

-- THIS VIEW WILL BE USED BY XTREME REPORTS & IT IS BASED UPON XN TABLES    
create VIEW VW_XNSREPS_CONS    
AS    
 SELECT  A.DEPT_ID,    
   'OPS' AS XN_TYPE,     
   XN_DT,     
   'OPS' AS XN_NO,     
   'OPS'+A.DEPT_ID AS XN_ID,    
   A.PRODUCT_CODE,    
   A.QUANTITY_OB AS XN_QTY    
 FROM OPS01106 A WITH (NOLOCK)    
 JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
 JOIN ARTICLE C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE
 JOIN SECTIOND D (NOLOCK) ON D.SUB_SECTION_CODE=C.SUB_SECTION_CODE
 JOIN SECTIONM E (NOLOCK) ON E.SECTION_CODE=D.SECTION_CODE
 WHERE ISNULL(E.ITEM_TYPE,0)=2
         
 -- PURCHASE INVOICE    
 UNION ALL    
 
 --CREATE NONCLUSTERED INDEX IX_PCODE_PID01106_INCL ON [DBO].[PID01106] ([PRODUCT_CODE]) INCLUDE ([QUANTITY],[MRR_ID],[TAX_AMOUNT])
 SELECT B.DEPT_ID,    
 (CASE WHEN  (B.INV_MODE IN (0,1)) THEN 'PUR' ELSE 'CHI' END) AS XN_TYPE,     
 B.RECEIPT_DT AS XN_DT,    
 B.MRR_NO AS XN_NO,  
 'PIM'+B.MRR_ID AS XN_ID,     
 A.PRODUCT_CODE,     
 A.QUANTITY AS XN_QTY    
 FROM PID01106 A WITH(NOLOCK)    
 JOIN PIM01106 B WITH(NOLOCK) ON A.MRR_ID = B.MRR_ID
 LEFT OUTER JOIN PIM01106 C (NOLOCK) ON C.REF_CONVERTED_MRNTOBILL_MRRID=B.MRR_ID
 WHERE B.CANCELLED = 0 AND C.MRR_ID IS NULL
 AND A.PRODUCT_CODE<>'' AND B.RECEIPT_DT<>''
 AND B.XN_ITEM_TYPE=2
     
   
 -- PURCHASE RETURN    
 UNION ALL    
 SELECT C.MAJOR_DEPT_ID AS DEPT_ID,    
   (CASE WHEN MODE=2 THEN 'CHO'  
    ELSE 'PRT' END) AS XN_TYPE,     
   B.RM_DT AS XN_DT,    
   B.RM_NO AS XN_NO,    
   'RMM'+B.RM_ID AS XN_ID,     
   A.PRODUCT_CODE,    
   A.QUANTITY AS XN_QTY    
 FROM RMD01106 A WITH(NOLOCK)
 JOIN RMM01106 B WITH(NOLOCK) ON A.RM_ID = B.RM_ID    
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_code/*LEFT(A.RM_ID,2)*//*Rohit 05-11-2024*/  
 WHERE B.CANCELLED = 0 AND B.DN_TYPE IN (0,1) AND ISNULL(C.SIS_LOC,0)<>1  
 AND XN_ITEM_TYPE=2
   
 ---RETAIL SALE     
 UNION ALL    
 --CREATE NONCLUSTERED INDEX IX_CAN_CMM_INCL ON [DBO].[CMM01106] ([CANCELLED]) INCLUDE ([CM_NO],[CM_DT],[DISCOUNT_PERCENTAGE],[CUSTOMER_CODE],[CM_ID])
 SELECT C.MAJOR_DEPT_ID AS DEPT_ID,    
   ( CASE WHEN A.QUANTITY > 0 THEN 'SLS' ELSE 'SLR' END) AS XN_TYPE,     
   B.CM_DT AS XN_DT,    
   B.CM_NO AS XN_NO,    
   'CMM'+B.CM_ID AS XN_ID,  
   A.PRODUCT_CODE,    
   ABS(A.QUANTITY) AS XN_QTY
 FROM CMD_CONS A WITH(NOLOCK)    
 JOIN CMM01106 B WITH(NOLOCK) ON A.CM_ID = B.CM_ID    
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=  B.location_code/*LEFT(A.CM_ID,2)*//*Rohit 05-11-2024*/
 WHERE B.CANCELLED = 0
     
 -- CANCELLATION AND STOCK ADJUSTMENT    
 UNION ALL    
 SELECT C.MAJOR_DEPT_ID AS DEPT_ID,    
   (CASE WHEN B.CNC_TYPE=1 AND STOCK_ADJ_NOTE=0 THEN 'CNC'    
      WHEN B.CNC_TYPE=2 AND STOCK_ADJ_NOTE=0 THEN 'UNC'    
      WHEN B.CNC_TYPE=1 AND STOCK_ADJ_NOTE=1 THEN 'SAC' ELSE 'SAU' END) AS XN_TYPE,     
   B.CNC_MEMO_DT AS XN_DT,    
   B.CNC_MEMO_NO AS XN_NO,    
   'ICM'+B.CNC_MEMO_ID AS XN_ID,  
   A.PRODUCT_CODE,    
   A.QUANTITY AS XN_QTY    
 FROM ICD01106 A WITH(NOLOCK)    
 JOIN ICM01106 B WITH(NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID    
 JOIN SKU WITH(NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
 JOIN ARTICLE D WITH(NOLOCK) ON D.ARTICLE_CODE=SKU.ARTICLE_CODE  
 JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE=D.SUB_SECTION_CODE
 JOIN SECTIONM E (NOLOCK) ON E.SECTION_CODE=SD.SECTION_CODE 
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=  B.location_code/*LEFT(A.CNC_MEMO_ID,2)*//*Rohit 05-11-2024*/
 WHERE B.CANCELLED = 0 AND E.ITEM_TYPE=2   
     
 --WHOLESALE INVOICE    
 UNION ALL    
 SELECT B.DEPT_ID AS DEPT_ID,    
   (CASE WHEN B.INV_MODE=2 THEN 'CHO' ELSE 'WSL' END)  AS XN_TYPE,    
   B.INV_DT AS XN_DT,    
   B.INV_NO AS XN_NO,    
   'INM'+B.INV_ID AS XN_ID,  
   A.PRODUCT_CODE,    
   A.QUANTITY AS XN_QTY
 FROM IND01106 A WITH(NOLOCK)    
 JOIN INM01106 B WITH(NOLOCK) ON A.INV_ID = B.INV_ID    
 WHERE B.CANCELLED = 0 AND XN_ITEM_TYPE=2 
 
     
 --WHOLESALE CREDIT NOTE    
 UNION ALL    
 --CREATE NONCLUSTERED INDEX IX_CAN_CNM01106_INCL ON [DBO].[CNM01106] ([CANCELLED],[CN_TYPE]) INCLUDE ([CN_ID],[BILLED_FROM_DEPT_ID],[MODE],[RECEIPT_DT],[BIN_TRANSFER],[CN_NO],[CN_DT],[AC_CODE])
 SELECT LOC.MAJOR_DEPT_ID AS DEPT_ID,    
   (CASE WHEN MODE=2 THEN 'CHI' ELSE 'WSR' END) AS XN_TYPE,    
   (CASE WHEN MODE=2 THEN B.RECEIPT_DT ELSE CN_DT END) AS XN_DT,    
   B.CN_NO AS XN_NO,    
   'CNM'+B.CN_ID AS XN_ID,  
   A.PRODUCT_CODE,    
   A.QUANTITY AS XN_QTY
 FROM CND01106 A (NOLOCK)    
 JOIN CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID    
 JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=B.BILLED_FROM_DEPT_ID  
 WHERE B.CANCELLED = 0 AND B.CN_TYPE<>2 AND (MODE<>2 OR B.RECEIPT_DT<>'')     
 AND XN_ITEM_TYPE=2  
 
 union all

 SELECT B.location_code/*LEFT(B.MEMO_ID,2)*//*Rohit 05-11-2024*/ AS DEPT_ID ,    
 'GRNPSIN' AS XN_TYPE,     
 B.MEMO_DT AS XN_DT,    
 B.MEMO_NO AS XN_NO,  
 'GRNPSIN'+B.MEMO_ID AS XN_ID,     
 A.PRODUCT_CODE AS PRODUCT_CODE,      
 A.QUANTITY AS XN_QTY
        
 FROM GRN_PS_DET  A WITH(NOLOCK)    
 JOIN GRN_PS_MST B WITH(NOLOCK) ON A.MEMO_ID  = B.MEMO_ID
 JOIN SKU WITH(NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
 JOIN ARTICLE D WITH(NOLOCK) ON D.ARTICLE_CODE=SKU.ARTICLE_CODE  
 JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE=D.SUB_SECTION_CODE
 JOIN SECTIONM E (NOLOCK) ON E.SECTION_CODE=SD.SECTION_CODE 
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_code/*LEFT(A.memo_id,2)  *//*Rohit 05-11-2024*/
 WHERE B.CANCELLED = 0 AND E.ITEM_TYPE=2  
 
 UNION ALL
 SELECT B.DEPT_ID,    
 'GRNPSOUT' AS XN_TYPE,     
 B.RECEIPT_DT AS XN_DT,    
 B.MRR_NO AS XN_NO,  
 'PIM'+B.MRR_ID AS XN_ID,     
 A.PRODUCT_CODE AS PRODUCT_CODE,         
 A.QUANTITY AS XN_QTY       
 FROM PID01106 A WITH(NOLOCK)    
 JOIN PIM01106 B WITH(NOLOCK) ON A.MRR_ID = B.MRR_ID
 WHERE B.CANCELLED = 0 
 AND A.PRODUCT_CODE<>'' AND B.RECEIPT_DT<>''
 AND ISNULL(B.PIM_MODE,0)=6
 AND ISNULL(B.xn_item_type,0) in (2) 

 UNION ALL
 SELECT B.location_code/*left(b.memo_id,2)*//*Rohit 05-11-2024*/ as dept_id,    
 'SLSDLV' AS XN_TYPE,     
 B.memo_dt AS XN_DT,    
 B.memo_no AS XN_NO,  
 'SLSDLV'+B.memo_id AS XN_ID,     
 A.PRODUCT_CODE AS PRODUCT_CODE,         
 A.QUANTITY AS XN_QTY       
 FROM sls_delivery_cons A WITH(NOLOCK)    
 JOIN sls_delivery_mst B WITH(NOLOCK) ON A.memo_id = B.memo_id
 WHERE B.CANCELLED = 0 
 AND A.PRODUCT_CODE<>'' 
    
--***************** END OF CREATING VIEW VW_XNSREPS_CONS 
