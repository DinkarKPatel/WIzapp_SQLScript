CREATE PROCEDURE [DBO].[SP3S_INV_JOBCARD_ISSUE_13]          
(          
  @IMODE INT ,          
  @CWHERE VARCHAR(MAX)='',      
  @CAGENCYCODE VARCHAR(20)='',      
  @FINYEAR VARCHAR(10)=''  ,    
  @DEPTID VARCHAR(10)='' ,
  @NRETURNMODE INT=0,
  @CJOB_CODE VARCHAR(10)=''
          
)      
----WITH ENCRYPTION
AS          
          
BEGIN        
 DECLARE @CCMD NVARCHAR(MAX)  
 -- LBLPENDINGJOBCARD_BOM: 13
	;WITH BOM_SUMRRY
	AS
	(
		SELECT T.MEMO_ID,T.ROW_ID, T.ARTICLE_CODE,T.PARA1_CODE,T.PARA2_CODE,T.PARA3_CODE,T.PARA4_CODE,T.PARA5_CODE,T.PARA6_CODE
		,T.QUANTITY,ISNULL(X.ISSUED_QTY,0) AS ISSUED_QTY,(T.QUANTITY-ISNULL(X.ISSUED_QTY,0)) AS PENDING_QTY
		FROM ORD_PLAN_BOM_DET T (NOLOCK)    
		JOIN ORD_PLAN_DET T1 (NOLOCK) ON  T.REF_ROW_ID=T1.ROW_ID AND T1.MEMO_ID=T.MEMO_ID
		JOIN ORD_PLAN_MST T2 (NOLOCK) ON  T1.MEMO_ID=T2.MEMO_ID 	
		LEFT OUTER JOIN
		(
			SELECT A4.JOB_CODE, A6.ORD_PLAN_BOM_DET_ROW_ID AS ROW_ID,SUM(A6.QUANTITY) AS ISSUED_QTY
			FROM BOM_ISSUE_DET A4 (NOLOCK) 
			JOIN BOM_ISSUE_MST A5  (NOLOCK) ON A5.ISSUE_ID=A4.ISSUE_ID
			JOIN BOM_ISSUE_REF A6  (NOLOCK) ON A5.ISSUE_ID=A6.BOM_ISSUE_ID AND A4.ROW_ID=A6.BOM_DET_ROW_ID
			JOIN ORD_PLAN_BOM_DET A1  (NOLOCK) ON A1.ROW_ID=A6.ORD_PLAN_BOM_DET_ROW_ID
			WHERE A5.CANCELLED=0 AND A1.MEMO_ID=@CWHERE 
			GROUP BY A4.JOB_CODE,A6.ORD_PLAN_BOM_DET_ROW_ID
		)X ON X.ROW_ID=T.ROW_ID and t.job_code=x.job_code 
		WHERE T2.CANCELLED=0 AND ISNULL(T2.SHORT_CLOSE,0)=0 AND T.MEMO_ID=@CWHERE 
		AND (@CJOB_CODE='' OR T.JOB_CODE=@CJOB_CODE)
	)
	SELECT CAST(1 AS BIT) AS CHK,A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.PARA3_CODE,A.PARA4_CODE,A.PARA5_CODE,A.PARA6_CODE
	,B.ARTICLE_NO,B.ARTICLE_NAME,C.PARA1_NAME,D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,
	SUM(A.QUANTITY) AS REQ_QTY,SUM(A.ISSUED_QTY) AS ISSUED_QTY,SUM(A.QUANTITY-A.ISSUED_QTY) AS PENDING_QTY ,
	'' AS ISSUE_ID,CONVERT(VARCHAR(100) ,NEWID()) AS ROW_ID,
	CONVERT(NUMERIC(14,2), SUM(CASE WHEN ISNULL(UC.CONVERSION_VALUE,0) =0 THEN A.QUANTITY-A.ISSUED_QTY
	         ELSE (A.QUANTITY-A.ISSUED_QTY)/ISNULL(UC.CONVERSION_VALUE,0) END)  ) AS STOCK_QTY ,
	ISNULL(bu.CONVERSION_UOM_NAME,I.UOM_NAME) as UOM_NAME,
	I.UOM_NAME AS STOCK_UOM 
	FROM BOM_SUMRRY A 
	JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE         
	JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE        
	JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE        
	JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE        
	JOIN PARA4 F (NOLOCK) ON A.PARA4_CODE = F.PARA4_CODE        
	JOIN PARA5 G (NOLOCK) ON A.PARA5_CODE = G.PARA5_CODE        
	JOIN PARA6 H (NOLOCK) ON A.PARA6_CODE = H.PARA6_CODE        
	JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE        
	JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE        
	JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE 
	LEFT OUTER JOIN UOM_CONVERSION UC (NOLOCK) ON UC.UOM_CODE=i.UOM_CODE
    LEFT OUTER JOIN BOM_UOM BU (NOLOCK) ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE    
	GROUP BY A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.PARA3_CODE,A.PARA4_CODE,A.PARA5_CODE,A.PARA6_CODE
	,B.ARTICLE_NO,B.ARTICLE_NAME,C.PARA1_NAME,D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,I.UOM_NAME,
	ISNULL(bu.CONVERSION_UOM_NAME,I.UOM_NAME)
	HAVING SUM(A.QUANTITY-A.ISSUED_QTY)>0
END
