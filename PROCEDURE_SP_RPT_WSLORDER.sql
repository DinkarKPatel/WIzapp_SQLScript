CREATE PROCEDURE SP_RPT_WSLORDER--(LocId 3 digit change by Sanjay:30-10-2024)
( 
@DFM_DT VARCHAR(10)='',
@DTODT VARCHAR(10)='',
@XN_PARTY_NAME VARCHAR(100)=''
)
AS
BEGIN

  
  DECLARE @DTSQL NVARCHAR(MAX)

	
IF OBJECT_ID('TEMPDB..#TMPORDER','U') IS NOT NULL
       DROP TABLE #TMPORDER
SELECT b.location_Code AS DEPT_ID ,
		   B.ORDER_ID ,
		   B.ORDER_NO ,
		   B.ORDER_DT ,
		   B.AC_CODE ,
		   A.ARTICLE_CODE ,
		   A.PARA1_CODE ,
		   A.PARA2_CODE ,
		   SUM(A.QUANTITY) AS ORD_QTY,
		   CONVERT(NUMERIC(12,2),SUM(A.QUANTITY*A.WS_PRICE )) AS ORDER_VALUE,
		   ISNULL(WPS.WPS_QTY,0) AS WPS_QTY,
		   ISNULL(WPS.WSL_QTY,0) AS WSL_QTY,
		   ISNULL(WPS.WSL_RATE,0) AS WSL_RATE,
		   ISNULL(WPS.WSL_NET_RATE,0) AS WSL_NET_RATE
    INTO #TMPORDER
	FROM BUYER_ORDER_DET A (NOLOCK)
	JOIN BUYER_ORDER_MST B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID  
	LEFT JOIN
	(
	
	  SELECT A.ORDER_ID ,A.ARTICLE_CODE  ,
			   A.PARA1_CODE ,A.PARA2_CODE,
			   SUM(CASE WHEN IND.PS_ID IS NULL THEN   A.WPS_QTY ELSE 0 END ) AS WPS_QTY , 
			   SUM(ISNULL(IND.WSL_QTY,0)) AS WSL_QTY,
			   SUM(ISNULL(IND.WSL_RATE ,0)) AS WSL_RATE,
			   SUM(ISNULL(IND.WSL_NET_RATE ,0)) AS WSL_NET_RATE
        FROM
	  (
		SELECT A.PS_ID, A.ORDER_ID ,A.PACKSLIP_ARTICLE_CODE AS ARTICLE_CODE  ,
			   A.PACKSLIP_PARA1_CODE AS PARA1_CODE ,A.PACKSLIP_PARA2_CODE AS PARA2_CODE,
			   A.QUANTITY AS WPS_QTY ,
			   SRNO=ROW_NUMBER () OVER (PARTITION BY A.PS_ID,A.PACKSLIP_ARTICLE_CODE ,A.PACKSLIP_PARA1_CODE,A.PACKSLIP_PARA2_CODE ORDER BY A.PS_ID,A.PACKSLIP_ARTICLE_CODE ,A.PACKSLIP_PARA1_CODE,A.PACKSLIP_PARA2_CODE,QUANTITY  )   
			   
		FROM WPS_DET A (NOLOCK)
		JOIN WPS_MST B (NOLOCK) ON A.PS_ID =B.PS_ID 
		WHERE B.CANCELLED =0
		AND ISNULL(A.ORDER_ID,0)<>''
		
		) A
		LEFT OUTER JOIN
		(	
		SELECT PS_ID ,SKU.ARTICLE_CODE ,SKU.PARA1_CODE ,SKU.PARA2_CODE,
		A.QUANTITY AS WSL_QTY  ,
		SRNO=ROW_NUMBER () OVER (PARTITION BY A.PS_ID,SKU.ARTICLE_CODE ,SKU.PARA1_CODE,SKU.PARA2_CODE ORDER BY A.PS_ID,SKU.ARTICLE_CODE ,SKU.PARA1_CODE,SKU.PARA2_CODE,QUANTITY  )   ,
		A.NET_RATE  AS WSL_NET_RATE ,
		A.RATE   AS WSL_RATE  
		FROM IND01106 A (NOLOCK)
		JOIN INM01106 B (NOLOCK) ON A.INV_ID =B.INV_ID 
		JOIN SKU ON SKU.PRODUCT_CODE =A.PRODUCT_CODE
		WHERE B.CANCELLED =0
		AND  ISNULL(PS_ID,'')<>''
		

		)IND ON IND.PS_ID =A.PS_ID 
		AND IND .ARTICLE_CODE=A.ARTICLE_CODE
		AND IND .PARA1_CODE=A.PARA1_CODE
		AND IND .PARA2_CODE=A.PARA2_CODE
		AND IND.SRNO=A.SRNO
		GROUP BY A.ORDER_ID ,A.ARTICLE_CODE  ,
			   A.PARA1_CODE ,A.PARA2_CODE
		
	) WPS ON WPS.ORDER_ID =B.ORDER_ID 
	AND WPS.ARTICLE_CODE =A.ARTICLE_CODE 
	AND WPS.PARA1_CODE =A.PARA1_CODE 
	AND WPS.PARA2_CODE =A.PARA2_CODE 
	WHERE B.CANCELLED =0 
	AND 1=2
	GROUP BY b.location_Code  ,B.ORDER_ID ,B.ORDER_NO ,B.ORDER_DT,
	B.AC_CODE ,A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE  ,ISNULL(WPS.WPS_QTY,0),ISNULL(WPS.WSL_QTY,0),
	ISNULL(WPS.WSL_RATE,0) ,ISNULL(WPS.WSL_NET_RATE,0) 
	
	
  SET @DTSQL=N' SELECT b.location_code AS DEPT_ID ,
		   B.ORDER_ID ,
		   B.ORDER_NO ,
		   B.ORDER_DT ,
		   B.AC_CODE ,
		   A.ARTICLE_CODE ,
		   A.PARA1_CODE ,
		   A.PARA2_CODE ,
		   SUM(A.QUANTITY) AS ORD_QTY,
		   CONVERT(NUMERIC(12,2),SUM(A.QUANTITY*A.WS_PRICE )) AS ORDER_VALUE,
		   ISNULL(WPS.WPS_QTY,0) AS WPS_QTY,
		   ISNULL(WPS.WSL_QTY,0) AS WSL_QTY,
		   ISNULL(WPS.WSL_RATE,0) AS WSL_RATE,
		   ISNULL(WPS.WSL_NET_RATE,0) AS WSL_NET_RATE
	FROM BUYER_ORDER_DET A (NOLOCK)
	JOIN BUYER_ORDER_MST B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID  
	LEFT JOIN
	(
	
	  SELECT A.ORDER_ID ,A.ARTICLE_CODE  ,
			   A.PARA1_CODE ,A.PARA2_CODE,
			   SUM(CASE WHEN IND.PS_ID IS NULL THEN   A.WPS_QTY ELSE 0 END ) AS WPS_QTY , 
			   SUM(ISNULL(IND.WSL_QTY,0)) AS WSL_QTY,
			   SUM(ISNULL(IND.WSL_RATE ,0)) AS WSL_RATE,
			   SUM(ISNULL(IND.WSL_NET_RATE ,0)) AS WSL_NET_RATE
        FROM
	  (
		SELECT A.PS_ID, A.ORDER_ID ,A.PACKSLIP_ARTICLE_CODE AS ARTICLE_CODE  ,
			   A.PACKSLIP_PARA1_CODE AS PARA1_CODE ,A.PACKSLIP_PARA2_CODE AS PARA2_CODE,
			   A.QUANTITY AS WPS_QTY ,
			   SRNO=ROW_NUMBER () OVER (PARTITION BY A.PS_ID,A.PACKSLIP_ARTICLE_CODE ,A.PACKSLIP_PARA1_CODE,A.PACKSLIP_PARA2_CODE ORDER BY A.PS_ID,A.PACKSLIP_ARTICLE_CODE ,A.PACKSLIP_PARA1_CODE,A.PACKSLIP_PARA2_CODE,QUANTITY  )   
			   
		FROM WPS_DET A (NOLOCK)
		JOIN WPS_MST B (NOLOCK) ON A.PS_ID =B.PS_ID 
		WHERE B.CANCELLED =0
		AND ISNULL(A.ORDER_ID,'''')<>''''
		
		) A
		LEFT OUTER JOIN
		(	
		SELECT PS_ID ,SKU.ARTICLE_CODE ,SKU.PARA1_CODE ,SKU.PARA2_CODE,
		A.QUANTITY AS WSL_QTY  ,
		SRNO=ROW_NUMBER () OVER (PARTITION BY A.PS_ID,SKU.ARTICLE_CODE ,SKU.PARA1_CODE,SKU.PARA2_CODE ORDER BY A.PS_ID,SKU.ARTICLE_CODE ,SKU.PARA1_CODE,SKU.PARA2_CODE,QUANTITY  )   ,
		A.NET_RATE  AS WSL_NET_RATE ,
		A.RATE   AS WSL_RATE  
		FROM IND01106 A (NOLOCK)
		JOIN INM01106 B (NOLOCK) ON A.INV_ID =B.INV_ID 
		JOIN SKU ON SKU.PRODUCT_CODE =A.PRODUCT_CODE
		WHERE B.CANCELLED =0
		AND  ISNULL(PS_ID,'''')<>''''
		

		)IND ON IND.PS_ID =A.PS_ID 
		AND IND .ARTICLE_CODE=A.ARTICLE_CODE
		AND IND .PARA1_CODE=A.PARA1_CODE
		AND IND .PARA2_CODE=A.PARA2_CODE
		AND IND.SRNO=A.SRNO
		GROUP BY A.ORDER_ID ,A.ARTICLE_CODE  ,
			   A.PARA1_CODE ,A.PARA2_CODE
		
	) WPS ON WPS.ORDER_ID =B.ORDER_ID 
	AND WPS.ARTICLE_CODE =A.ARTICLE_CODE 
	AND WPS.PARA1_CODE =A.PARA1_CODE 
	AND WPS.PARA2_CODE =A.PARA2_CODE 
	JOIN LM01106 LM ON LM.AC_CODE=B.AC_CODE
	WHERE B.CANCELLED =0 
	AND B.ORDER_DT BETWEEN '''+ CONVERT(VARCHAR(10),@DFM_DT,121)+''' AND '''+ CONVERT(VARCHAR(10),@DTODT,121)+'''
	AND ('''+@XN_PARTY_NAME+'''='''' OR LM.AC_NAME LIKE ''%'+@XN_PARTY_NAME+'%'')
	GROUP BY b.location_code  ,B.ORDER_ID ,B.ORDER_NO ,B.ORDER_DT,
	B.AC_CODE ,A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE  ,ISNULL(WPS.WPS_QTY,0),ISNULL(WPS.WSL_QTY,0),
	ISNULL(WPS.WSL_RATE,0) ,ISNULL(WPS.WSL_NET_RATE,0) '
	INSERT INTO #TMPORDER
	EXEC SP_EXECUTESQL @DTSQL
	PRINT @DTSQL
    
    SELECT L.DEPT_ALIAS AS ALIAS,
           A.ORDER_NO ,
           CONVERT(VARCHAR,A.ORDER_DT,105) AS  ORDER_DT,
           LM.AC_NAME AS XN_PARTY_NAME,
           ART.ARTICLE_NO ,
           ART.ARTICLE_NAME ,
           P1.PARA1_NAME AS COLOR,
           P2.PARA2_NAME AS SIZE,
           A.ORD_QTY AS CAL_ORD_QTY ,
           ISNULL(A.ORDER_VALUE,0) AS CAL_ORDER_VALUE,
          -- A.WPS_QTY AS CAL_WPS_QTY ,
           ISNULL(A.WSL_QTY,0) AS CAL_WSL_QTY ,
           ISNULL(A.WSL_RATE,0) AS CAL_WSL_RATE,
           ISNULL(A.WSL_NET_RATE,0) AS CAL_WSL_NET_RATE,
           CASE WHEN A.ORD_QTY -(ISNULL(A.WSL_QTY,0))>0 THEN 
           A.ORD_QTY -(ISNULL(A.WSL_QTY,0)) ELSE 0 END AS CAL_PENDING_QTY,--ISNULL(A.WPS_QTY ,0)+
           
           CASE WHEN ISNULL(A.ORDER_VALUE,0)-ISNULL(A.WSL_RATE,0)>0 THEN
           ISNULL(A.ORDER_VALUE,0)-ISNULL(A.WSL_RATE,0) ELSE 0 END  AS CAL_PENDING_VALUE
    FROM #TMPORDER A
    JOIN LOCATION L ON A.DEPT_ID =L.DEPT_ID 
    JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
    JOIN ARTICLE ART ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
    JOIN PARA1 P1 ON P1.PARA1_CODE =A.PARA1_CODE 
    JOIN PARA2 P2 ON P2.PARA2_CODE =A.PARA2_CODE 
    

END
