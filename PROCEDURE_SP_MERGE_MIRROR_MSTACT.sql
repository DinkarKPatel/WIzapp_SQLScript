create PROCEDURE DBO.SP_MERGE_MIRROR_MSTACT   
 (  
   @NMODE INT  =2
  ,@XN_TYPE VARCHAR(50) ='MSTACT'  
 )  
AS  
 BEGIN  
       DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)  
              ,@CTEMPLOCTABLE VARCHAR(100),@CSTATECODEOUT CHAR(7),@CSTATECODE VARCHAR(10)  
              ,@CCURDEPTID VARCHAR(10),@CHODEPTID VARCHAR(10),@BHOLOC BIT,@NLOCTYPE VARCHAR(50)  
              ,@BPURLOC VARCHAR(10),@CTABLENAME VARCHAR(100),@CTMP_TABLENAME VARCHAR(100)  
              ,@CKEYFIELD1 VARCHAR(100),@CTEMPLOCSSTTABLE VARCHAR(500),@CTEMPTABLE VARCHAR(500)  
              ,@CTEMPLOCSSTMSTTABLE VARCHAR(500),@BPROCEED BIT,@CKEYFIELD2 VARCHAR(500),@CKEYFIELD3 VARCHAR(500)   
              ,@CSOURCETABLE VARCHAR(1000),@NXNSMERGINGORDER INT,@CSOURCEDB VARCHAR(200),@CERRORMSG VARCHAR(MAX) 
              ,@CFILTERCONDITION varchar(100)   
BEGIN TRY  
   SELECT @CSOURCEDB=''   

   
     
   --VALIDATE DATE   
   IF ISNULL(@XN_TYPE,'')  = ''  
      BEGIN  
        SET @CERRORMSG ='XN_TYPE IS NOT NULL. PLEASE PASS XN TYPE INTO PARAMATER'  
        GOTO END_PROC;  
      END  
     
   IF ISNULL(@NMODE,0) = 1  
         GOTO END_PROC;   
     
   BEGIN TRANSACTION  
        
      SET @CSTEP = 00    
                 
   SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'    
   SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'    
     
   IF @CCURDEPTID=@CHODEPTID  
   BEGIN  

	   SET @CERRORMSG='P:SP_MERGE_MIRROR_MSTACT, CANNOT CALL MERGING PROC AT HEAD OFFICE'  
	   GOTO END_PROC  

   END       
  
   SET @CSTEP = 10      
       
   SELECT @NLOCTYPE=LOC_TYPE,@BPURLOC=PUR_LOC FROM LOCATION WHERE DEPT_ID=@CCURDEPTID    
          
     
   SET @CSTEP = 20  
     
   SET @CTEMPTABLE='MSTACT_LM01106_MIRROR'

   SET @DTSQL=N'UPDATE '+@CTEMPTABLE+' WITH (ROWLOCK)  SET COMPANY_CODE=''01'''  
   EXEC SP_EXECUTESQL @DTSQL  
  
     
   SET @CTEMPTABLE='MSTACT_LMP01106_MIRROR'
   SET @DTSQL=N'UPDATE '+@CTEMPTABLE+' WITH (ROWLOCK)  SET COMPANY_CODE=''01'''  
   EXEC SP_EXECUTESQL @DTSQL  

   SET @CSTEP = 30  
    
   
    SET @CKEYFIELD2 =''  
    SET @CKEYFIELD3 =''  
  --INSERT DATA INTO LOCATION TABLE  
    
    
    --INSERT DATA INTO CITY TABLE  
    SET @CSTEP = 40  
    SET @CTABLENAME = 'REGIONM'  
    SET @CSOURCETABLE ='MSTACT_REGIONM_MIRROR'  
    SET @CKEYFIELD1='REGION_CODE'  
    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
      
    --INSERT DATA INTO CITY TABLE  
    SET @CSTEP = 50  
    SET @CTABLENAME = 'STATE'  
    SET @CSOURCETABLE ='MSTACT_STATE_MIRROR'  
    SET @CKEYFIELD1='STATE_CODE'  
    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
  
    --INSERT DATA INTO CITY TABLE  
    SET @CSTEP = 60  
    SET @CTABLENAME = 'CITY'  
    SET @CSOURCETABLE ='MSTACT_CITY_MIRROR'  
    SET @CKEYFIELD1='CITY_CODE'  
    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
      
    --INSERT DATA INTO AREA TABLE  
    SET @CSTEP = 70  
    SET @CTABLENAME = 'AREA'  
    SET @CSOURCETABLE ='MSTACT_AREA_MIRROR'  
    SET @CKEYFIELD1='AREA_CODE'  
    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
    
    --INSERT DATA INTO HD01106 TABLE  
    SET @CSTEP = 75  
    SET @CTABLENAME = 'HD01106'  
    SET @CSOURCETABLE ='MSTACT_HD01106_MIRROR'  
    SET @CKEYFIELD1='HEAD_CODE'  
    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
  

    --INSERT DATA INTO LM01106 TABLE  
    SET @CSTEP = 80  
    SET @CTABLENAME = 'LM01106'  
    SET @CSOURCETABLE ='MSTACT_LM01106_MIRROR'  
    SET @CKEYFIELD1='AC_CODE'  

	IF OBJECT_ID('TEMPDB..#TMPLEDGER','U') IS NOT NULL
	   DROP TABLE #TMPLEDGER

	SELECT A.AC_CODE ,B.MAJOR_AC_CODE 
	INTO #TMPLEDGER
	FROM MSTACT_LM01106_MIRROR A
	LEFT JOIN LM01106 B ON A.MAJOR_AC_CODE  =B.AC_CODE
	WHERE B.AC_CODE IS NULL
	

	UPDATE A SET MAJOR_AC_CODE=A.AC_CODE  
	FROM MSTACT_LM01106_MIRROR A
	JOIN #TMPLEDGER B ON A.AC_CODE =B.AC_CODE 

	

  
    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
      
    --INSERT DATA INTO LMP01106 TABLE  
    SET @CSTEP = 90  
    SET @CTABLENAME = 'LMP01106'  
    SET @CSOURCETABLE ='MSTACT_LMP01106_MIRROR'  
    SET @CKEYFIELD1='AC_CODE'  
    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
    
    
	UPDATE A SET MAJOR_AC_CODE=A.major_ac_code   
	FROM LM01106  A
	JOIN #TMPLEDGER B ON A.AC_CODE =B.AC_CODE 

				
   
    
      --INSERT DATA INTO LMP01106 TABLE  
    SET @CSTEP = 100
    SET @CTABLENAME = 'LM_TERMS'  
    SET @CSOURCETABLE ='MSTACT_LM_TERMS_MIRROR'  
    SET @CKEYFIELD1='ROW_ID'  
    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1 
    
    
    
     
      --INSERT DATA INTO LMP01106 TABLE  
    SET @CSTEP = 110  
    SET @CTABLENAME = 'LEDGER_TERMS'  
    SET @CSOURCETABLE ='MSTACT_LEDGER_TERMS_MIRROR'  
    SET @CKEYFIELD1='TERMS_CODE'
    
     SET @DTSQL=N'UPDATE A SET USER_CODE=''0000000'' FROM  '+@CSOURCETABLE+' A WHERE USER_CODE NOT IN (SELECT USER_CODE FROM USERS)'
     EXEC SP_EXECUTESQL @DTSQL
      
    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
    
    --INSERT DATA INTO LMP01106 TABLE    
    SET @CSTEP = 115    
    SET @CTABLENAME = 'NRM'    
    SET @CSOURCETABLE ='MSTACT_NRM_MIRROR'    
    SET @CKEYFIELD1='NRM_ID'    
    EXEC UPDATEMASTERXN    
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,    
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,    
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,    
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
      
   --MERGE DATA INTO LM_SHIPING_DETAILS TABLE
   --INSERT DATA INTO LMP01106 TABLE    
    
    set @CFILTERCONDITION=' b.shipping_ac_code is not null'
     
    SET @CSTEP = 116    
    SET @CTABLENAME = 'LM_SHIPPING_DETAILS'    
    SET @CSOURCETABLE ='MSTACT_LM_SHIPPING_DETAILS_MIRROR'    
    SET @CKEYFIELD1='ac_code'    
    EXEC UPDATEMASTERXN    
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,    
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,    
    @CKEYFIELD2='shipping_ac_code',@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,    
    @CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0,@BALWAYSUPDATE=1  
      
      
    GOTO END_PROC  
END TRY  
  
BEGIN CATCH  
 SET @CERRORMSG='P:SP_MERGE_MIRROR_MSTACT, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
 GOTO END_PROC  
END CATCH  
  
END_PROC:  
   
 IF @@TRANCOUNT>0  
 BEGIN  
  IF ISNULL(@CERRORMSG,'')=''   
   COMMIT  
  ELSE  
   ROLLBACK   
 END  
   
 IF ISNULL(@CERRORMSG,'')='' 
 BEGIN     
       
	   DELETE  FROM MSTACT_LM01106_MIRROR 
	   DELETE  FROM MSTACT_LM_TERMS_MIRROR 
	   DELETE  FROM MSTACT_LEDGER_TERMS_MIRROR 
	   DELETE  FROM MSTACT_HD01106_MIRROR 
	   DELETE  FROM MSTACT_LMP01106_MIRROR 
	   DELETE  FROM MSTACT_AREA_MIRROR 
	   DELETE  FROM MSTACT_CITY_MIRROR 
	   DELETE  FROM MSTACT_STATE_MIRROR 
	   DELETE  FROM MSTACT_REGIONM_MIRROR 
	   DELETE  FROM MSTACT_NRM_MIRROR 
	   DELETE  FROM MSTACT_LM_SHIPPING_DETAILS_MIRROR 
 END  
    
 SELECT @XN_TYPE AS MEMO_ID,@CERRORMSG AS ERRMSG        
END  
--END PROCEDURE SP_MERGE_MIRROR_MSTTILL
