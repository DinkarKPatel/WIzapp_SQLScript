CREATE PROCEDURE SAVETRAN_PRINT_LOCATION--(LocId 3 digit change by Sanjay:06-11-2024)
(
	@NSPID					INT
   ,@CPRINTID				VARCHAR(50)
)
AS
BEGIN

DECLARE		    @CTEMPDBNAME			VARCHAR(100),
				@CMASTERTABLENAME		VARCHAR(100),
				@CDETAILTABLENAME1		VARCHAR(100),
				@CDETAILTABLENAME2		VARCHAR(100),
				@CTEMPMASTERTABLENAME	VARCHAR(100),
				@CTEMPDETAILTABLENAME1	VARCHAR(100),
				@CTEMPDETAILTABLENAME2	VARCHAR(100),
				@CTEMPMASTERTABLE		VARCHAR(100),
				@CTEMPDETAILTABLE1		VARCHAR(100),
				@CTEMPDETAILTABLE2		VARCHAR(100),
				@CERRMSG				VARCHAR(500),
				@LDONOTUPDATESTOCK		BIT,
				@CKEYFIELD1				VARCHAR(50),
				@CKEYFIELDVAL1			VARCHAR(50),
				@NMEMONOLEN				NUMERIC(20,0),
				@CMEMONOVAL				VARCHAR(50),
				@CDEPT_ID				VARCHAR(4),
				@CCMD					NVARCHAR(4000),
				@NSAVETRANLOOP			BIT,
				@NSTEP					INT,
				@LENABLETEMPDATABASE	BIT,
				@CMEMONOPREFIX			VARCHAR(10)

	DECLARE @OUTPUT TABLE (ERRMSG VARCHAR(2000),REPORT_ID VARCHAR(100))

	SET @NSTEP = 10		-- SETTTING UP ENVIRONMENT
	-- TEMPORARY DATABASE Discarded now onwards as per Meeting on 30-10-2020 mentioned in Client issues List
	SET @CTEMPDBNAME = ''

	SET @NSTEP = 30
	SET @CMASTERTABLENAME	= 'PRINTLOCATION'
	
	SET @CTEMPMASTERTABLENAME	= 'TEMP_'+@CMASTERTABLENAME+'_'+LTRIM(RTRIM(STR(@NSPID)))
	
	SET @CTEMPMASTERTABLE	= @CTEMPDBNAME + @CTEMPMASTERTABLENAME
	
	SET @CERRMSG			= ''
	SET @LDONOTUPDATESTOCK	= 0
	SET @CKEYFIELD1			= 'PRINTID'
	SET @NMEMONOLEN			= 10
	

	BEGIN TRANSACTION
	
	BEGIN TRY
		
		SET @NSTEP = 100
		SET @CCMD=N'SELECT TOP 1 @CKEYFIELDVAL1=PRINTID FROM '+@CTEMPMASTERTABLE
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD,N'@CKEYFIELDVAL1 VARCHAR(50) OUTPUT',@CKEYFIELDVAL1 OUTPUT
		
		SET @NSTEP = 105
		IF ISNULL(@CKEYFIELDVAL1,'')=''
			SET @CKEYFIELDVAL1=@CPRINTID
		
		SET @NSTEP = 110
		DELETE PRINTLOCATION WHERE PRINTID=@CKEYFIELDVAL1
		
		SET @NSTEP = 160
		EXEC UPDATEMASTERXN 
			  @CSOURCEDB	= @CTEMPDBNAME
			, @CSOURCETABLE = @CTEMPMASTERTABLENAME
			, @CDESTDB		= ''
			, @CDESTTABLE	= @CMASTERTABLENAME
			, @CKEYFIELD1	= @CKEYFIELD1
			, @LINSERTONLY	= 1
			, @BALWAYSUPDATE = 1
		
				
	END TRY
	BEGIN CATCH
		SET @CERRMSG = 'P:- SAVETRAN_PRINT_LOCATION, STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		GOTO END_PROC
	END CATCH
	
END_PROC:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')='' 
			COMMIT TRANSACTION
		ELSE
			ROLLBACK
	END
	
	INSERT @OUTPUT(ERRMSG,REPORT_ID)
		VALUES (ISNULL(@CERRMSG,''),ISNULL(@CKEYFIELDVAL1,''))

	SELECT * FROM @OUTPUT	
	
	---DROPPING TEMP TABLES
	SET @CCMD = N'IF OBJECT_ID('''+@CTEMPMASTERTABLE+''',''U'') IS NOT NULL
					 DROP TABLE '+@CTEMPMASTERTABLE
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD

END
--END OF PROCEDURE - SAVETRAN_PRINT_LOCATION
