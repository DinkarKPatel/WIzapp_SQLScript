CREATE PROC SP_PRD_CANCELUNCANCEL_MST    
@NQUERYID NUMERIC (3,0),    
@CWHERE VARCHAR(MAX),    
@CFINYEAR VARCHAR(5),    
@NNAVMODE NUMERIC(1,0),    
@CMEMOID VARCHAR(40),    
@CDEPTID VARCHAR(7)    
--WITH ENCRYPTION
    
AS    
BEGIN      
    
DECLARE @CCMD NVARCHAR(4000)    
    
IF @NQUERYID IN (3,4,5)    
BEGIN    
	  DECLARE @BPICKFREIGHT BIT,@BPICKOC BIT,@BPICKRO BIT,@NSTOCKADJVALUE NUMERIC(10,2)    
	      
	  SELECT TOP 1 @BPICKFREIGHT=VALUE FROM CONFIG WHERE CONFIG_OPTION='FIXREPS_PICK_FREIGHT'       
	      
	  SELECT TOP 1 @BPICKOC=VALUE FROM CONFIG WHERE CONFIG_OPTION='fixreps_PICK_OTHER_CHARGES'       
	      
	  SELECT TOP 1 @BPICKRO=VALUE FROM CONFIG WHERE CONFIG_OPTION='fixreps_PICK_ROUND_OFF'       
    
END    
    
    
IF @NQUERYID = 1    
	GOTO LBLNAVIGATE    
    
ELSE IF @NQUERYID =2    
	GOTO LBLGETMASTER    
    
ELSE IF @NQUERYID = 3    
	GOTO LBLGETDETAILS    
    
ELSE IF @NQUERYID =4     
	GOTO LBLGETPRODUCT    
    
ELSE IF @NQUERYID =5    
	GOTO LBLGETPRODUCTINFO    
    
ELSE IF @NQUERYID = 6    
	GOTO LBLGETREPORT    
    
ELSE IF @NQUERYID = 7    
	GOTO LBLGETPRODUCTMULTIPLE    
    
ELSE     
GOTO LAST    
    
    
LBLNAVIGATE:    
	EXEC SP_NAVIGATE 'PRD_ICM01106',@NNAVMODE,@CMEMOID,@CFINYEAR,'CNC_MEMO_NO','CNC_MEMO_DT','CNC_MEMO_ID',@CWHERE     
GOTO LAST    
    
LBLGETMASTER:    
	SELECT T1.*,T2.USERNAME,CAST(0 AS NUMERIC) AS RATE    
	FROM PRD_ICM01106 T1    
	JOIN USERS T2 ON T2.USER_CODE = T1.USER_CODE    
	WHERE T1.CNC_MEMO_ID = @CMEMOID    
GOTO LAST    
    
LBLGETDETAILS:    
		SELECT A.*,S.PRODUCT_CODE,B.ARTICLE_NAME ,B.ARTICLE_NO ,B.ARTICLE_DESC AS PRODUCT_NAME,C.PARA1_NAME ,D.PARA2_NAME,F.PARA3_NAME ,    
	G.PARA4_NAME,H.PARA5_NAME ,I.PARA6_NAME ,
	B.CODING_SCHEME, 
	B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],S.DT_CREATED AS [SKU_DT_CREATED],E.UOM_TYPE 
	,B1.DEPARTMENT_ID,B1.DEPT_ID
	FROM PRD_ICD01106 A         
	JOIN PRD_ICM01106 B1 ON A.CNC_MEMO_ID=B1.CNC_MEMO_ID      
	--JOIN VW_PRD_STOCKVALUE C1  ON A.PRODUCT_UID = C1.PRODUCT_UID
	JOIN PRD_SKU S ON A.PRODUCT_UID= S.PRODUCT_UID
	JOIN ARTICLE B ON S.ARTICLE_CODE = B.ARTICLE_CODE      
	JOIN SECTIOND SD ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	JOIN SECTIONM SM ON SD.SECTION_CODE = SM.SECTION_CODE    
	JOIN PARA1 C ON S.PARA1_CODE = C.PARA1_CODE      
	JOIN PARA2 D ON S.PARA2_CODE = D.PARA2_CODE      
	JOIN PARA3 F ON S.PARA3_CODE = F.PARA3_CODE      
	JOIN PARA4 G ON S.PARA4_CODE = G.PARA4_CODE      
	JOIN PARA5 H ON S.PARA5_CODE = H.PARA5_CODE      
	JOIN PARA6 I ON S.PARA6_CODE = I.PARA6_CODE      
	JOIN UOM   E ON B.UOM_CODE = E.UOM_CODE        
	WHERE A.CNC_MEMO_ID =  @CMEMOID        
GOTO LAST    
    
LBLGETPRODUCTMULTIPLE:    
 
     
  SET @CCMD = N'SELECT A.AC_CODE, F.UOM_TYPE, H.SECTION_NAME, G.SUB_SECTION_NAME, A.PRODUCT_CODE, A.INV_DT,     
  A.INV_NO, 0'+(CASE WHEN @BPICKFREIGHT=1 THEN '+ISNULL(C.FREIGHT,0)' ELSE '' END)+    
  (CASE WHEN @BPICKOC=1 THEN '+ISNULL(C.OTHER_CHARGES,0)' ELSE '' END )+    
  (CASE WHEN @BPICKRO=1 THEN '+ISNULL(C.ROUND_OFF,0)' ELSE '' END)+'  AS PURCHASE_PRICE, A.MRP, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC,     
  C.PARA1_NAME, D.PARA2_NAME, E.PARA3_NAME, F.UOM_CODE, F.UOM_NAME, 0 AS FREIGHT, 0 AS DISCOUNT_AMOUNT,     
  0 AS TAX_AMOUNT, I.FORM_ID,I.FORM_NAME, 0 AS OTHER_CHARGES, I.TAX_PERCENTAGE,     
 ISNULL(PMT.QUANTITY_IN_STOCK,0) AS [QUANTITY_IN_STOCK],ISNULL(PMT.QUANTITY_IN_STOCK,0) AS QTY,
 ---ISNULL(TP.QUANTITY,0) AS [QUANTITY_IN_STOCK],
   (A.PURCHASE_PRICE ) AS RATE,  A.PRODUCT_UID,  
  B.CODING_SCHEME AS CODING_SCHEME,A.MRP AS FIX_MRP,'''' AS PRODUCT_NAME,B.ALIAS AS ARTICLE_ALIAS ,''000'' AS BIN_ID,'''' AS BIN_NAME   
  FROM PRD_SKU A 
   JOIN ##TEMP_PCODE_'+@CWHERE+' TP ON TP.PRODUCT_CODE=A.PRODUCT_CODE           
  JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE            
  JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE            
  JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE           
  JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE            
  JOIN UOM F (NOLOCK) ON B.UOM_CODE = F.UOM_CODE           
  JOIN SECTIOND G (NOLOCK) ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE            
  JOIN SECTIONM H (NOLOCK) ON G.SECTION_CODE = H.SECTION_CODE           
  JOIN FORM I (NOLOCK) ON A.FORM_ID = I.FORM_ID           
 -- JOIN VW_STOCKVALUE J (NOLOCK) ON A.PRODUCT_CODE = J.PRODUCT_CODE          
  LEFT OUTER JOIN PRD_PMT PMT (NOLOCK) ON PMT.PRODUCT_UID=A.PRODUCT_UID     
  WHERE PMT.QUANTITY_IN_STOCK>0 AND PMT.DEPARTMENT_ID=''DEF0000'' AND  A.PRODUCT_CODE IN (SELECT PRODUCT_CODE FROM ##TEMP_PCODE_'+@CWHERE+') AND ISNULL(PMT.QUANTITY_IN_STOCK,0) '  
  + (CASE WHEN @NNAVMODE=1 THEN '>0' ELSE '=ISNULL(PMT.QUANTITY_IN_STOCK,0)' END)+  
  '  ORDER BY A.PRODUCT_CODE'    
  PRINT @CCMD    
  EXECUTE SP_EXECUTESQL @CCMD   
         
GOTO LAST    
      
LBLGETPRODUCT:    
	SELECT 	A.PRODUCT_CODE,A.PRODUCT_UID,B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME,
	 B.ARTICLE_DESC AS PRODUCT_NAME, B.ARTICLE_DESC,     
	C.PARA1_NAME, D.PARA2_NAME, F.UOM_CODE, F.UOM_NAME, H.SECTION_NAME, G.SUB_SECTION_NAME, A.PRODUCT_UID,
	ISNULL(PMT.QUANTITY_IN_STOCK,0) AS [QUANTITY_IN_STOCK], B.CODING_SCHEME,A.PRODUCT_CODE,PMT.DEPARTMENT_ID
	FROM PRD_SKU A           
	JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE            
	JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE            
	JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE           
	JOIN UOM F (NOLOCK) ON B.UOM_CODE = F.UOM_CODE           
	JOIN SECTIOND G (NOLOCK) ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE            
	JOIN SECTIONM H (NOLOCK) ON G.SECTION_CODE = H.SECTION_CODE           
	--JOIN VW_PRD_STOCKVALUE J (NOLOCK) ON A.PRODUCT_UID = J.PRODUCT_UID          
	JOIN PRD_PMT PMT (NOLOCK) ON PMT.PRODUCT_UID=A.PRODUCT_UID  AND PMT.DEPARTMENT_ID = @CDEPTID 
	WHERE A.WORK_ORDER_ID=''  
	
GOTO LAST    
    
LBLGETPRODUCTINFO:    
	SET @CCMD = N' SELECT A.QUANTITY_IN_STOCK, C.CODING_SCHEME 
	FROM PRD_PMT A    
	JOIN PRD_SKU B (NOLOCK)  ON A.PRODUCT_UID = B.PRODUCT_UID    
	JOIN ARTICLE C (NOLOCK) ON B.ARTICLE_CODE = C.ARTICLE_CODE    
	WHERE A.PRODUCT_UID = '''+@CWHERE +'''
	AND A.DEPARTMENT_ID = '''+@CDEPTID+'''  '
	PRINT @CCMD    
  EXECUTE SP_EXECUTESQL @CCMD     
GOTO LAST    
    
LBLGETREPORT:    
 --SELECT * FROM VW_PRD_CANCELUNCANCEL_QBF  WHERE XN_ID =@CMEMOID    
GOTO LAST    
    
LAST:    
END
