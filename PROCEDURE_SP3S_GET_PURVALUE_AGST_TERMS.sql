CREATE PROCEDURE SP3S_GET_PURVALUE_AGST_TERMS
@nMode NUMERIC(1,0),----- 1.Fetch Detailed Data for Single Mrr
					----- 2.Fetch Taxable Value Difference for Generating FDN
					----- 3.Called from MultiPle FDN Module
					----- 4.Called from Batch script for Purchase value agst Terms
					-----   to be displayed for Pending Purchases in Transaction Approval
@bConvertedMrr BIT=0
AS
BEGIN
	DECLARE @PICK_INVOICE_TAX_AMOUNT_IN_LEDGER NUMERIC(14,2)
	SELECT DISTINCT terms INTO #PurTerms FROM #TMPMRR a JOIN pim01106 b ON a.MRR_ID=b.mrr_id
	where isnull(TERMS,'')<>''

	CREATE TABLE #ledger_terms (terms VARCHAR(1000), GROSS_MARGIN numeric(10,2),CREDIT_DAYS numeric(5,0),prevatdiscount numeric(10,2),
	REIMUBURSE_PURCHASE_TAX BIT,REIMUBURSE_FREIGHT BIT,REIMUBURSE_INSURANCE bit,REIMUBURSE_OUTPUT_VAT BIT,
	CashDiscount NUMERIC(7,3),ApplyCDOnTotal BIT,EOSS_DISCOUNT_SHARE BIT,
	EOSS_DISCOUNT_PER NUMERIC(10,2),FIX_MRP_MD_PERCENTAGE NUMERIC(6,2),REIMUBURSE_OUTPUT_GST BIT)

	DECLARE @cTerms VARCHAR(200)

	WHILE EXISTS (SELECT TOP 1 * FROM #PurTerms)
	BEGIN
		SELECT TOP 1 @cTerms=terms FROM #PurTerms


		INSERT INTO #ledger_terms (terms, GROSS_MARGIN,CREDIT_DAYS,prevatdiscount,cashdiscount,REIMUBURSE_PURCHASE_TAX,
		REIMUBURSE_FREIGHT,REIMUBURSE_INSURANCE,REIMUBURSE_OUTPUT_VAT,ApplyCDOnTotal,
		EOSS_DISCOUNT_SHARE,EOSS_DISCOUNT_PER,FIX_MRP_MD_PERCENTAGE,REIMUBURSE_OUTPUT_GST)
		SELECT terms, GROSS_MARGIN,CREDIT_DAYS,prevatdiscount,cashdiscount,REIMUBURSE_PURCHASE_TAX,
		REIMUBURSE_FREIGHT,REIMUBURSE_INSURANCE,REIMUBURSE_OUTPUT_VAT,ApplyCDOnTotal,
		EOSS_DISCOUNT_SHARE,EOSS_DISCOUNT_PER,FIX_MRP_MD_PERCENTAGE,REIMUBURSE_OUTPUT_GST
		FROM dbo.FN3SGETLEDGERTERMS (@cTerms)

		DELETE  FROM #PurTerms WHERE terms=@cTerms
	END
	
	SELECT pim.mrr_id,pim.mrr_no AS INVOICE_NO,pim.bill_no,pim.receipt_dt INVOICE_DATE,ac_name INVOICE_SUPPLIER
		  ,PIM.DISCOUNT_PERCENTAGE		AS INVOICE_DISCOUNTPERCENTAGE	 
		  ,PIM.DISCOUNT_AMOUNT			AS INVOICE_DISCOUNTAMOUNT
		  ,PIM.EXCISE_DUTY_AMOUNT		AS INVOICE_EXCISEDUTYAMOUNT
		  ,SUM(PID.TAX_AMOUNT+ISNULL(PID.IGST_AMOUNT,0)+ISNULL(PID.SGST_AMOUNT,0)+ISNULL(PID.CGST_AMOUNT,0))
		  +ISNULL(PIM.freight_cgst_amount,0)+ISNULL(pim.freight_sgst_amount,0)+
		   isnull(pim.freight_igst_amount,0)+ISNULL(PIM.other_charges_cgst_amount,0)+ISNULL(pim.other_charges_sgst_amount,0)+
		   isnull(pim.other_charges_igst_amount,0) AS INVOICE_TAXAMOUNT
		  ,PIM.POSTTAXDISCOUNTAMOUNT	AS INVOICE_POSTTAXDISCOUNTAMOUNT
		  ,isnull(PIM.FREIGHT,0) AS INVOICE_FREIGHT
		  ,isnull(PIM.other_charges,0)		AS INVOICE_OTHERCHARGES
		  ,PIM.ROUND_OFF				AS INVOICE_ROUNDOFF
		  ,PIM.TOTAL_AMOUNT				AS INVOICE_NETAMOUNT
		  ,SUM(PID.QUANTITY*PID.PURCHASE_PRICE)
										AS INVOICE_PURCHASEVALUE
		  ,SUM(PID.QUANTITY*SKU.MRP)    AS INVOICE_MRPVALUE
		  ,CONVERT(NUMERIC(18,2),0)		AS INVOICE_MARKDOWN								
		  ,ISNULL(lt.prevatdiscount,0) AS LEDGER_DISCOUNTPERCENTAGE	 
		  ,CONVERT(NUMERIC(18,2),0) AS LEDGER_DISCOUNTAMOUNT
		  ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_EXCISEDUTYAMOUNT
          ,SUM(DBO.FN3SRETURNLEDGERTAX((PID.QUANTITY*SKU.MRP),PID.GST_PERCENTAGE,lt.GROSS_MARGIN,
									    lt.prevatdiscount,PIM.BILL_LEVEL_TAX_METHOD))			
           AS LEDGER_TAXAMOUNT
          ,SUM( CASE WHEN LT.REIMUBURSE_PURCHASE_TAX =1 THEN 	
		  (DBO.FN3SRETURNLEDGERTAX((PID.QUANTITY*SKU.MRP),PID.TAX_PERCENTAGE,lt.GROSS_MARGIN,
									lt.prevatdiscount,PIM.BILL_LEVEL_TAX_METHOD))	
           ELSE 0 END) AS LEDGER_POSTTAXDISCOUNTAMOUNT
		  		
		  ,(CASE WHEN lt.REIMUBURSE_FREIGHT=0 THEN isnull(PIM.FREIGHT,0) ELSE 0 END)		AS LEDGER_FREIGHT
		  ,(CASE WHEN lt.REIMUBURSE_INSURANCE=0 
		  THEN isnull(PIM.other_charges,0) ELSE 0 END)		AS LEDGER_OTHERCHARGES
		  ,PIM.ROUND_OFF				AS LEDGER_ROUNDOFF
		  ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_NETAMOUNT
		  ,SUM(PID.QUANTITY*SKU.MRP)    AS LEDGER_MRPVALUE
		  ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_PURCHASEVALUE
		  ,ISNULL(lt.gross_margin,0)    AS LEDGER_MARKDOWN
 	      ,0  AS REIMUBURSE_AMT_GST
		  ,PIM.BILL_LEVEL_TAX_METHOD
	INTO #PURCHASEHEADERDETAILS
	FROM PIM01106 PIM (NOLOCK)
	JOIN PID01106 PID (NOLOCK) ON PIM.MRR_ID=PID.MRR_ID
	LEFT OUTER JOIN SKU (NOLOCK) ON PID.PRODUCT_CODE= SKU.PRODUCT_CODE
	LEFT OUTER JOIN #ledger_terms lt (NOLOCK) ON lt.terms=pim.terms
	JOIN lm01106 lm (NOLOCK) ON lm.ac_code=pim.ac_code
	WHERE 
	PIM.MRR_ID in(select mrr_id from  #TMPMRR) AND ISNULL(pim.terms,'')<>''

	GROUP BY pim.mrr_id,pim.mrr_no,pim.bill_no,pim.receipt_dt,ac_name,PIM.SUBTOTAL,PIM.DISCOUNT_PERCENTAGE,PIM.DISCOUNT_AMOUNT,PIM.EXCISE_DUTY_AMOUNT
		  ,PIM.POSTTAXDISCOUNTAMOUNT,ISNULL(PIM.freight_cgst_amount,0),
		  ISNULL(pim.freight_sgst_amount,0),isnull(pim.freight_igst_amount,0),
		  ISNULL(PIM.other_charges_cgst_amount,0),ISNULL(pim.other_charges_sgst_amount,0),
		   isnull(pim.other_charges_igst_amount,0),PIM.ROUND_OFF
		  ,PIM.TOTAL_AMOUNT,lt.GROSS_MARGIN,lt.prevatdiscount
		  ,lt.REIMUBURSE_FREIGHT,lt.REIMUBURSE_insurance
		  ,PIM.TERMS,PIM.ROUND_OFF,pim.freight,pim.other_charges
		  ,PIM.BILL_LEVEL_TAX_METHOD
		  
     ---Did this changes as per Ticket#09-1421 (Discussion done with Pankaj/Sir) (Date:08-10-2021) 
     UPDATE #PURCHASEHEADERDETAILS SET LEDGER_TAXAMOUNT=INVOICE_TAXAMOUNT

	
	UPDATE #PURCHASEHEADERDETAILS
			SET LEDGER_PURCHASEVALUE=LEDGER_MRPVALUE-(LEDGER_MRPVALUE*LEDGER_MARKDOWN/100.00)
			   ,INVOICE_MARKDOWN=(CASE WHEN INVOICE_MRPVALUE=0 THEN 0
									ELSE (((INVOICE_MRPVALUE-INVOICE_PURCHASEVALUE)/INVOICE_MRPVALUE)*100)
									END)
									
	UPDATE #PURCHASEHEADERDETAILS  SET LEDGER_PURCHASEVALUE =LEDGER_PURCHASEVALUE-isnull(REIMUBURSE_AMT_GST,0)
	UPDATE #PURCHASEHEADERDETAILS  SET LEDGER_DISCOUNTAMOUNT =((LEDGER_PURCHASEVALUE)*LEDGER_DISCOUNTPERCENTAGE )/100 --AD  DISCOUNT AMOUNT
	
	
	UPDATE #PURCHASEHEADERDETAILS
			SET LEDGER_DISCOUNTAMOUNT=(LEDGER_PURCHASEVALUE)*LEDGER_DISCOUNTPERCENTAGE/100
	---REIMUBURSE_AMT_GST
	
	UPDATE #PURCHASEHEADERDETAILS
			SET LEDGER_NETAMOUNT=LEDGER_PURCHASEVALUE-LEDGER_DISCOUNTAMOUNT+LEDGER_EXCISEDUTYAMOUNT
								 + CASE WHEN (BILL_LEVEL_TAX_METHOD=1 OR @PICK_INVOICE_TAX_AMOUNT_IN_LEDGER ='1') 
								 THEN  LEDGER_TAXAMOUNT ELSE 0 END 
								 -LEDGER_POSTTAXDISCOUNTAMOUNT+LEDGER_FREIGHT
								 +LEDGER_OTHERCHARGES
								 
								 --ISNULL(REIMUBURSE_AMT_GST,0)
	
	UPDATE #PURCHASEHEADERDETAILS 
			SET  LEDGER_ROUNDOFF =ROUND(LEDGER_NETAMOUNT,0)-LEDGER_NETAMOUNT
				,LEDGER_NETAMOUNT=ROUND(LEDGER_NETAMOUNT,0)
	
	
	IF @nMode=2
	BEGIN
	   
	  -- if @@spid=598
			--select INVOICE_PURCHASEVALUE,INVOICE_DISCOUNTAMOUNT,LEDGER_PURCHASEVALUE,LEDGER_DISCOUNTAMOUNT, * from #PURCHASEHEADERDETAILS

	   INSERT INTO #TMPTAXABLEVALUEDIFF
	   SELECT SUM(INVOICE_NETAMOUNT - LEDGER_NETAMOUNT)
	   FROM #PURCHASEHEADERDETAILS
	    
	
	END
	ELSE
	IF @nMode=1
	BEGIN

		 IF @bConvertedMrr=0
			SELECT 
		  			 INVOICE_DISCOUNTPERCENTAGE
		  			,INVOICE_DISCOUNTAMOUNT
		  			,INVOICE_EXCISEDUTYAMOUNT
		  			,INVOICE_TAXAMOUNT
		  			,INVOICE_POSTTAXDISCOUNTAMOUNT
		  			,INVOICE_FREIGHT
		  			,INVOICE_OTHERCHARGES
		  			,INVOICE_ROUNDOFF
		  			,INVOICE_NETAMOUNT
		  			,INVOICE_MRPVALUE
		  			,INVOICE_PURCHASEVALUE
		  			,INVOICE_MARKDOWN
		  			,LEDGER_DISCOUNTPERCENTAGE
		  			,LEDGER_DISCOUNTAMOUNT
		  			,LEDGER_EXCISEDUTYAMOUNT
		  			,LEDGER_TAXAMOUNT
		  			,LEDGER_POSTTAXDISCOUNTAMOUNT
		  			,LEDGER_FREIGHT
		  			,LEDGER_OTHERCHARGES
		  			,LEDGER_ROUNDOFF
		  			,LEDGER_NETAMOUNT
		  			,LEDGER_MRPVALUE
		  			,LEDGER_PURCHASEVALUE
		  			,LEDGER_MARKDOWN
		  			,(LEDGER_DISCOUNTPERCENTAGE - INVOICE_DISCOUNTPERCENTAGE) AS DIFF_DISCOUNTPERCENTAGE
		  			,(LEDGER_DISCOUNTAMOUNT-INVOICE_DISCOUNTAMOUNT) AS DIFF_DISCOUNTAMOUNT
		  			,(INVOICE_EXCISEDUTYAMOUNT - LEDGER_EXCISEDUTYAMOUNT) AS DIFF_EXCISEDUTYAMOUNT
		  			,(INVOICE_TAXAMOUNT-LEDGER_TAXAMOUNT) AS DIFF_TAXAMOUNT
		  			,(LEDGER_POSTTAXDISCOUNTAMOUNT - INVOICE_POSTTAXDISCOUNTAMOUNT) AS DIFF_POSTTAXDISCOUNTAMOUNT
		  			,(INVOICE_FREIGHT - LEDGER_FREIGHT) AS DIFF_FREIGHT
		  			,(INVOICE_OTHERCHARGES - LEDGER_OTHERCHARGES) AS DIFF_OTHERCHARGES
		  			,(INVOICE_ROUNDOFF - LEDGER_ROUNDOFF) AS DIFF_ROUNDOFF
		  			,(INVOICE_NETAMOUNT - LEDGER_NETAMOUNT) AS DIFF_NETAMOUNT
		  			,(INVOICE_MRPVALUE - LEDGER_MRPVALUE) AS DIFF_MRPVALUE	
		  			,(INVOICE_PURCHASEVALUE - LEDGER_PURCHASEVALUE) AS DIFF_PURCHASEVALUE
		  			,(LEDGER_MARKDOWN - INVOICE_MARKDOWN) AS DIFF_MARKDOWN
		  			,REIMUBURSE_AMT_GST
		  	
			FROM #PURCHASEHEADERDETAILS	
		else
	     	SELECT 
		  		avg( INVOICE_DISCOUNTPERCENTAGE) as INVOICE_DISCOUNTPERCENTAGE
		  		,sum(INVOICE_DISCOUNTAMOUNT) as INVOICE_DISCOUNTAMOUNT
		  		,sum(INVOICE_EXCISEDUTYAMOUNT) as INVOICE_EXCISEDUTYAMOUNT
		  		,sum(INVOICE_TAXAMOUNT) as INVOICE_TAXAMOUNT
		  		,sum(INVOICE_POSTTAXDISCOUNTAMOUNT) as INVOICE_POSTTAXDISCOUNTAMOUNT
		  		,sum(INVOICE_FREIGHT) as INVOICE_FREIGHT
		  		,sum(INVOICE_OTHERCHARGES) as INVOICE_OTHERCHARGES
		  		,sum(INVOICE_ROUNDOFF) as INVOICE_ROUNDOFF
		  		,sum(INVOICE_NETAMOUNT) as INVOICE_NETAMOUNT
		  		,sum(INVOICE_MRPVALUE) as INVOICE_MRPVALUE
		  		,sum(INVOICE_PURCHASEVALUE) as INVOICE_PURCHASEVALUE
		  		,avg(INVOICE_MARKDOWN) as INVOICE_MARKDOWN
		  		,avg(LEDGER_DISCOUNTPERCENTAGE) as LEDGER_DISCOUNTPERCENTAGE
		  		,sum(LEDGER_DISCOUNTAMOUNT) as LEDGER_DISCOUNTAMOUNT
		  		,sum(LEDGER_EXCISEDUTYAMOUNT) as LEDGER_EXCISEDUTYAMOUNT
		  		,sum(LEDGER_TAXAMOUNT) as LEDGER_TAXAMOUNT
		  		,sum(LEDGER_POSTTAXDISCOUNTAMOUNT) as LEDGER_POSTTAXDISCOUNTAMOUNT
		  		,sum(LEDGER_FREIGHT) as LEDGER_FREIGHT
		  		,sum(LEDGER_OTHERCHARGES) as LEDGER_OTHERCHARGES
		  		,sum(LEDGER_ROUNDOFF) as LEDGER_ROUNDOFF
		  		,sum(LEDGER_NETAMOUNT) as LEDGER_NETAMOUNT
		  		,sum(LEDGER_MRPVALUE) as LEDGER_MRPVALUE
		  		,sum(LEDGER_PURCHASEVALUE) as LEDGER_PURCHASEVALUE
		  		,sum(LEDGER_MARKDOWN) as LEDGER_MARKDOWN
		  		,(avg(LEDGER_DISCOUNTPERCENTAGE) - avg(INVOICE_DISCOUNTPERCENTAGE)) AS DIFF_DISCOUNTPERCENTAGE
		  		,sum(LEDGER_DISCOUNTAMOUNT-INVOICE_DISCOUNTAMOUNT) AS DIFF_DISCOUNTAMOUNT
		  		,sum(INVOICE_EXCISEDUTYAMOUNT - LEDGER_EXCISEDUTYAMOUNT) AS DIFF_EXCISEDUTYAMOUNT
		  		,sum(INVOICE_TAXAMOUNT-LEDGER_TAXAMOUNT) AS DIFF_TAXAMOUNT
		  		,sum(LEDGER_POSTTAXDISCOUNTAMOUNT - INVOICE_POSTTAXDISCOUNTAMOUNT) AS DIFF_POSTTAXDISCOUNTAMOUNT
		  		,sum(INVOICE_FREIGHT - LEDGER_FREIGHT) AS DIFF_FREIGHT
		  		,sum(INVOICE_OTHERCHARGES - LEDGER_OTHERCHARGES) AS DIFF_OTHERCHARGES
		  		,sum(INVOICE_ROUNDOFF - LEDGER_ROUNDOFF) AS DIFF_ROUNDOFF
		  		,sum(INVOICE_NETAMOUNT - LEDGER_NETAMOUNT) AS DIFF_NETAMOUNT
		  		,sum(INVOICE_MRPVALUE - LEDGER_MRPVALUE) AS DIFF_MRPVALUE	
		  		,sum(INVOICE_PURCHASEVALUE - LEDGER_PURCHASEVALUE) AS DIFF_PURCHASEVALUE
		  		,sum(LEDGER_MARKDOWN - INVOICE_MARKDOWN) AS DIFF_MARKDOWN
		  		,sum(REIMUBURSE_AMT_GST) as REIMUBURSE_AMT_GST
		  	
			FROM #PURCHASEHEADERDETAILS	

	end

	ELSE
	IF @nMode=3
	BEGIN
		SELECT *  
		--DIFFERENCE CURSOR  
		,(CASE WHEN INVOICE_NETAMOUNT>LEDGER_NETAMOUNT  
		THEN (INVOICE_NETAMOUNT - LEDGER_NETAMOUNT)  
		ELSE 0 END) AS DIFF_NETAMOUNT  
		,CAST(0 AS INT) AS ACTION_CODE  
		,INVOICE_NO+BILL_NO+
		CONVERT(VARCHAR(20),INVOICE_DATE,105)+
		INVOICE_SUPPLIER+
		CAST(INVOICE_NETAMOUNT AS VARCHAR(100))+
		CAST(LEDGER_NETAMOUNT AS VARCHAR(100))+
		CAST((CASE WHEN INVOICE_NETAMOUNT>LEDGER_NETAMOUNT  
		THEN (INVOICE_NETAMOUNT - LEDGER_NETAMOUNT)  
		ELSE 0 END) AS VARCHAR(100)) AS SEARCH_STR
		FROM #PURCHASEHEADERDETAILS  
		WHERE INVOICE_NETAMOUNT>LEDGER_NETAMOUNT     
		ORDER BY INVOICE_DATE,INVOICE_NO  
	END
	ELSE
	IF @nMode=4
	BEGIN
		INSERT INTO pending_purapp_ledgernet (mrr_id,LEDGER_NETAMOUNT)							
		SELECT  a.mrr_id,LEDGER_NETAMOUNT FROM #PURCHASEHEADERDETAILS a

		INSERT INTO pending_purapp_ledgernet (mrr_id,LEDGER_NETAMOUNT)							
		SELECT  ref_converted_mrntobill_mrrid,SUM(LEDGER_NETAMOUNT) FROM #PURCHASEHEADERDETAILS a
		JOIN pim01106 b (NOLOCK) ON a.mrr_id=b.mrr_id
		WHERE ISNULL(ref_converted_mrntobill_mrrid,'')<>''
		GROUP BY ref_converted_mrntobill_mrrid

	END
	
END
