CREATE PROCEDURE SP_MERGE_MIRROR_SNC_DATA
(
	@CMEMOID VARCHAR(50)
   ,@CLOCID VARCHAR(3)
   ,@CSOURCEDB VARCHAR(200)
   ,@CMERGEDB VARCHAR(200)
   ,@BMSTINSERTONLY BIT
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
AS
BEGIN

	DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
		   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
		   ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
		   ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(MAX)
	BEGIN TRY
		DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(40))  	
		
		DECLARE @CMEMOIDSEARCH VARCHAR(100)
		SELECT TOP 1 @CMEMOIDSEARCH=A.MEMO_ID FROM SNC_MST A (NOLOCK) WHERE A.MEMO_ID=@CMEMOID
		
		
		SET @CSTEP=20
		SET @CTABLE_SUFFIX=REPLACE(@CMEMOID,'-','_')
		BEGIN TRANSACTION 
		SET @CSOURCEDB = DB_NAME()+'_TEMP..'
		SET @CSTEP=50
		SET @CTABLENAME='SNC_BARCODE_DET'
		SET @CTMP_TABLENAME=@CSOURCEDB+'TMP_SNC_SNC_DET_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CSTEP=60
		SET @DTSQL = N'DELETE  A FROM '+@CTABLENAME+' A JOIN '+@CTMP_TABLENAME+' B 
						ON A.REFROW_ID = B.ROW_ID'
		PRINT @DTSQL
		EXEC SP_EXECUTESQL 	@DTSQL

		SET @CSTEP=70
		SET @CTABLENAME='SNC_CONSUMABLE_DET'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='MEMO_ID'
		SET @CSTEP=80
		SET @DTSQL=N'DELETE  FROM '+@CMERGEDB+'['+@CTABLENAME+']  WHERE '+@CKEYFIELD+' = '''+@CMEMOID+''' '
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL
		
					
		SET @CSTEP=90
		SET @CTABLENAME='SNC_DET'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='MEMO_ID'
		SET @CSTEP=100
		SET @DTSQL=N'DELETE  FROM '+@CMERGEDB+'['+@CTABLENAME+']  WHERE '+@CKEYFIELD+' = '''+@CMEMOID+''''
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL
		
		
		SET @CTABLENAME='PARA1'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='PARA1_CODE'
		SET @CSTEP=120
		
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA1_NAME',@CCOLKEYNAME=@CKEYFIELD

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
		SET @CSTEP=130
		SET @CTABLENAME='PARA2'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='PARA2_CODE'
		SET @CSTEP=140
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA2_NAME',@CCOLKEYNAME=@CKEYFIELD


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
								  
		SET @CSTEP=150
		SET @CTABLENAME='PARA3'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='PARA3_CODE'
		SET @CSTEP=160
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA3_NAME',@CCOLKEYNAME=@CKEYFIELD


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1		
		SET @CSTEP=170
		SET @CTABLENAME='PARA4'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='PARA4_CODE'
		SET @CSTEP=180
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA4_NAME',@CCOLKEYNAME=@CKEYFIELD


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
		SET @CSTEP=190
		SET @CTABLENAME='PARA5'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='PARA5_CODE'
		SET @CSTEP=200
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA5_NAME',@CCOLKEYNAME=@CKEYFIELD


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
								  								  								  						  						  						  
		SET @CSTEP=210
		SET @CTABLENAME='PARA6'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='PARA6_CODE'
		SET @CSTEP=220
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA6_NAME',@CCOLKEYNAME=@CKEYFIELD


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
							  
		
		SET @CSTEP=250
		SET @CTABLENAME='SECTIONM'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='SECTION_CODE'
		SET @CSTEP=260
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='SECTION_NAME',@CCOLKEYNAME=@CKEYFIELD


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1	
		
		SET @CSTEP=250
		SET @CTABLENAME='SECTIOND'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='SUB_SECTION_CODE'
		SET @CSTEP=260
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='SUB_SECTION_NAME',@CCOLKEYNAME=@CKEYFIELD


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1	
								  
		
										  
        SET @CSTEP=230
		SET @CTABLENAME='ARTICLE'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='ARTICLE_CODE'
		SET @CSTEP=240
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='ARTICLE_NO',@CCOLKEYNAME=@CKEYFIELD


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1	
								  
         SET @CSTEP=235
		SET @CTABLENAME='ATTRM'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='ATTRIBUTE_CODE'
		SET @CSTEP=240
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1	
								  
        SET @CSTEP=235
		SET @CTABLENAME='ATTR_KEY'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='KEY_CODE'
		SET @CSTEP=240
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
								  
        SET @CSTEP=235
		SET @CTABLENAME='ART_ATTR'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='ARTICLE_CODE'
		SET @CSTEP=240
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1									  									  								  							  
		
		SET @CSTEP=250
		SET @CTABLENAME='SKU'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='PRODUCT_CODE'
		SET @CSTEP=260
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1	
								  						  
		SET @CSTEP=250
		SET @CTABLENAME='SKU_OH'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='PRODUCT_CODE'
		SET @CSTEP=260
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1							  						  						  
								  
		SET @CSTEP=300
		SET @CTABLENAME='SNC_MST'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='MEMO_ID'
		SET @CSTEP=320
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1 
		
		SET @CSTEP=350
		SET @CTABLENAME='SNC_DET'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='MEMO_ID'
		SET @CSTEP=360
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1 						  
		

		SET @CSTEP=400
		SET @CTABLENAME='SNC_CONSUMABLE_DET'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='MEMO_ID'
		SET @CSTEP=500
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1 
								  
		SET @CSTEP=600
		SET @CTABLENAME='SNC_BARCODE_DET'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='REFROW_ID'
		SET @CSTEP=700
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1 
							

		SET @CSTEP=705 
		
		SET @CTMP_TABLENAME=@CSOURCEDB+'TMP_SNC_pmt01106_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		EXEC SP3S_MERGE_LOCPMT  
		@cTempTable=@CTMP_TABLENAME,
		@CXN_TYPE='SNC'
	
		SET @cStep=710
									  
		IF ISNULL(@CERRMSGOUT,'')<>''
			BEGIN
				SET @CERRMSG='P:SP_MERGE_MIRROR_SNC_DATA, STEP:'+@CSTEP+', MESSAGE:'+@CERRMSGOUT
			END	

			SET @CSTEP=800
			
			SET @CTABLESSTR='SNC_MST,SNC_DET,PARA1,PARA2,PARA3,PARA4,PARA5,PARA6,SNC_CONSUMABLE_DET,SNC_BARCODE_DET,PMT01106,XNSTABLELIST'

			EXEC SP3S_DROPTEMPTABLES_MIRRORDATA
			@CXNTYPE='SNC',
			@CTABLESUFFIX=@CTABLE_SUFFIX,
			@CTABLESSTR=@CTABLESSTR								  						  
	END TRY
	BEGIN CATCH
		SET @CERRMSG='P:SP_MERGE_MIRROR_SNC_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH

EXIT_PROC:
	
	
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
	END
	ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK
END
