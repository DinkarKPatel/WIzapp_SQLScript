CREATE FUNCTION FN_GETCMM_EMP
(@CXNID VARCHAR(40))
RETURNS VARCHAR(200)
--WITH ENCRYPTION

AS
BEGIN
	
	DECLARE @CSALESPERSONNAME VARCHAR(200),@CSPNAME VARCHAR(200),@BLOOP BIT,@CEMPCODE CHAR(7)	
	
	DECLARE @TEMP TABLE (EMP_CODE CHAR(7))
	
	INSERT @TEMP 
	SELECT DISTINCT EMP_CODE FROM CMD01106 WHERE CM_ID=@CXNID
	UNION 
	SELECT DISTINCT EMP_CODE1 FROM CMD01106 WHERE CM_ID=@CXNID
	UNION
	SELECT DISTINCT EMP_CODE2 FROM CMD01106 WHERE CM_ID=@CXNID
	
	SET @CSALESPERSONNAME=''
	
	SET @BLOOP=0
	
	WHILE @BLOOP=0
	BEGIN
		SET @CEMPCODE=''
		SELECT TOP 1 @CEMPCODE=EMP_CODE FROM @TEMP
		
		IF ISNULL(@CEMPCODE,'')=''
			BREAK
			
		SELECT TOP 1 @CSPNAME=EMP_NAME FROM EMPLOYEE A WHERE EMP_CODE=@CEMPCODE
		
		SET @CSALESPERSONNAME=@CSALESPERSONNAME+(CASE WHEN @CSALESPERSONNAME<>'' THEN ',' ELSE '' END)+@CSPNAME
		
		DELETE FROM @TEMP WHERE EMP_CODE=@CEMPCODE
	END
						  
	RETURN @CSALESPERSONNAME
END
