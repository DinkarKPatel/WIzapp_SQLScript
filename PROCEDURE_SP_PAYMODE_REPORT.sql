create PROC SP_PAYMODE_REPORT
@DEPTID VARCHAR(10),
@FROMDT DATETIME,
@TODT DATETIME
--WITH ENCRYPTION
AS
DECLARE @TEMP_VAL VARCHAR(50)
--(dinkar) Replace  left(memoid,2) to Location_code 
BEGIN
IF @DEPTID=''
BEGIN
		SELECT     location_Code  AS [DEPT_ID],LOCATION.DEPT_NAME AS [DEPT_NAME],CM_NO AS [MEMO_NO], MEMO_TYPE AS [MEMO_TYPE], CM_DT AS [MEMO_DATE],
				   NET_AMOUNT AS [MEMO_AMOUNT],PP.TT_AMOUNT AS [PAY_AMOUNT],PAYMODE_NAME,PAYMODE_GRP_NAME AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		           FROM CMM01106 AS CC JOIN 
				   (SELECT MEMO_ID,SUM(AMOUNT) AS TT_AMOUNT,PAYMODE_NAME,PAYMODE_GRP_NAME FROM PAYMODE_XN_DET 
				   JOIN PAYMODE_MST ON PAYMODE_MST.PAYMODE_CODE = PAYMODE_XN_DET.PAYMODE_CODE 
				   JOIN PAYMODE_GRP_MST AS LL ON LL.PAYMODE_GRP_CODE = PAYMODE_MST.PAYMODE_GRP_CODE
				   WHERE XN_TYPE = 'SLS'
				   GROUP BY MEMO_ID,PAYMODE_GRP_NAME ,PAYMODE_NAME ) AS PP ON CC.CM_ID = PP.MEMO_ID 
				   JOIN LOCATION ON location_Code = LOCATION.DEPT_ID
				   WHERE CM_DT >= @FROMDT AND CM_DT <= @TODT AND CC.CANCELLED=0 
				   				   
		UNION 
		SELECT     location_Code  AS [DEPT_ID],LOCATION.DEPT_NAME AS [DEPT_NAME],CM_NO AS [MEMO_NO], MEMO_TYPE AS [MEMO_TYPE], CM_DT AS [MEMO_DATE],
				   CONVERT(NUMERIC(14,2),0) AS [MEMO_AMOUNT],CONVERT(NUMERIC(14,2),0) AS [PAY_AMOUNT],'INR' AS PAYMODE_NAME,'0000000' AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		           FROM CMM01106 AS CC  
				   JOIN LOCATION ON location_Code = LOCATION.DEPT_ID
				   WHERE CM_DT >= @FROMDT AND CM_DT <= @TODT AND CC.CANCELLED=1 
				   				   
		UNION 
		SELECT     CC.location_Code   AS [DEPT_ID], LOCATION.DEPT_NAME AS [DEPT_NAME],INV_NO  AS [MEMO_NO],MEMO_TYPE AS [MEMO_TYPE], INV_DT AS [MEMO_DATE],
				   NET_AMOUNT AS [MEMO_AMOUNT] ,PP.TT_AMOUNT AS [PAY_AMOUNT],PAYMODE_NAME,PAYMODE_GRP_NAME AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		           FROM INM01106 AS CC  JOIN
				   (SELECT MEMO_ID,SUM(AMOUNT) AS TT_AMOUNT,PAYMODE_NAME,PAYMODE_GRP_NAME FROM PAYMODE_XN_DET 
				   JOIN PAYMODE_MST ON PAYMODE_MST.PAYMODE_CODE = PAYMODE_XN_DET.PAYMODE_CODE 
				   JOIN PAYMODE_GRP_MST AS LL ON LL.PAYMODE_GRP_CODE = PAYMODE_MST.PAYMODE_GRP_CODE
				   WHERE XN_TYPE = 'WSL'
				   GROUP BY MEMO_ID,PAYMODE_GRP_NAME,PAYMODE_NAME  ) AS PP ON CC.INV_ID  = PP.MEMO_ID 
				   JOIN LOCATION ON CC.DEPT_ID = LOCATION.DEPT_ID
				   WHERE INV_DT >= @FROMDT AND INV_DT <= @TODT AND CC.CANCELLED=0
		UNION
		SELECT     CC.location_Code   AS [DEPT_ID], LOCATION.DEPT_NAME AS [DEPT_NAME],INV_NO  AS [MEMO_NO],MEMO_TYPE AS [MEMO_TYPE], INV_DT AS [MEMO_DATE],
				   CONVERT(NUMERIC(14,2),0) AS [MEMO_AMOUNT] ,CONVERT(NUMERIC(14,2),0) AS [PAY_AMOUNT],'INR' AS PAYMODE_NAME,'0000000' AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		           FROM INM01106 AS CC  
				   JOIN LOCATION ON CC.DEPT_ID = LOCATION.DEPT_ID
				   WHERE INV_DT >= @FROMDT AND INV_DT <= @TODT  AND CC.CANCELLED=1
		UNION  
		SELECT    location_Code  AS [DEPT_ID],LOCATION.DEPT_NAME AS [DEPT_NAME], ADV_REC_NO AS [MEMO_NO], ARC_TYPE AS [MEMO_TYPE] ,ADV_REC_DT AS [MEMO_DATE],
				  CC.NET_AMOUNT * (CASE WHEN CC.ARC_TYPE=2 THEN -1 ELSE 1 END) AS [MEMO_AMOUNT],PP.TT_AMOUNT  * (CASE WHEN CC.ARC_TYPE=2 THEN -1 ELSE 1 END)  AS [PAY_AMOUNT],PAYMODE_NAME,PAYMODE_GRP_NAME AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		FROM      ARC01106 AS CC JOIN
				  (SELECT MEMO_ID,SUM(AMOUNT) AS TT_AMOUNT,PAYMODE_NAME,PAYMODE_GRP_NAME FROM PAYMODE_XN_DET 
				  JOIN PAYMODE_MST ON PAYMODE_MST.PAYMODE_CODE = PAYMODE_XN_DET.PAYMODE_CODE 
				   JOIN PAYMODE_GRP_MST AS LL ON LL.PAYMODE_GRP_CODE = PAYMODE_MST.PAYMODE_GRP_CODE			  
				  WHERE XN_TYPE = 'ARC'
				  GROUP BY MEMO_ID,PAYMODE_GRP_NAME,PAYMODE_NAME  ) AS PP ON CC.ADV_REC_ID  = PP.MEMO_ID 
				  JOIN LOCATION ON cc.location_Code = LOCATION.DEPT_ID
				  WHERE ADV_REC_DT >= @FROMDT AND ADV_REC_DT <= @TODT AND CC.CANCELLED=0 
		UNION  
		SELECT    location_Code  AS [DEPT_ID],LOCATION.DEPT_NAME AS [DEPT_NAME], ADV_REC_NO AS [MEMO_NO], ARC_TYPE AS [MEMO_TYPE] ,ADV_REC_DT AS [MEMO_DATE],
				  CONVERT(NUMERIC(14,2),0) AS [MEMO_AMOUNT],CONVERT(NUMERIC(14,2),0) AS [PAY_AMOUNT],'INR' AS PAYMODE_NAME,'0000000' AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		FROM      ARC01106 AS CC  
				  JOIN LOCATION ON cc.location_Code = LOCATION.DEPT_ID
				  WHERE ADV_REC_DT >= @FROMDT AND ADV_REC_DT <= @TODT AND CC.CANCELLED=1 
		ORDER BY [MEMO_DATE],[MEMO_NO]		  
END
ELSE
BEGIN
SELECT     location_Code  AS [DEPT_ID],LOCATION.DEPT_NAME AS [DEPT_NAME],CM_NO AS [MEMO_NO], MEMO_TYPE AS [MEMO_TYPE], CM_DT AS [MEMO_DATE],
				   NET_AMOUNT AS [MEMO_AMOUNT],PP.TT_AMOUNT AS [PAY_AMOUNT],PAYMODE_NAME,PAYMODE_GRP_NAME AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		FROM       CMM01106 AS CC JOIN 
				   (SELECT MEMO_ID,SUM(AMOUNT) AS TT_AMOUNT,PAYMODE_NAME,PAYMODE_GRP_NAME FROM PAYMODE_XN_DET 
				   JOIN PAYMODE_MST ON PAYMODE_MST.PAYMODE_CODE = PAYMODE_XN_DET.PAYMODE_CODE 
				   JOIN PAYMODE_GRP_MST AS LL ON LL.PAYMODE_GRP_CODE = PAYMODE_MST.PAYMODE_GRP_CODE
				   WHERE XN_TYPE = 'SLS'
				   GROUP BY MEMO_ID,PAYMODE_GRP_NAME ,PAYMODE_NAME ) AS PP ON CC.CM_ID = PP.MEMO_ID 
				   JOIN LOCATION ON cc.location_Code = LOCATION.DEPT_ID
				   WHERE CM_DT >= @FROMDT AND CM_DT <= @TODT  AND  location_Code  = @DEPTID AND CC.CANCELLED=0 
				   
		UNION 
		SELECT     location_Code  AS [DEPT_ID],LOCATION.DEPT_NAME AS [DEPT_NAME],CM_NO AS [MEMO_NO], MEMO_TYPE AS [MEMO_TYPE], CM_DT AS [MEMO_DATE],
				   CONVERT(NUMERIC(14,2),0) AS [MEMO_AMOUNT],CONVERT(NUMERIC(14,2),0) AS [PAY_AMOUNT],'INR' AS PAYMODE_NAME,'0000000' AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		FROM       CMM01106 AS CC 
				   JOIN LOCATION ON cc.location_Code = LOCATION.DEPT_ID
				   WHERE CM_DT >= @FROMDT AND CM_DT <= @TODT  AND  location_Code  = @DEPTID AND CC.CANCELLED=1 
				   
		UNION 
		SELECT     CC.DEPT_ID  AS [DEPT_ID],LOCATION.DEPT_NAME AS [DEPT_NAME], INV_NO  AS [MEMO_NO],MEMO_TYPE AS [MEMO_TYPE], INV_DT AS [MEMO_DATE],
				   NET_AMOUNT AS [MEMO_AMOUNT] ,PP.TT_AMOUNT AS [PAY_AMOUNT],PAYMODE_NAME,PAYMODE_GRP_NAME AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		FROM       INM01106 AS CC  JOIN
				   (SELECT MEMO_ID,SUM(AMOUNT) AS TT_AMOUNT,PAYMODE_NAME,PAYMODE_GRP_NAME FROM PAYMODE_XN_DET 
				   JOIN PAYMODE_MST ON PAYMODE_MST.PAYMODE_CODE = PAYMODE_XN_DET.PAYMODE_CODE 
				   JOIN PAYMODE_GRP_MST AS LL ON LL.PAYMODE_GRP_CODE = PAYMODE_MST.PAYMODE_GRP_CODE
				   WHERE XN_TYPE = 'WSL'
				   GROUP BY MEMO_ID,PAYMODE_GRP_NAME,PAYMODE_NAME  ) AS PP ON CC.INV_ID  = PP.MEMO_ID 
				    JOIN LOCATION ON CC.DEPT_ID = LOCATION.DEPT_ID
				   WHERE INV_DT >= @FROMDT AND INV_DT <= @TODT AND  CC.DEPT_ID = @DEPTID AND CC.CANCELLED=0 		   
		UNION 
		SELECT     CC.DEPT_ID  AS [DEPT_ID],LOCATION.DEPT_NAME AS [DEPT_NAME], INV_NO  AS [MEMO_NO],MEMO_TYPE AS [MEMO_TYPE], INV_DT AS [MEMO_DATE],
				   CONVERT(NUMERIC(14,2),0) AS [MEMO_AMOUNT] ,CONVERT(NUMERIC(14,2),0) AS [PAY_AMOUNT],'INR' AS PAYMODE_NAME,'0000000' AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		FROM       INM01106 AS CC   
				   JOIN LOCATION ON CC.DEPT_ID = LOCATION.DEPT_ID
				   WHERE INV_DT >= @FROMDT AND INV_DT <= @TODT AND  CC.DEPT_ID = @DEPTID AND CC.CANCELLED=1 
		UNION 
		SELECT    cc.location_Code  AS [DEPT_ID],LOCATION.DEPT_NAME AS [DEPT_NAME], ADV_REC_NO AS [MEMO_NO], ARC_TYPE AS [MEMO_TYPE] ,ADV_REC_DT AS [MEMO_DATE],
				  CC.NET_AMOUNT * (CASE WHEN CC.ARC_TYPE=2 THEN -1 ELSE 1 END)  AS [MEMO_AMOUNT],PP.TT_AMOUNT  * (CASE WHEN CC.ARC_TYPE=2 THEN -1 ELSE 1 END)  AS [PAY_AMOUNT],
				  PAYMODE_NAME,PAYMODE_GRP_NAME AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		FROM      ARC01106 AS CC JOIN
				  (SELECT MEMO_ID,SUM(AMOUNT) AS TT_AMOUNT,PAYMODE_NAME,PAYMODE_GRP_NAME FROM PAYMODE_XN_DET 
				  JOIN PAYMODE_MST ON PAYMODE_MST.PAYMODE_CODE = PAYMODE_XN_DET.PAYMODE_CODE 
				   JOIN PAYMODE_GRP_MST AS LL ON LL.PAYMODE_GRP_CODE = PAYMODE_MST.PAYMODE_GRP_CODE			  
				  WHERE XN_TYPE = 'ARC'
				  GROUP BY MEMO_ID,PAYMODE_GRP_NAME,PAYMODE_NAME  ) AS PP ON CC.ADV_REC_ID  = PP.MEMO_ID 
				   JOIN LOCATION ON cc.location_Code = LOCATION.DEPT_ID
				  WHERE ADV_REC_DT >= @FROMDT AND ADV_REC_DT <= @TODT AND   cc.location_Code  = @DEPTID AND CC.CANCELLED=0 
		UNION 
		SELECT    cc.location_Code  AS [DEPT_ID],LOCATION.DEPT_NAME AS [DEPT_NAME], ADV_REC_NO AS [MEMO_NO], ARC_TYPE AS [MEMO_TYPE] ,ADV_REC_DT AS [MEMO_DATE],
				  CONVERT(NUMERIC(14,2),0) AS [MEMO_AMOUNT],CONVERT(NUMERIC(14,2),0)  AS [PAY_AMOUNT],'INR' AS PAYMODE_NAME,'0000000' AS [PAYMODE_GROUP_NAME],CC.CANCELLED
		FROM      ARC01106 AS CC 
				   JOIN LOCATION ON cc.location_Code = LOCATION.DEPT_ID
				  WHERE ADV_REC_DT >= @FROMDT AND ADV_REC_DT <= @TODT AND   cc.location_Code  = @DEPTID AND CC.CANCELLED=1 		
		ORDER BY [MEMO_DATE],[MEMO_NO]				  
END

END
