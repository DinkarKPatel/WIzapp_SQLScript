
CREATE PROCEDURE SP3S_PENDING_DASHBOARD_TAT 
(
 @DFMDATE DATETIME='2018-04-10' ,
 @DTODATE DATETIME='2018-12-28' ,
 @CDEPT_ID VARCHAR(5)='',
 @NPENDING INT =0 --0 FOR COMPLETED ,1 PENDING
 --IN TAT FILTER FROM TO DATE ,AS ON DATE IN PENDENCEY
)
AS
BEGIN

      DECLARE  @TBLDET TABLE (SR INT,XN_NAME VARCHAR(1000),DEPT_ID VARCHAR(5),MEMO_NO VARCHAR(100),MEMO_DT DATETIME,
      XN_QTY NUMERIC(10,3),NET_AMOUNT NUMERIC(18,3),TAT_DAYS NUMERIC(3,0),Due_days numeric(4,0))
      
      DECLARE  @TBLDETPENDING TABLE (SR INT,XN_NAME VARCHAR(1000),DEPT_ID VARCHAR(5),MEMO_NO VARCHAR(100),MEMO_DT DATETIME,
      XN_QTY NUMERIC(10,3),PENDING_QTY NUMERIC(10,3),NET_AMOUNT NUMERIC(18,3),PENDING_AMOUNT NUMERIC(18,3),TAT_DAYS NUMERIC(3,0),Due_days numeric(4,0))
   
     
     
   	IF OBJECT_ID('tempdb..#APPROVALLOCATION','U') IS NOT NULL
	   DROP TABLE #APPROVALLOCATION
			
			SELECT DISTINCT DEPT_ID 
			INTO #APPROVALLOCATION
			FROM LOC_XNSAPPROVAL
			WHERE XN_TYPE='PUR'
			
			DECLARE @IMAXLEVEL INT
			
			SELECT @IMAXLEVEL=MAX(LEVEL_NO) 
			FROM XN_APPROVAL_CHECKLIST_LEVELS 
			WHERE XN_TYPE='PUR' AND INACTIVE=0
			
			DECLARE @DCUTOFFDATE  DATETIME
			SELECT TOP 1 @DCUTOFFDATE=CUTOFFDATE FROM GST_ACCOUNTS_CONFIG_MST WHERE XN_TYPE='PUR'

	        SET @DCUTOFFDATE=ISNULL(@DCUTOFFDATE,'')
			
	
			
IF @NPENDING=0 
    GOTO LBLTAT
ELSE IF @NPENDING=1
    GOTO LBLPENDING
 ELSE
    GOTO END_PROC
      
        
        
        LBLTAT:
             
             PRINT '1 BUDGET PLAN'
             
             INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS)
             
			 SELECT MST.SR,MST.XN_NAME,A.location_code AS DEPT_ID, 
			        A.MEMO_NO ,A.MEMO_DT ,0 AS XN_QTY,SUM(BUDGET_AMOUNT) AS BUDGET_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) AS TAT_DAYS,
			        DATEDIFF (DAY ,A.MEMO_DT +ISNULL(A.TAT_DAYS,0), BM.MEMO_DT)  AS DUE_DAYS
			   
			 FROM BUDGET_PLAN_MST A (NOLOCK)
			 JOIN BUDGET_PLAN_DET B (NOLOCK) ON A.MEMO_NO =B.MEMO_NO 
			 JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='BDGPL'
			 JOIN 
			 (
			    SELECT BUDGET_PLAN_MEMO_NO,MAX(MEMO_DT) AS MEMO_DT 
			    FROM   BUY_PLAN_MST BM 
			    WHERE  BM.CANCELLED =0
			    GROUP BY BUDGET_PLAN_MEMO_NO
			 )BM ON BM.BUDGET_PLAN_MEMO_NO =A.MEMO_NO 
			 WHERE A.CANCELLED =0 
			 AND (@CDEPT_ID='' OR A.location_code =@CDEPT_ID)
			 AND A.MEMo_DT BETWEEN @DFMDATE AND @DTODATE
			 GROUP BY MST.SR,MST.XN_NAME,location_code , 
			 A.MEMO_NO ,A.MEMO_DT ,DATEDIFF (DAY ,A.MEMO_DT +ISNULL(A.TAT_DAYS,0), BM.MEMO_DT),ISNULL(A.TAT_DAYS,0)
			
			
			
			
			PRINT '2 BUY PLAN '
			
			INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS)
		    SELECT  A.SR,A.XN_NAME,A.DEPT_ID, 
			        A.MEMO_NO ,A.MEMO_DT,SUM(QUANTITY) AS XN_QTY,SUM(PURCHASE_PRICE*QUANTITY) AS NET_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) AS TAT_DAYS,
			        DATEDIFF (DAY ,A.MEMO_DT +ISNULL(A.TAT_DAYS,0), MAX(A.PO_DT))  AS DUE_DAYS 
			 FROM
			(
			SELECT MST.SR,MST.XN_NAME,A.location_code AS DEPT_ID, 
			       A.MEMO_NO ,A.MEMO_DT,B.QUANTITY ,B.PURCHASE_PRICE ,
			       ISNULL(C.BPL_QTY,0) AS BPL_QTY ,C.PO_DT ,A.TAT_DAYS 
			FROM BUY_PLAN_MST A (NOLOCK)
			JOIN BUY_PLAN_DET B (NOLOCK) ON A.MEMO_NO=B.MEMO_NO
			LEFT JOIN
			(
			 SELECT A.BUY_PLAN_ROW_ID ,SUM(A.QUANTITY) AS BPL_QTY,
			        MAX(B.PO_DT) AS PO_DT
			 FROM POD01106 A (NOLOCK)
			 JOIN POM01106 B (NOLOCK) ON A.PO_ID=B.PO_ID
			 WHERE A.BUY_PLAN_ROW_ID<>'' AND B.CANCELLED =0
			 GROUP BY A.BUY_PLAN_ROW_ID
			)  C ON B.ROW_ID=C.BUY_PLAN_ROW_ID
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='BUYPL'
			WHERE A.CANCELLED=0
			AND (@CDEPT_ID='' OR A.location_code =@CDEPT_ID)
			AND A.MEMo_DT BETWEEN @DFMDATE AND @DTODATE
			) A
			GROUP BY A.SR,A.XN_NAME,A.DEPT_ID , 
			A.MEMO_NO ,A.MEMO_DT,ISNULL(A.TAT_DAYS,0)
			HAVING SUM(ISNULL(A.BPL_QTY,0))>=SUM(QUANTITY)
		
            
            
            PRINT '3 PO VS QC '
            
          
			INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS)            
			SELECT MST.SR,MST.XN_NAME,A.location_code AS DEPT_ID, 
			        A.PO_NO ,A.PO_DT ,A.TOTAL_QUANTITY  AS XN_QTY,A.total_amount  AS total_amount,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.po_dt  +ISNULL(A.TAT_DAYS,0), C.memo_dt)  AS Due_DAYS
			FROM POM01106 A (NOLOCK) 
			JOIN
			(
			SELECT A.PO_ID ,SUM(ISNULL(A.QC_QUANTITY,0)) AS QC_QTY,MAX(B.MEMO_DT) AS MEMO_DT 
			FROM QC_XN_DET_1 A (NOLOCK)
			JOIN QC_XN_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
			WHERE B.CANCELLED =0 
			GROUP BY A.PO_ID
			) C ON A.PO_ID =C.PO_ID
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='POQC'
			WHERE A.CANCELLED=0 AND ISNULL(A.PO_RECEIVING_MODE ,0)=2
			AND (@CDEPT_ID='' OR A.location_code =@CDEPT_ID)
			AND A.PO_DT BETWEEN @DFMDATE AND @DTODATE
			AND QC_QTY>=A.TOTAL_QUANTITY
            
            PRINT '4 PO VS ASN '
            
            INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS)
            SELECT MST.SR,MST.XN_NAME,A.location_code AS DEPT_ID, 
			        A.PO_NO ,A.PO_DT ,A.TOTAL_QUANTITY  AS XN_QTY,A.total_amount  AS total_amount,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.po_dt  +ISNULL(A.TAT_DAYS,0), C.memo_dt)  AS Due_DAYS
			FROM POM01106 A (NOLOCK)
			JOIN
			(
			SELECT C.PO_ID ,SUM(A.QUANTITY ) AS ASN_QTY,MAX(B.MEMO_DT) AS MEMO_DT 
			FROM ASN_DET  A
			JOIN ASN_MST  B ON A.MEMO_ID =B.MEMO_ID 
			JOIN pod01106 C (NOLOCK) ON C.row_id =A.PO_ROW_ID 
			WHERE B.CANCELLED =0 AND A.PO_ROW_ID <>''
			GROUP BY C.PO_ID
			) C ON A.PO_ID =C.PO_ID
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='POASN'
			WHERE A.CANCELLED=0 AND ISNULL(A.PO_RECEIVING_MODE ,0)=2
			AND (@CDEPT_ID='' OR A.location_code =@CDEPT_ID)
			AND A.PO_DT BETWEEN @DFMDATE AND @DTODATE
			AND ASN_QTY>=A.TOTAL_QUANTITY
			
			
			PRINT '5 PO VS GRN '
			
			
			INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS)
			SELECT MST.SR,MST.XN_NAME,A.location_Code AS DEPT_ID, 
			        A.PO_NO ,A.PO_DT ,A.TOTAL_QUANTITY  AS XN_QTY,A.total_amount  AS total_amount,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.po_dt  +ISNULL(A.TAT_DAYS,0), C.memo_dt)  AS Due_DAYS
			FROM POM01106 A (NOLOCK)
			JOIN
			(
			SELECT C.PO_ID ,SUM(A.QUANTITY ) AS GRN_QTY,MAX(B.MEMO_DT) AS MEMO_DT 
			FROM GRN_PS_DET   A
			JOIN GRN_PS_MST   B ON A.MEMO_ID =B.MEMO_ID 
			JOIN pod01106 C (NOLOCK) ON C.row_id =A.PO_ROW_ID 
			WHERE B.CANCELLED =0 AND A.PO_ROW_ID <>''
			GROUP BY C.PO_ID
			) C ON A.PO_ID =C.PO_ID
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='POGRN'
			WHERE A.CANCELLED=0 AND ISNULL(A.PO_RECEIVING_MODE ,0)=3
			AND (@CDEPT_ID='' OR A.location_Code =@CDEPT_ID)
			AND A.PO_DT BETWEEN @DFMDATE AND @DTODATE
			AND GRN_QTY>=A.TOTAL_QUANTITY
			--
            
			
			PRINT '6 ASN VS PARCEL '
			
            INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS)
			SELECT MST.SR,MST.XN_NAME,A.location_code AS DEPT_ID, 
				   A.MEMO_NO ,A.MEMO_DT ,TOTAL_QUANTITY AS XN_QTY,0 AS XN_AMOUNT,
				   ISNULL(A.TAT_DAYS,0) AS TAT_DAYS,
				   DATEDIFF (DAY ,A.MEMO_DT +ISNULL(A.TAT_DAYS,0), C.parcel_memo_dt)  AS DUE_DAYS 
			FROM ASN_MST A (nolock)
			JOIN 
			(
			 SELECT A.REF_MEMO_ID ,MAX(parcel_memo_dt ) AS parcel_memo_dt 
			 FROM parcel_det A (nolock)
			 JOIN parcel_mst B (nolock) ON A.parcel_memo_id =B.parcel_memo_id 
			 WHERE B.cancelled =0
			 AND B.xn_type ='ASN'  
			GROUP BY A.REF_MEMO_ID
			) C ON A.MEMO_ID =C.REF_MEMO_ID 
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='ASNPC'
			AND (@CDEPT_ID='' OR A.location_code =@CDEPT_ID)
			AND A.MEMO_DT  BETWEEN @DFMDATE AND @DTODATE
			WHERE A.CANCELLED =0

        
           PRINT '7 GRN VS PI '
			
           INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS) 
           SELECT MST.SR,MST.XN_NAME,A.location_Code  AS DEPT_ID, 
			        A.MEMO_NO  ,A.MEMO_DT  ,A.TOTAL_QUANTITY  AS XN_QTY,0  AS NET_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.MEMO_DT  +ISNULL(A.TAT_DAYS,0), PIM.RECEIPT_DT)  AS Due_DAYS
	       FROM GRN_PS_MST  A (NOLOCK) 
	       JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='GRNPI'
	       JOIN PIM01106 PIM ON PIM.MRR_ID =A.REF_CONVERTED_MRR_ID
		   WHERE A.CANCELLED =0
		   AND (@CDEPT_ID='' OR A.location_Code =@CDEPT_ID)
		   AND A.MEMO_DT  BETWEEN @DFMDATE AND @DTODATE
		   AND ISNULL(REF_CONVERTED_MRR_ID,'')<>'' 
            
    
            PRINT '8 BUYER ORDER TO PICKLIST '
	        INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS) 
	        SELECT  MST.SR,MST.XN_NAME,A.location_Code AS DEPT_ID, 
			        A.ORDER_NO  ,A.ORDER_DT  ,SUM(B.QUANTITY)  AS XN_QTY,a.TOTAL_AMOUNT  AS NET_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.ORDER_DT  +ISNULL(A.TAT_DAYS,0), C.MEMO_DT)  AS Due_DAYS 
	        FROM BUYER_ORDER_MST A (NOLOCK)
	        JOIN BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID
	        LEFT JOIN
	        (
	          SELECT B.ORDER_ID,MAX(MEMO_DT) AS MEMO_DT ,SUM(A.QUANTITY) AS PICKLIST_QTY
	          FROM FLOOR_ST_DET A (NOLOCK) 
	          JOIN FLOOR_ST_MST B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
	          WHERE B.CANCELLED=0 AND ISNULL(B.ORDER_ID,'')<>''
	          GROUP BY B.ORDER_ID
	        
	        ) C ON A.ORDER_ID=C.ORDER_ID
	        JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='BOPL'
	        WHERE A.CANCELLED=0
	        AND (@CDEPT_ID='' OR A.location_Code =@CDEPT_ID)
		    AND A.ORDER_DT  BETWEEN @DFMDATE AND @DTODATE
	        GROUP BY MST.SR,MST.XN_NAME,A.location_Code, 
			A.ORDER_NO  ,A.ORDER_DT ,a.TOTAL_AMOUNT ,
			ISNULL(A.TAT_DAYS,0) ,isnull(c.PICKLIST_QTY,0),
			DATEDIFF (DAY ,A.ORDER_DT  +ISNULL(A.TAT_DAYS,0), C.MEMO_DT)
			having isnull(c.PICKLIST_QTY,0)>=SUM(B.QUANTITY)
             
            
            PRINT '9 BUYER ORDER TO invoice '
            
	        INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS) 
	        SELECT  MST.SR,MST.XN_NAME,A.location_Code AS DEPT_ID, 
			        A.ORDER_NO  ,A.ORDER_DT  ,SUM(B.QUANTITY)  AS XN_QTY,a.TOTAL_AMOUNT  AS NET_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.ORDER_DT  +ISNULL(A.TAT_DAYS,0), C.MEMO_DT)  AS Due_DAYS 
	        FROM BUYER_ORDER_MST A (NOLOCK)
	        JOIN BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID
	        LEFT JOIN
	        (
	          SELECT a.ORDER_ID,MAX(inv_dt) AS MEMO_DT ,SUM(A.QUANTITY) AS wsl_QTY
	          FROM ind01106 A (NOLOCK) 
	          JOIN inm01106 B (NOLOCK) ON A.inv_id=B.inv_id
	          WHERE B.CANCELLED=0 AND ISNULL(a.ORDER_ID,'')<>''
	          GROUP BY a.ORDER_ID
	        
	        ) C ON A.ORDER_ID=C.ORDER_ID
	        JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='BOPL'
	        WHERE A.CANCELLED=0 AND A.memo_type =1
	        AND (@CDEPT_ID='' OR A.location_Code =@CDEPT_ID)
		    AND A.ORDER_DT  BETWEEN @DFMDATE AND @DTODATE
	        GROUP BY MST.SR,MST.XN_NAME,A.location_Code, 
			A.ORDER_NO  ,A.ORDER_DT ,a.TOTAL_AMOUNT ,
			ISNULL(A.TAT_DAYS,0) ,
			DATEDIFF (DAY ,A.ORDER_DT  +ISNULL(A.TAT_DAYS,0), C.MEMO_DT),isnull(c.wsl_QTY,0)
			having isnull(c.wsl_QTY,0)>=SUM(B.QUANTITY)
			
           PRINT '10 PI POSTINT '
           
           INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS) 
           SELECT MST.SR,MST.XN_NAME,A.location_Code AS DEPT_ID, 
			        A.MRR_NO  ,A.RECEIPT_DT  ,A.TOTAL_QUANTITY  AS XN_QTY,a.TOTAL_AMOUNT  AS NET_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.RECEIPT_DT  +ISNULL(A.TAT_DAYS,0), VM.VOUCHER_DT)  AS Due_DAYS
	        FROM PIM01106 A
	        JOIN LOCATION LA ON A.location_Code=LA.DEPT_ID 
	        JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='PUR_ACT'
	        LEFT JOIN #APPROVALLOCATION AL ON A.location_Code=AL.DEPT_ID
	        LEFT OUTER JOIN LOCATION LS ON LS.DEPT_ID=A.challan_source_location_code
	        JOIN 
	        (
				SELECT B.MEMO_ID,B.LAST_UPDATE,C.VOUCHER_DT
				FROM POSTACT_VOUCHER_LINK B 
				JOIN VM01106 C ON C.VM_ID = B.VM_ID 
				WHERE C.CANCELLED=0 AND B.XN_TYPE = 'PUR' 
	        )VM  ON A.MRR_ID = VM.MEMO_ID  
	        LEFT OUTER JOIN LOCATION LOC ON LOC.DEPT_ID=A.DEPT_ID
	        WHERE  A.MEMO_TYPE=1 AND 
	        ((A.CANCELLED=1 AND VM.MEMO_ID IS NOT NULL) OR A.CANCELLED=0)
	        AND (ISNULL(LA.LOC_TYPE,0)=1 OR ISNULL(LA.ACCOUNT_POSTING_AT_HO,0)=1 OR 
				  (ISNULL(LA.ENABLE_ACCOUNTING_AT_LOC,0)=1 AND LA.LOC_TYPE=2 ))	 --AND @BLOC=1
	        AND (AL.DEPT_ID IS NULL OR A.APPROVEDLEVELNO>=@IMAXLEVEL)
	        AND A.bill_DT BETWEEN @DFMDATE AND @DFMDATE 
			--AND (ISNULL(A.XN_ITEM_TYPE,0)=@NXNITEMTYPE OR (ISNULL(A.XN_ITEM_TYPE,0) IN (0,1) AND @NXNITEMTYPE=1))				 
	        AND (ISNULL(@DCUTOFFDATE,'')='' OR A.bill_dt>@DCUTOFFDATE)
	  
	        AND (ISNULL(@CDEPT_ID,'')='' OR 
				(CASE WHEN ISNULL(A.ACCOUNTS_DEPT_ID,'')='' AND ISNULL(LOC.ALLOW_PURCHASE_AT_HO,0)=0
					  THEN A.location_Code  WHEN ISNULL(LOC.ALLOW_PURCHASE_AT_HO,0)=1 THEN A.DEPT_ID 
					ELSE A.ACCOUNTS_DEPT_ID END)=@CDEPT_ID)
			--AND (@CACCODE='' OR A.AC_CODE=@CACCODE)						
	        AND ((A.INV_MODE<>2 AND A.BILL_CHALLAN_MODE=0))
	        AND VM.LAST_UPDATE = A.LAST_UPDATE
	        --AND (VM.MEMO_ID IS NULL OR VM.LAST_UPDATE <> A.LAST_UPDATE) 
	        
	       PRINT '11 QC VS ASN '
	          
		   INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS) 
           SELECT MST.SR,MST.XN_NAME,A.location_code AS DEPT_ID, 
			        A.PO_NO  ,A.po_dt   ,A.QC_QUANTITY  AS XN_QTY,0  AS NET_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.po_dt   +ISNULL(A.TAT_DAYS,0), B.ASN_DT)  AS Due_DAYS	        
			FROM 
			(
			SELECT POM.PO_NO,POM.PO_DT,A.PO_ID ,POM.TAT_DAYS ,pom.location_code,
			SUM(ISNULL(QC_QUANTITY,0)) AS QC_QUANTITY
			FROM QC_XN_DET_1 A (NOLOCK)
			JOIN QC_XN_MST B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID 
			join pom01106 pom on pom.po_id =a.PO_ID 
			where b.cancelled=0 and pom.cancelled=0
			GROUP BY POM.PO_NO,POM.PO_DT,A.PO_ID,POM.TAT_DAYS,pom.location_code
			) A
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='QCASN'
			JOIN
			(
			 SELECT D.PO_ID ,SUM(A.QUANTITY) AS ASN_QTY ,MAX(MEMO_DT ) AS ASN_DT
			 FROM ASN_DET A (NOLOCK) 
			 JOIN ASN_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
			 JOIN POD01106 C (NOLOCK) ON C.ROW_ID =A.PO_ROW_ID 
			 JOIN POM01106 D (NOLOCK) ON C.PO_ID  =D.PO_ID 
			 WHERE B.CANCELLED =0 AND D.CANCELLED=0
			 GROUP BY D.PO_ID 
			) B ON A.PO_ID =B.PO_ID 
			where QC_QUANTITY>ISNULL(ASN_QTY,0)
			AND (@CDEPT_ID='' OR A.location_Code  =@CDEPT_ID)
		    AND A.PO_DT  BETWEEN @DFMDATE AND @DTODATE	
				
			
			PRINT '12 QC VS ASN '
					
		   INSERT INTO @TBLDET(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,NET_AMOUNT,TAT_DAYS,DUE_DAYS) 
           SELECT MST.SR,MST.XN_NAME,a.location_code AS DEPT_ID, 
			        A.parcel_memo_no  ,A.parcel_memo_dt   ,A.parcel  AS XN_QTY,0  AS NET_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.parcel_memo_dt   +ISNULL(A.TAT_DAYS,0), C.MEMO_DT)  AS Due_DAYS	  
			 from
			 (			
			  SELECT a.parcel_memo_id , A.parcel_memo_no ,A.parcel_memo_dt ,A.TAT_DAYS,A.location_code,
			  COUNT(*) as  parcel
			  FROM PARCEL_MST A
			  JOIN parcel_det B ON A.parcel_memo_id =B.parcel_memo_id 
			  WHERE A.cancelled =0 AND A.xn_type ='GRN'
              GROUP BY a.parcel_memo_id , A.parcel_memo_no ,A.parcel_memo_dt ,A.TAT_DAYS,A.location_code
			 ) a
			 JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='PCGRN'
			  join
			 (
			  SELECT C.PARCEL_MEMO_ID,count(*)  AS QTY ,MAX(MEMO_DT ) AS MEMO_DT 
			  FROM GRN_PS_MST A (NOLOCK)
			  JOIN GRN_PS_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
			  JOIN PARCEL_DET C (NOLOCK) ON A.REF_PARCEL_ROW_ID =C.ROW_ID 
			  WHERE A.CANCELLED=0
			  GROUP BY C.PARCEL_MEMO_ID
			 ) c on a.PARCEL_MEMO_ID =c.PARCEL_MEMO_ID 
			 WHERE parcel>=ISNULL(QTY,0)
             AND (@CDEPT_ID='' OR a.location_code =@CDEPT_ID)
		     AND A.parcel_memo_dt  BETWEEN @DFMDATE AND @DTODATE	
				

            SELECT * FROM @TBLDET
            ORDER BY SR 
 
        
        GOTO END_PROC
        
        
        
	    LBLPENDING:
	    
	      INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
             
			 SELECT MST.SR,MST.XN_NAME,A.location_code AS DEPT_ID, 
			        A.MEMO_NO ,A.MEMO_DT ,0 AS XN_QTY,0 AS PENDING_QTY,SUM(BUDGET_AMOUNT) AS BUDGET_AMOUNT,
			        SUM(BUDGET_AMOUNT) AS PENDING_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) AS TAT_DAYS,
			        DATEDIFF (DAY ,A.MEMO_DT +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS DUE_DAYS
			   
			 FROM BUDGET_PLAN_MST A (NOLOCK)
			 JOIN BUDGET_PLAN_DET B (NOLOCK) ON A.MEMO_NO =B.MEMO_NO 
			 JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='BDGPL'
			 left JOIN 
			 (
			    SELECT BUDGET_PLAN_MEMO_NO,MAX(MEMO_DT) AS MEMO_DT 
			    FROM   BUY_PLAN_MST BM 
			    WHERE  BM.CANCELLED =0
			    GROUP BY BUDGET_PLAN_MEMO_NO
			 )BM ON BM.BUDGET_PLAN_MEMO_NO =A.MEMO_NO 
			 WHERE A.CANCELLED =0 
			 and BUDGET_PLAN_MEMO_NO is null
			 AND (@CDEPT_ID='' OR A.location_code =@CDEPT_ID)
			 AND A.MEMo_DT <=@DTODATE
			 GROUP BY MST.SR,MST.XN_NAME,A.location_code , 
			 A.MEMO_NO ,A.MEMO_DT ,DATEDIFF (DAY ,A.MEMO_DT +ISNULL(A.TAT_DAYS,0), @DTODATE),ISNULL(A.TAT_DAYS,0)
			
			
			PRINT '2 BUY PLAN '
			
			 INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
             
		    SELECT  A.SR,A.XN_NAME,A.DEPT_ID, 
			        A.MEMO_NO ,A.MEMO_DT,
			        SUM(QUANTITY) AS XN_QTY,
			        SUM(QUANTITY-ISNULL(A.BPL_QTY,0)) AS PENDING_QTY,
			        SUM(PURCHASE_PRICE*QUANTITY) AS NET_AMOUNT,
			        SUM(PURCHASE_PRICE*ISNULL(A.BPL_QTY,0)) AS PENDING_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) AS TAT_DAYS,
			        DATEDIFF (DAY ,A.MEMO_DT +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS DUE_DAYS 
			 FROM
			(
			SELECT MST.SR,MST.XN_NAME,A.location_code AS DEPT_ID, 
			       A.MEMO_NO ,A.MEMO_DT,B.QUANTITY ,B.PURCHASE_PRICE ,
			       ISNULL(C.BPL_QTY,0) AS BPL_QTY ,C.PO_DT ,A.TAT_DAYS 
			FROM BUY_PLAN_MST A (NOLOCK)
			JOIN BUY_PLAN_DET B (NOLOCK) ON A.MEMO_NO=B.MEMO_NO
			LEFT JOIN
			(
			 SELECT A.BUY_PLAN_ROW_ID ,SUM(A.QUANTITY) AS BPL_QTY,
			        MAX(B.PO_DT) AS PO_DT
			 FROM POD01106 A (NOLOCK)
			 JOIN POM01106 B (NOLOCK) ON A.PO_ID=B.PO_ID
			 WHERE A.BUY_PLAN_ROW_ID<>'' AND B.CANCELLED =0
			 GROUP BY A.BUY_PLAN_ROW_ID
			)  C ON B.ROW_ID=C.BUY_PLAN_ROW_ID
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='BUYPL'
			WHERE A.CANCELLED=0
			AND (@CDEPT_ID='' OR A.location_code =@CDEPT_ID)
			AND A.MEMo_DT <=@DTODATE
			) A
			GROUP BY A.SR,A.XN_NAME,A.DEPT_ID  , 
			A.MEMO_NO ,A.MEMO_DT,ISNULL(A.TAT_DAYS,0)
			HAVING SUM(QUANTITY)>SUM(ISNULL(A.BPL_QTY,0))
            
            
            PRINT '3 PO VS QC '
            
          
			 INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
			SELECT MST.SR,MST.XN_NAME,A.location_Code AS DEPT_ID, 
			        A.PO_NO ,A.PO_DT ,
			        A.TOTAL_QUANTITY  AS XN_QTY,
			        A.TOTAL_QUANTITY-ISNULL(QC_QTY,0) AS PENDING_QTY,
			        A.total_amount  AS total_amount,
			        0 as   PENDING_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.po_dt  +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS Due_DAYS
			FROM POM01106 A (NOLOCK) 
			left JOIN
			(
			SELECT A.PO_ID ,SUM(ISNULL(A.QC_QUANTITY,0)) AS QC_QTY,MAX(B.MEMO_DT) AS MEMO_DT 
			FROM QC_XN_DET_1 A (NOLOCK)
			JOIN QC_XN_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
			WHERE B.CANCELLED =0 
			GROUP BY A.PO_ID
			) C ON A.PO_ID =C.PO_ID
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='POQC'
			WHERE A.CANCELLED=0 AND ISNULL(A.PO_RECEIVING_MODE ,0)=2
			AND (@CDEPT_ID='' OR A.location_Code =@CDEPT_ID)
			AND A.po_dt  <=@DTODATE
			AND A.TOTAL_QUANTITY>isnull(QC_QTY,0)
            
            PRINT '4 PO VS ASN '
            
             INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
            SELECT MST.SR,MST.XN_NAME,A.location_Code  AS DEPT_ID, 
			        A.PO_NO ,A.PO_DT ,A.TOTAL_QUANTITY  AS XN_QTY,
			        A.TOTAL_QUANTITY-ISNULL(c.ASN_QTY,0) AS PENDING_QTY,
			        A.total_amount  AS total_amount,
			        0 AS PENDING_amount,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.po_dt  +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS Due_DAYS
			FROM POM01106 A (NOLOCK)
			left JOIN
			(
			SELECT C.PO_ID ,SUM(A.QUANTITY ) AS ASN_QTY,MAX(B.MEMO_DT) AS MEMO_DT 
			FROM ASN_DET  A
			JOIN ASN_MST  B ON A.MEMO_ID =B.MEMO_ID 
			JOIN pod01106 C (NOLOCK) ON C.row_id =A.PO_ROW_ID 
			WHERE B.CANCELLED =0 AND A.PO_ROW_ID <>''
			GROUP BY C.PO_ID
			) C ON A.PO_ID =C.PO_ID
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='POASN'
			WHERE A.CANCELLED=0 AND ISNULL(A.PO_RECEIVING_MODE ,0)=2
			AND (@CDEPT_ID='' OR A.location_Code  =@CDEPT_ID)
			AND A.po_dt  <=@DTODATE
			AND A.TOTAL_QUANTITY>isnull(ASN_QTY,0)
			
			
			PRINT '5 PO VS GRN '
			
			
			 INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
			SELECT MST.SR,MST.XN_NAME,A.location_Code  AS DEPT_ID, 
			        A.PO_NO ,A.PO_DT ,A.TOTAL_QUANTITY  AS XN_QTY,
			        A.TOTAL_QUANTITY-ISNULL(c.GRN_QTY,0) as pending_qty,
			        A.total_amount  AS total_amount,
			        0 as pending_amount,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.po_dt  +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS Due_DAYS
			FROM POM01106 A (NOLOCK)
			left JOIN
			(
			SELECT C.PO_ID ,SUM(A.QUANTITY ) AS GRN_QTY,MAX(B.MEMO_DT) AS MEMO_DT 
			FROM GRN_PS_DET   A
			JOIN GRN_PS_MST   B ON A.MEMO_ID =B.MEMO_ID 
			JOIN pod01106 C (NOLOCK) ON C.row_id =A.PO_ROW_ID 
			WHERE B.CANCELLED =0 AND A.PO_ROW_ID <>''
			GROUP BY C.PO_ID
			) C ON A.PO_ID =C.PO_ID
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='POGRN'
			WHERE A.CANCELLED=0
			AND (@CDEPT_ID='' OR A.location_Code  =@CDEPT_ID)
			AND A.po_dt  <=@DTODATE
			AND A.TOTAL_QUANTITY>isnull(GRN_QTY,0)
			--
            
			
			PRINT '6 ASN VS PARCEL '
			
            INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
			SELECT MST.SR,MST.XN_NAME,A.location_code  AS DEPT_ID, 
				   A.MEMO_NO ,A.MEMO_DT ,TOTAL_QUANTITY AS XN_QTY,
				   TOTAL_QUANTITY AS PENDING_QTY,
				   0 AS XN_AMOUNT,
				   0 AS pending_AMOUNT,
				   ISNULL(A.TAT_DAYS,0) AS TAT_DAYS,
				   DATEDIFF (DAY ,A.MEMO_DT +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS DUE_DAYS 
			FROM ASN_MST A (nolock)
			left JOIN 
			(
			 SELECT A.REF_MEMO_ID ,MAX(parcel_memo_dt ) AS parcel_memo_dt 
			 FROM parcel_det A (nolock)
			 JOIN parcel_mst B (nolock) ON A.parcel_memo_id =B.parcel_memo_id 
			 WHERE B.cancelled =0
			 AND B.xn_type ='ASN'  
			GROUP BY A.REF_MEMO_ID
			) C ON A.MEMO_ID =C.REF_MEMO_ID 
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='ASNPC'
			WHERE A.CANCELLED =0 and REF_MEMO_ID is null
			AND (@CDEPT_ID='' OR A.location_code  =@CDEPT_ID)
			AND A.MEMO_DT   <=@DTODATE

        
           PRINT '7 GRN VS PI '
			
            INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
           SELECT MST.SR,MST.XN_NAME,A.location_Code  AS DEPT_ID, 
			        A.MEMO_NO  ,A.MEMO_DT  
			        ,A.TOTAL_QUANTITY  AS XN_QTY
			        ,A.TOTAL_QUANTITY  AS PENDING_QTY,
			        0  AS NET_AMOUNT,
			        0 AS pending_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.MEMO_DT  +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS Due_DAYS
	       FROM GRN_PS_MST  A (NOLOCK) 
	       JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='GRNPI'
		   WHERE A.CANCELLED =0
		   AND ISNULL(REF_CONVERTED_MRR_ID,'')='' 
		   AND (@CDEPT_ID='' OR A.location_Code  =@CDEPT_ID)
			AND A.MEMO_DT   <=@DTODATE

            
            PRINT '8 BUYER ORDER TO PICKLIST '
            
	        INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
	        
	        SELECT  MST.SR,MST.XN_NAME,A.location_Code  AS DEPT_ID, 
			        A.ORDER_NO  ,A.ORDER_DT  ,
			        SUM(B.QUANTITY)  AS XN_QTY,
			        SUM(B.QUANTITY)-ISNULL(C.PICKLIST_QTY,0) AS PENDING_QTY,
			        a.TOTAL_AMOUNT  AS NET_AMOUNT,
			        0 AS PENDING_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.ORDER_DT  +ISNULL(A.TAT_DAYS,0),@DTODATE)  AS Due_DAYS 
	        FROM BUYER_ORDER_MST A (NOLOCK)
	        JOIN BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID
	        LEFT JOIN
	        (
	          SELECT B.ORDER_ID,MAX(MEMO_DT) AS MEMO_DT ,SUM(A.QUANTITY) AS PICKLIST_QTY
	          FROM FLOOR_ST_DET A (NOLOCK) 
	          JOIN FLOOR_ST_MST B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
	          WHERE B.CANCELLED=0 AND ISNULL(B.ORDER_ID,'')<>''
	          GROUP BY B.ORDER_ID
	        
	        ) C ON A.ORDER_ID=C.ORDER_ID
	        JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='BOPL'
	        WHERE A.CANCELLED=0
	        AND (@CDEPT_ID='' OR A.location_Code =@CDEPT_ID)
			AND A.order_dt    <=@DTODATE
	        GROUP BY MST.SR,MST.XN_NAME,A.location_Code, 
			A.ORDER_NO  ,A.ORDER_DT ,a.TOTAL_AMOUNT ,
			ISNULL(A.TAT_DAYS,0) ,isnull(c.PICKLIST_QTY,0),
			DATEDIFF (DAY ,A.ORDER_DT  +ISNULL(A.TAT_DAYS,0), @DTODATE)
			having SUM(B.QUANTITY)>isnull(c.PICKLIST_QTY,0)
             
            
            PRINT '9 BUYER ORDER TO invoice '
            
	        INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
	         
	        SELECT  MST.SR,MST.XN_NAME,A.location_Code AS DEPT_ID, 
			        A.ORDER_NO  ,A.ORDER_DT  ,
			        SUM(B.QUANTITY)  AS XN_QTY,
			        SUM(B.QUANTITY)-ISNULL(c.wsl_QTY,0) as pending_qty,
			        a.TOTAL_AMOUNT  AS NET_AMOUNT,
			        0 as pending_amount,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.ORDER_DT  +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS Due_DAYS 
	        FROM BUYER_ORDER_MST A (NOLOCK)
	        JOIN BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID
	        LEFT JOIN
	        (
	          SELECT a.ORDER_ID,MAX(inv_dt) AS MEMO_DT ,SUM(A.QUANTITY) AS wsl_QTY
	          FROM ind01106 A (NOLOCK) 
	          JOIN inm01106 B (NOLOCK) ON A.inv_id=B.inv_id
	          WHERE B.CANCELLED=0 AND ISNULL(a.ORDER_ID,'')<>''
	          GROUP BY a.ORDER_ID
	        
	        ) C ON A.ORDER_ID=C.ORDER_ID
	        JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='BOPL'
	        WHERE A.CANCELLED=0
	        AND (@CDEPT_ID='' OR A.location_Code =@CDEPT_ID)
			AND A.order_dt    <=@DTODATE
	        GROUP BY MST.SR,MST.XN_NAME,A.location_Code, 
			A.ORDER_NO  ,A.ORDER_DT ,a.TOTAL_AMOUNT ,
			ISNULL(A.TAT_DAYS,0) ,
			DATEDIFF (DAY ,A.ORDER_DT  +ISNULL(A.TAT_DAYS,0), @DTODATE),isnull(c.wsl_QTY,0)
			having SUM(B.QUANTITY)<isnull(c.wsl_QTY,0)
			
           PRINT '10 PI POSTINT '
           
           INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
           SELECT MST.SR,MST.XN_NAME,A.location_Code AS DEPT_ID, 
			        A.MRR_NO  ,A.RECEIPT_DT  ,
			        A.TOTAL_QUANTITY  AS XN_QTY,
			        A.TOTAL_QUANTITY  AS pending_QTY,
			        a.TOTAL_AMOUNT  AS NET_AMOUNT,
			        a.TOTAL_AMOUNT  AS PENDING_AMOUNT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.RECEIPT_DT  +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS Due_DAYS
	       FROM PIM01106 A
	        JOIN LOCATION LA ON A.location_Code=LA.DEPT_ID 
	        JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='PUR_ACT'
	        LEFT JOIN #APPROVALLOCATION AL ON A.location_Code =AL.DEPT_ID
	        LEFT OUTER JOIN LOCATION LS ON LS.DEPT_ID=A.challan_source_location_code
	        left JOIN 
	        (
				SELECT B.MEMO_ID,B.LAST_UPDATE,C.VOUCHER_DT
				FROM POSTACT_VOUCHER_LINK B 
				JOIN VM01106 C ON C.VM_ID = B.VM_ID 
				WHERE C.CANCELLED=0 AND B.XN_TYPE = 'PUR' 
	        )VM  ON A.MRR_ID = VM.MEMO_ID  
	        LEFT OUTER JOIN LOCATION LOC ON LOC.DEPT_ID=A.DEPT_ID
	        WHERE  A.MEMO_TYPE=1 AND 
	        ((A.CANCELLED=1 AND VM.MEMO_ID IS NOT NULL) OR A.CANCELLED=0)
	        AND (ISNULL(LA.LOC_TYPE,0)=1 OR ISNULL(LA.ACCOUNT_POSTING_AT_HO,0)=1 OR 
				  (ISNULL(LA.ENABLE_ACCOUNTING_AT_LOC,0)=1 AND LA.LOC_TYPE=2 ))	 --AND @BLOC=1
	        AND (AL.DEPT_ID IS NULL OR A.APPROVEDLEVELNO>=@IMAXLEVEL)
	        AND A.bill_DT BETWEEN @DFMDATE AND @DFMDATE 
			--AND (ISNULL(A.XN_ITEM_TYPE,0)=@NXNITEMTYPE OR (ISNULL(A.XN_ITEM_TYPE,0) IN (0,1) AND @NXNITEMTYPE=1))				 
	        AND (ISNULL(@DCUTOFFDATE,'')='' OR A.bill_dt>@DCUTOFFDATE)
	  
	        AND (ISNULL(@CDEPT_ID,'')='' OR 
				(CASE WHEN ISNULL(A.ACCOUNTS_DEPT_ID,'')='' AND ISNULL(LOC.ALLOW_PURCHASE_AT_HO,0)=0
					  THEN A.location_Code  WHEN ISNULL(LOC.ALLOW_PURCHASE_AT_HO,0)=1 THEN A.DEPT_ID 
					ELSE A.ACCOUNTS_DEPT_ID END)=@CDEPT_ID)
			--AND (@CACCODE='' OR A.AC_CODE=@CACCODE)						
	        AND ((A.INV_MODE<>2 AND A.BILL_CHALLAN_MODE=0))
	        AND (VM.MEMO_ID IS NULL OR VM.LAST_UPDATE <> A.LAST_UPDATE) 
	        
	        
	        
	       INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
           SELECT MST.SR,MST.XN_NAME,A.location_Code AS DEPT_ID, 
			        A.PO_NO  ,A.po_dt   ,A.QC_QUANTITY  AS XN_QTY,
			        A.QC_QUANTITY-ISNULL(B.ASN_QTY,0) AS PENDING_QTY,
			        0  AS NET_AMOUNT,
			        0 AS PENDING_AMT,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.po_dt   +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS Due_DAYS	        
			FROM 
			(
			SELECT POM.PO_NO,POM.PO_DT,A.PO_ID ,POM.TAT_DAYS ,pom.location_Code,
			SUM(ISNULL(QC_QUANTITY,0)) AS QC_QUANTITY
			FROM QC_XN_DET_1 A (NOLOCK)
			JOIN QC_XN_MST B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID 
			join pom01106 pom on pom.po_id =a.PO_ID 
			where b.cancelled=0 and pom.cancelled=0
			GROUP BY POM.PO_NO,POM.PO_DT,A.PO_ID,POM.TAT_DAYS,pom.location_Code
			) A
			JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='QCASN'
			LEFT OUTER JOIN
			(
			 SELECT D.PO_ID ,SUM(A.QUANTITY) AS ASN_QTY ,MAX(MEMO_DT ) AS ASN_DT
			 FROM ASN_DET A (NOLOCK) 
			 JOIN ASN_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
			 JOIN POD01106 C (NOLOCK) ON C.ROW_ID =A.PO_ROW_ID 
			 JOIN POM01106 D (NOLOCK) ON C.PO_ID  =D.PO_ID 
			 WHERE B.CANCELLED =0 AND D.CANCELLED=0
			 GROUP BY D.PO_ID 
			) B ON A.PO_ID =B.PO_ID 
			where QC_QUANTITY<ISNULL(ASN_QTY,0)
			AND (@CDEPT_ID='' OR A.location_Code  =@CDEPT_ID)
		    AND A.PO_DT  BETWEEN @DFMDATE AND @DTODATE	
				
			
			PRINT '12 QC VS ASN '
					
		   INSERT INTO @TBLDETPENDING(SR,XN_NAME,DEPT_ID,MEMO_NO,MEMO_DT,XN_QTY,PENDING_QTY ,NET_AMOUNT,PENDING_AMOUNT ,TAT_DAYS,DUE_DAYS)
           SELECT MST.SR,MST.XN_NAME,a.location_code  AS DEPT_ID, 
			        A.parcel_memo_no  ,A.parcel_memo_dt   ,A.parcel  AS XN_QTY,
			        A.parcel-ISNULL(C.QTY,0) AS PENDING_QTY,
			        0  AS NET_AMOUNT,
			        0 AS PENDING_QTY,
			        ISNULL(A.TAT_DAYS,0) as TAT_DAYS,
			        DATEDIFF (DAY ,A.parcel_memo_dt   +ISNULL(A.TAT_DAYS,0), @DTODATE)  AS Due_DAYS	  
			 from
			 (			
			  SELECT a.parcel_memo_id , A.parcel_memo_no ,A.parcel_memo_dt ,A.TAT_DAYS,A.location_code ,
			  COUNT(*) as  parcel
			  FROM PARCEL_MST A
			  JOIN parcel_det B ON A.parcel_memo_id =B.parcel_memo_id 
			  WHERE A.cancelled =0 AND A.xn_type ='GRN'
              GROUP BY a.parcel_memo_id , A.parcel_memo_no ,A.parcel_memo_dt ,A.TAT_DAYS,A.location_code 
			 ) a
			 JOIN XN_TAT_MST MST (NOLOCK) ON MST.XN_TYPE='PCGRN'
			 left outer join
			 (
			  SELECT C.PARCEL_MEMO_ID,count(*)  AS QTY ,MAX(MEMO_DT ) AS MEMO_DT 
			  FROM GRN_PS_MST A (NOLOCK)
			  JOIN GRN_PS_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
			  JOIN PARCEL_DET C (NOLOCK) ON A.REF_PARCEL_ROW_ID =C.ROW_ID 
			  WHERE A.CANCELLED=0
			  GROUP BY C.PARCEL_MEMO_ID
			 ) c on a.PARCEL_MEMO_ID =c.PARCEL_MEMO_ID 
			 WHERE parcel<ISNULL(QTY,0)
             AND (@CDEPT_ID='' OR a.location_code  =@CDEPT_ID)
		     AND A.parcel_memo_dt  BETWEEN @DFMDATE AND @DTODATE	
				
	        
	        
            SELECT * FROM @TBLDETPENDING
            ORDER BY SR 
	        
			   
		GOTO  END_PROC
		
		
		
		

   END_PROC:
END
