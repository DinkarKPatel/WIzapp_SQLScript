create PROCEDURE SP3S_DOC_GSTR--(LocId 3 digit change by Sanjay:06-11-2024)
(
  @DFMDATE DATETIME='2019-04-01',
  @DTODATE DATETIME='2019-09-13',
  @CGSTN_NO VARCHAR(100)='',
  @CLOC_TYPE INT=0,
  @CDEPT_ID VARCHAR(4)=''
  
)
AS
BEGIN
       

	    DECLARE @EINVOICE_START_DATE VARCHAR(10),@EINVOICESTDATE DATETIME
	  select @EINVOICE_START_DATE=value from config where config_option='EINVOICE_START_DATE'

	  set @einvoicestdate=''
      IF ISNULL(@EINVOICE_START_DATE,'')<>''
      SET @EINVOICESTDATE=@EINVOICE_START_DATE

	    DECLARE @CEINVOICE_PREFIX VARCHAR(10)
	   select @CEINVOICE_PREFIX=value  from CONFIG where config_option ='EINVOICE_PREFIX'
	   set @CEINVOICE_PREFIX=ISNULL(@CEINVOICE_PREFIX,'')


	    IF OBJECT_ID ('TEMPDB..#TMP_DO_NOT_CONSIDER_FOR_GSTRREPS','U') is not null
	    drop table #TMP_DO_NOT_CONSIDER_FOR_GSTRREPS

	 SELECT A.user_code INTO #TMP_DO_NOT_CONSIDER_FOR_GSTRREPS FROM USERS A
	 WHERE ISNULL(DO_NOT_CONSIDER_FOR_GSTRREPS,0)=1

       DECLARE @TBLDOC TABLE (PREFIX VARCHAR(30),RTYPE VARCHAR(10),SR INT,DOC_TYPE VARCHAR(100),SRFM VARCHAR(100),SRTO VARCHAR(100) ,TOTAL_NO INT,TOTAL_CANCELLED INT,LEN_INV_NO NUMERIC(10,2))
       
       
       IF OBJECT_ID ('TEMPDB..#TMPINV','U') IS NOT NULL
          DROP TABLE #TMPINV
          
       SELECT A.INV_ID,LEN(INV_NO) AS LEN_INV_NO,
        CASE WHEN (@CEINVOICE_PREFIX<>'' AND LEFT(RTRIM(LTRIM(A.INV_NO)),1)='0' and CAST( INV_DT  AS DATETIME) >= @EINVOICESTDATE) THEN @CEINVOICE_PREFIX ELSE '' END+INV_NO AS INV_NO,
	   INV_DT  ,CANCELLED,MEMO_PREFIX,a.location_code
       INTO #TMPINV
       FROM INM01106 A (NOLOCK)
       JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_code
       LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE
       LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =PARTY_DEPT_ID 
       WHERE  ISNULL(A.MEMO_TYPE,0)  IN(0,1)
       AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
       AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
       AND (@CLOC_TYPE =0 OR ISNULL(B.LOC_TYPE,0)=@CLOC_TYPE )
       AND  ISNULL(B.LOC_GST_NO,'')<> ISNULL(CASE WHEN A.INV_MODE=1 THEN LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END,'')
       AND (@CDEPT_ID='' OR a.location_Code=@CDEPT_ID)
       
	   UPDATE #TMPINV SET MEMO_PREFIX=SUBSTRING(INV_NO,1,LEN(LTRIM(RTRIM(INV_NO)))-6)
	   WHERE (MEMO_PREFIX ='' or left(MEMO_PREFIX,len(location_code))<>location_code)
	   
	   
	   
       INSERT INTO @TBLDOC(PREFIX,RTYPE,SR,DOC_TYPE ,SRFM ,SRTO  ,TOTAL_NO ,TOTAL_CANCELLED,LEN_INV_NO )
       SELECT MEMO_PREFIX,'DOCS' AS RYPE,1 AS SR ,'Invoices for outward supply' AS DOC_TYPE,
               MIN(INV_NO) AS SRFM,
               MAX(INV_NO) AS SRTO,
               COUNT(*) AS TOTAL_NO,
               SUM(CASE WHEN CANCELLED =1 THEN 1 ELSE 0 END) TOTAL_CANCELLED,
               LEN_INV_NO
       FROM #TMPINV 
       GROUP BY MEMO_PREFIX,LEN_INV_NO
       
      
       --AND ISNULL(B.LOC_TYPE,0)=1
       
      
       INSERT INTO @TBLDOC(PREFIX,RTYPE,SR,DOC_TYPE ,SRFM ,SRTO  ,TOTAL_NO ,TOTAL_CANCELLED )
       SELECT  CASE WHEN  CHARINDEX('-',CM_NO)>0 and LEN(CM_NO)>=12 THEN SUBSTRING(CM_NO,1, LEN(CM_NO) -CHARINDEX('-',RTRIM(LTRIM(REVERSE(CM_NO))))) ELSE   LEFT(CM_NO,LEN(LOCATION_CODE)+3) END  AS PREFIX,
	   'DOCS' AS RYPE,1 AS SR ,'Invoices for outward supply' AS DOC_TYPE,
               MIN(CASE WHEN (@CEINVOICE_PREFIX<>'' AND LEFT(RTRIM(LTRIM(A.CM_NO)),1)='0' and CAST( CM_DT  AS DATETIME) >= @EINVOICESTDATE) THEN @CEINVOICE_PREFIX ELSE '' END+A.CM_NO) AS SRFM,
               MAX(CASE WHEN (@CEINVOICE_PREFIX<>'' AND LEFT(RTRIM(LTRIM(A.CM_NO)),1)='0' and CAST( CM_DT  AS DATETIME) >= @EINVOICESTDATE) THEN @CEINVOICE_PREFIX ELSE '' END+A.CM_NO) AS SRTO,
               COUNT(*) AS TOTAL_NO,
               SUM(CASE WHEN CANCELLED =1 THEN 1 ELSE 0 END ) TOTAL_CANCELLED
       FROM CMM01106 A (NOLOCK)
       JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =LEFT (A.CM_ID,2)
	   LEFT JOIN #TMP_DO_NOT_CONSIDER_FOR_GSTRREPS U ON A.USER_CODE =U.user_code
       WHERE  ISNULL(A.MEMO_TYPE,0) IN(0,1)
       AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
       AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
       AND (@CLOC_TYPE =0 OR ISNULL(B.LOC_TYPE,0)=@CLOC_TYPE )
       AND (@CDEPT_ID='' OR a.location_Code=@CDEPT_ID)
	   AND U.user_code IS NULL
       GROUP BY  CASE WHEN  CHARINDEX('-',CM_NO)>0 and LEN(CM_NO)>=12 THEN SUBSTRING(CM_NO,1, LEN(CM_NO) -CHARINDEX('-',RTRIM(LTRIM(REVERSE(CM_NO))))) ELSE   LEFT(CM_NO,LEN(LOCATION_CODE)+3) END 
     

     

       
       IF OBJECT_ID('TEMPDB..#TMPCNM','U') IS NOT NULL
           DROP TABLE #TMPCNM
        
        SELECT MEMO_PREFIX,A.CN_ID,A.CN_NO,A.CANCELLED 
        INTO #TMPCNM
        FROM CNM01106  A
       JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =LEFT (A.CN_ID,2)
        LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE
       LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =LEFT (A.RM_ID,2) 
       WHERE  ISNULL(A.MEMO_TYPE,0) IN(0,1)
       AND A.receipt_dt BETWEEN @DFMDATE AND @DTODATE
       AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
       AND  ISNULL(B.LOC_GST_NO,'')<> ISNULL(CASE WHEN A.MODE=1 THEN LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END,'')   
       AND (@CDEPT_ID='' OR a.location_Code=@CDEPT_ID)
	
	   UPDATE #TMPCNM SET MEMO_PREFIX=SUBSTRING(CN_NO,1,LEN(LTRIM(RTRIM(CN_NO)))-6)
        
       INSERT INTO @TBLDOC(PREFIX,RTYPE,SR,DOC_TYPE ,SRFM ,SRTO  ,TOTAL_NO ,TOTAL_CANCELLED )
        SELECT MEMO_PREFIX,'DOCS' AS RYPE,3 AS SR ,'Credit Note' AS DOC_TYPE,
               MIN(CN_NO) AS SRFM,
               MAX(CN_NO) AS SRTO,
               COUNT(*) AS TOTAL_NO,
               SUM(CASE WHEN CANCELLED =1 THEN 1 ELSE 0 END ) TOTAL_CANCELLED
       FROM #TMPCNM
       --AND ISNULL(B.LOC_TYPE,0)=1
       GROUP BY MEMO_PREFIX


       
       INSERT INTO @TBLDOC(PREFIX,RTYPE,SR,DOC_TYPE ,SRFM ,SRTO  ,TOTAL_NO ,TOTAL_CANCELLED )
          SELECT LEFT(ADV_REC_NO,len(b.location_Code)+3) AS PREFIX,'DOCS' AS RYPE,4 AS SR ,'Receipt Voucher' AS DOC_TYPE,
               MIN(ADV_REC_NO) AS SRFM,
               MAX(ADV_REC_NO) AS SRTO,
               COUNT(*) AS TOTAL_NO,
               SUM(CASE WHEN CANCELLED =1 THEN 1 ELSE 0 END ) TOTAL_CANCELLED
        FROM ARC01106   B (NOLOCK) 
        JOIN LOCATION C (NOLOCK) ON C.DEPT_ID =b.location_Code
        WHERE  B.ADV_REC_DT BETWEEN @DFMDATE AND @DTODATE
		AND (@CGSTN_NO='' OR C.LOC_GST_NO=@CGSTN_NO)
		AND (@CLOC_TYPE =0 OR ISNULL(C.LOC_TYPE,0)=@CLOC_TYPE )
		AND (@CDEPT_ID='' OR b.location_Code=@CDEPT_ID)
		and isnull(b.gst_percentage,0)<>0
	--	AND ISNULL(C.LOC_TYPE,0)=1
		GROUP BY LEFT(ADV_REC_NO,len(b.location_Code)+3)
		
		--rcm series
		
		  IF OBJECT_ID ('TEMPDB..#TMPPUR','U') IS NOT NULL
          DROP TABLE #TMPPUR
          
       SELECT A.mrr_id,LEN(rcm_memo_no  ) AS LEN_mrr_NO,
       rcm_memo_no,bill_dt  ,CANCELLED,MEMO_PREFIX
       INTO #TMPPUR
       FROM pim01106  A (NOLOCK)
       JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =CASE WHEN ISNULL(A.PUR_FOR_DEPT_ID ,'')<>'' THEN PUR_FOR_DEPT_ID ELSE A.DEPT_ID END
       WHERE  ISNULL(A.MEMO_TYPE,0)  IN(0,1)
       AND A.BILL_DT  BETWEEN @DFMDATE AND @DTODATE
       AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
       AND (@CLOC_TYPE =0 OR ISNULL(B.LOC_TYPE,0)=@CLOC_TYPE )
       AND (@CDEPT_ID='' OR b.dept_id=@CDEPT_ID)
       and isnull(a.rcm_applicable ,0)=1
       

       
       SELECT RTYPE ,DOC_TYPE  AS [NATURE  OF DOCUMENT] ,
              LTRIM(RTRIM(SRFM)) AS [SR. NO. FROM],
              LTRIM(RTRIM(SRTO)) AS [SR. NO. TO],
              TOTAL_NO AS[TOTAL NUMBER] ,
              TOTAL_CANCELLED AS [CANCELLED]
       FROM @TBLDOC
       ORDER BY SR,SRFM
       
       SELECT RTYPE ,SUM(TOTAL_NO) AS TOTAL_NO,
              SUM(TOTAL_CANCELLED) AS [TOTAL CANCELLED]
       FROM @TBLDOC
	   GROUP BY RTYPE
 
END

