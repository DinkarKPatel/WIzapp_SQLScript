CREATE PROCEDURE SP_VALIDATEXN_BEFORESAVE_ARC
(
	@NSPID			varchar(50),
	@CUSERCODE		NVARCHAR(10),
	@NUPDATEMODE	INT,
	@CRETVAL		NVARCHAR(MAX) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
	BEGIN TRY
		DECLARE @CCMD		NVARCHAR(MAX),
				@CTEMPARC		NVARCHAR(MAX),
				@CTEMPCMMCREDITRECEIPT NVARCHAR(MAX),
				@CTEMPDBNAME	VARCHAR(50),
				@NSTEP INT,@NAMOUNT NUMERIC(10,2),@NDISCAMOUNT NUMERIC(10,2),@NNETAMOUNT NUMERIC(10,2)

		SET @NSTEP=0

	
		SET @CTEMPDBNAME = ''
		--+LTRIM(RTRIM(STR(@NSPID)))
		
		SET @CTEMPARC=@CTEMPDBNAME+'arc_arc01106_upload'
		SET @CTEMPCMMCREDITRECEIPT='ARC_CMM_CREDIT_RECEIPT_UPLOAD'

		SET @CRETVAL=''

		
		--********************************************VALIDATION FOR CMM01106****************************************************
		
		SET @NSTEP=0
		--VALIDATING ARC TYPE MODE
		SET @CCMD=N'IF EXISTS ((SELECT TOP 1 ARC_TYPE FROM '+ @CTEMPARC + N' WHERE (ARC_TYPE IN (2) OR arct<>1) AND SP_ID='''+@NSPID+''') )  AND 
		              EXISTS (SELECT TOP 1 ''U'' FROM '+ @CTEMPCMMCREDITRECEIPT +N' WHERE  SP_ID='''+@NSPID+''' )
						SET @CRETVAL1=''BILLS REFERENCE CAN ONLY BE LINKED WITH O/S Receipt....CAN NOT PROCEED'''
						
		EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		PRINT @CCMD
		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		GOTO ATLAST
		
		--********************************************VALIDATION FOR CMM01106****************************************************
		
		--SET @NSTEP=0
		----VALIDATING ARC TYPE MODE
		--SET @CCMD=N'IF EXISTS (SELECT TOP 1 ARC_TYPE FROM '+ @CTEMPARC + N' WHERE ARC_TYPE IN (2)) AND 
		--               EXISTS (SELECT TOP 1 ''U'' FROM '+ @CTEMPCMMCREDITRECEIPT +N' )
		--				SET @CRETVAL1=''BILLS REFERENCE CAN NOT BE LINKED WITH PAYMENT....CAN NOT PROCEED'''
		--		PRINT @CCMD		
		--EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		
		--IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		--GOTO ATLAST
		
		
		
		
		
		SET @NSTEP=1
		SET @CCMD=N'IF NOT EXISTS (SELECT COUNT(*) FROM '+@CTEMPARC+' WHERE  SP_ID='''+@NSPID+''')
						SET @CRETVAL1=''NO RECORD FOUND AT MASTER LEVEL..... CANNOT PROCEED'''

		EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		PRINT @CCMD
		PRINT 'RETURN VALUE :'+ISNULL(@CRETVAL,'')

		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		GOTO ATLAST

		--VALIDATING FINYEAR
		SET @CCMD=N'SELECT @CRETVAL1=(CASE WHEN ''01'' + LTRIM(RTRIM((DBO.FN_GETFINYEAR(ADV_REC_DT))))=FIN_YEAR THEN '''' 
					ELSE ''MEMO DATE IS NOT IN CURRENT FINANCIAL YEAR...CAN NOT PROCEED'' END)
					FROM '+ @CTEMPARC +' WHERE  SP_ID='''+@NSPID+''''
		EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		PRINT @CCMD
		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		GOTO ATLAST

		SET @NSTEP=3
		--VALIDATING ARC TYPE MODE
		SET @CCMD=N'IF EXISTS (SELECT TOP 1 ARC_TYPE FROM '+ @CTEMPARC + N' WHERE ARC_TYPE NOT IN (1,2) AND SP_ID='''+@NSPID+''') 
						SET @CRETVAL1=''RECEIPT/PAYMENT MODE IS NOT CORRECT...CAN NOT PROCEED'''
						
		EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		PRINT @CCMD
		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		GOTO ATLAST

		SET @NSTEP=4
		--VALIDATING ARCT TYPE MODE
		SET @CCMD=N'IF EXISTS (SELECT TOP 1 ARCT FROM '+ @CTEMPARC + N' WHERE ARC_TYPE=1 AND ARCT NOT IN (1,2,3,4,5)  AND SP_ID='''+@NSPID+''') 
						SET @CRETVAL1=''RECEIPT TYPE IS NOT CORRECT...CAN NOT PROCEED'''
		
						
		EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		PRINT @CCMD
		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		GOTO ATLAST
		
		SET @NSTEP=5
		--VALIDATING RECEIVED AMOUNT
		SET @CCMD=N'SELECT TOP 1 @NAMOUNTOUT=AMOUNT,@NDISCAMOUNTOUT=DISCOUNT_AMOUNT,@NNETAMOUNTOUT=NET_AMOUNT FROM '+
					@CTEMPARC +' WHERE  SP_ID='''+@NSPID+''''
		PRINT @CCMD				
		EXEC SP_EXECUTESQL @CCMD,N'@NAMOUNTOUT NUMERIC(10,2) OUTPUT,@NDISCAMOUNTOUT NUMERIC(10,2) OUTPUT,
		@NNETAMOUNTOUT NUMERIC(10,2) OUTPUT',@NAMOUNTOUT=@NAMOUNT OUTPUT,@NDISCAMOUNTOUT=@NDISCAMOUNT OUTPUT,
		@NNETAMOUNTOUT=@NNETAMOUNT OUTPUT
		
		IF ISNULL(@NAMOUNT,0)<=0
			SET @CRETVAL='ZERO OR NEGATIVE AMOUNT IS NOT ALLOWED...CAN NOT PROCEED'
		ELSE
		IF ISNULL(@NDISCAMOUNT,0)<0
			SET @CRETVAL='NEGATIVE DISCOUNT AMOUNT IS NOT ALLOWED...CAN NOT PROCEED'
		ELSE
		IF ISNULL(@NNETAMOUNT,0)<0
			SET @CRETVAL='ZERO OR NEGATIVE NET AMOUNT IS NOT ALLOWED...CAN NOT PROCEED'
		
		IF ISNULL(@CRETVAL,'')<>''
			GOTO ATLAST
			
		--VALIDATING CUSTOMER CODE

		SET @NSTEP=9
		--IF @BVALUE=1
		--BEGIN
		SET @CCMD=N'IF EXISTS (SELECT TOP 1 A.CUSTOMER_CODE FROM '+ @CTEMPARC + N' A 
								WHERE CUSTOMER_CODE IN ('''',''000000000000'') AND AC_CODE IN ('''',''0000000000'') AND SP_ID='''+@NSPID+''')
						SET @CRETVAL1=''CUSTOMER DETAILS SHOULD NOT BE BLANK....CAN NOT PROCEED'''
						EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		--END
		PRINT @CCMD
		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
			GOTO ATLAST

		
		--VALIDATING USER CODE
		IF @NUPDATEMODE=1
		BEGIN
			SET @NSTEP=10
			SET @CCMD=N'UPDATE '+ @CTEMPARC + N' SET USER_CODE='''+@CUSERCODE+''' WHERE LTRIM(RTRIM(USER_CODE)) = '''' AND SP_ID='''+@NSPID+''''
			EXEC SP_EXECUTESQL @CCMD
		END

		SET @NSTEP=12
		SET @CCMD=N'IF EXISTS (SELECT TOP 1 A.USER_CODE FROM '+ @CTEMPARC + N' A 
								LEFT OUTER JOIN USERS B ON B.USER_CODE=A.USER_CODE
								WHERE B.USER_CODE IS NULL AND SP_ID='''+@NSPID+''')
						SET @CRETVAL1=''INVALID USER DETAILS FOUND....CAN NOT PROCEED'''
		EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		PRINT @CCMD
		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
			GOTO ATLAST

		--VALIDATING EDITING USER CODE
		IF @NUPDATEMODE=1
		BEGIN
			SET @NSTEP=10
			SET @CCMD=N'UPDATE '+ @CTEMPARC + N' SET EDT_USER_CODE='''+@CUSERCODE+''' WHERE LTRIM(RTRIM(USER_CODE)) = '''' AND SP_ID='''+@NSPID+''''
			EXEC SP_EXECUTESQL @CCMD
		END

		--SET @NSTEP=12
		--SET @CCMD=N'IF EXISTS (SELECT TOP 1 A.USER_CODE FROM '+ @CTEMPARC + N' A 
		--						LEFT OUTER JOIN USERS B ON B.USER_CODE=A.EDT_USER_CODE
		--						WHERE B.USER_CODE IS NULL)
		--				SET @CRETVAL1=''INVALID EDITING USER DETAILS FOUND....CAN NOT PROCEED'''
		--EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		--PRINT @CCMD
		--IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		--	GOTO ATLAST
		
		
	
		--VALIDATING EMPLOYEE 
		SET @CRETVAL=''
		SET @CCMD=N'UPDATE '+ @CTEMPARC + N' SET EMP_CODE= (CASE WHEN LTRIM(RTRIM(EMP_CODE))='''' THEN ''0000000'' ELSE EMP_CODE END) WHERE  SP_ID='''+@NSPID+''''
		EXEC SP_EXECUTESQL @CCMD

			SET @NSTEP=14

		SET @CCMD=N'IF EXISTS (SELECT TOP 1 A.EMP_CODE FROM '+ @CTEMPARC + N' A 
							   LEFT OUTER JOIN EMPLOYEE B ON B.EMP_CODE=A.EMP_CODE WHERE B.EMP_CODE IS NULL  AND SP_ID='''+@NSPID+''')
						SET @CRETVAL1=''INVALID SALES PERSON DETAILS FOUND....CAN NOT PROCEED'''
		EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		PRINT @CCMD
		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
			GOTO ATLAST

		SET @NSTEP=15
		--VALIDATING DISCOUNT AMOUNT
		SET @CCMD=N'IF EXISTS (SELECT TOP 1 A.DISCOUNT_AMOUNT  FROM '+@CTEMPARC+ ' A
							WHERE ((A.DISCOUNT_AMOUNT > A.AMOUNT) OR NET_AMOUNT <0) AND SP_ID='''+@NSPID+''')
						SET @CRETVAL1=''DISCOUNT CAN NOT BE MORE THAN RECEIVED AMOUNT... PLEASE CHECK'''
		EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
		PRINT @CCMD
		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		GOTO ATLAST

		SET @CRETVAL=''

		SET @NSTEP=16
		ATLAST:

		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
			SET @CRETVAL=ISNULL(@CRETVAL,'') +'(SP_VALIDATEXN_BEFORESAVE_ARC)'
	END TRY
	
	BEGIN CATCH
		SET @CRETVAL=N'ERROR FOUND IN PROCEDURE : SP_VALIDATEXN_BEFORESAVE_ARC '+ISNULL(ERROR_PROCEDURE(),'NULL P')+
		'STEP : '+LTRIM(RTRIM(STR(@NSTEP)))+' AT LINE NO. :'+  
		  ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+' MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')  
	END CATCH
END
---- 'END OF CREATING PROCEDURE SP_VALIDATEXN_BEFORESAVE_ARC'
