CREATE PROCEDURE SP_MERGEDOCPRT_APPDATA  
(  
 @CMEMOID VARCHAR(40)
)  
--WITH ENCRYPTION
AS  
BEGIN    
	  DECLARE @CERRORMSG VARCHAR(1000),@CCURDEPTID CHAR(2),@CHODEPTID CHAR(2),@CCMD NVARCHAR(MAX),
			  @NSTEP INT,@BPROCEED BIT,@BLOCDATAEXISTS BIT,@CTABLEPREFIX VARCHAR(100),@CXNTYPE VARCHAR(15)	
		
	    
	  BEGIN TRANSACTION  
	    
	  SET @NSTEP = 10  
	  DECLARE @TRETMSG TABLE  (MEMO_ID VARCHAR(40),ERRMSG VARCHAR(MAX))  
	   
	  BEGIN TRY  
	       
	  SELECT @CERRORMSG='',@BPROCEED=1,@CXNTYPE='DOCPRT_APP'
	    
	  SET @CTABLEPREFIX='TMP_DOCPRT_APP'
	   
	  SET @NSTEP = 20  
	  	
	  SET @CCMD=N'IF OBJECT_ID(''TMP_DOCPRT_APP_RMM01106_'+LTRIM(RTRIM(@CMEMOID))+''',''U'') IS NOT NULL  
		  SELECT @BLOCDATAEXISTSOUT=1   
		 ELSE  
		  SELECT @BLOCDATAEXISTSOUT=0'  
	  EXEC SP_EXECUTESQL @CCMD,N'@BLOCDATAEXISTSOUT BIT OUTPUT',@BLOCDATAEXISTSOUT=@BLOCDATAEXISTS OUTPUT  
	    
	  IF @BLOCDATAEXISTS=0  
	  BEGIN  
		   SET @NSTEP = 25  
		     
		   SET @CERRORMSG='NO DEBIT NOTE APPROVAL DATA FOUND TO BE MERGED'  
		   GOTO LBLLAST  
	  END  

	  SET @NSTEP=30
	  IF EXISTS (SELECT RM_ID FROM RMM01106 WHERE RM_ID=@CMEMOID AND APPROVED=3)
	  BEGIN
			SET @CERRORMSG='DEBIT NOTE HAS ALREADY BEEN DISAPPROVED AND MARKED AS CANCELLED....CANNOT REPROCESS'
			GOTO LBLLAST	
	  END 	
	  	    
	  SET @NSTEP=35
	  
	  SET @CCMD=N'UPDATE RMM01106 SET APPROVED=B.APPROVED,EXPORTED=(CASE WHEN B.APPROVED=2 THEN 1 ELSE EXPORTED END)
				  FROM [TMP_DOCPRT_APP_RMM01106_'+LTRIM(RTRIM(@CMEMOID))+'] B WHERE B.RM_ID=RMM01106.RM_ID'	 
	  
	  EXEC SP_EXECUTESQL @CCMD
	  
	  
	  SET @NSTEP=40

	  ----- JUST CANCEL THE DEBIT NOTE IF IT HAS BEEN DISAPPROVED BY HEAD OFFICE		  
	  IF EXISTS (SELECT RM_ID FROM RMM01106 WHERE RM_ID=@CMEMOID AND APPROVED=3 AND CANCELLED=0)	      	  
		  EXEC SAVETRAN_PRT 
		  @NUPDATEMODE=3,
		  @CMEMOID=@CMEMOID
	  
	  -- DELETING FROM TEMP TABLES  
	  
	  GOTO LBLLAST
	    
	 END TRY  
	  
	 BEGIN CATCH  
		  
		  PRINT 'UNTRAPPED ERROR'    
		       
		  DECLARE @CERRORPROCNAME VARCHAR(100),@CLINENO VARCHAR(5),@CERRTEXT VARCHAR(MAX)  
		    
		  SELECT @CERRORPROCNAME=ISNULL(ERROR_PROCEDURE(),'NULL P'),@CLINENO=ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE'),  
		  @CERRTEXT='STEP : '+LTRIM(RTRIM(STR(@NSTEP)))+' '+ISNULL(ERROR_MESSAGE(),'NULL MSG')  
		    
		  SELECT @CERRORMSG=@CERRTEXT  
		  
		  GOTO LBLLAST  
     END CATCH  

LBLLAST:  	 
	 
	      
	IF @@TRANCOUNT>0  
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			COMMIT TRANSACTION  
		 ELSE
			ROLLBACK
	END	
	 
 	INSERT @TRETMSG
	SELECT @CMEMOID,@CERRORMSG
			
	SELECT * FROM @TRETMSG

	EXEC SP_DROPTEMPTABLES_XNS 'DOCPRT_APP',0,@CMEMOID,'TMP_DOCPRT_APP'  

END  
--- 'END OF CREATING PROCEDURE SP_MERGEDOCPRT_APPDATA'
