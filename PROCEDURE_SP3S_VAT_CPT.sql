CREATE PROCEDURE SP3S_VAT_CPT
(
	 @DFROMDT DATETIME
	,@DTODT DATETIME
	,@CFLT_HEAD VARCHAR(20)=''
)
--WITH ENCRYPTION
AS
BEGIN
DECLARE @DTSQL NVARCHAR(MAX)


IF OBJECT_ID('TEMPDB..#HEADS','U') IS NOT NULL
	DROP TABLE #HEADS

CREATE TABLE #HEADS(HEAD_CODE VARCHAR(10))	

INSERT #HEADS(HEAD_CODE)
SELECT * FROM DBO.FN3S_SUBHEADS(@CFLT_HEAD)

------LIST OF PURCHASES
SET @DTSQL=N'
	   SELECT		1 AS SR_NO	
				,''PURCHASE'' AS XN  
				,(F.FORM_NAME) AS TAX_PERCENTAGE
				, SUM( PID.RFNET-PID.TAX_AMOUNT ) AS GROSS_VALUE
				, SUM(PID.TAX_AMOUNT) AS TAX_AMOUNT
				, SUM(PID.RFNET) AS TOTAL_VALUE
		FROM PIM01106 A  (NOLOCK)
		JOIN PID01106 PID (NOLOCK) ON A.MRR_ID=PID.MRR_ID
		JOIN FORM F (NOLOCK) ON PID.FORM_ID=F.FORM_ID
		JOIN LM01106 B (NOLOCK) ON F.TAX_AC_CODE = B.AC_CODE  
		JOIN LM01106 B1 (NOLOCK) ON A.AC_CODE = B1.AC_CODE  
		LEFT JOIN #HEADS HD ON HD.HEAD_CODE = B.HEAD_CODE  
		WHERE A.RECEIPT_DT BETWEEN '''+CONVERT(VARCHAR,@DFROMDT,110)+''' AND '''+CONVERT(VARCHAR,@DTODT,110)+''' 
		AND A.MEMO_TYPE=1 AND A.PIM_MODE=1 AND A.INV_MODE=1 AND A.BILL_NO <> ''''  AND A.CANCELLED=0  AND ROUND(A.SUBTOTAL,0)<>0  
		'+(CASE WHEN ISNULL(@CFLT_HEAD,'')='' THEN '' ELSE ' AND HD.HEAD_CODE IS NOT NULL ' END)+' 
		GROUP  BY (F.FORM_NAME)
	UNION ALL '
-----LIST OF PURCHASE RETURN
SET @DTSQL=@DTSQL+N'
	SELECT		 2 AS SR_NO
				,''PURCHASE RETURN'' AS XN
				,(F.FORM_NAME) AS TAX_PERCENTAGE
				, SUM( PID.RFNET-PID.ITEM_TAX_AMOUNT ) AS GROSS_VALUE
				, SUM(PID.ITEM_TAX_AMOUNT) AS TAX_AMOUNT
				, SUM(PID.RFNET) AS TOTAL_VALUE
		FROM RMM01106 A  (NOLOCK)
		JOIN RMD01106 PID (NOLOCK) ON A.RM_ID=PID.RM_ID
		JOIN FORM F (NOLOCK) ON PID.ITEM_FORM_ID=F.FORM_ID
		JOIN LM01106 B (NOLOCK) ON F.TAX_AC_CODE = B.AC_CODE  
		JOIN LM01106 B1 (NOLOCK) ON A.AC_CODE = B1.AC_CODE  
		LEFT JOIN #HEADS HD (NOLOCK) ON HD.HEAD_CODE = B.HEAD_CODE  
		WHERE A.RM_DT BETWEEN '''+CONVERT(VARCHAR,@DFROMDT,110)+''' AND '''+CONVERT(VARCHAR,@DTODT,110)+''' 
		AND A.MEMO_TYPE=1 AND A.MODE<>2
		AND A.CANCELLED=0  
		AND  ROUND(A.SUBTOTAL,0) <>0  
		'+(CASE WHEN ISNULL(@CFLT_HEAD,'')='' THEN '' ELSE ' AND HD.HEAD_CODE IS NOT NULL ' END)+' 
		GROUP  BY (F.FORM_NAME)
	UNION ALL	'
----LIST OF SALES
SET @DTSQL=@DTSQL+N'SELECT		 3 AS SR_NO
				,''SALE'' AS XN
				,CONVERT(VARCHAR(10),(PID.TAX_PERCENTAGE)) AS TAX_PERCENTAGE
				, SUM( PID.RFNET-PID.TAX_AMOUNT ) AS GROSS_VALUE
				, SUM(PID.TAX_AMOUNT) AS TAX_AMOUNT
				, SUM(PID.RFNET) AS TOTAL_VALUE
		FROM CMM01106 A  (NOLOCK)
		JOIN CMD01106 PID (NOLOCK) ON A.CM_ID=PID.CM_ID
		WHERE A.CM_DT BETWEEN '''+CONVERT(VARCHAR,@DFROMDT,110)+''' AND '''+CONVERT(VARCHAR,@DTODT,110)+''' 
		AND A.MEMO_TYPE=1 AND A.CM_MODE=1
		AND A.CANCELLED=0  
		GROUP  BY (PID.TAX_PERCENTAGE)
		ORDER BY SR_NO,(TAX_PERCENTAGE)'

PRINT @DTSQL
EXEC SP_EXECUTESQL @DTSQL
END
---END OF PROCEDURE - SP3S_VAT_CPT
