CREATE PROCEDURE SP_PRD_WO_CANCELLED
(
 @NQUERYID INT,
 @CMEMO_ID VARCHAR(100)='',
 @CWHERE VARCHAR(1000)=''
)
AS
BEGIN
 DECLARE @CCMD NVARCHAR(MAX)                

IF @NQUERYID=1
   GOTO LBLMST
ELSE IF @NQUERYID=2
   GOTO LBLDETNEWMEMO
ELSE IF @NQUERYID=3
   GOTO LBLDETEXISTINGMEMO 
ELSE IF @NQUERYID=4
   GOTO LBLNAVIGATE 
LBLMST:
 IF @CMEMO_ID<>''
 BEGIN
   SELECT MEMO_NO ,
		  MEMO_ID,
		  MEMO_DT,
		  CANCELLED,
		  A.USER_CODE,
		  A.LAST_UPDATE,
		  B.USERNAME
   FROM PRD_WO_CNC_MST A
   JOIN USERS B ON A.USER_CODE=B.USER_CODE
   WHERE A.MEMO_ID=@CMEMO_ID
 
 END
 ELSE
 BEGIN
 SELECT   MEMO_NO =CAST('LATER' AS VARCHAR(10)),
		  MEMO_ID=CAST('LATER' AS VARCHAR(22)) ,
		  MEMO_DT=GETDATE(),
		  CANCELLED=CAST(0 AS BIT),
		  LAST_UPDATE=GETDATE(),
		  USER_CODE =CAST('' AS VARCHAR(10)),
		  FIN_YEAR=CAST('' AS VARCHAR(10))
		  WHERE 1=2
 END

GOTO END_PROC
    
LBLDETNEWMEMO:

  IF OBJECT_ID('TEMPDB..#TMPORDER_PENDING','U') IS NOT NULL
     DROP TABLE #TMPORDER_PENDING
     
  SELECT CAST(0 AS BIT) AS CHK, MST.MEMO_ID AS REF_WO_ID
			,MST.MEMO_NO AS ORDER_NO
			,MST.MEMO_DT  AS ORDER_DT
			,AR1.ARTICLE_NAME AS FG_ARTICLE_NAME
			,AR1.ARTICLE_NO AS FG_ARTICLE_NO
			,AR1.ARTICLE_CODE AS ARTICLE_CODE
			,PARA1.PARA1_CODE
			,PARA1.PARA1_NAME
			,PARA2.PARA2_CODE
			,PARA2.PARA2_NAME
		    ,DET1.QUANTITY AS WO_QTY
			,DET.QUANTITY AS REQUIRED_QTY	 
	INTO #TMPORDER_PENDING  
	FROM PRD_WO_ART_BOM A (NOLOCK)      
	JOIN PRD_WO_DET B (NOLOCK) ON A.REF_ROW_ID = B.ROW_ID
	JOIN PRD_WO_MST MST (NOLOCK) ON B.MEMO_ID=MST.MEMO_ID
	JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE =B.ARTICLE_CODE
	JOIN ARTICLE AR1 (NOLOCK) ON AR1.ARTICLE_CODE =MST.ARTICLE_SET_CODE     
	JOIN PARA1 P1 (NOLOCK) ON A.PARA1_CODE=P1.PARA1_CODE
	JOIN PARA2 P2 (NOLOCK) ON A.PARA2_CODE=P2.PARA2_CODE
	JOIN
	(
	 SELECT PARA1_CODE,PARA2_CODE,REF_ROW_ID,SUM(QUANTITY) AS QUANTITY 
	 FROM PRD_WO_SUB_DET C
	 GROUP BY REF_ROW_ID,PARA1_CODE,PARA2_CODE
	) DET ON B.ROW_ID=DET.REF_ROW_ID
	JOIN ARTICLE C (NOLOCK) ON A.BOM_ARTICLE_CODE = C.ARTICLE_CODE 
	JOIN
	(
	 SELECT  REF_ROW_ID,SUM(QUANTITY) AS QUANTITY 
	 FROM PRD_WO_SUB_DET C
	 GROUP BY REF_ROW_ID
	) DET1 ON B.ROW_ID=DET1.REF_ROW_ID
	JOIN PARA1  (NOLOCK) ON DET.PARA1_CODE=PARA1.PARA1_CODE
	JOIN PARA2  (NOLOCK) ON DET.PARA2_CODE=PARA2.PARA2_CODE
	WHERE 
	 MST.CANCELLED=0
	AND MARK_AS_COMPLETED=1
	--AND MST.MEMO_ID='HO0111700000HO00000559'
	GROUP BY MST.MEMO_ID 
			,MST.MEMO_NO 
			,MST.MEMO_DT  
			,AR1.ARTICLE_NAME 
			,AR1.ARTICLE_NO 
			,AR1.ARTICLE_CODE 
			,PARA1.PARA1_CODE
			,PARA1.PARA1_NAME
			,PARA2.PARA2_CODE
			,PARA2.PARA2_NAME
		    ,DET1.QUANTITY 
			,DET.QUANTITY
			
			SELECT A.*,ISNULL(B.CUTTING_QTY,0) AS CUTTING_QTY,
			ISNULL(A.REQUIRED_QTY,0)-ISNULL(B.CUTTING_QTY,0) AS PENDING_QTY,
			QUANTITY =CAST(0 AS NUMERIC(10,2)),
			ROW_ID =CAST('LATER' + CAST(NEWID() AS VARCHAR(100)) AS VARCHAR(40)),
			MEMO_ID=CAST('LATER' AS VARCHAR(22))
			FROM #TMPORDER_PENDING A
			LEFT OUTER JOIN
			(
             
			  SELECT A.REF_WO_ID ,A.PARA1_CODE,A.PARA2_CODE ,SUM(CUTTING_QTY) AS CUTTING_QTY
			  FROM 
			  (
			  SELECT C.REF_WO_ID ,A.PARA1_CODE,A.PARA2_CODE ,SUM(ISSUE_QTY) AS CUTTING_QTY
			  FROM 
			  PRD_STK_TRANSFER_MATERIAL_DET A
			  JOIN PRD_STK_TRANSFER_MST B ON A.MEMO_ID =B.MEMO_ID
			  JOIN
			  (
			   SELECT REF_WO_ID ,MEMO_ID 
			   FROM PRD_STK_TRANSFER_DET  A
			   GROUP BY REF_WO_ID ,MEMO_ID 
			  ) C ON B.MEMO_ID=C.MEMO_ID
			  WHERE B.CANCELLED=0
			  GROUP BY C.REF_WO_ID ,A.PARA1_CODE,A.PARA2_CODE 
			  UNION ALL
			  SELECT B.REF_WO_ID ,B.PARA1_CODE,B.PARA2_CODE ,SUM(QUANTITY) AS CANCELLED_QTY
			  FROM PRD_WO_CNC_MST A
              JOIN PRD_WO_CNC_DET B ON A.MEMO_ID=B.MEMO_ID
              WHERE A.CANCELLED=0
              GROUP BY B.REF_WO_ID ,B.PARA1_CODE,B.PARA2_CODE
              ) A
              GROUP BY A.REF_WO_ID ,A.PARA1_CODE,A.PARA2_CODE 
			) B ON A.REF_WO_ID =B.REF_WO_ID 
			AND A.PARA1_CODE=B.PARA1_CODE 
			AND A.PARA2_CODE=B.PARA2_CODE
       WHERE ISNULL(A.REQUIRED_QTY,0)-ISNULL(B.CUTTING_QTY,0)>0
 
       
 GOTO END_PROC

 LBLDETEXISTINGMEMO:
    
    
   SELECT  B.REF_WO_ID
			,MST.MEMO_NO AS ORDER_NO
			,MST.MEMO_DT  AS ORDER_DT
			,AR1.ARTICLE_NAME AS FG_ARTICLE_NAME
			,AR1.ARTICLE_NO AS FG_ARTICLE_NO
			,AR1.ARTICLE_CODE AS ARTICLE_CODE
			,P1.PARA1_CODE
			,P1.PARA1_NAME
			,P2.PARA2_CODE
			,P2.PARA2_NAME
		    ,WO_QTY AS WO_QTY
		    ,0 AS REQUIRED_QTY	
		    ,ISNULL(CUTTING_QTY,0) AS CUTTING_QTY,
			 WO_QTY-(ISNULL(CUTTING_QTY,0)+B.QUANTITY) AS PENDING_QTY
			 ,B.QUANTITY
			 ,ROW_ID
			 ,A.MEMO_ID
	FROM PRD_WO_CNC_MST A
    JOIN PRD_WO_CNC_DET B ON A.MEMO_ID=B.MEMO_ID
    JOIN PRD_WO_MST MST ON B.REF_WO_ID=MST.MEMO_ID
    LEFT OUTER JOIN
	(
	  SELECT C.REF_WO_ID ,A.PARA1_CODE,A.PARA2_CODE ,SUM(ISSUE_QTY) AS CUTTING_QTY
	  FROM 
	  PRD_STK_TRANSFER_MATERIAL_DET A
	  JOIN PRD_STK_TRANSFER_MST B ON A.MEMO_ID =B.MEMO_ID
	  JOIN
	  (
	  SELECT REF_WO_ID ,MEMO_ID 
	  FROM PRD_STK_TRANSFER_DET  A
	  GROUP BY REF_WO_ID ,MEMO_ID 
	  ) C ON B.MEMO_ID=C.MEMO_ID
      WHERE B.CANCELLED=0
	GROUP BY C.REF_WO_ID ,A.PARA1_CODE,A.PARA2_CODE 
	) C ON C.REF_WO_ID =B.REF_WO_ID 
	AND C.PARA1_CODE=B.PARA1_CODE 
	AND C.PARA2_CODE=B.PARA2_CODE
    JOIN ARTICLE AR1 (NOLOCK) ON AR1.ARTICLE_CODE =B.ARTICLE_CODE     
	JOIN PARA1 P1 (NOLOCK) ON B.PARA1_CODE=P1.PARA1_CODE
	JOIN PARA2 P2 (NOLOCK) ON B.PARA2_CODE=P2.PARA2_CODE
	 JOIN 
    (
     SELECT A.MEMO_ID ,PARA1_CODE,PARA2_CODE,SUM(QUANTITY) AS WO_QTY
     FROM  
    
	(
	 SELECT MEMO_ID,PARA1_CODE,PARA2_CODE,QUANTITY
	 FROM PRD_WO_DET A
	 JOIN PRD_WO_SUB_DET B ON A.ROW_ID=B.REF_ROW_ID
	 GROUP BY MEMO_ID,PARA1_CODE,PARA2_CODE,QUANTITY
	) A
	GROUP BY A.MEMO_ID ,PARA1_CODE,PARA2_CODE
	
    )ORD ON ORD.MEMO_ID=MST.MEMO_ID 
    AND ORD.PARA1_CODE=P1.PARA1_CODE
    AND ORD.PARA2_CODE=P2.PARA2_CODE
	WHERE A.MEMO_ID=@CMEMO_ID
 
GOTO END_PROC 
 
 
 
 LBLNAVIGATE:
 SET @CCMD=N'SELECT MEMO_ID,MEMO_NO FROM PRD_WO_CNC_MST '+(CASE WHEN ISNULL(@CWHERE,'')='' THEN ''        
    ELSE ' WHERE '+@CWHERE END)        
 PRINT @CCMD        
 EXEC SP_EXECUTESQL @CCMD                  
GOTO END_PROC 

END_PROC:
END
