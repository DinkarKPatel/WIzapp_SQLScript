CREATE PROCEDURE SP_SEND_MIRROR_MSTUSR_NEW--(LocId 3 digit change by Sanjay:06-11-2024)
(
	@CTARGETLOCID VARCHAR(5)='',
	@CLOCUSRMSTLASTUPDATE VARCHAR(50)='',
	@NAPIVERSION INT=0,
	@NMODE INT=0
)
--WITH ENCRYPTION
AS
BEGIN
  DECLARE @CCMD NVARCHAR(MAX)=''

  BEGIN TRY
		--INSERT CALL_WC (SP_NAME, CUSTOMER_CODE,PARA_EXPR, LAST_UPDATE) SELECT 'SP_SEND_MIRROR_MSTUSR' AS SP_NAME,'',STR(@NAPIVERSION) ,GETDATE()
		DECLARE @CERRORMSG VARCHAR(1000),@CCURDEPTID VARCHAR(4),@CHODEPTID VARCHAR(4),
				@CXNMASTERTABLENAME VARCHAR(100),@BPROCEED BIT,@CTABLENAME VARCHAR(100),@CMASTERKEYFIELD VARCHAR(100),
				@CKEYFIELD VARCHAR(100),@CPARENTTABLENAME VARCHAR(100),@CPARENTPARANAME VARCHAR(100),@CCHILDPARANAME VARCHAR(100),
				@CWHERECLAUSE VARCHAR(100),@CJOINSTR VARCHAR(1000),@CMEMOID VARCHAR(100),@CFINYEAR VARCHAR(100),
				@NGRPCHARS INT,@NSERIESCHARS INT,@BSERIESBROKEN BIT,@CPREVMEMOID VARCHAR(40),@CMERGETABLENAME VARCHAR(50),
				@CFIRSTMEMOID VARCHAR(40),@NPREVMEMOID INT,@NMEMONOLEN INT,@CRETCMD NVARCHAR(MAX),
				@CDELCHILDTABLENAME VARCHAR(100),@CDELCHILDPARANAME VARCHAR(100),@CDELPARENTPARANAME VARCHAR(100),
				@CORIGINALTABLENAME VARCHAR(100),@NLOCTYPE INT,@BDONOTMERGE BIT,@CRFXNTYPE VARCHAR(10),@BHOLOC BIT,
				@BINSERTONLY BIT,@BLINKEDMASTER BIT,@BPURLOC BIT,@CSOURCELOCID VARCHAR(4),@BSOURCEPURLOC BIT,
				@CMISSINGMEMOID VARCHAR(40),@CGRPCODE VARCHAR(20),@BRETVAL BIT,@NPREVNO INT,@CPREVNO VARCHAR(20),
				@BEMPHEADSUPDATED BIT,@CFILTERCONDITION VARCHAR(100),@CTABLEPREFIX VARCHAR(100),@CXNTYPE VARCHAR(10),
				@NXNSMERGINGORDER INT,@NSTEP INT,@CKEYFIELD2 VARCHAR(100),@CTMP_TABLENAME VARCHAR(500),
				@CSOURCEDB VARCHAR(200),@CHOUSRMSTLASTUPDATE VARCHAR(50),@CTEMPDBNAME VARCHAR(500),
				@CSLSSETLUPD VARCHAR(50),@CTEMPTABLENAME VARCHAR(500),@NSPID INT,@CSPID VARCHAR(5),@DTSQL NVARCHAR(MAX)
				,@CDEPTID VARCHAR(5)--01 FEB 2018
		
		SET @CDEPTID=@CTARGETLOCID--01 FEB 2018
		SET @CCMD=''
		SET @NSTEP=10	
		
		SET @NSPID=@@SPID
		
		SET @CSPID=LTRIM(RTRIM(LTRIM(RTRIM(STR(@NSPID)))))
				
		SET @CSOURCEDB=''
		
		DECLARE @TRETMSG TABLE (MEMO_ID VARCHAR(40),ERRMSG VARCHAR(MAX))

		SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
		SELECT @CHODEPTID  = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
		
		IF @CCURDEPTID<>@CHODEPTID
		   BEGIN
			  SELECT TOP 1 @CSLSSETLUPD=VALUE FROM CONFIG WHERE CONFIG_OPTION='MSTUSRROLE_LAST_UPDATE' 
			  SET @CSLSSETLUPD=ISNULL(@CSLSSETLUPD,'')
			  SELECT @CSLSSETLUPD AS LAST_UPDATE,'' AS ERRMSG
			  GOTO END_PROC
		   END	
		ELSE
		   BEGIN
			  IF @CHODEPTID=@CTARGETLOCID
					SET @CTARGETLOCID=''
			  		
			  SET @CSPID=(CASE WHEN @CTARGETLOCID='' THEN LTRIM(RTRIM(STR(@@SPID))) ELSE @CTARGETLOCID END) 
			  
			  PRINT '@CSPID - '+@CSPID
			  
			  SELECT @CHOUSRMSTLASTUPDATE=CONVERT(VARCHAR(20),MAX(LAST_UPDATE)) 
			  FROM 
			  (
			    SELECT MAX(LAST_UPDATE) AS LAST_UPDATE,'' AS ERRMSG FROM USER_ROLE_DET WITH (NOLOCK)
			    UNION
			    SELECT MAX(LAST_UPDATE) AS LAST_UPDATE,'' AS ERRMSG FROM USERS WITH (NOLOCK)
			    UNION
			    SELECT MAX(LAST_UPDATE) AS LAST_UPDATE,'' AS ERRMSG FROM EMPLOYEE WITH (NOLOCK)			
			  ) A

			  IF ISNULL(@CLOCUSRMSTLASTUPDATE,'')=ISNULL(@CHOUSRMSTLASTUPDATE,'')
			     BEGIN
				   SET @CERRORMSG='NO NEW USERS & PERMISSION DATA FOUND FOR THE LOCATION ID :'+@CTARGETLOCID
				   PRINT 'END_PROC'
				   GOTO END_PROC		
			     END	
		   END	
							
		SELECT @CERRORMSG='',@BPROCEED=1,@NMEMONOLEN=10,@CRETCMD='',@CMEMOID='',@CXNTYPE='MSTUSRROLE',@BEMPHEADSUPDATED=0
		
		SET @NSTEP=20
		
		SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
		SELECT @CHODEPTID  = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
				
		IF @CCURDEPTID=@CHODEPTID
			SET @BHOLOC=1
				
		SELECT @NLOCTYPE=LOC_TYPE,@BPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID
		
		SET @NSTEP=30		
								
	
LBLMERGE:

		DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),ERRMSG VARCHAR(MAX),SP_ID /*INT*/VARCHAR(5))  
		
		INSERT @TXNSSENDINFO (ORG_TABLENAME)  
		SELECT 'LOCUSERS'
		UNION 
		SELECT 'USERS'
		UNION 
		SELECT 'USER_ROLE_MST'
		UNION 
		SELECT 'USER_ROLE_DET'
		UNION 
		SELECT 'BINUSERS'
		UNION 
		SELECT 'CONFIG'
		UNION 
		SELECT 'EMPLOYEE'
		UNION 
		SELECT 'EMPCATEGORY'
		UNION 
		SELECT 'BIN'
		UNION
		SELECT 'FIXEDFREEZE'
		UNION
		SELECT 'ROLLINGFREEZE'			
		UNION
		SELECT 'EMPLOYEE_GRP'
		UNION
		SELECT 'EMP_GRP_LINK'
		UNION
		SELECT 'USER_XTREAM_LAYOUT_SETUP'			

		IF @NAPIVERSION>1
			INSERT @TXNSSENDINFO (ORG_TABLENAME)  
			SELECT 'REPLOCS'
			UNION 
			SELECT 'REP_MST'
			UNION 
			SELECT 'REP_DET'
			UNION 
			SELECT 'REP_FILTER'
			UNION 
			SELECT 'REP_FILTER_DET'
			union
			SELECT 'wow_xpert_rep_mst'
			union
			SELECT 'wow_xpert_rep_det'
			union
			SELECT 'wow_xpert_rep_mst_linked_filter'

																
		DECLARE MIRRORMSTUSRCUR CURSOR FOR SELECT ORG_TABLENAME FROM @TXNSSENDINFO
		OPEN MIRRORMSTUSRCUR
		FETCH NEXT FROM MIRRORMSTUSRCUR INTO @CTABLENAME
		WHILE @@FETCH_STATUS=0
		  BEGIN
			SET @NSTEP=35
			
			--01 FEB 2018:START
			--SET @CFILTERCONDITION=' SP_ID='+LTRIM(RTRIM(LTRIM(RTRIM(STR(@NSPID)))))
			SET @CFILTERCONDITION=' SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
			--01 FEB 2018:END
			
			SET @DTSQL=N'DELETE FROM MSTUSRROLE_'+@CTABLENAME+'_UPLOAD WITH (ROWLOCK) WHERE '+@CFILTERCONDITION
			PRINT @DTSQL				
			EXEC SP_EXECUTESQL @DTSQL		
					
			FETCH NEXT FROM MIRRORMSTUSRCUR INTO @CTABLENAME
		  END
		CLOSE MIRRORMSTUSRCUR
		DEALLOCATE MIRRORMSTUSRCUR
		
		--01 FEB 2018:START	--DELETE ONLY
		IF ISNULL(@NMODE,0)=3
		   GOTO END_PROC
		--01 FEB 2018:END	
			
		DECLARE @CTMPLOCUSERSTABLENAME VARCHAR(500),@CTMPUSERTABLENAME VARCHAR(500),@CTMPUSERROLETABLENAME VARCHAR(500),
				@CTMPBINUSERTABLENAME VARCHAR(500)
				
		
		SET @NSTEP=42		
		SET @CTABLENAME='LOCUSERS'
		IF ISNULL(@CTARGETLOCID,'') <> ''
			SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='USER_CODE',@CJOINSTR = ''
			,@CFILTERCONDITION=' DEPT_ID='''+@CTARGETLOCID+'''' 
	    ELSE
	       SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD' ,@CKEYFIELD='USER_CODE',@CJOINSTR = '',@CFILTERCONDITION = ''
	       
	    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID
		
		
		IF ISNULL(@CTARGETLOCID,'')<>''
		BEGIN
		
				IF NOT EXISTS(SELECT TOP 1 'U' FROM LOCUSERS WHERE DEPT_ID=@CTARGETLOCID)
				BEGIN
					SET @CERRORMSG='NO USER ATTACH WITH THIS LOCATION ID :'+@CTARGETLOCID
				   PRINT 'END_PROC'
					GOTO END_PROC	
				END
		END
		
		SET @NSTEP=50		
		SET @CTABLENAME='USERS'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD'
		,@CKEYFIELD='USER_CODE'
		,@CJOINSTR = ' JOIN MSTUSRROLE_LOCUSERS_UPLOAD SRC ON SRC.USER_CODE=B.USER_CODE '
		,@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='' ,@CSOURCETABLE=@CTABLENAME ,@CDESTDB='' ,@CDESTTABLE=@CTEMPTABLENAME
		,@CKEYFIELD1=@CKEYFIELD ,@CKEYFIELD2='' ,@CKEYFIELD3='' ,@LINSERTONLY=1 ,@CFILTERCONDITION=@CFILTERCONDITION
		,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1 ,@BUPDATEXNS=1 ,@CJOINSTR=@CJOINSTR ,@CSEARCHTABLE=@CTABLENAME
		,@CINSSPID=@CSPID
		
		
		SET @NSTEP=60	
		SET @CTABLENAME='USER_ROLE_MST'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='ROLE_ID',
		@CJOINSTR = ' JOIN MSTUSRROLE_USERS_UPLOAD SRC ON SRC.ROLE_ID=B.ROLE_ID ',
		@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID
		
		
		
		SET @NSTEP=70		
		SET @CTABLENAME='USER_ROLE_DET'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='ROLE_ID',
		@CJOINSTR = ' JOIN MSTUSRROLE_USER_ROLE_MST_UPLOAD SRC ON SRC.ROLE_ID=B.ROLE_ID ',
		@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID
		
		
		
		SET @NSTEP=75		
		SET @CTABLENAME='BINUSERS'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='USER_CODE',
		@CJOINSTR = ' JOIN MSTUSRROLE_USERS_UPLOAD SRC ON SRC.USER_CODE=B.USER_CODE',
		@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID

		
		
		SET @NSTEP=80
		SET @CTABLENAME='EMPLOYEE_GRP'
		IF ISNULL(@CTARGETLOCID,'') <> ''
			SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='EMP_GRP_CODE',
			@CJOINSTR = '',@CFILTERCONDITION=' DEPT_ID='''+@CTARGETLOCID+'''' 
		ELSE
		   SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='EMP_GRP_CODE',
		   @CJOINSTR = '',@CFILTERCONDITION = ''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID



		SET @NSTEP=83
		SET @CTABLENAME='EMP_GRP_LINK'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='EMP_GRP_CODE',
		@CJOINSTR = ' JOIN MSTUSRROLE_EMPLOYEE_GRP_UPLOAD SRC ON SRC.EMP_GRP_CODE=B.EMP_GRP_CODE',
		@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID
		


		SET @NSTEP=85		
		INSERT MSTUSRROLE_CONFIG_UPLOAD	( CONFIG_OPTION,  DEPT_ID, LAST_UPDATE, REMARKS, ROW_ID, VALUE, SP_ID )
		SELECT 'MSTUSRROLE_LAST_UPDATE' AS CONFIG_OPTION, '' AS DEPT_ID,GETDATE() AS LAST_UPDATE,
		'' AS REMARKS,NEWID() AS ROW_ID,@CHOUSRMSTLASTUPDATE AS  VALUE,@NSPID AS SP_ID 


		
		SET @NSTEP=130
		SET @CTABLENAME='EMPLOYEE'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='EMP_CODE',
		@CJOINSTR = ' JOIN MSTUSRROLE_EMP_GRP_LINK_UPLOAD SRC ON SRC.EMP_CODE=B.EMP_CODE ',
		@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID
		


		--CATEGORY_CODE
		SET @NSTEP=140		
		SET @CTABLENAME='EMPCATEGORY'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='EMP_CODE',
		@CJOINSTR = ' JOIN MSTUSRROLE_EMPLOYEE_UPLOAD SRC ON SRC.CATEGORY_CODE=B.CATEGORY_CODE',
		@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID
						


		SET @NSTEP=150		
		SET @CTABLENAME='BIN'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='BIN_ID',
		@CJOINSTR = ' JOIN MSTUSRROLE_BINUSERS_UPLOAD SRC ON SRC.BIN_ID=B.BIN_ID',
		@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID
		


		SET @NSTEP=160		
		SET @CTABLENAME='FIXEDFREEZE'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='USER_CODE',
		@CJOINSTR = '',@CFILTERCONDITION=''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID
		


		SET @NSTEP=165		
		UPDATE MSTUSRROLE_FIXEDFREEZE_UPLOAD  WITH (ROWLOCK) SET USER_CODE='0000000'


		SET @NSTEP=170		
		SET @CTABLENAME='ROLLINGFREEZE'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='ROW_ID',
		@CJOINSTR = ' JOIN MSTUSRROLE_USERS_UPLOAD SRC ON SRC.ROLE_ID=B.ROLE_ID ',
		@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID



		SET @NSTEP=175
		SET @CTABLENAME='EMP_GRP_LINK'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='EMP_GRP_CODE',
		@CJOINSTR = ' JOIN MSTUSRROLE_EMPLOYEE_UPLOAD SRC ON SRC.EMP_CODE=B.EMP_CODE ',
		@CFILTERCONDITION='(SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''')'
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='DEPT_ID',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID


		SET @NSTEP=180		
		SET @CTABLENAME='REPLOCS'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD'
		,@CKEYFIELD='USER_CODE',@CJOINSTR = ''
		,@CFILTERCONDITION=' DEPT_ID='''+@CTARGETLOCID+'''' 
		
		IF @CTARGETLOCID=''
			SET @CFILTERCONDITION=''
			
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='' ,@CSOURCETABLE=@CTABLENAME ,@CDESTDB='' ,@CDESTTABLE=@CTEMPTABLENAME
		,@CKEYFIELD1=@CKEYFIELD ,@CKEYFIELD2='' ,@CKEYFIELD3='' ,@LINSERTONLY=1 ,@CFILTERCONDITION=@CFILTERCONDITION
		,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1 ,@BUPDATEXNS=1 ,@CJOINSTR=@CJOINSTR ,@CSEARCHTABLE=@CTABLENAME
		,@CINSSPID=@CSPID

		--changes for xpert reporting filter

		SELECT Rep_id ,sp_id  
		into #tmpREPLOCS_upload
		FROM MSTUSRROLE_REPLOCS_UPLOAD
		where SP_ID=@CSPID
		union 
	    select a.rep_id,@CSPID as Sp_id  
		from Xpert_filter_Mst a (nolock)
		join WOW_Xpert_Rep_Mst_Linked_Filter b (nolock) on a.Filter_id =b.Filter_id 

		SET @NSTEP=190		
		SET @CTABLENAME='REP_MST'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD'
		,@CKEYFIELD='REP_ID'
		,@CJOINSTR = ' JOIN #TMPREPLOCS_UPLOAD SRC ON SRC.REP_ID=B.REP_ID '
		,@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='' ,@CSOURCETABLE=@CTABLENAME ,@CDESTDB='' ,@CDESTTABLE=@CTEMPTABLENAME
		,@CKEYFIELD1=@CKEYFIELD ,@CKEYFIELD2='' ,@CKEYFIELD3='' ,@LINSERTONLY=1 ,@CFILTERCONDITION=@CFILTERCONDITION
		,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1 ,@BUPDATEXNS=1 ,@CJOINSTR=@CJOINSTR ,@CSEARCHTABLE=@CTABLENAME
		,@CINSSPID=@CSPID
		

		UPDATE MSTUSRROLE_REP_MST_UPLOAD SET USER_CODE='0000000' WHERE SP_ID=@CSPID
			
		SET @NSTEP=200		
		SET @CTABLENAME='REP_DET'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD'
		,@CKEYFIELD='REP_ID'
		,@CJOINSTR = ' JOIN MSTUSRROLE_REP_MST_UPLOAD SRC ON SRC.REP_ID=B.REP_ID '
		,@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='' ,@CSOURCETABLE=@CTABLENAME ,@CDESTDB='' ,@CDESTTABLE=@CTEMPTABLENAME
		,@CKEYFIELD1=@CKEYFIELD ,@CKEYFIELD2='' ,@CKEYFIELD3='' ,@LINSERTONLY=1 ,@CFILTERCONDITION=@CFILTERCONDITION
		,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1 ,@BUPDATEXNS=1 ,@CJOINSTR=@CJOINSTR ,@CSEARCHTABLE=@CTABLENAME
		,@CINSSPID=@CSPID

		SET @NSTEP=205		
		SET @CTABLENAME='REP_FILTER'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD'
		,@CKEYFIELD='REP_ID'
		,@CJOINSTR = ' JOIN MSTUSRROLE_REP_MST_UPLOAD SRC ON SRC.REP_ID=B.REP_ID '
		,@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='' ,@CSOURCETABLE=@CTABLENAME ,@CDESTDB='' ,@CDESTTABLE=@CTEMPTABLENAME
		,@CKEYFIELD1=@CKEYFIELD ,@CKEYFIELD2='' ,@CKEYFIELD3='' ,@LINSERTONLY=1 ,@CFILTERCONDITION=@CFILTERCONDITION
		,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1 ,@BUPDATEXNS=1 ,@CJOINSTR=@CJOINSTR ,@CSEARCHTABLE=@CTABLENAME
		,@CINSSPID=@CSPID

		SET @NSTEP=210		
		SET @CTABLENAME='REP_FILTER_DET'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD'
		,@CKEYFIELD='REP_ID'
		,@CJOINSTR = ' JOIN MSTUSRROLE_REP_MST_UPLOAD SRC ON SRC.REP_ID=B.REP_ID '
		,@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='' ,@CSOURCETABLE=@CTABLENAME ,@CDESTDB='' ,@CDESTTABLE=@CTEMPTABLENAME
		,@CKEYFIELD1=@CKEYFIELD ,@CKEYFIELD2='' ,@CKEYFIELD3='' ,@LINSERTONLY=1 ,@CFILTERCONDITION=@CFILTERCONDITION
		,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1 ,@BUPDATEXNS=1 ,@CJOINSTR=@CJOINSTR ,@CSEARCHTABLE=@CTABLENAME
		,@CINSSPID=@CSPID


		--new table Introduce for Wow reporting

		SET @NSTEP=212		
		SET @CTABLENAME='wow_xpert_rep_mst'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD'
		,@CKEYFIELD='REP_ID'
		,@CJOINSTR = ' JOIN MSTUSRROLE_REPLOCS_UPLOAD SRC ON SRC.REP_ID=B.REP_ID '
		,@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='' ,@CSOURCETABLE=@CTABLENAME ,@CDESTDB='' ,@CDESTTABLE=@CTEMPTABLENAME
		,@CKEYFIELD1=@CKEYFIELD ,@CKEYFIELD2='' ,@CKEYFIELD3='' ,@LINSERTONLY=1 ,@CFILTERCONDITION=@CFILTERCONDITION
		,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1 ,@BUPDATEXNS=1 ,@CJOINSTR=@CJOINSTR ,@CSEARCHTABLE=@CTABLENAME
		,@CINSSPID=@CSPID


		SET @NSTEP=214		
		SET @CTABLENAME='wow_xpert_rep_det'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD'
		,@CKEYFIELD='REP_ID'
		,@CJOINSTR = ' JOIN MSTUSRROLE_wow_xpert_rep_mst_UPLOAD SRC ON SRC.REP_ID=B.REP_ID '
		,@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='' ,@CSOURCETABLE=@CTABLENAME ,@CDESTDB='' ,@CDESTTABLE=@CTEMPTABLENAME
		,@CKEYFIELD1=@CKEYFIELD ,@CKEYFIELD2='' ,@CKEYFIELD3='' ,@LINSERTONLY=1 ,@CFILTERCONDITION=@CFILTERCONDITION
		,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1 ,@BUPDATEXNS=1 ,@CJOINSTR=@CJOINSTR ,@CSEARCHTABLE=@CTABLENAME
		,@CINSSPID=@CSPID


		SET @NSTEP=216		
		SET @CTABLENAME='wow_xpert_rep_mst_linked_filter'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD'
		,@CKEYFIELD='REP_ID'
		,@CJOINSTR = ' JOIN MSTUSRROLE_wow_xpert_rep_mst_UPLOAD SRC ON SRC.REP_ID=B.REP_ID '
		,@CFILTERCONDITION=' SRC.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='' ,@CSOURCETABLE=@CTABLENAME ,@CDESTDB='' ,@CDESTTABLE=@CTEMPTABLENAME
		,@CKEYFIELD1=@CKEYFIELD ,@CKEYFIELD2='' ,@CKEYFIELD3='' ,@LINSERTONLY=1 ,@CFILTERCONDITION=@CFILTERCONDITION
		,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1 ,@BUPDATEXNS=1 ,@CJOINSTR=@CJOINSTR ,@CSEARCHTABLE=@CTABLENAME
		,@CINSSPID=@CSPID



		--end New report Tables 
		
		
		
		SET @NSTEP=220		
		SET @CTABLENAME='USER_XTREAM_LAYOUT_SETUP'
		SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='ROLE_ID',
		@CJOINSTR = ' ',
		@CFILTERCONDITION=''
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
		,@CDESTTABLE=@CTEMPTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
		,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
		,@BALWAYSUPDATE=1,@BUPDATEXNS=1,@CJOINSTR=@CJOINSTR,@CSEARCHTABLE=@CTABLENAME,@CINSSPID=@CSPID
																
		GOTO END_PROC
		
	END TRY

	BEGIN CATCH
		PRINT 'UNTRAPPED ERROR'		
		SELECT @CERRORMSG='PROCEDURE SP_SEND_MIRROR_MSTUSR_NEW : STEP: '+STR(@NSTEP)+' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		GOTO END_PROC
	END CATCH

END_PROC:

	IF ISNULL(@CERRORMSG,'')<>''
		SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
	ELSE
	BEGIN
		UPDATE @TXNSSENDINFO SET ORG_TABLENAME='MSTUSRROLE_'+ORG_TABLENAME+'_MIRROR',
		TMP_TABLENAME='MSTUSRROLE_'+ORG_TABLENAME+'_UPLOAD',SP_ID=@CSPID
		
		SELECT *,1 AS PICK_FROM_CURRENT_DB FROM @TXNSSENDINFO	
	END
END
--- 'END OF CREATING PROCEDURE SP_SEND_MIRROR_MSTUSR_NEW
