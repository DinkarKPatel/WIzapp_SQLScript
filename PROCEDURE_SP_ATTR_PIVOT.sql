CREATE PROCEDURE SP_ATTR_PIVOT(@ARTICLE_CODE VARCHAR(1000))
AS
BEGIN
	SET NOCOUNT ON
	DECLARE @COL VARCHAR(MAX)
	IF OBJECT_ID('TEMPDB..#A') IS NOT NULL
	   DROP TABLE #A
	SELECT A.ARTICLE_CODE,M.ATTRIBUTE_NAME,K.KEY_NAME [KEY_VAL]
	INTO #A
	FROM ART_ATTR A (NOLOCK)
	JOIN ATTRM M (NOLOCK) JOIN ATTR_KEY K (NOLOCK) ON M.ATTRIBUTE_CODE=K.ATTRIBUTE_CODE 
	ON A.ATTRIBUTE_CODE=M.ATTRIBUTE_CODE AND A.KEY_CODE=K.KEY_CODE
	WHERE M.INACTIVE=0 AND K.INACTIVE=0 AND M.ATTRIBUTE_TYPE=1
	UNION
	SELECT A.ARTICLE_CODE,M.ATTRIBUTE_NAME+'_ALIAS',K.KEY_ALIAS
	FROM ART_ATTR A (NOLOCK)
	JOIN ATTRM M (NOLOCK) JOIN ATTR_KEY K (NOLOCK) ON M.ATTRIBUTE_CODE=K.ATTRIBUTE_CODE 
	ON A.ATTRIBUTE_CODE=M.ATTRIBUTE_CODE AND A.KEY_CODE=K.KEY_CODE
	WHERE M.INACTIVE=0 AND K.INACTIVE=0 AND M.ATTRIBUTE_TYPE=1

	SELECT @COL=COALESCE(@COL,'')+'['+ATTRIBUTE_NAME+'],' FROM (SELECT DISTINCT ATTRIBUTE_NAME FROM #A)A

	IF ISNULL(@COL,'')<>'' SET @COL=LEFT(@COL,LEN(@COL)-1)

	SET @COL='SELECT [ARTICLE_CODE],'+@COL+' FROM (SELECT * FROM #A WHERE ARTICLE_CODE='''+LTRIM(RTRIM(@ARTICLE_CODE))+''') A 
	PIVOT (MAX (KEY_VAL) FOR ATTRIBUTE_NAME IN ('+@COL+'))PVT'
	EXEC(@COL)
	SET NOCOUNT OFF
END
