CREATE PROCEDURE SP3S_MIRROR_GENTEMPTABLES
@CORGTABLENAME VARCHAR(500)='',
@CTMPTABLENAME  VARCHAR(1000)='',
@CTABLENAMEPARA VARCHAR(500)=''
AS
BEGIN
	
	DECLARE @CCMD NVARCHAR(MAX),@CTEMPDB VARCHAR(1000),@CSTRUEXPR NVARCHAR(MAX),@CTMPTABLE VARCHAR(1000),
	@CSTEP VARCHAR(5),@CERRMSG VARCHAR(MAX)
	
BEGIN TRY
	
	SET @CSTEP=10
	
	IF @CORGTABLENAME='pmt01106'
		set @CORGTABLENAME='pmtlocs'
		
	SET @CTEMPDB=DB_NAME()+'_TEMP.DBO.'
		
	IF OBJECT_ID('TEMPDB..#TMPSTRUINFO','U') IS NOT NULL
		DROP TABLE #TMPSTRUINFO
	
	SELECT TABLE_NAME AS ORG_TABLENAME,TABLE_NAME AS TMP_TABLENAME
	INTO #TMPSTRUINFO FROM TABLESTRUINFO WHERE 1=2

	SET @CSTEP=20	
	IF @CTABLENAMEPARA<>''
		SET @CCMD=N'SELECT ORG_TABLENAME,TMP_TABLENAME FROM '+@CTEMPDB+@CTABLENAMEPARA	
	ELSE
		SET @CCMD=N'SELECT '''+@CORGTABLENAME+''' AS ORG_TABLENAME,'''+@CTMPTABLENAME+''' AS TMP_TABLENAME'
			
	INSERT 	#TMPSTRUINFO
	EXEC SP_EXECUTESQL @CCMD		
	
	SET @CSTEP=30
	IF CURSOR_STATUS('GLOBAL','TEMPTABLESTRUCUR') IN (0,1)	
	BEGIN
		CLOSE TEMPTABLESTRUCUR
		DEALLOCATE TEMPTABLESTRUCUR
	END
	
	
	SET @CSTEP=40
	DECLARE TEMPTABLESTRUCUR CURSOR FOR SELECT 	ORG_TABLENAME,TMP_TABLENAME FROM #TMPSTRUINFO
	OPEN TEMPTABLESTRUCUR
	
	FETCH NEXT FROM TEMPTABLESTRUCUR INTO @CORGTABLENAME,@CTMPTABLENAME
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @CSTEP=50
		SET @CTMPTABLE=@CTEMPDB+'['+@CTMPTABLENAME+']'
		
		PRINT 'DROP TABLE '+@CTMPTABLE
		
		IF OBJECT_ID(@CTMPTABLE,'U') IS NOT NULL
		BEGIN
			SET @CSTEP=55
			PRINT 'DROP TABLE '
			SET @CCMD=N'DROP TABLE '+@CTMPTABLE
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
		END	
		
		SET @CSTEP=60
		
		SELECT @CSTRUEXPR=REPLACE(STRUEXPR,'TABLE ['+@CORGTABLENAME+']','TABLE '+@CTEMPDB+'['+@CTMPTABLENAME+']')
		FROM TABLESTRUINFO (NOLOCK) WHERE TABLE_NAME=@CORGTABLENAME
		
		PRINT @CSTRUEXPR
		EXEC SP_EXECUTESQL @CSTRUEXPR
		
		FETCH NEXT FROM TEMPTABLESTRUCUR INTO @CORGTABLENAME,@CTMPTABLENAME
	END
	
	SET @CSTEP=70
	CLOSE TEMPTABLESTRUCUR
	DEALLOCATE TEMPTABLESTRUCUR 

END TRY

BEGIN CATCH
	SET @CERRMSG='P: SP3S_MIRROR_GENTEMPTABLES, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH				

END_PROC:

	SELECT ISNULL(@CERRMSG,'') AS ERRMSG
END
---------- END OF CREATING PROCEDURE SP3S_MIRROR_GENTEMPTABLES
