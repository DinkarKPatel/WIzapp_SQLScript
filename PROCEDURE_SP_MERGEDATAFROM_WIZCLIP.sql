CREATE PROCEDURE SP_MERGEDATAFROM_WIZCLIP
(
    @CLOCID VARCHAR(4),
    @NSP_ID INT
)
--WITH ENCRYPTION
AS
SET NOCOUNT ON
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 	

DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX)
	   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
	   ,@CFILTERCONDITION VARCHAR(200),@CFILTERCONDITION2 VARCHAR(500),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	   ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(MAX),@CMIRRORINGENABLED VARCHAR(5)
	   ,@CCURDEPTID VARCHAR(5),@CTEMPMASTERTABLE VARCHAR(200),@CTEMPDETAILTABLE VARCHAR(200)
	   ,@CTEMPPAYMODETABLE VARCHAR(200),@CTEMPTABLE VARCHAR(100),@CDONOTRESETPOSTEDINAC VARCHAR(1)
	   ,@CSOURCEDB VARCHAR(200),@CMERGEDB VARCHAR(200),@BMSTINSERTONLY BIT, @CERRMSG VARCHAR(1000)
	
BEGIN TRY
	
	
	SET @CSTEP=10

	SELECT @CSOURCEDB='',@CMERGEDB='',@BMSTINSERTONLY=1
	
	SET @CSTEP=15
    
	SELECT @CTEMPMASTERTABLE=@CSOURCEDB+'SLS_CMM01106_UPLOAD',
		   @CTEMPDETAILTABLE=@CSOURCEDB+'SLS_CMD01106_UPLOAD',
		   @CTEMPPAYMODETABLE=@CSOURCEDB+'SLS_PAYMODE_XN_DET_UPLOAD'


LBLSTART:

	BEGIN TRANSACTION 	     
	    
LBLMERGE:
	---DELETING EXISTING RECORD IF BILL COMES AGAIN FOR MERGING
	
	--SELECT @CTEMPMASTERTABLE,@CFILTERCONDITION

	SET @CFILTERCONDITION=''
	
	
	SET @DTSQL = N'DELETE A FROM SLS_CMM01106_UPLOAD A
	               LEFT OUTER JOIN
	               (
	               SELECT A.CM_ID,A.SP_ID FROM SLS_CMM01106_UPLOAD A
	               JOIN CMD01106 B ON A.CM_ID=B.CM_ID 
	               WHERE B.MRP<>B.OLD_MRP AND A.SP_ID='''+RTRIM(LTRIM(STR(@NSP_ID)))+'''
	               ) B ON A.CM_ID=B.CM_ID AND A.SP_ID=B.SP_ID 
	               WHERE A.SP_ID='''+RTRIM(LTRIM(STR(@NSP_ID)))+''' AND B.CM_ID IS NULL'
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	
	SET @DTSQL = N'DELETE A FROM SLS_CMD01106_UPLOAD A
	               LEFT OUTER JOIN 
	               (
	               SELECT A.CM_ID,A.SP_ID FROM SLS_CMM01106_UPLOAD A
	               WHERE  A.SP_ID='''+RTRIM(LTRIM(STR(@NSP_ID)))+'''
	               ) B ON A.CM_ID=B.CM_ID AND A.SP_ID=B.SP_ID 
	               WHERE A.SP_ID='''+RTRIM(LTRIM(STR(@NSP_ID)))+''' AND B.CM_ID IS NULL'
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	
	SET @DTSQL = N'DELETE A FROM SLS_PAYMODE_XN_DET_UPLOAD A
	               LEFT OUTER JOIN 
	               (
	               SELECT A.CM_ID,A.SP_ID FROM SLS_CMM01106_UPLOAD A
	               WHERE  A.SP_ID='''+RTRIM(LTRIM(STR(@NSP_ID)))+'''
	               ) B ON A.MEMO_ID=B.CM_ID AND A.SP_ID=B.SP_ID 
	               WHERE A.SP_ID='''+RTRIM(LTRIM(STR(@NSP_ID)))+''' AND B.CM_ID IS NULL'
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	
	
	SET @CFILTERCONDITION='B.SP_ID='''+RTRIM(LTRIM(STR(@NSP_ID)))+''''	
	
	SET @CSTEP=115
		SET @DTSQL=N'DELETE A FROM PAYMODE_XN_DET A JOIN '+@CTEMPMASTERTABLE+' B (NOLOCK) ON A.MEMO_ID=B.CM_ID
					 WHERE '+@CFILTERCONDITION+' AND XN_TYPE=''SLS'''
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL
		
		SET @CSTEP=130
		SET @DTSQL=N'DELETE A FROM CMD01106  A
					 JOIN '+@CTEMPMASTERTABLE+' B (NOLOCK) ON A.CM_ID=B.CM_ID		 
					 LEFT OUTER JOIN
					 (SELECT ROW_ID FROM '+@CTEMPDETAILTABLE+' B WHERE '+@CFILTERCONDITION+') C ON A.ROW_ID=C.ROW_ID
					 WHERE '+@CFILTERCONDITION+' ' 
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL
	
	
	---UPDATING TRANSACTION TABLES
	
	SET @CSTEP=250
	SET @CTABLENAME='CMM01106'
	SET @CTMP_TABLENAME='SLS_CMM01106_UPLOAD'
	SET @CKEYFIELD='CM_ID'
	
	SET @CFILTERCONDITION='B.SP_ID='''+RTRIM(LTRIM(STR(@NSP_ID)))+''''
	
	
	SET @DTSQL = N'UPDATE A SET CM_DT = CONVERT(DATETIME,CONVERT(VARCHAR(10),CM_DT,120)),
				   SHIFT_ID=(CASE WHEN SHIFT_ID='''' THEN NULL ELSE SHIFT_ID END),
				   CUSTOMER_CODE=ISNULL(B.CUSTOMER_CODE,''000000000000'') FROM '+@CTEMPMASTERTABLE+' A WITH (ROWLOCK) 
				   LEFT OUTER JOIN CUSTDYM B (NOLOCK) ON A.CUSTOMER_CODE=B.CUSTOMER_CODE WHERE A.SP_ID='''+RTRIM(LTRIM(STR(@NSP_ID)))+''''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	
	SET @CSTEP=260
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=@LUPDATEONLY
							  ,@BALWAYSUPDATE=1,@BUPDATEXNS=1 
							  
	SET @CTABLENAME='CMD01106'
	SET @CTMP_TABLENAME='SLS_CMD01106_UPLOAD'
	SET @CKEYFIELD='ROW_ID'
	 
	SET @CSTEP=270
	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@BUPDATEXNS=1 


	SET @CSTEP=275
	SET @CTABLENAME='PAYMODE_XN_DET'
	SET @CTMP_TABLENAME='SLS_PAYMODE_XN_DET_UPLOAD'
	SET @CKEYFIELD='MEMO_ID'
	
	SET @CFILTERCONDITION2=' B.SP_ID='''+RTRIM(LTRIM(STR(@NSP_ID)))+''' AND B.XN_TYPE=''SLS'''
	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='XN_TYPE',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION2,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=0,@BUPDATEXNS=1


	 
	 SELECT TOP 1 @CERRMSG=A.CM_ID+'MISMATCH BETWEEN BILL MASTER SUBTOTAL :'+
	 LTRIM(RTRIM(STR((ISNULL(A.SUBTOTAL,0)+ISNULL(A.SUBTOTAL_R,0)),10,2)))+' & DETAIL '+LTRIM(RTRIM(STR(ISNULL(B.NET,0),10,2))) 
	 FROM CMM01106  A (NOLOCK)
	 LEFT OUTER JOIN
	 (SELECT A.CM_ID,SUM(NET) AS NET FROM CMD01106 A (NOLOCK)
	  JOIN SLS_CMM01106_UPLOAD UP ON A.CM_ID =UP.CM_ID 
	  WHERE UP.SP_ID =@NSP_ID 
	  GROUP BY A.CM_ID
	 ) B ON A.CM_ID=B.CM_ID
	 JOIN SLS_CMM01106_UPLOAD UP ON A.CM_ID =UP.CM_ID 
	 WHERE  UP.SP_ID =@NSP_ID  AND ABS((ISNULL(A.SUBTOTAL,0)+ISNULL(A.SUBTOTAL_R,0))-ISNULL(B.NET,0))>1
	 
	 IF ISNULL(@CERRMSG,'')=''
	 BEGIN
	 SELECT TOP 1 @CERRMSG=A.CM_ID+ ' NET AMOUNT :'+LTRIM(RTRIM(STR(A.NET_AMOUNT,14,2)))+' SHOULD BE EQUAL TO THE SUM OF ALL PAYMENT MODES :'+LTRIM(RTRIM(STR(ISNULL(B.AMOUNT,0),14,2)))
	 FROM CMM01106 A (NOLOCK)
	 LEFT OUTER JOIN
	 (SELECT A.MEMO_ID,SUM(AMOUNT) AS AMOUNT FROM  PAYMODE_XN_DET A 
	 JOIN SLS_CMM01106_UPLOAD UP ON A.MEMO_ID  =UP.CM_ID 
	  WHERE UP.SP_ID =@NSP_ID  AND XN_TYPE='SLS' GROUP BY A.MEMO_ID) B ON A.CM_ID=B.MEMO_ID
	  JOIN SLS_CMM01106_UPLOAD UP ON A.CM_ID =UP.CM_ID  
	 WHERE UP.SP_ID =@NSP_ID  AND  A.NET_AMOUNT<>ISNULL(B.AMOUNT,0) 		
     END
	
    
    IF ISNULL(@CERRMSG,'')=''
    BEGIN 
		SET @CSTEP=390
	    		
		DELETE A FROM SLS_PAYMODE_XN_DET_UPLOAD A WHERE SP_ID=@NSP_ID 
		
		DELETE A FROM SLS_CMD01106_UPLOAD A WHERE SP_ID=@NSP_ID 
		
        DELETE A FROM SLS_CMM01106_UPLOAD A WHERE SP_ID=@NSP_ID 
	END
		

		
END TRY

BEGIN CATCH
	SET @CERRMSG='P:SP_MERGEDATAFROM_WIZCLIP, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO EXIT_PROC
END CATCH

EXIT_PROC:

	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')='' 
			COMMIT
		ELSE
			ROLLBACK
    END
	
   SELECT @CERRMSG AS ERRMSG
	
END	
---END OF PROCEDURE - SP_MERGEDATAFROM_WIZCLIP
