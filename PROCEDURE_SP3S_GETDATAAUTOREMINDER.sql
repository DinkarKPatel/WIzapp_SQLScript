CREATE PROC SP3S_GETDATAAUTOREMINDER
(
 @IMONTH NUMERIC(10,0),
 @IDAYS NUMERIC(10,0),
 @CFINYEAR VARCHAR(10)
)
AS BEGIN
SELECT * FROM
(
	SELECT A.*,'' AS SMS_DET,'' AS EMAIL_BODY,'' AS EMAIL_SUB,B.AC_NAME,B.MOBILE,B.E_MAIL,
	(CASE WHEN ISNULL(B.BILL_BY_BILL,0)=1 THEN  D.DUE_BAL ELSE D.LEDGER_BAL END ) AS DUE_BAL,D.LEDGER_BAL,
	B.CITY,B.STATE
	FROM DR_AUTO_REMINDER  A (NOLOCK)
	LEFT JOIN  
		(   
		 SELECT  D.AC_CODE  
			  ,SUM(CASE WHEN C.X_TYPE='CR' THEN -AMOUNT ELSE AMOUNT END) AS DUE_BAL,
			  DBO.FN_ACT_OPENING_NEW ( D.AC_CODE, '', D.STMT_CUT_OFF_DT, @CFINYEAR, '01' )  AS LEDGER_BAL
			  
		 FROM VM01106 A(NOLOCK)  
		 JOIN VD01106 B(NOLOCK) ON B.VM_ID = A.VM_ID  
		 LEFT OUTER JOIN BILL_BY_BILL_REF  C(NOLOCK) ON C.VD_ID=B.VD_ID  
		 JOIN 
		 (SELECT AC_CODE,STMT_CUT_OFF_DT FROM DR_AUTO_REMINDER D 
		  WHERE ISNULL(T_ID,'') <> ''  AND ISNULL(PROCESSED,0) = 0 AND ISNULL(DISABLE_AUTO_REMINDER,0) = 0 
			AND MONTH(AR_DT)= @IMONTH AND DAY(AR_DT)= @IDAYS  AND (SEND_MAIL=1 OR SEND_SMS=1)
		  UNION 
		  SELECT lm.AC_CODE,STMT_CUT_OFF_DT FROM lm01106 lm 
		  JOIN DR_AUTO_REMINDER D ON d.AC_CODE=lm.major_ac_code
		  WHERE ISNULL(T_ID,'') <> ''  AND ISNULL(PROCESSED,0) = 0 AND ISNULL(DISABLE_AUTO_REMINDER,0) = 0 
			AND MONTH(AR_DT)= @IMONTH AND DAY(AR_DT)= @IDAYS  AND (SEND_MAIL=1 OR SEND_SMS=1)
		 ) d ON d.AC_CODE=b.AC_CODE		

		 WHERE A.CANCELLED = 0   
		-- AND A.VOUCHER_DT+C.CR_DAYS <= CONVERT(VARCHAR, D.STMT_CUT_OFF_DT,121)
		 AND A.VOUCHER_DT+ ISNULL(C.CR_DAYS,0) <= D.STMT_CUT_OFF_DT  		    
		 GROUP BY D.AC_CODE ,   D.STMT_CUT_OFF_DT 	       
		)D ON D.AC_CODE = A.AC_CODE  

	JOIN LMV01106 B ON A.AC_CODE= B.AC_CODE 
	WHERE ISNULL(DISABLE_AUTO_REMINDER,0) = 0 AND ISNULL(PROCESSED,0) = 0 AND MONTH(AR_DT)= @IMONTH 
	AND DAY(AR_DT)= @IDAYS  AND (SEND_MAIL=1 OR SEND_SMS=1)
) A WHERE DUE_BAL >0 OR LEDGER_BAL >0


END
