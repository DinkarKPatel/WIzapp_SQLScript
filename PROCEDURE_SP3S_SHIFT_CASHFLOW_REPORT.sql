CREATE PROCEDURE SP3S_SHIFT_CASHFLOW_REPORT
(
	 @CSHIFT_ID VARCHAR(15)
	,@BSHOW_DENOMINATION BIT=0 
	,@BCRISSUE BIT=0
	,@BOSRCT BIT=0
	,@BCRNOTE BIT=0
	,@BCRNOTEADJSLS BIT=0
	,@BCRNOTEADJRCT BIT=0
	,@BADVADJPYT BIT=0
	,@BADVADJSLS BIT=0
	,@BADVRCT BIT=0
	,@BDOCRCV BIT=0
	,@BOC BIT=0
	,@BCRREFUND BIT=0
	,@BCASHREF  BIT=0
	,@BPAYMENT  BIT=0
	,@BDCARD    BIT=0
	,@CDEPTID Varchar(10)=''
)
--WITH ENCRYPTION
AS
BEGIN
SET NOCOUNT ON 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
/*
DIFFERENT METHODS OF CASH FLOW.
	CREDIT ISSUE						: @BCRISSUE
	OUTSTANDING RECEIPT					: @BOSRCT
	CREDIT NOTES						: @BCRNOTE
	CREDIT NOTES ADJUSTED IN SALE		: @BCRNOTEADJSLS
	CREDIT NOTES ADJUSTED IN RECEIPT	: @BCRNOTEADJRCT
	LIST OF ALL PAYMENTS				: @BADVADJPYT
	ADVANCE ADJUSTED IN SALE			: @BADVADJSLS
	ADVANCES IN RECEIPT					: @BADVRCT
	DOCUMENT RECEIVED					: @BDOCRCV
	LIST OF OTHER CHARGES				: @BOC
	LIST OF CASHREFUND					: @BCASHREF
	LIST OF PAYMENTS                    : @BPAYMENT
	LIST OF DISCOUNT CARD ISSUE/RENEWAL : @BDCARD

EXEC SP3S_SHIFT_CASHFLOW_REPORT	
			 @CSHIFT_ID='00-20150605-002'
			,@BSHOW_DENOMINATION=1 
			,@BCRISSUE=1
			,@BOSRCT=1
			,@BCRNOTE=1
			,@BCRNOTEADJSLS=1
			,@BCRNOTEADJRCT=1
			,@BADVADJPYT=1
			,@BADVADJSLS=1
			,@BADVRCT=1
			,@BDOCRCV=1
			,@BOC=1
			,@BCRREFUND=1
			,@BCASHREF=1
			,@BPAYMENT=1
			,@BDCARD=1
*/
	DECLARE @NLIFT_AMOUNT NUMERIC(18,2)
	DECLARE @BDSM BIT
	SELECT TOP 1 @BDSM=VALUE FROM CONFIG WHERE CONFIG_OPTION='OPEN_CASHIER_FOR_CASHMEMOS'
		
	SET @BDSM=ISNULL(@BDSM,0)	
	
	SELECT @NLIFT_AMOUNT=SUM(LIFT_AMOUNT)
	FROM TILL_LIFTS 
	WHERE CANCELLED=0 AND SHIFT_ID=@CSHIFT_ID

	SET @NLIFT_AMOUNT=ISNULL(@NLIFT_AMOUNT,0)

	IF OBJECT_ID('#SLS_REPORT','U') IS NOT NULL
		DROP TABLE #SLS_REPORT
		
	CREATE TABLE #SLS_REPORT (DEPT_ID VARCHAR(10),DEPT_NAME VARCHAR(100),CM_DT DATETIME,CANCELLED BIT
							 ,PAYMODE_GRP_NAME VARCHAR(100),PAYMODE_NAME VARCHAR(100), TRAN_TYPE VARCHAR(100)
							 ,AMOUNT NUMERIC(14,2),USER_CODE VARCHAR(7),BIN_ID VARCHAR(7),IS_ISSUE BIT)

	---RETURNING DATA FOR FIRST CURSOR THAT DISPLAYS SUMMARY OF THE SHIFT.
	SELECT LCT.DEPT_ID+'-'+LCT.DEPT_NAME AS LOCATION
		  ,USR.USERNAME AS CASHIER
		  ,TM.TILL_NAME AS TILL
		  ,TSM.SHIFT_ID
		  ,(CASE WHEN ISNULL(TSM.CLOSE_DATE,'')='' THEN 'OPEN' ELSE 'CLOSED' END) AS [STATUS]
		  ,CONVERT(VARCHAR,TSM.OPEN_DATE,105)+' '+CONVERT(VARCHAR(5),TSM.OPEN_TIME,114) AS OPENED_AT
		  ,(CASE WHEN CONVERT(VARCHAR,TSM.CLOSE_DATE,105)='01-01-1900' THEN '' ELSE CONVERT(VARCHAR,TSM.CLOSE_DATE,105) END)
		  +' '+(CASE WHEN CONVERT(VARCHAR,TSM.CLOSE_DATE,105)='01-01-1900' THEN '' ELSE CONVERT(VARCHAR(5),TSM.CLOSE_TIME,114) END)
		   AS CLOSED_AT
		   --CASE ADDED IN HOUR AND MIN TO PREFIX 0 WHEN THE LEN IS FOUND TO BE 1
		  ,(CASE WHEN 
		   LEN(
				CONVERT(VARCHAR(10),(DATEDIFF(MI,(TSM.OPEN_TIME),(CASE WHEN ISNULL(TSM.CLOSE_DATE,'')='' THEN GETDATE() 
				ELSE TSM.CLOSE_TIME END)))/60)
			  )=1 THEN '0'+CONVERT(VARCHAR(10),(DATEDIFF(MI,TSM.OPEN_TIME,(CASE WHEN ISNULL(TSM.CLOSE_DATE,'')='' 
				  THEN GETDATE() ELSE TSM.CLOSE_TIME END)))/60)
			  ELSE 
				CONVERT(VARCHAR(10),(DATEDIFF(MI,TSM.OPEN_TIME,(CASE WHEN ISNULL(TSM.CLOSE_DATE,'')='' THEN GETDATE() 
				ELSE TSM.CLOSE_TIME END)))/60)
				END)	 		
		   +':'
		   +(CASE WHEN 
		   LEN(
				CONVERT(VARCHAR(10),(DATEDIFF(MI,TSM.OPEN_TIME,(CASE WHEN ISNULL(TSM.CLOSE_DATE,'')='' THEN GETDATE() 
				ELSE TSM.CLOSE_TIME END)))%60)
			  )=1 THEN '0'+CONVERT(VARCHAR(10),(DATEDIFF(MI,TSM.OPEN_TIME,(CASE WHEN ISNULL(TSM.CLOSE_DATE,'')='' THEN GETDATE() 
				ELSE TSM.CLOSE_TIME END)))%60)
			  ELSE 
				CONVERT(VARCHAR(10),(DATEDIFF(MI,TSM.OPEN_TIME,(CASE WHEN ISNULL(TSM.CLOSE_DATE,'')='' THEN GETDATE() 
				ELSE TSM.CLOSE_TIME END)))%60)
				END)	 		
		   AS [HOURS] 
		  ,TSM.COMP_OP AS COMPUTER_OPENING
		  ,TSM.PHY_OP AS PHYSICAL_OPENING
		  ,CONVERT(NUMERIC(18,2),(TSM.COMP_OP-TSM.PHY_OP)) AS OPENING_DIFF
		  ,TSM.RECEIPTS AS COMPUTER_RECEIPTS 
		  ,(TSM.ISSUES-@NLIFT_AMOUNT) AS COMPUTER_ISSUES
		  /*LIFT AMOUNT IS ALREADY ADDED TO THE ISSUES, SO LIFT AMOUNT NEEDS TO BE SUBSTRACTED IF THE LIFT COMPONENT 
			IS SHOWN SEPARATELY.*/
		  ,@NLIFT_AMOUNT AS LIFT
		  ,TSM.COMP_CL AS COMPUTER_CLOSING
		  ,TSM.PHY_CL AS PHYSICAL_CLOSING
		  ,CONVERT(NUMERIC(18,2),(TSM.COMP_CL-TSM.PHY_CL)) AS CLOSING_DIFF
	FROM DBO.TILL_SHIFT_MST TSM
	JOIN DBO.LOCATION LCT ON TSM.LOCATION_CODE=LCT.DEPT_ID
	JOIN DBO.USERS USR ON TSM.USER_CODE=USR.USER_CODE
	JOIN DBO.TILL_MST TM ON TSM.TILL_ID=TM.TILL_ID
	WHERE SHIFT_ID=@CSHIFT_ID

	---SECOND CURSOR FOR DENOMINATION WISE BREAK UP FOR THE SHIFT
	SELECT SHIFT_ID,DENO_NAME,QUANTITY,AMOUNT 
	FROM TILL_SHIFT_DET
	WHERE SHIFT_ID=@CSHIFT_ID AND QUANTITY<>0
	AND @BSHOW_DENOMINATION=1 /*DENOMINATION SHOUD BE SHOW ONLY WHEN REQUESTED ELSE RETURN BLANK CURSOR*/
	ORDER BY DENO_NAME DESC

	--PREPARING CURSOR FOR ISSUE/RECEIPTS DETAILS TRANSACTION WISE
	INSERT #SLS_REPORT( DEPT_ID, DEPT_NAME, CM_DT, CANCELLED, PAYMODE_GRP_NAME, PAYMODE_NAME, TRAN_TYPE, AMOUNT
					  , USER_CODE, BIN_ID, IS_ISSUE )
	---LIST OF CASH MEMOS EXCEPT CREDIT NOTE ISSUE AND CREDIT REFUND BILLS
	SELECT LO.DEPT_ID,LO.DEPT_NAME,CM.CM_DT,CM.CANCELLED,PGM.PAYMODE_GRP_NAME
		  ,PM.PAYMODE_NAME,'SALE' AS TRAN_TYPE
		  ,SUM(CASE WHEN (PXD.PAYMODE_CODE='0000004' AND PXD.AMOUNT>0) OR PXD.PAYMODE_CODE<>'0000004' 
		   THEN  PXD.AMOUNT ELSE 0 END) AS AMOUNT
	,CM.USER_CODE,CM.BIN_ID 
	,0 AS IS_ISSUE
	FROM CMM01106 CM (NOLOCK)
	LEFT JOIN 
	(
		SELECT DISTINCT DSD.CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0 AND DSM.SHIFT_ID=@CSHIFT_ID
	)DSD ON CM.CM_ID=DSD.CM_ID
	LEFT JOIN 
	(
		SELECT DISTINCT A.CM_ID 
		FROM  CMM01106  A (NOLOCK) 
		JOIN VW_BILL_PAYMODE PAY (NOLOCK) ON PAY.MEMO_ID=A.CM_ID AND PAY.XN_TYPE='SLS'
		WHERE A.SHIFT_ID=@CSHIFT_ID
		AND (A.NET_AMOUNT<0 AND PAY.CREDIT_AMOUNT<>0)/*CREDITNOTE AND CREDIT REFUND BILLS*/
		AND A.CANCELLED = 0 
	)CMM ON CM.CM_ID=CMM.CM_ID
	JOIN LOCATION  LO (NOLOCK) ON LO.DEPT_ID = CM.location_Code 
	JOIN PAYMODE_XN_DET PXD (NOLOCK) ON  PXD.MEMO_ID = CM.CM_ID
	JOIN PAYMODE_MST PM (NOLOCK) ON PM.PAYMODE_CODE = PXD.PAYMODE_CODE
	JOIN PAYMODE_GRP_MST PGM (NOLOCK) ON PGM.PAYMODE_GRP_CODE = PM.PAYMODE_GRP_CODE
	WHERE PXD.XN_TYPE = 'SLS' AND CM.CANCELLED = 0 
	AND NOT ( PXD.PAYMODE_CODE='0000004' AND PXD.AMOUNT<0 AND SUBSTRING(CM_NO,5,1)='N')
	AND PXD.PAYMODE_CODE<>'CMR0001'
	AND ((@BDSM=1 AND (DSD.CM_ID IS NOT NULL OR CMM.CM_ID IS NOT NULL)) OR (@BDSM=0 AND CM.SHIFT_ID=@CSHIFT_ID)) 
	GROUP BY LO.DEPT_ID,LO.DEPT_NAME,CM.CM_DT,PGM.PAYMODE_GRP_NAME,PM.PAYMODE_NAME,CM.CANCELLED,CM.USER_CODE 
			,CM.BIN_ID,PGM.PAYMODE_GRP_CODE, SUBSTRING(CM.CM_NO,5,1)
	UNION ALL								
	---LIST OF CREDIT REFUND BILLS
	SELECT LO.DEPT_ID,LO.DEPT_NAME,CM.CM_DT,CM.CANCELLED,PAYMODE_GRP_NAME,PAYMODE_NAME,'SALE' AS TRAN_TYPE,
	SUM(PXD.AMOUNT) AS AMOUNT,CM.USER_CODE,CM.BIN_ID,1 AS IS_ISSUE 
	FROM CMM01106 CM (NOLOCK)
	JOIN LOCATION  LO (NOLOCK) ON LO.DEPT_ID = CM.location_Code 
	JOIN PAYMODE_XN_DET PXD (NOLOCK) ON  PXD.MEMO_ID = CM.CM_ID 
	JOIN PAYMODE_MST PM (NOLOCK) ON PM.PAYMODE_CODE = PXD.PAYMODE_CODE
	JOIN PAYMODE_GRP_MST PGM (NOLOCK) ON PGM.PAYMODE_GRP_CODE = PM.PAYMODE_GRP_CODE
	WHERE PXD.XN_TYPE = 'SLS' AND PXD.PAYMODE_CODE='CMR0001' AND CM.CANCELLED = 0 
	AND CM.SHIFT_ID=@CSHIFT_ID
	GROUP BY LO.DEPT_ID,LO.DEPT_NAME,CM.CM_DT,PAYMODE_GRP_NAME,PAYMODE_NAME,CM.CANCELLED,CM.USER_CODE,CM.BIN_ID
	UNION ALL
	--LIST OF CREDIT NOTES
	SELECT LO.DEPT_ID,LO.DEPT_NAME,CM.CM_DT,CM.CANCELLED,PGM.PAYMODE_GRP_NAME,'CREDIT NOTE ISSUE' [PAYMODE_NAME]
	,'SALE' AS TRAN_TYPE,
	SUM(PXD.AMOUNT) AS AMOUNT,CM.USER_CODE,CM.BIN_ID,1 AS IS_ISSUE 
	FROM CMM01106 CM (NOLOCK)
	JOIN LOCATION  LO (NOLOCK) ON LO.DEPT_ID = CM.location_Code
	JOIN PAYMODE_XN_DET PXD (NOLOCK) ON  PXD.MEMO_ID = CM.CM_ID
	JOIN PAYMODE_MST PM (NOLOCK) ON PM.PAYMODE_CODE = PXD.PAYMODE_CODE
	JOIN PAYMODE_GRP_MST PGM (NOLOCK) ON PGM.PAYMODE_GRP_CODE = PM.PAYMODE_GRP_CODE
	WHERE PXD.XN_TYPE = 'SLS' AND CM.CANCELLED = 0 
	AND CM.SHIFT_ID=@CSHIFT_ID
	AND PXD.PAYMODE_CODE='0000004' AND PXD.AMOUNT<0 AND	SUBSTRING(CM_NO,5,1)='N'
	GROUP BY LO.DEPT_ID,LO.DEPT_NAME,CM.CM_DT,PGM.PAYMODE_GRP_NAME,PM.PAYMODE_NAME,CM.CANCELLED,CM.USER_CODE 
			,CM.BIN_ID
	UNION ALL
	--LIST OF WHOLESALE FOR A GIVEN SHIFT
	SELECT LO.DEPT_ID,LO.DEPT_NAME,INM.INV_DT,INM.CANCELLED,PGM.PAYMODE_GRP_NAME,PM.PAYMODE_NAME
	,'WHOLESALE' AS TRAN_TYPE,SUM(ISNULL(PXD.AMOUNT,0)) AS AMOUNT,INM.USER_CODE,INM.BIN_ID 
	,0 AS IS_ISSUE
	FROM INM01106 INM (NOLOCK)
	JOIN LOCATION  LO (NOLOCK) ON LO.DEPT_ID = INM.LOCATION_CODE
	JOIN PAYMODE_XN_DET PXD (NOLOCK) ON  PXD.MEMO_ID = INM.INV_ID
	JOIN PAYMODE_MST PM (NOLOCK) ON PM.PAYMODE_CODE = PXD.PAYMODE_CODE
	JOIN PAYMODE_GRP_MST PGM (NOLOCK) ON PGM.PAYMODE_GRP_CODE = PM.PAYMODE_GRP_CODE
	WHERE PXD.XN_TYPE = 'WSL' AND INM.CANCELLED = 0 
	AND 1=2/*INSTEAD OF THIS FILTER APPLY INM.SHIFT_ID=@CSHIFT_ID WHEN SHIFT WILL BE ENABLED FOR WHOLESALE INVOICE.*/
	GROUP BY LO.DEPT_ID,LO.DEPT_NAME,INM.INV_DT,PGM.PAYMODE_GRP_NAME,PM.PAYMODE_NAME,INM.CANCELLED,INM.USER_CODE 
			,INM.BIN_ID
	UNION ALL
	--LIST OF TRANSACTION THRU ADVANCES CASHIER MODULE
	SELECT LO.DEPT_ID,LO.DEPT_NAME,AR.ADV_REC_DT,AR.CANCELLED,PGM.PAYMODE_GRP_NAME,PM.PAYMODE_NAME,
	(CASE WHEN AR.ARC_TYPE=1 THEN
	(CASE WHEN AR.ARCT=1 THEN 'O/S RECEIPTS' WHEN AR.ARCT=2 THEN 'ADVANCES' WHEN AR.ARCT=3 THEN 'FEES/O/C' 
		  WHEN AR.ARCT=5 THEN 'D.CARD ISS/REN'	END) 
	      WHEN AR.ARC_TYPE=2 THEN 'PAYMENT' ELSE '' END) AS TRAN_TYPE,
	SUM(PXD.AMOUNT) AS AMOUNT,AR.USER_CODE,AR.BIN_ID 
	,(CASE WHEN AR.ARC_TYPE=1 THEN 0 ELSE 1 END) AS IS_ISSUE
	FROM ARC01106 AR
	JOIN LOCATION  LO ON LO.DEPT_ID = AR.LOCATION_CODE
	JOIN PAYMODE_XN_DET PXD ON  PXD.MEMO_ID = AR.ADV_REC_ID
	JOIN PAYMODE_MST PM ON PM.PAYMODE_CODE = PXD.PAYMODE_CODE
	JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = PM.PAYMODE_GRP_CODE
	WHERE PXD.XN_TYPE = 'ARC' AND AR.SHIFT_ID=@CSHIFT_ID
	AND CANCELLED = 0
	GROUP BY LO.DEPT_ID,LO.DEPT_NAME,AR.ADV_REC_DT,PGM.PAYMODE_GRP_NAME,PM.PAYMODE_NAME,ARCT,AR.CANCELLED
	,AR.USER_CODE,AR.BIN_ID,AR.ARC_TYPE
	UNION ALL
	SELECT LO.DEPT_ID,LO.DEPT_NAME,TMST.MEMO_DT,TMST.CANCELLED,'01. CURRENCY' AS PAYMODE_GRP_NAME
		  ,'INR' AS PAYMODE_NAME,'TILL' AS TRAN_TYPE
		  ,SUM(TDET.AMOUNT) AS AMOUNT,TMST.USER_CODE,'000' AS BIN_ID 
		  ,(CASE WHEN TDET.XN_TYPE='DR' THEN 1 ELSE 0 END) AS IS_ISSUE
	FROM TILL_EXPENSE_MST TMST
	JOIN TILL_EXPENSE_DET TDET ON TMST.MEMO_ID=TDET.MEMO_ID
	JOIN LOCATION  LO ON LO.DEPT_ID = TMST.LOCATION_CODE
	WHERE TMST.SHIFT_ID=@CSHIFT_ID
	AND TMST.CANCELLED = 0
	GROUP BY LO.DEPT_ID,LO.DEPT_NAME,TMST.MEMO_DT,TMST.CANCELLED,TMST.USER_CODE,TDET.XN_TYPE
	UNION ALL
	SELECT LO.DEPT_ID,LO.DEPT_NAME,TMST.MEMO_DT,TMST.CANCELLED,'01. CURRENCY' AS PAYMODE_GRP_NAME
		  ,'INR' AS PAYMODE_NAME,'LIFT' AS TRAN_TYPE
		  ,SUM(TMST.LIFT_AMOUNT) AS AMOUNT,TMST.USER_CODE,'000' AS BIN_ID 
		  ,1 AS IS_ISSUE
	FROM TILL_LIFTS TMST
	JOIN LOCATION  LO ON LO.DEPT_ID = TMST.LOCATION_CODE
	WHERE TMST.SHIFT_ID=@CSHIFT_ID
	AND TMST.CANCELLED = 0
	GROUP BY LO.DEPT_ID,LO.DEPT_NAME,TMST.MEMO_DT,TMST.CANCELLED,TMST.USER_CODE
	
	--TRANSFORMING THE ROWS OF TRANSACTION TYPE INTO COLUMNS FOR RECEIPTS
	IF OBJECT_ID('#FINAL_SLS_REPORT_RECEIPTS','U') IS NOT NULL
		DROP TABLE #FINAL_SLS_REPORT_RECEIPTS 
	
	CREATE TABLE #FINAL_SLS_REPORT_RECEIPTS(PAYMODE_GRP_NAME VARCHAR(100),PAYMODE_NAME VARCHAR(100)
										   ,SALE NUMERIC(14,2),OS_RECEIPTS NUMERIC(14,2),ADVANCES NUMERIC(14,2)
										   ,OC NUMERIC(14,2),D_CARD_ISS_REN NUMERIC(14,2),WHOLESALE NUMERIC(14,2)
										   ,TILL NUMERIC(14,2))
	
	INSERT #FINAL_SLS_REPORT_RECEIPTS	( PAYMODE_GRP_NAME, PAYMODE_NAME, SALE, OS_RECEIPTS, ADVANCES, OC,D_CARD_ISS_REN
										, WHOLESALE, TILL )  
	SELECT 	  PAYMODE_GRP_NAME, PAYMODE_NAME,SUM(AMOUNT) AS SALE,0 AS OS_RECEIPTS,0 AS ADVANCES,0 AS OC,0 AS D_CARD_ISS_REN,0 AS WHOLESALE
	,0 AS TILL 
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='SALE' AND IS_ISSUE=0
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	UNION ALL
	SELECT 	  PAYMODE_GRP_NAME, PAYMODE_NAME,0 AS SALE,SUM(AMOUNT) AS OS_RECEIPTS,0 AS ADVANCES,0 AS OC,0 AS D_CARD_ISS_REN,0 AS WHOLESALE
	,0 AS TILL 
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='O/S RECEIPTS' 
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	UNION ALL
	SELECT 	  PAYMODE_GRP_NAME, PAYMODE_NAME,0 AS SALE,0 AS OS_RECEIPTS,SUM(AMOUNT) AS ADVANCES,0 AS OC,0 AS D_CARD_ISS_REN,0 AS WHOLESALE
	,0 AS TILL 
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='ADVANCES' 
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	UNION ALL
	SELECT 	  PAYMODE_GRP_NAME, PAYMODE_NAME,0 AS SALE,0 AS OS_RECEIPTS,0 AS ADVANCES,SUM(AMOUNT) AS OC,0 AS D_CARD_ISS_REN,0 AS WHOLESALE
	,0 AS TILL 
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='FEES/O/C' 
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	UNION ALL
	SELECT 	  PAYMODE_GRP_NAME, PAYMODE_NAME,0 AS SALE,0 AS OS_RECEIPTS,0 AS ADVANCES,0 AS OC,SUM(AMOUNT) AS D_CARD_ISS_REN,0 AS WHOLESALE
	,0 AS TILL 
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='D.CARD ISS/REN' 
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	UNION ALL
	SELECT 	  PAYMODE_GRP_NAME, PAYMODE_NAME,0 AS SALE,0 AS OS_RECEIPTS,0 AS ADVANCES,0 AS OC,0 AS D_CARD_ISS_REN,SUM(AMOUNT) AS WHOLESALE
	,0 AS TILL 
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='WHOLESALE' AND IS_ISSUE=0
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	UNION ALL
	SELECT 	  PAYMODE_GRP_NAME, PAYMODE_NAME,0 AS SALE,0 AS OS_RECEIPTS,0 AS ADVANCES,0 AS OC,0 AS D_CARD_ISS_REN
			 ,0 AS WHOLESALE,SUM(AMOUNT) AS TILL 
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='TILL' AND IS_ISSUE=0
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	
	--TRANSFORMING THE ROWS OF TRANSACTION TYPE INTO COLUMNS FOR ISSUES
	IF OBJECT_ID('#FINAL_SLS_REPORT_ISSUES','U') IS NOT NULL
		DROP TABLE #FINAL_SLS_REPORT_ISSUES
	
	CREATE TABLE #FINAL_SLS_REPORT_ISSUES(PAYMODE_GRP_NAME VARCHAR(100),PAYMODE_NAME VARCHAR(100)
										 ,SALE NUMERIC(14,2),PAYMENT NUMERIC(14,2),TILL NUMERIC(14,2)
										 ,TILL_LIFTS NUMERIC(14,2))
	
	INSERT #FINAL_SLS_REPORT_ISSUES(PAYMODE_GRP_NAME,PAYMODE_NAME,SALE,PAYMENT,TILL,TILL_LIFTS)
	SELECT PAYMODE_GRP_NAME,PAYMODE_NAME,SUM(AMOUNT) AS SALE,0 AS PAYMENT,0 AS TILL,0 AS TILL_LIFTS
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='SALE' AND IS_ISSUE=1 
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	UNION ALL
	SELECT PAYMODE_GRP_NAME,PAYMODE_NAME,0 AS SALE,SUM(AMOUNT) AS PAYMENT,0 AS TILL,0 AS TILL_LIFTS
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='PAYMENT' 
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	UNION ALL
	SELECT PAYMODE_GRP_NAME,PAYMODE_NAME,0 AS SALE,0 AS PAYMENT,SUM(AMOUNT) AS TILL,0 AS TILL_LIFTS
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='TILL' AND IS_ISSUE=1 
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	UNION ALL
	SELECT PAYMODE_GRP_NAME,PAYMODE_NAME,0 AS SALE,0 AS PAYMENT,0 AS TILL,SUM(AMOUNT) AS TILL_LIFTS
	FROM #SLS_REPORT										   
	WHERE TRAN_TYPE='LIFT' AND IS_ISSUE=1 
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	
	
	SELECT PAYMODE_GRP_NAME, PAYMODE_NAME, SUM(SALE) AS SALE, SUM(OS_RECEIPTS) AS OS_RECEIPTS, SUM(ADVANCES) AS ADVANCES
		  ,SUM(OC) AS OC,SUM(D_CARD_ISS_REN) AS D_CARD_ISS_REN,SUM(WHOLESALE) AS WHOLESALE,SUM(TILL) AS TILL
	FROM #FINAL_SLS_REPORT_RECEIPTS
	GROUP BY PAYMODE_GRP_NAME, PAYMODE_NAME
	
	SELECT PAYMODE_GRP_NAME,PAYMODE_NAME,SUM(SALE) AS SALE,SUM(PAYMENT) AS PAYMENT,SUM(TILL) AS TILL,SUM(TILL_LIFTS) AS TILL_LIFTS
	FROM #FINAL_SLS_REPORT_ISSUES
	GROUP BY PAYMODE_GRP_NAME,PAYMODE_NAME
	
	DECLARE @REP_DETAILS TABLE(PRINT_ORDER NUMERIC(4,2), PRINT_DETAIL VARCHAR(100),XN_TYPE VARCHAR(10),   
							   DEPT_ID VARCHAR(2),USER_CODE VARCHAR(10),MEMO_NO VARCHAR(50),   
							   MEMO_DT DATETIME, ADJ_MEMO_NO VARCHAR(MAX), ADJ_MEMO_DT DATETIME,   
							   AMOUNT NUMERIC(18,2), CUSTOMER_CODE VARCHAR(12), BILL_AMOUNT NUMERIC(18,2)
							   ,CASH NUMERIC(18,2),CC NUMERIC(18,2),MISC NUMERIC(18,2),BIN_ID VARCHAR(3)
							   ,PAYMODE_GRP_NAME VARCHAR(50),DISCOUNT_AMOUNT NUMERIC(18,2),CARD_NAME VARCHAR(50))  
	
	--IF (@BCRISSUE=1 OR @BOSRCT=1 OR @BCRNOTE=1 OR @BCRNOTEADJSLS=1 OR 
	--	@BCRNOTEADJRCT=1 OR @BADVADJPYT=1 OR @BADVADJSLS=1 OR @BADVRCT=1 OR @BDOCRCV=1 OR @BOC=1)
	--BEGIN 
		IF @BCRISSUE=1 	
		--LIST OF CREDIT ISSUED
		BEGIN
			INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE , DEPT_ID, USER_CODE, 
								 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
								 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT, BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME)
			SELECT	1 AS PRINT_ORDER, 'LIST OF CREDIT ISSUED' AS PRINT_DETAIL,'SLS' AS XN_TYPE,
					A.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
					A.CM_NO AS MEMO_NO, A.CM_DT AS MEMO_DT,
					'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,
					B.AMOUNT,
					A.CUSTOMER_CODE
					--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME
					--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME
					,A.NET_AMOUNT AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,CONVERT(NUMERIC(18,2),0) AS DISCOUNT_AMOUNT
					,(CASE WHEN D.PAYMODE_GRP_CODE='0000002' THEN D.PAYMODE_NAME ELSE '' END)
			FROM CMM01106 A
			LEFT JOIN 
			(
				SELECT DISTINCT DSD.CM_ID
				FROM DSD01106 DSD(NOLOCK) 
				JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
				WHERE DSM.CANCELLED=0 AND DSM.SHIFT_ID=@CSHIFT_ID
			)DSD ON A.CM_ID=DSD.CM_ID
			LEFT JOIN 
			(
				SELECT DISTINCT A.CM_ID 
				FROM  CMM01106  A (NOLOCK) 
				JOIN VW_BILL_PAYMODE PAY (NOLOCK) ON PAY.MEMO_ID=A.CM_ID AND PAY.XN_TYPE='SLS'
				WHERE A.SHIFT_ID=@CSHIFT_ID
				AND (A.NET_AMOUNT<0 AND PAY.CREDIT_AMOUNT<>0)/*CREDITNOTE AND CREDIT REFUND BILLS*/
				AND A.CANCELLED = 0 
			)CMM ON A.CM_ID=CMM.CM_ID
			JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID 
			JOIN PAYMODE_MST D ON D.PAYMODE_CODE=B.PAYMODE_CODE
			JOIN PAYMODE_GRP_MST PGM (NOLOCK) ON PGM.PAYMODE_GRP_CODE = D.PAYMODE_GRP_CODE
			--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
			WHERE A.CANCELLED = 0 
			AND B.XN_TYPE = 'SLS' AND D.PAYMODE_GRP_CODE = '0000004' AND B.AMOUNT>0
			AND  ((@BDSM=1 AND (DSD.CM_ID IS NOT NULL OR CMM.CM_ID IS NOT NULL)) OR (@BDSM=0 AND A.SHIFT_ID=@CSHIFT_ID))
		END	
		
		IF @BCRREFUND=1
		BEGIN	
			INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE , DEPT_ID, USER_CODE, 
								 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
								 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT, BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME  )
			SELECT	1.1 AS PRINT_ORDER, 'LIST OF CREDIT REFUNDS' AS PRINT_DETAIL,'SLS' AS XN_TYPE,
					A.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
					A.CM_NO AS MEMO_NO, A.CM_DT AS MEMO_DT,
					E.CM_NO AS ADJ_MEMO_NO,E.CM_DT AS ADJ_MEMO_DT,
					ABS(B.AMOUNT) AS [AMOUNT],
					A.CUSTOMER_CODE
					--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME
					--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME
					,A.NET_AMOUNT AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,CONVERT(NUMERIC(18,2),0) AS DISCOUNT_AMOUNT
					,CASE WHEN D.PAYMODE_GRP_CODE='0000002' THEN D.PAYMODE_NAME ELSE '' END
			FROM CMM01106 A
			JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID 
			JOIN PAYMODE_MST D ON D.PAYMODE_CODE=B.PAYMODE_CODE
			JOIN PAYMODE_GRP_MST PGM (NOLOCK) ON PGM.PAYMODE_GRP_CODE = D.PAYMODE_GRP_CODE
			--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
			JOIN CMM01106 E ON E.CM_ID=B.ADJ_MEMO_ID 
			WHERE A.CANCELLED = 0 AND A.SHIFT_ID=@CSHIFT_ID
			AND B.XN_TYPE = 'SLS' AND D.PAYMODE_CODE = 'CMR0001' AND B.AMOUNT<0
		END
		
		IF @BOSRCT=1
		--LIST OF OUTSTANDING RECEIPT
		INSERT @REP_DETAILS( PRINT_ORDER, PRINT_DETAIL,XN_TYPE, DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,CASH,CC,BIN_ID
							 ,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME  )
		SELECT	 2 AS PRINT_ORDER, 'LIST OF OUTSTANDING RECEIVED' AS PRINT_DETAIL,'' AS XN_TYPE,
				a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				 A.ADV_REC_NO AS MEMO_NO,A.ADV_REC_DT AS MEMO_DT  ,
				DBO.FN_GETAGAINSTBILL(A.ADV_REC_ID) AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,
				(CASE WHEN P.PAYMODE_GRP_CODE = '0000001' THEN P.CASH WHEN P.PAYMODE_GRP_CODE = '0000002' THEN P.CC ELSE 0 END ) AS AMOUNT, 
				A.CUSTOMER_CODE,
				--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME,
				--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME,
				--A.NET_AMOUNT 
				(CASE WHEN P.PAYMODE_GRP_CODE = '0000001' THEN P.CASH+A.DISCOUNT_AMOUNT WHEN P.PAYMODE_GRP_CODE = '0000002' THEN P.CC+A.DISCOUNT_AMOUNT ELSE 0 END ) AS BILL_AMOUNT,
				P.CASH,P.CC,A.BIN_ID,P.PAYMODE_GRP_NAME,A.DISCOUNT_AMOUNT
				,P.CARD_NAME
		FROM ARC01106 A
		JOIN 
		   (
				SELECT MEMO_ID,C.PAYMODE_GRP_CODE,ISNULL(SUM(CASE WHEN C.PAYMODE_GRP_CODE = '0000001' THEN A.AMOUNT END),0) AS CASH,
				ISNULL(SUM(CASE WHEN C.PAYMODE_GRP_CODE = '0000002' THEN A.AMOUNT END),0) AS CC 
				,C.PAYMODE_GRP_NAME,CASE WHEN C.PAYMODE_GRP_CODE = '0000002' THEN B.PAYMODE_NAME ELSE '' END AS CARD_NAME
				FROM PAYMODE_XN_DET A 
				JOIN PAYMODE_MST B ON A.PAYMODE_CODE = B.PAYMODE_CODE
				JOIN PAYMODE_GRP_MST C ON C.PAYMODE_GRP_CODE = B.PAYMODE_GRP_CODE
				JOIN ARC01106 D ON D.ADV_REC_ID=A.MEMO_ID
				WHERE A.XN_TYPE='ARC' 
				AND C.PAYMODE_GRP_CODE IN ('0000002','0000001') 
				GROUP BY MEMO_ID,C.PAYMODE_GRP_CODE,C.PAYMODE_GRP_NAME,B.PAYMODE_NAME
			)P ON P.MEMO_ID= A.ADV_REC_ID
		WHERE A.SHIFT_ID=@CSHIFT_ID
		AND A.ARC_TYPE=1 AND A.ARCT=1 AND A.CANCELLED = 0
		
		--LIST OF DISCOUNT CARD ISSUED/RENEWED
		IF @BDCARD=1
		INSERT @REP_DETAILS(PRINT_ORDER,PRINT_DETAIL,XN_TYPE,DEPT_ID,USER_CODE,MEMO_NO,   
							MEMO_DT,ADJ_MEMO_NO,ADJ_MEMO_DT,AMOUNT,CUSTOMER_CODE,BILL_AMOUNT
						   ,CASH,CC,MISC,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME)
		SELECT	2.1 AS PRINT_ORDER, 'LIST OF DISCOUNT CARD ISSUE/RENEWAL' AS PRINT_DETAIL,'ARC' AS XN_TYPE,
					a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				A.ADV_REC_NO AS MEMO_NO, A.ADV_REC_DT AS MEMO_DT,  
				'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,B.AMOUNT,A.CUSTOMER_CODE
				,A.AMOUNT AS BILL_AMOUNT,0 AS CASH,0 AS CC,0 AS MISC,A.BIN_ID,PGM.PAYMODE_GRP_NAME,A.DISCOUNT_AMOUNT
				,'NO.- '+ISNULL(A.CARD_NO,'')+',TYPE- '+ISNULL(BM.CARD_NAME,'')+',ISSUE DT.- '+CONVERT(VARCHAR,A.CARD_ISSUE_DT,110) AS CARD_NAME  
		FROM ARC01106 A
		JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID = B.MEMO_ID AND B.XN_TYPE = 'ARC'
		JOIN PAYMODE_MST D ON D.PAYMODE_CODE=B.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = D.PAYMODE_GRP_CODE
		LEFT OUTER JOIN BWD_MST BM ON BM.MEMO_ID=A.CARD_CODE
		WHERE A.ARC_TYPE=1 AND A.ARCT=5 AND A.CANCELLED = 0
		AND A.SHIFT_ID=@CSHIFT_ID
		
		IF @BCRNOTE=1
		-- LIST OF CREDIT NOTES
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE ,DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME)
		SELECT	3 AS PRINT_ORDER, 'LIST OF CREDIT NOTES ISSUED' AS PRINT_DETAIL,'SLS' AS XN_TYPE,
		 a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				A.CM_NO AS MEMO_NO, A.CM_DT AS MEMO_DT,
				'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,
				ABS(B.AMOUNT) AS AMOUNT,
				A.CUSTOMER_CODE,
				--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME,
				--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME,
				A.NET_AMOUNT AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,A.DISCOUNT_AMOUNT
				,CASE WHEN D.PAYMODE_GRP_CODE='0000002' THEN D.PAYMODE_NAME ELSE '' END
		FROM CMM01106 A
		JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID 
		--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		JOIN PAYMODE_MST D ON D.PAYMODE_CODE=B.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = D.PAYMODE_GRP_CODE
		LEFT JOIN 
		(
			SELECT DISTINCT DSD.CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
			WHERE DSM.CANCELLED=0 AND DSM.SHIFT_ID=@CSHIFT_ID
		)DSD ON A.CM_ID=DSD.CM_ID
		LEFT JOIN 
		(
			SELECT DISTINCT A.CM_ID 
			FROM  CMM01106  A (NOLOCK) 
			JOIN VW_BILL_PAYMODE PAY (NOLOCK) ON PAY.MEMO_ID=A.CM_ID AND PAY.XN_TYPE='SLS'
			WHERE A.SHIFT_ID=@CSHIFT_ID
			AND (A.NET_AMOUNT<0 AND PAY.CREDIT_AMOUNT<>0)/*CREDITNOTE AND CREDIT REFUND BILLS*/
			AND A.CANCELLED = 0 
		)CMM ON A.CM_ID=CMM.CM_ID
		WHERE SUBSTRING(A.CM_NO,5,1) = 'N'
		AND A.CANCELLED = 0     
		AND B.XN_TYPE = 'SLS' AND D.PAYMODE_CODE = '0000004' AND B.AMOUNT < 0
		AND  ((@BDSM=1 AND (DSD.CM_ID IS NOT NULL OR CMM.CM_ID IS NOT NULL)) 
			 OR (@BDSM=0 AND A.SHIFT_ID=@CSHIFT_ID))
		ORDER BY A.CM_DT, A.CM_NO
		
		IF @BCRNOTEADJSLS=1 
		-- LIST OF CREDIT NOTES ADJUSTED IN SALE
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE ,DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME)
		SELECT	4 AS PRINT_ORDER, 'LIST OF CREDIT NOTES ADJUSTED' AS PRINT_DETAIL,'SLS' AS XN_TYPE,
				a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				A.CM_NO AS MEMO_NO, A.CM_DT AS MEMO_DT, 
				CN.CM_NO AS ADJ_MEMO_NO, CN.CM_DT AS ADJ_MEMO_DT,B.AMOUNT,
				A.CUSTOMER_CODE,
				--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME,
				--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME,
				A.NET_AMOUNT AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,A.DISCOUNT_AMOUNT
				,CASE WHEN D.PAYMODE_GRP_CODE='0000002' THEN D.PAYMODE_NAME ELSE '' END
		FROM CMM01106 A
		JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID AND B.XN_TYPE = 'SLS'
		JOIN PAYMODE_MST D ON D.PAYMODE_CODE=B.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = D.PAYMODE_GRP_CODE
		--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		LEFT OUTER JOIN CMM01106 CN ON CN.CM_ID = B.ADJ_MEMO_ID
		LEFT JOIN 
		(
			SELECT DISTINCT DSD.CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
			WHERE DSM.CANCELLED=0 AND DSM.SHIFT_ID=@CSHIFT_ID
		)DSD ON A.CM_ID=DSD.CM_ID
		LEFT JOIN 
		(
			SELECT DISTINCT A.CM_ID 
			FROM  CMM01106  A (NOLOCK) 
			JOIN VW_BILL_PAYMODE PAY (NOLOCK) ON PAY.MEMO_ID=A.CM_ID AND PAY.XN_TYPE='SLS'
			WHERE A.SHIFT_ID=@CSHIFT_ID
			AND (A.NET_AMOUNT<0 AND PAY.CREDIT_AMOUNT<>0)/*CREDITNOTE AND CREDIT REFUND BILLS*/
			AND A.CANCELLED = 0 
		)CMM ON A.CM_ID=CMM.CM_ID
		WHERE B.PAYMODE_CODE = '0000001'  AND A.CANCELLED = 0 
		AND ((@BDSM=1 AND (DSD.CM_ID IS NOT NULL OR A.CM_ID IS NOT NULL)) OR (@BDSM=0 and cmm.cm_id is not null))
				
		IF @BCRNOTEADJRCT=1
		-- LIST OF CREDIT NOTES ADJUSTED IN RECEIPT
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE ,DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME  )
		SELECT	5 AS PRINT_ORDER, 'LIST OF CREDIT NOTES ADJUSTED' AS PRINT_DETAIL,'REC' AS XN_TYPE,
					a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				A.ADV_REC_NO AS MEMO_NO, A.ADV_REC_DT AS MEMO_DT,  
				CN.CM_NO AS ADJ_MEMO_NO, CN.CM_DT AS ADJ_MEMO_DT,
				B.AMOUNT, 
				A.CUSTOMER_CODE,
				--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME,
				--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME,
				A.NET_AMOUNT AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,A.DISCOUNT_AMOUNT
				,CASE WHEN D.PAYMODE_GRP_CODE='0000002' THEN D.PAYMODE_NAME ELSE '' END
		FROM ARC01106 A
		JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID AND B.XN_TYPE = 'REC'
		JOIN PAYMODE_MST D ON D.PAYMODE_CODE=B.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = D.PAYMODE_GRP_CODE
		--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		LEFT OUTER JOIN CMM01106 CN ON CN.CM_ID = B.ADJ_MEMO_ID
		WHERE B.PAYMODE_CODE = '0000001' AND A.CANCELLED = 0
		AND   A.SHIFT_ID=@CSHIFT_ID
		
		IF @BADVADJPYT=1
		--LIST OF ADVANCE ADJUSTED IN PAYMENTS/LIST OF ALL PAYMENTS
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE, DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME )
		SELECT	6 AS PRINT_ORDER,(CASE WHEN PM.PAYMODE_CODE='0000002' THEN 'LIST OF ADVANCE ADJUSTED' ELSE 'LIST OF PAYMENTS' END) AS PRINT_DETAIL
		,'ARC' AS XN_TYPE
		,	a.LOCATION_CODE AS DEPT_ID
		, A.USER_CODE
		,A.ADV_REC_NO AS MEMO_NO
		,A.ADV_REC_DT AS MEMO_DT  
		,'' AS ADJ_MEMO_NO
		,'' AS ADJ_MEMO_DT
		,D.NET_AMOUNT
		,A.CUSTOMER_CODE
		,A.NET_AMOUNT AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,A.DISCOUNT_AMOUNT
		,CASE WHEN PM.PAYMODE_GRP_CODE='0000002' THEN PM.PAYMODE_NAME ELSE '' END
		FROM ARC01106 A
		--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		JOIN PAYMODE_XN_DET B ON B.MEMO_ID=A.ADV_REC_ID -----CHANGES A.CM_ID 17.12.14
		JOIN PAYMODE_MST PM ON PM.PAYMODE_CODE=B.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = PM.PAYMODE_GRP_CODE
		JOIN ARC01106 D ON D.ADV_REC_ID=B.ADJ_MEMO_ID
		WHERE A.SHIFT_ID=@CSHIFT_ID
		AND A.ARC_TYPE=2 AND A.CANCELLED = 0
			
		IF @BADVADJSLS=1
		--LIST OF ADVANCE ADJUSTED IN SALE
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE, DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME )
		SELECT	7 AS PRINT_ORDER, 'LIST OF ADVANCE ADJUSTED' AS PRINT_DETAIL,'SLS' AS XN_TYPE,
					a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				 A.CM_NO AS MEMO_NO,A.CM_DT AS MEMO_DT  ,
				B.REF_NO AS ADJ_MEMO_NO, CN.ADV_REC_DT AS ADJ_MEMO_DT,
				 B.AMOUNT, 
				A.CUSTOMER_CODE,				 
				 --(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME,
				--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME,
				A.NET_AMOUNT AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,CONVERT(NUMERIC(18,2),0) AS DISCOUNT_AMOUNT
				,CASE WHEN D.PAYMODE_GRP_CODE='0000002' THEN D.PAYMODE_NAME ELSE '' END
		FROM CMM01106 A
		LEFT JOIN 
		(
			SELECT DISTINCT DSD.CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
			WHERE DSM.CANCELLED=0 AND DSM.SHIFT_ID=@CSHIFT_ID
		)DSD ON A.CM_ID=DSD.CM_ID
		LEFT JOIN 
		(
			SELECT DISTINCT A.CM_ID 
			FROM  CMM01106  A (NOLOCK) 
			JOIN VW_BILL_PAYMODE PAY (NOLOCK) ON PAY.MEMO_ID=A.CM_ID AND PAY.XN_TYPE='SLS'
			WHERE A.SHIFT_ID=@CSHIFT_ID
			AND (A.NET_AMOUNT<0 AND PAY.CREDIT_AMOUNT<>0)/*CREDITNOTE AND CREDIT REFUND BILLS*/
			AND A.CANCELLED = 0 
		)CMM ON A.CM_ID=CMM.CM_ID
		JOIN PAYMODE_XN_DET B ON B.MEMO_ID=A.CM_ID
		JOIN PAYMODE_MST D ON D.PAYMODE_CODE=B.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = D.PAYMODE_GRP_CODE
		--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		JOIN ARC01106 CN ON CN.ADV_REC_ID = B.ADJ_MEMO_ID
		WHERE D.PAYMODE_CODE='0000002' AND A.CANCELLED = 0
		AND  ((@BDSM=1 AND (DSD.CM_ID IS NOT NULL OR CMM.CM_ID IS NOT NULL)) OR (@BDSM=0 AND A.SHIFT_ID=@CSHIFT_ID))
				
		IF @BADVRCT=1
		-- LIST OF ADVANCES IN RECEIPT  
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE, DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME )
		SELECT	 8 AS PRINT_ORDER, 'LIST OF ADVANCES RECEIVED' AS PRINT_DETAIL,'' AS XN_TYPE,
					a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				 A.ADV_REC_NO AS MEMO_NO,A.ADV_REC_DT AS MEMO_DT  ,
				'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,
				ISNULL(B.AMOUNT,0) AS AMOUNT, --CHANGES BY DISNKAR B.AMOUNT
				A.CUSTOMER_CODE,
				--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME,
				--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME,
				ISNULL(B.AMOUNT,0)+ISNULL(A.DISCOUNT_AMOUNT,0) AS BILL_AMOUNT, --AS NET_AMOUNT CHANGES BY DINKAR
				A.BIN_ID,PGM.PAYMODE_GRP_NAME,A.DISCOUNT_AMOUNT
				,CASE WHEN D.PAYMODE_GRP_CODE='0000002' THEN D.PAYMODE_NAME ELSE '' END 
		FROM ARC01106 A
		LEFT JOIN PAYMODE_XN_DET B ON B.MEMO_ID=A.ADV_REC_ID
		LEFT JOIN PAYMODE_MST D ON D.PAYMODE_CODE=B.PAYMODE_CODE
		LEFT JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = D.PAYMODE_GRP_CODE
		WHERE ISNULL(B.XN_TYPE,'ARC')='ARC' /*DONE SO THAT ADVANCE WITH 100% DISCOUNT COULD BE INCLUDED AS 
		FOR SUCH ADVANCE NO ENTRY IS CREATED IN PAYMODE_XN_DET*/
		AND A.SHIFT_ID=@CSHIFT_ID
		AND ISNULL(PGM.PAYMODE_GRP_CODE,'0000002') <>'0000003' 
		AND A.ARC_TYPE =1 AND  A.ARCT=2 AND A.CANCELLED = 0
		
		IF @BDOCRCV=1
		--LIST OF DOCUMENT RECEIVED
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE ,DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME  )
		
		SELECT	9 AS PRINT_ORDER, 'LIST OF DOCUMENT RECEIVED' AS PRINT_DETAIL,'SLS' AS XN_TYPE,
					a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				 A.CM_NO AS MEMO_NO,A.CM_DT AS MEMO_DT  ,
				'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,B.AMOUNT,
				A.CUSTOMER_CODE,
				--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME, 
				--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME,
				B.AMOUNT+CONVERT(NUMERIC(18,2),0)  AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,CONVERT(NUMERIC(18,2),0) AS DISCOUNT_AMOUNT
				,CASE WHEN PM.PAYMODE_GRP_CODE='0000002' THEN PM.PAYMODE_NAME ELSE '' END
		FROM CMM01106 A
		JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID AND B.XN_TYPE = 'SLS'
		--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		JOIN PAYMODE_MST PM ON PM.PAYMODE_CODE = B.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = PM.PAYMODE_GRP_CODE 
		LEFT JOIN 
		(
			SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
			WHERE DSM.CANCELLED=0 AND DSM.SHIFT_ID=@CSHIFT_ID
		)DSD ON A.CM_ID=DSD.CM_ID
		LEFT JOIN 
		(
			SELECT DISTINCT A.CM_ID 
			FROM  CMM01106  A (NOLOCK) 
			JOIN VW_BILL_PAYMODE PAY (NOLOCK) ON PAY.MEMO_ID=A.CM_ID AND PAY.XN_TYPE='SLS'
			WHERE A.SHIFT_ID=@CSHIFT_ID
			AND (A.NET_AMOUNT<0 AND PAY.CREDIT_AMOUNT<>0)/*CREDITNOTE AND CREDIT REFUND BILLS*/
			AND A.CANCELLED = 0 
		)CMM ON A.CM_ID=CMM.CM_ID
		WHERE PGM.PAYMODE_GRP_CODE ='0000003' AND A.CANCELLED = 0
		AND ((@BDSM=1 AND (DSD.CM_ID IS NOT NULL OR CMM.CM_ID IS NOT NULL)) OR (@BDSM=0 AND A.SHIFT_ID=@CSHIFT_ID))
		AND ISNULL(B.ADJ_MEMO_ID,'')=''
		
		UNION ALL
		
		SELECT	9 AS PRINT_ORDER, 'LIST OF DOCUMENT RECEIVED' AS PRINT_DETAIL,'ARC' AS XN_TYPE,
					a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				 A.ADV_REC_NO AS MEMO_NO,A.ADV_REC_DT AS MEMO_DT  ,
				'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,B.AMOUNT, 
				A.CUSTOMER_CODE,
				--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME,
				--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME,
				B.AMOUNT+A.DISCOUNT_AMOUNT AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,A.DISCOUNT_AMOUNT
				,CASE WHEN PM.PAYMODE_CODE IN ('0000001','0000002') THEN PM.PAYMODE_NAME ELSE '' END
		FROM ARC01106 A
		JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID = B.MEMO_ID AND B.XN_TYPE = 'ARC'
		--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		JOIN PAYMODE_MST PM ON PM.PAYMODE_CODE = B.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = PM.PAYMODE_GRP_CODE 
		WHERE PGM.PAYMODE_GRP_CODE ='0000003' AND  A.SHIFT_ID=@CSHIFT_ID
		AND A.CANCELLED = 0
		/*IF IT IS PAYMENT, ADVANCES SHOULD NOT BE DISPLAYED IN THE LIST OF DOCUMENTS RECEIVED AS IT IS 
		ALREADY BEING DISPLAYED IN LIST OF ADVANCES AGAINST PAYMENT*/
		AND ((A.ARC_TYPE=2 AND PM.PAYMODE_CODE<>'0000002') OR A.ARC_TYPE=1)
		--AND ISNULL(B.ADJ_MEMO_ID,'')=''
		
		IF @BOC=1
		--LIST OF OTHER CHARGES
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE, DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME )
		SELECT	10 AS PRINT_ORDER,'LIST OF OTHER CHARGES' AS PRINT_DETAIL,'O/C' AS XN_TYPE,
					a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				 A.ADV_REC_NO AS MEMO_NO,A.ADV_REC_DT AS MEMO_DT  ,
				'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,
				B.AMOUNT, 
				A.CUSTOMER_CODE,
				--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME,
				--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME,
				A.NET_AMOUNT AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,A.DISCOUNT_AMOUNT
				,CASE WHEN PM.PAYMODE_GRP_CODE='0000002' THEN PM.PAYMODE_NAME ELSE '' END
		FROM ARC01106 A
		--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		JOIN PAYMODE_XN_DET B ON B.MEMO_ID=A.ADV_REC_ID
		JOIN PAYMODE_MST PM ON PM.PAYMODE_CODE = B.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = PM.PAYMODE_GRP_CODE 
		--JOIN ARC01106 D ON D.ADV_REC_ID=B.ADJ_MEMO_ID
		WHERE B.XN_TYPE='ARC' AND A.SHIFT_ID=@CSHIFT_ID
		AND A.ARC_TYPE=1 AND A.ARCT=3 AND A.CANCELLED = 0
		
		IF @BCASHREF = 1
		--LIST OF CASH REFUND BILL
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE ,DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME  )
		SELECT 11 AS PRINT_ORDER,'LIST OF CASH REFUND' AS PRINT_DETAIL ,'SLS' AS XN_TYPE,
				a.LOCATION_CODE AS DEPT_ID,A.USER_CODE,
				A.CM_NO AS MEMO_NO,A.CM_DT AS MEMO_DT,
				'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,B.AMOUNT,
				A.CUSTOMER_CODE,
				A.NET_AMOUNT AS BILL_AMOUNT,A.BIN_ID,PGM.PAYMODE_GRP_NAME,CONVERT(NUMERIC(18,2),0) AS DISCOUNT_AMOUNT
				,CASE WHEN PM.PAYMODE_GRP_CODE='0000002' THEN PM.PAYMODE_NAME ELSE '' END
		FROM CMM01106 A
		LEFT JOIN 
		(
			SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
			WHERE DSM.CANCELLED=0 AND DSM.SHIFT_ID=@CSHIFT_ID
		)DSD ON A.CM_ID=DSD.CM_ID
		LEFT JOIN 
		(
			SELECT DISTINCT A.CM_ID 
			FROM  CMM01106  A (NOLOCK) 
			JOIN VW_BILL_PAYMODE PAY (NOLOCK) ON PAY.MEMO_ID=A.CM_ID AND PAY.XN_TYPE='SLS'
			WHERE A.SHIFT_ID=@CSHIFT_ID
			AND (A.NET_AMOUNT<0 AND PAY.CREDIT_AMOUNT<>0)/*CREDITNOTE AND CREDIT REFUND BILLS*/
			AND A.CANCELLED = 0 
		)CMM ON A.CM_ID=CMM.CM_ID	
		JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID AND B.XN_TYPE = 'SLS'
		--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		JOIN PAYMODE_MST PM ON PM.PAYMODE_CODE = B.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PGM ON PGM.PAYMODE_GRP_CODE = PM.PAYMODE_GRP_CODE 
		WHERE PGM.PAYMODE_GRP_CODE ='0000001' AND A.CANCELLED = 0
		AND ISNULL(B.ADJ_MEMO_ID,'')=''	AND  SUBSTRING(A.CM_NO,5,1)<>'N' AND B.AMOUNT < 0
		AND ((@BDSM=1 AND (DSD.CM_ID IS NOT NULL OR CMM.CM_ID IS NOT NULL)) OR (@BDSM=0 AND A.SHIFT_ID=@CSHIFT_ID))
		
		
		IF @BPAYMENT=1
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL,XN_TYPE, DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_CODE, BILL_AMOUNT,CASH,CC,BIN_ID,PAYMODE_GRP_NAME,DISCOUNT_AMOUNT,CARD_NAME  )
		SELECT	 12 AS PRINT_ORDER, 'LIST OF PAYMENTS' AS PRINT_DETAIL,'' AS XN_TYPE,
					a.LOCATION_CODE AS DEPT_ID, A.USER_CODE,
				 A.ADV_REC_NO AS MEMO_NO,A.ADV_REC_DT AS MEMO_DT  ,
				DBO.FN_GETAGAINSTBILL(A.ADV_REC_ID) AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,
				(CASE WHEN P.PAYMODE_GRP_CODE = '0000001' THEN P.CASH WHEN P.PAYMODE_GRP_CODE = '0000002' THEN P.CC WHEN P.PAYMODE_GRP_CODE NOT IN ('0000001','0000002') THEN P.MISC ELSE 0 END ) AS AMOUNT, 
				A.CUSTOMER_CODE,
				--(CASE WHEN C.CUSTOMER_FNAME <> '' AND  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME WHEN  C.CUSTOMER_FNAME <> '' THEN C.CUSTOMER_FNAME WHEN  C.CUSTOMER_LNAME <> '' THEN C.CUSTOMER_LNAME ELSE USER_CUSTOMER_CODE END) AS CUSTOMER_NAME,
				--(CASE WHEN  C.CUSTOMER_FNAME = '' THEN USER_CUSTOMER_CODE ELSE C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME END) AS CUSTOMER_NAME,
				A.NET_AMOUNT AS BILL_AMOUNT,P.CASH,P.CC,A.BIN_ID,P.PAYMODE_GRP_NAME,A.DISCOUNT_AMOUNT
				,P.CARD_NAME
		FROM ARC01106 A
		JOIN 
		   (SELECT MEMO_ID,C.PAYMODE_GRP_CODE,ISNULL(SUM(CASE WHEN C.PAYMODE_GRP_CODE = '0000001' THEN A.AMOUNT END),0) AS CASH,
			ISNULL(SUM(CASE WHEN C.PAYMODE_GRP_CODE = '0000002' THEN A.AMOUNT END),0) AS CC,
			ISNULL(SUM(CASE WHEN C.PAYMODE_GRP_CODE NOT IN ('0000001','0000002') THEN A.AMOUNT END),0) AS MISC
			,C.PAYMODE_GRP_NAME,CASE WHEN C.PAYMODE_GRP_CODE = '0000002' THEN B.PAYMODE_NAME ELSE '' END AS CARD_NAME
			FROM PAYMODE_XN_DET A 
			JOIN PAYMODE_MST B ON A.PAYMODE_CODE = B.PAYMODE_CODE
			JOIN PAYMODE_GRP_MST C ON C.PAYMODE_GRP_CODE = B.PAYMODE_GRP_CODE
			JOIN ARC01106 D ON D.ADV_REC_ID=A.MEMO_ID
			WHERE A.XN_TYPE='ARC' 
			AND B.PAYMODE_GRP_CODE NOT IN ('0000003')
			--AND C.PAYMODE_GRP_CODE IN ('0000002','0000001','0000000') 
			GROUP BY MEMO_ID,C.PAYMODE_GRP_CODE,C.PAYMODE_GRP_NAME,B.PAYMODE_NAME) 
			P ON P.MEMO_ID= A.ADV_REC_ID
		--JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		WHERE A.SHIFT_ID=@CSHIFT_ID
		AND A.ARC_TYPE=2  AND A.CANCELLED = 0
	
	
		SELECT PRINT_ORDER,PRINT_DETAIL,XN_TYPE, 
								DEPT_ID ,MEMO_NO, 
		(CASE WHEN CONVERT (VARCHAR,MEMO_DT,105) = '01-01-1900' THEN '' ELSE CONVERT (VARCHAR,MEMO_DT,105)END) AS MEMO_DT, ADJ_MEMO_NO ,
		(CASE WHEN CONVERT (VARCHAR,ADJ_MEMO_DT,105) = '01-01-1900' THEN '' ELSE CONVERT (VARCHAR,ADJ_MEMO_DT,105) END) AS ADJ_MEMO_DT , 
						AMOUNT , 
						USER_CUSTOMER_CODE+CASE WHEN ISNULL(CUSTOMER_FNAME ,'')+ISNULL(CUSTOMER_LNAME,'')<>'' THEN  
						    ' - '+ ISNULL(CUSTOMER_FNAME ,'')+ ' '+ISNULL(CUSTOMER_LNAME,'') ELSE '' END AS CUSTOMER_NAME, 
						BILL_AMOUNT ,
		ISNULL(CASH,0) AS CASH ,ISNULL(CC,0) AS CC 
		,A.USER_CODE,U.USERNAME,A.BIN_ID,PAYMODE_GRP_NAME
		,(CASE WHEN ROW_NUMBER() OVER(PARTITION BY A.MEMO_NO ORDER BY A.ADJ_MEMO_DT)=1 THEN A.DISCOUNT_AMOUNT ELSE 0 END) AS DISCOUNT_AMOUNT,
		A.CARD_NAME
		FROM @REP_DETAILS A
		JOIN USERS U ON A.USER_CODE=U.USER_CODE
		JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		ORDER BY PRINT_ORDER,MEMO_DT,MEMO_NO
END
--END OF PROCEDURE - SP3S_SHIFT_CASHFLOW_REPORT
