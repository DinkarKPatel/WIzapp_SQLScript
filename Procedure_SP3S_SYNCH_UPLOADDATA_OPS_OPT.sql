CREATE PROCEDURE SP3S_SYNCH_UPLOADDATA_OPS_OPT
    @nSpId VARCHAR(40)

AS

BEGIN
	DECLARE @CSTEP VARCHAR(100),@CDEPTID VARCHAR(40),@CFILTERCONDITION VARCHAR(300),@BAddmode bit
	PRINT 'START INSERT ops01106 '+@nSpId
BEGIN TRY
	declare @CERRMSG varchar(1000)
	
	SET @CSTEP=10
LBLSTART:
    
    BEGIN TRANSACTION

    SELECT @CDEPTID='',@BAddmode=1,@CERRMSG=''
    
    SELECT TOP 1 @CDEPTID = DEPT_ID FROM OPS_SIS_OPS_UPLOAD  (NOLOCK)	WHERE sp_id=@nSpId
    
	
    IF ISNULL(@CDEPTID,'')=''
		GOTO EXIT_PROC

		UPDATE A SET PRODUCT_CODE=LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))  
		FROM OPS_SIS_OPS_UPLOAD A (NOLOCK)	WHERE SP_ID=@NSPID
		AND CHARINDEX('@',PRODUCT_CODE)<>0

    	SELECT a.product_code as new_product_code into #tmpbarcode FROM OPS_SIS_OPS_UPLOAD A (NOLOCK)
		LEFT JOIN SKU B (nolock) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
		WHERE A.SP_ID=@nSpId AND B.PRODUCT_CODE IS NULL
		GROUP BY a.product_code

		IF EXISTS (SELECT TOP 1 'U' FROM #tmpbarcode)
		BEGIN
			SET @CSTEP=84.2
			
			 EXEC SPSIS_INSERTSKUBARCODE @NSPID, 'ops',@CERRMSG OUTPUT
			
			 if isnull(@cErrmsg,'')<>''
			    goto EXIT_PROC

            end
			SET @CFILTERCONDITION = 'B.SP_ID='''+@nSpId+''''

			DELETE FROM OPS_OPS01106_UPLOAD WHERE SP_ID=@nSpId

			INSERT INTO OPS_OPS01106_UPLOAD(DEPT_ID,PRODUCT_CODE,quantity_ob,SP_ID,XN_DT,RECEIPT_DT,BIN_ID)
			SELECT DEPT_ID,PRODUCT_CODE,sum(XN_QTY) as XN_QTY,SP_ID,XN_DT, XN_DT RECEIPT_DT,'000' AS BIN_ID
			FROM OPS_SIS_OPS_UPLOAD
			WHERE SP_ID=@NSPID
			group by DEPT_ID,PRODUCT_CODE,SP_ID,XN_DT


			EXEC UPDATEMASTERXN_OPT @CSOURCEDB='',@CSOURCETABLE='OPS_OPS01106_UPLOAD',@CDESTDB=''
							  ,@CDESTTABLE='OPS01106',@CKEYFIELD1='PRODUCT_CODE',@CKEYFIELD2='DEPT_ID',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1

     DELETE FROM SAVETRAN_BARCODE_NETQTY WHERE SP_ID=@NSPID
	 INSERT SAVETRAN_BARCODE_NETQTY	( BIN_ID, DEPT_ID, PRODUCT_CODE, sp_id, XN_QTY ) 
		 SELECT 	'000'  BIN_ID,DEPT_ID DEPT_ID, PRODUCT_CODE,@nSpId SP_ID,A.quantity_ob AS XN_QTY 
		 FROM OPS_OPS01106_UPLOAD A (NOLOCK)
		 WHERE A.sp_id =@NSPID

	lblupdatepmt:
	EXEC SPSIS_UPDATEPMT @NSPID

	SET @cStep='40'
	

	
END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP3S_SYNCH_UPLOADDATA_OPS_OPT, MEMO ID :'+@CDEPTID+' STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO EXIT_PROC
END CATCH

EXIT_PROC:

	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')='' 
			commit
		ELSE
			ROLLBACK
    END
	select @CERRMSG as errmsg
	DELETE FROM  OPS_SIS_OPS_UPLOAD WHERE SP_ID=@NSPID
	DELETE FROM OPS_OPS01106_UPLOAD WHERE SP_ID=@NSPID
	
END	
---END OF PROCEDURE - SP_SYNCH_UPLOADDATA_GRPPUR_OPT

