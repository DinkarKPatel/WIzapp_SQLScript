create PROCEDURE INSDFMUSERS 
(
	@CUSERCODE VARCHAR(10) = ''
)
--WITH ENCRYPTION
AS 
BEGIN
	DECLARE @CMODULE TABLE ( MODULENAME VARCHAR(10), MODULEGROUP VARCHAR(50) )
	INSERT @CMODULE VALUES ( 'ACT', 'ACCOUNTS' )
	INSERT @CMODULE VALUES ( 'PUR', 'PURCHASE' )
	INSERT @CMODULE VALUES ( 'SLS', 'RETAIL SALE' )
	INSERT @CMODULE VALUES ( 'WSL', 'WHOLESALE' )
	INSERT @CMODULE VALUES ( 'CHO', 'CHALLAN OUT' )
	INSERT @CMODULE VALUES ( 'CHI', 'CHALLAN IN' )
	INSERT @CMODULE VALUES ( 'JWI', 'JOBWORK' )

	DECLARE @CLOCID VARCHAR(4)

	IF @CUSERCODE = ''
	BEGIN
		SELECT @CLOCID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'LOCATION_ID'

		INSERT DFMSETUP ( MODULE_NAME, USER_CODE, FREEZING_DATE, 
						  AUTO_FREEZING, AUTO_FREEZING_DAYS, LAST_UPDATE, MODULE_GROUP, ROW_ID )
		SELECT B.MODULENAME, A.USER_CODE, 
			'' AS FREEZING_DATE, 1 AS AUTO_FREEZING, 
			1 AS AUTO_FREEZING_DAYS, GETDATE() AS LAST_UPDATE, B.MODULEGROUP, (B.MODULENAME + A.USER_CODE)
		FROM USERS A, @CMODULE B 
		WHERE ( A.USER_CODE = '0000000' 
			 OR A.USER_CODE IN ( SELECT USER_CODE FROM LOCUSERS WHERE DEPT_ID = @CLOCID ))
		AND B.MODULENAME + A.USER_CODE NOT IN (
			SELECT MODULE_NAME + USER_CODE FROM DFMSETUP )
	END
	ELSE
	BEGIN
		INSERT DFMSETUP ( MODULE_NAME, USER_CODE, FREEZING_DATE, 
						  AUTO_FREEZING, AUTO_FREEZING_DAYS, LAST_UPDATE, MODULE_GROUP, ROW_ID )
		SELECT B.MODULENAME, @CUSERCODE,
			'' AS FREEZING_DATE, 1 AS AUTO_FREEZING, 
			1 AS AUTO_FREEZING_DAYS, GETDATE() AS LAST_UPDATE, B.MODULEGROUP, (B.MODULENAME + @CUSERCODE)
		FROM @CMODULE B 
		WHERE B.MODULENAME NOT IN (
			SELECT MODULE_NAME FROM DFMSETUP WHERE USER_CODE = @CUSERCODE )

		UPDATE DFMSETUP SET AUTO_FREEZING = 1,
							AUTO_FREEZING_DAYS = B.AUTO_FREEZING_DAYS,
							FREEZING_DATE = B.FREEZING_DATE
		FROM
		(
			SELECT	MODULE_NAME, 
					MAX(FREEZING_DATE) AS FREEZING_DATE,
					MAX(AUTO_FREEZING_DAYS) AS AUTO_FREEZING_DAYS
			FROM DFMSETUP
			GROUP BY MODULE_NAME
		) B
		WHERE DFMSETUP.MODULE_NAME = B.MODULE_NAME
		AND DFMSETUP.USER_CODE = @CUSERCODE
		AND DFMSETUP.FREEZING_DATE = ''
	END
END
