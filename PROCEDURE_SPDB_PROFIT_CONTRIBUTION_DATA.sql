CREATE PROCEDURE SPDB_PROFIT_CONTRIBUTION_DATA
@DTODATE DATETIME,
@BCALLEDFORGMROI BIT=0
AS
BEGIN
	IF OBJECT_ID('TEMPDB..#TMPSETUP','U') IS NOT NULL
		DROP TABLE #TMPSETUP
	
	SELECT * INTO #TMPSETUP	FROM DB_SALE_CONTR_SETUP  WHERE MODE=(CASE WHEN @BCALLEDFORGMROI=0 THEN 2 ELSE 3 END)

	IF OBJECT_ID('TEMPDB..#TMPSUMMARY','U') IS NOT NULL
		DROP TABLE #TMPSUMMARY
	
	SELECT * INTO  #TMPSUMMARY FROM DB_PROFIT_CONTR_SUMMARY WHERE 1=2
	
	DECLARE @CSETUPCODE CHAR(5),@CPARANAME VARCHAR(200),@CFILTERCRITERIA VARCHAR(MAX),@BFLAG BIT,
			@CCMD NVARCHAR(MAX),@CFINYEAR VARCHAR(10)

	SELECT @CFINYEAR='01'+DBO.FN_GETFINYEAR(@DTODATE)
	
	SET @BFLAG=0
	
	WHILE @BFLAG=0
	BEGIN
		SET @CSETUPCODE=''
		SELECT TOP 1 @CSETUPCODE=SETUP_CODE,@CPARANAME=PARA_NAME,@CFILTERCRITERIA=FILTER_CRITERIA FROM #TMPSETUP
		IF ISNULL(@CSETUPCODE,'')=''
			BREAK
	    
	    IF ISNULL(@CFILTERCRITERIA,'')=''
		SET @CFILTERCRITERIA=' 1=1 '
		
		SET @CCMD=N'SELECT LEFT(A.CM_ID,2) AS DEPT_ID,'''+@CSETUPCODE+''' AS SETUP_CODE,'+@CPARANAME+' AS PARA_VAL,
					SUM(QUANTITY) AS SOLD_QTY,SUM(NET-CMM_DISCOUNT_AMOUNT) AS SOLD_VAL_ATMRP,
					SUM((SKU.PURCHASE_PRICE-ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+
					(CASE WHEN POST_TAX_SEPARATELY=0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END))*A.QUANTITY)
					 AS SOLD_VAL_ATPP,SUM(ISNULL(FDN_DR.FDN_AMT,0)*A.QUANTITY) AS FDN_DRAMOUNT,
					 SUM(ISNULL(FDN_CR.PRTAMOUNT_CREDITED,0)*A.QUANTITY) AS FDN_CRAMOUNT,
					 SUM(ISNULL(EOSDN_CR.PRTAMOUNT_CREDITED,0)*A.QUANTITY) AS EOSSDN_CRAMOUNT,
					0 AS PROFIT,0 AS CONTR_PCT
					FROM CMD01106 A (NOLOCK) JOIN CMM01106 B  (NOLOCK) ON A.CM_ID=B.CM_ID
					JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
					JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE 
					JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
					JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
					JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
					JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
					JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
					JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
					JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
					JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
					JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=SKU.AC_CODE
					LEFT OUTER JOIN SKU_OH (NOLOCK) ON SKU_OH.PRODUCT_CODE=SKU.PRODUCT_CODE
					JOIN FORM (NOLOCK) ON FORM.FORM_ID=SKU.FORM_ID
					JOIN LOCATION ON LOCATION.DEPT_ID=LEFT(A.CM_ID,2)
					LEFT OUTER JOIN 
					(SELECT RMD.PRODUCT_CODE,SUM(RMD.FDN_RATE) AS FDN_AMT
					 FROM RMD01106 RMD (NOLOCK)
					 JOIN RMM01106 RMM (NOLOCK) ON RMM.RM_ID=RMD.RM_ID
					 JOIN CMD01106 CMD (NOLOCK) ON CMD.PRODUCT_CODE=RMD.PRODUCT_CODE
					 JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=CMD.CM_ID
					 JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=RMD.PRODUCT_CODE
					 JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE 
					 JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
					 JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
					 JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
					 JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
					 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
					 JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
					 JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
					 JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
					 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=SKU.AC_CODE
					 WHERE CMM.FIN_YEAR='''+@CFINYEAR+''' AND CMM.CM_DT<='''+CONVERT(VARCHAR,@DTODATE,112)+''' AND '+@CFILTERCRITERIA+'
					 AND RMM.MODE=1 AND RMM.CANCELLED=0 AND CMM.CANCELLED=0
					 GROUP BY RMD.PRODUCT_CODE
					 ) FDN_DR ON FDN_DR.PRODUCT_CODE=A.PRODUCT_CODE

					LEFT OUTER JOIN 
					(SELECT PID.PRODUCT_CODE,SUM(PID.PRTAMOUNT) AS PRTAMOUNT_CREDITED
					 FROM PID01106 PID (NOLOCK)
					 JOIN PIM01106 PIM (NOLOCK) ON PIM.MRR_ID=PID.MRR_ID
					 JOIN RMM01106 RMM (NOLOCK) ON RMM.REFMEMOID=PIM.MRR_ID
					 JOIN CMD01106 CMD (NOLOCK) ON CMD.PRODUCT_CODE=PID.PRODUCT_CODE
					 JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=CMD.CM_ID
					 JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=PID.PRODUCT_CODE
					 JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE 
					 JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
					 JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
					 JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
					 JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
					 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
					 JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
					 JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
					 JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
					 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=SKU.AC_CODE
					 WHERE CMM.FIN_YEAR='''+@CFINYEAR+''' AND CMM.CM_DT<='''+CONVERT(VARCHAR,@DTODATE,112)+''' AND '+@CFILTERCRITERIA+'
					 AND PIM.INV_MODE=1 AND CMM.CANCELLED=0 AND PIM.CANCELLED=0
					 AND RMM.CANCELLED=0
					 GROUP BY PID.PRODUCT_CODE
					 ) FDN_CR ON FDN_CR.PRODUCT_CODE=A.PRODUCT_CODE 

					LEFT OUTER JOIN 
					(SELECT A.PRODUCT_CODE,SUM(A.DISCOUNT_SHARING_AMOUNT/A.QUANTITY) AS PRTAMOUNT_CREDITED
					 FROM EOSSDND A (NOLOCK)
					 JOIN EOSSDNM B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
					 JOIN CMD01106 CMD (NOLOCK) ON CMD.PRODUCT_CODE=A.PRODUCT_CODE
					 JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=CMD.CM_ID
					 JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
					 JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE 
					 JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
					 JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
					 JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
					 JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
					 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
					 JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
					 JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
					 JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
					 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=SKU.AC_CODE
					 WHERE CMM.FIN_YEAR='''+@CFINYEAR+''' AND CMM.CM_DT<='''+CONVERT(VARCHAR,@DTODATE,112)+''' AND '+@CFILTERCRITERIA+'
					 AND CMM.CANCELLED=0 AND B.CANCELLED=0
					 GROUP BY A.PRODUCT_CODE
					 ) EOSDN_CR ON EOSDN_CR.PRODUCT_CODE=A.PRODUCT_CODE					 
					 					 
					WHERE FIN_YEAR='''+@CFINYEAR+''' AND CM_DT<='''+CONVERT(VARCHAR,@DTODATE,112)+''' AND CANCELLED=0 AND '+@CFILTERCRITERIA+'
					GROUP BY LEFT(A.CM_ID,2),'+@CPARANAME+'
					
					UNION
					SELECT '''' AS DEPT_ID,'''+@CSETUPCODE+''' AS SETUP_CODE,'+@CPARANAME+' AS PARA_VAL,
					SUM(QUANTITY) AS SOLD_QTY,SUM(NET-CMM_DISCOUNT_AMOUNT) AS SOLD_VAL_ATMRP,
					SUM((SKU.PURCHASE_PRICE-ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+
					(CASE WHEN POST_TAX_SEPARATELY=0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END))*A.QUANTITY)
					 AS SOLD_VAL_ATPP,SUM(ISNULL(FDN_DR.FDN_AMT,0)*A.QUANTITY) AS FDN_DRAMOUNT,
					 SUM(ISNULL(FDN_CR.PRTAMOUNT_CREDITED,0)*A.QUANTITY) AS FDN_CRAMOUNT,
					 SUM(ISNULL(EOSDN_CR.PRTAMOUNT_CREDITED,0)*A.QUANTITY) AS EOSSDN_CRAMOUNT,
					0 AS PROFIT,0 AS CONTR_PCT
					FROM CMD01106 A (NOLOCK) JOIN CMM01106 B  (NOLOCK) ON A.CM_ID=B.CM_ID
					JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
					JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE 
					JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
					JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
					JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
					JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
					JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
					JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
					JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
					JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
					JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=SKU.AC_CODE
					LEFT OUTER JOIN SKU_OH (NOLOCK) ON SKU_OH.PRODUCT_CODE=SKU.PRODUCT_CODE
					JOIN FORM (NOLOCK) ON FORM.FORM_ID=SKU.FORM_ID
					JOIN LOCATION ON LOCATION.DEPT_ID=LEFT(A.CM_ID,2)
					LEFT OUTER JOIN 
					(SELECT RMD.PRODUCT_CODE,SUM(RMD.FDN_RATE) AS FDN_AMT
					 FROM RMD01106 RMD (NOLOCK)
					 JOIN RMM01106 RMM (NOLOCK) ON RMM.RM_ID=RMD.RM_ID
					 JOIN CMD01106 CMD (NOLOCK) ON CMD.PRODUCT_CODE=RMD.PRODUCT_CODE
					 JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=CMD.CM_ID
					 JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=RMD.PRODUCT_CODE
					 JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE 
					 JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
					 JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
					 JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
					 JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
					 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
					 JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
					 JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
					 JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
					 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=SKU.AC_CODE
					 WHERE CMM.FIN_YEAR='''+@CFINYEAR+''' AND CMM.CM_DT<='''+CONVERT(VARCHAR,@DTODATE,112)+''' AND '+@CFILTERCRITERIA+'
					 AND RMM.MODE=1 AND RMM.CANCELLED=0 AND CMM.CANCELLED=0
					 GROUP BY RMD.PRODUCT_CODE
					 ) FDN_DR ON FDN_DR.PRODUCT_CODE=A.PRODUCT_CODE

					LEFT OUTER JOIN 
					(SELECT PID.PRODUCT_CODE,SUM(PID.PRTAMOUNT) AS PRTAMOUNT_CREDITED
					 FROM PID01106 PID (NOLOCK)
					 JOIN PIM01106 PIM (NOLOCK) ON PIM.MRR_ID=PID.MRR_ID
					 JOIN RMM01106 RMM (NOLOCK) ON RMM.REFMEMOID=PIM.MRR_ID
					 JOIN CMD01106 CMD (NOLOCK) ON CMD.PRODUCT_CODE=PID.PRODUCT_CODE
					 JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=CMD.CM_ID
					 JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=PID.PRODUCT_CODE
					 JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE 
					 JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
					 JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
					 JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
					 JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
					 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
					 JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
					 JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
					 JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
					 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=SKU.AC_CODE
					 WHERE CMM.FIN_YEAR='''+@CFINYEAR+''' AND CMM.CM_DT<='''+CONVERT(VARCHAR,@DTODATE,112)+''' AND '+@CFILTERCRITERIA+'
					 AND PIM.INV_MODE=1 AND CMM.CANCELLED=0 AND PIM.CANCELLED=0
					 AND RMM.CANCELLED=0
					 GROUP BY PID.PRODUCT_CODE
					 ) FDN_CR ON FDN_CR.PRODUCT_CODE=A.PRODUCT_CODE 

					LEFT OUTER JOIN 
					(SELECT A.PRODUCT_CODE,SUM(A.DISCOUNT_SHARING_AMOUNT/A.QUANTITY) AS PRTAMOUNT_CREDITED
					 FROM EOSSDND A (NOLOCK)
					 JOIN EOSSDNM B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
					 JOIN CMD01106 CMD (NOLOCK) ON CMD.PRODUCT_CODE=A.PRODUCT_CODE
					 JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=CMD.CM_ID
					 JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
					 JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE 
					 JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
					 JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
					 JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
					 JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
					 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
					 JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
					 JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
					 JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
					 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=SKU.AC_CODE
					 WHERE CMM.FIN_YEAR='''+@CFINYEAR+''' AND CMM.CM_DT<='''+CONVERT(VARCHAR,@DTODATE,112)+''' AND '+@CFILTERCRITERIA+'
					 AND CMM.CANCELLED=0 AND B.CANCELLED=0
					 GROUP BY A.PRODUCT_CODE
					 ) EOSDN_CR ON EOSDN_CR.PRODUCT_CODE=A.PRODUCT_CODE					 
					 					 
					WHERE FIN_YEAR='''+@CFINYEAR+''' AND CM_DT<='''+CONVERT(VARCHAR,@DTODATE,112)+''' AND CANCELLED=0 AND '+@CFILTERCRITERIA+'
					GROUP BY '+@CPARANAME
		PRINT @CCMD
		
		IF @BCALLEDFORGMROI=0
			INSERT DB_PROFIT_CONTR_SUMMARY	( DEPT_ID,SETUP_CODE,PARA_VAL,SOLD_QTY,SOLD_VAL_ATMRP,SOLD_VAL_ATPP,
			FDN_DRAMOUNT,FDN_CRAMOUNT,EOSSDN_CRAMOUNT,PROFIT_AMOUNT,CONTR_PCT )
			EXEC SP_EXECUTESQL @CCMD							
		ELSE
		BEGIN
			INSERT #TMPSUMMARY	(DEPT_ID,SETUP_CODE,PARA_VAL,SOLD_QTY,SOLD_VAL_ATMRP,SOLD_VAL_ATPP,
			FDN_DRAMOUNT,FDN_CRAMOUNT,EOSSDN_CRAMOUNT,PROFIT_AMOUNT,CONTR_PCT )
			EXEC SP_EXECUTESQL @CCMD							
			
			UPDATE #TMPSUMMARY SET  PROFIT_AMOUNT=(SOLD_VAL_ATMRP-SOLD_VAL_ATPP)+
			((FDN_CRAMOUNT-FDN_DRAMOUNT+EOSSDN_CRAMOUNT))
			
			INSERT DB_GMROI_SUMMARY	( DEPT_ID,SETUP_CODE,PARA_VAL,PROFIT_AMOUNT)
			SELECT DEPT_ID,SETUP_CODE,PARA_VAL,PROFIT_AMOUNT FROM #TMPSUMMARY
		END
		DELETE FROM #TMPSETUP WHERE SETUP_CODE=@CSETUPCODE	
	END
	
	IF @BCALLEDFORGMROI=0
	BEGIN
		UPDATE DB_PROFIT_CONTR_SUMMARY SET PROFIT_AMOUNT=(SOLD_VAL_ATMRP-SOLD_VAL_ATPP)+((FDN_CRAMOUNT-FDN_DRAMOUNT+EOSSDN_CRAMOUNT)*SOLD_QTY)
		
		UPDATE A SET CONTR_PCT=(PROFIT_AMOUNT/B.TOTAL_PROFIT_AMOUNT)*100 
		FROM DB_PROFIT_CONTR_SUMMARY A
		JOIN (SELECT DEPT_ID,SETUP_CODE,SUM(PROFIT_AMOUNT) AS TOTAL_PROFIT_AMOUNT FROM DB_PROFIT_CONTR_SUMMARY
			  GROUP BY DEPT_ID,SETUP_CODE) B ON A.DEPT_ID=B.DEPT_ID AND A.SETUP_CODE=B.SETUP_CODE	
	END	  
END
----------- END OF SPDB_PROFIT_CONTRIBUTION_DATA
