CREATE PROCEDURE SP3S_PENDING_WSL_DELIEVERY
(
	 @DFROMDATE DATETIME	  /*ORDERS CONSIDERATION START DATE*/	
	,@DTODATE DATETIME		  /*ORDERS TO BE CONSIDERED TILL DATE*/
	,@CAC_CODE VARCHAR(10)='' /*GET DETAILS FOR A SINGLE CUSTOMER OR ALL CUSTOMER*/
	,@CARTICLE_CODE VARCHAR(10)=''/*GET DETAILS FOR AN ARTICLE OR ALL ARTICLES*/
	,@BSUMMARY BIT=0		  /*GET SUMMARY REPORT (1) OR DETAIL REPORT (0)*/
)
--WITH ENCRYPTION
AS
BEGIN
	IF OBJECT_ID('TEMPDB..#PICKLIST','U') IS NOT NULL
		DROP TABLE #PICKLIST

	---GETTING PICKLIST WISE PICKLIST QUANTITY AND INVOICE QUANTITY
	SELECT PKM.AC_CODE,PKM.PICK_LIST_NO,PKM.PICK_LIST_DT,PKD.ARTICLE_CODE,PKD.PARA1_CODE,PKD.PARA2_CODE
		  ,CAST(SUM(PKD.PICK_LIST_QTY) AS NUMERIC(18,2)) AS PICK_LIST_QTY
		  ,CAST(SUM(ISNULL(PKD.ADD_QTY,0)) AS NUMERIC(18,2)) AS PICK_LIST_ADD_QTY
		  ,CAST(ISNULL(INV.INVOICE_QTY,0) AS NUMERIC(18,2)) AS INVOICE_QTY
		  ,CAST(SUM(PKD.PICK_LIST_QTY+ISNULL(PKD.ADD_QTY,0))-ISNULL(INV.INVOICE_QTY,0) AS NUMERIC(18,2)) AS PENDING_INVOICE_QTY 
		  ,INV_NO,INV_DT
	INTO #PICKLIST
	FROM WSL_PICKLIST_MST PKM (NOLOCK)
	JOIN WSL_PICKLIST_DET PKD (NOLOCK) ON PKM.PICK_LIST_ID=PKD.PICK_LIST_ID
	LEFT JOIN 
	(
		SELECT IND.PICK_LIST_ID,IND.PICKLIST_ARTICLE_CODE,IND.PICKLIST_PARA1_CODE,IND.PICKLIST_PARA2_CODE
		       ,INV_NO,INV_DT
			  ,SUM(IND.QUANTITY) AS INVOICE_QTY	
		FROM INM01106 INM (NOLOCK)
		JOIN IND01106 IND (NOLOCK) ON INM.INV_ID=IND.INV_ID
		WHERE INM.CANCELLED=0 AND ISNULL(IND.PICK_LIST_ID,'')<>'' AND (@CAC_CODE='' OR INM.AC_CODE=@CAC_CODE)
		GROUP BY IND.PICK_LIST_ID,IND.PICKLIST_ARTICLE_CODE,IND.PICKLIST_PARA1_CODE,IND.PICKLIST_PARA2_CODE,INV_NO,INV_DT
		
	)INV ON PKD.PICK_LIST_ID=INV.PICK_LIST_ID AND PKD.ARTICLE_CODE=INV.PICKLIST_ARTICLE_CODE AND
			PKD.PARA1_CODE=INV.PICKLIST_PARA1_CODE AND PKD.PARA2_CODE=INV.PICKLIST_PARA2_CODE
	WHERE PKM.CANCELLED=0 AND (@CAC_CODE='' OR PKM.AC_CODE=@CAC_CODE)
	AND (@CARTICLE_CODE='' OR PKD.ARTICLE_CODE=@CARTICLE_CODE)
	AND PKM.PICK_LIST_DT BETWEEN @DFROMDATE AND @DTODATE
	GROUP BY PKM.AC_CODE,PKM.PICK_LIST_NO,PKM.PICK_LIST_DT,PKD.ARTICLE_CODE,PKD.PARA1_CODE,PKD.PARA2_CODE,ISNULL(INV.INVOICE_QTY,0)
	         ,INV_NO,INV_DT
	
	IF @BSUMMARY=0
	BEGIN
		--GET THE DETAILED REPORT
		SELECT LM.AC_NAME AS CUSTOMER_NAME,A.PICK_LIST_NO,CONVERT(VARCHAR(10),A.PICK_LIST_DT,105) AS PICK_LIST_DT,ART.ARTICLE_NO,P1.PARA1_NAME AS COLOR
			  ,P2.PARA2_NAME AS SIZE,A.PICK_LIST_QTY,A.PICK_LIST_ADD_QTY,
			  CAST(ISNULL(A.PICK_LIST_QTY,0)+ISNULL(A.PICK_LIST_ADD_QTY,0) AS NUMERIC(18,2)) AS PICK_LIST_TOTAL_QTY,
			  A.INVOICE_QTY,A.PENDING_INVOICE_QTY,
			  ISNULL(INV_NO,'') AS INV_NO 
			  ,CASE WHEN INV_DT IS NULL THEN '' ELSE CONVERT(VARCHAR,INV_DT ,105) END AS INV_DT
		FROM #PICKLIST A
		JOIN ARTICLE ART (NOLOCK) ON A.ARTICLE_CODE=ART.ARTICLE_CODE
		JOIN PARA1 P1(NOLOCK) ON A.PARA1_CODE=P1.PARA1_CODE
		JOIN PARA2 P2(NOLOCK) ON A.PARA2_CODE=P2.PARA2_CODE
		JOIN LM01106 LM(NOLOCK) ON A.AC_CODE=LM.AC_CODE
		WHERE PENDING_INVOICE_QTY>0
		ORDER BY CUSTOMER_NAME,PICK_LIST_DT,PICK_LIST_NO,ARTICLE_NO,COLOR,SIZE
	END
	
	--DROPPING TEMP TABLE AFTER RETURNING THE RESULTSET
	IF OBJECT_ID('TEMPDB..#PICKLIST','U') IS NOT NULL
		DROP TABLE #PICKLIST
END
--END OF PROCEDURE - SP3S_PENDING_WSL_DELIEVERY
