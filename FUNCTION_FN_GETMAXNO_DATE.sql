

-- FUNCTION TO GET MAX NO. IN A TRANSACTION FOR A GIVEN COMBINATION OF DATE & MEMO PREFIX
CREATE FUNCTION FN_GETMAXNO_DATE (@DMEMODT DATETIME,@NMEMOPREFIXLEN INT,@CMEMOPREFIX VARCHAR(10),@CFINYEAR VARCHAR(10),@CXNID VARCHAR(40))
RETURNS VARCHAR(20) 
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CMAXBILLNO VARCHAR(20),@DPREVMEMODT DATETIME
	
	SELECT @CMAXBILLNO=MAX(CM_NO) FROM CMM01106 (NOLOCK) 
	WHERE CM_DT=@DMEMODT AND LEFT(CM_NO,@NMEMOPREFIXLEN)=@CMEMOPREFIX AND CANCELLED=0
	AND CM_ID<>@CXNID
	
	IF ISNULL(@CMAXBILLNO,'')=''
	BEGIN
		SELECT TOP 1 @DPREVMEMODT=CM_DT FROM CMM01106 (NOLOCK) WHERE LEFT(CM_NO,@NMEMOPREFIXLEN)=@CMEMOPREFIX
		AND CM_DT<@DMEMODT AND CANCELLED=0 AND FIN_YEAR=@CFINYEAR ORDER BY CM_DT DESC
		
		SELECT @CMAXBILLNO=MAX(CM_NO) FROM CMM01106 (NOLOCK) 
		WHERE CM_DT=@DPREVMEMODT AND LEFT(CM_NO,@NMEMOPREFIXLEN)=@CMEMOPREFIX AND CANCELLED=0
	END	
	
	RETURN ISNULL(@CMAXBILLNO,'')
END
