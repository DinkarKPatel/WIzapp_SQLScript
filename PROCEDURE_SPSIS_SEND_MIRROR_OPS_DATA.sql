create PROCEDURE SPSIS_SEND_MIRROR_OPS_DATA
(
 @CPANNO VARCHAR(10)='SOFTINFOSY',
 @CSIS_LINK_LOCATION VARCHAR(100)
)
AS
BEGIN

BEGIN TRY

	DECLARE @cCmd NVARCHAR(MAX),@cStep VARCHAR(6),@CERRMSG VARCHAR(1000) 

    SET @CERRMSG=''
	SET @cStep='10'
    

	DECLARE @DCUTOFFDATE DATETIME,@CSIS_HO_ID VARCHAR(5),@CHODEPT_ID varchar(5)
		SET @DCUTOFFDATE=''


	SELECT @CHODEPT_ID=value  FROM CONFIG WHERE CONFIG_OPTION ='HO_LOCATION_ID'

		DECLARE @TBLXNDETAILS TABLE (XN_TYPE VARCHAR(30),XN_ID VARCHAR(50),TABLENAME VARCHAR(100),
		LASTUPDATE DATETIME,SEND_ORDER NUMERIC(5,0) ,COLUMNNAME VARCHAR(50))

		SELECT @DCUTOFFDATE=Cutoff_date,@CSIS_HO_ID=SIS_HO_ID  FROM SISLOCATIONDETAILS A
		WHERE PAN_NO=@CPANNO AND SIS_LINK_LOCATION=@CSIS_LINK_LOCATION

		

	
	CREATE TABLE  #PMTXNSUPD1(dept_id CHAR(5), product_code varchar(50), CBSQty numeric(10,2))
	 declare @locholist varchar(100)
	 set @locholist=''

	if @CHODEPT_ID=@CSIS_LINK_LOCATION
	begin
	     

			SELECT @locholist=isnull(@locholist+',','')+ ''''+ A.DEPT_ID +'''' 
			FROM LOCATION A (NOLOCK)
			LEFT JOIN SISLOCATIONDETAILS SL (NOLOCK)  ON SL.SIS_LINK_LOCATION=A.DEPT_ID
			WHERE SL.SIS_LINK_LOCATION IS NULL

			

	end

	
	
	IF NOT EXISTS (SELECT TOP 1 'U' FROM SIS_OPS WHERE PAN_NO=@CPANNO AND DEPT_ID =@CSIS_HO_ID)
	BEGIN

		SET @cStep='20'
		SET @cCmd=N'
		;WITH OPS
		AS
		(
			select '''+@CSIS_HO_ID+''' AS dept_id, CASE WHEN ISNULL(C.VENDOR_EAN_NO,'''') <> '''' THEN C.VENDOR_EAN_NO ELSE  A.PRODUCT_CODE END as PRODUCT_CODE, 
			  sum(case when a.xn_type in (''PFI'', ''WSR'', ''APR'', ''CHI'', ''WPR'', ''OPS'', ''DCI'', ''SCF'', ''PUR'', ''UNC'', ''SLR'',
			''JWR'',''DNPR'',''TTM'',''API'',''PRD'', ''PFG'', ''BCG'',''MRP'',''PSB'',''JWR'',''MIR'',''GRNPSIN'',''MAQ'',''OLOAQ'') 
			then 1 else -1 end * xn_qty) CBSQty
			from '+db_name()+'.dbo.VW_XNSREPS_new a (nolock) 
			JOIN SKU C (NOLOCK) ON C.PRODUCT_CODE=a.PRODUCT_CODE
			JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =C.AC_CODE
			WHERE SUBSTRING(LMP.AC_GST_NO,3,10)='''+@CPANNO+'''
			AND A.DEPT_ID in('''+@CSIS_LINK_LOCATION+''''+@locholist+')
			AND  a.xn_type not in (''TRI'', ''TRO'') 
			AND a.BIN_ID <>''999''
			AND a.XN_DT<'''+CONVERT(VARCHAR(20),@DCUTOFFDATE,110)+'''
			group by CASE WHEN ISNULL(C.VENDOR_EAN_NO,'''') <> '''' THEN C.VENDOR_EAN_NO ELSE  A.PRODUCT_CODE END
			having sum(case when xn_type in (''PFI'', ''WSR'', ''APR'', ''CHI'', ''WPR'', ''OPS'', ''DCI'', ''SCF'', ''PUR'', ''UNC'', ''SLR'',
			''JWR'',''DNPR'',''TTM'',''API'',''PRD'', ''PFG'', ''BCG'',''MRP'',''PSB'',''JWR'',''MIR'',''GRNPSIN'',''MAQ'',''OLOAQ'') 
			then 1 else -1 end * xn_qty)<>0
		)
		SELECT A.dept_id,A.product_code,A.cbsqty FROM OPS A
		LEFT OUTER JOIN SIS_OPS B (NOLOCK) ON B.PRODUCT_CODE=A.PRODUCT_CODE AND B.PAN_NO='''+@CPANNO+'''  AND b.DEPT_ID='''+@CSIS_LINK_LOCATION+'''
		WHERE (B.PRODUCT_CODE IS NULL OR (ISNULL(B.XN_Qty,0)<>ISNULL(A.CBSQty,0)))
		'
		PRINT @cCmd
  

		INSERT INTO #PMTXNSUPD1 (dept_id,product_code,cbsqty)
		EXEC SP_EXECUTESQL @cCmd

	end
	

	--SELECT distinct 'SIS_SKUNAMES_UPLOAD' as TARGET_TABLENAME ,a.article_no,
	--         LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))as PRODUCT_CODE,a.ARTICLE_NO,a.PARA3_NAME,a.PARA2_NAME,
	--		 b.dept_id as ops_memo_id
	--FROM SKU_NAMES A (NOLOCK)
	--JOIN #PMTXNSUPD1 B ON A.PRODUCT_CODE=B.PRODUCT_CODE




END TRY
BEGIN CATCH
	SET @CERRMSG=ERROR_MESSAGE()
END CATCH
	IF ISNULL(@CERRMSG,'')<>''
	BEGIN
		SELECT ISNULL(@CERRMSG,'') AS ERRMSG
	END
	ELSE
	BEGIN
		IF (SELECT COUNT(*) FROM #PMTXNSUPD1)>0 
		BEGIN
			DELETE SIS_OPS WHERE PAN_NO=@CPANNO AND DEPT_ID =@CSIS_HO_ID

			INSERT INTO SIS_OPS(DEPT_ID,PRODUCT_CODE,XN_QTY,PAN_NO,XN_DT)
			SELECT DEPT_ID,PRODUCT_CODE,cbsqty,@CPANNO AS PAN_NO,@DCUTOFFDATE-1 AS XN_DT
			FROM #PMTXNSUPD1

			SELECT * FROM SIS_OPS  WHERE PAN_NO=@CPANNO AND DEPT_ID =@CSIS_HO_ID
		END
		ELSE
		BEGIN
			SELECT * FROM SIS_OPS WHERE 1=2
		END
	END
END

