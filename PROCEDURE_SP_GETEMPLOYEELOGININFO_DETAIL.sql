CREATE PROCEDURE SP_GETEMPLOYEELOGININFO_DETAIL    
@CEMPID CHAR(7),          
@DFRMDT DATETIME,          
@DTODT DATETIME,    
@LOCATION VARCHAR(50),    
@STATUS VARCHAR(40)    
AS          
BEGIN        
    
DECLARE @QUERY NVARCHAR(MAX)  
DECLARE @FILTER NVARCHAR(200)

SET @CEMPID =LTRIM(RTRIM(@CEMPID))  
SET @FILTER=''
  
SET @QUERY = N' SELECT * FROM     
   (      
    SELECT B.DEPT_ID,B.EMP_FNAME + '' '' + B.EMP_LNAME AS EMP_NAME,CONVERT(VARCHAR(25),A.ATTENDANCE_DT,105) AS ATTENDANCE_DT,          
    DATENAME(DW,A.ATTENDANCE_DT) AS DAY_NAME,(CASE WHEN TIME_IN<>'''' THEN (LTRIM(RIGHT(CONVERT(CHAR(19),TIME_IN,100),7)))        
    ELSE '''' END) AS TIME_IN,          
    A.REMARKS_IN,(CASE WHEN TIME_OUT<>'''' THEN (LTRIM(RIGHT(CONVERT(CHAR(19),TIME_OUT,100),7))) ELSE '''' END) AS TIME_OUT,      
    A.REMARKS_OUT,        
    (CASE WHEN (TIME_IN>E.SHIFT_TIME_IN OR TIME_OUT < E.SHIFT_TIME_OUT) AND TIME_IN <> '''' AND TIME_OUT <> ''''         
    THEN ''LATE'' WHEN TIME_IN='''' AND TIME_OUT = '''' THEN ''''         
    WHEN TIME_IN ='''' OR TIME_OUT='''' THEN ''INCOMPLETE'' ELSE ''IN TIME'' END) AS REMARKS        
    , E.SHIFT_NAME,      
    DBO.FN_GETEMP_ATDSTATUS(B.EMP_ID,ATTENDANCE_DT,LOG_ABSENT_STATUS,E.SHIFT_TIME_IN,    
    E.SHIFT_TIME_OUT,A.TIME_IN,A.TIME_OUT,E.EARLY_CUTOFF,E.LATE_CUTOFF,E.HALFDAY_CUTOFF,    
     B.WEEKLY_OFF1) AS ATT_STATUS  ,L.DEPT_NAME ,B.REF_ID        
    FROM EMP_MST B JOIN EMP_ATTENDANCE A ON A.EMP_ID = B.EMP_ID         
    JOIN EMP_SHIFTS E ON  E.SHIFT_ID=A.SHIFT_ID       
    JOIN LOCATION L ON B.DEPT_ID= L.DEPT_ID     
    WHERE   
     A.ATTENDANCE_DT BETWEEN '''+CONVERT(VARCHAR,@DFRMDT,101)+''' AND '''+CONVERT(VARCHAR,@DTODT,101)+''''  

IF ISNULL(@CEMPID,'')<>''  
BEGIN
 SET @QUERY = @QUERY + ' AND ( B.REF_ID =  '''+@CEMPID+'''  OR B.EMP_ID='''+@CEMPID+''')'   
END
 
SET @QUERY = @QUERY + ') XX '  

IF ISNULL(RTRIM(LTRIM(@STATUS)),'')<>''
 SET @FILTER = ' (XX.ATT_STATUS IN ('+@STATUS+')) '  
ELSE
	PRINT 'NULL STATUS'
  
IF ISNULL(RTRIM(LTRIM(@LOCATION)),'')<>''
BEGIN  
	IF LEN(RTRIM(LTRIM(@FILTER)))>0 
		SET @FILTER = @FILTER + ' AND '  
	ELSE
		PRINT 'NULL FILTER'
	
	SET @FILTER = @FILTER + ' (XX.DEPT_ID='''+@LOCATION+''') '
	 
END   
ELSE
	PRINT 'NULL LOCATION FILTER'
 
IF LEN(RTRIM(LTRIM(@FILTER)))>0  
 SET @QUERY = @QUERY + ' WHERE ' + @FILTER  
ELSE
	PRINT 'NULL LAST FILTER'
	
SET @QUERY = @QUERY + ' ORDER BY XX.DEPT_NAME ASC,XX.ATTENDANCE_DT ASC '  

--PRINT @QUERY   
  
EXEC SP_EXECUTESQL @QUERY    
END
