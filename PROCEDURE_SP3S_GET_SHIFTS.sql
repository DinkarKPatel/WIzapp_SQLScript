CREATE PROCEDURE SP3S_GET_SHIFTS  
(  
  @CUSER_CODE CHAR(7)  
 ,@DDATE DATETIME   
 ,@cLoc VARCHAR(5)=''  
)  
--WITH ENCRYPTION   
AS   
BEGIN  
/*  
 THIS PROCEDURE RETURNS ALL THE SHIFTS FOR TILLS THAT THE USER HAS ACCESS TO FOR A SPECIFIC DATE.  
  
*/  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 --GETTING LIST OF TILLS THE USER HAS ACCESS TO  
 IF OBJECT_ID('TEMPDB..#USERTILLS','U') IS NOT NULL  
    DROP TABLE #USERTILLS  
   
  SELECT TILL_ID INTO #USERTILLS FROM TILL_USERS 
  WHERE (USER_CODE=@CUSER_CODE OR  @CUSER_CODE='0000000')
   
 --RETURNING ALL SHIFTS FOR THE TILLS AT A GIVEN DATE.  
 IF @CLOC=''  
  SELECT A.SHIFT_ID   
  FROM TILL_SHIFT_MST A  
  JOIN #USERTILLS B ON A.TILL_ID=B.TILL_ID  
  WHERE A.OPEN_DATE>=@DDATE  
  ORDER BY A.SHIFT_ID  
 ELSE  
  SELECT A.SHIFT_ID   
  FROM TILL_SHIFT_MST A  
  JOIN #USERTILLS B ON A.TILL_ID=B.TILL_ID  
  WHERE A.OPEN_DATE>=@DDATE AND A.location_code=@cLoc  
  ORDER BY A.SHIFT_ID  
END  
--END OF PROCEDURE - SP3S_GET_SHIFTS  