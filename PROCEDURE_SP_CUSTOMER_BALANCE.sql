CREATE  PROCEDURE  SP_CUSTOMER_BALANCE
@CCUSTCODE	VARCHAR(100)   
--WITH ENCRYPTION

AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 
	DECLARE @NTOTAL NUMERIC(20,2)
	DECLARE @TTABLE TABLE 
	(
		[XN_TYPE]		VARCHAR(100),
		[MEMO_NO]		VARCHAR(50),
		[MEMO_ID]		VARCHAR(100),
		[MEMO_DT]		DATETIME,
		[CR_AMT]		NUMERIC(20,2),
		[DR_AMT]		NUMERIC(20,2),
		[NET]			NUMERIC(20,2)
	)
	INSERT INTO @TTABLE ([XN_TYPE],	[MEMO_NO],[MEMO_ID],[MEMO_DT],[CR_AMT],[DR_AMT],[NET]	)
	SELECT CAPTION,XN_NO,XN_ID,XN_DT,CR_AMOUNT,DR_AMOUNT,0
	FROM 
	(
	SELECT  A.CUSTOMER_CODE, A.USER_CUSTOMER_CODE, A.CUSTOMER_TITLE, A.CUSTOMER_FNAME, A.CUSTOMER_LNAME,    
	  'OPS' AS XN_TYPE,     
	  '' AS XN_NO, '' AS XN_ID, '' AS XN_DT,     
	  ( CASE WHEN A.OPENING_BALANCE > 0 THEN A.OPENING_BALANCE ELSE 0 END ) AS DR_AMOUNT,     
	  ( CASE WHEN A.OPENING_BALANCE < 0 THEN ABS(A.OPENING_BALANCE) ELSE 0 END ) AS CR_AMOUNT,     
	  LOCATION_ID  AS DEPT_ID,     
	  '' AS ADJ_BILL_NO,     
	  CAST('' AS VARCHAR(50)) AS EMP_NAME,    
	  'OPENING BALANCE ' + CAST( ABS(A.OPENING_BALANCE) AS VARCHAR(20) ) AS NARRATION,0 AS MEMO_TYPE 
	  ,'OPENING BALANCE' AS CAPTION  
	FROM CUSTDYM A    
	WHERE A.OPENING_BALANCE <> 0    
	AND A.CUSTOMER_CODE = @CCUSTCODE    
	    
	-- SALE ON CREDIT    
	UNION ALL    
	SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,    
	  ( CASE WHEN PAY.CREDIT_AMOUNT>0 THEN 'SLS' ELSE     
		  ( CASE WHEN SUBSTRING(A.CM_NO,LEN(A.LOCATION_CODE)+3,1)='N' THEN 'CNI' ELSE 'SLR' END ) END ) AS XN_TYPE,     
	  A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT,     
	  ( CASE WHEN (PAY.CREDIT_AMOUNT) > 0 THEN (PAY.CREDIT_AMOUNT+PAY.ADVANCE_AMOUNT_ADJUSTED) ELSE 0 END ) AS DR_AMOUNT,     
	( CASE WHEN (PAY.CREDIT_AMOUNT+PAY.ADVANCE_AMOUNT_ADJUSTED+PAY.CREDIT_REFUND_AMOUNT) < 0
	 THEN ABS((PAY.CREDIT_AMOUNT+PAY.ADVANCE_AMOUNT_ADJUSTED+PAY.CREDIT_REFUND_AMOUNT)) ELSE 0 END ) AS CR_AMOUNT,                   
	  A.location_Code  AS DEPT_ID,     
	  '' AS ADJ_BILL_NO,     
	  '' AS EMP_NAME, -- ISNULL(EMP.EMP_NAME,'') AS EMP_NAME,    
	  'BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.NET_AMOUNT AS VARCHAR(20) ) AS NARRATION,  
	  A.MEMO_TYPE  ,'SALE' AS CAPTION  
	  
	FROM CMM01106 A    
	JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE  
	JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'SLS'  
	WHERE ((PAY.CREDIT_AMOUNT+PAY.ADVANCE_AMOUNT_ADJUSTED+PAY.CREDIT_REFUND_AMOUNT)  <> 0) AND A.CM_MODE = 1 --AND A.REF_CM_ID = ''    
	AND A.CANCELLED = 0 AND A.CUSTOMER_CODE = @CCUSTCODE    
	    
	-- ADVANCE ADJUSTMENT    
	UNION ALL    
		 SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,    
		'ADJ' AS XN_TYPE,     
		A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT,     
		0 AS DR_AMOUNT,    
		(ORD.TOTAL_AMOUNT) AS CR_AMOUNT,     
		A.location_Code  AS DEPT_ID,     
		'' AS ADJ_BILL_NO,     
		'' AS EMP_NAME, -- ISNULL(EMP.EMP_NAME,'') AS EMP_NAME,    
		'ADVANCE ADJ IN BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' + CAST( ORD.TOTAL_AMOUNT AS VARCHAR(20) ) AS NARRATION,  
		A.MEMO_TYPE ,'ORDER ADJ. ' AS CAPTION 
		FROM CMM01106 A    
		JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE 
		JOIN CMD01106 AS CD ON A.CM_ID= CD.CM_ID 
		JOIN 
		(
		 SELECT B.ORDER_TYPE,A.CUSTOMER_CODE,B.PRODUCT_CODE,REF_PRODUCT_CODE,
		        TOTAL_AMOUNT 
				 
				 FROM WSL_ORDER_MST A (NOLOCK)
				 JOIN WSL_ORDER_DET B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID
				 WHERE A.CANCELLED=0 AND ISNULL(B.CANCELLED,0)=0
		
		) ORD ON ORD.CUSTOMER_CODE=A.CUSTOMER_CODE
		  AND CD.PRODUCT_CODE=CASE WHEN ORD.ORDER_TYPE =1 THEN ORD.REF_PRODUCT_CODE ELSE ORD.PRODUCT_CODE END
		WHERE A.CM_MODE = 1 --AND A.REF_CM_ID = ''    
		AND A.CANCELLED = 0 AND A.CUSTOMER_CODE = @CCUSTCODE      
	    
	-- CREDIT NOTE ADJUSTMENT    
	UNION ALL    
	SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,    
	  'CNA' AS XN_TYPE,     
	  A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT,     
	  PAY.CN_AMOUNT AS DR_AMOUNT,     
	  0 AS CR_AMOUNT,     
	  A.location_Code  AS DEPT_ID,     
	  '' AS ADJ_BILL_NO,     
	  '' AS EMP_NAME, -- ISNULL(EMP.EMP_NAME,'') AS EMP_NAME,    
	  'CN ADJ IN BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' + CAST( PAY.CN_AMOUNT AS VARCHAR(20) ) AS NARRATION,  
	  A.MEMO_TYPE    ,'CREDIT NOTE ADJUSTMENT' AS CAPTION   
	FROM CMM01106 A    
	JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE    
	JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'SLS'  
	WHERE PAY.CN_AMOUNT > 0 AND A.CM_MODE = 1 --AND A.REF_CM_ID = ''    
	AND A.CANCELLED = 0 AND A.CUSTOMER_CODE  = @CCUSTCODE    
	UNION ALL    
	SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,    
	  'REC' AS XN_TYPE,     
	  A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,    
	  0 AS DR_AMOUNT,     
	  A.AMOUNT AS CR_AMOUNT,     
	  A.location_Code  AS DEPT_ID,     
	  --A.ADJ_BILL_NO AS ADJ_BILL_NO,     
	  '' AS ADJ_BILL_NO,  
	  CAST('' AS VARCHAR(50)) AS EMP_NAME,    
	  'RECEIPT# ' + A.ADV_REC_NO + ' DATED: ' + CAST(A.ADV_REC_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.AMOUNT AS VARCHAR(20) ) AS NARRATION,  
	  0 AS MEMO_TYPE   ,'RECEIPT' AS CAPTION 
	FROM ARC01106 A    
	JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE   
	LEFT OUTER JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.ADV_REC_ID AND PAY.XN_TYPE = 'ARC'  
	   
	WHERE A.AMOUNT <> 0     
	AND A.ARC_TYPE =1 AND A.ARCT IN (1,2)    
	AND A.CANCELLED = 0 AND A.CUSTOMER_CODE = @CCUSTCODE   
	-- AND A.ARCT<>3   -- ( A.ARCT=2 OR ( A.ARCT=1 AND A.ADJ_BILL_ID <> '') )    
	--AND ISNULL(A.REF_XN_TYPE,'') <> 'SOM'    
	UNION ALL    
	SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,    
	  'CNA' AS XN_TYPE,     
	  A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,    
	  (CASE WHEN A.ARC_TYPE=1 THEN PAY.CN_AMOUNT ELSE 0 END) AS DR_AMOUNT,     
	  (CASE WHEN A.ARC_TYPE=2 THEN PAY.CN_AMOUNT ELSE 0 END) AS CR_AMOUNT,     
	  A.location_Code  AS DEPT_ID,     
	  --A.ADJ_BILL_NO AS ADJ_BILL_NO,    
	  '' AS ADJ_BILL_NO,   
	  CAST('' AS VARCHAR(50)) AS EMP_NAME,    
	  'C/N ADJ IN RECEIPT# ' + A.ADV_REC_NO + ' DATED: ' + CAST(A.ADV_REC_DT AS VARCHAR(50)) + ' AMT: ' + CAST( PAY.CN_AMOUNT AS VARCHAR(20) ) AS NARRATION    
	  ,0 AS MEMO_TYPE ,'CREDIT NOTE ADJUSTED IN RECEIPT' AS CAPTION 
	FROM ARC01106 A    
	JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE   
	JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'ARC'   
	WHERE PAY.CN_AMOUNT <> 0     
	AND A.CANCELLED = 0 AND A.CUSTOMER_CODE  = @CCUSTCODE    
	-- AND A.ARCT<>3   -- ( A.ARCT=2 OR ( A.ARCT=1 AND A.ADJ_BILL_ID <> '') )    
	AND ISNULL(A.REF_XN_TYPE,'') <> 'SOM'    
	UNION ALL    
	SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,    
	  'PAY' AS XN_TYPE,     
	  A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,    
	  A.NET_AMOUNT AS DR_AMOUNT,     
	  0 AS CR_AMOUNT,     
	  A.location_Code  AS DEPT_ID,     
	  --A.ADJ_BILL_NO AS ADJ_BILL_NO,     
	  '' AS ADJ_BILL_NO,  
	  CAST('' AS VARCHAR(50)) AS EMP_NAME,    
	  'PAYMENT# ' + A.ADV_REC_NO + ' DATED: ' + CAST(A.ADV_REC_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.AMOUNT AS VARCHAR(20) ) AS NARRATION    
	  ,0 AS MEMO_TYPE  ,'PAYMENT AGAINST BILL' AS CAPTION  
	FROM ARC01106 A    
	JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE    
	WHERE A.AMOUNT <> 0     
	AND A.ARC_TYPE =2     
	AND A.CANCELLED = 0 AND A.CUSTOMER_CODE  = @CCUSTCODE    
	  
	-- WHOLESALE  
	UNION ALL    
	SELECT A.AC_CODE AS CUSTOMER_CODE, A.AC_CODE AS USER_CUSTOMER_CODE, '' AS CUSTOMER_TITLE,   
	  B.AC_NAME AS CUSTOMER_FNAME, '' AS CUSTOMER_LNAME,    
	  'WSL' AS XN_TYPE, A.INV_NO AS XN_NO, A.INV_ID AS XN_ID, A.INV_DT AS XN_DT,     
	  ( CASE WHEN (PAY.CREDIT_AMOUNT) > 0 THEN (PAY.CREDIT_AMOUNT) ELSE 0 END ) AS DR_AMOUNT,     
	  0 AS CR_AMOUNT,     
	  A.location_Code  AS DEPT_ID,     
	  '' AS ADJ_BILL_NO,     
	  '' AS EMP_NAME, -- ISNULL(EMP.EMP_NAME,'') AS EMP_NAME,    
	  'BILL# ' + A.INV_NO + ' DATED: ' + CAST(A.INV_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.NET_AMOUNT AS VARCHAR(20) ) AS NARRATION,  
	  A.MEMO_TYPE ,'WHOLE SALE' AS CAPTION 
	FROM INM01106 A    
	JOIN LM01106 B ON A.AC_CODE = B.AC_CODE  
	JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.INV_ID AND PAY.XN_TYPE = 'WSL'  
	WHERE INV_MODE=1 AND PAY.XN_TYPE='WSL' AND A.CANCELLED=0  AND A.AC_CODE= @CCUSTCODE
	  
	-- WHOLE SALE RETURN  
	UNION ALL  
	SELECT A.AC_CODE AS CUSTOMER_CODE, A.AC_CODE AS USER_CUSTOMER_CODE, '' AS CUSTOMER_TITLE,   
	  B.AC_NAME AS CUSTOMER_FNAME, '' AS CUSTOMER_LNAME,    
	  'WSR' AS XN_TYPE, A.CN_NO AS XN_NO, A.CN_ID AS XN_ID, A.CN_DT AS XN_DT,     
	  0 AS DR_AMOUNT,     
	  A.TOTAL_AMOUNT AS CR_AMOUNT,     
	  A.location_Code  AS DEPT_ID,     
	  '' AS ADJ_BILL_NO,     
	  '' AS EMP_NAME, -- ISNULL(EMP.EMP_NAME,'') AS EMP_NAME,    
	  'BILL# ' + A.CN_NO + ' DATED: ' + CAST(A.CN_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.TOTAL_AMOUNT AS VARCHAR(20) ) AS NARRATION,  
	  A.MEMO_TYPE  ,'WHOLESALE RETURN' AS CAPTION  
	FROM CNM01106 A    
	JOIN LM01106 B ON A.AC_CODE = B.AC_CODE  
	WHERE A.MODE=1 AND A.CANCELLED=0  AND A.AC_CODE = @CCUSTCODE
	  
	-------RECEIPT AGAINST WSL   
	  
	UNION ALL  
	SELECT A.AC_CODE AS CUSTOMER_CODE, A.AC_CODE AS USER_CUSTOMER_CODE, '' AS CUSTOMER_TITLE,   
	B.AC_NAME AS CUSTOMER_FNAME, '' AS CUSTOMER_LNAME,    
	  'REC' AS XN_TYPE,     
	  A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,    
	  0 AS DR_AMOUNT,     
	  A.AMOUNT AS CR_AMOUNT,     
	  A.location_Code  AS DEPT_ID,     
	  --A.ADJ_BILL_NO AS ADJ_BILL_NO,     
	  '' AS ADJ_BILL_NO,  
	  CAST('' AS VARCHAR(50)) AS EMP_NAME,    
	  'RECEIPT# ' + A.ADV_REC_NO + ' DATED: ' + CAST(A.ADV_REC_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.AMOUNT AS VARCHAR(20) ) AS NARRATION,  
	  0 AS MEMO_TYPE   ,'RECEIPT FROM LEDGER' AS CAPTION 
	FROM ARC01106 A    
	JOIN LM01106 B ON A.AC_CODE = B.AC_CODE   
	LEFT OUTER JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.ADV_REC_ID AND PAY.XN_TYPE = 'ARC'  
	WHERE A.PARTY_TYPE=2 AND A.CANCELLED =0   AND A.AC_CODE = @CCUSTCODE
	
	-- BUYERS ORDER
 
	UNION ALL
	 
	SELECT	A.CUSTOMER_CODE, C.USER_CUSTOMER_CODE, C.CUSTOMER_TITLE, C.CUSTOMER_FNAME, C.CUSTOMER_LNAME,
			'WOD' AS XN_TYPE, 
			A.ORDER_NO AS XN_NO, A.ORDER_ID AS XN_ID, A.ORDER_DT AS XN_DT, 
			A.TOTAL_AMOUNT AS DR_AMOUNT, 
			0 AS CR_AMOUNT, 
			A.location_Code  AS DEPT_ID, 
			 '' AS ADJ_BILL_NO, 
			CAST('' AS VARCHAR(50)) AS EMP_NAME,
			'BUYERS ORDER # ' + A.ORDER_NO + ' DATED: ' + CAST(A.ORDER_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.TOTAL_AMOUNT AS VARCHAR(20) ) AS NARRATION,
			 0 AS MEMO_TYPE,'BUYERS ORDER' AS CAPTION 
	FROM WSL_ORDER_MST A
	JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
	WHERE A.TOTAL_AMOUNT <> 0
	AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000'  AND A.APPROVED=1 AND A.CUSTOMER_CODE=@CCUSTCODE

	-- DELIVERY OF BUYERS ITEMS IN CASHMEMO
	UNION ALL
	
	SELECT A.CUSTOMER_CODE, D.USER_CUSTOMER_CODE, D.CUSTOMER_TITLE, D.CUSTOMER_FNAME, D.CUSTOMER_LNAME,
			'WLD' AS XN_TYPE,
			A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT, 
			SUM(B.RFNET) AS DR_AMOUNT,
			0 AS CR_AMOUNT,
			A.location_Code  AS DEPT_ID, 
			 '' AS ADJ_BILL_NO, 
			'' AS EMP_NAME,
			'WLD DELIVERY IN BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' + CAST( SUM(B.MRP*B.QUANTITY) AS VARCHAR(20) ) AS NARRATION,
			 0 AS MEMO_TYPE,'BUYERS ORDER DELV' AS CAPTION 
	FROM CMM01106 A
	JOIN CMD01106 B (NOLOCK) ON A.CM_ID = B.CM_ID
	JOIN SKU_BO C  (NOLOCK) ON B.PRODUCT_CODE = C.PRODUCT_CODE
	JOIN CUSTDYM D  (NOLOCK) ON A.CUSTOMER_CODE = D.CUSTOMER_CODE
	WHERE A.CM_MODE = 1 
	AND A.CANCELLED = 0 
	AND A.CUSTOMER_CODE = @CCUSTCODE
	GROUP BY A.CUSTOMER_CODE, D.USER_CUSTOMER_CODE, D.CUSTOMER_TITLE, D.CUSTOMER_FNAME, D.CUSTOMER_LNAME,
			 A.CM_NO, A.CM_ID, A.CM_DT, A.location_Code 
 
  )A ORDER BY XN_DT   

  
  DECLARE @NCUMMULATIVE NUMERIC(14,2),@NBILL NUMERIC(14,2),@NADJ NUMERIC(14,2),@CMEMO VARCHAR(50),
		  @CXNTYPE VARCHAR(MAX),@DTXNDT DATETIME
	SET @NCUMMULATIVE=0

	BEGIN TRY
		DECLARE ABC CURSOR 
		FOR 
		SELECT CR_AMT,DR_AMT,MEMO_ID,XN_TYPE,MEMO_DT FROM @TTABLE
	END TRY
	BEGIN CATCH
		CLOSE ABC
		DEALLOCATE ABC
		DECLARE ABC CURSOR 
		FOR 
		SELECT CR_AMT,DR_AMT,MEMO_ID,XN_TYPE,MEMO_DT FROM @TTABLE
	END CATCH

	OPEN ABC

	FETCH NEXT FROM ABC INTO @NBILL ,@NADJ ,@CMEMO,@CXNTYPE,@DTXNDT
	WHILE @@FETCH_STATUS=0
	BEGIN

	SET @NCUMMULATIVE=@NCUMMULATIVE -(CASE WHEN @NBILL<>0 THEN -1 * @NBILL ELSE @NADJ END)
	UPDATE @TTABLE SET NET=@NCUMMULATIVE WHERE MEMO_ID=@CMEMO AND XN_TYPE=@CXNTYPE AND MEMO_DT=@DTXNDT
	FETCH NEXT FROM ABC INTO @NBILL ,@NADJ ,@CMEMO,@CXNTYPE,@DTXNDT
	END
	CLOSE ABC
	DEALLOCATE ABC


	INSERT INTO @TTABLE ([XN_TYPE],	[MEMO_NO],[MEMO_ID],[MEMO_DT],[CR_AMT],[DR_AMT],[NET]	)
	SELECT 'BALANCE' AS [XN_TYPE],NULL AS [MEMO_NO],NULL AS [MEMO_ID],NULL AS [MEMO_DT],SUM(CR_AMT) AS [CR_AMT],SUM(DR_AMT) AS [DR_AMT],SUM(CR_AMT) -SUM(DR_AMT) AS [NET]
	FROM @TTABLE

	UPDATE @TTABLE SET CR_AMT =NULL WHERE CR_AMT =0
	UPDATE @TTABLE SET DR_AMT =NULL WHERE DR_AMT =0

	SELECT * FROM @TTABLE A,CUSTDYM B
	WHERE B.CUSTOMER_CODE=@CCUSTCODE
  
  
END
