CREATE PROCEDURE SP3SBUILDRFOPT_BULK
@BBUILDRFOPT BIT=1
AS
BEGIN
    
    DECLARE @CCMD NVARCHAR(MAX),@CRFDBNAME VARCHAR(500),@CSTEP VARCHAR(10),@bWH bit,
	@CHODEPTID VARCHAR(5),@CCURDEPTID VARCHAR(5),@BPURLOC BIT,@CRFSOURCE VARCHAR(2),
	@CINSJOINSTR VARCHAR(500),@CWHERECLAUSE VARCHAR(500),@CRFOPTBULK_INSERT BIT,@BCREATERFOPT BIT
	
	
	EXEC SP3S_POPULATE_CUSTOMERCRM_CUBE
	--EXEC SP3S_GSTREPS 
	EXEC SP_CUST_ATTR_VALUE
	
	SELECT @CWHERECLAUSE = '',@CINSJOINSTR=''
	--,@CRFDBNAME=DB_NAME()+'_RFOPT'
	EXEC SP3S_RFDBNAME @CRFDBNAME OUTPUT 
    IF ISNULL(@CRFDBNAME,'')=''
    SET @CRFDBNAME=DB_NAME()+'_RFOPT.DBO.'

	SET @CCMD=N'IF NOT EXISTS(SELECT TOP 1 * FROM SYS.DATABASES WHERE NAME='''+@CRFDBNAME+''')
					SET @BCREATERFOPT=1'
	EXEC SP_EXECUTESQL @CCMD,N'@BCREATERFOPT BIT OUTPUT',@BCREATERFOPT=@BCREATERFOPT OUTPUT			
				
	IF @BCREATERFOPT=1
	BEGIN
		EXEC SP3S_CRT_RFOPT ''
		
		IF @BBUILDRFOPT=0
			SET @BBUILDRFOPT=1
	END
	
	IF @BBUILDRFOPT=0		
		RETURN
		
	SELECT TOP 1 @CHODEPTID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'
	SELECT TOP 1 @CCURDEPTID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'LOCATION_ID'
	
	SELECT @CRFOPTBULK_INSERT=ISNULL(BUILD_RFOPT,0),@bWH= pur_loc  FROM LOCATION WHERE DEPT_ID =@CCURDEPTID
	
	IF ISNULL(@CHODEPTID,'')=ISNULL(@CCURDEPTID,'')
		SET @CRFOPTBULK_INSERT=1
	
	EXEC SP3S_UPDATE_FIX_BARCODE
	
	
	IF ISNULL(@CRFOPTBULK_INSERT,0)<>1
		RETURN	
	----- DO NOT PROCESS RF_OPT ENTRY IF CURRENT LOCATION IS POS AND REPORTING SOURCE IS NOT RF_OPT
		   
	   ----- START OF REBUILD CONSUMABLES REPORT FILE		
	   SET @CCMD=N'TRUNCATE TABLE '+@CRFDBNAME+'RF_OPT_CONS'
	   PRINT @CCMD 
	   EXEC SP_EXECUTESQL @CCMD
		   
	   SET @CCMD=N'INSERT '+@CRFDBNAME+'RF_OPT_CONS
					(DEPT_ID,XN_TYPE,XN_DT,XN_NO,XN_ID,PRODUCT_CODE,XN_QTY) 
				   SELECT  A.DEPT_ID,
						   XN_TYPE,   
						   XN_DT,   
						   XN_NO,   
						   XN_ID, 
						   A.PRODUCT_CODE,  
						   XN_QTY
						 FROM VW_XNSREPS_CONS A'
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
		----- END OF REBUILD CONSUMABLES REPORT FILE		

		          
		
		IF ISNULL(@CHODEPTID,'')=ISNULL(@CCURDEPTID,'') or @bWH= 1
		BEGIN
		    
		    EXEC SP3S_UPD_SKUXFP_BULK
		    EXEC SP_SHRINKLOGFILE
		    EXEC SP3S_UPDATE_LOCATION_STOCKATRSP 
		END 
		
		-- END OF XFP REBUILD
				
				
		           
		DECLARE @RFDBNAME VARCHAR(100)
		SET @RFDBNAME=DB_NAME ()+'_RFOPT'
		
	    
       DECLARE @CPROC_CODE VARCHAR(100)
       SET @CPROC_CODE='SP_SHRINKLOGFILE'

       	--CREATING PROCEDURE TO SHRINK LOG FILE
	--SET @CCMD=N' IF OBJECT_ID('''+@CRFDBNAME+'.DBO.SP_SHRINKLOGFILE'',''P'') IS NULL
	--				SET @BPROC_NOT_EXISTS=1 '
	--PRINT @CCMD				
	--EXEC SP_EXECUTESQL @CCMD,N'@BPROC_NOT_EXISTS BIT OUTPUT',@BPROC_NOT_EXISTS OUTPUT
	
   
     SET @CCMD=N' USE '+@RFDBNAME+'; EXEC ('' '+@CPROC_CODE+' '')'
	 PRINT @CCMD			
	 EXEC SP_EXECUTESQL 	@CCMD	

	 UPDATE CONFIG SET VALUE=''	WHERE CONFIG_OPTION='BULK_RFOPTBUILD_INPROCESS'
         
END
