CREATE PROCEDURE SPPPC_DQRQ_SELF_DETAILS
(
 @NQUERYID INT=0,
 @CBOM_ARTICLE_CODE VARCHAR(MAX)='',
 @CSUBSECTION_CODE VARCHAR(MAX)=''
 
 
)
AS
BEGIN

    DECLARE @CCMD NVARCHAR(MAX),@CFILTER NVARCHAR(MAX),@CFILTER1 NVARCHAR(MAX)
    
    SET @CFILTER=''
    IF ISNULL(@CBOM_ARTICLE_CODE,'')=''
    SET  @CFILTER=' AND 1=1'
    IF ISNULL(@CBOM_ARTICLE_CODE,'')<>''
    SET  @CFILTER=' AND TMP.ARTICLE_CODE '+@CBOM_ARTICLE_CODE+''
    
    
    SET @CFILTER1=''
    IF ISNULL(@CSUBSECTION_CODE,'')=''
    SET  @CFILTER1=' AND 1=1'
    IF ISNULL(@CSUBSECTION_CODE,'')<>''
    SET  @CFILTER1=' AND TMP.SUB_SECTION_CODE '+@CSUBSECTION_CODE+''
    
    SET @CFILTER=@CFILTER+@CFILTER1
    
    IF @NQUERYID IN(1,2)
    BEGIN
         IF OBJECT_ID ('TEMPDB..#TMPARTICLE','U') IS NOT NULL
         DROP TABLE #TMPARTICLE   
         
      SELECT ART.ARTICLE_TYPE , B.ARTICLE_CODE,ART.ARTICLE_NAME ,ART.ARTICLE_NO,ART.SUB_SECTION_CODE 
      INTO #TMPARTICLE
      FROM PPC_PID01106 B
      JOIN PPC_PIM01106 C ON B.MRR_ID =C.MRR_ID
      JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_CODE 
      WHERE B.PO_ROW_ID =''
      GROUP BY  ART.ARTICLE_TYPE ,B.ARTICLE_CODE,ART.ARTICLE_NAME,ART.ARTICLE_NO ,ART.SUB_SECTION_CODE 
      UNION 
      SELECT ART.ARTICLE_TYPE ,A.ARTICLE_CODE,ART.ARTICLE_NAME ,ART.ARTICLE_NO ,ART.SUB_SECTION_CODE  
      FROM PPC_POD01106 A
      JOIN PPC_POM01106 B ON A.PO_ID =B.PO_ID 
      JOIN PPC_PID01106 C ON C.PO_ROW_ID =A.ROW_ID 
      JOIN PPC_PIM01106 D ON C.MRR_ID =D.MRR_ID 
      JOIN ARTICLE ART ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
      WHERE B.CANCELLED =0 AND D.CANCELLED =0
      AND A.BO_BOM_ROW_ID =''
      GROUP BY ART.ARTICLE_TYPE ,A.ARTICLE_CODE,ART.ARTICLE_NAME ,ART.ARTICLE_NO,ART.SUB_SECTION_CODE  
      
    
    END
    
    IF @NQUERYID IN(3,4)
    BEGIN
       
         IF OBJECT_ID ('TEMPDB..#TMPPID','U') IS NOT NULL
         DROP TABLE #TMPPID 
      SELECT  B.ROW_ID ,B.ARTICLE_CODE 
      INTO #TMPPID 
      FROM PPC_PID01106 B
      JOIN PPC_PIM01106 C ON B.MRR_ID =C.MRR_ID
      WHERE B.PO_ROW_ID =''
      GROUP BY B.ROW_ID ,B.ARTICLE_CODE
      UNION 
      SELECT C.ROW_ID  ,A.ARTICLE_CODE
      FROM PPC_POD01106 A
      JOIN PPC_POM01106 B ON A.PO_ID =B.PO_ID 
      JOIN PPC_PID01106 C ON C.PO_ROW_ID =A.ROW_ID 
      JOIN PPC_PIM01106 D ON C.MRR_ID =D.MRR_ID 
      WHERE B.CANCELLED =0 AND D.CANCELLED =0
      AND A.BO_BOM_ROW_ID =''
      GROUP BY C.ROW_ID ,A.ARTICLE_CODE
   
   
  -- SELECT * INTO TMPPID FROM #TMPPID
   
    
    END
  
IF @NQUERYID=1
   GOTO LBLBOMARTICLE 
ELSE IF @NQUERYID=2
  GOTO LBLSUBSECTIONDETAILS 
ELSE IF @NQUERYID=3
  GOTO LBLARTICLEDETAILS 
ELSE IF @NQUERYID=4
  GOTO LBLBARCODEDETAILS  
ELSE IF @NQUERYID=5
   GOTO LBLDQBARCODEDET   
ELSE 
   GOTO END_PROC
   
   LBLSUBSECTIONDETAILS:
       
       SELECT B.SUB_SECTION_CODE ,B.SUB_SECTION_NAME  
       FROM #TMPARTICLE A
       JOIN SECTIOND B ON A.SUB_SECTION_CODE  =B.SUB_SECTION_CODE 
        WHERE A.ARTICLE_TYPE<>1
       GROUP BY B.SUB_SECTION_CODE ,B.SUB_SECTION_NAME
      
       
   GOTO END_PROC
     
   LBLBOMARTICLE:
     
     SET @CCMD=N' SELECT TMP.ARTICLE_CODE ,TMP.ARTICLE_NAME ,TMP.ARTICLE_NO  
      FROM #TMPARTICLE TMP
      WHERE 1=1 '+ @CFILTER + '
      GROUP BY TMP.ARTICLE_CODE ,TMP.ARTICLE_NAME ,TMP.ARTICLE_NO  
      ORDER BY TMP.ARTICLE_NO '
      PRINT @CCMD
      EXEC SP_EXECUTESQL @CCMD
      
      GOTO END_PROC
      
   LBLARTICLEDETAILS:
      
    
      SET @CCMD=N'SELECT B.ARTICLE_CODE AS BOM_ARTICLE_CODE,ART.ARTICLE_NAME AS BOM_ARTICLE_NAME,ART.ARTICLE_NO AS BOM_ARTICLE_NO,
              '''' AS ROW_ID,'''' AS BO_ROW_ID,0 AS BO_QTY,''''  AS REF_ROW_ID,
              SUM(E.QUANTITY_IN_STOCK ) AS QUANTITY_IN_STOCK,SUM(E.QUANTITY_IN_STOCK ) AS QUANTITY
        
      FROM #TMPPID TMP
      JOIN PPC_PID01106 B ON TMP.ROW_ID=B.ROW_ID
      JOIN PPC_PIM01106 C ON B.MRR_ID =C.MRR_ID
      JOIN PPC_PID01106_BARCODE D ON D.PID_ROW_ID=B.ROW_ID
      JOIN PPC_PMT E ON E.PRODUCT_UID=D.PRODUCT_UID
      JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_CODE
      WHERE C.CANCELLED =0 AND ISNULL(E.QUANTITY_IN_STOCK,0) > 0
      AND ISNULL(E.BO_BOM_ROW_ID,'''')=''''
        '+@CFILTER+' 
      GROUP BY B.ARTICLE_CODE,ART.ARTICLE_NAME ,ART.ARTICLE_NO
      ORDER BY ART.ARTICLE_NO'
      PRINT @CCMD
      EXEC SP_EXECUTESQL @CCMD
                      
             
     GOTO END_PROC        
  
   LBLBARCODEDETAILS:
   
     SET @CCMD=N' SELECT B.ARTICLE_CODE AS BOM_ARTICLE_CODE,ART.ARTICLE_NAME AS BOM_ARTICLE_NAME,ART.ARTICLE_NO AS BOM_ARTICLE_NO,
             P1.PARA1_CODE,P1.PARA1_NAME,
             '''' AS REF_ROW_ID,CAST(''LATER''+CAST(NEWID () AS VARCHAR(100))  AS VARCHAR(40)) AS ROW_ID,D.PRODUCT_UID,D.PRODUCT_CODE,
             E.QUANTITY_IN_STOCK AS  QUANTITY_IN_STOCK,E.QUANTITY_IN_STOCK AS  QUANTITY,0 AS REQ_QTY
        
      FROM #TMPPID TMP
      JOIN PPC_PID01106 B ON TMP.ROW_ID=B.ROW_ID
      JOIN PPC_PIM01106 C ON B.MRR_ID =C.MRR_ID
      JOIN PPC_PID01106_BARCODE D ON D.PID_ROW_ID=B.ROW_ID
      JOIN PPC_PMT E ON E.PRODUCT_UID=D.PRODUCT_UID
      JOIN PARA1 P1 ON P1.PARA1_CODE=B.PARA1_CODE
      JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_CODE
      WHERE C.CANCELLED =0 AND ISNULL(E.QUANTITY_IN_STOCK,0) > 0
      AND ISNULL(E.BO_BOM_ROW_ID,'''')=''''
      '+@CFILTER+''
      
      PRINT @CCMD
      EXEC SP_EXECUTESQL @CCMD
         
      
   GOTO END_PROC
   
   
    LBLDQBARCODEDET:  
   
   
  SELECT B.AC_CODE ,LM.AC_NAME ,  
      A.ORDER_ID ,B.ORDER_NO, B.ORDER_DT,  
      B.BILL_NO,PMT.BO_BOM_ROW_ID,  
      A.ARTICLE_CODE  ,ART.ARTICLE_NO,  
      A.PARA1_CODE ,P1.PARA1_NAME ,  
      A.SIZEGROUP_CODE ,SG.SIZEGROUP_NAME ,  
      A.PARA3_CODE,P3.PARA3_NAME ,  
      C.BOM_ARTICLE_CODE ,ART1.ARTICLE_NAME AS BOM_ARTICLE_NAME ,  
      A.ROW_ID AS REF_ROW_ID,  
      CAST('LATER'+CAST(NEWID () AS VARCHAR(100))  AS VARCHAR(40)) AS ROW_ID,  
      PMT.PRODUCT_UID ,PMT.PRODUCT_CODE,  
      SUM(PMT.QUANTITY_IN_STOCK ) AS QUANTITY_IN_STOCK ,  
      SUM(PMT.QUANTITY_IN_STOCK ) AS QUANTITY,  
      CAST(0 AS NUMERIC(10,3)) AS REQ_QTY  
      FROM PPC_BUYER_ORDER_DET A  
      JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID =B.ORDER_ID   
      JOIN PPC_BO_ART_BOM C ON C.REF_ROW_ID=A.ROW_ID   
      JOIN PPC_PMT PMT ON C.ROW_ID =PMT.BO_BOM_ROW_ID  
      JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE  
      JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE=A.SIZEGROUP_CODE  
      JOIN PARA3 P3 ON P3.PARA3_CODE=A.PARA3_CODE  
      JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE  
      JOIN ARTICLE ART1 ON ART1.ARTICLE_CODE=C.BOM_ARTICLE_CODE  
      JOIN LM01106 LM ON LM.AC_CODE =B.AC_CODE   
      WHERE B.CANCELLED =0   
      AND PMT.QUANTITY_IN_STOCK>0  
      --AND (@CORDER_ID='' OR A.ORDER_ID =@CORDER_ID)  
      --AND (@CBO_ROW_ID='' OR  A.ROW_ID =@CBO_ROW_ID)  
      --AND (@CBOM_ARTICLE_CODE='' OR C.BOM_ARTICLE_CODE=@CBOM_ARTICLE_CODE)  
      GROUP BY B.ORDER_NO,B.ORDER_DT,B.AC_CODE ,LM.AC_NAME,A.ORDER_ID ,  
      A.ARTICLE_CODE ,ART.ARTICLE_NO , B.BILL_NO,  
      A.PARA1_CODE ,P1.PARA1_NAME ,  
      A.SIZEGROUP_CODE ,SG.SIZEGROUP_NAME ,  
      A.PARA3_CODE,P3.PARA3_NAME ,BO_BOM_ROW_ID,  
      C.BOM_ARTICLE_CODE ,ART1.ARTICLE_NAME  ,  
      C.ROW_ID ,PMT.PRODUCT_UID ,PMT.PRODUCT_CODE,A.ROW_ID  
        
    GOTO END_PROC  
     
  
END_PROC:

END
