
CREATE PROCEDURE SP_UPC_JOBS
(
 @CORDER_ID VARCHAR(50)='',
 @CPARA1_CODE VARCHAR(10)='',
 @CPARA2_CODE VARCHAR(10)='',
 @CWO_ID VARCHAR(50)='',
 @CARTICLE_CODE VARCHAR(15)=''
 )
AS
BEGIN
	 
	 
	 
	 IF OBJECT_ID ('TEMPDB..#TMPPRODUCT','U') IS NOT NULL
	    DROP TABLE #TMPPRODUCT
	 

    SELECT c.PRODUCT_CODE ,UPC.QUANTITY_IN_STOCK,b.ARTICLE_CODE 
    INTO #TMPPRODUCT
    FROM ORD_PLAN_MST A (NOLOCK)
    JOIN ORD_PLAN_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
    JOIN ORD_PLAN_BARCODE_DET C (NOLOCK) ON B.ROW_ID=C.REFROW_ID
    JOIN JOBWORK_PMT UPC ON UPC.PRODUCT_CODE =C.PRODUCT_CODE 
    LEFT JOIN BUYER_ORDER_DET BD (NOLOCK) ON BD.ROW_ID=WOD_ROW_ID
    LEFT JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID=BD.ORDER_ID
    LEFT OUTER JOIN BUYER_ORDER_MST BO ON BO.ORDER_ID= ISNULL(UPC.ORDER_ID ,BM.ORDER_ID )     
    WHERE A.CANCELLED=0 AND ISNULL(BM.CANCELLED,0)=0 AND ISNULL(UPC.QUANTITY_IN_STOCK ,0)>0
    AND ISNULL(ISNULL(UPC.ORDER_ID ,BM.ORDER_ID ),'')=@CORDER_ID
    AND(@CARTICLE_CODE='' OR  B.ARTICLE_CODE =@CARTICLE_CODE)
    AND B.PARA1_CODE =@CPARA1_CODE
    AND B.PARA2_CODE =@CPARA2_CODE
    AND A.MEMO_ID  =@CWO_ID
   
    
    
       
	 IF OBJECT_ID ('TEMPDB..#TMPREC','U') IS NOT NULL
		   DROP TABLE #TMPREC

		 SELECT AG.AGENCY_NAME,  A.PRODUCT_CODE,B.RECEIPT_ID  MEMO_ID ,
		 a.JOB_CODE ,B.RECEIPT_NO  AS REC_NO,CONVERT(VARCHAR,B.RECEIPT_DT,105)  AS REC_DT,
		 TMP.QUANTITY_IN_STOCK 
		 INTO #TMPREC
		 FROM JOBWORK_RECEIPT_DET  A
		 JOIN JOBWORK_RECEIPT_MST  B ON A.RECEIPT_ID =B.RECEIPT_ID
		 JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE=b.AGENCY_CODE 
		 JOIN #TMPPRODUCT TMP ON A.PRODUCT_CODE =TMP.PRODUCT_CODE 
		 WHERE B.CANCELLED=0
		  
		 
		 ;WITH CTE AS
		 (
		 SELECT AGENCY_NAME,PRODUCT_CODE,MEMO_ID,JOB_CODE,
				SR=ROW_NUMBER () OVER (PARTITION BY PRODUCT_CODE,JOB_CODE ORDER BY PRODUCT_CODE,JOB_CODE, MEMO_ID DESC)
		 FROM #TMPREC
		 
		 )
		 DELETE  FROM CTE WHERE SR>1
		 
		SELECT REC_NO,B.REC_DT,AGENCY_NAME,JOBS.JOB_NAME ,b.PRODUCT_CODE ,
				b.QUANTITY_IN_STOCK AS WIP_STOCK  
		FROM #TMPREC B
		JOIN JOBS ON B.JOB_CODE =JOBS.JOB_CODE 
		
		
END



