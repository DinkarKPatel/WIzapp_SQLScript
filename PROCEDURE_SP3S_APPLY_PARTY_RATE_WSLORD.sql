CREATE PROCEDURE SP3S_APPLY_PARTY_RATE_WSLORD--(LocId 3 digit change by Sanjay:06-11-2024)
(
   @NSPID INT,
   @CERRORMSG VARCHAR(MAX) OUTPUT
 )   
----WITH ENCRYPTION
AS
BEGIN
	PRINT 'ENTER PARTY RATE NEW WITH MRP'
    DECLARE @CERRMSG VARCHAR(MAX),@CARTICLE_CODE VARCHAR(100),@CPARA1_CODE VARCHAR(100),@CPARA2_CODE VARCHAR(100),
    @CPARA3_CODE VARCHAR(100),@CPARA4_CODE VARCHAR(100),@CPARA5_CODE VARCHAR(100),@CPARA6_CODE VARCHAR(100),
    @CPARTYRATEMEMOID VARCHAR(100),@CCMD NVARCHAR(MAX),@NBASE_PRICE NUMERIC(18,2),@NCAL_MODE INT,
    @NDISCOUNT_PERCENTAGE NUMERIC(18,2),@NRATE NUMERIC(18,2),@NDISCOUNT_AMOUNT NUMERIC(18,2),
    @NNETRATE NUMERIC(18,2),@GIVE_CREDIT_VAT INT,@VAT_PER NUMERIC(18,2),@CMEMO_DT DATETIME,
    @VAT_AMOUNT NUMERIC(18,2),@PARTY_FINAL_MARGIN NUMERIC(18,2),@GROSS_SALE NUMERIC(18,2),@BMRPRANGEBASEDMEMO BIT,
    @VAT_EX_AMOUNT NUMERIC(18,2),@CFILTER_EXP VARCHAR(2000),@BFOUND BIT,@CROWID VARCHAR(40),@CSTEP VARCHAR(5)
    
     DECLARE @CPARTYRATEFILTER VARCHAR(1000),@CTERMSCODE VARCHAR(20),@NCUSTOMRATETYPE INT,
      @CTARGETLOCID VARCHAR(5),@CSOURCELOCID VARCHAR(5),@NDEFAULTRATETYPE INT,@BENABLEEXCISDUTY BIT,
      @BCUSTOMPROCEXISTS BIT,@CUTERRORMSG VARCHAR(MAX),@CTERRMSG VARCHAR(MAX),
      @CERRPC VARCHAR(50),@NINVTYPE INT,@NBILLLEVELTAXMETHOD INT,@NRATEPICKINGMETHOD INT,
      @NPARTYDISCPCT NUMERIC(7,3),@CPRODUCTCODE VARCHAR(50),@BPARTYRATEFILTERAPPLICABLE BIT,@BDONOTCALEXCISE BIT,
      @NCALMODE INT,@NLOTPRICE NUMERIC(10,2),@NXFERTYPE INT,@CROUNDNETRATE VARCHAR(4),
      @CCURLOCID VARCHAR(5),@BGSTBILL BIT,@DINVDT DATETIME,@CPARTYSTATECODE CHAR(7),@BGROUPINV BIT,
      @XN_ITEM_TYPE NUMERIC(2,0),@cuser_code varchar(10)
	  
	  
    
BEGIN TRY              
    SET @CSTEP=10           
	SET @CERRMSG=''
	

	SELECT TOP 1 @CPARTYRATEMEMOID=MEMO_ID,@CMEMO_DT=MEMO_DT,@BMRPRANGEBASEDMEMO=ISNULL(MRP_RANGE_BASED_MEMO,0) FROM PARTY_RATE_MST A
	JOIN WSL_INV_SETTINGS B ON  A.MEMO_ID=B.PARTY_RATE_MEMO_ID
	WHERE B.SP_ID=@NSPID
	
	
	IF ISNULL(@CPARTYRATEMEMOID,'')=''
	GOTO END_PROC
	
	IF OBJECT_ID('TEMPDB..#TMPPRATEDET','U') IS NOT NULL
		DROP TABLE #TMPPRATEDET
	
	SET @CSTEP=20
	SELECT * INTO #TMPPRATEDET FROM PARTY_RATE_DET WHERE MEMO_ID=@CPARTYRATEMEMOID

	--rate_picking_method (Mode (ledger terms,custom rate,party rate)
	--mst_base_price (Wsp,mrp,pp)
	--mst_value (Discount%)
	
	IF NOT EXISTS (SELECT TOP 1 'U' FROM #TMPPRATEDET)
	BEGIN
	  
	    SELECT TOP 1 @NINVTYPE=ISNULL(INV_TYPE,0),@NXFERTYPE=ISNULL(XFER_TYPE,0),@NDEFAULTRATETYPE=DEFAULT_RATE_TYPE,@NCUSTOMRATETYPE=ISNULL(A.CUSTOM_RATE_TYPE,0),
		  @BPARTYRATEFILTERAPPLICABLE=ISNULL(PARTYRATE_FILTER_APPLICABLE,0),@CTERMSCODE=ISNULL(TERMS_CODE,''), 
		  @CTARGETLOCID=TARGET_LOCATION_ID,@CSOURCELOCID=A.LOCATION_ID,
		  @BENABLEEXCISDUTY=ISNULL(ENABLE_EXCISE_DUTY,0),@BCUSTOMPROCEXISTS=ISNULL(CUSTOM_PROC_EXISTS,0),
		  @NBILLLEVELTAXMETHOD=BILL_LEVEL_TAX_METHOD,@NRATEPICKINGMETHOD=ISNULL(C.RATE_PICKING_METHOD,0),
		  @NPARTYDISCPCT=(CASE WHEN ISNULL(DISCOUNT_PICKING_MODE,0)=2 THEN 0 ELSE PARTY_DISCOUNT_PCT END),
		  @NCALMODE=MST_CAL_MODE,@BDONOTCALEXCISE=ISNULL(DONOT_CALC_EXCISE,0),
		  @NLOTPRICE=A.LOT_PRICE,@BGSTBILL=ISNULL(GST_BILL,0),@DINVDT=INV_DT,
		  @CPARTYSTATECODE=PARTY_STATE_CODE,
		  @XN_ITEM_TYPE=A.XN_ITEM_TYPE,
		  @cuser_code=user_code 
		  FROM WSL_INV_SETTINGS A (NOLOCK)
		  LEFT OUTER JOIN LOCATION B ON A.LOCATION_ID=B.DEPT_ID
		  LEFT OUTER JOIN 
		  (SELECT MEMO_ID,RATE_PICKING_METHOD,DISCOUNT_PICKING_MODE,MST_CAL_MODE 
		   FROM PARTY_RATE_MST WHERE MEMO_ID=@CPARTYRATEMEMOID) C ON C.MEMO_ID=A.PARTY_RATE_MEMO_ID
		  WHERE SP_ID=@NSPID
		  
	     UPDATE A SET 	RATE=(CASE WHEN ISNULL(MANUAL_RATE,0)=1 THEN RATE WHEN @NLOTPRICE<>0 THEN @NLOTPRICE 
					 WHEN ISNULL(B.MRP_WSP_MODE,0)=2 OR @NDEFAULTRATETYPE=1 AND ISNULL(ARTICLE.WHOLESALE_PRICE,0)>0 THEN ARTICLE.WHOLESALE_PRICE
					 WHEN @NDEFAULTRATETYPE=3 THEN (ARTICLE.PURCHASE_PRICE)
					  ELSE isnull(sku.MRP, ARTICLE.MRP) END),
		  DISCOUNT_AMOUNT=0,DISCOUNT_PERCENTAGE=(CASE WHEN @NLOTPRICE<>0 THEN 0 ELSE ISNULL(@NPARTYDISCPCT,0)*
		  (CASE WHEN ISNULL(@NCALMODE,3)=1 THEN -1 ELSE 1 END) END)
			  ,HSN_CODE=ARTICLE.HSN_CODE
		  FROM WSL_ITEM_DETAILS A 	  
		  left join sku (nolock) on a.PRODUCT_CODE =sku.product_code 
		  JOIN ARTICLE  (NOLOCK) ON A.ARTICLE_CODE =ARTICLE.ARTICLE_CODE	
		  JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
		  WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 
		  AND ISNULL(MANUAL_DISCOUNT,0)=0
		 
		  		  
		  UPDATE WSL_ITEM_DETAILS SET DISCOUNT_AMOUNT=(RATE * INVOICE_QUANTITY * DISCOUNT_PERCENTAGE) / 100
		  WHERE SP_ID=@NSPID AND ISNULL(MANUAL_NET_RATE,0)=0

		  UPDATE WSL_ITEM_DETAILS SET DISCOUNT_PERCENTAGE=((RATE -NET_RATE)/RATE) * 100
		  WHERE SP_ID=@NSPID AND ISNULL(MANUAL_NET_RATE,0)=1
		  
		  UPDATE WSL_ITEM_DETAILS SET DISCOUNT_AMOUNT=(RATE -NET_RATE) * INVOICE_QUANTITY * DISCOUNT_PERCENTAGE / 100
		  WHERE SP_ID=@NSPID AND ISNULL(MANUAL_NET_RATE,0)=1
		  
		  UPDATE WSL_ITEM_DETAILS SET NET_RATE=RATE-(RATE * DISCOUNT_PERCENTAGE/ 100) WHERE SP_ID=@NSPID
		  AND ISNULL(MANUAL_NET_RATE,0)=0
	      
	END
	
	
	SET @BFOUND=1
	WHILE @BFOUND=1
	BEGIN
		
		SET @CSTEP=30
		SELECT @CFILTER_EXP='',@CROWID=''
		
		SELECT TOP 1 @CROWID=ROW_ID FROM #TMPPRATEDET
		
		IF ISNULL(@CROWID,'')=''
			BREAK
		
		SET @CSTEP=40				
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND ARTICLE_CODE NOT IN ('','00000000'))
			SET @CFILTER_EXP=@CFILTER_EXP+' ARTICLE.ARTICLE_CODE=PR.ARTICLE_CODE'	
		
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA1_CODE NOT IN ('','0000000'))	
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA1_CODE=PR.PARA1_CODE' 
		
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA2_CODE NOT IN ('','0000000'))
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA2_CODE=PR.PARA2_CODE' 
		
		--IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA3_CODE NOT IN ('','0000000'))
		--	SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA3_CODE=PR.PARA3_CODE' 
		
		--SET @CSTEP=70
		--IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA4_CODE NOT IN ('','0000000'))
		--	SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA4_CODE=PR.PARA4_CODE' 
							 
		--IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA5_CODE NOT IN ('','0000000'))
		--	SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA5_CODE=PR.PARA5_CODE' 
							 
		--IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA6_CODE NOT IN ('','0000000'))
		--	SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA6_CODE=PR.PARA6_CODE' 
		
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND SECTION_CODE NOT IN ('','0000000'))
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' SECTIONM.SECTION_CODE=PR.SECTION_CODE'			

		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND SUB_SECTION_CODE NOT IN ('','0000000'))
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' SECTIOND.SUB_SECTION_CODE=PR.SUB_SECTION_CODE'						
		
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND ISNULL(HSN_CODE,'') NOT IN ('','0000000000'))
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' ARTICLE.HSN_CODE=PR.HSN_CODE'						
		
		--update  WSL_ITEM_DETAILS set MANUAL_RATE=0 ,MANUAL_NET_RATE=0,MANUAL_DISCOUNT=0 




		SET @CSTEP=50		
		SET @CCMD=N'UPDATE A SET PARTY_RATE_BASE_PRICE=PR.BASE_PRICE,PARTY_RATE_CAL_MODE=PR.CAL_MODE,
					DISCOUNT_PERCENTAGE=(CASE WHEN ISNULL(PR.CAL_MODE,3)=1 THEN PR.VALUE*-1 WHEN ISNULL(PR.CAL_MODE,3)=2 THEN PR.VALUE
					 ELSE 0 END),RATE=(CASE WHEN ISNULL(PR.CAL_MODE,3)=3 THEN PR.VALUE ELSE 0 END),
					PARTY_RATE_GIVE_CREDIT_VAT=PR.GIVE_CREDIT_VAT
					FROM WSL_ITEM_DETAILS A 
					JOIN ARTICLE  (NOLOCK) ON A.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
					JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
					JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
					JOIN #TMPPRATEDET PR (NOLOCK) ON '+@CFILTER_EXP+
					' WHERE A.SP_ID='+LTRIM(RTRIM(STR(@NSPID)))+' AND MEMO_ID='''+@CPARTYRATEMEMOID+''''+
					(CASE WHEN @BMRPRANGEBASEDMEMO=1 THEN ' AND ARTICLE.MRP BETWEEN PR.FROM_MRP AND PR.TO_MRP ' ELSE '' END)+
					' AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0'
		
		PRINT ISNULL(@CCMD,'NULL PARTYRATE EXPR ')							
		EXEC SP_EXECUTESQL @CCMD
		
		DELETE FROM #TMPPRATEDET WHERE ROW_ID=@CROWID






		
		
	END
	


	SET @CSTEP=55	
	UPDATE A SET RATE=(CASE WHEN ISNULL(PARTY_RATE_CAL_MODE,0)=3 AND ISNULL(RATE,0)<>0 THEN RATE
	WHEN ISNULL(PARTY_RATE_BASE_PRICE,0)=1 THEN ARTICLE .WHOLESALE_PRICE 
	WHEN ISNULL(PARTY_RATE_BASE_PRICE,0)=2 THEN ARTICLE .MRP 
	ELSE 
	(A.PURCHASE_PRICE
	)  END)
	FROM WSL_ITEM_DETAILS A
	JOIN ARTICLE (NOLOCK) ON A.ARTICLE_CODE =ARTICLE .ARTICLE_CODE 
	WHERE A.SP_ID=@NSPID AND PARTY_RATE_CAL_MODE IS NOT NULL
	AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	
	IF EXISTS (SELECT TOP 1 'U' FROM WSL_ITEM_DETAILS WHERE SP_ID=@NSPID AND RATE =0)
	BEGIN
	     
	     SET @CERRORMSG='RATE CAN NOT BE ZERO'
	     SELECT a.section_name ,a.sub_section_name ,a.article_no , A.PRODUCT_CODE ,
	     'RATE CAN NOT BE ZERO' AS MESSAGE
	     FROM WSL_ITEM_DETAILS  A (NOLOCK)
	     WHERE A.SP_ID=@NSPID AND RATE =0 
	    
	     
	     GOTO END_PROC
	END
	

	SET @CSTEP=60
	
		
	
	UPDATE WSL_ITEM_DETAILS SET DISCOUNT_AMOUNT=RATE*DISCOUNT_PERCENTAGE*INVOICE_QUANTITY/100
	WHERE SP_ID=@NSPID  --ISNULL(PARTY_RATE_CAL_MODE,0)=2
	AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	
	
	SET @CSTEP=70
	UPDATE WSL_ITEM_DETAILS SET NET_RATE =RATE-(DISCOUNT_AMOUNT /INVOICE_QUANTITY)
	WHERE SP_ID=@NSPID --AND ISNULL(PARTY_RATE_CAL_MODE,0)=2
	AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	
	----DECLARE @CALLOW_TO_SAVE_WITHOUT_PARTY_RATE VARCHAR(10)

	----SELECT TOP 1 @CALLOW_TO_SAVE_WITHOUT_PARTY_RATE=VALUE FROM USER_ROLE_DET A(NOLOCK)
	----JOIN USERS B(NOLOCK) ON A.ROLE_ID=B.ROLE_ID
	----WHERE USER_CODE=@CUSER_CODE 
	----AND FORM_OPTION='ALLOW_TO_SAVE_WITHOUT_PARTY_RATE'	
	
	----if ISNULL(@CALLOW_TO_SAVE_WITHOUT_PARTY_RATE,'')<>'1'
	----begin
	----     IF EXISTS (SELECT TOP 1 'U' FROM WSL_ITEM_DETAILS WHERE SP_ID=@NSPID AND ISNULL(discount_amount,0) =0)
	----     begin
	----         update WSL_ITEM_DETAILS set errmsg='Party Rate not Define' WHERE SP_ID=@NSPID AND ISNULL(discount_amount,0) =0
	         
	----     SELECT SM.section_name ,SD.sub_section_name ,ART.article_no , A.PRODUCT_CODE ,
	----     A.errmsg  AS MESSAGE
	----     FROM WSL_ITEM_DETAILS  A (NOLOCK)
	----     JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
	----     JOIN ARTICLE ART (NOLOCK) ON B.ARTICLE_CODE=ART.ARTICLE_CODE
	----     JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE=ART.SUB_SECTION_CODE
	----     JOIN SECTIONM SM (NOLOCK) ON SM.section_code =SD.section_code 
	----     WHERE A.SP_ID=@NSPID AND ISNULL(A.errmsg,'')<>''
	----     ORDER BY SM.section_name ,SD.sub_section_name ,ART.article_no
	     
	----		 SET @CERRORMSG='Party Rate not Define Please check'
	----		 GOTO END_PROC
	     
	----     end
	     
--	end

	
	
	GOTO END_PROC
END TRY

BEGIN CATCH
	SET @CERRORMSG='PROCEDURE SP3S_APPLY_PARTY_RATE_WSLORD STEP#'+@CSTEP+':'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:
			
END
--END OF PROCEDURE - SP3S_APPLY_PARTY_RATE_NEW
