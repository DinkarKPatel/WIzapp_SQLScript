CREATE VIEW VW_EMP_ATTENANCE_COMPLIED  
--WITH ENCRYPTION
AS  
 SELECT ATTENDANCE_DT, EMP_ID, SHIFT_ID, SHIFT_TIME_IN, SHIFT_TIME_OUT, HALFDAY_CUTOFF,  
LOG_ABSENT_STATUS,  
   DATEADD(SS, -DATEPART(SS, TIME_IN), TIME_IN) AS TIME_IN,   
   WORKING_HOURS,  
   (CASE WHEN X.MARKETING_EMP = 1--MARKETING EMPLOYEE  
   THEN  
   TIME_OUT   
   ELSE--NOT MARKETING EMPLOYEE  
   (CASE WHEN (DATEDIFF(MI, TIME_IN, TIME_OUT) - WORKING_HOURS ) > 0   
      THEN DATEADD(MI,  -(DATEDIFF(MI, TIME_IN, TIME_OUT) - WORKING_HOURS ), TIME_OUT)   
      ELSE TIME_OUT END )  
      END) AS TIME_OUT  
 FROM   
 (  
  SELECT ATTENDANCE_DT, EMP_ATTENDANCE.EMP_ID, EMP_ATTENDANCE.SHIFT_ID, SHIFT_TIME_IN, SHIFT_TIME_OUT, HALFDAY_CUTOFF,  
    ISNULL(LOG_ABSENT_STATUS,0) AS LOG_ABSENT_STATUS,  
    MIN(TIME_IN) AS TIME_IN,   
    MAX(TIME_OUT) AS TIME_OUT,EMP_MST.MARKETING_EMP,  
      
  (CASE WHEN EMP_MST.MARKETING_EMP = 0 --NOT MARKETING EMPLOYEE  
  THEN   
   (CASE WHEN DATEDIFF(MI, MIN(TIME_IN), MAX(TIME_OUT) ) < SUM( DATEDIFF(MI, TIME_IN, TIME_OUT))   
  THEN DATEDIFF(MI, MIN(TIME_IN), MAX(TIME_OUT) )  
  ELSE SUM( DATEDIFF(MI, TIME_IN, TIME_OUT))  
     END)  
  ELSE--MARKETING EMPLOYEE  
  DATEDIFF(MI, MIN(TIME_IN), MAX(TIME_OUT))  
  END)  AS WORKING_HOURS    
  FROM EMP_ATTENDANCE   
  JOIN EMP_MST ON EMP_MST.EMP_ID = EMP_ATTENDANCE .EMP_ID  
  GROUP BY ATTENDANCE_DT, EMP_ATTENDANCE.EMP_ID, EMP_ATTENDANCE.SHIFT_ID, SHIFT_TIME_IN, SHIFT_TIME_OUT,   
  HALFDAY_CUTOFF, ISNULL(LOG_ABSENT_STATUS,0),EMP_MST.MARKETING_EMP  
 ) X
