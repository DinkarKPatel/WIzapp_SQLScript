CREATE PROCEDURE SAVETRAN_MERGE_MIRROR_PARTYWSL_DATA     --(LocId 3 digit change by Sanjay:06-11-2024)   
(        
	 @Csp_id VARCHAR(50),       
	 @cACname varchar(1000)=''
	 

)      
AS        
BEGIN 
     
	
	SET NOCOUNT ON  
	
	DECLARE @DTSQL NVARCHAR(MAX),@CSTEP varchar(10),@CCURDEPTID varchar(4),@CHODEPTID varchar(4),@CSOURCEDB varchar(50),
	        @DINVDT dateTime,@CMERGEDB varchar(100),@CMRRIDSEARCH varchar(100),@CWIZAPPUSERCODE char(7),@CFINYEAR varchar(5),
			@CMEMONOPREFIX varchar(10),@CMEMOPREFIXPROC varchar(50),@MRR_NO varchar(20),@CMRRID varchar(50),@CCMDOUTPUT varchar(1000),
			@CTABLENAME varchar(100),@CTMP_TABLENAME varchar(100),@CKEYFIELD varchar(20),@bAddmode bit,
			@BCANCELLED bit ,@BNEGSTOCKFOUND bit,@CINVID VARCHAR(50),@CWHERECLAUSE varchar(100),@CCMD nvarchar(max),@CERRMSG varchar(1000)


 
 BEGIN TRY        
 BEGIN TRAN 

  SET @CSTEP=2
  
  set @CWIZAPPUSERCODE='0000000'
  set @CMEMONOPREFIX=''
	 
   SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE  CONFIG_OPTION='LOCATION_ID'
 
  SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE  CONFIG_OPTION='HO_LOCATION_ID'
  
  if @CCURDEPTID<>@CHODEPTID
  if isnull(@DINVDT,'')=''
  BEGIN
	   SET @CERRMSG = 'merging allow only headOffice'		
	   GOTO EXIT_PROC
  END


  SET @CSOURCEDB=DB_NAME()+'.DBO.'        
     
  SELECT TOP 1 @DINVDT=INV_DT,@CFINYEAR=fin_year,@CINVID=inv_id  FROM PUR_pim01106_UPLOAD B (NOLOCK)
  WHERE  sp_id =@Csp_id 

  if isnull(@CINVID,'')=''
  BEGIN
	   SET @CERRMSG = 'Data Not found'		
	   GOTO EXIT_PROC
  END


	DECLARE @cSourceAcCode CHAR(10)

	select @cSourceAcCode=AC_CODE  from LM01106 where ac_name =@cACname

	IF ISNULL(@cSourceAcCode,'') IN ('','0000000000')
	BEGIN
		SET @CERRMSG='Source Location Control Account not defined ..... Please check'
		GOTO EXIT_PROC
	END

 
  SET @CMERGEDB=DB_NAME()+'.DBO.'      
  SET @CERRMSG=''        
  

  SELECT TOP 1 @CMRRIDSEARCH = mrr_id  FROM PIM01106 (NOLOCK) WHERE INV_ID =@CINVID AND CANCELLED=0   
  SET @bAddmode=(CASE WHEN 	ISNULL(@CMRRIDSEARCH,'')<>'' THEN 0 ELSE 1 END)

  if isnull(@CMRRIDSEARCH,'')<>''
  BEGIN
	   SET @CERRMSG ='' --'Invoice Already Exists in mrr -'	+@CMRRIDSEARCH	
	   GOTO EXIT_PROC
  END



   EXEC SP_GETMASTERS 
   @cFinyear='01112',
   @nFileFormat=2,
   @CERRORMSG=@CERRMSG OUTPUT,
   @CAC_CODE=@cSourceAcCode,
   @NIMPORTFROM=0,
   @cdept_id=@CCURDEPTID,
   @nSpId=@Csp_id

  

   PRINT 'COME OUT OF IMPORTMASTERS'     
   IF ISNULL(@CERRMSG,'')<>''  
    GOTO EXIT_PROC  



	EXEC SP3S_VALIDATE_PARAS @CERRORMSG=@CERRMSG OUTPUT
	IF ISNULL(@CERRMSG,'')<>''  
	GOTO EXIT_PROC
	

	 SET @cStep = 32  
 
   SET @CCMD=N'UPDATE A SET ARTICLE_CODE=ART.ARTICLE_CODE,PARA1_CODE=ISNULL(C.PARA1_CODE,''0000000''),  
      PARA2_CODE=ISNULL(D.PARA2_CODE,''0000000''),PARA3_CODE=ISNULL(E.PARA3_CODE,''0000000''),  
      PARA4_CODE=ISNULL(F.PARA4_CODE,''0000000''),PARA5_CODE=ISNULL(G.PARA5_CODE,''0000000''),  
      PARA6_CODE=ISNULL(H.PARA6_CODE,''0000000'') 
      FROM   pur_pid01106_upload A (NOLOCK) 
      JOIN #TMPMASTERSENC B ON A.ROW_ID=B.ROW_ID  
         JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_NO = B.ARTICLE_NO    
         LEFT OUTER JOIN PARA1 C (NOLOCK) ON C.PARA1_NAME = B.PARA1_NAME   AND ISNULL(C.INACTIVE,0)=0 
         LEFT OUTER JOIN PARA2 D (NOLOCK) ON D.PARA2_NAME = B.PARA2_NAME   AND ISNULL(D.INACTIVE,0)=0
         LEFT OUTER JOIN PARA3 E (NOLOCK) ON E.PARA3_NAME = B.PARA3_NAME   AND ISNULL(E.INACTIVE,0)=0
         LEFT OUTER JOIN PARA4 F (NOLOCK) ON F.PARA4_NAME = B.PARA4_NAME   AND ISNULL(F.INACTIVE,0)=0
         LEFT OUTER JOIN PARA5 G (NOLOCK) ON G.PARA5_NAME = B.PARA5_NAME   AND ISNULL(G.INACTIVE,0)=0
         LEFT OUTER JOIN PARA6 H (NOLOCK) ON H.PARA6_NAME = B.PARA6_NAME   AND ISNULL(H.INACTIVE,0)=0
         LEFT OUTER JOIN FORM I (NOLOCK) ON I.FORM_NAME = B.FORM_NAME 
         WHERE A.SP_ID='''+LTRIM(RTRIM((@Csp_id)))+''' '   
   PRINT @CCMD        
   EXEC SP_EXECUTESQL @CCMD    
   

  
 
  
   SET @CCMD=N'UPDATE A SET ARTICLE_CODE=ART.ARTICLE_CODE,PARA1_CODE=ISNULL(C.PARA1_CODE,''0000000''),  
      PARA2_CODE=ISNULL(D.PARA2_CODE,''0000000''),PARA3_CODE=ISNULL(E.PARA3_CODE,''0000000''),  
      PARA4_CODE=ISNULL(F.PARA4_CODE,''0000000''),PARA5_CODE=ISNULL(G.PARA5_CODE,''0000000''),  
      PARA6_CODE=ISNULL(H.PARA6_CODE,''0000000'')
      FROM pur_pid01106_upload A 
      JOIN #TMPMASTERSENC B ON A.PRODUCT_CODE=B.PRODUCT_CODE  
         JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_NO = B.ARTICLE_NO    
         LEFT OUTER JOIN PARA1 C (NOLOCK) ON C.PARA1_NAME = B.PARA1_NAME  AND ISNULL(C.INACTIVE,0)=0    
         LEFT OUTER JOIN PARA2 D (NOLOCK) ON D.PARA2_NAME = B.PARA2_NAME  AND ISNULL(D.INACTIVE,0)=0  
         LEFT OUTER JOIN PARA3 E (NOLOCK) ON E.PARA3_NAME = B.PARA3_NAME  AND ISNULL(E.INACTIVE,0)=0  
         LEFT OUTER JOIN PARA4 F (NOLOCK) ON F.PARA4_NAME = B.PARA4_NAME  AND ISNULL(F.INACTIVE,0)=0  
         LEFT OUTER JOIN PARA5 G (NOLOCK) ON G.PARA5_NAME = B.PARA5_NAME  AND ISNULL(G.INACTIVE,0)=0  
         LEFT OUTER JOIN PARA6 H (NOLOCK) ON H.PARA6_NAME = B.PARA6_NAME  AND ISNULL(H.INACTIVE,0)=0
         LEFT OUTER JOIN FORM I (NOLOCK) ON I.FORM_NAME = B.FORM_NAME 
         WHERE  A.SP_ID='''+LTRIM(RTRIM((@Csp_id)))+''' AND ISNULL(A.PRODUCT_CODE,'''')<>''''' 

   PRINT @CCMD        
   EXEC SP_EXECUTESQL @CCMD     
     
   IF OBJECT_ID ('TEMPDB..#TMPSTOCK','U') IS NOT NULL
	   DROP TABLE #TMPSTOCK

	SELECT DEPT_ID,BIN_ID,PRODUCT_CODE,QUANTITY_IN_STOCK 
	INTO #TMPSTOCK
	FROM PMT01106 WHERE 1=2

	IF EXISTS (SELECT TOP 1 'U' FROM PIM01106 WHERE MRR_ID=@CMRRIDSEARCH )
	BEGIN
	    INSERT INTO #TMPSTOCK(DEPT_ID,BIN_ID,PRODUCT_CODE,QUANTITY_IN_STOCK )
		SELECT B.DEPT_ID,B.BIN_ID,A.PRODUCT_CODE,-1*A.QUANTITY QUANTITY_IN_STOCK 
		FROM PID01106 A (NOLOCK)
		JOIN PIM01106 B (NOLOCK) ON A.MRR_ID=B.MRR_ID 
		WHERE A.MRR_ID=@CMRRIDSEARCH

	END 
     


    --SELECT 	@CCURDEPTID
	IF ISNULL(@CMRRIDSEARCH,'')=''
	BEGIN      
		REGENRATE: 
		
		PRINT 'WHEN NO DATA FOUND IN GROUP PURCHASE'
		
		EXEC SAVETRAN_GETMEMOPREFIX
		@CXNTYPE='GRP_PUR',
		@CUSERCODE=@CWIZAPPUSERCODE,
		@CFINYEAR=@CFINYEAR,
		@CSOURCELOCID=@CCURDEPTID,
		@CTARGETLOCID='',
		@CMANUALPREFIX=@CMEMONOPREFIX,
		@CMEMOID=@CINVID,
		@CMEMOPREFIX=@CMEMOPREFIXPROC OUTPUT,
		@CERRORMSG=@CERRMSG OUTPUT

		
		IF ISNULL(@CERRMSG,'')<>''
			GOTO EXIT_PROC
		
		
		DECLARE @NMEMONOLEN NUMERIC(10,0)
		SET @NMEMONOLEN=LEN(@CMEMOPREFIXPROC)+6
	   SET @CSTEP=300	
	  
		EXEC GETNEXTKEY 'PIM01106', 'MRR_NO', @NMEMONOLEN, @CMEMOPREFIXPROC, 1,@CFINYEAR,0, @MRR_NO OUTPUT
	
	

		--SELECT  @MRR_NO AS MEMO_NO
		IF @MRR_NO IS NULL            
		BEGIN      
		    SET @CERRMSG = 'STEP- ' + LTRIM(STR(@CSTEP)) + ' ERROR CREATING NEXT MRR_NO....'           
			GOTO EXIT_PROC              
		END        
		
		IF EXISTS (SELECT TOP 1 * FROM PIM01106 WITH (NOLOCK) WHERE MRR_NO = @MRR_NO AND FIN_YEAR = @CFINYEAR)
			GOTO REGENRATE
		
		SET @CMRRID = @CCURDEPTID +@CFINYEAR+ ISNULL(REPLICATE('0', 15-LEN(LTRIM(RTRIM(@MRR_NO)))),'') + LTRIM(RTRIM(@MRR_NO))          
		
				
		IF @CMRRID IS NULL            
		BEGIN          
			SET @CERRMSG = 'STEP- ' + LTRIM(STR(@CSTEP)) + ' ERROR CREATING NEXT MRR_ID.'          
			GOTO EXIT_PROC          
		END 
		
		IF EXISTS (SELECT TOP 1 * FROM PIM01106 WITH (NOLOCK) WHERE MRR_id = @CMRRID)
			GOTO REGENRATE
    END
        		 
	
      PRINT 'CHECK UPDATE'      
      PRINT  @MRR_NO      
      PRINT @CMRRID
      PRINT @MRR_NO
      PRINT @CSOURCEDB
      PRINT @CTMP_TABLENAME
     
     UPDATE A SET AC_code=@cSourceAcCode,mrr_no =@MRR_NO,mrr_id=@CMRRID,BIN_ID ='000',
	 MEMO_TYPE=(CASE WHEN a.MEMO_TYPE=0 THEN 1 ELSE a.MEMO_TYPE END),
	 BROKER_AC_CODE='0000000000',GOODS_TDS_AMOUNT=0,GOODS_TDS_BASEAMOUNT=0,GOODS_TDS_PERCENTAGE=0,
	 MRR_CREATION_DEPT_ID =@CCURDEPTID
	 FROM pur_pim01106_upload A WITH (ROWLOCK) 
	 WHERE sp_id=@Csp_id 

	 update a set mrr_id=@CMRRID FROM pur_pid01106_upload A WITH (ROWLOCK) 
	 WHERE sp_id=@Csp_id 
   

	SET @cStep='385'
	EXEC SP3S_upd_qty_lastupdate
	@nUpdateMode=1,
	@cXnType='pur',
	@cMemoId=@cMrrId,
	@nSpId=@@spid,
	@cMasterTable='PIM01106',
	@cMemoIdCol='mrr_id',
	@cXnDtCol='receipt_dt',
	@CERRORMSG=@CERRMSG OUTPUT
	
	IF ISNULL(@CERRMSG,'')<>''
		GOTO EXIT_PROC	


    SET @CTABLENAME='PIM01106'        
    SET @CTMP_TABLENAME='pur_pim01106_upload'       
    SET @CKEYFIELD='MRR_ID'        
    SET @CWHERECLAUSE = ' b.SP_ID='''+LTRIM(RTRIM((@Csp_id )))+''''
 

	PRINT @CWHERECLAUSE
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CMERGEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@bAddmode,@LUPDATEONLY=0,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CWHERECLAUSE,@BUPDATEXNS=1
  --SELECT * FROM PIM01106    


		SET @CTABLENAME='PID01106'        
		SET @CTMP_TABLENAME='pur_pid01106_upload'
		SET @CKEYFIELD='MRR_ID'        
		SET @CSTEP= 700        
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CMERGEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
				,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
				,@LINSERTONLY=0,@LUPDATEONLY=0        
				,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CWHERECLAUSE
	
	 
        
 
	    INSERT INTO #TMPSTOCK(DEPT_ID,BIN_ID,PRODUCT_CODE,QUANTITY_IN_STOCK )
		SELECT B.DEPT_ID,B.BIN_ID,A.PRODUCT_CODE,A.QUANTITY QUANTITY_IN_STOCK 
		FROM PID01106 A (NOLOCK)
		JOIN PIM01106 B (NOLOCK) ON A.MRR_ID=B.MRR_ID 
		WHERE A.MRR_ID=@cMrrId AND CANCELLED=0



		
	 INSERT PMT01106	( BIN_ID, DEPT_ID, DEPT_ID_NOT_STUFFED, last_update, product_code, quantity_in_stock, rep_id, STOCK_RECO_QUANTITY_IN_STOCK )  
	 SELECT  DISTINCT 	 A. BIN_ID,A. DEPT_ID, '' AS DEPT_ID_NOT_STUFFED,GETDATE() last_update,
	 a.product_code,0 AS quantity_in_stock,'' rep_id, 0 STOCK_RECO_QUANTITY_IN_STOCK 
	 FROM #TMPSTOCK A
	 LEFT JOIN PMT01106 B ON A.PRODUCT_CODE=B.PRODUCT_CODE AND A.DEPT_ID=B.DEPT_ID AND A.BIN_ID=B.BIN_ID 
	 WHERE B.BIN_ID IS NULL

	 UPDATE A SET QUANTITY_IN_STOCK=A.QUANTITY_IN_STOCK+ISNULL(B.QUANTITY_IN_STOCK,0) 
	 FROM PMT01106 A
	 JOIN
	 (
	  SELECT DEPT_ID,PRODUCT_CODE,BIN_ID,SUM(QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK
	  FROM #TMPSTOCK
	  GROUP BY DEPT_ID,PRODUCT_CODE,BIN_ID
	 ) B ON A.PRODUCT_CODE=B.PRODUCT_CODE AND A.DEPT_ID=B.DEPT_ID AND A.BIN_ID =B.BIN_ID 

	
  
 

   							
 END TRY        
 BEGIN CATCH
  PRINT 'CATCH START'       
  SET @CERRMSG='P:SAVETRAN_MERGE_MIRROR_PARTYWSL_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
 END CATCH        
        
EXIT_PROC:   


 	
	
 IF ISNULL(@CERRMSG,'')='' AND ISNULL(@CCMDOUTPUT,'')=''
 BEGIN
 		SET @CSTEP=570	
	
	--DELETE FROM PUR_pim01106_UPLOAD  WITH (ROWLOCK) where sp_id=@Csp_id 
	--DELETE FROM PUR_pid01106_UPLOAD WITH (ROWLOCK) where sp_id=@Csp_id

	
	
 END


 IF @@trancount>0 
 BEGIN
	IF ISNULL(@cErrmsg,'')=''
	begin
	     COMMIT
		
	end
	ELSE
	begin
		ROLLBACK
		
	end
 END

 select @CERRMSG as errmsg

		
 
END 
------ END OF CREATING PROCEDURE - SAVETRAN_MERGE_MIRROR_PARTYWSL_DATA

