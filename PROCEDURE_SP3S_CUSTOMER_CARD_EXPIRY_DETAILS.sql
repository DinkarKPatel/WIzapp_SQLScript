CREATE PROCEDURE SP3S_CUSTOMER_CARD_EXPIRY_DETAILS
AS
BEGIN
    
    IF EXISTS (SELECT TOP 1 'U' FROM REP_CRM WHERE REP_CODE= 'MSC29')
    BEGIN
        
	  DECLARE @CSMS VARCHAR(MAX),@CEMAIL VARCHAR(MAX)
	  SELECT TOP 1 @CSMS=SMS,@CEMAIL=EMAIL   FROM REP_CRM WHERE REP_CODE= 'MSC29'
        INSERT CUSTOMER_CARD_EXPIRY_SMSLOG	( CUSTOMER_CODE, CARD_NO, DT_CARD_EXPIRY, SMS, SMS_SENT_ON, MSG_SENT, MOBILE, EMAIL_ID, EMAIL_SUBJECT, EMAIL_BODY, EMAIL_SENT )  
        SELECT 	  A.CUSTOMER_CODE, A.CARD_NO, A.DT_CARD_EXPIRY, 
                  SMS=REPLACE(REPLACE(REPLACE(@CSMS,'<CUSTOMER NAME>', A.CUSTOMER_TITLE +' '+CUSTOMER_FNAME+' '+CUSTOMER_LNAME ),'<CARD_NO>',A.CARD_NO),'<CARD_EXP_DT>',CONVERT(VARCHAR(10),A.DT_CARD_EXPIRY,126)), 
                  SMS_SENT_ON='', 
                  MSG_SENT=0, A.MOBILE, 
                  EMAIL_ID=A.EMAIL, 
                  EMAIL_SUBJECT='CARD EXPIRY', 
                  EMAIL_BODY=REPLACE(REPLACE(REPLACE(@CEMAIL,'<CUSTOMER NAME>', A.CUSTOMER_TITLE +' '+CUSTOMER_FNAME+' '+CUSTOMER_LNAME ),'<CARD_NO>',A.CARD_NO),'<CARD_EXP_DT>',CONVERT(VARCHAR(10),A.DT_CARD_EXPIRY,126)), EMAIL_SENT=0 
        FROM CUSTDYM A
        LEFT OUTER JOIN CUSTOMER_CARD_EXPIRY_SMSLOG B ON A.CUSTOMER_CODE =B.CUSTOMER_CODE
        WHERE A.DT_CARD_EXPIRY BETWEEN 
        CONVERT(VARCHAR(10),GETDATE(),126) AND  CONVERT(VARCHAR(10),GETDATE()+6,126)
        AND B.CUSTOMER_CODE IS NULL AND ISNULL(A.CARD_NO,'')<>'' AND ISNULL(A.MOBILE,'') <>''
        
      
        
       
    
    END


END
