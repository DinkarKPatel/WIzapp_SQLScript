CREATE PROCEDURE SP3S_VOUCHER_LIST (@FRMDT DATETIME=NULL,@TODT DATETIME=NULL
,@POSTINGFRMDT DATETIME=NULL,@POSTINGTODT DATETIME=NULL
,@VOUCHER_TYPE VARCHAR(10)='',@VOUCHER_NO VARCHAR(100)='',@CANCEL INT)
AS
BEGIN
--1=CANCEL
--0=UNCANCEL
--2=BOTH
   DECLARE @CASE VARCHAR(10),@SQL VARCHAR(MAX),@WHERE VARCHAR(1000)
   SET @CASE=''
   IF YEAR(ISNULL(@FRMDT,''))=1900
      SET @CASE='0'
   ELSE    
      SET @CASE='1'
      
   IF YEAR(ISNULL(@POSTINGFRMDT,''))=1900
      SET @CASE+='0'
   ELSE
      SET @CASE+='1'

   IF @VOUCHER_TYPE=''
      SET @CASE+='0'
   ELSE
      SET @CASE+='1'
      
   IF @VOUCHER_NO=''
      SET @CASE+='0'
   ELSE
      SET @CASE+='1'
   
   SET @WHERE=CHAR(13)+' WHERE '
   
   SELECT @WHERE+=CASE @CANCEL
			          WHEN 0 THEN 'M.CANCELLED=0'
					  WHEN 1 THEN 'M.CANCELLED=1'
					  WHEN 2 THEN 'M.CANCELLED IN (0,1)'
				 END
	   
   IF SUBSTRING(@CASE,1,1)='1'
      SET @WHERE+=' AND (M.VOUCHER_DT BETWEEN '''+REPLACE(CONVERT(VARCHAR,@FRMDT,102),'.','-')+''' AND '''+REPLACE(CONVERT(VARCHAR,@TODT,102),'.','-')+''')'
   
   IF SUBSTRING(@CASE,2,1)='1'
      SET @WHERE+=' AND (M.LAST_UPDATE BETWEEN '''+REPLACE(CONVERT(VARCHAR,@POSTINGFRMDT,102),'.','-')+''' AND '''+REPLACE(CONVERT(VARCHAR,@POSTINGTODT,102),'.','-')+''')'
    
   IF SUBSTRING(@CASE,3,1)='1'
      SET @WHERE+=' AND VTYP.VOUCHER_TYPE='''+@VOUCHER_TYPE+''''
         
   IF SUBSTRING(@CASE,4,1)='1'
      SET @WHERE+=' AND M.VOUCHER_NO='''+@VOUCHER_NO+''''
   
   SET @SQL='SELECT M.*,VTYP.VOUCHER_TYPE,[STATUS]=CASE M.CANCELLED WHEN 0 THEN ''UNCANCELLED'' ELSE ''CANCELLED'' END 
   FROM VM01106 M(NOLOCK)
   JOIN VCHTYPE VTYP (NOLOCK) ON VTYP.VOUCHER_CODE=M.VOUCHER_CODE'+@WHERE
   
   EXEC(@SQL)
 				 
   SET @SQL='SELECT D.VM_ID AS VM_IDD,D.X_TYPE,D.CREDIT_AMOUNT,D.DEBIT_AMOUNT,D.NARRATION,AC.AC_NAME 
   FROM VM01106 M(NOLOCK) JOIN VD01106 D(NOLOCK) ON M.VM_ID=D.VM_ID
   JOIN VCHTYPE VTYP (NOLOCK) ON VTYP.VOUCHER_CODE=M.VOUCHER_CODE
   JOIN LMV01106 AC(NOLOCK) ON AC.AC_CODE=D.AC_CODE'+@WHERE
   
   EXEC(@SQL)
END
