CREATE VIEW VW_WL_PRD_PURCHASEINVOICELIST 

AS           
SELECT   
A.RECEIPT_DT AS 'MEMO_DT',   
A.MRR_NO AS 'MEMO_NO',   
A.INV_NO AS 'CHALLAN_NO',   
A.BILL_NO AS 'BILL_NO',  
A.CHECKED_BY AS 'CHECKED_BY',  
(CASE WHEN A.CANCELLED = 0 THEN A.TOTAL_AMOUNT  ELSE 0 END) AS 'NET_PURCHASE_VALUE',          
A.INV_DT AS 'BILL_DATE',   
A.VANDOR_BILL_DT AS 'VENDOR_BILL_DATE',
(CASE WHEN A.CANCELLED = 0 THEN A.DISCOUNT_AMOUNT  ELSE 0 END)  AS 'BILL_DISCOUNT_AMOUNT',  
A.DISCOUNT_PERCENTAGE AS 'DISCOUNT_PERCENTAGE',  
(CASE WHEN A.CANCELLED = 0 THEN A.FREIGHT  ELSE 0 END) AS 'FREIGHT',  
(CASE WHEN A.CANCELLED = 0 THEN A.OTHER_CHARGES  ELSE 0 END) AS 'OTHER_CHARGES',  
(CASE WHEN A.CANCELLED = 0 THEN A.ROUND_OFF  ELSE 0 END) AS 'ROUND_OFF',  
A.RECEIVED_BY AS 'RECEIVED_BY',  
A.REMARKS AS 'REMARKS',  
(CASE WHEN A.CANCELLED = 0 THEN A.SUBTOTAL  ELSE 0 END) AS 'SUBTOTAL',  
 B.AC_NAME AS 'SUPPLIER_NAME', 
 H.USERNAME AS 'CREATED_BY_USER',  
(CASE WHEN A.CANCELLED = 0 THEN ISNULL(D.TOTAL_QUANTITY,0) ELSE 0 END)  AS TOTAL_QUANTITY,   
(CASE WHEN A.CANCELLED = 0 THEN ISNULL(D.TOTAL_MRP_VALUE,0) ELSE 0 END) AS TOTAL_MRP_VALUE,  
(CASE WHEN A.CANCELLED = 0 THEN ISNULL(D.ITEM_GROSS_AMOUNT,0) ELSE 0 END) AS ITEM_GROSS_AMOUNT,
(CASE WHEN A.CANCELLED = 0 THEN ISNULL(D.ITEM_DISCOUNT_AMOUNT,0) ELSE 0 END) AS ITEM_DISCOUNT_AMOUNT,
(CASE WHEN A.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END) AS CANCELLED,
(CASE WHEN A.POSTEDINAC  = 1 OR ISNULL(VM.VM_ID,'')<>'' THEN 'POSTED' ELSE 'PENDING' END) AS AC_POSTED  
,A.MRR_ID AS 'MEMO_ID',A.FIN_YEAR ,
F.FORM_NAME AS TAX_TYPE,D.TAX_PERCENTAGE ,D.TAX_AMOUNT   
FROM PRD_PIM01106 A (NOLOCK)           
JOIN LM01106 B (NOLOCK)  ON A.AC_CODE = B.AC_CODE          
JOIN FORM G (NOLOCK)  ON A.FORM_ID = G.FORM_ID  
JOIN USERS H (NOLOCK) ON A.USER_CODE = H.USER_CODE  
LEFT OUTER JOIN VM_MRR VM (NOLOCK) ON VM.MRR_ID=A.MRR_ID  

LEFT OUTER JOIN 
(
	SELECT MRR_ID, FORM_ID,TAX_PERCENTAGE ,SUM(QUANTITY) AS 'TOTAL_QUANTITY',     
	SUM(QUANTITY*MRP) AS 'TOTAL_MRP_VALUE',    
	SUM(GROSS_PURCHASE_PRICE * QUANTITY) AS 'ITEM_GROSS_AMOUNT',  
	SUM(DISCOUNT_AMOUNT) AS 'ITEM_DISCOUNT_AMOUNT' , SUM(TAX_AMOUNT) AS TAX_AMOUNT
	FROM PRD_PID01106 GROUP BY MRR_ID  , FORM_ID,TAX_PERCENTAGE
) D ON D.MRR_ID=A.MRR_ID 
 LEFT OUTER JOIN FORM F ON D.FORM_ID = F.FORM_ID
