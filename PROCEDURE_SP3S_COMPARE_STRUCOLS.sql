CREATE PROCEDURE SP3S_COMPARE_STRUCOLS
AS
BEGIN
	DECLARE @CTABLENAME VARCHAR(500),@CCOLNAME VARCHAR(500),@CCOLDATATYPE VARCHAR(200),@CCONSTNAME VARCHAR(500),
	@CDEFINITION VARCHAR(500),@NCOLLENGTH NUMERIC(5,0),@NCOLXPREC NUMERIC(5,0),@NCOLXSCALE NUMERIC(5,0),@BISCOLNULLABLE BIT,
		@CDEFAULTVAL VARCHAR(5),@CCMD NVARCHAR(MAX),@BFLAG BIT,@CSTEP VARCHAR(5),@CERRORMSG VARCHAR(500)

BEGIN TRY	
	SET @CSTEP='10'	
	SET @CERRORMSG=''
	
	SET @CSTEP='135'
	---CREATE THE MISSING INDEXES
	TRUNCATE TABLE TARGETDBINDEXKEYS
	
	INSERT TARGETDBINDEXKEYS	( TABLENAME,INDEX_NAME)
	SELECT A.NAME AS TABLENAME,B.NAME AS INDEXNAME FROM SYSOBJECTS A (NOLOCK)
	JOIN SYSINDEXES B (NOLOCK) ON A.ID=B.ID
	JOIN SYSINDEXKEYS C (NOLOCK) ON C.ID=B.ID AND C.INDID=B.INDID
	JOIN SYSCOLUMNS D (NOLOCK) ON D.ID=C.ID AND D.COLID =C.COLID
    LEFT OUTER JOIN STRUCOMP_SQLEXPR H (NOLOCK) ON H.TABLENAME=A.NAME AND H.COLNAME=D.NAME
	WHERE A.XTYPE='U' AND B.INDID BETWEEN 1 AND 254 
	AND INDEXPROPERTY(A.ID,B.NAME,'ISUNIQUE')=0
	AND INDEXPROPERTY(A.ID,B.NAME,'ISSTATISTICS')=0
	AND INDEXPROPERTY(A.ID,B.NAME,'ISHYPOTHETICAL')=0
	
	SET @CSTEP='140'
	
	SELECT DISTINCT A.TABLENAME,A.CMD,A.INDEX_NAME INTO #TMPINDEXESNOTFOUND FROM SOURCEDBINDEXKEYS_COMP A (NOLOCK) 
	LEFT OUTER JOIN TARGETDBINDEXKEYS B (NOLOCK) ON A.TABLENAME=B.TABLENAME AND A.INDEX_NAME=B.INDEX_NAME
	WHERE B.TABLENAME IS NULL

	SET @BFLAG=0
	WHILE @BFLAG=0
	BEGIN
		SET @CSTEP='150'
		SET @CCMD=''
		
		SELECT TOP 1 @CCMD=CMD,@CCONSTNAME=INDEX_NAME FROM #TMPINDEXESNOTFOUND
		
		IF ISNULL(@CCMD,'')=''
			BREAK
		
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD	
		
		DELETE FROM #TMPINDEXESNOTFOUND WHERE INDEX_NAME=@CCONSTNAME	
	END	
	

					
END TRY

BEGIN CATCH
	SET @CERRORMSG='ERROR IN PROCEDURE SP3S_COMPARE_STRUCOLS AT STEP#'+@CSTEP+' '+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:
	SELECT ISNULL(@CERRORMSG,'') AS ERRMSG		
END
