
DELETE FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN'

IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_MST' AND FIELD_NAME='hsn_type') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_MST','','hsn_type','','UPDATE','hsn_type'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_MST' AND FIELD_NAME='inactive') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_MST','','inactive','','UPDATE','inactive'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_MST' AND FIELD_NAME='RETAILSALE_TAX_METHOD') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_MST','','RETAILSALE_TAX_METHOD','','UPDATE','RETAILSALE_TAX_METHOD'


IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_DET' AND FIELD_NAME='TAX_PERCENTAGE') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_DET','','TAX_PERCENTAGE','','UPDATE','TAX_PERCENTAGE'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_DET' AND FIELD_NAME='RATE_CUTOFF') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_DET','','RATE_CUTOFF','','UPDATE','RATE_CUTOFF'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_DET' AND FIELD_NAME='RATE_CUTOFF_TAX_PERCENTAGE') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_DET','','RATE_CUTOFF_TAX_PERCENTAGE','','UPDATE','RATE_CUTOFF_TAX_PERCENTAGE'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_DET' AND FIELD_NAME='WEF') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_DET','','WEF','','UPDATE','WEF'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_DET' AND FIELD_NAME='GST_CAL_BASIS') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_DET','','GST_CAL_BASIS','','UPDATE','GST_CAL_BASIS'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_DET' AND FIELD_NAME='DEPT_ID') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_DET','','DEPT_ID','','UPDATE','DEPT_ID'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_DET' AND FIELD_NAME='Rate_CutOff_Gst_Cess_Percentage') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_DET','','Rate_CutOff_Gst_Cess_Percentage','','UPDATE','Rate_CutOff_Gst_Cess_Percentage'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_DET' AND FIELD_NAME='Gst_Cess_Percentage') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_DET','','Gst_Cess_Percentage','','UPDATE','Gst_Cess_Percentage'

IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='HSN' AND TABLE_NAME='HSN_DET' AND FIELD_NAME='') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'HSN','HSN_DET','','','','DELETE',''

   
 UPDATE  XN_AUDIT_TRIAL_MST SET KEY_FIELDS='HSN_CODE+' WHERE TABLE_NAME IN('HSN_DET','HSN_MST') AND FIELD_NAME <>''
   
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=1 WHERE TABLE_NAME='HSN_DET' AND FIELD_NAME='HSN_CODE'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=2 WHERE TABLE_NAME='HSN_DET' AND FIELD_NAME='TAX_PERCENTAGE'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=3 WHERE TABLE_NAME='HSN_DET' AND FIELD_NAME LIKE 'RATE_CUTOFF'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=4 WHERE TABLE_NAME='HSN_DET' AND FIELD_NAME='RATE_CUTOFF_TAX_PERCENTAGE'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=5 WHERE TABLE_NAME='HSN_DET' AND FIELD_NAME='WEF'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=6 WHERE TABLE_NAME='HSN_DET' AND FIELD_NAME='GST_CAL_BASIS'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=7 WHERE TABLE_NAME='HSN_DET' AND FIELD_NAME='Rate_CutOff_Gst_Cess_Percentage'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=8 WHERE TABLE_NAME='HSN_DET' AND FIELD_NAME='Gst_Cess_Percentage'



UPDATE XN_AUDIT_TRIAL_MST SET TRIG=UPPER(TRIG) WHERE XN_TYPE ='HSN'

UPDATE X SET X.DATA_TYPE=C.DATA_TYPE
FROM XN_AUDIT_TRIAL_MST X 
JOIN INFORMATION_SCHEMA.COLUMNS C ON C.TABLE_NAME=X.TABLE_NAME AND C.COLUMN_NAME=X.FIELD_NAME
WHERE TRIG='UPDATE' and  XN_TYPE ='HSN'


IF OBJECT_ID('TEMPDB..#PKEY','U') IS NOT NULL
   DROP TABLE #PKEY
SELECT DISTINCT X.TABLE_NAME,COL.COLUMN_NAME,COL.ORDINAL_POSITION
INTO #PKEY
FROM XN_AUDIT_TRIAL_MST X (ROWLOCK) 
JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS PK
JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE COL ON PK.TABLE_NAME=COL.TABLE_NAME AND PK.CONSTRAINT_NAME=COL.CONSTRAINT_NAME AND PK.CONSTRAINT_TYPE='PRIMARY KEY'
ON X.TABLE_NAME=PK.TABLE_NAME
WHERE XN_TYPE ='HSN'
DECLARE @TAB VARCHAR(100),@KEY VARCHAR(1000)
IF CURSOR_STATUS('GLOBAL','PKEY') IN (0,1)
   BEGIN
     CLOSE PKEY
	 DEALLOCATE PKEY
   END
DECLARE PKEY CURSOR FOR SELECT DISTINCT TABLE_NAME FROM #PKEY
OPEN PKEY
FETCH NEXT FROM PKEY INTO @TAB
WHILE @@FETCH_STATUS=0
  BEGIN
    SET @KEY='' 
    SELECT @KEY=COALESCE('',@KEY)+COLUMN_NAME+'+' FROM #PKEY WHERE TABLE_NAME=@TAB ORDER BY ORDINAL_POSITION
    UPDATE XN_AUDIT_TRIAL_MST SET KEY_FIELDS=UPPER(@KEY) WHERE TABLE_NAME=@TAB
    FETCH NEXT FROM PKEY INTO @TAB
  END
CLOSE PKEY
DEALLOCATE PKEY

