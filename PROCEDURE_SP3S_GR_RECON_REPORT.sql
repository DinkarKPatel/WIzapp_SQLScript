CREATE PROCEDURE SP3S_GR_RECON_REPORT
(
	@CASONDATE	DATETIME,
	@CLOC VARCHAR(5)=''
)
AS
BEGIN	

    DECLARE @STARTDATE DATETIME,@CDEPTID VARCHAR(10),@SLR_RECON_REQD bit
    
    IF @CASONDATE=''
    SET @CASONDATE=GETDATE()
    
	IF @CLOC=''
    SELECT TOP 1 @CDEPTID = DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
	ELSE 
	SET @CDEPTID=@CLOC

 --   SELECT TOP 1 @STARTDATE=SLR_RECON_CUTOFF_DATE  FROM LOCATION WHERE DEPT_ID=@CDEPTID 
    
 --   --donot show report if gr recon not enable
   
	--IF OBJECT_ID('tempdb..#tmpSlrPending','U') IS NOT NULL
	--	DROP TABLE #tmpSlrPending
		
	--select a.row_id into #tmpSlrPending FROM 
	--CMD01106  A  (NOLOCK) 
	--JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=A.CM_ID
	--join location l (nolock) on L.DEPT_ID =CMM.LOCATION_CODE 
	--left outer join
	--(select a.cmd_row_id,SUM(a.quantity) as quantity FROM 
	-- SLR_RECON_DET  a (NOLOCK)
	-- JOIN SLR_RECON_MST b (NOLOCK) ON a.MEMO_ID=b.MEMO_ID
	-- JOIN cmd01106 c (NOLOCK) ON c.row_id=a.cmd_row_id
	-- JOIN cmm01106 d (NOLOCK) On d.cm_id=c.cm_id
	-- WHERE d.CANCELLED=0 AND b.CANCELLED=0 AND A.QUANTITY<0 AND d.CM_DT BETWEEN @STARTDATE AND @CASONDATE
	-- GROUP BY a.cmd_row_id
	--) c on c.CMD_ROW_ID=A.ROW_ID 

 --   WHERE CMM.CANCELLED=0 AND A.QUANTITY<0 AND CMM.CM_DT BETWEEN @STARTDATE AND @CASONDATE
	--AND A.QUANTITY<>ISNULL(c.QUANTITY,0)
	--AND (@CLOC='' OR CMM.location_Code =@CLOC)
	--and ISNULL(l.SLR_RECON_REQD,0)=1
	
	


	--SELECT A.*,
	--		A.SR_NO AS SRNO,  
	--		EMP.EMP_NAME, A.PRODUCT_CODE, sku.ARTICLE_CODE, sn.ARTICLE_NO, sn.ARTICLE_NAME, sku.PARA1_CODE,    
	--		sn.PARA1_NAME, sku.PARA2_CODE, sn.PARA2_NAME, sku.PARA3_CODE, sn.PARA3_NAME, sn.uom UOM_NAME,       
	--		CMM.location_Code as DEPT_ID, sku.barcode_coding_scheme CODING_SCHEME,  ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK ,   
	--		SKU.PURCHASE_PRICE,  SKU.MRP,SKU.WS_PRICE,   sn.SECTION_NAME, sn.SUB_SECTION_NAME,    
	--		sku.PARA4_CODE,sku.PARA5_CODE,sku.PARA6_CODE,    
	--		PARA4_NAME,PARA5_NAME,PARA6_NAME,e.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],    
	--		'' AS [ART_DT_CREATED],'' AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],    
	--		A.MRP AS [LOCSKU_MRP],SKU.PRODUCT_NAME,  
	--		EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2
	--		,ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],sn.article_alias AS ARTICLE_ALIAS 
	--		,CMM.CM_NO	,CONVERT(VARCHAR(20),CMM.CM_DT,105) AS [CM_DT],ISNULL(SLR_DET.QUANTITY,0) AS [RETURNED_QTY],
	--		'' AS [RECON_MEMO_NO],'' AS [RECON_MEMO_DT]
	--FROM  CMD01106  A  (NOLOCK) 
	--JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=A.CM_ID
	--JOIN #tmpSlrPending pn (nolock) on pn.row_id=a.row_id
	--join sku (nolock) on sku.product_code =a.PRODUCT_CODE 
	--JOIN SKU_NAMES SN (NOLOCK) ON SN.PRODUCT_CODE=A.PRODUCT_CODE  
	--LEFT OUTER JOIN PMT01106 P  (NOLOCK) ON P.PRODUCT_CODE=A.PRODUCT_CODE AND P.BIN_ID=A.BIN_ID AND P.DEPT_ID=A.dept_id  
	--LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID  
	--JOIN UOM E  (NOLOCK) ON sn.uom = E.uom_name 


	--JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
	--LEFT OUTER JOIN PMT01106 P  (NOLOCK) ON P.PRODUCT_CODE=A.PRODUCT_CODE AND P.BIN_ID=A.BIN_ID AND P.DEPT_ID=A.dept_id  
	--LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID  
	--JOIN ARTICLE B  (NOLOCK) ON SKU.ARTICLE_CODE = B.ARTICLE_CODE      
	--JOIN SECTIOND SD  (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	--JOIN SECTIONM SM  (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	--JOIN PARA1 C  (NOLOCK) ON SKU.PARA1_CODE = C.PARA1_CODE      
	--JOIN PARA2 D  (NOLOCK) ON SKU.PARA2_CODE = D.PARA2_CODE      
	--JOIN PARA3 F  (NOLOCK) ON SKU.PARA3_CODE = F.PARA3_CODE      
	--JOIN PARA4 G  (NOLOCK) ON SKU.PARA4_CODE = G.PARA4_CODE      
	--JOIN PARA5 H  (NOLOCK) ON SKU.PARA5_CODE = H.PARA5_CODE      
	--JOIN PARA6 I  (NOLOCK) ON SKU.PARA6_CODE = I.PARA6_CODE      
	--JOIN UOM E  (NOLOCK) ON B.UOM_CODE = E.UOM_CODE 
	--LEFT OUTER JOIN NRM N (NOLOCK) ON N.NRM_ID=ISNULL(A.NRM_ID,'0000000')
	--LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON A.EMP_CODE = EMP.EMP_CODE   
	--LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON A.EMP_CODE1 = EMP1.EMP_CODE     
	--LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON A.EMP_CODE2 = EMP2.EMP_CODE    
	----LEFT OUTER JOIN SLSDET S (NOLOCK) ON S.ROW_ID =A.SLSDET_ROW_ID
	--LEFT OUTER JOIN 
	--(select a.cmd_row_id,SUM(a.quantity) as quantity FROM 
	-- SLR_RECON_DET  a (NOLOCK)
	-- JOIN SLR_RECON_MST b (NOLOCK) ON a.MEMO_ID=b.MEMO_ID
	-- JOIN cmd01106 c (NOLOCK) ON c.row_id=a.cmd_row_id
	-- JOIN cmm01106 d (NOLOCK) On d.cm_id=c.cm_id
	-- WHERE d.CANCELLED=0 AND b.CANCELLED=0 AND A.QUANTITY<0 AND d.CM_DT BETWEEN @STARTDATE AND @CASONDATE
	-- GROUP BY a.cmd_row_id
	--) SLR_DET ON SLR_DET.cmd_row_id=A.ROW_ID 
	--ORDER BY CMM.CM_DT 


	SELECT A.*,A.GRQuantity As Quantity,
	0 AS SRNO,  
	A.PRODUCTCODE AS PRODUCT_CODE,  sn.ARTICLE_NO, sn.ARTICLE_NAME,     
	sn.PARA1_NAME,  sn.PARA2_NAME,  sn.PARA3_NAME, sn.uom UOM_NAME,       
	CMM.location_Code as DEPT_ID, 
	0 AS QUANTITY_IN_STOCK ,   
	SN.PP AS PURCHASE_PRICE,  SN.MRP,SN.WS_PRICE,   sn.SECTION_NAME, sn.SUB_SECTION_NAME, 
	PARA4_NAME,PARA5_NAME,PARA6_NAME, 
	SN.MRP AS [LOCSKU_MRP],  		
	'' AS [BIN_NAME],sn.article_alias AS ARTICLE_ALIAS 
	,CMM.CM_NO	,CONVERT(VARCHAR(20),CMM.CM_DT,105) AS [CM_DT],
	ISNULL(RecoQty,0) AS [RETURNED_QTY],
	'' AS [RECON_MEMO_NO],'' AS [RECON_MEMO_DT]
	FROM  POSGRRecos   A  (NOLOCK) 
	JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=A.CM_ID	
	JOIN SKU_NAMES SN (NOLOCK) ON SN.PRODUCT_CODE=A.PRODUCTCODE 
	join location l (nolock) on L.DEPT_ID =CMM.LOCATION_CODE 
	WHERE CMM.CANCELLED=0 AND  ISNULL(l.SLR_RECON_REQD,0)=1
	AND (@CLOC='' OR CMM.location_Code =@CLOC)
	AND CMM.CM_DT BETWEEN '1900-01-01' AND @CASONDATE
	AND abs(GRQuantity -RecoQty) >0
	ORDER BY CMM.CM_DT 


END