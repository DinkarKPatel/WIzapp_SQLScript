

-- RETURNS THE BAR CODES WITH APPLIED SCHEME DISCOUNTS
CREATE PROCEDURE SP_APPLYSCHEMES
(
	@CBUNDLEID VARCHAR(50),
	@CSLSDETROWID VARCHAR(100),
	@NMODE	NUMERIC(1,0)=1,
	@BINCDISCITEMS  BIT=0,
	@CFILTERJOINSTR VARCHAR(MAX)
)
--WITH ENCRYPTION
AS 
BEGIN
	
	DECLARE @CPRODUCTCODE VARCHAR(50),@NMRP NUMERIC(10,2),@NDISCOUNTAMT NUMERIC(10,2),
			@NQTY NUMERIC(10,3),@NSCHEMEAPPLIEDQTY NUMERIC(10,3),@NLOOPCNT NUMERIC(3,0),
			@BPROCESS BIT,@CCMDSLSDETROWID VARCHAR(100),@NNEWROWID NUMERIC(3,0),@NSCHEMEAPPLIEDAMT NUMERIC(10,2),
			@CCMDROWID VARCHAR(500),@BAPPLYSSCHEMEEXCLUSIVELY BIT,@NDISCAPPMODE INT,
			@BDONOTAPPLYDISCONMULTISETS BIT,@BVALUEBASEDSET BIT
			
			
	
	IF NOT EXISTS (SELECT * FROM BUNDLEM WHERE BUNDLE_ID=@CBUNDLEID)
		RETURN
		

	--IF @CBUNDLEID IN ('0100016','0100018')
	--BEGIN
	--	SELECT @CBUNDLEID,* FROM #TMPCMD
	--	SELECT * FROM #TEMPCMDNORMALIZED
	--END
	
	DELETE FROM #TEMPCMDNORMALIZED
		
	IF OBJECT_ID('TEMPDB..#TEMPBUNDLEM','U') IS NOT NULL
		DROP TABLE #TEMPBUNDLEM
	
	SELECT BUNDLE_ID,CONVERT(BIT,0) AS MAX_QTY_ACHIEVED INTO #TEMPBUNDLEM FROM BUNDLEM WHERE 1=2
	
	SELECT @NDISCAPPMODE=DISC_APP_MODE,@BDONOTAPPLYDISCONMULTISETS=DONOT_APPLYDISCON_MULTISETS,
	@BVALUEBASEDSET=(CASE WHEN BUY_DISC_APP_MODE=2 THEN 1 ELSE 0 END),
	@BINCDISCITEMS=CONSIDER_NET_SALEVAL_BUYITEMS
	FROM BUNDLEM WHERE BUNDLE_ID=@CBUNDLEID
					
	DECLARE CMDCURSOR CURSOR  FOR SELECT PRODUCT_CODE,MRP,
	(CASE WHEN DISCOUNT_AMOUNT<>0 THEN DISCOUNT_AMOUNT ELSE MRP*DISCOUNT_PERCENTAGE/100 END) AS DISCOUNT_AMOUNT,
	QUANTITY,SCHEME_APPLIED_QTY,SLSDET_ROW_ID,SCHEME_APPLIED_AMOUNT,CMD_ROW_ID FROM #TMPCMD
	WHERE (@BINCDISCITEMS=1 OR SLSDET_ROW_ID='' OR (SCHEME_ID<>'' AND ABS(QUANTITY)-SCHEME_APPLIED_QTY>0))
	AND ((@NMODE=1 AND QUANTITY>0) OR (@NMODE=2 AND QUANTITY<0))
	OPEN CMDCURSOR
	FETCH NEXT FROM CMDCURSOR INTO @CPRODUCTCODE,@NMRP,@NDISCOUNTAMT,@NQTY,@NSCHEMEAPPLIEDQTY,
								   @CCMDSLSDETROWID,@NSCHEMEAPPLIEDAMT,@CCMDROWID
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @NLOOPCNT=1
		WHILE @NLOOPCNT<=ABS(@NQTY)-@NSCHEMEAPPLIEDQTY
		BEGIN
				
			INSERT #TEMPCMDNORMALIZED (PRODUCT_CODE,MRP,NET,SLSDET_ROW_ID,DISCOUNT_AMOUNT,DISCAMTCHANGED,
		    SCHEME_APPLIED_AMOUNT,OLD_SCHEME_APPLIED_AMOUNT,NETAMTCHANGED,DISCOUNT_FIGURE,SCHEME_ID,
		    BUNDLE_ROW_ID,ROW_ID,CMD_ROW_ID)
		    
		    SELECT @CPRODUCTCODE,(@NMRP-(ABS(@NDISCOUNTAMT)/ABS(@NQTY)))*(CASE WHEN @NQTY>0 THEN 1 ELSE -1 END),
		    (@NMRP-(ABS(@NDISCOUNTAMT)/ABS(@NQTY)))*
		    (CASE WHEN @NQTY>0 THEN 1 ELSE -1 END),@CCMDSLSDETROWID,0,0,@NSCHEMEAPPLIEDAMT,@NSCHEMEAPPLIEDAMT,0,0,'','','',@CCMDROWID
		    
			SET @NLOOPCNT=@NLOOPCNT+1
		END										
		FETCH NEXT FROM CMDCURSOR INTO @CPRODUCTCODE,@NMRP,@NDISCOUNTAMT,@NQTY,@NSCHEMEAPPLIEDQTY,
									   @CCMDSLSDETROWID,@NSCHEMEAPPLIEDAMT,@CCMDROWID
	END
	CLOSE CMDCURSOR
	DEALLOCATE CMDCURSOR
	
	
	SELECT @NNEWROWID=1
	UPDATE #TEMPCMDNORMALIZED SET ROW_ID=LTRIM(RTRIM(STR(@NNEWROWID))),@NNEWROWID=@NNEWROWID+1
	
	
	--SELECT 'NORMALIZED BEFORE',* FROM #TEMPCMDNORMALIZED
	
	----PRINT 'ENTER SCHEMES '+@CBUNDLEID
	SET @BPROCESS = 1
	WHILE @BPROCESS = 1
	BEGIN
		PRINT 'PROCESS BUNDLE :'+@CBUNDLEID
		EXEC SP_PROCESSBUNDLE @CBUNDLEID,@CSLSDETROWID,@CFILTERJOINSTR,@BPROCESS OUTPUT
		
		---- DO NOT APPLY SCHEME FOR MULTIPLE SETS
		IF (@NDISCAPPMODE=2 OR @BVALUEBASEDSET=1) AND @BDONOTAPPLYDISCONMULTISETS=1
			BREAK
		
	END

	
	--IF @CBUNDLEID IN ('0100018')
	--BEGIN
	--	SELECT 'BUNDLE PROCESSED:'+@CBUNDLEID,* FROM #TMPCMD
	--	SELECT * FROM #TEMPCMDNORMALIZED
	--END
    
    --SELECT 'NORMALIZED AFTER',* FROM #TEMPCMDNORMALIZED
    
	SELECT @BAPPLYSSCHEMEEXCLUSIVELY=APPLY_SCHEME_EXCLUSIVELY FROM BUNDLEM WHERE BUNDLE_ID=@CBUNDLEID
	
	UPDATE A SET DISCOUNT_AMOUNT=A.DISCOUNT_AMOUNT+B.DISCOUNT_AMOUNT,
						SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+ABS(B.QUANTITY),
						SLSDET_ROW_ID=C.SLSDET_ROW_ID,
						SCHEME_ID=C.SCHEME_ID,
						SCHEME_APPLIED_AMOUNT=(CASE WHEN @BAPPLYSSCHEMEEXCLUSIVELY=1 THEN A.MRP ELSE A.SCHEME_APPLIED_AMOUNT+B.SCHEME_APPLIED_AMOUNT END)
	FROM  #TMPCMD A 
	JOIN (SELECT CMD_ROW_ID,SUM(DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT,SUM(SCHEME_APPLIED_AMOUNT)
		  AS SCHEME_APPLIED_AMOUNT,COUNT(*) AS QUANTITY FROM #TEMPCMDNORMALIZED
		   GROUP BY CMD_ROW_ID) B ON B.CMD_ROW_ID=A.CMD_ROW_ID
	JOIN #TEMPCMDNORMALIZED C ON C.CMD_ROW_ID=A.CMD_ROW_ID
	
	WHERE  ABS(A.QUANTITY-A.SCHEME_APPLIED_QTY)>0
	AND (B.DISCOUNT_AMOUNT<>0 OR C.SCHEME_ID<>'')
	
	--SELECT 'AFTER SCHEME',* FROM #TMPCMD

	UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ABS((DISCOUNT_AMOUNT/(QUANTITY*MRP))*100)
	WHERE QUANTITY<>0 AND MRP>0
	
	--IF @CBUNDLEID IN ('0100016')
	--BEGIN
	--	SELECT 'TEMPCMD PROCESSED:',* FROM #TEMPCMDNORMALIZED
	--END
		
	--IF @CBUNDLEID IN ('0100012','0100013','0100014')
	--BEGIN
	--	SELECT @CBUNDLEID,* FROM #TMPCMD
	--	SELECT * FROM #TEMPCMDNORMALIZED
	--END
		
	END_PROC:
END
