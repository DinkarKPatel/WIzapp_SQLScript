CREATE PROCEDURE SP_GETPRODUCTCODE_SLS
@CUSERCODE	VARCHAR(100),
@NQTY		NUMERIC(10,2),
@CPRODUCTCODE	VARCHAR(MAX),
@cLOCID		VARCHAR(5)=''
--WITH ENCRYPTION
AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 
	IF ISNULL(@CLOCID,'')=''
		SELECT @CLOCID	=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
	
	DECLARE @dtSearch TABLE(PRODUCT_CODE VARCHAR(100),ARTICLE_CODE VARCHAR(20),ARTICLE_NO VARCHAR(100),ARTICLE_NAME  VARCHAR(100),
    QUANTITY NUMERIC(14,2),BIN_ID  VARCHAR(10),RATE NUMERIC(14,2),PARA3_NAME VARCHAR(100))
	if REPLACE(@CPRODUCTCODE,'%','')<>''
	BEGIN
		INSERT INTO @dtSearch(PRODUCT_CODE ,ARTICLE_CODE ,ARTICLE_NO ,ARTICLE_NAME ,    QUANTITY ,BIN_ID  ,RATE,PARA3_NAME )
		SELECT DISTINCT TOP 50 SKU.PRODUCT_CODE,'' AS ARTICLE_CODE,SKU.ARTICLE_NO,SKU.ARTICLE_NAME,
		P.QUANTITY_IN_STOCK AS [QUANTITY],P.BIN_ID ,SKU.MRP AS RATE ,SKU.para3_name
		FROM SKU_NAMES  SKU (NOLOCK)      
		LEFT OUTER JOIN PMT01106 P (NOLOCK) ON P.PRODUCT_CODE=SKU.PRODUCT_CODE   AND P.DEPT_ID =@cLOCID AND P.BIN_ID<>'999' 
		--JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE
		LEFT OUTER JOIN BINUSERS LOC (NOLOCK) ON LOC.BIN_ID=P.BIN_ID AND LOC.USER_CODE=@CUSERCODE  
		WHERE  SKU.PRODUCT_CODE<>''   
		AND (SKU.STOCK_NA=1 OR (P.QUANTITY_IN_STOCK>0 AND @NQTY>0) OR ( @NQTY<0)  )  
		--AND @CUSERCODE=(CASE WHEN @CUSERCODE='0000000' THEN @CUSERCODE ELSE LOC.USER_CODE END)  
		AND SKU.PRODUCT_CODE LIKE @CPRODUCTCODE  
		--AND ISNULL(ART.INACTIVE,0)= 0

		INSERT INTO @dtSearch(PRODUCT_CODE ,ARTICLE_CODE ,ARTICLE_NO ,ARTICLE_NAME ,    QUANTITY ,BIN_ID  ,RATE ,PARA3_NAME)
		SELECT DISTINCT TOP 50 SKU.PRODUCT_CODE,'' AS ARTICLE_CODE,SKU.ARTICLE_NO,SKU.ARTICLE_NAME,
		P.QUANTITY_IN_STOCK AS [QUANTITY],P.BIN_ID ,SKU.MRP AS RATE ,SKU.para3_name
		FROM SKU_NAMES  SKU (NOLOCK)      
		LEFT OUTER JOIN PMT01106 P (NOLOCK) ON P.PRODUCT_CODE=SKU.PRODUCT_CODE    AND P.DEPT_ID =@cLOCID AND P.BIN_ID<>'999' 
		LEFT OUTER JOIN BINUSERS LOC (NOLOCK) ON LOC.BIN_ID=P.BIN_ID AND LOC.USER_CODE=@CUSERCODE  
			LEFT OUTER JOIN @dtSearch S ON S.PRODUCT_CODE=SKU.product_Code
		WHERE  S.PRODUCT_CODE IS NULL AND    SKU.PRODUCT_CODE<>''   
		AND (SKU.STOCK_NA=1 OR (P.QUANTITY_IN_STOCK>0 AND @NQTY>0) OR ( @NQTY<0)  )  
		--AND @CUSERCODE=(CASE WHEN @CUSERCODE='0000000' THEN @CUSERCODE ELSE LOC.USER_CODE END)  
		AND SKU.ARTICLE_NO LIKE @CPRODUCTCODE  

		INSERT INTO @dtSearch(PRODUCT_CODE ,ARTICLE_CODE ,ARTICLE_NO ,ARTICLE_NAME ,    QUANTITY ,BIN_ID  ,RATE,PARA3_NAME )
		SELECT DISTINCT TOP 50 SKU.PRODUCT_CODE,'' AS ARTICLE_CODE,SKU.ARTICLE_NO,SKU.ARTICLE_NAME,
		P.QUANTITY_IN_STOCK AS [QUANTITY],P.BIN_ID ,SKU.MRP AS RATE ,SKU.para3_name
		FROM SKU_NAMES  SKU (NOLOCK)      
		LEFT OUTER JOIN PMT01106 P (NOLOCK) ON P.PRODUCT_CODE=SKU.PRODUCT_CODE    AND P.DEPT_ID =@cLOCID AND  P.BIN_ID<>'999' 
		LEFT OUTER JOIN BINUSERS LOC (NOLOCK) ON LOC.BIN_ID=P.BIN_ID AND LOC.USER_CODE=@CUSERCODE  
			LEFT OUTER JOIN @dtSearch S ON S.PRODUCT_CODE=SKU.product_Code
		WHERE S.PRODUCT_CODE IS NULL AND  SKU.PRODUCT_CODE<>''   
		AND (SKU.STOCK_NA=1 OR (P.QUANTITY_IN_STOCK>0 AND @NQTY>0) OR ( @NQTY<0)  )  
		--AND @CUSERCODE=(CASE WHEN @CUSERCODE='0000000' THEN @CUSERCODE ELSE LOC.USER_CODE END)  
		AND SKU.para3_name LIKE @CPRODUCTCODE  
	END
   SELECT * ,'Article : '+ARTICLE_NO +' | Style : '+ para3_name AS Description FROM @dtSearch
   ORDER BY PRODUCT_CODE
END


