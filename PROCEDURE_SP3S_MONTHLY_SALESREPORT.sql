CREATE PROCEDURE SP3S_MONTHLY_SALESREPORT
(
 @FM_DT VARCHAR(20)='',
 @DTO_DT VARCHAR(20)='',
 @CDEPT_ID VARCHAR(5)='', ---'' FOR ALL LOCATION AND AND LOC FILTER
 @NRV_QTY INT =1---1 FOR NRV 2 FOR QTY
)
--WITH ENCRYPTION 
AS
BEGIN
    IF @DTO_DT=''
    SET @DTO_DT=GETDATE()
    
  
    DECLARE @TBLREPORT TABLE (ORDER_NO INT,MTH_NAME CHAR(3),NRV NUMERIC(12,0),NRV_CONT_PER NUMERIC(10,0),QTY NUMERIC(12,0),QTY_CONT_PER NUMERIC(10,0))
    DECLARE @TBLMONTH TABLE (ORDER_NO INT,MTH_NAME CHAR(3))
    
    DECLARE @DTSQL NVARCHAR(MAX),@CFILTER VARCHAR(MAX),@NCONVERSIONAMOUNT NUMERIC(18,0),@ERROR VARCHAR(1000)
    DECLARE @CURYEAR AS VARCHAR(10),@TQTY NUMERIC(12,2),@TNRV NUMERIC(12,2)
    SET @CFILTER=''
    SET @CURYEAR=(SELECT '01'+ DBO.FN_GETFINYEAR(@DTO_DT))
     
    IF  @FM_DT =''
		SELECT @ERROR='PLEASE SELECT FROM DATE.' 
	IF ISNULL(@ERROR,'')<>''
	BEGIN
	   SELECT  @ERROR AS ERRMSG 
	   GOTO END_PROC
	END
	
	
    SET @CFILTER= ' A.FIN_YEAR='''+@CURYEAR+''' AND A.CM_DT <= '''+CONVERT(VARCHAR(11),@DTO_DT,120)+''' '   
    IF @CFILTER<>''
    SET @CFILTER=' AND '+@CFILTER
  
  
    SET @NCONVERSIONAMOUNT=10000000
   
    
     INSERT INTO @TBLMONTH (ORDER_NO,MTH_NAME)
	 SELECT 1 AS ORDER_NO, 'APR' AS MTH_NAME UNION
	 SELECT 2 AS ORDER_NO, 'MAY' AS MTH_NAME UNION
	 SELECT 3 AS ORDER_NO, 'JUN' AS MTH_NAME UNION
	 SELECT 4 AS ORDER_NO, 'JUL' AS MTH_NAME UNION
	 SELECT 5 AS ORDER_NO, 'AUG' AS MTH_NAME UNION
	 SELECT 6 AS ORDER_NO, 'SEP' AS MTH_NAME UNION
	 SELECT 7 AS ORDER_NO, 'OCT' AS MTH_NAME UNION 
	 SELECT 8 AS ORDER_NO, 'NOV' AS MTH_NAME UNION
	 SELECT 9 AS ORDER_NO, 'DEC' AS MTH_NAME UNION
	 SELECT 10 AS ORDER_NO, 'JAN' AS MTH_NAME UNION
	 SELECT 11 AS ORDER_NO, 'FEB' AS MTH_NAME UNION
	 SELECT 12 AS ORDER_NO, 'MAR' AS MTH_NAME 
	 


IF @CDEPT_ID<>''
 SET @CFILTER=@CFILTER+' AND A.location_Code ='''+@CDEPT_ID+''''
 
 IF @NRV_QTY=1
  GOTO LBL_NRV   
 ELSE IF @NRV_QTY=2 
  GOTO LBL_QTY   
     --SELECT * FROM @TBLREPORT
  LBL_NRV:
	
  
		 --INSERT INTO @TBLREPORT(ORDER_NO,DY_NAME,CNT ,NRV)
  SET @DTSQL =N'SELECT A.MTH_NAME,SUM(ISNULL(NRV,0)) AS NRV 
		 FROM 
		 (
		 SELECT CM_DT ,LEFT(DATENAME(MM ,CM_DT),3) AS MTH_NAME,
				SUM(NET_AMOUNT) AS NRV
		 FROM CMM01106 A (NOLOCK)
		 WHERE A.CANCELLED=0'+@CFILTER+  
		 'GROUP BY CM_DT,LEFT(DATENAME(MM ,CM_DT),3) 
		 ) A
		 GROUP BY A.MTH_NAME'
		
		 PRINT @DTSQL
		 INSERT INTO @TBLREPORT(MTH_NAME,NRV )
		 EXEC SP_EXECUTESQL @DTSQL
		 
		 SELECT @TNRV=SUM(ISNULL(NRV ,0)) FROM @TBLREPORT
		 UPDATE @TBLREPORT SET NRV_CONT_PER =(NRV *100)/CASE WHEN @TNRV=0 THEN 1 ELSE @TNRV END 
		 
		
            
		 UPDATE @TBLREPORT SET NRV=NRV/@NCONVERSIONAMOUNT
         
          SELECT A.MTH_NAME,ISNULL(NRV,0) AS NRV ,ISNULL(NRV_CONT_PER ,0) AS NRV_CONT_PER
          FROM @TBLMONTH A
		  LEFT OUTER JOIN @TBLREPORT B ON A.MTH_NAME =B.MTH_NAME 
		  ORDER BY A.ORDER_NO
		  
         GOTO END_PROC
         
   LBL_QTY:
   
   
		SET @DTSQL=N'SELECT A.MTH_NAME, SUM(ISNULL(QUANTITY,0)) AS QUANTITY 
		  FROM 
		 (
		 SELECT CM_DT ,LEFT(DATENAME(MM ,CM_DT),3) AS MTH_NAME,SUM(QUANTITY) AS QUANTITY 
		 FROM CMM01106 A (NOLOCK)
		 JOIN CMD01106 B (NOLOCK)  ON A.CM_ID=B.CM_ID
		 WHERE   A.CANCELLED=0'+ @CFILTER +'
		 GROUP BY CM_DT ,LEFT(DATENAME(MM ,CM_DT),3)
		 ) A
		 GROUP BY A.MTH_NAME'
		 PRINT @DTSQL
		 INSERT INTO @TBLREPORT(MTH_NAME,QTY)
		 EXEC SP_EXECUTESQL @DTSQL
	     
	    
		
		  SELECT @TQTY=SUM(ISNULL(QTY,0)) FROM @TBLREPORT
		  UPDATE @TBLREPORT SET QTY_CONT_PER =(QTY *100)/CASE WHEN @TQTY=0 THEN 1 ELSE @TQTY END 
	      
	      
		 SELECT A.MTH_NAME,QTY ,QTY_CONT_PER 
		 FROM @TBLMONTH A
		 JOIN @TBLREPORT B ON A.MTH_NAME  =B.MTH_NAME 
		 ORDER BY A.ORDER_NO
         GOTO END_PROC
     
END_PROC:
	 
END
