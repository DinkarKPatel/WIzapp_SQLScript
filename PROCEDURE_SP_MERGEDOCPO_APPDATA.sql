CREATE PROCEDURE SP_MERGEDOCPO_APPDATA  
(  
 @CMEMOID VARCHAR(40)
)  
--WITH ENCRYPTION
AS  
BEGIN    
	  DECLARE @CERRORMSG VARCHAR(1000),@CCURDEPTID CHAR(2),@CHODEPTID CHAR(2),@CCMD NVARCHAR(MAX),
			  @NSTEP INT,@BPROCEED BIT,@BLOCDATAEXISTS BIT,@CTABLEPREFIX VARCHAR(100),@CXNTYPE VARCHAR(15)	
		
	    
	  BEGIN TRANSACTION  
	    
	  SET @NSTEP = 10  
	  DECLARE @TRETMSG TABLE  (MEMO_ID VARCHAR(40),ERRMSG VARCHAR(MAX))  
	   
	  BEGIN TRY  
	       
	  SELECT @CERRORMSG='',@BPROCEED=1,@CXNTYPE='DOCPO_APP'
	    
	  SET @CTABLEPREFIX='TMP_DOCPO_APP'
	   
	  SET @NSTEP = 20  
	  	
	  SET @CCMD=N'IF OBJECT_ID(''TMP_DOCPO_APP_POM01106_'+LTRIM(RTRIM(@CMEMOID))+''',''U'') IS NOT NULL  
		  SELECT @BLOCDATAEXISTSOUT=1   
		 ELSE  
		  SELECT @BLOCDATAEXISTSOUT=0'  
	  EXEC SP_EXECUTESQL @CCMD,N'@BLOCDATAEXISTSOUT BIT OUTPUT',@BLOCDATAEXISTSOUT=@BLOCDATAEXISTS OUTPUT  
	    
	  IF @BLOCDATAEXISTS=0  
	  BEGIN  
		   SET @NSTEP = 25  
		     
		   SET @CERRORMSG='NO PO APPROVAL DATA FOUND TO BE MERGED'  
		   GOTO LBLLAST  
	  END  
	    
	  SET @NSTEP=30
	  
	  SET @CCMD=N'UPDATE POM01106 SET APPROVED=B.APPROVED
				  FROM [TMP_DOCPO_APP_POM01106_'+LTRIM(RTRIM(@CMEMOID))+']'+
				' B WHERE B.PO_ID=POM01106.PO_ID'	 
	  
	  EXEC SP_EXECUTESQL @CCMD
	      
	  -- DELETING FROM TEMP TABLES  
	  
	  GOTO LBLLAST
	    
	 END TRY  
	  
	 BEGIN CATCH  
		  
		  PRINT 'UNTRAPPED ERROR'    
		       
		  DECLARE @CERRORPROCNAME VARCHAR(100),@CLINENO VARCHAR(5),@CERRTEXT VARCHAR(MAX)  
		    
		  SELECT @CERRORPROCNAME=ISNULL(ERROR_PROCEDURE(),'NULL P'),@CLINENO=ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE'),  
		  @CERRTEXT='STEP : '+LTRIM(RTRIM(STR(@NSTEP)))+' '+ISNULL(ERROR_MESSAGE(),'NULL MSG')  
		    
		  SELECT @CERRORMSG=@CERRTEXT  
		  
		  GOTO LBLLAST  
     END CATCH  

LBLLAST:  	 
	 
	      
	IF @@TRANCOUNT>0  
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			COMMIT TRANSACTION  
		 ELSE
			ROLLBACK
	END	
	 
 	INSERT @TRETMSG
	SELECT @CMEMOID,@CERRORMSG
			
	SELECT * FROM @TRETMSG

	EXEC SP_DROPTEMPTABLES_XNS 'DOCPO_APP',0,@CMEMOID,'TMP_DOCPO_APP'  

END  
--- 'END OF CREATING PROCEDURE SP_MERGEDOCPO_APPDATA'
