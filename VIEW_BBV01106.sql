CREATE VIEW BBV01106
--WITH ENCRYPTION
AS 
SELECT A.VDN_ID, B.AC_CODE, A.REF_NO, C.VOUCHER_DT AS REF_DATE,
	( CASE WHEN A.NX_TYPE='DR' THEN 1 ELSE -1 END *A.INV_AMT ) AS INV_AMT,
	ABS( ( ( CASE WHEN A.NX_TYPE='DR' THEN 1 ELSE -1 END *A.INV_AMT )
			+ ISNULL( ( SELECT SUM( CASE WHEN VA.X_TYPE='DR' THEN 1 ELSE -1 END *VA.AMOUNT )
						FROM VDA01106 VA JOIN VD01106 VB ON VA.VD_ID=VB.VD_ID
						JOIN VM01106 VC ON VB.VM_ID=VC.VM_ID
						WHERE VDN_ID=A.VDN_ID AND VC.CANCELLED=0 AND ISNULL(VC.OP_ENTRY,0)=0 ), 0 ))) AS PENDING_AMT,
	CASE WHEN ( ( CASE WHEN A.NX_TYPE='DR' THEN 1 ELSE -1 END *A.INV_AMT )
	+ISNULL ( ( SELECT SUM( CASE WHEN VA.X_TYPE='DR' THEN 1 ELSE -1 END *VA.AMOUNT )
				FROM VDA01106 VA JOIN VD01106 VB ON VA.VD_ID=VB.VD_ID
				JOIN VM01106 VC ON VB.VM_ID=VC.VM_ID
				WHERE VDN_ID=A.VDN_ID AND VC.CANCELLED=0  AND ISNULL(VC.OP_ENTRY,0)=0 ),0)) > 0
				THEN 'DR' ELSE 'CR' END AS X_TYPE,C.BILL_ID 
FROM VDN01106 A
JOIN VD01106 B ON A.VD_ID=B.VD_ID
JOIN VM01106 C ON C.VM_ID=B.VM_ID WHERE C.CANCELLED=0 AND ISNULL(C.OP_ENTRY,0)=0 
UNION ALL
SELECT A.VDN_ID, B.AC_CODE, A.REF_NO, REF_DATE,
	( CASE WHEN A.NX_TYPE='DR' THEN 1 ELSE -1 END *A.INV_AMT ) AS INV_AMT,
	ABS( ( ( CASE WHEN A.NX_TYPE='DR' THEN 1 ELSE -1 END *A.INV_AMT )
			+ ISNULL( ( SELECT SUM( CASE WHEN VA.X_TYPE='DR' THEN 1 ELSE -1 END *AMOUNT )
						FROM VDA01106 VA JOIN VD01106 VB ON VA.VD_ID=VB.VD_ID
						JOIN VM01106 VC ON VB.VM_ID=VC.VM_ID
						WHERE VDN_ID=A.VDN_ID AND VC.CANCELLED=0 AND ISNULL(VC.OP_ENTRY,0)=0 ), 0 ) ) ) AS PENDING_AMT,
	CASE WHEN ( ( CASE WHEN A.NX_TYPE='DR' THEN 1 ELSE -1 END *A.INV_AMT )
				+ ISNULL( ( SELECT SUM( CASE WHEN VA.X_TYPE='DR' THEN 1 ELSE -1 END *AMOUNT )
							FROM VDA01106 VA JOIN VD01106 VB ON VA.VD_ID=VB.VD_ID
						JOIN VM01106 VC ON VB.VM_ID=VC.VM_ID
						WHERE VDN_ID=A.VDN_ID AND VC.CANCELLED=0 AND ISNULL(VC.OP_ENTRY,0)=0 ), 0 ) ) > 0
				  THEN 'DR' ELSE 'CR' END AS X_TYPE,'' AS BILL_ID
FROM VDN01106 A
JOIN LM01106 B ON B.AC_CODE = A.VD_ID
