CREATE PROCEDURE SP_ATTD_STATUS
(
	@DFROMDT DATETIME,
	@TFROMDT DATETIME,
	@CEMP_ID VARCHAR(20)='',
	@CLOCATIONID VARCHAR(20)='',
	@CDEPARTMENTID VARCHAR(20)='',
	@BALL BIT = 0,
	@BABS BIT = 0,
	@BLEAVE BIT = 0,
	@BWEEK BIT = 0,
	@BBDAY BIT = 0
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX), @CFILTER VARCHAR(1000),@NSTEP VARCHAR(10)
	BEGIN TRY	
		SET @NSTEP = 10
		PRINT @NSTEP
		SET @CFILTER = 'WHERE C.EMP_STATUS=0 AND A.ATTENDANCE_DT BETWEEN '''+CONVERT(VARCHAR,@DFROMDT,120)+''' AND '''+CONVERT(VARCHAR,@TFROMDT,120)+''''
		
		SET @NSTEP = 20	
		IF ISNULL(@CEMP_ID,'') <> ''
			SET @CFILTER = @CFILTER + ' AND C.EMP_ID = '''+@CEMP_ID+''''
		
		IF ISNULL(@CLOCATIONID,'') <> ''
			SET @CFILTER = @CFILTER + ' AND C.DEPT_ID = '''+@CLOCATIONID+''''
			
		IF ISNULL(@CDEPARTMENTID,'') <> ''
			SET @CFILTER = @CFILTER + ' AND C.DEPARTMENT_ID = '''+@CDEPARTMENTID+''''	
		
		IF (ISNULL(@BWEEK,0) = 0 AND ISNULL(@BBDAY,0) = 0 AND ISNULL(@BALL,0) = 0 AND ISNULL(@BLEAVE,0) = 0 AND ISNULL(@BABS,0) = 0 )
			SET @BALL = 1
		
		SET @NSTEP = 30
		IF ISNULL(@BALL,0) = 0
		BEGIN
			SET @CFILTER = @CFILTER + ' AND A.TIME_IN = '''' AND A.TIME_OUT = '''' AND ( '
			
			SET @NSTEP = 40
			IF ISNULL(@BLEAVE,0) <> 0
				SET @CFILTER = @CFILTER + ' A.LOG_ABSENT_STATUS = 3 '
			IF (ISNULL(@BWEEK,0) <> 0 OR ISNULL(@BBDAY,0) <> 0 OR ISNULL(@BABS,0) <> 0) AND ISNULL(@BLEAVE,0) = 1
				SET @CFILTER = @CFILTER + ' OR'
			
			SET @NSTEP = 50		
			IF ISNULL(@BWEEK,0) <> 0
				SET @CFILTER = @CFILTER + ' A.LOG_ABSENT_STATUS = 1 '
			IF (ISNULL(@BBDAY,0) <> 0 OR ISNULL(@BABS,0) <> 0) AND ISNULL(@BWEEK,0) = 1
				SET @CFILTER = @CFILTER + ' OR'
					
			SET @NSTEP = 60
			IF ISNULL(@BBDAY,0) <> 0
				SET @CFILTER = @CFILTER + ' A.LOG_ABSENT_STATUS = 4 '
			IF ISNULL(@BABS,0) <> 0 AND ISNULL(@BBDAY,0) = 1
				SET @CFILTER = @CFILTER + ' OR'
					
			SET @NSTEP = 70
			IF ISNULL(@BABS,0) <> 0
				SET @CFILTER = @CFILTER + ' A.LOG_ABSENT_STATUS NOT IN (1,3,4) '
			
			SET @CFILTER = @CFILTER + ')'		
		END
		PRINT @CFILTER	
		SET @NSTEP = 80
		SET @CCMD = ' SELECT C.DEPT_ID,C.DEPARTMENT_ID,C.REF_ID,A.EMP_ID,C.EMP_FNAME +SPACE(1)+C.EMP_LNAME AS EMPNAME,A.ATTENDANCE_DT,W.TIME_IN,W.TIME_OUT,B.SHIFT_TIME_IN,B.SHIFT_TIME_OUT,A.REMARKS_IN,A.REMARKS_OUT,A.ATT_REMARKS AS REMARKS,B.SHIFT_NAME,B.LATE_CUTOFF,B.EARLY_CUTOFF, 
		(CASE WHEN A.LOG_ABSENT_STATUS= 1 AND A.TIME_IN = '''' AND A.TIME_OUT = '''' THEN ''WO'' 
			  WHEN A.LOG_ABSENT_STATUS= 2 AND A.TIME_IN = '''' AND A.TIME_OUT = '''' THEN ''AB''
			  WHEN A.LOG_ABSENT_STATUS= 3 AND A.TIME_IN = '''' AND A.TIME_OUT = '''' THEN ''LV'' 
			  WHEN A.LOG_ABSENT_STATUS= 4 AND A.TIME_IN = '''' AND A.TIME_OUT = '''' THEN ''BO''
			  WHEN A.TIME_IN = '''' AND A.TIME_OUT = '''' THEN ''LV'' ELSE ''P'' END) AS ATTSTATUS
		FROM EMP_ATTENDANCE A
		JOIN EMP_SHIFTS B ON A.SHIFT_ID=B.SHIFT_ID 
		JOIN EMP_MST C ON A.EMP_ID = C.EMP_ID JOIN 
		(
		  SELECT EMP_ID,ATTENDANCE_DT,MIN(TIME_IN) AS TIME_IN,MAX(TIME_OUT) AS TIME_OUT FROM EMP_ATTENDANCE
		  GROUP BY EMP_ID, ATTENDANCE_DT
		)W ON W.EMP_ID=A.EMP_ID AND W.ATTENDANCE_DT=A.ATTENDANCE_DT AND W.TIME_IN=A.TIME_IN '+@CFILTER+''
		
		PRINT @CCMD
		
		EXEC SP_EXECUTESQL @CCMD
	END TRY
	BEGIN CATCH
			SELECT 'STEP:- '+@NSTEP +' '+ERROR_MESSAGE() AS ERRMSG
	END CATCH					 
END
