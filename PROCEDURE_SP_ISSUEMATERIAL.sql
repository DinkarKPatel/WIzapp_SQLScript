CREATE PROCEDURE SP_ISSUEMATERIAL 
@NQUERYID NUMERIC (2,0),        
@CMEMOID VARCHAR(40),        
@CWHERE VARCHAR(500),        
@CPRODUCTCODE VARCHAR(50),        
@CFINYEAR VARCHAR(5),        
@NNAVMODE NUMERIC(2,0) ,
@CAGENCY_CODE VARCHAR(100)='' ,
@NQTY INT=0,
@CPARA2_CODE VARCHAR(10)='',
@NDEFAULT_BASIS INT=0,
@CJOB_CODE VARCHAR(10)=''
--WITH ENCRYPTION
AS         
BEGIN        
        
DECLARE @CCMD NVARCHAR(MAX),        
@CCMD1 NVARCHAR(MAX),        
@CHEADCODESTR VARCHAR(MAX),        
@CDEBTORSTR VARCHAR(MAX),        
@CCREDITORSTR VARCHAR(MAX)        
        
IF         
@NQUERYID = 1        
GOTO LBLNAVIGATE        
        
ELSE IF         
@NQUERYID = 2        
GOTO LBLGETMASTERS        
        
ELSE IF         
@NQUERYID = 3        
GOTO LBLGETDETAILS        
        
ELSE IF         
@NQUERYID = 4        
GOTO LBLGETDEPARTMENT        
        
ELSE IF        
@NQUERYID = 5        
GOTO LBLGETWORKORDERMASTER        
        
ELSE IF        
@NQUERYID = 6        
GOTO LBLGETWORKORDERDETAILS        
        
ELSE IF        
@NQUERYID = 7        
GOTO LBLGETORDERWISEITEMS        
        
ELSE IF        
@NQUERYID = 8        
GOTO LBLGETWODETAILS        
        
ELSE IF         
@NQUERYID = 9        
GOTO LBLGETLEDGERS        
        
ELSE IF         
@NQUERYID = 10        
GOTO LBLGETJOBS        

ELSE IF                 
@NQUERYID = 11                
GOTO LBLGETSTKDET

ELSE IF                 
@NQUERYID = 12                
GOTO LBLGETCOMPDET

ELSE IF                 
@NQUERYID = 13            
GOTO LBLGETSTKDET_VIEW
--ELSE IF 
--@NQUERYID = 14            
--GOTO LBLDEFAULTBASIS_RATE

ELSE IF 
@NQUERYID = 15            
GOTO LBLISSUE_ROW_VIEW 

LBLISSUE_ROW_VIEW:
        
SELECT  0 AS CHCK, A.*,0 AS PROCESS_QTY,RIGHT(A.REF_WO_ID,10) AS WO_NO,
PENDING_QTY=A.ISSUE_QTY
FROM
(
 SELECT C.REF_WO_ID,A.ARTICLE_CODE,
 A.PARA1_CODE,PARA1_NAME COM_COLOR,
 A.PARA2_CODE,PARA2_NAME COM_SIZE,
 J.JOB_NAME ,
 ISSUE_QTY
,DEFAULT_BASIS
,DEFAULT_BASIS AS DEFAULT_BASIS_VALUE
,RATE
,AMOUNT
,A.NET_AMOUNT
,B.MEMO_ID
,A.ROW_ID
FROM PRD_ISSUE_ROW_MATERIAL_DET A
 JOIN PRD_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID
 JOIN 
 (
  SELECT JOB_CODE, C.MEMO_ID,C.REF_PRD_WORKORDER_MEMOID AS REF_WO_ID,REF_MATERIAL_ROW_ID
  FROM PRD_ISSUE_MATERIAL_DET  C
  WHERE C.MEMO_ID=@CMEMOID
  GROUP BY JOB_CODE,C.MEMO_ID,C.REF_MATERIAL_ROW_ID,C.REF_PRD_WORKORDER_MEMOID
 ) C ON A.MEMO_ID=C.MEMO_ID 
AND A.ROW_ID=C.REF_MATERIAL_ROW_ID
JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
JOIN PARA2 P2 ON P2.PARA2_CODE=A.PARA2_CODE
LEFT JOIN JOBS J ON J.JOB_CODE =C.JOB_CODE 
--WHERE CANCELLED=0 
WHERE B.MEMO_ID=@CMEMOID
--AND DEFAULT_BASIS<>1
--GROUP BY C.REF_WO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE
)	A


 GOTO LAST    




LBLGETSTKDET_VIEW:
 
 DECLARE @WORKORDER_ID VARCHAR(100)
 IF @CWHERE='DEF0000'
	SET @WORKORDER_ID=''
	ELSE 
	SELECT TOP 1 @WORKORDER_ID=REF_WO_ID FROM PRD_STK_TRANSFER_DET WHERE MEMO_ID=@CMEMOID
     
    SELECT  CAST(0 AS BIT) AS CHCK, CAST('' AS VARCHAR(100)) AS MEMO_ID,
    MST.MEMO_NO AS WO_NO,
	CAST('LATER'+ CAST(NEWID() AS VARCHAR(100)) AS VARCHAR(40)) AS ROW_ID,
	AR.ARTICLE_CODE ,
	AR.ARTICLE_NO,AR.ARTICLE_NAME,A.MEMO_ID AS WO_ID,
	PARA1.PARA1_NAME COM_COLOR,PARA2.PARA2_NAME COM_SIZE,
	CONVERT(NUMERIC(10,2),SUM(K.QUANTITY)/COUNT(A.ARTICLE_CODE)) AS WO_QTY,
	(ISNULL(STK.ISSUE_QTY,0)) AS STOCK_QTY,
	(ISNULL(STK.PROCESS_QTY,0)) AS PROCESS_QTY,
	CONVERT(NUMERIC(10,2),STK.ISSUE_QTY)-(ISNULL(STK.PROCESS_QTY,0)) AS PENDING_QTY,
	CAST(0 AS NUMERIC(10,2)) AS ISSUE_QTY,
	K.PARA1_CODE,K.PARA2_CODE,
	1  AS DEFAULT_BASIS ,
	0 AS RATE,
	JOB_NAME  AS JOB_NAME,
	J1.JOB_CODE  AS JOB_CODE,
	'RATE/MTR' AS DEFAULT_BASIS_NAME,1 AS DEFAULT_BASIS_VALUE	
	,CAST(0 AS NUMERIC(12,2)) AS AMOUNT
	,CAST(0 AS NUMERIC(12,2)) AS NET_AMOUNT	
	FROM PRD_WO_DET (NOLOCK) A  
	JOIN PRD_WO_MST MST ON MST.MEMO_ID=A.MEMO_ID
	JOIN PRD_WO_SUB_DET K ON A.ROW_ID = K.REF_ROW_ID   
	JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE         
	JOIN UOM D ON B.UOM_CODE = D.UOM_CODE         
	JOIN PARA1 ON PARA1.PARA1_CODE = K.PARA1_CODE         
	JOIN PARA2 ON PARA2.PARA2_CODE = K.PARA2_CODE 
	JOIN ARTICLE AR ON AR.ARTICLE_CODE=MST.ARTICLE_SET_CODE
	JOIN
	(
	 SELECT DET.MEMO_ID 
	 FROM PRD_WO_ART_BOM A
	 JOIN PRD_WO_DET DET ON A.REF_ROW_ID=DET.ROW_ID
	 JOIN PRD_SKU B ON A.BOM_ARTICLE_CODE=B.ARTICLE_CODE
	 JOIN PRD_PMT C ON B.PRODUCT_UID=C.PRODUCT_UID 
	 WHERE QUANTITY_IN_STOCK>0 
	 AND DET.MEMO_ID=@CMEMOID 
	 AND B.WORK_ORDER_ID=@WORKORDER_ID
	 AND C.DEPARTMENT_ID=@CWHERE
	 GROUP BY DET.MEMO_ID 
	)PMT ON PMT.MEMO_ID=A.MEMO_ID
	 JOIN
	(
	  SELECT C.REF_WO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.ISSUE_QTY,ISSUE.ISSUE_QTY AS PROCESS_QTY 
	  FROM PRD_STK_TRANSFER_MATERIAL_DET A
	  JOIN PRD_STK_TRANSFER_MST B ON A.MEMO_ID =B.MEMO_ID
	  JOIN 
	  (
	    SELECT C.MEMO_ID,C.REF_ROW_ID,C.REF_WO_ID
	    FROM PRD_STK_TRANSFER_DET C
	    WHERE C.REF_WO_ID=@CMEMOID
	    GROUP BY C.MEMO_ID,C.REF_ROW_ID,C.REF_WO_ID
	  ) C ON A.MEMO_ID=C.MEMO_ID 
	  AND A.ROW_ID=C.REF_ROW_ID
	  LEFT OUTER JOIN
	  (
		   
		 SELECT A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.ISSUE_QTY,B.ORDER_ID
		 FROM PRD_AGENCY_ISSUE_ROW_MATERIAL_DET A
		 JOIN 
		(
		 SELECT A.MEMO_ID, A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID,
		 REF_MATERIAL_ROW_ID 
		 FROM PRD_ISSUE_MATERIAL_DET A
		 JOIN PRD_ISSUE_MATERIAL_MST B ON A.MEMO_ID=B.MEMO_ID
		 WHERE B.CANCELLED=0
		 GROUP BY A.REF_PRD_WORKORDER_MEMOID,REF_MATERIAL_ROW_ID,A.MEMO_ID
		) B ON A.MEMO_ID=B.MEMO_ID AND A.ROW_ID=B.REF_MATERIAL_ROW_ID
	 
	   WHERE ORDER_ID=@CMEMOID 
	  ) ISSUE ON C.REF_WO_ID=ISSUE.ORDER_ID AND 
	  A.ARTICLE_CODE=ISSUE.ARTICLE_CODE AND  A.PARA1_CODE= ISSUE.PARA1_CODE
	  AND A.PARA2_CODE=ISSUE.PARA2_CODE 
	  WHERE CANCELLED=0 AND C.REF_WO_ID=@CMEMOID
	  AND B.TARGET_DEPARTMENT_ID=@CWHERE
	  
	) STK ON STK.REF_WO_ID=MST.MEMO_ID 
	AND PARA1.PARA1_CODE=STK.PARA1_CODE 
	AND PARA2.PARA2_CODE=STK.PARA2_CODE
	LEFT JOIN
	(
	 SELECT TOP 1 DEFAULT_BASIS, A.JOB_CODE,
	 CASE WHEN ISNULL(DEFAULT_BASIS,0)=1  THEN JOB_RATE
				   WHEN ISNULL(DEFAULT_BASIS,0)=2  THEN JOB_RATE_PCS
				   WHEN ISNULL(DEFAULT_BASIS,0)=3  THEN JOB_RATE_DAYS
				   WHEN ISNULL(DEFAULT_BASIS,0)=4  THEN JOB_RATE_HOURS
			  ELSE 0 END AS RATE
	FROM AGENCY_JOBS A (NOLOCK)
	JOIN PRD_AGENCY_MST B (NOLOCK) ON  A.AGENCY_CODE =B.AGENCY_CODE
	WHERE A.AGENCY_CODE=@CAGENCY_CODE
	) AJ ON  1=1
	LEFT JOIN JOBS J1 ON J1.JOB_CODE=AJ.JOB_CODE
	WHERE A.MEMO_ID=@CMEMOID 
	AND MST.CANCELLED=0
	GROUP BY AR.ARTICLE_NO,AR.ARTICLE_CODE ,AR.ARTICLE_NAME,A.MEMO_ID ,
	PARA1.PARA1_NAME ,PARA2.PARA2_NAME,K.PARA1_CODE,K.PARA2_CODE,STK.ISSUE_QTY,
	JOB_NAME ,STK.PROCESS_QTY,J1.JOB_CODE  ,  MST.MEMO_NO 
	
 GOTO LAST        

 
 
 
LBLGETCOMPDET:
                         
SET @CCMD= N'SELECT CHCK,ARTICLE_NO,A.REF_WO_ID,A.REF_WO_NO,
             SUM(A.AVG_QTY) AS AVG_QTY,
             SUM(A.REQUIRED_QTY) AS REQUIRED_QTY,
             0 AS ISSUE_QTY
            FROM
           (
			 SELECT CAST(0 AS BIT) AS CHCK, C.ARTICLE_NO,B.ARTICLE_CODE,
			 B.MEMO_ID AS REF_WO_ID,
			 RIGHT(B.MEMO_ID,10) AS REF_WO_NO
			 ,AVG_QTY
			 ,CONVERT(NUMERIC(12,2),AVG_QTY * '+STR(@NQTY)+') AS REQUIRED_QTY   --CHANGES BY DET QUANTITYT 
			 ,STK.ISSUE_QTY    
			 FROM PRD_WO_ART_BOM A (NOLOCK)      
			 JOIN  PRD_WO_DET B (NOLOCK) ON A.REF_ROW_ID = B.ROW_ID
			 JOIN PRD_WO_MST MST (NOLOCK) ON MST.MEMO_ID =B.MEMO_ID  
			 JOIN
			 (
			  SELECT C.PARA1_CODE,C.PARA2_CODE,REF_ROW_ID,SUM(QUANTITY) AS QUANTITY 
			  FROM PRD_WO_SUB_DET C
			  WHERE C.PARA1_CODE='''+@CPRODUCTCODE+'''
			  AND C.PARA2_CODE='''+@CPARA2_CODE+'''
			  GROUP BY REF_ROW_ID,C.PARA1_CODE,C.PARA2_CODE
			 ) DET ON B.ROW_ID=DET.REF_ROW_ID
			 JOIN ARTICLE C (NOLOCK) ON B.ARTICLE_CODE = C.ARTICLE_CODE   
			 JOIN
			 (
			  SELECT B.REF_WO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.ISSUE_QTY 
				 FROM PRD_STK_TRANSFER_MATERIAL_DET A
				 JOIN 
				 (
				  SELECT REF_ROW_ID,B.REF_WO_ID 
				  FROM PRD_STK_TRANSFER_MST A
				  JOIN PRD_STK_TRANSFER_DET B ON A.MEMO_ID=B.MEMO_ID 
				  WHERE A.CANCELLED =0 AND B.REF_WO_ID='''+@CMEMOID+''' 
				  AND TARGET_DEPARTMENT_ID='''+@CWHERE+'''
				  GROUP BY REF_ROW_ID,B.REF_WO_ID
				 ) B ON A.ROW_ID  =B.REF_ROW_ID  
				 WHERE  B.REF_WO_ID='''+@CMEMOID+''' 
			 ) STK ON B.MEMO_ID=STK.REF_WO_ID
			 AND MST.ARTICLE_SET_CODE=STK.ARTICLE_CODE
			 AND DET.PARA1_CODE=STK.PARA1_CODE
			 AND DET.PARA2_CODE=STK.PARA2_CODE
			 JOIN
			 (
				   SELECT DISTINCT A.COMPONENT_CODE,A.COM_PARA1_CODE,A.COM_PARA2_CODE
				   FROM PRD_SKU A
				   JOIN PRD_PMT B ON A.PRODUCT_UID=B.PRODUCT_UID
				   WHERE B.QUANTITY_IN_STOCK>0
				   AND A.WORK_ORDER_ID='''+@CMEMOID+'''
				   AND B.DEPARTMENT_ID='''+@CWHERE+'''
				
			 )  PMT ON PMT.COMPONENT_CODE=B.ARTICLE_CODE
			      AND DET.PARA1_CODE=PMT.COM_PARA1_CODE
			     AND DET.PARA2_CODE=PMT.COM_PARA2_CODE
			       
			 WHERE B.MEMO_ID='''+@CMEMOID+'''    
             
			) A          
			GROUP BY CHCK,ARTICLE_NO,A.REF_WO_ID,A.REF_WO_NO'
		
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD	
	
GOTO LAST 
 
 
LBLGETSTKDET:
 
SELECT CAST(0 AS BIT) AS CHCK, CAST('' AS VARCHAR(100)) AS MEMO_ID,
	CAST('LATER'+ CAST(NEWID() AS VARCHAR(100)) AS VARCHAR(40)) AS ROW_ID,
A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,
       A.WO_ID,
       A.PARA1_CODE,A.PARA2_CODE,
       A. COM_COLOR,
        A.COM_SIZE,
        A.WO_QTY,
        A.QUANTITY_IN_STOCK,
STK_QTY AS STOCK_QTY,
MAX(ISSUE_QTY) AS PROCESS_QTY,
CAST(0 AS INT) AS ISSUE_QTY,
CAST(0 AS INT) AS PENDING_QTY,
1  AS DEFAULT_BASIS ,
	0 AS RATE,JOB_NAME  AS JOB_NAME,
	J1.JOB_CODE  AS JOB_CODE,
	'RATE/MTR' AS DEFAULT_BASIS_NAME,1 AS DEFAULT_BASIS_VALUE
	,CAST(0 AS NUMERIC(12,2)) AS AMOUNT
	,CAST(0 AS NUMERIC(12,2)) AS NET_AMOUNT	
FROM 
(
SELECT MST.ARTICLE_SET_CODE AS ARTICLE_CODE,B1.ARTICLE_NO,B1.ARTICLE_NAME,
       A.MEMO_ID AS WO_ID,
       C.PARA1_CODE,C.PARA2_CODE,
       P11.PARA1_NAME AS COM_COLOR,
       P21.PARA2_NAME AS COM_SIZE,
       CONVERT(NUMERIC(10,2),SUM(C.QUANTITY)/COUNT(A.ARTICLE_CODE)) AS WO_QTY,
       SUM(F.QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK
FROM PRD_WO_DET A 
JOIN PRD_WO_MST MST ON MST.MEMO_ID=A.MEMO_ID
JOIN ARTICLE B ON A.ARTICLE_CODE=B.ARTICLE_CODE 
JOIN PRD_WO_SUB_DET C ON A.ROW_ID=C.REF_ROW_ID 
JOIN PRD_WO_ART_BOM D ON C.REF_ROW_ID=D.REF_ROW_ID  
JOIN ARTICLE B1 ON MST.ARTICLE_SET_CODE=B1.ARTICLE_CODE 
JOIN PRD_SKU E ON
E.ARTICLE_CODE=D.BOM_ARTICLE_CODE
AND A.MEMO_ID=E.WORK_ORDER_ID
AND A.ARTICLE_CODE=E.COMPONENT_CODE  
AND C.PARA1_CODE=E.COM_PARA1_CODE 
AND C.PARA2_CODE=E.COM_PARA2_CODE
JOIN PRD_PMT F ON E.PRODUCT_UID=F.PRODUCT_UID AND QUANTITY_IN_STOCK >0  
JOIN PARA1 P11 ON P11.PARA1_CODE=C.PARA1_CODE 
JOIN PARA2 P21 ON P21.PARA2_CODE=C.PARA2_CODE
WHERE A.MEMO_ID=@CMEMOID
AND DEPARTMENT_ID=@CWHERE 
GROUP BY MST.ARTICLE_SET_CODE,C.PARA1_CODE,C.PARA2_CODE,
P11.PARA1_NAME,P21.PARA2_NAME ,B1.ARTICLE_NO,B1.ARTICLE_NAME,A.MEMO_ID
) A
JOIN 
(
  SELECT C.REF_WO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,
   SUM(A.ISSUE_QTY) AS STK_QTY
	 -- SUM(ISNULL(ISSUE.ISSUE_QTY,0)) AS PROCESS_QTY 
   FROM PRD_STK_TRANSFER_MATERIAL_DET A
   JOIN PRD_STK_TRANSFER_MST B ON A.MEMO_ID =B.MEMO_ID
   JOIN 
   (
	    SELECT C.MEMO_ID,C.REF_ROW_ID,C.REF_WO_ID
	    FROM PRD_STK_TRANSFER_DET C
	    WHERE C.REF_WO_ID=@CMEMOID
	    GROUP BY C.MEMO_ID,C.REF_ROW_ID,C.REF_WO_ID
   ) C ON A.MEMO_ID=C.MEMO_ID 
  AND A.ROW_ID=C.REF_ROW_ID
  WHERE B.CANCELLED=0
  AND B.TARGET_DEPARTMENT_ID=@CWHERE
  GROUP BY C.REF_WO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE 
) STK  ON  STK.REF_WO_ID=A.WO_ID AND
A.PARA1_CODE=STK.PARA1_CODE 
AND A.PARA2_CODE=STK.PARA2_CODE
AND STK.ARTICLE_CODE=A.ARTICLE_CODE
LEFT JOIN 
(
  SELECT ORDER_ID,C.REF_MATERIAL_ROW_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,
   SUM(A.ISSUE_QTY) AS ISSUE_QTY
	 -- SUM(ISNULL(ISSUE.ISSUE_QTY,0)) AS PROCESS_QTY 
   FROM PRD_ISSUE_ROW_MATERIAL_DET A
   JOIN PRD_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID
   JOIN 
   (
	    SELECT C.REF_PRD_WORKORDER_MEMOID AS ORDER_ID,C.MEMO_ID,C.REF_MATERIAL_ROW_ID
	    FROM PRD_ISSUE_MATERIAL_DET C
	    WHERE C.REF_PRD_WORKORDER_MEMOID=@CMEMOID 
	    GROUP BY C.REF_PRD_WORKORDER_MEMOID,C.MEMO_ID,C.REF_MATERIAL_ROW_ID
   ) C ON A.MEMO_ID=C.MEMO_ID 
  AND A.ROW_ID=C.REF_MATERIAL_ROW_ID
  WHERE B.CANCELLED=0
  AND B.TARGET_DEPARTMENT_ID=@CWHERE 
  GROUP BY ORDER_ID,C.REF_MATERIAL_ROW_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE 
) P  
ON  P.ORDER_ID=A.WO_ID AND
A.PARA1_CODE=P.PARA1_CODE 
AND A.PARA2_CODE=P.PARA2_CODE
AND P.ARTICLE_CODE=A.ARTICLE_CODE
LEFT JOIN
	(
	 SELECT TOP 1 DEFAULT_BASIS, A.JOB_CODE,
	 CASE WHEN ISNULL(DEFAULT_BASIS,0)=1  THEN JOB_RATE
				   WHEN ISNULL(DEFAULT_BASIS,0)=2  THEN JOB_RATE_PCS
				   WHEN ISNULL(DEFAULT_BASIS,0)=3  THEN JOB_RATE_DAYS
				   WHEN ISNULL(DEFAULT_BASIS,0)=4  THEN JOB_RATE_HOURS
			  ELSE 0 END AS RATE
	FROM AGENCY_JOBS A (NOLOCK)
	JOIN PRD_AGENCY_MST B (NOLOCK) ON  A.AGENCY_CODE =B.AGENCY_CODE
	WHERE A.AGENCY_CODE=@CAGENCY_CODE
) AJ ON  1=1
LEFT JOIN JOBS J1 ON J1.JOB_CODE=AJ.JOB_CODE
GROUP BY
A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,
       A.WO_ID,
       A.PARA1_CODE,A.PARA2_CODE,
       A. COM_COLOR,
        A.COM_SIZE,
        A.WO_QTY,
        A.QUANTITY_IN_STOCK,
STK_QTY ,JOB_NAME  ,
	J1.JOB_CODE

GOTO LAST        


        
LBLNAVIGATE:        
 EXECUTE SP_NAVIGATE 'PRD_ISSUE_MATERIAL_MST',@NNAVMODE,@CMEMOID,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERE        
GOTO LAST        
        
LBLGETMASTERS:        
 SELECT DISTINCT T1.*, T2.USERNAME,T3.DEPARTMENT_NAME,
 --ISNULL(T6.MEMO_ID,'') AS WORK_ORDER_MEMO_ID,        
 --ISNULL(T6.MEMO_NO,'') AS WORK_ORDER_MEMO_NO
 '' AS JOB_CODE
 ,ISNULL(J.JOB_NAME,'') AS JOB_NAME,        
 --ISNULL(T6.REF_NO,'') AS WORK_REFNO,        
 (CASE WHEN T6.MEMO_DT <> '' THEN CONVERT(CHAR(10),ISNULL(T6.MEMO_DT,''),105) ELSE ''  END) AS WORKORDERDT        
 ,ISNULL(AGE.AGENCY_NAME,'') AS AGENCY_NAME        
 ,ISNULL(ARTSET.ARTICLE_NO,'') AS ARTICLE_SET         
 FROM PRD_ISSUE_MATERIAL_MST (NOLOCK) T1 
 JOIN PRD_ISSUE_MATERIAL_DET (NOLOCK) DET ON T1.MEMO_ID =DET.MEMO_ID        
 JOIN USERS (NOLOCK) T2 ON T1.USER_CODE = T2.USER_CODE        
 LEFT OUTER JOIN PRD_AGENCY_MST AGE (NOLOCK) ON T1.REF_AGENCY_CODE = AGE.AGENCY_CODE         
 LEFT OUTER JOIN PRD_DEPARTMENT_MST (NOLOCK) T3 ON T3.DEPARTMENT_ID = T1.TARGET_DEPARTMENT_ID        
 LEFT OUTER JOIN PRD_WO_MST (NOLOCK) T6 ON DET.REF_PRD_WORKORDER_MEMOID= T6.MEMO_ID        
 LEFT OUTER JOIN JOBS (NOLOCK) J ON J.JOB_CODE=DET.JOB_CODE        
 LEFT OUTER JOIN ARTICLE (NOLOCK) ARTSET ON T6.ARTICLE_SET_CODE = ARTSET.ARTICLE_CODE         
 WHERE (@CMEMOID ='' OR T1.MEMO_ID = @CMEMOID )
        
GOTO LAST        
        
LBLGETDETAILS:        
 DECLARE @CREFWORKORDERMEMOID VARCHAR(MAX),@CSOURCEDEPTID VARCHAR(MAX)         
 IF @CMEMOID <> ''        
 BEGIN        
  --SELECT TOP 1 @CREFWORKORDERMEMOID=REF_PRD_WORKORDER_MEMOID FROM PRD_ISSUE_MATERIAL_DET WHERE MEMO_ID = @CMEMOID        
  SELECT TOP 1 @CSOURCEDEPTID = ISNULL(SOURCE_DEPARTMENT_ID,'')  FROM PRD_ISSUE_MATERIAL_MST WHERE MEMO_ID = @CMEMOID        
 END        
 ELSE        
  SELECT @CREFWORKORDERMEMOID = '',@CSOURCEDEPTID = ''        
    
    IF @CSOURCEDEPTID IS NULL
    SET @CSOURCEDEPTID=''      
    
         
 SET @CCMD = N'SELECT CAST(1 AS BIT) AS CHCK,C.UOM_NAME,D.*,B.ARTICLE_NO,B.ARTICLE_NAME,D.ROW_ID ,        
  ISNULL(P.WIP,0) AS QUANTITY_IN_STOCK ,ARTCOM.ARTICLE_NO AS COMP_NAME,ISNULL(O.ISSUED_QTY,0) AS ISSUED_QTY,        
  ISNULL(O.TOTAL_QTY,0) AS TOTAL_QTY,(ISNULL(O.TOTAL_QTY,0) - ISNULL(O.ISSUED_QTY ,0)) AS BALANCE_QTY,        
  ISNULL(B.ENABLE_FIXWT_ENTRY,0) AS ENABLE_FIXWT_ENTRY,ISNULL(B.FIX_WEIGHT,0) AS FIX_WEIGHT
  ,D.PRODUCT_UID,D.PURCHASE_PRICE AS RATE
  ,P.PRODUCT_CODE 
  ,D.REF_PRD_WORKORDER_MEMOID AS REF_WO_ID
  ,RIGHT(D.REF_PRD_WORKORDER_MEMOID,10) AS REF_WO_NO
  ,D.JOB_CODE 
  ,JOBS.JOB_NAME
  ,P.PURCHASE_PRICE  
  ,D.REF_PRD_WORKORDER_MEMOID 
  ,CAST('''' AS VARCHAR(50)) AS PARA1_NAME,CAST('''' AS VARCHAR(50)) AS PARA2_NAME  
  ,CAST(0 AS NUMERIC(12,2)) AS AMOUNT 
  ,CAST(0 AS NUMERIC(12,2)) AS NET_AMOUNT
  ,CAST(''''  AS VARCHAR(100)) AS PRODUCT_UID
  FROM PRD_ISSUE_MATERIAL_DET D         
  JOIN ARTICLE B ON D.ARTICLE_CODE  = B.ARTICLE_CODE         
  JOIN UOM C ON B.UOM_CODE = C.UOM_CODE         
  JOIN JOBS ON JOBS.JOB_CODE=D.JOB_CODE        
  JOIN         
  (SELECT SKU.COM_PARA1_CODE,SKU.COM_PARA2_CODE, SKU.PURCHASE_PRICE, SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP,
  SKU.PRODUCT_CODE            
  FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID         
  WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +''') P ON P.PRODUCT_UID = D.PRODUCT_UID         
  JOIN ARTICLE ARTCOM ON D.REF_COMPONENT_ARTICLE_CODE = ARTCOM.ARTICLE_CODE         
  LEFT OUTER JOIN         
  (SELECT A.ARTICLE_CODE,K.PARA1_CODE,K.PARA2_CODE,K.QUANTITY AS TOTAL_QTY,        
  S.ISSUED_QTY FROM PRD_WO_DET A JOIN PRD_WO_SUB_DET K ON A.ROW_ID = K.REF_ROW_ID          
  LEFT OUTER JOIN         
  (SELECT D.AVG_QTY,D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,SUM(D.QUANTITY) AS ISSUED_QTY,        
  D.REF_COMPONENT_ARTICLE_CODE AS RCA         
  FROM PRD_ISSUE_MATERIAL_DET D JOIN PRD_ISSUE_MATERIAL_MST M ON M.MEMO_ID = D.MEMO_ID         
  WHERE         --
   M.SOURCE_DEPARTMENT_ID = '''+ @CSOURCEDEPTID +''' AND M.CANCELLED = 0        
  GROUP BY D.AVG_QTY,D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,D.REF_COMPONENT_ARTICLE_CODE
  ) S         
  ON S.ARTICLE_CODE = A.ARTICLE_CODE AND S.PARA1_CODE = K.PARA1_CODE AND  S.PARA2_CODE = K.PARA2_CODE         
  AND S.RCA = A.ARTICLE_CODE ) O   --   
  ON O.ARTICLE_CODE = B.ARTICLE_CODE AND O.PARA1_CODE = D.PARA1_CODE         
  AND O.PARA2_CODE = D.PARA2_CODE AND O.ARTICLE_CODE = D.REF_COMPONENT_ARTICLE_CODE         
  WHERE ('''+@CMEMOID+''' ='''' OR D.MEMO_ID ='''+@CMEMOID+''') AND D.TYPE = 1 '        
        
        --D.REF_PRD_WORKORDER_MEMOID = '''+ @CREFWORKORDERMEMOID +''' AND 
         -- WHERE A.MEMO_ID ='''+ @CREFWORKORDERMEMOID +'''  
SET @CCMD1 = N'UNION ALL      
  SELECT CAST(1 AS BIT) AS CHCK,C.UOM_NAME,D.*,B.ARTICLE_NO,B.ARTICLE_NAME,D.ROW_ID,        
  ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,ARTCOM.ARTICLE_NO AS COMP_NAME,        
  ISNULL(O.ISSUED_QTY,0) AS ISSUED_QTY,ISNULL(S.TOTAL_QTY,0) AS TOTAL_QTY,        
  (ISNULL(S.TOTAL_QTY,0) - ISNULL(O.ISSUED_QTY ,0)) AS BALANCE_QTY,        
  ISNULL(B.ENABLE_FIXWT_ENTRY,0) AS ENABLE_FIXWT_ENTRY,ISNULL(B.FIX_WEIGHT,0) AS FIX_WEIGHT 
  ,D.PRODUCT_UID  ,D.PURCHASE_PRICE AS RATE      
  ,P.PRODUCT_CODE
   ,D.REF_PRD_WORKORDER_MEMOID AS REF_WO_ID
  ,RIGHT(D.REF_PRD_WORKORDER_MEMOID,10) AS REF_WO_NO
  ,D.JOB_CODE 
  ,JOBS.JOB_NAME
  ,0.PURCHASE_PRICE 
  ,D.REF_PRD_WORKORDER_MEMOID  
   ,CAST('''' AS VARCHAR(50)) AS PARA1_NAME,CAST('''' AS VARCHAR(50)) AS PARA2_NAME     
   ,CAST(0 AS NUMERIC(12,2)) AS AMOUNT 
  ,CAST(0 AS NUMERIC(12,2)) AS NET_AMOUNT 
   ,CAST(''''  AS VARCHAR(100)) AS PRODUCT_UID
  FROM PRD_ISSUE_MATERIAL_DET D JOIN ARTICLE B ON D.ARTICLE_CODE  = B.ARTICLE_CODE         
  JOIN UOM C ON B.UOM_CODE = C.UOM_CODE         
  JOIN JOBS ON JOBS.JOB_CODE=D.JOB_CODE           
  JOIN         
  (SELECT SKU.PURCHASE_PRICE, SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP,
  SKU.PRODUCT_CODE           
  FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID         
  WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +''') P ON P.PRODUCT_UID = D.PRODUCT_UID          
  JOIN ARTICLE ARTCOM ON D.REF_COMPONENT_ARTICLE_CODE = ARTCOM.ARTICLE_CODE         
  LEFT OUTER JOIN         
  (SELECT A.AVG_QTY,(A.AVG_QTY * SUM(K.QUANTITY)) AS TOTAL_QTY,A.BOM_ARTICLE_CODE,A.PARA1_CODE,        
  K.ARTICLE_CODE AS SET_ARTICLE_CODE         
  FROM PRD_WO_ART_BOM A         
  JOIN ARTICLE B ON A.BOM_ARTICLE_CODE = B.ARTICLE_CODE         
  JOIN PRD_WO_DET C ON A.REF_ROW_ID = C.ROW_ID JOIN UOM D ON B.UOM_CODE = D.UOM_CODE         
  JOIN         
  (SELECT A.ARTICLE_CODE,SUM(C.QUANTITY) AS QUANTITY ,A.ROW_ID FROM PRD_WO_DET A         
  JOIN PRD_WO_SUB_DET C ON A.ROW_ID = C.REF_ROW_ID          
   GROUP BY A.ARTICLE_CODE,A.ROW_ID) K     --     
  ON K.ROW_ID = C.ROW_ID         
  GROUP BY A.AVG_QTY,A.BOM_ARTICLE_CODE,A.PARA1_CODE,K.ARTICLE_CODE) S         
  ON S.BOM_ARTICLE_CODE = D.ARTICLE_CODE AND S.PARA1_CODE = D.PARA1_CODE         
  AND S.AVG_QTY = D.AVG_QTY AND S.SET_ARTICLE_CODE = D.REF_COMPONENT_ARTICLE_CODE        
  LEFT OUTER JOIN         
  (SELECT D.AVG_QTY,D.PRODUCT_UID,SUM(D.QUANTITY) AS ISSUED_QTY,        
  D.REF_COMPONENT_ARTICLE_CODE AS RCA FROM PRD_ISSUE_MATERIAL_DET D         
  JOIN PRD_ISSUE_MATERIAL_MST M ON M.MEMO_ID = D.MEMO_ID         
   WHERE      
   M.SOURCE_DEPARTMENT_ID = '''+ @CSOURCEDEPTID +''' AND M.CANCELLED = 0        
  GROUP BY D.AVG_QTY,D.PRODUCT_UID,D.REF_COMPONENT_ARTICLE_CODE) O         
  ON O.PRODUCT_UID = D.PRODUCT_UID         
  AND O.RCA = D.REF_COMPONENT_ARTICLE_CODE AND O.AVG_QTY = D.AVG_QTY         
  WHERE ('''+@CMEMOID+''' ='''' OR D.MEMO_ID = '''+@CMEMOID+''') AND D.TYPE = 0 '        
PRINT @CCMD         
PRINT @CCMD1        
EXECUTE (@CCMD+ @CCMD1  )  --+ @CCMD1      
        
        --A.MEMO_ID = '''+ @CREFWORKORDERMEMOID +'''
       --D.REF_PRD_WORKORDER_MEMOID = '''+ @CREFWORKORDERMEMOID +'''  AND  
SET @CCMD = N'SELECT CAST('''' AS VARCHAR(50)) AS UOM_NAME,CAST(0 AS NUMERIC(10,3)) AS QUANTITY,        
CAST('''' AS VARCHAR(50)) AS ARTICLE_NO,CAST('''' AS VARCHAR(50)) AS ROW_ID,        
CAST(0 AS NUMERIC(10,3)) AS QUANTITY_IN_STOCK,        
CAST(0 AS BIT) AS TYPE,CAST('''' AS VARCHAR(50)) AS PARA1_CODE,CAST('''' AS VARCHAR(50)) AS PARA2_CODE,        
CAST('''' AS VARCHAR(50)) AS PARA1_NAME,CAST('''' AS VARCHAR(50)) AS PARA2_NAME , CAST(0 AS NUMERIC(10,2)) AS RATE --        
,CAST('''' AS VARCHAR(50)) AS   REF_WO_ID
,CAST('''' AS VARCHAR(50)) AS   REF_WO_NO
,CAST('''' AS VARCHAR(50)) AS  JOB_CODE 
,CAST('''' AS VARCHAR(50)) AS  JOB_NAME
,CAST('''' AS NUMERIC(12,2)) AS  PURCHASE_PRICE 
,CAST('''' AS NUMERIC(12,2)) AS  REF_PRD_WORKORDER_MEMOID   
,CAST(0 AS NUMERIC(12,2)) AS AMOUNT 
,CAST(0 AS NUMERIC(12,2)) AS NET_AMOUNT 
 ,CAST(''''  AS VARCHAR(100)) AS PRODUCT_UID   
FROM PRD_ISSUE_MATERIAL_MST WHERE 1=2'        
        
PRINT @CCMD        
EXECUTE SP_EXECUTESQL @CCMD        
        
GOTO LAST        
        
        
        
LBLGETDEPARTMENT:        
 SELECT * FROM PRD_DEPARTMENT_MST WHERE (DEPARTMENT_ID <> @CWHERE OR DEPARTMENT_ID <> 'DEF0001') AND INACTIVE = 0        
 ORDER BY DEPARTMENT_NAME --        
GOTO LAST        
        
LBLGETWORKORDERMASTER:        
 SELECT DISTINCT T1.*,CONVERT(CHAR(10),ISNULL(T1.MEMO_DT,''),105) AS MEMO_DATE,ART.ARTICLE_NO         
    FROM PRD_WO_MST T1        
    JOIN PRD_WO_DET T2 ON T2.MEMO_ID = T1.MEMO_ID        
    JOIN ARTICLE ART ON T1.ARTICLE_SET_CODE = ART.ARTICLE_CODE         
    WHERE T1.CANCELLED = 0 AND T1.MARK_AS_COMPLETED =1 AND
    T1.MEMO_ID IN 
(	SELECT WO.MEMO_ID 
	FROM PRD_PMT A (NOLOCK) 
	JOIN PRD_SKU S ON A.PRODUCT_UID= S.PRODUCT_UID 
	LEFT OUTER JOIN PRD_WO_MST WO(NOLOCK) ON WO.MEMO_ID=S.WORK_ORDER_ID AND MARK_AS_COMPLETED=1 
	WHERE  DEPARTMENT_ID= @CWHERE AND (WIP > 0 OR QUANTITY_IN_STOCK > 0) AND ISNULL(WO.MEMO_NO ,'')<>'' 
	GROUP BY WO.MEMO_ID  
	HAVING SUM(ISNULL(WIP,0)) > 0 OR SUM(ISNULL(QUANTITY_IN_STOCK,0))>0 
)       
     
GOTO LAST        
        
LBLGETWORKORDERDETAILS:        
        
  SELECT A.ROW_ID,B.ARTICLE_CODE,B.ARTICLE_NO          
  FROM PRD_WO_DET A 
  JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE          
  WHERE MEMO_ID = @CMEMOID         
          
  GOTO LAST        
        
LBLGETORDERWISEITEMS:        
        
DECLARE @CWORKORDERMEMOID VARCHAR(MAX)         
 IF @CMEMOID <> ''        
 BEGIN        
  SELECT TOP 1 @CWORKORDERMEMOID = ''        
  SELECT TOP 1 @CWORKORDERMEMOID= SKU.WORK_ORDER_ID FROM PRD_SKU SKU JOIN         
  PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID         
  WHERE PMT.DEPARTMENT_ID = @CWHERE AND WORK_ORDER_ID = @CMEMOID        
          
 END        
 ELSE SELECT @CWORKORDERMEMOID = ''        
          
 PRINT @CWORKORDERMEMOID        

      
    
DECLARE @CCMD2 NVARCHAR(MAX)        
         
SET @CCMD = N' SELECT CAST(0 AS BIT) AS CHCK,D.UOM_NAME,((K.QUANTITY) - ISNULL(S.ISSUED_QTY ,0)) AS QUANTITY        
   ,1 AS AVG_QTY,K.PARA1_CODE,B.ARTICLE_NO,B.ARTICLE_NAME,PARA1.PARA1_NAME,K.PARA2_CODE         
   ,PARA2.PARA2_NAME,A.ARTICLE_CODE ,A.ROW_ID AS REF_ROW_ID ,NEWID() AS ROW_ID          
   ,ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK ,ISNULL(P.QUANTITY_IN_STOCK,0) AS ORG_QUANTITY_IN_STOCK,ISNULL(S.ISSUED_QTY ,0) AS ISSUED_QTY        
   ,( K.QUANTITY) AS TOTAL_QTY ,((K.QUANTITY) - ISNULL(S.ISSUED_QTY ,0)) AS BALANCE_QTY        
   ,CAST(1 AS BIT) AS TYPE,B.ARTICLE_NO AS COMPONENT_NAME ,A.ARTICLE_CODE AS COMPONENT_CODE,
    K.PARA1_CODE AS COMPARA1_CODE
   , K.PARA2_CODE AS COMPARA2_CODE ,       
   ISNULL(B.ENABLE_FIXWT_ENTRY,0) AS ENABLE_FIXWT_ENTRY,ISNULL(B.FIX_WEIGHT,0) AS FIX_WEIGHT,        
   CAST(0 AS NUMERIC(10,3)) AS GROSS_WEIGHT,CAST(0 AS NUMERIC(10,3)) AS NO_OF_PCS,P.PRODUCT_UID,P.MRP,P.WS_PRICE         
   ,P.PURCHASE_PRICE AS RATE ,ISNULL(K.QUANTITY,0) AS COM_QTY , P.PRODUCT_CODE ,
   1 AS DISCON,1   AS DEFAULT_BASIS ,
   0 AS RATE ,0 AS PCS ,0 AS DISCOUNT_AMOUNT
   ,0 AS AMOUNT,0 AS NET_AMOUNT,A.MEMO_ID AS REF_WO_ID
   ,RIGHT(A.MEMO_ID,10)  AS REF_WO_NO
   ,JOBS.JOB_CODE AS JOB_CODE
   ,JOBS.JOB_NAME AS JOB_NAME  
   ,B.ARTICLE_NO AS COMP_NAME 
   ,SUM(K.QUANTITY) AS ORD_QUANTITY'
  SET @CCMD1=',PARA1.PARA1_NAME AS COM_COLOR,PARA2.PARA2_NAME AS COM_SIZE,
   A.MEMO_ID,
   CAST('''' AS VARCHAR(100)) AS REF_MATERIAL_ROW_ID
   FROM         
   PRD_WO_DET A         
   JOIN PRD_WO_SUB_DET K ON A.ROW_ID = K.REF_ROW_ID   
   JOIN PRD_WO_ART_BOM DA ON K.REF_ROW_ID=DA.REF_ROW_ID        
   JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE         
   JOIN UOM D ON B.UOM_CODE = D.UOM_CODE         
   JOIN PARA1 ON PARA1.PARA1_CODE = K.PARA1_CODE         
   JOIN PARA2 ON PARA2.PARA2_CODE = K.PARA2_CODE  
   LEFT JOIN
	(
	 SELECT TOP 1  DEFAULT_BASIS, A.JOB_CODE,
	JOB_RATE AS RATE
	FROM AGENCY_JOBS A (NOLOCK)
	WHERE A.JOB_CODE='''+@CAGENCY_CODE +'''
	) AJ ON 1=1 
    LEFT JOIN JOBS ON JOBS.JOB_CODE=AJ.JOB_CODE
    JOIN         
   (        
	  SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP        
	  ,SKU.MRP,SKU.PURCHASE_PRICE,SKU.WS_PRICE , SKU.PRODUCT_CODE,WORK_ORDER_ID,COMPONENT_CODE, COM_PARA1_CODE,COM_PARA2_CODE            
	  FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID         
	  WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +'''  AND QUANTITY_IN_STOCK>0
	  AND ('''+ @CMEMOID +'''='''' OR SKU.WORK_ORDER_ID = '''+ @CMEMOID +''')        
    ) P        
   ON P.ARTICLE_CODE=DA.BOM_ARTICLE_CODE
    AND A.MEMO_ID=P.WORK_ORDER_ID
    AND A.ARTICLE_CODE=P.COMPONENT_CODE  
    AND K.PARA1_CODE=P.COM_PARA1_CODE 
    AND K.PARA2_CODE=P.COM_PARA2_CODE
   LEFT JOIN         
   (        
  SELECT D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,SUM(D.QUANTITY) AS ISSUED_QTY        
  FROM PRD_ISSUE_MATERIAL_DET D 
  JOIN PRD_ISSUE_MATERIAL_MST M ON M.MEMO_ID = D.MEMO_ID         
  WHERE 
  ('''+@CMEMOID+''' ='''' OR D.REF_PRD_WORKORDER_MEMOID = '''+@CMEMOID+'''         )
  AND M.SOURCE_DEPARTMENT_ID = '''+ @CWHERE +''' AND M.CANCELLED = 0         
  GROUP BY D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE        
   ) S         
   ON S.ARTICLE_CODE = A.ARTICLE_CODE --AND S.PARA1_CODE = K.PARA1_CODE AND  S.PARA2_CODE = K.PARA2_CODE         
   WHERE ('''+@CMEMOID+'''='''' OR  A.MEMO_ID ='''+@CMEMOID+''') 
   --AND ISNULL(P.WIP,0) > 0     
   GROUP BY D.UOM_NAME,((K.QUANTITY) - ISNULL(S.ISSUED_QTY ,0)) ,K.PARA1_CODE,B.ARTICLE_NO,B.ARTICLE_NAME,
   PARA1.PARA1_NAME,K.PARA2_CODE ,PARA2.PARA2_NAME,A.ARTICLE_CODE ,A.ROW_ID ,ISNULL(P.QUANTITY_IN_STOCK,0) ,ISNULL(S.ISSUED_QTY ,0) 
    ,(K.QUANTITY),((K.QUANTITY) - ISNULL(S.ISSUED_QTY ,0)) ,B.ARTICLE_NO ,A.ARTICLE_CODE ,      
   ISNULL(B.ENABLE_FIXWT_ENTRY,0) ,ISNULL(B.FIX_WEIGHT,0) , P.PRODUCT_UID, P.MRP,P.WS_PRICE   
   ,P.PURCHASE_PRICE ,ISNULL(K.QUANTITY,0) ,K.PARA1_CODE,K.PARA2_CODE,P.PRODUCT_CODE
    ,A.MEMO_ID ,RIGHT(A.MEMO_ID,10),JOBS.JOB_CODE 
   ,JOBS.JOB_NAME,PARA1.PARA1_NAME
   ,PARA2.PARA2_NAME ,A.MEMO_ID '    
   
   
       
          
PRINT @CCMD         
PRINT @CCMD1    
--PRINT @CCMD2        
EXECUTE (@CCMD+@CCMD1)      -- + @CCMD1 + @CCMD2
        
    
        
 
         
 GOTO LAST        
        
LBLGETWODETAILS:        
GOTO LAST        
        
LBLGETLEDGERS:        
 SELECT T1.*,T2.JOB_CODE FROM PRD_AGENCY_MST T1        
 JOIN AGENCY_JOBS T2 ON T2.AGENCY_CODE = T1.AGENCY_CODE        
 WHERE (@CWHERE='' OR T2.JOB_CODE = @CWHERE )
 ORDER BY AGENCY_NAME        
 GOTO LAST        
        
LBLGETJOBS:        
 SELECT DISTINCT JOBS.* FROM PRD_WO_DET D         
 JOIN PRD_WO_ART_JOBS J ON D.ROW_ID = J.REF_ROW_ID         
 JOIN JOBS ON J.JOB_CODE = JOBS.JOB_CODE         
 WHERE (@CMEMOID='' OR D.MEMO_ID =@CMEMOID )
 ORDER BY JOBS.JOB_NAME        
         
GOTO LAST        
LAST:        
END
