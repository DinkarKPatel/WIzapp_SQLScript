CREATE PROCEDURE SP3S_HSN_PERCENTAGE
(
 @DMEMO_DT DATETIME
)
AS
BEGIN

IF OBJECT_ID('TEMPDB..#TMPHSN','U') IS NOT NULL
    DROP TABLE #TMPHSN

  ;WITH CTE AS
  (
   SELECT B.HSN_CODE,ISNULL(C.TAX_PERCENTAGE,0) AS TAX_PERCENTAGE,ISNULL(C.RATE_CUTOFF,0) AS RATE_CUTOFF,
   ISNULL(C.RATE_CUTOFF_TAX_PERCENTAGE,0) AS RATE_CUTOFF_TAX_PERCENTAGE,
   ISNULL(C.WEF,'') AS WEF,ISNULL(B.TAXABLE_ITEM,'') AS TAXABLE_ITEM,ISNULL(B.HSN_TYPE ,'') AS HSN_TYPE  ,
   SR=ROW_NUMBER() OVER (PARTITION BY B.HSN_CODE ORDER BY ISNULL(C.WEF,'') DESC)
  
   FROM HSN_MST B (NOLOCK) 
   LEFT JOIN HSN_DET C (NOLOCK) ON B.HSN_CODE =C.HSN_CODE AND C.WEF  <=@DMEMO_DT 
  )
  
  SELECT * INTO #TMPHSN FROM CTE WHERE SR=1
  
  SELECT HSN_CODE,TAX_PERCENTAGE
  FROM #TMPHSN
  ORDER BY HSN_CODE 
  
  
END
