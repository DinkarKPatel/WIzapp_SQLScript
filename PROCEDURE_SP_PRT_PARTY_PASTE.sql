CREATE PROCEDURE SP_PRT_PARTY_PASTE   --(LocId 3 digit change by Sanjay:06-11-2024)     
(          
 @CPRODUCTCODE NVARCHAR(50),        
 @MEMOTYPE NUMERIC(1),        
 @NMODE INT=1  ,        
 @CDEPTID varCHAR(4)='',         
 @CBIN_ID VARCHAR(MAX)='',
 @CUSERCODE VARCHAR(10)	--//FOR BIN AUTHENTICATION//     
) 
--WITH ENCRYPTION
         
AS           
BEGIN 
  DECLARE @CQUERY NVARCHAR(MAX)      
  SET @CQUERY=N'SELECT DISTINCT A.AC_CODE AS [AC_CODE], F.UOM_TYPE, H.SECTION_NAME, G.SUB_SECTION_NAME,A.PRODUCT_CODE,            
 CONVERT(VARCHAR, A.INV_DT, 105) AS INV_DT, A.INV_NO,LM.AC_NAME,              
  A.PURCHASE_PRICE AS GROSS_PURCHASE_PRICE,   A.MRP,A.WS_PRICE ,B.ARTICLE_CODE,   
 B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC, C.PARA1_NAME, D.PARA2_NAME,E.PARA3_NAME, P4.PARA4_NAME,   
 P5.PARA5_NAME , P6.PARA6_NAME, F.UOM_CODE, F.UOM_NAME,  I.FORM_ID, PMT.DEPT_ID,             
 I.FORM_NAME,  I.TAX_PERCENTAGE, ISNULL(PMT.QUANTITY_IN_STOCK,0) AS [QUANTITY_IN_STOCK],            
 ISNULL(B.DT_CREATED,'''') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'''') AS [PARA3_DT_CREATED],ISNULL(A.DT_CREATED,'''') AS [SKU_DT_CREATED],          
 '''' AS MRR_NO ,A.BARCODE_CODING_SCHEME AS CODING_SCHEME,B.DISCON,          
 LM.INACTIVE ,LMP.ON_HOLD,0 AS  [DISCOUNT_PERCENTAGE],0 AS  [DISCOUNT_AMOUNT],   
 CONVERT(NUMERIC(14,2),(CASE WHEN A.PURCHASE_PRICE<>0 THEN (AOH.DISCOUNT_AMOUNT *100)/A.PURCHASE_PRICE
								 ELSE 0 END)) AS  [DN_DISCOUNT_PERCENTAGE],     
 (CASE WHEN A.ER_FLAG=0 THEN 1 ELSE A.ER_FLAG END )AS ER_FLAG,A.CHALLAN_NO,A.INV_NO AS BILL_NO ,ISNULL(AOH.EXCISE_DUTY_AMOUNT,0) AS EXCISE_DUTY_AMOUNT,          
 ISNULL(AOH.FREIGHT,0) AS FREIGHT, ISNULL(AOH.OTHER_CHARGES,0) AS OTHER_CHARGES,          
 0 AS [PUR_DISCOUNT_PERCENTAGE],0 AS [PUR_DISCOUNT_AMOUNT] ,      
  A.PURCHASE_PRICE  AS INV_RATE      
 , A.PURCHASE_PRICE  ,TEMP.QTY AS QUANTITY,       
 1 AS BILL_LEVEL_TAX_METHOD ,''EXCLUSIVE'' AS TAX_METHOD_NAME ,
 ISNULL(BI.BIN_ID,''' +@CBIN_ID +''') AS [BIN_ID],BI.BIN_NAME,B.ALIAS AS ARTICLE_ALIAS,ISNULL(AOH.EXCISE_DUTY_AMOUNT,0) AS PARTY_PUR_EXCISE_RATE
 ,'''' AS ERRMSG
 FROM SKU A (NOLOCK)                
 LEFT JOIN SKU_OH AOH (NOLOCK) ON A.PRODUCT_CODE=AOH.PRODUCT_CODE          
 JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE                  
 JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE                  
 JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE                 
 JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE                  
 JOIN PARA4 P4 (NOLOCK) ON A.PARA4_CODE = P4.PARA4_CODE                  
 JOIN PARA5 P5 (NOLOCK) ON A.PARA5_CODE = P5.PARA5_CODE                  
 JOIN PARA6 P6 (NOLOCK) ON A.PARA6_CODE = P6.PARA6_CODE          
 JOIN UOM F (NOLOCK) ON B.UOM_CODE = F.UOM_CODE                 
 JOIN SECTIOND G (NOLOCK) ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE                  
 JOIN SECTIONM H (NOLOCK) ON G.SECTION_CODE = H.SECTION_CODE                 
 JOIN FORM I (NOLOCK) ON A.FORM_ID = I.FORM_ID                         
 LEFT OUTER JOIN PMT01106 PMT (NOLOCK) ON PMT.PRODUCT_CODE=A.PRODUCT_CODE           
 JOIN LM01106 LM (NOLOCK) ON A.AC_CODE = LM.AC_CODE          
 LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LM.AC_CODE=LMP.AC_CODE          
 JOIN BIN_LOC BL (NOLOCK) ON BL.DEPT_ID =''' +@CDEPTID +'''  
 JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=BL.DEPT_ID    
 JOIN BIN BI (NOLOCK) ON BI.BIN_ID=BL.BIN_ID 
 JOIN #TEMP_PCODE_' +@CPRODUCTCODE +' TEMP (NOLOCK)  ON TEMP.PRODUCT_CODE=A.PRODUCT_CODE                      
 JOIN BINUSERS BU (NOLOCK) ON BI.BIN_ID=BU.BIN_ID AND BU.USER_CODE=''' + @CUSERCODE + '''
 WHERE BL.BIN_ID='+(CASE WHEN ISNULL(@CBIN_ID,'')='' THEN 'BL.BIN_ID' ELSE '''' +@CBIN_ID +'''' END)      +  '
 AND A.ER_FLAG=(CASE WHEN '+LTRIM(RTRIM(STR(@MEMOTYPE)))+'=1 OR A.BARCODE_CODING_SCHEME=1 THEN A.ER_FLAG ELSE '+LTRIM(RTRIM(STR(@MEMOTYPE)))+' END)'                   
  
 PRINT @CQUERY
 EXECUTE SP_EXECUTESQL @CQUERY   
END
