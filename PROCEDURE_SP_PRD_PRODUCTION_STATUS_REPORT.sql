CREATE PROCEDURE SP_PRD_PRODUCTION_STATUS_REPORT  
(  
 @DASON AS DATETIME='',  
 @CARTICLE_CODE VARCHAR(MAX)='',  
 @CAC_CODE VARCHAR(MAX)='',  
 @MERCHANT_CODE VARCHAR(MAX)='',  
 @CAC_CODE_NOTIN VARCHAR(10)='',  
 @NSUMMARY INT=0  
)  
AS  
BEGIN  
  
DECLARE @DTSQL NVARCHAR(MAX),@CART_STATUS VARCHAR(MAX),@AAC_STATUS VARCHAR(MAX),  
        @CMERCHANTSTATUS VARCHAR(MAX)  
  
  
IF @CARTICLE_CODE=''  
BEGIN  
   SET @CART_STATUS=''  
   SET @CARTICLE_CODE='IN('''')'  
END  
ELSE   
BEGIN  
   SET @CART_STATUS='LATER'  
END  
  
IF @CAC_CODE=''  
BEGIN  
   SET @AAC_STATUS=''  
   SET @CAC_CODE='IN('''')'  
END  
ELSE   
BEGIN  
   SET @AAC_STATUS='LATER'  
END  
  
  
IF @MERCHANT_CODE=''  
BEGIN  
   SET @CMERCHANTSTATUS=''  
   SET @MERCHANT_CODE='IN('''')'  
END  
ELSE   
BEGIN  
   SET @CMERCHANTSTATUS='LATER'  
END  
  
  
  
IF OBJECT_ID('TEMPDB..#TMPORDER','U') IS NOT NULL  
   DROP TABLE #TMPORDER  
     
     
SELECT B.ARTICLE_CODE,ART.ARTICLE_NO,  
       B.PARA1_CODE,P1.PARA1_NAME,  
       B.PARA2_CODE,P2.PARA2_NAME,  
       A.AC_CODE,LM.AC_NAME,A.ORDER_ID,  
       A.ORDER_NO,A.ORDER_DT,A.DELIVERY_DT,  
       DATEDIFF(DAY,A.ORDER_DT,A.DELIVERY_DT) AS DTD,  
       ISNULL(A.SALE_EMP_CODE,'0000000') AS SALE_EMP_CODE,ISNULL(EMP.EMP_NAME,'') AS EMP_NAME,  
       ISNULL(A.MERCHANT_CODE,'') AS MERCHANT_CODE,ISNULL(EMP1.EMP_NAME,'') AS MERCHANT,  
       (B.QUANTITY)-ISNULL(ADJ_QTY,0) AS QTY, 
        ISNULL(ADJ_QTY,0) AS ADJ_QTY,
       --CAST(0 AS NUMERIC(10,2)) AS DLVRD,  
       CAST(0 AS NUMERIC(10,2)) AS PENDING_WSL,  
       CAST(0 AS NUMERIC(10,2)) AS QUANTITY_IN_STOCK ,
       CAST(0 AS INT) AS SR 
INTO #TMPORDER1  
FROM BUYER_ORDER_MST A (NOLOCK)  
JOIN BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID  
JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=A.AC_CODE  
JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=B.ARTICLE_CODE   
JOIN PARA1 P1 ON P1.PARA1_CODE =B.PARA1_CODE   
JOIN PARA2 P2 ON P2.PARA2_CODE =B.PARA2_CODE   
LEFT JOIN EMPLOYEE EMP (NOLOCK) ON EMP.EMP_CODE=A.SALE_EMP_CODE  
LEFT JOIN EMPLOYEE EMP1 (NOLOCK) ON EMP1.EMP_CODE=B.ITEM_EMP_CODE  
WHERE   
1=2  
     
     
SET @DTSQL=N'SELECT B.ARTICLE_CODE,ART.ARTICLE_NO,  
       B.PARA1_CODE,P1.PARA1_NAME,  
       B.PARA2_CODE,P2.PARA2_NAME,  
       A.AC_CODE,LM.AC_NAME,A.ORDER_ID,  
       A.ORDER_NO,A.ORDER_DT,A.DELIVERY_DT,  
       DATEDIFF(DAY,A.DELIVERY_DT,GETDATE()) AS DTD,  
       ISNULL(B.ITEM_EMP_CODE,''0000000'') AS SALE_EMP_CODE,ISNULL(EMP.EMP_NAME,'''') AS EMP_NAME,  
       ISNULL(B.ITEM_MERCHANT_CODE,'''') AS MERCHANT_CODE,ISNULL(EMP1.EMP_NAME,'''') AS MERCHANT,  
       SUM(B.QUANTITY) AS QTY,  
       SUM(ISNULL(B.ADJ_QTY,0)) AS ADJ_QTY,
       --(ISNULL(WSL_QTY,0)) AS DLVRD,  
       SUM(B.QUANTITY) AS PENDING_WSL,  --(ISNULL(WSL_QTY,0))
        ISNULL(QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,
        SR=ROW_NUMBER() OVER (PARTITION BY  B.ARTICLE_CODE,A.ORDER_ID ORDER BY B.ARTICLE_CODE,A.ORDER_ID ) 
FROM BUYER_ORDER_MST A (NOLOCK)  
JOIN BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID  
JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=A.AC_CODE  
JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=B.ARTICLE_CODE   
JOIN PARA1 P1 ON P1.PARA1_CODE =B.PARA1_CODE   
JOIN PARA2 P2 ON P2.PARA2_CODE =B.PARA2_CODE   
LEFT JOIN EMPLOYEE EMP (NOLOCK) ON EMP.EMP_CODE=B.ITEM_EMP_CODE  
LEFT JOIN EMPLOYEE EMP1 (NOLOCK) ON EMP1.EMP_CODE=B.ITEM_MERCHANT_CODE  
--LEFT OUTER JOIN  
--(  
-- SELECT AC_CODE,ORDER_ID,PACKSLIP_ARTICLE_CODE,PACKSLIP_PARA1_CODE,PACKSLIP_PARA2_CODE,  
-- SUM(QUANTITY) AS WSL_QTY   
-- FROM WPS_MST A (NOLOCK)  
-- JOIN WPS_DET B (NOLOCK) ON A.PS_ID=B.PS_ID  
-- WHERE A.CANCELLED=0 AND ISNULL(ORDER_ID,'''')<>''''  
-- GROUP BY AC_CODE,ORDER_ID,PACKSLIP_ARTICLE_CODE,PACKSLIP_PARA1_CODE,PACKSLIP_PARA2_CODE  
--) WSL ON WSL.ORDER_ID=A.ORDER_ID  
--AND A.AC_CODE=WSL.AC_CODE  
--AND B.ARTICLE_CODE=WSL.PACKSLIP_ARTICLE_CODE  
--AND B.PARA1_CODE=WSL.PACKSLIP_PARA1_CODE  
--AND B.PARA2_CODE=WSL.PACKSLIP_PARA2_CODE  
LEFT OUTER JOIN  
(  
 SELECT  A.ARTICLE_CODE,--A.PARA1_CODE,A.PARA2_CODE,  
 SUM(QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK   
 FROM SKU A (NOLOCK)  
 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE  
 GROUP BY A.ARTICLE_CODE--,A.PARA1_CODE,A.PARA2_CODE  
) STK ON  B.ARTICLE_CODE=STK.ARTICLE_CODE  
--AND B.PARA1_CODE=STK.PARA1_CODE  
--AND B.PARA2_CODE=STK.PARA2_CODE  
WHERE A.CANCELLED=0   
AND A.ORDER_DT<='''+CONVERT(VARCHAR(11),@DASON,120)+'''  
AND ('''+RTRIM(LTRIM(@CART_STATUS))+'''='''' OR ART.ARTICLE_CODE '+@CARTICLE_CODE+')  
AND ('''+RTRIM(LTRIM(@AAC_STATUS))+'''='''' OR A.AC_CODE '+@CAC_CODE+')  
AND ('''+RTRIM(LTRIM(@CMERCHANTSTATUS))+'''='''' OR B.ITEM_MERCHANT_CODE '+@MERCHANT_CODE+')  
AND ('''+RTRIM(LTRIM(@CAC_CODE_NOTIN))+'''='''' OR A.AC_CODE<>'''+@CAC_CODE_NOTIN+''')  
GROUP BY  B.ARTICLE_CODE,ART.ARTICLE_NO,P1.PARA1_NAME,  
 B.PARA1_CODE,A.AC_CODE,LM.AC_NAME,  
A.ORDER_NO,A.ORDER_ID,A.ORDER_DT,A.DELIVERY_DT,  
DATEDIFF(DAY,A.DELIVERY_DT,GETDATE()) ,  
ISNULL(B.ITEM_EMP_CODE,''0000000''),ISNULL(EMP.EMP_NAME,''''),  
B.ITEM_MERCHANT_CODE,EMP1.EMP_NAME,B.PARA2_CODE,P2.PARA2_NAME ,ISNULL(QUANTITY_IN_STOCK,0)'  
  
PRINT @DTSQL  
INSERT INTO #TMPORDER1  
EXEC SP_EXECUTESQL @DTSQL  
  
  

 IF OBJECT_ID('TEMPDB..#TMPWSP','U') IS NOT NULL
      DROP TABLE #TMPWSP
      
     SELECT B.AC_CODE, A.ORDER_ID,A.PACKSLIP_ARTICLE_CODE,PACKSLIP_PARA1_CODE,PACKSLIP_PARA2_CODE ,
     SUM(QUANTITY) AS WPS_QTY
     INTO #TMPWSP
     FROM WPS_DET A
     JOIN WPS_MST B ON A.PS_ID=B.PS_ID
     WHERE B.CANCELLED=0 AND A.ORDER_ID<>''
     GROUP BY B.AC_CODE,A.ORDER_ID,A.PACKSLIP_ARTICLE_CODE ,PACKSLIP_PARA1_CODE,PACKSLIP_PARA2_CODE
   
   
  
	  
	  
	SELECT  A.ARTICLE_CODE,A.ARTICLE_NO,A.PARA1_CODE,A.PARA1_NAME,A.PARA2_CODE
		   ,A.PARA2_NAME,A.AC_CODE,A.AC_NAME,A.ORDER_ID,A.ORDER_NO
		   ,A.ORDER_DT,A.DELIVERY_DT,A.DTD,A.SALE_EMP_CODE,A.EMP_NAME,A.MERCHANT_CODE
		   ,A.MERCHANT,A.QTY,
		   ISNULL(ADJ_QTY,0) AS ADJ_QTY,
		   A.QUANTITY_IN_STOCK,A.SR ,
			WPS.WPS_QTY,
			ISNULL(WPS.WPS_QTY,0) AS DLVRD,
			SUM(A.QTY)-(ISNULL(ADJ_QTY,0)+ISNULL(WPS.WPS_QTY,0)) AS PENDING_WSL,
			   CASE WHEN  SUM(A.QTY)-ISNULL(WPS.WPS_QTY,0) <=0  THEN 2
					WHEN  SUM(A.QTY)-ISNULL(WPS.WPS_QTY,0)>=ISNULL(A.QTY,0) THEN 0
			   ELSE 1 END AS TYPE
			--CASE WHEN CASE WHEN  SUM(B.QTY)-ISNULL(WPS.WPS_QTY,0) <=0  THEN 2
			--		       WHEN  SUM(B.QTY)-ISNULL(WPS.WPS_QTY,0)>=ISNULL(A.QTY,0) THEN 0
			--   ELSE 1 END=0 THEN 0 ELSE A.QTY END AS DLVRD,
			   
			--SUM(B.QTY) AS CUMM_SUM,
			--A.QTY -CASE WHEN CASE WHEN  SUM(B.QTY)-ISNULL(WPS.WPS_QTY,0) <=0  THEN 2
			--		              WHEN  SUM(B.QTY)-ISNULL(WPS.WPS_QTY,0)>=ISNULL(A.QTY,0) THEN 0
			--                      ELSE 1 END=0 
			--         THEN 0 ELSE A.QTY END AS PENDING_WSL,	
			         	   
			--   CASE WHEN  SUM(B.QTY)-ISNULL(WPS.WPS_QTY,0) <=0  THEN 2
			--		WHEN  SUM(B.QTY)-ISNULL(WPS.WPS_QTY,0)>=ISNULL(A.QTY,0) THEN 0
			--   ELSE 1 END AS TYPE
    INTO #TMPORDER
	FROM #TMPORDER1 A
	--JOIN #TMPORDER1 B ON A.ARTICLE_CODE=B.ARTICLE_CODE AND A.ORDER_ID=B.ORDER_ID  AND B.SR<=A.SR
	LEFT JOIN #TMPWSP WPS ON A.ORDER_ID=WPS.ORDER_ID
			AND A.ARTICLE_CODE=WPS.PACKSLIP_ARTICLE_CODE
			AND A.AC_CODE=WPS.AC_CODE AND A.PARA1_CODE =WPS.PACKSLIP_PARA1_CODE AND A.PARA2_CODE =WPS.PACKSLIP_PARA2_CODE
	GROUP BY A.ARTICLE_CODE,A.ARTICLE_NO,A.PARA1_CODE,A.PARA1_NAME,A.PARA2_CODE
		   ,A.PARA2_NAME,A.AC_CODE,A.AC_NAME,A.ORDER_ID,A.ORDER_NO,A.PENDING_WSL
		   ,A.ORDER_DT,A.DELIVERY_DT,A.DTD,A.SALE_EMP_CODE,A.EMP_NAME,A.MERCHANT_CODE
		   ,A.MERCHANT,A.QTY,ISNULL(ADJ_QTY,0),A.QUANTITY_IN_STOCK,A.SR ,WPS.WPS_QTY
	ORDER BY A.ORDER_ID,A.SR



--(ISNULL(WSL_QTY,0)) AS DLVRD,  
-- SUM(B.QUANTITY) AS PENDING_WSL,

  
--BUYER ORDER AGEAINST WORK ORDER  
  
IF OBJECT_ID('TEMPDB..#TMPWO','U') IS NOT NULL  
   DROP TABLE #TMPWO  
     
   SELECT A.ORDER_ID,A.MEMO_ID ,B.ARTICLE_CODE,Q.PARA1_CODE,Q.PARA2_CODE,       
   SUM(B.QUANTITY) AS QUANTITY,SUM(B.ADJ_QTY) AS ADJ_QTY, SUM(Q.QUANTITY) AS PRD_QUANTITY    
 INTO #TMPWO   
 FROM  (SELECT DISTINCT * FROM PRD_WO_ORDERS) A       
 JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID       
 JOIN PRD_WO_DET P ON C.MEMO_ID=P.MEMO_ID       
 JOIN PRD_WO_SUB_DET Q ON P.ROW_ID =Q.REF_ROW_ID       
 JOIN BUYER_ORDER_DET B ON A.ORDER_ID=B.ORDER_ID       
 AND B.PARA1_CODE = Q.PARA1_CODE       
 AND B.PARA2_CODE = Q.PARA2_CODE       
 AND B.ARTICLE_CODE = C.ARTICLE_SET_CODE       
 JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID       
 WHERE C.CANCELLED=0  AND M.CANCELLED=0  
 AND 1=2  
 GROUP BY A.ORDER_ID,A.MEMO_ID,B.ARTICLE_CODE,Q.PARA1_CODE,Q.PARA2_CODE  
     
     
SET @DTSQL=N' SELECT B.ORDER_ID,ISNULL(A.MEMO_ID,'''') AS MEMO_ID ,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,       
   SUM(B.QUANTITY) AS QUANTITY,SUM(ISNULL(B.ADJ_QTY,0)) AS ADJ_QTY, SUM(ISNULL(A.QUANTITY,0)) AS PRD_QUANTITY     
 FROM BUYER_ORDER_DET B   
 JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID   
 LEFT OUTER JOIN  
 (  
  SELECT A.ORDER_ID,C.ARTICLE_SET_CODE ,A.MEMO_ID,Q.PARA1_CODE,Q.PARA2_CODE,Q.QUANTITY  
  FROM  
 (SELECT DISTINCT * FROM PRD_WO_ORDERS) A       
 JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID       
 JOIN PRD_WO_DET P ON C.MEMO_ID=P.MEMO_ID       
 JOIN PRD_WO_SUB_DET Q ON P.ROW_ID =Q.REF_ROW_ID       
 WHERE C.CANCELLED=0   
 ) A ON A.ORDER_ID=B.ORDER_ID       
 AND B.PARA1_CODE = A.PARA1_CODE       
 AND B.PARA2_CODE = A.PARA2_CODE       
 AND B.ARTICLE_CODE = A.ARTICLE_SET_CODE       
 WHERE  M.CANCELLED=0  
 AND M.ORDER_DT<='''+CONVERT(VARCHAR(11),@DASON,120)+'''  
 AND ('''+RTRIM(LTRIM(@CART_STATUS))+'''='''' OR B.ARTICLE_CODE '+@CARTICLE_CODE+')  
 AND ('''+RTRIM(LTRIM(@AAC_STATUS))+'''='''' OR M.AC_CODE '+@CAC_CODE+')  
 AND ('''+RTRIM(LTRIM(@CMERCHANTSTATUS))+'''='''' OR B.ITEM_MERCHANT_CODE '+@MERCHANT_CODE+')  
 AND ('''+RTRIM(LTRIM(@CAC_CODE_NOTIN))+'''='''' OR M.AC_CODE<>'''+@CAC_CODE_NOTIN+''')  
 GROUP BY B.ORDER_ID,A.MEMO_ID,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE'  
 PRINT @DTSQL  
INSERT INTO #TMPWO  
EXEC SP_EXECUTESQL @DTSQL  
  
  
     
  
IF OBJECT_ID('TEMPDB..#TMPWOQTY','U') IS NOT NULL  
   DROP TABLE #TMPWOQTY  
  
SELECT A.*,ISNULL(ISSUE_QTY,0) AS ISSUE_QTY,  
       A.QUANTITY-(ISNULL(ADJ_QTY,0)+ISNULL(ISSUE_QTY,0)) AS WO_QTY  
INTO #TMPWOQTY  
FROM   
         
 ( SELECT A.ORDER_ID,A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,       
   SUM(A.QUANTITY) AS QUANTITY, SUM(A.ADJ_QTY) AS ADJ_QTY, SUM(A.PRD_QUANTITY) AS PRD_QUANTITY     
  FROM  #TMPWO A  
  GROUP BY A.ORDER_ID,A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE  
 ) A  
 LEFT OUTER JOIN  
 (  
  SELECT A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,  
         B.REF_WO_ID,SUM(ISSUE_QTY) AS ISSUE_QTY  
  FROM PRD_STK_TRANSFER_MATERIAL_DET A (NOLOCK)  
  JOIN  
  (  
   SELECT A.MEMO_ID, A.REF_WO_ID,REF_ROW_ID FROM PRD_STK_TRANSFER_DET A  
   JOIN PRD_STK_TRANSFER_MST B ON A.MEMO_ID=B.MEMO_ID  
   WHERE B.CANCELLED=0  
   GROUP BY A.MEMO_ID,A.REF_WO_ID,REF_ROW_ID  
  ) B ON A.MEMO_ID=B.MEMO_ID AND A.ROW_ID=B.REF_ROW_ID  
  GROUP BY A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,B.REF_WO_ID  
 ) B ON A.MEMO_ID=B.REF_WO_ID  
 AND A.ARTICLE_CODE=B.ARTICLE_CODE  
 AND A.PARA1_CODE=B.PARA1_CODE  
 AND A.PARA2_CODE=B.PARA2_CODE  
 WHERE   
 A.QUANTITY-ISNULL(ISSUE_QTY,0)>0   
--  B.REF_WO_ID='WH0111700000WH00001000'  
  
--ALL JOBS AGE=AINST WORK ORDER AND ITS QTY    
  
  
  
IF OBJECT_ID('TEMPDB..#TMPJOBS','U') IS NOT NULL  
   DROP TABLE #TMPJOBS  
     
  
IF OBJECT_ID('TEMPDB..#TMPJOBS','U') IS NOT NULL  
   DROP TABLE #TMPJOBS  
     
SELECT A.ORDER_ID,A.MEMO_ID AS WORK_ORDER_ID ,A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE,JOB_NAME,  
       ISNULL(B.ISSUE_QTY,0)-ISNULL(REC_QTY,0) AS  ISSUE_QTY  
INTO #TMPJOBS  
FROM   
  
( SELECT A.ORDER_ID,A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,       
   SUM(A.QUANTITY) AS QUANTITY, SUM(A.PRD_QUANTITY) AS PRD_QUANTITY     
  FROM  #TMPWO A  
  GROUP BY A.ORDER_ID,A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE  
 ) A  
 JOIN  
  (  
 SELECT  B.WORK_ORDER_ID ,A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE,B.JOB_NAME,B.JOB_CODE,  
       SUM(A.ISSUE_QTY) AS  ISSUE_QTY  
       FROM  
   PRD_AGENCY_ISSUE_ROW_MATERIAL_DET A  
   JOIN   
 (  
  SELECT A.MEMO_ID,A.REF_MATERIAL_ROW_ID ,  
  A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID,A.JOB_CODE,JOBS.JOB_NAME  
  FROM  PRD_AGENCY_ISSUE_MATERIAL_DET A  
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID=B.MEMO_ID  
  JOIN JOBS ON A.JOB_CODE=JOBS.JOB_CODE  
  WHERE B.CANCELLED=0   
  GROUP BY A.MEMO_ID,A.REF_MATERIAL_ROW_ID ,  
  A.REF_PRD_WORKORDER_MEMOID ,A.JOB_CODE,JOBS.JOB_NAME,A.JOB_CODE  
 ) B ON A.MEMO_ID=B.MEMO_ID AND  A.ROW_ID= B.REF_MATERIAL_ROW_ID  
GROUP BY B.WORK_ORDER_ID ,A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE,B.JOB_NAME,B.JOB_CODE  
) B ON A.MEMO_ID=B.WORK_ORDER_ID  
 AND A.ARTICLE_CODE=B.ARTICLE_CODE  
 AND A.PARA1_CODE=B.PARA1_CODE  
 AND A.PARA2_CODE=B.PARA2_CODE  
    
LEFT  JOIN  
(  
 SELECT D.WORK_ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,D.JOB_CODE,  
 SUM(REC_QTY) AS REC_QTY  
 FROM PRD_AGENCY_ROW_MATERIAL_RECEIPT_DET A  
 JOIN  
 (  
  SELECT A.MEMO_ID ,REF_MATERIAL_ROW_ID,C.WORK_ORDER_ID,C.JOB_CODE  
  FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A  
  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID  
  JOIN  
  (  
   SELECT A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID ,A.JOB_CODE  
   FROM PRD_AGENCY_ISSUE_MATERIAL_DET A  
   JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID=B.MEMO_ID  
   WHERE B.CANCELLED=0  
   GROUP BY A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID ,A.JOB_CODE  
   UNION ALL  
   SELECT A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID,A.JOB_CODE  
   FROM PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING A  
   JOIN PRD_AGENCY_ISSUE_MATERIAL_MST_PENDING B ON A.MEMO_ID=B.MEMO_ID  
   WHERE B.CANCELLED=0  
   GROUP BY A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID ,A.JOB_CODE  
  ) C ON  C.ROW_ID=A.REF_ROW_ID  
  WHERE B.CANCELLED=0  
  GROUP BY A.MEMO_ID ,REF_MATERIAL_ROW_ID,C.WORK_ORDER_ID,C.JOB_CODE  
 )D ON A.MEMO_ID=D.MEMO_ID AND A.ROW_ID=D. REF_MATERIAL_ROW_ID  
 GROUP BY D.WORK_ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,D.JOB_CODE  
) REC    
ON A.MEMO_ID=REC.WORK_ORDER_ID  
 AND A.ARTICLE_CODE=REC.ARTICLE_CODE  
 AND A.PARA1_CODE=REC.PARA1_CODE  
 AND A.PARA2_CODE=REC.PARA2_CODE  
 AND B.JOB_CODE=REC.JOB_CODE  
  
  
IF OBJECT_ID('TEMPDB..#TMPWIP','U') IS NOT NULL  
   DROP TABLE #TMPWIP  
  
SELECT A.ORDER_ID,A.MEMO_ID AS WORK_ORDER_ID ,A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE,  
       PRD_QUANTITY-(ISNULL(B.ISSUE_QTY,0)-ISNULL(REC_QTY,0)) AS  WIP_QTY  
 INTO #TMPWIP  
FROM   
  
( SELECT A.ORDER_ID,A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,       
   SUM(A.QUANTITY) AS QUANTITY, SUM(A.PRD_QUANTITY) AS PRD_QUANTITY     
  FROM  #TMPWO A  
  GROUP BY A.ORDER_ID,A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE  
 ) A  
 JOIN  
  (  
 SELECT  B.WORK_ORDER_ID ,A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE,  
       SUM(A.ISSUE_QTY) AS  ISSUE_QTY  
       FROM  
   PRD_AGENCY_ISSUE_ROW_MATERIAL_DET A  
   JOIN   
 (  
  SELECT A.MEMO_ID,A.REF_MATERIAL_ROW_ID ,  
  A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID  
  FROM  PRD_AGENCY_ISSUE_MATERIAL_DET A  
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID=B.MEMO_ID  
  WHERE B.CANCELLED=0   
  GROUP BY A.MEMO_ID,A.REF_MATERIAL_ROW_ID ,  
  A.REF_PRD_WORKORDER_MEMOID   
 ) B ON A.MEMO_ID=B.MEMO_ID AND  A.ROW_ID= B.REF_MATERIAL_ROW_ID  
GROUP BY B.WORK_ORDER_ID ,A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE  
) B ON A.MEMO_ID=B.WORK_ORDER_ID  
 AND A.ARTICLE_CODE=B.ARTICLE_CODE  
 AND A.PARA1_CODE=B.PARA1_CODE  
 AND A.PARA2_CODE=B.PARA2_CODE  
    
LEFT  JOIN  
(  
 SELECT D.WORK_ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,  
 SUM(REC_QTY) AS REC_QTY  
 FROM PRD_AGENCY_ROW_MATERIAL_RECEIPT_DET A  
 JOIN  
 (  
  SELECT A.MEMO_ID ,REF_MATERIAL_ROW_ID,C.WORK_ORDER_ID  
  FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A  
  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID  
  JOIN  
  (  
   SELECT A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID   
   FROM PRD_AGENCY_ISSUE_MATERIAL_DET A  
   JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID=B.MEMO_ID  
   WHERE B.CANCELLED=0  
   GROUP BY A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID  
   UNION ALL  
   SELECT A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID  
   FROM PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING A  
   JOIN PRD_AGENCY_ISSUE_MATERIAL_MST_PENDING B ON A.MEMO_ID=B.MEMO_ID  
   WHERE B.CANCELLED=0  
   GROUP BY A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID ,A.JOB_CODE  
  ) C ON  C.ROW_ID=A.REF_ROW_ID  
  WHERE B.CANCELLED=0  
  GROUP BY A.MEMO_ID ,REF_MATERIAL_ROW_ID,C.WORK_ORDER_ID  
 )D ON A.MEMO_ID=D.MEMO_ID AND A.ROW_ID=D. REF_MATERIAL_ROW_ID  
 GROUP BY D.WORK_ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE  
) REC    
ON A.MEMO_ID=REC.WORK_ORDER_ID  
 AND A.ARTICLE_CODE=REC.ARTICLE_CODE  
 AND A.PARA1_CODE=REC.PARA1_CODE  
 AND A.PARA2_CODE=REC.PARA2_CODE  
   
  
  
IF OBJECT_ID('TEMPDB..#TMPORDER_WO','U') IS NOT NULL  
   DROP TABLE #TMPORDER_WO  
  
SELECT A.* ,ISNULL(B.WO_QTY,0)-ISNULL(DLVRD,0) AS WO,ISNULL(WIP_QTY,0) AS WIP_QTY  
INTO #TMPORDER_WO  
FROM #TMPORDER A  
LEFT OUTER JOIN  
(  
 SELECT A.ORDER_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,SUM(WO_QTY) AS WO_QTY      
 FROM #TMPWOQTY A  
 GROUP BY A.ORDER_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE  
) B ON A.ORDER_ID=B.ORDER_ID   
AND A.ARTICLE_CODE=B.ARTICLE_CODE  
AND A.PARA1_CODE=B.PARA1_CODE  
AND A.PARA2_CODE=B.PARA2_CODE   
  
LEFT OUTER JOIN  
(  
 SELECT A.ORDER_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,SUM(WIP_QTY) AS WIP_QTY      
 FROM #TMPWIP A  
 GROUP BY A.ORDER_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE  
) C ON C.ORDER_ID=A.ORDER_ID   
AND C.ARTICLE_CODE=A.ARTICLE_CODE  
AND C.PARA1_CODE=A.PARA1_CODE  
AND C.PARA2_CODE=A.PARA2_CODE   
  
  
  
IF OBJECT_ID('TEMPDB..#TMPTRANSFER','U') IS NOT NULL  
   DROP TABLE #TMPTRANSFER  
  
SELECT A.*,ISNULL(ISSUE_QTY,0) AS TRF_QTY  
INTO #TMPTRANSFER  
FROM   
         
 ( SELECT A.ORDER_ID,A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,       
   SUM(A.QUANTITY) AS QUANTITY, SUM(A.PRD_QUANTITY) AS PRD_QUANTITY     
  FROM  #TMPWO A  
  GROUP BY A.ORDER_ID,A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE  
 ) A  
 JOIN  
 (  
  SELECT A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,  
         A.REF_PRD_WORKORDER_MEMOID AS REF_WO_ID,  
         SUM(QTY) AS ISSUE_QTY  
  FROM PRD_TRANSFER_MAIN_DET A (NOLOCK)  
  JOIN PRD_TRANSFER_MAIN_MST B ON A.MEMO_ID =B.MEMO_ID   
  WHERE B.CANCELLED =0  
  GROUP BY A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.REF_PRD_WORKORDER_MEMOID  
 ) B ON A.MEMO_ID=B.REF_WO_ID  
 AND A.ARTICLE_CODE=B.ARTICLE_CODE  
 AND A.PARA1_CODE=B.PARA1_CODE  
 AND A.PARA2_CODE=B.PARA2_CODE  
   
   
 DECLARE @CCOLNAME VARCHAR(MAX),@CDISPCOLNAME VARCHAR(MAX)  
 SET @CCOLNAME=''  
 SET @CDISPCOLNAME=''  
   
 IF OBJECT_ID('TEMPDB..#TMPJOBMST','U') IS NOT NULL  
    DROP TABLE #TMPJOBMST  
   
 SELECT DISTINCT JOB_NAME INTO #TMPJOBMST FROM #TMPJOBS   
   
 SELECT   @CCOLNAME=ISNULL(@CCOLNAME+',','')+'SUM(CASE WHEN JOB_NAME= '''+(JOB_NAME) + ''' THEN ISSUE_QTY ELSE 0 END) AS '+QUOTENAME(JOB_NAME)  
 FROM #TMPJOBMST  
 WHERE JOB_NAME<>''  
   
 SELECT   @CDISPCOLNAME=ISNULL(@CDISPCOLNAME+',','') + 'ISNULL('+QUOTENAME(JOB_NAME)+',0) AS '+REPLACE(JOB_NAME,' ','')  
 FROM #TMPJOBMST  
 WHERE JOB_NAME<>''  
 IF @CCOLNAME IS NULL
 SET @CCOLNAME=''
   
-- SELECT @CDISPCOLNAME  
   
 --IF @CCOLNAME<>''  
 --SET @CCOLNAME=','+@CCOLNAME  
   
 --IF @CDISPCOLNAME<>''  
 --SET @CDISPCOLNAME=','+@CDISPCOLNAME  
   
IF @NSUMMARY=1  
BEGIN  
    
  DECLARE @JOBWORKQTY AS VARCHAR(MAX)    
    
 SELECT   @JOBWORKQTY=ISNULL(@JOBWORKQTY+'+','') + 'SUM(ISNULL('+QUOTENAME(JOB_NAME)+',0))  '  
 FROM #TMPJOBMST  
 WHERE JOB_NAME<>''  
   
   IF @JOBWORKQTY IS NULL
   SET @JOBWORKQTY=0
     
    IF OBJECT_ID('TEMPDB..#TMPSUMMARY','U') IS NOT NULL  
       DROP TABLE #TMPSUMMARY  
 SELECT A.*,PENDING=PENDING_WSL,WIP_QTY-ISNULL(TRF_QTY,0) AS WIP_STOCK,  
 CASE WHEN DTD>0 THEN 1 ELSE 0 END AS TYPE1  
 INTO #TMPSUMMARY  
 FROM #TMPORDER_WO A   
 LEFT OUTER JOIN  
 (  
  SELECT A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,  
   SUM(TRF_QTY) AS TRF_QTY  
  FROM #TMPTRANSFER A  
  GROUP BY A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE  
 ) C ON A.ORDER_ID=C.ORDER_ID  
 AND A.ARTICLE_CODE=C.ARTICLE_CODE  
 AND A.PARA1_CODE=C.PARA1_CODE  
 AND A.PARA2_CODE=C.PARA2_CODE  
 ORDER BY ORDER_ID  
 -- EXEC SP_PRD_PRODUCTION_STATUS_REPORT '2016-10-28','IN (''HO0000287'')','','','',1   
  

 SET @DTSQL=N' SELECT A.ARTICLE_CODE,A.ARTICLE_NO,  
        SUM(QTY) AS BO_QTY,  
        SUM(ADJ_QTY) AS ADJ_QTY, 
        SUM(DLVRD) AS DLVRD,  
        SUM(WO) AS WO_QTY,  
        SUM(WIP_STOCK) AS WIP_STOCK,  
        QUANTITY_IN_STOCK,  
 '+@JOBWORKQTY+' AS JOB_WORK_QTY,  
 CAST(SUM(QTY)-(SUM(DLVRD)+SUM(WIP_STOCK)+QUANTITY_IN_STOCK+'+@JOBWORKQTY+') AS NUMERIC(12,2)) AS REQUIREMENT_QTY  
 FROM #TMPSUMMARY A  
 LEFT OUTER JOIN   
 (  
  SELECT A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE   
  '+@CCOLNAME+'  
  FROM #TMPJOBS A  
  GROUP BY A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE   
 ) B ON A.ORDER_ID=B.ORDER_ID  
 AND A.ARTICLE_CODE=B.ARTICLE_CODE  
 AND A.PARA1_CODE=B.PARA1_CODE  
 AND A.PARA2_CODE=B.PARA2_CODE  
 GROUP BY A.ARTICLE_CODE,A.ARTICLE_NO,QUANTITY_IN_STOCK  
 ORDER BY A.ARTICLE_NO'  
PRINT @DTSQL  
EXEC SP_EXECUTESQL @DTSQL  
  
  
END  
ELSE  
BEGIN  
SET @DTSQL=N'SELECT A.*,PENDING=PENDING_WSL,WIP_QTY-ISNULL(TRF_QTY,0) AS WIP_STOCK,  
CASE WHEN DTD>0 THEN 1 ELSE 0 END AS TYPE  
'+@CDISPCOLNAME+'  
FROM #TMPORDER_WO A  
LEFT OUTER JOIN   
(  
 SELECT A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE   
 '+@CCOLNAME+'  
 FROM #TMPJOBS A  
 GROUP BY A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE   
  
) B ON A.ORDER_ID=B.ORDER_ID  
AND A.ARTICLE_CODE=B.ARTICLE_CODE  
AND A.PARA1_CODE=B.PARA1_CODE  
AND A.PARA2_CODE=B.PARA2_CODE  
LEFT OUTER JOIN  
(  
 SELECT A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,  
        SUM(TRF_QTY) AS TRF_QTY  
 FROM #TMPTRANSFER A  
 GROUP BY A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE  
) C ON A.ORDER_ID=C.ORDER_ID  
AND A.ARTICLE_CODE=C.ARTICLE_CODE  
AND A.PARA1_CODE=C.PARA1_CODE  
AND A.PARA2_CODE=C.PARA2_CODE  
WHERE PENDING_WSL-ISNULL(TRF_QTY,0)>0  
ORDER BY ORDER_ID'  
  
PRINT @DTSQL  
EXEC SP_EXECUTESQL @DTSQL  
  
END  

END
