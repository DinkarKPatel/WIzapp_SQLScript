create FUNCTION FN_GETAGAINSTBILL
( 
	@CADVMEMOID VARCHAR(50)
)
RETURNS VARCHAR(MAX)
--WITH ENCRYPTION
AS 
BEGIN
	DECLARE @CCMIDLIST VARCHAR(MAX),@ARC_TYPE NUMERIC(5)
	
	SELECT @ARC_TYPE=ARC_TYPE FROM ARC01106 WHERE ADV_REC_ID=@CADVMEMOID
	IF ISNULL(@ARC_TYPE,0)=1
	BEGIN
	    SELECT @CCMIDLIST=ISNULL(@CCMIDLIST,'')+','+ LTRIM(RTRIM(CM_NO ))
		FROM CMM_CREDIT_RECEIPT A
		JOIN CMM01106 B ON B.CM_ID=A.CM_ID
		WHERE ADV_REC_ID=@CADVMEMOID
		
		IF EXISTS (SELECT TOP 1 'U' FROM HBD_RECEIPT (NOLOCK) WHERE ADV_REC_ID=@CADVMEMOID)
		BEGIN

			SELECT @CCMIDLIST=ISNULL(@CCMIDLIST,'')+','+ LTRIM(RTRIM(MEMO_NO ))
			FROM HBD_RECEIPT A (NOLOCK)
			JOIN HOLD_BACK_DELIVER_MST b (NOLOCK) ON B.MEMO_ID=A.MEMO_ID
			WHERE ADV_REC_ID=@CADVMEMOID
		END
	END
	IF ISNULL(@ARC_TYPE,0)=2
	BEGIN
	    SELECT @CCMIDLIST=ISNULL(@CCMIDLIST,'')+','+ LTRIM(RTRIM(C.CM_NO ))
		FROM PAYMODE_XN_DET A
		JOIN ARC01106 B ON B.ADV_REC_ID=A.MEMO_ID
		JOIN CMM01106 C ON C.CM_ID=A.ADJ_MEMO_ID
		WHERE ADV_REC_ID=@CADVMEMOID AND A.XN_TYPE='ARC'
	END

	
	SET @CCMIDLIST=SUBSTRING(@CCMIDLIST,2,LEN(@CCMIDLIST))
	RETURN @CCMIDLIST
END
