create PROCEDURE SP3S_MISMATCH_COLUMNS
(
 @CTABLE_TYPE VARCHAR(100)='_UPLOAD'
)
AS
BEGIN



	IF OBJECT_ID ('TEMPDB..#TMPUPLOADTABLE','U') IS NOT NULL
	   DROP TABLE #TMPUPLOADTABLE
	   
	SELECT A.*,B.TABLE_NAME  AS UPLOADTABLE_NAME
	INTO #TMPUPLOADTABLE
	FROM INFORMATION_SCHEMA.COLUMNS A (nolock)
	JOIN 
	( SELECT TABLE_NAME 
	  FROM INFORMATION_SCHEMA.COLUMNS A (nolock)
	  WHERE RIGHT (A.TABLE_NAME,6)  IN('MIRROR','UPLOAD')
	  AND A.TABLE_NAME NOT LIKE '%PPC%'
	  GROUP BY TABLE_NAME
	)B ON A.TABLE_NAME+@CTABLE_TYPE=RIGHT(B.TABLE_NAME,LEN(A.TABLE_NAME+@CTABLE_TYPE))
	WHERE RIGHT(REPLACE(B.TABLE_NAME,RIGHT(B.TABLE_NAME,LEN(A.TABLE_NAME+@CTABLE_TYPE)),''),1)='_'
	AND CHARINDEX('_',B.TABLE_NAME)=LEN(REPLACE(B.TABLE_NAME,RIGHT(B.TABLE_NAME,LEN(A.TABLE_NAME+@CTABLE_TYPE)),''))
	AND A.TABLE_NAME   NOT LIKE 'TMP%'
	AND  A.TABLE_NAME NOT LIKE 'TEMP%'
	AND RIGHT (A.TABLE_NAME,6) NOT IN('MIRROR','UPLOAD')
	AND A.TABLE_NAME NOT LIKE '%PPC%'
	and a.COLUMN_NAME not like '%HO_SYNCH_LAST_UPDATE%'



IF OBJECT_ID ('TEMPDB..#TMPCOLUMNMISMATCH','U') IS NOT NULL
   DROP TABLE #TMPCOLUMNMISMATCH
   
SELECT distinct  A.* 
INTO #TMPCOLUMNMISMATCH
FROM #TMPUPLOADTABLE A
LEFT JOIN  INFORMATION_SCHEMA .COLUMNS B (nolock) ON A.UPLOADTABLE_NAME =B.TABLE_NAME AND A.COLUMN_NAME =B.COLUMN_NAME 
WHERE A.COLUMN_NAME NOT IN('TS')
AND  B.COLUMN_NAME IS NULL



DECLARE @CTABLENAME VARCHAR(100),@CUPLOAD_TABLE_NAME VARCHAR(100),
        @CCOLUMNNAME VARCHAR(200),@CDATATYPE VARCHAR(100),
        @CHARACTER_MAXIMUM_LENGTH VARCHAR(100),
        @NNUMERIC_PRECISION VARCHAR(100),
        @NNUMERIC_SCALE VARCHAR(100),
        @DTSQL NVARCHAR(MAX),@cColMode VARCHAR(50)

WHILE EXISTS (SELECT TOP 1 'U' FROM #TMPCOLUMNMISMATCH)
BEGIN
      
    
    SELECT TOP 1 @CTABLENAME=TABLE_NAME ,
                 @CUPLOAD_TABLE_NAME=UPLOADTABLE_NAME,
                 @CCOLUMNNAME=COLUMN_NAME,
                 @CDATATYPE=DATA_TYPE,
                 @CHARACTER_MAXIMUM_LENGTH=CHARACTER_MAXIMUM_LENGTH,
                 @NNUMERIC_PRECISION=NUMERIC_PRECISION,
                 @NNUMERIC_SCALE=NUMERIC_SCALE
                 
    FROM #TMPCOLUMNMISMATCH
    
    IF RIGHT (@CUPLOAD_TABLE_NAME,6) IN('MIRROR','UPLOAD')
    BEGIN
			
		   SET @cColMode=''
		   	
		   IF NOT EXISTS (SELECT TOP 1 'U' FROM INFORMATION_SCHEMA .COLUMNS WHERE TABLE_NAME =@CUPLOAD_TABLE_NAME AND COLUMN_NAME=@CCOLUMNNAME)
				SET @cColMode=' ADD '
	       ELSE
	       IF  EXISTS (SELECT TOP 1 'U' FROM INFORMATION_SCHEMA .COLUMNS WHERE TABLE_NAME =@CUPLOAD_TABLE_NAME AND COLUMN_NAME=@CCOLUMNNAME
						  AND is_nullable='no') 
				SET @cColMode=' ALTER COLUMN '
		   
		   
		   IF @cColMode=''
				GOTO lblNextCol
				 		
		   IF ISNULL(@NNUMERIC_SCALE,'')<>''
		   SET @NNUMERIC_SCALE=','+@NNUMERIC_SCALE
	       
	       
		   IF @CHARACTER_MAXIMUM_LENGTH='-1'
		   SET @CHARACTER_MAXIMUM_LENGTH='MAX'
	       
		   IF @CDATATYPE IN('BIT','DATETIME','INT')
		   BEGIN
			 SET @DTSQL=' ALTER TABLE '+@CUPLOAD_TABLE_NAME+@cColMode+@CCOLUMNNAME+ ' '+@CDATATYPE
		   END
		   ELSE IF @CDATATYPE IN('NVARCHAR','NCHAR','VARCHAR','CHAR','varbinary')
		   BEGIN
			   SET @DTSQL=' ALTER TABLE '+@CUPLOAD_TABLE_NAME+@cColMode+@CCOLUMNNAME+ ' '+@CDATATYPE +' ('+@CHARACTER_MAXIMUM_LENGTH+')'
	          
		   END
		   ELSE IF @CDATATYPE IN('NUMERIC')
		   BEGIN
			   SET @DTSQL=' ALTER TABLE '+@CUPLOAD_TABLE_NAME+@cColMode+@CCOLUMNNAME+ ' '+@CDATATYPE +' ('+@NNUMERIC_PRECISION+@NNUMERIC_SCALE+')'
	          
		   END
	     
		  PRINT @DTSQL
		  EXEC SP_EXECUTESQL @DTSQL
    END
lblNextCol:

    DELETE FROM #TMPCOLUMNMISMATCH WHERE UPLOADTABLE_NAME=@CUPLOAD_TABLE_NAME AND COLUMN_NAME=@CCOLUMNNAME

END 
    
    IF @CTABLE_TYPE='_MIRROR'
    GOTO END_PROC
    
    EXEC SP3S_MISMATCH_COLUMNS '_MIRROR'

END_PROC:


END

/*
--docwsl_sku_mirror

--sls_cmm01106_upload

--exec SP3S_MISMATCH_COLUMNS '_upload'


set nocount on
*/
