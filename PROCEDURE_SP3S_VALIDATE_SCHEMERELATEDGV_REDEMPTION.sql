CREATE PROCEDURE SP3S_VALIDATE_SCHEMERELATEDGV_REDEMPTION
@NSPID VARCHAR(40),
@cLocationId VARCHAR(4),
@dCmDt DATETIME,
@NCMMSUBTOTAL NUMERIC(10,2),
@CERRORMSG VARCHAR(MAX) OUTPUT
AS
BEGIN
	DECLARE @CGVSCHEMECODE VARCHAR(10),@nGvMode NUMERIC(1,0),@cStep VARCHAR(10),
	@NMINBILLAMTFORGVREDEMPTION NUMERIC(10,0),@NGVSCHEMEAMOUNT NUMERIC(10,2)

BEGIN TRY
	SET @cStep=240

	SELECT TOP 1 @CGVSCHEMECODE=A.SCHEME_CODE,@NGVMODE=MODE FROM GV_SCHEME_MST A  (NOLOCK) 
	JOIN GV_SCHEME_LOCS B (NOLOCK) ON A.SCHEME_CODE=B.SCHEME_CODE
	WHERE B.DEPT_ID=@CLOCATIONID AND @DCMDT BETWEEN APPLICABLE_FROM_DT AND APPLICABLE_TO_DT
				
	IF ISNULL(@CGVSCHEMECODE,'')<>''
	BEGIN
		SET @cStep = 245
			
		SELECT @NMINBILLAMTFORGVREDEMPTION=MIN(MRP_FROM) FROM GV_SCHEME_1 (NOLOCK) WHERE SCHEME_CODE=@CGVSCHEMECODE
			
		IF @NCMMSUBTOTAL>=ISNULL(@NMINBILLAMTFORGVREDEMPTION,0)
		BEGIN
			IF @NGVMODE=1
				SELECT TOP 1 @NGVSCHEMEAMOUNT=AMOUNT FROM SLS_PAYMODE_XN_DET_UPLOAD (NOLOCK) WHERE SP_ID=@NSPID
				AND PAYMODE_CODE='GVC0001' AND AMOUNT<>0
			ELSE
				SELECT TOP 1 @NGVSCHEMEAMOUNT=GV_AMOUNT FROM SLS_GV_MST_REDEMPTION_UPLOAD (NOLOCK) 
				WHERE SP_ID=@NSPID AND GV_AMOUNT<>0
								
			IF ISNULL(@NGVSCHEMEAMOUNT,0)=0
			BEGIN
				SET @CERRORMSG='BILLS WITHOUT GIFT VOUCHERS NOT ALLOWED...CANNOT SAVE'
				GOTO END_PROC
			END
		END	
			
		SET @cStep = 250
			
		SELECT A.GV_SRNO,A.GV_SCRATCH_NO,0 AS DENOMINATION,CONVERT(BIT,0) AS GV_SOLD,CONVERT(VARCHAR(MAX),'') AS ERRMSG,
		GV_TYPE,CONVERT(BIT,0) AS VALIDATE_THRU_API	INTO #TMPGVREDEMPTION 
		FROM SLS_GV_MST_REDEMPTION_UPLOAD A (NOLOCK)
		JOIN SKU_GV_MST B (NOLOCK) ON A.GV_SRNO=B.GV_SRNO  WHERE SP_ID=@NSPID
		UNION ALL
		SELECT A.GV_SRNO,A.GV_SCRATCH_NO,0 AS DENOMINATION,CONVERT(BIT,0) AS GV_SOLD,CONVERT(VARCHAR(MAX),'') AS ERRMSG,
		GV_TYPE,CONVERT(BIT,0) AS VALIDATE_THRU_API
		FROM SLS_PAYMODE_XN_DET_UPLOAD A (NOLOCK)
		JOIN SKU_GV_MST B (NOLOCK) ON A.GV_SRNO=B.GV_SRNO  WHERE SP_ID=@NSPID AND PAYMODE_CODE='GVC0001'
			
		SET @cStep = 255
			
		EXEC SP3S_GETGVREDEMPTION_SCHEME_1 @cLocationId,@NCMMSUBTOTAL
			
		IF EXISTS (SELECT TOP 1 GV_SRNO FROM #TMPGVREDEMPTION WHERE ERRMSG<>'')
		BEGIN
			SELECT TOP 1 @CERRORMSG='BILL AMOUNT :'+LTRIM(RTRIM(STR(@NCMMSUBTOTAL,10,2)))+' GV NO.:'+GV_SRNO+' '+ERRMSG  FROM #TMPGVREDEMPTION WHERE ERRMSG<>''
			GOTO END_PROC
		END
	END	
END TRY

BEGIN CATCH
	SET @cErrormsg='Error in Procedure SP3S_VALIDATE_SCHEMERELATEDGV_REDEMPTION at Step#'+@cStep+' '+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:
END