CREATE PROCEDURE SP_MBQ_FORMAT1
( 
  @CDTFROM VARCHAR(15),
  @CDTTO VARCHAR(15),
  @CWHERE VARCHAR(50),
  @CDEPTID VARCHAR(10),
  @INTMONTH INT,
  @INTYEAR INT ,
  @CARTICLE VARCHAR(50),
  @CPRODUCT VARCHAR(50)
)
--WITH ENCRYPTION

AS
BEGIN


SELECT LO.DEPT_ID,LO.DEPT_NAME,D.ARTICLE_NO AS PRODUCT_CODE,B.PRODUCT_NAME , (B.MRP) AS MRP,
       ISNULL(MST.MBQ,0) AS MBQ_QTY, ISNULL(MST.MST,0) AS MST_QTY, 
      
        

      SUM( CASE WHEN A.XN_TYPE='SLS' AND XN_DT BETWEEN @CDTFROM AND @CDTTO 
                AND  LO.PUR_LOC=0   THEN XN_QTY  WHEN A.XN_TYPE='SLR' AND XN_DT BETWEEN @CDTFROM AND @CDTTO  
                AND  LO.PUR_LOC=0  THEN - (ABS(XN_QTY)) ELSE 0 END) AS SLS_QTY,  

      SUM( (CASE WHEN A.XN_TYPE='OPS' OR (A.XN_TYPE IN ('OPS', 'PUR', 'CHI', 'SLR','UNC','APR', 'WSR', 'PFI',   
                     'PFG', 'BCG','MRP','DCI','PSB','JWR') AND XN_DT <= @CDTTO AND LO.PUR_LOC=0 )   
                THEN 1 WHEN A.XN_TYPE IN ('PRT','CHO','SLS','CNC','APP','WSL','CIP', 'CRM', 'DCO','MIP','CSB',  
                       'JWI','DLM') AND XN_DT <= @CDTTO AND LO.PUR_LOC=0 THEN -1 ELSE 0 END) * (XN_QTY)) AS STOCK_QTY,  

      SUM( CASE WHEN A.XN_TYPE='SLS' AND XN_DT BETWEEN @CDTFROM AND @CDTTO AND LO.PUR_LOC=0     
                THEN (XN_QTY)  WHEN A.XN_TYPE='SLR' AND XN_DT BETWEEN @CDTFROM AND @CDTTO
                AND LO.PUR_LOC=0  THEN - (ABS(XN_QTY)) ELSE 0 END) * (B.MRP) AS SLS_VAL  

    
FROM VW_XNSREPS A 
JOIN LOCATION LO (NOLOCK) ON LO.DEPT_ID = A.DEPT_ID  
JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE = B.PRODUCT_CODE  
JOIN ARTICLE D (NOLOCK) ON D.ARTICLE_CODE=B.ARTICLE_CODE
JOIN SECTIOND E (NOLOCK) ON D.SUB_SECTION_CODE = E.SUB_SECTION_CODE  
JOIN SECTIONM F (NOLOCK) ON E.SECTION_CODE = F.SECTION_CODE   
LEFT OUTER JOIN PARA2 H (NOLOCK) ON B.PARA2_CODE = H.PARA2_CODE   
LEFT OUTER JOIN PARA1 J (NOLOCK) ON B.PARA1_CODE = J.PARA1_CODE 
LEFT OUTER  JOIN   
(  
	SELECT DEPT_ID,MST.ARTICLE_CODE,SUM(MBQ) AS MBQ,SUM(ISNULL(MST,0)) AS MST 
	FROM  MIN_SALE_TARGET MST  (NOLOCK) 
	--JOIN SKU S ON MST.ARTICLE_CODE = S.ARTICLE_CODE AND MST.PARA2_CODE = S.PARA2_CODE	
	JOIN SECTIOND E (NOLOCK) ON MST.SUB_SECTION_CODE = E.SUB_SECTION_CODE   
	WHERE MST.MONTH = @INTMONTH  AND MST.YEAR =@INTYEAR
	AND (@CWHERE='' OR E.SECTION_CODE = @CWHERE )  AND (@CDEPTID ='' OR MST.DEPT_ID =@CDEPTID ) 
	AND (@CARTICLE='' OR MST.ARTICLE_CODE = @CARTICLE ) 
	--AND (@CPRODUCT='' OR S.PRODUCT_CODE  = @CPRODUCT ) 
	--AND MST.DEPT_ID <> 'W1' 
    GROUP BY DEPT_ID,MST.ARTICLE_CODE 
) MST  ON  MST.ARTICLE_CODE= B.ARTICLE_CODE  AND MST.DEPT_ID= LO.DEPT_ID

WHERE (@CDEPTID ='' OR LO.DEPT_ID =@CDEPTID ) AND (@CWHERE='' OR E.SECTION_CODE = @CWHERE )  
AND (@CARTICLE='' OR D.ARTICLE_CODE = @CARTICLE ) AND (@CPRODUCT='' OR B.PRODUCT_CODE  = @CPRODUCT )
AND LO.INACTIVE = 0 
GROUP BY LO.DEPT_ID,LO.DEPT_NAME,D.ARTICLE_NO,B.PRODUCT_NAME ,B.MRP,
ISNULL(MST.MBQ,0),ISNULL(MST.MST,0)  
HAVING LO.DEPT_ID  IS NOT NULL  
AND (
			SUM( CASE WHEN A.XN_TYPE='SLS' AND XN_DT BETWEEN @CDTFROM AND @CDTTO 
                AND  LO.PUR_LOC=0   THEN XN_QTY  WHEN A.XN_TYPE='SLR' AND XN_DT BETWEEN @CDTFROM AND @CDTTO  
                AND  LO.PUR_LOC=0  THEN - (ABS(XN_QTY)) ELSE 0 END) > 0
		OR
			SUM( (CASE WHEN A.XN_TYPE='OPS' OR (A.XN_TYPE IN ('OPS', 'PUR', 'CHI', 'SLR','UNC','APR', 'WSR', 'PFI',   
                     'PFG', 'BCG','MRP','DCI','PSB','JWR') AND XN_DT <= @CDTTO AND LO.PUR_LOC=0 )   
                THEN 1 WHEN A.XN_TYPE IN ('PRT','CHO','SLS','CNC','APP','WSL','CIP', 'CRM', 'DCO','MIP','CSB',  
                       'JWI','DLM') AND XN_DT <= @CDTTO AND LO.PUR_LOC=0 THEN -1 ELSE 0 END) * (XN_QTY)) > 0
        OR ISNULL(MST.MBQ,0) > 0  OR ISNULL(MST.MST,0)  > 0
	)
  
ORDER BY LO.DEPT_ID,D.ARTICLE_NO


END
