CREATE PROC SPPC_PO           
@NMODE INT,          
@PONUMBER CHAR(50),          
@CANCELLED BIT,
@CBILL_NO VARCHAR(100)='' ,
@CFIN_YEAR VARCHAR(5)=''  ,
@PUR_STATUS INT=0,
@NAPPROVED INT=2   ,
@CAC_CODE VARCHAR(10)=''    
AS BEGIN           

IF(@NMODE=1)          
BEGIN       
	SELECT POD.BILL_NO,CASE WHEN CANCELLED=0 THEN 'NO' ELSE 'YES' END CANCELLED,
	PPC_POM01106.*,LM01106.AC_CODE,
	LM01106.AC_NAME ,POD.PUR_STATUS ,
	POD.PUR_STATUS_FILTER ,PO_QTY        
	FROM PPC_POM01106 
	JOIN LM01106 ON LM01106.AC_CODE=PPC_POM01106.AC_CODE  
    LEFT JOIN
    (
     SELECT A.BILL_NO,A.PO_ID ,A.PUR_STATUS,PUR_STATUS_FILTER,
     SUM(A.QUANTITY) AS PO_QTY
     FROM 
      (
     SELECT D.BILL_NO,A.PO_ID,A.ROW_ID,
     CAST(CASE WHEN A.QUANTITY >ISNULL(PID.PI_QTY,0) THEN 'PENDING' ELSE 'COMPLETED' END AS VARCHAR(10)) AS PUR_STATUS,
     CAST(CASE WHEN A.QUANTITY >ISNULL(PID.PI_QTY,0) THEN 1 ELSE 2 END AS VARCHAR(10)) AS PUR_STATUS_FILTER,
     A.QUANTITY
     FROM PPC_POD01106 A
	 JOIN PPC_POM01106 POM ON POM.PO_ID=A.PO_ID
	 LEFT JOIN PPC_BO_ART_BOM B ON BO_BOM_ROW_ID =B.ROW_ID 
	 LEFT JOIN PPC_BUYER_ORDER_DET  C ON C.ROW_ID  =B.REF_ROW_ID
	 LEFT JOIN PPC_BUYER_ORDER_MST D ON C.ORDER_ID =D.ORDER_ID
	 LEFT JOIN 
	 (
	  SELECT PO_ROW_ID ,SUM(A.QUANTITY) AS PI_QTY 
	  FROM PPC_PID01106 A
	  JOIN PPC_PIM01106 B ON A.MRR_ID =B.MRR_ID 
	  WHERE B.CANCELLED =0
	  GROUP BY PO_ROW_ID
	 ) PID ON A.ROW_ID =PID.PO_ROW_ID
	 ) A
	 GROUP BY A.BILL_NO,A.PO_ID,A.PUR_STATUS,PUR_STATUS_FILTER 
    ) POD ON PPC_POM01106.PO_ID=POD.PO_ID
  WHERE (@CBILL_NO='' OR POD.BILL_NO=@CBILL_NO)  
  AND (@PONUMBER='' OR PPC_POM01106.PO_ID=@PONUMBER)
  AND (@CANCELLED='' OR PPC_POM01106.CANCELLED=@CANCELLED)
  AND PPC_POM01106.FIN_YEAR=@CFIN_YEAR  
  AND(@PUR_STATUS=0 OR PUR_STATUS_FILTER=@PUR_STATUS)
  AND (@NAPPROVED=2 OR PPC_POM01106.APPROVED=@NAPPROVED)
  AND (@CAC_CODE='' OR PPC_POM01106.AC_CODE=@CAC_CODE)
  ORDER BY  PPC_POM01106.PO_NO DESC 
END  
ELSE IF(@NMODE=5)          
BEGIN       
	 SELECT D.BILL_NO    FROM PPC_POD01106 A
    JOIN PPC_BO_ART_BOM B ON BO_BOM_ROW_ID =B.ROW_ID 
    JOIN PPC_BUYER_ORDER_DET  C ON C.ROW_ID  =B.REF_ROW_ID
    JOIN PPC_BUYER_ORDER_MST D ON C.ORDER_ID =D.ORDER_ID 
    WHERE (@CBILL_NO='' OR D.BILL_NO=@CBILL_NO)  
    AND (@PONUMBER='' OR A.PO_ID=@PONUMBER)
    GROUP BY D.BILL_NO 
     
END  

        
          
END
