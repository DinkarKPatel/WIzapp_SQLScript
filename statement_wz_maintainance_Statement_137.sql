IF EXISTS (SELECT NAME FROM SYS.INDEXES WHERE NAME='IX_JOBWORK_ISSUE_DET_ISSUE_ID')
	DROP INDEX JOBWORK_ISSUE_DET.IX_JOBWORK_ISSUE_DET_ISSUE_ID

IF NOT EXISTS (SELECT TOP 1 'U'  FROM INFORMATION_SCHEMA .COLUMNS 
WHERE TABLE_NAME ='JOBWORK_ISSUE_MST' AND COLUMN_NAME ='ISSUE_NO' AND DATA_TYPE ='varchar' AND CHARACTER_MAXIMUM_LENGTH =25)
BEGIN
   
   
   DECLARE @CCMD NVARCHAR(MAX)
   
   
   IF OBJECT_ID ('TEMPDB..#TMPCONS','U') IS NOT NULL
      DROP TABLE #TMPCONS
   
   SELECT SR=1, TABLE_NAME ,CONSTRAINT_NAME  INTO #TMPCONS FROM INFORMATION_SCHEMA .CONSTRAINT_COLUMN_USAGE
   WHERE TABLE_NAME ='JOBWORK_ISSUE_DET'
   AND COLUMN_NAME IN('ISSUE_ID')
   UNION ALL
   SELECT SR=2, TABLE_NAME ,CONSTRAINT_NAME  FROM INFORMATION_SCHEMA .CONSTRAINT_COLUMN_USAGE
   WHERE TABLE_NAME ='JOBWORK_ISSUE_MST'
   AND COLUMN_NAME IN('ISSUE_NO','ISSUE_ID')
   
   
   
   
   DECLARE @CTABLE_NAME VARCHAR(100),@CCONSNAME VARCHAR(1000)
   
   WHILE EXISTS (SELECT TOP 1 'U' FROM #TMPCONS)
   BEGIN
       
       
       SELECT TOP 1 @CTABLE_NAME=TABLE_NAME ,@CCONSNAME=CONSTRAINT_NAME FROM #TMPCONS
       ORDER BY SR
       
       SET @CCMD=N' ALTER TABLE '+@CTABLE_NAME+' DROP CONSTRAINT ' +@CCONSNAME
       EXEC SP_EXECUTESQL @CCMD
       
       DELETE FROM #TMPCONS WHERE TABLE_NAME=@CTABLE_NAME AND CONSTRAINT_NAME=@CCONSNAME
       
   
   END
   

   --PK_jobwork_issue_mst_issue_id
   ALTER TABLE JOBWORK_ISSUE_MST ALTER COLUMN ISSUE_NO VARCHAR(10) NOT NULL
   ALTER TABLE JOBWORK_ISSUE_MST ALTER COLUMN ISSUE_NO VARCHAR(25) NOT NULL
   ALTER TABLE JOBWORK_ISSUE_MST ALTER COLUMN ISSUE_ID VARCHAR(50) NOT NULL   
   ALTER TABLE JOBWORK_ISSUE_DET ALTER COLUMN ISSUE_ID VARCHAR(50) NOT NULL
   
   
   ALTER TABLE JOBWORK_ISSUE_MST ADD CONSTRAINT PK_jobwork_issue_mst_issue_id PRIMARY KEY (ISSUE_ID )
   
   ALTER TABLE JOBWORK_ISSUE_DET ADD CONSTRAINT FK_JOBWORK_ISSUE_DET_JOBWORK_ISSUE_MST FOREIGN KEY (ISSUE_ID)
   REFERENCES JOBWORK_ISSUE_MST (ISSUE_ID)
    
   ALTER TABLE JOBWORK_ISSUE_MST ADD CONSTRAINT UNQ_JOBWORK_ISSUE_MST_ISSUE_NO UNIQUE (FIN_YEAR, ISSUE_NO)
   
END