CREATE  PROCEDURE SP_PRD_SHORT_RAW_MATERIAL_ISSUE    
(    
 @CAGENCY_CODE VARCHAR(100)='',    
 @CORDER_ID VARCHAR(100)=''    
)    
AS    
BEGIN           
IF OBJECT_ID('TEMPDB..#TMPISSUE_RM_REQ','U') IS NOT NULL    
   DROP TABLE #TMPISSUE_RM_REQ    
    
 SELECT   MST.MEMO_ID AS ORDER_ID    
   ,MST.MEMO_NO AS ORDER_NO    
   ,MST.MEMO_DT  AS ORDER_DT    
   ,MST.ARTICLE_SET_CODE    
   ,C.ARTICLE_NO AS BM_ARTICLE_NO    
   ,C.ARTICLE_NAME AS BM_ARTICLE_NAME    
   ,C.ARTICLE_CODE  AS BM_ARTICLE_CODE    
   ,AR.ARTICLE_CODE AS COMP_CODE    
   ,AR.ARTICLE_NO AS ARTICLE_NO    
   ,AR1.ARTICLE_NAME AS FG_ARTICLE_NAME    
   ,AR1.ARTICLE_NO AS FG_ARTICLE_NO    
   ,AR1.ARTICLE_CODE AS FG_ARTICLE_CODE    
   ,DET1.QUANTITY AS WO_QTY    
   ,DET.QUANTITY AS WO_PARA_QTY    
   ,PARA1.PARA1_CODE    
   ,PARA1.PARA1_NAME    
   ,PARA2.PARA2_CODE    
   ,PARA2.PARA2_NAME    
   ,UOM.UOM_CODE    
   ,UOM.UOM_NAME    
   ,A.AVG_QTY AS AVG_QTY 
   ,A.ADD_AVG_QTY   
   ,AGENCY_CODE    
   ,CT.MEMO_ID AS MEMO_ID    
    ,ISNULL(CT.ISSUE_QTY,0) AS ISSUE_PCS    
   ,ISNULL(CONVERT(NUMERIC(12,2),(A.AVG_QTY+ISNULL(A.ADD_AVG_QTY,0)) * ISNULL(CT.ISSUE_QTY,0)),0) AS REQUIRED_QTY     
       
 INTO #TMPISSUE_RM_REQ      
 FROM PRD_WO_ART_BOM A (NOLOCK)          
 JOIN PRD_WO_DET B (NOLOCK) ON A.REF_ROW_ID = B.ROW_ID    
 JOIN PRD_WO_MST MST (NOLOCK) ON B.MEMO_ID=MST.MEMO_ID    
 JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE =B.ARTICLE_CODE    
 JOIN ARTICLE AR1 (NOLOCK) ON AR1.ARTICLE_CODE =MST.ARTICLE_SET_CODE         
 JOIN PARA1 P1 (NOLOCK) ON A.PARA1_CODE=P1.PARA1_CODE    
 JOIN PARA2 P2 (NOLOCK) ON A.PARA2_CODE=P2.PARA2_CODE    
 JOIN    
 (    
  SELECT PARA1_CODE,PARA2_CODE,REF_ROW_ID,SUM(QUANTITY) AS QUANTITY     
  FROM PRD_WO_SUB_DET C    
  GROUP BY REF_ROW_ID,PARA1_CODE,PARA2_CODE    
 ) DET ON B.ROW_ID=DET.REF_ROW_ID    
 JOIN ARTICLE C (NOLOCK) ON A.BOM_ARTICLE_CODE = C.ARTICLE_CODE     
 JOIN UOM ON UOM.UOM_CODE=C.UOM_CODE    
 JOIN    
 (    
  SELECT  REF_ROW_ID,SUM(QUANTITY) AS QUANTITY     
  FROM PRD_WO_SUB_DET C    
  GROUP BY REF_ROW_ID    
 ) DET1 ON B.ROW_ID=DET1.REF_ROW_ID    
 JOIN PARA1  (NOLOCK) ON DET.PARA1_CODE=PARA1.PARA1_CODE    
 JOIN PARA2  (NOLOCK) ON DET.PARA2_CODE=PARA2.PARA2_CODE    
 JOIN    
 (    
  SELECT C.REF_AGENCY_CODE AS AGENCY_CODE,A.MEMO_ID, A.ARTICLE_CODE ,A.PARA1_CODE AS PARA1_CODE,A.PARA2_CODE AS PARA2_CODE,C.REF_WO_ID,    
   SUM(A.ISSUE_QTY) AS ISSUE_QTY    
  FROM PRD_AGENCY_ISSUE_ROW_MATERIAL_DET A    
  JOIN    
  (    
    SELECT B.REF_AGENCY_CODE, A.REF_PRD_WORKORDER_MEMOID AS REF_WO_ID ,A.MEMO_ID    
    FROM PRD_AGENCY_ISSUE_MATERIAL_DET A    
    JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID=B.MEMO_ID    
    WHERE B.CANCELLED =0    
    GROUP BY B.REF_AGENCY_CODE,A.REF_PRD_WORKORDER_MEMOID ,A.MEMO_ID    
  ) C ON A.MEMO_ID=C.MEMO_ID  
  JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE =C.REF_AGENCY_CODE      
  WHERE (@CAGENCY_CODE='' OR  AG.AC_CODE =@CAGENCY_CODE)    
  GROUP BY C.REF_AGENCY_CODE,A.MEMO_ID, A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE ,C.REF_WO_ID    
 ) CT ON CT.REF_WO_ID =B.MEMO_ID    
 AND CT.ARTICLE_CODE=MST.ARTICLE_SET_CODE    
 AND PARA1.PARA1_CODE=CT.PARA1_CODE    
 AND PARA2.PARA2_CODE=CT.PARA2_CODE    
 JOIN PRD_AGENCY_ISSUE_MATERIAL_REQ_DET REQ ON REQ.MEMO_ID=CT.MEMO_ID    
 AND REQ.ARTICLE_CODE=A.BOM_ARTICLE_CODE    
 AND REQ.COMPONENT_CODE=AR.ARTICLE_CODE    
 AND PARA1.PARA1_CODE=REQ.COM_PARA1_CODE    
 AND PARA2.PARA2_CODE=REQ.COM_PARA1_CODE    
 WHERE (@CORDER_ID='' OR  B.MEMO_ID=@CORDER_ID) AND    
  MST.CANCELLED=0    
 AND MARK_AS_COMPLETED=1    
     
     
    
 --SELECT * FROM #TMPISSUE_RM_REQ    
     
            
IF OBJECT_ID('TEMPDB..#TMPISSUE_RM_REQ_DETAILS','U') IS NOT NULL    
   DROP TABLE #TMPISSUE_RM_REQ_DETAILS    
       
 SELECT 'PENDING FOR ISSUE' AS TRAN_TYPE,  A.*,    
        ISNULL(T.QUANTITY,0) AS ISSUE_QTY,    
        A.REQUIRED_QTY-ISNULL(T.QUANTITY,0) AS PENDING_QTY    
 INTO #TMPISSUE_RM_REQ_DETAILS    
 FROM #TMPISSUE_RM_REQ A    
 LEFT JOIN    
 (    
      
  SELECT A.REF_WO_ID,A.MEMO_ID,A.COMPONENT_CODE,A.ARTICLE_CODE,A.COM_PARA1_CODE,A.COM_PARA2_CODE,A.UOM_CODE,    
  SUM(QUANTITY) AS  QUANTITY    
  FROM    
  (    
  SELECT A.REF_PRD_WORKORDER_MEMOID AS REF_WO_ID,A.MEMO_ID, C.COMPONENT_CODE,C.ARTICLE_CODE,C.COM_PARA1_CODE,C.COM_PARA2_CODE,AR.UOM_CODE,    
  SUM(QUANTITY) AS  QUANTITY    
  FROM PRD_AGENCY_ISSUE_MATERIAL_DET A    
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID=B.MEMO_ID    
  JOIN PRD_SKU C ON A.PRODUCT_UID=C.PRODUCT_UID    
  JOIN ARTICLE AR ON AR.ARTICLE_CODE=C.ARTICLE_CODE    
  WHERE B.CANCELLED=0    
  GROUP BY A.REF_PRD_WORKORDER_MEMOID,A.MEMO_ID,C.COMPONENT_CODE,C.ARTICLE_CODE,C.COM_PARA1_CODE,C.COM_PARA2_CODE,AR.UOM_CODE    
  UNION ALL    
  SELECT A.REF_PRD_WORKORDER_MEMOID AS REF_WO_ID,A.REF_ISSUE_ID, C.COMPONENT_CODE,C.ARTICLE_CODE,C.COM_PARA1_CODE,C.COM_PARA2_CODE,AR.UOM_CODE,    
  SUM(QUANTITY) AS  QUANTITY    
  FROM PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING A    
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST_PENDING B ON A.MEMO_ID=B.MEMO_ID    
  JOIN PRD_SKU C ON A.PRODUCT_UID=C.PRODUCT_UID    
  JOIN ARTICLE AR ON AR.ARTICLE_CODE=C.ARTICLE_CODE    
  WHERE B.CANCELLED=0    
  GROUP BY A.REF_PRD_WORKORDER_MEMOID,A.REF_ISSUE_ID,C.COMPONENT_CODE,C.ARTICLE_CODE,C.COM_PARA1_CODE,C.COM_PARA2_CODE,AR.UOM_CODE    
  ) A    
  GROUP BY A.REF_WO_ID,A.MEMO_ID,A.COMPONENT_CODE,A.ARTICLE_CODE,A.COM_PARA1_CODE,A.COM_PARA2_CODE,A.UOM_CODE    
 ) T ON T.REF_WO_ID=A.ORDER_ID    
 AND T.MEMO_ID=A.MEMO_ID    
 AND T.ARTICLE_CODE=A.BM_ARTICLE_CODE    
 AND T.UOM_CODE=A.UOM_CODE    
 AND T.COMPONENT_CODE=A.COMP_CODE    
 AND T.COM_PARA1_CODE =A.PARA1_CODE     
 AND T.COM_PARA2_CODE=A.PARA2_CODE    
 WHERE A.REQUIRED_QTY-ISNULL(T.QUANTITY,0)>0    
     
     
     
 SELECT A.*,B.AGENCY_NAME  FROM #TMPISSUE_RM_REQ_DETAILS A    
 JOIN PRD_AGENCY_MST B ON A.AGENCY_CODE =B.AGENCY_CODE     
     
    
END
