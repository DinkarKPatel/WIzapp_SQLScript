CREATE PROCEDURE SP_SEND_MIRROR_JWI_DATA_NEW  
(   
  @CUPLOADEDXNID VARCHAR(50)  
 ,@CCURLOCID VARCHAR(5)  
 ,@BACKNOWLEDGE BIT=0    
 ,@CERRMSG VARCHAR(1000) OUTPUT  
)  
--WITH ENCRYPTION  
AS  
BEGIN  
     DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION VARCHAR(MAX),  
             @CMEMOID VARCHAR(50),@DMEMOLASTUPDATE DATETIME,  
             @CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPMASTERTABLE VARCHAR(100),  
             @CTEMPDETAILTABLE VARCHAR(100),@BRECFOUND BIT  
       
        
BEGIN TRY  
     DECLARE @CTEMPDBNAME VARCHAR(100)  
   
   SET @CTEMPDBNAME=''

   SET @CMEMOID=@CUPLOADEDXNID  
  SET @CSTEP=20  
  
 IF ISNULL(@CMEMOID,'')=''  
  GOTO END_PROC  
   
 LBLTABLEINFO:  
   
 ---- SEND THE JWI MEMO MASTER TABLE  
  
  SELECT DISTINCT  A.*,'JWI_JOBWORK_ISSUE_MST_UPLOAD' AS TARGET_TABLENAME FROM JOBWORK_ISSUE_MST A (NOLOCK)
  WHERE A.ISSUE_ID =@CMEMOID
   
 SET @CSTEP=250  
 ---- SEND THE JWI MEMO DETAIL TABLE  
  SELECT DISTINCT  A.*,'JWI_JOBWORK_ISSUE_DET_UPLOAD' AS TARGET_TABLENAME FROM JOBWORK_ISSUE_det A (NOLOCK)
  WHERE A.ISSUE_ID =@CMEMOID
 
  SET @CSTEP=251 
 ---- SEND THE PMT01106 TABLE  
   SELECT DISTINCT 'JWI_PMT01106_UPLOAD' AS TARGET_TABLENAME, @CMEMOID AS JWI_MEMO_ID ,A.DEPT_ID,A.product_code,A.BIN_ID,A.quantity_in_stock  
	  FROM PMT01106 A (NOLOCK)  
	  JOIN JOBWORK_ISSUE_DET B (NOLOCK) ON B.product_code=A.product_code
	  WHERE B.issue_id=@CMEMOID 


 GOTO END_PROC  
   
 END TRY  
BEGIN CATCH  
 SET @CERRMSG='P: SP_SEND_MIRROR_JWI_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
 GOTO END_PROC  
END CATCH    
   
END_PROC:  
     
END  