CREATE PROCEDURE SPDB_SALE_CONTRIBUTION_DATA
@DTODATE DATETIME
AS
BEGIN
	IF OBJECT_ID('TEMPDB..#TMPSETUP','U') IS NOT NULL
		DROP TABLE #TMPSETUP
	
	SELECT * INTO #TMPSETUP	FROM DB_SALE_CONTR_SETUP WHERE MODE=1
	
	DECLARE @CSETUPCODE CHAR(5),@CPARANAME VARCHAR(200),@CFILTERCRITERIA VARCHAR(MAX),@BFLAG BIT,
			@CCMD NVARCHAR(MAX),@CFINYEAR VARCHAR(10)

	SELECT @CFINYEAR='01'+DBO.FN_GETFINYEAR(@DTODATE)
	
	SET @BFLAG=0
	
	WHILE @BFLAG=0
	BEGIN
		SET @CSETUPCODE=''
		SELECT TOP 1 @CSETUPCODE=SETUP_CODE,@CPARANAME=PARA_NAME,@CFILTERCRITERIA=FILTER_CRITERIA FROM #TMPSETUP
		
		IF ISNULL(@CSETUPCODE,'')=''
			BREAK
		
		SET @CCMD=N'SELECT LEFT(A.CM_ID,2) AS DEPT_ID,'''+@CSETUPCODE+''' AS SETUP_CODE,'+@CPARANAME+' AS PARA_VAL,
					SUM(QUANTITY) AS SOLD_QTY,SUM(NET-CMM_DISCOUNT_AMOUNT) AS SOLD_AMOUNT,
					0 AS QTY_CONTR_PCT,0 AS AMOUNT_CONTR_PCT
					FROM CMD01106 A (NOLOCK) JOIN CMM01106 B  (NOLOCK) ON A.CM_ID=B.CM_ID
					JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
					JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE 
					JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
					JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
					JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
					JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
					JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
					JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
					JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
					JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
					JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=SKU.AC_CODE
					WHERE FIN_YEAR='''+@CFINYEAR+''' AND CM_DT<='''+CONVERT(VARCHAR,@DTODATE,112)+''' AND CANCELLED=0 AND '+
					@CFILTERCRITERIA+' GROUP BY LEFT(A.CM_ID,2),'+@CPARANAME+'
					UNION
					SELECT '''' AS DEPT_ID,'''+@CSETUPCODE+''' AS SETUP_CODE,'+@CPARANAME+' AS PARA_VAL,
					SUM(QUANTITY) AS SOLD_QTY,SUM(NET-CMM_DISCOUNT_AMOUNT) AS SOLD_AMOUNT,
					0 AS QTY_CONTR_PCT,0 AS AMOUNT_CONTR_PCT
					FROM CMD01106 A (NOLOCK) JOIN CMM01106 B  (NOLOCK) ON A.CM_ID=B.CM_ID
					JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
					JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE 
					JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
					JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
					JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
					JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
					JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
					JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
					JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
					JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
					JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=SKU.AC_CODE
					WHERE FIN_YEAR='''+@CFINYEAR+''' AND CM_DT<='''+CONVERT(VARCHAR,@DTODATE,112)+'''
					AND CANCELLED=0 AND '+@CFILTERCRITERIA+'
					GROUP BY '+@CPARANAME					
		INSERT DB_SALE_CONTR_SUMMARY	( DEPT_ID,SETUP_CODE, PARA_VAL, SOLD_QTY, SOLD_AMOUNT, QTY_CONTR_PCT,AMOUNT_CONTR_PCT )
		EXEC SP_EXECUTESQL @CCMD							

		DELETE FROM #TMPSETUP WHERE SETUP_CODE=@CSETUPCODE	
	END
	
	UPDATE A SET QTY_CONTR_PCT=(SOLD_QTY/B.TOTAL_SOLD_QTY)*100,AMOUNT_CONTR_PCT=(SOLD_AMOUNT/B.TOTAL_SOLD_AMOUNT)*100 
	FROM DB_SALE_CONTR_SUMMARY A
	JOIN (SELECT DEPT_ID,SETUP_CODE,SUM(SOLD_QTY) AS TOTAL_SOLD_QTY,SUM(SOLD_AMOUNT) AS TOTAL_SOLD_AMOUNT FROM DB_SALE_CONTR_SUMMARY
		  GROUP BY DEPT_ID,SETUP_CODE) B ON A.DEPT_ID=B.DEPT_ID AND A.SETUP_CODE=B.SETUP_CODE	
END
----------- END OF SPDB_SALE_CONTRIBUTION_DATA
