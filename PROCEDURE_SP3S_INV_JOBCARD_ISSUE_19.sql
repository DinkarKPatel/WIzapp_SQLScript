CREATE PROCEDURE [DBO].[SP3S_INV_JOBCARD_ISSUE_19]          
(          
  @IMODE INT ,          
  @CWHERE VARCHAR(MAX)='',      
  @CAGENCYCODE VARCHAR(20)='',      
  @FINYEAR VARCHAR(10)=''  ,    
  @DEPTID VARCHAR(10)='' ,
  @NRETURNMODE INT=0
          
)      
----WITH ENCRYPTION
AS          
          
BEGIN        
 DECLARE @CCMD NVARCHAR(MAX)  
 -- RETURN_BARCODE: 19
 
  ;WITH ISSUE_RETURN AS
	(
	SELECT 	G.PRODUCT_CODE,
	CAST(SUM(CASE WHEN ISNULL(A.ISSUE_TYPE,0)=0 THEN 1 ELSE -1 END *QUANTITY) AS NUMERIC(14,2)) AS ISSUED_QTY,
	CAST(0 AS NUMERIC(14,2)) AS QUANTITY,
	ORD_PLAN_BOM_DET_ROW_ID,G.DEPT_ID,G.COMPANY_CODE,G.PURCHASE_PRICE,G.REF_NO,JOB_CODE,G.BIN_ID,MANUAL_GST_CALCULATE
	FROM BOM_ISSUE_MST A (NOLOCK)             
	JOIN BOM_ISSUE_DET G (NOLOCK)  ON A.ISSUE_ID = G.ISSUE_ID  
	WHERE A.JOBWORK_ISSUE_ID=@CWHERE
	AND @CWHERE<>''and a.cancelled =0
	GROUP BY G.PRODUCT_CODE,ORD_PLAN_BOM_DET_ROW_ID	,G.DEPT_ID,G.COMPANY_CODE,G.PURCHASE_PRICE,G.REF_NO,
	JOB_CODE,G.BIN_ID,MANUAL_GST_CALCULATE
	)


	SELECT cast(0 as bit) as chk, A.* ,
		CAST('' AS VARCHAR(100)) AS REMARKS,
		CAST('LATER' AS VARCHAR(100)) AS ROW_ID,
		GETDATE() AS LAST_UPDATE,
		CAST('LATER' AS VARCHAR(100)) AS ISSUE_ID,
		CAST(0 AS NUMERIC(10,2)) AS XN_VALUE_WITHOUT_GST,
        sku.hsn_code ,
		CAST(0 AS NUMERIC(10,2)) AS GST_PERCENTAGE,
		CAST(0 AS NUMERIC(10,2)) AS IGST_AMOUNT,
		CAST(0 AS NUMERIC(10,2)) AS CGST_AMOUNT,
		CAST(0 AS NUMERIC(10,2)) AS SGST_AMOUNT,
		CAST(0 AS NUMERIC(10,2)) AS XN_VALUE_WITH_GST,
		ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
		PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
		CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,      
		SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
		P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
		PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
		ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
		ART.STOCK_NA,JOBS.JOB_CODE,JOBS.JOB_NAME,(0*A.QUANTITY) AS AMOUNT,ART.ALIAS AS ARTICLE_ALIAS,B.BIN_NAME 
	FROM ISSUE_RETURN A
	JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
	JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE          
	JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
	JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE        
	JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE          
	JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE          
	JOIN PARA3 P3 (NOLOCK) ON SKU.PARA3_CODE = P3.PARA3_CODE          
	JOIN PARA4 P4 (NOLOCK) ON SKU.PARA4_CODE = P4.PARA4_CODE          
	JOIN PARA5 P5 (NOLOCK) ON SKU.PARA5_CODE = P5.PARA5_CODE          
	JOIN PARA6 P6 (NOLOCK) ON SKU.PARA6_CODE = P6.PARA6_CODE          
	JOIN UOM E (NOLOCK) ON ART.UOM_CODE = E.UOM_CODE       
	JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE=A.JOB_CODE   
	JOIN BIN B (NOLOCK) ON B.BIN_ID =A.BIN_ID  
	where ISSUED_QTY>0	
		

 
 
END
