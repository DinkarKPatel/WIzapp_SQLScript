
create TRIGGER [DBO].[TRG_INSERT_SKU_NAMES] ON [DBO].[SKU]  
FOR INSERT
AS
begin
	  --duplicat Record in art det boxweight stored in sku_names as discuss with sanjiv sir first duplicate remove and weight column insert in sku_names 
  
	  SELECT A.ARTICLE_CODE ,A.PARA2_CODE , MAX(ISNULL(C.BOXWEIGHT,0)) AS BOXWEIGHT
			 into #tmpBOXWEIGHT
	  FROM INSERTED A
	  JOIN ART_DET C ON C.ARTICLE_CODE =A.ARTICLE_CODE AND C.PARA2_CODE =A.PARA2_CODE 
	  WHERE ISNULL(C.BOXWEIGHT,0)<>0
	  group by A.ARTICLE_CODE ,A.PARA2_CODE

	 CREATE TABLE #tmpNewSkuImg (product_code VARCHAR(50),img_id VARCHAR(200),article_code varchar(10),para1_code varchar(10),
	 para2_code varchar(10),para3_code varchar(10),para4_code varchar(10),para5_code varchar(10),para6_code varchar(10))

	 IF EXISTS (SELECT TOP 1 'U'  FROM IMAGE_INFO_CONFIG A (NOLOCK)
			   WHERE (A.SECTION=1 OR A.SUB_SECTION=1 OR A.ARTICLE=1
					  OR A.PARA1=1 OR A.PARA2=1 OR A.PARA3=1 
					  OR A.PARA4=1 OR A.PARA5=1 OR A.PARA6=1
					  OR A.PRODUCT=1 ))
	 BEGIN
		INSERT INTO #tmpNewSkuImg (product_code,article_code,para1_code,para2_code,para3_code,para4_code,para5_code,para6_code)
		SELECT product_code,article_code,para1_code,para2_code,para3_code,para4_code,para5_code,para6_code
		FROM INSERTED

		EXEC SP3S_UPDATE_IMGINFO_BARCODES
	 END

	  --- Did this change as per requirement of a client agst Ticket#0223-00146
	  --- Previously we had removed this in caluclation of LC as per confirmation by all Support Seniors (Date:20-02-2023)
	  DECLARE @cConsiderTaxAsPartofLc VARCHAR(2)
	  
	  SELECT TOP 1 @cConsiderTaxAsPartofLc=value from config (NOLOCK) where config_option='considerTaxAsPartofLc' 

	  SET @cConsiderTaxAsPartofLc=ISNULL(@cConsiderTaxAsPartofLc,'')

  
	INSERT SKU_NAMES (PRODUCT_CODE, LC, PP,PP_WO_DP, MRP, WS_PRICE,AC_NAME,oem_ac_name
					, ARTICLE_NO, ARTICLE_NAME, STOCK_NA, SECTION_NAME, SUB_SECTION_NAME
					, PARA1_NAME, PARA2_NAME, PARA3_NAME, PARA4_NAME, PARA5_NAME, PARA6_NAME
					, ATTR1_KEY_NAME, ATTR2_KEY_NAME, ATTR3_KEY_NAME, ATTR4_KEY_NAME, ATTR5_KEY_NAME
					, ATTR6_KEY_NAME, ATTR7_KEY_NAME, ATTR8_KEY_NAME, ATTR9_KEY_NAME, ATTR10_KEY_NAME
					, ATTR11_KEY_NAME, ATTR12_KEY_NAME, ATTR13_KEY_NAME, ATTR14_KEY_NAME, ATTR15_KEY_NAME
					, ATTR16_KEY_NAME, ATTR17_KEY_NAME, ATTR18_KEY_NAME, ATTR19_KEY_NAME, ATTR20_KEY_NAME
					, ATTR21_KEY_NAME, ATTR22_KEY_NAME, ATTR23_KEY_NAME, ATTR24_KEY_NAME, ATTR25_KEY_NAME
					, sku_item_type,section_alias,sub_section_alias,para1_alias,para2_alias,para3_alias,para4_alias
					, para5_alias,para6_alias,PURCHASE_BILL_DT,PURCHASE_BILL_NO ,purchase_receipt_Dt, AC_CODE ,para2_order,article_alias,CHALLAN_RECEIPT_DT,XFER_PRICE
					, uom,batch_no,expiry_dt,purchase_challan_no,purchase_gst_percentage,purchase_gst_amount,sn_hsn_code,sn_barcode_coding_scheme,sn_article_desc,sku_er_flag
					,fix_mrp,basic_purchase_price,para7_name,alternate_uom_name,alt_uom_conversion_factor,vendor_ean_no,SN_Uom_type
					,boxWeight,barcode_img_id,para1_set,para2_set,purloc_pan_no,pur_mrr_no,SN_ARTICLE_PACK_SIZE,supplier_alias,Pur_Broker_Ac_code,Pur_Broker_Ac_Name
					,SKU_ITEM_TYPE_DESC )
	SELECT A.PRODUCT_CODE
	,(a.PURCHASE_PRICE+ ISNULL(SKU_OH.OTHER_CHARGES,0) +  --+ISNULL(SKU_OH.TAX_AMOUNT,0) (Tax is not part of LC as per confirmation by All Senior Support ( Sanjay : 01-11-2022))
	(CASE WHEN @cConsiderTaxAsPartofLc='1' then ISNULL(sku_oh.tax_amount,0) ELSE 0 END)+
		  ISNULL(SKU_OH.ROUND_OFF,0) + ISNULL(SKU_OH.FREIGHT,0)+ 
		  ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0)+ISNULL(SKU_OH.VALUE_ADD,0)+ISNULL(SKU_OH.CustomdutyAmt,0)  ) as lc

	,(a.PURCHASE_PRICE + (CASE WHEN  ISNULL(FF.POST_TAX_SEPARATELY,0) =0 AND  ISNULL(FF.FORM_ID,'') <> '0000000' 
					   THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END)  +
					   ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) +ISNULL(SKU_OH.VALUE_ADD,0)+ISNULL(sku_oh.depreciation,0)) AS pp

	 ,(a.PURCHASE_PRICE + (CASE WHEN  ISNULL(FF.POST_TAX_SEPARATELY,0) =0 AND  ISNULL(FF.FORM_ID,'') <> '0000000' 
					   THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END)  +
					   ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) +ISNULL(SKU_OH.VALUE_ADD,0))
					   AS PP_WO_DP

	,A.MRP,A.WS_PRICE,LM01106.AC_NAME,isnull(oem_lm.ac_name,'') oem_ac_name
	,ISNULL(ARTICLE_NO,'') ,ISNULL(ARTICLE_NAME,'') ,ISNULL(ARTICLE.STOCK_NA,0)STOCK_NA, ISNULL(SECTION_NAME,'') ,ISNULL(SUB_SECTION_NAME,'')
	,ISNULL(PARA1_NAME,''),ISNULL(PARA2_NAME,''),ISNULL(PARA3_NAME,''),ISNULL(PARA4_NAME,''),ISNULL(PARA5_NAME,''),ISNULL(PARA6_NAME,'')
	,ISNULL(A1.ATTR1_KEY_NAME,'')   ,ISNULL(A2.ATTR2_KEY_NAME,'')   ,ISNULL(A3.ATTR3_KEY_NAME,'')   ,ISNULL(A4.ATTR4_KEY_NAME,'')   ,ISNULL(A5.ATTR5_KEY_NAME,'') 
	,ISNULL(A6.ATTR6_KEY_NAME,'')   ,ISNULL(A7.ATTR7_KEY_NAME,'')   ,ISNULL(A8.ATTR8_KEY_NAME,'')   ,ISNULL(A9.ATTR9_KEY_NAME,'')   ,ISNULL(A10.ATTR10_KEY_NAME,'') 
	,ISNULL(A11.ATTR11_KEY_NAME,'') ,ISNULL(A12.ATTR12_KEY_NAME,'') ,ISNULL(A13.ATTR13_KEY_NAME,'') ,ISNULL(A14.ATTR14_KEY_NAME,'') ,ISNULL(A15.ATTR15_KEY_NAME,'')      
	,ISNULL(A16.ATTR16_KEY_NAME,'') ,ISNULL(A17.ATTR17_KEY_NAME,'') ,ISNULL(A18.ATTR18_KEY_NAME,'') ,ISNULL(A19.ATTR19_KEY_NAME,'') ,ISNULL(A20.ATTR20_KEY_NAME,'')      
	,ISNULL(A21.ATTR21_KEY_NAME,'') ,ISNULL(A22.ATTR22_KEY_NAME,'') ,ISNULL(A23.ATTR23_KEY_NAME,'') ,ISNULL(A24.ATTR24_KEY_NAME,'') ,ISNULL(A25.ATTR25_KEY_NAME,'')      	  
	,SECTIONM.ITEM_TYPE,SECTIONM.ALIAS AS section_alias,SECTIOND.ALIAS AS sub_section_alias,p1.ALIAS AS para1_alias,p2.ALIAS AS para2_alias
	,p3.ALIAS AS para3_alias,p4.ALIAS AS para4_alias,p5.ALIAS AS para5_alias,p6.ALIAS AS para6_alias,A.inv_dt ,
	A.inv_no ,a.receipt_Dt, A.ac_code
	,isnull(p2.para2_order,0) as para2_order,article.alias as article_alias,a.CHALLAN_RECEIPT_DT,a.XFER_PRICE
	,uom.uom_NAME ,batch_no,expiry_dt,a.challan_no purchase_challan_no,a.gst_percentage purchase_gst_percentage
	,sku_oh.tax_amount purchase_gst_amount,
	a.hsn_code,a.barcode_coding_scheme,ARTICLE.article_desc,isnull(a.er_flag,0) as er_flag,a.fix_mrp,a.basic_purchase_price,
	ISNULL(P7.para7_name,'') AS para7_name,ISNULL(alt_uom.uom_name,'') alternate_uom_name,a.alt_uom_conversion_factor,
	a.VENDOR_EAN_NO,uom.uom_type,ISNULL(BOX.boxWeight,ARTICLE.boxWeight ) AS boxWeight,img.img_id,
	p1.para1_set,p2.para2_set,loc.pan_no,a.pur_mrr_no ,ARTICLE.ARTICLE_PACK_SIZE,LM01106.ALIAS as supplier_alias,
	a.Pur_Broker_Ac_code,bklm.AC_NAME Pur_Broker_Ac_Name,
	 (CASE WHEN isnull(SECTIONM.ITEM_TYPE,0) in(0,1) THEN 'INV'   WHEN SECTIONM.ITEM_TYPE =2 THEN 'CONS' WHEN SECTIONM.ITEM_TYPE =3 THEN 'ASSESTS' 
					 WHEN SECTIONM.ITEM_TYPE =4 THEN 'SERVICE' ELSE  '' END) AS  SKU_ITEM_TYPE_DESC
	
	FROM INSERTED A
	JOIN LM01106 (NOLOCK) ON LM01106.AC_CODE=A.AC_CODE
	LEFT JOIN LM01106 oem_lm (NOLOCK) ON oem_lm.AC_CODE=A.SHIPPING_FROM_AC_CODE
	LEFT JOIN SKU_OH (NOLOCK) ON A.PRODUCT_CODE=SKU_OH.PRODUCT_CODE 
	LEFT JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=A.ARTICLE_CODE
	LEFT JOIN uom (NOLOCK) ON uom.uom_code=article.uom_code
	LEFT JOIN uom alt_uom (NOLOCK) ON alt_uom.uom_code=a.alternate_uom_CODE
	LEFT JOIN ARTICLE_FIX_ATTR  AF (NOLOCK) ON AF.ARTICLE_CODE=A.ARTICLE_CODE
	LEFT JOIN FORM FF (NOLOCK) ON FF.FORM_ID=A.FORM_ID
	LEFT JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
	LEFT JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
	LEFT JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=A.PARA1_CODE      
	LEFT JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=A.PARA2_CODE      
	LEFT JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE=A.PARA3_CODE      
	LEFT JOIN PARA4 P4 (NOLOCK) ON P4.PARA4_CODE=A.PARA4_CODE      
	LEFT JOIN PARA5 P5 (NOLOCK) ON P5.PARA5_CODE=A.PARA5_CODE      
	LEFT JOIN PARA6 P6 (NOLOCK) ON P6.PARA6_CODE=A.PARA6_CODE   
	LEFT JOIN PARA7 P7 (NOLOCK) ON P7.PARA7_CODE=A.PARA7_CODE  
	LEFT JOIN ATTR1_MST A1 (NOLOCK) ON A1.ATTR1_KEY_CODE=af.attr1_KEY_CODE      
	LEFT JOIN ATTR2_MST A2 (NOLOCK) ON A2.ATTR2_KEY_CODE=af.attr2_KEY_CODE      
	LEFT JOIN ATTR3_MST A3 (NOLOCK) ON A3.ATTR3_KEY_CODE=af.attr3_KEY_CODE      
	LEFT JOIN ATTR4_MST A4 (NOLOCK) ON A4.ATTR4_KEY_CODE=af.attr4_KEY_CODE      
	LEFT JOIN ATTR5_MST A5 (NOLOCK) ON A5.ATTR5_KEY_CODE=af.attr5_KEY_CODE      
	LEFT JOIN ATTR6_MST A6 (NOLOCK) ON A6.ATTR6_KEY_CODE=af.attr6_KEY_CODE      
	LEFT JOIN ATTR7_MST A7 (NOLOCK) ON A7.ATTR7_KEY_CODE=af.attr7_KEY_CODE      
	LEFT JOIN ATTR8_MST A8 (NOLOCK) ON A8.ATTR8_KEY_CODE=af.attr8_KEY_CODE      
	LEFT JOIN ATTR9_MST A9 (NOLOCK) ON A9.ATTR9_KEY_CODE=af.attr9_KEY_CODE      
	LEFT JOIN ATTR10_MST A10 (NOLOCK) ON A10.ATTR10_KEY_CODE=af.attr10_KEY_CODE      
	LEFT JOIN ATTR11_MST A11 (NOLOCK) ON A11.ATTR11_KEY_CODE=af.attr11_KEY_CODE      
	LEFT JOIN ATTR12_MST A12 (NOLOCK) ON A12.ATTR12_KEY_CODE=af.attr12_KEY_CODE      
	LEFT JOIN ATTR13_MST A13 (NOLOCK) ON A13.ATTR13_KEY_CODE=af.attr13_KEY_CODE      
	LEFT JOIN ATTR14_MST A14 (NOLOCK) ON A14.ATTR14_KEY_CODE=af.attr14_KEY_CODE      
	LEFT JOIN ATTR15_MST A15 (NOLOCK) ON A15.ATTR15_KEY_CODE=af.attr15_KEY_CODE      
	LEFT JOIN ATTR16_MST A16 (NOLOCK) ON A16.ATTR16_KEY_CODE=af.attr16_KEY_CODE      
	LEFT JOIN ATTR17_MST A17 (NOLOCK) ON A17.ATTR17_KEY_CODE=af.attr17_KEY_CODE      
	LEFT JOIN ATTR18_MST A18 (NOLOCK) ON A18.ATTR18_KEY_CODE=af.attr18_KEY_CODE      
	LEFT JOIN ATTR19_MST A19 (NOLOCK) ON A19.ATTR19_KEY_CODE=af.attr19_KEY_CODE      
	LEFT JOIN ATTR20_MST A20 (NOLOCK) ON A20.ATTR20_KEY_CODE=af.attr20_KEY_CODE      
	LEFT JOIN ATTR21_MST A21 (NOLOCK) ON A21.ATTR21_KEY_CODE=af.attr21_KEY_CODE      
	LEFT JOIN ATTR22_MST A22 (NOLOCK) ON A22.ATTR22_KEY_CODE=af.attr22_KEY_CODE      
	LEFT JOIN ATTR23_MST A23 (NOLOCK) ON A23.ATTR23_KEY_CODE=af.attr23_KEY_CODE      
	LEFT JOIN ATTR24_MST A24 (NOLOCK) ON A24.ATTR24_KEY_CODE=af.attr24_KEY_CODE      
	LEFT JOIN ATTR25_MST A25 (NOLOCK) ON A25.ATTR25_KEY_CODE=Af.ATTR25_KEY_CODE
	LEFT JOIN #tmpBOXWEIGHT BOX ON BOX.ARTICLE_CODE =A.ARTICLE_CODE AND BOX.PARA2_CODE =A.PARA2_CODE 
	LEFT JOIN #tmpNewSkuImg img ON img.product_code=a.product_code
	LEFT JOIN location loc(NOLOCK) ON loc.dept_id=a.purchaseLocId
	LEFT JOIN LM01106 BKLM (NOLOCK) ON BKLM.AC_CODE=A.PUR_BROKER_AC_CODE
	; 
END





