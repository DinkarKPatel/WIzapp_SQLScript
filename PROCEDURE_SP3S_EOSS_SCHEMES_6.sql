CREATE PROCEDURE SP3S_EOSS_SCHEMES_6
(
	@CSCHEMEDETROWID VARCHAR(50),
	@CSLSTITLE VARCHAR(500),
	@CROUNDITEMLEVEL VARCHAR(5),
	@CJOINSTRBUY VARCHAR(MAX),
	@CJOINSTRGET VARCHAR(MAX),
	@CPICKSLRDISCMODE VARCHAR(5),
	@NSPID VARCHAR(40),
	@CERRMSG VARCHAR(MAX) OUTPUT
)
AS 
BEGIN

	DECLARE @NORGBUYAMT NUMERIC(10,2),@NBUYAMT NUMERIC(10,2),@NGETAMT NUMERIC(10,2),@NREQGETAMT NUMERIC(10,2),
			@CPRODUCTCODE VARCHAR(50),@NMRP NUMERIC(10,2),@NQTY NUMERIC(10,2),
			@CCMDROWID VARCHAR(50),@NLOOPCNT INT,@NMODE INT,@BQUALIFIED BIT,
			@CROWID VARCHAR(100),@NSTEP VARCHAR(10),@NAMT NUMERIC(10,2),
			@CMRPORDER VARCHAR(10),@NREQBUYAMT NUMERIC(10,2),@BRETRY2NDCASE BIT,@BSCHEMEFOUND BIT,
			@CCMD NVARCHAR(MAX),@CBUYFILTER VARCHAR(MAX),@NDISCFIGURE NUMERIC(10,2),
			@CADDFILTER VARCHAR(MAX),@CORGADDFILTER VARCHAR(MAX),@NDISCMODE INT,@BLOOP BIT,
			@NFILTERMODE INT,@BPROCESSSLRENTRY BIT,@NGETFILTERMODE INT,@NTRIAL INT,@NAPPLYMODE NUMERIC(1,0),
			@NDISCAPPLIED NUMERIC(10,2),@BCREATESETSSLSSLRITEMS BIT,@BDONOTAPPLYSCHEMEONDISCITEMS BIT
	
	SET @BPROCESSSLRENTRY=0
	SET @NSTEP='137.0'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1

	DECLARE @CENABLEOPTIMIZEDSCHEMES VARCHAR(2)
	SELECT TOP 1 @CENABLEOPTIMIZEDSCHEMES=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_OPTIMIZED_EOSS_SCHEMES'		
	
	SET @CENABLEOPTIMIZEDSCHEMES=ISNULL(@CENABLEOPTIMIZEDSCHEMES,'')

START_PROC:

		SET @NSTEP='137.1'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1

	SELECT @NORGBUYAMT=0,@CPRODUCTCODE='',@NBUYAMT=0,@NGETAMT=0,@NMRP=0,@NQTY=0,
		   @CCMDROWID='',@NLOOPCNT=0,@NREQGETAMT=0,@NMODE=0,@BQUALIFIED=0,@CROWID='',
		   @NSTEP=0,@NAMT=0,@CMRPORDER='',@NREQBUYAMT=0,@BRETRY2NDCASE=0,@CCMD='',
		   @NDISCMODE=0,@CBUYFILTER='',@CADDFILTER='',@NFILTERMODE=0,
		   @CADDFILTER='',@CORGADDFILTER='',@NGETFILTERMODE=0

	SELECT @BDONOTAPPLYSCHEMEONDISCITEMS=ISNULL(DONOT_APPLY_SCHEME_ON_DISCOUNTED_ITEMS,0) FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
	
	--IF @@SPID=163
	--	SELECT 'CHECK TMPCMD B4 PP Scheme:'+@CSLSTITLE,* FROM #TMPCMD

	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMD A WHERE (@BDONOTAPPLYSCHEMEONDISCITEMS=1 AND (ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 
				   AND ISNULL(A.SCHEME_SETUP_DET_ROW_ID,'')=''))OR (@BDONOTAPPLYSCHEMEONDISCITEMS=0 
				   AND ABS(A.MRP*A.QUANTITY)-A.SCHEME_APPLIED_AMOUNT>0))
		GOTO END_PROC
	
	IF @BPROCESSSLRENTRY=1
		SET @CORGADDFILTER='A.QUANTITY<0'
	ELSE
		SET @CORGADDFILTER='A.QUANTITY>0'
			
	IF CURSOR_STATUS('GLOBAL','SCHEMECUR') IN (0,1)
	BEGIN
		CLOSE SCHEMECUR
		DEALLOCATE SCHEMECUR
	END

BEGIN TRY        
		
		SET @NSTEP='137.3'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1
	
	PRINT 'CHECK SCHEME SP3S_EOSS_SCHEMES_6'	
	SELECT @CMRPORDER='',@BQUALIFIED=0,@BRETRY2NDCASE=0
		
	SELECT @CBUYFILTER=(CASE WHEN FILTER_MODE IN (0,1) AND @CENABLEOPTIMIZEDSCHEMES<>'1' THEN  BUY_FILTER_CRITERIA ELSE '1=1' END),
		   @NDISCMODE=DISC_METHOD,@NFILTERMODE=FILTER_MODE,@NGETFILTERMODE=GET_FILTER_MODE,
		   @BCREATESETSSLSSLRITEMS=ISNULL(CREATE_SETS_SLS_SLR_ITEMS,0)
	FROM SCHEME_SETUP_DET
	WHERE ROW_ID=@CSCHEMEDETROWID
	
	IF @BCREATESETSSLSSLRITEMS=1 AND ISNULL(@CPICKSLRDISCMODE,'')<>'3'
		SET @CORGADDFILTER='1=1'
		
	IF @NFILTERMODE NOT IN (0,1)
		SELECT @CADDFILTER=@CORGADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''''
	ELSE
		SELECT @CADDFILTER=@CORGADDFILTER+' AND 1=1'			

	IF @BDONOTAPPLYSCHEMEONDISCITEMS=1
		SELECT @CADDFILTER=@CADDFILTER+' AND ISNULL(A.SCHEME_SETUP_DET_ROW_ID,'''')='''' AND ABS(A.MRP*A.QUANTITY)-A.SCHEME_APPLIED_AMOUNT>0 '
							
		SET @NSTEP='137.5'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1

	IF OBJECT_ID('TEMPDB..#TMPCMDSCHEMES','U') IS NULL
		SELECT PRODUCT_CODE,MRP,QUANTITY,CMD_ROW_ID AS ROW_ID,CONVERT(INT,0) AS MODE,
		CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT,QUANTITY AS SCHEME_APPLIED_QTY
		INTO #TMPCMDSCHEMES FROM #TMPCMD WHERE 1=2 
	ELSE
		TRUNCATE TABLE #TMPCMDSCHEMES
		
	SET @CCMD=N' SELECT A.PRODUCT_CODE,A.NET AS MRP,A.QUANTITY,
				 A.CMD_ROW_ID AS ROW_ID,1 AS MODE,
				 0 AS DISCOUNT_AMOUNT,0 FROM #TMPCMD A
				 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTRBUY+'
				 WHERE '+@CBUYFILTER+' AND '+@CADDFILTER
	
	PRINT @CCMD				 
	INSERT #TMPCMDSCHEMES
	EXEC SP_EXECUTESQL @CCMD
		
		SET @NSTEP='137.7'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1

	
	IF OBJECT_ID('TEMPDB..#TEMPCMDPREV','U') IS NOT NULL
		DROP TABLE #TEMPCMDPREV

	SELECT * INTO #TEMPCMDPREV FROM #TMPCMDSCHEMES
	
	SET @NTRIAL=1 
	
	SELECT @NBUYAMT=ABS(SUM(MRP)) FROM #TMPCMDSCHEMES WHERE MODE=1
		
	SELECT @BQUALIFIED=0,@BSCHEMEFOUND=0,@NDISCFIGURE=0


	SELECT @NDISCFIGURE=DISCOUNT_FIGURE FROM SCHEME_SETUP_SCH0006_1 
	WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID AND @NBUYAMT BETWEEN 
	FROM_AMOUNT AND TO_AMOUNT
		
	IF ISNULL(@NDISCFIGURE,0)<>0
		SELECT @BQUALIFIED=1
	IF @BQUALIFIED=0
	BEGIN
		PRINT 'CHECK SCHEME SP3S_EOSS_SCHEMES_6 SET NOT FOUND'	
		GOTO EXIT_PROC
	END

	--IF @@SPID=163
	--	SELECT @NBUYAMT NBUYAMT,@NDISCFIGURE DISCFIGURE

LBLCHKBUY:
		SET @NSTEP='137.9'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1

	
	PRINT 'TRIAL#'+STR(@NTRIAL)	
			
END TRY

BEGIN CATCH
  PRINT 'CATCH IN SP3S_EOSS_SCHEMES_6'       
  SET @CERRMSG='P:SP3S_EOSS_SCHEMES_6, STEP:'+LTRIM(RTRIM(@NSTEP))+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
END CATCH

EXIT_PROC:
		
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
				SET @NSTEP='137.11'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1
	
		IF @BQUALIFIED=0
		BEGIN
			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=0
			
		END	
		ELSE
		BEGIN
		SET @NSTEP='137.13'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1

			
		
			DECLARE @NSUBTOTAL NUMERIC(10,2)
			
			SELECT @NSUBTOTAL=SUM(MRP) FROM #TMPCMDSCHEMES
			
			SET @NDISCAPPLIED=(CASE WHEN @NDISCMODE=1 THEN @NSUBTOTAL*@NDISCFIGURE/100 ELSE @NDISCFIGURE END)
			
			UPDATE #TMPCMDSCHEMES SET  DISCOUNT_AMOUNT=((@NDISCAPPLIED/ABS(@NSUBTOTAL))*MRP)*
			(CASE WHEN	QUANTITY<0 THEN -1 ELSE 1 END)
							
			SELECT @NDISCAPPLIED=SUM(DISCOUNT_AMOUNT) FROM #TMPCMDSCHEMES

					SET @NSTEP='137.15'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1

			UPDATE #TMPCMD SET DISCOUNT_AMOUNT=#TMPCMD.DISCOUNT_AMOUNT+ABS(B.DISCOUNT_AMOUNT)*
			(CASE WHEN	B.QUANTITY<0 THEN -1 ELSE 1 END),
			SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSLSTITLE,SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
			SCHEME_APPLIED_QTY=#TMPCMD.SCHEME_APPLIED_QTY+B.SCHEME_APPLIED_QTY,
			SCHEME_APPLIED_AMOUNT=#TMPCMD.MRP*#TMPCMD.QUANTITY,
			DISCOUNT_PERCENTAGE=(CASE WHEN @NDISCMODE=1 AND ISNULL(#TMPCMD.SCHEME_APPLIED_QTY,0)=0 THEN @NDISCFIGURE
			ELSE DISCOUNT_PERCENTAGE END)
			FROM #TMPCMDSCHEMES B WHERE B.ROW_ID=#TMPCMD.CMD_ROW_ID

			
			SET @NSTEP='137.25'
			EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1

			UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ABS(ROUND((DISCOUNT_AMOUNT/(MRP*QUANTITY))*100,2))
			WHERE (@NDISCMODE<>1 OR ISNULL(DISCOUNT_PERCENTAGE,0)=0 OR @BDONOTAPPLYSCHEMEONDISCITEMS=0)

			UPDATE #TMPCMD SET NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT

			----NEED TO RECALCULATE THIS AGAIN BECAUSE OF DA MILANODISCOUNT AMOUNT VALIDATION BEING FAILED 
			---- ON FINAL SAVE ( TICKET#11-0480 DATED: 07-11-2022)
			UPDATE  #TMPCMD SET DISCOUNT_AMOUNT=ROUND(MRP*QUANTITY*DISCOUNT_PERCENTAGE/100,2)

			UPDATE  #TMPCMD SET NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT

			--IF @@SPID=163
			--BEGIN
			--	SELECT 'CHECK #TMPCMDSCHEMES AFTER PP VALUE BASED',* FROM #TMPCMDSCHEMES 
			--	SELECT '%TMPCMD AFTER PP VALUE BASED APPLIED',* FROM #TMPCMD
			--END				
			--SELECT '%TMPCMD AFTER',* FROM #TMPCMD
			
		END	
		
		
				SET @NSTEP='137.17'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1

		IF @BPROCESSSLRENTRY=0 AND @CPICKSLRDISCMODE<>'3' AND @BCREATESETSSLSSLRITEMS=0
		BEGIN
			SET @BPROCESSSLRENTRY=1
			GOTO START_PROC
		END	
		ELSE
			GOTO END_PROC	
	END	

END_PROC:

		SET @NSTEP='137.19'
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,'',1

END
----- END OF PROCEDURE SP3S_EOSS_SCHEMES_6
