create PROCEDURE SP_PURCHASEINVOICEPROCESING
(
 @CMRR_ID VARCHAR(100),
 @NUPDATEMODE NUMERIC(1,0),
 @NBOXNO    INT=0,
 @CPRODUCTCODE  VARCHAR(50)='',
 @CACCODE VARCHAR(10)='',
 @CERRORMSG VARCHAR(1000) OUTPUT,
 @CSP_ID varchar(50)=''
 
)
AS
BEGIN
       
       DECLARE  @CSTEP VARCHAR(10) ,@DONOT_CHKPO_APPROVAL varchar(10)

BEGIN TRY
       
       SET @CSTEP=10
       
        select @DONOT_CHKPO_APPROVAL=value  from config where config_option='DONOT_CHKPO_APPROVAL'
        set @DONOT_CHKPO_APPROVAL=isnull(@DONOT_CHKPO_APPROVAL,'')
       
IF @NUPDATEMODE IN(3,4,5)
   GOTO LBLUPDATE_PUR
   
         SELECT @CACCODE AS AC_CODE INTO #TMPAC_CODE UNION
	     SELECT MAJOR_AC_CODE  FROM LM01106 WHERE AC_CODE=@CACCODE 
	   
	   
	   
	 
	   
   --***THIS PROCESS HAS BEEN SETTLED OM ONE TO MANY PURCHASE AND ONE TO ONE PURCHASE***
   
       IF @NUPDATEMODE IN(1,2)
       BEGIN
       
          IF @NUPDATEMODE IN(2)
          begin
              
              	UPDATE A SET PARA1_CODE =(CASE WHEN ISNULL(POPARA1,0)=0 THEN '0000000' ELSE A.PARA1_CODE END ),
							 PARA2_CODE =(CASE WHEN ISNULL(POPARA2,0)=0 THEN '0000000' ELSE A.PARA2_CODE END ),
							 PARA3_CODE  =(CASE WHEN ISNULL(POPARA3,0)=0 THEN '0000000' ELSE A.PARA3_CODE END )
				FROM #TMPPI_PROCESS A
				JOIN ARTICLE ART (NOLOCK) ON A.ARTICLE_CODE =ART.ARTICLE_CODE 
				JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE 
          
          end
       
		   SELECT A.ROW_ID  ,A.ARTICLE_CODE ,
		          art.article_no  ARTICLE_NO ,
		          p1.para1_name  PARA1_NAME ,
		          p2.para2_name  PARA2_NAME,
		          p3.para3_name  PARA3_NAME  ,
		          SUM(A.QUANTITY) AS  QUANTITY,
				  PRODUCT_SRNO=CAST(0 AS INT),
				  ARTICLE_SRNO=CAST(0 AS INT),
				  RUNNING_TOTAL=CAST(0 AS NUMERIC(14,3)),
				  LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE ))) AS PRODUCT_CODE,
				  CAST('' AS VARCHAR(100)) AS PO_ROW_ID 
		   INTO #TMPPISETOFF
		   FROM #TMPPI_PROCESS A (NOLOCK)
		   JOIN ARTICLE ART (NOLOCK) ON A.ARTICLE_CODE =ART.ARTICLE_CODE 
		   JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=A.PARA1_CODE
		   JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=A.PARA2_CODE
		   JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE=A.PARA3_CODE
		   GROUP BY A.ROW_ID ,A.ARTICLE_CODE ,art.article_no,p1.para1_name ,p2.para2_name,p3.para3_name,
		   LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))
		   having SUM(A.QUANTITY)<>0
		   
		  IF EXISTS ( SELECT  TOP 1 'U' FROM #TMPPISETOFF WHERE QUANTITY<0) and @NUPDATEMODE=2
		  BEGIN
		     
		     UPDATE A SET QTY =A.QTY +B.QUANTITY 
		     FROM PURCHASEORDERPROCESSINGNEW A (NOLOCK)
		     JOIN #TMPPISETOFF B ON A.ROWID =B.ROW_ID
		     WHERE B.QUANTITY<0 AND A.XNTYPE ='PURCHASEINVOICE'
		     
		     DELETE A  FROM PURCHASEORDERPROCESSINGNEW A (NOLOCK)
		     JOIN #TMPPISETOFF B ON A.ROWID =B.ROW_ID
		     WHERE B.QUANTITY<0 AND A.XNTYPE ='PURCHASEINVOICE'
		     AND A.QTY=0
		     
		     
		     DELETE  FROM #TMPPISETOFF WHERE QUANTITY<0
		  END 
		  
		  IF NOT  EXISTS ( SELECT  TOP 1 'U' FROM #TMPPISETOFF )
             GOTO END_PROC
          
	       SET @CSTEP=20
	       
	     
	       SELECT A.REFROWID ,P1.PARA1_NAME ,P2.PARA2_NAME ,P3.PARA3_NAME,
				   B.ARTICLE_CODE ,CAST('' AS VARCHAR(300)) AS ARTICLE_NO,B.PRODUCT_CODE ,
				   (CASE WHEN A.XNTYPE='PURCHASEORDER' THEN A.QTY ELSE -1*A.QTY END) AS PENDINGQTY
			INTO #TMPPOQTY
			FROM PURCHASEORDERPROCESSINGNEW A (NOLOCK)
			JOIN POD01106 B (NOLOCK) ON A.REFROWID =B.ROW_ID 
			JOIN POM01106 C (NOLOCK) ON C.PO_ID =B.PO_ID 
			JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =B.PARA1_CODE 
			JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =B.PARA2_CODE 
			JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE =B.PARA3_CODE 
			where 1=2
	       
	       IF EXISTS (SELECT TOP 1 'U' FROM #TMP_PIM_POID)
	       BEGIN
                
                insert into #TMPPOQTY(REFROWID,PARA1_NAME,PARA2_NAME,PARA3_NAME,ARTICLE_CODE,ARTICLE_NO,PRODUCT_CODE,PENDINGQTY)
				SELECT A.REFROWID ,P1.PARA1_NAME ,P2.PARA2_NAME ,P3.PARA3_NAME,
					   B.ARTICLE_CODE ,CAST('' AS VARCHAR(100)) AS ARTICLE_NO,B.PRODUCT_CODE ,
					   SUM(CASE WHEN A.XNTYPE='PURCHASEORDER' THEN A.QTY ELSE -1*A.QTY END) AS PENDINGQTY
				FROM PURCHASEORDERPROCESSINGNEW A (NOLOCK)
				JOIN POD01106 B (NOLOCK) ON A.REFROWID =B.ROW_ID 
				JOIN POM01106 C (NOLOCK) ON C.PO_ID =B.PO_ID 
				JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =B.PARA1_CODE 
				JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =B.PARA2_CODE 
				JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE =B.PARA3_CODE 
				JOIN #TMPAC_CODE TMP ON C.AC_CODE =TMP.AC_CODE 
				JOIN #TMP_PIM_POID PO ON PO.PO_ID =C.PO_ID 
				WHERE C.CANCELLED=0 AND ISNULL(C.SHORT_CLOSE,0)=0 
				GROUP BY A.REFROWID ,P1.PARA1_NAME ,P2.PARA2_NAME ,P3.PARA3_NAME,B.ARTICLE_CODE,B.PRODUCT_CODE
				HAVING  SUM(CASE WHEN A.XNTYPE='PURCHASEORDER' THEN A.QTY ELSE -1*A.QTY END)>0
				
			END
			Else 
			begin
			      
			    insert into #TMPPOQTY(REFROWID,PARA1_NAME,PARA2_NAME,PARA3_NAME,ARTICLE_CODE,ARTICLE_NO,PRODUCT_CODE,PENDINGQTY)
				SELECT A.REFROWID ,P1.PARA1_NAME ,P2.PARA2_NAME ,P3.PARA3_NAME,
					   B.ARTICLE_CODE ,CAST('' AS VARCHAR(100)) AS ARTICLE_NO,B.PRODUCT_CODE ,
					   SUM(CASE WHEN A.XNTYPE='PURCHASEORDER' THEN A.QTY ELSE -1*A.QTY END) AS PENDINGQTY
				FROM PURCHASEORDERPROCESSINGNEW A (NOLOCK)
				JOIN POD01106 B (NOLOCK) ON A.REFROWID =B.ROW_ID 
				JOIN POM01106 C (NOLOCK) ON C.PO_ID =B.PO_ID 
				JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =B.PARA1_CODE 
				JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =B.PARA2_CODE 
				JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE =B.PARA3_CODE 
				JOIN #TMPAC_CODE TMP ON C.AC_CODE =TMP.AC_CODE 
				WHERE C.CANCELLED=0 AND ISNULL(C.SHORT_CLOSE,0)=0 
				and (c.ApprovedLevelNo =99 or @DONOT_CHKPO_APPROVAL='1')
				and c.DELIVERY_DT >=convert(varchar(10),getdate(),21)
				GROUP BY A.REFROWID ,P1.PARA1_NAME ,P2.PARA2_NAME ,P3.PARA3_NAME,B.ARTICLE_CODE,B.PRODUCT_CODE
				HAVING  SUM(CASE WHEN A.XNTYPE='PURCHASEORDER' THEN A.QTY ELSE -1*A.QTY END)>0
			 
			
			end
			
			UPDATE A SET ARTICLE_NO =B.ARTICLE_NO 
			FROM #TMPPOQTY A
			JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE =B.ARTICLE_CODE 
			
		
			
			SET @CSTEP=30
			
			 ;WITH BARCODE_TOTAL AS 
			(
			 SELECT PRODUCT_CODE ,SUM(QUANTITY) AS TOTALPIQTY
			 FROM #TMPPISETOFF WHERE PRODUCT_CODE<>'' GROUP BY PRODUCT_CODE
			 )
			 
			 UPDATE C SET PO_ROW_ID =B.REFROWID  
			 FROM BARCODE_TOTAL A
			 JOIN #TMPPOQTY B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
			 JOIN #TMPPISETOFF C ON A.PRODUCT_CODE =C.PRODUCT_CODE 
			 WHERE B.PENDINGQTY >=A.TOTALPIQTY
			 
			 
			 
			SET @CSTEP=40
			
			IF EXISTS (SELECT TOP 1 'U' FROM #TMPPISETOFF WHERE PO_ROW_ID ='')
			BEGIN
		
			
				UPDATE A SET PARA1_NAME =(CASE WHEN ISNULL(POPARA1,0)=0 THEN 'NA' ELSE A.PARA1_NAME END ),
							 PARA2_NAME =(CASE WHEN ISNULL(POPARA2,0)=0 THEN 'NA' ELSE A.PARA2_NAME END ),
							 PARA3_NAME =(CASE WHEN ISNULL(POPARA3,0)=0 THEN 'NA' ELSE A.PARA3_NAME END ),
							 ARTICLE_NO =ART.ARTICLE_NO 
				FROM #TMPPOQTY A
				JOIN ARTICLE ART (NOLOCK) ON A.ARTICLE_CODE =ART.ARTICLE_CODE 
				JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE 

				SET @CSTEP=60
			    
				UPDATE A SET PARA1_NAME =(CASE WHEN ISNULL(POPARA1,0)=0 THEN 'NA' ELSE A.PARA1_NAME END ),
							 PARA2_NAME =(CASE WHEN ISNULL(POPARA2,0)=0 THEN 'NA' ELSE A.PARA2_NAME END ),
							 PARA3_NAME =(CASE WHEN ISNULL(POPARA3,0)=0 THEN 'NA' ELSE A.PARA3_NAME END )
							
				FROM #TMPPISETOFF A
				JOIN ARTICLE ART (NOLOCK) ON A.ARTICLE_CODE =ART.ARTICLE_CODE 
				JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE 
				WHERE ISNULL(PO_ROW_ID,'')=''
				
				SET @CSTEP=70
				
				;WITH ARTICLE_TOTAL AS 
				(
				 SELECT ARTICLE_NO ,PARA1_NAME ,PARA2_NAME,PARA3_NAME   ,SUM(QUANTITY) AS TOTALPIQTY
				 FROM #TMPPISETOFF WHERE ISNULL(PO_ROW_ID,'')=''
				 GROUP BY ARTICLE_NO ,PARA1_NAME ,PARA2_NAME ,PARA3_NAME
				 )
				 
				 UPDATE C SET PO_ROW_ID =B.REFROWID  
				 FROM ARTICLE_TOTAL A
				 JOIN #TMPPOQTY B ON A.ARTICLE_NO  =B.ARTICLE_NO AND A.PARA1_NAME =B.PARA1_NAME AND A.PARA2_NAME =B.PARA2_NAME  AND A.PARA3_NAME =B.PARA3_NAME 
				 JOIN #TMPPISETOFF C ON A.ARTICLE_NO  =C.ARTICLE_NO AND A.PARA1_NAME =C.PARA1_NAME AND A.PARA2_NAME =C.PARA2_NAME  AND A.PARA3_NAME =C.PARA3_NAME 
				 WHERE B.PENDINGQTY >=A.TOTALPIQTY
				 AND  ISNULL(PO_ROW_ID,'')='' AND ISNULL(B.PRODUCT_CODE,'')=''
				 
			  IF EXISTS (SELECT TOP 1 'U' FROM #TMPPISETOFF WHERE PO_ROW_ID ='')
			   BEGIN
		
				 UPDATE A SET PENDINGQTY=PENDINGQTY-QUANTITY FROM #TMPPOQTY A
				 JOIN 
				 (
				   SELECT PO_ROW_ID,SUM(QUANTITY) AS QUANTITY 
				   FROM #TMPPISETOFF
				   WHERE PO_ROW_ID<>'' GROUP BY PO_ROW_ID
				  ) B ON A.REFROWID  =B.PO_ROW_ID
				   
				END
		END
		
		  INSERT INTO PURCHASEORDERPROCESSINGNEW(XNTYPE,ROWID,REFROWID,QTY)
		  SELECT 'PURCHASEINVOICE' AS XNTYPE ,A.ROW_ID  ,A.PO_ROW_ID  REFROWID  ,SUM(A.QUANTITY) AS QTY
		  FROM #TMPPISETOFF A
		  WHERE PO_ROW_ID <>''
		 GROUP BY A.ROW_ID,A.PO_ROW_ID 
	 
	END
	

	 
	
 --***THIS PROCESS HAS BEEN SETTLED OM MANY TO TO MANY PURCHASE AND MANY TO ONE PURCHASE***	
 
      SELECT * INTO #TMPPISETOFF_NEW 
      FROM #TMPPISETOFF WHERE PO_ROW_ID =''
      
     
     

	  IF EXISTS (SELECT TOP 1 'U' FROM #TMPPISETOFF_NEW )
	  BEGIN
	       
	        SELECT A.PRODUCT_CODE  
			INTO #TMPBARCODESETOFF
			FROM #TMPPOQTY A
			JOIN #TMPPISETOFF_NEW B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
			where A.PRODUCT_CODE <>''
			GROUP BY A.PRODUCT_CODE 
			
			
					
	  IF EXISTS (SELECT TOP 1 'U' FROM #TMPBARCODESETOFF)
	   BEGIN	
	        
	        SET @CSTEP=100
	        
	        UPDATE A SET PRODUCT_SRNO =SR FROM #TMPPISETOFF_NEW A
			JOIN
			(
			SELECT ROW_ID ,
				   SR=ROW_NUMBER () OVER (PARTITION BY A.PRODUCT_CODE ORDER BY QUANTITY) 
			FROM #TMPPISETOFF_NEW A
			JOIN #TMPBARCODESETOFF B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
			WHERE A.PO_ROW_ID =''
			) B ON A.ROW_ID =B.ROW_ID 
			
			SET @CSTEP=105
			
			;with cte_RUNNING_TOTAL as 
			(
			
			select a.PRODUCT_CODE ,a.PRODUCT_SRNO ,
			       SUM(b.Quantity) as RUNNING_TOTAL 
			from #TMPPISETOFF_NEW A
			join #TMPPISETOFF_NEW b on a.PRODUCT_CODE =b.PRODUCT_CODE and b.PRODUCT_SRNO<=a.PRODUCT_SRNO
			where a.PRODUCT_CODE<>'' and a.PRODUCT_SRNO>0  and b.PRODUCT_SRNO>0
			group by a.PRODUCT_CODE ,a.PRODUCT_SRNO 
			)
			
			Update A set RUNNING_TOTAL =b.RUNNING_TOTAL 
			from #TMPPISETOFF_NEW A
			join cte_RUNNING_TOTAL b on a.PRODUCT_CODE =b.PRODUCT_CODE and a.PRODUCT_SRNO =b.PRODUCT_SRNO 
			
			SET @CSTEP=110
			
			;WITH CTE_PENDING_BARCODE AS
			(
			SELECT A.REFROWID  ,A.PRODUCT_CODE,A.PENDINGQTY ,SR=1
			FROM #TMPPOQTY A 
			JOIN #TMPBARCODESETOFF B ON A.PRODUCT_CODE =B.PRODUCT_CODE  
			UNION ALL
			SELECT A.REFROWID  ,A.PRODUCT_CODE,A.PENDINGQTY ,SR=SR+1 
			FROM CTE_PENDING_BARCODE A
			WHERE SR<PENDINGQTY
			)
			
			SELECT A.REFROWID ,A.PRODUCT_CODE ,CAST(1 AS NUMERIC(1,0)) AS QUANTITY ,
			       SR=ROW_NUMBER () OVER(ORDER BY REFROWID)  
			INTO #TMPBARCODE_PO
			FROM CTE_PENDING_BARCODE A
			OPTION (MAXRECURSION 0);
			
			SET @CSTEP=120
			
			IF EXISTS (SELECT TOP 1 'U' FROM #TMPPISETOFF_NEW A
			LEFT JOIN
			(
			  SELECT PRODUCT_CODE,SUM(QUANTITY) AS PENDING_PO 
			  FROM #TMPBARCODE_PO
			  GROUP BY PRODUCT_CODE
			) B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
			GROUP BY A.PRODUCT_CODE,ISNULL(B.PENDING_PO,0)
			HAVING SUM(A.QUANTITY )>(ISNULL(B.PENDING_PO,0)))
			BEGIN
			    
			    SET @CERRORMSG='PENDING PO NOT FOUND OF SELECTD ITEM'
			    
				SELECT A.PRODUCT_CODE,A.ARTICLE_NO ,A.PARA1_NAME ,A.PARA2_NAME ,A.PARA3_NAME, 
					   SUM(A.QUANTITY ) AS PUR_QTY ,
					   SUM(ISNULL(B.PENDING_PO,0)) AS PENDING_PO,
					   'PENDING PO NOT FOUND OF SELECTD ITEM' AS ERRMSG,@CMRR_ID as memo_id
				FROM #TMPPISETOFF_NEW A
				LEFT JOIN
				(
				  SELECT PRODUCT_CODE,SUM(QUANTITY) AS PENDING_PO 
				  FROM #TMPBARCODE_PO
				  GROUP BY PRODUCT_CODE
				) B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
				GROUP BY A.PRODUCT_CODE,A.ARTICLE_NO ,A.PARA1_NAME ,A.PARA2_NAME ,A.PARA3_NAME,ISNULL(B.PENDING_PO,0)
				HAVING SUM(A.QUANTITY )>(ISNULL(B.PENDING_PO,0)) 
				
			   GOTO END_PROC
		   END 
			
			DELETE A FROM #TMPPOQTY A
			JOIN #TMPBARCODE_PO B ON A.REFROWID =B.REFROWID 
			
			 INSERT INTO PURCHASEORDERPROCESSINGNEW(XNTYPE,ROWID,REFROWID,QTY)
			 SELECT 'PURCHASEINVOICE' AS XNTYPE ,A.ROW_ID  ,B.REFROWID  ,SUM(B.QUANTITY) AS QTY
			 FROM #TMPPISETOFF_NEW A
			 JOIN #TMPBARCODE_PO B ON A.PRODUCT_CODE =B.PRODUCT_CODE AND 
					 B.SR BETWEEN  (A.RUNNING_TOTAL -A.QUANTITY )+1 AND RUNNING_TOTAL 
			  WHERE PRODUCT_SRNO >0
			  GROUP BY A.ROW_ID  ,B.REFROWID
			
	   END
	   
	   
	   PRINT 'NOW PURCHASE INVOICE SETTLEMENT ARTICLE AND PARAA WISE'
	   
	   SET @CSTEP=130
	   
	  

	   
	   IF EXISTS (SELECT TOP 1 'Ú' FROM #TMPPISETOFF_NEW WHERE PRODUCT_SRNO =0)
	   BEGIN
	   
			UPDATE A SET ARTICLE_SRNO =SR FROM #TMPPISETOFF_NEW A
			JOIN
			(
			SELECT ROW_ID ,
				   SR=ROW_NUMBER () OVER (PARTITION BY ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA3_NAME ORDER BY QUANTITY) 
			FROM #TMPPISETOFF_NEW
			WHERE PRODUCT_SRNO =0
			) B ON A.ROW_ID =B.ROW_ID 
			
			SET @CSTEP=135
			
			 ;with cte_art_runningTotal as 
			 (
			 
			 select a.article_no ,a.para1_name ,a.para2_name ,a.para3_name ,a.ARTICLE_SRNO,
			        sum(b.Quantity) as RUNNING_TOTAL
			  from #TMPPISETOFF_NEW A
			 join #TMPPISETOFF_NEW b on a.article_no =b.article_no and a.para1_name =b.para1_name and a.para2_name =b.para2_name 
			 and a.para3_name =b.para3_name and b.ARTICLE_SRNO <=a.ARTICLE_SRNO 
			 where a.ARTICLE_SRNO>0 and b.ARTICLE_SRNO>0
			 group by a.article_no ,a.para1_name ,a.para2_name ,a.para3_name,a.ARTICLE_SRNO
			 )
			 
			
			 Update a set RUNNING_TOTAL=b.RUNNING_TOTAL  
			 FROM #TMPPISETOFF_NEW A
			 JOIN CTE_ART_RUNNINGTOTAL B ON A.ARTICLE_NO =B.ARTICLE_NO AND A.PARA1_NAME =B.PARA1_NAME AND A.PARA2_NAME =B.PARA2_NAME 
			 AND A.PARA3_NAME =B.PARA3_NAME and a.ARTICLE_SRNO=b.ARTICLE_SRNO
             
            
             	 
			SET @CSTEP=140
			
			;WITH CTE_PENDING AS
			(
			SELECT A.REFROWID ,A.ARTICLE_CODE ,A.ARTICLE_NO ,A.PARA1_NAME ,A.PARA2_NAME ,A.PARA3_NAME ,A.PRODUCT_CODE,
				   A.PENDINGQTY ,SR=1
			FROM #TMPPOQTY A
			JOIN
			( 
			  SELECT ARTICLE_NO ,PARA1_NAME ,PARA2_NAME ,PARA3_NAME  FROM #TMPPISETOFF_NEW
			  WHERE PRODUCT_SRNO =0
			  GROUP BY ARTICLE_NO ,PARA1_NAME ,PARA2_NAME ,PARA3_NAME 
			) B ON A.ARTICLE_NO =B.ARTICLE_NO AND A.PARA1_NAME =B.PARA1_NAME AND A.PARA2_NAME =B.PARA2_NAME AND A.PARA3_NAME =B.PARA3_NAME 
			where a.product_code =''
			UNION ALL
			SELECT A.REFROWID ,A.ARTICLE_CODE ,A.ARTICLE_NO ,A.PARA1_NAME ,A.PARA2_NAME ,A.PARA3_NAME ,A.PRODUCT_CODE,
				   A.PENDINGQTY ,SR=SR+1 
			FROM CTE_PENDING A
			WHERE SR<PENDINGQTY
			)

			SELECT A.REFROWID,A.ARTICLE_NO ,A.PARA1_NAME,A.PARA2_NAME,A.PARA3_NAME ,
			       CAST(1 AS NUMERIC(1,0)) AS QUANTITY,
			       SR=ROW_NUMBER () OVER(partition by A.ARTICLE_NO ,A.PARA1_NAME,A.PARA2_NAME,A.PARA3_NAME ORDER BY A.REFROWID) 
			INTO #TMPARTICLE_PO
			FROM CTE_PENDING A
			OPTION (MAXRECURSION 0);
			
			SET @CSTEP=150
			
			
	        IF EXISTS (SELECT TOP 1 'U' FROM #TMPPISETOFF_NEW A
			LEFT JOIN
			(
			  SELECT A.ARTICLE_NO ,A.PARA1_NAME,A.PARA2_NAME,A.PARA3_NAME,
			        SUM(QUANTITY) AS PENDING_PO 
			  FROM #TMPARTICLE_PO A
			  GROUP BY A.ARTICLE_NO ,A.PARA1_NAME,A.PARA2_NAME,A.PARA3_NAME
			) B ON A.ARTICLE_NO  =B.ARTICLE_NO AND A.PARA1_NAME =B.PARA1_NAME AND A.PARA2_NAME =B.PARA2_NAME AND A.PARA3_NAME =B.PARA3_NAME 
			GROUP BY A.ARTICLE_NO ,A.PARA1_NAME ,A.PARA2_NAME ,A.PARA3_NAME,b.PENDING_PO
			HAVING SUM(A.QUANTITY )>(ISNULL(B.PENDING_PO,0)) )
			BEGIN
			    
			    SET @CERRORMSG='PENDING PO NOT FOUND OF SELECTD ITEM'
			    
				SELECT A.ARTICLE_NO ,A.PARA1_NAME ,A.PARA2_NAME ,A.PARA3_NAME, 
					   SUM(A.QUANTITY ) AS PUR_QTY ,
					    (ISNULL(B.PENDING_PO,0)) AS PENDING_PO,
					   'PENDING PO NOT FOUND OF SELECTD ITEM' AS ERRMSG,@CMRR_ID as memo_id, a.PRODUCT_CODE  AS PRODUCT_CODE
				FROM #TMPPISETOFF_NEW A
				LEFT JOIN
				(
				  SELECT A.ARTICLE_NO ,A.PARA1_NAME,A.PARA2_NAME,A.PARA3_NAME,
				        SUM(QUANTITY) AS PENDING_PO 
				   FROM #TMPARTICLE_PO A
				  GROUP BY A.ARTICLE_NO ,A.PARA1_NAME,A.PARA2_NAME,A.PARA3_NAME
				) B ON A.ARTICLE_NO  =B.ARTICLE_NO AND A.PARA1_NAME =B.PARA1_NAME AND A.PARA2_NAME =B.PARA2_NAME AND A.PARA3_NAME =B.PARA3_NAME 
				GROUP BY A.ARTICLE_NO ,A.PARA1_NAME ,A.PARA2_NAME ,A.PARA3_NAME,B.PENDING_PO,a.PRODUCT_CODE 
				HAVING SUM(A.QUANTITY )>(ISNULL(B.PENDING_PO,0)) 
				
			    GOTO END_PROC
		   END 
		   
		   
		  
		 
		   
		 INSERT INTO PURCHASEORDERPROCESSINGNEW(XNTYPE,ROWID,REFROWID,QTY)
	     SELECT 'PURCHASEINVOICE' AS XNTYPE ,A.ROW_ID  ,B.REFROWID  ,SUM(B.QUANTITY) AS QTY
		  FROM #TMPPISETOFF_NEW A
		  JOIN #TMPARTICLE_PO B ON A.ARTICLE_NO  =B.ARTICLE_NO AND  A.PARA1_NAME =B.PARA1_NAME AND A.PARA2_NAME =B.PARA2_NAME AND A.PARA3_NAME =B.PARA3_NAME 
					AND  B.SR BETWEEN  (A.RUNNING_TOTAL -A.QUANTITY )+1 AND RUNNING_TOTAL 
		 WHERE ARTICLE_SRNO >0
		GROUP BY A.ROW_ID  ,B.REFROWID
	    
	    END
	    
	    
	    
	END  
 
 GOTO END_PROC
     
 LBLUPDATE_PUR: 
 
  
        IF @NUPDATEMODE=3
        BEGIN
            
            DELETE A FROM  PURCHASEORDERPROCESSINGNEW  A (NOLOCK)
            JOIN PID01106 B ON A.ROWID =B.ROW_ID 
            WHERE MRR_ID =@CMRR_ID AND A.XNTYPE ='PURCHASEINVOICE'
        
        END
        ELSE IF @NUPDATEMODE=4
        BEGIN
        
      
        
            DELETE A  FROM PURCHASEORDERPROCESSINGNEW  A (NOLOCK)
            JOIN PID01106 B ON A.ROWID =B.ROW_ID 
            WHERE MRR_ID =@CMRR_ID AND A.XNTYPE ='PURCHASEINVOICE'
            AND B.BOX_NO =@NBOXNO 
        
          
            
        END
        ELSE IF @NUPDATEMODE=5
        BEGIN
        
        
        
            DELETE A FROM PURCHASEORDERPROCESSINGNEW  A (NOLOCK)
            JOIN PID01106 B ON A.ROWID =B.ROW_ID 
            WHERE MRR_ID =@CMRR_ID AND A.XNTYPE ='PURCHASEINVOICE'
            AND B.PRODUCT_CODE =@CPRODUCTCODE 
        
       
        
        
        END
 
      
       
      
       
      
END TRY
BEGIN CATCH

        PRINT 'ENTER CATCH OF SP_PURCHASEINVOICEPROCESING'
		SET @CERRORMSG=' ERROR IN PROCEDURE SP_PURCHASEINVOICEPROCESING AT STEP#'+@CSTEP+' '+ERROR_MESSAGE()
		GOTO END_PROC
		
END CATCH
      
   END_PROC:
   
   IF EXISTS (SELECT TOP 1 'U' FROM  PURCHASEORDERPROCESSINGNEW  A (NOLOCK)
            JOIN PID01106 B (NOLOCK) ON A.ROWID =B.ROW_ID 
            WHERE MRR_ID =@CMRR_ID AND A.XNTYPE ='PURCHASEINVOICE' AND Qty =0)
    BEGIN
        
       DELETE A FROM  PURCHASEORDERPROCESSINGNEW  A (NOLOCK)
        JOIN PID01106 B (NOLOCK) ON A.ROWID =B.ROW_ID 
        WHERE MRR_ID =@CMRR_ID AND A.XNTYPE ='PURCHASEINVOICE' AND Qty =0
    
    END
  
  
  DELETE A FROM  PIM_POID_UPLOAD A (NOLOCK) WHERE SP_ID=@CSP_ID


END