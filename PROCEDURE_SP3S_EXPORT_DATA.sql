CREATE PROCEDURE SP3S_EXPORT_DATA--(LocId 3 digit change by Sanjay:06-11-2024)
(
	@nQueryMode INT=1,
	@nExportType VARCHAR(10)='',
	@nIncludeHeader	INT=1,
	@cOutputFileName VARCHAR(1000)='',
	@CXNTYPE	VARCHAR(100)='WSL',
	@cmemoid varchar(50)=''

	
)
AS
BEGIN
	IF @nQueryMode=1
	BEGIN
		SELECT 'Export to Excel' AS Export_Name,'XLS' Export_Type, CAST(0 AS INT) AS WITH_HEADER 
		UNION SELECT 'Export to CSV' AS Export_Name,'CSV' Export_Type, CAST(0 AS INT) AS WITH_HEADER 
		--UNION SELECT 'Export to CSV(With Header)' AS Export_Name,'CSV' Export_Type, CAST(1 AS INT) AS WITH_HEADER 
	--	UNION SELECT 'Export to XML' AS Export_Name,'XML' Export_Type, CAST(0 AS INT) AS WITH_HEADER 
		UNION SELECT 'Export to TXT' AS Export_Name,'TXT' Export_Type, CAST(0 AS INT) AS WITH_HEADER 
	--	UNION SELECT 'Export to TXT(With Header)' AS Export_Name,'TXT' Export_Type, CAST(1 AS INT) AS WITH_HEADER 
	END
	ELSE IF @nQueryMode=2 
	BEGIN
	    DECLARE @CTABLENAME VARCHAR(100)
		SET @CTABLENAME='TEMPWSLEXPORT'
	  
    	DECLARE @FILE VARCHAR(1000),@LINE_ITEMS VARCHAR(8000),@ROW BIGINT,@BATCH INT=1,@ccmd varchar(max)  
		DECLARE @DTSQL NVARCHAR(MAX),@COLNAME VARCHAR(100)  

		SET @FILE=@cOutputFileName

		DECLARE @header VARCHAR(MAX),
				@details VARCHAR(MAX),
				@CRLF VARCHAR(4),
				@RowTerminator CHAR(1)
		SET @CRLF = CHAR(13) + CHAR(10)
		SET @RowTerminator = '|'

		 IF OBJECT_ID('TEMPDB..#TMPWSL','U') IS NOT NULL
				DROP TABLE #TMPWSL

				SELECT CAST(0 AS INT) AS SR, CAST('' AS VARCHAR(MAX)) AS DISPLAY_NAME
				INTO #TMPWSL WHERE 1=2

         EXEC SP_WSLINV_11 @cmemoid
	     return
				
  
		 	          
    END
	ELSE IF @nQueryMode=3 
	BEGIN
	       
		    DECLARE @CSENDPARA6 VARCHAR(10)  
			SELECT @CSENDPARA6 = VALUE FROM CONFIG WHERE CONFIG_OPTION = 'SENT_SUPPLIER_NAME_PARA6'  
			SELECT @CSENDPARA6=ISNULL(@CSENDPARA6,'')  
  
			DECLARE @cpara1Name varchar(10),@cpara2Name varchar(10),@cpara3Name varchar(10),@cpara4Name varchar(10),@cpara5Name varchar(10),@cpara6Name varchar(10),  
			  @CPARANAME VARCHAR(5000)  
  
			SELECT @cpara1Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA1_NAME' ELSE VALUE END  FROM CONFIG WHERE CONFIG_OPTION ='PARA1_CAPTION'  
			SELECT @cpara2Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA2_NAME' ELSE VALUE END  FROM CONFIG WHERE CONFIG_OPTION ='PARA2_CAPTION'  
			SELECT @cpara3Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA3_NAME' ELSE VALUE END  FROM CONFIG WHERE CONFIG_OPTION ='PARA3_CAPTION'  
			SELECT @cpara4Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA4_NAME' ELSE VALUE END  FROM CONFIG WHERE CONFIG_OPTION ='PARA4_CAPTION'  
			SELECT @cpara5Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA5_NAME' ELSE VALUE END  FROM CONFIG WHERE CONFIG_OPTION ='PARA5_CAPTION'  
			SELECT @cpara6Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA6_NAME' ELSE VALUE END  FROM CONFIG WHERE CONFIG_OPTION ='PARA6_CAPTION'  
  
  
			SET @CPARANAME='SN.PARA1_NAME AS '+QUOTENAME(@cpara1Name)+','  
			SET @CPARANAME=@CPARANAME+' SN.PARA2_NAME AS '+QUOTENAME(@cpara2Name)+','  
			SET @CPARANAME=@CPARANAME+' SN.PARA3_NAME AS '+QUOTENAME(@cpara3Name)+','  
			SET @CPARANAME=@CPARANAME+' SN.PARA4_NAME AS '+QUOTENAME(@cpara4Name)+','  
			SET @CPARANAME=@CPARANAME+' SN.PARA5_NAME AS '+QUOTENAME(@cpara5Name)+','  
			SET @CPARANAME=@CPARANAME+'(CASE WHEN '''+@CSENDPARA6+'''= ''1'' THEN L.AC_NAME ELSE SN.PARA6_NAME END) AS  '+QUOTENAME(@cpara6Name)+''  
  
			IF OBJECT_ID ('TEMPWSLEXPORT','U' ) IS NOT NULL  
			   drop table TEMPWSLEXPORT  
   
			SET @DTSQL=N'SELECT  LEFT( S1.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'', S1.PRODUCT_CODE)-1,-1),LEN( S1.PRODUCT_CODE ))) PRODUCT_CODE,  
			T1.RATE AS PURCHASE_PRICE,T1.gst_percentage,(T1.igst_amount+ T1.cgst_amount+T1.sgst_amount) as gst_amount, 
			SN.ARTICLE_NO,SN.ARTICLE_NAME  
			,S1.BARCODE_CODING_SCHEME AS CODING_SCHEME,SN.SECTION_NAME,SN.SUB_SECTION_NAME,  
			'+@CPARANAME+'  
			,SN.sn_article_desc as ARTICLE_DESC,B.CN_NO,B.CN_DT,B.RECEIPT_DT,FR.FORM_NAME,  
			sn. uom as  UOM_NAME,T1.QUANTITY,S1.MRP,T1.RATE ,T1.DISCOUNT_PERCENTAGE,T1.DISCOUNT_AMOUNT,T1.NET_RATE,  
			sn.article_alias AS ARTICLE_ALIAS,S1.ONLINE_PRODUCT_CODE,S1.VENDOR_EAN_NO ,  
			T1.HSN_CODE,(CASE WHEN CHARINDEX(''@'',S1.PRODUCT_CODE)>1 THEN LEFT(S1.PRODUCT_CODE,CHARINDEX(''@'',S1.PRODUCT_CODE)-1) ELSE S1.PRODUCT_CODE END) AS PRODUCT_CODE1 ,  
			sn.ATTR1_KEY_NAME ,sn.ATTR2_KEY_NAME ,sn.ATTR3_KEY_NAME ,sn.ATTR4_KEY_NAME ,sn.ATTR5_KEY_NAME ,sn.ATTR6_KEY_NAME ,sn.ATTR7_KEY_NAME ,sn.ATTR8_KEY_NAME ,sn.ATTR9_KEY_NAME ,sn.ATTR10_KEY_NAME ,  
			sn.ATTR11_KEY_NAME ,sn.ATTR12_KEY_NAME ,sn.ATTR13_KEY_NAME ,sn.ATTR14_KEY_NAME ,sn.ATTR15_KEY_NAME ,sn.ATTR16_KEY_NAME ,sn.ATTR17_KEY_NAME ,sn.ATTR18_KEY_NAME ,sn.ATTR19_KEY_NAME ,  
			sn.ATTR20_KEY_NAME ,sn.ATTR21_KEY_NAME ,sn.ATTR22_KEY_NAME ,sn.ATTR23_KEY_NAME ,sn.ATTR24_KEY_NAME ,sn.ATTR25_KEY_NAME ,S1.FIX_MRP  ,T1.inv_no AS BILL_NO,T1.inv_dt as BILL_DT
			FROM cnd01106 T1 (NOLOCK)  
			JOIN CNM01106 B (NOLOCK)  ON B.CN_ID=T1.CN_ID   
			JOIN SKU S1 (NOLOCK) ON S1.PRODUCT_CODE=T1.PRODUCT_CODE     
			JOIN SKU_NAMES SN (NOLOCK) ON SN.PRODUCT_CODE =S1.PRODUCT_CODE   
			LEFT JOIN FORM FR (NOLOCK)ON T1.ITEM_FORM_ID= FR.FORM_ID   
			JOIN LM01106 L (NOLOCK) ON L.AC_CODE = S1.AC_CODE   
			WHERE T1.CN_ID = '''+ @CMEMOID+''' '  
			PRINT @DTSQL  
			EXEC SP_EXECUTESQL @DTSQL  

	END
	ELSE IF @nQueryMode=4 
	BEGIN
		exec SP_PURCHASEORDER 20,@CMEMOID
	END
		
END

