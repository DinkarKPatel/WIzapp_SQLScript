CREATE PROCEDURE SPPPC_FG_REC_BAROCDE_NEW  
(  
 @NQUERYID INT=0,  
 @CAGENCY_CODE VARCHAR(100)='',  
 @CPRODUCT_CODE VARCHAR(100)='',
 @NRETURN INT=0,
 @CORDER_ID VARCHAR(100)=''
 
)  
AS  
BEGIN  
 IF @NQUERYID=1  
    GOTO LBLAGENCY 
 ELSE IF @NQUERYID=2  
    GOTO LBLPRODUCT
 ELSE IF @NQUERYID=3  
    GOTO LBLJOBS
 ELSE  
 GOTO END_PROC  
 
 LBLAGENCY:
     
      SELECT DISTINCT A.AC_CODE,B.AC_NAME
      FROM PPC_AGENCY_ISSUE_FG_MST A
      JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
      WHERE A.CANCELLED=0
      UNION
      SELECT DISTINCT A.AC_CODE,B.AC_NAME
      FROM PPC_AGENCY_ISSUE_FG_FIRST_MST A
      JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
      WHERE A.CANCELLED=0
 
 GOTO END_PROC
 LBLPRODUCT:    
      IF OBJECT_ID ('TEMPDB..#TMPREC','U') IS NOT NULL
          DROP TABLE #TMPREC
      SELECT CAST(1 AS BIT) AS CHK,
	         CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
	         ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
	         ART_ROW_ID=ART.ARTICLE_NO+SG.SIZEGROUP_NAME+P1.PARA1_NAME ,
	         A.AC_CODE,LM.AC_NAME ,
	         OM.BILL_NO,
			 B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
			 B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
			 B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
			 B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
			 SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
			 IM.JOB_CODE,
			 JOBS.JOB_NAME,
			 ID.PRODUCT_CODE,
		     1  AS QUANTITY,
			 PMT.QUANTITY_IN_STOCK,
			 CAST(0 AS NUMERIC(10,2)) AS RATE,
		     CAST(0 AS NUMERIC(10,2)) AS AMOUNT,
		     ID.ROW_ID AS REF_ROW_ID ,
		     OM.ROW_ID AS BO_ROW_ID
		INTO #TMPREC
		FROM PPC_FGBCG_MST A
		JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
		JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
		JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE 
		JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
		JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
		JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
		JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
		JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
		JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
		JOIN PPC_AGENCY_ISSUE_FG_DET ID ON ID.PRODUCT_CODE=PMT.PRODUCT_CODE
		JOIN PPC_AGENCY_ISSUE_FG_MST IM ON ID.MEMO_ID=IM.MEMO_ID
		JOIN 
		(
		 SELECT ROW_ID,BILL_NO FROM PPC_BUYER_ORDER_MST A
		 JOIN PPC_BUYER_ORDER_DET B ON A.ORDER_ID =B.ORDER_ID 
		 WHERE A.CANCELLED =0
		 AND (@CORDER_ID='' OR A.ORDER_ID =@CORDER_ID)
		) OM ON OM.ROW_ID =B.BO_DET_ROW_ID 
		LEFT OUTER JOIN
		(
			SELECT A.REF_ROW_ID, B.AC_CODE ,A.PRODUCT_CODE ,B.JOB_CODE ,A.QUANTITY  
			FROM PPC_AGENCY_REC_FG_DET A
			JOIN PPC_AGENCY_REC_FG_MST B ON A.MEMO_ID =B.MEMO_ID 
			WHERE B.CANCELLED =0 
			AND (@CPRODUCT_CODE='' OR  A.PRODUCT_CODE =@CPRODUCT_CODE)
			AND B.AC_CODE =@CAGENCY_CODE 
		) REC ON REC.AC_CODE =IM.AC_CODE 
		AND REC.PRODUCT_CODE =ID.PRODUCT_CODE 
		AND IM.JOB_CODE =REC.JOB_CODE 
		AND ID.ROW_ID=REC.REF_ROW_ID
		JOIN JOBS ON JOBS.JOB_CODE=IM.JOB_CODE
		WHERE PMT.QUANTITY_IN_STOCK=0 AND IM.CANCELLED=0
		AND (@CPRODUCT_CODE='' OR PMT.PRODUCT_CODE=@CPRODUCT_CODE)
				--AND JOBS.JOB_CODE=@CJOB_CODE
		AND IM.AC_CODE=@CAGENCY_CODE
		AND ISNULL(IM.APPROVED,0)=1
		--AND SKU.PARA2_CODE<>'0000000'
		AND REC.PRODUCT_CODE IS NULL
		UNION ALL
		SELECT CAST(1 AS BIT) AS CHK,
			   CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
			   ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
			   ART_ROW_ID=ART.ARTICLE_NO+SG.SIZEGROUP_NAME+P1.PARA1_NAME ,
			   A.AC_CODE,LM.AC_NAME ,
			   OM.BILL_NO,
			   B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
			   B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
			   B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
			   B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
			   SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
			   JOBS.JOB_CODE,
			   JOBS.JOB_NAME,
			   ID.PRODUCT_CODE,
			   1 AS QUANTITY,
			   PMT.QUANTITY_IN_STOCK,
			   CAST(0 AS NUMERIC(10,2)) AS RATE,
			   CAST(0 AS NUMERIC(10,2)) AS AMOUNT ,
			 ID.ROW_ID AS REF_ROW_ID,
			   OM.ROW_ID AS BO_ROW_ID
		  FROM PPC_FGBCG_MST A
		  JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
		  JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
		  JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE 
		  JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
		  JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
		  JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
		  JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
		  JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
		  JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
		  JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET ID ON ID.PRODUCT_CODE=PMT.PRODUCT_CODE
		  JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST IM ON ID.MEMO_ID=IM.MEMO_ID
		  JOIN 
		(
		 SELECT ROW_ID,BILL_NO FROM PPC_BUYER_ORDER_MST A
		 JOIN PPC_BUYER_ORDER_DET B ON A.ORDER_ID =B.ORDER_ID 
		 WHERE A.CANCELLED =0
		  AND (@CORDER_ID='' OR A.ORDER_ID =@CORDER_ID)
		) OM ON OM.ROW_ID =B.BO_DET_ROW_ID 
		  LEFT OUTER JOIN
		 (
			SELECT A.REF_ROW_ID,B.AC_CODE ,A.PRODUCT_CODE ,B.JOB_CODE ,A.QUANTITY  
			FROM PPC_AGENCY_REC_FG_DET A
		    JOIN PPC_AGENCY_REC_FG_MST B ON A.MEMO_ID =B.MEMO_ID 
			WHERE B.CANCELLED =0 
			AND (@CPRODUCT_CODE='' OR  A.PRODUCT_CODE =@CPRODUCT_CODE)
			AND B.AC_CODE =@CAGENCY_CODE 
		) REC ON REC.AC_CODE =IM.AC_CODE 
		AND REC.PRODUCT_CODE =ID.PRODUCT_CODE 
		AND IM.JOB_CODE =REC.JOB_CODE 
		AND ID.ROW_ID=REC.REF_ROW_ID
		JOIN JOBS ON JOBS.JOB_CODE=IM.JOB_CODE
		WHERE PMT.QUANTITY_IN_STOCK=0 AND IM.CANCELLED=0
		AND (@CPRODUCT_CODE='' OR  PMT.PRODUCT_CODE=@CPRODUCT_CODE)
		AND ISNULL(IM.APPROVED,0)=1
	--	AND SKU.PARA2_CODE<>'0000000'
		--AND JOBS.JOB_CODE=@CJOB_CODE
		AND IM.AC_CODE=@CAGENCY_CODE
		AND REC.PRODUCT_CODE IS NULL
		
		
		SELECT DISTINCT CAST(1 AS BIT) AS CHK,
	         CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
	        -- ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
			 B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
			 B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
			 B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
			 SKU.PARA2_CODE,P2.PARA2_NAME ,
			 CAST(0 AS NUMERIC(10,0)) AS QUANTITY,
			 CAST(0 AS NUMERIC(10,0)) AS MISSING_QTY,
			 TMP.BO_ROW_ID
		FROM PPC_FGBCG_MST A
		JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
		JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
		JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE 
		JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
		JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
		JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
		JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
		JOIN #TMPREC TMP ON TMP.ARTICLE_CODE=B.ARTICLE_CODE AND TMP.PARA1_CODE =B.PARA1_CODE AND TMP.SIZEGROUP_CODE =B.SIZEGROUP_CODE
		AND B.BO_DET_ROW_ID=TMP.BO_ROW_ID
		--WHERE SKU.PARA2_CODE<>'0000000'
		
		
		
		SELECT CHK,
	         MEMO_ID,
	         ROW_ID,
	         ART_ROW_ID,
	         A.AC_CODE,A.AC_NAME ,
	         A.BILL_NO,
			 A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,
			 A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,
			 A.PARA1_CODE,A.COLOR,
			 A.PARA3_CODE,A.BUYER_STYLE_NO,
			 A.PARA2_CODE,A.SIZE,
			 A.JOB_CODE,
			 A.JOB_NAME,
			 A.PRODUCT_CODE,
		     A.QUANTITY,
		     CAST(0 AS NUMERIC(10,0)) AS PHY_QTY,
		     CAST(1 AS NUMERIC(10,0)) AS SCAN_QTY,
		     CAST(0 AS NUMERIC(10,0)) AS BAL_QTY,
			 A.QUANTITY_IN_STOCK,
			 A.RATE,
		     A.AMOUNT ,
		     A.REF_ROW_ID ,
		     A.BO_ROW_ID
		  FROM #TMPREC A
		  
		  
		  
	   
 
 
 GOTO END_PROC
       
       
    LBLJOBS: --FOR REC
        
       SELECT  JOBS.JOB_CODE,JOBS.JOB_NAME,0 AS JOB_ORDER    
       FROM PPC_AGENCY_ISSUE_FG_MST A  
       JOIN PPC_AGENCY_ISSUE_FG_DET B ON A.MEMO_ID =B.MEMO_ID
       JOIN JOBS ON JOBS.JOB_CODE=A.JOB_CODE  
       WHERE  (@CAGENCY_CODE  ='' OR A.AC_CODE  =@CAGENCY_CODE ) 
       AND CANCELLED=0   
       GROUP BY JOBS.JOB_CODE,JOBS.JOB_NAME  
       UNION 
       SELECT  JOBS.JOB_CODE,JOBS.JOB_NAME,0 AS JOB_ORDER    
       FROM PPC_AGENCY_ISSUE_FG_FIRST_MST A  
       JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET B ON A.MEMO_ID =B.MEMO_ID
       JOIN JOBS ON JOBS.JOB_CODE=A.JOB_CODE  
       WHERE  (@CAGENCY_CODE  ='' OR A.AC_CODE  =@CAGENCY_CODE ) 
       AND CANCELLED=0   
       GROUP BY JOBS.JOB_CODE,JOBS.JOB_NAME     
          
     GOTO END_PROC
     
 END_PROC:
   
 END
