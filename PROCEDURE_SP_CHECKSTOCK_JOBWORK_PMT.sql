create PROCEDURE SP_CHECKSTOCK_JOBWORK_PMT    
 @NARTICLE_PRD_MODE INT=1,--1 FOR INDIVISUAL 2 FOR (SET & COMPONENT)
 @CPRODUCTCODE VARCHAR(50),    
 @BDONOTCHECKSTOCK BIT=0,    
 @CDEPT_ID  VARCHAR(5)='', 
 @CWHERE VARCHAR(40)='',  
 @NQTY NUMERIC(14,2)=0,  
 @CUSERCODE VARCHAR(10),
 @CSP_ID varchar(40)=''
AS    
BEGIN    
   
   DECLARE @JOB_CARD_TYPE VARCHAR(10),@CERRMSG VARCHAR(100)-- 1 FOR COMPONENT BASED 2 FOR RM BASED
   --SELECT TOP 1 @JOB_CARD_TYPE=VALUE  FROM CONFIG WHERE CONFIG_OPTION ='JOB_CARD_COMPONENT_BASED' 
	
	SET @CERRMSG=''   
	--IF ISNULL(@JOB_CARD_TYPE,'')<>'1'
	--   SET @JOB_CARD_TYPE=''
	
	if @CPRODUCTCODE<>''
	begin
	  
	      set @CSP_ID=@@SPID 
		  delete from TTM_BARCODE where sp_id=@CSP_ID
		  INSERT INTO TTM_BARCODE(PRODUCT_CODE,QUANTITY,SP_ID)
		  SELECT @CPRODUCTCODE,1 AS QUANTITY,@CSP_ID AS SP_ID
	end

     
 IF  EXISTS(	SELECT A.PRODUCT_CODE  FROM  TTM_BARCODE A (nolock) LEFT JOIN SKU B (nolock) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
 WHERE A.SP_ID =@CSP_ID AND B.PRODUCT_CODE IS NULL )      
  SET @CERRMSG= 'SELECTED BARCODE NOT FOUND....PLEASE CHECK'    
 
  SELECT A.PRODUCT_CODE, A.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, A.PARA1_CODE,      
				C.PARA1_NAME, A.PARA2_CODE, D.PARA2_NAME, A.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,         
				ISNULL(PMT.DEPT_ID, '') AS DEPT_ID, A.BARCODE_CODING_SCHEME AS CODING_SCHEME,  B.INACTIVE,
				CASE WHEN (B.STOCK_NA =1 OR ISNULL(B.ARTICLE_PRD_MODE,0) =2) THEN 99 ELSE 
					ISNULL(PMT.QUANTITY_IN_STOCK,0) END 
				 AS QUANTITY_IN_STOCK,      
				A.PURCHASE_PRICE,
				A.MRP AS [MRP],    
				A.WS_PRICE  AS WS_PRICE,       
				'' AS SCHEME_ID, SM.SECTION_NAME, SD.SUB_SECTION_NAME,      
				A.PARA4_CODE,A.PARA5_CODE,A.PARA6_CODE,      
				PARA4_NAME,PARA5_NAME,PARA6_NAME,B.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],      
				B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],A.DT_CREATED AS [SKU_DT_CREATED],      
				CASE WHEN ISNULL(B.ARTICLE_PRD_MODE,0) =2 THEN 1 ELSE B.STOCK_NA END AS STOCK_NA,
				'' AS EAN,  
				A.FORM_ID,'' AS FORM_NAME,0 AS TAX_PERCENTAGE , A.PRODUCT_NAME,  
				A.MRP AS RATE,A.ER_FLAG,ISNULL(A.FIX_MRP,0) AS [FIX_MRP] ,'' AS AC_NAME  
				,A.INV_DT,A.RECEIPT_DT ,'0000000000' as AC_CODE,B.ALIAS AS [ARTICLE_ALIAS],
				ISNULL(PMT.BIN_ID, @CDEPT_ID) AS [BIN_ID],ISNULL(BIN.BIN_NAME, '') AS [BIN_NAME],'' AS [WIP_UID],
				0 AS LANDED_COST,A.ONLINE_PRODUCT_CODE AS ONLINE_BAR_CODE,
				A.VENDOR_EAN_NO,A.HSN_CODE,SM.ITEM_TYPE,bc.quantity ,
				cast('' as varchar(100)) as jobcard_id
 
  INTO #SP_CHECKSTOCK  
  FROM SKU A   (NOLOCK)     
  JOIN JOBWORK_PMT PMT  (NOLOCK) ON A.PRODUCT_CODE=PMT.PRODUCT_CODE  
  LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=ISNULL(PMT.BIN_ID, '')
  JOIN ARTICLE B  (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE        
  JOIN SECTIOND SD  (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE      
  JOIN SECTIONM SM  (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE      
  JOIN PARA1 C  (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE        
  JOIN PARA2 D  (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE        
  JOIN PARA3 F  (NOLOCK) ON A.PARA3_CODE = F.PARA3_CODE        
  JOIN PARA4 G  (NOLOCK) ON A.PARA4_CODE = G.PARA4_CODE        
  JOIN PARA5 H  (NOLOCK) ON A.PARA5_CODE = H.PARA5_CODE        
  JOIN PARA6 I  (NOLOCK) ON A.PARA6_CODE = I.PARA6_CODE           
  JOIN UOM E  (NOLOCK) ON B.UOM_CODE = E.UOM_CODE  
  join TTM_BARCODE BC (nolock) on bc.product_code =a.product_code 
  WHERE bc.SP_ID = @CSP_ID and 
  ((@NARTICLE_PRD_MODE=1 AND B.ARTICLE_PRD_MODE=1) OR ((@NARTICLE_PRD_MODE=2) AND B.ARTICLE_PRD_MODE IN(2,3) ) ) 
  
  
  IF EXISTS (SELECT TOP 1 'U' FROM #SP_CHECKSTOCK WHERE QUANTITY_IN_STOCK <=0 )
  SET @CERRMSG='BARCODE NOT IN STOCK'
  
  if @CPRODUCTCODE<>''
  SELECT @CERRMSG AS RETMSG
  
  SELECT * ,@CERRMSG AS RETMSG
  FROM #SP_CHECKSTOCK A

    delete from TTM_BARCODE where sp_id=@CSP_ID
  
       
END
