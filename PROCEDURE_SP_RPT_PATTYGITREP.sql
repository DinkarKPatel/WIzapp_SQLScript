--SELECT * FROM LOCATION
--EXEC SP_RPT_PATTYGITREP '2015-09-20'
CREATE PROCEDURE SP_RPT_PATTYGITREP--(LocId 3 digit change by Sanjay:30-10-2024)
(   
@DTODT DATETIME ,    
@CSOURCEDEPTID VARCHAR(4)='',    
@CTARGETDEPTID VARCHAR(4)='',  
@NDUEDAYS INT=0
)     
AS    
BEGIN    
  DECLARE @CCUTOFFDATE VARCHAR(100)    
      
  SELECT TOP 1 @CCUTOFFDATE=VALUE FROM CONFIG WHERE CONFIG_OPTION='GIT_CUT_OFF_DATE'    
      
  SET @CCUTOFFDATE=ISNULL(@CCUTOFFDATE,'')    
      
  IF @CTARGETDEPTID=''	       
	SELECT C.DEPT_ID AS [TARGET_DEPT_ID],C.DEPT_NAME AS   [TARGET_DEPT_NAME],    
    C1.DEPT_ID AS [SOURCE_DEPT_ID],C1.DEPT_NAME AS   [SOURCE_DEPT_NAME],      
    PO.MEMO_NO AS SOURCE_CHALLAN_NO,    
    CONVERT(VARCHAR,PO.MEMO_DT,105) AS SOURCE_CHALLAN_DT,PO.AMOUNT AS CAL_GIT_VALUE,       
    DATEDIFF(DD,PO.MEMO_DT,@DTODT) AS DUEDAYS      
	FROM PCO_MST PO 
	LEFT JOIN PCI_MST A ON PO.MEMO_ID=A.MEMO_ID  
	JOIN LOCATION C ON C.DEPT_ID=po.target_location_Code   
	JOIN LOCATION C1 ON C1.DEPT_ID=a.location_Code
	WHERE po.cancelled=0 and (A.MEMO_ID IS NULL OR ISNULL(A.RECEIPT_DT,'')='')--PO.MEMO_DT <= @DTODT  --AND A.MEMO_DT>=(CASE WHEN @CCUTOFFDATE<>'' THEN @CCUTOFFDATE ELSE A.MEMO_DT END) 
  ELSE
	SELECT C.DEPT_ID AS [TARGET_DEPT_ID],C.DEPT_NAME AS   [TARGET_DEPT_NAME],    
    C1.DEPT_ID AS [SOURCE_DEPT_ID],C1.DEPT_NAME AS   [SOURCE_DEPT_NAME],      
    PO.MEMO_NO AS SOURCE_CHALLAN_NO,    
    CONVERT(VARCHAR,PO.MEMO_DT,105) AS SOURCE_CHALLAN_DT,PO.AMOUNT AS CAL_GIT_VALUE,       
    DATEDIFF(DD,PO.MEMO_DT,@DTODT) AS DUEDAYS      
	FROM PCO_MST PO 
	LEFT JOIN  PCI_MST A ON PO.MEMO_ID=A.MEMO_ID  
	JOIN LOCATION C ON C.DEPT_ID=po.location_Code
	JOIN LOCATION C1 ON C1.DEPT_ID=po.target_location_Code
	WHERE (A.MEMO_ID IS NULL OR ISNULL(A.RECEIPT_DT,'')='')--PO.MEMO_DT <= @DTODT  --AND A.MEMO_DT>=(CASE WHEN @CCUTOFFDATE<>'' THEN @CCUTOFFDATE ELSE A.MEMO_DT END) 
	AND C.DEPT_ID=@CTARGETDEPTID and po.cancelled=0 
 END    
----- 'END OF CREATING PROCEDURE SP_RPT_PATTYGITREP'
