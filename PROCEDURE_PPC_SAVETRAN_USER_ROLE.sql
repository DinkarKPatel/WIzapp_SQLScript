CREATE PROC PPC_SAVETRAN_USER_ROLE  
(    
 @NUPDATEMODE INT,
 @NSPID INT,
 @CROLE_ID VARCHAR (10)=''                  
)  
------WITH ENCRYPTION  
AS  
BEGIN  
  DECLARE @CMASTERTABLENAME VARCHAR(100),  
          @CTEMPMASTERTABLE VARCHAR(100),  
          @CTEMPDBNAME VARCHAR(100),    
          @NSTEP VARCHAR(10),  
          @BENABLETEMPDB BIT,  
          @CERRORMSG VARCHAR(500),  
          @CKEYFIELD VARCHAR(22),   
          @NCKEYFIELDLEN INT,    
          @NSAVETRANLOOP BIT,  
          @CCMD NVARCHAR(MAX),  
          @CMEMODEPTID VARCHAR(2),  
          @CNEW_ROLE_ID VARCHAR(7)  
      
    DECLARE @OUTPUT TABLE(ERRMSG VARCHAR(2000),CAT_ID VARCHAR(22))  
    SET @NSTEP = 0  -- SETTTING UP ENVIRONMENT    
    
 
   SET @CTEMPDBNAME = ''   
   SET @CMASTERTABLENAME ='USER_ROLE_MST'    
    
   SET @CTEMPMASTERTABLE  ='MST_USER_ROLE_MST_UPLOAD'  
 
   SET @CKEYFIELD = 'ROLE_ID'  
         SET @NCKEYFIELDLEN = 7  
         SET @NSTEP = 10  -- BEGIN TRANSACTION      
 
   BEGIN TRANSACTION  
   BEGIN TRY       
     SET @NSTEP = 30  --CALL FROM ADD MODE  
  IF @NUPDATEMODE = 1  
  BEGIN  
     SET @NSAVETRANLOOP=0  
     WHILE @NSAVETRANLOOP=0  
     BEGIN  
      --EXEC GETNEXTKEY @CMASTERTABLENAME, @CKEYFIELD, @NCKEYFIELDLEN, '01', 1,@CFINYEAR='',@NROWCOUNT=0, @CNEW_ROLE_ID OUTPUT     
      EXEC GETNEXTKEY @CMASTERTABLENAME, @CKEYFIELD, @NCKEYFIELDLEN, '', 1,'',0,@CNEW_ROLE_ID OUTPUT     
      SET @CCMD= N'IF EXISTS(SELECT '+@CKEYFIELD+' FROM '+@CMASTERTABLENAME+' WHERE '+@CKEYFIELD+' = '''+@CNEW_ROLE_ID+''')  
          SET @NLOOPOUTPUT=0  
          ELSE  
          SET @NLOOPOUTPUT=1'  
      PRINT @CCMD  
      EXEC SP_EXECUTESQL @CCMD,N'@NLOOPOUTPUT BIT OUTPUT',@NLOOPOUTPUT=@NSAVETRANLOOP OUTPUT  
     END  
     SET @NSTEP = 40   
     --SET @CNEW_ROLE_ID = @CLOCID + @CFINYEAR+ REPLICATE('0', 15-LEN(LTRIM(RTRIM(@CNEW_CALL_CODE1)))) + LTRIM(RTRIM(@CNEW_CALL_CODE1))     
     IF @CNEW_ROLE_ID IS NULL    
     BEGIN  
        SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR CREATING NEXT USER CODE....'  
        GOTO END_PROC      
     END  
       
     SET @NSTEP = 60 -- UPDATING NEW ID INTO TEMP TABLES  
     SET @CCMD=N'UPDATE '+@CTEMPMASTERTABLE+' SET '+@CKEYFIELD+'='''+@CNEW_ROLE_ID+'''  WHERE SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''  
     PRINT @CCMD   
     EXEC SP_EXECUTESQL @CCMD   
       
 
  END--END FROM ADD MODE  
  ELSE  
  BEGIN--CALL FROM EDIT AND CANCELLED MODE  
       SET @NSTEP = 80  -- GETTING MEMO ID FROM TEMP TABLE  
       SET @CCMD=N'SELECT @CNEW_ROLE_ID='+@CKEYFIELD+' FROM ' +@CMASTERTABLENAME+ ' WHERE ROLE_ID= '''+@CROLE_ID+''' AND SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''   
       PRINT @CCMD  
       EXEC SP_EXECUTESQL @CCMD,N'@CNEW_ROLE_ID VARCHAR(7) OUTPUT',@CNEW_ROLE_ID OUTPUT  
         
       SET @NSTEP = 90  
       IF @CNEW_ROLE_ID IS NULL    
       BEGIN  
         
         SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR PLEASE ENTER USERS CODE FOR UPDATING....'   
         GOTO END_PROC      
         
       END         
  END  
   
 
	  SET @NSTEP = 140  
	  IF LTRIM(RTRIM(ISNULL(@CNEW_ROLE_ID,'LATER'))) = 'LATER'  
	  BEGIN  
	   SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR CREATING NEXT USERS_CODE....'  
	   GOTO END_PROC  
	  END  
	    
	  SET @NSTEP = 160  
	  
	   DECLARE @FILTER VARCHAR(MAX)
	SET @FILTER=' B.SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
		     
		 -- UPDATING MASTER TABLE FROM TEMP TABLE  
	  IF @NUPDATEMODE = 1 OR @NUPDATEMODE = 2  
	  BEGIN  
	    
		EXEC UPDATEMASTERXN   
		   @CSOURCEDB = ''  
		 , @CSOURCETABLE = @CTEMPMASTERTABLE  
		 , @CDESTDB  = ''  
		 , @CDESTTABLE = @CMASTERTABLENAME  
		 , @CKEYFIELD1 = @CKEYFIELD  
		 , @BALWAYSUPDATE = 1  
		 ,@CFILTERCONDITION=@FILTER
	       
	   
	   END
   END TRY  
   BEGIN CATCH  
    SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()  
    GOTO END_PROC  
    END CATCH  
END_PROC:  

--SELECT * FROM USERS WHERE USER_CODE ='0000010'
  IF @@TRANCOUNT>0  
  BEGIN  
   IF ISNULL(@CERRORMSG,'')=''  
    COMMIT TRANSACTION  
   ELSE  
    ROLLBACK    
  END   
  IF ISNULL(@CERRORMSG,'')=''  
  BEGIN

    DELETE FROM MST_USER_ROLE_MST_UPLOAD WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID)))
  END
   
                  
  SELECT ISNULL(@CERRORMSG,'') AS ERRMSG,@CNEW_ROLE_ID AS ROLE_ID 
END  
----'END OF  PROCEDURE SAVETRAN_USERS'
