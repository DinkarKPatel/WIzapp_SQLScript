CREATE FUNCTION FN_GET_PLHEADCODE ( @CHEADCODE CHAR(10) )
RETURNS CHAR(10)
--WITH ENCRYPTION
AS 
BEGIN
	DECLARE @CRETVAL VARCHAR(MAX),@CTEMPHEADCODE VARCHAR(10)
	
	SET @CRETVAL = ''

	DECLARE ABC CURSOR FOR 
	SELECT A.MAJOR_HEAD_CODE FROM HD01106 A (NOLOCK)  
	JOIN HD01106 B ON A.MAJOR_HEAD_CODE=B.HEAD_CODE
	WHERE A.HEAD_CODE = @CHEADCODE AND B.MAJOR_HEAD_CODE<>B.HEAD_CODE
	AND a.head_code NOT IN ('0000000026','0000000027','0000000028','0000000029','0000000030')

	OPEN ABC
	FETCH NEXT FROM ABC INTO @CTEMPHEADCODE
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @CRETVAL = DBO.FN_GET_PLHEADCODE( @CTEMPHEADCODE )
		
		IF @CRETVAL=''
		BEGIN
			SET @CRETVAL=@CTEMPHEADCODE
			BREAK
		END	
		FETCH NEXT FROM ABC INTO @CTEMPHEADCODE
	END
	CLOSE ABC
	DEALLOCATE ABC
	
	IF @CRETVAL=''
		SELECT @CRETVAL=@CHEADCODE
		
	RETURN @CRETVAL
END