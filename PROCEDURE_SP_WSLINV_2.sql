CREATE PROCEDURE SP_WSLINV_2--(LocId 3 digit change by Sanjay:04-11-2024)
	@CMEMOID	VARCHAR(40) = '',
	@CWHERE1	VARCHAR(500) = '',
	@NNAVMODE	NUMERIC(1,0) = 0,
	@CWHERE2	NVARCHAR(MAX)='',
	@DMEMODT DATETIME='',
	@CLOCID		VARCHAR(4)=''
----WITH ENCRYPTION
AS
BEGIN
 	
	 IF OBJECT_ID('#TEMPDB..#TMPGPMEMO','U') IS NOT NULL
		DROP TABLE #TMPGPMEMO
	 
	 ;WITH CTE AS
	 (
	 SELECT B.INV_ID,A.MEMO_NO AS GP_ISSUE_NO ,A.MEMO_ID AS GP_ISSUE_ID,A.MEMO_DT ,
			ROW_NUMBER() OVER (PARTITION BY B.INV_ID ORDER BY A.LAST_UPDATE DESC) AS SR
	 FROM TBL_GP_ISSUE_MST A
	 JOIN   TBL_GP_ISSUE_DET B ON A.MEMO_ID=B.MEMO_ID
	 JOIN INM01106 INM ON INM.INV_ID=B.INV_ID 
	 WHERE A.CANCELLED =0 AND INM.INV_ID=@CMEMOID
	 )
	 SELECT * INTO #TMPGPMEMO FROM CTE WHERE SR=1
	--
	SELECT CAST((CASE WHEN T1.XN_ITEM_TYPE IN (1,4,2) THEN ISNULL(LOC.Enable_EInvoice,0) ELSE 0 END) AS BIT) AS Enable_EInvoice,
	ISNULL(LOC.loc_gst_no,'') AS loc_gst_no,(CASE WHEN T1.Inv_mode=2 THEN ISNULL(T6.loc_gst_no,'') ELSE ISNULL(T4.Ac_gst_no,'') END) AS [PARTY_GST_NO]
	 ,(CASE WHEN T1.shipping_same_as_billing_Add<>1 THEN ISNULL(SHIP.address0,T1.Shipping_address) ELSE '' END) AS Shipping_address, 
	(CASE WHEN T1.shipping_same_as_billing_Add<>1 THEN ISNULL(SHIP.address1,T1.shipping_address2) ELSE '' END) AS shipping_address2,
	(CASE WHEN T1.shipping_same_as_billing_Add<>1 THEN ISNULL(SHIP.address2,T1.shipping_address3) ELSE '' END) AS shipping_address3
	,(CASE WHEN T1.shipping_same_as_billing_Add<>1 THEN ISNULL(SHIP.AREA_NAME,T1.SHIPPING_AREA_NAME) ELSE '' END) AS SHIPPING_AREA_NAME
	 ,(CASE WHEN T1.shipping_same_as_billing_Add<>1 THEN ISNULL(SHIP.CITY,T1.SHIPPING_CITY_NAME) ELSE '' END) AS SHIPPING_CITY_NAME
	 ,(CASE WHEN T1.shipping_same_as_billing_Add<>1 THEN ISNULL(SHIP.STATE,T1.SHIPPING_STATE_NAME) ELSE '' END) AS SHIPPING_STATE_NAME
	 ,   ISNULL(X.emp_code,'0000000') AS [emp_code],ISNULL(x.emp_code1,'0000000')  AS [emp_code1],
   ISNULL(x.emp_code2,'0000000') as [emp_code2],ISNULL(x.emp_name,'') AS [emp_name],
   ISNULL(x.emp_name1,'') AS [emp_name1],ISNULL(x.emp_name2,'') AS [emp_name2]
	,T1.*,T2.USERNAME,
	 T4.AC_NAME,T4.ADDRESS0,T4.ADDRESS1,T4.ADDRESS2,         
	 T4.AREA_NAME,T4.CITY,T4.[STATE],T4.PINCODE, T5.EMP_NAME,ISNULL(T6.DEPT_NAME,'') AS DEPT_NAME        
	 ,ISNULL(DTM.DT_NAME,'') AS DT_NAME,ISNULL(T7.AC_NAME,'') AS BROKER_AC_NAME,  
	 CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT, BIN.BIN_NAME,CONVERT(NUMERIC(10,2), 0 )AS TOTAL_CUSTOM_DUTY_AMOUNT, 
	 T4.INV_RATE_TYPE, T4.RESTRICT_PUR_ENTRY,
	 T4.DEFAULT_RATE_TYPE AS LEDGER_DEFAULT_RATE_TYPE ,ISNULL(T4.WSL_RATE_CALC_METHOD,1) AS WSL_RATE_CALC_METHOD,         
	 ISNULL(T4.PURCHASE_AGAINST_TERMS,0) AS [PURCHASE_AGAINST_TERMS],
	 T.TERMS_NAME ,T4.E_MAIL,T4.e_mail_cc ,
	 ISNULL(GP.GP_ISSUE_NO,'') AS GP_ISSUE_NO,
	 ISNULL(GP.GP_ISSUE_ID,'') AS GP_ISSUE_ID,
	 ST.GST_STATE_NAME AS PARTY_STATE_NAME,
	 CAST('' AS VARCHAR(40)) AS SP_ID,(CASE WHEN T1.shipping_same_as_billing_Add<>1 THEN ISNULL(SHIP.AC_NAME,'') ELSE '' END) AS SHIPPING_AC_NAME
	 ,CAST(0 AS NUMERIC(14,2)) AS  cr_discount_percentage
	 ,T4.Ac_gst_no AS [GST_NO] 
	 ,(CASE WHEN T1.shipping_same_as_billing_Add<>1 THEN ISNULL(SHIP.Ac_gst_no,'') ELSE '' END) AS [SHIP_GST_NO] ,AR.TDS_Name as BROKER_TDS_NAME,
	 ISNULL(T1.FREIGHT_CGST_AMOUNT,0)+ISNULL(T1.FREIGHT_SGST_AMOUNT,0) +ISNULL(T1.FREIGHT_IGST_AMOUNT,0) AS  FREIGHT_GST_AMT,
     ISNULL(T1.FREIGHT,0)+CASE WHEN ISNULL(T1.OH_TAX_METHOD,0)=1 THEN
     ISNULL(T1.FREIGHT_CGST_AMOUNT,0)+ISNULL(T1.FREIGHT_SGST_AMOUNT,0) +ISNULL(T1.FREIGHT_IGST_AMOUNT,0) 
      ELSE 0 END AS FREIGHT_TOTAL,
     ISNULL(T1.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(T1.OTHER_CHARGES_SGST_AMOUNT,0) +ISNULL(T1.OTHER_CHARGES_IGST_AMOUNT,0) AS  OTHER_CHARGES_GST_AMT,
     ISNULL(T1.OTHER_CHARGES,0)+CASE WHEN ISNULL(T1.OH_TAX_METHOD,0)=1 THEN
     ISNULL(T1.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(T1.OTHER_CHARGES_SGST_AMOUNT,0) +ISNULL(T1.OTHER_CHARGES_IGST_AMOUNT,0)
     ELSE 0 END AS OTHER_CHARGES_TOTAL,FC.FC_NAME AS XN_FC_NAME,ISNULL(T4.lm_remarks,'') AS LEDGER_REMARKS,T4.PARTY_RATE_MEMO_ID
	 ,'' as ecoupon_id,(case when T4.freightPaidBy =2 then 'Party' else 'Company' end) as freightmethod
	 FROM INM01106 T1  (NOLOCK)       
	 JOIN LOCATION LOC  (NOLOCK) ON LOC.dept_id=T1.location_Code
	 LEFT OUTER JOIN USERS T2 (NOLOCK) ON T1.USER_CODE = T2.USER_CODE  
	 LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=T1.TARGET_BIN_ID               
	 JOIN LMV01106 T4 (NOLOCK) ON T4.AC_CODE = T1.AC_CODE        
	 LEFT OUTER JOIN EMPLOYEE T5 (NOLOCK) ON T5.EMP_CODE = T1.EMP_CODE        
	 LEFT OUTER JOIN LOCATION T6 (NOLOCK) ON T6.DEPT_ID = T1.PARTY_DEPT_ID          
	 LEFT JOIN DTM (NOLOCK) ON DTM.DT_CODE = T1.DT_CODE 
	 LEFT OUTER JOIN LMV01106 T7 (NOLOCK) ON T7.AC_CODE = T1.BROKER_AC_CODE   
	 LEFT OUTER JOIN LEDGER_TERMS T ON T.TERMS_CODE=T1.TERMS_CODE  
	 LEFT OUTER JOIN #TMPGPMEMO GP ON GP.INV_ID=T1.INV_ID     
	 LEFT JOIN TDS_Section AR ON T1.broker_tds_code=AR.TDS_Code
	 --LEFT JOIN CITY CT ON CT.CITY_CODE=AR.CITY_CODE
	   LEFT OUTER JOIN GST_STATE_MST ST ON T1.PARTY_STATE_CODE=ST.GST_STATE_CODE
	   LEFT OUTER JOIN LMV01106 SHIP(NOLOCK) ON SHIP.AC_CODE=T1.SHIPPING_AC_CODE
	   LEFT OUTER JOIN fc  (NOLOCK) ON T1.xn_fc_code = fc.fc_code
	   LEFT OUTER JOIN
	  (
		SELECT TOP 1 inv_id,e1.emp_code,e2.emp_code  AS [emp_code1],e3.emp_code as [emp_code2],e1.emp_name AS [emp_name]
		,e2.emp_name AS [emp_name1],e3.emp_name AS [emp_name2]
		FROM ind01106 a (NOLOCK)
		JOIN employee e1 (NOLOCK) ON e1.emp_code=a.emp_code
		JOIN employee e2 (NOLOCK) ON e2.emp_code=a.emp_code1
		JOIN employee e3 (NOLOCK) ON e3.emp_code=a.emp_code2
		WHERE a.inv_id=@CMEMOID AND (a.emp_code<>'0000000' OR a.emp_code2<>'0000000' OR a.emp_code2<>'0000000')
	  )x ON X.inv_id=T1.inv_id
	 WHERE T1.INV_ID = @CMEMOID            
	

eND