CREATE PROCEDURE SP_GENDEPTWISEPMT
(
 @CPMTTABLE VARCHAR(20)
)
--WITH ENCRYPTION
AS
DECLARE @CCMD NVARCHAR(4000)
DECLARE @BFOUND VARCHAR(20)
SET @CCMD= ''

BEGIN

	SET @CCMD= N'SELECT  @BFOUNDOUT = NAME FROM SYSOBJECTS WHERE NAME= '''+@CPMTTABLE+'''' 

	PRINT @CCMD	
	EXEC SP_EXECUTESQL @CCMD, N'@BFOUNDOUT VARCHAR OUTPUT', @BFOUNDOUT = @BFOUND OUTPUT           

	IF ISNULL(@BFOUND,'')= ''
	BEGIN

		SET @CCMD= N' CREATE TABLE '+ @CPMTTABLE + '
					  ( 
						ARTICLE_CODE CHAR(9) NOT NULL,
						PARA1_CODE CHAR(7) NOT NULL,
						PARA2_CODE CHAR(7) NOT NULL,
						QUANTITY_IN_STOCK NUMERIC(10,3) NOT NULL,
						LAST_UPDATE DATETIME NOT NULL,
						WIP NUMERIC(10,3) ,
						TS TIMESTAMP
		                
					  )'
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

		--PRIMARY KEY

		SET @CCMD= N' ALTER TABLE '+ @CPMTTABLE + 
					' ADD CONSTRAINT  PK_'+ @CPMTTABLE +' PRIMARY KEY (ARTICLE_CODE,PARA1_CODE,PARA2_CODE)'
		            
		EXEC SP_EXECUTESQL @CCMD

		--FOREIGN KEY ON ARTICLE_CODE

		SET @CCMD= N' ALTER TABLE '+ @CPMTTABLE + 
					' ADD CONSTRAINT  FK_'+ @CPMTTABLE +'_ARTICLE FOREIGN KEY (ARTICLE_CODE) REFERENCES ARTICLE (ARTICLE_CODE) '
		            
		EXEC SP_EXECUTESQL @CCMD

		--FOREIGN KEY ON PARA1_CODE

		SET @CCMD= N' ALTER TABLE '+ @CPMTTABLE + 
					' ADD CONSTRAINT  FK_'+ @CPMTTABLE +'_PARA1 FOREIGN KEY (PARA1_CODE) REFERENCES PARA1 (PARA1_CODE) '
		            
		EXEC SP_EXECUTESQL @CCMD

		--FOREIGN KEY ON PARA2_CODE

		SET @CCMD= N' ALTER TABLE '+ @CPMTTABLE + 
					' ADD CONSTRAINT  FK_'+ @CPMTTABLE +'_PARA2 FOREIGN KEY (PARA2_CODE) REFERENCES PARA2 (PARA2_CODE) '
		            
		EXEC SP_EXECUTESQL @CCMD

	END

END
