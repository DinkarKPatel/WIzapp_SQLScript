CREATE FUNCTION FN_GETLASTPRICE
(
@CPRODUCTCODE VARCHAR(30),
@CPARTYACCODE CHAR(10),
@DMAXDATE DATETIME,
@NQUANTITY NUMERIC(10,3)
)
  RETURNS @CRETLASTPRICE TABLE  
 (RATE NUMERIC(12,4),DISCOUNT_PERCENTAGE NUMERIC(6,2),INV_QUANTITY NUMERIC(10,3),NET_RATE NUMERIC(12,4),DISCOUNT_AMOUNT NUMERIC(12,4))  	
--WITH ENCRYPTION 
AS
BEGIN
	INSERT @CRETLASTPRICE  SELECT TOP 1 RATE,A.DISCOUNT_PERCENTAGE,  QUANTITY,NET_RATE,
			   (A.DISCOUNT_AMOUNT/A.QUANTITY)*@NQUANTITY AS DISCOUNT_AMOUNT
			   FROM IND01106 A JOIN INM01106 B ON A.INV_ID=B.INV_ID
			   WHERE A.PRODUCT_CODE=@CPRODUCTCODE AND B.CANCELLED=0 AND B.AC_CODE=@CPARTYACCODE
			   AND B.INV_DT<=@DMAXDATE ORDER BY INV_DT DESC	
	
	RETURN 
END
