--- EXEC SP_VALIDATE_IMPORTDATA 'GV',105
CREATE PROCEDURE SP_VALIDATE_IMPORTDATA
@CXNTYPE VARCHAR(10),
@NSPID INT=0,
@CTEMPTABLEPARA VARCHAR(500)='',
@nGvType NUMERIC(1,0)=0,
@nValidationSource NUMERIC(1,0)=0

AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@CTEMPTABLENAME VARCHAR(200),@CERRMSG VARCHAR(1000),
			@CRETMSG NVARCHAR(MAX)
	
	IF @CTEMPTABLEPARA=''	
		SET @CTEMPTABLENAME='TEMP_EXCEL_IMPORT_'+LTRIM(RTRIM(STR(@NSPID)))
	ELSE
		SET @CTEMPTABLENAME=@CTEMPTABLEPARA	

	IF @CXNTYPE='GV'
	BEGIN
		SELECT @CCMD='',@CRETMSG=''
		
		SET @CCMD=N'IF EXISTS (SELECT GV_SCRATCH_NO FROM '+@CTEMPTABLENAME+'
							   WHERE isnull(GV_SCRATCH_NO,'''')<>'''' GROUP BY GV_SCRATCH_NO HAVING COUNT(*)>1)
						SET @CERRMSG=''DUPLICATE COMBINATION OF GV SCRATCH NO. FOUND'''
		PRINT @CCMD				
		EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(1000) OUTPUT',@CERRMSG OUTPUT
		
		IF ISNULL(@CERRMSG,'')<>''
		BEGIN								   
			SET @CRETMSG=N'SELECT *,'''+@CERRMSG+''' AS ERRMSG FROM '+@CTEMPTABLENAME+' WHERE GV_SCRATCH_NO IN 
						( SELECT GV_SCRATCH_NO FROM '+@CTEMPTABLENAME+'
						  WHERE isnull(GV_SCRATCH_NO,'''')<>''''
						  GROUP BY GV_SCRATCH_NO HAVING COUNT(*)>1)'
		END
	
		SET @CERRMSG=''
		
		IF @CTEMPTABLEPARA<>''
		BEGIN		
			SET @CCMD=N'IF EXISTS (SELECT A.GV_SCRATCH_NO FROM '+@CTEMPTABLENAME+' A
								   JOIN GV_GEN_DET B ON A.GV_SCRATCH_NO=B.GV_SCRATCH_NO 
								   JOIN GV_GEN_MST C ON C.MEMO_ID=B.MEMO_ID
								   WHERE C.CANCELLED=0 AND A.MEMO_ID<>B.MEMO_ID
								   AND isnull(A.GV_SCRATCH_NO,'''')<>'''')
							SET @CERRMSG=''SAME GV SCRATCH NO. ALREADY LINKED'''
			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(1000) OUTPUT',@CERRMSG OUTPUT
			
			IF ISNULL(@CERRMSG,'')<>''
			BEGIN								   
				SET @CRETMSG=N'SELECT *,'''+@CERRMSG+''' AS ERRMSG FROM '+@CTEMPTABLENAME+' WHERE GV_SCRATCH_NO IN 
							( SELECT A.GV_SCRATCH_NO FROM '+@CTEMPTABLENAME+' A
								   JOIN GV_GEN_DET B ON A.GV_SCRATCH_NO=B.GV_SCRATCH_NO 
								   JOIN GV_GEN_MST C ON C.MEMO_ID=B.MEMO_ID
								   WHERE C.CANCELLED=0 AND A.MEMO_ID<>B.MEMO_ID
								   AND isnull(A.GV_SCRATCH_NO,'''')<>'''')'
			END

			IF @nGvType=1 AND @nValidationSource<>2
			BEGIN
				SET @CCMD=N'IF EXISTS (SELECT A.GV_SCRATCH_NO FROM '+@CTEMPTABLENAME+' A
									   where isnull(A.GV_SCRATCH_NO,'''')='''')
								SET @CERRMSG=''GV SCRATCH NO. Cannot be Blank'''
				PRINT @CCMD				
				EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(1000) OUTPUT',@CERRMSG OUTPUT
			
				IF ISNULL(@CERRMSG,'')<>''
				BEGIN								   
					SET @CRETMSG=N'SELECT *,'''+@CERRMSG+''' AS ERRMSG FROM '+@CTEMPTABLENAME+' a
									where isnull(A.GV_SCRATCH_NO,'''')='''''
				END		
			END
		END
		
		SET @CERRMSG=''
				
		SET @CCMD=N'IF EXISTS (SELECT GV_SRNO FROM '+@CTEMPTABLENAME+'
							   GROUP BY GV_SRNO HAVING COUNT(*)>1)
						SET @CERRMSG=''DUPLICATE COMBINATION OF GV NO. FOUND'''
		PRINT @CCMD						
		EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(MAX) OUTPUT',@CERRMSG=@CERRMSG OUTPUT
		
		IF ISNULL(@CERRMSG,'')<>''
		BEGIN								   
			SET @CRETMSG=@CRETMSG+(CASE WHEN @CRETMSG<>'' THEN ' UNION ' ELSE '' END)+
						N'SELECT *,'''+@CERRMSG+''' AS ERRMSG FROM '+@CTEMPTABLENAME+' WHERE GV_SRNO IN 
						( SELECT GV_SRNO FROM '+@CTEMPTABLENAME+'
						  GROUP BY GV_SRNO HAVING COUNT(*)>1)
					  '
		END		
		
		SET @CERRMSG=''

		IF @CTEMPTABLEPARA<>''
		BEGIN		
			SET @CCMD=N'IF EXISTS (SELECT A.GV_SCRATCH_NO FROM '+@CTEMPTABLENAME+' A
								   JOIN GV_GEN_DET B ON A.GV_SRNO=B.GV_SRNO
								   JOIN GV_GEN_MST C ON C.MEMO_ID=B.MEMO_ID
								   WHERE C.CANCELLED=0 AND A.MEMO_ID<>B.MEMO_ID)
							SET @CERRMSG=''SAME GV SR NO. ALREADY LINKED'''
			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(1000) OUTPUT',@CERRMSG OUTPUT
			
			IF ISNULL(@CERRMSG,'')<>''
			BEGIN								   
				SET @CRETMSG=N'SELECT *,'''+@CERRMSG+''' AS ERRMSG FROM '+@CTEMPTABLENAME+' WHERE GV_SRNO IN 
							( SELECT A.GV_SRNO FROM '+@CTEMPTABLENAME+' A
								   JOIN GV_GEN_DET B ON A.GV_SRNO=B.GV_SRNO
								   JOIN GV_GEN_MST C ON C.MEMO_ID=B.MEMO_ID
								   WHERE C.CANCELLED=0 AND A.MEMO_ID<>B.MEMO_ID )'
			END
		END
		
		SET @CERRMSG=''
				
		SET @CCMD=N'IF EXISTS (SELECT TOP 1 GV_SRNO FROM '+@CTEMPTABLENAME+'
							   WHERE ISNUMERIC(DENOMINATION)=0) 
						SET @CERRMSG=''GV DENOMINATION SHOULD BE PURELY NUMBER'''
		PRINT @CCMD				
		EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(MAX) OUTPUT',@CERRMSG=@CERRMSG OUTPUT
		
		IF ISNULL(@CERRMSG,'')<>''
		BEGIN								   
			SET @CRETMSG=@CRETMSG+(CASE WHEN @CRETMSG<>'' THEN ' UNION ' ELSE '' END)+
					  N'SELECT *,'''+@CERRMSG+''' AS ERRMSG FROM '+@CTEMPTABLENAME+' WHERE ISNUMERIC(DENOMINATION)=0'
  
		END			
		
		SET @CERRMSG=''
		SET @CCMD=N'IF EXISTS (SELECT TOP 1 GV_SRNO FROM '+@CTEMPTABLENAME+'
							   WHERE ISNUMERIC(DISCOUNT_AMOUNT)=0) 
						SET @CERRMSG=''GV DISCOUNT SHOULD BE PURELY NUMBER'''					   
		PRINT @CCMD						
		EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(MAX) OUTPUT',@CERRMSG=@CERRMSG OUTPUT
		
		IF ISNULL(@CERRMSG,'')<>''
		BEGIN								   
			SET @CRETMSG=@CRETMSG+(CASE WHEN @CRETMSG<>'' THEN ' UNION ' ELSE '' END)+
			N'SELECT *,'''+@CERRMSG+''' AS ERRMSG FROM '+@CTEMPTABLENAME+' WHERE ISNUMERIC(DISCOUNT_AMOUNT)=0'
		END					
		
		IF @CRETMSG<>''
		BEGIN
			IF @CTEMPTABLEPARA=''
				SELECT 'ERROR' AS ERRMSG
					
			SET @CRETMSG=@CRETMSG+' ORDER BY ERRMSG'
			
			EXEC SP_EXECUTESQL @CRETMSG
			
			IF @CTEMPTABLEPARA<>''
			BEGIN
				SET @CCMD=N'INSERT #TMPGVGENERR SELECT ''ERROR'' AS ERRMSG'
				EXEC SP_EXECUTESQL @CCMD
			END	
		END	
		ELSE
		IF @CTEMPTABLEPARA=''
		BEGIN
			SELECT '' AS ERRMSG
			SET @CRETMSG='SELECT *,'''' AS ERRMSG FROM '+@CTEMPTABLENAME
			EXEC SP_EXECUTESQL @CRETMSG
		END
		
		
	END
	
END
