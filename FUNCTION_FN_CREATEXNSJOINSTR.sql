CREATE  FUNCTION FN_CREATEXNSJOINSTR
(
	@CXNTYPE VARCHAR(10),
	@CTABLENAME VARCHAR(50),
	@CPARENTTABLENAME VARCHAR(50),
	@CPARENTPARANAME VARCHAR(50),
	@CJOINSTR VARCHAR(MAX),
	@CWHERECLAUSE NVARCHAR(1000)='',
	@CMEMOID VARCHAR(40)=''
)
RETURNS VARCHAR(1000) 
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CPARENTKEYFIELD VARCHAR(30),@CNEXTPARENTTABLENAME VARCHAR(30),@CCHILDPARANAME VARCHAR(50),
	@CNEXTPARENTPARANAME VARCHAR(50), @CTEMPWHERECLAUSE NVARCHAR(1000)

	
	SELECT @CCHILDPARANAME = (CASE WHEN CHILD_PARA_NAME<>'' THEN CHILD_PARA_NAME ELSE PARENT_PARA_NAME END)
	FROM XNSINFO 
	WHERE XN_TYPE = @CXNTYPE 
	AND   TABLENAME = @CTABLENAME 
	AND   PARENT_TABLENAME = @CPARENTTABLENAME

	IF @CPARENTTABLENAME<>''
	BEGIN
		SET @CJOINSTR=@CJOINSTR+' JOIN '+@CPARENTTABLENAME+(CASE WHEN LEFT(@CPARENTTABLENAME,4)='TMP_' THEN 
					   '_'+LTRIM(RTRIM(STR(@@SPID))) ELSE '' END) +' ON '
		
		IF LEFT(@CPARENTTABLENAME,4)='TMP_'
		BEGIN
			IF LEFT(@CPARENTTABLENAME,7)='TMP_CIM'
				SET @CJOINSTR=@CJOINSTR+@CTABLENAME+'.'+@CCHILDPARANAME+'='+@CPARENTPARANAME
			ELSE	
				SET @CJOINSTR=@CJOINSTR+@CTABLENAME+'.'+@CCHILDPARANAME+'='+@CPARENTTABLENAME+'_'+LTRIM(RTRIM(STR(@@SPID)))+'.'+@CPARENTPARANAME
				
			RETURN @CJOINSTR	
		END 
		
		SET @CJOINSTR=@CJOINSTR+@CTABLENAME+'.'+@CCHILDPARANAME+'='+@CPARENTTABLENAME+'.'+@CPARENTPARANAME
	END
	ELSE
		SELECT @CJOINSTR='',@CPARENTTABLENAME=@CTABLENAME
		
	SELECT TOP 1 @CNEXTPARENTTABLENAME = PARENT_TABLENAME, @CNEXTPARENTPARANAME = PARENT_PARA_NAME,
				 @CTEMPWHERECLAUSE = WHERECLAUSE
	FROM XNSINFO 
	WHERE XN_TYPE = @CXNTYPE 
	AND   TABLENAME = @CPARENTTABLENAME 
	ORDER BY XNS_SENDING_ORDER

	IF ( @CWHERECLAUSE = '' AND ISNULL(@CTEMPWHERECLAUSE,'') <> '' )
		SET @CWHERECLAUSE = @CTEMPWHERECLAUSE

	IF ISNULL(@CNEXTPARENTTABLENAME,'')<>ISNULL(@CPARENTTABLENAME,'') AND @CNEXTPARENTTABLENAME<>''
	    SELECT @CJOINSTR = DBO.FN_CREATEXNSJOINSTR(@CXNTYPE, @CPARENTTABLENAME,@CNEXTPARENTTABLENAME,
						   @CNEXTPARENTPARANAME,@CJOINSTR,@CWHERECLAUSE,@CMEMOID)		
	ELSE
	BEGIN
		SELECT @CPARENTKEYFIELD=KEYFIELD FROM XNSINFO (NOLOCK) WHERE TABLENAME=@CPARENTTABLENAME
		SELECT @CJOINSTR = @CJOINSTR+(CASE WHEN @CWHERECLAUSE<>'' OR ISNULL(@CMEMOID,'')<>'' THEN 
						   ' WHERE '+@CWHERECLAUSE ELSE '' END)+(CASE WHEN @CXNTYPE NOT IN ('ACT','INV','USR') THEN 
						   (CASE WHEN @CWHERECLAUSE<>'' AND ISNULL(@CMEMOID,'')<>'' THEN ' AND ' ELSE '' END)+
						   (CASE WHEN ISNULL(@CMEMOID,'')<>'' THEN 
							@CPARENTTABLENAME+'.'+@CPARENTKEYFIELD+'='''+@CMEMOID+'''' ELSE '' END)	
							ELSE '' END)
	END
	
	RETURN @CJOINSTR
END
