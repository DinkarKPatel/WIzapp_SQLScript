CREATE PROCEDURE SP3S_DSR_REDEEMED_GIFT_VOUCHER_LIST--(LocId 3 digit change by Sanjay:05-11-2024)
(
   @DFM_DT DATETIME,
   @DTO_DT DATETIME
)
AS
BEGIN
      SELECT DISTINCT  P.LOCATION_CODE AS LOC_ID,DEPT_NAME AS LOC_NAME,
              A.GV_SRNO AS GV_NO,A.QUANTITY, (case when B.DENOMINATION <=0 then A. DENOMINATION ELSE B.DENOMINATION END )AS DENOMINATION,
              ADV_REC_NO AS SALE_RECEIPT_NO,CONVERT(VARCHAR,ADV_REC_DT,105) AS SALE_DATE,
              CUSTOMER_NAME=CASE WHEN ISNULL(C.MOBILE,'')<> '' THEN  ISNULL(C.MOBILE,'')+', ' ELSE '' END + 
              ISNULL(C.CUSTOMER_FNAME,'') +' '+ISNULL(CUSTOMER_LNAME,''),
              P.CM_NO AS ADJ_MEMO_ID, CONVERT(VARCHAR,P.BILL_DT ,105) AS BILL_DT
       FROM ARC_GVSALE_DETAILS A (NOLOCK)
	   JOIN SKU_GV_MST B (NOLOCK) ON B.GV_SRNO=A.GV_SRNO
	   JOIN
	   (
	       SELECT  C.CM_NO, C.CM_DT AS BILL_DT ,GV_SRNO ,C.location_Code
	       FROM  PAYMODE_XN_DET B (NOLOCK) 
		   JOIN CMM01106 C ON C.CM_ID=B.MEMO_ID
	       WHERE C.CANCELLED =0 AND  B.XN_TYPE='SLS' AND PAYMODE_CODE='GVC0001'
	       GROUP BY C.CM_NO, C.CM_DT ,GV_SRNO,C.location_Code
	   ) P ON  P.GV_SRNO =A.GV_SRNO    
	   JOIN ARC01106 ARC (NOLOCK) ON ARC.ADV_REC_ID=A.ADV_REC_ID 
	   JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=P.location_Code
	   JOIN CUSTDYM C (NOLOCK) ON C.CUSTOMER_CODE=ARC.CUSTOMER_CODE
	   WHERE ISNULL(ARC.CANCELLED,0)=0 
	   AND B.DT_CREATED BETWEEN @DFM_DT AND @DTO_DT
END

--END OF PROCEDURE SP3S_DSR_REDEEMED_GIFT_VOUCHER_LIST
