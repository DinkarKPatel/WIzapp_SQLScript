CREATE PROCEDURE SP_MBQ_WH
( 
  @CDTFROM VARCHAR(15),
  @CDTTO VARCHAR(15),
  @CWHERE VARCHAR(50),
  @CDEPTID VARCHAR(10),
  @INTMONTH INT,
  @INTYEAR INT 
)
--WITH ENCRYPTION

AS
BEGIN


SELECT MST.ARTICLE_CODE, J.PARA1_NAME AS SECTION_NAME,B.PRODUCT_NAME AS SUB_SECTION_NAME,ARTICLE_NO,(B.MRP) AS MRP,
       ISNULL(MST.MBQ,0) AS MBQ_QTY, ISNULL(MST.MST,0) AS MST_QTY, 
       ISNULL(MSTWH.MBQ,0) AS MBQ_QTY_WH, ISNULL(MSTWH.MST,0) AS MST_QTY_WH,
       
     
      SUM( (CASE WHEN A.XN_TYPE='OPS' OR (A.XN_TYPE IN ('OPS', 'PUR', 'CHI', 'SLR','UNC','APR', 'WSR', 'PFI',   
                'PFG', 'BCG','MRP','DCI','PSB','JWR') AND XN_DT <= @CDTTO AND  LO.PUR_LOC=1 
                AND A.DEPT_ID = 'W1' )   
                 THEN 1 WHEN A.XN_TYPE IN ('PRT','CHO','SLS','CNC','APP','WSL','CIP', 'CRM', 'DCO','MIP','CSB',  
                'JWI','DLM') AND XN_DT <= @CDTTO AND  LO.PUR_LOC= 1AND A.DEPT_ID = 'W1' 
                THEN -1 ELSE 0 END) * (XN_QTY)) AS STOCK_QTY_WH ,  

      SUM( CASE WHEN A.XN_TYPE='SLS' AND XN_DT BETWEEN @CDTFROM AND @CDTTO 
                AND  LO.PUR_LOC=0   THEN XN_QTY  WHEN A.XN_TYPE='SLR' AND XN_DT BETWEEN @CDTFROM AND @CDTTO  
                AND  LO.PUR_LOC=0  THEN - (ABS(XN_QTY)) ELSE 0 END) AS SLS_QTY,  

      SUM( (CASE WHEN A.XN_TYPE='OPS' OR (A.XN_TYPE IN ('OPS', 'PUR', 'CHI', 'SLR','UNC','APR', 'WSR', 'PFI',   
                     'PFG', 'BCG','MRP','DCI','PSB','JWR') AND XN_DT <= @CDTTO AND LO.PUR_LOC=0 )   
                THEN 1 WHEN A.XN_TYPE IN ('PRT','CHO','SLS','CNC','APP','WSL','CIP', 'CRM', 'DCO','MIP','CSB',  
                       'JWI','DLM') AND XN_DT <= @CDTTO AND LO.PUR_LOC=0 THEN -1 ELSE 0 END) * (XN_QTY)) AS STOCK_QTY,  

      SUM( CASE WHEN A.XN_TYPE='SLS' AND XN_DT BETWEEN @CDTFROM AND @CDTTO AND LO.PUR_LOC=0     
                THEN (XN_QTY)  WHEN A.XN_TYPE='SLR' AND XN_DT BETWEEN @CDTFROM AND @CDTTO
                AND LO.PUR_LOC=0  THEN - (ABS(XN_QTY)) ELSE 0 END) * (B.MRP) AS SLS_VAL  

    
FROM VW_XNSREPS A 
JOIN LOCATION LO (NOLOCK) ON LO.DEPT_ID = A.DEPT_ID  
JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE = B.PRODUCT_CODE  

RIGHT OUTER JOIN   
(  
	SELECT ARTICLE_CODE,SUM(MBQ) AS MBQ,SUM(ISNULL(MST,0)) AS MST 
	FROM  MIN_SALE_TARGET MST  (NOLOCK) 	
	JOIN SECTIOND E (NOLOCK) ON MST.SUB_SECTION_CODE = E.SUB_SECTION_CODE   
	WHERE MST.MONTH = @INTMONTH  AND MST.YEAR =@INTYEAR
	AND (@CWHERE='' OR E.SECTION_CODE = @CWHERE )  AND (@CDEPTID ='' OR MST.DEPT_ID =@CDEPTID ) 
	AND MST.DEPT_ID <> 'W1' 
    GROUP BY ARTICLE_CODE  
) MST  ON  MST.ARTICLE_CODE= B.ARTICLE_CODE 

JOIN ARTICLE D (NOLOCK) ON D.ARTICLE_CODE=MST.ARTICLE_CODE
JOIN SECTIOND E (NOLOCK) ON D.SUB_SECTION_CODE = E.SUB_SECTION_CODE  
JOIN SECTIONM F (NOLOCK) ON E.SECTION_CODE = F.SECTION_CODE   
LEFT OUTER JOIN PARA2 H (NOLOCK) ON B.PARA2_CODE = H.PARA2_CODE   
LEFT OUTER JOIN PARA1 J (NOLOCK) ON B.PARA1_CODE = J.PARA1_CODE  
LEFT OUTER JOIN   
(  
	SELECT ARTICLE_CODE,SUM(MBQ) AS MBQ,SUM(ISNULL(MST,0)) AS MST  
	FROM  MIN_SALE_TARGET MST (NOLOCK)   
	JOIN LOCATION LO (NOLOCK) ON LO.DEPT_ID = MST.DEPT_ID 
	JOIN SECTIOND E (NOLOCK) ON MST.SUB_SECTION_CODE = E.SUB_SECTION_CODE  
	WHERE  LO.PUR_LOC=1 AND LO.DEPT_ID='W1' AND MST.MONTH = @INTMONTH  AND MST.YEAR =  @INTYEAR
	AND (@CWHERE='' OR E.SECTION_CODE = @CWHERE )
	GROUP BY ARTICLE_CODE  
) MSTWH  ON  MSTWH.ARTICLE_CODE= MST.ARTICLE_CODE 
WHERE (@CDEPTID ='' OR LO.DEPT_ID =@CDEPTID ) AND (@CWHERE='' OR E.SECTION_CODE = @CWHERE )  
GROUP BY MST.ARTICLE_CODE,J.PARA1_NAME,B.PRODUCT_NAME,D.ARTICLE_CODE,ARTICLE_NO,B.MRP,
ISNULL(MST.MBQ,0),ISNULL(MST.MST,0),ISNULL(MSTWH.MBQ,0) , ISNULL(MSTWH.MST,0)      
ORDER BY SLS_VAL


END
