CREATE PROCEDURE SP_SEND_MIRROR_DNPS_DATA_NEW
(	
	 @CUPLOADEDXNID VARCHAR(50)
	,@CCURLOCID VARCHAR(5)
	,@BACKNOWLEDGE BIT=0
	,@CERRMSG VARCHAR(1000) OUTPUT
)	
--WITH ENCRYPTION
AS
/*
	SP_SEND_MIRROR_DNPS_DATA_NEW_208_04_02_14 : THIS PROCEDURE WILL SEND PURCHASE DEBITNOTE PACKSLIP DATA FROM LOCATION TO HO.
*/
BEGIN
	DECLARE @DTSQL NVARCHAR(MAX),@CSPID VARCHAR(10),@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),
	@CTEMPMASTERTABLE VARCHAR(200),@CTEMPLMTABLE VARCHAR(200),@CTEMPLMPTABLE VARCHAR(200),@CTEMPAREATABLE VARCHAR(200),@CTEMPCITYTABLE VARCHAR(200)
	,@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX)
	,@CKEYFIELD VARCHAR(100)
	
BEGIN TRY 	
	---- CALL ACKNOWLEDGEMENT OF MEMO SUCCESSFUL MERGING AT MIRRORING SERVER
	SET @CSTEP=0
	DECLARE @CTEMPDBNAME VARCHAR(40)
	SET @CTEMPDBNAME=''
	--CHNAGE BY BAIJNATH
	SET @CMEMOID=@CUPLOADEDXNID
	---- IF NO MEMO FOUND , JUST END THE PROCESS
	IF ISNULL(@CMEMOID,'')=''
		GOTO END_PROC
LBLTABLEINFO:
	SET @CSTEP=50
	---- DNPSPULATE LIST OF TABLES 

	
	SET @CSTEP=220
	---- SEND THE DNPS MEMO MASTER TABLE
	
	SELECT DISTINCT  A.*,'DNPS_DNPS_MST_UPLOAD' AS TARGET_TABLENAME FROM DNPS_MST A (NOLOCK) WHERE A.ps_id =@CMEMOID 
	
	SET @CSTEP=230
	---- SEND THE DNPS MEMO DETAIL TABLE
	SELECT DISTINCT  A.*,'DNPS_DNPS_DET_UPLOAD' AS TARGET_TABLENAME FROM DNPS_DET A (NOLOCK) WHERE A.ps_id =@CMEMOID 
	
	
	SET @CSTEP=231
	---- SEND THE DNPS MEMO DETAIL TABLE
	
	  SELECT DISTINCT 'DNPS_PMT01106_UPLOAD' AS TARGET_TABLENAME, A.DEPT_ID,A.product_code,A.BIN_ID,A.quantity_in_stock  
	  FROM PMT01106 A (NOLOCK)  
	  JOIN DNPS_DET B (NOLOCK) ON B.product_code=A.product_code
	  WHERE B.ps_id=@CMEMOID 
       
	

	GOTO END_PROC

END TRY
BEGIN CATCH
	SET @CERRMSG='P: SP_SEND_MIRROR_DNPS_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 		
END_PROC:
	
END
---END OF PROCEDURE - SP_SEND_MIRROR_DNPS_DATA_NEW
