
IF NOT EXISTS (SELECT TOP 1 'U' FROM ITEM_STATUS)
BEGIN

	IF OBJECT_ID ('TEMPDB..#TMPRECUPD','U') IS NOT NULL
	   DROP TABLE #TMPRECUPD
		    
		SELECT A.* ,
			 SR=ROW_NUMBER () OVER (PARTITION BY a.REF_HBD_ROW_ID ORDER BY ISSUE_DT DESC,ISSUE_ID DESC)
	   into #TMPRECUPD
		FROM
		(
		 SELECT A.REF_HBD_ROW_ID ,B.ISSUE_ID,B.ISSUE_DT ,
				A.JOB_CODE,A.DUE_DT,C.RECEIPT_ID,C.JOB_RATE,  
				SUM(A.QUANTITY) AS ISSUE_QTY,
				SUM(C.REC_QTY) AS REC_QTY,
			    SUM(CONVERT(NUMERIC(10,2),(C.JOB_RATE*C.REC_QTY))) AS AMOUNT
		FROM POST_SALES_JOBWORK_ISSUE_DET A (NOLOCK) 
		JOIN POST_SALES_JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID=B.ISSUE_ID 
	    LEFT JOIN
		(
		  SELECT A.REF_ROW_ID ,B.RECEIPT_ID  ,
			    A.QUANTITY REC_QTY,
			    A.JOB_RATE 
		  FROM POST_SALES_JOBWORK_RECEIPT_DET A (NOLOCK) 
		  JOIN POST_SALES_JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID =B.RECEIPT_ID 
		 WHERE B.CANCELLED =0

		 ) C ON A.ROW_ID =C.REF_ROW_ID
		WHERE B.CANCELLED=0 
		GROUP BY A.REF_HBD_ROW_ID ,B.ISSUE_ID,B.ISSUE_DT ,A.JOB_CODE,
		C.RECEIPT_ID,C.JOB_RATE,A.DUE_DT
				
			  
	) A

     DELETE FROM #TMPRECUPD WHERE SR>1
         


	


			INSERT INTO ITEM_STATUS(CM_ID,REF_CMD_ROW_ID,HBD_MEMO_ID,HBD_ROW_ID, PRODUCT_CODE,HOLD_QTY,DELIVERED,
												DELIVERY_DT,EMP_CODE,EMP_CODE1,EMP_CODE2,ITEM_REMARKS,MRP,
												ISSUE_ID,JOB_CODE,ISSUE_QTY,ISSUE_DUE_DT,
												RECEIPT_ID, REC_QTY,JOB_RATE,AMOUNT,
												DELIVER_MEMO_ID,Additional_job,HBD_STATUS  )

		   SELECT D.CM_ID ,b.ref_cmd_row_id  ,A.MEMO_ID AS HBD_MEMO_ID,B.ROW_ID AS HBD_ROW_ID,
				  B.PRODUCT_CODE,B.QUANTITY  AS HOLD_QTY,
				  B.delivered ,
				  DELIVERY_DT,isnull(c.EMP_CODE,a.hbd_emp_code ),EMP_CODE1,EMP_CODE2,b.remarks  ITEM_REMARKS,c.MRP,
				  ISNULL(REC.ISSUE_ID,'') AS  ISSUE_ID,
				  ISNULL(REC.JOB_CODE,'') AS JOB_CODE,
				  ISNULL(REC.ISSUE_QTY,0)  AS ISSUE_QTY,
				  REC.DUE_DT,
				  ISNULL(REC.RECEIPT_ID ,'') AS  RECEIPT_ID,
				  ISNULL(REC.REC_QTY,0)  AS REC_QTY,
				  rec.job_rate,rec.AMOUNT,
				  ISNULL(DEL.MEMO_ID,'') AS DEL_MEMO_ID,
				  b.Additional_job,b.HBD_STATUS
		   FROM HOLD_BACK_DELIVER_MST A (NOLOCK)
		   JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
		   LEFT JOIN CMD01106 C (NOLOCK) ON B.REF_CMD_ROW_ID =C.ROW_ID 
		   LEFT JOIN CMM01106 D (NOLOCK) ON D.CM_ID =C.CM_ID 
		   LEFT JOIN #TMPRECUPD REC ON REC.REF_HBD_ROW_ID =B.ROW_ID 
		   LEFT JOIN
		   (
    
			 SELECT B.REF_HBD_ROW_ID ,B.MEMO_ID ,
			 sr=ROW_NUMBER () over (partition by B.REF_HBD_ROW_ID order by b.memo_id desc)
			 FROM SLS_DELIVERY_MST A (NOLOCK)
			 JOIN SLS_DELIVERY_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
			 WHERE A.CANCELLED =0
			 GROUP BY  B.REF_HBD_ROW_ID ,B.MEMO_ID 
		   ) DEL ON DEL.REF_HBD_ROW_ID =B.ROW_ID  and del.sr=1
		   WHERE A.CANCELLED=0 AND ISNULL(D.CANCELLED,0)=0


END
