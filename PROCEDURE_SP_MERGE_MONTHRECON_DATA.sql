CREATE PROCEDURE SP_MERGE_MONTHRECON_DATA
@CDEPTID VARCHAR(10)
--WITH ENCRYPTION
AS
BEGIN

BEGIN TRY

	DECLARE @CCMD NVARCHAR(MAX),@CTARGETDBNAME VARCHAR(500),@CFILEPATH VARCHAR(1000),
			@CTABLENAME VARCHAR(300),@CTABLE VARCHAR(300),@CTEMPTABLE VARCHAR(200),
			@CSOURCEDB VARCHAR(500),@CSOURCETABLE VARCHAR(500),@CERRMSG VARCHAR(MAX),
			@NSTEP INT
	
	SET @NSTEP=10
	
	SELECT @CTARGETDBNAME='WIZAPP3S_LOCXNS_RECON',@CSOURCEDB=DB_NAME()+'_TEMP.DBO.'	
	
	SET @CSOURCETABLE=@CSOURCEDB+'TEMP_LOC_RECON_'+@CDEPTID
	
	SELECT @CFILEPATH=PHYSICAL_NAME FROM SYS.MASTER_FILES WHERE DATABASE_ID=DB_ID(DB_NAME()) AND TYPE_DESC='ROWS'
	SET @CFILEPATH=REVERSE(RIGHT(REVERSE(@CFILEPATH),(LEN(@CFILEPATH)-CHARINDEX('\',REVERSE(@CFILEPATH),1))+1))

	SET @NSTEP=20
	

			
	SET @CCMD=N'IF NOT EXISTS(SELECT TOP 1 ''U'' FROM SYS.DATABASES WHERE NAME='''+@CTARGETDBNAME+''') 
	BEGIN
		CREATE DATABASE ' + @CTARGETDBNAME + ' ON '+
		' ( NAME = ' + @CTARGETDBNAME + ', ' + 
		'  FILENAME = ''' + @CFILEPATH  + @CTARGETDBNAME + '.MDF'' ) ' + 
		' LOG ON ' + 
		' ( NAME = ' + @CTARGETDBNAME + '_LOG, ' + 
		'  FILENAME = ''' + @CFILEPATH  + @CTARGETDBNAME + '_LOG.LDF'' )
	END'
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
	
	BEGIN TRANSACTION
		
	SET @NSTEP=30
	SET @CTABLENAME='LOC_RECON_'+@CDEPTID
	SET @CTABLE=@CTARGETDBNAME+'.DBO.'+@CTABLENAME
	
	SET @NSTEP=40
	SET @CCMD=N'IF OBJECT_ID('''+@CTABLE+''',''U'') IS NOT NULL
					DROP TABLE '+@CTABLE
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=50
	SET @CCMD=N'SELECT * INTO '+@CTABLE+' FROM '+@CSOURCETABLE
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=60
	SET @CCMD=N'DROP TABLE '+@CSOURCETABLE
	EXEC SP_EXECUTESQL @CCMD
	
	GOTO EXIT_PROC
END TRY

BEGIN CATCH
	SET @CERRMSG='P:SP_MERGE_MONTHRECON_DATA, STEP:'+LTRIM(RTRIM(STR(@NSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
	GOTO EXIT_PROC
END CATCH

EXIT_PROC:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')=''
			COMMIT TRANSACTION
		ELSE
			ROLLBACK	
	END
	
	SELECT ISNULL(@CERRMSG,'') AS MESSAGE

END	
---END OF PROCEDURE - SP_MERGE_MONTHRECON_DATA
