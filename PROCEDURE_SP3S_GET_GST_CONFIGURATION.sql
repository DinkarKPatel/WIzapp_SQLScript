CREATE PROCEDURE SP3S_GET_GST_CONFIGURATION
(
  @NMODE INT=1, --FOR GET 2 FOR INSERT,
  @CVALUE VARCHAR(MAX)=''
  
) 
AS
BEGIN
	IF OBJECT_ID ('TEMPDB..#TMPACCOUNTS','U') IS NOT NULL
	   DROP TABLE #TMPACCOUNTS

	
	IF @CVALUE=''
		SELECT @CVALUE=ISNULL(@CVALUE+',','')+CAST(GST_PERCENTAGE AS VARCHAR(10)) FROM GST_ACCOUNTS_CONFIG_DET_2
		GROUP BY GST_PERCENTAGE

	--SET @CVALUE='5,12,18'

	;WITH CTE(XN_TYPE,DATA1,DATAITEM,VALUE) AS
	(
	  SELECT XN_TYPE, @CVALUE,SUBSTRING(@CVALUE,1, CHARINDEX (',',@CVALUE+',')-1),STUFF(@CVALUE,1, CHARINDEX (',',@CVALUE),'')
	  FROM GST_ACCOUNTS_CONFIG_MST
	  WHERE XN_TYPE NOT IN('CHO_XFR','CHI_XFR','PTC','BTF','JWR','TLF')
	  UNION ALL
	  SELECT XN_TYPE,VALUE,SUBSTRING(VALUE,1, CHARINDEX (',',VALUE+',')-1),
	  STUFF(VALUE,1, CHARINDEX (',',VALUE+','),'') FROM CTE WHERE VALUE>''
	)

	SELECT XN_TYPE ,DATAITEM  INTO #TMPACCOUNTS FROM  CTE WHERE ISNULL(DATAITEM,'')<>''



  IF @NMODE=1
  BEGIN
     
     SELECT 	A.GST_PERCENTAGE, A.XN_TYPE, A.COLUMNNAME, 
			 A. COLUMNDESC,A.VALUE, A.REMARKS, A.FILTER_HEAD_CODE 
	 FROM GST_ACCOUNTS_CONFIG_DET_2 A
	 UNION ALL
     SELECT 	A.DATAITEM AS   GST_PERCENTAGE, A.XN_TYPE, A.COLUMNNAME, 
			 A. COLUMNDESC,'0000000000' VALUE,'' AS  REMARKS,'' AS FILTER_HEAD_CODE 
	 FROM
	(
		SELECT XN_TYPE ,DATAITEM,'CGST_TAX_AC_CODE' AS COLUMNNAME,'CGST A/C'  AS COLUMNDESC FROM #TMPACCOUNTS UNION ALL
		SELECT XN_TYPE ,DATAITEM,'IGST_TAX_AC_CODE' AS COLUMNNAME,'IGST A/C' AS COLUMNDESC FROM #TMPACCOUNTS UNION ALL
		SELECT XN_TYPE ,DATAITEM,'IGST_XN_AC_CODE' AS COLUMNNAME,'IGST XN A/C' AS COLUMNDESC  FROM #TMPACCOUNTS UNION ALL
		SELECT XN_TYPE ,DATAITEM,'LOCAL_GST_XN_AC_CODE' AS COLUMNNAME,'LOCAL XN A/C' AS COLUMNDESC FROM #TMPACCOUNTS UNION ALL
		SELECT XN_TYPE ,DATAITEM,'SGST_TAX_AC_CODE' AS COLUMNNAME,'SGST A/C' AS COLUMNDESC  FROM #TMPACCOUNTS 
	) A
	LEFT OUTER JOIN GST_ACCOUNTS_CONFIG_DET_2 B ON A.XN_TYPE=B.XN_TYPE AND A.DATAITEM =B.GST_PERCENTAGE AND A.COLUMNNAME =B.COLUMNNAME
	WHERE B.XN_TYPE IS NULL
	ORDER BY XN_TYPE,GST_PERCENTAGE ,COLUMNNAME

  
  
  END
  ELSE
  BEGIN
  
     INSERT GST_ACCOUNTS_CONFIG_DET_2	( GST_PERCENTAGE, XN_TYPE, COLUMNNAME, COLUMNDESC, VALUE, REMARKS, FILTER_HEAD_CODE )
	 SELECT 	A.DATAITEM AS   GST_PERCENTAGE, A.XN_TYPE, A.COLUMNNAME, 
			 A. COLUMNDESC,'0000000000' VALUE,'' AS  REMARKS,'' AS FILTER_HEAD_CODE 
	 FROM
	(
		SELECT XN_TYPE ,DATAITEM,'CGST_TAX_AC_CODE' AS COLUMNNAME,'CGST A/C'  AS COLUMNDESC FROM #TMPACCOUNTS UNION ALL
		SELECT XN_TYPE ,DATAITEM,'IGST_TAX_AC_CODE' AS COLUMNNAME,'IGST A/C' AS COLUMNDESC FROM #TMPACCOUNTS UNION ALL
		SELECT XN_TYPE ,DATAITEM,'IGST_XN_AC_CODE' AS COLUMNNAME,'IGST XN A/C' AS COLUMNDESC  FROM #TMPACCOUNTS UNION ALL
		SELECT XN_TYPE ,DATAITEM,'LOCAL_GST_XN_AC_CODE' AS COLUMNNAME,'LOCAL XN A/C' AS COLUMNDESC FROM #TMPACCOUNTS UNION ALL
		SELECT XN_TYPE ,DATAITEM,'SGST_TAX_AC_CODE' AS COLUMNNAME,'SGST A/C' AS COLUMNDESC  FROM #TMPACCOUNTS 
	) A
	LEFT OUTER JOIN GST_ACCOUNTS_CONFIG_DET_2 B ON A.XN_TYPE=B.XN_TYPE AND A.DATAITEM =B.GST_PERCENTAGE AND A.COLUMNNAME =B.COLUMNNAME
	WHERE B.XN_TYPE IS NULL

  
  END
	 

END
