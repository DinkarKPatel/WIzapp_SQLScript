CREATE PROCEDURE SP3S_REP_WCCOUPONS_CNTR
@DFROMDT DATETIME,
@DTODT DATETIME,
@NDIVFACTOR INT=1
AS
BEGIN
	IF OBJECT_ID('TEMPDB..#TMPCOUPONSLS','U') IS NOT NULL
		DROP TABLE #TMPCOUPONSLS
	
	SELECT B.DEPT_ID,DEPT_NAME,LEFT(DATENAME(MM,CM_DT),3) AS BILL_MONTH,SUM(NET_AMOUNT-ATD_CHARGES) AS TOTAL_SALES,
	SUM(CASE WHEN ISNULL(ECOUPON_ID,'')<>'' THEN NET_AMOUNT-ATD_CHARGES ELSE 0 END) AS COUPON_SALES,
	CONVERT(INT,0) AS CNTR_PCT
	INTO #TMPCOUPONSLS FROM CMM01106 A (NOLOCK) 
	JOIN LOCATION B ON B.DEPT_ID=a.location_Code  
	WHERE CM_DT BETWEEN @DFROMDT AND @DTODT AND CANCELLED=0
	GROUP BY B.DEPT_ID,DEPT_NAME,LEFT(DATENAME(MM,CM_DT),3),YEAR(CM_DT),MONTH(CM_DT)
	ORDER BY YEAR(CM_DT),MONTH(CM_DT)
	
	UPDATE #TMPCOUPONSLS SET TOTAL_SALES=CONVERT(INT,TOTAL_SALES/@NDIVFACTOR),COUPON_SALES=CONVERT(INT,COUPON_SALES/@NDIVFACTOR),
	CNTR_PCT=((CASE WHEN TOTAL_SALES>0 THEN COUPON_SALES/TOTAL_SALES ELSE 0 END))*100
	
	SELECT * FROM #TMPCOUPONSLS 
END
--END OF PROCEDURE - SP3S_REP_WCCOUPONS_CNTR
