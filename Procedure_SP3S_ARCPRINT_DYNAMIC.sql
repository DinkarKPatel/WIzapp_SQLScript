CREATE PROCEDURE SP3S_ARCPRINT_DYNAMIC--(LocId 3 digit change by Sanjay:04-11-2024)
(
@cMemoId VARCHAR(40),
@CWHERE NVARCHAR(50)=''
)
AS
BEGIN

	SET NOCOUNT ON
	   DECLARE @cCmdCols NVARCHAR(MAX),@cCmd NVARCHAR(MAX),@cCols VARCHAR(MAX),@cCmd1 NVARCHAR(MAX),@cCmd2 NVARCHAR(MAX),@cCmd3 NVARCHAR(MAX),@cCmdIMG NVARCHAR(MAX),
	    @SALE_PERSON VARCHAR(1000),@cnullableCols varchar(max) ,@CERRMSG varchar (1000) ,@NTYPE int,@REF_NO varchar(max),@CUS VARCHAR(100),@BAL FLOAT

		SELECT @NTYPE=ARC01106.ARCT,@CUS=customer_code FROM ARC01106(NOLOCK) WHERE ARC01106.ADV_REC_ID=@cMemoId  


		IF EXISTS (SELECT TOP 1 'U' FROM dynamic_print_cols	(NOLOCK) WHERE LTRIM(RTRIM(xn_type))='ARC' AND selected=1 AND DISPLAY_COLUMN_NAME ='cust_bal')
		begin
		   
		    CREATE TABLE #CUSBAL(cust_bal FLOAT)   
			INSERT INTO #CUSBAL
	        EXEC USP_CUSTBAL @CUS,''
	        select @BAL=cust_bal from #CUSBAL
		END

        
		SET @SALE_PERSON=''    
	
		DECLARE @SALES_PERSON VARCHAR(MAX)=''  


		IF EXISTS (SELECT TOP 1 'U' FROM dynamic_print_cols	(NOLOCK) WHERE LTRIM(RTRIM(xn_type))='ARC' AND selected=1 AND DISPLAY_COLUMN_NAME ='SALE_PERSON')
		BEGIN

			IF @NTYPE=1
			   SELECT @SALES_PERSON=ISNULL(@SALES_PERSON,'')+EMP_NAME+','
			   FROM
			   (SELECT DISTINCT E.EMP_NAME
			   FROM CMM_CREDIT_RECEIPT R (NOLOCK) 
			   JOIN CMD01106 C (NOLOCK) ON C.CM_ID=R.CM_ID   
			   JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE=C.EMP_CODE
			   WHERE R.ADV_REC_ID=@cMemoId AND C.EMP_CODE<>'0000000'
			   UNION
			   SELECT DISTINCT E.EMP_NAME
			   FROM CMM_CREDIT_RECEIPT R (NOLOCK) 
			   JOIN CMD01106 C (NOLOCK) ON C.CM_ID=R.CM_ID   
			   JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE=C.EMP_CODE1
			   WHERE R.ADV_REC_ID=@cMemoId AND C.EMP_CODE1<>'0000000'
			   UNION
			   SELECT DISTINCT E.EMP_NAME
			   FROM CMM_CREDIT_RECEIPT R (NOLOCK) 
			   JOIN CMD01106 C (NOLOCK) ON C.CM_ID=R.CM_ID   
			   JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE=C.EMP_CODE2
			   WHERE R.ADV_REC_ID=@cMemoId AND C.EMP_CODE2<>'0000000'
			   )E
			ELSE IF @NTYPE=2
			   SELECT @SALES_PERSON=ISNULL(@SALES_PERSON,'')+EMP_NAME+','
			   FROM (SELECT DISTINCT E.EMP_NAME
			   FROM WSL_ORDER_ADV_RECEIPT R (NOLOCK)  
			   JOIN WSL_ORDER_MST MST (NOLOCK) ON R.ORDER_ID=MST.ORDER_ID  
			   JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE=MST.EMP_CODE
			   WHERE R.ADV_REC_ID=@cMemoId AND E.EMP_CODE<>'0000000')E

			IF @SALES_PERSON<>'' AND RIGHT(@SALES_PERSON,1)=','
			   SET @SALES_PERSON=LEFT(@SALES_PERSON,LEN(@SALES_PERSON)-1)	

				SELECT @SALE_PERSON=LTRIM(RTRIM(@SALE_PERSON))              
				IF RIGHT(@SALE_PERSON,1)=','              
				   SET @SALE_PERSON=LEFT(@SALE_PERSON,LEN(@SALE_PERSON)-1)              
				IF @SALE_PERSON<>''               
				   SET @SALE_PERSON='You are attended by '+@SALE_PERSON  
		 

		 END


	IF EXISTS (SELECT TOP 1 'U' FROM dynamic_print_cols	(NOLOCK) WHERE LTRIM(RTRIM(xn_type))='ARC' AND selected=1 AND DISPLAY_COLUMN_NAME ='AGAINST_BILL_NO')
	BEGIN

	 IF @NTYPE=1  
	   SELECT @REF_NO=ISNULL(@REF_NO,'')+C.CM_NO+'(' + CONVERT(VARCHAR(10),C.CM_DT,105)+') Amt:'+cast(r.receipt_amount as varchar(100))+','  
	   FROM CMM_CREDIT_RECEIPT R (NOLOCK) 
	   JOIN CMM01106 C (NOLOCK) ON C.CM_ID=R.CM_ID   
	   WHERE R.ADV_REC_ID=@cMemoId  
	   ORDER BY C.CM_ID  
	ELSE IF @NTYPE=2  
	   SELECT @REF_NO=ISNULL(@REF_NO,'')+MST.ORDER_NO+'(' + CONVERT(VARCHAR(10),mst.order_dt,105)+'), '  
	   FROM WSL_ORDER_ADV_RECEIPT R (NOLOCK)  
	   JOIN WSL_ORDER_MST MST (NOLOCK) ON R.ORDER_ID=MST.ORDER_ID  
	   WHERE R.ADV_REC_ID=@cMemoId  
	   ORDER BY MST.ORDER_NO  
   ELSE IF @NTYPE=3  
	   SELECT @REF_NO=ISNULL(@REF_NO,'')+MST.memo_no+'(' + CONVERT(VARCHAR(10),mst.memo_dt,105)+'), '  
	   FROM HBD_RECEIPT R (NOLOCK)  
	   JOIN hold_back_deliver_mst MST (NOLOCK) ON R.MEMO_ID=MST.MEMO_ID  
	   WHERE R.ADV_REC_ID=@cMemoId  
	   ORDER BY MST.memo_no  
	END



	   select @SALES_PERSON as SALE_PERSON,@REF_NO AS AGAINST_BILL_NO,@BAL as cust_bal
	   INTO #TMPBILL


	   
	    SELECT @cCols=COALESCE(@cCols+',','')+column_name+' ['+DISPLAY_COLUMN_NAME+']' 
	    FROM dynamic_print_cols	
	    WHERE LTRIM(RTRIM(xn_type))='ARC' AND selected=1


		SELECT @cnullableCols=COALESCE(@cnullableCols+',','')+'NULL as '+' ['+DISPLAY_COLUMN_NAME+']' 
		FROM dynamic_print_cols	
	    WHERE LTRIM(RTRIM(xn_type))='ARC' AND selected=0

		SET @cnullableCols=ISNULL(@cnullableCols,'')
		IF ISNULL(@cnullableCols,'')<>''
		   SET @cnullableCols=','+ISNULL(@cnullableCols,'')


	   
	   DECLARE @NAME VARCHAR(300),@CREFNO VARCHAR(1000)

	   SELECT @NAME=COALESCE(@NAME,'')+(CASE WHEN M.PAYMODE_NAME='INR' THEN 'CASH' ELSE M.PAYMODE_NAME END)+':'+CONVERT(VARCHAR,ISNULL(P.amount,0))+'; ',
	          @CREFNO=COALESCE(@CREFNO+';','')+(CASE WHEN P.REF_NO ='' THEN  NULL ELSE RTRIM(LTRIM(P.REF_NO )) END )
	   FROM ARC01106  I (NOLOCK)
	   JOIN PAYMODE_XN_DET P (NOLOCK) ON I.adv_rec_id =P.memo_id AND P.xn_type='ARC'
	   JOIN paymode_mst M (NOLOCK) ON M.paymode_code =P.paymode_code 
	   WHERE I.adv_rec_id=@cMemoId


	   SET @NAME=RTRIM(@NAME)
	   IF RIGHT(@NAME,1)=';' SET @NAME=LEFT(@NAME,LEN(@NAME)-1)

	   IF RIGHT(@CREFNO,1)=';' SET @CREFNO=LEFT(@CREFNO,LEN(@CREFNO)-1)

	   set @NAME=isnull(@NAME,'')
	   set @CREFNO=isnull(@CREFNO,'')


	   DECLARE @CSPID VARCHAR(50),@CTABLENAME VARCHAR(50)

		SET @CSPID=LTRIM(RTRIM(STR(@@SPID )))
		SET @CTABLENAME  ='##TMPARCPRINT'+@CSPID

		SET @CCMD = N'IF OBJECT_ID(''TEMPDB..'+@CTABLENAME+''',''U'') IS NOT NULL
			DROP TABLE '+@CTABLENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
                


	   SET @cCmdCols=N'
	   SELECT '+@cCols+',
	   DBO.FN_CONVERTAMOUNTINWORDS(ABS(Arc.NET_AMOUNT)) AS  NET_AMOUNT_IN_WORDS,
	   DBO.FN_CONVERTAMOUNTINWORDS(ABS(Arc.igst_amount+Arc.cgst_amount+Arc.sgst_amount)) AS  Gst_Collection_IN_WORDS,
	   '''+@CREFNO+''' AS REFERENCE_NO,ARC.LOCATION_CODE,
	   '''+@NAME+''' PAYMENT_DETAILS
	   '+@cnullableCols
	   +' INTO '+@CTABLENAME+' '
	   SET @cCmd1=N'   FROM ARC01106 ARC (NOLOCK)   
	   LEFT JOIN ARC_GVSALE_DETAILS GV (NOLOCK)  ON ARC.ADV_REC_ID=GV.ADV_REC_ID
	   LEFT OUTER JOIN SKU_GV_MST GVSKU (NOLOCK) ON GVSKU.GV_SRNO=GV.GV_SRNO 
	   LEFT JOIN CUSTDYM CU (NOLOCK) ON CU.CUSTOMER_CODE =ARC.CUSTOMER_CODE   
	   LEFT JOIN AREA CA (NOLOCK) ON CA.AREA_CODE=CU.AREA_CODE  
	   LEFT JOIN CITY CC (NOLOCK) ON CC.CITY_CODE=CA.CITY_CODE  
	   LEFT JOIN GST_STATE_MST CS (NOLOCK) ON CS.GST_STATE_CODE=CU.CUS_GST_STATE_CODE   
	   LEFT JOIN COMPANY CMP (NOLOCK) ON CMP.COMPANY_CODE=''01''  
	   JOIN LOC_VIEW L (NOLOCK) ON L.DEPT_ID =ARC.LOCATION_CODE
	   JOIN GST_STATE_MST LS (NOLOCK) ON LS.GST_STATE_CODE=l.gst_state_code   
	   LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK)  ON  ARC.EMP_CODE = EMP.EMP_CODE 
	   left join (select top 1 * from GST_TNC where xn_type=''arc'') GST_TNC on 1=1
	   LEFT JOIN #TMPBILL TMPBILL ON 1=1
	   LEFT JOIN USERS U (NOLOCK) ON U.USER_CODE=ARC.USER_CODE
	   LEFT JOIN USERS EU (NOLOCK) ON EU.USER_CODE=ARC.EDT_USER_CODE
	   WHERE ARC.ADV_REC_ID='''+@cMemoId+'''
	   '

    
       PRINT @cCmdCols
       PRINT @ccmd1
       EXEC(@cCmdCols+@ccmd1)

	

	  
	   
 END_PROC:

	   IF ISNULL(@CERRMSG,'')<>'' 
	   BEGIN
		   SELECT @CERRMSG AS ERRMSG 
	   END
	   ELSE 
	   BEGIN
	        
		SET @CCMD = N'SELECT *  FROM '+@CTABLENAME+' '
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

	   END

	    SET @CCMD = N'IF OBJECT_ID(''TEMPDB..'+@CTABLENAME+''',''U'') IS NOT NULL
			DROP TABLE '+@CTABLENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

SET NOCOUNT OFF
END


