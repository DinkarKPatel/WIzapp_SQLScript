CREATE PROCEDURE SP_PPC_PRODUCTION_STATUS_REPORT    
(    
 @NQUERYID INT=1,
 @DASON AS DATETIME='2018-10-23',  
 @CORDER_ID VARCHAR(MAX)='' , 
 @CARTICLE_CODE VARCHAR(MAX)='',    
 @CSIZEGROUP VARCHAR(10)='', 
 @CPARA1_CODE VARCHAR(10)='',
 @CROW_ID VARCHAR(100)='',
 @CAC_CODE VARCHAR(MAX)=''
 
)    
AS    
BEGIN    
    
	   
DECLARE @DTSQL NVARCHAR(MAX),@CART_STATUS VARCHAR(MAX),@AAC_STATUS VARCHAR(MAX),    
        @CMERCHANTSTATUS VARCHAR(MAX)   ,@CORDSTATUS VARCHAR(MAX) 
    
		    
		IF @CARTICLE_CODE=''    
		BEGIN    
		   SET @CART_STATUS=''    
		   SET @CARTICLE_CODE='IN('''')'    
		END    
		ELSE     
		BEGIN    
		   SET @CART_STATUS='LATER'    
		END    
		    
		IF @CAC_CODE=''    
		BEGIN    
		   SET @AAC_STATUS=''    
		   SET @CAC_CODE='IN('''')'    
		END    
		ELSE     
		BEGIN    
		   SET @AAC_STATUS='LATER'    
		END   
		
		IF @CORDER_ID=''    
		BEGIN    
		   SET @CORDSTATUS=''    
		   SET @CORDER_ID='IN('''')'    
		END    
		ELSE     
		BEGIN    
		   SET @CORDSTATUS='LATER'    
		END    
		    
	
	  IF OBJECT_ID('TEMPDB..#TMPWO','U') IS NOT NULL    
			DROP TABLE #TMPWO    
		        
			SELECT A.AC_CODE,A.BILL_NO ,ORDER_NO,ORDER_DT,A.ORDER_ID,B.DELIVERY_DT,
					B.ARTICLE_CODE , B.PARA1_CODE,B.SIZEGROUP_CODE ,
					CAST(SUM(B.QUANTITY) AS NUMERIC(10,2)) AS ORDER_QTY,
					CAST(0 AS NUMERIC(10,2)) AS DLVRD,
					CAST(0 AS NUMERIC(10,2)) AS PENDING_BO,
					B.ROW_ID
			 INTO #TMPWO
			 FROM PPC_BUYER_ORDER_MST A
			 JOIN PPC_BUYER_ORDER_DET B ON A.ORDER_ID =B.ORDER_ID 
			 WHERE 1=2   
			 GROUP BY A.AC_CODE,A.BILL_NO ,ORDER_NO,ORDER_DT,A.ORDER_ID,B.DELIVERY_DT,
			 B.ARTICLE_CODE , B.PARA1_CODE,B.SIZEGROUP_CODE,B.ROW_ID  
		   
		     SET @DTSQL=N' SELECT A.AC_CODE,A.BILL_NO ,ORDER_NO,ORDER_DT,A.ORDER_ID,B.DELIVERY_DT,
					B.ARTICLE_CODE , B.PARA1_CODE,B.SIZEGROUP_CODE ,
					SUM(B.QUANTITY) AS ORDER_QTY,
					0 AS DLVRD,
					SUM(B.QUANTITY-ISNULL(ST.QUANTITY,0)) AS PENDING_BO,
					B.ROW_ID
			 FROM PPC_BUYER_ORDER_MST A (NOLOCK)
			 JOIN PPC_BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID 
			  JOIN
			 (
				SELECT BO_DET_ROW_ID  ,
					   SUM(QUANTITY) AS QUANTITY
				FROM PPC_FGBCG_MST A (NOLOCK)
				JOIN PPC_FGBCG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
				WHERE A.CANCELLED =0 
				GROUP BY BO_DET_ROW_ID
			 ) ST ON ST.BO_DET_ROW_ID=B.ROW_ID
			 WHERE A.CANCELLED =0
		   AND A.ORDER_DT<='''+CONVERT(VARCHAR(11),@DASON,120)+'''    
		  AND ('''+RTRIM(LTRIM(@CART_STATUS))+'''='''' OR B.ARTICLE_CODE '+@CARTICLE_CODE+')      
		  AND ('''+RTRIM(LTRIM(@AAC_STATUS))+'''='''' OR A.AC_CODE '+@CAC_CODE+')   
		   AND ('''+RTRIM(LTRIM(@CORDSTATUS))+'''='''' OR A.BILL_NO '+@CORDER_ID+')     
		  GROUP BY A.AC_CODE,A.BILL_NO ,ORDER_NO,ORDER_DT,A.ORDER_ID,B.DELIVERY_DT,
		  B.ARTICLE_CODE , B.PARA1_CODE,B.SIZEGROUP_CODE ,B.ROW_ID '    
		  PRINT @DTSQL    
		  INSERT INTO #TMPWO    
		  EXEC SP_EXECUTESQL @DTSQL    

       
		       
		       
		IF OBJECT_ID('TEMPDB..#TMPDLVRD','U') IS NOT NULL
		   DROP TABLE #TMPDLVRD

		SELECT A.ROW_ID AS BO_ROW_ID,
			   A.ORDER_QTY AS ORDER_QTY,
			   ISNULL(D.ISSUE_QTY,0) AS ISSUE_QTY,
			   A.ORDER_QTY-ISNULL(D.ISSUE_QTY,0) AS PENDING_FOR_ISSUE,
			   ISNULL(C.WSL_QTY,0) AS DLVRD
		INTO #TMPDLVRD
		FROM #TMPWO A
		LEFT JOIN
		(
			SELECT FG1.BO_DET_ROW_ID,SUM(ID.QUANTITY) AS WSL_QTY 
			FROM PPC_INM01106 IM  
			JOIN PPC_IND01106 ID ON IM.INV_ID=ID.INV_ID  
			JOIN PPC_FG_SKU SKU ON SKU.PRODUCT_CODE=ID.PRODUCT_CODE  
			JOIN PPC_FGBCG_DET FG1 ON FG1.ROW_ID=SKU.PPC_FGBCG_DET_ROW_ID  
			JOIN PPC_FGBCG_MST FGM ON FGM.MEMO_ID=FG1.MEMO_ID  
			WHERE IM.CANCELLED=0 AND FGM.CANCELLED =0
			GROUP BY FG1.BO_DET_ROW_ID
		) C ON A.ROW_ID=C.BO_DET_ROW_ID 
		LEFT OUTER JOIN
		(
		  SELECT FG1.BO_DET_ROW_ID,SUM(A.QUANTITY) AS ISSUE_QTY
		  FROM PPC_AGENCY_ISSUE_FG_FIRST_DET A
		  JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID 
		  JOIN PPC_FG_SKU SKU ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
		  JOIN PPC_FGBCG_DET FG1 ON FG1.ROW_ID=SKU.PPC_FGBCG_DET_ROW_ID  
		  JOIN PPC_FGBCG_MST FGM ON FGM.MEMO_ID=FG1.MEMO_ID  
		  WHERE  FGM.CANCELLED =0 AND  B.CANCELLED =0
		  GROUP BY FG1.BO_DET_ROW_ID

		) D ON A.ROW_ID=D.BO_DET_ROW_ID



     -- SELECT * INTO TMPWO FROM  #TMPWO
	 
	 
    
         IF OBJECT_ID('TEMPDB..#TMPJOBS','U') IS NOT NULL
           DROP TABLE #TMPJOBS
           
         IF OBJECT_ID('TEMPDB..#TMPJOBSDETAILS','U') IS NOT NULL
           DROP TABLE #TMPJOBSDETAILS
          
        SELECT PRODUCT_CODE ,A.MEMO_ID ,MEMO_DT ,JOBSR=1 ,B.JOB_CODE,JOBS.JOB_NAME ,
		A.QUANTITY AS ISSUE_QTY
		INTO #TMPJOBS
		FROM PPC_AGENCY_ISSUE_FG_FIRST_DET A
		JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID 
		JOIN JOBS  ON B.JOB_CODE=JOBS.JOB_CODE
		WHERE B.CANCELLED =0
        UNION ALL
        SELECT PRODUCT_CODE ,A.MEMO_ID ,MEMO_DT  ,JOBSR=2,B.JOB_CODE ,JOBS.JOB_NAME, 
        A.QUANTITY AS ISSUE_QTY
		FROM PPC_AGENCY_ISSUE_FG_DET A
		JOIN PPC_AGENCY_ISSUE_FG_MST B ON A.MEMO_ID =B.MEMO_ID 
	    JOIN JOBS  ON B.JOB_CODE=JOBS.JOB_CODE
		WHERE B.CANCELLED =0
       
       
        SELECT A.PRODUCT_CODE ,A.MEMO_ID ,A.MEMO_DT ,A.JOBSR ,A.JOB_CODE,A.JOB_NAME ,
                BO.PARA3_CODE,BO.ARTICLE_CODE,BO.PARA1_CODE,BO.SIZEGROUP_CODE,
		       A.ISSUE_QTY,MST.ORDER_ID  ,SKU.PARA2_CODE ,
			   PMT.QUANTITY_IN_STOCK AS JOB_QTY,
			   TPMT.QUANTITY_IN_STOCK ,
			   BO.ROW_ID
	    INTO #TMPPRODUCT
		FROM #TMPJOBS A
		JOIN PPC_FG_SKU SKU (NOLOCK) ON A.PRODUCT_CODE =SKU.PRODUCT_CODE 
		JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE 
		JOIN PPC_FGBCG_DET FGDET ON FGDET.ROW_ID =SKU.PPC_FGBCG_DET_ROW_ID 
		JOIN PPC_FGBCG_MST FGMST ON FGMST.MEMO_ID  =FGDET.MEMO_ID 
		JOIN PPC_BUYER_ORDER_DET BO ON BO.ROW_ID=FGDET.BO_DET_ROW_ID
		JOIN PPC_BUYER_ORDER_MST MST ON BO.ORDER_ID=MST.ORDER_ID
		LEFT JOIN PMT01106 TPMT ON PMT.PRODUCT_CODE =TPMT.PRODUCT_CODE 
		LEFT OUTER JOIN
		(
		 SELECT B.PRODUCT_CODE FROM PPC_INM01106 A
		 JOIN PPC_IND01106 B ON A.INV_ID =B.INV_ID
		 WHERE A.CANCELLED =0
		) INM ON A.PRODUCT_CODE =INM.PRODUCT_CODE 
		WHERE  MST.CANCELLED=0   AND  FGMST .CANCELLED=0
		AND INM.PRODUCT_CODE IS NULL
		--AND (@CORDER_ID ='' OR MST.ORDER_ID=@CORDER_ID)
		--AND (@CARTICLE_CODE ='' OR BO.ARTICLE_CODE=@CARTICLE_CODE)
		--AND (@CSIZEGROUP ='' OR BO.SIZEGROUP_CODE=@CSIZEGROUP)
		--AND (@CPARA1_CODE ='' OR BO.PARA1_CODE=@CPARA1_CODE)
		AND (@CROW_ID='' OR BO.ROW_ID=@CROW_ID)
		

		;WITH CTE AS
		(
         SELECT *,SR=ROW_NUMBER () OVER ( PARTITION BY PRODUCT_CODE  ORDER BY JOBSR DESC,MEMO_DT DESC,MEMO_ID DESC) 
         FROM #TMPPRODUCT
		
		)
		SELECT A.*
		INTO #TMPJOBSDETAILS 
		FROM  CTE A WHERE  A.SR=1
		
	IF @NQUERYID=1
	BEGIN	
	
		 SELECT A.AC_CODE,A.BILL_NO AS ORDER_NO,A.ORDER_NO AS SYS_ORDER_NO,
	         CONVERT(VARCHAR(10),A.ORDER_DT,105) AS ORDER_DT,
	         A.ORDER_ID,
             CONVERT(VARCHAR(10),A.DELIVERY_DT,105) AS DELIVERY_DT,
             A.ARTICLE_CODE,A.PARA1_CODE,
             A.SIZEGROUP_CODE,
             A.ORDER_QTY,
             ISNULL(DL.DLVRD ,0) AS DLVRD,
             ART.ARTICLE_NO,
	         P1.PARA1_NAME,SZ.SIZEGROUP_NAME,  
	         LM.AC_NAME,
	         A.ORDER_QTY-ISNULL(DL.DLVRD ,0) AS  PENDING_BO,
	         A.ROW_ID ,
	         ISNULL(WIP_QTY,0) AS WIP_QTY,
	         ISNULL(QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,
	         A.ORDER_QTY-ISNULL(DL.ISSUE_QTY,0) AS PENDING_FOR_ISSUE
	        -- CAST(A.ORDER_ID+A.ARTICLE_CODE +A.SIZEGROUP_CODE+ A.PARA1_CODE AS VARCHAR(100)) AS ROW_ID
      FROM #TMPWO  A
      JOIN #TMPDLVRD DL ON A.ROW_ID =DL.BO_ROW_ID
      JOIN ARTICLE ART ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
	  JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
	  JOIN PPC_SIZEGROUP SZ ON SZ.SIZEGROUP_CODE =A.SIZEGROUP_CODE  
	  JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
	  LEFT JOIN
	  (
	    SELECT ROW_ID ,
	     SUM(CASE WHEN ISNULL(A.JOB_QTY,0)>0 THEN JOB_QTY ELSE 0 END) AS WIP_QTY,
		 SUM(ISNULL(CONVERT(NUMERIC(10,0),QUANTITY_IN_STOCK),0)) AS QUANTITY_IN_STOCK
	    FROM #TMPJOBSDETAILS A
	    GROUP BY ROW_ID
	  ) ST ON ST.ROW_ID =A.ROW_ID 
      
    END
    ELSE
    BEGIN
		SELECT  A.ORDER_ID, A.PARA3_CODE,A.ARTICLE_CODE,A.PARA1_CODE,A.SIZEGROUP_CODE ,
		        A.JOB_CODE,A.JOB_NAME,
		        SUM(CASE WHEN ISNULL(A.JOB_QTY,0)=0 THEN 1 ELSE 0 END) AS JOB_QTY,
		        A.ROW_ID 
		      --  CAST(A.ORDER_ID+A.ARTICLE_CODE +A.SIZEGROUP_CODE+ A.PARA1_CODE AS VARCHAR(100)) AS ROW_ID
		FROM #TMPJOBSDETAILS A
        GROUP BY A.ORDER_ID, A.PARA3_CODE,A.ARTICLE_CODE ,
		A.JOB_CODE,A.JOB_NAME,A.PARA1_CODE,A.SIZEGROUP_CODE,
		A.ROW_ID 
		--CAST(A.ORDER_ID+A.ARTICLE_CODE +A.SIZEGROUP_CODE+ A.PARA1_CODE AS VARCHAR(100))
     END
     
	 
END
