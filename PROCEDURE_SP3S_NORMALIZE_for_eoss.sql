CREATE PROCEDURE SP3S_NORMALIZE_for_eoss
@nSpId VARCHAR(50)
as
BEGIN
	DECLARE @cCmdRowId VARCHAR(50),@nQty NUMERIC(5,0)

	WHILE EXISTS (SELECT TOP 1 a.product_code FROM #tmpCmd a JOIN sku b (NOLOCK) ON a.product_code=b.product_code
				  JOIN article c (NOLOCK) ON c.article_code=b.article_code	
				  WHERE quantity>1 AND not (ISNULL(b.barcode_coding_scheme,coding_scheme) IN (1,2) and discon=2))
	BEGIN
		SELECT TOP 1 @cCmdRowId=cmd_row_id,@nQty=quantity FROM  #tmpCmd  a JOIN sku b (NOLOCK) ON a.product_code=b.product_code
				  JOIN article c (NOLOCK) ON c.article_code=b.article_code	
				  WHERE quantity>1 AND not (ISNULL(b.barcode_coding_scheme,coding_scheme) IN (1,2) and discon=2)
		WHILE @nQty>0
		BEGIN
			INSERT #tmpCmd (PRODUCT_CODE,SUB_SECTION_CODE,QUANTITY,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,
							SCHEME_APPLIED_AMOUNT,SCHEME_SETUP_DET_ROW_ID,SCHEME_ID,DISCOUNT_PERCENTAGE,MRP,NET,
							CMD_ROW_ID,PACK_SLIP_ID,USER_CODE,BILL_LEVEL_DISCOUNT_PERCENTAGE,SLS_TITLE,BNGN_QTY,
							BNGN_DISCOUNT,WEIGHTED_AVG_DISC_PCT,WEIGHTED_AVG_DISC_AMT,ITEM_ROUND_OFF,APPLY_EXCLUSIVE_TAX,
							EXCLUSIVE_VAT_TO_DISC,CARD_DISCOUNT,BILL_LEVEL_DISCOUNT_AMOUNT,FORM_ID,PACK_SLIP_ROW_ID,
							MANUAL_TAX_METHOD,CARD_DISCOUNT_PERCENTAGE,BASIC_DISCOUNT_PERCENTAGE,CARD_DISCOUNT_AMOUNT,
							BASIC_DISCOUNT_AMOUNT,BNGN_ROW_ID,sp_id,ref_cmd_row_id,cmd_mrp,fix_mrp_item)
			SELECT PRODUCT_CODE,SUB_SECTION_CODE,1 as QUANTITY,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,
							SCHEME_APPLIED_AMOUNT,SCHEME_SETUP_DET_ROW_ID,SCHEME_ID,DISCOUNT_PERCENTAGE,MRP,NET,
							NEWID() AS CMD_ROW_ID,PACK_SLIP_ID,USER_CODE,BILL_LEVEL_DISCOUNT_PERCENTAGE,SLS_TITLE,BNGN_QTY,
							BNGN_DISCOUNT,WEIGHTED_AVG_DISC_PCT,WEIGHTED_AVG_DISC_AMT,ITEM_ROUND_OFF,APPLY_EXCLUSIVE_TAX,
							EXCLUSIVE_VAT_TO_DISC,CARD_DISCOUNT,BILL_LEVEL_DISCOUNT_AMOUNT,FORM_ID,PACK_SLIP_ROW_ID,
							MANUAL_TAX_METHOD,CARD_DISCOUNT_PERCENTAGE,BASIC_DISCOUNT_PERCENTAGE,CARD_DISCOUNT_AMOUNT,
							BASIC_DISCOUNT_AMOUNT,BNGN_ROW_ID,sp_id,cmd_row_id as ref_cmd_row_id,cmd_mrp,fix_mrp_item
							FROM #tmpCmd WHERE 	cmd_row_id=@cCmdRowId
			
			SET @nQty=@nQty-1
		END

		DELETE FROM #tmpCmd WHERE cmd_row_id=@cCmdRowId AND quantity>1
	END

END