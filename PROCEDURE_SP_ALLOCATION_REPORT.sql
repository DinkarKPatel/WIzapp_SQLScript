CREATE PROC SP_ALLOCATION_REPORT
(
@CUSER_CODE VARCHAR(MAX)='',
@CARTICLE_CODE VARCHAR(MAX)='',
@NPENDING INT=0,
@cac_code varchar(100)=''
)
AS
BEGIN

DECLARE @DTSQL NVARCHAR(MAX),@CART_STATUS VARCHAR(MAX),@CUSER_STATUS VARCHAR(MAX)

IF @CARTICLE_CODE=''
BEGIN
SET @CART_STATUS=''
SET @CARTICLE_CODE='IN('''')'
END
ELSE
BEGIN
SET @CART_STATUS='LATER'
END

SET @DTSQL= N'SELECT U.USERNAME, A.MEMO_NO ,A.MEMO_DT AS ALLOCATION_DT,ART.ARTICLE_NO ,
D.PRODUCT_CODE ,P1.PARA1_NAME ,P2.PARA2_NAME,
BM.ORDER_NO ,BM.ORDER_DT ,LM.AC_NAME AS BUYER_NAME ,
WO.MEMO_NO AS WO_NO,
WO.MEMO_DT AS WO_DT ,
JOBS .JOB_NAME ,
PMT.QUANTITY_IN_STOCK
FROM BUYER_ORDER_ALLOCATE_MST A
JOIN BUYER_ORDER_ALLOCATE_DET B ON A.MEMO_ID =B.MEMO_ID
JOIN BUYER_ORDER_ALLOCATE_SUB_DET C ON B.ROW_ID =C.REF_ROW_ID
JOIN BUYER_ORDER_ALLOCATE_BARCODE D ON C.ROW_ID =D.REF_ROW_ID
JOIN ARTICLE ART ON ART.ARTICLE_CODE =A.ARTICLE_CODE
JOIN PARA1 P1 ON P1.PARA1_CODE =A.PARA1_CODE
JOIN PARA2 P2 ON P2.PARA2_CODE =A.PARA2_CODE
JOIN BUYER_ORDER_MST BM ON BM.ORDER_ID =C.BUYER_ORDER_ID
JOIN LM01106 LM ON LM.AC_CODE =BM.AC_CODE
JOIN JOBWORK_PMT PMT ON PMT.PRODUCT_CODE =D.PRODUCT_CODE
JOIN
(
 SELECT PRODUCT_CODE  ,C.MEMO_NO,C.MEMO_DT
 FROM ORD_PLAN_BARCODE_DET A (NOLOCK)
 JOIN ORD_PLAN_DET B (NOLOCK) ON A.REFROW_ID=B.ROW_ID
 JOIN ORD_pLAN_MST C (NOLOCK) ON B.MEMO_ID=C.MEMO_ID 
 WHERE C.CANCELLED=0

) WO ON WO.PRODUCT_CODE=PMT.PRODUCT_CODE 
LEFT JOIN JOBS ON JOBS.JOB_CODE =PMT.JOB_CODE
LEFT JOIN USERS U ON U.USER_CODE=BM.USER_CODE
LEFT JOIN
(
SELECT A.PRODUCT_CODE AS PRODUCT_CODE 
FROM TRANSFER_TO_TRADING_DET A
JOIN TRANSFER_TO_TRADING_MST B ON A.MEMO_ID =B.MEMO_ID
WHERE B.CANCELLED =0
) TTM ON TTM.PRODUCT_CODE=PMT.PRODUCT_CODE
WHERE A.CANCELLED=0  
AND ('''+RTRIM(LTRIM(@CART_STATUS))+'''='''' OR ART.ARTICLE_CODE '+@CARTICLE_CODE+')
AND ('''+RTRIM(LTRIM(@CUSER_CODE))+'''='''' OR BM.USER_CODE= '''+@CUSER_CODE+''')
AND ('''+RTRIM(LTRIM(@CUSER_CODE))+'''='''' OR lm.ac_CODE= '''+@cac_code+''')
AND ('''+RTRIM(LTRIM(@NPENDING))+'''=''0'' OR TTM.PRODUCT_CODE IS NULL)
ORDER BY U.USERNAME,ART.ARTICLE_NO ,P1.PARA1_NAME ,P2.PARA2_NAME,LM.AC_NAME,A.MEMO_DT,A.MEMO_NO '

PRINT @DTSQL
EXEC SP_EXECUTESQL @DTSQL

END
