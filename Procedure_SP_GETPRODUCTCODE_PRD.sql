CREATE PROCEDURE SP_GETPRODUCTCODE_PRD
@CUSERCODE	VARCHAR(100),
@NQTY		NUMERIC(10,2),
@CPRODUCTCODE	VARCHAR(MAX),
@cLOCID		VARCHAR(5)='',
@cjobcardId varchar(50)=''
--WITH ENCRYPTION
AS
BEGIN

    IF @NQTY=0
	  SET @NQTY=1

	  DECLARE @CUSERFILTER VARCHAR(1000),@DTSQL NVARCHAR(MAX)

	IF ISNULL(@CLOCID,'')=''
		SELECT @CLOCID	=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
		declare @cMATERIAL_ISSUE_ONLY_ALLOCATED_STOCK varchar(10),@CORDER_ID VARCHAR(30)

		SELECT @CMATERIAL_ISSUE_ONLY_ALLOCATED_STOCK=VALUE FROM CONFIG WHERE CONFIG_OPTION='MATERIAL_ISSUE_ONLY_ALLOCATED_STOCK'


	    IF @CUSERCODE='0000000'
		   SET @CUSERFILTER=''
		ELSE 
		  SET @CUSERFILTER=' AND LOC.USER_CODE='''+@CUSERCODE +''''


		SET @CORDER_ID=''
		IF @CMATERIAL_ISSUE_ONLY_ALLOCATED_STOCK='1'
		begin

		    SELECT TOP 1 @CORDER_ID=ORDER_ID 
			FROM ORD_PLAN_DET A (nolock)
			JOIN BUYER_ORDER_DET B (nolock) ON A.WOD_ROW_ID =B.ROW_ID 
			WHERE A.MEMO_ID =@CJOBCARDID

		

		   IF ISNULL(@CORDER_ID,'')=''
		   SET @CORDER_ID= 'LATER'

		   SET @DTSQL=' SELECT DISTINCT  SKU.PRODUCT_CODE,ART.ARTICLE_CODE,ART.ARTICLE_NO +''/''+P1.PARA1_NAME+''/''+P2.PARA2_NAME+''/''+P3.PARA3_NAME+''/''+P4.PARA4_NAME+''/''+P5.PARA5_NAME+''/''+P6.PARA6_NAME AS ARTICLE_NO,ART.ARTICLE_NAME,
		   P.QUANTITY_IN_STOCK AS [QUANTITY],P.BIN_ID ,SKU.PURCHASE_PRICE AS RATE ,P.BO_ORDER_ID AS BOM_ORDER_ID
		   FROM SKU (NOLOCK)      
		   JOIN PMT01106 P (NOLOCK) ON P.PRODUCT_CODE=SKU.PRODUCT_CODE    
		   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE
		   JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=SKU.PARA1_CODE
		   JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=SKU.PARA2_CODE
		   JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE=SKU.PARA3_CODE
		   JOIN PARA4 P4 (NOLOCK) ON P4.PARA4_CODE=SKU.PARA4_CODE
		   JOIN PARA5 P5 (NOLOCK) ON P5.PARA5_CODE=SKU.PARA5_CODE
		   JOIN PARA6 P6 (NOLOCK) ON P6.PARA6_CODE=SKU.PARA6_CODE
		   LEFT OUTER JOIN BINUSERS LOC (NOLOCK) ON LOC.BIN_ID=P.BIN_ID AND LOC.USER_CODE='''+@CUSERCODE+'''  
		   WHERE  SKU.PRODUCT_CODE<>''''   AND P.DEPT_ID ='''+@CLOCID+'''
		   AND P.BO_ORDER_ID='''+@CORDER_ID+'''
		    AND (ART.STOCK_NA=1 OR P.QUANTITY_IN_STOCK>0)
		   '+@CUSERFILTER+'
		   ORDER BY SKU.PRODUCT_CODE'
		   PRINT @DTSQL
		   EXEC SP_EXECUTESQL @DTSQL




		   -- AND (ART.STOCK_NA=1 OR (P.QUANTITY_IN_STOCK>0 AND @NQTY>0) OR ( @NQTY<0)  )  
		   --AND @CUSERCODE=(CASE WHEN @CUSERCODE='0000000' THEN @CUSERCODE ELSE LOC.USER_CODE END)  
		end
		ELSE
		BEGIN



		if exists (select top 1'u' from ORD_PLAN_MST where MEMO_ID =@CJOBCARDID and isnull(JobCardType,0)=0)
		begin

		    IF OBJECT_ID ('TEMPDB..#TMPBOM','U') IS NOT NULL
			   DROP TABLE #TMPBOM

			   SELECT ARTICLE_CODE INTO #TMPBOM 
			   FROM ORD_PLAN_BOM_DET (NOLOCK) 
			   WHERE MEMO_ID =@CJOBCARDID AND QUANTITY >0
			   GROUP BY ARTICLE_CODE

		 
		  SET @DTSQL='SELECT TOP 100  SKU.PRODUCT_CODE,SKU.ARTICLE_CODE,ART.ARTICLE_NO +''/''+P1.PARA1_NAME+''/''+P2.PARA2_NAME+''/''+P3.PARA3_NAME+''/''+P4.PARA4_NAME+''/''+P5.PARA5_NAME+''/''+P6.PARA6_NAME AS ARTICLE_NO,ART.ARTICLE_NAME,
		             P.QUANTITY_IN_STOCK AS [QUANTITY],P.BIN_ID ,SKU.PURCHASE_PRICE AS RATE ,P.BO_ORDER_ID AS BOM_ORDER_ID
		   FROM SKU  (NOLOCK)      
		   JOIN PMT01106 P (NOLOCK) ON P.PRODUCT_CODE=SKU.PRODUCT_CODE    
		   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE
		   JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=SKU.PARA1_CODE
		   JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=SKU.PARA2_CODE
		   JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE=SKU.PARA3_CODE
		   JOIN PARA4 P4 (NOLOCK) ON P4.PARA4_CODE=SKU.PARA4_CODE
		   JOIN PARA5 P5 (NOLOCK) ON P5.PARA5_CODE=SKU.PARA5_CODE
		   JOIN PARA6 P6 (NOLOCK) ON P6.PARA6_CODE=SKU.PARA6_CODE
		   JOIN #TMPBOM BOM ON BOM.ARTICLE_CODE =ART.ARTICLE_CODE
		   LEFT OUTER JOIN BINUSERS LOC (NOLOCK) ON LOC.BIN_ID=P.BIN_ID AND LOC.USER_CODE='''+@CUSERCODE+'''  
		   WHERE  SKU.PRODUCT_CODE<>''''   AND P.DEPT_ID ='''+@CLOCID+'''
		   AND (ART.STOCK_NA=1 OR P.QUANTITY_IN_STOCK>0) and p.bin_id<>''999'' AND SKU.PRODUCT_CODE LIKE '''+@CPRODUCTCODE+'%''
		   '+@CUSERFILTER+'
		   ORDER BY PRODUCT_CODE '
		   PRINT @DTSQL
		   EXEC SP_EXECUTESQL @DTSQL

      
	  end
	  else
	  begin

	      SET @DTSQL='SELECT  TOP 100 SKU.PRODUCT_CODE,ART.ARTICLE_CODE,ART.ARTICLE_NO +''/''+SKU.PARA1_NAME+''/''+SKU.PARA2_NAME+''/''+SKU.PARA3_NAME+''/''+SKU.PARA4_NAME+''/''+SKU.PARA5_NAME+''/''+SKU.PARA6_NAME AS ARTICLE_NO,ART.ARTICLE_NAME,
		             P.QUANTITY_IN_STOCK AS [QUANTITY],P.BIN_ID ,SKU.pp AS RATE ,P.BO_ORDER_ID AS BOM_ORDER_ID
		   FROM SKU_NAMES SKU (NOLOCK)      
		   JOIN PMT01106 P (NOLOCK) ON P.PRODUCT_CODE=SKU.PRODUCT_CODE    
		   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_NO=SKU.ARTICLE_NO
		   LEFT OUTER JOIN BINUSERS LOC (NOLOCK) ON LOC.BIN_ID=P.BIN_ID AND LOC.USER_CODE='''+@CUSERCODE+'''  
		   WHERE  SKU.PRODUCT_CODE<>''''   AND P.DEPT_ID ='''+@CLOCID+'''
		   AND (ART.STOCK_NA=1 OR P.QUANTITY_IN_STOCK>0) AND SKU.PRODUCT_CODE LIKE '''+@CPRODUCTCODE+'%''
		   '+@CUSERFILTER+'
		   ORDER BY PRODUCT_CODE '
		   PRINT @DTSQL
		   EXEC SP_EXECUTESQL @DTSQL
	    

	  end

	END
		

	
	
  
END


