CREATE PROCEDURE SP3S_UPDATE_LOCATION_STOCKATRSP
AS
BEGIN
          
         DECLARE @LOC_ID VARCHAR(5),@HO_LOC_ID varCHAR(5),@DATE NVARCHAR(MAX)  ,@PMTDT varchar(15)
         SELECT @LOC_ID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
         SELECT @HO_LOC_ID=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'
         SELECT @DATE=CAST(GETDATE() AS DATE)
         SELECT @PMTDT=  CONVERT(VARCHAR(10),GETDATE(),112)
         
         IF 1=1
         BEGIN
			IF EXISTS(SELECT TOP 1'U' FROM LOCATION WHERE ISNULL(RESTRICTMAXSTOCKATRSP,0)=1)
			BEGIN
				DECLARE @CCMD NVARCHAR(MAX),@DB_NAME NVARCHAR(MAX)
				SET @DB_NAME=''
				--SELECT @DB_NAME=DB_NAME()+'_RFOPT.DBO.RF_OPT'
				SELECT @DB_NAME=DB_NAME()+'_pmt.DBO.pmtlocs_' + @PMTDT						
				

				SET @CCMD=N' UPDATE A SET CURRENTSTOCKATRSP=CBM
				FROM LOCATION A WITH(ROWLOCK)
				JOIN
				(
				SELECT [MAJOR_DEPT_ID],SUM(ISNULL(CBM , 0)) AS CBM
				FROM 
				(
				SELECT LOCATION.[MAJOR_DEPT_ID]
				,SUM(A.quantity_in_stock*sku.mrp) AS CBM
				FROM PMT01106 A  (NOLOCK) 
				JOIN SKU (NOLOCK) ON A.PRODUCT_CODE = SKU.PRODUCT_CODE 
				JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE 
				JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
				JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE AND SECTIONM.ITEM_TYPE=1         
				JOIN LOCATION  (NOLOCK) ON A.DEPT_ID = LOCATION.DEPT_ID
				WHERE ( LOCATION.INACTIVE IN (0) AND LOCATION.REPORT_BLOCKED IN (0)) AND  SKU.ER_FLAG IN (''0'' , ''1'' )
				AND ISNULL(RESTRICTMAXSTOCKATRSP,0)=1
				GROUP BY LOCATION.[MAJOR_DEPT_ID]

				) B 
				GROUP BY [MAJOR_DEPT_ID] HAVING NOT(SUM(ISNULL(CBM,0))= 0 ) 
				)C ON A.DEPT_ID=C.MAJOR_DEPT_ID WHERE ISNULL(A.RESTRICTMAXSTOCKATRSP,0)=1'
				PRINT @CCMD
				EXEC SP_EXECUTESQL @CCMD

			END
																	   
                  
                 
         END
         
END





