CREATE PROCEDURE SPACT_GETVOUCHERNO
(
	@CVOUCHERCODE VARCHAR(10) 
   ,@DVOUCHERDATE DATETIME
   ,@CDEPTID	  VARCHAR(5)=''
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CVOUCHERNOGENMODE  VARCHAR(2)
		   ,@CVOUCHERNO			VARCHAR(15)		
		   ,@CVOUCHERPREFIX		VARCHAR(5)
		   ,@CNEWREFNO			VARCHAR(15)
		   ,@CNEWDOCNO			VARCHAR(15)

	IF ISNULL(@CDEPTID,'')=''		   		
		SELECT TOP 1 @CDEPTID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	
	SELECT @CVOUCHERNOGENMODE = ISNULL(VALUE,0) 
	FROM CONFIG 
	WHERE CONFIG_OPTION = 'VOUCHER_NO_SYSTEM' 

	SET @CVOUCHERPREFIX = (CASE WHEN @CVOUCHERCODE = '0000000002' THEN 'P' 
						        WHEN @CVOUCHERCODE = '0000000003' THEN 'R'
						        ELSE '' END)+@CDEPTID

	/*
		@CVOUCHERNOGENMODE : 
		1  - DATEWISE SERIES
		2  - TYPEWISE SERIES
		3  - RUNNING SERIAL
	*/
	
	BEGIN TRANSACTION 
	
	EXEC GETNEXTVCHNO  
		 @DVCHDT		=@DVOUCHERDATE,
		 @CVCHCODE		=@CVOUCHERCODE,
		 @NMODE			=@CVOUCHERNOGENMODE,
		 @NWIDTH		=10,
		 @CCOMPANYCODE	='01',
		 @CPREFIX		=@CVOUCHERPREFIX,
		 @CNEWKEYVAL	=@CVOUCHERNO OUTPUT  

	EXEC GETNEXTKEY	
		  @CTABLENAME='VM01106'
		 ,@CCOLNAME='REF_NO'
		 ,@NWIDTH=10
		 ,@CPREFIX=@CDEPTID
		 ,@NLZEROS=0
		 ,@CFINYEAR=@CVOUCHERCODE
		 ,@NROWCOUNT=0
		 ,@CNEWKEYVAL=@CNEWREFNO OUTPUT		
	
	EXEC GETNEXTKEY	
		  @CTABLENAME='VM01106'
		 ,@CCOLNAME='DOCNO'
		 ,@NWIDTH=10
		 ,@CPREFIX=@CDEPTID
		 ,@NLZEROS=0
		 ,@CFINYEAR=''
		 ,@NROWCOUNT=0
		 ,@CNEWKEYVAL=@CNEWDOCNO OUTPUT		
		 	 
	ROLLBACK
	
	SELECT @CVOUCHERNO AS VOUCHERNO,@CNEWREFNO AS REFNO,@CNEWDOCNO AS DOCNO
END
