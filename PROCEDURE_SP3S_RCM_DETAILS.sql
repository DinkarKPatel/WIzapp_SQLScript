CREATE PROCEDURE SP3S_RCM_DETAILS
(
  @NQUERYID INT=0,
  @DFM_DT DATETIME,
  @DTODT DATETIME,
  @CMEMO_ID VARCHAR(50)='',
  @CXN_TYPE VARCHAR(5)='PUR',
  @CLOCID VARCHAR(5)=''
)
AS
BEGIN
   DECLARE @CCURDEPT_ID VARCHAR(5),@CHODEPT_ID VARCHAR(5)

   SELECT TOP 1 @CHODEPT_ID=VALUE  FROM CONFIG WHERE CONFIG_OPTION ='HO_LOCATION_ID'

   IF @CLOCID=''
   SELECT TOP 1 @CCURDEPT_ID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
   ELSE
   SET @CCURDEPT_ID=@CLOCID
   
   IF @CHODEPT_ID<>@CCURDEPT_ID
      RETURN
      
  
  IF @CXN_TYPE='PUR'    
  BEGIN
   IF @CMEMO_ID =''
      BEGIN
        IF OBJECT_ID('TEMPDB..#TMPRCM','U') IS NOT NULL
           DROP TABLE #TMPRCM
            
        SELECT DISTINCT A.MRR_ID
        INTO #TMPRCM  
        FROM PID01106 (NOLOCK) A
        JOIN PIM01106 (NOLOCK) B ON A.MRR_ID =B.MRR_ID
        JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =B.AC_CODE 
        LEFT OUTER JOIN 
        ( SELECT B.MEMO_ID  FROM RCM01106 A
          JOIN  RCM_PUR_EXPENSE B ON A.MEMO_ID =B.RCM_MEMO_ID 
          WHERE A.CANCELLED =0 AND B.XN_TYPE='PUR'
         ) RCM ON RCM.MEMO_ID=A.MRR_ID 
        WHERE B.CANCELLED=0 
        AND B.INV_MODE=1 AND B.MEMO_TYPE=1
        AND ISNULL(LMP.REGISTERED_GST_DEALER,0)=0
        AND B.MRR_DT BETWEEN @DFM_DT AND @DTODT
        AND ISNULL(A.GST_PERCENTAGE,0)=0  AND RCM.MEMO_ID IS NULL
      END
      
   IF @NQUERYID=1
      GOTO LBLMST
   ELSE IF @NQUERYID=2
      GOTO LBLSUPPLIER
   ELSE 
      GOTO END_PROC
   
    LBLSUPPLIER:
	  SELECT AC_CODE,AC_NAME FROM LM01106  
	  ORDER BY AC_NAME 
    GOTO END_PROC  
  
      
   LBLMST:
   IF @CMEMO_ID=''
      BEGIN
      
      
			
        IF OBJECT_ID('TEMPDB..#TMPRCD','U') IS NOT NULL
           DROP TABLE #TMPRCD
             
        SELECT PID.MRR_ID,PIM.MRR_DT,
        CAST('LATER' AS VARCHAR(22)) AS MEMO_ID,
        HSN_CODE=CASE WHEN ISNULL(PID.HSN_CODE,'') NOT IN ('','0000000000') THEN PID.HSN_CODE
		              WHEN ISNULL(SKU.HSN_CODE,'') NOT IN ('','0000000000') THEN SKU.HSN_CODE  
			          ELSE HM.HSN_CODE 
			     END, 
        (PID.QUANTITY) AS  QUANTITY,
        (PID.XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST ,
        CAST(0 AS NUMERIC(6,2)) AS GST_PERCENTAGE ,
        CAST(0 AS NUMERIC(12,2))AS IGST_AMOUNT ,
        CAST(0 AS NUMERIC(12,2))AS SGST_AMOUNT ,
        CAST(0 AS NUMERIC(12,2))AS CGST_AMOUNT ,
        CAST(0 AS NUMERIC(12,2)) AS XN_VALUE_WITH_GST,
        CAST('LATER' AS VARCHAR(100)) AS ROW_ID,
        PID.ROW_ID AS PID_ROW_ID,
        1 AS TAX_METHOD,
        PIM.FIN_YEAR,GETDATE() AS LAST_UPDATE
        INTO #TMPRCD
        FROM #TMPRCM TMP
        JOIN PID01106 PID (NOLOCK) ON TMP.MRR_ID =PID.MRR_ID 
        JOIN PIM01106 PIM (NOLOCK) ON PIM.MRR_ID=PID.MRR_ID
        JOIN SKU (NOLOCK) SKU ON PID.PRODUCT_CODE=SKU.PRODUCT_CODE 
		JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
		
		LEFT JOIN HSN_MST HM (NOLOCK) ON HM.HSN_CODE=ART.HSN_CODE 
        
        
        IF OBJECT_ID('TEMPDB..#TMPHSN','U') IS NOT NULL
			   DROP TABLE #TMPHSN

			;WITH CTE AS
			(
			SELECT C.HSN_CODE,C.TAX_PERCENTAGE,C.RATE_CUTOFF,C.RATE_CUTOFF_TAX_PERCENTAGE,C.WEF,B.TAXABLE_ITEM,B.HSN_TYPE ,  
				  SR=ROW_NUMBER() OVER (PARTITION BY A.PID_ROW_ID ORDER BY WEF DESC)
			FROM #TMPRCD A
			JOIN HSN_MST B ON A.HSN_CODE =B.HSN_CODE 
			JOIN HSN_DET C ON B.HSN_CODE =C.HSN_CODE AND C.WEF  <=MRR_DT 
			)

			SELECT * INTO #TMPHSN FROM CTE WHERE SR=1
			       
        UPDATE TMP SET GST_PERCENTAGE=CASE WHEN HM.RATE_CUTOFF<TMP.XN_VALUE_WITHOUT_GST/TMP.QUANTITY THEN HM.TAX_PERCENTAGE ELSE RATE_CUTOFF_TAX_PERCENTAGE END ,
				   IGST_AMOUNT=0, SGST_AMOUNT=0
		FROM #TMPRCD TMP
		JOIN #TMPHSN HM (NOLOCK) ON HM.HSN_CODE=TMP.HSN_CODE 
			
        UPDATE TMP SET XN_VALUE_WITH_GST=ROUND(XN_VALUE_WITHOUT_GST+(XN_VALUE_WITHOUT_GST*(CASE WHEN TAX_METHOD=2 THEN 0 ELSE ((ISNULL(TMP.GST_PERCENTAGE,0))/100) END)) ,2)	  
		FROM #TMPRCD TMP
				
        UPDATE TMP SET IGST_AMOUNT=0
                ,CGST_AMOUNT=ROUND(( XN_VALUE_WITHOUT_GST*(CASE WHEN TAX_METHOD=2 THEN (TMP.GST_PERCENTAGE/  
				 (100 + TMP.GST_PERCENTAGE)) ELSE (TMP.GST_PERCENTAGE/100) END) )/2,2)
				,SGST_AMOUNT=ROUND((XN_VALUE_WITHOUT_GST*(CASE WHEN TAX_METHOD=2 THEN (TMP.GST_PERCENTAGE/  
				 (100 + TMP.GST_PERCENTAGE)) ELSE (TMP.GST_PERCENTAGE/100) END) )/2,2)
        FROM #TMPRCD TMP
			
		DECLARE @FREIGHT_HSN_CODE VARCHAR(20),@OTHER_CHARGES_HSN_CODE VARCHAR(20)
		DECLARE @MAXGST_PERCENTAGE NUMERIC(10,2)
		
		IF EXISTS(SELECT TOP 1 'U' FROM GST_OH_CONFIG WHERE XN_TYPE='PUR')
           BEGIN
             SELECT TOP 1 @FREIGHT_HSN_CODE=HSN_CODE FROM GST_OH_CONFIG WHERE OH_NAME='FREIGHT' AND XN_TYPE='PUR'
             SELECT TOP 1 @OTHER_CHARGES_HSN_CODE=HSN_CODE FROM GST_OH_CONFIG WHERE OH_NAME='OC' AND XN_TYPE='PUR'
           END
        ELSE
           BEGIN
             SELECT TOP 1 @FREIGHT_HSN_CODE=HSN_CODE FROM GST_OH_CONFIG WHERE OH_NAME='FREIGHT' 
             SELECT TOP 1 @OTHER_CHARGES_HSN_CODE=HSN_CODE FROM GST_OH_CONFIG WHERE OH_NAME='OC'  
           END
           
        IF OBJECT_ID('TEMPDB..#TMPRCM1','U') IS NOT NULL
           DROP TABLE #TMPRCM1
	         
		SELECT A.MRR_NO,A.MRR_DT, 
			   'LATER' AS MEMO_NO,
			   CAST('' AS DATETIME) AS MEMO_DT,
			   CAST('LATER' AS VARCHAR(22)) AS MEMO_ID,
			   CAST(0 AS BIT) AS CANCELLED,
               A.MRR_ID,
               CASE WHEN ISNULL(FRIGHT_PAY_MODE,0)=2 THEN 0 ELSE  FREIGHT END  AS FREIGHT,
               ISNULL(A.FREIGHT_HSN_CODE,'0000000000') AS FREIGHT_HSN_CODE,
               A.FREIGHT_GST_PERCENTAGE,
               A.FREIGHT_IGST_AMOUNT,A.FREIGHT_CGST_AMOUNT,A.FREIGHT_SGST_AMOUNT,
			   A.OTHER_CHARGES,
			   A.OTHER_CHARGES_GST_PERCENTAGE,
			   ISNULL(A.OTHER_CHARGES_HSN_CODE,'0000000000') AS OTHER_CHARGES_HSN_CODE,
			   A.OTHER_CHARGES_IGST_AMOUNT,
			   A.OTHER_CHARGES_CGST_AMOUNT,
			   A.OTHER_CHARGES_SGST_AMOUNT,
			   CAST(0 AS NUMERIC(10,2))  AS TOTAL_REVERSE_CHARGES,
			   CAST(0 AS NUMERIC(10,2)) AS ROUND_OFF,
			   CASE WHEN ISNULL(A.OH_TAX_METHOD,0)=1 THEN 'EXCLUSIVE' ELSE 'INCLUSIVE' END OH_TAX_METHOD_NAME,
			   ISNULL(A.OH_TAX_METHOD,0) AS OH_TAX_METHOD,
			   ISNULL(A.FREIGHT_TAXABLE_VALUE,0) AS FREIGHT_TAXABLE_VALUE,
			   ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0) AS OTHER_CHARGES_TAXABLE_VALUE,
			   A.FIN_YEAR
			  ,LM.AC_CODE
			  ,LM.AC_NAME
		INTO #TMPRCM1   
		FROM #TMPRCM TMP
		JOIN PIM01106 A ON TMP.MRR_ID =A.MRR_ID   
		JOIN LM01106 LM ON A.AC_CODE=LM.AC_CODE
		WHERE A.MRR_DT BETWEEN @DFM_DT AND @DTODT
		ORDER BY MRR_DT 
			
			 
		UPDATE #TMPRCM1 SET FREIGHT_HSN_CODE=CASE WHEN ISNULL(FREIGHT,0)>0 THEN  @FREIGHT_HSN_CODE ELSE '0000000000' END,
                       OTHER_CHARGES_HSN_CODE=CASE WHEN ISNULL(OTHER_CHARGES,0)>0 THEN  @OTHER_CHARGES_HSN_CODE ELSE '0000000000' END  --FROM #TMPRCM1 TMP
        
        
	    UPDATE TMP SET OTHER_CHARGES_GST_PERCENTAGE=CASE  WHEN OTHER_CHARGES>0 THEN  MAXGST_PERCENTAGE ELSE 0 END,
                       FREIGHT_GST_PERCENTAGE=CASE  WHEN FREIGHT>0 THEN  MAXGST_PERCENTAGE ELSE 0 END
        FROM #TMPRCM1 TMP
        JOIN
        (
          SELECT MRR_ID,MAX(GST_PERCENTAGE) AS   MAXGST_PERCENTAGE
          FROM #TMPRCD
          GROUP BY MRR_ID
        ) B ON TMP.MRR_ID=B.MRR_ID
                
                
                
        UPDATE TMP SET FREIGHT_IGST_AMOUNT=0,
                       OTHER_CHARGES_IGST_AMOUNT=0,
                FREIGHT_SGST_AMOUNT =
			    ROUND(
					ISNULL(FREIGHT,0)*(CASE WHEN OH_TAX_METHOD=2 THEN (TMP.FREIGHT_GST_PERCENTAGE/  
					(100 + TMP.FREIGHT_GST_PERCENTAGE)) ELSE (TMP.FREIGHT_GST_PERCENTAGE/100) END)/2
		        ,2)
		        
		        ,FREIGHT_CGST_AMOUNT =
			     ROUND(
					ISNULL(FREIGHT,0)*(CASE WHEN OH_TAX_METHOD=2 THEN (TMP.FREIGHT_GST_PERCENTAGE/  
					(100 + TMP.FREIGHT_GST_PERCENTAGE)) ELSE (TMP.FREIGHT_GST_PERCENTAGE/100) END)/2
		         ,2) 
		         
				,OTHER_CHARGES_CGST_AMOUNT=
				 ROUND(
					ISNULL(OTHER_CHARGES,0)*(CASE WHEN OH_TAX_METHOD=2 THEN (TMP.OTHER_CHARGES_GST_PERCENTAGE/  
					(100 + TMP.OTHER_CHARGES_GST_PERCENTAGE)) ELSE (TMP.OTHER_CHARGES_GST_PERCENTAGE/100) END)/2
		        ,2)
		        
				,OTHER_CHARGES_SGST_AMOUNT=
				ROUND(
					ISNULL(OTHER_CHARGES,0)*(CASE WHEN OH_TAX_METHOD=2 THEN (TMP.OTHER_CHARGES_GST_PERCENTAGE/  
					(100 + TMP.OTHER_CHARGES_GST_PERCENTAGE)) ELSE (TMP.OTHER_CHARGES_GST_PERCENTAGE/100) END)/2
		        ,2)
		FROM #TMPRCM1 TMP
		
		
		 UPDATE TMP SET ROUND_OFF=ROUND((XN_VALUE_WITHOUT_GST +  OTHER_CHARGES +   
         CASE WHEN OH_TAX_METHOD=2 THEN 0 ELSE ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(FREIGHT_IGST_AMOUNT,0)+ISNULL(FREIGHT_CGST_AMOUNT,0)+ISNULL(FREIGHT_SGST_AMOUNT,0) END +
         ISNULL(FREIGHT,0) ),0)-
         (XN_VALUE_WITHOUT_GST+  +OTHER_CHARGES+  
         CASE WHEN OH_TAX_METHOD=2 THEN 0 ELSE  ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(FREIGHT_IGST_AMOUNT,0)+ISNULL(FREIGHT_CGST_AMOUNT,0)+ISNULL(FREIGHT_SGST_AMOUNT,0) END+
         ISNULL(FREIGHT,0) ) 
        FROM #TMPRCM1 TMP
        JOIN
        (
          SELECT MRR_ID,SUM(ISNULL(XN_VALUE_WITHOUT_GST,0)) AS   XN_VALUE_WITHOUT_GST
          FROM #TMPRCD
          GROUP BY MRR_ID
        ) B ON TMP.MRR_ID=B.MRR_ID	
        
        
        UPDATE TMP SET TOTAL_REVERSE_CHARGES=(XN_VALUE_WITHOUT_GST + OTHER_CHARGES +   
        CASE WHEN OH_TAX_METHOD=2 THEN 0 ELSE  ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(FREIGHT_IGST_AMOUNT,0)+ISNULL(FREIGHT_CGST_AMOUNT,0)+ISNULL(FREIGHT_SGST_AMOUNT,0) END+
        ISNULL(FREIGHT,0)+ROUND_OFF) 
        FROM #TMPRCM1 TMP
        JOIN
        (
          SELECT MRR_ID,SUM(ISNULL(XN_VALUE_WITHOUT_GST,0)) AS   XN_VALUE_WITHOUT_GST
          FROM #TMPRCD
          GROUP BY MRR_ID
        ) B ON TMP.MRR_ID=B.MRR_ID	
    
			
			
		SELECT A.MRR_NO,A.MRR_DT, 
			   'LATER' AS MEMO_NO,
			   CAST('' AS DATETIME) AS MEMO_DT,
			   CAST('LATER' AS VARCHAR(22)) AS MEMO_ID,
			   CAST(0 AS BIT) AS CANCELLED,
               A.MRR_ID,
               A.FREIGHT,
               ISNULL(A.FREIGHT_HSN_CODE,'0000000000') AS FREIGHT_HSN_CODE,
               A.FREIGHT_GST_PERCENTAGE,
               A.FREIGHT_IGST_AMOUNT,A.FREIGHT_CGST_AMOUNT,A.FREIGHT_SGST_AMOUNT,
			   A.OTHER_CHARGES,
			   A.OTHER_CHARGES_GST_PERCENTAGE,
			   ISNULL(A.OTHER_CHARGES_HSN_CODE,'0000000000') AS OTHER_CHARGES_HSN_CODE,
			   A.OTHER_CHARGES_IGST_AMOUNT,
			   A.OTHER_CHARGES_CGST_AMOUNT,
			   A.OTHER_CHARGES_SGST_AMOUNT,
			   CAST(0 AS NUMERIC(12,2)) AS TOTAL_REVERSE_CHARGES  
			   ,A.FIN_YEAR
			   ,A.AC_CODE
			   ,A.AC_NAME,
			   OH_TAX_METHOD,
			   FREIGHT_TAXABLE_VALUE,
			   OTHER_CHARGES_TAXABLE_VALUE,
			   A.TOTAL_REVERSE_CHARGES,
			   A.ROUND_OFF 
		FROM #TMPRCM1 A
		ORDER BY MRR_DT ,MRR_NO
			 
        SELECT RIGHT(A.MRR_ID,10) AS MRR_NO,
               A.MRR_ID,
               CAST('LATER' AS VARCHAR(22)) AS MEMO_ID,
               A.HSN_CODE, 
               SUM(A.QUANTITY) AS  QUANTITY,
               SUM(A.XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST ,
               A.GST_PERCENTAGE ,
               CAST(SUM(IGST_AMOUNT) AS NUMERIC(12,2)) AS IGST_AMOUNT ,
               CAST(SUM(SGST_AMOUNT) AS NUMERIC(12,2)) AS SGST_AMOUNT ,
               CAST(SUM(CGST_AMOUNT) AS NUMERIC(12,2)) AS CGST_AMOUNT ,
               CAST(SUM(XN_VALUE_WITH_GST) AS NUMERIC(12,2)) AS XN_VALUE_WITH_GST,
               CAST('LATER' AS VARCHAR(100)) AS ROW_ID
               ,A.FIN_YEAR
        FROM #TMPRCD A
        GROUP BY A.MRR_ID,A.HSN_CODE,A.GST_PERCENTAGE,A.FIN_YEAR
		ORDER BY A.MRR_ID
  END
  ELSE
    BEGIN
       SELECT B.MRR_NO, B.MRR_DT, A.MEMO_NO, A.MEMO_DT, A.MEMO_ID, A.CANCELLED, B.MRR_ID,
              A.FREIGHT, A.FREIGHT_HSN_CODE, A.FREIGHT_GST_PERCENTAGE, A.FREIGHT_IGST_AMOUNT,
              A.FREIGHT_CGST_AMOUNT, A.FREIGHT_SGST_AMOUNT, A.OTHER_CHARGES, A.OTHER_CHARGES_GST_PERCENTAGE,
			  A.OTHER_CHARGES_HSN_CODE, A.OTHER_CHARGES_IGST_AMOUNT, A.OTHER_CHARGES_CGST_AMOUNT,
			  A.OTHER_CHARGES_SGST_AMOUNT, A.TOTAL_REVERSE_CHARGES
			  ,A.AC_CODE,LM.AC_NAME
	   FROM RCM01106 A (NOLOCK) 
	   LEFT JOIN 
       (SELECT RCM_MEMO_ID,MEMO_ID FROM  RCM_PUR_EXPENSE 
        WHERE XN_TYPE ='PUR'
       )T ON A.MEMO_ID =T.RCM_MEMO_ID
	   LEFT JOIN PIM01106 B (NOLOCK) ON T.MEMO_ID=B.MRR_ID 
	   JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE
	   WHERE A.MEMO_ID =@CMEMO_ID 
	   --AND T.XN_TYPE='PUR'
					
	   SELECT RIGHT(T.MEMO_ID,10) AS MRR_NO, T.MEMO_ID AS MRR_ID, A.MEMO_ID, A.HSN_CODE, A.QUANTITY, A.GST_PERCENTAGE, A.IGST_AMOUNT ,
              A.SGST_AMOUNT, A.CGST_AMOUNT, A.XN_VALUE_WITHOUT_GST, A.XN_VALUE_WITH_GST
       FROM RCD01106 A
       JOIN RCM01106 B ON A.MEMO_ID=B.MEMO_ID
       LEFT JOIN 
       (SELECT RCM_MEMO_ID,MEMO_ID FROM  RCM_PUR_EXPENSE 
        WHERE XN_TYPE ='PUR'
       )T ON A.MEMO_ID =T.RCM_MEMO_ID
       WHERE A.MEMO_ID =@CMEMO_ID  
       --AND T.XN_TYPE='PUR'
    END
  GOTO END_PROC
   
END 

END_PROC:
END
