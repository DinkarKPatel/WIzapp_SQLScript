CREATE  PROCEDURE SP_BROKER_COMMISSION
(
  @NQUERYID INT,
  @CBROKERCODE VARCHAR(50),
  @CFROMDT VARCHAR(10),
  @CTODATE VARCHAR(10)
  
)
--WITH ENCRYPTION
AS
BEGIN
DECLARE @cHEAD_CODE VARCHAR(MAX), @cHEAD_CODE1 VARCHAR(MAX),@cHEAD_CODE2 VARCHAR(MAX)

IF @NQUERYID = 1  
 GOTO LBL1
    
ELSE IF @NQUERYID = 2  
 GOTO LBL2
 
 
LBL1:

SET  @cHEAD_CODE	= DBO.FN_ACT_TRAVTREE('0000000018') ----ADD VARIABLE BY GAURI ON 17/4/2019	
SET  @cHEAD_CODE1	= DBO.FN_ACT_TRAVTREE('0000000013') ----ADD VARIABLE BY GAURI ON 17/4/2019	
SET  @cHEAD_CODE2	= DBO.FN_ACT_TRAVTREE('0000000014') ----ADD VARIABLE BY GAURI ON 17/4/2019	
 

SELECT D.AC_NAME AS BROKER_NAME, C.AC_NAME, SUM(X.CREDIT) AS CREDIT ,
       ISNULL(C.BROKER_COMM_PERCENT ,0) AS COMM_PER,
       (SUM(X.CREDIT)* ISNULL(C.BROKER_COMM_PERCENT ,0))/100 AS COMM_AMOUNT

FROM 
(

	SELECT B.VM_ID,PARTY.AC_CODE ,
		   SUM(CASE WHEN PARTY.AC_CODE= A.AC_CODE AND CREDIT_AMOUNT >0  THEN CREDIT_AMOUNT ELSE 0 END ) AS CREDIT,
		   SUM(CASE WHEN BANK.AC_CODE= A.AC_CODE AND DEBIT_AMOUNT  >0  THEN DEBIT_AMOUNT ELSE 0 END ) AS DEBIT
	    
	FROM VD01106  A (NOLOCK)
	JOIN VM01106 B  (NOLOCK)ON A.VM_ID = B.VM_ID
	LEFT OUTER JOIN
	(
	 SELECT  AC_CODE, AC_NAME FROM LMV01106 (NOLOCK)  
	 WHERE BROKER_AC_CODE=( CASE WHEN  @CBROKERCODE ='' THEN BROKER_AC_CODE ELSE @CBROKERCODE END)
	 AND  CHARINDEX(HEAD_CODE,@cHEAD_CODE)>1 ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019
	)PARTY ON A.AC_CODE= PARTY.AC_CODE

	LEFT OUTER JOIN
	(

	  SELECT AC_CODE, AC_NAME FROM LMV01106 (NOLOCK)
	  WHERE CHARINDEX(HEAD_CODE,@cHEAD_CODE1)>1   ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019
	  OR
	  CHARINDEX(HEAD_CODE,@cHEAD_CODE2)>1			----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019
	 
	)BANK ON BANK.AC_CODE= A.AC_CODE
	
	 WHERE B.VOUCHER_CODE ='0000000003' AND ISNULL(PARTY.AC_CODE,'') <> ''
	 AND  B.VOUCHER_DT BETWEEN @CFROMDT AND @CTODATE AND B.CANCELLED=0
	 GROUP BY B.VM_ID,PARTY.AC_CODE
	 HAVING NOT(SUM(CASE WHEN PARTY.AC_CODE= A.AC_CODE AND CREDIT_AMOUNT >0  THEN CREDIT_AMOUNT ELSE 0 END )=0
	 AND SUM(CASE WHEN BANK.AC_CODE= A.AC_CODE AND DEBIT_AMOUNT >0  THEN CREDIT_AMOUNT ELSE 0 END )=0 )
	 
 )
  X
 JOIN VD01106 A ON X.VM_ID =  A.VM_ID AND A.DEBIT_AMOUNT =0
 JOIN VM01106 V ON A.VM_ID =  V.VM_ID 
 JOIN LMV01106 C ON X.AC_CODE = C.AC_CODE
 JOIN LMV01106 D ON C.BROKER_AC_CODE = D.AC_CODE  
 WHERE  V.CANCELLED=0
 GROUP BY  C.AC_NAME,C.BROKER_COMM_PERCENT,D.AC_NAME 
 ORDER BY C.AC_NAME
 
 GOTO LAST
 
 
LBL2:
 

SELECT D.AC_NAME AS BROKER_NAME, C.AC_NAME,V.VOUCHER_DT, SUM(X.CREDIT) AS CREDIT ,
       ISNULL(C.BROKER_COMM_PERCENT ,0) AS COMM_PER,
       (SUM(X.CREDIT)* ISNULL(C.BROKER_COMM_PERCENT ,0))/100 AS COMM_AMOUNT

FROM 
(

	SELECT B.VM_ID,PARTY.AC_CODE ,
		   SUM(CASE WHEN PARTY.AC_CODE= A.AC_CODE AND CREDIT_AMOUNT >0  THEN CREDIT_AMOUNT ELSE 0 END ) AS CREDIT,
		   SUM(CASE WHEN BANK.AC_CODE= A.AC_CODE AND DEBIT_AMOUNT  >0  THEN DEBIT_AMOUNT ELSE 0 END ) AS DEBIT
	    
	FROM VD01106  A (NOLOCK)
	JOIN VM01106 B  (NOLOCK)ON A.VM_ID = B.VM_ID
	LEFT OUTER JOIN
	(
	 SELECT  AC_CODE, AC_NAME FROM LMV01106 (NOLOCK)  
	 WHERE BROKER_AC_CODE=( CASE WHEN  @CBROKERCODE ='' THEN BROKER_AC_CODE ELSE @CBROKERCODE END)
	 AND  CHARINDEX(HEAD_CODE,@cHEAD_CODE)>1 ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019
	)PARTY ON A.AC_CODE= PARTY.AC_CODE

	LEFT OUTER JOIN
	(

	  SELECT AC_CODE, AC_NAME FROM LMV01106 (NOLOCK)
	  WHERE CHARINDEX(HEAD_CODE,@cHEAD_CODE1)>1 ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019
	  OR
	  CHARINDEX(HEAD_CODE,@cHEAD_CODE2)>1		----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019
	 
	)BANK ON BANK.AC_CODE= A.AC_CODE
	 WHERE B.VOUCHER_CODE ='0000000003' AND ISNULL(PARTY.AC_CODE,'') <> ''
	 AND  B.VOUCHER_DT BETWEEN @CFROMDT AND @CTODATE  AND B.CANCELLED=0
	 GROUP BY B.VM_ID,PARTY.AC_CODE
	 HAVING NOT(SUM(CASE WHEN PARTY.AC_CODE= A.AC_CODE AND CREDIT_AMOUNT >0  THEN CREDIT_AMOUNT ELSE 0 END )=0
	 AND SUM(CASE WHEN BANK.AC_CODE= A.AC_CODE AND DEBIT_AMOUNT >0  THEN CREDIT_AMOUNT ELSE 0 END )=0 )
	 
 )
  X
 JOIN VD01106 A ON X.VM_ID =  A.VM_ID AND A.DEBIT_AMOUNT =0
 JOIN VM01106 V ON A.VM_ID =  V.VM_ID 
 JOIN LMV01106 C ON X.AC_CODE = C.AC_CODE
 JOIN LMV01106 D ON C.BROKER_AC_CODE = D.AC_CODE  
 WHERE V.CANCELLED=0
 GROUP BY  C.AC_NAME,C.BROKER_COMM_PERCENT,D.AC_NAME ,V.VOUCHER_DT
 ORDER BY C.AC_NAME,V.VOUCHER_DT
 
 GOTO LAST
 
 LAST:
 
END
