CREATE PROCEDURE SP_RETAILSALE_15-- (LocId 3 digit change by Sanjay:30-10-2024)
(  
	 @CQUERYID			NUMERIC(2),  
	 @CWHERE			VARCHAR(MAX)='',  
	 @CFINYEAR			VARCHAR(5)='',  
	 @CDEPTID			VARCHAR(4)='',  
	 @NNAVMODE			NUMERIC(2)=1,  
	 @CWIZAPPUSERCODE	VARCHAR(10)='',  
	 @CREFMEMOID		VARCHAR(40)='',  
	 @CREFMEMODT		DATETIME='',  
	 @BINCLUDEESTIMATE	BIT=1,  
	 @CFROMDT			DATETIME='',  
	 @CTODT				VARCHAR(50)='',
	 @bCardDiscount		BIT=0,
	 @cCustCode			VARCHAR(15)=''
) 
AS  
BEGIN  
	 SELECT  A.*,  
	 I.EMP_NAME,   
		J.EMP_NAME AS EMP_NAME1 ,   
		K.EMP_NAME AS EMP_NAME2 ,    
	  
	 --J.EMP_NAME AS EMP_NAME2,K.EMP_NAME AS EMP_NAME3,
	 ISNULL(PMT.quantity_in_stock,B.QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK	 
	 ,B.*, 0 AS MRPCHANGED,   
	 '  ' AS LOCATION_ID,0 AS PROCESSED,A.PRODUCT_CODE AS OLDPC,0 AS SALES_SETUP_DISCOUNT,   
	 CONVERT(BIT,0) AS SCHEME_APPLIED,A.CMD_HOLD_ROW_ID AS ROW_ID,   
	 CONVERT(BIT,0) AS BUYN,CONVERT(BIT,0) AS GETN ,CONVERT(BIT,0) AS SCHEME_SELECTED,   
	 CONVERT(VARCHAR(10),'') AS SCHEME_ID,--T.DEPT_NAME,  
	 CONVERT(BIT,0) AS DISCAMTCHANGED,  
	 CONVERT (BIT,(CASE WHEN A.QUANTITY <0 THEN 1 ELSE 0 END)) AS SALERETURN,  
	 CONVERT(VARCHAR(10),'') AS TAX_STATUS,CONVERT(NUMERIC(10,2),0) AS APR_QTY,  
	 ROW_NUMBER() OVER( ORDER BY A.TS)  AS SRNO ,'' AS [NARRATION],
	 cast(0 as NUMERIC(14,2)) AS FIX_MRP,B.ITEM_TYPE
	 --,B.ART_DT_CREATED, B.PARA3_DT_CREATED,B.SKU_DT_CREATED  
	 FROM  CMD_HOLD  A   (NOLOCK)  
	 JOIN   
	 (  
	  SELECT   A.ARTICLE_CODE,   A.PARA1_CODE,  
	    A.PARA2_CODE, A.PARA3_CODE, E.UOM_NAME,     
	   '' AS [DEPT_ID], --A.COMPANY_CODE,  
	   a.barcode_CODING_SCHEME as CODING_SCHEME, B.MIN_PRICE, B.INACTIVE, CAST(0 AS NUMERIC(10,2)) AS [QUANTITY_IN_STOCK],   
	   CAST(0 AS NUMERIC(10,2)) AS [QUANTITY_SOLD], A.PURCHASE_PRICE,
	    B.DISCON, 
	   '' AS [SCHEME_ID],   
	   A.PARA4_CODE,A.PARA5_CODE,A.PARA6_CODE, E.UOM_CODE,   
	   A.DT_CREATED  AS [SKU_DT_CREATED], B.DT_CREATED AS ART_DT_CREATED, F.DT_CREATED AS PARA3_DT_CREATED,A.PRODUCT_NAME,
	   
	     SM.ITEM_TYPE,E.uom_type,A.hsn_code,sn.*
		FROM SKU A   (NOLOCK)  
		LEFT JOIN sku_names sn (NOLOCK) ON sn.product_code=a.product_code
	  JOIN ARTICLE B  (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE    
	  JOIN SECTIOND SD  (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE  
	  JOIN SECTIONM SM  (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE  
	  JOIN PARA1 C  (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE    
	  JOIN PARA2 D  (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE    
	  JOIN PARA3 F  (NOLOCK) ON A.PARA3_CODE = F.PARA3_CODE    
	  JOIN PARA4 G  (NOLOCK) ON A.PARA4_CODE = G.PARA4_CODE    
	  JOIN PARA5 H  (NOLOCK) ON A.PARA5_CODE = H.PARA5_CODE    
	  JOIN PARA6 I  (NOLOCK) ON A.PARA6_CODE = I.PARA6_CODE    
	  LEFT OUTER JOIN UOM E  (NOLOCK) ON B.UOM_CODE = E.UOM_CODE
	  
	 )B ON A.PRODUCT_CODE = B.PRODUCT_CODE   
	 --JOIN cmm_hold cmm (NOLOCK) ON cmm.cm_id=a.cm_id
	 left outer join PMT01106 PMT(NOLOCK) ON PMT.product_code=B.product_code AND PMT.DEPT_ID= @CDEPTID    AND PMT.BIN_ID=A.BIN_ID
	 LEFT OUTER JOIN EMPLOYEE I  (NOLOCK) ON A.EMP_CODE = I.EMP_CODE   
	 LEFT OUTER JOIN EMPLOYEE J  (NOLOCK) ON A.EMP_CODE1 = J.EMP_CODE     
	 LEFT OUTER JOIN EMPLOYEE K  (NOLOCK) ON A.EMP_CODE2 = K.EMP_CODE       
	 JOIN ARTICLE ART  (NOLOCK) ON ART.ARTICLE_CODE=B.ARTICLE_CODE  
	 JOIN PARA3 P3  (NOLOCK) ON P3.PARA3_CODE=B.PARA3_CODE  
	 
	 WHERE A.HOLD_ID=@CWHERE    -- AND cmm.hbd_location_code= @CDEPTID    
	 ORDER BY  ROW_NUMBER() OVER (ORDER BY A.TS)      
end
