CREATE PROCEDURE SP3S_ALTERATION_SETUP
(
	@cLoc	VARCHAR(5)=''
)
AS 
BEGIN
SET NOCOUNT ON
DECLARE @bHO BIT=0
IF EXISTS(SELECT TOP 1  * FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID' AND VALUE=@cLoc)
	SET @bHO=1
IF NOT EXISTS(SELECT TOP 1  * FROM ALTERATIONSETUP A (NOLOCK)) AND @bHO=1
	WITH LOC
	AS
	(
		SELECT DEPT_ID,DEPT_NAME,DEPT_ALIAS,area_code FROM location WHERE dept_id=@cLoc
	)
	,ALLDATA
	AS
	(
		SELECT L.DEPT_ID
		,SD.SUB_SECTION_CODE
		,J.JOB_CODE
		,CAST(0 AS FLOAT) BASE_NRV
		,CAST(0 AS FLOAT) JOBRATE_LESSTHAN_NRV 
		,CAST(0 AS FLOAT) JOBRATE_MORETHAN_NRV
		,CAST(0 AS FLOAT) VENDOR_RATE
		, L.DEPT_NAME,SD.SUB_SECTION_NAME,J.JOB_NAME
		,SD.SECTION_CODE
		, L.dept_alias, L.area_code
		FROM LOC L,SECTIOND SD(NOLOCK),JOBS J (NOLOCK)
		WHERE SD.INACTIVE=0 AND J.INACTIVE=0
		AND SUB_SECTION_CODE<>'0000000' AND JOB_NAME<>''
	)
	SELECT A.*, SM.section_name
	,A1.area_name AS DEPT_AREA,C1.CITY AS DEPT_CITY,S1.state AS DEPT_STATE
	FROM ALLDATA A
	JOIN SECTIONM SM (NOLOCK) ON SM.section_code =A.section_code
	LEFT OUTER JOIN AREA A1(NOLOCK) ON A1.area_code=A.area_code
	LEFT OUTER JOIN CITY C1(NOLOCK) ON C1.CITY_CODE=A1.city_code
	LEFT OUTER JOIN STATE S1(NOLOCK) ON C1.state_code=S1.state_code
	WHERE ISNULL(Sm.ITEM_TYPE,0)=1
	ORDER BY DEPT_ID,SECTION_NAME,sub_section_name,job_name
	
ELSE
	SELECT A.*,L.DEPT_NAME,S.SUB_SECTION_NAME,J.JOB_NAME ,SM.section_name
	,A1.area_name AS DEPT_AREA,C1.CITY AS DEPT_CITY,S1.state AS DEPT_STATE,L.dept_alias
	FROM ALTERATIONSETUP A (NOLOCK)
	JOIN SECTIOND S (NOLOCK) ON S.SUB_SECTION_CODE=A.SUB_SECTION_CODE
	LEFT JOIN SECTIONM SM (NOLOCK) ON SM.section_code =A.section_code
	JOIN JOBS J (NOLOCK) ON J.JOB_CODE=A.JOB_CODE
	LEFT OUTER JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=A.DEPT_ID
	LEFT OUTER JOIN AREA A1(NOLOCK) ON A1.area_code=L.area_code
	LEFT OUTER JOIN CITY C1(NOLOCK) ON C1.CITY_CODE=A1.city_code
	LEFT OUTER JOIN STATE S1(NOLOCK) ON C1.state_code=S1.state_code
	--WHERE ISNULL(SM.ITEM_TYPE,0)=1
	ORDER BY DEPT_ID,SECTION_NAME,sub_section_name,job_name
SET NOCOUNT OFF
END
