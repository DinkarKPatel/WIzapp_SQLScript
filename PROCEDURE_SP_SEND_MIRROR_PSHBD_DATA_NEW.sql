create PROCEDURE SP_SEND_MIRROR_PSHBD_DATA_NEW
(	
	 @CUPLOADEDXNID VARCHAR(50)
	,@CCURLOCID VARCHAR(5)	 
	,@BDONOTCHKPENDINGCUST BIT=0  
	,@BACKNOWLEDGE BIT=0
	,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
     DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION VARCHAR(MAX),
             @CMEMOID VARCHAR(50),@DMEMOLASTUPDATE DATETIME,
             @CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPMASTERTABLE VARCHAR(100),
             @CTEMPDETAILTABLE VARCHAR(100),@BRECFOUND BIT,@CTEMPSKUTABLE VARCHAR(500),@BPENDINGMSTFOUND bit
     
	 --USE JMLOC6
     
     DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),XN_ID VARCHAR(100)) 
     
BEGIN TRY
     DECLARE @CTEMPDBNAME VARCHAR(100)
	 
	 SET @CTEMPDBNAME=DB_NAME()+'_IMAGE'

	 SET @CSTEP=10
		SET @CFILTERCONDITION=''	
	
	 SET @CSTEP=20
    --CHNAGE BY BAIJNATH
	SET @CMEMOID=@CUPLOADEDXNID

    SET @CSTEP=40
	---- IF NO MEMO FOUND , JUST END THE PROCESS
	IF ISNULL(@CMEMOID,'')=''
		GOTO END_PROC

   
   	DECLARE @CPRINTTEXT VARCHAR(100)
	
	SET @CPRINTTEXT='CHECK MST BEFORE SENDING PSHBD :'+(CASE WHEN @BDONOTCHKPENDINGCUST=1 THEN 'DO NOT CHECK CUST' ELSE 'CHECK CUST' END)
	
	PRINT @CPRINTTEXT
	
	SET @BPENDINGMSTFOUND=0
	
	IF @BDONOTCHKPENDINGCUST=0
		EXEC SP_SEND_MIRROR_XNSMST_DATA_NEW 'PSHBD',@CMEMOID,@CCURLOCID,@BDONOTCHKPENDINGCUST
		,@BPENDINGMSTFOUND OUTPUT
		,@CERRMSG OUTPUT
	
	PRINT (CASE WHEN @BPENDINGMSTFOUND=1 THEN 'PMST-Y' ELSE 'PMST-N' END)
	
	IF ISNULL(@BPENDINGMSTFOUND,0)=1
	BEGIN
		PRINT 'PENDING MASTER FOUND'
		GOTO END_PROC
	END

	
LBLTABLEINFO:


	
	
	SET @CSTEP=220
	---- SEND THE PSHBD MEMO MASTER TABLE
	
	SELECT DISTINCT A.*,'PSHBD_HOLD_BACK_DELIVER_MST_UPLOAD' AS TARGET_TABLENAME FROM HOLD_BACK_DELIVER_MST A (NOLOCK) WHERE A.memo_id=@CMEMOID
	
	SET @CSTEP=250
	---- SEND THE PSHBD MEMO DETAIL TABLE
	SELECT DISTINCT  A.*,'PSHBD_HOLD_BACK_DELIVER_DET_UPLOAD'  AS TARGET_TABLENAME FROM HOLD_BACK_DELIVER_DET A (NOLOCK) WHERE A.memo_id=@CMEMOID

	SET @CSTEP=260
	---- SEND THE PSHBD MEMO DETAIL TABLE
	SELECT DISTINCT A.*,'PSHBD_SKU_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS PSHBD_MEMO_ID FROM SKU A (NOLOCK) 
	JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.product_code=B.product_code
	WHERE B.memo_id=@CMEMOID

	SET @CSTEP=290
	SET @DTSQL=N'SELECT DISTINCT *,''PSHBD_IMAGE_INFO_UPLOAD'' AS TARGET_TABLENAME FROM '+@CTEMPDBNAME+'..IMAGE_INFO WHERE PRODUCT_CODE IN (SELECT PRODUCT_CODE FROM HOLD_BACK_DELIVER_DET (NOLOCK) WHERE memo_id='''+@CMEMOID+''')'
	
	PRINT @DTSQL

	EXEC SP_EXECUTESQL @DTSQL


	
	GOTO END_PROC
	

	END TRY
BEGIN CATCH
	SET @CERRMSG='P: SP_SEND_MIRROR_PSHBD_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 	
	
END_PROC:
	
	
END
