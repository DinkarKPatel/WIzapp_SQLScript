

-- THIS VIEW WILL BE USED BY PROCEDURE FOR AUTO DATA RECONCILIATION OF LOCATIONS WITH HO
CREATE VIEW VW_LOCDTRECON

AS
	-- OPENING STOCK
	SELECT  A.DEPT_ID,
			'OPS' AS XN_TYPE, 
			'OPS' AS XN_ID,
			(CASE WHEN XN_DT='' THEN '2012-04-01' ELSE XN_DT END) AS XN_DT,
			0 AS CANCELLED,
			SUM(QUANTITY_OB) AS XN_QTY,
			CONVERT(NUMERIC(10,2),0) AS XN_NET
	FROM OPS01106 A 
	GROUP BY A.DEPT_ID,A.XN_DT
	
	-- PURCHASE INVOICE
	UNION ALL
	SELECT	B.DEPT_ID,
			'PUR' AS XN_TYPE, 
			B.MRR_ID  AS XN_ID, 
			B.RECEIPT_DT AS XN_DT,
			B.CANCELLED,
			0 AS XN_QTY,
			B.TOTAL_AMOUNT AS XN_NET
	FROM PIM01106 B (NOLOCK)
	JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID') CNF1 ON 1=1
	JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID') CNF2 ON 1=1
	JOIN LOCATION D ON D.DEPT_ID=B.DEPT_ID
	WHERE B.RECEIPT_DT<>''
	AND (B.INV_MODE=1 OR B.location_code/*LEFT(B.MRR_ID,2)*//*Rohit 04-11-2024*/=CNF1.VALUE OR CNF1.VALUE<>CNF2.VALUE)
	AND B.RECEIPT_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>'' AND B.RECEIPT_DT<>''
	  
	UNION ALL
	SELECT	B.PARTY_DEPT_ID AS DEPT_ID,
			'PUR' AS XN_TYPE, 
			C.MRR_ID  AS XN_ID, 
			C.RECEIPT_DT AS XN_DT,
			B.CANCELLED,
			0 AS XN_QTY,
			B.NET_AMOUNT AS XN_NET
	FROM INM01106 B (NOLOCK)
	JOIN PIM01106 C (NOLOCK) ON C.INV_ID = B.INV_ID
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID
	JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID') CNF ON 1=1
	WHERE C.location_code/*LEFT(C.MRR_ID,2)*//*Rohit 04-11-2024*/<>CNF.VALUE  AND C.RECEIPT_DT<>''
	AND C.RECEIPT_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''
		
	-- PURCHASE RETURN
	UNION ALL
	SELECT	B.location_code/*LEFT(B.RM_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'PRT' AS XN_TYPE, 
			B.RM_ID  AS XN_ID, 
			B.RM_DT AS XN_DT,
			B.CANCELLED,
			0 AS XN_QTY,
			B.TOTAL_AMOUNT AS XN_NET
	FROM RMM01106 B (NOLOCK)
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=b.location_code/*LEFT(B.RM_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.RM_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''

	
	-- RETAIL SALE 
	UNION ALL
	SELECT B.location_code/*LEFT(B.CM_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'SLS' AS XN_TYPE, 
			B.CM_ID  AS XN_ID, 
			B.CM_DT AS XN_DT,
			B.CANCELLED,
			0 AS XN_QTY,
			B.NET_AMOUNT AS XN_NET
	FROM CMM01106 B (NOLOCK)
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.CM_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.CM_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''
	AND B.CM_MODE=1

	-- APPROVAL ISSUE
	UNION ALL
	SELECT	B.location_code/*LEFT(B.MEMO_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'APP' AS XN_TYPE,
			B.MEMO_ID AS XN_ID,
			B.MEMO_DT AS XN_DT,
			B.CANCELLED,
			0 AS XN_QTY,
			B.NET_AMOUNT AS XN_NET
 	FROM APM01106 B (NOLOCK) 
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.MEMO_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.MEMO_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''		
	-- APPROVAL RETURN
	UNION ALL
	SELECT	C.location_code/*LEFT(C.MEMO_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'APR' AS XN_TYPE,
			C.MEMO_ID AS XN_ID,
			C.MEMO_DT AS XN_DT,
			C.CANCELLED,
			SUM(A.QUANTITY) AS XN_QTY,
			0 AS XN_NET 
	FROM APPROVAL_RETURN_DET A 
	JOIN APD01106 B (NOLOCK)ON A.APD_ROW_ID = B.ROW_ID
	JOIN APPROVAL_RETURN_MST C (NOLOCK) ON C.MEMO_ID = A.MEMO_ID
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=C.location_code/*LEFT(C.MEMO_ID,2)*//*Rohit 04-11-2024*/
	WHERE C.MEMO_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''
	GROUP BY C.location_code/*LEFT(C.MEMO_NO,2)*//*Rohit 04-11-2024*/,C.MEMO_ID,C.CANCELLED,C.MEMO_DT
	
	-- CANCELLATION AND STOCK ADJUSTMENT
	UNION ALL
	SELECT	B.location_code/*LEFT(B.CNC_MEMO_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			(CASE WHEN B.CNC_TYPE=1 THEN 'CNC' ELSE 'UNC' END) AS XN_TYPE, 
			B.CNC_MEMO_ID AS XN_ID,
			B.CNC_MEMO_DT AS XN_DT,
			0 AS CANCELLED,
			SUM(A.QUANTITY) AS XN_QTY,
			CONVERT(NUMERIC(10,2),0) AS XN_NET
	FROM ICD01106 A (NOLOCK)
	JOIN ICM01106 B (NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=A.DEPT_ID
	WHERE B.CNC_MEMO_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''	
	GROUP BY B.location_code/*A.DEPT_ID*//*Rohit 04-11-2024*/,B.CNC_MEMO_ID,B.CANCELLED,(CASE WHEN B.CNC_TYPE=1 THEN 'CNC' ELSE 'UNC' END),
	B.CNC_MEMO_DT
	
	--WHOLESALE INVOICE
	UNION ALL
	SELECT	DISTINCT B.location_code/*LEFT(B.INV_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'WSL'  AS XN_TYPE,
			B.INV_ID AS XN_ID,
			B.INV_DT AS XN_DT,
			B.CANCELLED,
			0 AS XN_QTY,
			B.NET_AMOUNT AS XN_NET
	FROM INM01106 B (NOLOCK)
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.INV_ID,2)*//*Rohit 04-11-2024*/
	LEFT OUTER JOIN IND01106 C (NOLOCK) ON C.INV_ID=B.INV_ID
	LEFT OUTER JOIN WPS_MST E (NOLOCK) ON E.PS_ID=C.PS_ID
	WHERE B.INV_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''	
	AND E.PS_ID IS NULL


	--WHOLESALE PACKSLIP
	UNION ALL
	SELECT	B.location_code/*LEFT(B.PS_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'WPS' AS XN_TYPE,
			B.PS_ID AS XN_ID,
			B.PS_DT AS XN_DT,
			B.CANCELLED,
			0 AS XN_QTY,
			B.SUBTOTAL AS XN_NET
	FROM WPS_MST B (NOLOCK)
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.PS_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.PS_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''	

	--WHOLESALE CREDIT NOTE
	UNION ALL
	SELECT	B.location_code/*LEFT(B.CN_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'WSR' AS XN_TYPE,
			B.CN_ID AS XN_ID,
			B.CN_DT AS XN_DT,
			B.CANCELLED,
			0 AS XN_QTY,
			B.TOTAL_AMOUNT AS XN_NET
	FROM CNM01106 B (NOLOCK)
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.CN_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.CN_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''	
	
	-- GENERATION OF NEW BAR CODES IN RATE REVISION
	UNION ALL	
	SELECT	B.location_code/*LEFT(B.IRM_MEMO_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'PFI' AS XN_TYPE,
			B.IRM_MEMO_ID AS XN_ID,
			B.IRM_MEMO_DT AS XN_DT,
			0 AS CANCELLED,
			SUM(A.QUANTITY) AS XN_QTY,
			CONVERT(NUMERIC(10,2),0) AS XN_NET
	FROM IRD01106 A (NOLOCK)
	JOIN IRM01106 B (NOLOCK) ON A.IRM_MEMO_ID = B.IRM_MEMO_ID
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.IRM_MEMO_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.IRM_MEMO_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''	
	AND A.NEW_PRODUCT_CODE<>''
	GROUP BY B.location_code,B.IRM_MEMO_ID,B.IRM_MEMO_DT 

	-- GENERATION OF NEW BAR CODES IN RATE REVISION
	UNION ALL	
	SELECT	B.location_code/*LEFT(B.MEMO_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'PFI' AS XN_TYPE,
			B.MEMO_ID AS XN_ID,
			B.MEMO_DT AS XN_DT,
			B.CANCELLED,
			SUM(A.QUANTITY) AS XN_QTY,
			CONVERT(NUMERIC(10,2),0) AS XN_NET
	FROM SCF01106 A (NOLOCK)
	JOIN SCM01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.MEMO_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.MEMO_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''	
	AND A.PRODUCT_CODE<>''
	GROUP BY B.location_code,B.MEMO_ID,B.DEPT_ID,B.CANCELLED,B.MEMO_DT
	
	-- CONSUMPTION OF OLD BARCODES IN RATE REVISION
	UNION ALL	
	SELECT	B.location_code/*LEFT(B.IRM_MEMO_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'CIP' AS XN_TYPE,
			B.IRM_MEMO_ID AS XN_ID,
			B.IRM_MEMO_DT AS XN_DT,
			0 AS CANCELLED,
			SUM(A.QUANTITY) AS XN_QTY,
			CONVERT(NUMERIC(10,2),0) AS XN_NET
	FROM IRD01106 A (NOLOCK)
	JOIN IRM01106 B (NOLOCK) ON A.IRM_MEMO_ID = B.IRM_MEMO_ID
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.IRM_MEMO_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.IRM_MEMO_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''	
	AND  A.NEW_PRODUCT_CODE<>''
	GROUP BY B.location_code,B.IRM_MEMO_ID,B.DEPT_ID,B.IRM_MEMO_DT
	
	-- CONSUMPTION OF BARCODES IN SPLIT/COMBINE
	UNION ALL	
	SELECT	B.location_code/*LEFT(B.MEMO_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'CIP' AS XN_TYPE,
			B.MEMO_ID AS XN_ID,
			B.MEMO_DT AS XN_DT,
			B.CANCELLED,
			SUM(A.QUANTITY+ADJ_QUANTITY) AS XN_QTY,
			CONVERT(NUMERIC(10,2),0) AS XN_NET
	FROM SCC01106 A (NOLOCK)
	JOIN SCM01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.MEMO_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.MEMO_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''	
	AND A.PRODUCT_CODE<>'' 
	GROUP BY B.location_code,B.MEMO_ID,A.DEPT_ID,B.CANCELLED,B.MEMO_DT
	
	UNION ALL		
	SELECT	B.location_code/*LEFT(B.ISSUE_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'JWI' AS XN_TYPE,
			B.ISSUE_ID AS XN_ID,
			B.ISSUE_DT AS XN_DT,
			B.CANCELLED,
			SUM(A.QUANTITY) AS XN_QTY,
			CONVERT(NUMERIC(10,2),0) AS XN_NET
	FROM POST_SALES_JOBWORK_ISSUE_DET A (NOLOCK)
	JOIN POST_SALES_JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.ISSUE_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.ISSUE_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''	
	GROUP BY B.location_code,B.ISSUE_ID,A.DEPT_ID,B.CANCELLED,B.ISSUE_DT	
	
	UNION ALL
	SELECT	B.location_code/*LEFT(B.RECEIPT_ID,2)*//*Rohit 04-11-2024*/ AS DEPT_ID,
			'JWR' AS XN_TYPE,
			B.RECEIPT_ID AS XN_ID,
			B.RECEIPT_DT AS XN_DT,
			B.CANCELLED,
			SUM(A.QUANTITY) AS XN_QTY,
			CONVERT(NUMERIC(10,2),0) AS XN_NET
	FROM POST_SALES_JOBWORK_RECEIPT_DET A (NOLOCK)
	JOIN POST_SALES_JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID
	JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.location_code/*LEFT(B.RECEIPT_ID,2)*//*Rohit 04-11-2024*/
	WHERE B.RECEIPT_DT<=D.DAY_CLOSE_DT AND D.DAY_CLOSE_DT<>''	
	GROUP BY B.location_code, B.RECEIPT_ID,B.DEPT_ID,B.CANCELLED,B.RECEIPT_DT	

			
--***************** END OF CREATING VIEW VW_LOCDTRECON
