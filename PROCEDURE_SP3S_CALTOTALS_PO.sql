CREATE PROCEDURE SP3S_CALTOTALS_PO--(LocId 3 digit change by Sanjay:06-11-2024)
@nUpdatemode NUMERIC(2,0),
@nSpId VARCHAR(40)='',
@CERRORMSG VARCHAR(MAX) OUTPUT,
@CLOCID	   VARCHAR(4)=''
AS
BEGIN
		DECLARE @cSTEP VARCHAR(5),@NSUBTOTAL NUMERIC(14,2),@NEXCLTAX NUMERIC(10,2),@NEXCLgstcess NUMERIC(10,2)

		SET @cSTEP = 66.6
		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

		EXEC SP3S_PO_CONVERT_FOREX_INR @NSPID,@CERRORMSG OUTPUT
	   IF ISNULL(@CERRORMSG,'')<>''
		  GOTO END_PROC
	
		DECLARE @STOTAL NUMERIC(14,2),@NINVOICE_QUANTITY NUMERIC(10,3)

		SELECT	 @STOTAL=SUM(INVOICE_QUANTITY*PURCHASE_PRICE) ,
			     @NINVOICE_QUANTITY=SUM(QUANTITY)  
		FROM PO_POD01106_UPLOAD (NOLOCK) 
		WHERE sp_id = @nSpId

		SET @cSTEP = 66.8
		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

		UPDATE A SET SUBTOTAL = ISNULL( @STOTAL ,0 ),TOTAL_QUANTITY=ISNULL(@NINVOICE_QUANTITY,0)
		FROM PO_POM01106_UPLOAD A WITH  (ROWLOCK)
		WHERE A.sp_id = @nSpId
		
		SET @cSTEP = 67
		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

		DECLARE @STR VARCHAR(MAX),@STR1 VARCHAR(MAX)
		SET @STR=NULL
		SET @STR1=NULL

		SELECT  @STR1=PO_ID,@STR =  COALESCE(@STR +  '/ ', ' ' ) + (''+C.UOM_NAME+': '+CAST(SUM(QUANTITY) AS VARCHAR) +' ')  
				FROM PO_POD01106_UPLOAD A(NOLOCK) 
				JOIN ARTICLE B(NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE
			JOIN UOM C(NOLOCK) ON C.UOM_CODE=B.UOM_CODE
			WHERE SP_ID=@nSpId GROUP BY C.UOM_NAME ,PO_ID

		SET @cSTEP = 67.2
		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

		UPDATE PO_POM01106_UPLOAD SET TOTAL_QUANTITY_STR =@STR WHERE SP_ID=@nSpId
		
		
		SET @cSTEP = 67.4
		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1
							
		UPDATE PO_POM01106_UPLOAD SET DISCOUNT_AMOUNT = ROUND(SUBTOTAL*DISCOUNT_PERCENTAGE/100,2)
		WHERE SP_ID=@nSpId AND MANUAL_DISCOUNT =0
		

		IF EXISTS (SELECT TOP 1 config_option FROM config(NOLOCK) WHERE config_option='CALC_GST_IN_PO' AND value='1')
		BEGIN

			SET @cSTEP=67.6
			EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

			EXEC SP3S_CALC_GST_PO
			@nSpId=@nSpId,
			@CERRORMSG=@CERRORMSG OUTPUT,
			@CLOCID=@CLOCID

			IF ISNULL(@CERRORMSG,'')<>''
				GOTO END_PROC
		END
		ELSE 
		BEGIN

		    UPDATE A SET OTHER_CHARGES_GST_PERCENTAGE=0,FREIGHT_GST_PERCENTAGE=0  
			FROM PO_POM01106_UPLOAD A (NOLOCK)
			WHERE SP_ID=@NSPID

		END

		SET @cSTEP=70

		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1
	    
		SELECT @NEXCLTAX=SUM(CASE WHEN BILL_LEVEL_TAX_METHOD=1 THEN A.TAX_AMOUNT+CGST_AMOUNT+SGST_AMOUNT+IGST_AMOUNT ELSE 0 END),
		       @NEXCLgstcess=SUM(CASE WHEN BILL_LEVEL_TAX_METHOD=1 THEN isnull(a.GST_CESS_AMOUNT,0) ELSE 0 END)
		FROM PO_POD01106_UPLOAD A(NOLOCK) JOIN PO_POM01106_UPLOAD B(NOLOCK) ON A.SP_ID=B.SP_ID 
		WHERE B.SP_ID=@nSpId

		SET @cSTEP=70.2
		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1
		
		DECLARE @NOHTAX NUMERIC(10,3)
		SELECT @NOHTAX=  ISNULL(FREIGHT_CGST_AMOUNT,0)+ISNULL(FREIGHT_SGST_AMOUNT,0)+ISNULL(FREIGHT_IGST_AMOUNT,0)+
							ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)
		FROM  PO_POM01106_UPLOAD (NOLOCK) WHERE SP_ID =@nSpId
		AND ISNULL(OH_TAX_METHOD,0)=1

		SET @cSTEP=70.4
		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1		
		
		SET @NEXCLTAX=ISNULL(@NEXCLTAX,0)+ISNULL(@NOHTAX,0)
		

		UPDATE a set ROUND_OFF=ISNULL(ROUND((SUBTOTAL-DISCOUNT_AMOUNT+ @NEXCLTAX+ISNULL(@NEXCLgstcess,0)+ OTHER_CHARGES+FREIGHT),0)
		-(SUBTOTAL-DISCOUNT_AMOUNT+@NEXCLTAX+ISNULL(@NEXCLgstcess,0)+OTHER_CHARGES+FREIGHT),0)
		from PO_POM01106_UPLOAD a (nolock)
		WHERE SP_ID=@nSpId AND MANUAL_ROUNDOFF=0

		SET @cSTEP=70.6
		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

		UPDATE a SET TOTAL_AMOUNT=ISNULL(SUBTOTAL,0)-ISNULL(DISCOUNT_AMOUNT,0)+ISNULL(@NEXCLTAX,0)+ISNULL(@NEXCLgstcess,0)+ISNULL(FREIGHT,0)+ISNULL(OTHER_CHARGES,0)+ISNULL(ROUND_OFF,0),
		             TOTAL_GST_CESS_AMOUNT=@NEXCLgstcess
		from PO_POM01106_UPLOAD a (nolock)
		WHERE SP_ID=@nSpId

		

END_PROC:	    
		
END	