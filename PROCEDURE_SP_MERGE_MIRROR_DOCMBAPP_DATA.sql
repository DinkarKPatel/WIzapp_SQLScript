CREATE PROCEDURE SP_MERGE_MIRROR_DOCMBAPP_DATA
(
	@CMEMOID VARCHAR(50),
    @CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
SET NOCOUNT ON
BEGIN
	/*
		SP_MERGE_MIRROR_POADJ_DATA_208_2014_02_04 : 
		THIS PROCEDURE WILL MERGE DATA FROM TEMPORARY TABLE TO ACTUAL TABLE.
		TABLE NAMES AND ITS MERGING ORDER WILL BE FIXED AND WILL BE DEFINED HERE.	
	*/
DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
	   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
	   ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	   ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(MAX),@CTEMPDBNAME VARCHAR(500)
	   
BEGIN TRY
SET @CSTEP=20
	SET @CTABLE_SUFFIX=REPLACE(@CMEMOID,'-','_')
BEGIN TRANSACTION 

	SET @CSTEP=30
	SET @CTABLENAME='CMD_MANUALBILL_ERRORS'
	SET @CTEMPDBNAME=DB_NAME()+'_TEMP.DBO.'
	SET @CTMP_TABLENAME=@CTEMPDBNAME+'[TMP_DOCMBAPP_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
	
	SET @DTSQL=N'UPDATE A SET APPROVED=1 FROM CMD_MANUALBILL_ERRORS A  WITH (ROWLOCK) JOIN '+@CTMP_TABLENAME+' B (NOLOCK)
				 ON B.CMD_ROW_ID=A.CMD_ROW_ID AND B.ERROR_CODE=A.ERROR_CODE
				 AND A.APPROVED=0 AND B.APPROVED=1 AND B.ERROR_CODE IN (''03'',''07'',''08'')'
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @CSTEP=40
	SET @CTABLESSTR='CMD_MANUALBILL_ERRORS'

    EXEC SP3S_DROPTEMPTABLES_MIRRORDATA
    @CXNTYPE='DOCMBAPP',
    @CTABLESUFFIX=@CTABLE_SUFFIX,
    @CTABLESSTR=@CTABLESSTR
	
END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP_MERGE_MIRROR_DOCMBAPP_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
END CATCH
EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
	END
	ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK
END	
---END OF PROCEDURE - SP_MERGE_MIRROR_DOCMBAPP_DATA
