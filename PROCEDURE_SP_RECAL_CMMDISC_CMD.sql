CREATE PROCEDURE SP_RECAL_CMMDISC_CMD
@NSPID VARCHAR(40)='',
@CSOURCETABLENAME VARCHAR(200)='',
@NCMMDISCAMT NUMERIC(10,2),
@CCMID VARCHAR(50)=''
AS
BEGIN
	DECLARE @NSUBTOTAL NUMERIC(14,2),@NSLSSUBTOTAL NUMERIC(14,2),@NSLRSUBTOTAL NUMERIC(14,2),
	@NBILLLEVELDISCAMT NUMERIC(14,2),@NTOTALCMMDISCAMT NUMERIC(14,2),@NDIFF NUMERIC(14,2),@CFILTER VARCHAR(500),
	@CCMD NVARCHAR(MAX),@CSTEP VARCHAR(5),@nCmmDiscPct NUMERIC(6,2)
	
	SET @NBILLLEVELDISCAMT=@NCMMDISCAMT
	
	PRINT 'ENTER RECAL_CMMDISC_CMD:'	+STR(@NBILLLEVELDISCAMT)
	SET @CFILTER=(CASE WHEN @CSOURCETABLENAME='' AND @NSPID<>'' THEN ' AND SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
					   WHEN @CCMID<>'' THEN ' AND CM_ID='''+@CCMID+'''' ELSE '' END)
	
	IF  @NSPID<>''
	BEGIN
		SET @CSOURCETABLENAME='SLS_CMD01106_UPLOAD'
		
		SELECT @nCmmDiscPct=discount_percentage
		FROM SLS_CMM01106_UPLOAD with(rowlock) WHERE SP_ID=@NSPID

		SELECT @NSUBTOTAL=SUM(net),@NSLSSUBTOTAL=SUM(CASE WHEN net>0 THEN net else 0 end),
		@NSLRSUBTOTAL=SUM(CASE WHEN net<0 THEN net else 0 end) FROM SLS_cmd01106_UPLOAD (NOLOCK)
		WHERE sp_id=@nSpId

	END
	ELSE
	BEGIN
		SELECT @CSOURCETABLENAME='CMD01106',@nCmmDiscPct=discount_percentage
		FROM CMM01106 WHERE CM_ID=@CCMID
		
		SELECT @NSUBTOTAL=SUM(net),@NSLSSUBTOTAL=SUM(CASE WHEN net>0 THEN net else 0 end),
		@NSLRSUBTOTAL=SUM(CASE WHEN net<0 THEN net else 0 end) FROM cmd01106 (NOLOCK)
		WHERE cm_id=@cCmId
	END
	--SELECT @NSUBTOTAL AS SUBTOTAL
	
	--- CHANGED THIS ON 26-04-2018 AFTER INSTRUCTIONS BY SIR WHILE SEEING THE NET REALIZED SALE VALUE REPORT AT KONTAIL 
	--SET @CSTEP=302
	--SET @CCMD=N'UPDATE '+@CSOURCETABLENAME+' SET CMM_DISCOUNT_AMOUNT='+(CASE WHEN @NBILLLEVELDISCAMT<>0 AND @NSUBTOTAL<>0 THEN 
	--'('+STR(@NBILLLEVELDISCAMT,10,2)+'/'+STR(@NSUBTOTAL)+')*NET' ELSE '0' END)+'	WHERE 1=1 '+@CFILTER
	--PRINT @CCMD
	--EXEC SP_EXECUTESQL @CCMD

	--- CHANGED THIS AGAIN ON 21-05-2019 AFTER INSTRUCTIONS BY SIR BECAUSE OF THE ISSUE CAME AT MBKB 
	--- FOR THE ITEMS SOLD IN THE EXCHANGE BILL WHEN RETURNED IN THE OTHER BILL ARE HAVING MORE DISCOUNT THAN THAT 
	--- OF SOLD ITEMS -- WHILE SEEING THE NET REALIZED SALE VALUE REPORT AT KONTAIL 	
	
	print 'Update cmm_discount amount'
	IF @NSUBTOTAL>0
	BEGIN
		SET @CSTEP=302
		SET @CCMD=N'UPDATE a SET CMM_DISCOUNT_AMOUNT=round((NET*('+str(@NCMMDISCAMT,10,2)+')/'+str(@nSLsSubtotal,10,2)+'),2)
		      from '+@CSOURCETABLENAME+' a with (rowlock)
		WHERE NET>0 '+@CFILTER
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
	END
	
	IF @NSUBTOTAL<0
	BEGIN
		SET @CSTEP=304
		SET @CCMD=N'UPDATE a SET CMM_DISCOUNT_AMOUNT=round((NET*('+str(@NCMMDISCAMT,10,2)+')/'+str(@NSLRSUBTOTAL,10,2)+'),2)
		           from '+@CSOURCETABLENAME+' a with (ROWLOCK)
		WHERE NET<0'+@CFILTER
		
		EXEC SP_EXECUTESQL @CCMD			
	END
	
	SET @CSTEP=307
	SET @CCMD=N'UPDATE a SET CMM_DISCOUNT_AMOUNT=ISNULL(CMM_DISCOUNT_AMOUNT,0) from '+@CSOURCETABLENAME+' a with (rowlock) WHERE 1=1'+@CFILTER
	EXEC SP_EXECUTESQL @CCMD

	SET @CCMD=N'SELECT @NTOTALCMMDISCAMT=SUM(CMM_DISCOUNT_AMOUNT) FROM '+@CSOURCETABLENAME+'  with (rowlock)  WHERE 1=1 '+@CFILTER
	EXEC SP_EXECUTESQL @CCMD,N'@NTOTALCMMDISCAMT NUMERIC(10,2) OUTPUT',@NTOTALCMMDISCAMT OUTPUT
	
	IF @NTOTALCMMDISCAMT<>@NBILLLEVELDISCAMT
	BEGIN
		SET @NDIFF=@NTOTALCMMDISCAMT-@NBILLLEVELDISCAMT
		
		SET @CCMD=N'UPDATE a SET CMM_DISCOUNT_AMOUNT=CMM_DISCOUNT_AMOUNT-'+STR(@NDIFF,10,2)+' 
		from '+@CSOURCETABLENAME+' a with (rowlock)
		WHERE ROW_ID=(SELECT TOP 1 ROW_ID FROM '+@CSOURCETABLENAME+' WHERE CMM_DISCOUNT_AMOUNT<>0'+@CFILTER+')'+@CFILTER
		EXEC SP_EXECUTESQL @CCMD
	END

END



