CREATE PROCEDURE SPPPC_BIND_WSL_ORDER         
@NMODE INT= '',        
@ORDER_ID VARCHAR(22)= '',        
@CANCELLED BIT ,
@CBILL_NO VARCHAR(100)='',
@CREF_NO VARCHAR(100)='',
@CAC_CODE VARCHAR(10)=''  ,
@CFIN_YEAR VARCHAR(10)=''     
AS BEGIN        
        
----0-----BIND ORDER NO        
IF @NMODE = 0         
BEGIN        
        
   IF OBJECT_ID('TEMPDB..#TMPDQRQ','U') IS NOT NULL
             DROP TABLE #TMPDQRQ
          
          SELECT B.BO_BOM_ROW_ID ,SUM(QUANTITY) AS DQRQ_QTY 
          INTO #TMPDQRQ
          FROM PPC_DQ_DET  B
		  JOIN PPC_DQRQ_MST C ON C.MEMO_ID=B.MEMO_ID
		  WHERE C.CANCELLED=0
		  --WHERE C.MEMO_ID = @CXNID  
		  GROUP BY B.BO_BOM_ROW_ID 
		  UNION ALL
		  SELECT C.BO_BOM_ROW_ID ,(-1)*SUM(C.QUANTITY) AS DQRQ_QTY 
          FROM PPC_DQ_DET  B
          JOIN PPC_RQ_DET C ON B.ROW_ID=C.REF_ROW_ID
		  JOIN PPC_DQRQ_MST D ON D.MEMO_ID=B.MEMO_ID
		  WHERE D.CANCELLED=0
		  --WHERE C.MEMO_ID = @CXNID  
		  GROUP BY C.BO_BOM_ROW_ID 
              
                   
     SELECT DISTINCT BILL_NO AS  ORDER_NO,A.ORDER_ID
     FROM PPC_BUYER_ORDER_MST A    
     JOIN PPC_BUYER_ORDER_DET C ON A.ORDER_ID=C.ORDER_ID    
     JOIN PPC_BO_ART_BOM D ON C.ROW_ID=D.REF_ROW_ID     
     JOIN ARTICLE ART ON ART.ARTICLE_CODE=D.BOM_ARTICLE_CODE    
     JOIN UOM ON UOM.UOM_CODE=ART.UOM_CODE 
     LEFT JOIN PPC_UOM_CONVERSION UC ON UOM.UOM_CODE=UC.UOM_CODE 
     LEFT JOIN PPC_BOM_UOM BU ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE    
     LEFT  JOIN    
     (    
      SELECT BO_BOM_ROW_ID,SUM(B.QUANTITY) AS QUANTITY,SUM(ADDITIONAL_QTY) AS ADDITIONAL_QTY    
      FROM  PPC_POM01106 A    
      JOIN PPC_POD01106 B ON A.PO_ID=B.PO_ID    
      WHERE A.CANCELLED=0    
      GROUP BY BO_BOM_ROW_ID    
     ) PO ON PO.BO_BOM_ROW_ID=D.ROW_ID 
     LEFT OUTER JOIN
     (
      SELECT BO_BOM_ROW_ID,DQRQ_QTY 
      FROM #TMPDQRQ
     ) DQRQ ON DQRQ.BO_BOM_ROW_ID=D.ROW_ID 
     WHERE A.CANCELLED=0    
     AND  CASE WHEN ISNULL(UC.CONVERSION_VALUE,0)=0 THEN
           CAST(CAST(C.QUANTITY*AVG_QTY AS NUMERIC(12,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(10,3))
           ELSE 
           CAST(CAST((C.QUANTITY*AVG_QTY)/UC.CONVERSION_VALUE AS NUMERIC(12,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(10,3))
           END+ISNULL(DQRQ.DQRQ_QTY,0) >0 
             
      
END        
        
        
        
----2-----BINDGRID        
IF @NMODE = 1         
BEGIN        
        
	SELECT U.USERNAME AS APPROVED_BY,*,LMV01106.AC_NAME 
	FROM PPC_BUYER_ORDER_MST A 
	INNER JOIN LMV01106 ON A.AC_CODE =LMV01106.AC_CODE 
	JOIN USERS U ON U.USER_CODE =A.APPROVED_BY
	WHERE FIN_YEAR=@CFIN_YEAR
	AND A.CANCELLED =0 AND 
	ISNULL(A.APPROVED,0)=1
	ORDER BY A.ORDER_DT DESC  ,A.ORDER_NO DESC     
END        
-----2-----SEARCHBY ORDER NO        
IF @NMODE=2        
BEGIN        
SELECT *,LMV01106.AC_NAME FROM PPC_BUYER_ORDER_MST 
INNER JOIN LMV01106 ON PPC_BUYER_ORDER_MST.AC_CODE =LMV01106.AC_CODE 
WHERE PPC_BUYER_ORDER_MST.ORDER_ID=@ORDER_ID        
OR PPC_BUYER_ORDER_MST.CANCELLED=@CANCELLED   
ORDER BY PPC_BUYER_ORDER_MST.ORDER_DT DESC  ,PPC_BUYER_ORDER_MST.ORDER_NO DESC     
END        
---3SEARCHBY ORDER NO  AND STATUS      
IF @NMODE=3        
BEGIN        
SELECT *,LMV01106.AC_NAME FROM PPC_BUYER_ORDER_MST 
INNER JOIN LMV01106 ON PPC_BUYER_ORDER_MST.AC_CODE=LMV01106.AC_CODE 
WHERE 
(@CBILL_NO='' OR PPC_BUYER_ORDER_MST.BILL_NO=@CBILL_NO) AND
(@CREF_NO='' OR PPC_BUYER_ORDER_MST.REF_NO=@CREF_NO)         
 AND (@CAC_CODE='' OR PPC_BUYER_ORDER_MST.AC_CODE=@CAC_CODE)                
 AND PPC_BUYER_ORDER_MST.CANCELLED=@CANCELLED 
 ORDER BY PPC_BUYER_ORDER_MST.ORDER_DT DESC  ,PPC_BUYER_ORDER_MST.ORDER_NO DESC     
     
      
END        
     
IF @NMODE = 4         
BEGIN        
        
SELECT *,LMV01106.AC_NAME FROM PPC_BUYER_ORDER_MST INNER JOIN LMV01106 
ON PPC_BUYER_ORDER_MST.AC_CODE =LMV01106.AC_CODE WHERE PPC_BUYER_ORDER_MST.ORDER_ID=@ORDER_ID      
ORDER BY PPC_BUYER_ORDER_MST.ORDER_DT DESC  ,PPC_BUYER_ORDER_MST.ORDER_NO DESC  
END         
        
END
