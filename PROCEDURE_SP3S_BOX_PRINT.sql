create PROCEDURE SP3S_BOX_PRINT
(
  @CMRR_ID VARCHAR(50)='',
  @NBOX_NO NUMERIC(5,0)=0
)
AS
BEGIN
   DECLARE @AC_NAME VARCHAR(100)
   
   SELECT TOP 1 @AC_NAME=LMV.AC_NAME
   FROM PIM01106 P (NOLOCK)
   JOIN LMV01106 LMV (NOLOCK) ON P.AC_CODE=LMV.AC_CODE
   WHERE P.MRR_ID=@CMRR_ID
   
   if object_id ('tempdb..#tmpboxprint','u') is not null
      drop table #tmpboxprint
   
   SELECT A.BOX_ID,A.BOX_NO,A.BOX_DT,A.FIN_YEAR,A.REF_MRR_ID ,B.PRODUCT_CODE,B.QUANTITY
   ,SKU.HSN_CODE ,C.ARTICLE_NO,SD.SUB_SECTION_NAME ,SM.SECTION_NAME
   ,P1.PARA1_NAME ,P2.PARA2_NAME ,P3.PARA3_NAME,P4.PARA4_NAME ,P5.PARA5_NAME ,P6.PARA6_NAME 
   ,ISNULL(@AC_NAME,'') AC_NAME,PIM.MRR_NO ,PIM.MRR_DT ,sku.mrp,p2.para2_order 
   into #tmpboxprint
   FROM BOXM A (NOLOCK)
   JOIN BOXD B (NOLOCK) ON A.BOX_ID=B.BOX_ID
   JOIN PIM01106 PIM (NOLOCK) ON PIM.mrr_id =A.REF_MRR_ID 
   JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE 
   JOIN ARTICLE C (NOLOCK) ON SKU.ARTICLE_CODE=C.ARTICLE_CODE   
   JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE= P1.PARA1_CODE    
   JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE= P2.PARA2_CODE    
   JOIN PARA3 P3 (NOLOCK) ON SKU.PARA3_CODE= P3.PARA3_CODE    
   JOIN PARA4 P4 (NOLOCK) ON SKU.PARA4_CODE= P4.PARA4_CODE    
   JOIN PARA5 P5 (NOLOCK) ON SKU.PARA5_CODE= P5.PARA5_CODE    
   JOIN PARA6 P6 (NOLOCK) ON SKU.PARA6_CODE= P6.PARA6_CODE    
   JOIN SECTIOND SD (NOLOCK) ON C.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
   JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE= SM.SECTION_CODE    
   WHERE (@CMRR_ID='' OR A.REF_MRR_ID=@CMRR_ID) AND (@NBOX_NO=0 OR A.BOX_NO= @NBOX_NO)
   ORDER BY A.REF_MRR_ID,B.PRODUCT_CODE
   
  -- DECLARE @CPARA1BATCH VARCHAR(MAX)
   
  --SELECT   @CPARA1BATCH=ISNULL(@CPARA1BATCH+',','')+ ( PARA1_NAME)
  --FROM
  --(
  --SELECT DISTINCT  PARA1_NAME  
  --FROM #TMPBOXPRINT
  --) A
  
   
   
   SELECT  A.* ,
   COALESCE(STUFF((SELECT DISTINCT  ','+ RTRIM(LTRIM(BOXP.PARA1_NAME)) FROM  #TMPBOXPRINT BOXP  
   WHERE A.REF_MRR_ID  =BOXP.REF_MRR_ID AND A.BOX_NO=BOXP.BOX_NO FOR XML PATH('')),1,1,''),'')  AS PARA1_GRP ,
   COALESCE(STUFF((SELECT   ','+ RTRIM(LTRIM(BOXP.PARA2_NAME)) FROM  #TMPBOXPRINT BOXP  
   WHERE A.REF_MRR_ID  =BOXP.REF_MRR_ID AND A.BOX_NO=BOXP.BOX_NO group by RTRIM(LTRIM(BOXP.PARA2_NAME)),boxp.para2_order order by boxp.para2_order FOR XML PATH('') ),1,1,''),'')  AS PARA2_GRP 
   FROM #TMPBOXPRINT A
   ORDER BY A.REF_MRR_ID,a.PRODUCT_CODE
END
