CREATE PROCEDURE SP_GEN_FINISH_GOODS  
@NQUERYID NUMERIC (2,0),  
@CMEMOID VARCHAR(40),  
@CWHERE VARCHAR(500),  
@CPRODUCTCODE VARCHAR(50),  
@CFINYEAR VARCHAR(5),  
@NNAVMODE NUMERIC(2,0)  
-- WITH ENCRYPTION
 
AS  
BEGIN  
  
DECLARE @CCMD NVARCHAR(MAX)  
  
IF   
@NQUERYID = 1  
GOTO LBLNAVIGATE  
  
ELSE IF   
@NQUERYID = 2  
GOTO LBLGETMASTERS  
  
ELSE IF   
@NQUERYID = 3  
GOTO LBLGETDETAILS  
  
ELSE IF  
@NQUERYID = 4  
GOTO LBLGETORDERWISEITEMS  
  
ELSE IF  
@NQUERYID = 5  
GOTO LBLGETWORKORDERMASTER  
  
  
LBLNAVIGATE:  
 EXECUTE SP_NAVIGATE 'PRD_FINISH_MST',@NNAVMODE,@CMEMOID,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERE  
GOTO LAST  
  
LBLGETMASTERS:  
 SELECT DISTINCT T1.*  
 ,ISNULL(T6.MEMO_NO,'') AS WORK_ORDER_MEMO_NO  
 ,ISNULL(T6.REF_NO,'') AS WORK_REFNO  
 ,(CASE WHEN T6.MEMO_DT <> '' THEN CONVERT(CHAR(10),ISNULL(T6.MEMO_DT,''),105) ELSE ''  END) AS WORKORDERDT  
 FROM PRD_FINISH_MST T1  
    JOIN PRD_WO_MST T6 ON T1.REF_PRD_WORKORDER_MEMOID= T6.MEMO_ID  
 WHERE T1.MEMO_ID = @CMEMOID  
  
GOTO LAST  
  
LBLGETDETAILS:  
 DECLARE @CREFWORKORDERMEMOID VARCHAR(MAX),@CSOURCEDEPTID VARCHAR(MAX),@CREFNO VARCHAR(MAX),@CORDERID VARCHAR(MAX)  
 IF @CMEMOID <> ''  
 BEGIN  
  SELECT TOP 1 @CREFWORKORDERMEMOID=REF_PRD_WORKORDER_MEMOID FROM PRD_FINISH_MST WHERE MEMO_ID = @CMEMOID  
  SELECT TOP 1 @CSOURCEDEPTID = DEPARTMENT_ID  FROM PRD_FINISH_MST WHERE MEMO_ID = @CMEMOID  
 END  
 ELSE  
  SELECT @CREFWORKORDERMEMOID = '',@CSOURCEDEPTID = '',@CREFNO = '',@CORDERID=''  
    
 SELECT C.UOM_NAME,B.ARTICLE_NO,B.ARTICLE_NAME,PARA1.PARA1_NAME,PARA2.PARA2_NAME  
 ,ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK  
 ,ISNULL(A.ISSUED_QTY ,0) AS ISSUED_QTY  
 ,ISNULL(OD.QUANTITY,0) AS TOTAL_QTY   
 ,(ISNULL(OD.QUANTITY,0) - ISNULL(A.ISSUED_QTY ,0)) AS BALANCE_QTY  
 ,FD.*   
 FROM PRD_FINISH_DET FD   
 JOIN PRD_FINISH_MST FM ON FM.MEMO_ID = FD.MEMO_ID    
 JOIN PRD_WO_MST D ON D.MEMO_ID = FM.REF_PRD_WORKORDER_MEMOID   
 JOIN BUYER_ORDER_MST OM ON D.REF_NO = OM.ORDER_NO --REF_NO
 LEFT OUTER JOIN BUYER_ORDER_DET OD ON OM.ORDER_ID = OD.ORDER_ID    
 AND OD.ARTICLE_CODE = FD.ARTICLE_CODE   
 AND OD.PARA1_CODE = FD.PARA1_CODE   
 AND OD.PARA2_CODE = FD.PARA2_CODE  
 JOIN ARTICLE B ON FD.ARTICLE_CODE  = B.ARTICLE_CODE  
 JOIN UOM C ON B.UOM_CODE = C.UOM_CODE   
 JOIN PARA1 ON PARA1.PARA1_CODE = FD.PARA1_CODE  
 JOIN PARA2 ON PARA2.PARA2_CODE = FD.PARA2_CODE  
 JOIN   
 (  
  SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP  
  ,SKU.MRP,SKU.PURCHASE_PRICE,SKU.WS_PRICE        
  FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID   
  WHERE PMT.DEPARTMENT_ID = @CSOURCEDEPTID   
 ) P ON P.PRODUCT_UID = FD.PRODUCT_UID    
 LEFT OUTER JOIN  
 (  
  SELECT D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,SUM(D.QUANTITY) AS ISSUED_QTY  
  FROM PRD_FINISH_DET D   
  JOIN PRD_FINISH_MST M ON M.MEMO_ID = D.MEMO_ID   
  WHERE M.REF_PRD_WORKORDER_MEMOID = @CREFWORKORDERMEMOID  
  AND M.DEPARTMENT_ID = @CSOURCEDEPTID  AND M.CANCELLED = 0   
  GROUP BY D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE  
 ) A ON A.ARTICLE_CODE = FD.ARTICLE_CODE AND A.PARA1_CODE = FD.PARA1_CODE AND A.PARA2_CODE = FD.PARA2_CODE   
 WHERE FD.MEMO_ID = @CMEMOID  
   
   
   
 SET @CCMD = N'SELECT D.*,C.UOM_NAME,B.ARTICLE_NO,B.ARTICLE_NAME,PARA1.PARA1_NAME,  
 ISNULL(P.WIP,0) AS QUANTITY_IN_STOCK ,PARA2.PARA2_NAME  
 ,ISNULL(O.ISSUED_QTY,0) AS ISSUED_QTY,  
 ISNULL(O.TOTAL_QTY,0) AS TOTAL_QTY,(ISNULL(O.TOTAL_QTY,0) - ISNULL(O.ISSUED_QTY ,0)) AS BALANCE_QTY  
 ,B.MRP ,P.PURCHASE_PRICE, P.WS_PRICE     
 FROM PRD_FINISH_CONSUMPTION_DET D   
 JOIN ARTICLE B ON D.ARTICLE_CODE  = B.ARTICLE_CODE   
 JOIN UOM C ON B.UOM_CODE = C.UOM_CODE   
 JOIN PARA1 ON PARA1.PARA1_CODE = D.PARA1_CODE  
 JOIN PARA2 ON PARA2.PARA2_CODE = D.PARA2_CODE   
 LEFT OUTER JOIN   
 (  
  SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP  
  ,SKU.MRP ,SKU.PURCHASE_PRICE, SKU.WS_PRICE       
  FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID   
  WHERE PMT.DEPARTMENT_ID = '''+ @CSOURCEDEPTID +'''  
 ) P ON P.PRODUCT_UID = D.PRODUCT_UID   
   
 LEFT OUTER JOIN   
 (  
  SELECT A.ARTICLE_CODE,K.PARA1_CODE,K.PARA2_CODE,K.QUANTITY AS TOTAL_QTY,S.ISSUED_QTY   
  FROM PRD_WO_DET A   
  JOIN PRD_WO_SUB_DET K ON A.ROW_ID = K.REF_ROW_ID    
  LEFT OUTER JOIN   
  (  
   SELECT D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,SUM(D.QUANTITY) AS ISSUED_QTY  
   FROM PRD_FINISH_CONSUMPTION_DET D   
   JOIN PRD_FINISH_MST M ON M.MEMO_ID = D.MEMO_ID   
   WHERE M.REF_PRD_WORKORDER_MEMOID = '''+ @CREFWORKORDERMEMOID +'''   
   AND M.DEPARTMENT_ID = '''+ @CSOURCEDEPTID +''' AND M.CANCELLED = 0  
   GROUP BY D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE  
  ) S   
  ON S.ARTICLE_CODE = A.ARTICLE_CODE AND S.PARA1_CODE = K.PARA1_CODE AND  S.PARA2_CODE = K.PARA2_CODE   
  WHERE A.MEMO_ID ='''+ @CREFWORKORDERMEMOID +'''  
 ) O   
 ON O.ARTICLE_CODE = D.ARTICLE_CODE AND O.PARA1_CODE = D.PARA1_CODE AND O.PARA2_CODE = D.PARA2_CODE   
 WHERE D.MEMO_ID ='''+@CMEMOID+''''  
  
 PRINT @CCMD   
 EXECUTE SP_EXECUTESQL @CCMD  
  
GOTO LAST  
  
  
LBLGETORDERWISEITEMS:  

SELECT C.UOM_NAME,B.ARTICLE_NO,PARA1.PARA1_NAME,PARA2.PARA2_NAME  
 ,ISNULL(P.QUANTITY_IN_STOCK ,0) AS QUANTITY_IN_STOCK  
 ,0 AS QUANTITY  
 ,ISNULL(A.ISSUED_QTY ,0) AS ISSUED_QTY  
 ,(SJ.QUANTITY) AS TOTAL_QTY   
 ,((SJ.QUANTITY) - ISNULL(A.ISSUED_QTY ,0)) AS BALANCE_QTY  
 ,('LATER_' + D.ARTICLE_SET_CODE +'-'+ SJ.PARA1_CODE +'-'+ SJ.PARA2_CODE) AS ROW_ID  
 ,B.MRP ,B.PURCHASE_PRICE ,B.ARTICLE_NAME   
 ,SJ.* ,D.ARTICLE_SET_CODE AS ARTICLE_CODE 
 FROM PRD_WO_MST D   
 JOIN 
 (
 SELECT DISTINCT DD.MEMO_ID,SD.PARA1_CODE,SD.PARA2_CODE,SD.QUANTITY 
 FROM PRD_WO_DET DD 
 JOIN PRD_WO_SUB_DET SD ON DD.ROW_ID=SD.REF_ROW_ID
 ) SJ ON SJ.MEMO_ID=D.MEMO_ID

 JOIN ARTICLE B ON D.ARTICLE_SET_CODE  = B.ARTICLE_CODE  
 JOIN UOM C ON B.UOM_CODE = C.UOM_CODE   
 JOIN PARA1 ON PARA1.PARA1_CODE = SJ.PARA1_CODE  
 JOIN PARA2 ON PARA2.PARA2_CODE = SJ.PARA2_CODE  

 LEFT OUTER JOIN   
 (  
  SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP  
  ,SKU.MRP,SKU.PURCHASE_PRICE,SKU.WS_PRICE        
  FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID   
  WHERE PMT.DEPARTMENT_ID = @CWHERE AND SKU.WORK_ORDER_ID = @CMEMOID   
 ) P ON P.ARTICLE_CODE = D.ARTICLE_SET_CODE AND P.PARA1_CODE = SJ.PARA1_CODE AND P.PARA2_CODE = SJ.PARA2_CODE   
 LEFT OUTER JOIN  
 (  
  SELECT D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,SUM(D.QUANTITY) AS ISSUED_QTY  
  FROM PRD_FINISH_DET D   
  JOIN PRD_FINISH_MST M ON M.MEMO_ID = D.MEMO_ID   
  WHERE M.REF_PRD_WORKORDER_MEMOID = @CMEMOID  
  AND M.DEPARTMENT_ID = @CWHERE  AND M.CANCELLED = 0   
  GROUP BY D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE  
 ) A ON A.ARTICLE_CODE = D.ARTICLE_SET_CODE AND A.PARA1_CODE = SJ.PARA1_CODE AND A.PARA2_CODE = SJ.PARA2_CODE   
 WHERE D.MEMO_ID = @CMEMOID AND ((SJ.QUANTITY) - ISNULL(A.ISSUED_QTY ,0)) > 0  
   
  
   
SET @CCMD = N'SELECT D.UOM_NAME  ,0 AS QUANTITY  ,K.PARA1_CODE,B.ARTICLE_NO,B.ARTICLE_NAME  
   ,PARA1.PARA1_NAME,K.PARA2_CODE   ,PARA2.PARA2_NAME,A.ARTICLE_CODE   
   ,(''LATER_'' + A.ARTICLE_CODE +''-''+ K.PARA1_CODE +''-''+ K.PARA2_CODE) AS ROW_ID  
   ,ISNULL(P.WIP,0) AS QUANTITY_IN_STOCK   ,P1.PRODUCT_UID  
   ,ISNULL(B.MRP,0) AS MRP,ISNULL(P1.PURCHASE_PRICE,0) AS PURCHASE_PRICE,ISNULL(P.WS_PRICE,0) AS WS_PRICE    
   ,(''LATER_'' + SM.ARTICLE_SET_CODE +''-''+ K.PARA1_CODE +''-''+ K.PARA2_CODE) AS REF_ROW_ID  
   FROM   PRD_WO_DET A   
   JOIN PRD_WO_MST SM ON SM.MEMO_ID = A.MEMO_ID   
   JOIN PRD_WO_SUB_DET K ON A.ROW_ID = K.REF_ROW_ID   
   JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE  
  -- JOIN PRD_SKU P1 ON P1.ARTICLE_CODE = A.ARTICLE_CODE AND P1.PARA1_CODE = K.PARA1_CODE AND P1.PARA2_CODE = K.PARA2_CODE  
  -- AND P1.COMPONENT_CODE=A.ARTICLE_CODE AND P1.COM_PARA1_CODE=K.PARA1_CODE AND P1.COM_PARA2_CODE=K.PARA2_CODE
  --AND P1.WORK_ORDER_ID=SM.MEMO_ID
  
     JOIN   
  (   
        SELECT WORK_ORDER_ID,A.PRODUCT_UID, ARTICLE_CODE,PARA1_CODE,PARA2_CODE,COMPONENT_CODE,COM_PARA1_CODE,  
        COM_PARA2_CODE,(PURCHASE_PRICE)   
        FROM PRD_SKU A (NOLOCK)  
        JOIN PRD_PMT B (NOLOCK) ON A.PRODUCT_UID = B.PRODUCT_UID   
        WHERE WORK_ORDER_ID = '''+ @CMEMOID +''' AND ISNULL(B.WIP,0)>0  
   ) P1 ON P1.ARTICLE_CODE = A.ARTICLE_CODE AND P1.PARA1_CODE = K.PARA1_CODE AND P1.PARA2_CODE = K.PARA2_CODE    
     AND P1.COMPONENT_CODE=A.ARTICLE_CODE AND P1.COM_PARA1_CODE=K.PARA1_CODE AND P1.COM_PARA2_CODE=K.PARA2_CODE  
     AND P1.WORK_ORDER_ID=SM.MEMO_ID  
  
   JOIN UOM D ON B.UOM_CODE = D.UOM_CODE   
   JOIN PARA1 ON PARA1.PARA1_CODE = K.PARA1_CODE   
   JOIN PARA2 ON PARA2.PARA2_CODE = K.PARA2_CODE   
	LEFT OUTER JOIN   
   (  
    SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP  
    ,SKU.MRP,SKU.PURCHASE_PRICE,SKU.WS_PRICE   ,SKU.COMPONENT_CODE     ,SKU.COM_PARA1_CODE,SKU.COM_PARA2_CODE     
    FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID   
    WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +''' AND SKU.WORK_ORDER_ID = '''+ @CMEMOID +''' AND PMT.QUANTITY_IN_STOCK>0  
   ) P  
   ON P.ARTICLE_CODE = A.ARTICLE_CODE AND P.PARA1_CODE = K.PARA1_CODE AND P.PARA2_CODE = K.PARA2_CODE  
   AND P.COMPONENT_CODE=A.ARTICLE_CODE AND P.COM_PARA1_CODE=K.PARA1_CODE AND P.COM_PARA2_CODE=K.PARA2_CODE
 
   WHERE A.MEMO_ID ='''+@CMEMOID+''' '  
  
   PRINT @CCMD   
   EXECUTE SP_EXECUTESQL @CCMD  
   
GOTO LAST  
  
LBLGETWORKORDERMASTER:  
 SELECT DISTINCT T1.*,CONVERT(CHAR(10),ISNULL(T1.MEMO_DT,''),105) AS MEMO_DATE,ART.ARTICLE_NO   
    FROM PRD_WO_MST T1  
    JOIN PRD_WO_DET T2 ON T2.MEMO_ID = T1.MEMO_ID  
    JOIN ARTICLE ART ON T1.ARTICLE_SET_CODE = ART.ARTICLE_CODE   
    WHERE T1.CANCELLED = 0 AND T1.MARK_AS_COMPLETED =1  
GOTO LAST  
  
  
LAST:  
END
