CREATE PROCEDURE SP3S_EOSS_SCHEMES_BILLMST_2
@CSCHEMEDETROWID VARCHAR(50),
@nSpId VARCHAR(500),
@CERRORMSG VARCHAR(MAX) OUTPUT
AS
BEGIN
	DECLARE @NBILLQTY NUMERIC(10,2),@NDISCOUNTFIGURE NUMERIC(6,2),@BAPPLYSCHEMEONNONEOSSITEMS BIT,
			@NDISCMETHOD INT,@BAPPLYCARDDISCOUNT BIT,@CSTEP VARCHAR(5),@NBILLAMOUNT NUMERIC(10,2)
	
BEGIN TRY
	
	SET @CSTEP='10'
	
	PRINT 'ENTER SP3S_EOSS_SCHEMES_BILLMST_2'
	SET @CERRORMSG = ''
	SELECT @NBILLQTY=SUM(QUANTITY) FROM SLS_CMd01106_UPLOAD (NOLOCK)
	WHERE sp_id=@nSpId

	SELECT @NBILLAMOUNT=SUBTOTAL FROM SLS_CMm01106_UPLOAD (NOLOCK)
	WHERE sp_id=@nSpId
	
	SET @CSTEP='20'

	SELECT TOP 1 @NDISCOUNTFIGURE=DISCOUNT_FIGURE,@NDISCMETHOD=DISC_METHOD,
	@BAPPLYSCHEMEONNONEOSSITEMS=APPLY_BILLLEVELSCHEME_ON_NONEOSS_ITEMS,
	@BAPPLYCARDDISCOUNT=APPLY_CARD_DISCOUNT_IF_BILLLEVELSCHEME_APPLICABLE
	FROM SCHEME_SETUP_SCHB002_1 A  JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID AND @NBILLQTY BETWEEN FROM_QTY AND TO_QTY
	
	--IF @@SPID=298
	--	SELECT 'CHECK #TMPCMD', @NBILLAMOUNT AS NBILLAMOUNT,MRP,QUANTITY,BASIC_DISCOUNT_PERCENTAGE FROM #TMPCMD
		
	--SELECT 'CHECK BUY MORE PAY LESS SCHEME',@NDISCMETHOD,@NDISCOUNTFIGURE,* FROM #TMPCMD
	
	--SELECT 'CHECK BUY MORE PAY LESS SCHEME',@CSCHEMEDETROWID,@NBILLQTY,@NDISCOUNTFIGURE
			    
	IF ISNULL(@NDISCOUNTFIGURE,0)<>0
	BEGIN
		SET @CSTEP='30'
		IF @NDISCMETHOD=1
			UPDATE #tmpslsdisctaxopt SET BILL_LEVEL_DISCOUNT_PERCENTAGE=@NDISCOUNTFIGURE,
			BILL_LEVEL_DISCOUNT_AMOUNT=@NBILLAMOUNT*@NDISCOUNTFIGURE/100
		ELSE
		BEGIN
			SET @CSTEP='40'
			UPDATE #tmpslsdisctaxopt SET BILL_LEVEL_DISCOUNT_AMOUNT=(CASE WHEN @NDISCOUNTFIGURE<@NBILLAMOUNT THEN 
			@NDISCOUNTFIGURE ELSE @NBILLAMOUNT END)
			
			UPDATE #tmpslsdisctaxopt SET BILL_LEVEL_DISCOUNT_PERCENTAGE=ROUND((BILL_LEVEL_DISCOUNT_AMOUNT/@NBILLAMOUNT)*100,3)
		END	

		UPDATE SLS_CMD01106_UPLOAD  SET Slsdet_ROW_ID=(CASE WHEN ISNULL(Slsdet_ROW_ID,'')='' THEN @CSCHEMEDETROWID ELSE 
						   Slsdet_ROW_ID END)
		WHERE sp_id=@nSpId
				
		
		PRINT 'BILL LEVEL DISCOUNT FINALLY APPLIED'
		SET @CSTEP='50'
		IF ISNULL(@BAPPLYCARDDISCOUNT,0)=0 AND EXISTS (SELECT TOP 1 PRODUCT_CODE FROM SLS_CMD01106_UPLOAD 
			WHERE sp_id=@nSpId AND ISNULL(CARD_DISCOUNT_PERCENTAGE,0)<>0)
			UPDATE SLS_CMD01106_UPLOAD SET CARD_DISCOUNT_PERCENTAGE=0 WHERE 
			sp_id=@nSpId AND ISNULL(CARD_DISCOUNT_PERCENTAGE,0)<>0
		
	END	
END TRY

BEGIN CATCH
	SET @CERRORMSG = 'PROCEDURE SP3S_EOSS_SCHEMES_BILLMST_2 : STEP- ' + @CSTEP + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:
	
END
