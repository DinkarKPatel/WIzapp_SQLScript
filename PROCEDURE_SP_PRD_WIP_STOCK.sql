CREATE PROCEDURE SP_PRD_WIP_STOCK
(
 @ASON_DATE DATETIME,
 @CPRODUCT_CODE VARCHAR(100)=''
)
AS
BEGIN
--1 FG STOCK---
IF OBJECT_ID('TEMPDB..#TMPFGSTK','U') IS NOT NULL
   DROP TABLE #TMPFGSTK

SELECT 1 AS SR, C.ORDER_ID ,A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE,SUM(A.ISSUE_QTY) AS FG_QTY  
INTO #TMPFGSTK
FROM PRD_STK_TRANSFER_MATERIAL_DET A
JOIN PRD_STK_TRANSFER_MST B ON A.MEMO_ID =B.MEMO_ID
JOIN
(
 SELECT REF_ROW_ID ,REF_WO_ID AS ORDER_ID ,MEMO_ID 
 FROM PRD_STK_TRANSFER_DET 
 GROUP BY REF_ROW_ID ,REF_WO_ID,MEMO_ID
) C ON B.MEMO_ID =C.MEMO_ID AND A.ROW_ID =C.REF_ROW_ID 
WHERE B.CANCELLED =0
GROUP BY C.ORDER_ID ,A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE


 

IF OBJECT_ID('TEMPDB..#TMPRMSTK','U') IS NOT NULL
   DROP TABLE #TMPRMSTK

SELECT 2 AS SR,'IN HOUSE' AS AGENCY_NAME, B.WORK_ORDER_ID AS ORDER_ID ,
       MST.ARTICLE_SET_CODE AS ARTICLE_CODE ,
       B.COM_PARA1_CODE ,B.COM_PARA2_CODE,B.COMPONENT_CODE ,
       B.ARTICLE_CODE AS RM_ARTICLE_CODE ,
       B.PRODUCT_CODE,
       B.PURCHASE_PRICE AS PURCHASE_PRICE,
       SUM(A.QUANTITY_IN_STOCK) RM_STK     
INTO #TMPRMSTK
FROM PRD_PMT A
JOIN PRD_SKU B ON A.PRODUCT_UID =B.PRODUCT_UID 
JOIN PRD_WO_MST MST ON MST.MEMO_ID  =B.WORK_ORDER_ID 
JOIN
(
  SELECT XN_PRODUCT_UID FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A
  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID =B.MEMO_ID 
  WHERE B.CANCELLED =0
  AND B.MEMO_DT <=@ASON_DATE
  UNION
  SELECT PRODUCT_UID FROM PRD_STK_TRANSFER_DET  A
  JOIN PRD_STK_TRANSFER_MST  B ON A.MEMO_ID =B.MEMO_ID 
  WHERE B.CANCELLED =0
  AND B.MEMO_DT <=@ASON_DATE
  UNION
  SELECT PRODUCT_UID FROM PRD_STK_TRANSFER_DET_PENDING   A
  JOIN PRD_STK_TRANSFER_MST_PENDING   B ON A.MEMO_ID =B.MEMO_ID 
  WHERE B.CANCELLED =0
  AND B.MEMO_DT <=@ASON_DATE
) XN ON XN.XN_PRODUCT_UID =B.PRODUCT_UID 
WHERE DEPARTMENT_ID ='DEF0001'
AND QUANTITY_IN_STOCK >0
GROUP BY B.WORK_ORDER_ID,MST.ARTICLE_SET_CODE ,B.COMPONENT_CODE , 
B.COM_PARA1_CODE ,B.COM_PARA2_CODE,B.PURCHASE_PRICE ,
B.ARTICLE_CODE ,B.PRODUCT_CODE
 

 
 IF OBJECT_ID('TEMPDB..#TMPAGSTK','U') IS NOT NULL
   DROP TABLE #TMPAGSTK
   
 SELECT 2 AS SR,D.AGENCY_NAME  AS AGENCY_NAME, C.REF_PRD_WORKORDER_MEMOID  AS ORDER_ID,
       A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE,0 AS FG_QTY  ,
       SKU.COMPONENT_CODE,
       SKU.ARTICLE_CODE AS RM_ARTICLE_CODE,SKU.PRODUCT_CODE,
       SKU.PURCHASE_PRICE ,
       C.ROW_ID ,
       C.QUANTITY-ISNULL(REC_QTY,0) AS RM_QTY  
 INTO #TMPAGSTK 
 FROM PRD_AGENCY_ISSUE_ROW_MATERIAL_DET A
 JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID 
 JOIN PRD_AGENCY_ISSUE_MATERIAL_DET C ON A.MEMO_ID =C.MEMO_ID AND A.ROW_ID =C.REF_MATERIAL_ROW_ID 
 JOIN PRD_AGENCY_MST D ON B.REF_AGENCY_CODE =D.AGENCY_CODE 
 JOIN PRD_SKU SKU ON SKU.PRODUCT_UID =C.PRODUCT_UID 
 LEFT OUTER JOIN
 (
   SELECT A.REF_ROW_ID ,SUM(A.QUANTITY) AS REC_QTY 
   FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A
   JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID =B.MEMO_ID 
   AND B.MEMO_DT <=@ASON_DATE
   WHERE B.CANCELLED =0
   GROUP BY A.REF_ROW_ID 
 ) REC ON C.ROW_ID =REC.REF_ROW_ID 
 WHERE B.CANCELLED =0
 AND B.MEMO_DT <=@ASON_DATE
 AND C.QUANTITY-ISNULL(REC_QTY,0)>0
 UNION ALL
 SELECT 2 AS SR,D.AGENCY_NAME  AS AGENCY_NAME, C.REF_PRD_WORKORDER_MEMOID  AS ORDER_ID,
       MST.ARTICLE_SET_CODE AS ARTICLE_CODE ,SKU.COM_PARA1_CODE AS  PARA1_CODE ,SKU.COM_PARA2_CODE AS PARA2_CODE,
       0 AS FG_QTY  ,
       SKU.COMPONENT_CODE,
       SKU.ARTICLE_CODE AS RM_ARTICLE_CODE,SKU.PRODUCT_CODE,
       SKU.PURCHASE_PRICE ,
       C.ROW_ID ,
       C.QUANTITY-ISNULL(REC_QTY,0) AS RM_QTY  
 FROM PRD_AGENCY_ISSUE_MATERIAL_MST_PENDING  B
 JOIN PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING C ON B.MEMO_ID =C.MEMO_ID
 JOIN PRD_AGENCY_MST D ON B.REF_AGENCY_CODE =D.AGENCY_CODE 
 JOIN PRD_SKU SKU ON SKU.PRODUCT_UID =C.PRODUCT_UID 
 JOIN PRD_WO_MST MST ON MST.MEMO_ID =C.REF_PRD_WORKORDER_MEMOID
 LEFT OUTER JOIN
 (
   SELECT A.REF_ROW_ID ,SUM(A.QUANTITY) AS REC_QTY 
   FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A
   JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID =B.MEMO_ID 
   WHERE B.CANCELLED =0
   AND B.MEMO_DT <=@ASON_DATE
   GROUP BY A.REF_ROW_ID 
 ) REC ON C.ROW_ID =REC.REF_ROW_ID 
 WHERE B.CANCELLED =0
 AND B.MEMO_DT <=@ASON_DATE
 AND C.QUANTITY-ISNULL(REC_QTY,0)>0
 
 
 IF OBJECT_ID('TEMPDB..#TMPAGSTK_DETAILS','U') IS NOT NULL
   DROP TABLE #TMPAGSTK_DETAILS
   
   SELECT  SR,A.AGENCY_NAME  , A.ORDER_ID,
           A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE,0 AS FG_QTY  ,
           A.COMPONENT_CODE,
           A.RM_ARTICLE_CODE ,A.PRODUCT_CODE,
           A.PURCHASE_PRICE ,
           SUM(RM_QTY) AS RM_QTY
   INTO #TMPAGSTK_DETAILS   
   FROM #TMPAGSTK A
   GROUP BY SR,A.AGENCY_NAME  , A.ORDER_ID,
   A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE,
   A.COMPONENT_CODE,
   A.RM_ARTICLE_CODE ,A.PRODUCT_CODE,
   A.PURCHASE_PRICE
 
 SELECT A.AGENCY_NAME ,A.ORDER_ID,
          A.ARTICLE_CODE,
          ART.ARTICLE_NO AS FG_ARTICLE_NO,
          ART.ARTICLE_NAME AS FG_ARTICLE_NAME,
          A.PARA1_CODE,
          P1.PARA1_NAME,
          A.PARA2_CODE  ,
          P2.PARA2_NAME ,
          B.FG_QTY ,
          A.COMPONENT_CODE ,
          ART1.ARTICLE_NO AS COMPONENT_ARTICLE_NO ,
          ART1.ARTICLE_NAME AS COMPONENT_ARTICLE_NAME ,
          A.RM_ARTICLE_CODE ,
          ART2.ARTICLE_NO AS RM_ARTICLE_NO  ,
          ART2.ARTICLE_NAME AS RM_ARTICLE_NAME  ,
          A.PRODUCT_CODE ,
          A.PURCHASE_PRICE ,
          A.RM_STK
FROM
(  
   SELECT SR=1, A.AGENCY_NAME ,A.ORDER_ID,
          A.ARTICLE_CODE,
          A.COM_PARA1_CODE AS PARA1_CODE,
          A.COM_PARA2_CODE AS PARA2_CODE ,
          A.COMPONENT_CODE ,
          A.RM_ARTICLE_CODE ,
          A.PRODUCT_CODE ,
          A.PURCHASE_PRICE ,
          A.RM_STK 
   FROM #TMPRMSTK A
   UNION ALL
   SELECT 2, A.AGENCY_NAME ,A.ORDER_ID,
          A.ARTICLE_CODE,
          A.PARA1_CODE,
          A.PARA2_CODE  ,
          A.COMPONENT_CODE ,
          A.RM_ARTICLE_CODE ,
          A.PRODUCT_CODE ,
          A.PURCHASE_PRICE ,
          A.RM_QTY  
   FROM #TMPAGSTK_DETAILS A
 ) A
 JOIN #TMPFGSTK B ON A.ORDER_ID=B.ORDER_ID AND A.ARTICLE_CODE=B.ARTICLE_CODE  
 AND A.PARA1_CODE=B.PARA2_CODE  AND A.PARA2_CODE=B.PARA2_CODE 
 JOIN ARTICLE ART ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
 JOIN PARA1 P1 ON P1.PARA1_CODE =A.PARA1_CODE 
 JOIN PARA2 P2 ON P2.PARA2_CODE =A.PARA2_CODE 
 JOIN ARTICLE ART1 ON ART1.ARTICLE_CODE =A.COMPONENT_CODE  
 JOIN ARTICLE ART2 ON ART2.ARTICLE_CODE =A.RM_ARTICLE_CODE 
 WHERE (@CPRODUCT_CODE='' OR A.PRODUCT_CODE =@CPRODUCT_CODE) 
 ORDER BY A.ORDER_ID,
  A.ARTICLE_CODE,
 A.PARA1_CODE,A.PARA2_CODE  , B.FG_QTY 
 
 END
