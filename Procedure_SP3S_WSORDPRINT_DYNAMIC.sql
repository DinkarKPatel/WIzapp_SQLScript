create PROCEDURE SP3S_WSORDPRINT_DYNAMIC
(
@cMemoId VARCHAR(40),
@CWHERE NVARCHAR(50)=''
)
AS
BEGIN
	SET NOCOUNT ON
	   DECLARE @cCmdCols NVARCHAR(MAX),@cCmd NVARCHAR(MAX),@cCols NVARCHAR(MAX),@cCmd1 NVARCHAR(MAX),@cCmd2 NVARCHAR(MAX),@cCmd3 NVARCHAR(MAX),@cCmdIMG NVARCHAR(MAX)
	   ,@PARA1 NVARCHAR(10),@PARA2 NVARCHAR(10),@PARA3 NVARCHAR(10),@PARA4 NVARCHAR(10),@PARA5 NVARCHAR(10),@PARA6 NVARCHAR(10),@cAc_code varchar(20)

		DECLARE @IMG_SECTION BIT,@IMG_SUB_SECTION BIT,@IMG_ARTICLE BIT,@IMG_PARA1 BIT,@IMG_PARA2 BIT,@IMG_PARA3 BIT,@IMG_PARA4 BIT,@IMG_PARA5 BIT,@IMG_PARA6 BIT,@IMG_PRODUCT BIT
		SELECT @IMG_SECTION=SECTION,@IMG_SUB_SECTION=SUB_SECTION,@IMG_ARTICLE=ARTICLE        
		,@IMG_PARA1=PARA1 ,@IMG_PARA2=PARA2, @IMG_PARA3=PARA3,@IMG_PARA4=PARA4        
		,@IMG_PARA5=PARA5 ,@IMG_PARA6=PARA6, @IMG_PRODUCT=PRODUCT        
		FROM DBO.IMAGE_INFO_CONFIG WITH(NOLOCK)  
		--END: 30 NOV 2019
		

		DECLARE @NTAXABLEVALUE NUMERIC(14,2),@NIGST_AMOUNT NUMERIC(14,2),@NCGST_AMOUNT NUMERIC(14,2),@NSGST_AMOUNT NUMERIC(14,2)
		
		SELECT  @NTAXABLEVALUE=ISNULL(BOD.XN_VALUE_WITHOUT_GST,0)+ ISNULL(BOM.OTHER_CHARGES_TAXABLE_VALUE,0),
			    @NIGST_AMOUNT=ISNULL(BOD.IGST_AMOUNT,0)+ISNULL(BOM.OTHER_CHARGES_IGST_AMOUNT,0),
			    @NCGST_AMOUNT=ISNULL(BOD.CGST_AMOUNT,0)+ISNULL(BOM.OTHER_CHARGES_CGST_AMOUNT,0),
			    @NSGST_AMOUNT=ISNULL(BOD.SGST_AMOUNT,0)+ ISNULL(BOM.OTHER_CHARGES_SGST_AMOUNT,0),
			    @cAc_code=bom.ac_code 
		FROM BUYER_ORDER_MST  BOM (NOLOCK)
		JOIN 
		( 
		   SELECT order_id ,
		          SUM(XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST,
				  SUM(IGST_AMOUNT ) AS IGST_AMOUNT,
				  SUM(CGST_AMOUNT ) AS CGST_AMOUNT,
				  SUM(SGST_AMOUNT) AS SGST_AMOUNT
		   FROM BUYER_ORDER_DET BOD (NOLOCK)
		   WHERE BOD.order_id=@CMEMOID
		   GROUP BY order_id
		 ) BOD ON BOM.order_id =BOD.order_id 
		 WHERE BOM.order_id=@cMemoId 

	
        SELECT TOP 1 @PARA1=VALUE FROM CONFIG WHERE config_option='PARA1_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA2=VALUE FROM CONFIG WHERE config_option='PARA2_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA3=VALUE FROM CONFIG WHERE config_option='PARA3_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA4=VALUE FROM CONFIG WHERE config_option='PARA4_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA5=VALUE FROM CONFIG WHERE config_option='PARA5_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA6=VALUE FROM CONFIG WHERE config_option='PARA6_caption' AND ISNULL(VALUE,'') <>''
	    SET @PARA1=CASE WHEN ISNULL(@PARA1,'')='' THEN 'Para1' ELSE ISNULL(@PARA1,'') END
	    SET @PARA2=CASE WHEN ISNULL(@PARA2,'')='' THEN 'Para2' ELSE ISNULL(@PARA2,'') END
	    SET @PARA3=CASE WHEN ISNULL(@PARA3,'')='' THEN 'Para3' ELSE ISNULL(@PARA3,'') END
	    SET @PARA4=CASE WHEN ISNULL(@PARA4,'')='' THEN 'Para4' ELSE ISNULL(@PARA4,'') END
	    SET @PARA5=CASE WHEN ISNULL(@PARA5,'')='' THEN 'Para5' ELSE ISNULL(@PARA5,'') END
	    SET @PARA6=CASE WHEN ISNULL(@PARA6,'')='' THEN 'Para6' ELSE ISNULL(@PARA6,'') END
	   
	    SELECT @cCols=COALESCE(@cCols+',','')+column_name+' ['+DISPLAY_COLUMN_NAME+']' 
	    FROM dynamic_print_cols	
	    WHERE LTRIM(RTRIM(xn_type))='wslord' AND selected=1
	    
	    select AC_CODE  lmacCode,
	           CAST('' as varchar(1000)) as TransporterName,
	           MOBILE as TransporterMobile,
			   E_MAIL as TransporterEmail
	    into #tmpTransporter 
	    from LMP01106 (nolock) where 1=2 
		
		if exists (select top 1 'U' FROM dynamic_print_cols	WHERE LTRIM(RTRIM(xn_type))='wslord' AND selected=1 and DISPLAY_COLUMN_NAME  in('TransporterName','TransporterMobile','TransporterEmail'))
		begin
		
			insert into #tmpTransporter(lmacCode,TransporterName,TransporterMobile,TransporterEmail)
			SELECT top 1 tr.lmacCode, B.AC_NAME As TransporterName,
				   C.MOBILE as TransporterMobile,
				   C.E_MAIL as TransporterEmail
			FROM lm_angm TR (NOLOCK)
			JOIN LM01106 B (NOLOCK) ON TR.angmacCode =B.AC_CODE 
			LEFT JOIN LMP01106 C (NOLOCK) ON TR.angmacCode =C.AC_CODE 
			WHERE lmacCode =@cAc_code
		
		end

		
	
	   DECLARE @CSPID VARCHAR(50),@CTABLENAME VARCHAR(50)

		SET @CSPID=LTRIM(RTRIM(STR(@@SPID )))
		SET @CTABLENAME  ='##TMPINVPRINT'+@CSPID

		SET @CCMD = N'IF OBJECT_ID(''TEMPDB..'+@CTABLENAME+''',''U'') IS NOT NULL
			DROP TABLE '+@CTABLENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
                

	   SET @cCmdCols=N'
	   SELECT '+@cCols+',
	   '''+@para1 +''' AS PARA1_CONFIG,'''+@PARA2 +''' AS PARA2_CONFIG,'''+@PARA3 +''' AS PARA3_CONFIG,
	   '''+@PARA4 +''' AS PARA4_CONFIG,'''+@PARA5 +''' AS PARA5_CONFIG,'''+@PARA6 +''' AS PARA6_CONFIG,
	   DBO.FN_CONVERTAMOUNTINWORDS(ABS(BOM.total_amount)) AS  NET_AMOUNT_IN_WORDS,
	   '+RTRIM(LTRIM(STR(@NTAXABLEVALUE ,14,2)))+' as Total_Taxable_value,
	   '+RTRIM(LTRIM(STR(@NIGST_AMOUNT,14,2)))+' as Total_Igst_Amount,
	   '+RTRIM(LTRIM(STR(@NSGST_AMOUNT,14,2)))+' as Total_Sgst_Amount,
	   '+RTRIM(LTRIM(STR(@NCGST_AMOUNT,14,2)))+' as Total_Cgst_amount,
	   BUYER_ORDER_DET.QUANTITY AS QTY,Way_bill,ApprovedLevelNo,CAST('''' AS VARCHAR(100)) AS DOCUMENTCOPY
	   '
	   +' INTO '+@CTABLENAME+' '
	   SET @cCmd1=N'  FROM BUYER_ORDER_DET  (NOLOCK)  
	   JOIN BUYER_ORDER_MST BOM (NOLOCK) ON BOM.ORDER_ID=BUYER_ORDER_DET.ORDER_ID         
	   JOIN USERS  (NOLOCK) ON USERS.USER_CODE=BOM.USER_CODE   
	   LEFT JOIN COMPANY CMP (NOLOCK) ON CMP.COMPANY_CODE=''01''  
	   LEFT JOIN LM01106 PRLM (NOLOCK) ON PRLM.AC_CODE=BOM.AC_CODE    
	   LEFT JOIN LMP01106 PRLMP (NOLOCK) ON PRLM.AC_CODE=PRLMP.AC_CODE    
	   LEFT JOIN AREA PRA (NOLOCK) ON PRLMP.AREA_CODE=PRA.AREA_CODE                  
	   LEFT JOIN CITY PRC (NOLOCK) ON PRA.CITY_CODE=PRC.CITY_CODE 
	   LEFT JOIN Gst_state_mst PRST(NOLOCK) ON PRLMP.ac_gst_state_code=PRST.gst_state_code
	   LEFT OUTER JOIN ANGM ANG ON PRLMP.ANGADIA_CODE =ANG.ANGADIA_CODE
	   JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID =BOM.WBO_FOR_DEPT_ID 
	   LEFT JOIN AREA SLA (NOLOCK) ON SL.AREA_CODE=SLA.AREA_CODE                  
	   LEFT JOIN CITY SLC (NOLOCK) ON SLA.CITY_CODE=SLC.CITY_CODE                  
	   LEFT JOIN GST_STATE_MST SLS (NOLOCK) ON SLS.GST_STATE_CODE=SL.GST_STATE_CODE
	   LEFT JOIN STANDARD_UOM SUOM (NOLOCK) ON SUOM.UOM_CODE=BUYER_ORDER_DET.AREA_UOM_CODE
	   LEFT OUTER JOIN LM01106 BN (NOLOCK) ON BOM.BROKER_AC_CODE=BN.AC_CODE
	   LEFT JOIN LM01106 SHLM (NOLOCK) ON SHLM.AC_CODE=BOM.SHIPPING_AC_CODE
	   LEFT JOIN LMP01106 SHLMP (NOLOCK) ON SHLMP.AC_CODE=BOM.SHIPPING_AC_CODE
	   LEFT JOIN AREA SHAR (NOLOCK) ON SHLMP.AREA_CODE=SHAR.AREA_CODE
	   left join #tmpTransporter tr on 1=1
	   '
       SET @cCmd3=N' 
	    LEFT JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=BUYER_ORDER_DET.PRODUCT_CODE AND ISNULL(BUYER_ORDER_DET.PRODUCT_CODE,'''')<>''''
	    JOIN ARTICLE ON ARTICLE.ARTICLE_CODE = isnull(SKU.ARTICLE_CODE,BUYER_ORDER_DET.ARTICLE_CODE)       
		LEFT OUTER JOIN ART_DET AD ON BUYER_ORDER_DET.ARTICLE_CODE=AD.ARTICLE_CODE AND BUYER_ORDER_DET.PARA2_CODE=AD.PARA2_CODE 
	    
		JOIN SECTIOND ON SECTIOND.SUB_SECTION_CODE= ARTICLE.SUB_SECTION_CODE        
	    JOIN SECTIONM ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE
		
	    JOIN PARA1 ON PARA1.PARA1_CODE =isnull(SKU.para1_code, BUYER_ORDER_DET.PARA1_CODE)        
	    JOIN PARA2 ON PARA2.PARA2_CODE = isnull(SKU.para2_code, BUYER_ORDER_DET.PARA2_CODE )
		LEFT JOIN PARA3 ON PARA3.PARA3_CODE = isnull(SKU.para3_code, BUYER_ORDER_DET.PARA3_CODE )
		LEFT JOIN PARA4 ON PARA4.PARA4_CODE =isnull(SKU.para4_code,  BUYER_ORDER_DET.PARA4_CODE) 
		LEFT JOIN PARA5 ON PARA5.PARA5_CODE = isnull(SKU.para5_code, BUYER_ORDER_DET.PARA5_CODE )
		LEFT JOIN PARA6 ON PARA6.PARA6_CODE = isnull(SKU.para6_code, BUYER_ORDER_DET.PARA6_CODE )

        LEFT JOIN UOM UOM (NOLOCK) ON UOM.UOM_CODE=ARTICLE.UOM_CODE                  
	    LEFT JOIN EMPLOYEE EMP ON EMP.EMP_CODE=BOM.SALE_EMP_CODE  
		LEFT JOIN ARTICLE_FIX_ATTR AF (NOLOCK) ON af.article_code=ARTICLE.article_code
       LEFT JOIN ATTR1_MST A1 (NOLOCK) ON A1.ATTR1_KEY_CODE=AF.ATTR1_KEY_CODE        
       LEFT JOIN ATTR2_MST A2 (NOLOCK) ON A2.ATTR2_KEY_CODE=AF.ATTR2_KEY_CODE        
       LEFT JOIN ATTR3_MST A3 (NOLOCK) ON A3.ATTR3_KEY_CODE=AF.ATTR3_KEY_CODE        
       LEFT JOIN ATTR4_MST A4 (NOLOCK) ON A4.ATTR4_KEY_CODE=AF.ATTR4_KEY_CODE        
       LEFT JOIN ATTR5_MST A5 (NOLOCK) ON A5.ATTR5_KEY_CODE=AF.ATTR5_KEY_CODE        
       LEFT JOIN ATTR6_MST A6 (NOLOCK) ON A6.ATTR6_KEY_CODE=AF.ATTR6_KEY_CODE        
       LEFT JOIN ATTR7_MST A7 (NOLOCK) ON A7.ATTR7_KEY_CODE=AF.ATTR7_KEY_CODE        
       LEFT JOIN ATTR8_MST A8 (NOLOCK) ON A8.ATTR8_KEY_CODE=AF.ATTR8_KEY_CODE        
       LEFT JOIN ATTR9_MST A9 (NOLOCK) ON A9.ATTR9_KEY_CODE=AF.ATTR9_KEY_CODE        
       LEFT JOIN ATTR10_MST A10 (NOLOCK) ON A10.ATTR10_KEY_CODE=AF.ATTR10_KEY_CODE        
       LEFT JOIN ATTR11_MST A11 (NOLOCK) ON A11.ATTR11_KEY_CODE=AF.ATTR11_KEY_CODE        
       LEFT JOIN ATTR12_MST A12 (NOLOCK) ON A12.ATTR12_KEY_CODE=AF.ATTR12_KEY_CODE        
       LEFT JOIN ATTR13_MST A13 (NOLOCK) ON A13.ATTR13_KEY_CODE=AF.ATTR13_KEY_CODE        
       LEFT JOIN ATTR14_MST A14 (NOLOCK) ON A14.ATTR14_KEY_CODE=AF.ATTR14_KEY_CODE        
       LEFT JOIN ATTR15_MST A15 (NOLOCK) ON A15.ATTR15_KEY_CODE=AF.ATTR15_KEY_CODE        
       LEFT JOIN ATTR16_MST A16 (NOLOCK) ON A16.ATTR16_KEY_CODE=AF.ATTR16_KEY_CODE        
       LEFT JOIN ATTR17_MST A17 (NOLOCK) ON A17.ATTR17_KEY_CODE=AF.ATTR17_KEY_CODE        
       LEFT JOIN ATTR18_MST A18 (NOLOCK) ON A18.ATTR18_KEY_CODE=AF.ATTR18_KEY_CODE        
       LEFT JOIN ATTR19_MST A19 (NOLOCK) ON A19.ATTR19_KEY_CODE=AF.ATTR19_KEY_CODE        
       LEFT JOIN ATTR20_MST A20 (NOLOCK) ON A20.ATTR20_KEY_CODE=AF.ATTR20_KEY_CODE        
       LEFT JOIN ATTR21_MST A21 (NOLOCK) ON A21.ATTR21_KEY_CODE=AF.ATTR21_KEY_CODE        
       LEFT JOIN ATTR22_MST A22 (NOLOCK) ON A22.ATTR22_KEY_CODE=AF.ATTR22_KEY_CODE        
       LEFT JOIN ATTR23_MST A23 (NOLOCK) ON A23.ATTR23_KEY_CODE=AF.ATTR23_KEY_CODE        
       LEFT JOIN ATTR24_MST A24 (NOLOCK) ON A24.ATTR24_KEY_CODE=AF.ATTR24_KEY_CODE        
       LEFT JOIN ATTR25_MST A25 (NOLOCK) ON A25.ATTR25_KEY_CODE=AF.ATTR25_KEY_CODE
	 
	   '

       
       IF CHARINDEX('PROD_IMAGE',@CCOLS)>0
       SET @cCmdIMG=N'LEFT OUTER JOIN ' + DB_NAME()+ '_IMAGE..IMAGE_INFO IMG (NOLOCK) ON 1=1 ' +
                            (CASE WHEN @IMG_SECTION = 1 THEN 'AND IMG.SECTION_CODE=SECTIONM.SECTION_CODE' ELSE ''  END) +
                            (CASE WHEN @IMG_SUB_SECTION = 1 THEN ' AND IMG.SUB_SECTION_CODE=SECTIOND.SUB_SECTION_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_ARTICLE = 1 THEN ' AND IMG.ARTICLE_CODE=ARTICLE.ARTICLE_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA1 = 1 THEN ' AND IMG.PARA1_CODE=BUYER_ORDER_DET.PARA1_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA2 = 1 THEN ' AND IMG.PARA2_CODE=BUYER_ORDER_DET.PARA2_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA3 = 1 THEN ' AND IMG.PARA3_CODE=BUYER_ORDER_DET.PARA3_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA4 = 1 THEN  ' AND IMG.PARA4_CODE=BUYER_ORDER_DET.PARA4_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA5 = 1 THEN  ' AND IMG.PARA5_CODE=BUYER_ORDER_DET.PARA5_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA6 = 1 THEN  ' AND IMG.PARA6_CODE=BUYER_ORDER_DET.PARA6_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PRODUCT = 1 THEN  'AND IMG.PRODUCT_CODE=BUYER_ORDER_DET.PRODUCT_CODE' ELSE '' END)
                            +' WHERE BOM.ORDER_ID='''+@cMemoId+''''       
       ELSE
          SET @cCmdIMG=N' WHERE BOM.ORDER_ID='''+@cMemoId+''''
     print 'cCmdCols '+@cCmdCols
    
       PRINT @ccmd1

       PRINT @ccmd3
       PRINT 'IMG '+@cCmdIMG
       EXEC(@cCmdCols+@ccmd1+@ccmd3+@cCmdIMG)

	   DECLARE  @CERRMSG VARCHAR(100)

	  
	   
 END_PROC:

	   IF ISNULL(@CERRMSG,'')<>'' 
	   BEGIN
		   SELECT @CERRMSG AS ERRMSG 
	   END
	   ELSE 
	   BEGIN
	        
		SET @CCMD = N'SELECT * FROM '+@CTABLENAME+' '
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

		--IF EXISTS(SELECT 'U' FROM SYS.TABLES WHERE NAME ='TBL_WSORDPRINT_DYNAMIC' AND DATEDIFF(d,create_date,getdate())<>0)
  --			DROP TABLE TBL_WSORDPRINT_DYNAMIC

		IF  OBJECT_ID('TBL_WSORDPRINT_DYNAMIC','U') IS NULL	
		BEGIN
			SET @CCMD = N'SELECT * INTO TBL_WSORDPRINT_DYNAMIC FROM '+@CTABLENAME+' WHERE 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
		END
	   END

	    SET @CCMD = N'IF OBJECT_ID(''TEMPDB..'+@CTABLENAME+''',''U'') IS NOT NULL
			DROP TABLE '+@CTABLENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

SET NOCOUNT OFF
END


