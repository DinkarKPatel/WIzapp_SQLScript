CREATE FUNCTION DBO.FN_GETSALEPERSON
(
	 @CXNID VARCHAR(40)
	,@NMODE NUMERIC(2)
	/*
		VALUE 0 : FOR RETAIL SALE XN
		VALUE 1 : FOR WHOLE  SALE XN
		VALUE 2 : FOR CREDIT NOTE XN
		THIS FUNCTION IS USED BY :
		VIEW : CUSTDBXN
	*/
)
RETURNS VARCHAR(200)
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CSALESPERSONNAME VARCHAR(200),@CSALESPERSONNAME1 VARCHAR(200),@CSALESPERSONNAME2 VARCHAR(200),
	@CSALESPERSONNAME3 VARCHAR(200)	
	
	IF @NMODE=0
	BEGIN
		SELECT TOP 1 @CSALESPERSONNAME1=EMP_NAME FROM CMD01106 A JOIN EMPLOYEE B ON A.EMP_CODE=B.EMP_CODE
		WHERE CM_ID=@CXNID AND ISNULL(EMP_NAME,'')<>''

		SELECT TOP 1 @CSALESPERSONNAME2=EMP_NAME FROM CMD01106 A JOIN EMPLOYEE B ON A.EMP_CODE1=B.EMP_CODE
		WHERE CM_ID=@CXNID AND ISNULL(EMP_NAME,'')<>''
		
		SELECT TOP 1 @CSALESPERSONNAME3=EMP_NAME FROM CMD01106 A JOIN EMPLOYEE B ON A.EMP_CODE2=B.EMP_CODE
		WHERE CM_ID=@CXNID AND ISNULL(EMP_NAME,'')<>''
		
		IF ISNULL(@CSALESPERSONNAME1,'')<>''
			SET  @CSALESPERSONNAME=@CSALESPERSONNAME1
		ELSE IF ISNULL(@CSALESPERSONNAME2,'')<>''		
			SET  @CSALESPERSONNAME=@CSALESPERSONNAME2
		ELSE IF ISNULL(@CSALESPERSONNAME3,'')<>''		
			SET  @CSALESPERSONNAME=@CSALESPERSONNAME3
		ELSE SET  @CSALESPERSONNAME=''
	END
	ELSE IF @NMODE=1
	BEGIN
		SELECT TOP 1 @CSALESPERSONNAME1=EMP_NAME FROM IND01106 A JOIN EMPLOYEE B ON A.EMP_CODE=B.EMP_CODE
		WHERE INV_ID=@CXNID AND ISNULL(EMP_NAME,'')<>''

		SELECT TOP 1 @CSALESPERSONNAME2=EMP_NAME FROM IND01106 A JOIN EMPLOYEE B ON A.EMP_CODE1=B.EMP_CODE
		WHERE INV_ID=@CXNID AND ISNULL(EMP_NAME,'')<>''
		
		SELECT TOP 1 @CSALESPERSONNAME3=EMP_NAME FROM IND01106 A JOIN EMPLOYEE B ON A.EMP_CODE2=B.EMP_CODE
		WHERE INV_ID=@CXNID AND ISNULL(EMP_NAME,'')<>''
		
		IF ISNULL(@CSALESPERSONNAME1,'')<>''
			SET  @CSALESPERSONNAME=@CSALESPERSONNAME1
		ELSE IF ISNULL(@CSALESPERSONNAME2,'')<>''		
			SET  @CSALESPERSONNAME=@CSALESPERSONNAME2
		ELSE IF ISNULL(@CSALESPERSONNAME3,'')<>''		
			SET  @CSALESPERSONNAME=@CSALESPERSONNAME3
		ELSE SET  @CSALESPERSONNAME=''
	END
	ELSE IF @NMODE=2
	BEGIN
		SELECT TOP 1 @CSALESPERSONNAME1=EMP_NAME FROM CND01106 A JOIN EMPLOYEE B ON A.EMP_CODE=B.EMP_CODE
		WHERE CN_ID=@CXNID AND ISNULL(EMP_NAME,'')<>''

		SELECT TOP 1 @CSALESPERSONNAME2=EMP_NAME FROM CND01106 A JOIN EMPLOYEE B ON A.EMP_CODE1=B.EMP_CODE
		WHERE CN_ID=@CXNID AND ISNULL(EMP_NAME,'')<>''
		
		SELECT TOP 1 @CSALESPERSONNAME3=EMP_NAME FROM CND01106 A JOIN EMPLOYEE B ON A.EMP_CODE2=B.EMP_CODE
		WHERE CN_ID=@CXNID AND ISNULL(EMP_NAME,'')<>''
		
		IF ISNULL(@CSALESPERSONNAME1,'')<>''
			SET  @CSALESPERSONNAME=@CSALESPERSONNAME1
		ELSE IF ISNULL(@CSALESPERSONNAME2,'')<>''		
			SET  @CSALESPERSONNAME=@CSALESPERSONNAME2
		ELSE IF ISNULL(@CSALESPERSONNAME3,'')<>''		
			SET  @CSALESPERSONNAME=@CSALESPERSONNAME3
		ELSE SET  @CSALESPERSONNAME=''
	END
RETURN 	@CSALESPERSONNAME
END --END OF FUNCTION : FN_GETSALEPERSON
