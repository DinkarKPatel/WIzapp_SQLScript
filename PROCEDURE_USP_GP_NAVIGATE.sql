CREATE PROCEDURE USP_GP_NAVIGATE
(
@CMEMO_ID VARCHAR(22)
)
AS
BEGIN 
 
          DECLARE @CCMD NVARCHAR(MAX)
          
          SET @CCMD=N'SELECT  MEMO_NO,MEMO_ID,MEMO_DT,TRANSPORTER_NAME,TRANSPORTER_CODE,
				REMARKS_MST,CANCELLED,
				FIN_YEAR,USER_CODE,LAST_UPDATE,EDT_USER_CODE,HANDOVER,HANDOVER_USER_CODE,HANDOVER_LAST_UPDATE
			   ,ISNULL(ANGADIA_ADD1,'''')+'' ''+ISNULL(ANGADIA_ADD2,'''')+'' ''+ISNULL(AREA_NAME,'''')+'' ''+ISNULL(CITY,'''') AS [ADDRESS]
               ,DELIVERED_BY,WAY_BILL,WAY_BILL_STR
                FROM(
                SELECT  MEMO_NO,MEMO_ID,MEMO_DT,ANGM.ANGADIA_NAME AS TRANSPORTER_NAME,N.TRANSPORTER_CODE,
				N.REMARKS AS REMARKS_MST,N.CANCELLED,
				N.FIN_YEAR,N.USER_CODE,N.LAST_UPDATE,N.EDT_USER_CODE,HANDOVER,HANDOVER_USER_CODE,HANDOVER_LAST_UPDATE
				,ANGM.ANGADIA_ADD1,ANGM.ANGADIA_ADD2,AR.AREA_NAME,CT.CITY
				,N.DELIVERED_BY,N.WAY_BILL,(CASE WHEN ISNULL(N.WAY_BILL,0)=1 THEN ''YES'' ELSE ''NO'' END) AS WAY_BILL_STR
				FROM TBL_GP_ISSUE_MST N (NOLOCK) 
				JOIN ANGM (NOLOCK) ON ANGM.ANGADIA_CODE=N.TRANSPORTER_CODE
				JOIN DBO.AREA AR WITH(NOLOCK) ON ANGM.AREA_CODE=AR.AREA_CODE
				JOIN DBO.CITY CT WITH(NOLOCK) ON AR.CITY_CODE=CT.CITY_CODE
				WHERE N.MEMO_ID='''+@CMEMO_ID+'''
				) T'
				
          PRINT @CCMD
          EXEC SP_EXECUTESQL @CCMD
          
            SET @CCMD=N'SELECT CHK, INV_NO,AC_NAME,INV_ID,INV_DT,
					QUANTITY,
					[WEIGHT],TOTAL_BOXES,REMARKS_DET,DELIVERED_BY,WAY_BILL,WAY_BILL_STR
                FROM (
                SELECT  CAST(1 AS BIT) AS CHK, INV_NO,L.AC_NAME,D.INV_ID,INV_DT,
                CAST(SUM(E.QUANTITY) AS NUMERIC(10,2))AS QUANTITY,
				B.QTY AS WEIGHT, 0 as TOTAL_BOXES,M.REMARKS AS REMARKS_DET
				,N.DELIVERED_BY,D.WAY_BILL,(CASE WHEN ISNULL(D.WAY_BILL,0)=1 THEN ''YES'' ELSE ''NO'' END) AS WAY_BILL_STR
				FROM 
				PARCEL_MST A(NOLOCK) JOIN 
				PARCEL_DET B(NOLOCK) ON A.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID
				JOIN INM01106 D(NOLOCK) ON C.REF_MEMO_ID=D.INV_ID
				JOIN IND01106 E(NOLOCK) ON E.INV_ID=D.INV_ID
				JOIN LM01106 L(NOLOCK) ON L.AC_CODE=D.AC_CODE
				JOIN TBL_GP_ISSUE_DET M (NOLOCK) ON M.INV_ID=D.INV_ID
				JOIN TBL_GP_ISSUE_MST N (NOLOCK) ON M.MEMO_ID=N.MEMO_ID
				JOIN DBO.ANGM AGM WITH(NOLOCK) ON N.TRANSPORTER_CODE=AGM.ANGADIA_CODE 
				WHERE M.MEMO_ID='''+@CMEMO_ID+'''
				AND D.CANCELLED=0 
				GROUP BY INV_NO,D.INV_ID,C.TOTAL_BOXES,B.QTY,INV_DT,L.AC_NAME,M.REMARKS
				,AGM.ANGADIA_NAME,N.DELIVERED_BY,D.WAY_BILL,(CASE WHEN ISNULL(D.WAY_BILL,0)=1 THEN ''YES'' ELSE ''NO'' END) 
				
				)T ORDER BY INV_NO '
          PRINT @CCMD
          EXEC SP_EXECUTESQL @CCMD
END

-- USP_GP_NAVIGATE  'HO0111700000GP00000047'
