CREATE PROCEDURE SP3S_BUDGET_UTIZ_REPORT--(LocId 3 digit change by Sanjay:04-11-2024)
(
	@CDEPT_ID VARCHAR(4)=''
)
--WITH ENCRYPTION
AS
BEGIN
/*EXEC SP3S_BUDGET_UTIZ_REPORT '01'*/
	DECLARE @DCUR_DATE DATETIME,@CCUR_FINYEAR VARCHAR(5)
			,@CSPID VARCHAR(5),@CEXPENSE_MONTH VARCHAR(50),@CEXP_COLLIST VARCHAR(MAX),@DTSQL NVARCHAR(MAX)
			,@DOP_DT DATETIME
			
	SET @CSPID=LTRIM(RTRIM(STR(@@SPID)))
	SET @CEXPENSE_MONTH='EXPENSES_'+@CSPID
	SET @CEXP_COLLIST='[APRIL_EXPENSE],[MAY_EXPENSE],[JUNE_EXPENSE],[JULY_EXPENSE],[AUGUST_EXPENSE],[SEPTEMBER_EXPENSE]
					 ,[OCTOBER_EXPENSE],[NOVEMBER_EXPENSE],[DECEMBER_EXPENSE],[JANUARY_EXPENSE],[FEBRUARY_EXPENSE],[MARCH_EXPENSE]'
	
	SET @DCUR_DATE=GETDATE()
	--GETTING CURRENT FIN_YEAR
	SET @CCUR_FINYEAR='01'+DBO.FN_GETFINYEAR(@DCUR_DATE)
	
	--SELECT @CCUR_FINYEAR,@DCUR_DATE
	
	IF OBJECT_ID('TEMPDB..#EXPENSES','U') IS NOT NULL
		DROP TABLE #EXPENSES
		
	IF OBJECT_ID('TEMPDB..#BUDGET','U') IS NOT NULL
		DROP TABLE #BUDGET	
	
	--CONSIDER TRANSACTION AF
	SELECT @DOP_DT=MAX(OPENING_CASH_DATE)
	FROM LOC_REQ WHERE DEPT_ID=@CDEPT_ID
	
	SELECT PEM.location_Code AS DEPT_ID,PED.AC_CODE,DATENAME(MONTH,PEM.PEM_MEMO_DT)+'_EXPENSE' AS [MONTH]
		  ,CONVERT(NUMERIC(10,0),SUM(CASE WHEN PED.XN_TYPE='DR' THEN PED.XN_AMOUNT ELSE -PED.XN_AMOUNT END)) AS EXPENSE	
	INTO #EXPENSES	  
	FROM PEM01106 PEM(NOLOCK)
	JOIN PED01106 PED(NOLOCK) ON PEM.PEM_MEMO_ID=PED.PEM_MEMO_ID
	WHERE PEM.CANCELLED=0 AND PEM.FIN_YEAR=@CCUR_FINYEAR
	AND (@CDEPT_ID='' OR pem.location_code=@CDEPT_ID)
	AND (ISNULL(@DOP_DT,'')='' OR PEM.PEM_MEMO_DT>=@DOP_DT)
	GROUP BY pem.location_code,PED.AC_CODE,DATENAME(MONTH,PEM.PEM_MEMO_DT)
	
	SET @DTSQL=N'IF OBJECT_ID('''+@CEXPENSE_MONTH+''',''U'') IS NOT NULL
						DROP TABLE '+@CEXPENSE_MONTH+'
				 SELECT DEPT_ID,AC_CODE,'+@CEXP_COLLIST+' 
				 INTO '+@CEXPENSE_MONTH+' 
				 FROM #EXPENSES
				 PIVOT (SUM(EXPENSE) FOR [MONTH] IN ('+@CEXP_COLLIST+')) AS PT'
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	IF OBJECT_ID('TEMPDB..#ALLDEPTHEADS','U') IS NOT NULL
		DROP TABLE #ALLDEPTHEADS
	
	SELECT DEPT_ID,AC_CODE
		  ,CONVERT(NUMERIC(10,0),MONTH1) AS APRIL_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH2) AS MAY_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH3) AS JUNE_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH4) AS JULY_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH5) AS AUGUST_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH6) AS SEPTEMBER_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH7) AS OCTOBER_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH8) AS NOVEMBER_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH9) AS DECEMBER_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH10) AS JANUARY_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH11) AS FEBRUARY_BUDGET 
		  ,CONVERT(NUMERIC(10,0),MONTH12) AS MARCH_BUDGET 
	INTO #BUDGET
	FROM MONTHLYBUDGET_HEAD (NOLOCK)
	WHERE DEPT_ID=@CDEPT_ID
	
	SELECT DEPT_ID,AC_CODE 
	INTO #ALLDEPTHEADS
	FROM #EXPENSES
	UNION 
	SELECT DEPT_ID,AC_CODE 
	FROM #BUDGET
	
	SET @DTSQL=N' SELECT AD.DEPT_ID,LOC.DEPT_NAME AS DEPT_NAME,LM.AC_NAME
	,ISNULL(BG.APRIL_BUDGET,0) AS APRIL_BUDGET,ISNULL(EX.APRIL_EXPENSE,0) AS APRIL_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.APRIL_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.APRIL_EXPENSE,0)/ISNULL(BG.APRIL_BUDGET,0))*100 END)) AS APRIL_UTILIZ
	
	,ISNULL(BG.MAY_BUDGET,0) AS MAY_BUDGET,ISNULL(EX.MAY_EXPENSE,0) AS MAY_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.MAY_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.MAY_EXPENSE,0)/ISNULL(BG.MAY_BUDGET,0))*100 END)) AS MAY_UTILIZ
	
	,ISNULL(BG.JUNE_BUDGET,0) AS JUNE_BUDGET,ISNULL(EX.JUNE_EXPENSE,0) AS JUNE_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.JUNE_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.JUNE_EXPENSE,0)/ISNULL(BG.JUNE_BUDGET,0))*100 END)) AS JUNE_UTILIZ
	
	,ISNULL(BG.JULY_BUDGET,0) AS JULY_BUDGET,ISNULL(EX.JULY_EXPENSE,0) AS JULY_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.JULY_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.JULY_EXPENSE,0)/ISNULL(BG.JULY_BUDGET,0))*100 END)) AS JULY_UTILIZ
	
	,ISNULL(BG.AUGUST_BUDGET,0) AS AUGUST_BUDGET,ISNULL(EX.AUGUST_EXPENSE,0) AS AUGUST_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.AUGUST_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.AUGUST_EXPENSE,0)/ISNULL(BG.AUGUST_BUDGET,0))*100 END)) AS AUGUST_UTILIZ
	
	,ISNULL(BG.SEPTEMBER_BUDGET,0) AS SEPTEMBER_BUDGET,ISNULL(EX.SEPTEMBER_EXPENSE,0) AS SEPTEMBER_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.SEPTEMBER_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.SEPTEMBER_EXPENSE,0)/ISNULL(BG.SEPTEMBER_BUDGET,0))*100 END)) AS SEPTEMBER_UTILIZ
	
	,ISNULL(BG.OCTOBER_BUDGET,0) AS OCTOBER_BUDGET,ISNULL(EX.OCTOBER_EXPENSE,0) AS OCTOBER_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.OCTOBER_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.OCTOBER_EXPENSE,0)/ISNULL(BG.OCTOBER_BUDGET,0))*100 END)) AS OCTOBER_UTILIZ
	
	,ISNULL(BG.NOVEMBER_BUDGET,0) AS NOVEMBER_BUDGET,ISNULL(EX.NOVEMBER_EXPENSE,0) AS NOVEMBER_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.NOVEMBER_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.NOVEMBER_EXPENSE,0)/ISNULL(BG.NOVEMBER_BUDGET,0))*100 END)) AS NOVEMBER_UTILIZ
	
	,ISNULL(BG.DECEMBER_BUDGET,0) AS DECEMBER_BUDGET,ISNULL(EX.DECEMBER_EXPENSE,0) AS DECEMBER_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.DECEMBER_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.DECEMBER_EXPENSE,0)/ISNULL(BG.DECEMBER_BUDGET,0))*100 END)) AS DECEMBER_UTILIZ
	
	,ISNULL(BG.JANUARY_BUDGET,0) AS JANUARY_BUDGET,ISNULL(EX.JANUARY_EXPENSE,0) AS JANUARY_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.JANUARY_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.JANUARY_EXPENSE,0)/ISNULL(BG.JANUARY_BUDGET,0))*100 END)) AS JANUARY_UTILIZ
	
	,ISNULL(BG.FEBRUARY_BUDGET,0) AS FEBRUARY_BUDGET,ISNULL(EX.FEBRUARY_EXPENSE,0) AS FEBRUARY_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.FEBRUARY_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.FEBRUARY_EXPENSE,0)/ISNULL(BG.FEBRUARY_BUDGET,0))*100 END)) AS FEBRUARY_UTILIZ
	
	,ISNULL(BG.MARCH_BUDGET,0) AS MARCH_BUDGET,ISNULL(EX.MARCH_EXPENSE,0) AS MARCH_EXPENSE
	,CONVERT(NUMERIC(10),(CASE WHEN ISNULL(BG.MARCH_BUDGET,0)=0 THEN 0 ELSE (ISNULL(EX.MARCH_EXPENSE,0)/ISNULL(BG.MARCH_BUDGET,0))*100 END)) AS MARCH_UTILIZ
	
	FROM #ALLDEPTHEADS AD
	JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=AD.DEPT_ID
	JOIN LM01106 LM(NOLOCK) ON AD.AC_CODE=LM.AC_CODE
	LEFT JOIN '+@CEXPENSE_MONTH+' EX ON AD.DEPT_ID=EX.DEPT_ID AND AD.AC_CODE=EX.AC_CODE
	LEFT JOIN #BUDGET BG ON AD.DEPT_ID=BG.DEPT_ID AND AD.AC_CODE=BG.AC_CODE'
	EXEC SP_EXECUTESQL @DTSQL
	
	/*
		SELECT * FROM #EXPENSES
		SELECT * FROM #BUDGET
		SELECT * FROM #ALLDEPTHEADS
		SELECT * FROM EXPENSES_131
	*/		
END	
--END OF PROCEDURE - SP3S_BUDGET_UTIZ_REPORT
