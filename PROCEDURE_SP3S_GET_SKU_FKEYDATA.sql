CREATE PROCEDURE SP3S_GET_SKU_FKEYDATA
@CSOURCEDB VARCHAR(200),
@CSOURCETABLE VARCHAR(200),
@CSOURCEKEYFIELD VARCHAR(200),
@CXNTYPE VARCHAR(10),
@CTABLESUFFIX VARCHAR(40),
@CLOCID VARCHAR(5),
@CERRORMSG VARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	BEGIN TRY
		DECLARE @CCMD NVARCHAR(MAX),@CTEMPTABLE VARCHAR(1000),@CTEMPTABLE1 VARCHAR(1000),@CTEMPTABLE2 VARCHAR(1000),
				@CTEMPTABLE3 VARCHAR(1000),@CKEYFIELDVAL VARCHAR(40),@CDESTDB VARCHAR(200),@CFILTERCONDITION VARCHAR(MAX),
				@NSTEP INT,@CSTR VARCHAR(200)
		
		SET @CDESTDB='WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.'
				
		SET @NSTEP=10
		SET @CTEMPTABLE=(CASE WHEN LEFT(@CSOURCETABLE,1)='#' THEN @CSOURCETABLE ELSE @CSOURCEDB+'TMP_'+@CXNTYPE+'_'+@CSOURCETABLE+'_'+@CTABLESUFFIX END)
		SET @CTEMPTABLE1=@CSOURCEDB+'TMP_'+@CXNTYPE+'_SKU_'+@CTABLESUFFIX

		IF @CSOURCETABLE<>'#TMPMISSINGSKUDATA'
		BEGIN			
			IF OBJECT_ID('TEMPDB..#TMPMISSINGSKUDATA','U') IS NOT NULL
				DROP TABLE #TMPMISSINGSKUDATA

			SELECT PRODUCT_CODE INTO #TMPMISSINGSKUDATA FROM SKU WHERE 1=2
		END
				
		SET @NSTEP=20
		IF OBJECT_ID('TEMPDB..#TMPMISSINGSKUDETAILSDATA','U') IS NOT NULL
			DROP TABLE #TMPMISSINGSKUDETAILSDATA

		SELECT FORM_ID,AC_CODE,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PARA3_CODE,PARA4_CODE,
			   PARA5_CODE,PARA6_CODE INTO #TMPMISSINGSKUDETAILSDATA FROM SKU WHERE 1=2
		
	
		IF @CSOURCETABLE<>'#TMPMISSINGSKUDATA'
		BEGIN			
			SET @NSTEP=30			
			SET @CCMD=N'SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SKU B ON B.PRODUCT_CODE=A.'+@CSOURCEKEYFIELD+'
						WHERE B.PRODUCT_CODE IS NULL  AND A.'+@CSOURCEKEYFIELD+' IS NOT NULL '+
						(CASE WHEN @CSOURCETABLE='SKU' 
						THEN  
						'UNION
						SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SKU B ON B.PRODUCT_CODE=A.'+@CSOURCEKEYFIELD+'
						WHERE (B.PRODUCT_CODE IS NULL  AND A.'+@CSOURCEKEYFIELD+' IS NOT NULL) OR A.AC_CODE<>B.AC_CODE OR A.ARTICLE_CODE<>B.ARTICLE_CODE
						OR A.PARA1_CODE<>B.PARA1_CODE OR A.PARA2_CODE<>B.PARA2_CODE OR A.PARA3_CODE<>B.PARA3_CODE
						OR A.PARA4_CODE<>B.PARA4_CODE OR A.PARA5_CODE<>B.PARA5_CODE OR A.PARA6_CODE<>B.PARA6_CODE'
						ELSE
						'UNION
						SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
						JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SKU C ON C.PRODUCT_CODE=A.'+@CSOURCEKEYFIELD+'
						WHERE C.PRODUCT_CODE IS NULL OR C.AC_CODE<>B.AC_CODE OR C.ARTICLE_CODE<>B.ARTICLE_CODE
						OR C.PARA1_CODE<>B.PARA1_CODE OR C.PARA2_CODE<>B.PARA2_CODE OR C.PARA3_CODE<>B.PARA3_CODE
						OR C.PARA4_CODE<>B.PARA4_CODE OR C.PARA5_CODE<>B.PARA5_CODE OR C.PARA6_CODE<>B.PARA6_CODE'
						END)

			INSERT #TMPMISSINGSKUDATA
			EXEC SP_EXECUTESQL @CCMD
		END
		
			
		IF EXISTS (SELECT TOP 1 PRODUCT_CODE FROM #TMPMISSINGSKUDATA)
		BEGIN
			
			SET @NSTEP=40
			SET @CSTR='A.FORM_ID,A.AC_CODE,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.PARA3_CODE,A.PARA4_CODE,A.PARA5_CODE,A.PARA6_CODE'
			
			IF OBJECT_ID(@CTEMPTABLE1,'U') IS NOT NULL
				SET @CCMD=N'SELECT DISTINCT '+@CSTR+' FROM '+@CTEMPTABLE1+'  A 
							JOIN #TMPMISSINGSKUDATA B ON A.PRODUCT_CODE=B.PRODUCT_CODE
							UNION
							SELECT DISTINCT '+@CSTR+' FROM SKU A 
							JOIN #TMPMISSINGSKUDATA B ON A.PRODUCT_CODE=B.PRODUCT_CODE '
			ELSE
				SET @CCMD=N'SELECT DISTINCT '+@CSTR+' FROM SKU A 
							JOIN #TMPMISSINGSKUDATA B ON A.PRODUCT_CODE=B.PRODUCT_CODE '
			
			PRINT @CCMD
			INSERT #TMPMISSINGSKUDETAILSDATA
			EXEC SP_EXECUTESQL @CCMD
			
			
			SET @NSTEP=45			
			EXEC SP3S_GET_FORM_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGSKUDETAILSDATA',
			@CSOURCEKEYFIELD='FORM_ID',
			@CXNTYPE=@CXNTYPE,
			@CTABLESUFFIX=@CTABLESUFFIX,
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT

			
			SET @NSTEP=50			
			EXEC SP3S_GET_ARTICLE_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGSKUDETAILSDATA',
			@CSOURCEKEYFIELD='ARTICLE_CODE',
			@CXNTYPE=@CXNTYPE,
			@CTABLESUFFIX=@CTABLESUFFIX,
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT
			
			SET @NSTEP=60
			EXEC SP3S_GET_PARA1_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGSKUDETAILSDATA',
			@CSOURCEKEYFIELD='PARA1_CODE',
			@CXNTYPE=@CXNTYPE,
			@CTABLESUFFIX=@CTABLESUFFIX,
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT
			
			SET @NSTEP=70
			EXEC SP3S_GET_PARA2_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGSKUDETAILSDATA',
			@CSOURCEKEYFIELD='PARA2_CODE',
			@CXNTYPE=@CXNTYPE,
			@CTABLESUFFIX=@CTABLESUFFIX,
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT
			
			SET @NSTEP=80
			EXEC SP3S_GET_PARA3_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGSKUDETAILSDATA',
			@CSOURCEKEYFIELD='PARA3_CODE',
			@CXNTYPE=@CXNTYPE,
			@CTABLESUFFIX=@CTABLESUFFIX,
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT
			
			SET @NSTEP=90						
			EXEC SP3S_GET_PARA4_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGSKUDETAILSDATA',
			@CSOURCEKEYFIELD='PARA4_CODE',
			@CXNTYPE=@CXNTYPE,
			@CTABLESUFFIX=@CTABLESUFFIX,
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT			
			
			SET @NSTEP=100
			EXEC SP3S_GET_PARA5_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGSKUDETAILSDATA',
			@CSOURCEKEYFIELD='PARA5_CODE',
			@CXNTYPE=@CXNTYPE,
			@CTABLESUFFIX=@CTABLESUFFIX,
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT
			
			SET @NSTEP=110
			EXEC SP3S_GET_PARA6_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGSKUDETAILSDATA',
			@CSOURCEKEYFIELD='PARA6_CODE',
			@CXNTYPE=@CXNTYPE,
			@CTABLESUFFIX=@CTABLESUFFIX,
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT
			
			SET @NSTEP=120
			EXEC SP3S_GET_LM01106_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGSKUDETAILSDATA',
			@CSOURCEKEYFIELD='AC_CODE',
			@CXNTYPE=@CXNTYPE,
			@CTABLESUFFIX=@CTABLESUFFIX,
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT
			
			SET @NSTEP=130				
			SET @CFILTERCONDITION='B.PRODUCT_CODE IN (SELECT PRODUCT_CODE FROM #TMPMISSINGSKUDATA)'
			
			EXEC UPDATEMASTERXN_MIRROR
			@CSOURCEDB='',
			@CSOURCETABLE='SKU',
			@CDESTDB=@CDESTDB,
			@CDESTTABLE='SKU',
			@CKEYFIELD1='PRODUCT_CODE',
			@LINSERTONLY=0,
			@CFILTERCONDITION=@CFILTERCONDITION,
			
			
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1
		END
		
		GOTO END_PROC									
	END TRY
	
	BEGIN CATCH
		SELECT @CERRORMSG='PROCEDURE SP3S_GET_SKU_FKEYDATA : '+ISNULL(ERROR_PROCEDURE(),'NULL P')+'STEP :'+STR(ISNULL(@NSTEP,0))+ ' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		GOTO END_PROC
	END CATCH
	
END_PROC:
		
END
----'END OF PROCEDURE SP3S_GET_SKU_FKEYDATA'
