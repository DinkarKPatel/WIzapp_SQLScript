CREATE PROC VALIDATEXN_JWI_BEFORE_EDIT 
@CMEMOID VARCHAR(30),
@BCANCELXN BIT,
@CERRORMSG VARCHAR(200) OUTPUT,
@CEXPRERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CTEXT VARCHAR(10),@CPRODUCTCODE VARCHAR(50)
	
	SELECT @CPRODUCTCODE=''
	
	SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)
	
	IF EXISTS (SELECT TOP 1 A.ISSUE_ID 
			   FROM JOBWORK_ISSUE_MST A 
			   JOIN JOBWORK_ISSUE_DET B ON A.ISSUE_ID=B.ISSUE_ID 
			   JOIN JOBWORK_RECEIPT_DET D ON D.REF_ROW_ID=B.ROW_ID
			   JOIN JOBWORK_RECEIPT_MST E ON E.RECEIPT_ID=D.RECEIPT_ID
			   WHERE A.ISSUE_ID=@CMEMOID AND A.CANCELLED=0 AND E.CANCELLED=0 AND B.JOB_CODE=D.JOB_CODE )
	BEGIN	
		SET @CERRORMSG='ONE OR MORE REFERENCES OF THIS MEMO IS FOUND INTO JOB RECEIPT.........CAN NOT '+@CTEXT
		RETURN
	END
		
END
