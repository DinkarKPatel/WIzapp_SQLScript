create PROCEDURE SP3S_UPDATE_Onlineorder_stock
@nSpId VARCHAR(40),
@cErrormsg VARCHAR(MAX) OUTPUT
AS
BEGIN
	DECLARE @cStep VARCHAR(20),@bNewEntry BIT
	
	set @CERRORMSG=''

	set @cStep='10'
	
BEGIN TRANSACTION
BEGIN TRY
    
	--APPLICATION NOT DEBUG HOW TO INSERT ZERO QUANTITY (ANIL SIR)21-12-2022
	IF EXISTS (SELECT TOP 1 'U' FROM  ONLINEORDER_BARCODE_NETQTY A (NOLOCK)
	  WHERE SP_ID=@NSPID AND ISNULL(ALLOCATE_QTY,0)=0)
	  DELETE A FROM ONLINEORDER_BARCODE_NETQTY A (NOLOCK)
	  WHERE SP_ID=@NSPID AND ISNULL(ALLOCATE_QTY,0)=0

	INSERT PMT01106	( BIN_ID, DEPT_ID, DEPT_ID_NOT_STUFFED, last_update, product_code, quantity_in_stock, rep_id, STOCK_RECO_QUANTITY_IN_STOCK,bo_order_id )  
    SELECT 	A.BIN_ID  BIN_ID,A.DEPT_ID  DEPT_ID,'' DEPT_ID_NOT_STUFFED,GETDATE() LAST_UPDATE,A. PRODUCT_CODE,0 QUANTITY_IN_STOCK,'' REP_ID, 0STOCK_RECO_QUANTITY_IN_STOCK ,
	        a.order_id
	FROM  ONLINEORDER_BARCODE_NETQTY  (NOLOCK)  A
	LEFT JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE AND A.DEPT_ID =B.DEPT_ID AND A.BIN_ID =B.BIN_ID and a.order_id=isnull(b.bo_order_id ,'')
	WHERE SP_ID=@NSPID  and b.product_code is null
	group by a.PRODUCT_CODE,a.DEPT_ID,a.BIN_ID,a.order_id
	


	UPDATE A SET QUANTITY_IN_STOCK=QUANTITY_IN_STOCK-ISNULL(B.Allocate_Qty,0)
	FROM PMT01106 A (NOLOCK)
	JOIN
	(
	  SELECT PRODUCT_CODE,DEPT_ID,BIN_ID,
	          SUM(Allocate_Qty) AS Allocate_Qty
	  FROM ONLINEORDER_BARCODE_NETQTY A (NOLOCK)
	  WHERE SP_ID=@NSPID 
	  group by PRODUCT_CODE,DEPT_ID,BIN_ID
	) B  ON A.PRODUCT_CODE =B.PRODUCT_CODE AND A.DEPT_ID =B.DEPT_ID AND A.BIN_ID =B.BIN_ID 
	where isnull(a.bo_order_id ,'')=''

	if exists (SELECT TOP 1 'U'	FROM PMT01106 A (NOLOCK)
	JOIN
	(
	  SELECT PRODUCT_CODE,DEPT_ID,BIN_ID,
	          SUM(Allocate_Qty) AS Allocate_Qty
	  FROM ONLINEORDER_BARCODE_NETQTY A (NOLOCK)
	  WHERE SP_ID=@NSPID 
	  group by PRODUCT_CODE,DEPT_ID,BIN_ID
	) B  ON A.PRODUCT_CODE =B.PRODUCT_CODE AND A.DEPT_ID =B.DEPT_ID AND A.BIN_ID =B.BIN_ID 
	where isnull(a.bo_order_id ,'')='' and quantity_in_stock<0)
	begin
	    set @CERRORMSG='Stock Going Negative'
		goto END_PROC
	end



	UPDATE A SET QUANTITY_IN_STOCK=QUANTITY_IN_STOCK+ISNULL(B.Allocate_Qty,0)
	FROM PMT01106 A (NOLOCK)
	JOIN
	(
	  SELECT PRODUCT_CODE,DEPT_ID,BIN_ID,a.order_id,
	          SUM(Allocate_Qty) AS Allocate_Qty
	  FROM ONLINEORDER_BARCODE_NETQTY A (NOLOCK)
	  WHERE SP_ID=@NSPID 
	  group by PRODUCT_CODE,DEPT_ID,BIN_ID,a.order_id
	) B  ON A.PRODUCT_CODE =B.PRODUCT_CODE AND A.DEPT_ID =B.DEPT_ID AND A.BIN_ID =B.BIN_ID and a.bo_order_id=b.order_id
	where isnull(a.bo_order_id ,'')<>''



	GOTO END_PROC
END TRY

BEGIN CATCH	
	SET @cErrormsg='Error in SP3S_UPDATE_Onlineorder_stock at Step#'+@cStep +' '+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:
IF @@TRANCOUNT>0
	BEGIN

		IF ISNULL(@CERRORMSG,'')='' 
		BEGIN
			commit TRANSACTION
		END	
		ELSE
		BEGIN
		    ROLLBACK	
		END
	END	

	DELETE A  FROM ONLINEORDER_BARCODE_NETQTY A 
	WHERE SP_ID=@NSPID 
END

