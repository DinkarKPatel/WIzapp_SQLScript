CREATE PROCEDURE SP_WL_GETTAXDETAILS
(
	@MEMODT				DATETIME,
	@PRODUCT_CODE		VARCHAR(50),
	@NMRP				NUMERIC(14,2),
	@NNET				NUMERIC(14,2),
	@STATECODE			VARCHAR(20)
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @FIRSTDT    DATETIME,  
   @SECONDDT    DATETIME,  
   @MEMOID     VARCHAR(50),  
   @SUB_SECTION_CODE  VARCHAR(20),  
   @NTAXCALCBASIS   INT,  
   @NBASEVALUE    NUMERIC(10,2)  
  
 DECLARE @OUTPUTC TABLE ( TAX_PERCENTAGE NUMERIC(10,3), TAX_AC_CODE VARCHAR(20),   
        TAX_AC_NAME VARCHAR(100), SALE_AC_CODE VARCHAR(20),   
        SALE_AC_NAME VARCHAR(100),TAX_METHOD NUMERIC(4) )  
  
     
 SELECT @SUB_SECTION_CODE = B.SUB_SECTION_CODE   
 FROM SKU A  
 JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE  
 WHERE A.PRODUCT_CODE = @PRODUCT_CODE  
  
 IF ISNULL(@SUB_SECTION_CODE,'') = ''  
  GOTO ENDPROC  
   
 SELECT TOP 1 @MEMOID = A.MEMO_ID,@NTAXCALCBASIS=TAX_CALC_BASIS   
 FROM LOCSST_MST A  
 JOIN LOCSST B ON B.MEMO_ID=A.MEMO_ID  
 WHERE FROM_DT<=@MEMODT AND B.SUB_SECTION_CODE=@SUB_SECTION_CODE --AND A.STATE_CODE=@STATECODE  
 ORDER BY FROM_DT DESC  
   
 IF @NTAXCALCBASIS=1  
  SET @NBASEVALUE=@NNET  
 ELSE  
  SET @NBASEVALUE=@NMRP  
    
 IF ISNULL(@MEMOID,'') = ''  
  GOTO ENDPROC  
  
 -- GETTING TAX INFO FROM LOCSSTADD, IF VARIANCE FOUND.  
 INSERT @OUTPUTC ( TAX_PERCENTAGE, TAX_AC_CODE, TAX_AC_NAME, SALE_AC_CODE,   
       SALE_AC_NAME,TAX_METHOD )  
 SELECT A.TAX_PERCENTAGE, A.TAX_AC_CODE, LM.AC_NAME AS TAX_AC_NAME,   
   A.SALE_AC_CODE, LM_SLS.AC_NAME AS SALE_AC_NAME  ,B.TAX_METHOD
 FROM LOCSSTADD A  
 JOIN LOCSST B ON B.ROW_ID=A.LOCSST_ROW_ID  
 JOIN LMV01106 LM ON LM.AC_CODE=A.TAX_AC_CODE  
 JOIN LMV01106 LM_SLS ON LM_SLS.AC_CODE=A.SALE_AC_CODE  
 WHERE B.MEMO_ID = @MEMOID   
 AND B.SUB_SECTION_CODE = @SUB_SECTION_CODE   
 AND (ABS(@NBASEVALUE) BETWEEN MIN_MRP AND MAX_MRP)  
  
 IF(@@ROWCOUNT=0)  
 BEGIN  
  INSERT @OUTPUTC ( TAX_PERCENTAGE, TAX_AC_CODE, TAX_AC_NAME, SALE_AC_CODE,   
        SALE_AC_NAME,TAX_METHOD )  
  SELECT  A.TAX_PERCENTAGE, A.TAX_AC_CODE, LM.AC_NAME AS TAX_AC_NAME, A.SALE_AC_CODE,   
    LM_SLS.AC_NAME AS SALE_AC_NAME,A.TAX_METHOD  
  FROM LOCSST A  
  JOIN LOCSST_MST MST ON MST.MEMO_ID=A.MEMO_ID    
  JOIN SECTIOND B ON A.SUB_SECTION_CODE= B.SUB_SECTION_CODE  
  JOIN SECTIONM C ON B.SECTION_CODE= C.SECTION_CODE  
  JOIN STATE D ON MST.STATE_CODE = D.STATE_CODE    
  JOIN LMV01106 LM ON LM.AC_CODE=A.TAX_AC_CODE  
  JOIN LMV01106 LM_SLS ON LM_SLS.AC_CODE=A.SALE_AC_CODE  
  WHERE MST.MEMO_ID= @MEMOID AND B.SUB_SECTION_CODE=@SUB_SECTION_CODE  
  ORDER BY C.SECTION_NAME,B.SUB_SECTION_NAME  
 END  
   
ENDPROC:  
 SELECT * FROM @OUTPUTC  
END
--********************************* END OF PROCEDURE SP_WL_GETTAXDETAILS
