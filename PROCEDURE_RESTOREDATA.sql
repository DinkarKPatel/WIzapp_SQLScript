CREATE PROCEDURE RESTOREDATA
		@CDB VARCHAR(40),
		@CBACKUPFILE VARCHAR(1000),
		@CDATFILENAME VARCHAR(1000)='',
		@CLOGFILENAME VARCHAR(1000)=''
--WITH ENCRYPTION		
AS
BEGIN	

	DECLARE @CCMD NVARCHAR(4000),
			@CDBDEVICE VARCHAR(40)
	
	SET @CDBDEVICE = @CDB + '_DATA'
	
	--*** RESTORING BACKUP OF THE CHALLAN DATABASE
	SET @CCMD = N' IF EXISTS ( SELECT NAME FROM MASTER.DBO.SYSDEVICES
				WHERE NAME = ''' + @CDBDEVICE + ''' AND STATUS = 16 ) 
				EXEC SP_DROPDEVICE ''' + @CDBDEVICE + ''''
	EXEC SP_EXECUTESQL @CCMD
	
	
	SET @CCMD = N' EXEC SP_ADDUMPDEVICE ''DISK'', ''' + @CDBDEVICE + ''', ''' + @CBACKUPFILE + ''''
	EXEC SP_EXECUTESQL @CCMD

	
	IF @CLOGFILENAME<>''
		SET @CCMD = N' RESTORE DATABASE ' + @CDB + ' FROM ' + @CDBDEVICE + ' WITH REPLACE, MOVE '''+@CDATFILENAME+''' TO '''+'C:\TEMPDB\'+@CDB+'.MDF'''+',MOVE '''+@CLOGFILENAME+''' TO '''+'C:\TEMPDB\'+@CDB+'.LDF'''	
	ELSE
		SET @CCMD = N' RESTORE DATABASE ' + @CDB + ' FROM ' + @CDBDEVICE + ' WITH REPLACE'

	EXEC SP_EXECUTESQL @CCMD

	SET @CCMD = N' IF EXISTS ( SELECT NAME FROM MASTER.DBO.SYSDEVICES
				WHERE NAME = ''' + @CDBDEVICE + ''' AND STATUS = 16 ) 
				EXEC SP_DROPDEVICE ''' + @CDBDEVICE + ''''
	EXEC SP_EXECUTESQL @CCMD

END
