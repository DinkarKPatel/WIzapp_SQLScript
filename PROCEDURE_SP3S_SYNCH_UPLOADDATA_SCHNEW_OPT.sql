CREATE PROCEDURE SP3S_SYNCH_UPLOADDATA_SCHNEW_OPT
(
	@CspId VARCHAR(50),  
    @CERRMSG VARCHAR(MAX) OUTPUT  
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
	   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
	   ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	   ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(MAX),@CMEMOID VARCHAR(50)
       ,@CLOCID VARCHAR(5),@CSOURCEDB VARCHAR(200),@CMERGEDB VARCHAR(200),@BMSTINSERTONLY BIT
	   
     DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(40))  	

    BEGIN TRY
		SET @CSTEP=20
		SET @CTABLE_SUFFIX='UPLOAD'
		BEGIN TRANSACTION

		SET @CSOURCEDB=''
	    SET @CMERGEDB=''
	    SET @BMSTINSERTONLY=0

		
		SELECT  @CMEMOID=MEMO_NO,@CLOCID=LEFT(MEMO_NO,2) 
		FROM SCHNEW_SCHEME_SETUP_MST_UPLOAD WHERE SP_ID=@CSPID

		 IF ISNULL(@CMEMOID,'')=''
		GOTO EXIT_PROC

		
		DECLARE @CMEMOIDSEARCH VARCHAR(100),@BADDMODE BIT
		SELECT TOP 1 @CMEMOIDSEARCH=A.memo_no FROM SCHEME_SETUP_MST A (NOLOCK) WHERE A.memo_no=@CMEMOID
	
		IF ISNULL(@CMEMOIDSEARCH,'')<>''
			SET @BADDMODE=0
		ELSE
			SET @BADDMODE=1

		
	    SET @CFILTERCONDITION=' B.MEMO_NO='''+@CMEMOID+''' AND B.SP_ID='''+@CSPID +''' '
	
			PRINT 'ENTER NEW SCHEME XNS MERGING-1'
			SET @CSTEP=60
			SET @CTABLENAME='SCHEME_SETUP_MST'
			SET @CTMP_TABLENAME='SCHNEW_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
			SET @CKEYFIELD='MEMO_NO'
			SET @CSTEP=80
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
									  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1
		    
			IF @BADDMODE=0
			BEGIN

				SET @DTSQL = N'DELETE A FROM SCHEME_SETUP_SLSBC A JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
							   WHERE B.'+@CKEYFIELD+' = '''+@CMEMOID+''''
				PRINT @DTSQL
				EXEC SP_EXECUTESQL @DTSQL
				SET @DTSQL = N'DELETE FROM SCHEME_SETUP_DET WHERE '+@CKEYFIELD+' = '''+@CMEMOID+''''
				PRINT @DTSQL
				EXEC SP_EXECUTESQL @DTSQL
			

			END 
			PRINT 'ENTER NEW SCHEME XNS MERGING-2'		
			
			SET @CSTEP=100
			SET @CTABLENAME='SCHEME_SETUP_DET'
			SET @CTMP_TABLENAME='SCHNEW_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
			SET @CKEYFIELD='MEMO_NO'
			
			SET @CSTEP=130
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
		

		  SET @CFILTERCONDITION=' B.SCHNEW_MEMO_ID='''+@CMEMOID+''' AND B.SP_ID='''+@CSPID +''' '
			SET @CSTEP=150
			SET @CTABLENAME='SCHEME_SETUP_SLSBC'
			SET @CTMP_TABLENAME='SCHNEW_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
			SET @CKEYFIELD='ROW_ID'
				
			SET @CSTEP=200
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 

			 
			DELETE FROM SCHNEW_SCHEME_SETUP_MST_UPLOAD WHERE SP_ID=@CSPID 	   
			DELETE FROM SCHNEW_SCHEME_SETUP_DET_UPLOAD WHERE SP_ID=@CSPID 	   
			DELETE FROM SCHNEW_SCHEME_SETUP_SLSBC_UPLOAD WHERE SP_ID=@CSPID 	   
	END TRY
	BEGIN CATCH
		SET @CERRMSG='P:SP_MERGE_MIRROR_SCHNEW_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH
	EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
	END
	ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK
END
