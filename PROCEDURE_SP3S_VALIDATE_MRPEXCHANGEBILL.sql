-- PROCEDURE TO VALIDATE MRP EXCHANGE BILL
CREATE PROCEDURE SP3S_VALIDATE_MRPEXCHANGEBILL
@NSPID VARCHAR(40)='',
@CCMID VARCHAR(40)='',
@CERRORMSG VARCHAR(500) OUTPUT
AS
BEGIN
	DECLARE @CCMMTABLE VARCHAR(300),@CCMDTABLE VARCHAR(300),@CWHERECLAUSE VARCHAR(500),@CCMD NVARCHAR(MAX),
			@NSLSMRPVAL NUMERIC(10,2),@NSLRMRPVAL NUMERIC(10,2),@BMRPEXCHANGEBILL BIT
	
	SET @CERRORMSG=''
		
	SELECT @CCMMTABLE=(CASE WHEN @NSPID='' THEN 'CMM01106' ELSE 'SLS_CMM01106_UPLOAD' END),
		   @CCMDTABLE=(CASE WHEN @NSPID='' THEN 'CMD01106' ELSE 'SLS_CMD01106_UPLOAD' END)
	
	SET @CWHERECLAUSE=(CASE WHEN @NSPID<>'' THEN 'SP_ID='''+LTRIM(RTRIM((@NSPID)))+'''' ELSE 'CM_ID='''+@CCMID+'''' END)
	
	SET @CCMD=N'SELECT @BMRPEXCHANGEBILL=ISNULL(MRP_EXCHANGE_BILL,0) FROM '+@CCMMTABLE+' (NOLOCK) WHERE '+@CWHERECLAUSE
	PRINT @CCMD
	EXEC SP_EXECUTESQL 	@CCMD,N'@BMRPEXCHANGEBILL BIT OUTPUT',@BMRPEXCHANGEBILL=@BMRPEXCHANGEBILL OUTPUT
	
	IF @BMRPEXCHANGEBILL=0
		RETURN
		
	SET @CCMD=N'IF EXISTS (SELECT TOP 1 PRODUCT_CODE FROM '+@CCMDTABLE+' (NOLOCK) WHERE '+@CWHERECLAUSE+' AND DISCOUNT_PERCENTAGE<>0)
					SET @CERRORMSG=''ITEM LEVEL DISCOUNTS SHOULD BE ZERO IN MRP EXCHANGE BILL'''
	EXEC SP_EXECUTESQL 	@CCMD,N'@CERRORMSG VARCHAR(500) OUTPUT',@CERRORMSG=@CERRORMSG OUTPUT
	
	IF ISNULL(@CERRORMSG,'')<>''
		GOTO END_PROC
		
		
	SET @CCMD=N'IF EXISTS (SELECT TOP 1 PRODUCT_CODE FROM '+@CCMDTABLE+' (NOLOCK) WHERE '+@CWHERECLAUSE+' AND TAX_METHOD=2
					AND (ISNULL(TAX_AMOUNT,0)+ISNULL(CGST_AMOUNT,0)+ISNULL(SGST_AMOUNT,0)+ISNULL(IGST_AMOUNT,0))<>0)
					SET @CERRORMSG=''TAX CALCULATION SHOULD BE INCLUSIVE IN MRP EXCHANGE BILL'''
	EXEC SP_EXECUTESQL 	@CCMD,N'@CERRORMSG VARCHAR(500) OUTPUT',@CERRORMSG=@CERRORMSG OUTPUT		 					
	
	IF ISNULL(@CERRORMSG,'')<>''
		GOTO END_PROC
		
	SET @CCMD=N'SELECT @NSLSMRPVAL=SUM(MRP*QUANTITY) FROM '+@CCMDTABLE+' (NOLOCK) WHERE '+@CWHERECLAUSE+' AND QUANTITY>0'
	EXEC SP_EXECUTESQL 	@CCMD,N'@NSLSMRPVAL NUMERIC(10,2) OUTPUT',@NSLSMRPVAL OUTPUT
		
	SET @CCMD=N'SELECT @NSLRMRPVAL=SUM(MRP*QUANTITY) FROM '+@CCMDTABLE+' WHERE '+@CWHERECLAUSE+' AND QUANTITY<0'
	EXEC SP_EXECUTESQL 	@CCMD,N'@NSLRMRPVAL NUMERIC(10,2) OUTPUT',@NSLRMRPVAL OUTPUT
	
	
	IF ISNULL(@NSLSMRPVAL,0)<ABS(ISNULL(@NSLRMRPVAL,0))
		SET @CERRORMSG='SOLD VALUE OF ITEMS SHOULD BE MORE THAN RETURN VALUE IN MRP EXCHANGE BILL'		
	
	IF ISNULL(@CERRORMSG,'')<>''
		GOTO END_PROC

END_PROC:

END
