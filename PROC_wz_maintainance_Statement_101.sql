

IF NOT EXISTS(SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_VM_NO_VM01106' AND VALUE='1')
BEGIN
	PRINT 'UPDATING ECOUPON IDS AS BLANK FOR NO DISCOUNT IN THE BILLS'
	
	UPDATE VM01106 SET VM_NO=DEPT_ID+LEFT(CONVERT(VARCHAR(40),NEWID()),8) WHERE ISNULL(VM_NO,'')='' 
	
	WHILE EXISTS(SELECT FIN_YEAR,VM_NO FROM VM01106 GROUP BY FIN_YEAR,VM_NO HAVING COUNT(*)>1)
	BEGIN
		UPDATE A SET VM_NO=DEPT_ID+LEFT(CONVERT(VARCHAR(40),NEWID()),8) 
		FROM VM01106 A
		JOIN 
		(
			SELECT FIN_YEAR,VM_NO FROM VM01106 GROUP BY FIN_YEAR,VM_NO HAVING COUNT(*)>1
		)B ON A.FIN_YEAR=B.FIN_YEAR AND A.VM_NO=B.VM_NO
	END
		
	IF NOT EXISTS(SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_VM_NO_VM01106')
	   INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
	   VALUES ('UPDATE_VM_NO_VM01106','1','',GETDATE())	
	ELSE	
		UPDATE CONFIG SET VALUE='1' WHERE CONFIG_OPTION='UPDATE_VM_NO_VM01106'	
END
