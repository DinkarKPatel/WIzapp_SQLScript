CREATE VIEW VW_TRACK_REPORT

AS

SELECT  WOM.MEMO_NO AS WORK_ORDER_NO, 
WOM.EMP_CODE,OM.AC_CODE,OM.REF_NO,OM.ORDER_NO,ISNULL(CONVERT(VARCHAR,OM.ORDER_DT ,105),'') AS ORDER_DT,
        ISNULL(CONVERT(VARCHAR,OM.TRAIL_DT ,105),'') AS TRIAL_DT ,
        ISNULL(CONVERT(VARCHAR,OM.DELIVERY_DT ,105),'') AS DELIVERY_DT,  
        LM.AC_NAME,ODA.ARTICLE_NO AS SET_NO,OD.QUANTITY,WOM.MEMO_ID AS WORK_ORDER_ID,WODA.ARTICLE_NO AS COMP_NO,  
        ISNULL(AI.K_NAME,ISNULL(AG.AGENCY_NAME,'')) AS K_NAME,ISNULL(AI.CHALLAN_NO,'') AS CHALLAN_NO,
        ISNULL(AI.DEPARTMENT ,ISNULL(E1.JOB_NAME,'')) AS DEPARTMENT,  
        ISNULL(CONVERT(VARCHAR,AI.ISSUE_DT ,105),' ') AS ISSUE_DT,
        ISNULL(CONVERT(VARCHAR,AI.RECEIVE_DT,105),' ') AS RECEIVE_DT,  
        CASE WHEN ISNULL(CONVERT(VARCHAR,PRD_JOBS.TARGET_DT,105),'')='' THEN '' 
             WHEN  ISNULL(CONVERT(VARCHAR,PRD_JOBS.TARGET_DT,105),'')='01-01-1900' THEN '' ELSE CONVERT(VARCHAR,PRD_JOBS.TARGET_DT,105) END  AS TARGET_DT,  
        ISNULL(EMP.EMP_FNAME,'')+' '+ISNULL(EMP.EMP_LNAME,'') AS ALLOCATED_TO,  
        ISNULL(CONVERT(VARCHAR,DTM.MEMO_DT,105),'') AS COMPLETION_DT  ,  
        CASE WHEN ISNULL(CONVERT(VARCHAR,DTM.MEMO_DT,105),'')<>''THEN   
             CASE WHEN DATEDIFF(DAY,OM.DELIVERY_DT,DTM.MEMO_DT) <0  THEN 0 ELSE DATEDIFF(DAY,OM.DELIVERY_DT,DTM.MEMO_DT) END   
             ELSE    
             CASE WHEN DATEDIFF(DAY,OM.DELIVERY_DT,GETDATE())<0 THEN 0 ELSE DATEDIFF(DAY,OM.DELIVERY_DT,GETDATE()) END   
             END AS NET_DELAY ,  
        CASE WHEN ISNULL(CONVERT(VARCHAR,DTM.MEMO_DT,105),'')<>''THEN   
        CASE WHEN DATEDIFF(DAY,DTM.MEMO_DT,OM.DELIVERY_DT) <0  THEN 0 ELSE DATEDIFF(DAY,DTM.MEMO_DT,OM.DELIVERY_DT) END   
             ELSE    
             CASE WHEN DATEDIFF(DAY,GETDATE(),OM.DELIVERY_DT)<0 THEN 0 ELSE DATEDIFF(DAY,GETDATE(),OM.DELIVERY_DT) END   
             END  AS DAYS_TO_GO,
       
        CASE WHEN ISNULL(CONVERT(VARCHAR,AI.TARGET_DT,105),'')='01-01-1900' OR ISNULL(CONVERT(VARCHAR,AI.TARGET_DT,105),'')=''
        THEN '' ELSE  
        CASE WHEN ISNULL(CONVERT(VARCHAR,AI.RECEIVE_DT ,105),'')<>''THEN     
             CASE WHEN DATEDIFF(DAY,AI.TARGET_DT,AI.RECEIVE_DT ) <0  THEN 0 ELSE DATEDIFF(DAY,AI.TARGET_DT,AI.RECEIVE_DT ) END     
             ELSE      
             CASE WHEN DATEDIFF(DAY,AI.TARGET_DT,GETDATE())<0 THEN 0 ELSE DATEDIFF(DAY,AI.TARGET_DT,GETDATE()) END     
             END 
             
        END AS DEPT_NET_DELAY ,     
             ISNULL(PRD_JOBS.JOB_ORDER,0) AS JOB_ORDER ,AI.ISSUE_NO ,AI.RECEIPT_NO  
  
FROM WSL_ORDER_MST OM  (NOLOCK)
JOIN WSL_ORDER_DET OD (NOLOCK) ON OD.ORDER_ID=OM.ORDER_ID  
JOIN ARTICLE ODA (NOLOCK) ON ODA.ARTICLE_CODE=OD.ARTICLE_CODE  
JOIN PRD_WO_MST WOM (NOLOCK) ON WOM.ARTICLE_SET_CODE=OD.ARTICLE_CODE AND WOM.REF_NO=OM.REF_NO  
JOIN LMV01106 LM (NOLOCK) ON LM.AC_CODE=OM.AC_CODE  
JOIN PRD_WO_DET WOD (NOLOCK) ON WOD.MEMO_ID=WOM.MEMO_ID  
JOIN ARTICLE WODA (NOLOCK) ON WODA.ARTICLE_CODE=WOD.ARTICLE_CODE  
LEFT OUTER JOIN EMP_MST EMP (NOLOCK) ON EMP.EMP_ID=WOM.EMP_CODE  
LEFT OUTER JOIN   
(  
		SELECT B.REF_PRD_WORKORDER_MEMOID,AJ.AGENCY_NAME AS K_NAME,D.AGENCY_CHALLAN_NO AS CHALLAN_NO,
		       B.REF_COMPONENT_ARTICLE_CODE ,ART.ARTICLE_NO,E.JOB_NAME AS DEPARTMENT,  
		       B.ARTICLE_CODE,	A.MEMO_DT AS ISSUE_DT,D.MEMO_DT AS RECEIVE_DT,E.JOB_CODE,A.MEMO_NO AS ISSUE_NO ,
		       D.MEMO_NO AS RECEIPT_NO ,A.DELIVERY_DT AS TARGET_DT  
		FROM PRD_AGENCY_ISSUE_MATERIAL_MST A  (NOLOCK)           
		JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID    
		LEFT OUTER JOIN  PRD_AGENCY_MATERIAL_RECEIPT_DET C (NOLOCK) ON  B.ROW_ID=C.REF_ROW_ID       
		LEFT OUTER JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID   AND D.CANCELLED =0            
		JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE              
		JOIN JOBS E (NOLOCK) ON E.JOB_CODE=B.JOB_CODE  
		JOIN PRD_AGENCY_MST AJ (NOLOCK) ON AJ.AGENCY_CODE=A.REF_AGENCY_CODE  
		WHERE A.CANCELLED=0
		
	    UNION ALL   
	    
	    
	    SELECT B.REF_PRD_WORKORDER_MEMOID,'IN HOUSE' AS K_NAME,'' AS CHALLAN_NO,
		       B.REF_COMPONENT_ARTICLE_CODE ,ART.ARTICLE_NO,DM.DEPARTMENT_NAME AS DEPARTMENT,  
		       B.ARTICLE_CODE,	A.MEMO_DT AS ISSUE_DT,D.MEMO_DT AS RECEIVE_DT,E.JOB_CODE,A.MEMO_NO AS ISSUE_NO ,
		       D.MEMO_NO AS RECEIPT_NO ,A.DELIVERY_DT AS TARGET_DT
		FROM PRD_ISSUE_MATERIAL_MST A  (NOLOCK)           
		JOIN PRD_ISSUE_MATERIAL_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID    
		LEFT OUTER JOIN  PRD_MATERIAL_RECEIPT_DET C (NOLOCK) ON  B.ROW_ID=C.REF_ROW_ID       
		LEFT OUTER JOIN PRD_MATERIAL_RECEIPT_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID  AND D.CANCELLED =0         
		JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE              
		JOIN JOBS E (NOLOCK) ON E.JOB_CODE=B.JOB_CODE  
		JOIN PRD_DEPARTMENT_MST DM ON DM.DEPARTMENT_ID=A.TARGET_DEPARTMENT_ID   
		WHERE A.CANCELLED=0
	    
	             
	  
              
       UNION ALL  
       
	  --SELECT  E.REF_WO_ID AS REF_PRD_WORKORDER_MEMOID,LM.AC_NAME AS K_NAME,PM.BILL_NO AS CHALLAN_NO,
	  --WOD.ARTICLE_CODE AS REF_COMPONENT_ARTICLE_CODE,  
	  --ART.ARTICLE_NO,'PURCHASE' AS DEPARTMENT_NAME,A.ARTICLE_CODE,  
	  --E.PS_DT AS ISSUE_DT , PM.INV_DT AS RECEIVE_DT,'0000000' AS JOB_CODE,E.PS_NO AS ISSUE_NO , 
	  --PM.MRR_NO AS  RECEIPT_NO
	  --FROM PRD_PID01106 A              
	  --JOIN PRD_PIM01106 PM ON PM.MRR_ID=A.MRR_ID         
	  --JOIN PRD_POD01106 B ON B.ROW_ID=A.PO_ROW_ID              
	  --LEFT OUTER JOIN PRD_PO_WSL C ON B.PO_ID=C.PO_ID              
	  --LEFT OUTER JOIN PRD_PS_MST E ON C.INV_ID=E.PS_ID              
	  --LEFT OUTER JOIN PRD_WO_DET WOD ON WOD.MEMO_ID=E.REF_WO_ID  
	  --LEFT OUTER JOIN ARTICLE ART ON ART.ARTICLE_CODE=WOD.ARTICLE_CODE             
	  --LEFT OUTER JOIN ARTICLE ART1 ON ART1.ARTICLE_CODE=A.ARTICLE_CODE             
	  --LEFT OUTER JOIN LMV01106 LM ON LM.AC_CODE=PM.AC_CODE  
	  
	  
	  
		SELECT  D.REF_WO_ID AS REF_PRD_WORKORDER_MEMOID,LM.AC_NAME AS K_NAME,PM.BILL_NO AS CHALLAN_NO,
		WOD.ARTICLE_CODE AS REF_COMPONENT_ARTICLE_CODE, ART.ARTICLE_NO,'EMBROIDERY' AS DEPARTMENT_NAME,
		A.ARTICLE_CODE, B.PO_DT AS ISSUE_DT, PM.RECEIPT_DT  AS RECEIVE_DT,'0100001' AS JOB_CODE,
		B.PO_NO AS ISSUE_NO,PM.MRR_NO AS RECEIPT_NO ,B.DELIVERY_DT AS TARGET_DT 
		FROM PRD_POD01106 A (NOLOCK)
		JOIN PRD_POM01106 B (NOLOCK) ON A.PO_ID = B.PO_ID  AND B.CANCELLED=0
		JOIN PRD_PO_WSL C (NOLOCK) ON B.PO_ID = C.PO_ID  
		JOIN PRD_PS_MST D (NOLOCK) ON C.INV_ID=D.PS_ID 
		LEFT OUTER JOIN PRD_WO_DET WOD (NOLOCK) ON WOD.MEMO_ID=D.REF_WO_ID  
		LEFT OUTER JOIN ARTICLE ART (NOLOCK) ON  ART.ARTICLE_CODE=WOD.ARTICLE_CODE             
		LEFT OUTER JOIN ARTICLE ART1 (NOLOCK) ON ART1.ARTICLE_CODE=A.ARTICLE_CODE             
		LEFT OUTER JOIN LMV01106 LM (NOLOCK) ON LM.AC_CODE=B.AC_CODE 
		LEFT OUTER JOIN PRD_PID01106 PD (NOLOCK) ON A.ROW_ID= PD.PO_ROW_ID 
		LEFT OUTER JOIN PRD_PIM01106  PM (NOLOCK) ON PD.MRR_ID = PM.MRR_ID   AND PM.CANCELLED =0
	  
	  
	  
	  
) AI ON AI.REF_PRD_WORKORDER_MEMOID=WOD.MEMO_ID AND WOD.ARTICLE_CODE=AI.REF_COMPONENT_ARTICLE_CODE  
LEFT OUTER JOIN PRD_STK_TRANSFER_DTM_MST DTM (NOLOCK) ON WOD.MEMO_ID=DTM.REF_WO_ID AND DTM.CANCELLED=0  
LEFT OUTER JOIN PRD_WO_ART_JOBS PRD_JOBS (NOLOCK) ON PRD_JOBS.REF_ROW_ID=WOD.ROW_ID 
JOIN JOBS E1 ON E1.JOB_CODE=PRD_JOBS.JOB_CODE  
JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE=PRD_JOBS.AGENCY_CODE
