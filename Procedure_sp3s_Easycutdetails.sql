create procedure  sp3s_Easycutdetails
(
 @cspid varchar(100)=''
)
as
begin

SELECT xn_type='Process sale', B.CM_DT , B.CM_NO ,CUSTOMER_FNAME +CUSTOMER_LNAME AS CUSTOMERNAME, 
       B.NET_AMOUNT ,SUM(A.OLD_NET +CMM_DISCOUNT_AMOUNT) AS PROCESSABLESALE,
	   a.old_mrp,a.new_mrp,
	   A.OLD_DISCOUNT_PERCENTAGE ,A.NEW_DISCOUNT_PERCENTAGE ,
	   SUM(A.OLD_DISCOUNT_AMOUNT) OLD_DISCOUNT_AMOUNT,
	   SUM(NEW_DISCOUNT_AMOUNT ) AS NEW_DISCOUNT_AMOUNT,
	   SUM(OLD_NET) AS OLD_NET,
	   SUM(NEW_NET) AS NEW_NET,
	   SUM(A.CMM_DISCOUNT_AMOUNT ) AS CMM_DISCOUNT_AMOUNT,
	   SUM(LESS_DISCOUNT) AS LESS_DISCOUNT,DISCADD

FROM CASHMEMO_ADJ_DET_UPLOAD A
JOIN CMM01106 B ON A.CM_ID =B.CM_ID 
JOIN CUSTDYM C (NOLOCK) ON B.CUSTOMER_CODE =C.CUSTOMER_CODE 
WHERE SP_ID=@cspid
GROUP BY B.CM_DT , B.CM_NO ,CUSTOMER_FNAME +CUSTOMER_LNAME, B.NET_AMOUNT , A.OLD_DISCOUNT_PERCENTAGE,A.NEW_DISCOUNT_PERCENTAGE,DISCADD ,a.old_mrp,a.new_mrp

 --select sp_id from CASHMEMO_ADJ_DET_UPLOAD



 SELECT  A1.CM_ID ,A1.CM_NO ,A1.CM_DT ,A1.NET_AMOUNT ,a1.customer_code 
 into #tmpcmm
 FROM CMM01106 A1 (NOLOCK)  
 JOIN
 (
  SELECT CM_DT FROM CASHMEMO_ADJ_DET_UPLOAD
  where SP_ID=@cspid
  GROUP BY CM_DT
 ) CMM ON A1 .CM_DT =CMM.CM_DT
 LEFT JOIN
 (
  SELECT CM_ID  FROM CASHMEMO_ADJ_DET_UPLOAD
  where SP_ID=@cspid
  GROUP BY CM_ID
 ) CMM1 ON CMM1 .CM_ID =A1.CM_ID 
 JOIN       
 (        
   SELECT A.MEMO_ID,B.PAYMODE_GRP_CODE,SUM(A.AMOUNT) AS [AMOUNT]    
   FROM PAYMODE_XN_DET A (NOLOCK)    
   JOIN PAYMODE_MST B (NOLOCK) ON B.PAYMODE_CODE=A.PAYMODE_CODE    
   JOIN PAYMODE_GRP_MST C (NOLOCK) ON C.PAYMODE_GRP_CODE=B.PAYMODE_GRP_CODE    
   WHERE C.PAYMODE_GRP_CODE='0000001' AND A.XN_TYPE='SLS'    
   GROUP BY A.MEMO_ID,B.PAYMODE_GRP_CODE    
 )X ON X.MEMO_ID=A1.CM_ID      
 WHERE   A1.NET_AMOUNT=X.AMOUNT         
 AND A1.CANCELLED=0 and CMM1.CM_ID is null     
 AND (ISNULL(A1.SUBTOTAL,0)+ISNULL(A1.SUBTOTAL_R,0))>0    AND CMM1.CM_ID IS NULL
 GROUP BY  A1.CM_ID ,A1.CM_NO ,A1.CM_DT ,A1.NET_AMOUNT ,a1.customer_code 
 

 
SELECT 'Discarded Sale' as xnType, B.CM_DT , B.CM_NO ,CUSTOMER_FNAME +CUSTOMER_LNAME AS CUSTOMERNAME, 
       B.NET_AMOUNT ,SUM(A.OLD_NET +CMM_DISCOUNT_AMOUNT) AS PROCESSABLESALE,
	   A.DISCOUNT_PERCENTAGE as old_DISCOUNT_PERCENTAGE ,A.DISCOUNT_PERCENTAGE NEW_DISCOUNT_PERCENTAGE ,
	   a.mrp old_mrp,a.mrp new_mrp,
	   SUM(A.DISCOUNT_AMOUNT) OLD_DISCOUNT_AMOUNT,
	   SUM(DISCOUNT_AMOUNT ) AS NEW_DISCOUNT_AMOUNT,
	   SUM(NET) AS OLD_NET,
	   SUM(NET) AS NEW_NET,
	   SUM(A.CMM_DISCOUNT_AMOUNT ) AS CMM_DISCOUNT_AMOUNT,
	   0 AS LESS_DISCOUNT,0 DISCADD

FROM cmd01106  A
JOIN #tmpcmm B ON A.CM_ID =B.CM_ID 
JOIN CUSTDYM C (NOLOCK) ON B.CUSTOMER_CODE =C.CUSTOMER_CODE 
GROUP BY B.CM_DT , B.CM_NO ,CUSTOMER_FNAME +CUSTOMER_LNAME, B.NET_AMOUNT , A.DISCOUNT_PERCENTAGE ,a.mrp 


end