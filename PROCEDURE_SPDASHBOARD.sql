CREATE PROCEDURE SPDASHBOARD  
(  
 @FINYEAR VARCHAR(10),  
 @PFINYEAR VARCHAR(10)  
)  
----WITH ENCRYPTION
AS  
BEGIN  
DECLARE @DIVFACTOR NUMERIC(10)  
DECLARE @CONSIDERBIN VARCHAR(10)  
DECLARE @YEAR VARCHAR(10)
SET @YEAR=LTRIM(RTRIM(@FINYEAR))

SELECT @DIVFACTOR=CONVERT(NUMERIC, ISNULL(VALUE,1)) FROM CONFIG WHERE  CONFIG_OPTION='DIV_FACTOR'  

SELECT @CONSIDERBIN=VALUE FROM CONFIG WHERE  CONFIG_OPTION='CONSIDER_BIN_SALE_TARGET'  

IF ISNULL(@DIVFACTOR,0)=0 
   SET @DIVFACTOR=1

IF ISNULL(@CONSIDERBIN,'')='' 
   SET @CONSIDERBIN=''

IF OBJECT_ID('TEMPDB..#TEMP','U') IS NOT NULL
   DROP TABLE #TEMP
   
SELECT * 
INTO #TEMP
FROM 
(  
SELECT '1' AS [ORDER], B.DEPT_ID,(B.DEPT_ID + ' ' + B.DEPT_NAME) AS DEPT_NAME,AREA_NAME,CITY,STATE,   
CASE WHEN ISNULL(DATEPART(YY,DBO.FN_GETFINYEARDATE(FIN_YEAR,2)),0)=0 THEN '' ELSE CONVERT(VARCHAR(4),DATEPART(YY,DBO.FN_GETFINYEARDATE(FIN_YEAR,2))-1)+'-'+SUBSTRING(CONVERT(VARCHAR(4),DATEPART(YY,DBO.FN_GETFINYEARDATE(FIN_YEAR,2))),3,2) END AS YEAR_NAME, 
ISNULL(CONVERT(VARCHAR, A.TARGET_MONTH),'') AS MONTH_NO,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO1, CAST(0 AS NUMERIC(14,2)) AS MONTH_NO2,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO3,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO4,  
CAST(0 AS NUMERIC(14,2)) AS MONTH_NO5,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO6,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO7,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO8,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO9,   
CAST(0 AS NUMERIC(14,2)) AS MONTH_NO10,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO11,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO12,ISNULL(TARGET_AMOUNT,0)/CONVERT(NUMERIC(10,2),@DIVFACTOR) AS SALE_TARGET,  
ISNULL(FIN_YEAR,'')AS FIN_YEAR 
FROM   
(   
  SELECT DEPT_ID,TARGET_YEAR, TARGET_MONTH, TARGET_AMOUNT, FIN_YEAR   
  FROM LOC_SALE_TARGET (NOLOCK)   
  WHERE FIN_YEAR = @FINYEAR
)A   
RIGHT OUTER JOIN   
  (   
   SELECT DEPT_ID,AREA_NAME,CITY,STATE,DEPT_NAME 
   FROM LOCATION L(NOLOCK)   
   JOIN AREA AR(NOLOCK) ON AR.AREA_CODE=L.AREA_CODE   
   JOIN CITY CT(NOLOCK) ON CT.CITY_CODE=AR.CITY_CODE   
   JOIN STATE ST(NOLOCK) ON ST.STATE_CODE=CT.STATE_CODE  
   WHERE L.INACTIVE=0
   AND 
   (
     L.DEPT_ID=L.MAJOR_DEPT_ID 
     AND L.SSPL_REG_KEY NOT IN ('E4B8C5EED283656F4599B25EE7B279349D059E09','4DC8FDD8B37A50657C9871D149638059C3743AA8','484F55C94A6347D93875A693D134C7B103BF605CA1','E090A4110EA2AA5908AAD54FD51C52FED0218F35')   
     --AND (L.DEPT_ID!=L.MAJOR_DEPT_ID)
   )
   UNION
   SELECT BIN_ID,AREA_NAME,CITY,STATE,BIN_NAME 
   FROM BIN(NOLOCK)    
   LEFT JOIN AREA AR(NOLOCK) ON AR.AREA_CODE=BIN.AREA_CODE   
   LEFT JOIN CITY CT(NOLOCK) ON CT.CITY_CODE=AR.CITY_CODE   
   LEFT JOIN STATE ST(NOLOCK) ON ST.STATE_CODE=CT.STATE_CODE 
   WHERE MBO_COUNTER =1 AND BIN.INACTIVE=0  AND  @CONSIDERBIN = '1'
   
   )B ON A.DEPT_ID = B.DEPT_ID   
  
UNION ALL  
  
SELECT '2' AS [ORDER], B.DEPT_ID,(B.DEPT_ID + ' ' + B.DEPT_NAME) AS DEPT_NAME,AREA_NAME,CITY,STATE,   
 CASE WHEN ISNULL(A.TARGET_YEAR,0)=0 THEN '' ELSE CONVERT(VARCHAR(4),A.TARGET_YEAR-1)+'-'+SUBSTRING(CONVERT(VARCHAR(4),A.TARGET_YEAR ),3,2) END AS YEAR_NAME,   
       ISNULL(CONVERT(VARCHAR, A.TARGET_MONTH),'') AS MONTH_NO,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO1, CAST(0 AS NUMERIC(14,2)) AS MONTH_NO2,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO3,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO4,  
       CAST(0 AS NUMERIC(14,2)) AS MONTH_NO5,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO6,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO7,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO8,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO9,   
       CAST(0 AS NUMERIC(14,2)) AS MONTH_NO10,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO11,CAST(0 AS NUMERIC(14,2)) AS MONTH_NO12,ISNULL(TARGET_AMOUNT,0)AS SALE_TARGET,  
        ISNULL(FIN_YEAR,'')AS FIN_YEAR   
FROM   
   (   
      SELECT DEPT_ID,TARGET_YEAR, TARGET_MONTH, TARGET_AMOUNT, FIN_YEAR   
      FROM LOC_SALE_TARGET(NOLOCK)  
      WHERE  FIN_YEAR =@PFINYEAR
   )A   
   RIGHT OUTER JOIN   
   (   
   SELECT DEPT_ID,AREA_NAME,CITY,STATE,DEPT_NAME 
   FROM LOCATION L(NOLOCK)   
   JOIN AREA AR(NOLOCK) ON AR.AREA_CODE=L.AREA_CODE   
   JOIN CITY CT(NOLOCK) ON CT.CITY_CODE=AR.CITY_CODE   
   JOIN STATE ST(NOLOCK) ON ST.STATE_CODE=CT.STATE_CODE  
   WHERE L.INACTIVE=0
   AND 
   (
     L.DEPT_ID=L.MAJOR_DEPT_ID 
     AND L.SSPL_REG_KEY NOT IN ('E4B8C5EED283656F4599B25EE7B279349D059E09','4DC8FDD8B37A50657C9871D149638059C3743AA8','484F55C94A6347D93875A693D134C7B103BF605CA1','E090A4110EA2AA5908AAD54FD51C52FED0218F35')
     --AND (L.DEPT_ID!=L.MAJOR_DEPT_ID)
   )
   UNION
   SELECT BIN_ID,AREA_NAME,CITY,STATE,BIN_NAME 
   FROM BIN(NOLOCK)    
   LEFT JOIN AREA AR(NOLOCK) ON AR.AREA_CODE=BIN.AREA_CODE   
   LEFT JOIN CITY CT(NOLOCK) ON CT.CITY_CODE=AR.CITY_CODE   
   LEFT JOIN STATE ST(NOLOCK) ON ST.STATE_CODE=CT.STATE_CODE 
   WHERE MBO_COUNTER =1 AND BIN.INACTIVE=0 AND  @CONSIDERBIN = '1'
   )B ON A.DEPT_ID = B.DEPT_ID   
)T   

IF @FINYEAR='01118'
   UPDATE #TEMP SET YEAR_NAME='2017-18'
   WHERE SALE_TARGET IN (SELECT SALE_TARGET FROM #TEMP WHERE LTRIM(RTRIM(FIN_YEAR))=LTRIM(RTRIM('01118')))
ELSE IF @FINYEAR='01119'
   UPDATE #TEMP SET YEAR_NAME='2018-19'
   WHERE SALE_TARGET IN (SELECT SALE_TARGET FROM #TEMP WHERE LTRIM(RTRIM(FIN_YEAR))=LTRIM(RTRIM('01119')))
ELSE IF @FINYEAR='01120'
   UPDATE #TEMP SET YEAR_NAME='2019-20'
   WHERE SALE_TARGET IN (SELECT SALE_TARGET FROM #TEMP WHERE LTRIM(RTRIM(FIN_YEAR))=LTRIM(RTRIM('01120')))
   
   
   UPDATE #TEMP SET YEAR_NAME='2019-20',FIN_YEAR= '01120' where isnull(YEAR_NAME,'')=''
   
SELECT * FROM #TEMP ORDER BY DEPT_ID,DEPT_NAME,YEAR_NAME,MONTH_NO DESC
END
