CREATE PROCEDURE SP_RPT_GITARS--(LocId 3 digit change by Sanjay:30-10-2024)
@DTODT DATETIME ,  
@cPlan_Name VARCHAR(100)='',
@cTargeTable VARCHAR(100)=''
AS  
BEGIN  
	 SET NOCOUNT ON
	 DECLARE @CCUTOFFDATE VARCHAR(100),@CHOLOCID VARCHAR(10),@CLOCID VARCHAR(10),@CSOURCEDEPTID VARCHAR(4)='',@CCMD VARCHAR(MAX)=''
	 ,@NDUEDAYS INT=0,@CTARGETDEPTID VARCHAR(4)
	   
	 SELECT TOP 1 @CCUTOFFDATE=VALUE FROM CONFIG WHERE CONFIG_OPTION='GIT_CUT_OFF_DATE'  
	 
	 SELECT TOP 1 @CHOLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID' 
	 SELECT TOP 1 @CLOCID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
	   
	 SET @CCUTOFFDATE=ISNULL(@CCUTOFFDATE,'')  
	 IF @CLOCID!=@CHOLOCID 
	    RETURN
	 
	 UPDATE_INDENT_TARGET:
	 SELECT TOP 1 @CTARGETDEPTID=LOC FROM #GITLOC
	 IF ISNULL(@CTARGETDEPTID,'')=''
	    BEGIN
	       RAISERROR('NO LOC FOUND TO BE UPDATED INDENT STOCK',0,1)WITH NOWAIT
	       RETURN
	    END
	 RAISERROR('CONTINUE TO UPDATE INDENT IN TEMPTABLE',0,1) WITH NOWAIT
	 
	 IF OBJECT_ID('TEMPDB..#TMPCHGIT','U') IS NOT NULL DROP TABLE #TMPCHGIT
	 IF OBJECT_ID('TEMPDB..#GIT','U') IS NOT NULL DROP TABLE #GIT
     CREATE TABLE #GIT(LOC VARCHAR(10),PRODUCT_CODE VARCHAR(1000),QTY FLOAT)		    
     
	 SELECT 'WSL' AS XN_TYPE,A.INV_ID AS MEMO_ID 
	 INTO #TMPCHGIT 
	 FROM INM01106 A (NOLOCK)   
	 LEFT OUTER JOIN PIM01106 B (NOLOCK) ON A.INV_ID=B.INV_ID AND B.CANCELLED=0 
	 WHERE A.INV_DT <= @DTODT 
		 AND A.INV_DT>=(CASE WHEN @CCUTOFFDATE<>'' THEN @CCUTOFFDATE ELSE A.INV_DT END)  
		 AND (a.location_Code=@CSOURCEDEPTID OR @CSOURCEDEPTID='')  
		 AND (A.PARTY_DEPT_ID=@CTARGETDEPTID OR @CTARGETDEPTID='')  
		 AND (ISNULL(B.RECEIPT_DT,'')='' OR ISNULL(B.RECEIPT_DT,'')>@DTODT)  
		 AND A.CANCELLED=0  AND A.INV_MODE =2
		 
	UNION  
		 
	SELECT 'PRT' AS XN_TYPE,A.RM_ID AS MEMO_ID 
	FROM RMM01106 A (NOLOCK)   
	LEFT OUTER JOIN CNM01106 B (NOLOCK) ON A.RM_ID=B.RM_ID  AND B.CANCELLED=0 
	WHERE A.RM_DT <= @DTODT 
		 AND A.RM_DT>=(CASE WHEN @CCUTOFFDATE<>'' THEN @CCUTOFFDATE ELSE A.RM_DT END)  
		 AND (a.location_Code=@CSOURCEDEPTID OR @CSOURCEDEPTID='')  
		 AND (A.PARTY_DEPT_ID=@CTARGETDEPTID OR @CTARGETDEPTID='')  
		 AND (ISNULL(B.RECEIPT_DT,'')='' OR ISNULL(B.RECEIPT_DT,'')>@DTODT)  
		 AND A.CANCELLED=0  AND A.MODE =2
		   
	
	IF EXISTS(SELECT * FROM #TMPCHGIT WHERE XN_TYPE='WSL')
	   BEGIN
	      SET @CCMD='SELECT PRODUCT_CODE,SUM(QUANTITY)QTY'+CHAR(13)+'FROM IND01106 WITH (INDEX=IND_IND01106_INVID,NOLOCK)'+CHAR(13)+'WHERE INV_ID IN ('''
	      SELECT @CCMD=COALESCE(@CCMD,'')+MEMO_ID+''',''' FROM #TMPCHGIT WHERE XN_TYPE='WSL'
	      SET @CCMD=LEFT(@CCMD,LEN(@CCMD)-2)+')'+CHAR(13)+'GROUP BY PRODUCT_CODE'
	   END
	IF EXISTS(SELECT * FROM #TMPCHGIT WHERE XN_TYPE='PRT') 
	   BEGIN
	      IF ISNULL(@CCMD,'')!='' SET @CCMD+=CHAR(13)+'UNION'+CHAR(13)
	      SET @CCMD=ISNULL(@CCMD,'')+'SELECT PRODUCT_CODE,SUM(-QUANTITY)QTY'+CHAR(13)+'FROM RMD01106 WITH (INDEX=IND_RMD01106_RMID,NOLOCK)'+CHAR(13)+'WHERE RM_ID IN ('''
	      SELECT @CCMD=COALESCE(@CCMD,'')+MEMO_ID+''',''' FROM #TMPCHGIT WHERE XN_TYPE='PRT'
	      SET @CCMD=LEFT(@CCMD,LEN(@CCMD)-2)+')'+CHAR(13)+'GROUP BY PRODUCT_CODE'
	   END
	PRINT @CCMD
	IF @CCMD<>'' 
	   SET @CCMD='INSERT #GIT(PRODUCT_CODE,QTY)'+CHAR(13)+@CCMD
	ELSE
	   SET @CCMD='INSERT #GIT(PRODUCT_CODE,QTY) SELECT '''',0'
	EXEC(@CCMD)
	UPDATE #GIT SET LOC=@CTARGETDEPTID   
	DELETE #GITLOC WHERE LOC=@CTARGETDEPTID
	IF EXISTS(SELECT TOP 1 LOC FROM #GITLOC)
	   GOTO UPDATE_INDENT_TARGET
	SELECT LOC,PRODUCT_CODE,SUM(QTY)QTY FROM #GIT GROUP BY LOC,PRODUCT_CODE  
	SET NOCOUNT ON
END