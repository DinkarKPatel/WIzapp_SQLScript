CREATE PROCEDURE SP3S_GST_TAX_CAL_OH_BATCH
(
  @CXN_TYPE VARCHAR(10)='',
  @NSPID VARCHAR(100)='',
  @BREGISTERED_DELEER INT=1,
  @CLOC_GSTN_NO VARCHAR(100)='',
  @CPARTY_GSTN_NO VARCHAR(100)='',
  @CCURSTATE_CODE VARCHAR(10)='',
  @CPARTYSTATE_CODE VARCHAR(10)='',
  @CERRMSG VARCHAR(200) OUTPUT 
)
AS
BEGIN
      
      DECLARE @FREIGHT_HSN_CODE VARCHAR(15),@OTHER_CHARGES_HSN_CODE VARCHAR(15),
              @INSURANCE_HSN_CODE VARCHAR(15),@PACKING_HSN_CODE VARCHAR(15),@CSTEP VARCHAR(10)
      
              
       BEGIN TRY 
      SET @CERRMSG=''
      SET @CSTEP='00'


      UPDATE TMP SET FREIGHT_TAXABLE_VALUE = ISNULL(FREIGHT_TAXABLE_VALUE,0),
	  OTHER_CHARGES_TAXABLE_VALUE = ISNULL(OTHER_CHARGES_TAXABLE_VALUE,0),
	  PACKING_TAXABLE_VALUE = ISNULL(PACKING_TAXABLE_VALUE,0),
	  INSURANCE_TAXABLE_VALUE = ISNULL(INSURANCE_TAXABLE_VALUE,0)
	  FROM GST_TAXINFO_CALC_OH TMP
	  WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
			      
      IF ISNULL(@BREGISTERED_DELEER,0)=1 
      BEGIN
            SET @CSTEP='20'
            
            IF ISNULL(@CERRMSG,'')<>''
            RETURN
       
              SET @CSTEP='30'
          
             --MAXIMUM OC GST PERCENTAGE PICK 
         
                
                UPDATE TMP
                SET OTHER_CHARGES_GST_PERCENTAGE=CASE  WHEN OTHER_CHARGES<>0 AND ISNULL(DO_NOT_CALC_GST_OH,0)=0 THEN  B.GST_PERCENTAGE ELSE 0 END,
                PACKING_GST_PERCENTAGE=CASE  WHEN PACKING<>0 AND ISNULL(DO_NOT_CALC_GST_OH,0)=0 THEN  B.GST_PERCENTAGE ELSE 0 END,
                INSURANCE_GST_PERCENTAGE=CASE  WHEN INSURANCE<>0 AND ISNULL(DO_NOT_CALC_GST_OH,0)=0 THEN  B.GST_PERCENTAGE ELSE 0 END,
                FREIGHT_GST_PERCENTAGE=CASE  WHEN FREIGHT<>0 AND ISNULL(DO_NOT_CALC_GST_OH,0)=0 THEN  B.GST_PERCENTAGE ELSE 0 END,
                ISIGST=CASE WHEN ISNULL(IGST_AMOUNT,0)>0 THEN 1 ELSE 0 END
                FROM GST_TAXINFO_CALC_OH TMP
                JOIN
                (
                 SELECT CM_ID,MAX(GST_PERCENTAGE) AS GST_PERCENTAGE ,
                        MAX(IGST_AMOUNT) AS IGST_AMOUNT
                 FROM CMD01106 (NOLOCK)
                 GROUP BY CM_ID
                ) B ON TMP.MEMO_ID=B.CM_ID
                WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
                
            --EXCLUSIVE TAX UPDATE
             SET @CSTEP='40'
             
             UPDATE TMP SET FREIGHT_TAXABLE_VALUE =ROUND(FREIGHT-(FREIGHT*(CASE WHEN OH_TAX_METHOD =2 THEN ((ISNULL(TMP.FREIGHT_GST_PERCENTAGE,0))/  
			 (100 + ISNULL(TMP.FREIGHT_GST_PERCENTAGE,0))) ELSE 0 END)),2),
			 
			  OTHER_CHARGES_TAXABLE_VALUE =ROUND(OTHER_CHARGES-(OTHER_CHARGES*(CASE WHEN OH_TAX_METHOD =2 THEN ((ISNULL(TMP.OTHER_CHARGES_GST_PERCENTAGE,0))/  
			 (100 + ISNULL(TMP.OTHER_CHARGES_GST_PERCENTAGE,0))) ELSE 0 END)),2),
			 
			 PACKING_TAXABLE_VALUE =ROUND(PACKING-(PACKING*(CASE WHEN OH_TAX_METHOD =2 THEN ((ISNULL(TMP.PACKING_GST_PERCENTAGE,0))/  
			 (100 + ISNULL(TMP.PACKING_GST_PERCENTAGE,0))) ELSE 0 END)),2),
			 
			  INSURANCE_TAXABLE_VALUE =ROUND(INSURANCE-(INSURANCE*(CASE WHEN OH_TAX_METHOD =2 THEN ((ISNULL(TMP.INSURANCE_GST_PERCENTAGE,0))/  
			 (100 + ISNULL(TMP.INSURANCE_GST_PERCENTAGE,0))) ELSE 0 END)),2)

			  FROM GST_TAXINFO_CALC_OH TMP
			  WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
				
			 
			    UPDATE TMP SET FREIGHT_GST_AMOUNT =
			    ROUND(
					ISNULL(FREIGHT,0)*(CASE WHEN OH_TAX_METHOD=2 THEN (TMP.FREIGHT_GST_PERCENTAGE/  
					(100 + TMP.FREIGHT_GST_PERCENTAGE)) ELSE (TMP.FREIGHT_GST_PERCENTAGE/100) END)
		        ,2 ) ,
		        
				OTHER_CHARGES_GST_AMOUNT=
				ROUND(
					ISNULL(OTHER_CHARGES,0)*(CASE WHEN OH_TAX_METHOD=2 THEN (TMP.OTHER_CHARGES_GST_PERCENTAGE/  
					(100 + TMP.OTHER_CHARGES_GST_PERCENTAGE)) ELSE (TMP.OTHER_CHARGES_GST_PERCENTAGE/100) END)
		        ,2 ),
				INSURANCE_GST_AMOUNT=
				ROUND(
					ISNULL(INSURANCE,0)*(CASE WHEN OH_TAX_METHOD=2 THEN (TMP.INSURANCE_GST_PERCENTAGE/  
					(100 + TMP.INSURANCE_GST_PERCENTAGE)) ELSE (TMP.INSURANCE_GST_PERCENTAGE/100) END)
		        ,2 ),
				PACKING_GST_AMOUNT=
				ROUND(
					ISNULL(PACKING,0)*(CASE WHEN OH_TAX_METHOD=2 THEN (TMP.PACKING_GST_PERCENTAGE/  
					(100 + TMP.PACKING_GST_PERCENTAGE)) ELSE (TMP.PACKING_GST_PERCENTAGE/100) END)
		        ,2 )
				FROM GST_TAXINFO_CALC_OH TMP
				WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
				
           
            
      
      END
      ELSE
      BEGIN
          
          UPDATE TMP SET FREIGHT_HSN_CODE='0000000000',
                         OTHER_CHARGES_HSN_CODE='0000000000',
                         INSURANCE_HSN_CODE='0000000000',
                         PACKING_HSN_CODE='0000000000',
						 FREIGHT_GST_PERCENTAGE=0 ,
						 OTHER_CHARGES_GST_PERCENTAGE=0,
						 INSURANCE_GST_PERCENTAGE=0,
						 PACKING_GST_PERCENTAGE=0,
						 ISIGST=0,
						 FREIGHT_GST_AMOUNT=0,
						 OTHER_CHARGES_GST_AMOUNT=0,
						 INSURANCE_GST_AMOUNT=0,
						 PACKING_GST_AMOUNT=0					
		  FROM GST_TAXINFO_CALC_OH TMP
		  WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) 
      
      END
  END TRY  
  BEGIN CATCH  
   SELECT @CERRMSG='ERROR MESSAGE IN PROCEDURE SP3S_GST_TAX_CAL_OH STEP#'+@CSTEP+' '+CAST(ERROR_MESSAGE() AS VARCHAR(MAX))+ '||'+ERROR_PROCEDURE()  
   PRINT 'ENTER CATCH IN SP3S_GST_TAX_CAL_OH'
  END CATCH  

END
