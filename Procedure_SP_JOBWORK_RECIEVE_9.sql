CREATE PROC [DBO].SP_JOBWORK_RECIEVE_9    
@NQUERYID INT=0,                          
@CWHERE NVARCHAR(4000)='H1001',            
@NMODE INT=1,    
@BWIP BIT=0,    
@NISSUE_MODE BIT=1,    
@cLocID VARCHAR(5)='H1',
@CSP_ID VARCHAR(50)='',
@BFILLITEMDETAILS BIT=0  ,
@CPRODUCT_CODE VARCHAR(50)='' ,
@CORDER_ID VARCHAR(50)='',
@CJOBCARD_ID VARCHAR(50)=''  
AS                          
BEGIN   
 
	 IF OBJECT_ID ('TEMPDB..#TMPBARCODE','U') IS NOT NULL
	    DROP TABLE #TMPBARCODE

		SELECT PRODUCT_CODE,job_code  into #TMPBARCODE 
		FROM JOBWORK_PMT WHERE 1=2

		declare @cjoin varchar(1000),@dtsql nvarchar(max),@cfilter varchar(1000)
		set @cjoin=''
		SET @cfilter=''

		if @CORDER_ID<>''
		begin
		    
				SET @CJOIN=' JOIN ORD_PLAN_BARCODE_DET  B  (NOLOCK) ON B.PRODUCT_CODE =A.PRODUCT_CODE 
						JOIN ORD_PLAN_DET C ON C.ROW_ID =B.REFROW_ID
						JOIN ORD_PLAN_MST D (NOLOCK)  ON C.MEMO_ID=D.MEMO_ID 
						JOIN BUYER_ORDER_DET E (NOLOCK) ON E.ROW_ID =C.WOD_ROW_ID
						JOIN BUYER_ORDER_MST F (NOLOCK) ON E.ORDER_ID =F.ORDER_ID 
						  '

				SET @CFILTER=  ' AND  D.CANCELLED=0 AND F.CANCELLED=0 AND F.ORDER_ID='''+@CORDER_ID+'''  '

		end
		if @CJOBCARD_ID<>''
		begin

			   SET @CJOIN=' JOIN ORD_PLAN_BARCODE_DET  B  (NOLOCK) ON B.PRODUCT_CODE =A.PRODUCT_CODE 
						JOIN ORD_PLAN_DET C ON C.ROW_ID =B.REFROW_ID
						JOIN ORD_PLAN_MST D (NOLOCK)  ON C.MEMO_ID=D.MEMO_ID 
						 '
				SET @CFILTER=  ' AND  D.CANCELLED=0  AND D.MEMO_ID='''+@CJOBCARD_ID+'''  '

		end


			SET @DTSQL=N' SELECT A.PRODUCT_CODE ,A.JOB_CODE
			 FROM JOBWORK_PMT A (NOLOCK) '+ @CJOIN +
			 ' WHERE A.QUANTITY_IN_STOCK =0 AND ISNULL(A.JOB_CODE,'''')<>'''' 
			 AND A.AGENCY_CODE ='''+@CWHERE+''' AND ISNULL(A.TTM,0)=0 '+ @CFILTER +'
			 GROUP BY A.PRODUCT_CODE,A.JOB_CODE '
			 PRINT @DTSQL
			 INSERT  INTO   #TMPBARCODE(PRODUCT_CODE,JOB_CODE)
			 EXEC SP_EXECUTESQL @DTSQL



	
	 
		 SELECT SKU_NAMES.ARTICLE_NO ,SKU_NAMES.PARA1_NAME ,SKU_NAMES .PARA2_NAME ,SKU_NAMES .PARA2_ORDER ,
				SKU.ARTICLE_CODE ,SKU.PARA1_CODE ,SKU.PARA2_CODE ,
				SUM(1 ) AS PENDING_QTY,
				CAST(0 AS NUMERIC(12,0)) AS REC_QTY ,
				@CWHERE as agency_code,
				CAST(newid() AS VARCHAR(50)) as row_id,A.JOB_CODE,0 as Rate,
				CAST('Pending Qty' AS VARCHAR(1000)) AS Qty_Type
		 FROM #TMPBARCODE A
		 JOIN SKU (NOLOCK) ON A.product_code =SKU .product_Code 
		 JOIN SKU_NAMES  (NOLOCK)  ON A.PRODUCT_CODE =SKU_NAMES.PRODUCT_CODE 
		 GROUP BY SKU_NAMES.ARTICLE_NO ,SKU_NAMES.PARA1_NAME ,SKU_NAMES .PARA2_NAME ,SKU_NAMES .PARA2_ORDER ,
		  SKU.ARTICLE_CODE ,SKU.PARA1_CODE ,SKU.PARA2_CODE,A.JOB_CODE
		  order by isnull(SKU_NAMES .PARA2_ORDER,0)



END



