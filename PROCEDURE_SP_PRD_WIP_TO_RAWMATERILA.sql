CREATE PROCEDURE SP_PRD_WIP_TO_RAWMATERILA
(
 @NQUERYID INT,
 @COREDR_ID VARCHAR(22)='',
 @CPRODUCT_CODE VARCHAR(100)='',
 @CMEMOID VARCHAR(22)='',
 @NNAVMODE INT=0,
 @CFINYEAR VARCHAR(5)='',
 @CWHERE   VARCHAR(100)=''
)
AS
BEGIN
   IF @NQUERYID IN(1,2,4)
   BEGIN
		
		IF OBJECT_ID('TEMPDB..#TMPWIPSTK','U') IS NOT NULL
		   DROP TABLE #TMPWIPSTK
		   
		   
		SELECT WO.MEMO_ID AS ORDER_ID, WO.MEMO_NO AS [WO_NO] , WO.REF_NO,
		       BC.ARTICLE_CODE AS COMPONENT_CODE,BC.ARTICLE_NO AS COMPONENT,
		       CC.PARA1_CODE AS COM_PARA1_CODE,CC.PARA1_NAME AS [COM COLOR],
			   DC.PARA2_CODE AS COM_PARA2_CODE,DC.PARA2_NAME AS [COM SIZE], 
			   B.ARTICLE_NO,S.PRODUCT_CODE, C.PARA1_NAME AS COLOR,D.PARA2_NAME AS SIZE, 
			   CAST(QUANTITY_IN_STOCK AS NUMERIC(10,2)) AS STOCK,
			   CAST(0 AS NUMERIC(10,2)) AS QUANTITY,
			   CAST(ISNULL(WIP,0) AS NUMERIC(10,2)) AS WIP 
			   , E.UOM_NAME AS UOM ,S.PURCHASE_PRICE AS [RATE] 
			   ,CASE WHEN ISNULL(A.WIP ,0)<>0 THEN ISNULL(A.WIP ,0)*S.
				PURCHASE_PRICE ELSE ISNULL(QUANTITY_IN_STOCK ,0)*S.PURCHASE_PRICE END  AS STOCK_VALUE,
				A.PRODUCT_UID  
	    INTO #TMPWIPSTK
		FROM PRD_PMT A (NOLOCK) 
		JOIN PRD_SKU S ON A.PRODUCT_UID= S.PRODUCT_UID 
		LEFT OUTER JOIN PRD_WO_MST WO(NOLOCK) ON WO.MEMO_ID=S.WORK_ORDER_ID AND MARK_AS_COMPLETED=1
		JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE= B.ARTICLE_CODE  
		JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE  
		JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE 
		LEFT OUTER JOIN ARTICLE BC (NOLOCK) ON S.COMPONENT_CODE= BC.ARTICLE_CODE  
		LEFT OUTER JOIN PARA1 CC (NOLOCK) ON S.COM_PARA1_CODE = CC.PARA1_CODE  
		LEFT OUTER JOIN PARA2 DC (NOLOCK) ON S.COM_PARA2_CODE = DC.PARA2_CODE 
		JOIN UOM E ON B.UOM_CODE= E.UOM_CODE  
		WHERE  DEPARTMENT_ID= 'DEF0001' AND (QUANTITY_IN_STOCK > 0) 
		AND ISNULL(WO.MEMO_NO ,'')<>''  
		AND (@COREDR_ID='' OR WO.MEMO_ID=@COREDR_ID)
		AND (@CPRODUCT_CODE='' OR S.PRODUCT_CODE =@CPRODUCT_CODE)
		ORDER BY WO.MEMO_NO,BC.ARTICLE_NO,B.ARTICLE_NO,C.PARA1_NAME,D.PARA2_NAME
     
     
     
     END
     
   
   IF @NQUERYID=1
      GOTO LBLORDER
   ELSE IF @NQUERYID=2
      GOTO LBLBARCODE
   ELSE IF @NQUERYID=3
      GOTO LBLMST
   ELSE IF @NQUERYID=4
      GOTO LBLDET
   ELSE IF @NQUERYID=6
       GOTO LBLNAVIGATE
   ELSE IF @NQUERYID=7
       GOTO LBSOURCEDEPARTMENT
   ELSE IF @NQUERYID=8
       GOTO LBTARGETDEPARTMENT
   ELSE
      GOTO END_PROC
   

     LBLORDER:
         
         SELECT ORDER_ID ,WO_NO AS ORDER_NO
         FROM #TMPWIPSTK
         GROUP BY ORDER_ID ,WO_NO
         ORDER BY ORDER_ID ,WO_NO
         
     GOTO END_PROC
     
     LBLBARCODE:
          
         SELECT A.PRODUCT_CODE 
         FROM #TMPWIPSTK A
         WHERE  (@COREDR_ID='' OR A.ORDER_ID =@COREDR_ID)
		 AND (@CPRODUCT_CODE='' OR A.PRODUCT_CODE =@CPRODUCT_CODE)
         GROUP BY PRODUCT_CODE
         ORDER BY PRODUCT_CODE
         
     
     GOTO END_PROC
     
     LBLMST:
       
       SELECT A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.LAST_UPDATE,
              A.SOURCE_DEPARTMENT_ID,B.DEPARTMENT_NAME AS SOURCE_DEPARTMENT_NAME,
              A.TARGET_DEPARTMENT_ID,C.DEPARTMENT_NAME AS TARGET_DEPARTMENT_NAME,
              A.DEPT_ID,A.FIN_YEAR,A.CANCELLED ,ORD.ORDER_NO,ORD.ORDER_ID,ORD.REMARKS
             
        FROM PRD_STK_RECEIVE_MST A
        JOIN
        (
          SELECT DISTINCT A.MEMO_ID, B.MEMO_NO AS ORDER_NO,A.REF_WO_ID AS ORDER_ID,C.REMARKS
          FROM PRD_STK_RECEIVE_DET A
          JOIN PRD_WO_MST B ON A.REF_WO_ID=B.MEMO_ID 
          JOIN PRD_STK_RECEIVE_MST C ON C.MEMO_ID=A.MEMO_ID
        ) ORD ON A.MEMO_ID=ORD.MEMO_ID
        JOIN PRD_DEPARTMENT_MST B ON A.SOURCE_DEPARTMENT_ID=B.DEPARTMENT_ID 
        JOIN PRD_DEPARTMENT_MST C ON A.TARGET_DEPARTMENT_ID=C.DEPARTMENT_ID 
        WHERE A.MEMO_ID=@CMEMOID
     
     GOTO END_PROC
     
     LBLDET:
        
        IF @CMEMOID =''
        BEGIN
        SELECT CAST(0 AS BIT) AS CHK,
               CAST('LATER' AS VARCHAR(22)) AS MEMO_ID, 
		       GETDATE () AS LAST_UPDATE,
		       CAST('LATER' AS VARCHAR(22)) AS ROW_ID, 
               A.PRODUCT_CODE ,
               A.PRODUCT_UID ,
               A.STOCK ,
               A.QUANTITY ,
               CAST('LATER' AS VARCHAR(22)) AS NEW_PRODUCT_UID, 
               A.COMPONENT_CODE,A.COMPONENT ,
               A.COM_PARA1_CODE,A.[COM COLOR] ,
	           A.COM_PARA2_CODE,A.[COM SIZE] ,
	           A.ORDER_ID AS REF_WO_ID,
	           A.WO_NO ,A.ARTICLE_NO ,
	           A.UOM 
          FROM #TMPWIPSTK A
          WHERE  A.ORDER_ID =@COREDR_ID
		  AND (@CPRODUCT_CODE='' OR A.PRODUCT_CODE =@CPRODUCT_CODE)
        END
        ELSE
        BEGIN
            
             SELECT CAST(1 AS BIT) AS CHK,
               A.MEMO_ID,A.LAST_UPDATE,
		       A.ROW_ID, 
               A.PRODUCT_CODE ,
               A.PRODUCT_UID ,
               PMT.QUANTITY_IN_STOCK AS STOCK ,
               A.QUANTITY ,
               A.NEW_PRODUCT_UID, 
               A.COMPONENT_CODE,ART.ARTICLE_NO AS  COMPONENT ,
               A.COM_PARA1_CODE,P1.PARA1_NAME AS [COM COLOR] ,
	           A.COM_PARA2_CODE,P2.PARA2_NAME AS [COM SIZE] ,
	           A.REF_WO_ID AS REF_WO_ID,
	           MST.MEMO_NO AS WO_NO ,ART.ARTICLE_NO ,
	           UOM.UOM_NAME AS UOM
        FROM PRD_STK_RECEIVE_DET A
        JOIN PRD_STK_RECEIVE_MST B ON A.MEMO_ID=B.MEMO_ID
        JOIN PRD_SKU SKU ON SKU.PRODUCT_UID=A.PRODUCT_UID
        JOIN PRD_PMT PMT ON PMT.PRODUCT_UID=SKU.PRODUCT_UID
        JOIN PRD_WO_MST MST ON MST.MEMO_ID=A.REF_WO_ID
        JOIN ARTICLE ART ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE
        JOIN ARTICLE ART1 ON ART1.ARTICLE_CODE=A.COMPONENT_CODE
        JOIN PARA1 P1 ON P1.PARA1_CODE=A.COM_PARA1_CODE
        JOIN PARA2 P2 ON P2.PARA2_CODE=A.COM_PARA2_CODE
        JOIN UOM ON UOM.UOM_CODE=ART1.UOM_CODE
        WHERE B.MEMO_ID=@CMEMOID
        
        
        END
     
     
     GOTO END_PROC
     
 
     
     LBLNAVIGATE:
         
          EXECUTE SP_NAVIGATE 'PRD_STK_RECEIVE_MST',@NNAVMODE,@CMEMOID,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERE  
	 
	     GOTO END_PROC
     
      GOTO END_PROC
      
      LBSOURCEDEPARTMENT:
           
           SELECT DEPARTMENT_ID,DEPARTMENT_NAME 
           FROM PRD_DEPARTMENT_MST 
           WHERE DEPARTMENT_ID='DEF0001'
           
      GOTO END_PROC
      LBTARGETDEPARTMENT:
           
           SELECT DEPARTMENT_ID,DEPARTMENT_NAME 
           FROM PRD_DEPARTMENT_MST 
           WHERE DEPARTMENT_ID<>'DEF0001'
           AND INACTIVE=0
           ORDER BY DEPARTMENT_NAME
           
      GOTO END_PROC

END_PROC:

END
