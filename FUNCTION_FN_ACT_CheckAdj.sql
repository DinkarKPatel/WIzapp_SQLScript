CREATE FUNCTION FN_ACT_CHECKADJ
(
	@CVDNID VARCHAR(20)
)
RETURNS BIT
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @NAMOUNT NUMERIC(14,2), 
			@NPOSADJ NUMERIC(14,2), 
			@NNEGADJ NUMERIC(14,2), 
			@CXTYPE  VARCHAR(2), 
			@LRETVAL BIT

	SELECT @NAMOUNT = INV_AMT, @CXTYPE = NX_TYPE FROM VDN01106 WHERE VDN_ID = @CVDNID

	SELECT	@NPOSADJ = SUM( CASE WHEN A.X_TYPE = @CXTYPE THEN A.AMOUNT ELSE 0 END ), 
			@NNEGADJ = SUM( CASE WHEN A.X_TYPE <> @CXTYPE THEN A.AMOUNT ELSE 0 END )
	FROM VDA01106 A
	JOIN VD01106 B ON A.VD_ID = B.VD_ID
	JOIN VM01106 C ON B.VM_ID = C.VM_ID
	WHERE C.CANCELLED = 0
	AND A.VDN_ID = @CVDNID

	IF (@NAMOUNT + @NPOSADJ - @NNEGADJ) < 0
		SET @LRETVAL = 0
	ELSE
		SET @LRETVAL = 1

	RETURN @LRETVAL
END
