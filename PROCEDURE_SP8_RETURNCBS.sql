CREATE PROCEDURE SP8_RETURNCBS
(
	 @CTABLENAME VARCHAR(100)
	,@BARTICLE BIT=0 /*IF ARTICLE NEEDS TO BE INCLUDED IN THE CLOSING STOCK*/
	,@BPARA1 BIT=0 /*IF PARA1 NEEDS TO BE INCLUDED IN THE CLOSING STOCK*/
	,@BPARA2 BIT=0 /*IF PARA2 NEEDS TO BE INCLUDED IN THE CLOSING STOCK*/
	,@DCBS_DATE DATETIME
)
AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@CSELECT_COLS VARCHAR(MAX),@CSELECT_DIS_COLS VARCHAR(MAX),@CGROUP_COLS VARCHAR(MAX),@CJOINSTR VARCHAR(MAX)
		   ,@CDEPT_ID VARCHAR(2),@COUTJOINSTR VARCHAR(MAX),@CSTEP VARCHAR(10),@CERRMSG VARCHAR(500)
		   ,@CSPID VARCHAR(10),@CPARA_TABLE VARCHAR(50)
BEGIN TRY	
	SET @CSTEP=10
	SELECT TOP 1 @CDEPT_ID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	SET @CSPID=RTRIM(LTRIM(STR(@@SPID)))
	SET @CPARA_TABLE='TEMP_CBS_'+@CSPID
	SET @CCMD=N'IF OBJECT_ID('''+@CPARA_TABLE+''',''U'') IS NOT NULL
					DROP TABLE '+@CPARA_TABLE
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
			
	SET @CSTEP=20
	SET @CSELECT_COLS=''
	SET @CGROUP_COLS=''
	SET @CJOINSTR=''
	SET @COUTJOINSTR=''
	SET @CERRMSG=''
	
	SET @CSTEP=30
	IF @BARTICLE=1
	BEGIN
		SET @CSELECT_COLS=' TMP.ARTICLE_CODE'
		SET @CGROUP_COLS=' TMP.ARTICLE_CODE'
		SET @CJOINSTR=' TMP.ARTICLE_CODE=SKU.ARTICLE_CODE'
		SET @COUTJOINSTR=' A.ARTICLE_CODE=B.ARTICLE_CODE'
	END	
	
	SET @CSTEP=40
	IF @BPARA1=1
	BEGIN
		SET @CSELECT_COLS=@CSELECT_COLS+(CASE WHEN @CSELECT_COLS='' THEN ' TMP.PARA1_CODE' ELSE ',TMP.PARA1_CODE' END)
		SET @CGROUP_COLS=@CGROUP_COLS+(CASE WHEN @CGROUP_COLS='' THEN ' TMP.PARA1_CODE' ELSE ',TMP.PARA1_CODE' END)
		SET @CJOINSTR=@CJOINSTR+(CASE WHEN @CJOINSTR='' THEN ' TMP.PARA1_CODE=SKU.PARA1_CODE' ELSE ' AND TMP.PARA1_CODE=SKU.PARA1_CODE' END)
		SET @COUTJOINSTR=@COUTJOINSTR+(CASE WHEN @COUTJOINSTR='' THEN ' A.PARA1_CODE=B.PARA1_CODE' ELSE ' AND A.PARA1_CODE=B.PARA1_CODE' END)
	END
	
	SET @CSTEP=50
	IF @BPARA2=1
	BEGIN
		SET @CSELECT_COLS=@CSELECT_COLS+(CASE WHEN @CSELECT_COLS='' THEN ' TMP.PARA2_CODE' ELSE ',TMP.PARA2_CODE' END)
		SET @CGROUP_COLS=@CGROUP_COLS+(CASE WHEN @CGROUP_COLS='' THEN ' TMP.PARA2_CODE' ELSE ',TMP.PARA2_CODE' END)
		SET @CJOINSTR=@CJOINSTR+(CASE WHEN @CJOINSTR='' THEN ' TMP.PARA2_CODE=SKU.PARA2_CODE' ELSE ' AND TMP.PARA2_CODE=SKU.PARA2_CODE' END)
		SET @COUTJOINSTR=@COUTJOINSTR+(CASE WHEN @COUTJOINSTR='' THEN ' A.PARA2_CODE=B.PARA2_CODE' ELSE ' AND A.PARA2_CODE=B.PARA2_CODE' END)
	END
	
	SET @CCMD=N' SELECT DISTINCT '+@CSELECT_COLS+' INTO '+@CPARA_TABLE+' FROM '+@CTABLENAME+' TMP'
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
		
	SET @CSTEP=60	
	SET @CSELECT_COLS=' SELECT '+@CSELECT_COLS
	SET @CGROUP_COLS=' GROUP BY '+@CGROUP_COLS
	SET @CJOINSTR=' ON '+@CJOINSTR
	SET @COUTJOINSTR=' ON '+@COUTJOINSTR
	--SELECT @CSELECT_COLS,@CGROUP_COLS,@CJOINSTR

	SET @CSTEP=70	
	SET @CCMD=N' UPDATE A SET WSLCBS=B.CBS 
				FROM '+@CTABLENAME+' A JOIN ('+@CSELECT_COLS
				+',SUM((CASE WHEN XN_TYPE IN (''WPR'',''SCF'',''OPS'',''PRD'', ''PUR'', ''CHI'', ''SLR'',''UNC'',''APR'', ''WSR'', ''PFI'',
						''PFG'', ''BCG'',''MRP'',''DCI'',''PSB'',''JWR'') AND ARTICLE.STOCK_NA=0 THEN XN_QTY
						WHEN XN_TYPE IN (''SCC'',''BOC'',''PRT'',''CHO'',''SLS'',''CNC'',''APP'',''WSL'',
						''CIP'', ''CRM'', ''DCO'',''MIP'',''CSB'',''JWI'',''DLM'',''WPI'') AND ARTICLE.STOCK_NA=0 THEN -XN_QTY 
						ELSE 0 END)) AS CBS
				FROM '+@CPARA_TABLE+' TMP 
				JOIN SKU '+@CJOINSTR+' 
				JOIN ARTICLE ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
				JOIN PARA1 ON SKU.PARA1_CODE=PARA1.PARA1_CODE
				JOIN PARA2 ON SKU.PARA2_CODE=PARA2.PARA2_CODE
				JOIN VW_XNSREPS RF ON SKU.PRODUCT_CODE=RF.PRODUCT_CODE 
				WHERE RF.DEPT_ID='''+@CDEPT_ID+''' 
				AND RF.XN_DT<='''+CONVERT(VARCHAR,@DCBS_DATE,110)+''''+@CGROUP_COLS+') B '+@COUTJOINSTR
				
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
	--SELECT * FROM RF01106
	
	SET @CCMD=N'IF OBJECT_ID('''+@CPARA_TABLE+''',''U'') IS NOT NULL
					DROP TABLE '+@CPARA_TABLE
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
	
END TRY
BEGIN CATCH
		SET @CERRMSG='@ STEP - '+@CSTEP+', MESSAGE - '+ERROR_MESSAGE()
END CATCH	
	SET @CCMD=N' SELECT *,'''+@CERRMSG+''' AS ERRMSG FROM '+@CTABLENAME
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
END
