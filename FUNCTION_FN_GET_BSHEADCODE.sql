  
CREATE FUNCTION FN_GET_BSHEADCODE ( @CHEADCODE CHAR(10) )  
RETURNS CHAR(10)  
--WITH ENCRYPTION  
AS   
BEGIN  
 DECLARE @CRETVAL VARCHAR(MAX),@CTEMPHEADCODE VARCHAR(10)  
   
 SET @CRETVAL = ''  
  
 DECLARE ABC CURSOR FOR   
 SELECT A.MAJOR_HEAD_CODE FROM HD01106 A (NOLOCK)    
 JOIN HD01106 B ON A.MAJOR_HEAD_CODE=B.HEAD_CODE  
 WHERE A.HEAD_CODE = @CHEADCODE AND B.MAJOR_HEAD_CODE<>B.HEAD_CODE  
  
  
 OPEN ABC  
 FETCH NEXT FROM ABC INTO @CTEMPHEADCODE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  SET @CRETVAL = DBO.FN_GET_BSHEADCODE( @CTEMPHEADCODE )  
    
  IF @CRETVAL=''  
  BEGIN  
   SET @CRETVAL=@CTEMPHEADCODE  
   BREAK  
  END   
  FETCH NEXT FROM ABC INTO @CTEMPHEADCODE  
 END  
 CLOSE ABC  
 DEALLOCATE ABC  
   
 IF @CRETVAL=''  
  SELECT @CRETVAL=@CHEADCODE  
    
 RETURN @CRETVAL  
END  