CREATE PROCEDURE SP_MERGE_MIRRORDATA
@CLOCID VARCHAR(5),
@CXNTYPE VARCHAR(20),
@CXNID VARCHAR(50),
@BENFORCEBATCHMODEMERGING BIT=0
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CMERGEDB VARCHAR(200),@CMERGEDBNAME VARCHAR(200),@CCMD NVARCHAR(MAX),@CRUN VARCHAR(2),@CERRMSG VARCHAR(MAX),
			@CSOURCEDB VARCHAR(200),@CPRIMARYDBEXETIME DATETIME,@CMIRRORDBEXETIME DATETIME,@BCHKLIST BIT,
			@CXNINFOTABLE VARCHAR(200),@CMIRRORINGENABLED VARCHAR(1),@BMSTINSERTONLY BIT,@CTEMPXNSTABLELIST VARCHAR(100),
			@CCURLOCID VARCHAR(5),@CHOLOCID VARCHAR(5),@CENFORCEBATCHMODEMERGING VARCHAR(2)


	SELECT TOP 1 @CCURLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'	
	SELECT TOP 1 @CHOLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'	
	
	
	---- ONLY CUSTOMER DATA IS ALLOWED TO BE MERGED AT LOCATION
	IF @CCURLOCID<>@CHOLOCID AND @CXNTYPE<>'CUS'
	BEGIN
		SET @CERRMSG='TRANSACTION MERGING CAN ONLY BE DONE AT HEAD OFFICE....'
		GOTO EXIT_PROC
	END 
	
	IF @BENFORCEBATCHMODEMERGING=0
	BEGIN
		SELECT TOP 1 @CENFORCEBATCHMODEMERGING=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENFORCE_BATCH_MODE_MERGING'
	
		
		IF ISNULL(@CENFORCEBATCHMODEMERGING,'')='1'
		BEGIN
			SET @CENFORCEBATCHMODEMERGING = ''
			
			SELECT TOP 1 @CENFORCEBATCHMODEMERGING=ENFORCE_BATCH_MODE_MERGING FROM LOC_MERGING_MODE
			WHERE DEPT_ID=@CLOCID
			
			SET @CENFORCEBATCHMODEMERGING = ISNULL(@CENFORCEBATCHMODEMERGING,'')
		END
	END
	ELSE
		SET @CENFORCEBATCHMODEMERGING='1'
				
	SET @CMERGEDBNAME=DB_NAME()
	SET @BMSTINSERTONLY=1
		
	SET @CMERGEDB = @CMERGEDBNAME+'.DBO.'
	
	SET @CSOURCEDB = DB_NAME()+'_TEMP.DBO.'
	
	SET @CERRMSG=''	
	SET @BCHKLIST = 0
	SET @CTEMPXNSTABLELIST = @CSOURCEDB+'TMP_'+@CXNTYPE+'_XNSTABLELIST_'+LTRIM(RTRIM(REPLACE(@CXNID,'-','_')))
	SET @CCMD = N'IF OBJECT_ID('''+@CTEMPXNSTABLELIST+''',''U'') IS NOT NULL
					SET @BCHKLIST = 1
				  ELSE 
				  	SET @BCHKLIST = 0'
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD,N'@BCHKLIST BIT OUTPUT',@BCHKLIST OUTPUT
	IF (@BCHKLIST = 1)
	BEGIN			  	
		EXEC SP_CHK_TABLELIST @CSOURCEDB,@CMERGEDB,@CXNTYPE,@CXNID,@CERRMSG OUTPUT
	END
	IF ISNULL(@CERRMSG,'') <> ''
	BEGIN
		GOTO EXIT_PROC
	END
	
	IF NOT EXISTS(SELECT TOP 1 'U' FROM SYS.DATABASES WHERE NAME=@CMERGEDBNAME)
	BEGIN
		SET @CERRMSG='P:SP_MERGE_MIRROR_DATA, MESSAGE: MIRROR DATABASE FOR DEPT_ID : '+LTRIM(RTRIM(@CLOCID))+' DOESNT EXISTS.'
		GOTO EXIT_PROC
	END
	
	SET @CCMD=N'SELECT @CRUN=VALUE FROM '+@CMERGEDB+'CONFIG WHERE CONFIG_OPTION=''DATA_SYNCH_RUNNING_'+@CLOCID+''''
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD,N'@CRUN VARCHAR(1) OUTPUT',@CRUN OUTPUT
	
	IF @CRUN='1'
	BEGIN
		SET @CERRMSG='RETRY'
		GOTO EXIT_PROC
	END
			
	EXEC SP3S_CHKTABLES_MIRRORDATA
	@CXNTYPE=@CXNTYPE,
	@CMEMOID=@CXNID,
	@CLOCID=@CLOCID,
	@CSOURCEDB=@CSOURCEDB,
	@CERRORMSG=@CERRMSG OUTPUT
	
	IF ISNULL(@CERRMSG,'')<>''
		GOTO EXIT_PROC
	
		
	PRINT 'START OF SP3S_CHECK_PARENTDATA'

	IF ISNULL(@CMIRRORINGENABLED,'')='1'
		EXEC SP3S_CHECK_PARENTDATA
		@CXNTYPE=@CXNTYPE,
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID,
		@CSOURCEDB=@CSOURCEDB,
		@CERRORMSG=@CERRMSG OUTPUT
	
	IF ISNULL(@CERRMSG,'')<>''
		GOTO EXIT_PROC
		
	PRINT 'END OF SP3S_CHECK_PARENTDATA'


		
	IF @CXNTYPE='SLS'
	BEGIN
		IF  ISNULL(@CENFORCEBATCHMODEMERGING,'')='1'
			EXEC SP_MERGE_MIRROR_SLS_TEMPBATCH_DATA
			@CMEMOID=@CXNID,
			@CSOURCEDB=@CSOURCEDB,
			@CMERGEDB=@CMERGEDB,			
		    @CERRMSG=@CERRMSG OUTPUT
   		ELSE
		BEGIN	
			EXEC SP_MERGE_MIRROR_SLS_DATA 
			@CMEMOID=@CXNID,
			@CLOCID=@CLOCID ,
			@CSOURCEDB=@CSOURCEDB,
			@CMERGEDB=@CMERGEDB,
			@BMSTINSERTONLY=@BMSTINSERTONLY,
			@CERRMSG=@CERRMSG OUTPUT
		
			IF ISNULL(@CERRMSG,'')=''
				EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'CMM01106'
		END	
	END	
	ELSE
	IF @CXNTYPE='PUR'
	BEGIN
		EXEC SP_MERGE_MIRROR_PUR_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
		
		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'PIM01106'
	END	
	ELSE
	IF @CXNTYPE='WSR'
	BEGIN
		
		EXEC SP_MERGE_MIRROR_WSR_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'CNM01106'		
	END	
	ELSE
	IF @CXNTYPE='WPS'
	BEGIN
	
		EXEC SP_MERGE_MIRROR_WPS_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT 	

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'WPS_MST'		
	END	
	ELSE
	IF @CXNTYPE='WSL'
	BEGIN
		EXEC SP_MERGE_MIRROR_WSL_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT 	

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'INM01106'				
	END	
	ELSE
	IF @CXNTYPE='PRT'
	BEGIN
		EXEC SP_MERGE_MIRROR_PRT_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT		

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'RMM01106'						
	END	
	ELSE
	IF @CXNTYPE='PO'
		EXEC SP_MERGE_MIRROR_PO_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT

	ELSE
	IF @CXNTYPE='APP'
	BEGIN
		EXEC SP_MERGE_MIRROR_APP_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'APM01106'						
	END	
	ELSE
	IF @CXNTYPE='POADJ'
	BEGIN
		EXEC SP_MERGE_MIRROR_POADJ_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT

						
	END	
	ELSE
	IF @CXNTYPE='APR'
	BEGIN
		EXEC SP_MERGE_MIRROR_APR_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT	

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'APPROVAL_RETURN_MST'						
	END	
	ELSE
	IF @CXNTYPE='ARC'
		EXEC SP_MERGE_MIRROR_ARC_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT					
	ELSE
	IF @CXNTYPE='RPS'
	BEGIN
		EXEC SP_MERGE_MIRROR_RPS_DATA 
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT			

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'RPS_MST'								
	END	
	ELSE
	IF @CXNTYPE='WSLORD'
		EXEC SP_MERGE_MIRROR_WSLORD_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT			
	ELSE
	IF @CXNTYPE='IRR'
	BEGIN
		EXEC SP_MERGE_MIRROR_IRR_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'IRM01106'										
	END	
	ELSE
	IF @CXNTYPE='CNC'
	BEGIN
		EXEC SP_MERGE_MIRROR_CNC_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT		

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'ICM01106'												
	END	
	ELSE
	IF @CXNTYPE='SCF'
	BEGIN		
		EXEC SP_MERGE_MIRROR_SCF_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'SCM01106'											
	END	
	ELSE
	IF @CXNTYPE='ACT'
		EXEC SP_MERGE_MIRROR_ACT_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='ATD'
		EXEC SP_MERGE_MIRROR_ATD_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='PBG'
		EXEC SP_MERGE_MIRROR_PBG_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT					
	ELSE
	IF @CXNTYPE='DNPS'
	BEGIN
		EXEC SP_MERGE_MIRROR_DNPS_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT					

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'DNPS_MST'												
	END	
	ELSE
	IF @CXNTYPE='CNPS'
	BEGIN
		EXEC SP_MERGE_MIRROR_CNPS_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT					

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'CNPS_MST'												
	END	
	
	ELSE
	IF @CXNTYPE='PTC'
		EXEC SP_MERGE_MIRROR_PTC_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT		
	ELSE
	IF @CXNTYPE='BCO'
	BEGIN
		EXEC SP_MERGE_MIRROR_BCO_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'FLOOR_ST_MST'														
	END	
	ELSE
	IF @CXNTYPE='OPS'
	BEGIN
		EXEC SP_MERGE_MIRROR_OPS_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'OPS01106'																
	END	
	ELSE
	IF @CXNTYPE='SCH'
		EXEC SP_MERGE_MIRROR_SCH_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='SCHNEW'
		EXEC SP_MERGE_MIRROR_SCHNEW_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT		
	ELSE	
	IF @CXNTYPE='DEND'
		EXEC SP_MERGE_MIRROR_DEND_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT							
	ELSE	
	IF @CXNTYPE='DOCPOADJ'
		EXEC SP_MERGE_MIRROR_DOCPOADJ_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT			
	ELSE	
	IF @CXNTYPE='SNC'
	BEGIN
		EXEC SP_MERGE_MIRROR_SNC_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT

		IF ISNULL(@CERRMSG,'')=''
			EXEC SP3S_MARKXNLOG_FOR_BUILDRFOPT 'SNC_MST'		
	END	
	ELSE
	IF @CXNTYPE='CUS'
		EXEC SP_MERGE_MIRROR_CUS_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='BIN_MST'
		EXEC SP_MERGE_MIRROR_BIN_MST_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT	
	ELSE
	IF @CXNTYPE='STREC'
		EXEC SP_MERGE_MIRROR_STREC_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	
	ELSE
	IF @CXNTYPE='PSJWI'
		EXEC SP_MERGE_MIRROR_PSJWI_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT	
	ELSE
	IF @CXNTYPE='PSJWR'
		EXEC SP_MERGE_MIRROR_PSJWR_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='PSDLV'
		EXEC SP_MERGE_MIRROR_PSDLV_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='PSHBD'
		EXEC SP_MERGE_MIRROR_PSHBD_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,	
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='PCI'
		EXEC SP_MERGE_MIRROR_PCI_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,	
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='PCO'
		EXEC SP_MERGE_MIRROR_PCO_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,	
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT															
	ELSE
	IF @CXNTYPE='DSM'
		EXEC SP_MERGE_MIRROR_DSM_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,	
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT														
	ELSE
	IF @CXNTYPE='PRCL'
		EXEC SP_MERGE_MIRROR_PRCL_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,	
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='WPL'
		EXEC SP_MERGE_MIRROR_WPL_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,	
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='WBO'
		EXEC SP_MERGE_MIRROR_WBO_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,	
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT							
	ELSE
	IF @CXNTYPE='XNSEMP'
		EXEC SP_MERGE_MIRROR_XNSEMP_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,	
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='XNSDTM'
		EXEC SP_MERGE_MIRROR_XNSDTM_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,	
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='XNSLM'
		EXEC SP_MERGE_MIRROR_XNSLM_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,	
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
 ELSE
	IF @CXNTYPE='TLF'
		EXEC SP_MERGE_MIRROR_TLF_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
	IF @CXNTYPE='SHF'
		EXEC SP_MERGE_MIRROR_SHF_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
    IF @CXNTYPE='BKT'
		EXEC SP_MERGE_MIRROR_BKT_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT	
	ELSE
    IF @CXNTYPE='TEX'
		EXEC SP_MERGE_MIRROR_TEX_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT
	ELSE
    IF @CXNTYPE='PTCAPP'
		EXEC SP_MERGE_MIRROR_PTCAPP_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT		
													
EXIT_PROC:
	
	DELETE FROM MIRROR_MERGE_LOG WITH (ROWLOCK) WHERE MEMO_ID=@CXNID AND XN_TYPE=@CXNTYPE
	
	IF ISNULL(@CERRMSG,'')<>''
		INSERT MIRROR_MERGE_LOG (MEMO_ID,ERRMSG,LAST_UPDATE,XN_TYPE)
		SELECT @CXNID AS MEMO_ID,ISNULL(@CERRMSG,'') AS ERRMSG,GETDATE() AS LAST_UPDATE,@CXNTYPE AS XN_TYPE
		
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
		INSERT MIRROR_MERGE_SUCCESS_LOG (MEMO_ID,LAST_UPDATE,XN_TYPE)
		SELECT @CXNID AS MEMO_ID,GETDATE() AS LAST_UPDATE,@CXNTYPE AS XN_TYPE
		
		SET @CERRMSG='SUCCESS'
	END	
	
	SELECT ISNULL(@CERRMSG,'') AS ERRMSG
END
----- 'END OF CREATING PROCEDURE SP_MERGE_MIRRORDATA'
