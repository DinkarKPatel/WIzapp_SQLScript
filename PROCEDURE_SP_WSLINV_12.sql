CREATE procEDURE SP_WSLINV_12--(LocId 3 digit change only increased the parameter width by Sanjay:04-11-2024)
	@CMEMOID	VARCHAR(40) = '',
	@CWHERE1	VARCHAR(500) = '',
	@NNAVMODE	NUMERIC(1,0) = 0,
	@CWHERE2	NVARCHAR(MAX)='',
	@DMEMODT DATETIME='',
	@CLOCID		VARCHAR(4)='',
	@NMEMOTYPE	NUMERIC(1,0) = 1,
	@NXN_ITEM_TYPE	NUMERIC(1,0) = 1
----WITH ENCRYPTION 


AS
BEGIN

    DECLARE @CURDEPT_ID VARCHAR(5),@IMAXLEVEL numeric(5,0)
    
    IF @CLOCID=''
      SELECT TOP 1 @CURDEPT_ID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
	ELSE
	   SELECT @CURDEPT_ID = @CLOCID

	 SELECT @IMAXLEVEL=MAX(LEVEL_NO)   
	 FROM XN_APPROVAL_CHECKLIST_LEVELS   
	 WHERE XN_TYPE='WPS' AND INACTIVE=0  

	


	   IF @NXN_ITEM_TYPE=0
	   SET @NXN_ITEM_TYPE=1
	

	SELECT CAST(0 AS BIT) AS BILLCHECK, B.PS_ID,B.PS_NO,B.PS_DT,0 AS SR,
           SUM(QUANTITY) AS TOTAL_QTY,  
           CAST('' AS NVARCHAR(10)) AS SRNO ,B.REMARKS,ISNULL(B.LOTTYPE,1) AS LOTTYPE,B.HEAD_COUNT  
    FROM WPS_DET A (NOLOCK)  
    JOIN WPS_MST B (NOLOCK) ON A.PS_ID= B.PS_ID   
    Join LMV01106 C on B. ac_code = C.ac_code      
    WHERE (B.AC_CODE=@CWHERE1 or c.BROKER_AC_CODE= @CWHERE1 or b.party_dept_id= @CWHERE1)  
    AND B.PS_MODE=@NNAVMODE AND CANCELLED=0 AND ISNULL(B.WSL_INV_ID,'')=''
	--AND ISNULL(B.LOTTYPE,1)=@CWHERE2 	
	AND ((B.bin_ID<>'888' AND @CWHERE2 <>'888') OR (B.bin_ID='888' AND @CWHERE2 ='888'))
	AND b.location_Code=@CURDEPT_ID     
	AND (@DMEMODT='' OR B.PS_DT<=@DMEMODT) --AND S.PS_ID IS NULL
	AND ISNULL(B.MEMO_TYPE,1)=CASE WHEN @NMEMOTYPE=1 THEN 1 ELSE 2 END
	AND ISNULL(B.XN_ITEM_TYPE,1)=@NXN_ITEM_TYPE
	AND (ISNULL(@CMEMOID,'')='' OR B.PS_NO= @CMEMOID)
	and (isnull(@IMAXLEVEL,0)=0 or b.ApprovedLevelNo=99)
    GROUP BY  B.PS_ID,B.PS_NO,B.PS_DT ,B.REMARKS,ISNULL(B.LOTTYPE,1),B.HEAD_COUNT
    ORDER BY B.PS_DT,B.PS_NO


END

