CREATE PROCEDURE SP_GETCCDETAILS_FROM_API
@NAMOUNT NUMERIC(10,0),
@NMODE INT=1,
@BRETVAL BIT OUTPUT,
@CERRMSG VARCHAR(1000) OUTPUT,
@CRESPONSESTRING VARCHAR(MAX) OUTPUT
AS
BEGIN
		
	BEGIN TRY
		
		DECLARE @DSTARTTIME DATETIME,@DLASTCHECKTIME DATETIME,@CFILTERCONDITION VARCHAR(200),
		@CTEMPTABLE VARCHAR(100),@CERRORPROCNAME VARCHAR(100),@CLINENO VARCHAR(5),@CERRTEXT VARCHAR(MAX),@NSTEP INT,
		@CCREDITCARDNO VARCHAR(50),@CAUTHORISATIONNO VARCHAR(50),@CCREDITCARDNAME VARCHAR(100)
	
		
		SELECT @BRETVAL=1,@CERRMSG=''
		
		SET @NSTEP=10
		
		IF @NMODE=1
		BEGIN 
			SET @NSTEP=20
			IF EXISTS (SELECT TOP 1 AMOUNT FROM CC_API_DETAILS (NOLOCK) WHERE SP_ID=@@SPID)
				DELETE FROM CC_API_DETAILS WHERE SP_ID=@@SPID
				
			INSERT CC_API_DETAILS	( SP_ID,AMOUNT )
			SELECT @@SPID AS SP_ID,@NAMOUNT AS AMOUNT
		END
		
		ELSE
		IF @NMODE=2
		BEGIN	
			SET @NSTEP=30
			
			SELECT @DSTARTTIME=GETDATE(),@DLASTCHECKTIME=GETDATE(),@BRETVAL=0
						
			WHILE @BRETVAL=0
			BEGIN
				IF ABS(DATEDIFF(S,GETDATE(),@DSTARTTIME)) >60
					BREAK
				
				SET @NSTEP=40	
				
				IF ABS(DATEDIFF(S,GETDATE(),@DLASTCHECKTIME))=5
				BEGIN
					SET @NSTEP=50
					
					IF NOT EXISTS (SELECT TOP 1 SP_ID FROM CC_API_DETAILS (NOLOCK) 
								   WHERE SP_ID=@@SPID AND (RESPONSE_STRING IS NOT NULL OR ERRMSG IS NOT NULL))
						SET @DLASTCHECKTIME=GETDATE()
					ELSE
					IF EXISTS (SELECT TOP 1 SP_ID FROM CC_API_DETAILS (NOLOCK) 
							   WHERE SP_ID=@@SPID AND (RESPONSE_STRING IS NOT NULL  OR ERRMSG IS NOT NULL))
					BEGIN
						SELECT @CRESPONSESTRING=RESPONSE_STRING,@CERRMSG=ERRMSG FROM CC_API_DETAILS (NOLOCK)
						WHERE SP_ID=@@SPID
						
						IF ISNULL(@CERRMSG,'')=''
							SET @BRETVAL=1
						ELSE
							SET @BRETVAL=0
							
						SET @NSTEP=60
						BREAK	
					END
				END	
			END
			
			SET @NSTEP=70
			
			IF @CRESPONSESTRING IS NULL	
			BEGIN
				SET @CERRMSG='THERE IS NO RESPONSE COMING FROM REMOTE SERVER...... PLEASE CONTACT SYSTEM ADMINISTRATOR'
				GOTO END_PROC
			END
			
			IF @CRESPONSESTRING='' AND ISNULL(@CERRMSG,'')=''
			BEGIN
				SET @CERRMSG='INVALID RESPONSE STRING RETURNED FROM REMOTE SERVER...... PLEASE CONTACT SYSTEM ADMINISTRATOR'
				GOTO END_PROC
			END
		END	
		
	END TRY
	
	BEGIN CATCH
						
		SELECT @CERRORPROCNAME=ISNULL(ERROR_PROCEDURE(),'NULL P'),@CLINENO=ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE'),
		@CERRTEXT=ISNULL(ERROR_MESSAGE(),'NULL MSG')
		

		SELECT @CERRMSG='STEP :'+ISNULL(LTRIM(RTRIM(STR(@NSTEP))),0)+' LINE NO. :'+@CLINENO+' MSG :'+@CERRTEXT
	
	END CATCH
	
END_PROC:	

END
------ 'END OF CREATING PROCEDURE SP_GETCCDETAILS_FROM_API'
