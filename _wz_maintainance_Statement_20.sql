

--**** UPDATING NEWLY INSERTED PI_QTY COLUMN IN POD01106 WITH TOTAL PURCHASE QTY
IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_POD01106_PIQTY' AND VALUE=1)
BEGIN
	PRINT 'UPDATING PI QTY COLUMN IN POD01106'
	
	IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_POD01106_PIQTY')
		INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
			   VALUES ('UPDATE_POD01106_PIQTY',1,'',GETDATE())	
	ELSE
		UPDATE CONFIG SET VALUE=1 WHERE CONFIG_OPTION='UPDATE_POD01106_PIQTY'
	
	UPDATE POD01106 SET PI_QTY=B.PI_QTY 
	FROM (SELECT PO_ROW_ID,SUM(QUANTITY) AS PI_QTY FROM PID01106 A
	      JOIN ARTICLE B ON A.ARTICLE_CODE=B.ARTICLE_CODE
	      JOIN PIM01106 C ON C.MRR_ID=A.MRR_ID
	      WHERE CODING_SCHEME IN (2,3) AND CANCELLED=0 
	      GROUP BY PO_ROW_ID) B 
	WHERE B.PO_ROW_ID=POD01106.ROW_ID
	
END		
