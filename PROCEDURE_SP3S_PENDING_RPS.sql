CREATE PROCEDURE SP3S_PENDING_RPS
(
  @DDATE DATETIME,
  @CLOCID    VARCHAR(5)='' 
)
AS
BEGIN
     
     DECLARE @CDEPT_ID VARCHAR(5)
     
  --   SELECT TOP 1  @CDEPT_ID=VALUE  FROM CONFIG  WHERE CONFIG_OPTION ='LOCATION_ID'
     
       
	IF ISNULL(@CLOCID,'')=''  
	SELECT @CDEPT_ID = DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
	ELSE   
	SET @CDEPT_ID=@CLOCID  

   SELECT A.CM_NO,A.CM_DT ,
   ERRMST='PENDING RETAIL PACK SLIP' 
   FROM RPS_MST A (NOLOCK)
   JOIN RPS_DET B (NOLOCK) ON A.CM_ID =B.CM_ID
   LEFT OUTER JOIN 
   (
	 SELECT A.CM_ID AS  PACK_SLIP_ID,SUM(CMD.QUANTITY) AS CMD_QTY  
	 FROM  RPS_MST A
	 JOIN CMM01106 CMM ON A.REF_CM_ID =CMM.CM_ID 
	 JOIN CMD01106 CMD ON CMM.CM_ID =CMD.CM_ID 
	 WHERE CMM.CANCELLED =0 AND A.CANCELLED =0
	 AND A.location_Code =@CDEPT_ID
     GROUP BY A.CM_ID
   )CMD ON A.CM_ID =CMD.PACK_SLIP_ID 
   WHERE A.CANCELLED=0 AND A.CM_DT= @DDATE
   AND A.location_Code=@CDEPT_ID
   AND CMD.PACK_SLIP_ID IS NULL
   GROUP BY A.CM_NO,A.CM_DT ,ISNULL(CMD.CMD_QTY,0)
   HAVING SUM(B.QUANTITY)>ISNULL(CMD.CMD_QTY,0)
END
