create PROCEDURE SP_POSCASHIERMODULE
@NQUERYID INT,
@CWHERE VARCHAR(MAX)='',
@DFILTERDATE DATETIME='',
@cLOC varchar(5)=''
--WITH ENCRYPTION
AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 
	DECLARE @CFINYEAR VARCHAR(5)
	SELECT @CFINYEAR='01'+DBO.FN_GETFINYEAR(@DFILTERDATE)

	DECLARE @CLOCID VARCHAR(5),@CCUTOFDATE VARCHAR(50)
	
	 SELECT @CLOCID= @cLOC
	
		  
	SELECT @CCUTOFDATE =VALUE FROM CONFIG WHERE CONFIG_OPTION='OPEN_CASHIER_FOR_CASHMEMOS_CUTOFF_DATE'	  
	IF ISDATE(@CCUTOFDATE)=0
	SET @CCUTOFDATE=''
	
	IF @NQUERYID=1
		GOTO LBLGETPACKSLIPDATA
	ELSE
		GOTO LAST

LBLGETPACKSLIPDATA:
	
	PRINT 'STEP : 1'+CONVERT(VARCHAR,GETDATE(),109)
	
	IF OBJECT_ID('TEMPDB..#TMPRPS','U') IS NOT NULL
		DROP TABLE #TMPRPS
	
	SELECT A.CM_ID 
	INTO #TMPRPS
	FROM  CMM01106  A (NOLOCK) 
	JOIN 
	(SELECT MEMO_ID,SUM(CASE WHEN PAYMODE_GRP_CODE='0000001' THEN AMOUNT ELSE 0 END) AS CASH_AMOUNT,
	 SUM(CASE WHEN A.PAYMODE_CODE IN ('0000004','CMR0001')  THEN AMOUNT ELSE 0 END) AS CREDIT_AMOUNT
	 FROM PAYMODE_XN_DET A (NOLOCK)
	 JOIN PAYMODE_MST B (NOLOCK) ON A.PAYMODE_CODE=B.PAYMODE_CODE
	 WHERE XN_TYPE='SLS' GROUP BY MEMO_ID
	 ) PAY ON PAY.MEMO_ID=A.CM_ID 
		
	LEFT JOIN 
	(
		SELECT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0 
	)DS ON A.CM_ID=DS.CM_ID
	WHERE A.FIN_YEAR=@CFINYEAR AND a.location_Code =@CLOCID AND A.CM_DT<=@DFILTERDATE 
	--AND SUBSTRING(CM_NO,5,1)<>'N' 
	AND NOT(A.NET_AMOUNT<0 AND PAY.CREDIT_AMOUNT<>0  AND PAY.CASH_AMOUNT=0)/*EXCLUDING CREDITNOTE AND CREDIT REFUND BILLS*/
	AND A.CANCELLED = 0 
	AND (@CCUTOFDATE='' OR A.CM_DT >=@CCUTOFDATE)
	AND  DS.CM_ID IS NULL  
	
	
	PRINT 'STEP : 2'+CONVERT(VARCHAR,GETDATE(),109)
	
	SELECT A.*, B.*, B.USER_CUSTOMER_CODE+'['+ B.CUSTOMER_TITLE+' '+B.CUSTOMER_FNAME+' '+B.CUSTOMER_LNAME +']' AS CUSTOMER_NAME, '' AS CREDIT_CARD_NAME , C.USERNAME, '' AS ADDRESS,  
	ISNULL(ST.STATE,'') AS [STATE],ISNULL(AR.AREA_NAME,'') AS  AREA,  
	ISNULL(CI.CITY,'') AS CITY,ISNULL(AR.PINCODE,'') AS PINCODE,  
	CAST((CASE WHEN ISNULL(CMR.CM_ID,'')<>'' THEN 1 ELSE 0 END) AS BIT) AS CREDIT_REFUND,  
	'' AS HOLD_ID,'' AS LOGIN_ID,'' AS SESSION_ID,CAST(ISNULL(TAX,0) AS NUMERIC(14,2)) AS [TOTAL_TAX]  ,ISNULL(D.USERNAME,'') AS [EDT_USERNAME],
	ISNULL(X.EMP_CODE,'0000000') AS [EMP_CODE],ISNULL(X.EMP_CODE1,'0000000')  AS [EMP_CODE1],
	ISNULL(X.EMP_CODE2,'0000000') AS [EMP_CODE2],DBO.FN_GETSALEPERSON(A.CM_ID,0) AS [EMP_NAME],
	ISNULL(X.EMP_NAME1,'') AS [EMP_NAME1],ISNULL(X.EMP_NAME2,'') AS [EMP_NAME2],DTM.DT_NAME,
	B1.AC_NAME,ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],
	CONVERT(NUMERIC(14,2),A.SUBTOTAL+A.SUBTOTAL_R) AS [SUBTOTAL_T],
	CONVERT(NUMERIC(14,3),(CASE WHEN (A.SUBTOTAL+A.SUBTOTAL_R)<>0 THEN (A.DISCOUNT_AMOUNT*100)/ (A.SUBTOTAL+A.SUBTOTAL_R) ELSE 0 END)) AS [DISCOUNT_PERCENTAGE_CALC]
	,DBO.FN_CONVERTINTOHOURSMINS(DATEDIFF(MI,A.LAST_UPDATE,GETDATE())) AS [DELAY] ,
	ISNULL(PAY.CASH_AMOUNT,0) AS CASH_AMOUNT,ISNULL(PAY.CC_AMOUNT,0) AS CC_AMOUNT,ISNULL(PAY.CREDIT_AMOUNT,0) AS CREDIT_AMOUNT,ISNULL(PAY.CN_AMOUNT,0) AS CN_AMOUNT,
	ISNULL(PAY.ADVANCE_AMOUNT_ADJUSTED,0)+ISNULL(PAY.OTHER_DOC_AMOUNT,0)+ISNULL(PAY.BANK_CHARGES,0)+ISNULL(PAY.MISC_AMOUNT,0) AS [OTHER_AMOUNT]
	FROM CMM01106 A  (NOLOCK)
	JOIN #TMPRPS C1 (NOLOCK) ON A.CM_ID=C1.CM_ID  
	JOIN CUSTDYM B  (NOLOCK) ON B.CUSTOMER_CODE=A.CUSTOMER_CODE   
	JOIN LM01106 B1  (NOLOCK) ON B1.AC_CODE=A.AC_CODE 
	JOIN DTM  (NOLOCK) ON DTM.DT_CODE=A.DT_CODE
	LEFT OUTER JOIN BIN  (NOLOCK) ON BIN.BIN_ID=ISNULL(A.BIN_ID,'000')  
	LEFT OUTER JOIN AREA AR  (NOLOCK) ON AR.AREA_CODE=B.AREA_CODE  
	LEFT OUTER JOIN CITY CI  (NOLOCK) ON CI.CITY_CODE=AR.CITY_CODE  
	LEFT OUTER JOIN STATE ST  (NOLOCK) ON ST.STATE_CODE=CI.STATE_CODE  
	LEFT OUTER JOIN CMR01106 CMR  (NOLOCK) ON CMR.CM_ID=A.CM_ID    
	JOIN USERS C  (NOLOCK) ON C.USER_CODE=A.USER_CODE  
	LEFT OUTER JOIN USERS D  (NOLOCK) ON D.USER_CODE=A.EDT_USER_CODE
	LEFT OUTER JOIN
	(
		SELECT SUM(TAX_AMOUNT) AS [TAX] ,A.CM_ID	FROM CMD01106 A (NOLOCK)
		JOIN #TMPRPS B (NOLOCK) ON A.CM_ID=B.CM_ID  
		WHERE TAX_METHOD=2 --AND CM_ID=@CWHERE 
		GROUP BY A.CM_ID
	)X1 ON X1.CM_ID=A.CM_ID  
	LEFT OUTER JOIN
	(
		SELECT TOP 1 A.CM_ID,E1.EMP_CODE,E2.EMP_CODE  AS [EMP_CODE1],E3.EMP_CODE AS [EMP_CODE2],E1.EMP_NAME AS [EMP_NAME]
		,E2.EMP_NAME AS [EMP_NAME1],E3.EMP_NAME AS [EMP_NAME2]
		FROM CMD01106 A (NOLOCK)
		JOIN EMPLOYEE E1 (NOLOCK) ON E1.EMP_CODE=A.EMP_CODE
		JOIN EMPLOYEE E2 (NOLOCK) ON E2.EMP_CODE=A.EMP_CODE1
		JOIN EMPLOYEE E3 (NOLOCK) ON E3.EMP_CODE=A.EMP_CODE2
		WHERE 1=2
	)X ON X.CM_ID=A.CM_ID
	JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID=A.CM_ID AND PAY.XN_TYPE='SLS'
	--WHERE ABS(CASH_AMOUNT) <> 0
	--WHERE (A.SUBTOTAL+A.SUBTOTAL_R)>0
	ORDER BY A.CM_NO
	
	
	PRINT 'STEP : 3'+CONVERT(VARCHAR,GETDATE(),109)
	
	--IF OBJECT_ID('TEMPDB..#TMPCMD','U') IS NOT NULL
	--	DROP TABLE #TMPCMD
	
	
	--SELECT A.* INTO #TMPCMD FROM CMD01106 A  WITH (NOLOCK,INDEX=IND_CMD01106_CMID)  
	--JOIN #TMPRPS B1 ON A.CM_ID=B1.CM_ID  
	
	PRINT 'STEP : 3.1'+CONVERT(VARCHAR,GETDATE(),109)
		
	SELECT  A.*,A.SR_NO AS SRNO,  
	EMP.EMP_NAME, A.PRODUCT_CODE, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, C.PARA1_CODE,    
	C.PARA1_NAME, D.PARA2_CODE, D.PARA2_NAME, F.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,       
	A.DEPT_ID, SKU.BARCODE_CODING_SCHEME AS CODING_SCHEME,  B.INACTIVE,0 AS QUANTITY_IN_STOCK ,   
	SKU.PURCHASE_PRICE,  SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,    
	G.PARA4_CODE,H.PARA5_CODE,I.PARA6_CODE,    
	PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],    
	B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],B.STOCK_NA,
	CONVERT (BIT,(CASE WHEN A.QUANTITY <0 THEN 1 ELSE 0 END)) AS SALERETURN ,
	CAST(0 AS BIT) AS CREDIT_REFUND,'' AS HOLD_ID,'' AS CMD_HOLD_ROW_ID, A.MRP AS [LOCSKU_MRP],SKU.PRODUCT_NAME,  
	EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2,
	(CASE WHEN ISNULL(SKU.FIX_MRP,0)=0 THEN SKU.MRP ELSE SKU.FIX_MRP END) AS [FIX_MRP],
	(CASE WHEN ISNULL(A.HOLD_FOR_ALTER,0)=0 THEN 'N' ELSE 'Y' END) AS [HOLD_FOR_ALTER_TXT],
	(CASE WHEN ISNULL(A.PACK_SLIP_ID,'')='' THEN '' ELSE RIGHT(A.PACK_SLIP_ID,10 ) END) AS [PACK_SLIP_NO],
	ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],B.ALIAS AS ARTICLE_ALIAS ,SD.SUB_SECTION_CODE,SM.SECTION_CODE,
	CONVERT(BIT,0 ) AS [BRANDWISE_DISC],ISNULL(SLS_TITLE,'') AS SLS_TITLE,
	ISNULL(N.NARRATION,'') AS [NARRATION],CONVERT(VARCHAR(10),'') AS [BUYER_ORDER_NO]
	FROM  CMD01106  A  WITH (NOLOCK,INDEX=IND_CMD01106_CMID)  
	JOIN #TMPRPS R ON R.CM_ID=A.CM_ID
	JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
	LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID  
	JOIN ARTICLE B  (NOLOCK) ON SKU.ARTICLE_CODE = B.ARTICLE_CODE      
	JOIN SECTIOND SD  (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	JOIN SECTIONM SM  (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	JOIN PARA1 C  (NOLOCK) ON SKU.PARA1_CODE = C.PARA1_CODE      
	JOIN PARA2 D  (NOLOCK) ON SKU.PARA2_CODE = D.PARA2_CODE      
	JOIN PARA3 F  (NOLOCK) ON SKU.PARA3_CODE = F.PARA3_CODE      
	JOIN PARA4 G  (NOLOCK) ON SKU.PARA4_CODE = G.PARA4_CODE      
	JOIN PARA5 H  (NOLOCK) ON SKU.PARA5_CODE = H.PARA5_CODE      
	JOIN PARA6 I  (NOLOCK) ON SKU.PARA6_CODE = I.PARA6_CODE      
	JOIN UOM E  (NOLOCK) ON B.UOM_CODE = E.UOM_CODE 
	LEFT OUTER JOIN NRM N (NOLOCK) ON N.NRM_ID=ISNULL(A.NRM_ID  ,'0000000')
	LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON A.EMP_CODE = EMP.EMP_CODE   
	LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON A.EMP_CODE1 = EMP1.EMP_CODE     
	LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON A.EMP_CODE2 = EMP2.EMP_CODE    
	LEFT OUTER JOIN SLSDET S (NOLOCK) ON S.ROW_ID =A.SLSDET_ROW_ID
	ORDER BY  A.SR_NO

	PRINT 'STEP : 4'+CONVERT(VARCHAR,GETDATE(),109)

	SELECT A.*,B.PAYMODE_NAME,C.* ,CAST(0 AS BIT ) AS DELETED,      
	(CASE WHEN A.CURRENCY_CONVERSION_RATE> 0 THEN     
	CAST(A.AMOUNT/A.CURRENCY_CONVERSION_RATE AS NUMERIC(10,2)) ELSE A.AMOUNT END ) AS BASIC_AMOUNT,
	ISNULL(S.CM_DT,ISNULL(R.ADV_REC_DT,'')) AS ADJ_MEMO_DT  ,CONVERT(VARCHAR(100),'') AS SP_ID  
	FROM PAYMODE_XN_DET A  (NOLOCK)   
	JOIN PAYMODE_MST B (NOLOCK) ON B.PAYMODE_CODE=A.PAYMODE_CODE      
	JOIN PAYMODE_GRP_MST C (NOLOCK) ON C.PAYMODE_GRP_CODE=B.PAYMODE_GRP_CODE      
	
	LEFT OUTER JOIN
	(
		SELECT  A.CM_NO,A.CM_DT,A.CM_ID FROM  CMM01106 A (NOLOCK) 
		JOIN PAYMODE_XN_DET B (NOLOCK) ON B.ADJ_MEMO_ID=A.CM_ID
		JOIN #TMPRPS C ON C.CM_ID=B.MEMO_ID
		WHERE  B.XN_TYPE='SLS' AND PAYMODE_CODE='0000001' AND SUBSTRING(A.CM_NO,5,1)='N'
	)S ON S.CM_ID=A.ADJ_MEMO_ID
	LEFT OUTER JOIN
	(
		SELECT  A.ADV_REC_NO,A.ADV_REC_DT,A.ADV_REC_ID FROM ARC01106 A (NOLOCK) 
		JOIN PAYMODE_XN_DET B (NOLOCK) ON B.ADJ_MEMO_ID=A.ADV_REC_ID
		JOIN #TMPRPS C ON C.CM_ID=B.MEMO_ID
		WHERE ARC_TYPE=2 AND  B.XN_TYPE='SLS' AND PAYMODE_CODE='0000002'
	 )R ON R.ADV_REC_ID=A.ADJ_MEMO_ID   
	 
	JOIN #TMPRPS D ON D.CM_ID=A.MEMO_ID
	WHERE A.XN_TYPE ='SLS' 

	PRINT 'STEP : 5'+CONVERT(VARCHAR,GETDATE(),109)
	
	GOTO LAST  
	
LAST:

END
--END OF PROCEDURE - SP_POSCASHIERMODULE
