CREATE PROCEDURE SAVETRAN_LOC_XNSAPPROVAL
(
	 @CSPID			VARCHAR(50)
)
--WITH ENCRYPTION
AS
BEGIN
DECLARE @CERRMSG VARCHAR(500),@CSTEP VARCHAR(10)
	   ,@CCMD NVARCHAR(MAX),@BREFEXISTS BIT
	  

DECLARE @TOUTPUT TABLE(XN_TYPE VARCHAR(10),DEPT_ID VARCHAR(100), MODULE_NAME VARCHAR(100),ERRMSG VARCHAR(500))

---LIST OF TABLES TO SAVE
DECLARE @TLOC_XNSAPPROVAL VARCHAR(100)


SET @TLOC_XNSAPPROVAL='MSTLOC_LOC_XNSAPPROVAL_UPLOAD'

BEGIN TRY
BEGIN TRANSACTION
		    SET @CSTEP=10

			--VALIDATION FOR BLANK CHECKLIST_DESC
			SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TLOC_XNSAPPROVAL+' WHERE ISNULL(XN_TYPE,'''')='''' AND SP_ID='''+@CSPID+''' )
					        SET @CERRMSG=''XN_TYPE   CANNOT BE BLANK.'''
			PRINT @CCMD					        
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT
			
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC
			
			SET @CSTEP=70
			--VALIDATION FOR UNIQUE CHECKLISTDESC
	
	
SET @CCMD=N'DELETE A FROM  LOC_XNSAPPROVAL A 
            JOIN '+@TLOC_XNSAPPROVAL+' B ON A.XN_TYPE=B.XN_TYPE 
			WHERE B.SP_ID= '''+@CSPID+''' '
PRINT @CCMD				        
EXEC SP_EXECUTESQL @CCMD
		
		 DECLARE @CWHERECLAUSE VARCHAR(1000)
        SET @CWHERECLAUSE = ' SP_ID='''+LTRIM(RTRIM((@CSPID)))+''''

	SET @CSTEP=160
	--UPDATING XN_APPROVAL_CHECKLIST_MST MASTER
	EXEC UPDATEMASTERXN 
			 @CSOURCEDB=''
			,@CSOURCETABLE=@TLOC_XNSAPPROVAL
			,@CDESTDB=''
			,@CDESTTABLE='LOC_XNSAPPROVAL'
			,@CKEYFIELD1='XN_TYPE'
			,@CKEYFIELD2=''
			,@CKEYFIELD3=''
			,@LINSERTONLY=0
			,@CFILTERCONDITION=@CWHERECLAUSE
			,@LUPDATEXNS=0
			,@CXNTYPE=''
			,@LUPDATEONLY=0
			,@CUSERID=''
			,@BALWAYSUPDATE=1
	
END TRY
BEGIN CATCH 
	SET @CERRMSG='SAVETRAN_LOC_XNSAPPROVAL: STEP - '+ISNULL(@CSTEP,'')+', MESSAGE - '+ERROR_MESSAGE() 
END CATCH

END_PROC:

IF @@TRANCOUNT>0  
 BEGIN  
  IF ISNULL(@CERRMSG,'')='' 
   COMMIT TRANSACTION  
  ELSE  
   ROLLBACK  
 END  
 
IF @CERRMSG<>''
BEGIN
INSERT @TOUTPUT(XN_TYPE,DEPT_ID,MODULE_NAME ,ERRMSG)
SELECT '','','',@CERRMSG
END
ELSE
BEGIN
SET @CCMD=N'SELECT XN_TYPE,DEPT_ID,MODULE_NAME,'''' AS ERRMSG FROM '+@TLOC_XNSAPPROVAL+''
PRINT @CCMD	

INSERT @TOUTPUT(XN_TYPE,DEPT_ID,MODULE_NAME ,ERRMSG)				        
EXEC SP_EXECUTESQL @CCMD
END
--DROP TEMP TABLES

DELETE A FROM MSTLOC_LOC_XNSAPPROVAL_UPLOAD A (NOLOCK) WHERE SP_ID=@CSPID


SELECT * FROM @TOUTPUT
END
--END OF PROCEDURE - SAVETRAN_LOC_XNSAPPROVAL
