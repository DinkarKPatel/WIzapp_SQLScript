create PROCEDURE SP3S_GST_TAX_CAL_OH_SLS
(
  @CXN_TYPE VARCHAR(10)='',
  @NSPID VARCHAR(40)=0,
  @BREGISTERED_DELEER INT=1,
  @CLOC_GSTN_NO VARCHAR(100)='',
  @CPARTY_GSTN_NO VARCHAR(100)='',
  @CCURSTATE_CODE VARCHAR(10)='',
  @CPARTYSTATE_CODE VARCHAR(10)='',
  @CERRMSG VARCHAR(200) OUTPUT 
)
AS
BEGIN
      
      DECLARE @FREIGHT_HSN_CODE VARCHAR(15),@OTHER_CHARGES_HSN_CODE VARCHAR(15),
              @INSURANCE_HSN_CODE VARCHAR(15),@PACKING_HSN_CODE VARCHAR(15),@CSTEP VARCHAR(10),
			  @nslsGstPercentage numeric(6,2)
      
              
       BEGIN TRY 
      SET @CERRMSG=''
      SET @CSTEP='00'


      UPDATE TMP SET OTHER_CHARGES_TAXABLE_VALUE = ISNULL(OTHER_CHARGES_TAXABLE_VALUE,0)
	  FROM SLS_GST_TAXINFO_CALC_OH TMP (NOLOCK)
	  WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
				      
      IF ISNULL(@BREGISTERED_DELEER,0)=1
      BEGIN
      
      
			   IF EXISTS(SELECT TOP 1 'U' FROM GST_OH_CONFIG WHERE XN_TYPE=@CXN_TYPE)
			   BEGIN
					SELECT TOP 1 @FREIGHT_HSN_CODE=HSN_CODE FROM GST_OH_CONFIG WHERE OH_NAME='FREIGHT' AND XN_TYPE=@CXN_TYPE
					SELECT TOP 1 @INSURANCE_HSN_CODE=HSN_CODE FROM GST_OH_CONFIG WHERE OH_NAME='INSURANCE' AND XN_TYPE=@CXN_TYPE
					SELECT TOP 1 @OTHER_CHARGES_HSN_CODE=HSN_CODE,@nslsGstPercentage=GST_PERCENTAGE FROM GST_OH_CONFIG WHERE OH_NAME='OC' AND XN_TYPE=@CXN_TYPE
					SELECT TOP 1 @PACKING_HSN_CODE=HSN_CODE FROM GST_OH_CONFIG WHERE OH_NAME='PACKING' AND XN_TYPE=@CXN_TYPE
	           
			   END
			   ELSE
			   BEGIN
					SELECT TOP 1 @FREIGHT_HSN_CODE=HSN_CODE FROM GST_OH_CONFIG WHERE OH_NAME='FREIGHT' 
					SELECT TOP 1 @INSURANCE_HSN_CODE=HSN_CODE FROM GST_OH_CONFIG WHERE OH_NAME='INSURANCE' 
					SELECT TOP 1 @OTHER_CHARGES_HSN_CODE=HSN_CODE,@nslsGstPercentage=GST_PERCENTAGE FROM GST_OH_CONFIG WHERE OH_NAME='OC'  
					SELECT TOP 1 @PACKING_HSN_CODE=HSN_CODE FROM GST_OH_CONFIG WHERE OH_NAME='PACKING'  
	           
			   END
           
           
           
            SET @CSTEP='10'     
            SELECT TOP 1 @CERRMSG=CASE WHEN ISNULL(OTHER_CHARGES,0)>0 AND ISNULL(@OTHER_CHARGES_HSN_CODE,'') IN ('','0000000000') 
                                                THEN 'OTHER CHARGES HSN CODE NOT FOUND'
                                  ELSE '' END
            FROM SLS_GST_TAXINFO_CALC_OH (NOLOCK)
            WHERE SP_ID=LTRIM(RTRIM((@NSPID))) 
            
            SET @CSTEP='20'
            
            IF ISNULL(@CERRMSG,'')<>''
            RETURN
            
            --UPDATE OH HSN CODE
            UPDATE TMP SET OTHER_CHARGES_HSN_CODE=CASE WHEN ISNULL(OTHER_CHARGES,0)<>0 THEN  @OTHER_CHARGES_HSN_CODE ELSE '0000000000' END,
                           ISIGST=CASE WHEN @CCURSTATE_CODE<>@CPARTYSTATE_CODE THEN 1 ELSE 0 END
            FROM SLS_GST_TAXINFO_CALC_OH TMP (NOLOCK)
            WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) 
            
          
            
              SET @CSTEP='30'
              
             --MAXIMUM OC GST PERCENTAGE PICK 
                DECLARE @OCGST_PERCENTAGE NUMERIC(10,2),@MAXGST_PERCENTAGE NUMERIC(10,2),@DMEMO_DT DATETIME
                
              
                     SELECT @MAXGST_PERCENTAGE=MAX(ISNULL(GST_PERCENTAGE,0))
                     FROM sls_GST_TAXINFO_CALC TMP (NOLOCK) WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
                     
                     SET @OCGST_PERCENTAGE=CASE WHEN ISNULL(@NSLSGSTPERCENTAGE,0)<>0 THEN @NSLSGSTPERCENTAGE ELSE  @MAXGST_PERCENTAGE END
                      
               
 
                UPDATE SLS_GST_TAXINFO_CALC_OH
                SET OTHER_CHARGES_GST_PERCENTAGE=CASE  WHEN OTHER_CHARGES<>0 AND ISNULL(DO_NOT_CALC_GST_OH,0)=0 THEN  @OCGST_PERCENTAGE ELSE 0 END
                WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
                
            --EXCLUSIVE TAX UPDATE
             SET @CSTEP='40'
             
             UPDATE TMP SET OTHER_CHARGES_TAXABLE_VALUE =ROUND(OTHER_CHARGES-(OTHER_CHARGES*(CASE WHEN OH_TAX_METHOD =2 THEN ((ISNULL(TMP.OTHER_CHARGES_GST_PERCENTAGE,0))/  
			 (100 + ISNULL(TMP.OTHER_CHARGES_GST_PERCENTAGE,0))) ELSE 0 END)),2)
			  FROM SLS_GST_TAXINFO_CALC_OH TMP (NOLOCK)
			  WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
				
			 
			    UPDATE TMP SET OTHER_CHARGES_GST_AMOUNT=
				ROUND(
					ISNULL(OTHER_CHARGES,0)*(CASE WHEN OH_TAX_METHOD=2 THEN (TMP.OTHER_CHARGES_GST_PERCENTAGE/  
					(100 + TMP.OTHER_CHARGES_GST_PERCENTAGE)) ELSE (TMP.OTHER_CHARGES_GST_PERCENTAGE/100) END)
		        ,2 )
				FROM SLS_GST_TAXINFO_CALC_OH TMP (NOLOCK)
				WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
				
           
            
      
      END
      ELSE
      BEGIN
          
          UPDATE TMP SET 
                         OTHER_CHARGES_HSN_CODE='0000000000',
						 OTHER_CHARGES_GST_PERCENTAGE=0,
						 ISIGST=0,
						 OTHER_CHARGES_GST_AMOUNT=0,
						 OTHER_CHARGES_TAXABLE_VALUE=OTHER_CHARGES 
						
		  FROM SLS_GST_TAXINFO_CALC_OH TMP (NOLOCK)
		  WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) 
      
      END
  END TRY  
  BEGIN CATCH  
   SELECT @CERRMSG='ERROR MESSAGE IN PROCEDURE SP3S_GST_TAX_CAL_OH_SLS STEP#'+@CSTEP+' '+CAST(ERROR_MESSAGE() AS VARCHAR(MAX))+ '||'+ERROR_PROCEDURE()  
   PRINT 'ENTER CATCH IN SP3S_GST_TAX_CAL_OH'
  END CATCH  

END
