CREATE PROCEDURE SP_POSTSALEJOBWORKS
(	 @NREPORTID SMALLINT 
	,@DHOLDBACKSDT DATETIME 
	,@DHOLDBACKEDT DATETIME	
	,@CAGENCY_CODE VARCHAR(100)=''
	,@CPRODUCT_CODE VARCHAR(100)=''
	,@CCUST_CODE VARCHAR(100)=''
	,@CJOB_CODE VARCHAR(100)=''
	
	
)
--WITH ENCRYPTION

AS
BEGIN --START OF PROCEDURE
	DECLARE  @VCMD NVARCHAR(MAX)
			,@VCMD1 NVARCHAR(MAX)
			,@VCMD2 NVARCHAR(MAX)
			,@NONHOLD INT 
			,@NISSUED INT
			,@NRECEIVED INT
			,@NDELIVERED INT
			,@NONTIME INT
			,@NLATE INT
			,@NDELIEVEREDTOCUSTOMER INT
			
		
	/*	REPORTID 1 - DAILY POST SALE HOLD, ISSUED, RECEIVED,ONTIME DELIVERY, LATE DELIEVERY  & DELIVERY COUNT 
		
		REPORTID 2 - DETAILED HOLD REPORT 
			(CUSTOMER NAME, BILL NO, ARTICLE NO, ARTICLE NAME, JOB, QTY, MEMO NO, MEMO DATE, DELIVERY DATE
			, PRODUCT CODE, PARA1, PARA2, STATUS, TOTAL NO. OF ARTICLES HOLD )
		REPORTID 3 - ISSUED REPORT
					(JOB ISSUE NO, JOB ISSUE DATE, AGENCY NAME, BILL NO, ARTICLE NO, ARTICLE NAME, PRODUCT CODE
					, PARA1, PARA2, JOB, RATE, QTY, STATUS, TOTAL NO. OF ARTICLES ISSUED)

		REPORTID 4- RECEIVED REPORT
					(RECEIPT NO., RECEIPT DATE, AGENCY NAME, BILL NO., ARTICLE NO, ARTICLE NAME, PRODUCT CODE
					, PARA1, PARA2, JOB, NON PAYABLE AMOUNT, QTY, STATUS, REMARKS, TOTAL NO. OF ARTICLES RECEIVED)
		REPORTID 5- DELIVERY REPORT
					(CUSTOMER NAME, BILL NO, DELIVERY NO, DELIVERY DATE, DELIVERED TO, JOB, QTY, PARA1, PARA2
					, STATUS, TOTAL NO. OF ARTICLES DELIVERED)
					
		REPORTID 6- TODAY'S / TOMORROW DELIVERY TO CUSTOMER  REPORT (CALENDAR IS REQUIRED)
					(CUSTOMER NAME, MEMO NO, BILL NO, QTY,JOB,ARTICLE NO, ARTICLE NAME, MEMO DATE, PARA1, PARA2
					, PRODUCT CODE)	
		REPORTID 7-	HOLD ITEM REPORT (CALENDAR IS REQUIRED)
					(CUSTOMER NAME, BILL NO, ARTICLE NO, ARTICLE NAME, JOB, QTY, MEMO NO, MEMO DATE, DELIVERY DATE
					, PRODUCT CODE, PARA1, PARA2, STATUS, TOTAL NO. OF ARTICLES HOLD )
		
		REPORTID 8- ISSUE ITEM REPORT (CALENDAR IS REQUIRED)
					(JOB ISSUE NO, JOB ISSUE DATE, AGENCY NAME, BILL NO, ARTICLE NO, ARTICLE NAME, PRODUCT CODE
					, PARA1, PARA2, JOB, RATE, QTY, STATUS, TOTAL NO. OF ARTICLES ISSUED)

		
		REPORTID 9- RECEIVED ITEM REPORT (CALENDAR IS REQUIRED)
					(RECEIPT NO., RECEIPT DATE, AGENCY NAME, BILL NO., ARTICLE NO, ARTICLE NAME, PRODUCT CODE
					, PARA1, PARA2, JOB, NON PAYABLE AMOUNT, QTY, STATUS, REMARKS, TOTAL NO. OF ARTICLES RECEIVED)
		
		REPORTID 10- PENDING DELIVERY REPORT 
					VENDOR WISE
					(JOB ISSUE NO, JOB ISSUE DATE, AGENCY NAME, BILL NO, ARTICLE NO, ARTICLE NAME, PRODUCT CODE
					, PARA1, PARA2, JOB, RATE, QTY, STATUS, TOTAL NO. OF ARTICLES ISSUED)
		REPORTID 11- CUSTOMER WISE
					JOB ISSUE NO, JOB ISSUE DATE, AGENCY NAME, BILL NO, ARTICLE NO, ARTICLE NAME, PRODUCT CODE
					, PARA1, PARA2, JOB, RATE, QTY, STATUS, TOTAL NO. OF ARTICLES ISSUED
		
		REPORTID 12- AGENCY JOB WISE (RATE) REPORT
					LIST OF ALL AGENCIES WITH THEIR PROFILE(WORK AND COST)
					
		REPORTID 13- NON PAYABLE REPORT (VENDOR WISE)			
		
		REPORTID 14- ON TIME DELIVERY REPORT (VENDOR WISE)
					(AGENCYNAME,PRODUCT_CODE,ARTICLE_NAME,BILL_NO,ISSUENO
					,DUEDATE,DELIEVERYDATE,NOOFLATEDAYS)
					
		REPORTID 15 - ALL CANCELLED REPORT (HOLD,ISSUE,RECEIVE,DELIVERED)

	*/
	IF @NREPORTID=1
	BEGIN
		--COUNT OF TOTAL DELIVERY TO CUSTOMER WITHOUT JOBWORK
		SELECT @NDELIEVEREDTOCUSTOMER=
			COUNT(DISTINCT HLDS.CM_NO) 
		FROM VW_POSTSALES_HBDPRINT HLDS
		WHERE HLDS.MEMO_DT BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND HLDS.CANCELLED=0 AND HLDS.DELIVERED=1
		
		--COUNT OF TOTAL ONHOLD ITEMS FOR A DATE RANGE
		SELECT @NONHOLD=
			   SUM(QUANTITY ) 
		FROM VW_POSTSALES_HBDPRINT HLDS
		WHERE HLDS.MEMO_DT BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND HLDS.CANCELLED=0 AND HLDS.DELIVERED=0
			
		--COUNT OF TOTAL ITEMS ISSUED FOR JOBWORK FOR THE SAME DATE RANGE
		SELECT @NISSUED=
			   SUM(ISSS.QUANTITY) 
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE ISSS.ISSUE_DT BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND ISSS.CANCELLED=0 	
		
		--COUNT OF TOTAL ITEMS RECEIVED BACK FROM JOBWORK FOR THE SAME DATE RANGE
		SELECT @NRECEIVED=
			   SUM(RCPT.QUANTITY) 
		FROM VW_POSTSALES_JOBWORKRECEIPTPRINT RCPT
		JOIN VW_POSTSALES_JOBWORKISSUEPRINT ISSS ON RCPT.REF_ROW_ID=ISSS.ROW_ID 
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE RCPT.RECEIPT_DT BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND  RCPT.CANCELLED=0	

		--COUNT OF TOTAL ITEMS DELIEVERED BACK TO CUSTOMER
		SELECT @NDELIVERED=
				 SUM(DLVY.QUANTITY)
		FROM VW_POSTSALES_SLS_DELIVERYPRINT DLVY
		JOIN VW_POSTSALES_HBDPRINT HLDS ON DLVY.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE DLVY.MEMO_DT  BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND  DLVY.CANCELLED=0
		--COUNT OF ONTIME DELIEVERIES WITHIN A DELIEVERY DATE RANGE
		SELECT @NONTIME=
			   SUM( ISSS.QUANTITY) 
 		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		JOIN VW_POSTSALES_SLS_DELIVERYPRINT DLVY ON HLDS.CM_ID=DLVY.CM_ID
		WHERE HLDS.DELIVERY_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT 
		AND	  HLDS.CANCELLED=0
		AND   DLVY.MEMO_DT<=HLDS.DELIVERY_DT  
		--COUNT OF LATE DELIVERIES WITHIN A DELIEVERY DATE RANGE
		SELECT @NLATE=
			   SUM( ISSS.QUANTITY) 
 		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		JOIN VW_POSTSALES_SLS_DELIVERYPRINT DLVY ON HLDS.CM_ID=DLVY.CM_ID
		WHERE HLDS.DELIVERY_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT 
		AND	  HLDS.CANCELLED=0
		AND   DLVY.MEMO_DT>HLDS.DELIVERY_DT
		
		
		SELECT @NONHOLD AS ONHOLD,@NISSUED AS ISSUEDFORJW,@NRECEIVED AS RECEIVEDFROMJW,@NDELIVERED AS DELIEVERED,@NDELIEVEREDTOCUSTOMER AS 'DELIVEREDTOCUSTOMER',@NONTIME AS ONTIMEDELIVERY,@NLATE AS LATEDELIEVERY
	END	
	
	IF @NREPORTID=2
	BEGIN
		SELECT @NONHOLD=
			   COUNT(DISTINCT HLDS.CM_ID) 
		FROM VW_POSTSALES_HBDPRINT HLDS
		WHERE HLDS.MEMO_DT BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND HLDS.CANCELLED=0 AND HLDS.DELIVERED=0
		--SELECT * FROM VW_POSTSALES_HBDPRINT
		SELECT DISTINCT 
			     HLDS.CM_NO	 
				,HLDS.CUSTOMER_NAME
				,HLDS.ARTICLE_NO
				,HLDS.ARTICLE_NAME
				,HLDS.JOB_NAME
				,1.00 AS QUANTITY
				,HLDS.MEMO_NO
				,HLDS.MEMO_DT
				,HLDS.DELIVERY_DT
				,HLDS.PRODUCT_CODE
				,HLDS.PARA1_NAME
				,HLDS.PARA2_NAME
				--,HLDS.CM_ID
				--,DLVY.CM_ID
				,CASE  
					WHEN HLDS.CANCELLED=1 THEN 'CANCELLED'
					WHEN DLVY.CM_ID IS NULL THEN 'HOLD'
					WHEN DLVY.CM_ID IS NOT NULL THEN 'DELIEVERED TO CUSTOMER'
					END AS 'STATUS'
				,@NONHOLD AS ONHOLDCOUNT				
		FROM VW_POSTSALES_HBDPRINT HLDS
		LEFT JOIN VW_POSTSALES_SLS_DELIVERYPRINT DLVY ON HLDS.CM_ID=DLVY.CM_ID 
		WHERE HLDS.MEMO_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
		ORDER BY 'STATUS'
		
		/*
		SELECT CM_ID,MEMO_ID FROM VW_POSTSALES_HBDPRINT	
		WHERE CM_ID IN 
		(SELECT CM_ID FROM VW_POSTSALES_SLS_DELIVERYPRINT)
		(SELECT MEMO_ID FROM VW_POSTSALES_SLS_DELIVERYPRINT)
		
		SELECT 		    
				 HLDS.CM_ID
				,DLVY.CM_ID							
		FROM VW_POSTSALES_HBDPRINT HLDS
		LEFT JOIN VW_POSTSALES_SLS_DELIVERYPRINT DLVY ON HLDS.CM_ID=DLVY.CM_ID
		*/
	END
	 
	IF @NREPORTID=3
	BEGIN
		SELECT @NISSUED=
				COUNT(ISSS.ISSUE_NO)
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.CM_NO=HLDS.CM_NO
		WHERE ISSS.CANCELLED=0
		AND	ISSS.ISSUE_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT 
		--SELECT * FROM VW_POSTSALES_JOBWORKISSUEPRINT
		SELECT DISTINCT
			 ISSS.ISSUE_NO AS JWISSUENO
			,ISSS.ISSUE_DT AS JWISSUEDT
			,ISSS.AGENCY_NAME AS AGENCYNAME
			,ISSS.CM_NO AS BILLNUMBER
			,ISSS.ARTICLE_NO
			,ISSS.ARTICLE_NAME
			,ISSS.PRODUCT_CODE
			,ISSS.PARA1_NAME
			,ISSS.PARA2_NAME
			,ISSS.JOB_NAME
			,ISSS.JOB_RATE
			,1.00 AS QUANTITY
			,ISSS.DUE_DT 
			,CASE ISSS.CANCELLED
				WHEN 1 THEN 'CANCELLED'
				WHEN 0 THEN 'ISSUED' 
			 END AS STATUS
			,@NISSUED AS ISSUEDCOUNT
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.CM_NO=HLDS.CM_NO
		WHERE ISSS.ISSUE_DT BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
	END

	IF @NREPORTID=4 --RECEIVED REPORT
	BEGIN
		SELECT @NRECEIVED=
			   COUNT(DISTINCT RCPT.ROW_ID) 
		FROM VW_POSTSALES_JOBWORKRECEIPTPRINT RCPT
		JOIN VW_POSTSALES_JOBWORKISSUEPRINT ISSS ON RCPT.REF_ROW_ID=ISSS.ROW_ID 
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE RCPT.RECEIPT_DT BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND  RCPT.CANCELLED=0	
		--SELECT * FROM VW_POSTSALES_JOBWORKRECEIPTPRINT
		SELECT DISTINCT
			 ISNULL(RCPT.RECEIPT_NO,'') AS RECEIPT_NO
			,ISNULL(RCPT.RECEIPT_DT,'') AS RECEIPT_DT
			,ISNULL(ISSS.AGENCY_NAME,'') AS AGENCY_NAME
			,ISNULL(RCPT.CM_NO,'') AS CM_NO
			,ISNULL(RCPT.ARTICLE_NO,'') AS ARTICLE_NO
			,ISNULL(RCPT.ARTICLE_NAME,'') AS ARTICLE_NAME
			,ISNULL(RCPT.PRODUCT_CODE,'') AS PRODUCT_CODE
			,ISNULL(RCPT.PARA1_NAME,'') AS  PARA1_NAME
			,ISNULL(RCPT.PARA2_NAME,'') AS PARA2_NAME
			,ISNULL(RCPT.JOB_NAME,'') AS JOB_NAME
			,ISNULL(RCPT.JOB_RATE,'0') AS JOB_RATE
			,ISNULL(CONVERT(NUMERIC(10,2),RCPT.QUANTITY),'0') AS QUANTITY
			,ISNULL(ISSS.DUE_DT,'') AS DUE_DT
			--,DATEDIFF(D,ISSS.DUE_DT,RCPT.RECEIPT_DT)
			,ISNULL(RCPT.RECEIPT_DT,'') AS RECEIPT_DT
			,CASE 
				WHEN RCPT.CANCELLED=1 THEN 'CANCELLED'
				WHEN DATEDIFF(D,ISSS.DUE_DT,RCPT.RECEIPT_DT)<= 0 THEN 'RECEIVED'
				WHEN DATEDIFF(D,ISSS.DUE_DT,RCPT.RECEIPT_DT)>0 THEN 'RECEIVED'
				WHEN RCPT.REF_ROW_ID IS NULL THEN 'PENDING'
			 END AS 'STATUS'
			,ISNULL(RCPT.REMARKS,'') AS REMARKS
			,@NRECEIVED AS RECEIVEDCOUNT
			--,ISNULL(ISSS.ROW_ID,'') AS 	ROW_ID			
			--,ISNULL(RCPT.REF_ROW_ID,'') AS REF_ROW_ID
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		LEFT JOIN VW_POSTSALES_JOBWORKRECEIPTPRINT RCPT ON ISSS.ROW_ID=RCPT.REF_ROW_ID	
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.CM_NO=HLDS.CM_NO
		WHERE RCPT.RECEIPT_DT BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT	
	END
	
	IF @NREPORTID=5
	BEGIN
		SELECT @NDELIVERED=
				 COUNT(DISTINCT DLVY.REF_HBD_ROW_ID)
		FROM VW_POSTSALES_SLS_DELIVERYPRINT DLVY
		JOIN VW_POSTSALES_HBDPRINT HLDS ON DLVY.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE DLVY.MEMO_DT  BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
		--SELECT * FROM VW_POSTSALES_SLS_DELIVERYPRINT
		SELECT DISTINCT
			 DLVY.CUSTOMER_NAME
			,DLVY.CM_NO 
			,DLVY.ROW_ID 
			,DLVY.MEMO_DT
			,DLVY.DELIVERED_TO
			,DLVY.JOB_NAME
			,DLVY.QUANTITY_IN_STOCK
			,DLVY.PARA1_NAME
			,DLVY.PARA2_NAME
			,DLVY.ARTICLE_NAME 
			,DLVY.MEMO_NO 
			,1.00 AS QUANTITY
			,DLVY.PRODUCT_CODE 
			,CASE 
				WHEN DLVY.CANCELLED=1 THEN 'CANCELLED'
				ELSE 'DELIEVERED'
			END AS 'STATUS'
			,@NDELIVERED AS DELIVEREDCOUNT
		FROM VW_POSTSALES_SLS_DELIVERYPRINT DLVY
		JOIN VW_POSTSALES_HBDPRINT HLDS ON DLVY.REF_HBD_ROW_ID=HLDS.ROW_ID
		--ON DLVY.CM_ID=HLDS.CM_ID
		WHERE DLVY.MEMO_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT	
		--AND HLDS.DELIVERED = 0
	END	
	
	IF @NREPORTID=6
	BEGIN
		--SELECT * FROM VW_POSTSALES_SLS_DELIVERYPRINT 
		SELECT DISTINCT
			 HLDS.CUSTOMER_NAME
			,HLDS.MEMO_NO
			,HLDS.CM_NO
			,HLDS.QUANTITY_IN_STOCK
			,HLDS.JOB_NAME
			,HLDS.ARTICLE_NO
			,HLDS.ARTICLE_NAME
			,HLDS.MEMO_DT
			,HLDS.PARA1_NAME
			,HLDS.PARA2_NAME
			,HLDS.PRODUCT_CODE
		FROM VW_POSTSALES_HBDPRINT HLDS
		LEFT JOIN VW_POSTSALES_SLS_DELIVERYPRINT DLVY ON HLDS.CM_ID=DLVY.CM_ID
		WHERE DLVY.CM_ID IS NULL 
		AND HLDS.CANCELLED=0
		AND HLDS.DELIVERY_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
	END
	
	IF @NREPORTID=7
	BEGIN
		SELECT @NONHOLD=
			   COUNT(DISTINCT HLDS.CM_ID) 
		FROM VW_POSTSALES_HBDPRINT HLDS
		WHERE HLDS.DELIVERY_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND HLDS.CANCELLED=0 AND HLDS.DELIVERED=0
		--SELECT * FROM VW_POSTSALES_HBDPRINT HLDS
		SELECT DISTINCT
			 HLDS.CUSTOMER_NAME
			,HLDS.CM_NO
			,HLDS.ARTICLE_NO
			,HLDS.ARTICLE_NAME
			,HLDS.JOB_NAME
			,HLDS.QUANTITY_IN_STOCK
			,HLDS.MEMO_NO
			,HLDS.MEMO_DT
			,HLDS.DELIVERY_DT
			,HLDS.PRODUCT_CODE
			,HLDS.PARA1_NAME
			,HLDS.PARA2_NAME
			,CASE  
					WHEN HLDS.CANCELLED=1 THEN 'CANCELLED'
					WHEN DLVY.CM_ID IS NULL THEN 'CUSTOMER DELIVERY PENDING'
					WHEN DLVY.CM_ID IS NOT NULL THEN 'DELIEVERED TO CUSTOMER'
					END AS 'STATUS'
			,@NONHOLD AS 'ONHOLDCOUNT'
		FROM VW_POSTSALES_HBDPRINT HLDS
		LEFT JOIN VW_POSTSALES_SLS_DELIVERYPRINT DLVY ON HLDS.CM_ID=DLVY.CM_ID
		WHERE HLDS.DELIVERY_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
	END
	
	IF @NREPORTID=8
	BEGIN
		SELECT @NISSUED=
			   COUNT(DISTINCT ISSS.REF_HBD_ROW_ID) 
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE ISSUE_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT AND
			  ISSS.CANCELLED=0 
		--SELECT * FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		SELECT DISTINCT 
			 ISSS.ISSUE_NO
			,ISSS.ISSUE_DT
			,ISSS.AGENCY_NAME
			,ISSS.CM_NO
			,ISSS.ARTICLE_NO
			,ISSS.ARTICLE_NAME
			,ISSS.PRODUCT_CODE
			,ISSS.PARA1_NAME
			,ISSS.PARA2_NAME
			,ISSS.JOB_NAME
			,ISSS.JOB_RATE
			,1.00 AS QUANTITY
			,CASE 
				WHEN ISSS.CANCELLED=1 THEN 'CANCELLED'
				ELSE 'ISSUED'
			END AS 'STATUS'
			,@NISSUED AS 'ISSUECOUNT'
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		WHERE ISSUE_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
	END

	IF @NREPORTID=9
	BEGIN
		SELECT @NRECEIVED=
			   COUNT(DISTINCT RCPT.ROW_ID) 
		FROM VW_POSTSALES_JOBWORKRECEIPTPRINT RCPT
		JOIN VW_POSTSALES_JOBWORKISSUEPRINT ISSS ON RCPT.REF_ROW_ID=ISSS.ROW_ID 
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE RCPT.RECEIPT_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND  RCPT.CANCELLED=0	
		
		SELECT DISTINCT
			 ISNULL(RCPT.RECEIPT_NO,'') AS RECEIPT_NO
			,ISNULL(RCPT.RECEIPT_DT,'') AS RECEIPT_DT
			,ISNULL(RCPT.AGENCY_NAME,'') AS AGENCY_NAME
			,ISNULL(RCPT.CM_NO,'') AS CM_NO
			,ISNULL(RCPT.ARTICLE_NO,'') AS ARTICLE_NO
			,ISNULL(RCPT.ARTICLE_NAME,'') AS ARTICLE_NAME
			,ISNULL(RCPT.PRODUCT_CODE,'') AS PRODUCT_CODE
			,ISNULL(RCPT.PARA1_NAME,'') AS  PARA1_NAME
			,ISNULL(RCPT.PARA2_NAME,'') AS PARA2_NAME
			,ISNULL(RCPT.JOB_NAME,'') AS JOB_NAME
			,ISNULL(RCPT.JOB_RATE,'0') AS JOB_RATE
			,ISNULL(CONVERT(NUMERIC(10,2),RCPT.QUANTITY),'0') AS QUANTITY
			,CASE 
				WHEN RCPT.CANCELLED=1 THEN 'CANCELLED'
				WHEN DATEDIFF(D,ISSS.DUE_DT,RCPT.RECEIPT_DT)<= 0 THEN 'RECEIVED ON TIME'
				WHEN DATEDIFF(D,ISSS.DUE_DT,RCPT.RECEIPT_DT)>0 THEN 'RECEIVED LATE'
				WHEN RCPT.REF_ROW_ID IS NULL THEN 'PENDING'
			 END AS 'STATUS'
			,@NRECEIVED AS 'RECEIVEDCOUNT'
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		LEFT JOIN VW_POSTSALES_JOBWORKRECEIPTPRINT RCPT ON ISSS.ROW_ID=RCPT.REF_ROW_ID
		WHERE RCPT.RECEIPT_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
	END
	
	IF @NREPORTID=10 --PENDING DELIVERY REPORT
	BEGIN
	
	IF OBJECT_ID('#TEMPDB..#TEMPPENDINRECEIPT','U') IS NOT NULL
	   DROP TABLE #TEMPPENDINRECEIPT
	   
	   SELECT 
			  E.ISSUE_NO
			 ,E.ISSUE_DT
			 ,E.AGENCY_NAME
			 ,CMM.CM_NO
			 ,CONVERT(VARCHAR,CMM.CM_DT,105) AS CM_DT
			 ,ART.ARTICLE_CODE
			 ,ART.ARTICLE_NAME
			 ,SKU.PRODUCT_CODE
			 ,P1.PARA1_NAME
			 ,P2.PARA2_NAME
			 ,E.JOB_NAME
			 ,E.JOB_RATE
			 ,E.DUE_DT 
			 ,1.00 AS QUANTITY
			 ,'PENDING' AS 'STATUS'
			 --,DATEDIFF(D,@DHOLDBACKEDT,ISSS.DUE_DT) AS 'OVERDUE' 
			 --,@NISSUED AS 'ISSUECOUNT'
		  INTO #TEMPPENDINRECEIPT	 		  
		  FROM CMD01106 CMD (NOLOCK)
		  JOIN CMM01106 CMM (NOLOCK) ON CMD.CM_ID =CMM.CM_ID 
		  JOIN 
		  (
			SELECT HD.REF_CMD_ROW_ID,HD.ROW_ID,HM.MEMO_NO,
			        HD.MEMO_ID,DELIVERED,
					HD.JOB_CODE,HM.LAST_UPDATE,HD.REMARKS,DELIVERY_DT,JOB_NAME ,JOBRATE
			FROM HOLD_BACK_DELIVER_DET HD (NOLOCK) 
			JOIN HOLD_BACK_DELIVER_MST HM (NOLOCK) ON HD.MEMO_ID =HM.MEMO_ID 
			JOIN JOBS L ON HD.JOB_CODE=L.JOB_CODE 
			WHERE HM.CANCELLED=0 AND HD.DELIVERED=0
		  )HD ON HD.REF_CMD_ROW_ID=CMD.ROW_ID 	
		  JOIN 
		  (		
				SELECT F.ISSUE_NO,ROW_ID
				 ,F.ISSUE_DT
				 ,D.AGENCY_NAME
				 ,D.AGENCY_CODE 
				 ,JOB.JOB_NAME
				 ,E.JOB_RATE
				 ,E.DUE_DT 
				 ,E.REF_HBD_ROW_ID 
				FROM POST_SALES_JOBWORK_ISSUE_DET  E (NOLOCK) 
				JOIN POST_SALES_JOBWORK_ISSUE_MST  F (NOLOCK) ON E.ISSUE_ID =F.ISSUE_ID
				JOIN JOBS JOB (NOLOCK) ON JOB.JOB_CODE = E.JOB_CODE 
				JOIN PRD_AGENCY_MST D (NOLOCK) ON F.AGENCY_CODE = D.AGENCY_CODE     
				WHERE F.CANCELLED=0 
		  )E ON E.REF_HBD_ROW_ID =HD.ROW_ID	
		  LEFT JOIN
		 (
		   SELECT ROW_ID,REF_ROW_ID FROM POST_SALES_JOBWORK_RECEIPT_DET D (NOLOCK)
		   JOIN POST_SALES_JOBWORK_RECEIPT_MST M (NOLOCK) ON D.RECEIPT_ID =M.RECEIPT_ID 
		   WHERE M.CANCELLED =0
		 )	REC ON E.ROW_ID =REC.REF_ROW_ID
		  JOIN SKU (NOLOCK) SKU ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
		  JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
		  JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE 
		  JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
          WHERE REC.REF_ROW_ID IS NULL
	     AND E.DUE_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT 
		 AND (@CAGENCY_CODE ='' OR E .AGENCY_CODE =@CAGENCY_CODE)
		 AND (@CPRODUCT_CODE ='' OR SKU.PRODUCT_CODE =@CPRODUCT_CODE) 
		 
		 
		SELECT @NISSUED=
			   COUNT(DISTINCT ISSS.ISSUE_NO) 
		FROM #TEMPPENDINRECEIPT ISSS
		
		SELECT * 
		 ,DATEDIFF(D,@DHOLDBACKEDT,ISSS.DUE_DT) AS 'OVERDUE' 
			 ,@NISSUED AS 'ISSUECOUNT'
		FROM #TEMPPENDINRECEIPT ISSS
		 
	
	--EXEC SP_POSTSALEJOBWORKS 10,'2014-04-01','2015-03-31','','','',''
		--SELECT @NISSUED=
		--	   COUNT(DISTINCT ISSS.REF_HBD_ROW_ID) 
		--FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		--JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		--WHERE ISSUE_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT 
		--AND (@CAGENCY_CODE ='' OR ISSS.AGENCY_CODE =@CAGENCY_CODE)
		--AND (@CPRODUCT_CODE ='' OR ISSS.PRODUCT_CODE =@CPRODUCT_CODE )
		--AND
		--	  ISSS.CANCELLED=0 
		
		--SELECT 
		--	  ISSS.ISSUE_NO
		--	 ,ISSS.ISSUE_DT
		--	 ,ISSS.AGENCY_NAME
		--	 ,ISSS.CM_NO
		--	 ,ISSS.ARTICLE_CODE
		--	 ,ISSS.ARTICLE_NAME
		--	 ,ISSS.PRODUCT_CODE
		--	 ,ISSS.PARA1_NAME
		--	 ,ISSS.PARA2_NAME
		--	 ,ISSS.JOB_NAME
		--	 ,ISSS.JOB_RATE
		--	 ,ISSS.DUE_DT 
		--	 ,1.00 AS QUANTITY
		--	 ,'PENDING' AS 'STATUS'
		--	 ,DATEDIFF(D,@DHOLDBACKEDT,ISSS.DUE_DT) AS 'OVERDUE' 
		--	 ,@NISSUED AS 'ISSUECOUNT'
		--FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		--LEFT JOIN VW_POSTSALES_JOBWORKRECEIPTPRINT RCPT ON ISSS.ROW_ID=RCPT.REF_ROW_ID
		--WHERE 
		--ISSS.DUE_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT 
		--AND (@CAGENCY_CODE ='' OR ISSS .AGENCY_CODE =@CAGENCY_CODE)
		--AND (@CPRODUCT_CODE ='' OR ISSS.PRODUCT_CODE =@CPRODUCT_CODE )
		--AND RCPT.REF_ROW_ID IS NULL	
		
	END
		
	IF @NREPORTID=11
	BEGIN
		SELECT @NISSUED=
			   COUNT(DISTINCT ISSS.REF_HBD_ROW_ID) 
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE ISSUE_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT 
		AND (@CCUST_CODE ='' OR ISSS.CUSTOMER_CODE =@CCUST_CODE)
		AND (@CPRODUCT_CODE ='' OR ISSS.PRODUCT_CODE =@CPRODUCT_CODE )
		AND ISSS.CANCELLED=0  
		
		--SELECT * FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		SELECT DISTINCT
			 ISSS.ISSUE_NO
			,ISSS.ISSUE_DT
			,ISSS.AGENCY_NAME
			,HLDS.CUSTOMER_NAME
			,ISSS.CM_NO
			,DLVY.CM_DT
			,HLDS.MEMO_NO
			,HLDS.MEMO_DT 
			,HLDS.ARTICLE_NO
			,HLDS.ARTICLE_NAME
			,HLDS.PRODUCT_CODE
			,HLDS.PARA1_NAME
			,HLDS.PARA2_NAME
			,HLDS.JOB_NAME
			,ISSS.JOB_RATE
			,1.00 AS QUANTITY
			,'PENDING' AS 'STATUS'
			,DATEDIFF(D,@DHOLDBACKEDT,HLDS.DELIVERY_DT) AS 'OVERDUE' 
			,HLDS.DELIVERY_DT
			
		FROM VW_POSTSALES_HBDPRINT HLDS
		LEFT JOIN VW_POSTSALES_SLS_DELIVERYPRINT DLVY ON HLDS.CM_ID=DLVY.CM_ID 
		LEFT JOIN VW_POSTSALES_JOBWORKISSUEPRINT ISSS ON HLDS.ROW_ID=ISSS.REF_HBD_ROW_ID
		WHERE HLDS.DELIVERY_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
		AND (@CCUST_CODE ='' OR HLDS.CUSTOMER_CODE =@CCUST_CODE)
		AND (@CPRODUCT_CODE ='' OR HLDS.PRODUCT_CODE =@CPRODUCT_CODE )
		AND DLVY.MEMO_DT IS NULL
	END
	
	IF @NREPORTID=12
	BEGIN
		SELECT DISTINCT
		   JM.AGENCY_NAME
		  ,JOBS.JOB_NAME
		  ,AJ.JOB_RATE
		FROM PRD_AGENCY_MST JM
		JOIN AGENCY_JOBS AJ ON JM.AGENCY_CODE=AJ.AGENCY_CODE
		JOIN JOBS ON AJ.JOB_CODE=JOBS.JOB_CODE
		WHERE JM.INACTIVE=0
		 AND (@CAGENCY_CODE ='' OR JM.AGENCY_CODE=@CAGENCY_CODE)
		AND (@CJOB_CODE ='' OR JOBS.JOB_CODE=@CJOB_CODE)
	END
	
	IF @NREPORTID=13 --ON TIME DELIVERY REPORT (VENDOR WISE)
	BEGIN
		SELECT DISTINCT
		 AGENCY_NAME
		,SUM(JOB_RATE) AS NONPAYABLEAMT
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		WHERE ISSS.ISSUE_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT 
		GROUP BY AGENCY_NAME
	END
	
	IF @NREPORTID=14
	BEGIN
	--VENDOR ONTIME DELIVERY REPORT 
	--EXEC SP_POSTSALEJOBWORKS 14,'2011-03-11 00:00:00.000','2013-03-13 00:00:00.000'
	
	--SELECT ISSUE_NO,ISSUE_DT,DUE_DT,CM_NO,* FROM VW_POSTSALES_JOBWORKISSUEPRINT WHERE ISSUE_NO='WH00000053' 
	--SELECT * FROM  VW_POSTSALES_JOBWORKRECEIPTPRINT WHERE CM_NO='WH00-0000049'   
		SELECT DISTINCT
			  ISSS.ISSUE_NO AS JWISSUENO
			 ,ISSS.ISSUE_DT AS JWISSUEDT
			 ,ISSS.AGENCY_NAME AS AGENCYNAME
			 ,ISSS.CM_NO AS BILLNUMBER
			 ,ISSS.PRODUCT_CODE
			 ,ISSS.ARTICLE_CODE
			 ,ISSS.ARTICLE_NAME
			 ,ISSS.CM_NO
			 ,ISSS.ISSUE_NO
			 ,ISSS.ISSUE_DT
			 ,ISSS.PARA1_NAME
			 ,ISSS.PARA2_NAME
			 ,ISSS.JOB_NAME
			 ,ISSS.JOB_RATE
			 ,1.00 AS QUANTITY
			 ,ISSS.DUE_DT
			 ,RCPT.RECEIPT_DT
			 ,CASE
				WHEN RCPT.RECEIPT_DT>ISSS.DUE_DT THEN 'LATE' 
				WHEN RCPT.RECEIPT_DT<=ISSS.DUE_DT THEN 'ONTIME'
				WHEN ISNULL(RCPT.RECEIPT_DT,'')='' THEN 'OVERDUE' 
			  END AS 'STATUS'
			 --,DATEDIFF(D,DLVY.MEMO_DT,HLDS.DELIVERY_DT)
			 ,CASE 
					WHEN RCPT.RECEIPT_DT>ISSS.DUE_DT THEN DATEDIFF(D,RCPT.RECEIPT_DT,ISSS.DUE_DT) 
					WHEN RCPT.RECEIPT_DT<=ISSS.DUE_DT THEN ''
					WHEN ISNULL(RCPT.RECEIPT_DT,'')='' THEN DATEDIFF(D,@DHOLDBACKEDT,ISSS.DUE_DT)
					END AS 'NOOFDAYS' 
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS 
		LEFT JOIN VW_POSTSALES_JOBWORKRECEIPTPRINT RCPT ON ISSS.ROW_ID=RCPT.REF_ROW_ID
		WHERE ISSS.DUE_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT 
			AND ISSS.CANCELLED=0 AND RCPT.CANCELLED=0
			AND (@CAGENCY_CODE ='' OR ISSS.AGENCY_CODE=@CAGENCY_CODE)
			--AND (@CJOB_CODE ='' OR ISSS.JOB_CODE=@CAGENCY_CODE)
		/*CUSTOMER ONTIME DELIVERY REPORT
		SELECT 
			  ISSS.ISSUE_NO AS JWISSUENO
			 ,ISSS.ISSUE_DT AS JWISSUEDT
			 ,ISSS.AGENCY_NAME AS AGENCYNAME
			 ,ISSS.CM_NO AS BILLNUMBER
			 ,ISSS.PRODUCT_CODE
			 ,ISSS.ARTICLE_CODE
			 ,ISSS.ARTICLE_NAME
			 ,ISSS.CM_NO
			 ,ISSS.ISSUE_NO
			 ,ISSS.ISSUE_DT
			 ,ISSS.PARA1_NAME
			 ,ISSS.PARA2_NAME
			 ,ISSS.JOB_NAME
			 ,ISSS.JOB_RATE
			 ,1.00 AS QUANTITY
			 ,HLDS.DELIVERY_DT
			 ,DLVY.MEMO_DT
			 ,CASE
				WHEN DLVY.MEMO_DT>HLDS.DELIVERY_DT THEN 'LATE' 
				WHEN DLVY.MEMO_DT<=HLDS.DELIVERY_DT THEN 'ONTIME'
				WHEN ISNULL(DLVY.MEMO_DT,'')='' THEN 'OVERDUE' 
			  END AS 'STATUS'
			 --,DATEDIFF(D,DLVY.MEMO_DT,HLDS.DELIVERY_DT)
			 ,CASE 
					WHEN DLVY.MEMO_DT>HLDS.DELIVERY_DT THEN DATEDIFF(D,DLVY.MEMO_DT,HLDS.DELIVERY_DT) 
					WHEN DLVY.MEMO_DT<=HLDS.DELIVERY_DT THEN ''
					WHEN ISNULL(DLVY.MEMO_DT,'')='' THEN DATEDIFF(D,@DHOLDBACKEDT,HLDS.DELIVERY_DT)
					END AS 'NOOFDAYS' 
		FROM VW_POSTSALES_HBDPRINT HLDS
		LEFT JOIN VW_POSTSALES_SLS_DELIVERYPRINT DLVY ON HLDS.CM_ID=DLVY.CM_ID
		JOIN VW_POSTSALES_JOBWORKISSUEPRINT ISSS ON HLDS.ROW_ID=ISSS.REF_HBD_ROW_ID
		WHERE HLDS.DELIVERY_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
		AND HLDS.CANCELLED=0 AND ISSS.CANCELLED=0
		*/
		/*CHANGED ON 11 AUG 2012
		SELECT 
			  ISSS.AGENCY_NAME
			 ,ISSS.PRODUCT_CODE
			 ,ISSS.ARTICLE_NAME
			 ,ISSS.CM_NO
			 ,ISSS.ISSUE_NO
			 ,HLDS.DELIVERY_DT
			 ,DLVY.MEMO_DT
			 --,DATEDIFF(D,DLVY.MEMO_DT,HLDS.DELIVERY_DT)
			 ,CASE  
					WHEN DLVY.MEMO_DT>HLDS.DELIVERY_DT THEN DATEDIFF(D,DLVY.MEMO_DT,HLDS.DELIVERY_DT) 
					WHEN DLVY.MEMO_DT<=HLDS.DELIVERY_DT THEN 0
					ELSE ''
					END AS 'LATEDAYS'
		FROM VW_POSTSALES_HBDPRINT HLDS
		LEFT JOIN VW_POSTSALES_SLS_DELIVERYPRINT DLVY ON HLDS.CM_ID=DLVY.CM_ID
		JOIN VW_POSTSALES_JOBWORKISSUEPRINT ISSS ON HLDS.ROW_ID=ISSS.REF_HBD_ROW_ID
		WHERE HLDS.DELIVERY_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
		*/
	END
	
	IF @NREPORTID=15 --ALL CANCELLATIONS
	BEGIN
		--HOLD CANCELLATIONS
		SELECT @NONHOLD=
				COUNT(HLDS.CM_NO)
		FROM VW_POSTSALES_HBDPRINT HLDS
		WHERE HLDS.CANCELLED=1
		AND	HLDS.MEMO_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT  
		
		SELECT DISTINCT
				 HLDS.CM_NO	 
				,HLDS.CUSTOMER_NAME
				,HLDS.ARTICLE_NO
				,HLDS.ARTICLE_NAME
				,HLDS.JOB_NAME
				,1.00 AS QUANTITY
				,HLDS.MEMO_NO
				,HLDS.MEMO_DT
				,HLDS.DELIVERY_DT
				,HLDS.PRODUCT_CODE
				,HLDS.PARA1_NAME
				,HLDS.PARA2_NAME
				,@NONHOLD AS TOTALCANCELLED 
				,'CANCELLED' AS 'STATUS'
		FROM VW_POSTSALES_HBDPRINT HLDS 
		WHERE HLDS.CANCELLED=1 AND
		HLDS.MEMO_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
		
		--ISSUE CANCELLATIONS
		SELECT @NISSUED=
				COUNT(ISSS.ISSUE_NO)
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.CM_NO=HLDS.CM_NO
		WHERE ISSS.CANCELLED=1
		AND	HLDS.MEMO_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT  
		
		
		SELECT 
			 ISSS.ISSUE_NO AS JWISSUENO
			,ISSS.ISSUE_DT AS JWISSUEDT
			,ISSS.AGENCY_NAME AS AGENCYNAME
			,ISSS.CM_NO AS BILLNUMBER
			,ISSS.ARTICLE_NO
			,ISSS.ARTICLE_NAME
			,ISSS.PRODUCT_CODE
			,ISSS.PARA1_NAME
			,ISSS.PARA2_NAME
			,ISSS.JOB_NAME
			,ISSS.JOB_RATE
			,1.00 AS QUANTITY
			,@NISSUED AS TOTALCANCELLED
			,ISSS.DUE_DT 
			,'CANCELLED' AS 'STATUS'
		FROM VW_POSTSALES_JOBWORKISSUEPRINT ISSS
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.CM_NO=HLDS.CM_NO
		WHERE ISSS.CANCELLED=1
		AND	HLDS.MEMO_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT 
		
		--RECEIVE CANCELLATIONS
		SELECT @NRECEIVED=
			   COUNT(RCPT.ROW_ID) 
		FROM VW_POSTSALES_JOBWORKRECEIPTPRINT RCPT
		JOIN VW_POSTSALES_JOBWORKISSUEPRINT ISSS ON RCPT.REF_ROW_ID=ISSS.ROW_ID 
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE HLDS.MEMO_DT BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND  RCPT.CANCELLED=1
				
		--SELECT * FROM VW_POSTSALES_JOBWORKRECEIPTPRINT
		SELECT 
			 ISNULL(RCPT.RECEIPT_NO,'') AS RECEIPT_NO
			,ISNULL(RCPT.RECEIPT_DT,'') AS RECEIPT_DT
			,ISNULL(RCPT.AGENCY_NAME,'') AS AGENCY_NAME
			,ISNULL(RCPT.CM_NO,'') AS CM_NO
			,ISNULL(RCPT.ARTICLE_NO,'') AS ARTICLE_NO
			,ISNULL(RCPT.ARTICLE_NAME,'') AS ARTICLE_NAME
			,ISNULL(RCPT.PRODUCT_CODE,'') AS PRODUCT_CODE
			,ISNULL(RCPT.PARA1_NAME,'') AS  PARA1_NAME
			,ISNULL(RCPT.PARA2_NAME,'') AS PARA2_NAME
			,ISNULL(RCPT.JOB_NAME,'') AS JOB_NAME
			,ISNULL(RCPT.JOB_RATE,'0') AS JOB_RATE
			,ISNULL(CONVERT(NUMERIC(10,2),RCPT.QUANTITY),'0') AS QUANTITY 
			,ISNULL(ISSS.DUE_DT,'') AS DUE_DT
			--,DATEDIFF(D,ISSS.DUE_DT,RCPT.RECEIPT_DT)
			,ISNULL(RCPT.RECEIPT_DT,'') AS RECEIPT_DT
			,ISNULL(RCPT.REMARKS,'') AS REMARKS
			,@NRECEIVED AS TOTALCANCELLED
			--,ISNULL(ISSS.ROW_ID,'') AS 	ROW_ID			
			--,ISNULL(RCPT.REF_ROW_ID,'') AS REF_ROW_ID
			,'CANCELLED' AS 'STATUS'
		FROM VW_POSTSALES_JOBWORKRECEIPTPRINT RCPT
		JOIN VW_POSTSALES_JOBWORKISSUEPRINT ISSS ON RCPT.REF_ROW_ID=ISSS.ROW_ID 
		JOIN VW_POSTSALES_HBDPRINT HLDS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE HLDS.MEMO_DT BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
			AND  RCPT.CANCELLED=1	
		
		--DELIVERY CANCELLATION
		SELECT @NDELIVERED=
				 COUNT(DLVY.MEMO_NO)
		FROM VW_POSTSALES_SLS_DELIVERYPRINT DLVY
		JOIN VW_POSTSALES_HBDPRINT HLDS ON DLVY.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE HLDS.MEMO_DT  BETWEEN  @DHOLDBACKSDT AND @DHOLDBACKEDT
		AND DLVY.CANCELLED=1
		--SELECT * FROM VW_POSTSALES_SLS_DELIVERYPRINT
		SELECT 
			 DLVY.CUSTOMER_NAME
			,DLVY.CM_NO 
			,DLVY.ROW_ID 
			,DLVY.MEMO_DT
			,DLVY.DELIVERED_TO
			,DLVY.JOB_NAME
			,DLVY.QUANTITY_IN_STOCK
			,DLVY.PARA1_NAME
			,DLVY.PARA2_NAME
			,DLVY.ARTICLE_NAME 
			,DLVY.MEMO_NO 
			,1.00 AS QUANTITY
			,DLVY.PRODUCT_CODE 
			,@NDELIVERED AS TOTALCANCELLED
			,'CANCELLED' AS 'STATUS'
		FROM VW_POSTSALES_SLS_DELIVERYPRINT DLVY
		JOIN VW_POSTSALES_HBDPRINT HLDS ON DLVY.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE HLDS.MEMO_DT BETWEEN @DHOLDBACKSDT AND @DHOLDBACKEDT
		AND DLVY.CANCELLED=1	
		 
	END
	
END
