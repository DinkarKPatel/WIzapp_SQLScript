create PROCEDURE SP_MERGE_MIRROR_DOCIRT_DATA        
(        
	 @CMEMOID VARCHAR(50),        
	 @CERRMSG VARCHAR(MAX) OUTPUT        
)        
AS        
BEGIN 
 
 
 
 SET NOCOUNT ON        
 
 DECLARE @DTSQL NVARCHAR(MAX),@CSOURCEDB VARCHAR(200),@CTMP_TABLENAME VARCHAR(200),        
   @CJOINSTR VARCHAR(MAX),@CERRORMSG VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100),        
   @CTABLENAME VARCHAR(200),@CERRMSGOUT VARCHAR(MAX),@CSTEP VARCHAR(20),@CKEYFIELD VARCHAR(100)        
   ,@CKEYFIELD1 VARCHAR(100),@CMERGEDB VARCHAR(50)
   ,@INV_MODE INT,@CFINYEAR VARCHAR(10),@MRR_NO VARCHAR(50),@INV_ID VARCHAR(50)      
   ,@TEMP_TABLE1 VARCHAR(20),@CCMD NVARCHAR(MAX), @CCURDEPTID CHAR(2),@CHODEPTID CHAR(2),
   @BSOURCEPURLOC BIT,@BTARGETPURLOC BIT,@BGENERATEAUTOSERIES BIT,@CSOURCELOCID CHAR(2), @BHOLOC BIT,@BSKU_OH BIT,
   @NTARGETLOCTYPE INT,@BMSTINSERTONLY BIT,@CMEMONOPREFIX VARCHAR(100),@CPARTYDEPTID VARCHAR(5),
   @BCHALLANRECEIVEDPREV BIT,@CTABLESSTR VARCHAR(MAX),@BGETCHALLANTHRUMIRROR BIT,@CSOURCETEMPTABLE VARCHAR(500),
   @CTMPINDTABLE VARCHAR(500),@NVERSIONNO INT,@NINVMODE INT,@CFILTERCONDITION VARCHAR(MAX),@CCMDOUTPUT VARCHAR(MAX),@CFILTERCONDITION1 VARCHAR(MAX),
   @BSENDPURINFOLOC BIT
   ,@NLOCTYPE NUMERIC(10),@bFlowPP BIT
  
 
 BEGIN TRY        
  
  SET @CSTEP=2
    	 
  SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'
  SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'
  

  SET @CSOURCEDB=''
  --SET @CSTEP=5	
  --SET @CSOURCEDB=DB_NAME()+'.DBO.'
          
  SET @CTABLESUFFIX=REPLACE(@CMEMOID,'-','_') 
  SET @CFILTERCONDITION=''
  SET @CTMP_TABLENAME='DOCIRT_IRM01106_MIRROR'
  
  SELECT TOP 1 @NVERSIONNO=MAX(VERSION_NO) FROM DOCIRT_IRM01106_MIRROR WHERE IRM_MEMO_ID=@CMEMOID
    
  SELECT @CFILTERCONDITION=' A.IRM_MEMO_ID='''+@CMEMOID+'''' 
		 
     
  SET @CCMD=N'SELECT @CPARTYDEPTID=DEPT_ID FROM '+@CTMP_TABLENAME+' A WHERE '+@CFILTERCONDITION
  
  PRINT @CCMD
  EXEC SP_EXECUTESQL @CCMD,N'@CPARTYDEPTID VARCHAR(5) OUTPUT',@CPARTYDEPTID OUTPUT
  
    
  IF ISNULL(@CMEMOID,'')=''
	GOTO EXIT_PROC     
  
 -- IF @CPARTYDEPTID<>@CCURDEPTID
 -- BEGIN
	--SET @CERRMSG = 'THE CHALLAN NO.:'+RIGHT(@CMEMOID,10)+' BELONGS TO LOCATION ID :'+@CPARTYDEPTID+' OTHER THAN CURRENT LOCATION ID:'+@CCURDEPTID		
	--GOTO EXIT_PROC
 -- END
  
  SELECT TOP 1 @CSOURCELOCID=DEPT_ID,@BSOURCEPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=LEFT(@CMEMOID,2)	
  SELECT TOP 1 @BTARGETPURLOC=PUR_LOC,@NTARGETLOCTYPE=LOC_TYPE,@BSENDPURINFOLOC=UPD_PURINFO
  FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID
  
  SET @BHOLOC=0
  IF @CCURDEPTID=@CHODEPTID
	  SET @BHOLOC=1
  
  SET @CSTEP = 10        
  SET @CMERGEDB=DB_NAME()+'.DBO.'      
  SET @CERRORMSG=''        
 
 	
  IF @BHOLOC=0
	BEGIN TRANSACTION        
	

  SELECT @CFILTERCONDITION=' B.DOCIRT_MEMO_ID='''+@CMEMOID+''''
  

  exec SP3S_REMOVE_MIRROR_DULICATE_MSTERS @CMEMOID,@NVERSIONNO,'DOCIRT'
    
	SET @CTABLENAME='SECTIONM'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='SECTION_CODE'
	SET @CSTEP=20
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1	
         ,@CFILTERCONDITION=@CFILTERCONDITION 	
	

	
	SET @CSTEP=30
	SET @CTABLENAME='SECTIOND'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='SUB_SECTION_CODE'
	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1 
         ,@CFILTERCONDITION=@CFILTERCONDITION    
         
    SET @CSTEP=40
	SET @CTABLENAME='PARA1'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA1_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
              
    SET @CSTEP=50
	SET @CTABLENAME='PARA2'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA2_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
       
    SET @CSTEP=60
	SET @CTABLENAME='PARA3'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA3_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
         
    SET @CSTEP=70
	SET @CTABLENAME='PARA4'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA4_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
         
    SET @CSTEP=80
	SET @CTABLENAME='PARA5'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA5_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
   
    SET @CSTEP=90
	SET @CTABLENAME='PARA6'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA6_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1 
         ,@CFILTERCONDITION=@CFILTERCONDITION 
         
    SET @CSTEP=92
	SET @CTABLENAME='PARA7'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA7_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1 
         ,@CFILTERCONDITION=@CFILTERCONDITION    
         
         

    	IF EXISTS (SELECT TOP 1 'U' FROM DOCIRT_HSN_MST_MIRROR A (NOLOCK)
		LEFT JOIN HSN_MST B (NOLOCK) ON A.HSN_CODE =B.HSN_CODE WHERE B.HSN_CODE IS NULL AND A.DOCIRT_MEMO_ID =@CMEMOID 
		 )
		begin
		--hsn changes--
			SET @CSTEP=95
			 SET @CTABLENAME='HSN_MST'
			SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
			SET @CKEYFIELD='HSN_CODE'
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			  ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0        
			  ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION      
		  
		  
			SET @CSTEP=174
			SET @CTABLENAME='HSN_DET'
			SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
			SET @CKEYFIELD='HSN_CODE'
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='WEF',@CKEYFIELD3=''        
			  ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0        
			  ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION      

        end 
		--end of hsn


         
    SET @CSTEP=100
	SET @CTABLENAME='UOM'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='UOM_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION     
    
   

	     
    SET @CSTEP=110
	SET @CTABLENAME='ARTICLE'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='ARTICLE_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION          
                  

	
	SET @CSTEP=120
	DECLARE @NCOUNT INT,@BLOOP INT,@CCMD1 NVARCHAR(MAX)
	SET @NCOUNT=25
	SET @BLOOP=1
	WHILE (@BLOOP <=@NCOUNT )
	BEGIN
	      
			DECLARE @CATTR_KEY_NAME VARCHAR(100)

			   
		  
			SET @CTABLENAME='ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST'

			SET @CSTEP=130
			EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

			SET @CTMP_TABLENAME='DOCIRT_ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST_MIRROR'
			SET @CKEYFIELD='ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_KEY_CODE'



			SET @CATTR_KEY_NAME ='ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_KEY_NAME'
					
			SET @CSTEP=140
			EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1		

			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
				,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
				,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
				,@BALWAYSUPDATE=1
				,@CFILTERCONDITION=@CFILTERCONDITION
			
	       
			SET @BLOOP=@BLOOP +1  			
	END
   
	SET @CSTEP=150
	SET @CTABLENAME='ARTICLE_FIX_ATTR'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='ARTICLE_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
		 
         
	SET @CSTEP=160 --- UPDATE DOCWSL_SKU_MIRROR FROM DOCIRT SKU MIRROR IF PRODUCT_CODE EXISTS
	SET @DTSQL=N'UPDATE B SET MRP=A.MRP,PARA1_CODE=B.PARA1_CODE,PARA2_CODE=B.PARA2_CODE,PARA3_CODE=B.PARA3_CODE,
	            PARA4_CODE=B.PARA4_CODE,PARA5_CODE=B.PARA5_CODE,PARA6_CODE=B.PARA6_CODE,HSN_CODE=B.HSN_CODE,EXPIRY_DT=B.EXPIRY_DT,
	            ARTICLE_CODE=B.ARTICLE_CODE 
	            FROM  DOCIRT_SKU_MIRROR A WITH (ROWLOCK)
		        JOIN DOCWSL_SKU_MIRROR B WITH (ROWLOCK)  ON A.PRODUCT_CODE=B.PRODUCT_CODE
		        WHERE A.DOCIRT_MEMO_ID='''+@CMEMOID+''''
				      
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	
	SET @CSTEP=170  --- UPDATE DOCWSL_PRT_MIRROR FROM DOCIRT SKU MIRROR IF PRODUCT_CODE EXISTS
	SET @DTSQL=N'UPDATE B SET MRP=A.MRP,PARA1_CODE=B.PARA1_CODE,PARA2_CODE=B.PARA2_CODE,PARA3_CODE=B.PARA3_CODE,
	            PARA4_CODE=B.PARA4_CODE,PARA5_CODE=B.PARA5_CODE,PARA6_CODE=B.PARA6_CODE,HSN_CODE=B.HSN_CODE,EXPIRY_DT=B.EXPIRY_DT,
	            ARTICLE_CODE=B.ARTICLE_CODE 
	            FROM  DOCIRT_SKU_MIRROR A WITH (ROWLOCK)
		        JOIN DOCPRT_SKU_MIRROR B WITH (ROWLOCK)  ON A.PRODUCT_CODE=B.PRODUCT_CODE
		        WHERE A.DOCIRT_MEMO_ID='''+@CMEMOID+''''
				      
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
   
   SET @CSTEP=180 	
   update DOCIRT_IRM01106_MIRROR set USER_CODE='0000000',EDT_USER_CODE='0000000' where IRM_MEMO_ID=@CMEMOID							  
   
   IF EXISTS(SELECT TOP 1'U' FROM DOCIRT_IRM01106_MIRROR WHERE IRM_MEMO_ID=@CMEMOID AND INS_MIS_PC_AT_LOC=0)
   BEGIN
      SET @CSTEP=185		
	SET @DTSQL=N'DELETE A FROM DOCIRT_SKU_MIRROR A WITH (ROWLOCK)
				 LEFT OUTER JOIN SKU B WITH (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
				 WHERE B.PRODUCT_CODE IS NULL AND  
				 A.DOCIRT_MEMO_ID='''+@CMEMOID+''''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
   END
	
	
										  

    
  SELECT @CFILTERCONDITION=' B.IRM_MEMO_ID='''+@CMEMOID+''''
  	
       SET @CSTEP=190
	SET @CTABLENAME='IRM01106'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='IRM_MEMO_ID'
	SET @CSTEP=365110
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							 

							  
	
	SET @CSTEP=200
	SET @CTABLENAME='IRD01106'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='IRM_MEMO_ID'
	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
							  
							  
    SELECT @NLOCTYPE=LOC_TYPE,@BFLOWPP=UPD_PURINFO FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID
	IF @NLOCTYPE=2 OR @BFLOWPP=0
	BEGIN
		SET @CSTEP=210
		SET @DTSQL=N'UPDATE A SET AC_CODE=ISNULL(B.AC_CODE,''0000000000'')
		,A.PURCHASE_PRICE=0,A.INV_NO='''',A.INV_DT='''',A.CHALLAN_NO='''',A.RECEIPT_DT='''',FORM_ID=''0000000''
		 FROM DOCIRT_SKU_MIRROR A WITH (ROWLOCK)
		 LEFT OUTER JOIN SKU B WITH (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
		 '
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL	
	END
	
	SET @CSTEP=220
	SET @DTSQL=N'UPDATE A SET AC_CODE=''0000000000'' FROM DOCIRT_SKU_MIRROR A WITH (ROWLOCK)
				 WHERE AC_CODE NOT IN (SELECT AC_CODE FROM LM01106)'
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL	
	
  SELECT @CFILTERCONDITION=' B.DOCIRT_MEMO_ID='''+@CMEMOID+''''
  	
	
	SET @CSTEP=230
	SET @CTABLENAME='SKU'
	SET @CTMP_TABLENAME='DOCIRT_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PRODUCT_CODE'


	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
								  
							  
	

	IF  ISNULL(@BHOLOC,'')=0
	BEGIN
	    SET @CSTEP=240
		SET @DTSQL=N' UPDATE a set MRP = B.MRP,
						  WS_PRICE=B.WS_PRICE,
						  ARTICLE_CODE=B.ARTICLE_CODE,
						  PARA1_CODE=B.PARA1_CODE,
						  PARA2_CODE=B.PARA2_CODE,
						  PARA3_CODE=B.PARA3_CODE,
						  PARA4_CODE=B.PARA4_CODE,
						  PARA5_CODE=B.PARA5_CODE,
						  PARA6_CODE=B.PARA6_CODE,
						  LAST_UPDATE=GETDATE(),
						  HSN_CODE =b.HSN_CODE,
						  EXPIRY_DT =b.EXPIRY_DT,
						  VENDOR_EAN_NO =b.VENDOR_EAN_NO,
						  FIX_MRP=b.fix_mrp,
						  BARCODE_CODING_SCHEME=b.BARCODE_CODING_SCHEME,
						  A.product_name=b.product_name
		FROM  SKU A (NOLOCK)
		JOIN DOCIRT_SKU_MIRROR B (NOLOCK) ON B.PRODUCT_CODE = LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))
		JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
		WHERE B.DOCIRT_MEMO_ID='''+@CMEMOID+''' 
		AND ISNULL(ART.PERISHABLE ,0)=0
		AND CHARINDEX (''@'',A.PRODUCT_CODE)<>0'
		PRINT @DTSQL
		exec sp_executesql @DTSQL

	END
	
	SET @CSTEP=250			
	EXEC SP3S_UPDATE_SKUNAMES @CMEMOID,'IRR'
	
	SET @CSTEP=260			

	TRUNCATE TABLE DOCIRT_IRD01106_MIRROR
	truncate table DOCIRT_IRM01106_MIRROR
	truncate table DOCIRT_SECTIONM_MIRROR
	truncate table DOCIRT_SECTIOND_MIRROR
	truncate table DOCIRT_PARA1_MIRROR
	truncate table DOCIRT_PARA2_MIRROR
	truncate table DOCIRT_PARA3_MIRROR
	truncate table DOCIRT_PARA4_MIRROR
	truncate table DOCIRT_PARA5_MIRROR
	truncate table DOCIRT_PARA6_MIRROR
	truncate table DOCIRT_ARTICLE_MIRROR
	truncate table DOCIRT_UOM_MIRROR
	truncate table DOCIRT_ART_DET_MIRROR
	truncate table DOCIRT_ART_PARA1_MIRROR
	truncate table DOCIRT_ARTicle_fix_attr_MIRROR
	truncate table DOCIRT_SKU_MIRROR

	truncate table DOCIRT_HSN_DET_MIRROR
	truncate table DOCIRT_HSN_MST_MIRROR
	truncate table DOCIRT_para7_MIRROR
	
	 
    					
 END TRY        
 BEGIN CATCH
  PRINT 'CATCH START'       
  SET @CERRMSG='P:SP_MERGE_MIRROR_DOCIRT_DATA, STEP:'+LTRIM(RTRIM(@CSTEP))+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
 END CATCH        
        
EXIT_PROC:   

     
 IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0        
 BEGIN 
	 IF @BHOLOC=0       
	 BEGIN
		COMMIT TRANSACTION
	END	
		
 END        
 ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0 
 BEGIN 
	 IF @BHOLOC=0
		ROLLBACK        
 END
  
		


END 
------ END OF CREATING PROCEDURE - SP_MERGE_MIRROR_DOCIRT_DATA

