CREATE PROCEDURE SP3S_GETCREDITBILLS_PENDING
(
	@CCUSTOMER_CODE		VARCHAR(50),
	@CREFMEMOID			VARCHAR(50),
	@CBILLNO			VARCHAR(50)
)
AS
BEGIN

	SELECT A.CUSTOMER_CODE,C.USER_CUSTOMER_CODE+'-'+ C.CUSTOMER_FNAME+' '+C.CUSTOMER_LNAME AS CUSTOMER_NAME,
    ISNULL(D1.RECEIPT_AMOUNT,0) AS PENDING,(B.CREDIT_AMOUNT-ISNULL(D.RECEIPT_AMOUNT,0)) AS PENDING_ORG,
    ISNULL(D.RECEIPT_AMOUNT,0)+ISNULL(D2.RECEIPT_AMOUNT,0) AS RECEIPT_AMOUNT, 
	A.CM_NO,CAST((CASE WHEN ISNULL(D1.RECEIPT_AMOUNT,0)<>0 THEN 1 ELSE 0 END) AS BIT) AS CHK,A.CM_ID,
	B.CREDIT_AMOUNT,A.CM_DT
    FROM CMM01106 A
    JOIN VW_BILL_PAYMODE B ON B.MEMO_ID = A.CM_ID AND XN_TYPE = 'SLS'
    JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
    LEFT OUTER JOIN 
    (	
		SELECT A1.CM_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT]
		FROM CMM_CREDIT_RECEIPT A1
		JOIN CMM01106 B1 ON B1.CM_ID=A1.CM_ID 
		JOIN ARC01106 B2 ON B2.ADV_REC_ID=A1.ADV_REC_ID
		WHERE (B1.CANCELLED=0 AND B2.CANCELLED=0) 
		AND A1.ADV_REC_ID<>@CREFMEMOID
		GROUP BY A1.CM_ID 
	)D ON D.CM_ID = A.CM_ID
	LEFT OUTER JOIN 
    (	
		SELECT A1.CM_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT]
		FROM CMM_CREDIT_RECEIPT A1
		JOIN ARC01106 B1 ON B1.ADV_REC_ID=A1.ADV_REC_ID 
		JOIN CMM01106 B2 ON B2.CM_ID=A1.CM_ID
		WHERE B1.CANCELLED=0 AND B2.CANCELLED=0 AND A1.ADV_REC_ID=@CREFMEMOID
		GROUP BY A1.CM_ID 
	)D1 ON D1.CM_ID = A.CM_ID
	
	LEFT OUTER JOIN
	 (
		 SELECT A.ADJ_MEMO_ID AS [CM_ID],SUM(ABS(ISNULL(A.AMOUNT,0))) AS RECEIPT_AMOUNT 
		 FROM PAYMODE_XN_DET  A
		  JOIN CMM01106 B ON B.CM_ID=A.MEMO_ID
		 JOIN CMM01106 C ON C.CM_ID=A.ADJ_MEMO_ID
		 WHERE B.CANCELLED=0 AND C.CANCELLED=0 AND A.XN_TYPE='SLS'
		 AND B.CUSTOMER_CODE = (CASE WHEN ISNULL(@CCUSTOMER_CODE,'')='' THEN B.CUSTOMER_CODE ELSE  ISNULL(@CCUSTOMER_CODE,'') END) 
		 AND A.PAYMODE_CODE='CMR0001'
		 GROUP BY A.ADJ_MEMO_ID
	 ) D2 ON D2.CM_ID=A.CM_ID
	 
	 
    WHERE A.CANCELLED=0 AND ISNULL(C.BILL_BY_BILL,0)=1 
    AND A.CUSTOMER_CODE = (CASE WHEN ISNULL(@CCUSTOMER_CODE,'')='' THEN A.CUSTOMER_CODE ELSE  ISNULL(@CCUSTOMER_CODE,'') END)  
    AND CREDIT_AMOUNT > 0 
    AND (B.CREDIT_AMOUNT-(ISNULL(D.RECEIPT_AMOUNT,0)+ISNULL(D2.RECEIPT_AMOUNT,0)) <> 0)
    AND A.location_Code =(SELECT VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID' )
	AND (A.CM_NO LIKE @CBILLNO OR A.CM_ID LIKE @CBILLNO)


	
	
	
	
END
