CREATE PROCEDURE   SP_PRD_MATERIAL_RECEIVE_PRINT
(
 @CRECEIPT_ID VARCHAR(100)
)
AS
BEGIN
    
   SELECT COM.COMPANY_NAME,COM.ADDRESS1 AS COM_ADDRESS1,COM.ADDRESS2 AS COM_ADDRESS2,COM.CITY COM_CITY,COM.PHONES_FAX,COM.LOGO_PATH,
   C.AGENCY_NAME,LM.ADDRESS0,LM.ADDRESS1,LM.ADDRESS2,CITY.CITY AS AG_CITY,
   B.MEMO_NO AS RECEIPT_NO,B.MEMO_DT AS RECEIPT_DT,
   JOBS.JOB_NAME,
   ROW_NUMBER() OVER(ORDER BY A.MEMO_ID) AS SR, 
   MST.MEMO_NO AS ORDER_NO,
   AR.ARTICLE_NO AS FG_ARTICLE_NO,
   AR.ARTICLE_NAME AS FG_ARTICLE_NAME,
   P1.PARA1_NAME,B.REMARKS,
   ORD.QUANTITY AS QTY,
   ORD.RATE,
   ORD.BILL_RATE-ISNULL(ORD.RATE,0) AS VARIATION,
   ORD.AMOUNT,
   B.SUBTOTAL,
   B.DISCOUNT_AMOUNT,
   B.OTHERCHARGES,
   B.NET_AMOUNT
   FROM PRD_AGENCY_ROW_MATERIAL_RECEIPT_DET A  
   JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID
   JOIN
   (
    SELECT B.JOB_CODE,A.REF_MATERIAL_ROW_ID , A.MEMO_ID,B.ORDER_ID,
           SUM(A.QUANTITY) AS QUANTITY,
           SUM(A.RATE) AS RATE,
           SUM(A.BILL_RATE) AS BILL_RATE,
           SUM(A.AMOUNT) AS AMOUNT
    FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A  
    JOIN  
    (  
     SELECT A.JOB_CODE, A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID FROM PRD_AGENCY_ISSUE_MATERIAL_DET A
     JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID 
     WHERE CANCELLED =0
        
     UNION   
     SELECT A.JOB_CODE,A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID FROM PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING  A
      JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID 
     WHERE CANCELLED =0  
    ) B ON A.REF_ROW_ID=B.ROW_ID  
    GROUP BY B.JOB_CODE,A.REF_MATERIAL_ROW_ID ,A.MEMO_ID,B.ORDER_ID  
   )ORD ON ORD.MEMO_ID=B.MEMO_ID  
   AND ORD.REF_MATERIAL_ROW_ID =A.ROW_ID 
   JOIN PRD_AGENCY_MST (NOLOCK) C ON B.AGENCY_CODE =C.AGENCY_CODE
   JOIN PRD_WO_MST MST ON MST.MEMO_ID=ORD.ORDER_ID   
   JOIN LMV01106 LM ON LM.AC_CODE=C.AC_CODE 
   JOIN JOBS ON JOBS.JOB_CODE=ORD.JOB_CODE
   JOIN ARTICLE AR ON AR.ARTICLE_CODE =A.ARTICLE_CODE 
   JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
   LEFT JOIN CITY  ON CITY.CITY_CODE=LM.CITY_CODE
   LEFT JOIN COMPANY COM ON COM.COMPANY_CODE='01'
   WHERE A.MEMO_ID=@CRECEIPT_ID
   AND B.CANCELLED =0  
  
    

END
