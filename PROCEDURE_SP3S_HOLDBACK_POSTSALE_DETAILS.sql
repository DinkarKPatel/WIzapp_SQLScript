CREATE PROCEDURE SP3S_HOLDBACK_POSTSALE_DETAILS
(
	----LIST OF INPUT PARAMETERS WITH DESCRIPTION
	 @DFROM_DT DATETIME
	,@DTO_DT DATETIME
	,@CANCELLED NUMERIC(1)=2 -- 0 FOR UN-CANCELLED 1 FOR CANCELLED 2 FOR ALL
	,@CUST_CODE VARCHAR(20)=''
	,@STATUS NUMERIC(1)=2
	,@LOC VARCHAR(5)=''
)
--WITH ENCRYPTION
AS
BEGIN
		
        SELECT A.MEMO_ID,CASE WHEN A.CANCELLED<>0 THEN 0 ELSE (CAST(1 AS NUMERIC(18,2))) END AS QUANTITY,
               CASE WHEN A.CANCELLED=0 AND DELIVERED =0 THEN (CAST(1 AS NUMERIC(18,2))) ELSE 0 END AS HOLD_QUANTITY,
               CASE WHEN A.CANCELLED=0 AND DELIVERED =1 THEN (CAST(1 AS NUMERIC(18,2))) ELSE 0 END AS DEL_QUANTITY,
               A.MEMO_NO,CONVERT(VARCHAR,A.MEMO_DT,105) AS MEMO_DT,
		       A.DELIVERY_POINT,A.DELIVERY_ADDRESS,
		       CONVERT(VARCHAR,A.LAST_UPDATE,105) AS LAST_UPDATE,
		       CANCELLED=CASE WHEN A.CANCELLED<>0 THEN 'CANCELLED' ELSE '' END,
		       A.CUSTOMER_CODE ,A.REMARKS,ref_cmd_row_id,
			  convert(varchar(40),'') AS BILL_NO ,
			  convert(datetime,'') AS BILL_DT   
		INTO #TMPHOLD_DEL
        FROM HOLD_BACK_DELIVER_MST A (NOLOCK)
		JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
		WHERE A.MEMO_DT BETWEEN @DFROM_DT AND @DTO_DT
		AND (@CANCELLED=2 OR A.CANCELLED =@CANCELLED)
		AND (@CUST_CODE='' OR A.CUSTOMER_CODE=@CUST_CODE)
		AND (@LOC='' OR A.location_Code=@LOC)	

		UPDATE a SET bill_no=cmm.cm_no,bill_dt=cmm.cm_dt FROM #TMPHOLD_DEL a
		JOIN  cmd01106 cmd (nolock) on cmd.ROW_ID=a.ref_cmd_row_id
		join cmm01106 cmm (nolock) on cmm.cm_id =cmd.cm_id

		SELECT T.MEMO_ID,T.MEMO_DT,T.MEMO_NO,T.DELIVERY_POINT ,T.DELIVERY_ADDRESS ,T.LAST_UPDATE ,T.CANCELLED,
		       SUM (ISNULL(T.QUANTITY ,0)) AS  QUANTITY,
		       SUM(ISNULL(HOLD_QUANTITY,0)) AS HOLD_QUANTITY,
		       SUM(ISNULL(DEL_QUANTITY,0)) AS DEL_QUANTITY,
		       CUSTOMER=D.CUSTOMER_TITLE +D.CUSTOMER_FNAME+D.CUSTOMER_LNAME,T.REMARKS,
		       E.DEPT_NAME,
		       I.AREA_NAME ,J.CITY,STATE,STATUS='',
		       T.BILL_NO,T.BILL_DT AS CM_DT
		INTO #TMPHOLD_DEL_FILTER
		FROM #TMPHOLD_DEL T
		--JOIN FN_BILL_NO(@DFROM_DT,@DTO_DT,@CANCELLED,@CUST_CODE,0) FN ON FN.MEMO_ID =T.MEMO_ID 
		JOIN CUSTDYM D ON D.CUSTOMER_CODE=T.CUSTOMER_CODE 
		JOIN LOCATION E (NOLOCK) ON E.DEPT_ID =LEFT(T.MEMO_ID,2)
		JOIN AREA I (NOLOCK) ON I.AREA_CODE = D.AREA_CODE         
		JOIN CITY J (NOLOCK) ON J.CITY_CODE = I.CITY_CODE         
		JOIN STATE K (NOLOCK) ON K.STATE_CODE = J.STATE_CODE  
		GROUP BY T.MEMO_ID,T.MEMO_DT,T.MEMO_NO,T.DELIVERY_POINT ,T.DELIVERY_ADDRESS ,T.LAST_UPDATE ,T.CANCELLED,
		         D.CUSTOMER_TITLE +D.CUSTOMER_FNAME+D.CUSTOMER_LNAME,T.REMARKS,
		         E.DEPT_NAME,I.AREA_NAME ,J.CITY,STATE,T.BILL_NO,T.BILL_DT 
	  
	   IF @STATUS=0
		 SELECT * FROM #TMPHOLD_DEL_FILTER T WHERE HOLD_QUANTITY >0
	     ORDER BY T.MEMO_DT,T.MEMO_ID
	   ELSE IF @STATUS=1
		  SELECT * FROM #TMPHOLD_DEL_FILTER T WHERE DEL_QUANTITY >0
		  ORDER BY T.MEMO_DT,T.MEMO_ID
	   ELSE
	      SELECT * FROM #TMPHOLD_DEL_FILTER T 
		  ORDER BY T.MEMO_DT,T.MEMO_ID
END