CREATE PROCEDURE SP_SEND_MIRROR_APP_DATA_NEW  --(LocId 3 digit change only increased the parameter width by Sanjay:01-11-2024)
(   
  @CUPLOADEDXNID VARCHAR(50)  
 ,@CCURLOCID VARCHAR(4)    
  ,@BACKNOWLEDGE BIT =0  
 ,@CERRMSG VARCHAR(1000) OUTPUT  
)   
--WITH ENCRYPTION  
AS  
/*  
 SP_SEND_MIRROR_APP_DATA_NEW_208_04_02_14 : THIS PROCEDURE WILL SEND APPROVAL ISSUE DATA FROM LOCATION TO HO.  
*/  
BEGIN  
 DECLARE @DTSQL NVARCHAR(MAX),@CSPID VARCHAR(10),@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),  
 @CTEMPMASTERTABLE VARCHAR(200),@CTEMPLMTABLE VARCHAR(200),@CTEMPLMPTABLE VARCHAR(200)  
 ,@CTEMPAREATABLE VARCHAR(200),@CTEMPCITYTABLE VARCHAR(200),@CTEMPCUSTABLE VARCHAR(200)  
 ,@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX)  
 ,@CKEYFIELD VARCHAR(100)  
  
 DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(40))     
BEGIN TRY    
 ---- CALL ACKNOWLEDGEMENT OF MEMO SUCCESSFUL MERGING AT MIRRORING SERVER  
 SET @CSTEP=0  
   
 DECLARE @CTEMPDBNAME VARCHAR(40)  


 SET @CTEMPDBNAME=''
 
 SET @CSTEP=30  
/*APM01106,APD01106,LM01106,CUSTDYM,LMP01106,HD01106,AREA,CITY,STATE*/  
   
 --CHNAGE BY BAIJNATH  
  SET @CMEMOID=@CUPLOADEDXNID  
   
 SET @CSTEP=40  
 ---- IF NO MEMO FOUND , JUST END THE PROCESS  
 IF ISNULL(@CMEMOID,'')=''  
  GOTO END_PROC  
LBLTABLEINFO:  
 SET @CSTEP=50  
 ---- POPULATE LIST OF TABLES   
/*APM01106,APD01106,LM01106,CUSTDYM,LMP01106,HD01106,AREA,CITY,STATE*/  
  
   
	 SET @CSTEP=220  
	 ---- SEND THE APP MEMO MASTER TABLE  
	 SELECT DISTINCT apm01106. *,'APP_APM01106_UPLOAD' AS TARGET_TABLENAME  FROM apm01106 (NOLOCK)
	 WHERE APM01106.MEMO_ID=@CMEMOID
   
	 SET @CSTEP=230  
	 ---- SEND THE APP MEMO DETAIL TABLE  
	 SELECT DISTINCT APD01106. *,'APP_APD01106_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS APP_MEMO_ID  FROM APD01106 (NOLOCK)
	 WHERE APD01106.MEMO_ID=@CMEMOID  
   
  
	 SET @CSTEP=245  
	 ---- SEND THE LEDGERS RELATED TO APP TABLE  
	 SELECT DISTINCT CUSTDYM. *,'APP_CUSTDYM_UPLOAD' AS TARGET_TABLENAME ,@CMEMOID AS APP_MEMO_ID  
	 FROM apm01106 (NOLOCK)
	 JOIN CUSTDYM (NOLOCK) ON CUSTDYM.customer_code=apm01106.CUSTOMER_CODE
	 WHERE APM01106.MEMO_ID=@CMEMOID
   
   
   
	 SET @CSTEP=270  
	 ---- SEND THE AREA RELATED TO LEDGERS TABLE 
	 SELECT DISTINCT AREA. *,'APP_AREA_UPLOAD' AS TARGET_TABLENAME ,@CMEMOID AS APP_MEMO_ID  
	 FROM APM01106 (NOLOCK)
	 JOIN CUSTDYM (NOLOCK) ON CUSTDYM.CUSTOMER_CODE=APM01106.CUSTOMER_CODE
	 JOIN AREA (NOLOCK) ON AREA.AREA_CODE=CUSTDYM.AREA_CODE 
	 WHERE APM01106.MEMO_ID=@CMEMOID


	 SELECT DISTINCT CITY. *,'APP_CITY_UPLOAD' AS TARGET_TABLENAME ,@CMEMOID AS APP_MEMO_ID  
	 FROM APM01106 (NOLOCK)
	 JOIN CUSTDYM (NOLOCK) ON CUSTDYM.CUSTOMER_CODE=APM01106.CUSTOMER_CODE
	 JOIN AREA (NOLOCK) ON AREA.AREA_CODE=CUSTDYM.AREA_CODE
	 JOIN CITY (NOLOCK)  ON CITY.CITY_CODE =AREA.city_code
	 WHERE APM01106.MEMO_ID=@CMEMOID

	
	SET @CSTEP=290
	---- SEND THE STATE RELATED TO LEDGERS TABLE
	

	 SELECT DISTINCT STATE. *,'APP_STATE_UPLOAD' AS TARGET_TABLENAME ,@CMEMOID AS APP_MEMO_ID  
	 FROM APM01106 (NOLOCK)
	 JOIN CUSTDYM (NOLOCK) ON CUSTDYM.CUSTOMER_CODE=APM01106.CUSTOMER_CODE
	 JOIN AREA (NOLOCK) ON AREA.AREA_CODE=CUSTDYM.AREA_CODE
	 JOIN CITY (NOLOCK)  ON CITY.CITY_CODE =AREA.city_code
	 JOIN STATE (NOLOCK) ON STATE.state_code =CITY.state_code
	 WHERE APM01106.MEMO_ID=@CMEMOID



   
 SET @CSTEP=271
 ---- SEND THE PMT01106 TABLE  
     
	 SELECT  DISTINCT 'APP_PMT01106_UPLOAD' AS TARGET_TABLENAME, @CMEMOID AS APP_MEMO_ID ,A.DEPT_ID,A.product_code,A.BIN_ID,A.quantity_in_stock    
	 FROM PMT01106  A (NOLOCK)
	 JOIN APD01106 B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
	 WHERE B.memo_id =@CMEMOID 

   
/*APM01106,APD01106,LM01106,CUSTDYM,LMP01106,HD01106,AREA,CITY,STATE*/  
    
  GOTO END_PROC    

  
END TRY  
BEGIN CATCH  
 SET @CERRMSG='P: SP_SEND_MIRROR_APP_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
 GOTO END_PROC  
END CATCH     
END_PROC:  
 
END  
---END OF PROCEDURE - SP_SEND_MIRROR_APP_DATA_NEW  