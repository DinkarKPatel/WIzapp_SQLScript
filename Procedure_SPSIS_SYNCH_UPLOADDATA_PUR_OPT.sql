create PROCEDURE SPSIS_SYNCH_UPLOADDATA_PUR_OPT
(
   @nSpId VARCHAR(50),
   @CDEPTID VARCHAR(5)/*Rohit 01-11-2024*/,
   @CSISDEPTID VARCHAR(5)/*Rohit 01-11-2024*/,
   @CERRMSG VARCHAR(MAX) OUTPUT
)
--WITH ENCRYPTION
AS
SET NOCOUNT ON
BEGIN

DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5),@cUpdatestr VARCHAR(4000),@bCancelled BIT
	   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
	   ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	   ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(MAX),@CMIRRORINGENABLED VARCHAR(5)
	   ,@CCURDEPTID VARCHAR(5),@CTEMPMASTERTABLE VARCHAR(200),@CTEMPDETAILTABLE1 VARCHAR(200),@CTEMPDETAILTABLE2 VARCHAR(200)
	   ,@CTEMPPAYMODETABLE VARCHAR(200),@CTEMPTABLE VARCHAR(100),@CDONOTRESETPOSTEDINAC VARCHAR(1)
	   ,@BADDMODE BIT,@CCUTOFFDATE VARCHAR(20),@CWHERECLAUSE VARCHAR(2000),@CMEMONOLEN VARCHAR(5),@NMEMONOLEN INT
	   ,@DMINMEMODT DATETIME,@DMAXMEMODT DATETIME,@CFINYEAR VARCHAR(5),@CMEMOPREFIX VARCHAR(10)
	   ,@CMINMEMONO VARCHAR(20),@CMAXMEMONO VARCHAR(20),@CSOURCEDB VARCHAR(200),@CMERGEDB VARCHAR(200)
	   ,@BMSTINSERTONLY BIT,@BSERIESMISMATCHFOUND BIT,@CMEMOID VARCHAR(40),@CPREVMEMONO VARCHAR(20)
	   ,@NPREVMEMONO NUMERIC(5,0),@NLENVALUE INT,@CPREVMEMONOSEARCH VARCHAR(20),@CMEMOIDSEARCH VARCHAR(40)
	   ,@CRETPRODUCTCODE VARCHAR(50),@NVERSIONNO INT,@CTEMPSKUTABLE VARCHAR(500)
	   ,@CPARTYDEPTID VARCHAR(5),@CTEMPIMPTABLE VARCHAR(200),@CFILTERCONDITION3 VARCHAR(500),@dMrrDt DATETIME
	   ,@dRececiptDt DATETIME,@NINVMODE INT
	   ,@CCMD NVARCHAR(MAX),@CKEYFIELD1 VARCHAR(200),@SLS_SYNC_AFTER DATETIME,@CWHERE varchar(100)
	

BEGIN TRY
	   

	 
	SELECT @CSOURCEDB='',@CMERGEDB='',@BMSTINSERTONLY=1,@BSERIESMISMATCHFOUND=0,@CERRMSG=''
	
    	
    SELECT TOP 1 @CCURDEPTID=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'

	SELECT @CTEMPMASTERTABLE=@CSOURCEDB+'PUR_PIm01106_UPLOAD',
		   @CTEMPDETAILTABLE1=@CSOURCEDB+'PUR_PID01106_UPLOAD'

			
LBLSTART:
    
    BEGIN TRANSACTION

	IF @CSISDEPTID<>'' AND EXISTS (SELECT TOP 1 'U' FROM PUR_PIM01106_UPLOAD A WHERE SP_ID =@NSPID AND A.INV_MODE =2)
	BEGIN

		UPDATE A SET INV_ID=@CSISDEPTID+SUBSTRING(INV_ID,LEN(@CSISDEPTID)+1,LEN(INV_ID)) /*Rohit 01-11-2024*/,
					 INV_NO=@CSISDEPTID+SUBSTRING(INV_NO,LEN(@CSISDEPTID)+1,LEN(INV_NO)) /*Rohit 01-11-2024*/,
					 challan_source_location_code=@CSISDEPTID
		FROM PUR_PIM01106_UPLOAD A
		WHERE SP_ID =@NSPID AND A.INV_MODE =2

	END


	--SOME MANDETORY COLUMNS UPDATE IN UPLOAD TABLES
	UPDATE A SET memo_type =1,
	             AC_CODE ='0000000000',
				 USER_CODE ='0000000',
				 EDT_USER_CODE='0000000',
				 PARTY_STATE_CODE='00',
				 BIN_ID='000',
				 MRR_ID=@CDEPTID+SUBSTRING(MRR_ID,LEN(@cdeptid)+1,LEN(MRR_ID))/*Rohit 01-11-2024*/ ,
				 MRR_NO=@CDEPTID+SUBSTRING(MRR_NO,LEN(@CDEPTID)+1,LEN(MRR_NO))/*Rohit 01-11-2024*/,
				 DEPT_ID=@CDEPTID,
				 MRR_CREATION_DEPT_ID=@CDEPTID,
				 freight_hsn_code ='0000000000',
				 other_charges_hsn_code ='0000000000',
				  bill_no='',
				 inv_dt ='',
				 inv_no='',
				 ApprovedLevelNo =99,
				 bill_level_tax_method =case when isnull(bill_level_tax_method,0)=0 then 1 else bill_level_tax_method end,
				 pim_mode =1,
				 location_Code =@CDEPTID
	FROM PUR_pim01106_UPLOAD A (NOLOCK)
	WHERE SP_ID =@nSpId

	UPDATE A SET BIN_ID ='000',
	           MRR_ID=@CDEPTID+SUBSTRING(MRR_ID,LEN(@CDEPTID)+1,LEN(MRR_ID))/*Rohit 01-11-2024*/,
			    hsn_code ='0000000000',
			    rfnet_wotax=isnull(rfnet_wotax,0),
				rfnet=isnull(rfnet,0)
	FROM PUR_PID01106_UPLOAD A (NOLOCK)
	WHERE SP_ID =@nSpId


	
	 UPDATE A SET PRODUCT_CODE=LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))  
	 FROM PUR_PID01106_UPLOAD A (NOLOCK)	WHERE SP_ID=@NSPID
	 AND CHARINDEX('@',PRODUCT_CODE)<>0


    SELECT @CMEMOID='',@NVERSIONNO=0
  
	SELECT TOP 1 @CMEMOID = B.MRR_ID ,
	@dMrrDt=mrr_dt,@bCancelled=cancelled,@dRececiptDt=receipt_dt,@NINVMODE=INV_MODE
    FROM PUR_PIM01106_UPLOAD B (NOLOCK) WHERE sp_id=@nSpId

    
	SET @CSTEP=17
    EXEC SP_CHKXNSAVELOG 'PURMERGE',@CSTEP,0,@nSpId,'',1
		
    SET @CFILTERCONDITION = 'B.sp_ID='''+@nSpId+''''
		
	SET @CMEMOIDSEARCH=''
	SELECT TOP 1 @CMEMOIDSEARCH=A.MRR_ID FROM PIM01106 A (NOLOCK) WHERE A.MRR_ID=@CMEMOID

	SET @CSTEP=19
    EXEC SP_CHKXNSAVELOG 'PURMERGE',@CSTEP,0,@nSpId,'',1
		
	IF ISNULL(@CMEMOIDSEARCH,'')<>''
		SET @BADDMODE=0
	ELSE
		SET @BADDMODE=1

		--check orphan Entry
		IF @NINVMODE=1
		BEGIN

		IF @BADDMODE=1 AND NOT EXISTS (SELECT TOP 1 'U' FROM PUR_PID01106_UPLOAD WHERE SP_ID =@NSPID)
		   GOTO EXIT_PROC
        IF @BADDMODE=0 AND NOT EXISTS (SELECT TOP 1 'U' FROM PUR_PID01106_UPLOAD WHERE SP_ID =@NSPID)
		  SET @BCANCELLED=1

		END


	IF @BADDMODE=0
	BEGIN

		SET @CSTEP=19.4
		EXEC SP_CHKXNSAVELOG 'PURMERGE',@CSTEP,0,@nSpId,'',1

		 INSERT SAVETRAN_BARCODE_NETQTY	( BIN_ID, DEPT_ID, PRODUCT_CODE, sp_id, XN_QTY ) 
		 SELECT 	'000'  BIN_ID,/*LEFT(A.MRR_ID,2)*//*Rohit 01-11-2024*/@CDEPTID DEPT_ID, PRODUCT_CODE,@nSpId SP_ID,-1*A.quantity AS XN_QTY 
		 FROM PID01106 A (NOLOCK)
		 WHERE A.mrr_id =@CMEMOID


		IF @bCancelled=1 
		BEGIN
			UPDATE pim01106 WITH (ROWLOCK) SET cancelled=1 WHERE mrr_id=@cMemoid
			GOTO lblupdatepmt
		END

		SET @CSTEP=21
		EXEC SP_CHKXNSAVELOG 'PURMERGE',@CSTEP,0,@nSpId,'',1

		IF EXISTS (SELECT TOP 1 tablename FROM savetran_updcols_updatestr (NOLOCK) WHERE sp_id=@nSPID)
			DELETE FROM savetran_updcols_updatestr WITH (ROWLOCK) WHERE sp_id=@nSpId

		INSERT savetran_updcols_updatestr (sp_id,tablename,updatestr)
		SELECT @nSPId as sp_id,tablename,'' from mirrorxnsinfo (NOLOCK)
		WHERE tablename IN ('pim01106','pid01106')


		IF OBJECT_ID('TEMPDB..#T','U') IS NOT NULL
			DROP TABLE #T
	
		select SP_ID INTO #t FROM PUR_PIm01106_UPLOAD (NOLOCK) WHERE 1=2

		SET @CSTEP=23
		EXEC SP_CHKXNSAVELOG 'PURMERGE',@CSTEP,0,@nSpId,'',1
		
		EXEC SP3S_VERIFY_PURDATA_merge_CHANGES
		@cMemoId=@cMemoId,
		@nSpId=@nSpid
	END

	DECLARE @cMissingRowId VARCHAR(40)

	IF @BADDMODE=0
	BEGIN	

		SET @CSTEP=27
		EXEC SP_CHKXNSAVELOG 'PURMERGE',@CSTEP,0,@nSpId,'',1

		SELECT TOP 1 @cMissingRowId=a.row_id FROM PID01106 A (NOLOCK) 
		LEFT JOIN 
		(SELECT row_id FROM PUR_PID01106_UPLOAD B (NOLOCK) WHERE sp_id=@nSpId) b
		ON A.row_ID =B.row_ID WHERE A.MRR_ID =@CMEMOID AND b.row_id IS NULL

		IF ISNULL(@cMissingRowId,'')<>''
		BEGIN		
			SET @CSTEP=30
			EXEC SP_CHKXNSAVELOG 'PURMERGE',@CSTEP,0,@nSpId,'',1

			DELETE A FROM PID01106 A WITH (ROWLOCK) LEFT JOIN 
			(SELECT row_id FROM PUR_PID01106_UPLOAD B (NOLOCK) WHERE sp_id=@nSpId) b
			ON A.row_ID =B.row_ID WHERE A.MRR_ID =@CMEMOID AND b.row_id IS NULL
		END

		SET @CSTEP=32
		
	END
	
LBLMERGE:
	---DELETING EXISTING RECORD IF BILL COMES AGAIN FOR MERGING
	
	--SELECT @CTEMPMASTERTABLE,@CFILTERCONDITION

	SET @CWHERE=' AND A.sp_ID='''+@nSpId+''''

	  

LBLDELETETEMPDATA:
 
	IF @BADDMODE=0
		PRINT 'ADDMODE:N'
	ELSE
		PRINT 'ADDMODE:Y'	
	
	SET @CSTEP=165
    EXEC SP_CHKXNSAVELOG 'PURMERGE',@CSTEP,0,@nSpId,'',1

	---UPDATING TRANSACTION TABLES
	SET @CTABLENAME='PIM01106'
	SET @CTMP_TABLENAME='PUR_PIm01106_UPLOAD'
	SET @CKEYFIELD='MRR_ID'

	SET @CFILTERCONDITION = 'B.sp_id='''+@nSpId+''''

	SELECT @cUpdatestr=updatestr FROM  savetran_updcols_updatestr (NOLOCK) WHERE sp_id=@nspid and tablename='pim01106'
	SET @LUPDATEONLY = (CASE WHEN @BADDMODE=0 THEN 1 ELSE 0 END)	

	EXEC UPDATEMASTERXN_opt @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BADDMODE,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=@LUPDATEONLY
							  ,@BALWAYSUPDATE=1,@lUpdateXns=1,@cUpdatestrPara=@cUpdatestr,@bThruUpdatestrPara=1  

    

	    SELECT a.product_code as new_product_code into #tmpbarcode FROM PUR_PId01106_UPLOAD A (NOLOCK)
		LEFT JOIN SKU B (nolock) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
		WHERE A.SP_ID=@nSpId AND B.PRODUCT_CODE IS NULL
		group by a.product_code

		IF EXISTS (SELECT TOP 1 'U' FROM #tmpbarcode)
		BEGIN
			SET @CSTEP=84.2
			EXEC SP_CHKXNSAVELOG 'SISPURMERGE',@CSTEP,0,@nSpId,'',1

			 EXEC SPSIS_INSERTSKUBARCODE @NSPID, 'PUR',@CERRMSG OUTPUT

			 if isnull(@cErrmsg,'')<>''
			    goto EXIT_PROC

          end


	UPDATE A SET ARTICLE_CODE=B.ARTICLE_CODE,
	             para1_code =b.para1_code ,
				 para2_code =b.para2_code ,
				 para3_code =b.para3_code ,
				 para4_code =b.para4_code ,
				 para5_code =b.para5_code ,
				 para6_code =b.para6_code ,
                 hsn_code=b.hsn_code
	FROM PUR_PID01106_UPLOAD A (NOLOCK)
	JOIN SKU B (NOLOCK)  ON A.PRODUCT_CODE =B.PRODUCT_CODE
	WHERE SP_ID =@NSPID


	SET @CSTEP=170
    EXEC SP_CHKXNSAVELOG 'SISPURMERGE',@CSTEP,0,@nSpId,'',1

    --PMT EFFECT IN CASE OF PUR AT HO LOCATION

	SET @CSTEP=180
    EXEC SP_CHKXNSAVELOG 'SISPURMERGE',@CSTEP,0,@nSpId,'',1

	SET @CTABLENAME='PID01106'
	SET @CTMP_TABLENAME='PUR_PID01106_UPLOAD'
	SET @CKEYFIELD='ROW_ID'
	
	
	SELECT @cMissingRowId='',@lUpdateonly=0
	IF @BADDMODE=0
	BEGIN
		SET @CSTEP=185
		EXEC SP_CHKXNSAVELOG 'SISPURMERGE',@CSTEP,0,@nSpId,'',1

		SELECT TOP 1 @cMissingRowId=b.row_id FROM 
		(SELECT row_id  FROM PUR_PID01106_UPLOAD (NOLOCK) WHERE sp_id=(LEFT(@nSPId,38)+@CDEPTID/* LEFT(@cMemoId,2)*//*Rohit 01-11-2024*/)) A
		RIGHT OUTER JOIN 
		(SELECT row_id FROM PUR_PID01106_UPLOAD (NOLOCK) WHERE sp_id=@nSpId) b ON 
		a.row_id=b.row_id WHERE a.row_id IS NULL

		--SELECT 'check @cMissingRowId of pid',@cMissingRowId

		IF ISNULL(@cMissingRowId,'')='' 
			SET @lUpdateonly=1
	END

	SET @CSTEP=190
    EXEC SP_CHKXNSAVELOG 'SISPURMERGE',@CSTEP,0,@nSpId,'',1


	SELECT @cUpdatestr=updatestr FROM  savetran_updcols_updatestr (NOLOCK) WHERE sp_id=@nspid and tablename='pid01106'

	EXEC UPDATEMASTERXN_opt @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BADDMODE,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=@lUpdateonly
							  ,@BALWAYSUPDATE=1,@lUpdateXns=@BADDMODE,@cUpdatestrPara=@cUpdatestr,@bThruUpdatestrPara=1 


	
	
	SET @CSTEP=210
    EXEC SP_CHKXNSAVELOG 'SISPURMERGE',@CSTEP,0,@nSpId,'',1

	    INSERT SAVETRAN_BARCODE_NETQTY	( BIN_ID, DEPT_ID, PRODUCT_CODE, sp_id, XN_QTY ) 
		 SELECT 	'000'  BIN_ID,/*LEFT(A.MRR_ID,2)*//*Rohit 01-11-2024*/@CDEPTID DEPT_ID, PRODUCT_CODE,@nSpId SP_ID,A.quantity AS XN_QTY 
		 FROM PID01106 A (NOLOCK)
		 WHERE A.mrr_id =@CMEMOID

	lblupdatepmt:
	EXEC SPSIS_UPDATEPMT @NSPID


		   
END TRY
BEGIN CATCH
	SET @CERRMSG='Error in Procedure SPSIS_SYNCH_UPLOADDATA_PUR_OPT, MEMO ID :'+@CMEMOID+' at STEP#'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO EXIT_PROC
END CATCH

EXIT_PROC:

	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')='' 
			commit
		ELSE
			ROLLBACK
    END

	declare @CtEXT VARCHAR(20)
	SET @cText=(CASE WHEN @BADDMODE=1 THEN 'ADDMODE' ELSE 'EDITMOTE' END)

	SET @CSTEP=245
    EXEC SP_CHKXNSAVELOG 'SISPURMERGE',@CSTEP,0,@nSpId,@cText,1
	

	DECLARE @nSpIdCopy VARCHaR(50)
	SET @nSpIdCopy=LEFT(@nSPId,38)+@CDEPTID/* LEFT(@cMemoId,2)*//*Rohit 01-11-2024*/
	EXEC SP3S_DELETEupload_PURmerge_TABLES @nSPId,@nSpIdCopy
END	
---END OF PROCEDURE - SPSIS_SYNCH_UPLOADDATA_PUR_OPT