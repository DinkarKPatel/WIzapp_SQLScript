CREATE PROCEDURE SP_SEND_MIRROR_SCF_DATA_NEW  
(  
  @CUPLOADEDXNID VARCHAR(50)  
 ,@CCURLOCID VARCHAR(5)   
  ,@BACKNOWLEDGE BIT =0   
 ,@CERRMSG VARCHAR(1000) OUTPUT  
)  
--WITH ENCRYPTION  
AS  
BEGIN  
 DECLARE @DTSQL NVARCHAR(MAX),@NSPID INT,@CTEMPTABLE VARCHAR(500),@CTEMPSKUTABLE VARCHAR(500),  
 @CMEMOID VARCHAR(50),@CTEMPARTICLETABLE VARCHAR(500),@CSTEP VARCHAR(5),  
 @CTEMPEMPLOYEETABLE VARCHAR(200),@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),  
 @BRECFOUND BIT,@CWHERECLAUSE VARCHAR(MAX),@CFILTERCONDITION VARCHAR(MAX),  
 @CTEMPMASTERTABLE VARCHAR(200),@BGROUP_INVOICE BIT  
   
DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(40))     
  
BEGIN TRY   
 SET @CSTEP=00  
 DECLARE @CTEMPDBNAME VARCHAR(40)  
 set @CTEMPDBNAME=''
 
 SELECT TOP 1 @CCURLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'   
 SET @CSTEP=20  
  
 --CHANGE BY BAIJNATH  
 SET @CMEMOID=@CUPLOADEDXNID  
 ---- IF NO MEMO FOUND , JUST END THE PROCESS  
 IF ISNULL(@CMEMOID,'')=''  
  GOTO END_PROC  
  
LBLTABLEINFO:  
 SET @CSTEP=50  
 ---- POPULATE LIST OF TABLES TO BE SENT AGAINST A GIVEN SPLIT/COMBINE MEMO  
 
   
 SET @CSTEP=60  
 ---- CALL ACKNOWLEDGEMENT OF MEMO SUCCESSFUL MERGING AT MIRRORING SERVER  
   
   
/*SCM01106,SCF01106,SCM01106_AUDIT,SCF01106_AUDIT,SCF_IMPORT_LOG,FORM,UOM,LM01106,HD01106,LMP01106,AREA,CITY,STATE  
,ARTICLE,SECTIOND,SECTIONM,PARA1,PARA2,PARA3,PARA4,PARA5,PARA6,SKU,SKU_OH,SKU_BO*/   
 SET @CSTEP=110  
 ---- SEND THE SPLIT/COMBINE MEMO MASTER TABLE  

 SELECT DISTINCT A.*,'SCF_SCM01106_UPLOAD' as TARGET_TABLENAME  FROM SCM01106 A WHERE MEMO_ID=@CMEMOID
   
 SET @CSTEP=120  
 ---- SEND THE SPLIT/COMBINE FINISHED ITEM DETAIL TABLE  

 
 SELECT DISTINCT A.*,'SCF_SCF01106_UPLOAD' as TARGET_TABLENAME  FROM SCF01106 A WHERE MEMO_ID=@CMEMOID
   
  
 SET @CSTEP=130  
 ---- SEND THE SPLIT/COMBINE CONSUMED ITEM DETAIL TABLE  
 
 SELECT DISTINCT A.*,'SCF_SCC01106_UPLOAD' as TARGET_TABLENAME  FROM SCC01106 A WHERE MEMO_ID=@CMEMOID
    
  
 SET @CSTEP=230  
 ---- SEND THE BAR CODE DETAILS OF SPLIT/COMBINE   

 SELECT DISTINCT SKU.*,'SCF_SKU_UPLOAD' as TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID  FROM SKU (NOLOCK)
 JOIN SCF01106 ON SKU.PRODUCT_CODE=SCF01106.PRODUCT_CODE  
 WHERE SCF01106.MEMO_ID=@CMEMOID
 UNION 
 SELECT DISTINCT SKU.*,'SCF_SKU_UPLOAD' as TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID  FROM SKU (NOLOCK)
 JOIN SCC01106 ON SKU.PRODUCT_CODE=SCC01106.PRODUCT_CODE  
 WHERE SCC01106.MEMO_ID=@CMEMOID
 
   
 SET @CSTEP=240  
 ---- SEND THE SKU_OH OF SPLIT/COMBINE   
 
 SELECT DISTINCT SKU_OH.*,'SCF_SKU_OH_UPLOAD' as TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID  FROM SKU_OH (NOLOCK)
 JOIN SCF01106 ON SKU_OH.PRODUCT_CODE=SCF01106.PRODUCT_CODE  
 WHERE SCF01106.MEMO_ID=@CMEMOID
 UNION 
 SELECT DISTINCT SKU_OH.*,'SCF_SKU_OH_UPLOAD' as TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID  FROM SKU_OH (NOLOCK)
 JOIN SCC01106 ON SKU_OH.PRODUCT_CODE=SCC01106.PRODUCT_CODE  
 WHERE SCC01106.MEMO_ID=@CMEMOID
 
   
   
 SET @CSTEP=250  
 ---- SEND THE ARTICLES OF SPLIT/COMBINE  
 

 IF OBJECT_ID ('TEMPDB..#TMPARTICLE','U') IS NOT NULL
    DROP TABLE #TMPARTICLE

	 SELECT DISTINCT  ARTICLE_CODE INTO #TMPARTICLE FROM SCF01106 WHERE MEMO_ID=@CMEMOID
	 UNION
	 SELECT DISTINCT SKU.article_code FROM SKU (NOLOCK)
	 JOIN SCF01106 ON SKU.PRODUCT_CODE=SCF01106.PRODUCT_CODE  
	 WHERE SCF01106.MEMO_ID=@CMEMOID
	 UNION 
	 SELECT DISTINCT SKU.article_code  FROM SKU (NOLOCK)
	 JOIN SCC01106 ON SKU.PRODUCT_CODE=SCC01106.PRODUCT_CODE  
	 WHERE SCC01106.MEMO_ID=@CMEMOID
 
  
    SELECT DISTINCT A.*,'SCF_ARTICLE_UPLOAD' as TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID  FROM ARTICLE A
	JOIN #TMPARTICLE TMP ON A.ARTICLE_CODE =TMP.ARTICLE_CODE
    
   
 SET @CSTEP=260   
 ---- SEND THE UOM OF SPLIT/COMBINE   
 
    SELECT DISTINCT UOM.*,'SCF_UOM_UPLOAD' as TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID  FROM ARTICLE A (NOLOCK)
	JOIN #TMPARTICLE TMP ON A.ARTICLE_CODE =TMP.ARTICLE_CODE
	JOIN UOM  (NOLOCK) ON UOM.UOM_CODE =A.uom_code
    
  
 SET @CSTEP=265  
 ---- SEND THE SUB SECTIONS OF SPLIT/COMBINE   

    SELECT DISTINCT SECTIOND.*,'SCF_SECTIOND_UPLOAD' as TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID  FROM ARTICLE A (NOLOCK)
	JOIN #TMPARTICLE TMP ON A.ARTICLE_CODE =TMP.ARTICLE_CODE
	JOIN SECTIOND   (NOLOCK) ON SECTIOND.sub_section_code =A.sub_section_code

   
 SET @CSTEP=270  
 ---- SEND THE SUB SECTIONS OF SPLIT/COMBINE   
 
   SELECT DISTINCT SECTIONM.*,'SCF_SECTIONM_UPLOAD' as TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID  FROM ARTICLE A (NOLOCK)
   JOIN #TMPARTICLE TMP ON A.ARTICLE_CODE =TMP.ARTICLE_CODE
   JOIN SECTIOND   (NOLOCK) ON SECTIOND.sub_section_code =A.sub_section_code
   JOIN SECTIONM (NOLOCK) ON SECTIONM.section_code =SECTIOND.section_code
 
   
 SET @CSTEP=340  
 ---- SEND THE PARA1 OF SPLIT/COMBINE  
 
 IF OBJECT_ID('TEMPDB..#TMPSKU','U') IS NOT NULL
    DROP TABLE #TMPSKU
 
 SELECT DISTINCT SKU.PRODUCT_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PARA3_CODE,SKU.PARA4_CODE,SKU.PARA5_CODE,SKU.PARA6_CODE 
 INTO #TMPSKU   
 FROM SKU (NOLOCK)
 JOIN SCF01106 ON SKU.PRODUCT_CODE=SCF01106.PRODUCT_CODE  
 WHERE SCF01106.MEMO_ID=@CMEMOID
 UNION 
 SELECT DISTINCT SKU.PRODUCT_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PARA3_CODE,SKU.PARA4_CODE,SKU.PARA5_CODE,SKU.PARA6_CODE  
  FROM SKU (NOLOCK)
 JOIN SCC01106 ON SKU.PRODUCT_CODE=SCC01106.PRODUCT_CODE  
 WHERE SCC01106.MEMO_ID=@CMEMOID
 
  

  SELECT DISTINCT PARA1.*,'SCF_PARA1_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID FROM PARA1 (NOLOCK)
  JOIN #TMPSKU B ON PARA1.PARA1_CODE =B.PARA1_CODE 

 SET @CSTEP=350  
 ---- SEND THE PARA2 OF SPLIT/COMBINE   
 
  SELECT DISTINCT PARA2.*,'SCF_PARA2_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID FROM PARA2 (NOLOCK)
  JOIN #TMPSKU B ON PARA2.PARA2_CODE =B.PARA2_CODE 

   
 SET @CSTEP=360  
 ---- SEND THE PARA3 OF SPLIT/COMBINE   
 
  SELECT DISTINCT PARA3.*,'SCF_PARA3_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID FROM PARA3 (NOLOCK)
  JOIN #TMPSKU B ON PARA3.PARA3_CODE =B.PARA3_CODE 

   
 SET @CSTEP=370  
 ---- SEND THE PARA4 OF SPLIT/COMBINE   
 
  SELECT DISTINCT PARA4.*,'SCF_PARA4_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID FROM PARA4 (NOLOCK)
  JOIN #TMPSKU B ON PARA4.PARA4_CODE =B.PARA4_CODE 

   
   
 SET @CSTEP=380  
 ---- SEND THE PARA5 OF SPLIT/COMBINE   
 
  SELECT DISTINCT PARA5.*,'SCF_PARA5_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID FROM PARA5 (NOLOCK)
  JOIN #TMPSKU B ON PARA5.PARA5_CODE =B.PARA5_CODE  
   
 SET @CSTEP=390  
 ---- SEND THE PARA6 OF SPLIT/COMBINE   

  SELECT DISTINCT PARA6.*,'SCF_PARA6_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID FROM PARA6 (NOLOCK)
  JOIN #TMPSKU B ON PARA6.PARA6_CODE =B.PARA6_CODE 
  
  
   SET @CSTEP=291 
 ---- SEND THE PMT01106 OF SPLIT/COMBINE   
 
 
  SELECT DISTINCT PMT01106.*,'SCF_PMT01106_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS SCF_MEMO_ID FROM PMT01106 (NOLOCK)
  JOIN #TMPSKU B ON PMT01106.PRODUCT_CODE   =B.PRODUCT_CODE 

   
 SET @CSTEP=460  
   
 GOTO END_PROC  
  
END TRY  
  
BEGIN CATCH  
 SET @CERRMSG='P: SP_SEND_MIRROR_SCF_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
 GOTO END_PROC  
END CATCH   
    
END_PROC:  
 
   
END   
---END OF PROCEDURE - SP_SEND_MIRROR_SCF_DATA_NEW  