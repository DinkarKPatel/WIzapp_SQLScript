create PROCEDURE SP3S_NAVIGATE_VOUCHER
(
	@NNAVMODE NUMERIC(1),/*@NNAVMODE : 
							  VALUES    : 1 - GET THE TOP(FIRST RECORD) ARTICLE_CODE
										  2 - GET THE PREVIOUS ARTICLE_CODE
										  3 - GET THE NEXT ARTICLE_CODE
										  4 - GET THE BOTTOM(LAST RECORD) ARTICLE_CODE
										  */
  
	@CFINYEAR VARCHAR(MAX),
	@CVM_ID VARCHAR(MAX),
	@BSHOWCANCEL BIT=0,
	@CWHERECLAUSE VARCHAR(MAX)=''
)
--WITH ENCRYPTION 
AS
BEGIN

	
	IF @NNAVMODE=1
	BEGIN
		SELECT TOP 1 VM_ID ,ts,VOUCHER_DT
		FROM VM01106 (nolock)
		WHERE fin_year=@CFINYEAR
		AND (@BSHOWCANCEL=0 OR cancelled=0)
		ORDER BY VOUCHER_DT ,VOUCHER_NO  
	END
	else IF @NNAVMODE=2
	BEGIN
		SELECT TOP 1 a.VM_ID ,a.VOUCHER_DT,a.VOUCHER_NO
		FROM VM01106 A
		LEFT OUTER JOIN 
		(
			SELECT ts,VOUCHER_NO  ,voucher_dt ,vm_id ,last_update
			FROM VM01106 WHERE fin_year=@CFINYEAR AND VM_ID=@CVM_ID
		)X ON 1=1
		WHERE fin_year=@CFINYEAR
		AND (@BSHOWCANCEL=0 OR cancelled=0)
		AND a.VOUCHER_DT<=x.VOUCHER_DT
		 and CONVERT(VARCHAR,a.VOUCHER_DT,112)+CONVERT(VARCHAR,a.LAST_UPDATE,121)+a.VOUCHER_NO<CONVERT(VARCHAR,x.VOUCHER_DT,112)+CONVERT(VARCHAR,x.LAST_UPDATE,121)+x.VOUCHER_NO
	 --   and CONVERT(VARCHAR,a.VOUCHER_DT,112)+a.VOUCHER_NO+cast(DATENAME (ss,LAST_UPDATE) as varchar(10))< CONVERT(VARCHAR,x.VOUCHER_DT,112)+x.VOUCHER_NO+cast(DATENAME (ss,LAST_UPDATE) as varchar(10))
        ORDER BY a.VOUCHER_DT DESC ,a.VOUCHER_NO  desc
		--HAVING A.ts=MIN(A.TS)
		--ORDER BY , a.ts 
	END
	ELSE IF @NNAVMODE=3
	BEGIN
		SELECT TOP 1 a.VM_ID ,a.VOUCHER_DT
		FROM VM01106 A
		LEFT OUTER JOIN 
		(
			SELECT ts,VOUCHER_NO,vm_id   ,voucher_dt,LAST_UPDATE   FROM VM01106 WHERE fin_year=@CFINYEAR AND VM_ID=@CVM_ID
		)X ON 1=1
		WHERE fin_year=@CFINYEAR
		AND (@BSHOWCANCEL=0 OR cancelled=0)
		AND a.VOUCHER_DT>=x.VOUCHER_DT
		and CONVERT(VARCHAR,a.VOUCHER_DT,112)+CONVERT(VARCHAR,a.LAST_UPDATE,121)+a.VOUCHER_NO>CONVERT(VARCHAR,x.VOUCHER_DT,112)+CONVERT(VARCHAR,x.LAST_UPDATE,121)+x.VOUCHER_NO
		 -- and CONVERT(VARCHAR,a.VOUCHER_DT,112)+a.VOUCHER_NO+cast(DATENAME (ss,LAST_UPDATE) as varchar(10))> CONVERT(VARCHAR,x.VOUCHER_DT,112)+x.VOUCHER_NO+cast(DATENAME (ss,LAST_UPDATE) as varchar(10))
		 ORDER BY a.VOUCHER_DT  ,a.VOUCHER_NO  
		
	END
	ELSE IF @NNAVMODE=4
	BEGIN
		SELECT TOP 1 VM_ID ,ts,VOUCHER_DT
		FROM VM01106 
		WHERE fin_year=@CFINYEAR
		AND (@BSHOWCANCEL=0 OR cancelled=0)
		ORDER BY VOUCHER_DT DESC ,VOUCHER_NO  desc



	END
	ELSE
	BEGIN
		SELECT  VM_ID ,ts,VOUCHER_DT
		FROM VM01106 
		WHERE --fin_year=@CFINYEAR AND (@BSHOWCANCEL=0 OR cancelled=0) AND 		
		VM_ID=@CVM_ID
	END
	
END
--END OF PROCEDURE - SP3S_NAVIGATE_ARTICLE
