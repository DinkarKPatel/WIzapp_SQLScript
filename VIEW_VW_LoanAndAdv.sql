CREATE VIEW  VW_LOANANDADV 
--WITH ENCRYPTION
AS    
SELECT A.LOAN_ID , A.LOAN_DATE ,A.SETTLED,A.TENURE ,A.EMP_ID , C.DEPT_ID , D.DEPARTMENT_ID ,    
B.EMP_FNAME +' '+ B.EMP_LNAME AS EMP_NAME  ,(C.DEPT_ID + ' - ' + C.DEPT_ALIAS)  AS DEPT_ALIAS, 
(C.DEPT_ID + ' - ' + C.DEPT_NAME) AS DEPT_NAME, D.DEPARTMENT_NAME ,E.AMOUNT AS PAID_AMOUNT,
CASE WHEN A.LOAN_TYPE =1 THEN 'LOAN'    
WHEN A.LOAN_TYPE =2 THEN 'ADVANCE'      
END AS LOAN_TYPE,     
CONVERT(DATETIME,(CONVERT(VARCHAR(50), F.PAYSLIP_YEAR)+'-'+CONVERT(VARCHAR(50), F.PAYSLIP_MONTH) + '-'+'01'))   AS[PAYSLIP_MONTH], 
CASE 
	WHEN A.LOAN_STATUS  =0 THEN 'UNAPPROVED'    
	WHEN A.LOAN_STATUS  =1 THEN 'APPROVED'      
	WHEN A.LOAN_STATUS  =1 THEN 'CANCELLED'    
END AS LOAN_STATUS,    
CASE 
	WHEN A.SETTLEMENT_TYPE   =1 THEN 'ONE TIMES'    
	WHEN A.SETTLEMENT_TYPE  =2 THEN ('EMI-'+ CONVERT(VARCHAR(10), A.TENURE))      
END AS SETTLEMENT_TYPE, A.LOAN_AMOUNT , 
A.EMI_AMOUNT, 
A.APPROVED_AMOUNT,
B.EMP_STATUS
FROM EMP_LOAN_MST A    
JOIN EMP_MST B ON A.EMP_ID = B.EMP_ID    
JOIN LOCATION C ON B.DEPT_ID = C.DEPT_ID     
JOIN EMP_DEPARTMENT D ON B.DEPARTMENT_ID = D.DEPARTMENT_ID     
LEFT OUTER JOIN EMP_PAYSLIP_DET E ON A.LOAN_ID = E.LOAN_ID     
LEFT OUTER JOIN EMP_PAYSLIP_MST F ON E.PAYSLIP_ID = F.PAYSLIP_ID     
WHERE ISNULL(F.CANCELLED,0) = 0
