create PROCEDURE SP_POSSALE_CHART
(
	@DTODATE VARCHAR(20)='',  
	@DCONVERSIONFACTOR INT=1,  
	@MCONVERSIONFACTOR INT=1,   
	@YCONVERSIONFACTOR INT=1    
)
--WITH ENCRYPTION
AS
BEGIN
      
       DECLARE @DTSQL NVARCHAR(MAX),
       @CURRENTYEAR VARCHAR(10),
       @PREVYEAR VARCHAR(10),
       @DPREV_TODATE  VARCHAR(20)
      
      --------DAY DIVISION FACTOR---- 
      IF @DCONVERSIONFACTOR=1  
		   SET @DCONVERSIONFACTOR=1000  
      ELSE IF @DCONVERSIONFACTOR=2  
           SET @DCONVERSIONFACTOR=100000  
      ELSE IF @DCONVERSIONFACTOR=3  
           SET @DCONVERSIONFACTOR=10000000  
       
      --------MONTH DIVISION FACTOR---- 
      IF @MCONVERSIONFACTOR=1  
          SET @MCONVERSIONFACTOR=1000  
      ELSE IF @MCONVERSIONFACTOR=2  
          SET @MCONVERSIONFACTOR=100000  
      ELSE IF @MCONVERSIONFACTOR=3  
          SET @MCONVERSIONFACTOR=10000000   
        
   IF @YCONVERSIONFACTOR=1  
      SET @YCONVERSIONFACTOR=1000  
   ELSE IF @YCONVERSIONFACTOR=2  
      SET @YCONVERSIONFACTOR=100000  
   ELSE IF @YCONVERSIONFACTOR=3  
     SET @YCONVERSIONFACTOR=10000000   
      
	   SET @CURRENTYEAR=(SELECT '01'+ DBO.FN_GETFINYEAR(@DTODATE))  --SET CURRENT YEAR
	   SET @DPREV_TODATE=(SELECT DATEADD(YEAR,-1,@DTODATE)) ----SET PREV YEAR DATE
	   SET @PREVYEAR=(SELECT '01'+ DBO.FN_GETFINYEAR(@DPREV_TODATE)) --SET PREV YEAR
	   DECLARE @TMPTABLE TABLE (DEPT_ID VARCHAR(5),DCY NUMERIC(12,2),DPY NUMERIC(12,2),DINCPER NUMERIC(10,0),
	                            MCY NUMERIC(12,2),MPY NUMERIC(12,2),MINCPER NUMERIC(10,0),
	                            YCY NUMERIC(12,2),YPY NUMERIC(12,2),YINCPER NUMERIC(10,0))
	   
       SET @DTSQL=N'SELECT DEPT_ID,SUM(DCY) AS DCY,SUM(DPY) AS DPY,
               SUM(MCY) AS MCY ,SUM(MPY) AS MPY,
               SUM(YCY) AS YCY,SUM(YPY) AS YPY
               FROM 
              (SELECT  Location_code AS DEPT_ID, 
	          SUM(CASE WHEN A.CM_DT ='''+CONVERT(VARCHAR(11),@DTODATE,120)+''' THEN A.NET_AMOUNT-ISNULL(A.ATD_CHARGES,0) ELSE 0 END) AS DCY,
	          0 AS DPY,
	          SUM(CASE WHEN MONTH(A.CM_DT) = MONTH('''+@DTODATE+''') AND A.FIN_YEAR='''+@CURRENTYEAR+''' AND A.CM_DT <= '''+CONVERT(VARCHAR(11),@DTODATE,120)+''' THEN A.NET_AMOUNT-ISNULL(A.ATD_CHARGES,0) ELSE 0 END) AS MCY,
	          0 AS MPY,
	          SUM(CASE WHEN  A.FIN_YEAR='''+@CURRENTYEAR+''' AND A.CM_DT <= '''+CONVERT(VARCHAR(11),@DTODATE,120)+''' THEN A.NET_AMOUNT-ISNULL(A.ATD_CHARGES,0) ELSE 0 END) AS YCY,
	          0 AS YPY
	   FROM CMM01106 A
	   WHERE A.CANCELLED=0  AND A.FIN_YEAR='''+@CURRENTYEAR+''' AND  A.CM_DT <='''+CONVERT(VARCHAR(11),@DTODATE,120)+''' 
	   GROUP BY Location_code
	   UNION
	   SELECT Location_code AS DEPT_ID, 
	          0 AS DCY,
	          SUM(CASE WHEN A.CM_DT ='''+CONVERT(VARCHAR(11),@DPREV_TODATE,120)+''' THEN A.NET_AMOUNT-ISNULL(A.ATD_CHARGES,0) ELSE 0 END) AS DPY,
	          0 AS  MCY,
	          SUM(CASE WHEN MONTH(A.CM_DT) = MONTH('''+@DPREV_TODATE+''') AND A.FIN_YEAR='''+@PREVYEAR+''' AND A.CM_DT <= '''+CONVERT(VARCHAR(11),@DPREV_TODATE,120)+''' THEN A.NET_AMOUNT-ISNULL(A.ATD_CHARGES,0) ELSE 0 END) AS MPY,
	          0 AS YCY,
	          SUM(CASE WHEN  A.FIN_YEAR='''+@PREVYEAR+''' AND A.CM_DT <= '''+CONVERT(VARCHAR(11),@DPREV_TODATE,120)+''' THEN A.NET_AMOUNT-ISNULL(A.ATD_CHARGES,0) ELSE 0 END) AS YPY
	   FROM CMM01106 A
	   WHERE A.CANCELLED=0  AND A.FIN_YEAR='''+@PREVYEAR+''' AND  A.CM_DT <='''+CONVERT(VARCHAR(11),@DPREV_TODATE,120)+''' 
	   GROUP BY Location_code) A
	   GROUP BY DEPT_ID'
	 
	 PRINT  @DTSQL
	 INSERT INTO @TMPTABLE(DEPT_ID ,DCY,DPY,MCY,MPY,YCY ,YPY )
	 EXEC SP_EXECUTESQL  @DTSQL
	 
	 UPDATE @TMPTABLE SET DINCPER=((DCY-DPY)*100)/CASE WHEN DCY=0 THEN -100 ELSE DCY END,
	                      MINCPER=((MCY-MPY)*100)/CASE WHEN MCY=0 THEN -100 ELSE MCY END,
	                      YINCPER=((YCY-YPY)*100)/CASE WHEN YCY=0 THEN -100 ELSE YCY END
	 
	 UPDATE @TMPTABLE SET DCY=DCY/@DCONVERSIONFACTOR,
	                      DPY=DPY/@DCONVERSIONFACTOR,
	                      MCY=MCY/@MCONVERSIONFACTOR,
	                      MPY=MPY/@MCONVERSIONFACTOR,
	                      YCY=YCY/@YCONVERSIONFACTOR ,
	                      YPY=YPY/@YCONVERSIONFACTOR 
	                      
	 SELECT B.DEPT_ALIAS , A.* FROM @TMPTABLE A
	 JOIN LOCATION B (NOLOCK)  ON A.DEPT_ID=B.DEPT_ID 
	   

END
