CREATE PROCEDURE SP3S_RETAILORDER_ITEMSTATUS
(
	@CORDER_ID VARCHAR(22)='',
	@CPRODUCT_CODE VARCHAR(100)='',
	@CCUSTOMER_CODE VARCHAR(100)='',
	@STATUS  VARCHAR(10) =''
)
AS
BEGIN
        IF @CORDER_ID='' AND @CPRODUCT_CODE='' AND @CCUSTOMER_CODE=''
        SET @CORDER_ID='RETURN BLANKROW'
        
        IF OBJECT_ID ('TEMPDB..#ORDDLV','U') IS NOT NULL
           DROP TABLE #ORDDLV
           
    	SELECT A.CUSTOMER_CODE
			  ,A.CM_NO 
			  ,A.CM_DT 
			  ,B.PRODUCT_CODE   
			  ,B.QUANTITY
		INTO #ORDDLV	  	  
		FROM CMM01106 A (NOLOCK) 
		JOIN CMD01106 B (NOLOCK) ON A.CM_ID=B.CM_ID
		JOIN WSL_ORDER_DET WOD (NOLOCK) ON B.PRODUCT_CODE=
							(CASE WHEN WOD.ORDER_TYPE=0 THEN WOD.PRODUCT_CODE ELSE WOD.REF_PRODUCT_CODE END)
		JOIN WSL_ORDER_MST WOM (NOLOCK) ON WOD.ORDER_ID=WOM.ORDER_ID AND A.CUSTOMER_CODE=WOM.CUSTOMER_CODE
		WHERE A.CM_MODE = 1 AND B.RFNET>0 
		AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000' AND WOM.CANCELLED=0 AND ISNULL(WOD.CANCELLED,0)=0


		;WITH CTE_REMOVEDUP AS
		(
			SELECT ROW_NUMBER() OVER(PARTITION BY PRODUCT_CODE,CUSTOMER_CODE ORDER BY CM_DT ASC,CM_NO ASC) AS SNO
				  ,CUSTOMER_CODE
				  ,CM_NO
				  ,PRODUCT_CODE
				  ,QUANTITY
			FROM #ORDDLV	  
		)
		DELETE CTE_REMOVEDUP WHERE SNO<>1
		
		CREATE INDEX IX_ORDDLV_PRODUCT_CODE  ON #ORDDLV(PRODUCT_CODE)
		CREATE INDEX IX_ORDDLV_CUSTOMER_CODE ON #ORDDLV(CUSTOMER_CODE)
		CREATE INDEX IX_ORDDLV_CM_NO ON #ORDDLV(CM_NO)	  
		
   DECLARE @CCMD NVARCHAR(MAX),@CMDT VARCHAR(1000)
   SET @CMDT=''
 
       SET @CCMD=N'SELECT A.PRODUCT_CODE,ART.ARTICLE_NO
		,ISNULL(PO.PO_NO,'''') AS PO_NO
		,(CASE WHEN ISNULL(PO.PO_DT,'''')='''' THEN '''' ELSE CONVERT(VARCHAR,ISNULL(PO.PO_DT,''''),105) END) AS PO_DT 
		,ISNULL(PO.AC_NAME,'''') AS SUPPLIER
		,COALESCE(PUR.MRR_NO,GPUR.MRR_NO,'''') AS MRR_NO
		,(CASE WHEN COALESCE(PUR.RECEIPT_DT,GPUR.RECEIPT_DT,'''')='''' THEN '''' ELSE CONVERT(VARCHAR,COALESCE(PUR.RECEIPT_DT,GPUR.RECEIPT_DT,''''),105) END) AS MRR_DT 
		,ISNULL(SLS.CM_NO,'''') AS CM_NO 
		,'+(CASE WHEN ISNULL(@CPRODUCT_CODE,'') = '' THEN '(CASE WHEN ISNULL(SLS.CM_DT,'''')=''1900-01-01'' THEN NULL ELSE  CONVERT(VARCHAR,ISNULL(SLS.CM_DT,''''),105) END)'ELSE 'SLS.CM_DT' END )+'
		 AS CM_DT
		,CANCELLED=CASE WHEN A.CANCELLED=0 THEN '''' ELSE ''CANCELLED'' END,
		CANCELLED_REMARKS,
		CANCELLED_USER_CODE,
		B.ORDER_NO,B.ORDER_DT,B.TRAIL_DT,B.DELIVERY_DT,B.REF_NO,B.URGENT
		FROM WSL_ORDER_DET A (NOLOCK)
		JOIN WSL_ORDER_MST B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID
		JOIN ARTICLE ART(NOLOCK) ON A.ARTICLE_CODE=ART.ARTICLE_CODE
		LEFT JOIN 
		(
			SELECT POM.PO_NO,POM.PO_DT,LM.AC_NAME,POD.PRODUCT_CODE
			FROM POM01106 POM(NOLOCK)
			JOIN POD01106 POD(NOLOCK) ON POM.PO_ID=POD.PO_ID
			JOIN LM01106 LM(NOLOCK) ON POM.AC_CODE=LM.AC_CODE
			WHERE POM.CANCELLED=0
		)PO ON A.PRODUCT_CODE=PO.PRODUCT_CODE
		LEFT JOIN 
		(
			SELECT PIM.MRR_NO,PIM.RECEIPT_DT,PID.PRODUCT_CODE
			FROM PIM01106 PIM(NOLOCK)
			JOIN PID01106 PID(NOLOCK) ON PIM.MRR_ID=PID.MRR_ID
			WHERE PIM.CANCELLED=0 AND PIM.INV_MODE=1 /*ONLY PARTY INVOICE*/
		)PUR ON A.PRODUCT_CODE=PUR.PRODUCT_CODE
		LEFT JOIN 
		(
			SELECT PIM.MRR_NO,PIM.RECEIPT_DT,PID.PRODUCT_CODE
			FROM PIM01106 PIM(NOLOCK)
			JOIN PID01106 PID(NOLOCK) ON PIM.MRR_ID=PID.MRR_ID
			WHERE PIM.CANCELLED=0 AND PIM.INV_MODE=2 /*ONLY GROUP INVOICE*/
		)GPUR ON A.PRODUCT_CODE=GPUR.PRODUCT_CODE
		LEFT JOIN 
		(
			SELECT CMM.CM_NO,CMM.CM_DT,CMM.PRODUCT_CODE,CUSTOMER_CODE
			FROM #ORDDLV CMM(NOLOCK)
		)SLS ON SLS.PRODUCT_CODE=(CASE WHEN A.ORDER_TYPE=1 THEN A.REF_PRODUCT_CODE ELSE A.PRODUCT_CODE END)
		AND SLS.CUSTOMER_CODE=B.CUSTOMER_CODE
		WHERE ('''+@CORDER_ID+'''='''' OR  A.ORDER_ID='''+@CORDER_ID+''') 
		AND ('''+@CPRODUCT_CODE+'''='''' OR A.PRODUCT_CODE ='''+@CPRODUCT_CODE+''')
		AND ('''+@CCUSTOMER_CODE+'''='''' OR B.CUSTOMER_CODE ='''+@CCUSTOMER_CODE+''')
		AND ('''+@STATUS+'''=''ALL'' OR ISNULL(SLS.CM_NO,'''') ='''+@STATUS+''')
		AND ISNULL(A.PRODUCT_CODE,'''')<>'''' 
		ORDER BY CASE WHEN ISNULL(PO.PO_NO,'''')='''' THEN 0  ELSE 1 END
		         ,CASE WHEN COALESCE(PUR.MRR_NO,GPUR.MRR_NO,'''')='''' THEN 0 ELSE 1 END 
		         ,CASE WHEN ISNULL(SLS.CM_NO,'''') ='''' THEN 0 ELSE 1 END
		         ,B.ORDER_NO,A.SERIAL_NO'
		
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
		
END
--END OF PROCEDURE - SP3S_RETAILORDER_ITEMSTATUS
