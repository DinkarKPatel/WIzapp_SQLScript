CREATE PROCEDURE SP_RPT_PETTY_EXPENSES_DIFF--(LocId 3 digit change by Sanjay:30-10-2024)
(
  @DTO_DT DATETIME,
  @CAC_CODE VARCHAR(10)=''
)    

AS
BEGIN
   DECLARE @CFIN_YEAR VARCHAR(5)  
   SELECT @CFIN_YEAR='01'+CAST(DBO.FN_GETFINYEAR (@DTO_DT) AS VARCHAR(5))
   
	
    IF OBJECT_ID('TEMPDB..#TMPPED','U') IS NOT NULL
       DROP TABLE #TMPPED	     
   SELECT B.PEM_MEMO_ID ,B.PEM_MEMO_NO,  B.PEM_MEMO_DT ,A.AC_CODE,ISNULL(A.APPROVEDLEVELNO,0) AS LEVEL_NO,
          SUM(CASE WHEN A.XN_TYPE ='DR' THEN XN_AMOUNT ELSE 0 END) AS DR_AMOUNT,
          SUM(CASE WHEN A.XN_TYPE ='CR' THEN XN_AMOUNT ELSE 0 END) AS CR_AMOUNT
   INTO #TMPPED
   FROM PED01106 A
   JOIN PEM01106 B ON A.PEM_MEMO_ID =B.PEM_MEMO_ID 
   JOIN LOCATION SL ON SL.DEPT_ID =b.location_Code
  -- LEFT OUTER JOIN PTCBILLS PB ON PB.PED_ROW_ID =A.ROW_ID 
  -- JOIN #TMPPTCBILLS PB ON A.ROW_ID =PB.PED_ROW_ID 
   WHERE B.CANCELLED =0
   AND (ISNULL(SL.LOC_TYPE,0)=1 OR ISNULL(SL.ACCOUNT_POSTING_AT_HO,0)=1)
   AND  ISNULL(HIDDENFROMAPPROVAL,0)<>1  AND B.FIN_YEAR =@CFIN_YEAR
   GROUP BY  B.PEM_MEMO_ID ,B.PEM_MEMO_NO,B.PEM_MEMO_DT ,A.AC_CODE,ISNULL(A.APPROVEDLEVELNO,0)
   
    IF OBJECT_ID('TEMPDB..#TMPPEDVCH','U') IS NOT NULL
       DROP TABLE #TMPPEDVCH	
       
    SELECT B.MEMO_ID,C.VOUCHER_DT,VD.AC_CODE,
           SUM(DEBIT_AMOUNT) AS DEBIT_AMOUNT,
           SUM(CREDIT_AMOUNT) AS CREDIT_AMOUNT
    INTO #TMPPEDVCH
    FROM POSTACT_VOUCHER_LINK B   
    JOIN VM01106 C ON C.VM_ID = B.VM_ID 
    JOIN VD01106 VD ON VD.VM_ID =C.VM_ID   
    WHERE C.CANCELLED=0 AND B.XN_TYPE = 'PTC' AND C.FIN_YEAR =@CFIN_YEAR 
    GROUP BY B.MEMO_ID,C.VOUCHER_DT,VD.AC_CODE
    
    
    SELECT A.PEM_MEMO_NO  ,A.PEM_MEMO_DT,LM.AC_CODE  ,LM.AC_NAME ,A.LEVEL_NO,A.DR_AMOUNT AS CAL_INV_DR_AMOUNT ,A.CR_AMOUNT AS CAL_INV_CR_AMOUNT,
           ISNULL(B.DEBIT_AMOUNT,0) AS CAL_VCH_DEBIT_AMOUNT ,ISNULL(B.CREDIT_AMOUNT,0) AS CAL_VCH_CREDIT_AMOUNT
    FROM #TMPPED A
    LEFT OUTER JOIN #TMPPEDVCH B ON A.PEM_MEMO_ID =B.MEMO_ID AND A.AC_CODE =B.AC_CODE 
    LEFT OUTER JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
    WHERE  (A.DR_AMOUNT <> ISNULL(B.DEBIT_AMOUNT,0) OR A.CR_AMOUNT <>ISNULL(B.CREDIT_AMOUNT,0) )
    ORDER BY LM.AC_NAME,A.PEM_MEMO_DT,A.PEM_MEMO_NO 
    --EXEC SP_RPT_PETTY_EXPENSES_DIFF '2017-09-12'
 
END
