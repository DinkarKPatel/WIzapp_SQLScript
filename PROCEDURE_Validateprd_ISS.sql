CREATE PROCEDURE VALIDATEPRD_ISS  
 @CXNID VARCHAR(50),   
 @NUPDATEMODE INT,
 @CUSERCODE CHAR(7),
 @CERRORMSG VARCHAR(200) OUTPUT  
-- -- WITH ENCRYPTION
   
AS  
BEGIN  

	
	DECLARE @CMEMO_ID VARCHAR(100),@NISSUE_QTY NUMERIC(12,2),@NREQ_QTY NUMERIC(12,2)
		
		
	SELECT TOP 1  @CMEMO_ID=A.MEMO_ID ,@NREQ_QTY=(A.ISSUE_QTY*B.AVG_QTY) ,
	@NISSUE_QTY=B.QUANTITY
	FROM PRD_AGENCY_ISSUE_ROW_MATERIAL_DET A
	JOIN
	(
      SELECT A.REF_PRD_WORKORDER_MEMOID ,A.MEMO_ID  
      FROM PRD_AGENCY_ISSUE_MATERIAL_DET A
      WHERE  A.MEMO_ID=@CXNID
      GROUP BY A.REF_PRD_WORKORDER_MEMOID ,A.MEMO_ID 
     ) DET ON DET.MEMO_ID =A.MEMO_ID 
	JOIN
	(
	 SELECT A.REF_MATERIAL_ROW_ID , A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID  ,A.AVG_QTY, A.MEMO_ID,B.COMPONENT_CODE , B.COM_PARA1_CODE ,B.COM_PARA2_CODE,B.ARTICLE_CODE ,
	        SUM(A.QUANTITY) AS QUANTITY
	 FROM PRD_AGENCY_ISSUE_MATERIAL_DET A
	 JOIN PRD_SKU B ON A.PRODUCT_UID=B.PRODUCT_UID
	 WHERE A.MEMO_ID=@CXNID
	 GROUP BY A.REF_MATERIAL_ROW_ID , A.REF_PRD_WORKORDER_MEMOID   ,A.AVG_QTY, A.MEMO_ID, B.COM_PARA1_CODE ,B.COM_PARA2_CODE,B.COMPONENT_CODE ,B.ARTICLE_CODE
	) B ON A.MEMO_ID=B.MEMO_ID
	AND DET.REF_PRD_WORKORDER_MEMOID =B.ORDER_ID 
	AND A.ROW_ID =B.REF_MATERIAL_ROW_ID 
	AND A.PARA1_CODE=B.COM_PARA1_CODE
	AND A.PARA2_CODE=B.COM_PARA2_CODE
    WHERE B.QUANTITY>(A.ISSUE_QTY*B.AVG_QTY)
    AND A.MEMO_ID=@CXNID
    
   IF ISNULL(@NISSUE_QTY,0)>ISNULL(@NREQ_QTY,0)
   BEGIN
        SET @CERRORMSG='ISSUE QUANTITY MUST BE LESS THEN OR EQUAL TO REQUIRED QTY.....PLEASE CHECK MEMO_ID- '  
		RETURN  
   END
   
   	-------
    IF EXISTS ( SELECT TOP 1 'U' FROM PRD_AGENCY_ISSUE_MATERIAL_REQ_DET A WHERE ISSUE_QTY >REQ_QTY AND MEMO_ID=@CXNID)
    BEGIN
       SET @CERRORMSG = ' ERROR ISSUE QTY MUST BE LESS THEN REQ QUANTITY....MEMO  '
	   GOTO END_PROC
    
    END
	
   ---  
     
     SELECT TOP 1  @CMEMO_ID=A.MEMO_ID,@NREQ_QTY=ISSUE_QTY,
            @NISSUE_QTY=B.QUANTITY 
     FROM PRD_AGENCY_ISSUE_MATERIAL_REQ_DET A
     JOIN
     (
      SELECT A.REF_PRD_WORKORDER_MEMOID ,A.MEMO_ID  
      FROM PRD_AGENCY_ISSUE_MATERIAL_DET A
      WHERE  A.MEMO_ID=@CXNID
      GROUP BY A.REF_PRD_WORKORDER_MEMOID ,A.MEMO_ID 
     ) DET ON DET.MEMO_ID =A.MEMO_ID 
     JOIN
     (
      SELECT A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID, REF_COMPONENT_ARTICLE_CODE,A.ARTICLE_CODE,A.AVG_QTY, A.MEMO_ID, B.COM_PARA1_CODE ,B.COM_PARA2_CODE,
	       AR.UOM_CODE, SUM(A.QUANTITY) AS QUANTITY
	  FROM PRD_AGENCY_ISSUE_MATERIAL_DET A
	  JOIN PRD_SKU B ON A.PRODUCT_UID=B.PRODUCT_UID
	  JOIN ARTICLE AR ON AR.ARTICLE_CODE=A.ARTICLE_CODE
	  WHERE A.MEMO_ID=@CXNID
	  GROUP BY  A.REF_PRD_WORKORDER_MEMOID,REF_COMPONENT_ARTICLE_CODE,A.ARTICLE_CODE,A.AVG_QTY, A.MEMO_ID, B.COM_PARA1_CODE ,B.COM_PARA2_CODE,
	  AR.UOM_CODE
     ) B ON DET.REF_PRD_WORKORDER_MEMOID=B.ORDER_ID AND
     A.COMPONENT_CODE=B.REF_COMPONENT_ARTICLE_CODE
     AND A.ARTICLE_CODE=B.ARTICLE_CODE 
     AND A.UOM_CODE=B.UOM_CODE
     AND A.MEMO_ID=B.MEMO_ID
     AND A.COM_PARA1_CODE=B.COM_PARA1_CODE
     AND A.COM_PARA2_CODE=B.COM_PARA2_CODE
     WHERE ISSUE_QTY>B.QUANTITY 
      AND  A.MEMO_ID=@CXNID
     
    IF ISNULL(@NISSUE_QTY,0)>ISNULL(@NREQ_QTY,0)
   BEGIN
        SET @CERRORMSG='ROW MATERIAL ISSUE QUANTITY MUST BE LESS THEN OR EQUAL TO REQUIRED QTY.....PLEASE CHECK MEMO_ID- '  +@CMEMO_ID
		RETURN  
   END
   
     
     
END_PROC:  
END  
--*************************************** END OF PROCEDURE VALIDATEXN_SLS
