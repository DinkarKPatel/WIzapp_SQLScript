CREATE PROCEDURE SP_PRD_UPCBARCODE_TRANSACTION_HISTORY
(
 @CPRODUCT_CODE VARCHAR(50)
)
AS
BEGIN
     
     DECLARE @TBLTRANSACTION TABLE(SR INT,DEPT_ID VARCHAR(2),XN_TYPE VARCHAR(10),XN_DT DATETIME,
     XN_NO VARCHAR(20),XN_ID VARCHAR(50),PRODUCT_CODE VARCHAR(100),IN_QTY NUMERIC(1,0),
     OUT_QTY NUMERIC(1,0),DEPARTMENT VARCHAR(50),JOB_NAME VARCHAR(50),ARTICLE_NO VARCHAR(50),COLOR VARCHAR(50))
     
     
     PRINT 'WORK ORDER'
     INSERT INTO @TBLTRANSACTION(SR,DEPT_ID,XN_TYPE,XN_DT,XN_NO,XN_ID,PRODUCT_CODE,IN_QTY,DEPARTMENT,ARTICLE_NO,COLOR )
     SELECT 1 AS SR,
            LEFT(B.MEMO_ID,2) AS DEPT_ID ,
            'WO' AS XN_TYPE,
            B.MEMO_DT AS XN_DT,
            B.MEMO_NO AS XN_NO,
            B.MEMO_ID AS XN_ID,
            A.PRODUCT_CODE,
            1 AS IN_QTY ,
            'RAW MATERIAL STORE' AS DEPARTMENT ,
            ART.ARTICLE_NO ,
            P1.PARA1_NAME 
     FROM PRD_UPCPMT A
     JOIN PRD_WO_MST B ON A.WO_ID =B.MEMO_ID 
     JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_SET_CODE 
     JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
     WHERE PRODUCT_CODE=@CPRODUCT_CODE AND CANCELLED=0
     
     
     PRINT 'WORK ORDER CANCELLETION'
     INSERT INTO @TBLTRANSACTION(SR,DEPT_ID,XN_TYPE,XN_DT,XN_NO,XN_ID,PRODUCT_CODE,OUT_QTY,DEPARTMENT,ARTICLE_NO,COLOR)
     SELECT 2 AS SR,
            LEFT(B.MEMO_ID,2) AS DEPT_ID ,
            'WOCNC' AS XN_TYPE,
            MST.MEMO_DT AS XN_DT,
            MST.MEMO_NO AS XN_NO,
            MST.MEMO_ID AS XN_ID,
            A.PRODUCT_CODE,
            C.QUANTITY AS IN_QTY  ,
           'RAW MATERIAL STORE' AS DEPARTMENT ,
           ART.ARTICLE_NO ,
           P1.PARA1_NAME 
     FROM PRD_UPCPMT A
     JOIN PRD_WO_MST B ON A.WO_ID =B.MEMO_ID 
     JOIN PRD_WO_CNC_UPC C ON A.PRODUCT_CODE =C.PRODUCT_CODE 
     JOIN PRD_WO_CNC_MST  MST ON MST.MEMO_ID  =C.MEMO_ID  
     JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_SET_CODE 
     JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
     WHERE A.PRODUCT_CODE=@CPRODUCT_CODE AND MST.CANCELLED =0
     
     PRINT 'AGENCY ISSUE MATERIAL'
     
     INSERT INTO @TBLTRANSACTION(SR,DEPT_ID,XN_TYPE,XN_DT,XN_NO,XN_ID,PRODUCT_CODE,OUT_QTY,DEPARTMENT,JOB_NAME,ARTICLE_NO,COLOR)
      SELECT 3 AS SR,
            LEFT(B.MEMO_ID,2) AS DEPT_ID ,
            'ISSUE' AS XN_TYPE,
            MST.MEMO_DT AS XN_DT,
            MST.MEMO_NO AS XN_NO,
            MST.MEMO_ID AS XN_ID,
            A.PRODUCT_CODE,
            C.QUANTITY AS IN_QTY ,
            DM.DEPARTMENT_NAME ,
            JOBS.JOB_NAME ,
            ART.ARTICLE_NO ,
           P1.PARA1_NAME  
     FROM PRD_UPCPMT A
     JOIN PRD_WO_MST B ON A.WO_ID =B.MEMO_ID 
     JOIN PRD_AGENCY_ISSUE_MATERIAL_UPC  C ON A.PRODUCT_CODE =C.PRODUCT_CODE 
     JOIN PRD_AGENCY_ISSUE_MATERIAL_MST  MST ON MST.MEMO_ID  =C.MEMO_ID  
     JOIN
     (
      SELECT MEMO_ID ,JOB_CODE FROM PRD_AGENCY_ISSUE_MATERIAL_DET
      GROUP BY MEMO_ID ,JOB_CODE
     ) JB ON JB.MEMO_ID =MST.MEMO_ID 
     JOIN PRD_DEPARTMENT_MST DM ON DM.DEPARTMENT_ID =MST.DEPARTMENT_ID 
     JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_SET_CODE 
     JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
     LEFT JOIN JOBS ON JOBS.JOB_CODE=JB.JOB_CODE 
     WHERE A.PRODUCT_CODE=@CPRODUCT_CODE AND MST.CANCELLED =0
     
     
  
     
     PRINT 'AGENCY RECEIVE'
     
     INSERT INTO @TBLTRANSACTION(SR,DEPT_ID,XN_TYPE,XN_DT,XN_NO,XN_ID,PRODUCT_CODE,IN_QTY,DEPARTMENT,JOB_NAME,ARTICLE_NO,COLOR)
      SELECT 4 AS SR,
            LEFT(B.MEMO_ID,2) AS DEPT_ID ,
            'REC' AS XN_TYPE,
            MST.MEMO_DT AS XN_DT,
            MST.MEMO_NO AS XN_NO,
            MST.MEMO_ID AS XN_ID,
            A.PRODUCT_CODE,
            C.QUANTITY AS IN_QTY  ,
            DM.DEPARTMENT_NAME ,
            JOBS.JOB_NAME ,
            ART.ARTICLE_NO ,
            P1.PARA1_NAME  
     FROM PRD_UPCPMT A
     JOIN PRD_WO_MST B ON A.WO_ID =B.MEMO_ID 
     JOIN PRD_AGENCY_MATERIAL_RECEIPT_UPC   C ON A.PRODUCT_CODE =C.PRODUCT_CODE 
     JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST  MST ON MST.MEMO_ID  =C.MEMO_ID  
     JOIN
     (
      SELECT A.MEMO_ID ,B.JOB_CODE 
      FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A
      JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B ON A.REF_ROW_ID =B.ROW_ID 
      JOIN PRD_AGENCY_ISSUE_MATERIAL_MST C ON B.MEMO_ID =C.MEMO_ID 
      WHERE C.CANCELLED =0
      GROUP BY A.MEMO_ID ,B.JOB_CODE 
     ) JB ON JB.MEMO_ID =MST.MEMO_ID 
     JOIN PRD_DEPARTMENT_MST DM ON DM.DEPARTMENT_ID =MST.DEPARTMENT_ID 
     JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_SET_CODE 
     JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
     JOIN JOBS ON JOBS.JOB_CODE=JB.JOB_CODE 
     WHERE A.PRODUCT_CODE=@CPRODUCT_CODE AND MST.CANCELLED =0

     
     PRINT 'TRANSFER TO TRADING'
     
     INSERT INTO @TBLTRANSACTION(SR,DEPT_ID,XN_TYPE,XN_DT,XN_NO,XN_ID,PRODUCT_CODE,OUT_QTY,DEPARTMENT,ARTICLE_NO,COLOR)
      SELECT 5 AS SR,
            LEFT(B.MEMO_ID,2) AS DEPT_ID ,
            CASE WHEN ISNULL(MODE,0)=0 THEN 'TTM' ELSE 'WIP_CNC' END AS XN_TYPE,
            MST.MEMO_DT AS XN_DT,
            MST.MEMO_NO AS XN_NO,
            MST.MEMO_ID AS XN_ID,
            A.PRODUCT_CODE,
            C.QUANTITY AS IN_QTY ,
            DM.DEPARTMENT_NAME  ,
            ART.ARTICLE_NO ,
            P1.PARA1_NAME  
     FROM PRD_UPCPMT A
     JOIN PRD_WO_MST B ON A.WO_ID =B.MEMO_ID 
     JOIN PRD_TRANSFER_TO_TRADING_UPC   C ON A.PRODUCT_CODE =C.PRODUCT_CODE 
     JOIN PRD_TRANSFER_MAIN_MST   MST ON MST.MEMO_ID  =C.MEMO_ID  
     JOIN PRD_DEPARTMENT_MST DM ON DM.DEPARTMENT_ID =MST.SOURCE_DEPARTMENT_ID 
     JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_SET_CODE 
     JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
     WHERE A.PRODUCT_CODE=@CPRODUCT_CODE AND MST.CANCELLED =0
     
     SELECT SR,DEPT_ID,XN_TYPE,XN_DT,XN_NO,
            XN_ID,PRODUCT_CODE,IN_QTY ,OUT_QTY,
            DEPARTMENT ,JOB_NAME,ARTICLE_NO,COLOR
     FROM @TBLTRANSACTION
     ORDER BY XN_DT,SR
     
     
     
END
