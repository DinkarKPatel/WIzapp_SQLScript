create PROCEDURE SP3S_GET_CURSOR_BASED_ON_OLAP_XNSSENDING_COLS
(
	@cXNTYPE	VARCHAR(100),
	@cTABLENAME	VARCHAR(100),
	@cKEYNAME	VARCHAR(100),
	@cKEYVALUE	VARCHAR(100),
	@bSKUNAMES	BIT=0,
	@bPMT	BIT=0,
	@CERRMSG VARCHAR(MAX) OUTPUT
)
AS
BEGIN
	DECLARE @cCols NVARCHAR(MAX),@cnullableCols NVARCHAR(MAX), @cCmdCols NVARCHAR(MAX),@cTARGET_TABLENAME VARCHAR(100),@CSTEP VARCHAR(5) 
	BEGIN TRY
		SET @CERRMSG=''
		SET @cTARGET_TABLENAME=@cXNTYPE+'_'+@cTABLENAME+'_UPLOAD'
		SET @CSTEP=10     
		SELECT @cCols=COALESCE(@cCols+',','')+colname 	FROM olap_xnssending_cols WHERE tablename=@cTABLENAME 
		SET @cCols=ISNULL(@cCols,'')
		SET @CSTEP=20  
		SET @cCmdCols=N'
		   SELECT '''+@cTARGET_TABLENAME+''' AS TARGET_TABLENAME,'+@cCols+' FROM '+@cTABLENAME+'  (NOLOCK)   WHERE '+@cKEYNAME+'='''+@cKEYVALUE+''''
		PRINT @cCmdCols
		SET @CSTEP=30     
		EXEC SP_EXECUTESQL @cCmdCols
		if @bSKUNAMES=1
		BEGIN
			SET @CSTEP=40     
			SET @cTARGET_TABLENAME='OLAP_SKU_NAMES_UPLOAD'
			SET @cCmdCols=N'
			 SELECT DISTINCT '''+@cTARGET_TABLENAME+''' AS TARGET_TABLENAME,B.*, '''+@cKEYVALUE+''' AS '+@cXNTYPE+'_MEMO_ID    
			 FROM '+@cTABLENAME+' (NOLOCK) A  
			 JOIN SKU_NAMES (NOLOCK) B ON A.PRODUCT_CODE  =B.PRODUCT_CODE  
			 WHERE A.'+@cKEYNAME+'='''+@cKEYVALUE  +'''
			 UNION
			 SELECT DISTINCT '''+@cTARGET_TABLENAME+''' AS TARGET_TABLENAME,B.*, '''+@cKEYVALUE +''' AS '+@cXNTYPE+'_MEMO_ID     
			 FROM '+@cTABLENAME+' (NOLOCK) A  
			 JOIN SKU_NAMES (NOLOCK) B ON LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))  =B.PRODUCT_CODE  
			 WHERE A.'+@cKEYNAME+'='''+@cKEYVALUE +'''
			 AND CHARINDEX (''@'',A.product_code )<>0'
		PRINT @cCmdCols
		SET @CSTEP=50     

		EXEC SP_EXECUTESQL @cCmdCols


		SET @cTARGET_TABLENAME='OLAP_SKU_UPLOAD'
			
		SET @cCols=''
		SELECT @cCols=COALESCE(@cCols+',','')+'B.'+colname 	FROM olap_xnssending_cols WHERE tablename='sku'
			SET @cCols=ISNULL(@cCols,'')

		SET @cCmdCols=N'
			 SELECT DISTINCT '''+@cTARGET_TABLENAME+''' AS TARGET_TABLENAME'+@cCols+', '''+@cKEYVALUE+''' AS '+@cXNTYPE+'_MEMO_ID    
			 FROM   '+@cTABLENAME+' (NOLOCK) A  
			 JOIN sku (NOLOCK) B ON A.product_code  =B.PRODUCT_CODE  
			 WHERE A.'+@cKEYNAME+'='''+@cKEYVALUE  +'''
			 UNION
			 SELECT DISTINCT '''+@cTARGET_TABLENAME+''' AS TARGET_TABLENAME'+@cCols+', '''+@cKEYVALUE +''' AS '+@cXNTYPE+'_MEMO_ID     
			 FROM '+@cTABLENAME+' (NOLOCK) A  
			 JOIN sku (NOLOCK) B ON LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))  =B.PRODUCT_CODE    
			 WHERE A.'+@cKEYNAME+'='''+@cKEYVALUE +'''
			 AND CHARINDEX (''@'',A.product_code )<>0'

			PRINT @cCmdCols
			SET @CSTEP=90     

			EXEC SP_EXECUTESQL @cCmdCols

		END
		if @bPMT=1
		BEGIN
			SET @CSTEP=60     
			SET @cTARGET_TABLENAME='OLAP_PMT01106_UPLOAD'
			SET @CSTEP=70  
			SET @cCols=''
			SELECT @cCols=COALESCE(@cCols+',','')+'B.'+colname 	FROM olap_xnssending_cols WHERE tablename='PMT01106'
			SET @cCols=ISNULL(@cCols,'')
			SET @CSTEP=80     
			SET @cCmdCols=N'
			 SELECT DISTINCT '''+@cTARGET_TABLENAME+''' AS TARGET_TABLENAME'+@cCols+', '''+@cKEYVALUE+''' AS '+@cXNTYPE+'_MEMO_ID    
			 FROM '+@cTABLENAME+' (NOLOCK) A  
			 JOIN PMT01106 (NOLOCK) B ON A.PRODUCT_CODE  =B.PRODUCT_CODE  AND B.DEPT_ID=LEFT(A.'++@cKEYNAME+',2)
			 WHERE A.'+@cKEYNAME+'='''+@cKEYVALUE  +'''
			 UNION
			 SELECT DISTINCT '''+@cTARGET_TABLENAME+''' AS TARGET_TABLENAME'+@cCols+', '''+@cKEYVALUE +''' AS '+@cXNTYPE+'_MEMO_ID     
			 FROM '+@cTABLENAME+' (NOLOCK) A  
			 JOIN PMT01106 (NOLOCK) B ON LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))  =B.PRODUCT_CODE    AND B.DEPT_ID=LEFT(A.'++@cKEYNAME+',2)
			 WHERE A.'+@cKEYNAME+'='''+@cKEYVALUE +'''
			 AND CHARINDEX (''@'',A.product_code )<>0'

			PRINT @cCmdCols
			SET @CSTEP=90     

			EXEC SP_EXECUTESQL @cCmdCols
		END
END TRY  
BEGIN CATCH  
 SET @CERRMSG='P: SP3S_GET_CURSOR_BASED_ON_OLAP_XNSSENDING_COLS, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
END CATCH   

	
END
