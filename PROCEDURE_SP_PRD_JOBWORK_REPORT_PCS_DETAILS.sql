CREATE  PROCEDURE SP_PRD_JOBWORK_REPORT_PCS_DETAILS  

(  
 @CAGENCY_CODE VARCHAR(MAX)='',  
 @NPENDING INT=0,
 @NSUMMARY INT=0,  -- 1 FOR SUMMARY 2 FOR DETAILS
 @CARTICLE_CODE VARCHAR(10)='',
 @DAS_ON DATETIME=''
)  
AS  
BEGIN  
  
  
     DECLARE @DTSQL NVARCHAR(MAX),@AC_CODE VARCHAR(MAX)  
     IF @CAGENCY_CODE=''  
     BEGIN  
     SET @AC_CODE=''  
     SET @CAGENCY_CODE='IN('''')'  
     END  
     ELSE   
     BEGIN  
     SET @AC_CODE='LATER'  
     END  
    
     IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL  
        DROP TABLE #TMPISSUE  
        
       IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL    
        DROP TABLE #TMPISSUE    
          
     SELECT ORD.WORK_ORDER_ID AS ORDER_ID, ORD.ORDER_NO,  A.REF_AGENCY_CODE AS AGENCY_CODE,
     B.PARA1_CODE,B.PARA2_CODE,B.ARTICLE_CODE,    
     C.AGENCY_NAME,P1.PARA1_NAME,P2.PARA2_NAME,    
     AR.ARTICLE_NO AS FG_ARTICLE_NO,    
     AR.ARTICLE_NAME AS FG_ARTICLE_NAME,    
     B.ISSUE_QTY AS ISSUE_QTY,
     A.MEMO_NO AS ISSUE_NO,  
     A.MEMO_DT AS ISSUE_DT ,
     A.MEMO_ID AS ISSUE_ID 
     INTO #TMPISSUE    
     FROM PRD_AGENCY_ISSUE_MATERIAL_MST (NOLOCK) A    
     JOIN PRD_AGENCY_ISSUE_ROW_MATERIAL_DET (NOLOCK) B ON A.MEMO_ID =B.MEMO_ID   
     JOIN  
     (  
       SELECT MST.MEMO_NO AS ORDER_NO, A.MEMO_ID, REF_MATERIAL_ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID   
       FROM PRD_AGENCY_ISSUE_MATERIAL_DET A  
       JOIN PRD_WO_MST MST ON A.REF_PRD_WORKORDER_MEMOID=MST.MEMO_ID  
       GROUP BY MST.MEMO_NO,A.MEMO_ID, REF_MATERIAL_ROW_ID,A.REF_PRD_WORKORDER_MEMOID  
     ) ORD ON  ORD.MEMO_ID=B.MEMO_ID AND B.ROW_ID =ORD.REF_MATERIAL_ROW_ID    
     JOIN ARTICLE AR ON AR.ARTICLE_CODE=B.ARTICLE_CODE    
     JOIN PRD_AGENCY_MST (NOLOCK) C ON A.REF_AGENCY_CODE =C.AGENCY_CODE    
     JOIN PARA1 P1 ON P1.PARA1_CODE=B.PARA1_CODE    
     JOIN PARA2 P2 ON P2.PARA2_CODE=B.PARA2_CODE    
     WHERE  
     1=2    
        
          
    SET @DTSQL=N' SELECT ORD.WORK_ORDER_ID AS ORDER_ID, ORD.ORDER_NO,  A.REF_AGENCY_CODE AS AGENCY_CODE,B.PARA1_CODE,B.PARA2_CODE,B.ARTICLE_CODE,  
      C.AGENCY_NAME,P1.PARA1_NAME,P2.PARA2_NAME,  
     AR.ARTICLE_NO AS FG_ARTICLE_NO,  
     AR.ARTICLE_NAME AS FG_ARTICLE_NAME,  
     SUM(B.ISSUE_QTY) AS ISSUE_QTY,
     A.MEMO_NO AS ISSUE_NO,  
     A.MEMO_DT AS ISSUE_DT,
     A.MEMO_ID AS ISSUE_ID 
     FROM PRD_AGENCY_ISSUE_MATERIAL_MST (NOLOCK) A  
     JOIN PRD_AGENCY_ISSUE_ROW_MATERIAL_DET (NOLOCK) B ON A.MEMO_ID =B.MEMO_ID 
     JOIN
     (
       SELECT MST.MEMO_NO AS ORDER_NO, A.MEMO_ID, REF_MATERIAL_ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID 
       FROM PRD_AGENCY_ISSUE_MATERIAL_DET A
       JOIN PRD_WO_MST MST ON A.REF_PRD_WORKORDER_MEMOID=MST.MEMO_ID
       WHERE ISNULL(MST.MARK_AS_COMPLETED,0)<>2
       GROUP BY MST.MEMO_NO,A.MEMO_ID, REF_MATERIAL_ROW_ID,A.REF_PRD_WORKORDER_MEMOID
     ) ORD ON  ORD.MEMO_ID=B.MEMO_ID AND B.ROW_ID =ORD.REF_MATERIAL_ROW_ID  
     JOIN ARTICLE AR ON AR.ARTICLE_CODE=B.ARTICLE_CODE  
     JOIN PRD_AGENCY_MST (NOLOCK) C ON A.REF_AGENCY_CODE =C.AGENCY_CODE  
     JOIN PARA1 P1 ON P1.PARA1_CODE=B.PARA1_CODE  
     JOIN PARA2 P2 ON P2.PARA2_CODE=B.PARA2_CODE  
     WHERE ('''+@AC_CODE+'''='''' OR C.AC_CODE  '+@CAGENCY_CODE+' )  
     AND ('''+@CARTICLE_CODE+'''='''' OR B.ARTICLE_CODE='''+@CARTICLE_CODE+''')
      AND ('''+CONVERT(VARCHAR(10), @DAS_ON,121)+'''=''1900-01-01'' OR A.MEMO_DT<='''+CONVERT(VARCHAR(10), @DAS_ON,121)+''')    
     AND A.CANCELLED =0  
     GROUP BY ORD.WORK_ORDER_ID ,B.ARTICLE_CODE,A.REF_AGENCY_CODE,B.PARA1_CODE,B.PARA2_CODE,C.AGENCY_NAME,P1.PARA1_NAME,P2.PARA2_NAME,  
     AR.ARTICLE_NO ,  
     AR.ARTICLE_NAME ,ORD.ORDER_NO, A.MEMO_NO ,  
     A.MEMO_DT ,A.MEMO_ID   '
     
     PRINT @DTSQL  
     INSERT INTO #TMPISSUE  
     EXEC SP_EXECUTESQL @DTSQL  
     
       
     IF OBJECT_ID ('TEMPDB..#TMPREC','U') IS NOT NULL    
        DROP TABLE #TMPREC   
          
          
   SELECT ORD.ORDER_ID, B.AGENCY_CODE,A.ARTICLE_CODE ,PARA1_CODE,PARA2_CODE,    
   REC_QTY AS  REC_QTY,
   B.MEMO_NO AS RECEIVE_NO,  
   B.MEMO_DT AS RECEIVE_DT,
   A.MEMO_ID AS REC_ISSUE_ID
   INTO #TMPREC    
   FROM PRD_AGENCY_ROW_MATERIAL_RECEIPT_DET A    
   JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID  
   JOIN  
   (  
      
    SELECT A.REF_MATERIAL_ROW_ID , A.MEMO_ID,B.ORDER_ID FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A    
    JOIN    
    (    
     SELECT A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID FROM PRD_AGENCY_ISSUE_MATERIAL_DET A  
     JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID   
     WHERE CANCELLED =0  
          
     UNION     
     SELECT A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID 
     FROM PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING  A  
     JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.REF_ISSUE_ID =B.MEMO_ID   
     WHERE CANCELLED =0    
    ) B ON A.REF_ROW_ID=B.ROW_ID    
    GROUP BY A.REF_MATERIAL_ROW_ID ,A.MEMO_ID,B.ORDER_ID    
   )ORD ON ORD.MEMO_ID=B.MEMO_ID    
   AND ORD.REF_MATERIAL_ROW_ID =A.ROW_ID   
  JOIN PRD_AGENCY_MST (NOLOCK) C ON B.AGENCY_CODE =C.AGENCY_CODE      
   WHERE 1=2  
    
   
     
   SET @DTSQL=N'SELECT ORD.ORDER_ID, B.AGENCY_CODE,A.ARTICLE_CODE ,PARA1_CODE,PARA2_CODE,  
   SUM(REC_QTY) AS  REC_QTY,
   B.MEMO_NO AS RECEIVE_NO,  
   B.MEMO_DT AS RECEIVE_DT,
   ORD.ISSUE_ID  
   FROM PRD_AGENCY_ROW_MATERIAL_RECEIPT_DET A  
   JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID
   JOIN
   (
    
    SELECT B.ISSUE_ID, A.REF_MATERIAL_ROW_ID , A.MEMO_ID,B.ORDER_ID FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A  
    JOIN  
    (  
     SELECT A.MEMO_ID AS ISSUE_ID, A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID FROM PRD_AGENCY_ISSUE_MATERIAL_DET A
     JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID 
     WHERE CANCELLED =0
     AND ('''+CONVERT(VARCHAR(10), @DAS_ON,121)+'''=''1900-01-01'' OR B.MEMO_DT<='''+CONVERT(VARCHAR(10), @DAS_ON,121)+''')
        
     UNION   
     SELECT B.MEMO_ID AS ISSUE_ID,A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID FROM PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING  A
      JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.REF_ISSUE_ID =B.MEMO_ID 
     WHERE CANCELLED =0  
    ) B ON A.REF_ROW_ID=B.ROW_ID  
    GROUP BY B.ISSUE_ID,A.REF_MATERIAL_ROW_ID ,A.MEMO_ID,B.ORDER_ID  
   )ORD ON ORD.MEMO_ID=B.MEMO_ID  
   AND ORD.REF_MATERIAL_ROW_ID =A.ROW_ID 
  JOIN PRD_AGENCY_MST (NOLOCK) C ON B.AGENCY_CODE =C.AGENCY_CODE    
  WHERE ( '''+@AC_CODE+'''='''' OR C.AC_CODE '+@CAGENCY_CODE+')  
   AND ('''+@CARTICLE_CODE+'''='''' OR A.ARTICLE_CODE='''+@CARTICLE_CODE+''') 
   -- AND ('''+CONVERT(VARCHAR(10), @DAS_ON,121)+'''=''1900-01-01'' OR B.MEMO_DT<='''+CONVERT(VARCHAR(10), @DAS_ON,121)+''')   
   AND B.CANCELLED =0  
   GROUP BY ORD.ISSUE_ID  ,ORD.ORDER_ID,B.AGENCY_CODE,A.ARTICLE_CODE ,PARA1_CODE,PARA2_CODE,B.MEMO_NO ,  
   B.MEMO_DT  '
    
   PRINT @DTSQL  
   INSERT INTO #TMPREC  
   EXEC SP_EXECUTESQL @DTSQL  
   
   
   --SELECT * INTO TMPISSUE FROM #TMPISSUE
   
   
   
   IF OBJECT_ID ('TEMPDB..#TMPISSUE_REC','U') IS NOT NULL
      DROP TABLE #TMPISSUE_REC
   
   SELECT A.ORDER_ID,
          A.ORDER_NO,A.AGENCY_CODE,
          A.AGENCY_NAME,
          A.PARA1_CODE,
          A.PARA1_NAME,
          A.PARA2_CODE,
          A.PARA2_NAME,
          A.ARTICLE_CODE,
          A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME,
          A.ISSUE_ID,
          A.ISSUE_NO,
          A.ISSUE_DT ,
          A.ISSUE_QTY,
          B.RECEIVE_NO,
          B.RECEIVE_DT ,
          B.REC_QTY ,
         
          SR=ROW_NUMBER() OVER (PARTITION BY A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID  ORDER BY A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID )  
   INTO #TMPISSUE_REC    
   FROM #TMPISSUE A
   LEFT OUTER JOIN
   (       
	 SELECT A.REC_ISSUE_ID,A.RECEIVE_NO,A.RECEIVE_DT, 
	 A.ORDER_ID, A.AGENCY_CODE,A.ARTICLE_CODE ,A.PARA1_CODE,A.PARA2_CODE,  
	 A.REC_QTY   
	 FROM #TMPREC A       
	) B ON A.AGENCY_CODE=B.AGENCY_CODE AND A.PARA1_CODE =B.PARA1_CODE   
	   AND A.PARA2_CODE =B.PARA2_CODE AND A.ARTICLE_CODE=B.ARTICLE_CODE 
	   AND A.ORDER_ID=B.ORDER_ID AND A.ISSUE_ID=B.REC_ISSUE_ID
    ORDER BY A.ISSUE_ID
   
   
  -- SELECT * INTO TMPREC FROM #TMPREC
   
   
   
 --  UPDATE #TMPISSUE_REC SET ISSUE_QTY=0 WHERE SR>1
 
 IF OBJECT_ID('TEMPDB..#TMPFINAL','U') IS NOT NULL
    DROP TABLE #TMPFINAL
 
   SELECT A.ORDER_ID,
          A.ORDER_NO,
          A.AGENCY_NAME,
          A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME, 
          A.PARA1_NAME AS FG_COLOR, 
          A.PARA2_NAME AS FG_SIZE, 
          A.ISSUE_ID,
          A.ISSUE_NO,
          A.ISSUE_DT ,
          A.SR,
          CASE WHEN A.SR=1 THEN  A.ISSUE_QTY ELSE 0 END AS ISSUE_QTY,
          ISNULL(A.RECEIVE_NO,'') AS RECEIVE_NO,
          ISNULL(A.RECEIVE_DT,'') AS  RECEIVE_DT,
          ISNULL(A.REC_QTY,0) AS  REC_QTY,
          SUM(B.REC_QTY ) AS CUMM_REC,
          A.ISSUE_QTY-SUM(ISNULL(B.REC_QTY,0)) AS PENDING_QTY 
   INTO #TMPFINAL 
   FROM #TMPISSUE_REC A
   JOIN #TMPISSUE_REC B ON A.ISSUE_ID=B.ISSUE_ID AND  A.ORDER_ID=B.ORDER_ID AND A.PARA1_CODE =B.PARA1_CODE AND A.PARA2_CODE =B.PARA2_CODE AND  B.SR<=A.SR
   GROUP BY A.ORDER_ID,
          A.ORDER_NO,A.AGENCY_CODE,
          A.AGENCY_NAME,
          A.PARA1_CODE,
          A.PARA1_NAME,
          A.PARA2_CODE,
          A.PARA2_NAME,
          A.ARTICLE_CODE,
          A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME,
          A.ISSUE_ID,
          A.ISSUE_NO,
          A.ISSUE_DT ,
          A.ISSUE_QTY,
          A.RECEIVE_NO,
          A.RECEIVE_DT ,
          A.REC_QTY,
          A.SR,
          CASE WHEN A.SR=1 THEN  A.ISSUE_QTY ELSE 0 END
   ORDER BY A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID,A.SR
       
       
       
   IF ISNULL(@NPENDING,0)=1
	BEGIN   
	 
	 DELETE A FROM #TMPFINAL A
	 JOIN
	 (
	 SELECT A.* FROM #TMPFINAL A
	 JOIN
	 (
	 SELECT  A.AGENCY_NAME, A.FG_COLOR,A.FG_SIZE,A.FG_ARTICLE_NO ,A.ORDER_ID,A.ISSUE_ID,MAX(SR)AS SR
	 FROM #TMPFINAL A 
	 GROUP BY  A.AGENCY_NAME, A.FG_COLOR,A.FG_SIZE,A.FG_ARTICLE_NO ,A.ORDER_ID,A.ISSUE_ID
	 ) B ON A.AGENCY_NAME=B.AGENCY_NAME 
	 AND  A.FG_COLOR=B.FG_COLOR 
	 AND A.FG_SIZE=B.FG_SIZE
	 AND A.FG_ARTICLE_NO=B. FG_ARTICLE_NO
	 AND A.ORDER_ID=B.ORDER_ID
	 AND A.ISSUE_ID=B.ISSUE_ID
	 AND A.SR=B.SR AND A.PENDING_QTY=0
	 ) B 
	 ON A.AGENCY_NAME=B.AGENCY_NAME 
	 AND  A.FG_COLOR=B.FG_COLOR 
	 AND A.FG_SIZE=B.FG_SIZE
	 AND A.FG_ARTICLE_NO=B. FG_ARTICLE_NO
	 AND A.ORDER_ID=B.ORDER_ID
	 AND A.ISSUE_ID=B.ISSUE_ID
   
   
    END
	  
--	  DROP TABLE TMPFINAL
--	  SELECT * INTO  TMPFINAL FROM #TMPFINAL A
	  
	  

--SELECT WO_ID,PARA1_CODE,PARA2_CODE ,COUNT(*) AS CNT INTO TMPUPC FROM PRD_UPCPMT A
--JOIN PRD_WO_MST B ON A.WO_ID =B.MEMO_ID 
--WHERE QUANTITY_IN_STOCK =0 AND B.CANCELLED =0
--AND ISNULL(B.MARK_AS_COMPLETED,0) <>2
--AND A.PRODUCT_CODE NOT IN
--(SELECT WIP_PRODUCT_CODE FROM PRD_TRANSFER_MAIN_DET A
--JOIN PRD_TRANSFER_MAIN_MST B ON A.MEMO_ID =B.MEMO_ID 
--WHERE B.CANCELLED =0)
--GROUP BY  WO_ID,PARA1_CODE,PARA2_CODE 
	  
	  SELECT A.ORDER_ID,
          A.ORDER_NO,
          A.AGENCY_NAME,
          A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME, 
          A. FG_COLOR, 
          A. FG_SIZE, 
          A.ISSUE_ID,
          A.ISSUE_NO,
          A.ISSUE_DT ,
          A.SR,
          CASE WHEN A.SR=1 THEN  A.ISSUE_QTY ELSE 0 END AS ISSUE_QTY,
          ISNULL(A.RECEIVE_NO,'') AS RECEIVE_NO,
          ISNULL(A.RECEIVE_DT,'') AS  RECEIVE_DT,
          ISNULL(A.REC_QTY,0) AS  REC_QTY,
          CUMM_REC AS CUMM_REC,
          PENDING_QTY AS PENDING_QTY  
          FROM #TMPFINAL A
          ORDER BY A.AGENCY_NAME, A.ISSUE_ID  ,   A. FG_COLOR,A.SR
END
