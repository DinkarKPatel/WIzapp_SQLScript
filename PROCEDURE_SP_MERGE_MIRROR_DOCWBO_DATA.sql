
create PROCEDURE SP_MERGE_MIRROR_DOCWBO_DATA        
(        
	 @CMEMOID VARCHAR(50),        
	 @CLOCID VARCHAR(4),        
	 @CERRMSG VARCHAR(MAX) OUTPUT        
)        
AS        
BEGIN 
 
 SET NOCOUNT ON        
 
 DECLARE @DTSQL NVARCHAR(MAX),@CSOURCEDB VARCHAR(200),@CTMP_TABLENAME VARCHAR(200),        
   @CJOINSTR VARCHAR(MAX),@CERRORMSG VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100),        
   @CTABLENAME VARCHAR(200),@CERRMSGOUT VARCHAR(MAX),@CSTEP VARCHAR(20),@CKEYFIELD VARCHAR(100)        
   ,@CKEYFIELD1 VARCHAR(100),@CMERGEDB VARCHAR(50)
   ,@INV_MODE INT,@CFINYEAR VARCHAR(10),@MRR_NO VARCHAR(50),@INV_ID VARCHAR(50)      
   ,@TEMP_TABLE1 VARCHAR(20),@CCMD NVARCHAR(MAX), @CCURDEPTID VARCHAR(4),@CHODEPTID VARCHAR(4),
   @BSOURCEPURLOC BIT,@BTARGETPURLOC BIT,@BGENERATEAUTOSERIES BIT,@CSOURCELOCID VARCHAR(4), @BHOLOC BIT,@BSKU_OH BIT,
   @NTARGETLOCTYPE INT,@BMSTINSERTONLY BIT,@CMEMONOPREFIX VARCHAR(100),@CPARTYDEPTID VARCHAR(5),
   @BCHALLANRECEIVEDPREV BIT,@CTABLESSTR VARCHAR(MAX),@BGETCHALLANTHRUMIRROR BIT,@CSOURCETEMPTABLE VARCHAR(500),
   @CTMPINDTABLE VARCHAR(500),@NVERSIONNO INT,@NINVMODE INT,@CFILTERCONDITION VARCHAR(MAX),@CCMDOUTPUT VARCHAR(MAX),@CFILTERCONDITION1 VARCHAR(MAX),
   @BSENDPURINFOLOC BIT,@NMSTTOTALQTY numeric(10,3),@NDetTotalQty numeric(10,3)
  
 
 BEGIN TRY        
  
  SET @CSTEP=2
    	 
  SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'
  SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'
  
  SET @CSTEP=5	
  SET @CSOURCEDB=DB_NAME()+'.DBO.'
          
  SET @CTABLESUFFIX=REPLACE(@CMEMOID,'-','_') 
  SET @CFILTERCONDITION=''
  SET @CTMP_TABLENAME=@CSOURCEDB+'DOCWBO_BUYER_ORDER_MST_MIRROR'
  
  SELECT TOP 1 @NVERSIONNO=MAX(VERSION_NO) FROM DOCWBO_BUYER_ORDER_MST_MIRROR WHERE ORDER_ID=@CMEMOID
    
  SELECT @CFILTERCONDITION=' A.ORDER_ID='''+@CMEMOID+''' AND A.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO))) 	
		 
     
  SET @CCMD=N'SELECT @CPARTYDEPTID=WBO_FOR_DEPT_ID FROM '+@CTMP_TABLENAME+' A WHERE '+@CFILTERCONDITION
  
  PRINT @CCMD
  EXEC SP_EXECUTESQL @CCMD,N'@CPARTYDEPTID VARCHAR(5) OUTPUT',@CPARTYDEPTID OUTPUT
    
  IF ISNULL(@CMEMOID,'')=''
	GOTO EXIT_PROC     
  
  IF @CPARTYDEPTID<>@CCURDEPTID
  BEGIN
	SET @CERRMSG = 'THE CHALLAN NO.:'+RIGHT(@CMEMOID,10)+' BELONGS TO LOCATION ID :'+@CPARTYDEPTID+' OTHER THAN CURRENT LOCATION ID:'+@CCURDEPTID		
	GOTO EXIT_PROC
  END
  
  SELECT TOP 1 @CSOURCELOCID=DEPT_ID,@BSOURCEPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=LEFT(@CMEMOID,2)	
  SELECT TOP 1 @BTARGETPURLOC=PUR_LOC,@NTARGETLOCTYPE=LOC_TYPE,@BSENDPURINFOLOC=UPD_PURINFO
  FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID


  SELECT @NMSTTOTALQTY=TOTAL_QUANTITY FROM DOCWBO_BUYER_ORDER_MST_MIRROR (nolock) WHERE ORDER_ID=@CMEMOID AND VERSION_NO=@NVERSIONNO
  SELECT @NDETTOTALQTY=SUM(QUANTITY) FROM DOCWBO_BUYER_ORDER_DET_MIRROR (NOLOCK)  WHERE ORDER_ID=@CMEMOID AND VERSION_NO=@NVERSIONNO
  
  if isnull(@NMSTTOTALQTY,0)<>isnull(@NDETTOTALQTY,0)
  begin
    SET @CERRMSG='Mismatch in Total quantity of Memo merged...'+str(ISNULL(@NMSTTOTALQTY,0))+'-'+str(ISNULL(@NDETTOTALQTY,0))
	GOTO EXIT_PROC
  end

 
  
  SET @BHOLOC=0
  IF @CCURDEPTID=@CHODEPTID
	  SET @BHOLOC=1
  
  SET @CSTEP = 10        
  SET @CMERGEDB=DB_NAME()+'.DBO.'      
  SET @CERRORMSG=''        
 
  IF @BHOLOC=1
	SET @BMSTINSERTONLY = 1
  ELSE
	SET @BMSTINSERTONLY = 0
	
  IF @BHOLOC=0
	BEGIN TRANSACTION        
	
/*INM,IND,PAYMODE_XN_DET,PAYMODE_MST,PAYMODE_GRP_MST*/        
    SET @CSTEP = 15        
        
                 
  SELECT @CFILTERCONDITION=' B.DOCWBO_MEMO_ID='''+@CMEMOID+''' AND B.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO))) 	
         
    SET @CSTEP = 140       
    SET @CTABLENAME='HD01106'        
    SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'        
    SET @CKEYFIELD='HEAD_CODE'        
    SET @CSTEP= 150        
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1  
         ,@CFILTERCONDITION=@CFILTERCONDITION  
         
    SET @CSTEP = 160       
    SET @CTABLENAME='LM01106'        
    SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'       
    SET @CKEYFIELD='AC_CODE'        
    
    

	SET @DTSQL=N'UPDATE A SET COMPANY_CODE=''01''  FROM '+@CTMP_TABLENAME+' A  WITH (ROWLOCK) WHERE COMPANY_CODE<>''01'' '
	EXEC SP_EXECUTESQL @DTSQL	
	
    SET @CSTEP = 165        
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
         
         
    UPDATE DOCWBO_LMP01106_MIRROR SET AREA_CODE='0000000' WHERE AREA_CODE 
    NOT IN (SELECT AREA_CODE FROM AREA)     

    SET @CSTEP = 170        
    SET @CTABLENAME='LMP01106'        
    SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'      
    SET @CKEYFIELD='AC_CODE'        
    SET @CSTEP= 175        
    PRINT @DTSQL        
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1 
         ,@CFILTERCONDITION=@CFILTERCONDITION 
    
	SET @CTABLENAME='SECTIONM'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='SECTION_CODE'
	SET @CSTEP=280
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1	
         ,@CFILTERCONDITION=@CFILTERCONDITION 	
	

	
	SET @CSTEP=310
	SET @CTABLENAME='SECTIOND'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='SUB_SECTION_CODE'
	SET @CSTEP=320
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1 
         ,@CFILTERCONDITION=@CFILTERCONDITION    
         
    SET @CSTEP=380
	SET @CTABLENAME='PARA1'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA1_CODE'
	SET @CSTEP=390
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
              
    SET @CSTEP=400
	SET @CTABLENAME='PARA2'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA2_CODE'
	SET @CSTEP=410
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
       
    SET @CSTEP=420
	SET @CTABLENAME='PARA3'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA3_CODE'
	SET @CSTEP=430
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
         
         
    SET @CSTEP=420
	SET @CTABLENAME='PARA4'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA4_CODE'
	SET @CSTEP=430
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
          
    
    
    SET @CSTEP=420
	SET @CTABLENAME='PARA5'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA5_CODE'
	SET @CSTEP=430
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
          


      
    SET @CSTEP=440
	SET @CTABLENAME='PARA6'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA6_CODE'
	SET @CSTEP=450
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION         
     
	 
	 
      
    SET @CSTEP=440
	SET @CTABLENAME='PARA7'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA7_CODE'
	SET @CSTEP=450
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION         
         

         
    SET @CSTEP=565
	SET @CTABLENAME='UOM'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='UOM_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION     
    
    SET @CSTEP=565
	SET @CTABLENAME='ARTICLE'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='ARTICLE_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 

	
   

   DECLARE @nParaCnt NUMERIC(2,0),@cColName VARCHAR(20)							  

	DECLARE @NCOUNT INT,@BLOOP INT,@CCMD1 NVARCHAR(MAX),@bExists bit
	SET @NCOUNT=25
	SET @BLOOP=1
	WHILE (@BLOOP <=@NCOUNT )
	BEGIN
			SET @CSTEP=65

			SET @nParaCnt=@bLoop
			SET @CTABLENAME='ATTR'+RTRIM(LTRIM(STR(@NPARACNT)))+'_MST'
			SET @CTMP_TABLENAME='DOCWBO_ATTR'+RTRIM(LTRIM(STR(@nParaCnt)))+'_MST_MIRROR'
			SET @CKEYFIELD='ATTR'+RTRIM(LTRIM(STR(@nParaCnt)))+'_KEY_CODE'


			SET @cCmd=N'IF EXISTS (SELECT TOP 1 '+@CKEYFIELD+' FROM '+@CTMP_TABLENAME+' B (NOLOCK) WHERE '+@CFILTERCONDITION+'
							AND '+@cKeyField+'<>''0000000'')
							SET @bExists=1
						ELSE
							SET @bExists=0'
			PRINT @cCmd
			EXEC SP_EXECUTESQL @cCmd,N'@bExists BIT OUTPUT' ,@bExists=@bExists OUTPUT

		  	----FOR DUPLICATE ATTRIBUTE 
			SET @bExists=1
			IF @bExists=1
			BEGIN
				SET @CSTEP=70
				--  SELECT @CFILTERCONDITION=' B.DOCWBO_MEMO_ID='''+@CMEMOID+''' AND B.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO))) 	

				SET @cCmd=N'IF EXISTS (SELECT TOP 1 a.'+@CKEYFIELD+' FROM '+@CTMP_TABLENAME+' a (NOLOCK)
									   LEFT OUTER JOIN '+@CTABLENAME+' b (NOLOCK) ON a.'+@CKEYFIELD+'=b.'+@CKEYFIELD+'
									   WHERE A.DOCWBO_MEMO_ID='''+@CMEMOID+''' AND A.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO)))+' AND  	 b.'+@CKEYFIELD+' IS NULL)
							SET @bExists=1
						ELSE
							SET @bExists=0'
				EXEC SP_EXECUTESQL @cCmd,N'@bExists BIT OUTPUT' ,@bExists=@bExists OUTPUT
				PRINT @cCmd

			
				IF @bExists=1
				BEGIN

					SET @CSTEP=75

					 EXEC UPDATEMASTERXN_opt @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
					 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
					 ,@LINSERTONLY=1,@LUPDATEONLY=0        
					 ,@BALWAYSUPDATE=1
					 ,@CFILTERCONDITION=@CFILTERCONDITION 
				END
			END
			
		

	       
		   SET @BLOOP=@BLOOP +1  			
	END
        
                 
	IF EXISTS (SELECT TOP 1 a.article_code FROM DOCWBO_ARTICLE_FIX_ATTR_MIRROR a (NOLOCK)
				LEFT OUTER JOIN  ARTICLE_FIX_ATTR b (NOLOCK) ON a.article_code=b.article_code
			   WHERE a.DOCWBO_MEMO_ID=@CMEMOID AND A.VERSION_NO=@NVERSIONNO AND b.article_code IS NULL)
	BEGIN
		SET @CSTEP=80
	  
		SET @CTABLENAME='ARTICLE_FIX_ATTR'
		SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='ARTICLE_CODE'
		EXEC UPDATEMASTERXN_opt @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='ARTICLE_CODE',@CKEYFIELD3=''        
			 ,@LINSERTONLY=1,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION        
    END            							  
		
                 
 --   SET @CSTEP=585
	--SET @CTABLENAME='SKU'
	--SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	--SET @CKEYFIELD='PRODUCT_CODE'


	--EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
 --        ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
 --        ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
 --        ,@BALWAYSUPDATE=1
 --        ,@CFILTERCONDITION=@CFILTERCONDITION 

 IF EXISTS (SELECT TOP 1 'U' FROM BUYER_ORDER_MST WHERE ORDER_ID=@CMEMOID AND MODE=3 and isnull(ORDER_STATUS,'')='' )
 begin
     set @CERRMSG=' Online Order can not be modified:'
	 goto EXIT_PROC
 end
    
  SELECT @CFILTERCONDITION=' A.ORDER_ID='''+@CMEMOID+''' AND A.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO)))
  

  UPDATE DOCWBO_BUYER_ORDER_MST_MIRROR SET APPROVED=1 WHERE ORDER_ID=@CMEMOID AND MODE <> 3
  	
       SET @CSTEP=360
	SET @CTABLENAME='BUYER_ORDER_MST'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='ORDER_ID'
	SET @CSTEP=110
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							 
   --DELETE FROM POD01106 WHERE ORDER_ID=@CMEMOID							  

   
   DELETE   A FROM BUYER_ORDER_DET A 
   LEFT JOIN  DOCWBO_BUYER_ORDER_DET_MIRROR B ON A.ROW_ID=B.ROW_ID AND A.ORDER_ID=B.ORDER_ID
   WHERE A.ORDER_ID=@CMEMOID AND B.ROW_ID IS NULL
							  
	
	SET @CSTEP=370
	SET @CTABLENAME='BUYER_ORDER_DET'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='ORDER_ID'
	SET @CSTEP=110
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 

 SELECT @CFILTERCONDITION=' B.DOCWBO_MEMO_ID='''+@CMEMOID+''' AND B.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO))) 	
							  
IF EXISTS (SELECT TOP 1 'U' FROM BUYER_ORDER_MST WHERE ORDER_ID=@CMEMOID AND MODE=3 )
 begin
      
	    DECLARE @CTENDERMODE VARCHAR(100)
		SELECT @CTENDERMODE=TENDERMODE FROM BUYER_ORDER_MST WHERE ORDER_ID =@CMEMOID

	IF NOT EXISTS (SELECT TOP 1 'U' FROM PAYMODE_MST WHERE PAYMODE_NAME =@CTENDERMODE) 
	begin

	  	SET @CTABLENAME='PAYMODE_MST'
		SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='paymode_code'
		EXEC UPDATEMASTERXN_opt @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=1,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION       
			 
      

		IF NOT EXISTS (SELECT TOP 1 'U' FROM PAYMODE_MST WHERE PAYMODE_NAME =@CTENDERMODE) and isnull(@CTENDERMODE,'')<>''
		begin
		     
			  set @CERRMSG=' Paymode Not Found:'
	          goto EXIT_PROC

		end

	end

 end
 
 	SET @CTABLENAME='SalesOrderProcessing'
	SET @CTMP_TABLENAME='DOCWBO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='MemoId'
	EXEC UPDATEMASTERXN_opt @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
		,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='ArticleCode',@CKEYFIELD3='Para1Code'        
		,@LINSERTONLY=1,@LUPDATEONLY=0 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION       
			 
	

	--FOR ONLINE ORDER Stock Allocation at The Time Of Merging if Stock not Available then it will be auto canclled'

	--IF EXISTS (SELECT TOP 1 'U' FROM BUYER_ORDER_MST WHERE ORDER_ID=@CMEMOID AND MODE=3) 
	--begin
	     
	--	 EXEC SP3S_ONLINEORDER_ALLOCATESTOCK @CORDER_ID=@CMEMOID,@CERRMSG=@CERRMSG OUTPUT 
	--	 IF ISNULL(@CERRMSG,'')<>''
	--	    GOTO EXIT_PROC

	--end

	
	 
    					
 END TRY        
 BEGIN CATCH
  PRINT 'CATCH START'       
  SET @CERRMSG='P:SP_MERGE_MIRROR_DOCWBO_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
 END CATCH        
        
EXIT_PROC:   
 
     
 IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0        
 BEGIN 
	 IF @BHOLOC=0       
	 BEGIN
	    
		commit TRANSACTION
		UPDATE BUYER_ORDER_MST SET HO_SYNCH_LAST_UPDATE ='',LAST_UPDATE =GETDATE () WHERE  MODE=3 and ORDER_ID=@CMEMOID
	END	
		
 END        
 ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0 
 BEGIN 
	 IF @BHOLOC=0
		ROLLBACK        
 END
   
		DELETE A FROM DOCWBO_BUYER_ORDER_DET_MIRROR A WITH (ROWLOCK) WHERE A.ORDER_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_BUYER_ORDER_MST_MIRROR A			 WITH (ROWLOCK) WHERE A.ORDER_ID  =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_HD01106_MIRROR A			 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_LM01106_MIRROR A			 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_LMP01106_MIRROR A			 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_SECTIONM_MIRROR A			 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_SECTIOND_MIRROR A			 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_PARA1_MIRROR A				 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_PARA2_MIRROR A				 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_PARA3_MIRROR A				 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_PARA4_MIRROR A				 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_PARA5_MIRROR A				 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_PARA6_MIRROR A				 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_PARA7_MIRROR A				 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		
		
		DELETE A FROM DOCWBO_ARTICLE_MIRROR A			 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_UOM_MIRROR A			 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_ATTRM_MIRROR A				 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_ART_ATTR_MIRROR A			 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_ATTR_KEY_MIRROR A			 WITH (ROWLOCK)  WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		
	    DELETE A FROM DOCWBO_ARTICLE_FIX_ATTR_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		
		DELETE A FROM DOCWBO_attr1_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr10_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr11_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr12_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr13_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr14_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr15_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr16_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr17_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr18_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr19_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr2_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr20_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr21_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr22_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr23_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr24_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr25_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr3_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr4_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr5_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr6_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr7_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr8_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_attr9_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_Paymode_mst_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		DELETE A FROM DOCWBO_SalesOrderProcessing_MIRROR A  WITH (ROWLOCK) WHERE A.DOCWBO_MEMO_ID =@CMEMOID AND A.VERSION_NO<=@NVERSIONNO
		
	

END 
------ END OF CREATING PROCEDURE - SP_MERGE_MIRROR_DOCWBO_DATA

