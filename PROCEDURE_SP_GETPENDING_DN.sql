CREATE PROCEDURE SP_GETPENDING_DN
@DTFROM	DATETIME,
@DTTO	DATETIME,
@CFINYEAR	VARCHAR(10),
@BMODE		NUMERIC(5)=0,
@BRECEIVED		NUMERIC(5)=0,
@CAC_CODE	VARCHAR(20),
@bEstimateMode INT=1
--WITH ENCRYPTION

AS
BEGIN
	SELECT RM_NO,RM_ID,RM_DT,CN_NO,CN_AMOUNT,CR_RECEIVED, 
	TOTAL_AMOUNT,AC_NAME,A.TOTAL_QUANTITY_STR
	FROM RMM01106 A
	JOIN LM01106 B ON B.AC_CODE=A.AC_CODE
	WHERE CANCELLED=0 
	AND ISNULL(MODE,0)=1--(CASE WHEN @BMODE =1 THEN 1 WHEN @BMODE=2 THEN 2 ELSE ISNULL(MODE,0) END)
	AND ISNULL(CR_RECEIVED,0)=(CASE WHEN @BRECEIVED =1 THEN 0 WHEN @BRECEIVED=2 THEN 1 ELSE ISNULL(CR_RECEIVED,0) END)
	AND RM_DT BETWEEN @DTFROM AND @DTTO
	--AND FIN_YEAR=@CFINYEAR
	AND A.AC_CODE=(CASE WHEN ISNULL(@CAC_CODE,'') ='' THEN A.AC_CODE ELSE ISNULL(@CAC_CODE,'') END)
	AND (2=@bEstimateMode OR A.memo_type=1)
	ORDER BY RM_DT,RM_NO,RM_ID
END
