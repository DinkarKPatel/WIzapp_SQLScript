CREATE PROCEDURE SP3S_SET_ATTR(@LOC VARCHAR(5),@FROM DATE,@TO DATE,@ART VARCHAR(100))
AS
BEGIN
SET NOCOUNT ON 
IF OBJECT_ID('TEMPDB..#PRODUCTS') IS NOT NULL DROP TABLE #PRODUCTS
SELECT DISTINCT LEFT(M.CM_ID,2)LOC,D.PRODUCT_CODE,S.article_code
,A.article_no,A.inactive ARTICLE_INACTIVE,A.ARTICLE_NAME
,S.PARA1_CODE ,PARA1.inactive PARA1_INACTIVE,PARA1.PARA1_NAME
,S.PARA2_CODE ,PARA2.inactive PARA2_INACTIVE,PARA2.PARA2_NAME
,S.PARA3_CODE ,PARA3.inactive PARA3_INACTIVE,PARA3.PARA3_NAME
,S.PARA4_CODE ,PARA4.inactive PARA4_INACTIVE,PARA4.PARA4_NAME
,S.PARA5_CODE ,PARA5.inactive PARA5_INACTIVE,PARA5.PARA5_NAME
,S.PARA6_CODE ,PARA6.inactive PARA6_INACTIVE,PARA6.PARA6_NAME
,ATTR1_MST.attr1_key_name,ATTR1_MST.attr1_inactive,ATTR1_MST.attr1_alias
,ATTR2_MST.attr2_key_name,ATTR2_MST.ATTR2_inactive,ATTR2_MST.ATTR2_alias
,ATTR3_MST.attr3_key_name,ATTR3_MST.ATTR3_inactive,ATTR3_MST.ATTR3_alias
,ATTR4_MST.attr4_key_name,ATTR4_MST.ATTR4_inactive,ATTR4_MST.ATTR4_alias
,ATTR5_MST.attr5_key_name,ATTR5_MST.ATTR5_inactive,ATTR5_MST.ATTR5_alias
,ATTR6_MST.attr6_key_name,ATTR6_MST.ATTR6_inactive,ATTR6_MST.ATTR6_alias
,ATTR7_MST.attr7_key_name,ATTR7_MST.ATTR7_inactive,ATTR7_MST.ATTR7_alias
,ATTR8_MST.attr8_key_name,ATTR8_MST.ATTR8_inactive,ATTR8_MST.ATTR8_alias
,ATTR9_MST.attr9_key_name,ATTR9_MST.attr9_inactive,ATTR9_MST.attr9_alias
,ATTR10_MST.attr10_key_name,ATTR10_MST.attr10_inactive,ATTR10_MST.attr10_alias
,ATTR11_MST.attr11_key_name,ATTR11_MST.attr11_inactive,ATTR11_MST.attr11_alias
,ATTR12_MST.attr12_key_name,ATTR12_MST.attr12_inactive,ATTR12_MST.attr12_alias
,ATTR13_MST.attr13_key_name,ATTR13_MST.attr13_inactive,ATTR13_MST.attr13_alias
,ATTR14_MST.attr14_key_name,ATTR14_MST.attr14_inactive,ATTR14_MST.attr14_alias
,ATTR15_MST.attr15_key_name,ATTR15_MST.attr15_inactive,ATTR15_MST.attr15_alias
,ATTR16_MST.attr16_key_name,ATTR16_MST.attr16_inactive,ATTR16_MST.attr16_alias
,ATTR17_MST.attr17_key_name,ATTR17_MST.attr17_inactive,ATTR17_MST.attr17_alias
,ATTR18_MST.attr18_key_name,ATTR18_MST.attr18_inactive,ATTR18_MST.attr18_alias
,ATTR19_MST.attr19_key_name,ATTR19_MST.attr19_inactive,ATTR19_MST.attr19_alias
,ATTR20_MST.attr20_key_name,ATTR20_MST.attr20_inactive,ATTR20_MST.attr20_alias
,ATTR21_MST.attr21_key_name,ATTR21_MST.attr21_inactive,ATTR21_MST.attr21_alias
,ATTR22_MST.attr22_key_name,ATTR22_MST.attr22_inactive,ATTR22_MST.attr22_alias
,ATTR23_MST.attr23_key_name,ATTR23_MST.attr23_inactive,ATTR23_MST.attr23_alias
,ATTR24_MST.attr24_key_name,ATTR24_MST.attr24_inactive,ATTR24_MST.attr24_alias
,ATTR25_MST.attr25_key_name,ATTR25_MST.attr25_inactive,ATTR25_MST.attr25_alias
INTO #PRODUCTS
FROM CMM01106 M (NOLOCK) 
JOIN CMD01106 D (NOLOCK) ON M.cm_id=D.cm_id 
JOIN SKU S (NOLOCK) 
JOIN ARTICLE A (NOLOCK)ON S.article_code=A.ARTICLE_CODE
JOIN SECTIOND SD (NOLOCK) ON SD.sub_section_code=A.sub_section_code
JOIN SECTIONM SM (NOLOCK) ON SM.section_code=SD.section_code
JOIN PARA1 (NOLOCK) ON  PARA1.para1_code=S.PARA1_CODE
JOIN PARA2 (NOLOCK) ON  PARA2.para2_code=S.PARA2_CODE
JOIN PARA3 (NOLOCK) ON  PARA3.para3_code=S.PARA3_CODE
JOIN PARA4 (NOLOCK) ON  PARA4.para4_code=S.PARA4_CODE
JOIN PARA5 (NOLOCK) ON  PARA5.para5_code=S.PARA5_CODE
JOIN PARA6 (NOLOCK) ON  PARA6.para6_code=S.PARA6_CODE
JOIN ARTICLE_FIX_ATTR AF (NOLOCK) ON AF.ARTICLE_CODE=A.ARTICLE_CODE    
JOIN ATTR1_MST (NOLOCK) ON ATTR1_MST.ATTR1_KEY_CODE=AF.ATTR1_KEY_CODE    
JOIN ATTR2_MST (NOLOCK) ON ATTR2_MST.ATTR2_KEY_CODE=AF.ATTR2_KEY_CODE    
JOIN ATTR3_MST (NOLOCK) ON ATTR3_MST.ATTR3_KEY_CODE=AF.ATTR3_KEY_CODE    
JOIN ATTR4_MST (NOLOCK) ON ATTR4_MST.ATTR4_KEY_CODE=AF.ATTR4_KEY_CODE    
JOIN ATTR5_MST (NOLOCK) ON ATTR5_MST.ATTR5_KEY_CODE=AF.ATTR5_KEY_CODE    
JOIN ATTR6_MST (NOLOCK) ON ATTR6_MST.ATTR6_KEY_CODE=AF.ATTR6_KEY_CODE    
JOIN ATTR7_MST (NOLOCK) ON ATTR7_MST.ATTR7_KEY_CODE=AF.ATTR7_KEY_CODE    
JOIN ATTR8_MST (NOLOCK) ON ATTR8_MST.ATTR8_KEY_CODE=AF.ATTR8_KEY_CODE    
JOIN ATTR9_MST (NOLOCK) ON ATTR9_MST.ATTR9_KEY_CODE=AF.ATTR9_KEY_CODE  
JOIN ATTR10_MST (NOLOCK) ON ATTR10_MST.ATTR10_KEY_CODE=AF.ATTR10_KEY_CODE    
JOIN ATTR11_MST (NOLOCK) ON ATTR11_MST.ATTR11_KEY_CODE=AF.ATTR11_KEY_CODE    
JOIN ATTR12_MST (NOLOCK) ON ATTR12_MST.ATTR12_KEY_CODE=AF.ATTR12_KEY_CODE    
JOIN ATTR13_MST (NOLOCK) ON ATTR13_MST.ATTR13_KEY_CODE=AF.ATTR13_KEY_CODE    
JOIN ATTR14_MST (NOLOCK) ON ATTR14_MST.ATTR14_KEY_CODE=AF.ATTR14_KEY_CODE    
JOIN ATTR15_MST (NOLOCK) ON ATTR15_MST.ATTR15_KEY_CODE=AF.ATTR15_KEY_CODE    
JOIN ATTR16_MST (NOLOCK) ON ATTR16_MST.ATTR16_KEY_CODE=AF.ATTR16_KEY_CODE    
JOIN ATTR17_MST (NOLOCK) ON ATTR17_MST.ATTR17_KEY_CODE=AF.ATTR17_KEY_CODE    
JOIN ATTR18_MST (NOLOCK) ON ATTR18_MST.ATTR18_KEY_CODE=AF.ATTR18_KEY_CODE    
JOIN ATTR19_MST (NOLOCK) ON ATTR19_MST.ATTR19_KEY_CODE=AF.ATTR19_KEY_CODE    
JOIN ATTR20_MST (NOLOCK) ON ATTR20_MST.ATTR20_KEY_CODE=AF.ATTR20_KEY_CODE    
JOIN ATTR21_MST (NOLOCK) ON ATTR21_MST.ATTR21_KEY_CODE=AF.ATTR21_KEY_CODE    
JOIN ATTR22_MST (NOLOCK) ON ATTR22_MST.ATTR22_KEY_CODE=AF.ATTR22_KEY_CODE    
JOIN ATTR23_MST (NOLOCK) ON ATTR23_MST.ATTR23_KEY_CODE=AF.ATTR23_KEY_CODE    
JOIN ATTR24_MST (NOLOCK) ON ATTR24_MST.ATTR24_KEY_CODE=AF.ATTR24_KEY_CODE    
JOIN ATTR25_MST (NOLOCK) ON ATTR25_MST.ATTR25_KEY_CODE=AF.ATTR25_KEY_CODE    
ON S.product_code=D.PRODUCT_CODE
WHERE M.CANCELLED=0 AND M.CM_DT BETWEEN @FROM AND @TO AND M.location_Code =@LOC

--PROCESS PARA1
UPDATE P SET para1_code=P1.para1_code
FROM #PRODUCTS P 
JOIN PARA1 P1 ON LTRIM(RTRIM(P1.para1_name))=LTRIM(RTRIM(P.PARA1_NAME)) AND P1.inactive=0
WHERE PARA1_INACTIVE=1
IF @@ROWCOUNT>0
   UPDATE S SET S.para1_code=P.PARA1_CODE FROM SKU S WITH(ROWLOCK) JOIN #PRODUCTS P ON S.PRODUCT_CODE=P.PRODUCT_CODE AND S.PARA1_CODE<>P.PARA1_CODE

--PROCESS PARA2
UPDATE P SET para2_code=P2.para2_code
FROM #PRODUCTS P 
JOIN PARA2 P2 ON LTRIM(RTRIM(P2.para2_name))=LTRIM(RTRIM(P.PARA2_NAME)) AND P2.inactive=0
WHERE PARA2_INACTIVE=1
IF @@ROWCOUNT>0
   UPDATE S SET S.para2_code=P.PARA2_CODE FROM SKU S WITH(ROWLOCK) JOIN #PRODUCTS P ON S.PRODUCT_CODE=P.PRODUCT_CODE AND S.PARA2_CODE<>P.PARA2_CODE

--PROCESS PARA3
UPDATE P SET para3_code=P3.para3_code
FROM #PRODUCTS P 
JOIN PARA3 P3 ON LTRIM(RTRIM(P3.para3_name))=LTRIM(RTRIM(P.PARA3_NAME)) AND P3.inactive=0
WHERE PARA3_INACTIVE=1
IF @@ROWCOUNT>0
   UPDATE S SET S.para3_code=P.PARA3_CODE FROM SKU S WITH(ROWLOCK) JOIN #PRODUCTS P ON S.PRODUCT_CODE=P.PRODUCT_CODE AND S.PARA3_CODE<>P.PARA3_CODE

--PROCESS PARA4
UPDATE P SET para4_code=P4.para4_code
FROM #PRODUCTS P 
JOIN PARA4 P4 ON LTRIM(RTRIM(P4.para4_name))=LTRIM(RTRIM(P.PARA4_NAME)) AND P4.inactive=0
WHERE PARA4_INACTIVE=1
IF @@ROWCOUNT>0
   UPDATE S SET S.para4_code=P.PARA4_CODE FROM SKU S WITH(ROWLOCK) JOIN #PRODUCTS P ON S.PRODUCT_CODE=P.PRODUCT_CODE AND S.PARA4_CODE<>P.PARA4_CODE
   
--PROCESS PARA5
UPDATE P SET para5_code=P5.para5_code
FROM #PRODUCTS P 
JOIN PARA5 P5 ON LTRIM(RTRIM(P5.para5_name))=LTRIM(RTRIM(P.PARA5_NAME)) AND P5.inactive=0
WHERE PARA5_INACTIVE=1
IF @@ROWCOUNT>0
   UPDATE S SET S.para5_code=P.PARA5_CODE FROM SKU S WITH(ROWLOCK) JOIN #PRODUCTS P ON S.PRODUCT_CODE=P.PRODUCT_CODE AND S.PARA5_CODE<>P.PARA5_CODE
   
--PROCESS PARA6
UPDATE P SET para6_code=P6.para6_code
FROM #PRODUCTS P 
JOIN PARA6 P6 ON LTRIM(RTRIM(P6.para6_name))=LTRIM(RTRIM(P.PARA6_NAME)) AND P6.inactive=0
WHERE PARA6_INACTIVE=1
IF @@ROWCOUNT>0
   UPDATE S SET S.para6_code=P.PARA6_CODE FROM SKU S WITH(ROWLOCK) JOIN #PRODUCTS P ON S.PRODUCT_CODE=P.PRODUCT_CODE AND S.PARA6_CODE<>P.PARA6_CODE
SET NOCOUNT OFF
END