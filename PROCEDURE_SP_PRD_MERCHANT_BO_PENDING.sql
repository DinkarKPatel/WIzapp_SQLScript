CREATE PROCEDURE SP_PRD_MERCHANT_BO_PENDING  
(  
 @CMERCHANT_CODE VARCHAR(MAX)='',  
 @CFG_ARTICLE_CODE VARCHAR(MAX)='',  
 @CAC_CODE VARCHAR(MAX)=''  
)  
AS  
BEGIN  
  
  
DECLARE  @CMERCHANTSTATUS VARCHAR(MAX),@DTSQL NVARCHAR(MAX),  
         @CFG_ARTICLE_STATUS  VARCHAR(MAX)  ,@CAC_CODE_STATUS VARCHAR(MAX)  
    
     
 IF @CMERCHANT_CODE=''    
 BEGIN    
    SET @CMERCHANTSTATUS=''    
    SET @CMERCHANT_CODE='IN('''')'    
 END    
 ELSE     
 BEGIN    
    SET @CMERCHANTSTATUS='LATER'    
 END    
     
  
 IF @CFG_ARTICLE_CODE=''    
 BEGIN    
    SET @CFG_ARTICLE_STATUS=''    
    SET @CFG_ARTICLE_CODE='IN('''')'    
 END    
 ELSE     
 BEGIN    
    SET @CFG_ARTICLE_STATUS='LATER'    
 END    
       
  
 IF @CAC_CODE=''    
 BEGIN    
    SET @CAC_CODE_STATUS=''    
    SET @CAC_CODE='IN('''')'    
 END    
 ELSE     
 BEGIN    
    SET @CAC_CODE_STATUS='LATER'    
 END    
       
         
       IF OBJECT_ID('TEMPDB..#TMPORDER','U') IS NOT NULL  
          DROP TABLE #TMPORDER  
  
  SELECT A.ORDER_NO,A.ORDER_DT ,A.AC_CODE,C.AC_NAME ,  
  A.ORDER_ID,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,A.DELIVERY_DT,  
  B.ITEM_MERCHANT_CODE,EMP.EMP_NAME AS MERCHANT_NAME,EMP.EMAIL,  
  SR=ROW_NUMBER() OVER (PARTITION BY  B.ARTICLE_CODE,A.ORDER_ID ORDER BY B.ARTICLE_CODE,A.ORDER_ID ) ,  
  SUM(QUANTITY) AS ORD_QUANTITY,  
  SUM(ISNULL(B.ADJ_QTY,0)) AS ADJ_QTY  
  INTO #TMPORDER  
  FROM BUYER_ORDER_MST A  
  JOIN BUYER_ORDER_DET B ON A.ORDER_ID=B.ORDER_ID  
  JOIN LM01106 C ON A.AC_CODE=C.AC_CODE  
  JOIN EMPLOYEE EMP ON EMP.EMP_CODE=B.ITEM_MERCHANT_CODE  
  WHERE ORDER_STATUS=2 AND   
  A.CANCELLED=0 AND 1=2   
  GROUP BY A.ORDER_NO,A.ORDER_DT ,A.AC_CODE,C.AC_NAME ,  
  A.ORDER_ID,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,A.DELIVERY_DT,  
  B.ITEM_MERCHANT_CODE,EMP.EMP_NAME,EMP.EMAIL  
    
  --AND ('''+RTRIM(LTRIM(@CMERCHANTSTATUS))+'''='''' OR B.ITEM_MERCHANT_CODE '+@MERCHANT_CODE+')    
       
     SET @DTSQL=N'SELECT A.ORDER_NO,A.ORDER_DT ,A.AC_CODE,C.AC_NAME ,  
  A.ORDER_ID,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,A.DELIVERY_DT,  
  B.ITEM_MERCHANT_CODE,EMP.EMP_NAME AS MERCHANT_NAME,EMP.EMAIL,  
  SR=ROW_NUMBER() OVER (PARTITION BY  B.ARTICLE_CODE,A.ORDER_ID ORDER BY B.ARTICLE_CODE,A.ORDER_ID ) ,  
  SUM(QUANTITY) AS ORD_QUANTITY,  
  SUM(ISNULL(B.ADJ_QTY,0)) AS ADJ_QTY  
  FROM BUYER_ORDER_MST A  
  JOIN BUYER_ORDER_DET B ON A.ORDER_ID=B.ORDER_ID  
  JOIN LM01106 C ON A.AC_CODE=C.AC_CODE  
  LEFT JOIN EMPLOYEE EMP ON EMP.EMP_CODE=B.ITEM_MERCHANT_CODE  
  WHERE --ORDER_STATUS=2    AND
   ('''+RTRIM(LTRIM(@CMERCHANTSTATUS))+'''='''' OR B.ITEM_MERCHANT_CODE '+@CMERCHANT_CODE+')   
  AND ('''+RTRIM(LTRIM(@CFG_ARTICLE_STATUS))+'''='''' OR B.ARTICLE_CODE '+@CFG_ARTICLE_CODE+')   
  AND ('''+RTRIM(LTRIM(@CAC_CODE_STATUS))+'''='''' OR A.AC_CODE '+@CAC_CODE+')   
  AND  A.CANCELLED=0   
  GROUP BY A.ORDER_NO,A.ORDER_DT ,A.AC_CODE,C.AC_NAME ,  
  A.ORDER_ID,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,A.DELIVERY_DT,  
  B.ITEM_MERCHANT_CODE,EMP.EMP_NAME,EMP.EMAIL'  
       PRINT @DTSQL    
       INSERT INTO #TMPORDER  
       EXEC SP_EXECUTESQL @DTSQL    
    
    
       
  --IF OBJECT_ID('TEMPDB..#TMPWSP','U') IS NOT NULL  
  --  DROP TABLE #TMPWSP  
   
     SELECT B.AC_CODE, ISNULL(UPC.ORDER_ID,ORD.ORDER_ID) AS ORDER_ID,
            TD.ARTICLE_CODE AS PACKSLIP_ARTICLE_CODE , 
            TD.OLD_PARA1_CODE AS PARA1_CODE ,TD.OLD_PARA2_CODE AS PARA2_CODE ,
            TD.REF_PRD_WORKORDER_MEMOID AS WO_ID,
      COUNT(*) AS WPS_QTY 
      INTO #TMPWSP
     FROM IND01106 A
     JOIN INM01106  B ON A.INV_ID =B.INV_ID 
     JOIN PRD_TRANSFER_MAIN_DET TD ON TD.PRODUCT_CODE =A.PRODUCT_CODE 
     JOIN PRD_TRANSFER_MAIN_MST  TM ON TM.MEMO_ID  =TD.MEMO_ID 
     LEFT OUTER JOIN PRD_UPCPMT UPC ON UPC.PRODUCT_CODE =TD.WIP_PRODUCT_CODE 
     LEFT OUTER JOIN PRD_WO_ORDERS ORD ON ORD.MEMO_ID =TD.REF_PRD_WORKORDER_MEMOID
     WHERE ISNULL(A.PS_ID,'') ='' AND TM.CANCELLED =0 AND B.CANCELLED =0
     GROUP BY  B.AC_CODE, ISNULL(UPC.ORDER_ID,ORD.ORDER_ID),
     TD.ARTICLE_CODE, TD.OLD_PARA1_CODE ,TD.OLD_PARA2_CODE,TD.REF_PRD_WORKORDER_MEMOID 
     UNION ALL
    SELECT  B.AC_CODE, ISNULL(UPC.ORDER_ID,ORD.ORDER_ID) AS ORDER_ID,
            TD.ARTICLE_CODE AS PACKSLIP_ARTICLE_CODE , 
            TD.OLD_PARA1_CODE AS PARA1_CODE ,TD.OLD_PARA2_CODE AS PARA2_CODE ,
            TD.REF_PRD_WORKORDER_MEMOID AS WO_ID,
     COUNT(*) AS WPS_QTY 
      FROM WPS_DET A
     JOIN WPS_MST   B ON A.PS_ID =B.PS_ID 
     JOIN PRD_TRANSFER_MAIN_DET TD ON TD.PRODUCT_CODE =A.PRODUCT_CODE 
     JOIN PRD_TRANSFER_MAIN_MST  TM ON TM.MEMO_ID  =TD.MEMO_ID 
     LEFT OUTER JOIN PRD_UPCPMT UPC ON UPC.PRODUCT_CODE =TD.WIP_PRODUCT_CODE 
     LEFT OUTER JOIN PRD_WO_ORDERS ORD ON ORD.MEMO_ID =TD.REF_PRD_WORKORDER_MEMOID
     WHERE  TM.CANCELLED =0 AND B.CANCELLED =0
     GROUP BY  B.AC_CODE, ISNULL(UPC.ORDER_ID,ORD.ORDER_ID),
     TD.ARTICLE_CODE, TD.OLD_PARA1_CODE ,TD.OLD_PARA2_CODE,TD.REF_PRD_WORKORDER_MEMOID 
   
           
       
   --SELECT B.AC_CODE, A.ORDER_ID,A.PACKSLIP_ARTICLE_CODE,   
   --SUM(QUANTITY) AS WPS_QTY  
   --INTO #TMPWSP  
   --FROM WPS_DET A  
   --JOIN WPS_MST B ON A.PS_ID=B.PS_ID  
   --WHERE B.CANCELLED=0 AND A.ORDER_ID<>''  
   --GROUP BY B.AC_CODE,A.ORDER_ID,A.PACKSLIP_ARTICLE_CODE   
      
   --   IF OBJECT_ID('TEMPDB..#TMPWO','U') IS NOT NULL    
   --      DROP TABLE #TMPWO    
         
   --SELECT A.ORDER_ID,A.MEMO_ID ,B.ARTICLE_CODE,Q.PARA1_CODE,Q.PARA2_CODE,         
   --SUM(Q.QUANTITY) AS PRD_QUANTITY      
   --INTO #TMPWO     
   --FROM  (SELECT DISTINCT * FROM PRD_WO_ORDERS) A         
   --JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID         
   --JOIN PRD_WO_DET P ON C.MEMO_ID=P.MEMO_ID         
   --JOIN PRD_WO_SUB_DET Q ON P.ROW_ID =Q.REF_ROW_ID         
   --JOIN BUYER_ORDER_DET B ON A.ORDER_ID=B.ORDER_ID         
   --AND B.PARA1_CODE = Q.PARA1_CODE         
   --AND B.PARA2_CODE = Q.PARA2_CODE         
   --AND B.ARTICLE_CODE = C.ARTICLE_SET_CODE         
   --JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID         
   --WHERE C.CANCELLED=0  AND M.CANCELLED=0    
   --AND 1=2    
   --GROUP BY A.ORDER_ID,A.MEMO_ID,B.ARTICLE_CODE,Q.PARA1_CODE,Q.PARA2_CODE    
         
         
  --SET @DTSQL=N' SELECT B.ORDER_ID,ISNULL(A.MEMO_ID,'''') AS MEMO_ID ,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,         
  --     SUM(ISNULL(A.QUANTITY,0)) AS PRD_QUANTITY       
  -- FROM #TMPORDER B    
  -- JOIN    
  -- (    
  --  SELECT A.ORDER_ID,C.ARTICLE_SET_CODE ,A.MEMO_ID,Q.PARA1_CODE,Q.PARA2_CODE,Q.QUANTITY    
  --  FROM    
  -- (SELECT DISTINCT * FROM PRD_WO_ORDERS) A         
  -- JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID         
  -- JOIN PRD_WO_DET P ON C.MEMO_ID=P.MEMO_ID         
  -- JOIN PRD_WO_SUB_DET Q ON P.ROW_ID =Q.REF_ROW_ID         
  -- WHERE C.CANCELLED=0     
  -- ) A ON A.ORDER_ID=B.ORDER_ID         
  -- AND B.PARA1_CODE = A.PARA1_CODE         
  -- AND B.PARA2_CODE = A.PARA2_CODE         
  -- AND B.ARTICLE_CODE = A.ARTICLE_SET_CODE         
  -- GROUP BY B.ORDER_ID,A.MEMO_ID,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE'    
  -- PRINT @DTSQL    
  --INSERT INTO #TMPWO    
  --EXEC SP_EXECUTESQL @DTSQL    
     
  --IF OBJECT_ID('TEMPDB..#TMPTRF','U') IS NOT NULL    
  --       DROP TABLE #TMPTRF    
          
  --      SELECT A.*,B.QUANTITY AS DLVRD_QTY   
  --      INTO #TMPTRF  
  --      FROM #TMPWO A  
  --      JOIN  
  --      (  
  --       SELECT B.REF_PRD_WORKORDER_MEMOID AS ORDER_ID,B.PARA1_CODE,B.PARA2_CODE ,  
  --       SUM(B.QTY) AS QUANTITY  
  --       FROM PRD_TRANSFER_MAIN_MST A  
  --       JOIN PRD_TRANSFER_MAIN_DET B ON A.MEMO_ID=B.MEMO_ID  
  --       WHERE A.CANCELLED=0  
  --       GROUP BY B.REF_PRD_WORKORDER_MEMOID,B.PARA1_CODE,B.PARA2_CODE  
  --      ) B ON A.MEMO_ID=B.ORDER_ID  
  --      AND A.PARA1_CODE=B.PARA1_CODE  
  --      AND A.PARA2_CODE=B.PARA2_CODE  
  --SELECT * INTO TMPORDER FROM #TMPORDER 
  
  --SELECT * INTO TMPWSP FROM #TMPWSP               
         
  SELECT A.ORDER_NO,A.AC_NAME,ART.ARTICLE_NO,  
         CONVERT(VARCHAR,A.ORDER_DT,105) AS ORDER_DT,  
         CONVERT(VARCHAR,A.DELIVERY_DT,105) AS DELIVERY_DT,  
         DATEDIFF(DD,A.DELIVERY_DT,GETDATE()) AS DTD,  
         A.ITEM_MERCHANT_CODE,  
         A.MERCHANT_NAME,  
         A.EMAIL,  
         CAST(SUM(A.ORD_QUANTITY) AS NUMERIC(10,2)) AS ORD_QTY,  
         CAST(SUM(A.ADJ_QTY) AS NUMERIC(10,2)) AS ADJ_QTY,  
         ISNULL(WPS_QTY,0) AS DLVRD_QTY,  
         CAST(SUM(A.ORD_QUANTITY) AS NUMERIC(10,2))-(CAST(SUM(A.ADJ_QTY) AS NUMERIC(10,2))+ISNULL(WPS_QTY,0)) AS PENDING_QTY  
  FROM #TMPORDER A  
  JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE  
  LEFT OUTER JOIN  
  (  
   SELECT ORDER_ID,ARTICLE_CODE,SUM(WPS_QTY) AS WPS_QTY  
   FROM  
   (  
   SELECT ORDER_ID,PACKSLIP_ARTICLE_CODE AS ARTICLE_CODE ,  
   SUM(WPS_QTY) AS WPS_QTY  
   FROM #TMPWSP  
   GROUP BY ORDER_ID,PACKSLIP_ARTICLE_CODE    
   ) A  
   GROUP BY ORDER_ID,ARTICLE_CODE  
  ) B ON A.ORDER_ID=B.ORDER_ID   
  AND A.ARTICLE_CODE=B.ARTICLE_CODE  
  GROUP BY A.ORDER_NO,A.AC_NAME,  
         CONVERT(VARCHAR,A.ORDER_DT,105) ,  
         CONVERT(VARCHAR,A.DELIVERY_DT,105) ,  
         DATEDIFF(DD,A.DELIVERY_DT,GETDATE()) ,  
         A.ITEM_MERCHANT_CODE,  
         A.MERCHANT_NAME,  
         A.EMAIL,  
         ISNULL(WPS_QTY,0),ART.ARTICLE_NO   
  -- HAVING CAST(SUM(A.ORD_QUANTITY) AS NUMERIC(10,2))-(CAST(SUM(A.ADJ_QTY) AS NUMERIC(10,2))+ISNULL(WPS_QTY,0))>0  
   ORDER BY  A.MERCHANT_NAME,A.ORDER_NO,ART.ARTICLE_NO  
  --CASE WHEN ISNULL(A.MERCHANT_NAME,'') ='' THEN 0 ELSE 1 END,  
  
END
