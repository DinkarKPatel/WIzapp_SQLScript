CREATE PROCEDURE SP3S_LIVE_PENDING_BO_TAT
(
	@nQueryID	INT=1,
	@DTASON		DATETIME='',
	@DFM_DT DATETIME='',  
	@DTO_DT DATETIME='',  
	@REF_NO VARCHAR(100)='',  
	@BUYER_NAME VARCHAR(100)='',  
	@CORDER_NO VARCHAR(100)=''     
)
AS
BEGIN
	IF @DTASON='' SET @DTASON=GETDATE()

	DECLARE @CSIZE VARCHAR(MAX),@CSIZE_SUM VARCHAR(MAX),@CSIZE_SUM_TOTAL VARCHAR(MAX)

	,@CCMD NVARCHAR(MAX),@CSIZE_ZERO NVARCHAR(MAX)

	IF OBJECT_ID('TEMPDB..#PENDINGBUYERORDER','U') IS NOT NULL

		DROP TABLE #PENDINGBUYERORDER



	IF OBJECT_ID('TEMPDB..##PENDINGORDER_PIVOT','U') IS NOT NULL

		DROP TABLE ##PENDINGORDER_PIVOT

	IF OBJECT_ID('TEMPDB..##PENDINGORDER_PIVOT1','U') IS NOT NULL

		DROP TABLE ##PENDINGORDER_PIVOT1





	CREATE TABLE #PENDINGBUYERORDER

	(

		ORDER_ID		VARCHAR(MAX),

		ORDER_NO		VARCHAR(MAX),

		ORDER_DT		DATETIME,

		REF_NO			VARCHAR(MAX),

		MSG_CAPTION		VARCHAR(MAX),

		TAT_DAYS		NUMERIC(5),

		JOB_CARD_ID		VARCHAR(100),

		JOB_CARD_NO		VARCHAR(100),

		JOB_CARD_DT		DATETIME,

		STATUS			NUMERIC(5)

		,JOB_CODE		VARCHAR(20) null

	)		

	BEGIN TRY



		SET @CCMD=N'					

			SELECT DISTINCT bomst.order_id,bomst.ORDER_NO,bomst.order_dt,bomst.ref_no,ISNULL(a3.job_NAME,''JOB NOT DEFINED'') AS ERR_MSG

			,ISNULL(a3.TAT_DAYS,0) AS TAT_DAYS

			,a2.MEMO_ID,a2.MEMO_NO,a2.MEMO_DT
			--,CAST(DATEDIFF(D,DATEADD(D,ISNULL(a3.TAT_DAYS,0),CAST(ISNULL(a2.JOB_START_DT,'''') AS DATE),CAST(ISNULL(c.receipt_dt,'''+ CONVERT(VARCHAR(20),@DTASON,101) +''') AS DATE))) AS INT) 
			,CAST(
					DATEDIFF(D
							,DATEADD(D,ISNULL(a3.TAT_DAYS,0),CAST(ISNULL(a2.JOB_START_DT,a2.MEMO_DT) AS DATE))
							,CAST(ISNULL(c.receipt_dt,'''+ CONVERT(VARCHAR(20),@DTASON,101) +''') AS DATE)) 
			AS INT) AS STATUS
			,J.JOB_CODE
			--,CAST(3 AS INT)+ROW_NUMBER() OVER (PARTITION BY a3.job_NAME ORDER BY a3.job_NAME) AS SRNO

			FROM BUYER_ORDER_DET bodet (NOLOCK) 

			JOIN BUYER_ORDER_MST bomst (NOLOCK) ON bomst.order_id=bodet.order_id

			LEFT OUTER JOIN ORD_PLAN_DET a1 on a1.wod_row_id=bodet.row_id

			LEFT OUTER JOIN ORD_PLAN_MST a2 on a2.MEMO_ID=a1.MEMO_ID

			LEFT OUTER JOIN 

			(

				SELECT C.MEMO_ID,C.JOB_CODE ,C.JOB_ORDER,C.TAT_DAYS,J.JOB_NAME,ROW_NUMBER() OVER (PARTITION BY C.MEMO_ID ORDER BY C.MEMO_ID,C.JOB_ORDER) AS SRNO

				FROM ORD_PLAN_MST B (NOLOCK) 

				JOIN ORD_PLAN_JOB C (NOLOCK) ON B.MEMO_ID=C.MEMO_ID

				JOIN JOBS J ON J.JOB_CODE=C.job_code

				WHERE B.CANCELLED=0

				GROUP BY C.MEMO_ID,C.JOB_ORDER,C.JOB_CODE,J.JOB_NAME,C.TAT_DAYS

			)a3 on a3.MEMO_ID=a1.MEMO_ID

			LEFT OUTER JOIN JOBS J ON J.JOB_CODE=a3.JOB_CODE

			LEFT OUTER JOIN ORD_PLAN_BARCODE_DET a (NOLOCK) ON a1.ROW_ID=a.REFROW_ID

			LEFT OUTER JOIN jobwork_receipt_det b ON b.product_code=a.PRODUCT_CODE

			LEFT OUTER JOIN jobwork_receipt_mst c ON b.receipt_id=c.receipt_id

			LEFT OUTER JOIN jobwork_issue_det d on d.row_id=b.ref_row_id AND a3.job_code=d.job_code

			LEFT OUTER JOIN jobwork_issue_mst e on e.issue_id=d.issue_id

			WHERE ISNULL(c.cancelled,0)=0 AND ISNULL(e.cancelled,0)=0 AND ISNULL(a2.cancelled,0)=0

			AND ISNULL(bomst.cancelled,0)=0 

			AND (''''=''' +@REF_NO+''' OR bomst.ref_no=''' +@REF_NO+''')

			AND (''''=''' +@BUYER_NAME+''' OR bomst.ac_code=''' +@BUYER_NAME+''')

			AND (''''=''' +@CORDER_NO+''' OR bomst.order_id=''' +@CORDER_NO+''')

			AND (bomst.order_dt BETWEEN '''+CONVERT(VARCHAR(20),@DFM_DT,101) +''' AND '''+CONVERT(VARCHAR(20),@DTO_DT,101) +''' )

			'

		

		PRINT 'STEP 1 :'+ @CCMD

		--

		INSERT INTO #PENDINGBUYERORDER

		EXEC SP_EXECUTESQL @CCMD

		--SELECT * FROM #PENDINGBUYERORDER

		IF (0= @@ROWCOUNT)

		BEGIN

			SELECT * FROM #PENDINGBUYERORDER

			RETURN

		END



		SELECT  

		@CSIZE=ISNULL(@CSIZE,'')+(CASE WHEN ISNULL(@CSIZE,'')='' THEN '' ELSE ',' END ) +'['+MSG_CAPTION+']',

		@CSIZE_SUM=ISNULL(@CSIZE_SUM,'')+(CASE WHEN ISNULL(@CSIZE_SUM,'')='' THEN '' ELSE ',' END ) +'SUM(['+MSG_CAPTION+']) AS ['+MSG_CAPTION+']',

		@CSIZE_SUM_TOTAL=ISNULL(@CSIZE_SUM_TOTAL,'')+(CASE WHEN ISNULL(@CSIZE_SUM_TOTAL,'')='' THEN '' ELSE '+' END ) +'ISNULL(SUM(['+MSG_CAPTION+']),0)',

		@CSIZE_ZERO=ISNULL(@CSIZE_ZERO,'')+(CASE WHEN ISNULL(@CSIZE_ZERO,'')='' THEN '' ELSE ',' END ) +'CAST(0 AS NUMERIC(14,2)) AS ['+MSG_CAPTION+']'

		FROM 
		(
			SELECT DISTINCT A.JOB_CODE,A.MSG_CAPTION,ISNULL(B.JOB_SR,999) AS JOB_SR
			FROM #PENDINGBUYERORDER A
			LEFT OUTER JOIN JOBS B ON B.JOB_CODE =A.JOB_CODE
		)X
		ORDER BY JOB_SR
			

		

		--SELECT @CSIZE ,@CSIZE_SUM,@CSIZE_SUM_TOTAL



		SET @CCMD=N'

		SELECT ORDER_ID,ORDER_NO,ORDER_DT,REF_NO,JOB_CARD_ID,JOB_CARD_NO,JOB_CARD_DT,'+@CSIZE+

		'INTO ##PENDINGORDER_PIVOT

		FROM 

		(

			SELECT * FROM #PENDINGBUYERORDER

		)X

		PIVOT

		(

			SUM(STATUS)

			FOR MSG_CAPTION IN ('+@CSIZE+')

		)PVT'



		PRINT 'STEP 2 :'+ @CCMD

		

		EXEC SP_EXECUTESQL @CCMD

		

		SET @CCMD=N'

		SELECT X.order_id,X.ORDER_NO,X.order_dt,X.ref_no,z.MEMO_ID as JOB_CARD_ID,z.MEMO_NO AS JOB_CARD_NO,z.MEMO_DT AS JOB_CARD_DT,X.[STATUS] AS [APPROVAL],Z.[STATUS] AS [JOB CARD INITIATED]

		INTO ##PENDINGORDER_PIVOT1

		FROM

		(

			SELECT order_id,ORDER_NO,order_dt,ref_no,''APPROVAL'' AS ERR_MSG,ISNULL(TAT_DAYS,0) AS TAT_DAYS

			--,NULL AS JOB_CARD_ID,NULL AS JOB_CARD_NO,NULL  AS JOB_CARD_DT

			,CAST(DATEDIFF(D,CAST(ORDER_DT+ISNULL(TAT_DAYS,0) AS DATE),CAST(ISNULL(APPROVED_ON,'''+ CONVERT(VARCHAR(20),@DTASON,101) +''') AS DATE)) AS INT) AS STATUS--,CAST(1 AS INT) AS SRNO

			FROM BUYER_ORDER_MST (NOLOCK)

			WHERE CANCELLED=0

			AND (''''=''' +@REF_NO+''' OR ref_no=''' +@REF_NO+''')

			AND (''''=''' +@BUYER_NAME+''' OR ac_code=''' +@BUYER_NAME+''')

			AND (''''=''' +@CORDER_NO+''' OR order_id=''' +@CORDER_NO+''')

			AND (order_dt BETWEEN '''+CONVERT(VARCHAR(20),@DFM_DT,101) +''' AND '''+CONVERT(VARCHAR(20),@DTO_DT,101) +''' )

		)X

		LEFT OUTER JOIN

		(

			SELECT b.order_id,b.ORDER_NO,b.order_dt,b.ref_no,

			''JOB CARD INITIATED'' AS err_msg,ISNULL(TAT_DAYS_JOBCARD,0) AS TAT_DAYS

			,x.MEMO_ID,x.MEMO_NO,X.MEMO_DT,
			CAST(DATEDIFF(d ,CAST(ORDER_DT+ISNULL(TAT_DAYS_JOBCARD,0) AS DATE),CAST(ISNULL(X.MEMO_DT,'''+ CONVERT(VARCHAR(20),@DTASON,101) +''') AS DATE)) AS INT) AS [STATUS]--,CAST(2 AS INT) AS SRNO

			FROM BUYER_ORDER_MST b (NOLOCK) --ON b.order_id=a.order_id

			LEFT OUTER JOIN

			(

				SELECT e.order_id,d.MEMO_ID,d.MEMO_NO,memo_dt,WOD_ROW_ID,SUM(C.QUANTITY ) AS JOB_CARD_QTY

				FROM ORD_PLAN_DET c (NOLOCK) 

				JOIN ORD_PLAN_MST d (NOLOCK) ON d.MEMO_ID=c.MEMO_ID

				JOIN BUYER_ORDER_DET e (NOLOCK) ON c.WOD_ROW_ID=e.row_id

				WHERE d.cancelled=0 AND ISNULL(c.wod_row_id,'''')<>''''

				GROUP BY e.order_id,d.MEMO_ID,d.MEMO_NO,memo_dt,WOD_ROW_ID

			)X ON X.order_id=b.order_id

			WHERE b.cancelled=0 --AND b.ORDER_ID=''JM011190000000JM000017''

			AND (''''=''' +@REF_NO+''' OR b.ref_no=''' +@REF_NO+''')

			AND (''''=''' +@BUYER_NAME+''' OR b.ac_code=''' +@BUYER_NAME+''')

			AND (''''=''' +@CORDER_NO+''' OR b.order_id=''' +@CORDER_NO+''')

			AND (b.order_dt BETWEEN '''+CONVERT(VARCHAR(20),@DFM_DT,101) +''' AND '''+CONVERT(VARCHAR(20),@DTO_DT,101) +''' )

			GROUP BY b.order_id,b.ORDER_NO,b.order_dt,b.ref_no,ISNULL(TAT_DAYS_JOBCARD,0),x.MEMO_ID,x.MEMO_NO,X.MEMO_DT

		)Z ON Z.order_id=X.order_id '--AND ISNULL(Z.memo_id,'')=ISNULL(X.memo_id'

				

		PRINT 'STEP 25 :'+ @CCMD

		

		EXEC SP_EXECUTESQL @CCMD

		

		--SELECT * FROM ##PENDINGORDER_PIVOT1

		

		SET @CCMD=N'SELECT a.*, '+@CSIZE+' 

					FROM  ##PENDINGORDER_PIVOT1 a 

					LEFT OUTER JOIN  

					(

					SELECT ORDER_ID,ORDER_NO,ORDER_DT	,REF_NO,JOB_CARD_ID,JOB_CARD_NO,JOB_CARD_DT, '+@CSIZE_sum+' FROM  ##PENDINGORDER_PIVOT GROUP BY ORDER_ID,ORDER_NO,ORDER_DT	,REF_NO,JOB_CARD_ID,JOB_CARD_NO,JOB_CARD_DT	

					

					) b ON b.order_id=a.order_id AND b.JOB_CARD_ID=a.JOB_CARD_ID

					ORDER BY a.order_dt,a.order_no'

					--GROUP BY ORDER_ID,ORDER_NO,ORDER_DT	,REF_NO,JOB_CARD_ID,JOB_CARD_NO,JOB_CARD_DT	'

		PRINT 'STEP 30 :'+ @CCMD

		

		EXEC SP_EXECUTESQL @CCMD

		

	END TRY

	BEGIN CATCH

		SELECT ERROR_MESSAGE()

	END CATCH

END


/*

EXEC SP3S_LIVE_PENDING_BO_TAT 1,'2019-04-30','2019-04-30','2019-04-30'
 EXEC SP3S_LIVE_PENDING_BO_TAT  @nQueryID=1,@DTASON	='2019-04-30',@DFM_DT= '2018-04-01',@DTO_DT='2019-04-29',@REF_NO='',@BUYER_NAME='',@CORDER_NO=''
*/