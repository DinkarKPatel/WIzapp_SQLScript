CREATE PROCEDURE SP3S_REVALIDATE_GST
(
@CCMID VARCHAR(22),
@CERRMSGGST VARCHAR(MAX) OUTPUT
)
AS
BEGIN
          DECLARE @GSTPER NUMERIC(10,2),@STOREDAMT NUMERIC(10,2),@EXECPTEDAMT NUMERIC(10,2)
          IF OBJECT_ID('TEMPDB..#T1','U')IS NOT NULL
          DROP TABLE #T1
          
          IF OBJECT_ID('TEMPDB.#T2','U')IS NOT NULL
          DROP TABLE #T2
       
          SELECT GST_PERCENTAGE,ROUND(SUM(IGST_AMOUNT+CGST_AMOUNT+SGST_AMOUNT+TAX_ROUND_OFF),2) AS AMT INTO #T1
		  FROM CMD01106  WHERE CM_ID=@CCMID GROUP BY GST_PERCENTAGE
		  
		  --SELECT * FROM #T1
		  
		   SELECT GST_PERCENTAGE,ROUND((SUM(XN_VALUE_WITHOUT_GST*GST_PERCENTAGE/100))  ,2)AS AMT INTO #T2 
		  FROM CMD01106  WHERE CM_ID=@CCMID GROUP BY GST_PERCENTAGE
		  
		  --SELECT * FROM #T2
		  SELECT TOP 1 @GSTPER=A.GST_PERCENTAGE,@STOREDAMT=A.AMT,@EXECPTEDAMT=B.AMT  FROM #T1 A 
		  JOIN #T2 B ON A.GST_PERCENTAGE=B.GST_PERCENTAGE 
		            AND A.AMT<>B.AMT
		            
		  
      IF ISNULL(@GSTPER,0)<>0
      BEGIN
        	  SET @CERRMSGGST= 'MISMATCH IN GST CALUCLATION FOR GST% '+RTRIM(LTRIM(STR(@GSTPER,6,2)))+' , STORED: '+RTRIM(LTRIM(STR(@STOREDAMT,10,2)))+' AND EXEPECTED : '+RTRIM(LTRIM(STR(@EXECPTEDAMT,10,2)))+' '
           
      END		            
     
END
