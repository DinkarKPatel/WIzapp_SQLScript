create PROCEDURE SP_DSR_CASHFUNDFLOW  
(  
 @DFROMDT DATETIME='',   
 @DTODT DATETIME='',  
 @NVIEWMODE INT=1,  
 @LPRINTDETAILS BIT=0,  
 @BESTIMATEENABLED BIT = 1,  
 @CDEPTID VARCHAR(5)='',  
 @CUSERCODE VARCHAR(12)='',  
 @CBINID VARCHAR(10)=''  
)  
AS  
BEGIN  
--(dinkar) Replace  left(memoid,2) to Location_code 
/*
MODIFICATION HISTORY:
MODIFIED BY			: BABAN
MODIFICATION DATE	: 15 SEP 2014
DESCRIPTION			: BASED ON CONFIG SETTING, CASH MEMOS COULD BE FILTERED(VALID CASH MEMO (VALIDATED BY CASHIER)
					  AND INVALID CASH MEMO).
*/  
 DECLARE @CMAJORDEPTID VARCHAR(5),@BDSM BIT  
 SELECT TOP 1 @BDSM=VALUE FROM CONFIG WHERE CONFIG_OPTION='OPEN_CASHIER_FOR_CASHMEMOS'
 SET @BDSM=ISNULL(@BDSM,0)
 SELECT @CMAJORDEPTID=MAJOR_DEPT_ID FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CDEPTID  
  
 SET @CMAJORDEPTID=ISNULL(@CMAJORDEPTID,'')  
  
  
 PRINT @DFROMDT  
 PRINT @DTODT  
 --@DTODT  SET @NVIEWMODE = 3  -- 1- CLUBBED, 2- LOCATION WISE, 3- USER WISE  
  
 --****** SUMMARIZED VIEW  
 DECLARE @REP_SUMMARY TABLE ( DEPT_ID VARCHAR(4), USER_CODE VARCHAR(10),   
         PRINT_GROUP INT, PRINT_ORDER INT, PRINT_DETAIL VARCHAR(50),  
         AMOUNT NUMERIC(14,2) )  
    
 -- SLS SUMMARY  
 INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, AMOUNT )  
 SELECT a.location_Code  AS DEPT_ID,   
   A.USER_CODE,  
   1 AS PRINT_GROUP,  
   1 AS PRINT_ORDER,  
   'CASH FROM SALES' AS PRINT_DETAIL,  
   SUM(PAY.CASH_AMOUNT) AS AMOUNT  
 FROM CMM01106 A    
 LEFT OUTER JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'SLS'  
 LEFT JOIN 
	(
		SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON A.CM_ID=DSD.CM_ID
 WHERE A.CANCELLED = 0   
 AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)      
 AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
 --AND A.CM_MODE = 1   
 AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
 AND A.CM_DT BETWEEN @DFROMDT AND @DTODT   
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
 AND  ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))
 GROUP BY  a.location_Code  , A.USER_CODE  
  
 -- WSL SUMMARY  
 INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, AMOUNT )  
 SELECT a.location_Code  AS DEPT_ID,   
   A.USER_CODE,  
   1 AS PRINT_GROUP,  
   1 AS PRINT_ORDER,  
   'CASH FROM WHOLESALES' AS PRINT_DETAIL,  
   SUM(PAY.CASH_AMOUNT) AS AMOUNT  
 FROM INM01106 A    
 LEFT OUTER JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.INV_ID AND PAY.XN_TYPE = 'WSL'  
 WHERE A.CANCELLED = 0 AND INV_MODE=1   
 AND LEFT(A.INV_NO,2) =(CASE WHEN @CMAJORDEPTID='' THEN LEFT(A.INV_NO,2) ELSE @CMAJORDEPTID END)      
 AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
 AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)  
 AND A.INV_DT BETWEEN @DFROMDT AND @DTODT   
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
 GROUP BY  a.location_Code  , A.USER_CODE  
  
 -- RECEIPTS / PAYMENTS SUMMARY  
 INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, AMOUNT )  
 SELECT a.location_Code  AS DEPT_ID,  
   A.USER_CODE,  
   1 AS PRINT_GROUP,  
   2 AS PRINT_ORDER,  
   (CASE WHEN A.ARC_TYPE = 1 AND A.ARCT = 1 THEN 'CASH FROM O/S RECEIPTS'  
      WHEN A.ARC_TYPE = 1 AND A.ARCT = 2 THEN 'CASH FROM ADVANCES'  
      WHEN A.ARC_TYPE = 1 AND A.ARCT = 3 THEN 'CASH FROM CHARGES/FEES'  
      WHEN A.ARC_TYPE = 2 THEN 'CASH PAYMENT TO CUSTOMERS'  
    ELSE '' END) AS PRINT_DETAIL,  
   SUM(ISNULL(PAY.CASH_AMOUNT,0)*(CASE WHEN A.ARC_TYPE = 2 THEN -1 ELSE 1 END)) AS AMOUNT  
 FROM ARC01106 A    
 LEFT OUTER JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.ADV_REC_ID AND PAY.XN_TYPE = 'ARC'  
 WHERE A.CANCELLED = 0     
 AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)      
 AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
 AND A.ADV_REC_DT BETWEEN @DFROMDT AND @DTODT   
 AND (ISNULL(PAY.CASH_AMOUNT,0) <> 0)    
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
 GROUP BY  a.location_Code ,A.USER_CODE, A.ARC_TYPE, A.ARCT  
  
  IF (SELECT ISNULL(VALUE,0) FROM CONFIG WHERE CONFIG_OPTION='CONSIDER_ALL_CASH_RECEIPTS')=1
  BEGIN
	 -- PETTY CASH SUMMARY  
	 INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, AMOUNT )  
	 SELECT b.location_Code  AS DEPT_ID, B.USER_CODE,  
	   1 AS PRINT_GROUP,  
	   3 AS PRINT_ORDER,   
	   (CASE WHEN A.XN_TYPE='CR' THEN 'CASH RECEIVED IN PETTYCASH' ELSE 'CASH PAYMENTS FROM PETTYCASH' END) AS PRINT_DETAIL,  
	   SUM(XN_AMOUNT * (CASE WHEN XN_TYPE='CR' THEN 1 ELSE -1 END)) AS AMOUNT  
	 FROM PED01106 A   
	 JOIN PEM01106 B ON A.PEM_MEMO_ID=B.PEM_MEMO_ID    
	 WHERE B.CANCELLED = 0     
	 AND b.location_Code =(CASE WHEN ((@CDEPTID = '')  OR (@CDEPTID=@CMAJORDEPTID)) THEN b.location_Code  ELSE @CDEPTID END)  
	 AND PEM_MEMO_DT BETWEEN @DFROMDT AND @DTODT   
	 AND B.USER_CODE=(CASE WHEN @CUSERCODE='' THEN B.USER_CODE ELSE @CUSERCODE END)   
	 GROUP BY  b.location_Code ,B.USER_CODE, A.XN_TYPE  
 END
     
 -- SLS CC SUMMARY  
 INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, AMOUNT )  
 SELECT a.location_Code  AS DEPT_ID,  
   A.USER_CODE,  
   2 AS PRINT_GROUP,  
   4 AS PRINT_ORDER,  
   'CARD RECEIPT FROM SALE: ' + C.PAYMODE_NAME AS PRINT_DETAIL,   
   SUM(B.AMOUNT) AS AMOUNT  
 FROM CMM01106 A   
 JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID   
 JOIN PAYMODE_MST C ON C.PAYMODE_CODE=B.PAYMODE_CODE  
 LEFT JOIN 
	(
		SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON A.CM_ID=DSD.CM_ID
 WHERE A.CANCELLED = 0    
 AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)    
 AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
 --AND   A.CM_MODE = 1     
 AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
 AND   B.XN_TYPE = 'SLS'  
 AND   C.PAYMODE_GRP_CODE='0000002'  
 AND   A.CM_DT BETWEEN @DFROMDT AND @DTODT   
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
 AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	
 GROUP BY  a.location_Code , A.USER_CODE, C.PAYMODE_NAME  
  
-- WSL CC SUMMARY  
 INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, AMOUNT )  
 SELECT a.location_Code  AS DEPT_ID,  
   A.USER_CODE,  
   2 AS PRINT_GROUP,  
   4 AS PRINT_ORDER,  
   'CARD RECEIPT FROM WHOLESALE: ' + C.PAYMODE_NAME AS PRINT_DETAIL,   
   SUM(B.AMOUNT) AS AMOUNT  
 FROM INM01106 A   
 JOIN PAYMODE_XN_DET B ON A.INV_ID = B.MEMO_ID   
 JOIN PAYMODE_MST C ON C.PAYMODE_CODE=B.PAYMODE_CODE  
 WHERE A.CANCELLED = 0  AND A.INV_MODE=1  
 AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)    
 AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
 --AND   A.CM_MODE = 1     
 AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
 AND   B.XN_TYPE = 'SLS'  
 AND   C.PAYMODE_GRP_CODE='0000002'  
 AND   A.INV_DT BETWEEN @DFROMDT AND @DTODT   
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
 GROUP BY  a.location_Code  , A.USER_CODE, C.PAYMODE_NAME  
  
 -- ARC CC SUMMARY  
 INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, AMOUNT )  
 SELECT a.location_Code  AS DEPT_ID,  
   A.USER_CODE,  
   2 AS PRINT_GROUP,  
   5 AS PRINT_ORDER,  
   (CASE WHEN A.ARCT = 1 THEN 'CARD RECEIPT FROM O/S RECEIPTS:'  
      WHEN A.ARCT = 2 THEN 'CARD RECEIPT FROM ADVANCES:'  
      WHEN A.ARCT = 3 THEN 'CARD RECEIPT FROM CHARGES/FEES:'  
    ELSE '' END) + C.PAYMODE_NAME AS PRINT_DETAIL,SUM(B.AMOUNT) AS AMOUNT  
 FROM ARC01106 A   
 JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID = B.MEMO_ID   
 JOIN PAYMODE_MST C ON C.PAYMODE_CODE=B.PAYMODE_CODE  
 WHERE A.ARC_TYPE = 1   
 AND   A.CANCELLED = 0   
 AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)      
 AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
 AND   B.XN_TYPE = 'ARC'  
 AND   C.PAYMODE_GRP_CODE='0000002'  
 AND A.ADV_REC_DT BETWEEN @DFROMDT AND @DTODT   
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)    
 GROUP BY a.location_Code  , A.USER_CODE, A.ARCT, C.PAYMODE_NAME  
  
  
 -- ADVANCE ADJUSTED IN SALE  
 INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, AMOUNT )  
 SELECT a.location_Code  AS DEPT_ID,  
   A.USER_CODE,  
   2 AS PRINT_GROUP,  
   5 AS PRINT_ORDER,  
   'PAYMENT TO CUSTOMER: '+ C.PAYMODE_NAME AS PRINT_DETAIL,SUM(B.AMOUNT)* -1 AS AMOUNT  
 FROM ARC01106 A   
 JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID = B.MEMO_ID   
 JOIN PAYMODE_MST C ON C.PAYMODE_CODE=B.PAYMODE_CODE  
 WHERE A.ARC_TYPE = 2   
 AND   A.CANCELLED = 0      
 AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)      
 AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)     AND   B.XN_TYPE = 'ARC'  
 AND   C.PAYMODE_CODE='0000001'  
 AND A.ADV_REC_DT BETWEEN @DFROMDT AND @DTODT   
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)    
 GROUP BY a.location_Code ,A.USER_CODE, A.ARCT, C.PAYMODE_NAME  
  
-- ADVANCE ADJUSTED IN SALE  
 INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, AMOUNT )  
 SELECT a.location_Code  AS DEPT_ID,  
   A.USER_CODE,  
   2 AS PRINT_GROUP,  
   5 AS PRINT_ORDER,  
   'PAYMENT TO CUSTOMER: '+ C.PAYMODE_NAME AS PRINT_DETAIL,SUM(B.AMOUNT)* -1  AS AMOUNT  
 FROM ARC01106 A   
 JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID = B.MEMO_ID   
 JOIN PAYMODE_MST C ON C.PAYMODE_CODE=B.PAYMODE_CODE  
 WHERE A.ARC_TYPE = 2   
 AND   A.CANCELLED = 0   
 AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)      
 AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)    
 AND   B.XN_TYPE = 'ARC'  
 AND   C.PAYMODE_CODE='0000002'  
 AND A.ADV_REC_DT BETWEEN @DFROMDT AND @DTODT   
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)    
 GROUP BY  a.location_Code  , A.USER_CODE, A.ARCT, C.PAYMODE_NAME  
 --****** DETAILED VIEW  
  
 DECLARE @REP_DETAILS TABLE (PRINT_ORDER INT, PRINT_DETAIL VARCHAR(100),   
        DEPT_ID VARCHAR(2), USER_CODE VARCHAR(10), MEMO_NO VARCHAR(50),   
        MEMO_DT DATETIME, ADJ_MEMO_NO VARCHAR(500), ADJ_MEMO_DT DATETIME,   
        AMOUNT NUMERIC(14,2), CUSTOMER_NAME VARCHAR(200), BILL_AMOUNT NUMERIC(10,2) )  
  
 IF @LPRINTDETAILS = 1  
 BEGIN  
  -- LIST OF CREDIT BILLS  
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT 1 AS PRINT_ORDER, 'LIST OF CREDIT ISSUED' AS PRINT_DETAIL,  
    a.location_Code  AS DEPT_ID, A.USER_CODE,  
    A.CM_NO AS MEMO_NO, A.CM_DT AS MEMO_DT,  
    '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,  
    B.CREDIT_AMOUNT AS AMOUNT,  
    C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
    A.NET_AMOUNT AS BILL_AMOUNT  
  FROM CMM01106 A  
  JOIN VW_BILL_PAYMODE B ON B.MEMO_ID = A.CM_ID AND B.XN_TYPE = 'SLS'  
  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
  LEFT JOIN 
	(
		SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON A.CM_ID=DSD.CM_ID
  WHERE B.CREDIT_AMOUNT > 0 AND A.CANCELLED = 0   
  AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)           
  AND ISNULL(A.BIN_ID, a.location_Code )=(CASE WHEN ((@CDEPTID = '')  OR (@CDEPTID=@CMAJORDEPTID)) THEN ISNULL(A.BIN_ID, a.location_Code ) ELSE @CDEPTID END)  
  AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
  AND   A.CM_DT BETWEEN @DFROMDT AND @DTODT   
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
  AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	
  ORDER BY a.location_Code ,A.CM_DT, A.CM_NO  
  
   INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,     
    MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,     
    AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )    
    SELECT 1 AS PRINT_ORDER, 'LIST OF CREDIT ISSUED IN WHOLESALE' AS PRINT_DETAIL,    
   a.location_Code  AS DEPT_ID, A.USER_CODE,    
   A.INV_NO AS MEMO_NO, A.INV_DT AS MEMO_DT,    
   '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,    
   B.CREDIT_AMOUNT AS AMOUNT,    
   C.AC_NAME  AS CUSTOMER_NAME,    
   A.NET_AMOUNT AS BILL_AMOUNT    
    FROM INM01106 A    
    JOIN VW_BILL_PAYMODE B ON B.MEMO_ID = A.INV_ID AND B.XN_TYPE = 'WSL'    
    JOIN LM01106 C ON A.AC_CODE = C.AC_CODE    
    WHERE B.CREDIT_AMOUNT > 0 AND A.CANCELLED = 0     
    AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)             
    AND ISNULL(A.BIN_ID, LEFT(A.INV_ID,2))=(CASE WHEN ((@CDEPTID = '')  OR (@CDEPTID=@CMAJORDEPTID)) THEN ISNULL(A.BIN_ID, a.location_Code ) ELSE @CDEPTID END)    
    AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE    
    AND   A.INV_DT BETWEEN @DFROMDT AND @DTODT     
    AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)     
    ORDER BY A.INV_DT, A.INV_NO   
    
  
  -- LIST OF CREDIT NOTES  
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT 2 AS PRINT_ORDER, 'LIST OF CREDIT NOTES ISSUED' AS PRINT_DETAIL,  
    a.location_Code  AS DEPT_ID, A.USER_CODE,  
    A.CM_NO AS MEMO_NO, A.CM_DT AS MEMO_DT,  
    '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,  
    ABS(B.CREDIT_AMOUNT) AS AMOUNT,  
    C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
    A.NET_AMOUNT AS BILL_AMOUNT  
  FROM CMM01106 A  
  JOIN VW_BILL_PAYMODE B ON B.MEMO_ID = A.CM_ID AND B.XN_TYPE = 'SLS'  
  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
  LEFT JOIN 
	(
		SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON A.CM_ID=DSD.CM_ID
  WHERE B.CREDIT_AMOUNT < 0 AND A.CANCELLED = 0       
  AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
  AND   SUBSTRING(A.CM_NO,len(a.location_Code)+3,1) = 'N'  
  AND   A.CM_DT BETWEEN @DFROMDT AND @DTODT  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
  AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	
  ORDER BY A.CM_DT, A.CM_NO  
  
  
  -- LIST OF CASH REFUND  
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT 3 AS PRINT_ORDER, 'LIST OF CASH REFUND' AS PRINT_DETAIL,  
    a.location_Code AS DEPT_ID, A.USER_CODE,  
    A.CM_NO AS MEMO_NO, A.CM_DT AS MEMO_DT,  
    '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,  
    ABS(B.CASH_AMOUNT) AS AMOUNT,  
    C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
    A.NET_AMOUNT AS BILL_AMOUNT  
  FROM CMM01106 A  
  JOIN VW_BILL_PAYMODE B ON B.MEMO_ID = A.CM_ID AND B.XN_TYPE = 'SLS'  
  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
  LEFT JOIN 
	(
		SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON A.CM_ID=DSD.CM_ID
  WHERE B.CASH_AMOUNT < 0 AND A.CANCELLED = 0        
  AND a.location_Code =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
  AND   A.CM_DT BETWEEN @DFROMDT AND @DTODT  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
  AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	
  ORDER BY A.CM_DT, A.CM_NO  
  
  -- LIST OF CREDIT REFUND  
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT 4 AS PRINT_ORDER, 'LIST OF CREDIT REFUND' AS PRINT_DETAIL,  
    a.location_Code AS DEPT_ID, A.USER_CODE,  
    A.CM_NO AS MEMO_NO, A.CM_DT AS MEMO_DT,  
    '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,  
    ABS(B.CREDIT_REFUND_AMOUNT) AS AMOUNT,  
    C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
    A.NET_AMOUNT AS BILL_AMOUNT  
  FROM CMM01106 A  
  JOIN VW_BILL_PAYMODE B ON B.MEMO_ID = A.CM_ID AND B.XN_TYPE = 'SLS'  
  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
  LEFT JOIN 
	(
		SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON A.CM_ID=DSD.CM_ID
  WHERE B.CREDIT_REFUND_AMOUNT <> 0 AND A.CANCELLED = 0   
  AND a.location_Code =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
  AND   A.CM_DT BETWEEN @DFROMDT AND @DTODT  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
  AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	
  ORDER BY A.CM_DT, A.CM_NO  
  
  
  -- LIST OF ADVANCE ADJUSTED  
   -- PENDING  
  --SELECT * FROM PAYMODE_GRP_MST  
  --SELECT * FROM PAYMODE_MST  
  --SELECT * FROM PAYMODE_XN_DET  
  -- LIST OF CREDIT NOTES ADJUSTED IN SALE  
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT 6 AS PRINT_ORDER, 'LIST OF CN ADJUSTED IN SALE' AS PRINT_DETAIL,  
    a.location_Code AS DEPT_ID, A.USER_CODE,  
    A.CM_NO AS MEMO_NO, A.CM_DT AS MEMO_DT,   
    CN.CM_NO AS ADJ_MEMO_NO, CN.CM_DT AS ADJ_MEMO_DT,  
    B.AMOUNT,   
    C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
    A.NET_AMOUNT AS BILL_AMOUNT  
  FROM CMM01106 A  
  JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID AND B.XN_TYPE = 'SLS'  
  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
  LEFT OUTER JOIN CMM01106 CN ON CN.CM_ID = B.ADJ_MEMO_ID  
  LEFT JOIN 
	(
		SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON A.CM_ID=DSD.CM_ID
  WHERE B.PAYMODE_CODE = '0000001'  AND A.CANCELLED = 0   
  AND a.location_Code =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
  AND   A.CM_DT BETWEEN @DFROMDT AND @DTODT  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
  AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	
  
  -- LIST OF CREDIT NOTES ADJUSTED IN WHOLESALE  
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT 6 AS PRINT_ORDER, 'LIST OF CN ADJUSTED IN WHOLESALE' AS PRINT_DETAIL,  
    a.location_Code AS DEPT_ID, A.USER_CODE,  
    A.INV_NO AS MEMO_NO, A.INV_DT AS MEMO_DT,   
    CN.CM_NO AS ADJ_MEMO_NO, CN.CM_DT AS ADJ_MEMO_DT,  
    B.AMOUNT,   
    C.AC_NAME AS CUSTOMER_NAME,  
    A.NET_AMOUNT AS BILL_AMOUNT  
  FROM INM01106 A  
  JOIN PAYMODE_XN_DET B ON A.INV_ID = B.MEMO_ID AND B.XN_TYPE = 'SLS'  
  JOIN LM01106 C ON A.AC_CODE = C.AC_CODE  
  LEFT OUTER JOIN CMM01106 CN ON CN.CM_ID = B.ADJ_MEMO_ID  
  WHERE B.PAYMODE_CODE = '0000001'  AND A.CANCELLED = 0  AND A.INV_MODE=1  
  AND a.location_Code =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
  AND   A.INV_DT BETWEEN @DFROMDT AND @DTODT  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
  
  -- LIST OF CREDIT NOTES ADJUSTED IN RECEIPT  
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT 7 AS PRINT_ORDER, 'LIST OF CN ADJUSTED IN RECEIPT' AS PRINT_DETAIL,  
    a.location_Code AS DEPT_ID, A.USER_CODE,  
    A.ADV_REC_NO AS MEMO_NO, A.ADV_REC_DT AS MEMO_DT,    
    CN.CM_NO AS ADJ_MEMO_NO, CN.CM_DT AS ADJ_MEMO_DT,  
    B.AMOUNT,   
    C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
    A.NET_AMOUNT AS BILL_AMOUNT  
  FROM ARC01106 A  
  JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID AND B.XN_TYPE = 'REC'  
  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
  LEFT OUTER JOIN CMM01106 CN ON CN.CM_ID = B.ADJ_MEMO_ID  
  WHERE B.PAYMODE_CODE = '0000001' AND A.CANCELLED = 0  
  AND a.location_Code =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND   CN.CM_DT BETWEEN @DFROMDT AND @DTODT   
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
  -- LIST OF ADVANCES IN RECEIPT    
  --BY MANISH TO CONSIDER ADVANCES AND OUTSTANDINGS  
--    
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT  8 AS PRINT_ORDER, 'LIST OF ADVANCES IN RECEIPT' AS PRINT_DETAIL,  
    a.location_Code AS DEPT_ID, A.USER_CODE,  
     A.ADV_REC_NO AS MEMO_NO,A.ADV_REC_DT AS MEMO_DT  ,  
    '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,  
    B.AMOUNT,   
    C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
    A.NET_AMOUNT AS BILL_AMOUNT  
  FROM ARC01106 A  
  JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID = B.MEMO_ID AND B.XN_TYPE = 'ARC'  
  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
  --LEFT OUTER JOIN CMM01106 CN ON CN.CM_ID = B.ADJ_MEMO_ID  
  WHERE ISNULL(A.ADV_REC_DT,'') BETWEEN @DFROMDT AND @DTODT  
  AND a.location_Code =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND A.ARCT = 2 AND A.CANCELLED = 0  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
    
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT  9 AS PRINT_ORDER, 'LIST OF OUTSTANDING IN RECEIPT' AS PRINT_DETAIL,  
    a.location_Code AS DEPT_ID, A.USER_CODE,  
     A.ADV_REC_NO AS MEMO_NO,A.ADV_REC_DT AS MEMO_DT  ,  
    DBO.FN_GETAGAINSTBILL(A.ADV_REC_ID) AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,  
    B.AMOUNT,   
    C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
    A.NET_AMOUNT AS BILL_AMOUNT  
  FROM ARC01106 A  
  JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID = B.MEMO_ID AND B.XN_TYPE = 'ARC'  
  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
  --LEFT OUTER JOIN CMM01106 CN ON CN.CM_ID = B.ADJ_MEMO_ID  
  WHERE ISNULL(A.ADV_REC_DT,'') BETWEEN @DFROMDT AND @DTODT   
  AND a.location_Code =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND A.ARC_TYPE=1 AND A.ARCT = 1 AND A.CANCELLED = 0  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
       
 INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT 9 AS PRINT_ORDER, 'LIST OF ADVANCE ADJUSTED IN PAYMENTS' AS PRINT_DETAIL,  
    a.location_Code AS DEPT_ID, A.USER_CODE,  
     A.ADV_REC_NO AS MEMO_NO,A.ADV_REC_DT AS MEMO_DT  ,  
    '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,  
    B.AMOUNT,   
    C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
    A.NET_AMOUNT * -1 AS BILL_AMOUNT  
  FROM ARC01106 A  
  JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID = B.MEMO_ID AND B.XN_TYPE = 'ARC'  
  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
  --LEFT OUTER JOIN CMM01106 CN ON CN.CM_ID = B.ADJ_MEMO_ID  
  WHERE ISNULL(A.ADV_REC_DT,'') BETWEEN @DFROMDT AND @DTODT   
  AND a.location_Code =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND A.ARC_TYPE=2 AND A.CANCELLED = 0  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
    
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT 11 AS PRINT_ORDER, 'LIST OF ADVANCE ADJUSTED IN CASH MEMO' AS PRINT_DETAIL,  
    a.location_Code AS DEPT_ID, A.USER_CODE,  
     A.CM_NO AS MEMO_NO,A.CM_DT AS MEMO_DT  ,  
    B.REF_NO AS ADJ_MEMO_NO, CN.ADV_REC_DT AS ADJ_MEMO_DT,  
    B.AMOUNT,   
    C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
    B.AMOUNT * -1 AS BILL_AMOUNT  
  FROM CMM01106 A  
  JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID AND B.XN_TYPE = 'SLS'  
  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
  JOIN ARC01106 CN ON CN.ADV_REC_ID = B.ADJ_MEMO_ID  
  LEFT JOIN 
	(
		SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON A.CM_ID=DSD.CM_ID
  WHERE B.PAYMODE_CODE ='0000002' AND  ISNULL(A.CM_DT,'') BETWEEN @DFROMDT AND @DTODT   
  AND a.location_Code =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND A.CANCELLED = 0  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
  AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	
    
    
  INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE,   
        MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
        AMOUNT, CUSTOMER_NAME, BILL_AMOUNT )  
  SELECT 11 AS PRINT_ORDER, 'LIST OF ADVANCE ADJUSTED IN WHOLESALE' AS PRINT_DETAIL,  
    a.location_Code AS DEPT_ID, A.USER_CODE,  
     A.INV_NO AS MEMO_NO,A.INV_DT AS MEMO_DT  ,  
    B.REF_NO AS ADJ_MEMO_NO, CN.ADV_REC_DT AS ADJ_MEMO_DT,  
    B.AMOUNT,   
    C.AC_NAME AS CUSTOMER_NAME,  
    B.AMOUNT * -1 AS BILL_AMOUNT  
  FROM INM01106 A  
  JOIN PAYMODE_XN_DET B ON A.INV_ID = B.MEMO_ID AND B.XN_TYPE = 'SLS'  
  JOIN LM01106 C ON A.AC_CODE = C.AC_CODE  
  JOIN ARC01106 CN ON CN.ADV_REC_ID = B.ADJ_MEMO_ID  
  WHERE A.INV_MODE=1 AND  B.PAYMODE_CODE ='0000002' AND  ISNULL(A.INV_DT,'') BETWEEN @DFROMDT AND @DTODT   
  AND a.location_Code =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code ELSE @CMAJORDEPTID END)           
  AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
  AND A.CANCELLED = 0  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)  
 END  
   
 IF @NVIEWMODE = 1   -- CLUBBED  
  SELECT '' DEPT_ID, ''DEPT_NAME, '' USER_CODE, ''USERNAME,   
    1 AS MAJOR_PRINT_GROUP, A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL,  
    '' AS MEMO_NO, '' AS MEMO_DT, '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,   
    SUM(AMOUNT) AS AMOUNT, '' AS CUSTOMER_NAME, 0 AS BILL_AMOUNT  
  FROM @REP_SUMMARY A  
  JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID  
  JOIN USERS C ON A.USER_CODE = C.USER_CODE 
  WHERE B.INACTIVE = 0  
  --GROUP BY A.DEPT_ID,B.DEPT_NAME, A.USER_CODE, C.USERNAME,A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL  
  GROUP BY A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL  
  UNION ALL   
  SELECT '' DEPT_ID, '' DEPT_NAME, '' USER_CODE, '' USERNAME,   
    2 AS MAJOR_PRINT_GROUP, PRINT_ORDER AS PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL,   
    MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
    AMOUNT, CUSTOMER_NAME, BILL_AMOUNT  
  FROM @REP_DETAILS A  
  JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID  
  JOIN USERS C ON A.USER_CODE = C.USER_CODE  
  WHERE B.INACTIVE = 0   
  --ORDER BY A.DEPT_ID, USERNAME, MAJOR_PRINT_GROUP, PRINT_GROUP, PRINT_ORDER, MEMO_DT, MEMO_NO  
  ORDER BY MAJOR_PRINT_GROUP, PRINT_GROUP, PRINT_ORDER, MEMO_DT, MEMO_NO  
  
 IF @NVIEWMODE = 2   -- LOCATION WISE  
  SELECT A.DEPT_ID, B.DEPT_NAME, '' USER_CODE, '' USERNAME,   
    1 AS MAJOR_PRINT_GROUP, A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL,   
    '' AS MEMO_NO, '' AS MEMO_DT, '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,   
    SUM(AMOUNT) AS AMOUNT, '' AS CUSTOMER_NAME, 0 AS BILL_AMOUNT  
  FROM @REP_SUMMARY A  
  JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID  
  JOIN USERS C ON A.USER_CODE = C.USER_CODE  
  WHERE B.INACTIVE = 0  
 -- GROUP BY  A.DEPT_ID,B.DEPT_NAME, A.USER_CODE, C.USERNAME,A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL  
  GROUP BY  A.DEPT_ID,B.DEPT_NAME,A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL 
  UNION ALL  
  
  SELECT A.DEPT_ID, B.DEPT_NAME, '' USER_CODE, '' USERNAME,   
    2 AS MAJOR_PRINT_GROUP, PRINT_ORDER AS PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL,   
    MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
    AMOUNT, CUSTOMER_NAME, BILL_AMOUNT  
  FROM @REP_DETAILS A  
  JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID  
  JOIN USERS C ON A.USER_CODE = C.USER_CODE  
  ----WHERE B.INACTIVE = 0  
  --ORDER BY A.DEPT_ID, USERNAME, MAJOR_PRINT_GROUP, PRINT_GROUP, PRINT_ORDER, MEMO_DT, MEMO_NO  
  ORDER BY A.DEPT_ID, MAJOR_PRINT_GROUP, PRINT_GROUP, PRINT_ORDER, MEMO_DT, MEMO_NO  
  
 IF @NVIEWMODE = 3   -- USER WISE  
  SELECT A.DEPT_ID, B.DEPT_NAME, A.USER_CODE, C.USERNAME AS USERNAME,   
    1 AS MAJOR_PRINT_GROUP, A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL,   
    '' AS MEMO_NO, '' AS MEMO_DT, '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,   
    SUM(AMOUNT) AS AMOUNT, '' AS CUSTOMER_NAME, 0 AS BILL_AMOUNT  
  FROM @REP_SUMMARY A  
  JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID  
  JOIN USERS C ON A.USER_CODE = C.USER_CODE  
  --WHERE B.INACTIVE = 0  
  GROUP BY A.DEPT_ID,B.DEPT_NAME, A.USER_CODE, C.USERNAME, A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL  
  UNION ALL  
  SELECT A.DEPT_ID, B.DEPT_NAME, A.USER_CODE, C.USERNAME,   
    2 AS MAJOR_PRINT_GROUP, PRINT_ORDER AS PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL,   
    MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT,   
    AMOUNT, CUSTOMER_NAME, BILL_AMOUNT  
  FROM @REP_DETAILS A  
  JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID  
  JOIN USERS C ON A.USER_CODE = C.USER_CODE  
  --WHERE B.INACTIVE = 0  
  ORDER BY A.DEPT_ID, C.USERNAME, MAJOR_PRINT_GROUP, PRINT_GROUP, PRINT_ORDER, MEMO_DT, MEMO_NO  
  
    SELECT CONVERT(DATETIME,'') AS [CM_DT], MIN(CM_NO) AS [FROM_BILL],MAX(CM_NO) AS [TO_BILL]  
	FROM CMM01106 CM
	LEFT JOIN 
	(
		SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON CM.CM_ID=DSD.CM_ID
	WHERE CM.CANCELLED = 0 AND  CM_DT BETWEEN @DFROMDT AND @DTODT  
	AND cm.location_Code = (CASE WHEN @CMAJORDEPTID = '' THEN cm.location_Code ELSE @CMAJORDEPTID END)  
	AND ISNULL(BIN_ID,'000') = (CASE WHEN ISNULL(@CBINID,'') = ''  THEN ISNULL(BIN_ID,'000') ELSE @CBINID END)  
	AND (MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)
	AND USER_CODE=(CASE WHEN @CUSERCODE='' THEN USER_CODE ELSE @CUSERCODE END)
	AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	
	GROUP BY LEFT(CM_NO,5)               
	ORDER BY CM_DT ASC
END
