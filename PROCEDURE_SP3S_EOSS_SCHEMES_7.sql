CREATE PROCEDURE SP3S_EOSS_SCHEMES_7
(
	@CSCHEMEDETROWID VARCHAR(50),
	@CSLSTITLE VARCHAR(1000),
	@CROUNDITEMLEVEL VARCHAR(5),
	@CJOINSTRBUY VARCHAR(MAX),
	@CJOINSTRGET VARCHAR(MAX),
	@CPICKSLRDISCMODE VARCHAR(5),
	@nSpId varchar(40),
	@CERRMSG	VARCHAR(MAX) OUTPUT
)
AS 
BEGIN

	DECLARE @NBUYQTY NUMERIC(5,0),@NBUYQTY1 NUMERIC(5,0),@NBUYQTY2 NUMERIC(5,0),@CPRODUCTCODE VARCHAR(50),@NMRP NUMERIC(10,2),@NQTY NUMERIC(10,2),
			@BMAXQTYSET BIT,@NREQBUYQTY NUMERIC(5,0),@CCMDROWID VARCHAR(50),@NLOOPCNT INT,@NMODE INT,
			@BQUALIFIED BIT,@CROWID VARCHAR(100),@NSTEP varchar(10),@NAMT NUMERIC(10,2),
			@CMRPORDER VARCHAR(10),@NREQBUYAMT NUMERIC(10,2),@BRETRY2NDCASE BIT,
			@CCMD NVARCHAR(MAX),@NDISCMODE INT,@NDISCFIGURE NUMERIC(7,3),
			@NAPPLIEDQTY NUMERIC(5,0),@BSCHEMEFOUND BIT,@CBUYFILTER VARCHAR(MAX),
			@CGETFILTER VARCHAR(MAX),@CADDFILTER VARCHAR(MAX),@NFILTERMODE INT,
			@BPROCESSSLRENTRY BIT,@NDISCAMTAPPLYMODE INT,@NTOTALMRPVAL NUMERIC(10,2),@NDISCAPPLIED NUMERIC(10,2),
			@BDONOTAPPLYSCHEMEONDISCITEMS BIT,@NCURPENDINGCNT NUMERIC(3,0),@NPREVPENDINGCNT NUMERIC(3,0)
	
		set @nStep='137.1'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1
	DECLARE @CENABLEOPTIMIZEDSCHEMES VARCHAR(2)
	SELECT TOP 1 @CENABLEOPTIMIZEDSCHEMES=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_OPTIMIZED_EOSS_SCHEMES'		
	
	set @CENABLEOPTIMIZEDSCHEMES=isnull(@CENABLEOPTIMIZEDSCHEMES,'')

	SELECT @BPROCESSSLRENTRY=0,@NCURPENDINGCNT=0,@NPREVPENDINGCNT=0		
	
START_PROC:
	SELECT @NBUYQTY=0,@CPRODUCTCODE='',@NMRP=0,@NQTY=0,@BMAXQTYSET=0,@NREQBUYQTY=0,
		   @CCMDROWID='',@NLOOPCNT=0,@NMODE=0,@BQUALIFIED=0,@CROWID='',@NSTEP=0,@NAMT=0,
		   @CMRPORDER='',@NREQBUYAMT=0,@BRETRY2NDCASE=0,@CCMD='',@NDISCMODE=0,
		   @NDISCFIGURE=0,@NAPPLIEDQTY=0,@BSCHEMEFOUND=0,@CBUYFILTER='',@CGETFILTER='',
		   @CADDFILTER='',@NFILTERMODE=0
			

	SELECT @BDONOTAPPLYSCHEMEONDISCITEMS=ISNULL(DONOT_APPLY_SCHEME_ON_DISCOUNTED_ITEMS,0) FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
	
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMD A WHERE (@BDONOTAPPLYSCHEMEONDISCITEMS=1 AND (ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 
				   AND A.SCHEME_SETUP_DET_ROW_ID='')) OR 
				   (@BDONOTAPPLYSCHEMEONDISCITEMS=0 AND ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0))
		GOTO END_PROC
		
	IF @BPROCESSSLRENTRY=1
		SET @CADDFILTER='A.QUANTITY<0'
	ELSE
		SET @CADDFILTER='A.QUANTITY>0'	
	set @nStep='137.2'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1
		
		
	IF CURSOR_STATUS('GLOBAL','SCHEMECUR') IN (0,1)
	BEGIN
		CLOSE SCHEMECUR
		DEALLOCATE SCHEMECUR
	END


BEGIN TRY        
	
	PRINT 'CHECK SCHEME SP3S_EOSS_SCHEMES_7'	
	set @nStep='137.4'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

		
	SELECT @CMRPORDER='',@BQUALIFIED=0,@BRETRY2NDCASE=0
		
			
	set @nStep='137.4'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

	IF OBJECT_ID('tempdb..#TMPCMDPPDISC','u') is null
		SELECT CMD_ROW_ID AS ROW_ID,CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT
		INTO #TMPCMDPPDISC FROM #TMPCMD WHERE 1=2 
	ELSE
		TRUNCATE TABLE #TMPCMDPPDISC
	
	IF OBJECT_ID('tempdb..#TMPCMDSCHEMES','u') is null
		SELECT PRODUCT_CODE,MRP,QUANTITY,CMD_ROW_ID AS ROW_ID,CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT,
		QUANTITY AS SCHEME_APPLIED_QTY,CONVERT(INT,0) AS MODE
		INTO #TMPCMDSCHEMES FROM #TMPCMD WHERE 1=2
	ELSE
		TRUNCATE TABLE #TMPCMDSCHEMES
			
	SELECT @CBUYFILTER=(CASE WHEN FILTER_MODE IN (0,1) AND @CENABLEOPTIMIZEDSCHEMES<>'1' THEN  BUY_FILTER_CRITERIA ELSE '' END),
		   @CGETFILTER=(CASE WHEN GET_FILTER_MODE IN (0,1) AND @CENABLEOPTIMIZEDSCHEMES<>'1' THEN  GET_FILTER_CRITERIA ELSE '' END),
		   @NFILTERMODE=FILTER_MODE,@NDISCMODE=DISC_METHOD,@NDISCAMTAPPLYMODE=DISCOUNT_AMOUNT_APPLICABLE_MODE
		   FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
		   	
	IF @NFILTERMODE NOT IN (0,1)
		SELECT @CADDFILTER=@CADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''''
	ELSE
		SELECT @CADDFILTER=@CADDFILTER+' AND 1=1'
	
	set @nStep='137.6'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1
				   		
	SELECT @CBUYFILTER=(CASE WHEN ISNULL(@CBUYFILTER,'')='' THEN '1=1' ELSE @CBUYFILTER END),
		   @CGETFILTER=(CASE WHEN ISNULL(@CGETFILTER,'')='' THEN '1=1' ELSE @CGETFILTER END)+
		   +' AND A.SCHEME_SETUP_DET_ROW_ID='''''
	
	
	IF @BDONOTAPPLYSCHEMEONDISCITEMS=1 
		SET @CBUYFILTER=@CBUYFILTER+( CASE WHEN @CBUYFILTER<>'' THEN ' AND ' ELSE '' END)+'ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 AND A.SCHEME_SETUP_DET_ROW_ID='''''
				   
	SET @CCMD=N' SELECT A.PRODUCT_CODE,A.NET,(ABS(A.QUANTITY))*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END),
				 A.CMD_ROW_ID AS ROW_ID,0 AS DISCOUNT_AMOUNT,
				 0 AS SCHEME_APPLIED_QTY,1 AS MODE	
				 FROM #TMPCMD A
				 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTRBUY+' WHERE '+@CBUYFILTER+' AND '+@CADDFILTER
				 
	PRINT @CCMD
					 
	INSERT #TMPCMDSCHEMES
	EXEC SP_EXECUTESQL @CCMD
	
		set @nStep='137.65'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

	SET @CCMD=N' SELECT A.PRODUCT_CODE,A.MRP,(ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY)*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END),
				 A.CMD_ROW_ID AS ROW_ID,0 AS DISCOUNT_AMOUNT,
				 0 AS SCHEME_APPLIED_QTY,2 AS MODE	
				 FROM #TMPCMD A
				 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTRGET+'
				 WHERE '+@CGETFILTER+' AND ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 AND '+@CADDFILTER
	PRINT @CCMD
					 
	INSERT #TMPCMDSCHEMES
	EXEC SP_EXECUTESQL @CCMD	

	
	--IF @@SPID=143
	--	SELECT @BDONOTAPPLYSCHEMEONDISCITEMS,'CHECK BEFORE APPLYING MAGIC',* FROM #TMPCMD
	
		
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMDSCHEMES)
	BEGIN
		IF @BPROCESSSLRENTRY=0 AND @CPICKSLRDISCMODE<>'3'
		BEGIN
			SET @BPROCESSSLRENTRY=1
			GOTO START_PROC
		END	
		ELSE
			GOTO END_PROC
	END	
		
	set @nStep='137.10'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

	
	SELECT @NBUYQTY1=SUM(ABS(QUANTITY)) FROM #TMPCMDSCHEMES WHERE MODE=1
	SELECT @NBUYQTY2=SUM(ABS(QUANTITY)) FROM #TMPCMDSCHEMES WHERE MODE=2
	AND ROW_ID NOT IN (SELECT ROW_ID FROM #TMPCMDSCHEMES WHERE MODE=1)
	
	
	SELECT @BQUALIFIED=0,@BSCHEMEFOUND=0,@NDISCFIGURE=0

	----- DO NOT APPLY SCHEME IF NO BUY ITEM IS FOUND
	IF ISNULL(@NBUYQTY1,0)=0
		GOTO EXIT_PROC
		
	SET @NBUYQTY=ISNULL(@NBUYQTY1,0)+ISNULL(@NBUYQTY2,0)
	
	--SELECT @NBUYQTY,* FROM #TMPCMDSCHEMES 
	set @nStep='137.12'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1
	
	SELECT @NDISCFIGURE=DISCOUNT_FIGURE FROM SCHEME_SETUP_SCH0007_1 (NOLOCK)
	WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID AND @NBUYQTY BETWEEN 
	FROM_QTY AND TO_QTY

	IF ISNULL(@NDISCFIGURE,0)<>0
		SELECT @BSCHEMEFOUND=1
		
	IF @BSCHEMEFOUND=0
	BEGIN
		SELECT TOP 1 @NDISCFIGURE=DISCOUNT_FIGURE FROM SCHEME_SETUP_SCH0007_1 (NOLOCK)
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID AND TO_QTY<=@NBUYQTY ORDER BY TO_QTY DESC

		IF ISNULL(@NDISCFIGURE,0)<>0
			SELECT @BSCHEMEFOUND=1,@BMAXQTYSET=1
	END
	
	IF @BSCHEMEFOUND=0
		GOTO EXIT_PROC
		
	set @nStep='137.14'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1



	IF @BPROCESSSLRENTRY=1
	BEGIN
		DECLARE @CPICKMAXDISCSLR VARCHAR(2)
		
		SELECT TOP 1 @CPICKMAXDISCSLR=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='PICK_MAXDISCOUNT_POWERPRICING_SLR' 
		
		SET @CPICKMAXDISCSLR=ISNULL(@CPICKMAXDISCSLR,'')
		
		IF @CPICKMAXDISCSLR='1'
		BEGIN	
			SELECT TOP 1 @NDISCFIGURE=DISCOUNT_FIGURE FROM SCHEME_SETUP_SCH0007_1 (NOLOCK)
			WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID ORDER BY TO_QTY DESC

			IF ISNULL(@NDISCFIGURE,0)<>0
				SELECT @BMAXQTYSET=1
		END	
	END	
		
	IF @BMAXQTYSET=1
	BEGIN
		set @nStep='137.16'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

		PRINT 'MAX QTY SET'
		IF @NDISCMODE=1
			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=(CASE WHEN @CROUNDITEMLEVEL='1' THEN
			ROUND(MRP*@NDISCFIGURE*QUANTITY/100,0) ELSE MRP*@NDISCFIGURE*QUANTITY/100 END),
			SCHEME_APPLIED_QTY=ABS(QUANTITY) WHERE MODE=2
		ELSE
		IF @NDISCMODE=3
		BEGIN
			IF @NDISCAMTAPPLYMODE<>2
				UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=(CASE WHEN (MRP-@NDISCFIGURE)>=0 THEN @NDISCFIGURE
				ELSE MRP END)*QUANTITY,SCHEME_APPLIED_QTY=ABS(QUANTITY)  WHERE MODE=2
			ELSE
			BEGIN
				set @nStep='137.18'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

				SELECT @NTOTALMRPVAL=SUM(MRP*QUANTITY) FROM #TMPCMDSCHEMES 
				
				UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=ABS((@NDISCFIGURE/@NTOTALMRPVAL)*MRP*QUANTITY)*
				(CASE WHEN @BPROCESSSLRENTRY=1 THEN -1 ELSE 1 END),
				SCHEME_APPLIED_QTY=ABS(QUANTITY) WHERE MODE=2	
				
				SELECT @NDISCAPPLIED=SUM(DISCOUNT_AMOUNT) FROM #TMPCMDSCHEMES
				
				IF @NDISCAPPLIED<>@NDISCFIGURE
				BEGIN
					SELECT TOP 1 @CCMDROWID=ROW_ID FROM #TMPCMDSCHEMES WHERE MODE=2
					 
					UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=DISCOUNT_AMOUNT+(@NDISCFIGURE-@NDISCAPPLIED)
					WHERE ROW_ID=@CCMDROWID
				END	
			END	
		END	
		ELSE
		begin
			set @nStep='137.20'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=(CASE WHEN (MRP-@NDISCFIGURE)>=0 THEN (MRP-@NDISCFIGURE)
			ELSE MRP END)*QUANTITY,SCHEME_APPLIED_QTY=ABS(QUANTITY) WHERE MODE=2
		end
		SET @BQUALIFIED = 1
		
		GOTO EXIT_PROC	
	END	
	
	set @nStep='137.21'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1
	
	
	PRINT 'MAGIC SCHEME-2'
	
	SET @NAPPLIEDQTY=0
	DECLARE SCHEMECUR CURSOR FOR SELECT PRODUCT_CODE,MRP,QUANTITY,ROW_ID FROM #TMPCMDSCHEMES WHERE MODE=2
	
	OPEN SCHEMECUR
	FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID
	
	WHILE @@FETCH_STATUS=0
	BEGIN
	set @nStep='137.23'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

		SET @NLOOPCNT=1
		WHILE @NLOOPCNT<=ABS(@NQTY)
		BEGIN
			SET @NAPPLIEDQTY=@NAPPLIEDQTY+1
			
			IF @NDISCMODE=1
			BEGIN
				set @nStep='137.25'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

				INSERT #TMPCMDPPDISC
				SELECT @CCMDROWID,(CASE WHEN @CROUNDITEMLEVEL='1' THEN
				ROUND(@NMRP*@NDISCFIGURE/100,0) ELSE @NMRP*@NDISCFIGURE/100 END)
 			END	
			ELSE
			IF @NDISCMODE=3
			BEGIN
					set @nStep='137.27'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

				IF @NDISCAMTAPPLYMODE<>2
					INSERT #TMPCMDPPDISC
					SELECT @CCMDROWID,(CASE WHEN @NMRP-@NDISCFIGURE>=0 THEN @NDISCFIGURE ELSE @NMRP END)
				ELSE
				BEGIN
					INSERT #TMPCMDPPDISC
					SELECT @CCMDROWID,@NMRP
				END	
			END				 			
			ELSE
			BEGIN
				INSERT #TMPCMDPPDISC
				SELECT @CCMDROWID,(CASE WHEN @NMRP-@NDISCFIGURE>=0 THEN @NMRP-@NDISCFIGURE ELSE @NMRP END)
			END				
					    
			SET @BQUALIFIED=1
		  
		    SET @NLOOPCNT=@NLOOPCNT+1
		END										

		IF @NAPPLIEDQTY=@NBUYQTY
			BREAK
		
		FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID
	END
	
	set @nStep='137.28'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

	
	CLOSE SCHEMECUR
	DEALLOCATE SCHEMECUR
	
	PRINT 'MAGIC SCHEME-3'
	
	IF NOT (@NDISCAMTAPPLYMODE=2 AND @NDISCMODE=3)
	BEGIN
		PRINT 'MAGIC SCHEME-4'
		
		--SELECT * FROM  #TMPCMDPPDISC
		
		UPDATE A SET DISCOUNT_AMOUNT=A.DISCOUNT_AMOUNT+ABS(B.DISCOUNT_AMOUNT)*(CASE WHEN @BPROCESSSLRENTRY=1 THEN -1 ELSE 1 END),
					 SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+ABS(B.QTY)
		FROM #TMPCMDSCHEMES A
		JOIN 
		(SELECT ROW_ID,SUM(DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT,COUNT(*) AS QTY FROM  #TMPCMDPPDISC
		 GROUP BY ROW_ID) B ON B.ROW_ID=A.ROW_ID
	END
	ELSE
	BEGIN
			set @nStep='137.30'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

		PRINT 'MAGIC SCHEME-5'
		SELECT @NTOTALMRPVAL=SUM(DISCOUNT_AMOUNT) FROM #TMPCMDPPDISC 

				
		UPDATE A SET DISCOUNT_AMOUNT=A.DISCOUNT_AMOUNT+ABS((@NDISCFIGURE/@NTOTALMRPVAL)*MRP*QUANTITY)*
		(CASE WHEN @BPROCESSSLRENTRY=1 THEN -1 ELSE 1 END),
					 SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+ABS(B.QTY)
		FROM #TMPCMDSCHEMES A
		JOIN 
		(SELECT ROW_ID,COUNT(*) AS QTY FROM  #TMPCMDPPDISC
		 GROUP BY ROW_ID) B ON B.ROW_ID=A.ROW_ID
				 		
		SELECT @NDISCAPPLIED=SUM(DISCOUNT_AMOUNT) FROM #TMPCMDSCHEMES
		
		IF @NDISCAPPLIED<>@NDISCFIGURE
		BEGIN
	set @nStep='137.32'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

			SELECT TOP 1 @CCMDROWID=A.ROW_ID FROM #TMPCMDSCHEMES A JOIN #TMPCMDPPDISC B ON A.ROW_ID=B.ROW_ID
			 
			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=DISCOUNT_AMOUNT+(@NDISCFIGURE-@NDISCAPPLIED)
			WHERE ROW_ID=@CCMDROWID
		END	
		
		--SELECT @BQUALIFIED,@NAPPLIEDQTY,@NREQBUYQTY, 'AFTER APPLYING SCH002',* FROM  #TMPCMDSCHEMES
	END	
	
	GOTO EXIT_PROC
END TRY

BEGIN CATCH
	  PRINT 'CATCH START'       
	  SET @CERRMSG='P:SP3S_EOSS_SCHEMES_7, TITLE : '+@CSLSTITLE+' STEP:'+LTRIM(RTRIM(@NSTEP))+', MESSAGE:'+ERROR_MESSAGE()        
	  GOTO END_PROC
END CATCH

EXIT_PROC:

	set @nStep='137.34'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1
		
	--SELECT ISNULL(@CERRMSG,'') AS ERRMSG
	
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
		IF @BQUALIFIED=0
		BEGIN
			--SELECT 'MAGIC SCHEME NOT QUALIFIED'
			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=0
			IF @BPROCESSSLRENTRY=0
			BEGIN
				SET @BPROCESSSLRENTRY=1
				GOTO START_PROC
			END	
			ELSE
				GOTO END_PROC
		END	
		ELSE

		BEGIN
			set @nStep='137.34'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

			--SELECT 'MAGIC SCHEME QUALIFIED'
			
			UPDATE #TMPCMD SET DISCOUNT_AMOUNT=#TMPCMD.DISCOUNT_AMOUNT+B.DISCOUNT_AMOUNT,
			SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSLSTITLE,
			SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
			SCHEME_APPLIED_QTY=#TMPCMD.SCHEME_APPLIED_QTY+B.SCHEME_APPLIED_QTY 
			FROM #TMPCMDSCHEMES B WHERE B.ROW_ID=#TMPCMD.CMD_ROW_ID 
			AND B.SCHEME_APPLIED_QTY<>0
			
			UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ABS(ROUND((DISCOUNT_AMOUNT/(MRP*QUANTITY))*100,2)),
			NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT
			
			--SELECT * FROM #TMPCMD
		END		
	END	
	ELSE
		GOTO END_PROC
	
	IF EXISTS (SELECT TOP 1 * FROM #TMPCMD WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0)
	BEGIN
		IF @NPREVPENDINGCNT<>0
		BEGIN
			set @nStep='137.36'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

			SELECT @NCURPENDINGCNT=SUM(ABS(QUANTITY)-SCHEME_APPLIED_QTY) FROM #TMPCMD
			WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0
		END
		ELSE
			SELECT @NPREVPENDINGCNT=SUM(ABS(QUANTITY)-SCHEME_APPLIED_QTY) FROM #TMPCMD
			WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0
		
		IF @NPREVPENDINGCNT<>@NCURPENDINGCNT	
			GOTO START_PROC
	END
	
END_PROC:

	set @nStep='137.38'
	EXEC SP_CHKXNSAVELOG 'sch_getdisc',@NSTEP,0,@NSPID,'',1

END
---- 'END OF CREATING PROCEDURE SP3S_EOSS_SCHEMES_7'