CREATE PROCEDURE DBO.SP3S_UPDATE_SAPINVOICE    
(    
 @TABLE_NAME VARCHAR(MAX)    
,@XN_ID VARCHAR(100)     
)    
AS    
BEGIN    
    
 BEGIN TRY    
  SET NOCOUNT ON;    
      
   IF OBJECT_ID('TEMPDB..#RESULT_OUTPUT') IS NOT NULL     
      DROP TABLE #RESULT_OUTPUT    
      
   CREATE TABLE #RESULT_OUTPUT(ERRMSG VARCHAR(MAX), MEMO_ID VARCHAR(50))    
      
   BEGIN TRANSACTION    
       
   --DECLARE LOCAL VARIABLE    
   DECLARE @CQUERY NVARCHAR(MAX),@ERRMSG VARCHAR(MAX),@CSOURCEDBNAME VARCHAR(100)    
          ,@CDESTINATIONDB VARCHAR(100),@AC_CODE VARCHAR(200)    
          ,@CLOCATIONID VARCHAR(50),@CFINYEAR VARCHAR(20)    
          ,@TEMPDB VARCHAR(200)    
          ,@CTABLE_EXISTS VARCHAR(10),@CSTEP VARCHAR(5)    
          ,@AC_NAME VARCHAR(100)    ,@NSPID INT
        
	SET @NSPID=@@SPID          
       
   SET @CSTEP='10'    
       
      
       
   SELECT @CLOCATIONID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'       
   SET @CSOURCEDBNAME = DB_NAME()+'..'    
       
       
   SET @CSTEP='20'    
       
   SET @CDESTINATIONDB =DB_NAME()+'..'    
   SET @CTABLE_EXISTS= 0    
   --SET VALIDATION    
   IF ISNULL(@TABLE_NAME,'') = ''    
      BEGIN    
       SET @ERRMSG='TABLE NAME PARAMATER COULD NOT BE NULL.'    
       GOTO PROC_END;    
      END    
   IF ISNULL(@XN_ID,'') = ''    
      BEGIN    
       SET @ERRMSG ='XN_ID COULD NOT BE NULL. PLEASE PASS VALUE IN XN_ID'    
       GOTO PROC_END;    
      END    
       
   SET @CSTEP='30'    
       
   SET @CQUERY =N'SELECT @CTABLE_EXISTS = OBJECT_ID('''+@TABLE_NAME+''')'    
   PRINT @CQUERY    
   EXEC SP_EXECUTESQL @CQUERY ,N'@CTABLE_EXISTS VARCHAR(10) OUTPUT',@CTABLE_EXISTS OUTPUT    
       
   IF ISNULL(@CTABLE_EXISTS,0) = 0    
      BEGIN    
            
       SET @ERRMSG ='TEMP TABLE NOT EXISTS..'    
       GOTO PROC_END;    
      END    
       
   SET @CSTEP='40'    
          
   ---SET AC CODE FOR INSERT FOR TEMP TABLE OF PIM01106    
   SELECT @AC_CODE=VALUE FROM DBO.CONFIG WITH(NOLOCK) WHERE  CONFIG_OPTION='ERP_HO_AC_CODE'    
   SELECT @AC_NAME = AC_NAME FROM LM01106 WITH(NOLOCK) WHERE AC_CODE = @AC_CODE    
       
   SET @CQUERY=N'SELECT TOP 1 @CFINYEAR= FIN_YEAR FROM '+@TEMPDB+''+@TABLE_NAME+''    
   PRINT(@CQUERY)    
   EXEC SP_EXECUTESQL @CQUERY , N'@CFINYEAR VARCHAR(20) OUTPUT',@CFINYEAR OUTPUT    
     
   
   SET @CSTEP=42 ----CHANGE FOR HSN MASTER
   
    SET @CQUERY=N'INSERT INTO HSN_MST(HSN_CODE,TAXABLE_ITEM,HSN_TYPE,GST_VARIATION ,GST_CAL_BASIS)
               SELECT DISTINCT A.HSN_CODE,A.TAXABLE_ITEM,A.HSN_TYPE,A.GST_VARIATION ,A.GST_CAL_BASIS 
               FROM '+@TEMPDB+''+@TABLE_NAME+' A LEFT JOIN HSN_MST B ON A.HSN_CODE=B.HSN_CODE WHERE B.HSN_CODE IS NULL'    
   PRINT(@CQUERY)    
   EXEC SP_EXECUTESQL @CQUERY  
   
    SET @CSTEP=44 ----CHANGE FOR HSN MASTER
   
    SET @CQUERY=N'INSERT INTO HSN_DET(HSN_CODE,TAX_PERCENTAGE,RATE_CUTOFF,RATE_CUTOFF_TAX_PERCENTAGE ,WEF,ROW_ID)  
               SELECT HSN_CODE,TAX_PERCENTAGE,RATE_CUTOFF,RATE_CUTOFF_TAX_PERCENTAGE,WEF,NEWID()
               FROM
               (
               SELECT DISTINCT A.HSN_CODE,A.TAX_PERCENTAGE,A.RATE_CUTOFF,A.RATE_CUTOFF_TAX_PERCENTAGE ,A.WEF
               FROM '+@TEMPDB+''+@TABLE_NAME+' A LEFT JOIN HSN_DET B ON A.HSN_CODE=B.HSN_CODE WHERE B.HSN_CODE IS NULL
               )A'    
   PRINT(@CQUERY)    
   EXEC SP_EXECUTESQL @CQUERY    
       
   
   DELETE FROM PUR_PIM01106_UPLOAD WHERE SP_ID=@NSPID    
   DELETE FROM PUR_PID01106_UPLOAD WHERE SP_ID=@NSPID
   
   SET @CSTEP='50'    
       
   ---SELECT DATA FROM TEMP TABLE AND INSERT INTOP NEWLY CREATED TEMP TABLE     
   SET @CQUERY=N'INSERT INTO PUR_PIM01106_UPLOAD    
               (FIN_YEAR,INV_NO,INV_DT,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,MRR_ID,MRR_NO,AC_CODE,MEMO_TYPE,    
               EXCISE_DUTY_AMOUNT,PIM_MODE,MEMO_PREFIX,TAXFORM_STORAGE_MODE,BILL_LEVEL_TAX_METHOD,REMARKS,MANUAL_DISCOUNT    
               ,MANUAL_ROUNDOFF,BILL_CHALLAN_MODE,SENT_FOR_RECON,INV_MODE,EMP_CODE,PUR_CAL_METHOD,PARTY_INV_AMOUNT,BIN_ID    
               ,BROKER_AC_CODE,BROKER_COMM_PERCENTAGE,BROKER_COMM_AMOUNT,MANUAL_BROKER_COMM,ACCOUNTS_DEPT_ID,MRR_DT    
               ,MEMO_TIME,CHI_ENTRY_REF_NO,TERMS,CHECKED_BY,RECEIVED_BY,USER_CODE,SENT_TO_HO,EDT_USER_CODE,CREDIT_DAYS    
               ,VANDOR_BILL_DT,POSTEDINAC,BILL_NO,RECEIPT_DT,TOTAL_AMOUNT,SUBTOTAL,OTHER_CHARGES    
               ,FREIGHT,TAX_PERCENTAGE,TAX_AMOUNT,ROUND_OFF,LAST_UPDATE,CANCELLED,DEPT_ID,POSTTAXDISCOUNTAMOUNT
               ,APPROVEDLEVELNO,THROUGH,GENERATED_BY_CHRECON,SEND_TO_LOC,INV_ID,FROM_EXCEL,EXCEL_FILE_PATH,MRR_CREATION_DEPT_ID    
               ,CR_DISCOUNT_PERCENTAGE,OH_TAX_METHOD,PARTY_STATE_CODE,SP_ID)     
               SELECT DISTINCT FIN_YEAR,INV_NO,INV_DT,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,''LATER'',''LATER'','''+@AC_CODE+''',1    
               , 0, 0,'''', 0, 0,'''', 0,0,0,0,1,'''',0,0,''000'',''0000000000'',0,0,0,'''',INV_DT,INV_DT,'''','''','''','''',''0000000'','''',''0000000''    
               ,0,INV_DT,0,'''','''', 0, 0, 0, 0, 0, 0, 0, GETDATE(), 0,'''+@CLOCATIONID+''', 0, 0,'''','''','''', '''+@XN_ID+''' AS INV_ID,  
               0 AS FROM_EXCEL,'''' AS EXCEL_FILE_PATH    
               ,'''+@CLOCATIONID+''' AS MRR_CREATION_DEPT_ID,0 AS CR_DISCOUNT_PERCENTAGE,1 AS OH_TAX_METHOD,''00'' AS  PARTY_STATE_CODE ,'+LTRIM(RTRIM(STR(@NSPID)))+' AS SP_ID  
               FROM '+@TEMPDB+''+@TABLE_NAME+''    
   PRINT(@CQUERY)    
   EXEC SP_EXECUTESQL @CQUERY    
       
       
   SET @CSTEP='60'    
     
   ---SELECT DATA FROM TEMP TABLE AND INSERT INTOP NEWLY CREATED TEMP TABLE     
   SET @CQUERY=N'INSERT INTO PUR_PID01106_UPLOAD   
               (QUANTITY,PURCHASE_PRICE,MRP,PRODUCT_CODE,ROW_ID,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,FIX_MRP,VENDOR_EAN_NO    
               ,PARA4_CODE,PARA5_CODE,PARA6_CODE,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PRINT_LABEL,MP_PERCENTAGE,LAST_UPDATE    
               ,PARA3_CODE,MRR_ID,SRNO,WHOLESALE_PRICE,WSP_PERCENTAGE,GROSS_PURCHASE_PRICE,BOX_NO,PO_ROW_ID,INVOICE_QUANTITY    
               ,SCHEME_QUANTITY,FORM_ID,TAX_PERCENTAGE,TAX_AMOUNT,RFNET,RFNET_WOTAX,USER_SRNO,MANUAL_MRP,MANUAL_WSP    
               ,MANUAL_DISCOUNT,MD_PERCENTAGE,WD_PERCENTAGE,AUTO_SRNO,MANUAL_GPP,MANUAL_WSPP,MANUAL_MPP,MANUAL_DPP,BIN_ID    
               ,AREA_LENGTH,AREA_WIDTH,AREA_SQARE,AREA_UOM_CODE,AREA_RATE_PP,MATERIAL_COST,RATE_AREA_SQUARE,CASHDISCOUNTAMOUNT    
               ,PIMDISCOUNTAMOUNT,PIMPOSTTAXDISCOUNTAMOUNT,PIMEXCISEDUTYAMOUNT,PRTAMOUNT,W8_CHALLAN_ID,ITEM_EXCISE_DUTY_PERCENTAGE    
               ,ITEM_EXCISE_DUTY_AMOUNT,PRTAMOUNT_CREDITED,MANUAL_MDP,HSN_CODE,SP_ID )    
                 
               SELECT QUANTITY,PURCHASE_PRICE,MRP,PRODUCT_CODE,ROW_ID,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,FIX_MRP,VENDOR_EAN_NO    
                ,''0000000'' AS PARA4_CODE,''0000000'' AS PARA5_CODE,''0000000'' AS PARA6_CODE,  
                ARTICLE_CODE,''0000000'' AS PARA1_CODE,''00000000'' AS PARA2_CODE,0 AS PRINT_LABEL,0 AS MP_PERCENTAGE,  
                GETDATE() AS LAST_UPDATE,''0000000'' AS PARA3_CODE,''LATER'' AS MRR_ID,0 AS SRNO,0 AS WHOLESALE_PRICE,  
                0 AS WSP_PERCENTAGE,PURCHASE_PRICE AS GROSS_PURCHASE_PRICE,0 AS BOX_NO,'''' AS PO_ROW_ID,QUANTITY AS INVOICE_QUANTITY,0 AS SCHEME_QUANTITY,  
                FORM_ID,0 AS TAX_PERCENTAGE,0 AS TAX_AMOUNT,0 AS RFNET,0 AS RFNET_WOTAX,0 AS USER_SRNO,0 AS MANUAL_MRP,0 AS MANUAL_WSP,  
                0 AS MANUAL_DISCOUNT,0 AS MD_PERCENTAGE,0 AS WD_PERCENTAGE,0 AS AUTO_SRNO,0 AS MANUAL_GPP,0 AS MANUAL_WSPP,0 AS MANUAL_MPP,0 AS MANUAL_DPP,  
                ''000'' AS BIN_ID,0 AS AREA_LENGTH,0 AS AREA_WIDTH,0 AS AREA_SQARE,'''' AS AREA_UOM_CODE,0 AS AREA_RATE_PP,0 AS MATERIAL_COST,  
                0 AS RATE_AREA_SQUARE,0 AS CASHDISCOUNTAMOUNT,0 AS PIMDISCOUNTAMOUNT,0 AS PIMPOSTTAXDISCOUNTAMOUNT,  
                0 AS PIMEXCISEDUTYAMOUNT,0 AS PRTAMOUNT,'''' AS W8_CHALLAN_ID,0 AS ITEM_EXCISE_DUTY_PERCENTAGE    
               ,0 AS ITEM_EXCISE_DUTY_AMOUNT,0 AS PRTAMOUNT_CREDITED,0 AS MANUAL_MDP,HSN_CODE ,'+LTRIM(RTRIM(STR(@NSPID)))+' AS SP_ID 
               FROM '+@TEMPDB+''+@TABLE_NAME+''    
   PRINT(@CQUERY)    
   EXEC SP_EXECUTESQL @CQUERY    
       
       
   SET @CSTEP='70'    
       
   --CREATE TABLE #TMPMASTERSENC FOR PERIVIOUS QUERY     
   IF OBJECT_ID('TEMPDB..#TMPMASTERSENC','U') IS NOT NULL    
      DROP TABLE #TMPMASTERSENC    
   SELECT S1.PRODUCT_CODE,T1.RATE AS PURCHASE_PRICE,B1.ARTICLE_NO    
 ,S1.BARCODE_CODING_SCHEME AS CODING_SCHEME,D.SECTION_NAME,C1.SUB_SECTION_NAME,E.PARA1_NAME    
 ,F.PARA2_NAME ,G.PARA3_NAME,FR.FORM_NAME,H.PARA4_NAME,I.PARA5_NAME,    
 J.PARA6_NAME AS PARA6_NAME  ,B1.ARTICLE_DESC,B.INV_NO,B.INV_DT,    
 UOM.UOM_NAME,T1.QUANTITY,S1.MRP,T1.RATE AS WS_PRICE,T1.DISCOUNT_PERCENTAGE,T1.DISCOUNT_AMOUNT,    
 B1.ALIAS AS ARTICLE_ALIAS,B1.ARTICLE_NAME,S1.ONLINE_PRODUCT_CODE,S1.VENDOR_EAN_NO,FIN_YEAR,S1.HSN_CODE    
 ,CAST('' AS VARCHAR(100)) AS ROW_ID,B1.STOCK_NA,S1.FIX_MRP    
 ,CAST('' AS VARCHAR(100)) AS GEN_EAN_CODES     
 ,CAST('' AS VARCHAR(100)) AS AC_NAME     
 ,S1.PRODUCT_NAME AS [PRODUCT_NAME]    
 ,CAST('' AS VARCHAR(10))  AS BIN_ID,C1.ALIAS AS SUB_SECTION_ALIAS,D.ALIAS AS SECTION_ALIAS    
 INTO #TMPMASTERSENC    
 FROM IND01106 T1 (NOLOCK)    
 JOIN INM01106 B (NOLOCK)  ON B.INV_ID=T1.INV_ID     
 JOIN SKU S1 (NOLOCK) ON S1.PRODUCT_CODE=T1.PRODUCT_CODE       
 JOIN ARTICLE B1 (NOLOCK) ON B1.ARTICLE_CODE = S1.ARTICLE_CODE      
 JOIN SECTIOND C1 (NOLOCK) ON C1.SUB_SECTION_CODE = B1.SUB_SECTION_CODE      
 JOIN SECTIONM D (NOLOCK) ON D.SECTION_CODE = C1.SECTION_CODE      
 LEFT OUTER JOIN ARTICLE_FIX_ATTR ATTR  (NOLOCK) ON B1.ARTICLE_CODE = ATTR.ARTICLE_CODE 
LEFT OUTER JOIN ATTR1_MST AT1 (NOLOCK) ON AT1.ATTR1_KEY_CODE=ATTR.ATTR1_KEY_CODE
LEFT OUTER JOIN ATTR2_MST AT2 (NOLOCK) ON AT2.ATTR2_KEY_CODE=ATTR.ATTR2_KEY_CODE
LEFT OUTER JOIN ATTR3_MST AT3 (NOLOCK) ON AT3.ATTR3_KEY_CODE=ATTR.ATTR3_KEY_CODE
LEFT OUTER JOIN ATTR4_MST AT4 (NOLOCK) ON AT4.ATTR4_KEY_CODE=ATTR.ATTR4_KEY_CODE
LEFT OUTER JOIN ATTR5_MST AT5 (NOLOCK) ON AT5.ATTR5_KEY_CODE=ATTR.ATTR5_KEY_CODE
LEFT OUTER JOIN ATTR6_MST AT6 (NOLOCK) ON AT6.ATTR6_KEY_CODE=ATTR.ATTR6_KEY_CODE
LEFT OUTER JOIN ATTR7_MST AT7 (NOLOCK) ON AT7.ATTR7_KEY_CODE=ATTR.ATTR7_KEY_CODE
LEFT OUTER JOIN ATTR8_MST AT8 (NOLOCK) ON AT8.ATTR8_KEY_CODE=ATTR.ATTR8_KEY_CODE
LEFT OUTER JOIN ATTR9_MST AT9 (NOLOCK) ON AT9.ATTR9_KEY_CODE=ATTR.ATTR9_KEY_CODE
LEFT OUTER JOIN ATTR10_MST AT10 (NOLOCK) ON AT10.ATTR10_KEY_CODE=ATTR.ATTR10_KEY_CODE
LEFT OUTER JOIN ATTR11_MST AT11 (NOLOCK) ON AT11.ATTR11_KEY_CODE=ATTR.ATTR11_KEY_CODE
LEFT OUTER JOIN ATTR12_MST AT12 (NOLOCK) ON AT12.ATTR12_KEY_CODE=ATTR.ATTR12_KEY_CODE
LEFT OUTER JOIN ATTR13_MST AT13 (NOLOCK) ON AT13.ATTR13_KEY_CODE=ATTR.ATTR13_KEY_CODE
LEFT OUTER JOIN ATTR14_MST AT14 (NOLOCK) ON AT14.ATTR14_KEY_CODE=ATTR.ATTR14_KEY_CODE
LEFT OUTER JOIN ATTR15_MST AT15 (NOLOCK) ON AT15.ATTR15_KEY_CODE=ATTR.ATTR15_KEY_CODE
LEFT OUTER JOIN ATTR16_MST AT16 (NOLOCK) ON AT16.ATTR16_KEY_CODE=ATTR.ATTR16_KEY_CODE
LEFT OUTER JOIN ATTR17_MST AT17 (NOLOCK) ON AT17.ATTR17_KEY_CODE=ATTR.ATTR17_KEY_CODE
LEFT OUTER JOIN ATTR18_MST AT18 (NOLOCK) ON AT18.ATTR18_KEY_CODE=ATTR.ATTR18_KEY_CODE
LEFT OUTER JOIN ATTR19_MST AT19 (NOLOCK) ON AT19.ATTR19_KEY_CODE=ATTR.ATTR19_KEY_CODE
LEFT OUTER JOIN ATTR20_MST AT20 (NOLOCK) ON AT20.ATTR20_KEY_CODE=ATTR.ATTR20_KEY_CODE
LEFT OUTER JOIN ATTR21_MST AT21 (NOLOCK) ON AT21.ATTR21_KEY_CODE=ATTR.ATTR21_KEY_CODE
LEFT OUTER JOIN ATTR22_MST AT22 (NOLOCK) ON AT22.ATTR22_KEY_CODE=ATTR.ATTR22_KEY_CODE
LEFT OUTER JOIN ATTR23_MST AT23 (NOLOCK) ON AT23.ATTR23_KEY_CODE=ATTR.ATTR23_KEY_CODE
LEFT OUTER JOIN ATTR24_MST AT24 (NOLOCK) ON AT24.ATTR24_KEY_CODE=ATTR.ATTR24_KEY_CODE
LEFT OUTER JOIN ATTR25_MST AT25(NOLOCK) ON AT25.ATTR25_KEY_CODE=ATTR.ATTR25_KEY_CODE     
 JOIN PARA1 E (NOLOCK) ON E.PARA1_CODE = S1.PARA1_CODE      
 JOIN PARA2 F (NOLOCK) ON F.PARA2_CODE = S1.PARA2_CODE      
 JOIN PARA3 G (NOLOCK) ON G.PARA3_CODE = S1.PARA3_CODE      
 JOIN PARA4 H (NOLOCK) ON H.PARA4_CODE = S1.PARA4_CODE      
 JOIN PARA5 I (NOLOCK) ON I.PARA5_CODE = S1.PARA5_CODE      
 JOIN PARA6 J (NOLOCK) ON J.PARA6_CODE = S1.PARA6_CODE      
 JOIN LM01106 K (NOLOCK) ON K.AC_CODE=S1.AC_CODE       
 JOIN UOM (NOLOCK) ON UOM.UOM_CODE=B1.UOM_CODE    
 JOIN FORM FR (NOLOCK)ON T1.ITEM_FORM_ID= FR.FORM_ID     
 JOIN LM01106 L (NOLOCK) ON L.AC_CODE = S1.AC_CODE     
 WHERE 1=2    
       
       
 SET @CQUERY = N'INSERT INTO #TMPMASTERSENC(PRODUCT_CODE,PURCHASE_PRICE,ARTICLE_NO,CODING_SCHEME,SECTION_NAME    
    ,SUB_SECTION_NAME,PARA1_NAME,PARA2_NAME,PARA3_NAME,FORM_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME    
    ,ARTICLE_DESC,INV_NO,INV_DT,UOM_NAME,QUANTITY,MRP,WS_PRICE,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT    
    ,ARTICLE_ALIAS,ARTICLE_NAME,ONLINE_PRODUCT_CODE,VENDOR_EAN_NO,FIN_YEAR,ROW_ID,STOCK_NA,FIX_MRP    
    ,PRODUCT_NAME,BIN_ID,AC_NAME,SECTION_ALIAS,SUB_SECTION_ALIAS)    
     SELECT PRODUCT_CODE,PURCHASE_PRICE,ARTICLE_NO,CODING_SCHEME,SECTION_NAME,SUB_SECTION_NAME,PARA1_NAME    
    ,PARA2_NAME,PARA3_NAME,FORM_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,ARTICLE_DESC,INV_NO,INV_DT    
    ,UOM_NAME,QUANTITY,MRP,WS_PRICE,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,ARTICLE_ALIAS,ARTICLE_NAME    
    ,ONLINE_PRODUCT_CODE,VENDOR_EAN_NO,FIN_YEAR,ROW_ID,STOCK_NA,FIX_MRP,'''',''000'','''+@AC_NAME+''','''' AS SECTION_ALIAS,'''' AS SUB_SECTION_ALIAS    
    FROM ['+@TABLE_NAME+']    
    '    
 PRINT @CQUERY     
 EXEC SP_EXECUTESQL @CQUERY    
       
   SET @CSTEP='80'    
        
  -- SELECT @CLOCATIONID,@CFINYEAR,@NSPID    
   --CALL SAVETRAN_PUR PROCEDURE    
   
        
   ---BELOW TABLE USED INTO SAVETRAN_PUR PROCEDURE    
       
     
   EXEC SAVETRAN_PUR @NUPDATEMODE=1,@NSPID=@NSPID,@CMEMONOPREFIX=@CLOCATIONID,@BTHROUGHIMPORT=1,@CFINYEAR=@CFINYEAR    
        ,@SP3S_UPDATE_SAPINVOICE = 1    
     
   SELECT TOP 1 @ERRMSG=ERRMSG FROM #RESULT_OUTPUT  WHERE ISNULL(ERRMSG,'')<>''    
   IF ISNULL(@ERRMSG,'')<>''  
  GOTO PROC_END  
       
       
   SET @CSTEP='90'    
   
   
       
   ----DROP TMP_WSLEXPORT TABLE    
   --SET @CQUERY=N'IF OBJECT_ID('''+@TEMPDB+''+@TABLE_NAME+''') IS NOT NULL     
   --              DROP TABLE '+@TEMPDB+''+@TABLE_NAME+''    
   --PRINT @CQUERY    
   --EXEC SP_EXECUTESQL @CQUERY    
   ----SELECT ISNULL(ERRMSG,'') AS [ERRMSG],ISNULL(MEMO_ID,'') AS [MEMO_ID],@XN_ID AS INV_ID  FROM #RESULT_OUTPUT    
      
END TRY    
    
BEGIN CATCH    
   PRINT 'ENTER CATCH OF SP3S_UPDATE_SAPINVOICE'  
   SELECT @ERRMSG='ERROR MESSAGE IN PROCEDURE SP3S_UPDATE_SAPINVOICE STEP#'+@CSTEP+' '+ERROR_MESSAGE()   
END CATCH    
    
PROC_END:    
           
  IF @@TRANCOUNT > 0    
  BEGIN    
  IF ISNULL(@ERRMSG,'') <> ''    
 ROLLBACK;    
  ELSE     
 COMMIT     
  END     
      
    --SELECT 'LAST STEP#'+@CSTEP  
        
  SELECT ISNULL(@ERRMSG,'') AS ERRMSG,@XN_ID AS [MEMO_ID]    
       
      
END
