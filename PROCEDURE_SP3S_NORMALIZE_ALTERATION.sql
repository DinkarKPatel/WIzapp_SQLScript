CREATE PROCEDURE SP3S_NORMALIZE_ALTERATION(@CMID VARCHAR(50))
AS 
BEGIN
SET NOCOUNT ON
--ALTERATIONSETUP_IMPORT_UPLOAD


SELECT A.CM_ID,A.PRODUCT_CODE,A.JOB_CODE,A.SYS_RATE,A.RATE,A.REMARKS,A.LAST_UPDATE,A.ROW_ID
		,D.SECTION_CODE,D.SUB_SECTION_NAME,E.JOB_NAME
		FROM CMM_ALTERATION A (NOLOCK)
		JOIN SKU B (NOLOCK) ON B.product_code=A.Product_code
		JOIN ARTICLE C (NOLOCK) ON C.article_code=B.article_code
		JOIN SECTIOND D (NOLOCK) ON C.SUB_SECTION_CODE=D.SUB_SECTION_CODE
		JOIN JOBS E (NOLOCK) ON E.JOB_CODE=A.JOB_CODE


DECLARE @LOC VARCHAR(10),@QTY FLOAT,@PROD VARCHAR(500),@SS VARCHAR(500),@Q FLOAT
IF OBJECT_ID('tempdb..#TEMP') IS NOT NULL DROP TABLE #TEMP

SELECT TOP 0 M.location_code DEPT_ID,D.QUANTITY,D.PRODUCT_CODE,SD.sub_section_NAME,A.JOB_CODE 
INTO #TEMP
FROM CMM01106 M (NOLOCK) JOIN CMD01106 D (NOLOCK) ON M.cm_id=D.cm_id
JOIN SKU S ON S.PRODUCT_CODE=D.PRODUCT_CODE
JOIN ARTICLE (NOLOCK) ON ARTICLE.article_code=S.article_code
JOIN SECTIOND SD(NOLOCK) ON SD.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN ALTERATIONSETUP A ON 1=1
WHERE M.CANCELLED=0 AND M.cm_id=@CMID

DELETE #TEMP
DECLARE NMLZ CURSOR FOR
SELECT M.location_code,D.QUANTITY,D.PRODUCT_CODE,SD.sub_section_NAME
FROM CMM01106 M (NOLOCK) 
JOIN CMD01106 D (NOLOCK) ON M.cm_id=D.cm_id
JOIN SKU S ON S.PRODUCT_CODE=D.PRODUCT_CODE
JOIN ARTICLE (NOLOCK) ON ARTICLE.article_code=S.article_code
JOIN SECTIOND SD(NOLOCK) ON SD.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN ALTERATIONSETUP A ON A.sub_section_code=SD.SUB_SECTION_CODE and a.dept_id=M.location_Code 
WHERE M.CANCELLED=0 AND M.cm_id=@CMID
OPEN NMLZ
FETCH NEXT FROM NMLZ INTO @LOC,@QTY,@PROD,@SS
WHILE @@FETCH_STATUS=0
  BEGIN
     SET @Q=@QTY
     WHILE @Q>0
       BEGIN
          INSERT #TEMP SELECT @LOC,1,@PROD,@SS
          SET @Q-=1
       END
     FETCH NEXT FROM NMLZ INTO @LOC,@QTY,@PROD,@SS
  END
CLOSE NMLZ
DEALLOCATE NMLZ
	SELECT T.*,S.JOB_CODE
	FROM #TEMP T 
	LEFT JOIN ALTERATIONSETUP S (NOLOCK) 
	JOIN Sectiond SD (NOLOCK) ON SD.sub_section_code=S.SUB_SECTION_CODE
	ON T.DEPT_ID=S.DEPT_ID AND T.SUB_SECTION_NAME=SD.SUB_SECTION_NAME
SET NOCOUNT OFF
END
