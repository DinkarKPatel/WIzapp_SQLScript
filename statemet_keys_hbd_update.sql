

IF OBJECT_ID ('TEMPDB..#TMPKYYS_hbd','U') IS NOT NULL
   DROP TABLE #TMPKYYS_hbd

SELECT 'KEYS_HBD_'+CAST(LEFT(LASTKEYVAL,2) AS VARCHAR(2)) AS KEYSTABLENAME INTO #TMPKYYS_hbd FROM KEYS WHERE TABLENAME ='HOLD_BACK_DELIVER_MST'
GROUP BY CAST(LEFT(LASTKEYVAL,2) AS VARCHAR(2))


DECLARE  @CKEYSTABLE VARCHAR(100),@CCMD NVARCHAR(MAX),@CCONSTNAME VARCHAR(100)

WHILE EXISTS (SELECT TOP 1 'U' FROM #TMPKYYS_hbd)
BEGIN
     
	 SELECT TOP 1  @CKEYSTABLE=KEYSTABLENAME FROM #TMPKYYS_hbd

	IF OBJECT_ID(@CKEYSTABLE,'U') IS  NULL
	BEGIN
		PRINT 'CREATE NEW KEYS TABLE FOR hbd'
		SET @CCMD=N'SELECT * INTO ['+@CKEYSTABLE+'] FROM keys WHERE 1=2'
		EXEC SP_EXECUTESQL @CCMD	

		SET @CCONSTNAME='PK_'+@CKEYSTABLE

		SET @CCMD=N' ALTER TABLE ['+@CKEYSTABLE+'] ADD CONSTRAINT ['+@CCONSTNAME+'] PRIMARY KEY (prefix,FinYear) '
		EXEC SP_EXECUTESQL @CCMD	

		SET @CCMD=N' INSERT INTO  ['+@CKEYSTABLE+'](ColumnName,prefix,FinYear,TableName,LastKeyVal) 
		SELECT ColumnName,prefix,FinYear,TableName,LastKeyVal 
		FROM keys WHERE ''KEYS_HBD_''+CAST(LEFT(LASTKEYVAL,2) AS VARCHAR(2))='''+@CKEYSTABLE+'''
		and TABLENAME =''HOLD_BACK_DELIVER_MST''
		'
		EXEC SP_EXECUTESQL @CCMD
	END

	 DELETE FROM #TMPKYYS_hbd WHERE KEYSTABLENAME=@CKEYSTABLE
END
