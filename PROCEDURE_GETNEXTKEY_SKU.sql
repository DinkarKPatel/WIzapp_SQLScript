CREATE PROCEDURE GETNEXTKEY_SKU  
	-- THESE ARE THE INPUT PARAMETERS   
	@NWIDTH		INTEGER,  
	@CPREFIX	VARCHAR(200) = '',   
	@NLZEROS	BIT = 1,  
	@CFINYEAR	VARCHAR(40) = '',
	@NROWCOUNT	INTEGER = 0 ,	  
	@CNEWKEYVAL VARCHAR(200) OUTPUT  
--	WITH ENCRYPTION
AS  
BEGIN  
	DECLARE @NLASTKEYVAL	BIGINT,
			@NTEMPLASTKEYVAL BIGINT,
			@NVALLEN		INTEGER,
			@NTEMPWIDTH		INTEGER,
			@CZEROS			VARCHAR(40),
			@CCMD			NVARCHAR(MAX),
			@CKEYSTABLE		VARCHAR(20),
			@CLASTKEYVAL	VARCHAR(200),
			@NBOOL			BIT ,
			@CCHKNEWKEYVAL	VARCHAR(200),
			@NCOUNT			INTEGER,
			@NTMPROWCOUNT	INTEGER,
			@CMANUALPREFIX  VARCHAR(10),
			@cTableName varchar(50),@CCOLNAME VARCHAR(50)
	
	seLECT @cTableName='SKu',@CCOLNAME='PRODUCT_CODE'
	SET @CKEYSTABLE =		 'KEYS_PMT' 

    --PRINT REPLICATE('*',10)+CHAR(13)+@CKEYSTABLE+CHAR(13)+REPLICATE('*',10)
	
	SELECT TOP 1 @CMANUALPREFIX=VALUE FROM CONFIG WHERE CONFIG_OPTION='MANUAL_MST_PREFIX'+@CTABLENAME
	
	IF ISNULL(@CMANUALPREFIX,'')<>''
		SET @CPREFIX=LTRIM(RTRIM(@CMANUALPREFIX))			 
	
	SET @CCMD = N'IF NOT EXISTS (   SELECT LASTKEYVAL FROM ' + @CKEYSTABLE + 
								 '  WHERE TABLENAME	= ''' + @CTABLENAME + ''' 
								    AND COLUMNNAME	= ''' + @CCOLNAME + '''  
 									AND PREFIX		= ''' + @CPREFIX + ''' 
 									AND FINYEAR		= ''' + @CFINYEAR + ''' )
				  INSERT ' + @CKEYSTABLE + ' ( TABLENAME, COLUMNNAME, PREFIX, FINYEAR, LASTKEYVAL )   
 									  VALUES ( ''' + @CTABLENAME + ''', ''' + @CCOLNAME + ''', ''' + @CPREFIX + ''',
											   ''' + @CFINYEAR + ''', '''') '
	
	EXEC SP_EXECUTESQL @CCMD

	
	IF @NLZEROS = 0  -- ZERO SUFFING IS NOT ENABLED  
	BEGIN   
		SET @CCMD = N'SELECT TOP 1 @NTEMPWIDTH = LEN( LASTKEYVAL )  
					  FROM ' + @CKEYSTABLE + ' 
					  WHERE TABLENAME = ''' + @CTABLENAME + '''  
					  AND COLUMNNAME  = ''' + @CCOLNAME + '''  
					  AND PREFIX	  = ''' + @CPREFIX + '''  
					  AND FINYEAR	  = ''' + @CFINYEAR + ''''
		
		EXEC SP_EXECUTESQL @CCMD, N'@NTEMPWIDTH INTEGER OUTPUT', @NTEMPWIDTH OUTPUT
		
		IF ISNULL(@NTEMPWIDTH,0)=0
			SET @NTEMPWIDTH = @NWIDTH
	END   
	ELSE
		SET @NTEMPWIDTH = @NWIDTH

	SELECT @NVALLEN = @NTEMPWIDTH - LEN(REPLACE(@CPREFIX,' ','0'))  
	
	--if @@spid=201 and @NLZEROS=1
	--	select 	@NTEMPWIDTH as NTEMPWIDTH,@NVALLEN as NVallen

	IF @NVALLEN < 0  
		SELECT  @NVALLEN = 0  


	SET @CCMD = N' SELECT TOP 1 @NTEMPLASTKEYVAL = CAST( RIGHT( LASTKEYVAL, '+STR(@NVALLEN)+' ) AS BIGINT )   
				   FROM ' + @CKEYSTABLE + '  
				   WHERE TABLENAME = ''' + @CTABLENAME + '''  
				   AND COLUMNNAME  = ''' + @CCOLNAME + '''  
				   AND PREFIX	   = ''' + @CPREFIX + '''  
				   AND FINYEAR     = ''' + @CFINYEAR + ''''
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD, N'@NTEMPLASTKEYVAL BIGINT OUTPUT', @NTEMPLASTKEYVAL OUTPUT

	SET @NLASTKEYVAL = (@NTEMPLASTKEYVAL + 1)

	IF @NLZEROS = 1  
		SELECT @CZEROS = REPLICATE('0', @NVALLEN - LEN(@NLASTKEYVAL))  
	ELSE  
		SELECT @CZEROS = ''  
   
	SET @CZEROS=ISNULL(@CZEROS,'')
   
	SELECT  @CNEWKEYVAL = @CPREFIX + @CZEROS + LTRIM(RTRIM(CAST(@NLASTKEYVAL AS VARCHAR(200))))

	IF @CNEWKEYVAL IS NOT NULL 
	BEGIN
		 SET @CCMD = N' UPDATE ' + @CKEYSTABLE + '
						SET LASTKEYVAL  = ''' + @CNEWKEYVAL + '''  
						WHERE TABLENAME = ''' + @CTABLENAME + '''  
						AND COLUMNNAME	= ''' + @CCOLNAME + '''  
						AND PREFIX		= ''' + @CPREFIX + '''  
						AND FINYEAR		= ''' + @CFINYEAR + ''''  
		  PRINT @CCMD	
		  EXEC SP_EXECUTESQL @CCMD     
	END

	SELECT @CNEWKEYVAL = (CASE WHEN @CNEWKEYVAL IS NULL THEN 'NULL' ELSE @CNEWKEYVAL END )

	--if @@spid=201 and @NLZEROS=1
	--	SELECT @CNEWKEYVAL as new_ean
END