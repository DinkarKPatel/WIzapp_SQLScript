CREATE PROCEDURE SP3S_RACK_SETUP
AS 
BEGIN
SET NOCOUNT ON
IF NOT EXISTS(SELECT TOP 1  * FROM loc_delivery_racks A (NOLOCK))
	WITH ALLDATA
	AS
	(
		SELECT L.DEPT_ID
		,L.DEPT_NAME,L.dept_alias,L.area_code
		,SD.rack_no
		FROM LOCATION L (NOLOCK),loc_delivery_racks SD(NOLOCK)
		WHERE L.INACTIVE=0 
	)
	SELECT A.*, A1.area_name AS DEPT_AREA,C1.CITY AS DEPT_CITY,S1.state AS DEPT_STATE
	FROM ALLDATA A
	LEFT OUTER JOIN AREA A1(NOLOCK) ON A1.area_code=A.area_code
	LEFT OUTER JOIN CITY C1(NOLOCK) ON C1.CITY_CODE=A1.city_code
	LEFT OUTER JOIN STATE S1(NOLOCK) ON C1.state_code=S1.state_code
	ORDER BY DEPT_ID,rack_no
	
ELSE
	SELECT A.*,L.DEPT_NAME,A1.area_name AS DEPT_AREA,C1.CITY AS DEPT_CITY,S1.state AS DEPT_STATE,L.dept_alias
	FROM loc_delivery_racks A (NOLOCK)
	JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=A.DEPT_ID
	LEFT OUTER JOIN AREA A1(NOLOCK) ON A1.area_code=L.area_code
	LEFT OUTER JOIN CITY C1(NOLOCK) ON C1.CITY_CODE=A1.city_code
	LEFT OUTER JOIN STATE S1(NOLOCK) ON C1.state_code=S1.state_code
	ORDER BY DEPT_ID,rack_no
SET NOCOUNT OFF
END