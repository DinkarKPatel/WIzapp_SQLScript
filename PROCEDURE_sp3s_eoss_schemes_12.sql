CREATE PROCEDURE SP3S_EOSS_SCHEMES_12
(
	@CSCHEMEDETROWID VARCHAR(50),
	@CSLSTITLE VARCHAR(1000),
	@CROUNDITEMLEVEL VARCHAR(5),
	@CJOINSTRBUY VARCHAR(MAX),
	@CJOINSTRGET VARCHAR(MAX),
	@CPICKSLRDISCMODE VARCHAR(5),
	@CERRMSG	VARCHAR(MAX) OUTPUT
)
AS 
BEGIN

	DECLARE @NBUYQTY NUMERIC(5,0),@NBUYQTY1 NUMERIC(5,0),@NBUYQTY2 NUMERIC(5,0),@CPRODUCTCODE VARCHAR(50),@NMRP NUMERIC(10,2),@NQTY NUMERIC(10,2),
			@BMAXQTYSET BIT,@NREQBUYQTY NUMERIC(5,0),@CCMDROWID VARCHAR(50),@NLOOPCNT INT,@NMODE INT,
			@BQUALIFIED BIT,@CROWID VARCHAR(100),@NSTEP INT,@NAMT NUMERIC(10,2),
			@CMRPORDER VARCHAR(10),@NREQBUYAMT NUMERIC(10,2),@BRETRY2NDCASE BIT,
			@CCMD NVARCHAR(MAX),@NDISCMODE INT,@NDISCFIGURE NUMERIC(7,3),
			@NAPPLIEDQTY NUMERIC(5,0),@BSCHEMEFOUND BIT,@CBUYFILTER VARCHAR(MAX),
			@CADDFILTER VARCHAR(MAX),@NFILTERMODE INT,
			@BPROCESSSLRENTRY BIT,@NDISCAMTAPPLYMODE INT,@NTOTALMRPVAL NUMERIC(10,2),@NDISCAPPLIED NUMERIC(10,2),
			@BDONOTAPPLYSCHEMEONDISCITEMS BIT,@NMAXQTY INT,@NTOTAPPLIEDQTY NUMERIC(3,0),
			@NCURPENDINGCNT NUMERIC(3,0),@NPREVPENDINGCNT NUMERIC(3,0)
	
	SELECT @BPROCESSSLRENTRY=0,@NCURPENDINGCNT=0,@NPREVPENDINGCNT=0	

	DECLARE @CENABLEOPTIMIZEDSCHEMES VARCHAR(2)
	SELECT TOP 1 @CENABLEOPTIMIZEDSCHEMES=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_OPTIMIZED_EOSS_SCHEMES'		
	
	set @CENABLEOPTIMIZEDSCHEMES=isnull(@CENABLEOPTIMIZEDSCHEMES,'')
	
START_PROC:
	SELECT @NBUYQTY=0,@CPRODUCTCODE='',@NMRP=0,@NQTY=0,@BMAXQTYSET=0,@NREQBUYQTY=0,
		   @CCMDROWID='',@NLOOPCNT=0,@NMODE=0,@BQUALIFIED=0,@CROWID='',@NSTEP=0,@NAMT=0,
		   @CMRPORDER='',@NREQBUYAMT=0,@BRETRY2NDCASE=0,@CCMD='',@NDISCMODE=0,
		   @NDISCFIGURE=0,@NAPPLIEDQTY=0,@BSCHEMEFOUND=0,@CBUYFILTER='',
		   @CADDFILTER='',@NFILTERMODE=0
			
	
	print 'enter power pricing (inc)-1'
	SELECT @BDONOTAPPLYSCHEMEONDISCITEMS=ISNULL(DONOT_APPLY_SCHEME_ON_DISCOUNTED_ITEMS,0) FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
	
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMD A WHERE ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 AND SCHEME_SETUP_DET_ROW_ID='')
		GOTO END_PROC
	
	print 'enter power pricing (inc)-2'
	IF @BPROCESSSLRENTRY=1
		SET @CADDFILTER='A.QUANTITY<0'
	ELSE
		SET @CADDFILTER='A.QUANTITY>0'	
		
		


BEGIN TRY        
	
	PRINT 'CHECK SCHEME SP3S_EOSS_SCHEMES_12'	
	SET @NSTEP=10
		
	SELECT @CMRPORDER='',@BQUALIFIED=0,@BRETRY2NDCASE=0
		
	IF OBJECT_ID('TEMPDB..#TMPCMDPPDISC','U') IS NOT NULL
		DROP TABLE #TMPCMDPPDISC

	IF OBJECT_ID('TEMPDB..#TMPCMDSCHEMES','U') IS NOT NULL
		DROP TABLE #TMPCMDSCHEMES
			
	SET @NSTEP=15
	SELECT CMD_ROW_ID AS ROW_ID,CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT
	INTO #TMPCMDPPDISC FROM #TMPCMD WHERE 1=2 

	SELECT PRODUCT_CODE,MRP,QUANTITY,CMD_ROW_ID AS ROW_ID,CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT,
	QUANTITY AS SCHEME_APPLIED_QTY,CONVERT(INT,0) AS MODE
	INTO #TMPCMDSCHEMES FROM #TMPCMD WHERE 1=2
	
	SELECT @CBUYFILTER=(CASE WHEN FILTER_MODE IN (0,1) AND @CENABLEOPTIMIZEDSCHEMES<>'1' THEN  BUY_FILTER_CRITERIA ELSE '' END),
		   @NFILTERMODE=FILTER_MODE,@NDISCMODE=DISC_METHOD,@NDISCAMTAPPLYMODE=ISNULL(DISCOUNT_AMOUNT_APPLICABLE_MODE,0)
		   FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
		   	
	IF @NFILTERMODE NOT IN (0,1)
		SELECT @CADDFILTER=@CADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''''
	ELSE
		SELECT @CADDFILTER=@CADDFILTER+' AND 1=1'
	
	SELECT @CADDFILTER=@CADDFILTER+' AND A.SCHEME_SETUP_DET_ROW_ID='''''
				   		
	SELECT @CBUYFILTER=(CASE WHEN  ISNULL(@CBUYFILTER,'')='' THEN '1=1' ELSE @CBUYFILTER END)
	
	SET @CCMD=N' SELECT A.PRODUCT_CODE,A.NET,(ABS(A.QUANTITY))*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END),
				 A.CMD_ROW_ID AS ROW_ID,0 AS DISCOUNT_AMOUNT,
				 0 AS SCHEME_APPLIED_QTY,1 AS MODE	
				 FROM #TMPCMD A
				 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTRBUY+'
				 WHERE '+@CBUYFILTER+'  AND A.DISCOUNT_PERCENTAGE=0 AND '+@CADDFILTER
	PRINT @CCMD
					 
	INSERT #TMPCMDSCHEMES
	EXEC SP_EXECUTESQL @CCMD
	
	
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMDSCHEMES)
	BEGIN
		IF @BPROCESSSLRENTRY=0 AND @CPICKSLRDISCMODE<>'3'
		BEGIN
			SET @BPROCESSSLRENTRY=1
			GOTO START_PROC
		END	
		ELSE
			GOTO END_PROC
	END	
	
	
	SELECT @NBUYQTY=SUM(QUANTITY) FROM #TMPCMDSCHEMES
	
	SELECT @NMAXQTY=MAX(TO_QTY) FROM SCHEME_SETUP_SCH0012 WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID
	
	SET @NSTEP=20
		
	SELECT @BQUALIFIED=0,@BSCHEMEFOUND=0,@NDISCFIGURE=0
	
	--SELECT @NBUYQTY,* FROM #TMPCMDSCHEMES		
	
	
	if exists (SELECT TOP 1 DISCOUNT_FIGURE FROM SCHEME_SETUP_SCH0012
			   WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID AND TO_QTY<=@NBUYQTY)
		SELECT TOP 1 @NDISCFIGURE=DISCOUNT_FIGURE FROM SCHEME_SETUP_SCH0012
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID AND TO_QTY<=@NBUYQTY
	else
		SELECT TOP 1 @NDISCFIGURE=DISCOUNT_FIGURE FROM SCHEME_SETUP_SCH0012
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID AND from_QTY>=@NBUYQTY
		order by from_qty

	IF ISNULL(@NDISCFIGURE,0)<>0
		SELECT @BSCHEMEFOUND=1

	
	--SELECT @BSCHEMEFOUND AS BSCHEMEFOUND
	
	IF @BSCHEMEFOUND=0
		GOTO EXIT_PROC
	
	SET @NSTEP=40	
	
	PRINT 'MAGIC SCHEME-2'
	
	SET @NTOTAPPLIEDQTY=0
LBLLOOP:

	SET @NAPPLIEDQTY=0

	IF CURSOR_STATUS('GLOBAL','SCHEMECUR') IN (0,1)
	BEGIN
		CLOSE SCHEMECUR
		DEALLOCATE SCHEMECUR
	END
	
	DECLARE SCHEMECUR CURSOR FOR SELECT PRODUCT_CODE,MRP,QUANTITY,ROW_ID FROM #TMPCMDSCHEMES 
		
	WHERE (QUANTITY-SCHEME_APPLIED_QTY)>0
	ORDER BY MRP DESC 
	
	OPEN SCHEMECUR
	FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID
	
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @NSTEP=80
		SET @NLOOPCNT=1
		WHILE @NLOOPCNT<=ABS(@NQTY)
		BEGIN
			SET @NAPPLIEDQTY=@NAPPLIEDQTY+1
			
			SELECT TOP 1 @NDISCFIGURE=DISCOUNT_FIGURE FROM SCHEME_SETUP_SCH0012
			WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID AND @NAPPLIEDQTY BETWEEN FROM_QTY AND TO_QTY
			
			IF @NDISCMODE=1
			BEGIN
				UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=(CASE WHEN @CROUNDITEMLEVEL='1' THEN
				ROUND(@NMRP*@NDISCFIGURE/100,0) ELSE @NMRP*@NDISCFIGURE/100 END),
				SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+1
				WHERE ROW_ID=@CCMDROWID
 			END	
			ELSE
			IF @NDISCMODE=3
			BEGIN
				IF @NDISCAMTAPPLYMODE<>2
					UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=(CASE WHEN @NMRP-@NDISCFIGURE>=0 THEN @NDISCFIGURE ELSE @NMRP END),
					SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+1
					WHERE ROW_ID=@CCMDROWID
				ELSE
				BEGIN
					UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=@NMRP,
					SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+1
					WHERE ROW_ID=@CCMDROWID
				END	
			END				 			
			ELSE
			BEGIN
				UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=(CASE WHEN @NMRP-@NDISCFIGURE>=0 THEN @NMRP-@NDISCFIGURE ELSE @NMRP END),
				SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+1
				WHERE ROW_ID=@CCMDROWID				
			END				
					    
			SET @BQUALIFIED=1
		  
		    SET @NLOOPCNT=@NLOOPCNT+1
		END										

		IF @NAPPLIEDQTY=@NMAXQTY OR @NAPPLIEDQTY>=@NBUYQTY
			BREAK
		
		FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID
	END
	
	SET @NTOTAPPLIEDQTY=@NTOTAPPLIEDQTY+@NAPPLIEDQTY
	
	--SELECT @NAPPLIEDQTY AS NAPPLIEDQTY,@NBUYQTY AS NBUYQTY
	IF @NTOTAPPLIEDQTY<@NBUYQTY
		GOTO LBLLOOP
	
	SET @NSTEP=110
	
	CLOSE SCHEMECUR
	DEALLOCATE SCHEMECUR
	
	PRINT 'MAGIC SCHEME-3'
	
	
	GOTO EXIT_PROC
END TRY

BEGIN CATCH
	     
	  SET @CERRMSG='P:SP3S_EOSS_SCHEMES_12, TITLE : '+@CSLSTITLE+' STEP:'+LTRIM(RTRIM(STR(@NSTEP)))+', MESSAGE:'+ERROR_MESSAGE()        
	  PRINT 'CATCH START IN SCH0012'+ @CERRMSG
	     
	  GOTO END_PROC
END CATCH

EXIT_PROC:
		
	--SELECT ISNULL(@CERRMSG,'') AS ERRMSG
	
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
		IF @BQUALIFIED=0
		BEGIN
			--SELECT 'MAGIC SCHEME NOT QUALIFIED'
			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=0
			IF @BPROCESSSLRENTRY=0
			BEGIN
				SET @BPROCESSSLRENTRY=1
				GOTO START_PROC
			END	
			ELSE
				GOTO END_PROC
		END	
		ELSE
		BEGIN
			--SELECT 'MAGIC SCHEME QUALIFIED'
			
			UPDATE #TMPCMD SET DISCOUNT_AMOUNT=#TMPCMD.DISCOUNT_AMOUNT+B.DISCOUNT_AMOUNT,
			SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSLSTITLE,
			SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
			SCHEME_APPLIED_QTY=#TMPCMD.SCHEME_APPLIED_QTY+B.SCHEME_APPLIED_QTY 
			FROM #TMPCMDSCHEMES B WHERE B.ROW_ID=#TMPCMD.CMD_ROW_ID 
			AND B.SCHEME_APPLIED_QTY<>0
			
			UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ABS(ROUND((DISCOUNT_AMOUNT/(MRP*QUANTITY))*100,2))
			WHERE (@NDISCMODE<>1 OR ISNULL(discount_percentage,0)=0)
			
			UPDATE #TMPCMD SET NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT
			
			--SELECT * FROM #TMPCMD
		END		
	END	
	ELSE
		GOTO END_PROC
		
	IF EXISTS (SELECT TOP 1 * FROM #TMPCMD WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0)
	BEGIN
		IF @NPREVPENDINGCNT<>0
		BEGIN
			SELECT @NCURPENDINGCNT=SUM(ABS(QUANTITY)-SCHEME_APPLIED_QTY) FROM #TMPCMD
			WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0
		END
		ELSE
			SELECT @NPREVPENDINGCNT=SUM(ABS(QUANTITY)-SCHEME_APPLIED_QTY) FROM #TMPCMD
			WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0
		
		IF @NPREVPENDINGCNT<>@NCURPENDINGCNT	
			GOTO START_PROC
	END
END_PROC:
	
	PRINT 'LAST STEP OF SCH0012:'+STR(@NSTEP)
END