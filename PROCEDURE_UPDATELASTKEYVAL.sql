CREATE PROCEDURE UPDATELASTKEYVAL
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @TABLENAME VARCHAR(100),@OBJECTID VARCHAR(100),@LENKEYS_CMM VARCHAR(50),@MAX_LENGTH VARCHAR(50),
			@CCMD NVARCHAR(MAX)
	SELECT TOP 1  @LENKEYS_CMM =MAX_LENGTH FROM SYS.COLUMNS WHERE OBJECT_ID=OBJECT_ID('KEYS_CMM','U') AND NAME ='LASTKEYVAL'

	IF ISNULL(@LENKEYS_CMM,0)=0
	SELECT 'INVALID LENGTH OF LASTKEYVAL OF KEYS_CMM' AS ERROR
	ELSE
	BEGIN
	DECLARE CUR_UPDATE_LASTKEYVAL_LEN CURSOR 
	FOR
	SELECT NAME,OBJECT_ID FROM SYS.TABLES WHERE NAME LIKE '%KEYS_CMM_%'
	OPEN CUR_UPDATE_LASTKEYVAL_LEN
	FETCH NEXT FROM CUR_UPDATE_LASTKEYVAL_LEN INTO @TABLENAME,@OBJECTID
	WHILE @@FETCH_STATUS=0
	BEGIN
	SELECT TOP 1 @MAX_LENGTH= MAX_LENGTH FROM SYS.COLUMNS WHERE OBJECT_ID=@OBJECTID AND NAME ='LASTKEYVAL'
	IF ISNULL(@MAX_LENGTH,'')<>ISNULL(@LENKEYS_CMM,'')
	BEGIN   
	   SET @CCMD=N'ALTER TABLE '+@TABLENAME+' ALTER COLUMN  LASTKEYVAL VARCHAR('+@LENKEYS_CMM+')'
	   PRINT @CCMD
	   EXEC SP_EXECUTESQL @CCMD
	END
	FETCH NEXT FROM CUR_UPDATE_LASTKEYVAL_LEN  INTO @TABLENAME,@OBJECTID
	END
	CLOSE CUR_UPDATE_LASTKEYVAL_LEN
	DEALLOCATE CUR_UPDATE_LASTKEYVAL_LEN
	END
END
