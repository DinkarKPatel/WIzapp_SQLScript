create PROC SAVETRAN_HSN
(
  @NSPID varchar(40),
  @EDIT_CLICKED bit=0,
  @CMACHINENAME		VARCHAR(100)='',
  @CWINDOWUSERNAME	VARCHAR(100)='',
  @CWIZAPPUSERCODE	VARCHAR(10)='0000000',
  @CHSN_CODE varchar(20)
)
--WITH ENCRYPTION
AS
BEGIN
   SET NOCOUNT ON
   DECLARE @CCMD NVARCHAR(MAX),@ON VARCHAR(1000),@COL VARCHAR(1000),@CMASTERTABLENAME VARCHAR(100),@CDETAILTABLENAME VARCHAR(100),
           @CTEMPMASTERTABLENAME VARCHAR(100),@CTEMPDETAILTABLENAME VARCHAR(100),@NSTEP INT=0,@CERRORMSG VARCHAR(MAX)='',@UPDATE VARCHAR(MAX)='',
		   @CKEYFIELD1	VARCHAR(50)
   
    BEGIN TRY
    BEGIN TRANSACTION

	
	SET @CMASTERTABLENAME	= 'HSN_MST'
	SET @CDETAILTABLENAME	= 'HSN_DET'

	SET @CTEMPMASTERTABLENAME	= 'HSN_HSN_MST_UPLOAD'
	SET @CTEMPDETAILTABLENAME	= 'HSN_HSN_DET_UPLOAD'
	

	IF @EDIT_CLICKED=1	
	 BEGIN
		
			SET @COL='IF OBJECT_ID(''tempdb..[##HSM_'+@NSPID+'_'+@CHSN_CODE+']'',''U'') IS NOT NULL'+CHAR(13)+' DROP TABLE [##HSM_'+@NSPID+'_'+@CHSN_CODE+'];'+CHAR(13)+'SELECT HSN_CODE OLD_HSN_CODE,HSN_CODE NEW_HSN_CODE,'
			SELECT @COL=COALESCE(@COL,'')+FIELD_NAME+' OLD_'+FIELD_NAME+','+FIELD_NAME+' NEW_'+FIELD_NAME+',' FROM XN_AUDIT_TRIAL_MST (NOLOCK) WHERE TABLE_NAME='HSN_MST' AND TRIG='UPDATE' ORDER BY ORDER_ID
			SET @COL=LEFT(@COL,LEN(@COL)-1)+CHAR(13)+'INTO [##HSM_'+@NSPID+'_'+@CHSN_CODE+']'+CHAR(13)+'FROM HSN_MST (NOLOCK) WHERE HSN_CODE='''+@CHSN_CODE+''';'
			PRINT @COL
			EXEC(@COL)
			SET @COL=''
			SET @COL='IF OBJECT_ID(''tempdb..[##HSN_'+@NSPID+'_'+@CHSN_CODE+']'',''U'') IS NOT NULL'+CHAR(13)+' DROP TABLE [##HSN_'+@NSPID+'_'+@CHSN_CODE+'];'+CHAR(13)+'SELECT HSN_CODE OLD_HSN_CODE,HSN_CODE NEW_HSN_CODE,ROW_ID AS ROW_ID ,'
			SELECT @COL=COALESCE(@COL,'')+FIELD_NAME+' OLD_'+FIELD_NAME+','+FIELD_NAME+' NEW_'+FIELD_NAME+',' FROM XN_AUDIT_TRIAL_MST (NOLOCK) WHERE TABLE_NAME='HSN_DET' AND TRIG='UPDATE' ORDER BY ORDER_ID
			SET @COL=LEFT(@COL,LEN(@COL)-1)+CHAR(13)+'INTO [##HSN_'+@NSPID+'_'+@CHSN_CODE+']'+CHAR(13)+'FROM HSN_DET (NOLOCK) WHERE HSN_CODE='''+@CHSN_CODE+''';'
			PRINT @COL
			EXEC(@COL)
		END


		DECLARE @CENABLE_MULTI_CURRENCY VARCHAR(10)
		SELECT  TOP 1 @CENABLE_MULTI_CURRENCY=VALUE  FROM config WHERE config_option ='ENABLE_MULTI_CURRENCY' 
		
		IF ISNULL(@CENABLE_MULTI_CURRENCY,'')<>'1'
        UPDATE A SET DEPT_ID ='' FROM  HSN_HSN_DET_UPLOAD A WHERE SP_ID=@NSPID

	


		DECLARE @CWHERECLAUSE VARCHAR(1000)
        SET @CWHERECLAUSE = ' SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''

		   SET @CKEYFIELD1='HSN_CODE'


			EXEC UPDATEMASTERXN_OPT---UPDATEMASTERXN 
				  @CSOURCEDB	= ''
				, @CSOURCETABLE = @CTEMPMASTERTABLENAME
				, @CDESTDB		= ''
				, @CDESTTABLE	= @CMASTERTABLENAME
				, @CKEYFIELD1	= @CKEYFIELD1
				, @BALWAYSUPDATE = 1
				, @CFILTERCONDITION=@CWHERECLAUSE--UPLOAD_TAB

		    
			DELETE FROM HSN_DET WHERE HSN_CODE =@CHSN_CODE

			SET @CCMD = N'UPDATE ' + @CTEMPDETAILTABLENAME + ' SET ROW_ID =  CONVERT(VARCHAR(40), NEWID())
							  WHERE LEFT(ROW_ID,5) = ''LATER'' AND SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
			EXEC SP_EXECUTESQL @CCMD


			--IF NOT  EXISTS (SELECT TOP 1'U' FROM HSN_HSN_DET_UPLOAD A WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID))))
			--BEGIN
			    
			--	set @CERRORMSG='hsn can not be saved without Details '
			--	goto END_PROC
			--END

			
			EXEC UPDATEMASTERXN_OPT---UPDATEMASTERXN 
				  @CSOURCEDB	= ''
				, @CSOURCETABLE = @CTEMPDETAILTABLENAME
				, @CDESTDB		= ''
				, @CDESTTABLE	= @CDETAILTABLENAME
				, @CKEYFIELD1	= 'row_id'
				, @BALWAYSUPDATE = 1
				, @CFILTERCONDITION=@CWHERECLAUSE--UPLOAD_TAB





   END TRY
   BEGIN CATCH
	  SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
	  GOTO END_PROC
   END CATCH
   
END_PROC:
   IF @@TRANCOUNT>0
	  BEGIN
		IF ISNULL(@CERRORMSG,'')=''
		begin
		    IF @EDIT_CLICKED=1 
                EXEC SP3S_CAPTURE_AUDIT_TRAIL_HSN 'HSN',@CHSN_CODE,'','',@NSPID,@CMACHINENAME,@CWINDOWUSERNAME,@CWIZAPPUSERCODE,0,'1900-01-01',@EDIT_CLICKED
	           
		   commit TRANSACTION
		end
		ELSE
		   ROLLBACK 	
	  END 

   SET @CCMD = N'DELETE HSN_HSN_MST_UPLOAD WHERE SP_ID='+CAST(@NSPID AS VARCHAR)+';
                 DELETE HSN_HSN_DET_UPLOAD WHERE SP_ID='+CAST(@NSPID AS VARCHAR)+';
					  '
		 PRINT @CCMD
		 EXEC SP_EXECUTESQL @CCMD
   SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
   SET NOCOUNT OFF
END
--END OF PROCEDURE PPC_SAVETRAN_HSNMASTER
