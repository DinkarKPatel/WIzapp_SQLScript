CREATE PROCEDURE SP_PRD_AGENCY_RETURN_RM
(
 @NQUERYID INT=0,
 @CAGENCY_CODE VARCHAR(10)='',
 @CORDER_ID VARCHAR(30)='',
 @CMEMOID VARCHAR(50)='',
 @NNAVMODE INT=0,
 @CFINYEAR VARCHAR(5)='',
 @CWHERE VARCHAR(100)=''
)
AS
BEGIN
     
     IF @NQUERYID IN(1,2,4)
     BEGIN
        
        IF OBJECT_ID ('TEMPDB..#TMPDETAILS','U') IS NOT NULL
            DROP TABLE #TMPDETAILS
         
		 SELECT MST.MEMO_ID AS ORDER_ID,MST.MEMO_NO AS ORDER_NO,MST.MEMO_DT AS ORDER_DT,
			   ART.ARTICLE_NO AS FG_ARTICLE_NO,
			   P1.PARA1_NAME ,P2.PARA2_NAME, 
			   ART1.ARTICLE_CODE AS COMPONENT_CODE,
			   ART1.ARTICLE_NO AS COMPONENT,
			   ART2.ARTICLE_CODE AS ARTICLE_CODE,
			   ART2.ARTICLE_NO AS RM_ARTICLE_NO,
			   UOM.UOM_NAME,
			   CAST('LATER' AS VARCHAR(100)) AS MEMO_ID,
			   A.ROW_ID AS REF_ROW_ID,
			   CAST('' AS VARCHAR(100)) AS ITEM_REMARKS,
	           B.REF_AGENCY_CODE AS AGENCY_CODE,
	           B.MEMO_NO AS ISSUE_NO,
	           B.MEMO_DT AS ISSUE_DT,
			   SKU.PRODUCT_CODE,
			   SKU.PRODUCT_UID,
			   CAST('LATER' AS VARCHAR(40)) AS ROW_ID,
			   GETDATE() AS LAST_UPDATE,
			   A.JOB_CODE ,
			   A.QUANTITY -(ISNULL(C.QUANTITY,0)+ISNULL(RM.QUANTITY,0)) AS PENDING_QTY,
			   CAST(0 AS NUMERIC(10,3)) AS QUANTITY
		INTO #TMPDETAILS
		FROM PRD_AGENCY_ISSUE_MATERIAL_DET A
		JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID 
		LEFT OUTER JOIN
		(
		  SELECT REF_ROW_ID ,SUM(A.QUANTITY) AS QUANTITY 
		  FROM PRD_AGENCY_MATERIAL_RECEIPT_DET  A
		  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID =B.MEMO_ID
		  WHERE B.CANCELLED =0
		  GROUP BY REF_ROW_ID
		) C ON A.ROW_ID =C.REF_ROW_ID
		LEFT OUTER JOIN
		(
		 SELECT A.PRODUCT_UID,A.QUANTITY FROM PRD_AGENCY_RM_RETURN_DET A
		 JOIN PRD_AGENCY_RM_RETURN_MST B ON A.MEMO_ID=B.MEMO_ID
		 WHERE B.CANCELLED=0
		 
		)RM ON RM.PRODUCT_UID=A.PRODUCT_UID
		JOIN PRD_SKU SKU ON SKU.PRODUCT_UID =A.PRODUCT_UID 
		JOIN PRD_WO_MST MST ON MST.MEMO_ID =A.REF_PRD_WORKORDER_MEMOID  
		JOIN ARTICLE ART ON ART.ARTICLE_CODE =MST.ARTICLE_SET_CODE 
		JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.COM_PARA1_CODE 
		JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.COM_PARA2_CODE 
		JOIN ARTICLE ART1 ON ART1.ARTICLE_CODE =SKU.COMPONENT_CODE 
		JOIN ARTICLE ART2 ON ART2.ARTICLE_CODE =SKU.ARTICLE_CODE  
		JOIN UOM ON UOM.UOM_CODE=ART2.UOM_CODE
		WHERE  A.QUANTITY -(ISNULL(C.QUANTITY,0)+ISNULL(RM.QUANTITY,0))>0
		AND (@CORDER_ID='' OR A.REF_PRD_WORKORDER_MEMOID =@CORDER_ID)
		AND (@CAGENCY_CODE ='' OR B.REF_AGENCY_CODE =@CAGENCY_CODE )
		AND B.CANCELLED =0
    
     END
 
     IF @NQUERYID=1
        GOTO LBL_AGENCY
     ELSE IF @NQUERYID=2
        GOTO LBL_ORDER
     ELSE IF @NQUERYID=3
       GOTO LBLMST
     ELSE IF @NQUERYID=4
       GOTO LBLDET
     ELSE IF @NQUERYID=5
       GOTO LBLNAVIGATE
     ELSE
       GOTO END_PROC
    
    LBL_AGENCY:
         
         SELECT A.AGENCY_CODE,B.AGENCY_NAME AS AGENCY_NAME 
         FROM #TMPDETAILS A
         JOIN PRD_AGENCY_MST  B ON A.AGENCY_CODE=B.AGENCY_CODE 
         GROUP BY A.AGENCY_CODE,B.AGENCY_NAME
         ORDER BY B.AGENCY_NAME 
         
    GOTO END_PROC
    
     LBL_ORDER:
          
         SELECT A.ORDER_ID ,A.ORDER_NO 
         FROM #TMPDETAILS A
         WHERE (@CAGENCY_CODE ='' OR A.AGENCY_CODE =@CAGENCY_CODE )
         GROUP BY A.ORDER_ID ,A.ORDER_NO 
         
      
      
     GOTO END_PROC
   
    
   LBLMST:
      
      SELECT MST.MEMO_NO AS ORDER_NO, AG.AGENCY_NAME AS AGENCY_NAME, A.* 
      FROM PRD_AGENCY_RM_RETURN_MST A
      JOIN PRD_AGENCY_MST  AG ON AG.AGENCY_CODE=A.AGENCY_CODE
      JOIN PRD_WO_MST MST ON MST.MEMO_ID =A.ORDER_ID
      WHERE A.MEMO_ID=@CMEMOID
      
      GOTO END_PROC
    
   
   LBLDET:
      
      IF @CMEMOID =''
      BEGIN
		  SELECT CAST(0 AS BIT) AS CHK,
			   A. FG_ARTICLE_NO,
			   A.PARA1_NAME ,A.PARA2_NAME, 
			   A.ARTICLE_CODE AS COMPONENT_CODE,
			   A.COMPONENT,
			   A.ARTICLE_CODE AS ARTICLE_CODE,
			   A.RM_ARTICLE_NO,
			   A.UOM_NAME,
			   A.MEMO_ID,
			   A.REF_ROW_ID,
			   A.ITEM_REMARKS AS ITEM_REMARKS,
	           A.AGENCY_CODE AS AGENCY_CODE,
	           A.ISSUE_NO,
	           A.ISSUE_DT,
			   A.PRODUCT_CODE,
			   A.PRODUCT_UID,
			   CAST('LATER' AS VARCHAR(40)) AS ROW_ID,
			   GETDATE() AS LAST_UPDATE,
			   A.JOB_CODE ,
			   A.PENDING_QTY,
			   A.QUANTITY AS QUANTITY 
		  
		  FROM #TMPDETAILS A
		  WHERE A.ORDER_ID=@CORDER_ID
		  AND A.AGENCY_CODE=@CAGENCY_CODE
      END
      ELSE
      BEGIN
       
       SELECT  CAST(1 AS BIT) AS CHK,
			   ART.ARTICLE_NO AS FG_ARTICLE_NO,
			   P1.PARA1_NAME ,P2.PARA2_NAME, 
			   ART1.ARTICLE_CODE AS COMPONENT_CODE,
			   ART1.ARTICLE_NO AS COMPONENT,
			   ART2.ARTICLE_CODE AS ARTICLE_CODE,
			   ART2.ARTICLE_NO AS RM_ARTICLE_NO,
			   UOM.UOM_NAME,
			   A.MEMO_ID,
			   A.REF_ROW_ID,
			   A.ITEM_REMARKS AS ITEM_REMARKS,
	           B.AGENCY_CODE AS AGENCY_CODE,
	           B.MEMO_NO AS ISSUE_NO,
	           B.MEMO_DT AS ISSUE_DT,
			   SKU.PRODUCT_CODE,
			   SKU.PRODUCT_UID,
			   A.ROW_ID,
			   A.LAST_UPDATE,
			   A.JOB_CODE ,
			   0  AS PENDING_QTY,
			   A.QUANTITY AS QUANTITY
       FROM PRD_AGENCY_RM_RETURN_DET A
       JOIN PRD_AGENCY_RM_RETURN_MST B ON A.MEMO_ID=B.MEMO_ID
       JOIN PRD_SKU SKU ON SKU.PRODUCT_UID =A.PRODUCT_UID 
	   JOIN PRD_WO_MST MST ON MST.MEMO_ID =B.ORDER_ID  
	   JOIN ARTICLE ART ON ART.ARTICLE_CODE =MST.ARTICLE_SET_CODE 
	   JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.COM_PARA1_CODE 
	   JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.COM_PARA2_CODE 
	   JOIN ARTICLE ART1 ON ART1.ARTICLE_CODE =SKU.COMPONENT_CODE 
	   JOIN ARTICLE ART2 ON ART2.ARTICLE_CODE =SKU.ARTICLE_CODE  
	   JOIN UOM ON UOM.UOM_CODE=ART2.UOM_CODE
       WHERE B.MEMO_ID =@CMEMOID
       
       
      
      END
   
   GOTO END_PROC
          	
	LBLNAVIGATE:  
	
	 EXECUTE SP_NAVIGATE 'PRD_AGENCY_RM_RETURN_MST',@NNAVMODE,@CMEMOID,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERE  
	 
	 GOTO END_PROC
    
    END_PROC:
END
