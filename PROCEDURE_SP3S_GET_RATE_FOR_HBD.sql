CREATE PROCEDURE  SP3S_GET_RATE_FOR_HBD
( 
@CARTICLE_NO VARCHAR(100)='',
@CDEPT_ID VARCHAR(2)='',
@cagency_code varchar(10)=''

)
AS
BEGIN


  --  SELECT ARTICLE_CODE, * FROM ARTICLE
	IF ISNULL(@CDEPT_ID,'')=''
	 SELECT @CDEPT_ID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 

	
	 IF OBJECT_ID('TEMPDB..#TMPJOBS','U') IS NOT NULL 
	 DROP TABLE #TMPJOBS

	 CREATE TABLE #TMPJOBS( SECTION_NAME  VARCHAR(100),SUB_SECTION_NAME  VARCHAR(100),ARTICLE_CODE VARCHAR(100), DEPT_ID  VARCHAR(100), DEPT_NAME  VARCHAR(100),
	         JOB_CODE  VARCHAR(100),JOB_NAME  VARCHAR(100), BASE_NRV NUMERIC(10,3), JOBRATE_LESSTHAN_NRV NUMERIC(10,3), JOBRATE_MORETHAN_NRV NUMERIC(10,3),VENDOR_RATE NUMERIC(10,3) )

    INSERT INTO #TMPJOBS (SECTION_NAME,SUB_SECTION_NAME,ARTICLE_CODE,DEPT_ID,DEPT_NAME,JOB_CODE ,JOB_NAME,BASE_NRV,JOBRATE_LESSTHAN_NRV,JOBRATE_MORETHAN_NRV,VENDOR_RATE )
	 SELECT cast('' as varchar(100)) as SECTION_NAME,
	        cast('' as varchar(100)) SUB_SECTION_NAME,
	        cast('' as varchar(100)) ARTICLE_CODE, 
			@CDEPT_ID as DEPT_ID, L.DEPT_NAME,
			AGENCY_JOBS.JOB_CODE,JOBS.JOB_NAME, 
			0 as BASE_NRV,0 as JOBRATE_LESSTHAN_NRV,0 as JOBRATE_MORETHAN_NRV,
	        AGENCY_JOBS.job_rate AS VENDOR_RATE 
	 FROM AGENCY_JOBS
	 join location l on l.dept_id=@CDEPT_ID
	 join jobs on jobs.job_code=AGENCY_JOBS.job_code
	 WHERE ISNULL(jobs.inactive,0)=0 AND (@CAGENCY_CODE='' OR AGENCY_CODE =@CAGENCY_CODE )
	 --AND AGENCY_JOBS.JOB_CODE=@CJOB_CODE
	 and AGENCY_JOBS.job_rate<>0
	 

	 IF NOT EXISTS (SELECT TOP 1 'U' FROM #TMPJOBS)
	BEGIN
			INSERT INTO #TMPJOBS (SECTION_NAME,SUB_SECTION_NAME,ARTICLE_CODE,DEPT_ID,DEPT_NAME,JOB_CODE ,JOB_NAME,BASE_NRV,JOBRATE_LESSTHAN_NRV,JOBRATE_MORETHAN_NRV,VENDOR_RATE )
			SELECT DISTINCT  SM.SECTION_NAME,SD.SUB_SECTION_NAME,ART.ARTICLE_CODE, L.DEPT_ID, L.DEPT_NAME,J.JOB_CODE,J.JOB_NAME, BASE_NRV,JOBRATE_LESSTHAN_NRV,JOBRATE_MORETHAN_NRV,
			A.VENDOR_RATE AS VENDOR_RATE
	
			FROM ARTICLE ART 
			JOIN SECTIOND SD ON SD.sub_section_code=ART.sub_section_code
			JOIN SECTIONM SM ON SM.section_code=SD.section_code
			JOIN ALTERATIONSETUP A ON A.SECTION_CODE=SM.section_code AND A.SUB_SECTION_CODE=SD.sub_section_code
			JOIN JOBS J (NOLOCK) ON J.JOB_CODE=A.JOB_CODE
			LEFT JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=A.dept_id
			WHERE ISNULL(J.inactive,0)=0 AND ART.ARTICLE_NO=@CARTICLE_NO AND (A.DEPT_ID=@CDEPT_ID OR ISNULL(A.DEPT_ID,'')='')


	end
	 IF NOT EXISTS (SELECT TOP 1 'U' FROM #TMPJOBS)
	 BEGIN
	     INSERT INTO #TMPJOBS (SECTION_NAME,SUB_SECTION_NAME,ARTICLE_CODE,DEPT_ID,DEPT_NAME,JOB_CODE ,JOB_NAME,BASE_NRV,JOBRATE_LESSTHAN_NRV,JOBRATE_MORETHAN_NRV,VENDOR_RATE )
	     SELECT DISTINCT SM.SECTION_NAME, SD.SUB_SECTION_NAME, ART. ARTICLE_CODE,@CDEPT_ID AS DEPT_ID,
		 L.DEPT_NAME  AS DEPT_NAME,
		 JOB_CODE,JOB_NAME ,0,0,0 ,0 as VENDOR_RATE
		 FROM JOBS (NOLOCK) 
		JOIN  ARTICLE ART ON ART.ARTICLE_NO =@CARTICLE_NO
		JOIN SECTIOND SD ON SD.sub_section_code=ART.sub_section_code
		JOIN SECTIONM SM ON SM.section_code=SD.section_code
		JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=@CDEPT_ID
		WHERE JOB_NAME <> '' AND JOBS.INACTIVE = 0 
	 END 
	 SELECT * FROM #TMPJOBS
	 WHERE @CARTICLE_NO<>''
	 ORDER BY DEPT_ID,SECTION_NAME,SUB_SECTION_NAME,JOB_NAME


END
