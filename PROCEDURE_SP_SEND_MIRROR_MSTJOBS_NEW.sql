CREATE PROCEDURE DBO.SP_SEND_MIRROR_MSTJOBS_NEW
(
 @CTARGETLOCID VARCHAR(5)
)
AS
 BEGIN
   DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION NVARCHAR(MAX)
           ,@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPLMTABLE VARCHAR(100)
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CCURDEPTID VARCHAR(5)
           ,@CHODEPTID VARCHAR(5),@CERRORMSG VARCHAR(MAX),@CREPLOCTABLE VARCHAR(500),@NLOCTYPE INT
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(2),@JOINMASTERTABLE VARCHAR(200),@JOINTEMPTABLE VARCHAR(200)

    DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),ERRMSG VARCHAR(MAX)) 
    
    BEGIN TRY
    
	SET @CSTEP=0

	SET @CTEMPDBNAME =''
	 
	SET @CSTEP=00
	 
	SET @CSTEP=10
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	SET @CFILTERCONDITION=''
	 
	SET @CSTEP=20

	SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
	
	SELECT @NLOCTYPE=LOC_TYPE FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	
	IF @CCURDEPTID<>@CHODEPTID
	BEGIN
		SELECT '' AS LAST_UPDATE,'' AS ERRMSG
		
		GOTO END_PROC
	END		

    
    ---SELECT DATA FROM PRD_AGENCY_MST TABLE
    SET @CSTEP=30
	SET @CTABLENAME = 'PRD_AGENCY_MST'
	SELECT DISTINCT  'MSTJOBS_PRD_AGENCY_MST_MIRROR' AS TARGET_TABLENAME,PRD_AGENCY_MST.*,1 AS PICK_FROM_CURRENT_DB FROM PRD_AGENCY_MST (NOLOCK)
	
	
	SET @CSTEP=40
	---SELECT DATA FROM AGENCY_JOBS TABLE
	SET @CTABLENAME = 'AGENCY_JOBS'

	SELECT DISTINCT  'MSTJOBS_AGENCY_JOBS_MIRROR' AS TARGET_TABLENAME,AGENCY_JOBS.*,1 AS PICK_FROM_CURRENT_DB FROM AGENCY_JOBS (NOLOCK)
	JOIN PRD_AGENCY_MST (NOLOCK) ON AGENCY_JOBS.AGENCY_CODE = PRD_AGENCY_MST.AGENCY_CODE

	
	SET @CSTEP=50
	---SELECT DATA FROM JOBS TABLE
	SET @CTABLENAME = 'JOBS'

	SELECT DISTINCT  'MSTJOBS_JOBS_MIRROR' AS TARGET_TABLENAME,JOBS.*,1 AS PICK_FROM_CURRENT_DB FROM JOBS (NOLOCK)
	JOIN DBO.AGENCY_JOBS AJ WITH(NOLOCK) ON JOBS.JOB_CODE = AJ.JOB_CODE


	SET @CSTEP=60
	---SELECT DATA FROM LM01106 TABLE
	SET @CTABLENAME = 'LM01106'
	SELECT DISTINCT  'MSTJOBS_LM01106_MIRROR' AS TARGET_TABLENAME,LM01106.*,1 AS PICK_FROM_CURRENT_DB FROM LM01106 (NOLOCK)
	JOIN DBO.PRD_AGENCY_MST A WITH(NOLOCK) ON LM01106.AC_CODE = A.AC_CODE


    
    SET @CSTEP=61
     ---SELECT DATA FROM LMP01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106 
	  
	SET @CTABLENAME = 'LMP01106'
	SELECT DISTINCT  'MSTJOBS_LMP01106_MIRROR' AS TARGET_TABLENAME,LMP01106.*,1 AS PICK_FROM_CURRENT_DB FROM LMP01106 (NOLOCK)
	JOIN DBO.PRD_AGENCY_MST A WITH(NOLOCK) ON LMP01106.AC_CODE = A.AC_CODE

 
	
     ---SELECT DATA FROM HD01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106  
	SET @CTABLENAME = 'HD01106'

	SELECT DISTINCT  'MSTJOBS_HD01106_MIRROR' AS TARGET_TABLENAME,HD01106.*,1 AS PICK_FROM_CURRENT_DB FROM HD01106 (NOLOCK)
	JOIN LM01106 (NOLOCK) ON HD01106.HEAD_CODE=LM01106.HEAD_CODE
	JOIN DBO.PRD_AGENCY_MST A WITH(NOLOCK) ON LM01106.AC_CODE = A.AC_CODE


	
	 
    
    SET @CSTEP=70
    --SELECT DATA FROM AREA TABLE 
	SET @CTABLENAME = 'AREA'
	SELECT DISTINCT  'MSTJOBS_AREA_MIRROR' AS TARGET_TABLENAME,AREA.*,1 AS PICK_FROM_CURRENT_DB FROM AREA (NOLOCK)
	JOIN  LMP01106 (NOLOCK) ON  AREA.area_code =LMP01106.area_code 
	JOIN DBO.PRD_AGENCY_MST A WITH(NOLOCK) ON LMP01106.AC_CODE = A.AC_CODE


    SET @CSTEP=80
   --SELECT DATA FROM AREA TABLE 
	SET @CTABLENAME = 'CITY'

	SELECT DISTINCT  'MSTJOBS_CITY_MIRROR' AS TARGET_TABLENAME,CITY.*,1 AS PICK_FROM_CURRENT_DB FROM CITY (NOLOCK)
	JOIN AREA (NOLOCK) ON CITY.CITY_CODE =AREA.CITY_CODE
	JOIN  LMP01106 (NOLOCK) ON  AREA.area_code =LMP01106.area_code 
	JOIN DBO.PRD_AGENCY_MST A WITH(NOLOCK) ON LMP01106.AC_CODE = A.AC_CODE




    SET @CSTEP=90
 --SELECT DATA FROM STATE TABLE 
	SET @CTABLENAME = 'STATE'
	SELECT DISTINCT  'MSTJOBS_STATE_MIRROR' AS TARGET_TABLENAME,STATE.*,1 AS PICK_FROM_CURRENT_DB FROM STATE (NOLOCK)
    JOIN  CITY (NOLOCK) ON CITY .state_code =STATE.state_code 
	JOIN AREA (NOLOCK) ON CITY.CITY_CODE =AREA.CITY_CODE
	JOIN  LMP01106 (NOLOCK) ON  AREA.area_code =LMP01106.area_code 
	JOIN DBO.PRD_AGENCY_MST A WITH(NOLOCK) ON LMP01106.AC_CODE = A.AC_CODE


    SET @CSTEP=100
   --SELECT DATA FROM STATE TABLE 
	SET @CTABLENAME = 'REGIONM'

	SELECT DISTINCT  'MSTJOBS_REGIONM_MIRROR' AS TARGET_TABLENAME,REGIONM.*,1 AS PICK_FROM_CURRENT_DB FROM REGIONM (NOLOCK)
	JOIN  STATE (NOLOCK) ON state .region_code =regionM .region_code 
    JOIN  CITY (NOLOCK) ON CITY .state_code =STATE.state_code 
	JOIN AREA (NOLOCK) ON CITY.CITY_CODE =AREA.CITY_CODE
	JOIN  LMP01106 (NOLOCK) ON  AREA.area_code =LMP01106.area_code 
	JOIN DBO.PRD_AGENCY_MST A WITH(NOLOCK) ON LMP01106.AC_CODE = A.AC_CODE


    
	END TRY
	
	BEGIN CATCH
	    SET @CERRORMSG='P: SP_SEND_MIRROR_MSTJOBS, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	    GOTO END_PROC
    END CATCH 
    
    END_PROC:
    
  SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
 END


 