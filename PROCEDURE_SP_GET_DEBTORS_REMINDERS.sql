CREATE PROCEDURE SP_GET_DEBTORS_REMINDERS
(
	@DCLOSINGDT DATETIME,
	@NMODE INT=1, --(1 FOR CR-DR,2 FOR RETAIL CUSTOMER)
	@NDUEBILLS INT=1,--( 1 FOR DUE BILLS 0 FOR ALL),
	@CWHERE VARCHAR(MAX)=''
)
AS
BEGIN 
--(dinkar) Replace  left(memoid,2) to Location_code 
		DECLARE @CCMD NVARCHAR(MAX),@ACCODE CHAR(10),@CDEPTID CHAR(4)
		DECLARE @CFIN_YEAR VARCHAR(5),@CHEAD_CODE VARCHAR(MAX)
		
		IF ISNULL(@CWHERE,'')<>''
		SET @CWHERE=' AND '+@CWHERE
		---GETTING CONFIG_OPTION TO RETURN ONACCOUNT BALANCE AND WHETHER TO CONSIDER PENDING WHOLESALE BUYER ORDER
		
		SET  @CDEPTID=''
		
				IF OBJECT_ID('TEMBDB..#TEMP_AC_CODE','U') IS NOT NULL
					DROP TABLE 	#TEMP_AC_CODE
					
				CREATE TABLE #TEMP_AC_CODE(AC_CODE CHAR(10))
				SELECT @CFIN_YEAR='01'+CAST(DBO.FN_GETFINYEAR (@DCLOSINGDT) AS VARCHAR(5))

				
				--'0000000018',0000000021'
				
              IF @NMODE=1
              BEGIN
              
                SELECT @CHEAD_CODE=DBO.FN_ACT_TRAVTREE('0000000018')
			    SET @CHEAD_CODE=@CHEAD_CODE+','+ISNULL((SELECT DBO.FN_ACT_TRAVTREE('0000000021')),'')
			    
			   
				SET @CCMD = N'SELECT DISTINCT AC_CODE FROM LMV01106(NOLOCK) 
				WHERE INACTIVE=0 AND  (HEAD_CODE IN ('+@CHEAD_CODE+')) '
				INSERT INTO #TEMP_AC_CODE(AC_CODE)
				EXEC SP_EXECUTESQL @CCMD
				PRINT @CCMD
			    
			    
			    IF OBJECT_ID('TEMPDB..#TMPCLOSING','U') IS NOT NULL
			       DROP TABLE #TMPCLOSING
			       
				CREATE TABLE  #TMPCLOSING  (HEAD_NAME VARCHAR(100),ac_code CHAR(10),
											LEDGER_BAL NUMERIC(14,2))
				
				
				
				EXEC sp3s_act_triallist
				@dFromDtPara=@DCLOSINGDT,
				@dToDtPara=@DCLOSINGDT,
				@cParentHeadCode='0000000018',
				@nSpId=@@SPID,
				@nMode=1,
				@bCalledFromReminders=1
                
				                
				IF OBJECT_ID ('TEMPDB..#TMPDUEBILLS','U') IS NOT NULL
				   DROP TABLE #TMPDUEBILLS

				SELECT CAST('' AS VARCHAR(100)) AS REF_NO,
				CAST ('' AS VARCHAR(10)) AS AC_CODE,
				CAST (0 AS NUMERIC(14,2)) AS DUE_BILLS,
				CAST ('' AS DATETIME ) AS DUE_DATE
				INTO #TMPDUEBILLS
				WHERE 1=2

				
				EXEC SP3S_BILL_BY_BILL @NMODE=4,@CAC_CODE='',@DT_TODATE=@DCLOSINGDT,@CLOCID='',@BSHOWMRRNO= 0,@NDUEBILLMODE=2

			  
				SET @CCMD = N'SELECT A.AC_CODE,A.AC_NAME,A.STATE,A.CITY,
				LEDGER_BAL  AS LEDGER_BAL,
				ISNULL(DB.DUE_BILLS,0)  AS DUE_BAL,
				ISNULL(SCH.SEND_MAIL,0) AS SEND_MAIL,ISNULL(SCH.SEND_SMS,0) AS SEND_SMS,A.MOBILE,A.E_MAIL AS EMAIL_ID,A.E_MAIL,NEWID() AS ROW_ID,
				'''' AS SMS_DET,'''' AS EMAIL_SUB,'''' AS EMAIL_BODY,
				CAST('''' AS VARCHAR(100)) AS T_NAME,
				ISNULL(SCH.T_ID,'''') AS T_ID,
				ISNULL(SMS.T_NAME,'''') AS SMS_T_NAME,
                ISNULL(SMS.SMS_SENT_ON,'''') AS SMS_SENT_ON,
                GETDATE() AS STMT_CUT_OFF_DT,
                (CASE WHEN ISNULL(SCH.ATTACHMENT_TYPE,0)=1 OR ISNULL(SCH.ATTACHMENT_TYPE,0)=3 THEN 1 ELSE 0 END)  AS SEND_LEDGER_AS_ATTACHMENT,
                CAST (0 AS BIT) AS PROCESSED, CAST (0 AS BIT) AS  EMAIL_SEND, CAST (0 AS BIT) AS SMS_SEND,A.AR_ID,A.AR_NAME,A.contact_person_name
				FROM LMV01106 A (NOLOCK)
				JOIN #TEMP_AC_CODE C ON A.AC_CODE = C.AC_CODE
				JOIN HD01106 ON HD01106.HEAD_CODE=A.HEAD_CODE
				LEFT JOIN DEBIT_BAL_SMS_LOG SMS ON SMS.AC_CODE=A.AC_CODE 
				LEFT JOIN ACT_SCHEDULER SCH ON A.AC_CODE=SCH.AC_CODE 
				LEFT JOIN #TMPCLOSING TMP ON TMP.AC_CODE=A.AC_CODE
				LEFT JOIN
				(
				SELECT AC_CODE ,SUM(ISNULL(DUE_BILLS,0)) AS DUE_BILLS 
				FROM #TMPDUEBILLS
				GROUP BY AC_CODE
				) DB ON DB.AC_CODE=A.AC_CODE
				WHERE (ISNULL(TMP.LEDGER_BAL,0)>0 OR ISNULL(DB.DUE_BILLS,0)>0)
				'+@CWHERE +
				'ORDER BY A.AC_NAME '
				PRINT @CCMD
				EXEC SP_EXECUTESQL @CCMD
				
				
			GOTO END_PROC	
			END
			ELSE
			BEGIN
			    

				IF OBJECT_ID('TEMPDB..#EMP_CUST_BAL','U' ) IS NOT NULL
				   DROP TABLE #EMP_CUST_BAL
                
				SELECT CUSTOMER_CODE ,CAST(0 AS NUMERIC(14,2)) AS BALANCE
				INTO #EMP_CUST_BAL
				FROM CUSTDYM 
				WHERE 1=2

			   EXEC SP3S_CUSTOMERBALANCE
				 @DFROM_DT=''
				,@DTO_DT=@DCLOSINGDT
				,@BORDER_XN=1
				,@CCUS_CODE=''
				,@NMODE=3
				,@NRETURNCBS=3
				,@BCZB=1

		   DELETE FROM #EMP_CUST_BAL WHERE BALANCE=0

			    
			    SET @CCMD = N'SELECT A.*
			    FROM
			    (
			    SELECT  A.CUSTOMER_CODE AS  AC_CODE,
			    ISNULL(H.CUSTOMER_FNAME,'''')+'' ''+ISNULL(H.CUSTOMER_LNAME,'''')  AS AC_NAME,
			    K.STATE,J.CITY,'''' AS HEAD_NAME,
				BALANCE  AS LEDGER_BAL,
				BALANCE AS DUE_BAL,
				0 AS EMAIL_SEND,0 AS SMS_SEND,H.MOBILE,H.EMAIL  AS EMAIL_ID,NEWID() AS ROW_ID,
				'''' AS SMS_DET,'''' AS EMAIL_SUB,'''' AS EMAIL_BODY,
				CAST('''' AS VARCHAR(100)) AS T_NAME,
				CAST('''' AS VARCHAR(100)) AS T_ID,
				ISNULL(SMS.T_NAME,'''') AS SMS_T_NAME,
                ISNULL(SMS.SMS_SENT_ON,'''') AS SMS_SENT_ON
                FROM #EMP_CUST_BAL A (NOLOCK)
                JOIN CUSTDYM H (NOLOCK) ON A.CUSTOMER_CODE = H.CUSTOMER_CODE
				JOIN AREA I (NOLOCK) ON I.AREA_CODE = H.AREA_CODE 
				JOIN CITY J (NOLOCK) ON J.CITY_CODE = I.CITY_CODE 
				JOIN STATE K (NOLOCK) ON K.STATE_CODE = J.STATE_CODE 
                LEFT JOIN DEBIT_BAL_SMS_LOG SMS ON SMS.AC_CODE=A.CUSTOMER_CODE 
                WHERE A.CUSTOMER_CODE NOT IN('''',''000000000000'')
				AND BALANCE>0
                ) A 
                WHERE 1=1 '+
                @CWHERE +
                'ORDER BY 
				CASE WHEN A.AC_NAME IN ('''',''-'') THEN 1 ELSE 0 END ,
				A.AC_NAME'
                PRINT @CCMD
				EXEC SP_EXECUTESQL @CCMD
			
			END
			
		--	SELECT * FROM CUSTDYM
			
	GOTO END_PROC
			
END_PROC:				
END