CREATE PROCEDURE SP_RETAILSALE_MANUAL_ADJ--(LocId 3 digit change by Sanjay:01-11-2024)
(  
	 @CQUERYID			NUMERIC(2),  
	 @CWHERE			VARCHAR(MAX)='',  
	 @CFINYEAR			VARCHAR(5)='',  
	 @CDEPTID			VARCHAR(4)='',  
	 @CWIZAPPUSERCODE	VARCHAR(10)='',  
	 @BINCLUDEESTIMATE	BIT=1,  
	 @CFROMDT			DATETIME='',  
	 @CTODT				DATETIME=''  
) 
----WITH ENCRYPTION
AS  
BEGIN  
DECLARE @CCMD NVARCHAR(MAX),@CFLATDISC VARCHAR(10)  
SET @CCMD=''  
   
IF @CQUERYID=1  
  GOTO LBLCMM01106  
 ELSE IF @CQUERYID=2
	GOTO LBLCMD01106
ELSE IF @CQUERYID=3  
  GOTO LBLERROR
ELSE IF @CQUERYID=4
	GOTO LBLCMD_ERROR_DESC  
 ELSE   
  GOTO LAST  


LBLERROR:
	SELECT A.*,D.*,B.SR_NO AS [SRNO]  FROM CMD_MANUALBILL_ERRORS A 
	JOIN CMD01106 B ON B.ROW_ID=A.CMD_ROW_ID
	JOIN CMM01106 C ON C.CM_ID=B.CM_ID
	LEFT OUTER JOIN MANUALBILL_ERRORS_MST D ON D.ERROR_CODE=A.ERROR_CODE
	WHERE C.CM_ID=@CWHERE
	ORDER BY B.SR_NO
	GOTO LAST
LBLCMM01106:

	DECLARE @BPAID	TABLE(CM_ID		VARCHAR(100)) 
	
	INSERT INTO @BPAID (CM_ID)
	SELECT DISTINCT A.CM_ID
	FROM CMM01106 A
	JOIN CMD01106 B ON B.CM_ID=A.CM_ID
	LEFT OUTER  JOIN CMD_MANUALBILL_ERRORS C ON C.CMD_ROW_ID=B.ROW_ID
	WHERE ISNULL(C.APPROVED,0)=0 AND ISNULL(A.MANUAL_BILL,0)=1 -- C.ERROR_CODE IN ('06','07','08')
	AND a.location_Code=(CASE WHEN ISNULL(@CDEPTID,'')='' THEN  a.location_Code ELSE @CDEPTID END)
	
  SELECT A.*, B.*, '' AS CUSTOMER_NAME, '' AS CREDIT_CARD_NAME , C.USERNAME, '' AS ADDRESS,  
  ISNULL(ST.STATE,'') AS [STATE],ISNULL(AR.AREA_NAME,'') AS  AREA,  
    ISNULL(CI.CITY,'') AS CITY,ISNULL(AR.PINCODE,'') AS PINCODE,  
    CAST((CASE WHEN ISNULL(CMR.CM_ID,'')<>'' THEN 1 ELSE 0 END) AS BIT) AS CREDIT_REFUND,  
    '' AS HOLD_ID,'' AS LOGIN_ID,'' AS SESSION_ID  
    ,CAST(ISNULL(TAX,0) AS NUMERIC(14,2)) AS [TOTAL_TAX]  ,ISNULL(D.USERNAME,'') AS [EDT_USERNAME],
   ISNULL(X.EMP_CODE,'0000000') AS [EMP_CODE],ISNULL(X.EMP_CODE1,'0000000')  AS [EMP_CODE1],
   ISNULL(X.EMP_CODE2,'0000000') AS [EMP_CODE2],ISNULL(X.EMP_NAME,'') AS [EMP_NAME],
   ISNULL(X.EMP_NAME1,'') AS [EMP_NAME1],ISNULL(X.EMP_NAME2,'') AS [EMP_NAME2],DTM.DT_NAME,
   B1.AC_NAME,ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],
   CONVERT(NUMERIC(14,2),A.SUBTOTAL+A.SUBTOTAL_R) AS [SUBTOTAL_T],
   CONVERT(NUMERIC(14,3),(CASE WHEN (A.SUBTOTAL+A.SUBTOTAL_R)<>0 THEN (A.DISCOUNT_AMOUNT*100)/ (A.SUBTOTAL+A.SUBTOTAL_R) ELSE 0 END)) AS [DISCOUNT_PERCENTAGE_CALC],
   '' AS [DELAY],
   CONVERT(NUMERIC(14,2),0) AS CASH_AMOUNT, CONVERT(NUMERIC(14,2),0)  AS CC_AMOUNT, CONVERT(NUMERIC(14,2),0)  AS CREDIT_AMOUNT, 
   CONVERT(NUMERIC(14,2),0)  AS CN_AMOUNT,	CONVERT(NUMERIC(14,2),0)  AS [OTHER_AMOUNT]
   ,CONVERT(VARCHAR(50),'APPROVE') AS [APPROVE]
  FROM CMM01106 A  (NOLOCK)
  JOIN @BPAID MN ON MN.CM_ID=A.CM_ID  
  JOIN CUSTDYM B  (NOLOCK) ON B.CUSTOMER_CODE=A.CUSTOMER_CODE   
  JOIN LM01106 B1  (NOLOCK) ON B1.AC_CODE=A.AC_CODE 
  JOIN DTM  (NOLOCK) ON DTM.DT_CODE=A.DT_CODE
  LEFT OUTER JOIN BIN  (NOLOCK) ON BIN.BIN_ID=ISNULL(A.BIN_ID,'000')  
  LEFT OUTER JOIN AREA AR  (NOLOCK) ON AR.AREA_CODE=B.AREA_CODE  
  LEFT OUTER JOIN CITY CI  (NOLOCK) ON CI.CITY_CODE=AR.CITY_CODE  
  LEFT OUTER JOIN STATE ST  (NOLOCK) ON ST.STATE_CODE=CI.STATE_CODE  
  LEFT OUTER JOIN CMR01106 CMR  (NOLOCK) ON CMR.CM_ID=A.CM_ID    
  JOIN USERS C  (NOLOCK) ON C.USER_CODE=A.USER_CODE  
  LEFT OUTER JOIN USERS D  (NOLOCK) ON D.USER_CODE=A.EDT_USER_CODE
  LEFT OUTER JOIN
  (
	SELECT SUM(TAX_AMOUNT) AS [TAX] ,CM_ID	FROM CMD01106 A (NOLOCK)
	WHERE TAX_METHOD=2 AND CM_ID=@CWHERE 
	GROUP BY CM_ID
  )X1 ON X1.CM_ID=A.CM_ID  
  LEFT OUTER JOIN
  (
	SELECT TOP 1 CM_ID,E1.EMP_CODE,E2.EMP_CODE  AS [EMP_CODE1],E3.EMP_CODE AS [EMP_CODE2],E1.EMP_NAME AS [EMP_NAME]
	,E2.EMP_NAME AS [EMP_NAME1],E3.EMP_NAME AS [EMP_NAME2]
	FROM CMD01106 A (NOLOCK)
	JOIN EMPLOYEE E1 (NOLOCK) ON E1.EMP_CODE=A.EMP_CODE
	JOIN EMPLOYEE E2 (NOLOCK) ON E2.EMP_CODE=A.EMP_CODE1
	JOIN EMPLOYEE E3 (NOLOCK) ON E3.EMP_CODE=A.EMP_CODE2
	WHERE A.CM_ID=@CWHERE AND (A.EMP_CODE<>'0000000' OR A.EMP_CODE2<>'0000000' OR A.EMP_CODE2<>'0000000')
  )X ON X.CM_ID=A.CM_ID
  GOTO LAST  
LBLCMD01106:  
    SELECT  A.*,A.SR_NO AS SRNO,  
    EMP.EMP_NAME, A.PRODUCT_CODE, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, C.PARA1_CODE,    
    C.PARA1_NAME, D.PARA2_CODE, D.PARA2_NAME, F.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,       
    A.DEPT_ID, B.CODING_SCHEME,  B.INACTIVE,SKU.PURCHASE_PRICE,  SKU.MRP,SKU.WS_PRICE,   
    SM.SECTION_NAME, SD.SUB_SECTION_NAME, G.PARA4_CODE,H.PARA5_CODE,I.PARA6_CODE,    
    PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],    
    B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],    
    B.STOCK_NA, A.MRP AS [LOCSKU_MRP],SKU.PRODUCT_NAME,  
  CONVERT (BIT,(CASE WHEN A.QUANTITY <0 THEN 1 ELSE 0 END)) AS SALERETURN ,CAST(0 AS BIT) AS CREDIT_REFUND,  
	EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2  ,(CASE WHEN ISNULL(SKU.FIX_MRP,0)=0 THEN SKU.MRP ELSE SKU.FIX_MRP END) AS [FIX_MRP],
   (CASE WHEN ISNULL(A.HOLD_FOR_ALTER,0)=0 THEN 'N' ELSE 'Y' END) AS [HOLD_FOR_ALTER_TXT],
   (CASE WHEN ISNULL(A.PACK_SLIP_ID,'')='' THEN '' ELSE RIGHT(A.PACK_SLIP_ID,10 ) END) AS [PACK_SLIP_NO]
   ,ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],B.ALIAS AS ARTICLE_ALIAS ,SD.SUB_SECTION_CODE,SM.SECTION_CODE,
   CONVERT(BIT,0 ) AS [BRANDWISE_DISC],ISNULL(SLS_TITLE,'') AS SLS_TITLE,ISNULL(N.NARRATION,'') AS [NARRATION]
  FROM  CMD01106  A  (NOLOCK) 
  JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=A.CM_ID
  JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
  JOIN ARTICLE B  (NOLOCK) ON SKU.ARTICLE_CODE = B.ARTICLE_CODE      
  JOIN SECTIOND SD  (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
  JOIN SECTIONM SM  (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
  JOIN PARA1 C  (NOLOCK) ON SKU.PARA1_CODE = C.PARA1_CODE      
  JOIN PARA2 D  (NOLOCK) ON SKU.PARA2_CODE = D.PARA2_CODE      
  JOIN PARA3 F  (NOLOCK) ON SKU.PARA3_CODE = F.PARA3_CODE      
  JOIN PARA4 G  (NOLOCK) ON SKU.PARA4_CODE = G.PARA4_CODE      
  JOIN PARA5 H  (NOLOCK) ON SKU.PARA5_CODE = H.PARA5_CODE      
  JOIN PARA6 I  (NOLOCK) ON SKU.PARA6_CODE = I.PARA6_CODE      
  JOIN UOM E  (NOLOCK) ON B.UOM_CODE = E.UOM_CODE 
  LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID  
  LEFT OUTER JOIN NRM N (NOLOCK) ON N.NRM_ID=ISNULL(A.NRM_ID  ,'0000000')
  LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON A.EMP_CODE = EMP.EMP_CODE   
  LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON A.EMP_CODE1 = EMP1.EMP_CODE     
  LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON A.EMP_CODE2 = EMP2.EMP_CODE    
  LEFT OUTER JOIN SLSDET S (NOLOCK) ON S.ROW_ID =A.SLSDET_ROW_ID
   WHERE A.CM_ID=@CWHERE     
  ORDER BY  A.SR_NO--ROW_NUMBER() OVER (ORDER BY A.TS)
  
     
GOTO LAST 

LBLCMD_ERROR_DESC:  
    SELECT  A.*,A.SR_NO AS SRNO,  
    EMP.EMP_NAME, A.PRODUCT_CODE, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, C.PARA1_CODE,    
    C.PARA1_NAME, D.PARA2_CODE, D.PARA2_NAME, F.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,       
    A.DEPT_ID, B.CODING_SCHEME,  B.INACTIVE,SKU.PURCHASE_PRICE,  SKU.MRP,SKU.WS_PRICE,   
    SM.SECTION_NAME, SD.SUB_SECTION_NAME, G.PARA4_CODE,H.PARA5_CODE,I.PARA6_CODE,    
    PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],    
    B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],
    SKU.DT_CREATED AS [SKU_DT_CREATED],B.STOCK_NA, A.MRP AS [LOCSKU_MRP],SKU.PRODUCT_NAME,    
  CONVERT (BIT,(CASE WHEN A.QUANTITY <0 THEN 1 ELSE 0 END)) AS SALERETURN ,CAST(0 AS BIT) AS CREDIT_REFUND,  
   EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2  ,(CASE WHEN ISNULL(SKU.FIX_MRP,0)=0 THEN SKU.MRP ELSE SKU.FIX_MRP END) AS [FIX_MRP],
   (CASE WHEN ISNULL(A.HOLD_FOR_ALTER,0)=0 THEN 'N' ELSE 'Y' END) AS [HOLD_FOR_ALTER_TXT],
   (CASE WHEN ISNULL(A.PACK_SLIP_ID,'')='' THEN '' ELSE RIGHT(A.PACK_SLIP_ID,10 ) END) AS [PACK_SLIP_NO]
   ,ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],B.ALIAS AS ARTICLE_ALIAS ,SD.SUB_SECTION_CODE,SM.SECTION_CODE,
   CONVERT(BIT,0 ) AS [BRANDWISE_DISC],ISNULL(SLS_TITLE,'') AS SLS_TITLE,ISNULL(N.NARRATION,'') AS [NARRATION],
   M1.*,M2.*,CONVERT(BIT,0) AS [CHK]
  FROM  CMD01106  A  (NOLOCK) 
  JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=A.CM_ID
  LEFT OUTER JOIN CMD_MANUALBILL_ERRORS M1 (NOLOCK) ON M1.CMD_ROW_ID=A.ROW_ID
  LEFT OUTER  JOIN MANUALBILL_ERRORS_MST M2 (NOLOCK) ON M2.ERROR_CODE=M1.ERROR_CODE
  JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
  JOIN ARTICLE B  (NOLOCK) ON SKU.ARTICLE_CODE = B.ARTICLE_CODE      
  JOIN SECTIOND SD  (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
  JOIN SECTIONM SM  (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
  JOIN PARA1 C  (NOLOCK) ON SKU.PARA1_CODE = C.PARA1_CODE      
  JOIN PARA2 D  (NOLOCK) ON SKU.PARA2_CODE = D.PARA2_CODE      
  JOIN PARA3 F  (NOLOCK) ON SKU.PARA3_CODE = F.PARA3_CODE      
  JOIN PARA4 G  (NOLOCK) ON SKU.PARA4_CODE = G.PARA4_CODE      
  JOIN PARA5 H  (NOLOCK) ON SKU.PARA5_CODE = H.PARA5_CODE      
  JOIN PARA6 I  (NOLOCK) ON SKU.PARA6_CODE = I.PARA6_CODE      
  JOIN UOM E  (NOLOCK) ON B.UOM_CODE = E.UOM_CODE 
  LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID  
  LEFT OUTER JOIN NRM N (NOLOCK) ON N.NRM_ID=ISNULL(A.NRM_ID  ,'0000000')
  LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON A.EMP_CODE = EMP.EMP_CODE   
  LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON A.EMP_CODE1 = EMP1.EMP_CODE     
  LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON A.EMP_CODE2 = EMP2.EMP_CODE    
  LEFT OUTER JOIN SLSDET S (NOLOCK) ON S.ROW_ID =A.SLSDET_ROW_ID
   WHERE A.CM_ID=@CWHERE     
  ORDER BY  A.SR_NO
  
     
GOTO LAST
	
	LAST:  
  
END
