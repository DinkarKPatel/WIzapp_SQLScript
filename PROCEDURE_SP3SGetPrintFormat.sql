CREATE PROCEDURE SP3SGETPRINTFORMAT
(
	 @NMODE NUMERIC(1)
	,@CPRINTID VARCHAR(40)=''
	,@CXNTYPE VARCHAR(10)=''
	,@CROW_ID VARCHAR(100)=''
	-- 0 FOR DETAIL 1 FOR HEADER 2 FOR FOOTER 
)
AS
BEGIN

	DECLARE @CSEPARTOR VARCHAR(10),@PARENTID VARCHAR(20), @REFID VARCHAR(20),@ISDEFAULT BIT,@MAXID INT,@MINID INT
	SET @REFID=0
	SET @ISDEFAULT=0
	SET @MINID=1
	SET @MAXID=0
	IF @CPRINTID='LATER'
	SET @CPRINTID=''

  IF OBJECT_ID('TEMPDB..#TMPPRINTMASTER','U') IS NOT NULL
		DROP TABLE #TMPPRINTMASTER
	  
	  SELECT ROW_NUMBER()OVER (ORDER BY PRINTID)AS RNO
			,PARENTPRINTID=CAST('' AS VARCHAR(100)),* INTO #TMPPRINTMASTER 
	  FROM PRINTMASTER
  
	  UPDATE #TMPPRINTMASTER SET PARENTPRINTID=PRINTID WHERE ISDEFAULTFORMAT=1
  
	  SELECT @MAXID=MAX(RNO) 
	  FROM #TMPPRINTMASTER
  
  WHILE @MINID<=@MAXID
	  BEGIN
		SELECT @PARENTID=PARENTPRINTID,@REFID=REFPRINTID,@ISDEFAULT=ISDEFAULTFORMAT
		FROM #TMPPRINTMASTER WHERE RNO=@MINID
	    
		WHILE @ISDEFAULT=0 AND @REFID IS NOT NULL
		 BEGIN
			SELECT @PARENTID=PARENTPRINTID,@REFID=REFPRINTID,@ISDEFAULT=ISDEFAULTFORMAT 
			FROM  #TMPPRINTMASTER
			WHERE PRINTID=@REFID
		 END
		 UPDATE #TMPPRINTMASTER SET PARENTPRINTID=@PARENTID WHERE RNO=@MINID
		 SET @MINID=@MINID+1
	  END
  
	IF @NMODE=1
		GOTO ALLPRINTFORMAT
	ELSE IF @NMODE=2
		GOTO REPORTPRINTFORMAT	
	ELSE IF @NMODE=3
		GOTO DOCUMENTREPORT		
	ELSE 
		GOTO ENDPROC	
	  
  ALLPRINTFORMAT:
  SELECT * FROM #TMPPRINTMASTER 
  WHERE (@CXNTYPE= '' OR XNTYPE=@CXNTYPE)
  AND  (@CPRINTID= '' OR PRINTID=@CPRINTID)
  ORDER BY ISDEFAULTFORMAT DESC

  GOTO ENDPROC	

  REPORTPRINTFORMAT:

   SELECT * FROM #TMPPRINTMASTER 
   WHERE (@CXNTYPE= '' OR XNTYPE=@CXNTYPE)
   AND  (@CPRINTID= '' OR PRINTID=@CPRINTID)
   ORDER BY ISDEFAULTFORMAT DESC
  --------------------FOR PRINTDETAIL-----------------------
	SELECT A.*
	FROM PRINTDETAIL A
	JOIN PRINTMASTER B ON A.PRINTID =B.PRINTID 
	WHERE (@CXNTYPE= '' OR B.XNTYPE=@CXNTYPE)
    AND  (@CPRINTID= '' OR A.PRINTID=@CPRINTID)
    AND ISNULL(ISDISPLAY,0)=0
	
	SELECT TOP 1 @CSEPARTOR=COLUMNSEPARATOR FROM PRINTDESCRIPTION WHERE PRINTID=@CPRINTID
		
	SELECT ISNULL(A.ROWID,'LATER'+CONVERT(VARCHAR(5),ROW_NUMBER() OVER(ORDER BY @CPRINTID))) AS ROWID
		   ,@CPRINTID AS PRINTID
		   ,'PARTICULARS' AS VALUENAME
		   ,ISNULL(A.DISPLAYNAME,B.DISPLAYNAME) AS DISPLAYNAME
		   ,ISNULL(A.SOURCENAME,B.SOURCENAME) AS SOURCENAME
		   ,ISNULL(A.COLUMNNAME,B.COLUMNNAME) AS COLUMNNAME
		   ,@CSEPARTOR AS COLUMNSEPARATOR
		   ,ISNULL(A.COLUMNPRINTLENGTH,B.COLUMNPRINTLENGTH) AS COLUMNPRINTLENGTH
		   ,ISNULL(A.DISPLAYORDER,B.DISPLAYORDER) AS DISPLAYORDER
		   ,ISNULL(A.ISVISIBLE,B.ISVISIBLE) AS ISVISIBLE
		   ,ISNULL(A.ISMASTERDATA,B.ISMASTERDATA) AS ISMASTERDATA
		   ,ISNULL(A.PICKALIAS,B.PICKALIAS) AS PICKALIAS
	FROM 
	(
		SELECT A.* 
		FROM PRINTDESCRIPTION A 
		JOIN PRINTMASTER B ON A.PRINTID =B.PRINTID 
	    WHERE (@CXNTYPE= '' OR B.XNTYPE=@CXNTYPE)
        AND  (@CPRINTID= '' OR A.PRINTID=@CPRINTID)
	)A
	FULL OUTER JOIN 
	( 
		SELECT 'BARCODE' AS DISPLAYNAME,'SKU' AS SOURCENAME,'PRODUCT_CODE' AS COLUMNNAME
			  ,0 AS COLUMNPRINTLENGTH,0 AS DISPLAYORDER,0 AS ISVISIBLE,0 AS ISMASTERDATA 
			  ,0 AS PICKALIAS
		UNION ALL
		SELECT 'SECTION' AS DISPLAYNAME,'SECTIONM' AS SOURCENAME,'SECTION_NAME' AS COLUMNNAME
			  ,0 AS COLUMNPRINTLENGTH,0 AS DISPLAYORDER,0 AS ISVISIBLE,0 AS ISMASTERDATA 
			  ,0 AS PICKALIAS
		UNION ALL
		SELECT 'SUB SECTION' AS DISPLAYNAME,'SECTIOND' AS SOURCENAME,'SUB_SECTION_NAME' AS COLUMNNAME
			  ,0 AS COLUMNPRINTLENGTH,0 AS DISPLAYORDER,0 AS ISVISIBLE,0 AS ISMASTERDATA
			  ,0 AS PICKALIAS
		UNION ALL
		SELECT 'ARTICLE NO.' AS DISPLAYNAME,'ARTICLE' AS SOURCENAME,'ARTICLE_NO' AS COLUMNNAME
			  ,0 AS COLUMNPRINTLENGTH,0 AS DISPLAYORDER,0 AS ISVISIBLE,0 AS ISMASTERDATA
			  ,0 AS PICKALIAS
		UNION ALL
		SELECT VALUE AS DISPLAYNAME,CONFIG_OPTION AS SOURCENAME,CONFIG_OPTION+'_NAME' AS COLUMNNAME
			  ,0 AS COLUMNPRINTLENGTH,0 AS DISPLAYORDER,0 AS ISVISIBLE,0 AS ISMASTERDATA
			  ,0 AS PICKALIAS
		FROM CONFIG WHERE CONFIG_OPTION LIKE 'PARA%CAPTION%' and LEN(CONFIG_OPTION)=13
		UNION ALL
		SELECT ATTRIBUTE_NAME AS DISPLAYNAME,'ATTR_VALUE' AS SOURCENAME,ATTRIBUTE_NAME AS COLUMNNAME
			  ,0 AS COLUMNPRINTLENGTH,0 AS DISPLAYORDER,0 AS ISVISIBLE,0 AS ISMASTERDATA
			  ,0 AS PICKALIAS
		FROM ATTRM WHERE ATTRIBUTE_TYPE=1 AND ISNULL(ATTRIBUTE_NAME,'')<>''
	)B ON A.COLUMNNAME=B.COLUMNNAME	
  ---FOR FOOTER 
    SELECT A.*
	FROM PRINTDETAIL A
	JOIN PRINTMASTER B ON A.PRINTID =B.PRINTID 
	WHERE (@CXNTYPE= '' OR B.XNTYPE=@CXNTYPE)
    AND  (@CPRINTID= '' OR A.PRINTID=@CPRINTID)
    AND  ISDISPLAY =1
    
    SELECT A.*
	FROM PRINTDETAIL A
	JOIN PRINTMASTER B ON A.PRINTID =B.PRINTID 
	WHERE (@CXNTYPE= '' OR B.XNTYPE=@CXNTYPE)
    AND  (@CPRINTID= '' OR A.PRINTID=@CPRINTID)
    AND  ISDISPLAY =2
    GOTO ENDPROC
   DOCUMENTREPORT:
    SELECT * FROM PRINTHEADER WHERE REF_ROW_ID=@CROW_ID
  GOTO ENDPROC	
  --IF ISNULL(@CROW_ID,'')<>''
   
   

  ENDPROC:
END
--END OF PROCEDURE - SP3SGETPRINTFORMAT
