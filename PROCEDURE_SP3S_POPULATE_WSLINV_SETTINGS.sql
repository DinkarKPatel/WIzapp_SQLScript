CREATE PROCEDURE SP3S_POPULATE_WSLINV_SETTINGS
@NSPID int,
@CCURLOCID VARCHAR(5),
@CTARGETLOCID VARCHAR(5),
@CPARTYACCODE CHAR(10),
@DINVDT DATETIME,
@CTERMSCODE VARCHAR(20)='',
@NBILLDISCOUNTPCT NUMERIC (10,4),  
@NINVMODE INT,
@NINVTYPE INT=0,
@NXFERTYPE INT=0,
@NMRPWSPMODE INT=0,
@CLOGINBINID VARCHAR(5)='',
@CUSERCODE CHAR(7)='',
@NBILLLEVELTAXMETHOD INT=0 ,
@BDONOTCALEXCISE BIT =0,
@NLOTPRICE INT=0,
@NITEMTYPE NUMERIC(1,0)=1,
@NMEMOTYPE NUMERIC(1,0)=1
--WITH ENCRYPTION
AS
BEGIN
    DECLARE @CERRMSG VARCHAR(MAX),@CARTICLE_CODE VARCHAR(100),@CPARA1_CODE VARCHAR(100),@CPARA2_CODE VARCHAR(100),
    @CPARA3_CODE VARCHAR(100),@CPARA4_CODE VARCHAR(100),@CPARA5_CODE VARCHAR(100),@CPARA6_CODE VARCHAR(100),
    @CMEMO_ID VARCHAR(100),@CCMD NVARCHAR(MAX),@NBASE_PRICE NUMERIC(18,2),@NCAL_MODE INT,
    @NDISCOUNT_PERCENTAGE NUMERIC(18,2),@NRATE NUMERIC(18,2),@NDISCOUNT_AMOUNT NUMERIC(18,2),
    @NNETRATE NUMERIC(18,2),@GIVE_CREDIT_VAT INT,@VAT_PER NUMERIC(18,2),@CMEMO_DT DATETIME,
    @VAT_AMOUNT NUMERIC(18,2),@PARTY_FINAL_MARGIN NUMERIC(18,2),@GROSS_SALE NUMERIC(18,2),
    @VAT_EX_AMOUNT NUMERIC(18,2),@CSTATECODE CHAR(7),@CFILTER_EXP VARCHAR(MAX) ,@CPARTYSTATECODE CHAR(7),
	@CLOCSSTMEMOID VARCHAR(40),@NTERMSDISCPER NUMERIC(10,2),@BCREDITPURCHASETAX BIT,@BCREDITOUTPUTVAT BIT,
	@CPARTYLOCSSTMEMOID VARCHAR(40),@CENABLEEXCISEDUTY VARCHAR(2),@CSTEP VARCHAR(3),@CERRORMSG VARCHAR(MAX),
	@NEXCISEEDUCESSPCT NUMERIC(6,2),@NEXCISEHEDUCESSPCT NUMERIC(6,2),@CCONSIDERNETEXCISEMRPVAL VARCHAR(2),
	@CEXCISEDUTYPCT VARCHAR(10),@CEXCISEACCPCT VARCHAR(10),@CMINEXCISABLEMRP VARCHAR(10),@NCUSTOMRATETYPE INT,
	@NMINEXCISABLEMRP NUMERIC(10,2),@NEXCISEACCPCT NUMERIC(7,3),@NEXCISEDUTYPCT NUMERIC(7,3),@CDNDTAXINEXCISEMRP VARCHAR(2),
	@BENFORCEBILLINGRULES BIT,@NLOCCUSTOMRATETYPE INT,@NLOCDEFAULTRATETYPE INT,@NDEFAULTRATETYPE INT,
	@BCUSTOMPROCEXISTS BIT,@CCUSTOMPROCNAME VARCHAR(200),@CPARTYRATEMEMOID VARCHAR(40),@NPARTYDISCPCT NUMERIC(7,3),
	@NRATEPICKINGMETHOD INT,@BPARTYRATEFILTERAPPLICABLE BIT,@BGSTBILL BIT,@CGSTCUTOFFDATE VARCHAR(20),@CGSTSTATECODE VARCHAR(5),
	@BGROUPINV BIT
			               
	BEGIN TRY
	    
	    SET @CSTEP=10
	               
		SELECT @CFILTER_EXP='',@CERRORMSG=''
		
		

		SET @BGSTBILL=0
		
		SELECT TOP 1  @CGSTCUTOFFDATE=VALUE FROM CONFIG WHERE CONFIG_OPTION='GST_CUT_OFF_DATE'
		IF ISNULL(@CGSTCUTOFFDATE,'')<>''
		BEGIN
			IF @DINVDT>=CONVERT(DATE,@CGSTCUTOFFDATE)
				SET @BGSTBILL=1
		END
		


		--SELECT TOP 1 MEMO_ID,MST_BASE_PRICE,CUSTOM_RATE_TYPE,ISNULL(MST_VALUE,0)
		--FROM PARTY_RATE_MST WHERE AC_CODE=@CPARTYACCODE AND SOURCE_DEPT_ID=@CCURLOCID
				
		--SELECT TOP 1 MEMO_ID,MST_BASE_PRICE,CUSTOM_RATE_TYPE,ISNULL(MST_VALUE,0)
		--FROM PARTY_RATE_MST WHERE AC_CODE=@CPARTYACCODE AND LOC_APPLICABLE_MODE<>2
				
								
		SET @CSTEP=20	
		SELECT TOP 1 @CSTATECODE=STATE_CODE FROM LOCATION A 
		JOIN AREA B ON A.AREA_CODE=B.AREA_CODE
		JOIN CITY C ON C.CITY_CODE=B.CITY_CODE
		WHERE A.DEPT_ID=@CCURLOCID
		
		SELECT TOP 1 @CLOCSSTMEMOID=MEMO_ID FROM LOCSST_MST WHERE STATE_CODE=@CSTATECODE AND FROM_DT<=@DINVDT
		ORDER BY FROM_DT DESC
		
		IF @NINVMODE=2
			SELECT TOP 1 @CPARTYSTATECODE=STATE_CODE,@CGSTSTATECODE=ISNULL(LEFT(A.LOC_GST_NO,2),'') FROM LOCATION A 
			JOIN AREA B ON A.AREA_CODE=B.AREA_CODE
			JOIN CITY C ON C.CITY_CODE=B.CITY_CODE
			WHERE A.DEPT_ID=@CTARGETLOCID
		ELSE
			SELECT TOP 1 @CPARTYSTATECODE=STATE_CODE,@CGSTSTATECODE=ISNULL(LEFT(A.AC_GST_NO,2),'') FROM LMP01106 A 
			JOIN AREA B ON A.AREA_CODE=B.AREA_CODE
			JOIN CITY C ON C.CITY_CODE=B.CITY_CODE
			WHERE A.AC_CODE=@CPARTYACCODE
				
		SET @CSTEP=30
		SELECT TOP 1 @CPARTYLOCSSTMEMOID=MEMO_ID FROM LOCSST_MST WHERE STATE_CODE=@CPARTYSTATECODE AND FROM_DT<=@DINVDT
		ORDER BY FROM_DT DESC
			
		SELECT @NTERMSDISCPER = ISNULL(GROSS_MARGIN,0),@BCREDITPURCHASETAX=REIMUBURSE_PURCHASE_TAX,@BCREDITOUTPUTVAT=REIMUBURSE_OUTPUT_VAT 
		FROM LEDGER_TERMS WHERE TERMS_CODE  = @CTERMSCODE                     
	    
	    SET @CSTEP=40  
		SELECT TOP 1 @CENABLEEXCISEDUTY=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_EXCISE_DUTY'  
	  	PRINT 'CAL EXCISE-1'  
				
		
		SET @CSTEP=50  
		SELECT @NEXCISEEDUCESSPCT=0,@NEXCISEHEDUCESSPCT=0    
		
		SELECT TOP 1  @CMINEXCISABLEMRP=VALUE FROM CONFIG WHERE  CONFIG_OPTION='MINIMUM_MRP_FOR_EXCISE'  
		SELECT TOP 1  @CEXCISEACCPCT=VALUE FROM CONFIG WHERE  CONFIG_OPTION='EXCISE_ACCESSIBLE_PERCENTAGE'   
		SELECT TOP 1  @CEXCISEDUTYPCT=VALUE FROM CONFIG WHERE CONFIG_OPTION='EXCISE_DUTY_PERCENTAGE'  

			
		SET @CSTEP=60     
		IF ISNULL(@CMINEXCISABLEMRP,'') IN ('','0')  
			SET @NMINEXCISABLEMRP=1000  
		ELSE  
			SET @NMINEXCISABLEMRP=@CMINEXCISABLEMRP  
		
		SET @CSTEP=70            
		IF ISNULL(@CEXCISEACCPCT,'') IN ('','0')  
			SET @NEXCISEACCPCT=60  
		ELSE  
			SET @NEXCISEACCPCT=@CEXCISEACCPCT  
		
		SET @CSTEP=80     
		IF ISNULL(@CEXCISEDUTYPCT,'') IN ('','0')  
			SET @NEXCISEDUTYPCT=2  
		ELSE  
			SET @NEXCISEDUTYPCT=@CEXCISEDUTYPCT  
		
		SET @CSTEP=90        
		  
		SELECT TOP 1 @CCONSIDERNETEXCISEMRPVAL=VALUE FROM CONFIG WHERE CONFIG_OPTION='NETEXCISEMRP_EXCISE_CALC'  
		  
		SET @CCONSIDERNETEXCISEMRPVAL=ISNULL(@CCONSIDERNETEXCISEMRPVAL,'')  
		
		SET @CSTEP=100    		
		
		SET @BPARTYRATEFILTERAPPLICABLE=0

		  
	  SELECT @BGROUPINV=(CASE WHEN ISNULL(@CTARGETLOCID,'')<>'' THEN 1 ELSE 0 END)

	  IF ISNULL(@NINVMODE,0)=1
	  SET @BGROUPINV=0
	  
	  declare @cGroupInv varchar(2)
	  set @cGroupInv=(case when @BGROUPINV=0 then '0' else '1' end)

	  print 'check group inv:'+ @cGroupinv+'-'+str(@nInvmode)+'-'+@CCURLOCID
	  
	  IF @BGROUPINV=0			    
	  BEGIN
		SELECT TOP 1 @CPARTYRATEMEMOID=ISNULL(PARTY_RATE_MEMO_ID,'') FROM LMP01106 A
			  WHERE  A.AC_CODE=@CPARTYACCODE 
			  --ORDER BY A.LAST_UPDATE DESC
	  END
	  ELSE
	  BEGIN
		  
		   IF EXISTS (SELECT TOP 1 'U' FROM location  A (NOLOCK) WHERE  A.dept_id=@CCURLOCID and billingRuleApplicableMode=2)
		   BEGIN
		       
		          SELECT TOP 1 @CPARTYRATEMEMOID=ISNULL(PARTY_RATE_MEMO_ID,'') FROM LOC_BILLING_RULES_ALLLOC A (NOLOCK)
				  WHERE  A.SOURCE_DEPT_ID=@CCURLOCID
		   
		   END
		   ELSE
		   BEGIN
		  
			   SELECT TOP 1 @CPARTYRATEMEMOID=ISNULL(PARTY_RATE_MEMO_ID,'') FROM LOC_BILLING_RULES A (NOLOCK)
					  WHERE  A.SOURCE_DEPT_ID=@CCURLOCID AND A.TARGET_DEPT_ID=@CTARGETLOCID 
		   END
		  --SELECT TOP 1 @CPARTYRATEMEMOID=A.MEMO_ID FROM PARTY_RATE_MST A
		  --JOIN PARTY_RATE_LOC B ON A.MEMO_ID=B.MEMO_ID
		  --JOIN PARTY_RATE_LOC C ON A.MEMO_ID=C.MEMO_ID
		  --WHERE PARTY_RATE_TYPE=2 AND B.DEPT_ID=@CCURLOCID AND B.SOURCE_TARGET_MODE=1
		  --AND C.DEPT_ID=@CTARGETLOCID AND C.SOURCE_TARGET_MODE=2
		  --ORDER BY A.LAST_UPDATE DESC
		  
		  --IF @CPARTYRATEMEMOID IS NULL
			 -- SELECT TOP 1 @CPARTYRATEMEMOID=A.MEMO_ID FROM PARTY_RATE_MST A
			 -- JOIN PARTY_RATE_LOC B ON A.MEMO_ID=B.MEMO_ID
			 -- WHERE PARTY_RATE_TYPE=2 AND B.SOURCE_TARGET_MODE=2 
			 -- AND A.LOC_APPLICABLE_MODE=1 AND B.DEPT_ID=@CTARGETLOCID
			 -- ORDER BY A.LAST_UPDATE DESC
		  
		  --IF @CPARTYRATEMEMOID IS NULL	
			 -- SELECT TOP 1 @CPARTYRATEMEMOID=A.MEMO_ID FROM PARTY_RATE_MST A
			 -- JOIN PARTY_RATE_LOC B ON A.MEMO_ID=B.MEMO_ID
			 -- WHERE PARTY_RATE_TYPE=2 AND B.DEPT_ID=@CCURLOCID AND B.SOURCE_TARGET_MODE=1 
			 -- AND A.TARGET_LOC_APPLICABLE_MODE=1 
			 -- ORDER BY A.LAST_UPDATE DESC			  

		  --IF @CPARTYRATEMEMOID IS NULL		  			  		  
			 -- SELECT TOP 1 @CPARTYRATEMEMOID=A.MEMO_ID FROM PARTY_RATE_MST A
			 -- WHERE PARTY_RATE_TYPE=2 AND A.LOC_APPLICABLE_MODE=1  AND A.TARGET_LOC_APPLICABLE_MODE=1 
			 -- ORDER BY A.LAST_UPDATE DESC	
			 
			 		  
	  END	  	  	
	
  	 SELECT TOP 1 @NDEFAULTRATETYPE=MST_BASE_PRICE,@NCUSTOMRATETYPE=CUSTOM_RATE_TYPE,
  	 @NPARTYDISCPCT=ISNULL(MST_VALUE,0) FROM PARTY_RATE_MST WHERE MEMO_ID=@CPARTYRATEMEMOID


	SET @BCUSTOMPROCEXISTS=0
	IF ISNULL(@NCUSTOMRATETYPE,0)>0
	BEGIN
		SELECT TOP 1 @CCUSTOMPROCNAME=NAME FROM SYSOBJECTS(NOLOCK) WHERE NAME='SP3S_GETINVRATE_CUSTOM'
		
		IF @CCUSTOMPROCNAME IS NOT NULL
			SET @BCUSTOMPROCEXISTS=1
	END			
	IF EXISTS(SELECT TOP 1 MEMO_ID FROM PARTY_RATE_DET WHERE MEMO_ID=@CPARTYRATEMEMOID AND
		(ARTICLE_CODE NOT IN ('','00000000') OR PARA1_CODE NOT IN ('','0000000') OR PARA2_CODE NOT IN ('','0000000')
		OR PARA3_CODE NOT IN ('','0000000') OR PARA4_CODE NOT IN ('','0000000')
		OR PARA5_CODE NOT IN ('','0000000') OR PARA6_CODE NOT IN ('','0000000')
		OR SECTION_CODE NOT IN ('','0000000') OR SUB_SECTION_CODE NOT IN ('','0000000')
		OR FROM_MRP <> 0 OR TO_MRP <> 0))
		SET @BPARTYRATEFILTERAPPLICABLE=1
		
					
WSL_SETTINGS:
		
		SET @CSTEP=110
		
		PRINT 'CALL INSERTION OF WSLINVSETTINGS'
		DELETE FROM WSL_INV_SETTINGS WHERE SP_ID=@NSPID
		SET @CSTEP=120
		INSERT WSL_INV_SETTINGS	( PARTY_RATE_MEMO_ID,SP_ID,LOCATION_ID, TARGET_LOCATION_ID, AC_CODE, INV_DT, TERMS_CODE,
		PARTYRATE_FILTER_APPLICABLE, LOCSST_MEMO_ID, TERMS_DISC_PCT, PARTY_LOCSST_MEMO_ID,LOCAL_STATE_CODE, PARTY_STATE_CODE, 
		REIMUBURSE_PURCHASE_TAX, REIMUBURSE_OUTPUT_VAT, ENABLE_EXCISE_DUTY, BILL_DISC_PCT, INV_TYPE, XFER_TYPE,
		MIN_EXCISABLE_MRP, EXCISE_ACCESSIBLE_PERCENTAGE, EXCISE_DUTY_PERCENTAGE, EXCISE_EDU_CESS_PERCENTAGE, EXCISE_HEDU_CESS_PERCENTAGE,
		DEFAULT_RATE_TYPE,CUSTOM_RATE_TYPE,MRP_WSP_MODE,CUSTOM_PROC_EXISTS,USER_CODE,LOGIN_BIN_ID,PARTY_DISCOUNT_PCT,BILL_LEVEL_TAX_METHOD,DONOT_CALC_EXCISE,LOT_PRICE,GST_BILL,XN_ITEM_TYPE,memo_type )
		SELECT @CPARTYRATEMEMOID AS PARTY_RATE_MEMO_ID,@NSPID AS SP_ID,@CCURLOCID AS LOCATION_ID,@CTARGETLOCID AS TARGET_LOCATION_ID,@CPARTYACCODE AS AC_CODE,
		@DINVDT AS INV_DT,@CTERMSCODE AS TERMS_CODE,@BPARTYRATEFILTERAPPLICABLE AS PARTYRATE_FILTER_APPLICABLE,@CLOCSSTMEMOID AS LOCSST_MEMO_ID,@NTERMSDISCPER AS TERMS_DISC_PCT,
		@CPARTYLOCSSTMEMOID AS PARTY_LOCSST_MEMO_ID,@CSTATECODE AS LOCAL_STATE_CODE,
		(CASE WHEN @BGSTBILL=1 THEN @CGSTSTATECODE ELSE  @CPARTYSTATECODE END) AS PARTY_STATE_CODE,
		@BCREDITPURCHASETAX AS REIMUBURSE_PURCHASE_TAX,@BCREDITOUTPUTVAT AS REIMUBURSE_OUTPUT_VAT,
		(CASE WHEN ISNULL(@CENABLEEXCISEDUTY,'')='1' AND @BGSTBILL=0 THEN 1 ELSE 0 END) AS ENABLE_EXCISE_DUTY,@NBILLDISCOUNTPCT AS BILL_DISC_PCT,  
		@NINVTYPE AS INV_TYPE,@NXFERTYPE AS XFER_TYPE,@NMINEXCISABLEMRP AS MIN_EXCISABLE_MRP,@NEXCISEACCPCT AS EXCISE_ACCESSIBLE_PERCENTAGE,
		@NEXCISEDUTYPCT AS EXCISE_DUTY_PERCENTAGE,@NEXCISEEDUCESSPCT AS EXCISE_EDU_CESS_PERCENTAGE,@NEXCISEHEDUCESSPCT AS EXCISE_HEDU_CESS_PERCENTAGE,
		@NDEFAULTRATETYPE AS DEFAULT_RATE_TYPE,@NCUSTOMRATETYPE AS CUSTOM_RATE_TYPE,@NMRPWSPMODE AS MRP_WSP_MODE,
		@BCUSTOMPROCEXISTS AS CUSTOM_PROC_EXISTS,@CUSERCODE AS USER_CODE,@CLOGINBINID AS LOGIN_BIN_ID,@NPARTYDISCPCT AS PARTY_DISCOUNT_PCT,
		@NBILLLEVELTAXMETHOD AS BILL_LEVEL_TAX_METHOD,@BDONOTCALEXCISE AS DONOT_CALC_EXCISE,ISNULL(@NLOTPRICE,0) AS LOT_PRICE,@BGSTBILL AS GST_BILL,@NITEMTYPE AS XN_ITEM_TYPE,
		@NMEMOTYPE memo_type 		
		
		GOTO END_PROC	
	END TRY
	
	BEGIN CATCH
		SET @CERRORMSG='PROCEDURE SP3S_POPULATE_WSLINV_SETTINGS : STEP #'+@CSTEP+' '+ERROR_MESSAGE()
		
		GOTO END_PROC 
	END CATCH
END_PROC:
	
	SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
END


