CREATE PROCEDURE SP3S_PENDINGORDER_FOR_PL
(
	@CWHERE NVARCHAR(MAX)
)
AS
BEGIN

	DECLARE @CSIZE VARCHAR(MAX),@CSIZE_SUM VARCHAR(MAX),@CSIZE_SUM_TOTAL VARCHAR(MAX)
	,@CCMD NVARCHAR(MAX),@CSIZE_ZERO NVARCHAR(MAX)
	PRINT @CWHERE
	SET @CWHERE=REPLACE(@CWHERE,'`','''')
	IF OBJECT_ID('TEMPDB..#PENDINGBUYERORDER','U') IS NOT NULL
		DROP TABLE #PENDINGBUYERORDER

	IF OBJECT_ID('TEMPDB..##PENDINGORDER_PIVOT','U') IS NOT NULL
		DROP TABLE ##PENDINGORDER_PIVOT


	CREATE TABLE #PENDINGBUYERORDER
	(
		ORDER_ID		VARCHAR(MAX),
		CUSTOMER_NAME	VARCHAR(MAX),
		ORDER_DT		DATETIME,
		ORDER_NO		VARCHAR(MAX),
		ROW_ID			VARCHAR(MAX),
		ARTICLE_NO		VARCHAR(MAX),
		ARTICLE_CODE	VARCHAR(MAX),
		PARA1_CODE		VARCHAR(MAX),
		PARA2_CODE		VARCHAR(MAX),
		PARA1_NAME		VARCHAR(MAX),
		PARA2_NAME		VARCHAR(MAX),
		QUANTITY		NUMERIC(14,2)
	)		
	BEGIN TRY

		SET @CCMD=N'
		SELECT DISTINCT A.ORDER_ID,LMV01106.AC_NAME AS CUSTOMER_NAME,BUYER_ORDER_MST.ORDER_DT,BUYER_ORDER_MST.ORDER_NO,
		A.ROW_ID,ARTICLE_NO,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,PARA1.PARA1_NAME,PARA2.PARA2_NAME,
		(CASE WHEN A.QUANTITY-ISNULL(B.QUANTITY,0) <=0 THEN NULL ELSE A.QUANTITY-ISNULL(B.QUANTITY,0) END )AS QUANTITY
		FROM BUYER_ORDER_DET A 
		LEFT OUTER JOIN
		(
			SELECT ORD_ROW_ID,SUM(QUANTITY) AS QUANTITY 
			FROM PLD01106  
			JOIN PLM01106 ON PLD01106.MEMO_ID = PLM01106.MEMO_ID
			WHERE ISNULL(PLM01106.CANCELLED,0) = 0  AND ISNULL(ORD_ROW_ID,'''') <> '''' 
			GROUP BY ORD_ROW_ID
		) B ON A.ROW_ID = B.ORD_ROW_ID
		JOIN BUYER_ORDER_MST (NOLOCK) ON A.ORDER_ID = BUYER_ORDER_MST.ORDER_ID
		JOIN LMV01106 (NOLOCK) ON BUYER_ORDER_MST.AC_CODE = LMV01106.AC_CODE
		JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE = A.ARTICLE_CODE
		JOIN PARA1 (NOLOCK) ON PARA1.PARA1_CODE = A.PARA1_CODE
		JOIN PARA2 (NOLOCK) ON PARA2.PARA2_CODE = A.PARA2_CODE
		JOIN PARA3 (NOLOCK) ON PARA3.PARA3_CODE = ARTICLE.PARA3_CODE
		JOIN PARA4 (NOLOCK) ON PARA4.PARA4_CODE = ARTICLE.PARA4_CODE
		JOIN PARA5 (NOLOCK) ON PARA5.PARA5_CODE	= ARTICLE.PARA5_CODE
		JOIN PARA6 (NOLOCK) ON PARA6.PARA6_CODE = ARTICLE.PARA6_CODE
		JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE = ARTICLE.SUB_SECTION_CODE
		JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE = SECTIOND.SECTION_CODE
		JOIN UOM (NOLOCK) ON UOM.UOM_CODE = ARTICLE.UOM_CODE
		LEFT OUTER JOIN
		(
			SELECT ARTICLE_CODE,PARA1_CODE,PARA2_CODE,SUM(QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK
			FROM SKU A
			JOIN PMT01106 B ON B.PRODUCT_CODE=A.PRODUCT_CODE
			JOIN BIN (NOLOCK) ON B.BIN_ID=BIN.BIN_ID
			WHERE ISNULL(BIN.stk_available_trn,0)=1
			GROUP BY ARTICLE_CODE,PARA1_CODE,PARA2_CODE--,PARA3_CODE,PARA4_CODE,PARA5_CODE,PARA6_CODE
			--,PARA3_CODE,PARA4_CODE,PARA5_CODE,PARA6_CODE
		)STK ON STK.ARTICLE_CODE=ARTICLE.ARTICLE_CODE AND STK.PARA1_CODE=PARA1.PARA1_CODE AND STK.PARA2_CODE=PARA2.PARA2_CODE 
		WHERE  ISNULL(STK.QUANTITY_IN_STOCK,0)>0 AND BUYER_ORDER_MST.MEMO_TYPE=2 AND (A.QUANTITY-ISNULL(B.QUANTITY,0) > 0 OR  B.ORD_ROW_ID IS NULL) 
		AND BUYER_ORDER_MST.CANCELLED = 0  AND ISNULL(BUYER_ORDER_MST.Short_close,0) = 0 AND '
		+ 
		(CASE WHEN ISNULL(@CWHERE,'')='' THEN ' 1=1 ' ELSE ISNULL(@CWHERE,'') END)
		
		PRINT 'STEP 1 :'+ @CCMD
		
		INSERT INTO #PENDINGBUYERORDER
		EXEC SP_EXECUTESQL @CCMD

		IF (0= @@ROWCOUNT)
		BEGIN
			SELECT CONVERT(BIT,0) AS BCHK,ORDER_ID,CUSTOMER_NAME,CONVERT(VARCHAR(20),ORDER_DT,105) AS ORDER_DT,ORDER_NO,ROW_ID,ARTICLE_NO,ARTICLE_CODE,PARA1_CODE,PARA1_NAME FROM #PENDINGBUYERORDER
			RETURN
		END

		SELECT  
		@CSIZE=ISNULL(@CSIZE,'')+(CASE WHEN ISNULL(@CSIZE,'')='' THEN '' ELSE ',' END ) +'['+A.PARA2_NAME+']',
		@CSIZE_SUM=ISNULL(@CSIZE_SUM,'')+(CASE WHEN ISNULL(@CSIZE_SUM,'')='' THEN '' ELSE ',' END ) +'SUM(['+PARA2_NAME+']) AS ['+A.PARA2_NAME+']',
		@CSIZE_SUM_TOTAL=ISNULL(@CSIZE_SUM_TOTAL,'')+(CASE WHEN ISNULL(@CSIZE_SUM_TOTAL,'')='' THEN '' ELSE '+' END ) +'ISNULL(SUM(['+A.PARA2_NAME+']),0)',
		@CSIZE_ZERO=ISNULL(@CSIZE_ZERO,'')+(CASE WHEN ISNULL(@CSIZE_ZERO,'')='' THEN '' ELSE ',' END ) +'CAST(0 AS NUMERIC(14,2)) AS ['+A.PARA2_NAME+']'
		FROM
		(
			SELECT A.PARA2_NAME,B.PARA2_ORDER
			FROM #PENDINGBUYERORDER A
			JOIN PARA2 B ON B.PARA2_CODE=A.PARA2_CODE
			GROUP BY A.PARA2_NAME,B.PARA2_ORDER
		)A
		ORDER BY A.PARA2_ORDER
		
		
		--SELECT @CSIZE ,@CSIZE_SUM,@CSIZE_SUM_TOTAL

		SET @CCMD=N'
		SELECT ORDER_ID,CUSTOMER_NAME,ORDER_DT,ORDER_NO,ARTICLE_NO,ARTICLE_CODE,PARA1_CODE,PARA1_NAME,'+@CSIZE+
		'INTO ##PENDINGORDER_PIVOT
		FROM 
		(
			SELECT * FROM #PENDINGBUYERORDER
		)X
		PIVOT
		(
			SUM(QUANTITY)
			FOR PARA2_NAME IN ('+@CSIZE+')
		)PVT'

		PRINT 'STEP 2 :'+ @CCMD
		
		EXEC SP_EXECUTESQL @CCMD
		
			
		SET @CCMD=N'
		SELECT CONVERT(BIT,0) AS BCHK,ORDER_ID,CUSTOMER_NAME,CONVERT(VARCHAR(20),ORDER_DT,105) AS ORDER_DT,ORDER_NO,ARTICLE_NO,ARTICLE_CODE,PARA1_CODE,PARA1_NAME,'+
		@CSIZE_SUM+','+@CSIZE_SUM_TOTAL +' AS TOTAL,CONVERT(INT,0) AS BEDIT,''ORD QTY'' AS QTY_MSG,CUSTOMER_NAME AS CUSTOMER_NAME_DISP
		FROM ##PENDINGORDER_PIVOT
		GROUP BY ORDER_ID,CUSTOMER_NAME,ORDER_DT,ORDER_NO,ARTICLE_NO,ARTICLE_CODE,PARA1_CODE,PARA1_NAME
		UNION
		SELECT CONVERT(BIT,0) AS BCHK,ORDER_ID,'''' AS CUSTOMER_NAME,'''' AS ORDER_DT,'''' AS ORDER_NO,'''' AS ARTICLE_NO,ARTICLE_CODE,PARA1_CODE,'''' AS PARA1_NAME,'+
		@CSIZE_ZERO+',CAST(0 AS NUMERIC(14,2)) AS TOTAL,CONVERT(INT,1) AS BEDIT,''PL QTY'' AS QTY_MSG,CUSTOMER_NAME AS CUSTOMER_NAME_DISP
		FROM ##PENDINGORDER_PIVOT
		GROUP BY ORDER_ID,CUSTOMER_NAME,ARTICLE_CODE,PARA1_CODE
		UNION
		SELECT CONVERT(BIT,0) AS BCHK,''ZZZZZZZZZZZZ''ORDER_ID,'''' AS CUSTOMER_NAME,'''' AS ORDER_DT,'''' AS ORDER_NO,'''' AS ARTICLE_NO,ARTICLE_CODE,PARA1_CODE,'''' AS PARA1_NAME,'+
		@CSIZE_ZERO+',CAST(0 AS NUMERIC(14,2)) AS TOTAL,CONVERT(INT,-1) AS BEDIT,''TOTAL PL QTY'' AS QTY_MSG,''ZZZZZZZZZZZZ'' AS CUSTOMER_NAME_DISP
		FROM ##PENDINGORDER_PIVOT
		GROUP BY ORDER_ID,CUSTOMER_NAME,ARTICLE_CODE,PARA1_CODE
		ORDER BY CUSTOMER_NAME_DISP,ORDER_ID,ARTICLE_CODE,PARA1_CODE, BEDIT
		'
		PRINT 'STEP 3 :'+ @CCMD
		
		EXEC SP_EXECUTESQL @CCMD
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
	END CATCH
END
