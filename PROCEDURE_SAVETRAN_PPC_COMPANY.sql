CREATE PROCEDURE SAVETRAN_PPC_COMPANY  
(  
  @NUPDATEMODE NUMERIC(1,0)/*1: ADD MODE, 2 : EDIT MODE */,    
  @CSPID   VARCHAR(10),  
  @CPARA_CODE VARCHAR(10)=''  
)  
----WITH ENCRYPTION  
AS   
BEGIN  
DECLARE @CERRMSG VARCHAR(500),@CSTEP VARCHAR(10)  
    ,@CCMD NVARCHAR(MAX),@CNEWCOMPANY_CODE VARCHAR(10),@BREFEXISTS BIT  
  
DECLARE @TOUTPUT TABLE(COMPANY_CODE VARCHAR(50),ERRMSG VARCHAR(500))  
  
---LIST OF TABLES TO SAVE  
DECLARE @TCOMPANY VARCHAR(100)  
  
  
SET @TCOMPANY='MST_COMPANY_UPLOAD'  
  
BEGIN TRY  
BEGIN TRANSACTION  
      SET @CSTEP=10  
   --VALIDATIONS ON COMPANY  
   /*  
    ** CHECK COMPANY_NAME, IT SHOULD NOT BE BLANK  
    ** CHECK COMPANY_NAME, IT SHOULD BE UNIQUE  
    ** ALIAS CAN BE BLANK OR SHOULD BE UNIQUE  
    ** IT SHOULD HAVE VALID UOM,SUBSECTION AND SECTION  
   */  
   --COMPANY NAME CANNOT BE BLANK.  
   SET @CSTEP=60  
   --VALIDATION FOR BLANK COMPANY_NAME  
   SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TCOMPANY+' WHERE ISNULL(COMPANY_NAME,'''')='''' AND 
   SP_ID='''+LTRIM(RTRIM(STR(@CSPID)))+''')  
             SET @CERRMSG=''COMPANY NAME CANNOT BE BLANK.'' '  
   PRINT @CCMD               
   EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT  
     
   IF ISNULL(@CERRMSG,'')<>''  
    GOTO END_PROC  
     
   SET @CSTEP=70  
   --VALIDATION FOR UNIQUE COMPANY_NAME  
   SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TCOMPANY+' A JOIN COMPANY B ON A.COMPANY_NAME=B.COMPANY_NAME  
          WHERE A.COMPANY_CODE<>B.COMPANY_CODE AND A.SP_ID='''+LTRIM(RTRIM(STR(@CSPID)))+''')  
             SET @CERRMSG=''COMPANY NAME ALREADY EXISTS.'' '  
   PRINT @CCMD  
   EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT  
   IF ISNULL(@CERRMSG,'')<>''  
    GOTO END_PROC  
      
 IF @NUPDATEMODE=1 --NEW COMPANY BEING ADDED  
 BEGIN  
   PRINT 'NEW COMPANY BEING ADDED'  
     
   SET @CSTEP=80  
   LBL_GENARTKEY:  
   EXEC GETNEXTKEY @CTABLENAME='COMPANY'  
       ,@CCOLNAME='COMPANY_CODE'  
       ,@NWIDTH='2'  
       ,@CPREFIX=''  
       ,@NLZEROS=1  
       ,@CFINYEAR=''  
       ,@NROWCOUNT=0  
       ,@CNEWKEYVAL=@CNEWCOMPANY_CODE OUTPUT   
     
   IF ISNULL(@CNEWCOMPANY_CODE,'')=''   
   BEGIN   
    SET @CERRMSG='ERROR GENERATING COMPANY CODE.'  
    GOTO END_PROC  
   END   
     
   SET @CSTEP=90      
   IF EXISTS(SELECT TOP 1 'U' FROM COMPANY WHERE COMPANY_CODE=@CNEWCOMPANY_CODE)  
    GOTO LBL_GENARTKEY  
     
   ---UPDATE THE COMPANY_CODE IN ALL TEMP TABLES  
   SET @CSTEP=100  
   ---UPDATING COMPANY_CODE IN COMPANY  
   SET @CCMD=N'UPDATE '+@TCOMPANY+' SET COMPANY_CODE='''+@CNEWCOMPANY_CODE+''' WHERE SP_ID='''+ LTRIM(RTRIM(@CSPID))+''''  
   PRINT @CCMD  
   EXEC SP_EXECUTESQL @CCMD 
   
    ---UPDATE THE AREA_CODE IN ALL TEMP TABLES WHEN AREA CODE IS BLANK 
   SET @CSTEP=105  
   ---UPDATING AREA_CODE IN COMPANY  
   SET @CCMD=N'UPDATE '+@TCOMPANY+' SET AREA_CODE=''0000000'' WHERE  ISNULL(AREA_CODE,'''')='''' AND SP_ID='''+ LTRIM(RTRIM(@CSPID))+''''  
   PRINT @CCMD  
   EXEC SP_EXECUTESQL @CCMD  
 
 END  
 ELSE  
 BEGIN --CASE OF EDIT   
      PRINT 'COMPANY BEING UPDATED'  
     
   --SET @CSTEP=110  
   -----UPDATING LAST_UPDATE IN COMPANY  
   --SET @CCMD=N'UPDATE '+@TCOMPANY+' SET LAST_UPDATE=GETDATE()'  
   --PRINT @CCMD  
   --EXEC SP_EXECUTESQL @CCMD  
   
    SET @CSTEP=110  
   ---UPDATING AREA_CODE IN COMPANY  
   SET @CCMD=N'UPDATE '+@TCOMPANY+' SET AREA_CODE=''0000000'' WHERE  ISNULL(AREA_CODE,'''')='''' AND SP_ID='''+ LTRIM(RTRIM(@CSPID))+''''  
   PRINT @CCMD  
   EXEC SP_EXECUTESQL @CCMD  
  
    
   SET @CSTEP=120  
   ---GET THE COMPANY_CODE OF MODIFIED COMPANY  
   SET @CCMD=N'SELECT @CNEWCOMPANY_CODE=COMPANY_CODE FROM '+@TCOMPANY  
   PRINT @CCMD  
   EXEC SP_EXECUTESQL @CCMD,N'@CNEWCOMPANY_CODE VARCHAR(10) OUTPUT',@CNEWCOMPANY_CODE OUTPUT  
 END  
   
  DECLARE @FILTER VARCHAR(MAX)  
     SET @FILTER=' B.SP_ID='''+LTRIM(RTRIM(STR(@CSPID)))+''''  
    
   
     
 SET @CSTEP=130  
 --UPDATING COMPANY MASTER  
 EXEC UPDATEMASTERXN   
    @CSOURCEDB=''  
   ,@CSOURCETABLE=@TCOMPANY  
   ,@CDESTDB=''  
   ,@CDESTTABLE='COMPANY'  
   ,@CKEYFIELD1='COMPANY_CODE'  
   ,@CKEYFIELD2=''  
   ,@CKEYFIELD3=''  
   ,@LINSERTONLY=0  
   ,@CFILTERCONDITION=@FILTER  
   ,@LUPDATEXNS=0  
   ,@CXNTYPE=''  
   ,@LUPDATEONLY=0
   ,@CUSERID=''  
   ,@BALWAYSUPDATE=1 
   
END TRY  
BEGIN CATCH   
 SET @CERRMSG='SAVETRAN_COMPANY: STEP - '+ISNULL(@CSTEP,'')+', MESSAGE - '+ERROR_MESSAGE()   
END CATCH  
  
END_PROC:  
  
IF @@TRANCOUNT>0    
 BEGIN    
  IF ISNULL(@CERRMSG,'')=''   
   COMMIT TRANSACTION  
     
  ELSE    
   ROLLBACK    
 END    
  
--DROP TEMP TABLES  
IF ISNULL(@CERRMSG,'')=''   
BEGIN  
      
    DELETE FROM MST_COMPANY_UPLOAD WHERE SP_ID =LTRIM(RTRIM(STR(@CSPID)))
  
END  
  
  
INSERT @TOUTPUT(COMPANY_CODE,ERRMSG)  
SELECT @CNEWCOMPANY_CODE,ISNULL(@CERRMSG,'')  
  
SELECT * FROM @TOUTPUT  
  
END  
--END OF PROCEDURE - SAVETRAN_PPC_COMPANY
