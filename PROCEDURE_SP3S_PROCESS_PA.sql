CREATE PROCEDURE SP3S_PROCESS_PA
(
	 @DPROCESS DATETIME
	,@BREPROCESS BIT=0 
	,@CPA_IDOUT VARCHAR(50) OUTPUT 
	,@CERRMSGOUT VARCHAR(500) OUTPUT 
)
--WITH ENCRYPTION
AS
BEGIN
DECLARE     @CSTEP VARCHAR(5),@CSAID VARCHAR(50),@CADID VARCHAR(50),@CAGEID VARCHAR(50),@CPROCESSID VARCHAR(50),@CREPORT_TYPE NUMERIC(1)
		   ,@CTSQL NVARCHAR(MAX),@CEXID VARCHAR(50),@NEXPENSES NUMERIC(18,4),@CDSID VARCHAR(50)
BEGIN TRY
	SET @CSTEP=110
	IF NOT EXISTS(SELECT TOP 1 'U' FROM SALE_ANALYSIS WHERE PROCESS_DT=@DPROCESS) OR @BREPROCESS = 1
		EXEC SP3S_SALE_ANALYSIS @DPROCESS,1,@CSAID OUTPUT,@CERRMSGOUT OUTPUT
	ELSE
		SELECT TOP 1 @CSAID=PROCESS_ID FROM SALE_ANALYSIS WHERE PROCESS_DT=@DPROCESS	
	
	SET @CSTEP=120 
	IF ISNULL(@CSAID,'')='' OR ISNULL(@CERRMSGOUT,'')<>'' 
	BEGIN
		SET @CERRMSGOUT='P:SP3S_PROCESS_PA,STEP: '+@CSTEP+', MESSAGE : '
		+(CASE WHEN ISNULL(@CERRMSGOUT,'')<>'' THEN @CERRMSGOUT ELSE ' ERROR PROCESSING SALE DATA...' END)
		GOTO EXIT_PROC
	END	
	
	SET @CSTEP=130 
	IF NOT EXISTS(SELECT TOP 1 'U' FROM ADI_MST WHERE PROCESS_DT=@DPROCESS) OR @BREPROCESS = 1
		EXEC SP3S_LOCWISE_ADI @DPROCESS,'',0,'LOCATION.MAJOR_DEPT_ID',1,@CADID OUTPUT,@CERRMSGOUT OUTPUT
	ELSE
		SELECT TOP 1 @CADID=PROCESS_ID FROM ADI_MST WHERE PROCESS_DT=@DPROCESS
		
	SET @CSTEP=140 
	IF ISNULL(@CADID,'')='' OR ISNULL(@CERRMSGOUT,'')<>''
	BEGIN
			SET @CERRMSGOUT='P:SP3S_PROCESS_PA,STEP: '+@CSTEP+', MESSAGE : '
			+(CASE WHEN ISNULL(@CERRMSGOUT,'')<>'' THEN @CERRMSGOUT ELSE 'ERROR PROCESSING ADI...' END)
			GOTO EXIT_PROC
	END	
	
	SET @CSTEP=150 
	IF NOT EXISTS(SELECT TOP 1 'U' FROM AGE_MST WHERE PROCESS_DT=@DPROCESS) OR @BREPROCESS = 1
		EXEC SP3S_STOCKAGE 'LOCATION.DEPT_ID',@DPROCESS,'',0,0,0,1,@CAGEID OUTPUT,@CERRMSGOUT OUTPUT
	ELSE
		SELECT TOP 1 @CAGEID=PROCESS_ID FROM AGE_MST WHERE PROCESS_DT=@DPROCESS
		
	SET @CSTEP=160 
	IF ISNULL(@CAGEID,'')='' OR ISNULL(@CERRMSGOUT,'')<>''
	BEGIN
		SET @CERRMSGOUT='P:SP3S_PROCESS_PA,STEP: '+@CSTEP+', MESSAGE : '
		+(CASE WHEN ISNULL(@CERRMSGOUT,'')<>'' THEN @CERRMSGOUT ELSE 'ERROR PROCESSING AGE...' END)
		GOTO EXIT_PROC
	END	
	
	SET @CSTEP=170 
	IF NOT EXISTS(SELECT TOP 1 'U' FROM EXPENSE_MST WHERE PROCESS_DT=@DPROCESS) OR @BREPROCESS = 1
		EXEC SP3S_EXPENSE_ANALYSIS @DPROCESS,1,@CEXID OUTPUT,@CERRMSGOUT OUTPUT
	ELSE
		SELECT TOP 1 @CEXID= PROCESS_ID FROM EXPENSE_MST WHERE PROCESS_DT=@DPROCESS
		
	SET @CSTEP=180 
	IF ISNULL(@CEXID,'')='' OR ISNULL(@CERRMSGOUT,'')<>''
	BEGIN
		SET @CERRMSGOUT='P:SP3S_PROCESS_PA,STEP: '+@CSTEP+', MESSAGE : '
		+(CASE WHEN ISNULL(@CERRMSGOUT,'')<>'' THEN @CERRMSGOUT ELSE 'ERROR PROCESSING EXPENSES...' END)
		GOTO EXIT_PROC
	END	
	ELSE 
	BEGIN
		IF OBJECT_ID('TEMPDB..#EXPENSES','U') IS NOT NULL
			DROP TABLE #EXPENSES
		
		SELECT DEPT_ID,SUM(EXPENSE_AMOUNT) AS EXPENSE_AMOUNT 
		INTO #EXPENSES FROM EXPENSE_DET WHERE PROCESS_ID=@CEXID AND XN_TYPE='CUR'
		GROUP BY DEPT_ID
		
		SELECT @NEXPENSES=SUM(ISNULL(EXPENSE_AMOUNT,0)) FROM #EXPENSES			
	END	
		
	SET @CSTEP=190
	IF NOT EXISTS(SELECT TOP 1 'U' FROM DIS_AVG_MST WHERE PROCESS_DT=@DPROCESS) OR @BREPROCESS = 1
		EXEC SP3S_DISC_AVG_ANALYSIS @DPROCESS,1,@CDSID OUTPUT,@CERRMSGOUT OUTPUT
		
	SET @CSTEP=200
	IF ISNULL(@CDSID,'')='' OR ISNULL(@CERRMSGOUT,'')<>''
	BEGIN
		SET @CERRMSGOUT='P:SP3S_PROCESS_PA,STEP: '+@CSTEP+', MESSAGE : '
		+(CASE WHEN ISNULL(@CERRMSGOUT,'')<>'' THEN @CERRMSGOUT ELSE 'ERROR PROCESSING DISC/SALE RATIO...' END)
		GOTO EXIT_PROC
	END	
		
	SET @CSTEP=210
	IF OBJECT_ID('TEMPDB..#POS_ANALYSIS','U') IS NOT NULL
		DROP TABLE #POS_ANALYSIS
				
	SET @CSTEP=220
	IF ISNULL(@CADID,'')<>''
	BEGIN
		 SET @CPROCESSID='PA'+CONVERT(VARCHAR(40),NEWID())
		 
		 INSERT POS_ANALYSIS	( PROCESS_ID, PROCESS_DT, DEPT_ID, DEPT_NAME, DEPT_AREA, DEPT_CITY, DEPT_STATE, DEPT_REGION, CM_TARGET, CM_SALE, CM_ACHIEVEDP, CM_CNTRP, CM_GM, CM_GM_CNTRP, CUM_TARGET, CUM_SALE, CUM_ACHIEVEDP, CUM_CNTRP, CUM_GM, CUM_GM_CNTRP, CUM_PSPD, CUM_TPY, CUM_ADI, CUM_GMROI, CUM_EXPENSE, CUM_EXPENSE_CNTRP, CUM_EXPENSE_PSF, CUM_DISC_SALE_RT, CUM_AVG_BILL, CUM_DOS, CUM_AGE1, CUM_AGE2, CUM_AGE3, CUM_AGE4 )  
		 SELECT @CPROCESSID AS PROCESSID,@DPROCESS AS PROCESSDT,AD.LAYOUT_VALUE AS DEPT_ID,L.DEPT_NAME AS DEPT_NAME
		 ,A.AREA_NAME AS DEPT_AREA,C.CITY AS DEPT_CITY,S.STATE AS DEPT_STATE,R.REGION_NAME AS DEPT_REGION
		 ,SA.CM_TARGET_VALUE AS CM_TARGET,SA.CM_SALE_VALUE AS CM_SALE,SA.CM_SAP AS CM_ACHIEVEDP,SA.CM_SCP AS CM_CNTRP,SA.CM_GM AS CM_GM
		 ,SA.CM_GMCP AS CM_GM_CNTRP,SA.CUM_TARGET_VALUE AS CUM_TARGET,SA.CUM_SALE_VALUE AS CUM_SALE,SA.CUM_SAP AS CUM_ACHIEVEDP,SA.CUM_SCP AS CUM_CNTRP
		 ,SA.CUM_GM AS CUM_GM,SA.CUM_GMCP AS CUM_GM_CNTRP
		 ,(CASE WHEN (SA.CUM_SALE_DAYS=0 OR SA.DEPT_AREA_COVERED=1) THEN 0 ELSE (SA.CUM_SALE_VALUE/(SA.CUM_SALE_DAYS*SA.DEPT_AREA_COVERED)) END) AS CUM_PSPD
		 ,(CASE WHEN SA.CUM_TOTAL_DAYS=0 OR ISNULL(AD.ADI_VALUE,0)=0 THEN 0 ELSE ((SA.CUM_SALE_VALUE*365)/(AD.ADI_VALUE*SA.CUM_TOTAL_DAYS)) END) AS CUM_TPY
		 , AD.ADI_VALUE AS CUM_ADI
		 ,(CASE WHEN ISNULL(AD.ADI_VALUE,0)=0 OR SA.CUM_TOTAL_DAYS=0 THEN 0 ELSE ((SA.CUM_GM*365*100)/(AD.ADI_VALUE*SA.CUM_TOTAL_DAYS)) END) AS CUM_GMROI
		 ,ISNULL(EP.EXPENSE_AMOUNT,0) AS CUM_EXPENSE,(ISNULL(EP.EXPENSE_AMOUNT,0)/@NEXPENSES)*100 AS CUM_EXPENSE_CNTRP
		 ,(CASE WHEN (SA.CUM_SALE_DAYS=0 OR SA.DEPT_AREA_COVERED=1) THEN 0 ELSE (ISNULL(EP.EXPENSE_AMOUNT,0)/(SA.CUM_SALE_DAYS*SA.DEPT_AREA_COVERED)) END) AS CUM_EXPENSE_PSF
		 ,(DAD.TOTAL_DIS_AMOUNT/DAD.GROSS_SALE_AMOUNT) AS CUM_DISC_SALE_RT
		 ,(DAD.NET_SALE_AMOUNT/DAD.BILL_COUNT) AS CUM_AVG_BILL
		 ,(CASE WHEN SA.CUM_SOLD_PURCHASE_VALUE=0 OR SA.CUM_SALE_DAYS=0 THEN 0 ELSE (AD.CBS_VALUE/(SA.CUM_SOLD_PURCHASE_VALUE/SA.CUM_SALE_DAYS)) END) AS CUM_DOS
		 ,AGD.AGE1 AS CUM_AGE1,AGD.AGE2 AS CUM_AGE2,AGD.AGE3 AS CUM_AGE3,AGD.AGE4 AS CUM_AGE4 
		 FROM ADI_DET AD (NOLOCK)
		 JOIN LOCATION L (NOLOCK) ON LTRIM(RTRIM(AD.LAYOUT_VALUE))=L.DEPT_ID
		 JOIN AREA A (NOLOCK) ON L.AREA_CODE=A.AREA_CODE
		 JOIN CITY C (NOLOCK) ON A.CITY_CODE=C.CITY_CODE
		 JOIN STATE S (NOLOCK) ON C.STATE_CODE=S.STATE_CODE
		 JOIN REGIONM R (NOLOCK) ON S.REGION_CODE=R.REGION_CODE
		 LEFT JOIN SALE_ANALYSIS SA (NOLOCK) ON LTRIM(RTRIM(AD.LAYOUT_VALUE))=SA.DEPT_ID AND SA.PROCESS_ID=@CSAID 
		 LEFT JOIN AGE_DET AGD ON LTRIM(RTRIM(AD.LAYOUT_VALUE))=LTRIM(RTRIM(AGD.LAYOUT_VALUE))	AND AGD.PROCESS_ID=@CAGEID
		 LEFT JOIN #EXPENSES EP ON LTRIM(RTRIM(AD.LAYOUT_VALUE))=LTRIM(RTRIM(EP.DEPT_ID))
		 LEFT JOIN DIS_AVG_DET DAD ON LTRIM(RTRIM(AD.LAYOUT_VALUE))=LTRIM(RTRIM(DAD.DEPT_ID)) AND DAD.PROCESS_ID=@CDSID
		 WHERE AD.PROCESS_ID=@CADID  		 
		 
		 SET @CPA_IDOUT=@CPROCESSID
	END		
	
END TRY
BEGIN CATCH
	SET @CERRMSGOUT='P:SP3S_PROCESS_PA,STEP: '+@CSTEP+', MESSAGE : '+ERROR_MESSAGE()
END CATCH
EXIT_PROC:	
END
---END OF PROCEDURE - SP3S_PROCESS_PA
