create PROCEDURE SP_SEND_MIRROR_XNSMST_DATA_NEW
@CXNTYPE VARCHAR(10),
@CMEMOID VARCHAR(40),
@CCURLOCID VARCHAR(5),
@BDONOTCHKPENDINGCUST BIT=0,
@BPENDINGMSTFOUND BIT OUTPUT,
@CERRMSG VARCHAR(MAX) OUTPUT
AS
BEGIN
	PRINT 'CHECK PENDING MST FOR :'+@CXNTYPE
	
	DECLARE @CPENDINGMSTCODE VARCHAR(20) ,@CSTEP VARCHAR(5)
	
	SET @BPENDINGMSTFOUND=0
	
	SET @CSTEP = 10
	
	IF @CXNTYPE='SLS'
	BEGIN
		SET @CSTEP = 40
			
		SELECT TOP 1 @CPENDINGMSTCODE=A.CUSTOMER_CODE 
		FROM CUSTDYM A (NOLOCK) 
		JOIN CMM01106 B (NOLOCK) ON A.CUSTOMER_CODE=B.CUSTOMER_CODE
		WHERE B.CM_ID=@CMEMOID AND A.CUSTOMER_CODE<>'000000000000'

			
		IF ISNULL(@CPENDINGMSTCODE,'')<>''
		BEGIN
			SET @BPENDINGMSTFOUND=1
				
			PRINT 'RETURN CUSTOMER CODE TO BE CHECKED FROM SLS'
				
			EXEC SP_SEND_MIRROR_CUS_DATA_new 
			@CCUSTOMERCODE=@CPENDINGMSTCODE,  
			@CERRMSG=@CERRMSG OUTPUT  
									
			GOTO END_PROC
		END	
	END
	ELSE IF @CXNTYPE='RPS'
	BEGIN
		SET @CSTEP = 40
			
		SELECT TOP 1 @CPENDINGMSTCODE=A.CUSTOMER_CODE 
		FROM CUSTDYM A (NOLOCK) 
		JOIN RPS_MST  B (NOLOCK) ON A.CUSTOMER_CODE=B.CUSTOMER_CODE
		WHERE B.CM_ID=@CMEMOID AND A.CUSTOMER_CODE<>'000000000000'

			
		IF ISNULL(@CPENDINGMSTCODE,'')<>''
		BEGIN
			SET @BPENDINGMSTFOUND=1
				
			PRINT 'RETURN CUSTOMER CODE TO BE CHECKED FROM SLS'
				
			EXEC SP_SEND_MIRROR_CUS_DATA_new 
			@CCUSTOMERCODE=@CPENDINGMSTCODE,  
			@CERRMSG=@CERRMSG OUTPUT  
									
			GOTO END_PROC
		END	
	END
	ELSE
	IF @CXNTYPE IN ('ARC','ADV')
	BEGIN
		
		SET @CSTEP = 130

		SELECT TOP 1 @CPENDINGMSTCODE=A.CUSTOMER_CODE FROM CUSTDYM A (NOLOCK) JOIN ARC01106 B (NOLOCK) ON A.CUSTOMER_CODE=B.CUSTOMER_CODE
		WHERE B.ADV_REC_ID=@CMEMOID AND A.CUSTOMER_CODE<>'000000000000'

		IF ISNULL(@CPENDINGMSTCODE,'')<>''
		BEGIN
			SET @CSTEP = 140
			SET @BPENDINGMSTFOUND=1

			PRINT 'RETURN CUSTOMER CODE TO BE CHECKED FROM ARC'
				
			EXEC SP_SEND_MIRROR_CUS_DATA_new 
			@CCUSTOMERCODE=@CPENDINGMSTCODE,  
			@CERRMSG=@CERRMSG OUTPUT  
							
			GOTO END_PROC
			
		END	
	END

	ELSE
	IF @CXNTYPE IN ('PSHBD')
	BEGIN
		
		SET @CSTEP = 130

		SELECT TOP 1 @CPENDINGMSTCODE=A.CUSTOMER_CODE FROM CUSTDYM A (NOLOCK) JOIN HOLD_BACK_DELIVER_MST B (NOLOCK) ON A.CUSTOMER_CODE=B.CUSTOMER_CODE
		WHERE B.memo_id=@CMEMOID AND A.CUSTOMER_CODE<>'000000000000'

		IF ISNULL(@CPENDINGMSTCODE,'')<>''
		BEGIN
			SET @CSTEP = 140
			SET @BPENDINGMSTFOUND=1

			PRINT 'RETURN CUSTOMER CODE TO BE CHECKED FROM PSHBD'
				
			EXEC SP_SEND_MIRROR_CUS_DATA_new 
			@CCUSTOMERCODE=@CPENDINGMSTCODE,  
			@CERRMSG=@CERRMSG OUTPUT  
							
			GOTO END_PROC
			
		END	
	END


	ELSE
	IF @CXNTYPE IN ('WSL','PUR','PRT','WSR')
	BEGIN
		DECLARE @cTableName VARCHAR(200),@cColname VARCHAR(200),@cCmd NVARCHAR(MAX)
				
		SET @CSTEP = 20
			
		SELECT @cTableName=(CASE WHEN @CXNTYPE='WSL' THEN 'inm01106' WHEN @CXNTYPE='WSR' THEN 'Cnm01106' WHEN @CXNTYPE='PUR' THEN 'pim01106'
								ELSE 'rmm01106' END),
			   @cColname=(CASE WHEN @CXNTYPE='WSL' THEN 'inv_id' WHEN @CXNTYPE='WSR' THEN 'Cn_id' WHEN @CXNTYPE='PUR' THEN 'mrr_id'
								ELSE 'rm_id' END)

		SET @cCMd=N'SELECT TOP 1 @CPENDINGMSTCODE=ac_code 
			FROM '+@cTableName+' WHERE '+@cColname+'='''+@CMEMOID+''''
		
		EXEC SP_EXECUTESQL @cCmd,N'@CPENDINGMSTCODE CHAR(10) OUTPUT',@CPENDINGMSTCODE=@CPENDINGMSTCODE OUTPUT
				
		SET @BPENDINGMSTFOUND=1
				
		EXEC SP_SEND_MIRROR_XNSLM_DATA_new 
				@CREQXNID=@CPENDINGMSTCODE,  
				@CERRMSG=@CERRMSG OUTPUT  			
									
		GOTO END_PROC
	END
		
END_PROC:
	
	PRINT 'SEND MST LAST STEP :'+@CSTEP+' FOR MEMO ID :'+@CMEMOID+' LOC ID :'+@CCURLOCID	
END