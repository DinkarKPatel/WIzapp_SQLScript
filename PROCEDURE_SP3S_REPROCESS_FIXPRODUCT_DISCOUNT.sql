CREATE PROCEDURE SP3S_REPROCESS_FIXPRODUCT_DISCOUNT
(
 @NSPID VARCHAR(50),
 @CCOLUMNNAME VARCHAR(100),
 @ERRMSG VARCHAR(MAX) OUTPUT
)
AS
BEGIN
 BEGIN TRY
             DECLARE @DTSQL NVARCHAR(MAX),@CROW_ID VARCHAR(100),@NCALTIME INT
 
              DECLARE @CIN_VALUE NUMERIC(2,2),@NTOTALDIFF INT,@NVALUEADD INT,
                      @NVALUE NUMERIC(10,2),@NCALCVALUE NUMERIC(10,2)
              
        
             WHILE EXISTS(SELECT TOP 1 'U' FROM #TMPDIFF)
             BEGIN
                 SET @CIN_VALUE='0.01'
                 SELECT @CROW_ID=ROW_ID,@NTOTALDIFF=ABS(DIFF)*100,@NVALUEADD=CASE WHEN DIFF>=0 THEN 1 ELSE -1 END ,
                 @NVALUE=VALUE
                 FROM #TMPDIFF
                
                 SET @CIN_VALUE=@CIN_VALUE*@NVALUEADD
                 
                 
				 SET @DTSQL=N';WITH CTE AS
				(SELECT A.*,SR=ROW_NUMBER() OVER (ORDER BY ROW_ID)
				 FROM  BATCHWISE_FIXCODE_UPLOAD  A 
				 WHERE SP_ID='''+LTRIM(RTRIM((@NSPID)))+'''
				 AND ROW_ID='''+@CROW_ID+'''
				 ) 
				 UPDATE CTE SET '+@CCOLUMNNAME+'='+@CCOLUMNNAME+' +'+RTRIM(LTRIM(STR(@CIN_VALUE,10,2)))+' WHERE SR<='''+STR(@NTOTALDIFF)+''''
				EXEC SP_EXECUTESQL @DTSQL
				PRINT @DTSQL+'DINKAR'
				
				----SELECT @NCALCVALUE=SUM(BASIC_DISCOUNT_AMOUNT ) FROM BATCHWISE_FIXCODE_UPLOAD WHERE SP_ID=@NSPID AND ROW_ID =@CROW_ID
				
				----SELECT @NVALUE,@NCALCVALUE,@NVALUEADD,@CIN_VALUE
			 ----   IF @NCALCVALUE=@NVALUE OR @NCALTIME=1
				----   DELETE FROM #TMPDIFF WHERE ROW_ID =@CROW_ID
				----ELSE
				----BEGIN
				----	SELECT  @NTOTALDIFF=ABS(@NVALUE-@NCALCVALUE)*100,
				----	@NVALUEADD=CASE WHEN (@NVALUE-@NCALCVALUE)>=0 THEN 1 ELSE -1 END
				----	SET @NCALTIME=1
 			----		GOTO LBLCALCULATE
				----END
				 DELETE FROM #TMPDIFF WHERE ROW_ID =@CROW_ID
             END
            
	         

END TRY
BEGIN CATCH
  SET @ERRMSG ='ERROR IN PROCEDURE || SP3S_REPROCESS_BILL_DISCOUNT ERROR MESSAGE || '+ ERROR_MESSAGE();
END CATCH

END_PROC:

END
