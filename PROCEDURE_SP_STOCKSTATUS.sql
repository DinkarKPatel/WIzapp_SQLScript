CREATE PROCEDURE SP_STOCKSTATUS
 (
 @CTODATE VARCHAR(10)='',    
 @CFROMDATE VARCHAR(10)='',
 @CWHERE VARCHAR(1000)=''
)
--WITH ENCRYPTION

AS
BEGIN
DECLARE @CQUERY NVARCHAR(MAX)  
SET @CQUERY= N' SELECT DEPARTMENT AS [DEPARTMENT], ARTICLE_NO,PARA1.PARA1_NAME,PARA2.PARA2_NAME,   
SUM((CASE WHEN A.XN_TYPE IN (''PUR'',''WSR'',''UNC'',''AMR'',''IMR'',''RMR'',''STRIN'') AND XN_DT <= '''+@CTODATE+''' AND XN_DT >= '''+@CFROMDATE+''' THEN 1   
WHEN A.XN_TYPE IN (''PRT'',''WSL'',''CNC'',''AMI'',''IMI'',''STROUT'',''OP'',''OPC'') AND XN_DT <= '''+@CTODATE+''' AND XN_DT >= '''+@CFROMDATE+''' THEN -1 ELSE 0 END) * (XN_QTY)) AS QTY  
,  
CONVERT(NUMERIC(10,2),SUM((CASE WHEN A.XN_TYPE IN (''PUR'',''WSR'',''UNC'',''AMR'',''IMR'',''RMR'',''STRIN'') AND XN_DT <= '''+@CTODATE+''' AND XN_DT >= '''+@CFROMDATE+''' THEN 1   
WHEN A.XN_TYPE IN (''PRT'',''WSL'',''CNC'',''AMI'',''IMI'',''STROUT'',''OP'',''OPC'')  AND XN_DT <= '''+@CTODATE+''' AND XN_DT >= '''+@CFROMDATE+''' THEN -1 ELSE 0 END) * (XN_QTY) * (XN_MRP)) ) AS STOCKMRP  
,  
CONVERT(NUMERIC(10,2),SUM((CASE WHEN A.XN_TYPE IN (''PUR'',''WSR'',''UNC'',''AMR'',''IMR'',''RMR'',''STRIN'') AND XN_DT <= '''+@CTODATE+''' AND XN_DT >= '''+@CFROMDATE+''' THEN 1   
WHEN A.XN_TYPE IN (''PRT'',''WSL'',''CNC'',''AMI'',''IMI'',''STROUT'',''OP'',''OPC'')  AND XN_DT <= '''+@CTODATE+''' AND XN_DT >= '''+@CFROMDATE+''' THEN -1 ELSE 0 END) * (XN_QTY) * (XN_PP)) ) AS STOCKPP  
FROM VW_STOCKSTATUS_REPORT A  
JOIN PARA1 ON PARA1.PARA1_CODE=A.PARA1_CODE  
JOIN PARA2 ON PARA2.PARA2_CODE=A.PARA2_CODE '  
IF @CWHERE<>''  
SET @CQUERY = @CQUERY + @CWHERE  
SET @CQUERY = @CQUERY + ' GROUP BY DEPARTMENT, ARTICLE_NO,PARA1_NAME,PARA2_NAME '  
  
PRINT @CQUERY  
EXEC SP_EXECUTESQL @CQUERY  
END
