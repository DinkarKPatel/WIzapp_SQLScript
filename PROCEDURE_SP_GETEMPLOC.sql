CREATE PROCEDURE SP_GETEMPLOC
--WITH ENCRYPTION
AS
BEGIN
	SELECT A.EMP_CODE,A.EMP_NAME,A.EMP_ALIAS,A.DEPT_ID,A.DEPT_ID +'-'+ A.DEPT_NAME AS [DEPT_NAME],ISNULL(B.CHK,0) AS CHK ,GETDATE() AS [LAST_UPDATE] 
	FROM
	(
		SELECT A.EMP_CODE,A.EMP_NAME,A.EMP_ALIAS,B.DEPT_ID,B.DEPT_NAME,CONVERT(BIT,0) AS [CHK]
		FROM EMPLOYEE A,LOCATION B
		WHERE B.INACTIVE=0 AND A.INACTIVE=0 AND B.MAJOR_DEPT_ID=B.DEPT_ID
	)A
	LEFT OUTER JOIN 
	(
		SELECT A.EMP_CODE,C.EMP_NAME,C.EMP_ALIAS,A.DEPT_ID,B.DEPT_NAME,CONVERT(BIT,1) AS [CHK]
		FROM LOC_EMP A
		JOIN LOCATION B ON B.DEPT_ID=A.DEPT_ID
		JOIN EMPLOYEE C ON C.EMP_CODE=A.EMP_CODE
		WHERE  B.INACTIVE=0 AND C.INACTIVE=0 AND B.DEPT_ID=B.MAJOR_DEPT_ID
	)B ON A.EMP_CODE=B.EMP_CODE AND A.DEPT_ID=B.DEPT_ID
	WHERE A.EMP_CODE<>'0000000'
	ORDER BY EMP_NAME,DEPT_NAME
END
