CREATE PROCEDURE PPC_SAVETRAN_BO_ART_BOM  
(  
  @NSPID   INT=0 ,
  @CORDER_ID VARCHAR(100) 
)  
----WITH ENCRYPTION  
AS  
BEGIN  
DECLARE @CERRMSG VARCHAR(500),@CSTEP VARCHAR(10)  
    ,@CCMD NVARCHAR(MAX)  
  
DECLARE @TOUTPUT TABLE(MEMO_ID VARCHAR(50),ERRMSG VARCHAR(500))  
  
---LIST OF TABLES TO SAVE  
DECLARE @TBO_ART_BOM VARCHAR(100)  
--,@TSKU VARCHAR(100)  
  
  
SET @TBO_ART_BOM='WSLORD_PPC_BO_ART_BOM_UPLOAD'  
--SET @TSKU=@CTABLE_PREFIX+'SKU'+@CTABLE_SUFFIX  
  
BEGIN TRY  
BEGIN TRANSACTION  
     SET @CSTEP=10  
       
     IF EXISTS (SELECT TOP 1 'U' FROM WSLORD_PPC_BO_ART_BOM_UPLOAD WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID))) GROUP BY REF_ROW_ID,BOM_ARTICLE_CODE HAVING COUNT(*)>1)  
     BEGIN  
         SET @CERRMSG='DUPLICATE BOM FOUND PLEASE CHECK.'  
         GOTO END_PROC  
     END  
     
     --***VALIDATE IF PO HAS BEEN GENERATED 
	     
	IF OBJECT_ID('TEMPDB..#TMPBOM','U') IS NOT NULL
	   DROP TABLE #TMPBOM

	SELECT A.ROW_ID , A.REF_ROW_ID 
	INTO #TMPBOM
	FROM PPC_BO_ART_BOM A
	JOIN PPC_POD01106 B ON A.ROW_ID=B.BO_BOM_ROW_ID
	JOIN PPC_POM01106 C ON B.PO_ID =C.PO_ID 
	JOIN
	(
	 SELECT REF_ROW_ID FROM WSLORD_PPC_BO_ART_BOM_UPLOAD
	 WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID))) 
	 GROUP BY REF_ROW_ID
	)D ON A.REF_ROW_ID=D.REF_ROW_ID
	LEFT OUTER JOIN
	(
	  SELECT ROW_ID  FROM WSLORD_PPC_BO_ART_BOM_UPLOAD
	  WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID))) 
	  GROUP BY ROW_ID
	) E ON A.ROW_ID=E.ROW_ID
	WHERE C.CANCELLED=0
	AND E.ROW_ID IS NULL
	
	IF EXISTS (SELECT TOP 1 'U' FROM #TMPBOM)
	BEGIN
	   SET @CERRMSG='PO HAS BEEN GENERATED CAN NOT CHANGE. PLEASE CHECK'  
       GOTO END_PROC  
	END


    
    --***VALIDATE IF PO HAS BEEN GENERATED 
    
    UPDATE A SET ROW_ID =B.ROW_ID  FROM WSLORD_PPC_BO_ART_BOM_UPLOAD A
    JOIN PPC_BO_ART_BOM B  ON A.REF_ROW_ID =B.REF_ROW_ID AND A.BOM_ARTICLE_CODE =B.BOM_ARTICLE_CODE 
    WHERE A.SP_ID=LTRIM(RTRIM(STR(@NSPID)))
    
	     
   --DELETE THE EXISTING RECORD FOR THIS PPC_BO_ART_BOM  
   	SET @CSTEP = 130	
	SET @CCMD = N'UPDATE '+ @TBO_ART_BOM + ' SET ROW_ID = NEWID() WHERE LEFT(ROW_ID,5) = ''LATER'' AND SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
	PRINT @CCMD	
	EXEC SP_EXECUTESQL @CCMD
   
   


   DELETE A FROM PPC_BO_ART_BOM A
   JOIN
   (
    SELECT REF_ROW_ID FROM WSLORD_PPC_BO_ART_BOM_UPLOAD
    WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID))) 
    GROUP BY REF_ROW_ID
   )B ON A.REF_ROW_ID=B.REF_ROW_ID
  
   
 --  SELECT * FROM WSLORD_PPC_BO_ART_BOM_UPLOAD
   
     
 DECLARE @FILTER VARCHAR(MAX)  
 SET @FILTER=' B.SP_ID= '''+LTRIM(RTRIM(STR(@NSPID)))+''' '   
   
 --SP_INSERTSTR PPC_SIZEGROUP_PARA2  
    EXEC UPDATEMASTERXN   
    @CSOURCEDB=''  
   ,@CSOURCETABLE=@TBO_ART_BOM  
   ,@CDESTDB=''  
   ,@CDESTTABLE='PPC_BO_ART_BOM'  
   ,@CKEYFIELD1='ROW_ID'  
   ,@CKEYFIELD2=''  
   ,@CKEYFIELD3=''  
   ,@LINSERTONLY=0  
   ,@CFILTERCONDITION=@FILTER  
   ,@LUPDATEXNS=0  
   ,@CXNTYPE=''  
   ,@LUPDATEONLY=0  
   ,@CUSERID=''  
   ,@BALWAYSUPDATE=1  
  
    
END TRY  
BEGIN CATCH   
 SET @CERRMSG='PPC_BO_ART_BOM: STEP - '+ISNULL(@CSTEP,'')+', MESSAGE - '+ERROR_MESSAGE()   
END CATCH  
  
END_PROC:  
  
IF @@TRANCOUNT>0    
 BEGIN    
  IF ISNULL(@CERRMSG,'')=''   
   COMMIT TRANSACTION    
  ELSE    
   ROLLBACK    
 END    
  

   -- DELETE FROM WSLORD_PPC_BO_ART_BOM_UPLOAD WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID)))  

  
INSERT @TOUTPUT(MEMO_ID,ERRMSG)  
SELECT '',ISNULL(@CERRMSG,'')  
  
SELECT * FROM @TOUTPUT  
  
END
