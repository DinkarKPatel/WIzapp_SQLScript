CREATE  PROC SP3S_PURCHASEINVOICELIST_QBF
(
@cFinyear varchar(20),
@cWhere Varchar(Max)=  '' 
)
 AS 
 Begin
 DECLARE @CCMD NVARCHAR(MAX)
 SET @CCMD =N'  Select DISTINCT mrr_id , mst_mrr_no  From (
SELECT   
A.MRR_ID,A.MEMO_TYPE,  
A.PARTY_INV_AMOUNT AS MST_PARTY_INV_AMOUNT,
A.BILL_LEVEL_TAX_METHOD AS MST_BILL_LEVEL_TAX_METHOD,
A.RECEIPT_DT AS MST_XN_DT,   
A.MRR_NO AS MST_MRR_NO,   
A.INV_NO AS MST_INV_NO,   
A.BILL_NO AS MST_BILL_NO, 
A.CHECKED_BY AS MST_CHECKED_BY,  
A.TOTAL_AMOUNT AS MST_TOTAL_AMOUNT,          
A.INV_DT AS MST_INV_DT,   
A.DISCOUNT_AMOUNT AS MST_DISCOUNT_AMOUNT,  
A.DISCOUNT_PERCENTAGE AS MST_DISCOUNT_PERCENTAGE,  
A.FREIGHT AS MST_FREIGHT,  
A.OTHER_CHARGES AS MST_OTHER_CHARGES,  
A.ROUND_OFF AS MST_ROUND_OFF,  
A.RECEIVED_BY AS MST_RECEIVED_BY,  
A.MEMO_TYPE AS MST_MEMO_TYPE,  
A.REMARKS AS MST_REMARKS,  
A.SUBTOTAL AS MST_SUBTOTAL,  
A.FIN_YEAR AS  MST_FIN_YEAR ,  
B.AC_NAME AS  MST_SUPP_NAME , 
H.USERNAME AS  MST_CREATED_USERNAME ,  
C.QUANTITY AS  QUANTITY ,   
C.PURCHASE_PRICE AS  PURCHASE_PRICE ,  
C.MRP AS  MRP ,
SKU.MRP AS  SKU_MRP , 
C.PURCHASE_PRICE * C.QUANTITY AS  AMOUNT ,  
C.PRODUCT_CODE AS  PRODUCT_CODE ,  
C.MP_PERCENTAGE AS  MP_PERCENTAGE ,  
P1.PARA1_NAME AS  PARA1_NAME ,   
P2.PARA2_NAME AS  PARA2_NAME ,   
P3.PARA3_NAME AS  PARA3_NAME ,         
P4.PARA4_NAME AS  PARA4_NAME ,   
P5.PARA5_NAME AS  PARA5_NAME ,   
P6.PARA6_NAME AS  PARA6_NAME ,         
D.ARTICLE_NO AS  ARTICLE_NO ,   
D.ARTICLE_NAME AS  ARTICLE_NAME ,  
D.ARTICLE_DESC AS  ARTICLE_DESC ,  
E.SUB_SECTION_NAME AS  SUB_SECTION_NAME ,   
F.SECTION_NAME AS  SECTION_NAME ,        
U.UOM_NAME AS  UOM_NAME ,  
C.BOX_NO,   
INV_MODE AS PURCHASE_TYPE  
,A.CHECKED_BY  
,A.RECEIVED_BY 
,A.CREDIT_DAYS  AS MST_CREDIT_DAYS 
,A.CR_DISCOUNT_PERCENTAGE   
,A.MRR_NO  
,A.INV_NO  
,A.INV_DT  
,A.BILL_NO  
,A.RECEIPT_DT 
,A.TOTAL_AMOUNT  
,A.REMARKS  
,A.SUBTOTAL  
,A.DISCOUNT_PERCENTAGE  
,A.DISCOUNT_AMOUNT  
,A.OTHER_CHARGES  
,A.FREIGHT  
,A.TAX_PERCENTAGE  
,A.TAX_AMOUNT  
,A.ROUND_OFF  
,A.CANCELLED  
,A.DEPT_ID   
,A.PIM_MODE  
,B.AC_NAME  
,B.ALIAS  
,C.SRNO  
,C.WHOLESALE_PRICE  
,C.WSP_PERCENTAGE  
,C.GROSS_PURCHASE_PRICE  
,C.INVOICE_QUANTITY  
,C.SCHEME_QUANTITY 
,LCT.DEPT_ID AS LOCATION_DEPT_ID  
,LCT.DEPT_NAME AS LOCATION_DEPT_NAME  
,LCT.DEPT_NAME AS MST_DEPT_NAME 
,SKU.PRODUCT_NAME  
 ,A.MEMO_PREFIX AS MST_MEMO_PREFIX,  
C.MD_PERCENTAGE,C.WD_PERCENTAGE ,A.LOCATION_CODE
FROM PIM01106 (NOLOCK) A  
LEFT OUTER JOIN LMV01106 (NOLOCK) B ON A.AC_CODE = B.AC_CODE          
LEFT OUTER JOIN PID01106 (NOLOCK) C ON A.MRR_ID = C.MRR_ID    
LEFT OUTER JOIN SKU (NOLOCK)  ON SKU.PRODUCT_CODE = C.PRODUCT_CODE  
LEFT OUTER JOIN ARTICLE (NOLOCK) D ON SKU.ARTICLE_CODE = D.ARTICLE_CODE          
LEFT OUTER JOIN SECTIOND (NOLOCK) E ON D.SUB_SECTION_CODE = E.SUB_SECTION_CODE           
LEFT OUTER JOIN SECTIONM (NOLOCK) F ON E.SECTION_CODE = F.SECTION_CODE           
LEFT OUTER JOIN PARA1 (NOLOCK) P1 ON SKU.PARA1_CODE = P1.PARA1_CODE          
LEFT OUTER JOIN PARA2 (NOLOCK) P2 ON SKU.PARA2_CODE = P2.PARA2_CODE          
LEFT OUTER JOIN PARA3 (NOLOCK) P3 ON SKU.PARA3_CODE = P3.PARA3_CODE          
LEFT OUTER JOIN PARA4 (NOLOCK) P4 ON SKU.PARA4_CODE = P4.PARA4_CODE          
LEFT OUTER JOIN PARA5 (NOLOCK) P5 ON SKU.PARA5_CODE = P5.PARA5_CODE          
LEFT OUTER JOIN PARA6 (NOLOCK) P6 ON SKU.PARA6_CODE = P6.PARA6_CODE          
LEFT OUTER JOIN USERS (NOLOCK) H ON A.USER_CODE = H.USER_CODE 
LEFT OUTER JOIN BIN  (NOLOCK) ON BIN.BIN_ID = A.BIN_ID  
LEFT OUTER JOIN UOM (NOLOCK) U ON D.UOM_CODE = U.UOM_CODE  
LEFT OUTER JOIN LOCATION LCT ON A.DEPT_ID=LCT.DEPT_ID  
LEFT OUTER JOIN LOCATION LCTF ON A.Pur_For_Dept_id=LCTF.DEPT_ID 
LEFT OUTER JOIN AREA LA ON LCT.AREA_CODE=LA.AREA_CODE   
LEFT OUTER JOIN EMPLOYEE EMP ON A.EMP_CODE = EMP.EMP_CODE   
LEFT OUTER JOIN UOM AR_U (NOLOCK) ON AR_U.UOM_CODE=C.AREA_UOM_CODE
WHERE  A.fin_year= '''+ @cFinyear + '''
) a '  + @cWhere 

PRINT @CCMD
EXEC SP_EXECUTESQL @CCMD
END

