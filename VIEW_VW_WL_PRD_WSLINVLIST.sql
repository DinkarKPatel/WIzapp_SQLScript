CREATE VIEW VW_WL_PRD_WSLINVLIST    

AS     
SELECT T1.INV_DT AS MEMO_DT,        
T3.AC_NAME AS CUSTOMER_NAME,
T1.INV_ID AS MEMO_ID,T1.INV_NO AS MEMO_NO,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.SUBTOTAL ELSE 0 END) AS BILL_GROSS_SALE_VALUE,    
T1.DISCOUNT_PERCENTAGE AS DISCOUNT_PERCENTAGE ,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.DISCOUNT_AMOUNT ELSE 0 END) AS DISCOUNT_AMOUNT ,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.FREIGHT ELSE 0 END) AS FREIGHT,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.OTHER_CHARGES ELSE 0 END) AS OTHER_CHARGES,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.NET_AMOUNT ELSE 0 END) AS NET_SALE_VALUE,    
T1.GRLR_DATE,     
T1.OCTROI_PERCENTAGE,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.OCTROI_AMOUNT ELSE 0 END) AS OCTROI_AMOUNT,    
T1.PARTY_DA_NO,    
T1.PARTY_PO_NO,    
T1.MANUAL_INV_NO,    
(CASE WHEN T1.CANCELLED = 1 THEN 0 ELSE ISNULL(T2.TOTAL_QUANTITY,0) END) AS TOTAL_QUANTITY,    
(CASE WHEN T1.CANCELLED = 1 THEN 0 ELSE ISNULL(T2.ITEM_DISCOUNT_AMOUNT,0) END) AS ITEM_DISCOUNT_AMOUNT,    
T4.FORM_NAME,T5.EMP_NAME AS SALES_PERSON,    
(CASE WHEN T1.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END) AS CANCELLED,    
T6.DEPT_ID ,T6.DEPT_NAME ,    
(CASE WHEN T1.APPROVED = 1 THEN 'YES' ELSE 'NO' END) AS APPROVED,    
(CASE WHEN ISNULL(VM.BILL_ID,'') <>'' THEN 'POSTED' ELSE 'PENDING' END) AS AC_POSTED ,
T1.FIN_YEAR, F.FORM_NAME AS TAX_TYPE,T2.TAX_PERCENTAGE ,T2.TAX_AMOUNT       
FROM PRD_INM01106 T1    
JOIN LMV01106 T3 ON T3.AC_CODE = T1.AC_CODE    
JOIN FORM   T4 ON T4.FORM_ID = T1.FORM_ID    
JOIN EMPLOYEE T5 ON T5.EMP_CODE = T1.EMP_CODE    
LEFT OUTER JOIN LOCATION T6 ON T6.DEPT_ID = T1.PARTY_DEPT_ID      
LEFT OUTER JOIN     
(
  SELECT  INV_ID,ITEM_FORM_ID,ITEM_TAX_PERCENTAGE AS TAX_PERCENTAGE,
        SUM(QUANTITY) AS TOTAL_QUANTITY,SUM(DISCOUNT_AMOUNT) AS ITEM_DISCOUNT_AMOUNT,
		SUM(QUANTITY*RATE) AS ITEM_GROSS_SALE_VALUE,SUM(ITEM_TAX_AMOUNT) AS TAX_AMOUNT    
  FROM PRD_IND01106 GROUP BY INV_ID,INV_ID,ITEM_FORM_ID,ITEM_TAX_PERCENTAGE
) T2 ON T2.INV_ID=T1.INV_ID     
LEFT OUTER JOIN 
(
 SELECT BILL_ID FROM VM01106 WHERE CANCELLED=0
) VM ON VM.BILL_ID=T1.INV_ID   
LEFT OUTER JOIN FORM F ON T2.ITEM_FORM_ID = F.FORM_ID
