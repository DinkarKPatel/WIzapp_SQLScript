CREATE   PROCEDURE SP_PRD_UPC_WO    
(    
 @CORDER_ID VARCHAR(100)='',     
 @CWO_ID VARCHAR(100)='',  
 @CPARA1_CODE VARCHAR(100)='',    
 @CPARA2_CODE VARCHAR(10)='' 
  
)    
AS    
BEGIN    
     
  IF OBJECT_ID ('TEMPDB..#TMPALLOCATION','U') IS NOT NULL      
    DROP TABLE #TMPALLOCATION      
    
   
          
  SELECT ORDER_ID,WO_ID AS MEMO_ID ,CAST('' AS VARCHAR(100)) AS ARTICLE_CODE,    
  PARA1_CODE,PARA2_CODE,PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE       
  INTO #TMPALLOCATION    
  FROM PRD_UPCPMT WHERE 1=2    
      
  DECLARE @DTSQL NVARCHAR(MAX)    
  SET @DTSQL=N' SELECT B.ORDER_ID,ISNULL(PMT1.WO_ID,ISNULL(A.MEMO_ID,'''')) AS MEMO_ID ,    
  B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,ISNULL(PMT1.PRODUCT_CODE,ISNULL(A.PRODUCT_CODE,'''')) AS PRODUCT_CODE,    
  ISNULL(PMT1.QUANTITY_IN_STOCK,ISNULL(A.QUANTITY_IN_STOCK,0)) AS QUANTITY_IN_STOCK,    
  ISNULL(PMT1.JOB_CODE,ISNULL(A.JOB_CODE,'''')) AS JOB_CODE          
  FROM BUYER_ORDER_DET B       
  JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID       
  LEFT JOIN      
  (      
   SELECT A.ORDER_ID,C.ARTICLE_SET_CODE ,A.MEMO_ID,PMT.PARA1_CODE,PMT.PARA2_CODE,    
   PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE    
   FROM      
  (SELECT DISTINCT * FROM PRD_WO_ORDERS) A           
  JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID             
  JOIN    
  (    
   SELECT WO_ID,PARA1_CODE,PARA2_CODE,PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE    
   FROM PRD_UPCPMT WHERE ISNULL(ORDER_ID,'''')=''''    
   AND ISNULL(JOB_CODE,'''')='''' 
  ) PMT ON PMT.WO_ID=C.MEMO_ID       
  WHERE C.CANCELLED=0       
  ) A ON A.ORDER_ID=B.ORDER_ID           
  AND B.PARA1_CODE = A.PARA1_CODE           
  AND B.PARA2_CODE = A.PARA2_CODE           
  AND B.ARTICLE_CODE = A.ARTICLE_SET_CODE     
  LEFT JOIN    
  (    
   SELECT ORDER_ID, WO_ID,PARA1_CODE,PARA2_CODE,PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE    
   FROM PRD_UPCPMT WHERE ISNULL(ORDER_ID,'''')<>''''    
    AND ISNULL(JOB_CODE,'''')='''' 
  ) PMT1 ON PMT1.ORDER_ID=M.ORDER_ID       
  AND B.PARA1_CODE=PMT1.PARA1_CODE    
  AND B.PARA2_CODE=PMT1.PARA2_CODE     
  WHERE  M.CANCELLED=0        
  AND M.ORDER_DT>=''2017-01-01''      
     AND B.ORDER_ID= '''+@CORDER_ID+'''        
     AND B.PARA1_CODE= '''+@CPARA1_CODE+'''     
     AND ISNULL(PMT1.WO_ID,ISNULL(A.MEMO_ID,''''))= '''+@CWO_ID+'''   
     AND ISNULL(PMT1.PARA2_CODE,ISNULL(A.PARA2_CODE,''''))= '''+@CPARA2_CODE +'''      
     '      
  PRINT @DTSQL      
  INSERT INTO #TMPALLOCATION      
  EXEC SP_EXECUTESQL @DTSQL      
      
  
  SELECT C.AC_NAME ,B.ORDER_NO,B.ORDER_DT,MST.MEMO_NO ,MST.MEMO_DT ,
         A.ARTICLE_CODE ,ART.ARTICLE_NO,A.PARA1_CODE ,A.PARA2_CODE ,
         A.PRODUCT_CODE ,A.QUANTITY_IN_STOCK 
  FROM #TMPALLOCATION   A
  JOIN BUYER_ORDER_MST B ON A.ORDER_ID =B.ORDER_ID 
  JOIN PRD_WO_MST MST ON MST.MEMO_ID =A.MEMO_ID 
  JOIN LM01106 C ON C.AC_CODE =B.AC_CODE 
  JOIN ARTICLE ART ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
      
      
END
