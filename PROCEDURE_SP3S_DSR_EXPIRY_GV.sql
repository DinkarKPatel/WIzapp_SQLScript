CREATE PROCEDURE SP3S_DSR_EXPIRY_GV--(LocId 3 digit change by Sanjay:05-11-2024)
(
   @NNO_OF_DAYS NUMERIC(18,0)=7,
   @CDEPT_ID VARCHAR(4)=''
)
AS
BEGIN
      DECLARE @CHO_DEPT_ID VARCHAR(5)

	  if @CDEPT_ID=''
      SELECT TOP 1 @CDEPT_ID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 

      SELECT TOP 1 @CHO_DEPT_ID=VALUE  FROM CONFIG  WHERE CONFIG_OPTION ='HO_LOCATION_ID'
      IF @CDEPT_ID=@CHO_DEPT_ID
      SET @CDEPT_ID=''
     
      SELECT DISTINCT  arc.location_Code AS LOC_ID,DEPT_NAME AS LOC_NAME,
              CUSTOMER_NAME=CASE WHEN ISNULL(C.MOBILE,'')<> '' THEN  ISNULL(C.MOBILE,'')+', ' ELSE '' END + 
              ISNULL(C.CUSTOMER_FNAME,'') +' '+ISNULL(CUSTOMER_LNAME,''),
              A.GV_SRNO AS GV_NO,
              ADV_REC_NO AS SALE_RECEIPT_NO,CONVERT(VARCHAR,ADV_REC_DT,105) AS DATE,
              CONVERT(VARCHAR,B.DT_EXPIRY,105) AS EXPIRY_DT
       FROM ARC_GVSALE_DETAILS A (NOLOCK)
	   JOIN SKU_GV_MST B (NOLOCK) ON B.GV_SRNO=A.GV_SRNO  
	   JOIN ARC01106 ARC (NOLOCK) ON ARC.ADV_REC_ID=A.ADV_REC_ID 
	   JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=  arc.location_Code
	   JOIN CUSTDYM C (NOLOCK) ON C.CUSTOMER_CODE=ARC.CUSTOMER_CODE
	   WHERE ISNULL(ARC.CANCELLED,0)=0 
	   AND  B.DT_EXPIRY>=GETDATE()
	   AND DATEDIFF (DD,GETDATE(),B.DT_EXPIRY)BETWEEN 0 AND @NNO_OF_DAYS
	   UNION ALL
	   SELECT DISTINCT  TARGET_DEPT_ID AS LOC_ID,DEPT_NAME AS LOC_NAME,
              CUSTOMER_NAME='',
              B.GV_SRNO AS GV_NO,
              MEMO_NO  AS SALE_RECEIPT_NO,CONVERT(VARCHAR,MEMO_DT,105) AS DATE,
              CONVERT(VARCHAR,C.DT_EXPIRY,105) AS EXPIRY_DT
      FROM GV_STKXFER_MST A (NOLOCK)
      JOIN GV_STKXFER_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID
      JOIN SKU_GV_MST C (NOLOCK) ON B.GV_SRNO=C.GV_SRNO
      JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=A.TARGET_DEPT_ID
      WHERE ISNULL(A.CANCELLED,0)=0 
	  AND  C.DT_EXPIRY>=GETDATE()
	  AND DATEDIFF (DD,GETDATE(),C.DT_EXPIRY)BETWEEN 0 AND @NNO_OF_DAYS
	  AND (@CDEPT_ID='' OR TARGET_DEPT_ID=@CDEPT_ID)
END

--END OF PROCEDURE SP3S_DSR_EXPIRY_GV
