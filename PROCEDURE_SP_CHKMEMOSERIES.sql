CREATE PROCEDURE SP_CHKMEMOSERIES
@CXNTYPE VARCHAR(10),  
@CMASTERKEYFIELD VARCHAR(50),  
@CXNMASTERTABLENAME VARCHAR(100),  
@NSPID INT,  
@CDEPTID VARCHAR(5),  
@CXNID VARCHAR(40),
@CERRORMSGOUT VARCHAR(200) OUTPUT,  
@CRETCMDOUT VARCHAR(200) OUTPUT,  
@CPREVMEMOID VARCHAR(40) OUTPUT  
--WITH ENCRYPTION
AS  
BEGIN  
--(dinkar) Replace  left(memoid,2) to Location_code 
 DECLARE @CCMD NVARCHAR(MAX),@NGRPCHARS INT,@NSERIESCHARS INT,@NMEMONOLEN INT,@CMEMOID VARCHAR(40),@CFIRSTMEMOID VARCHAR(40),  
 @NPREVMEMOID INT,@BSERIESBROKEN BIT,@CFINYEAR VARCHAR(10)  
 
 IF @CXNTYPE<>'SLS'
	RETURN
	  
 SELECT @CERRORMSGOUT='',@CRETCMDOUT='',@CDEPTID=LTRIM(RTRIM(@CDEPTID))  
 
 IF LEFT(@CXNTYPE,3)='DOC'
	 SET @CCMD=N'SELECT @CMEMOIDOUT='+@CMASTERKEYFIELD+',@CFINYEAROUT=FIN_YEAR FROM [TMP_'+@CXNTYPE+'_'+@CXNMASTERTABLENAME+'_'+@CXNID+']'
 ELSE   
 IF @CXNTYPE='XNSCHI'
	 SET @CCMD=N'SELECT @CMEMOIDOUT='+@CMASTERKEYFIELD+' FROM TMP_'+@CXNTYPE+'_LOCCIM_'+LTRIM(RTRIM(STR(@NSPID)))  
 ELSE	 
	SET @CCMD=N'SELECT @CMEMOIDOUT='+@CMASTERKEYFIELD+',@CFINYEAROUT=FIN_YEAR FROM TMP_'+@CXNTYPE+@CDEPTID+'_'+@CXNMASTERTABLENAME+  
     '_'+LTRIM(RTRIM(STR(@NSPID)))  
     
     
 PRINT ISNULL(@CCMD,'NULLCMD-CHK1')  
 EXEC SP_EXECUTESQL @CCMD,N'@CMEMOIDOUT VARCHAR(40) OUTPUT,@CFINYEAROUT VARCHAR(40) OUTPUT',  
        @CMEMOIDOUT=@CMEMOID OUTPUT,@CFINYEAROUT=@CFINYEAR OUTPUT  
   
    
 IF @CXNTYPE='XNSSLS'  
 BEGIN  
	  SELECT @NMEMONOLEN=10  
	  SET @NGRPCHARS=  LEN(RIGHT(@CMEMOID,@NMEMONOLEN))-CHARINDEX('-',REVERSE(RIGHT(@CMEMOID,@NMEMONOLEN)))+1
	  SET @NSERIESCHARS=@NMEMONOLEN-@NGRPCHARS
 END  

 ELSE
 IF @CXNTYPE='XNSARC'  
 BEGIN  
	  SELECT @NMEMONOLEN=9  
	  SET @NGRPCHARS=  LEN(RIGHT(@CMEMOID,@NMEMONOLEN))-CHARINDEX('-',REVERSE(RIGHT(@CMEMOID,@NMEMONOLEN)))+1
	  SET @NSERIESCHARS=@NMEMONOLEN-@NGRPCHARS
 END  
  
  
 ELSE   
 IF @CXNTYPE IN ('XNSPUR','DOCCHO','DOCCHI','XNSCHO','XNSCHI','DOCPO','DOCPUR','XNSIRT','XNSCNC','XNSWPS','XNSSCF')  
 BEGIN
	SET @NMEMONOLEN=10
	SET @NGRPCHARS =LEN(RIGHT(@CMEMOID,@NMEMONOLEN))-CHARINDEX('-',REVERSE(RIGHT(@CMEMOID,@NMEMONOLEN)))+1
	SET @NSERIESCHARS=@NMEMONOLEN-@NGRPCHARS
 END
 
 ELSE 
 IF @CXNTYPE IN ('XNSWSR','XNSWSL')
	SELECT @NMEMONOLEN=10,@NGRPCHARS=2,@NSERIESCHARS=8
 ELSE   
 IF @CXNTYPE IN ('XNSACT')  
	SELECT @NGRPCHARS=7,@NSERIESCHARS=8,@NMEMONOLEN=15  
 
 ELSE   
 IF @CXNTYPE IN ('XNSPEM')  
	SELECT @NGRPCHARS=2,@NSERIESCHARS=5,@NMEMONOLEN=7  

 ELSE   
 IF @CXNTYPE IN ('XNSJWI','XNSJWR')  
	SELECT @NGRPCHARS=2,@NSERIESCHARS=5,@NMEMONOLEN=7
   
 ELSE  
  SELECT @NGRPCHARS=2,@NSERIESCHARS=8,@NMEMONOLEN=10    
  
 PRINT 'MERGE MEMO ID :'+@CMEMOID+'GRP CHARS :'+STR(@NGRPCHARS)  
 SET @CCMD=N'SELECT TOP 1 @CFIRSTMEMOIDOUT='+@CMASTERKEYFIELD+' FROM '+@CXNMASTERTABLENAME+' WHERE   
    FIN_YEAR='''+@CFINYEAR+''' AND LEFT(RIGHT('+@CMASTERKEYFIELD+','+LTRIM(RTRIM(STR(@NMEMONOLEN)))+'),'+  
    LTRIM(RTRIM(STR(@NGRPCHARS)))+')='''+  
    LEFT(RIGHT(@CMEMOID,@NMEMONOLEN),@NGRPCHARS)+''' ORDER BY '+@CMASTERKEYFIELD  
 PRINT @CCMD  
 EXEC SP_EXECUTESQL @CCMD,N'@CFIRSTMEMOIDOUT VARCHAR(40) OUTPUT',@CFIRSTMEMOIDOUT=@CFIRSTMEMOID OUTPUT      
   
 PRINT 'FIRST MEMO ID : '+@CFIRSTMEMOID  
   
    
 IF @CMEMOID=ISNULL(@CFIRSTMEMOID,'')    
	  SET @CPREVMEMOID=@CMEMOID  
 ELSE  
 BEGIN  
	  SET @NPREVMEMOID=CONVERT(NUMERIC,RIGHT(RIGHT(@CMEMOID,@NMEMONOLEN),@NMEMONOLEN-@NGRPCHARS))-1  
	  
	  PRINT 'PREV MEMO NO.:'+STR(@NPREVMEMOID)
	  SET @CPREVMEMOID=SUBSTRING(@CMEMOID,1,LEN(@CMEMOID)-(@NMEMONOLEN-@NGRPCHARS))+REPLICATE('0',@NMEMONOLEN-@NGRPCHARS  
		   -LEN(LTRIM(RTRIM(STR(@NPREVMEMOID)))))+LTRIM(RTRIM(STR(@NPREVMEMOID)))  
	    
	  IF @NPREVMEMOID=0  
	  BEGIN  
	   SET @CPREVMEMOID=''  
	   RETURN  
	  END   
	    
	  PRINT 'PREV MEMO ID :'+@CPREVMEMOID+' FIRST MEMO ID :'+ISNULL(@CFIRSTMEMOID,'NULL FIRST MEMO')  
 END  

 SET @CCMD=N'IF NOT EXISTS (SELECT '+@CMASTERKEYFIELD+' FROM '+@CXNMASTERTABLENAME+' WHERE  '+ 
		   (CASE WHEN @CXNTYPE='XNSCHI' THEN '' ELSE ' FIN_YEAR='''+@CFINYEAR+''' AND ' END)+'
		   SUBSTRING('+@CMASTERKEYFIELD+',3,LEN('+@CMASTERKEYFIELD+'))='''+
		   SUBSTRING(@CPREVMEMOID,3,LEN(@CPREVMEMOID))+''')  
	  SET @BSERIESBROKENOUT=1  
	  ELSE  
	  SET @BSERIESBROKENOUT=0'  
 PRINT @CCMD      
 EXEC SP_EXECUTESQL @CCMD,N'@BSERIESBROKENOUT BIT OUTPUT',@BSERIESBROKENOUT=@BSERIESBROKEN OUTPUT  
 
 IF @BSERIESBROKEN=1     
 BEGIN    
  SET @CERRORMSGOUT= 'PREVIOUS '+@CXNTYPE+' MEMO NO.: '+RIGHT(@CPREVMEMOID,@NMEMONOLEN)+' NOT FOUND...PLEASE CHECK'  
  SET @CRETCMDOUT='SELECT '''+@CPREVMEMOID+''' AS MEMO_ID,'''+@CERRORMSGOUT+''' AS ERRMSG'  
 END   
 ELSE  
  SET @CPREVMEMOID=''  
END  
---- 'END OF CREATING PROCEDURE SP_CHKMEMOSERIES
