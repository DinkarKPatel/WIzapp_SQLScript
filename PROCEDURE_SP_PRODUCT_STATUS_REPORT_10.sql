
CREATE PROCEDURE SP_PRODUCT_STATUS_REPORT_10
(
 @nQueryID	INT,  
 @DFM_DT DATETIME='',  
 @DTO_DT DATETIME='',  
 @REF_NO VARCHAR(100)='',  
 @BUYER_NAME VARCHAR(100)='',  
 @CORDER_NO VARCHAR(100)='',  
 @JOBCARD_NO VARCHAR(100)=''  
)  
AS  
BEGIN
            
			IF OBJECT_ID ('TEMPDB..#TMPDETAILS','U') IS NOT NULL  
				 DROP TABLE #TMPDETAILS  
	        
		SELECT A.DEPT_ID ,ISNULL(LM.AC_NAME,'') AS BUYER_NAME,  
		ISNULL(BM.ORDER_NO,'') AS ORDER_NO,  
		ISNULL(CONVERT(VARCHAR,BM.ORDER_DT,105),'') AS ORDER_DT, 
		ISNULL(BD.ORDER_ID,'') AS ORDER_ID, 
		ISNULL(BD.QUANTITY ,0) AS BO_QTY,
		ISNULL(BM.REF_NO,'') AS REF_NO,  
		ISNULL(CONVERT(VARCHAR,BM.DELIVERY_DT,105),'') AS DELIVERY_DT,  
		ISNULL(OM.MEMO_NO,'') AS JOBCARD_NO,  
		ISNULL(CONVERT(VARCHAR,OM.MEMO_DT,105) ,'') AS JOBCARD_DT,  
		ISNULL(OM.MEMO_ID ,'') AS MEMO_ID,  
		A.PRODUCT_CODE ,  
		ART.ARTICLE_NO,  
		ART.ARTICLE_NAME ,  
		ART.ARTICLE_CODE,  
		P1.PARA1_NAME ,  
		P1.PARA1_CODE ,  
		P2.PARA2_NAME ,  
		P2.PARA2_CODE ,  
		CAST(1 AS NUMERIC(10,2)) AS ORD_QTY  ,
		A.XN_QTY,
		A1.attr1_key_name AS [BRAND],
		A.JOB_CODE ,
	    CAST('' AS VARCHAR(100))  AS NEXT_JOB_NAME
	   into #TMPDETAILS  
	   FROM ORD_PLAN_MST OM (NOLOCK)
	   JOIN ORD_PLAN_DET OD (NOLOCK) ON OM.MEMO_ID =OD.MEMO_ID 
	   JOIN ORD_PLAN_BARCODE_DET OBD (NOLOCK) ON OBD.REFROW_ID =OD.ROW_ID 
	   LEFT JOIN BUYER_ORDER_DET BD (NOLOCK) ON BD.row_id =OD.WOD_ROW_ID  
	   LEFT JOIN BUYER_ORDER_MST BM (NOLOCK ) ON BM.ORDER_ID=BD.ORDER_ID   
	   LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =BM.AC_CODE  
	   JOIN  
	   (  
		 
		 SELECT A.DEPT_ID , A.PRODUCT_CODE ,ISNULL(A.JOB_CODE,'') AS JOB_CODE ,
		 A.QUANTITY_IN_STOCK AS XN_QTY
		 FROM JOBWORK_PMT  A
		 WHERE ISNULL(A.QUANTITY_IN_STOCK,0)>0
		  
	   ) A  ON OBD.PRODUCT_CODE =A.PRODUCT_CODE 
	   JOIN SKU (NOLOCK) ON SKU.product_code =A.PRODUCT_CODE   
	   JOIN ARTICLE ART (NOLOCK) ON ART.article_code =SKU.article_code   
	   JOIN para1 P1 (NOLOCK) ON P1.para1_code =SKU.para1_code   
	   JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=SKU.PARA2_CODE  
	   LEFT OUTER JOIN article_fix_attr FIX_ATTR (NOLOCK) ON FIX_ATTR.article_code=ART.article_code
	   LEFT OUTER JOIN attr1_mst A1 (NOLOCK) ON A1.attr1_key_code=FIX_ATTR.attr1_key_code
	   WHERE ISNULL(BM.CANCELLED,0)=0  AND ISNULL(OM.CANCELLED,0)=0 
	   AND (@REF_NO='' OR ISNULL(BM.REF_NO,'')=@REF_NO)  
	   AND (@BUYER_NAME='' OR ISNULL(LM.AC_CODE ,'')=@BUYER_NAME)  
	   AND (@CORDER_NO='' OR ISNULL(BM.ORDER_ID,'')=@CORDER_NO)  
	   AND (@JOBCARD_NO='' OR ISNULL(OM.MEMO_ID,'')=@JOBCARD_NO)  
	   AND (@DFM_DT='' or ISNULL(BM.ORDER_DT,ISNULL(OM.MEMO_DT ,'')) BETWEEN @DFM_DT AND @DTO_DT  )
	   

	    
	    UPDATE A SET NEXT_JOB_NAME=CASE WHEN A.JOB_CODE<>'' AND  ISNULL(NJ.JOB_CODE,'')='' THEN 'TTM'
	                                    ELSE ISNULL(JOBS .JOB_NAME,'') END
	    FROM #TMPDETAILS A
	    LEFT JOIN ORD_PLAN_JOB T3 (NOLOCK) ON   A.MEMO_ID=T3.MEMO_ID AND T3.ARTICLE_CODE=A.ARTICLE_CODE AND T3.JOB_CODE=A.JOB_CODE 
		LEFT JOIN
		(
		  SELECT NJ.MEMO_ID,NJ.ARTICLE_CODE  ,NJ.JOB_CODE ,NJ.JOB_ORDER  
		  FROM ORD_PLAN_JOB  NJ (NOLOCK)
		) NJ ON  A.MEMO_ID=NJ.MEMO_ID AND A.ARTICLE_CODE=NJ.ARTICLE_CODE AND   ISNULL(T3.JOB_ORDER,0)+1=NJ.JOB_ORDER
		LEFT JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE =NJ.JOB_CODE
		
        DECLARE @CNEXT_JOB_NAME VARCHAR(MAX),@DTSQL NVARCHAR(MAX)
        
       SELECT @CNEXT_JOB_NAME=ISNULL(@CNEXT_JOB_NAME+',','')+QUOTENAME(NEXT_JOB_NAME)   
			 
	   FROM  
	   (  
	   SELECT  A.NEXT_JOB_NAME ,CASE WHEN A.NEXT_JOB_NAME='TTM' THEN 100 ELSE  ISNULL(B.JOB_SR,0) END  AS JOB_SR   
	   FROM #TMPDETAILS  A
	   LEFT JOIN jobs B (NOLOCK) ON A.NEXT_JOB_NAME =B.job_name 
	   WHERE ISNULL(A.NEXT_JOB_NAME,'')<>''
	   GROUP BY  A.NEXT_JOB_NAME,CASE WHEN A.NEXT_JOB_NAME='TTM' THEN 100 ELSE  ISNULL(B.JOB_SR,0) END 
	   ) A  
		ORDER BY ISNULL(A.JOB_SR,0)
		
		
		
		 SET @DTSQL=N'SELECT A.DEPT_ID as [Location Name], A.BUYER_NAME as [Party] ,A.ORDER_NO as [Order No] ,  
				  A.ORDER_DT as [Order Date],DELIVERY_DT as [Delivery Date],  
				  A.REF_NO as [Buyer Ref No],  
				  A.BO_QTY as [Buyer Order Qty] ,
				  A.JOBCARD_NO as [JobCard No],A.JOBCARD_DT as [JobCard Date] ,  
				  A.ARTICLE_NO [Article],A.ARTICLE_NAME as [Article Name] ,  
				  A.PARA1_NAME as [Color] ,A.PARA2_NAME as [Size] ,
				  A.BRAND, 
				  A.ORDER_QTY AS [JobCard Qty] ,
				 '+@CNEXT_JOB_NAME+'  
			
		   FROM  
		   (  
			SELECT A.DEPT_ID, A.BUYER_NAME ,A.ORDER_NO ,
				   A.ORDER_ID,A.ORDER_DT,a.BO_QTY ,
				   A.DELIVERY_DT,A.REF_NO,  
				   A.JOBCARD_NO ,A.JOBCARD_DT ,  
				   A.MEMO_ID,  
				   A.ARTICLE_NO,A.ARTICLE_NAME,A.ARTICLE_CODE ,  
				   A.PARA1_NAME,A.PARA1_CODE ,A.PARA2_NAME ,A.PARA2_CODE ,  
				   A.BRAND,
				   SUM(A.ORD_QTY) AS ORDER_QTY 
				   
		   FROM #TMPDETAILS A  
		   GROUP BY A.DEPT_ID, A.BUYER_NAME ,A.ORDER_NO ,A.ORDER_DT,a.BO_QTY ,A.DELIVERY_DT,A.REF_NO,  
		   A.memo_id,A.JOBCARD_NO ,A.JOBCARD_DT, A.ARTICLE_NO,A.ARTICLE_NAME,A.ARTICLE_CODE ,  
		   A.PARA1_NAME,A.PARA1_CODE ,A.PARA2_NAME ,A.PARA2_CODE,A.BRAND,a.MEMO_ID ,A.ORDER_ID
		   ) A   
		    LEFT JOIN  
		   (  
		     
			SELECT MEMO_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,'+@CNEXT_JOB_NAME+'  
			FROM  
			(  
			 SELECT A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,  
					NEXT_JOB_NAME,  
					SUM(XN_QTY) AS NEXT_JOB_QTY  
			 FROM #TMPDETAILS A  
			 GROUP BY A.MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,NEXT_JOB_NAME  
			 ) A  
			  PIVOT  
			  (  
				 SUM(NEXT_JOB_QTY) FOR NEXT_JOB_NAME IN ('+@CNEXT_JOB_NAME+')  
			  ) AS PV1  
				
		     
		   ) B ON A.ARTICLE_CODE=B.ARTICLE_CODE AND A.PARA1_CODE=B.PARA1_CODE AND A.PARA2_CODE=B.PARA2_CODE   
		   AND A.MEMO_ID=B.MEMO_ID   '  
		   PRINT @DTSQL  
		   EXEC (@DTSQL) 
	   
	   
	END  



