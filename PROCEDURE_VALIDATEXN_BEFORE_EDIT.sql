create PROCEDURE VALIDATEXN_BEFORE_EDIT--(LocId 3 digit change by Sanjay:06-11-2024)
@CXNTYPE VARCHAR(10),
@CMEMOID VARCHAR(100),
@BCANCELXN BIT,
@CUSERCODE CHAR(7)='',
@CERRORMSG VARCHAR(200)='' OUTPUT,
@CEXPRERRORMSG VARCHAR(200)='' OUTPUT,
@CLOCID	VARCHAR(4)='' ,
@nUpdatemode NUMERIC(1,0)=2,
@cXnLocationCode VARCHAR(4)=''
AS
BEGIN
		
	DECLARE @CCURLOCID VARCHAR(4),@CMASTERTABLENAME VARCHAR(100),@CKEYFIELD VARCHAR(100),
			@CCMD NVARCHAR(MAX),@BCANCELLED BIT,@CLOGINLOCID VARCHAR(4),@ALLOW_PUR_AT_HO BIT,
			@NALLOWEDITAT NUMERIC(1,0),@HOLOCID VARCHAR(4),@CFILTERCONDITITON VARCHAR(500),
			@CVALIDUSERCODE CHAR(7),@CVALIDUSERCODE1 CHAR(7)
			
			

			
	SET @CERRORMSG=''
	SET @CEXPRERRORMSG=''	

   if @cXnType='PARCEL' 
   BEGIN
   	    EXEC VALIDATEXN_PARCEL_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	 
		goto end_proc
   END

   if @cXnType='EOSSSORDN' 
   BEGIN
   	    EXEC VALIDATEXN_EOSSSOR_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	 
		goto end_proc
   END

   if @cXnType='EOSSDN' 
   BEGIN
   	    EXEC VALIDATEXN_EOSSDN_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	 
		goto end_proc
   END

   if @cXnType='EDT' 
   BEGIN
   	    EXEC VALIDATEXN_SORTERMS_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	 
		goto end_proc
   END
		  
   if @cXnType='wps' ----- Currently running slow at Cobb ...Shall carry out rest validations later on (22-01-2020)
   BEGIN
   	    EXEC VALIDATEXN_WPS_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	 
		goto end_proc
   END
   
   
	SELECT @CCURLOCID=@CLOCID


    IF ISNULL(@CCURLOCID,'')=''
	 BEGIN
		SET @CERRORMSG =' LOCATION ID CAN NOT BE BLANK  '  
		GOTO END_PROC    
	 END

	
	
	IF @CXNTYPE='PUR'
	BEGIN
		SELECT @ALLOW_PUR_AT_HO=ALLOW_PURCHASE_AT_HO FROM LOCATION A (NOLOCK) JOIN pim01106 b (NOLOCK) ON a.dept_id=b.dept_id 
		WHERE mrr_id=@CMEMOID
	END

	SELECT @HOLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'
	
	SET @CERRORMSG=''
	EXEC VALIDATE_XN_DATA_FREEZE  @CXNTYPE,@CUSERCODE,@CMEMOID ,'',@CERRORMSG OUTPUT
    IF ISNULL(@CERRORMSG,'')<>''
		GOTO END_PROC
		
		
		
	---- FIRSTLY, DO SOME VALIDATIONS COMMON FOR ALL TRANSACTION
	---- AFTER THAT CALL TRANSACTION SPECIFIC VALIDATIONS PROCEDURE
	
		
	DECLARE @BFLAG BIT
	
	IF @CXNTYPE <> 'XNSPOM' 
	BEGIN
		IF @CXNTYPE='PUR'
		BEGIN
			SET @BFLAG=0
			IF ISNULL(@ALLOW_PUR_AT_HO,0)=0
				SET @BFLAG=(CASE WHEN @cXnLocationCode<>@CCURLOCID THEN 0 ELSE 1 END) 
			ELSE
			BEGIN
			DECLARE @send_to_loc BIT
				SELECT @NALLOWEDITAT=ISNULL(ALLOW_EDIT_AT,1) ,@send_to_loc=ISNULL(send_to_loc,0) FROM PIM01106 WHERE MRR_ID=@CMEMOID
				IF @NALLOWEDITAT=1 AND @HOLOCID = @CCURLOCID 
					SET @BFLAG=1
				ELSE IF @NALLOWEDITAT=2 AND @HOLOCID <> @CCURLOCID
					SET @BFLAG=1
				ELSE IF @NALLOWEDITAT=2 AND @HOLOCID <> @cXnLocationCode AND @send_to_loc=0
					SET @BFLAG=1
				ELSE IF @HOLOCID = @CCURLOCID AND @cXnLocationCode=@HOLOCID
					SET @BFLAG=1
				
			END    
			
			--ALLOW TO CANCELLED GROUP PURCHASE 

			IF EXISTS (SELECT TOP 1 'U' FROM PIM01106 (NOLOCK) WHERE MRR_ID=@CMEMOID  AND INV_MODE =2)
			BEGIN
			   
			   --CANCELLED ALLOWED IN GROUP PURCHASE AS DISCUSS WITH SIR 
			    DECLARE @CALLOWTOCANCELLEDGROUPPURCHASE VARCHAR(10)
			   	SELECT TOP 1 @callowtocancelledgrouppurchase =VALUE FROM USER_ROLE_DET A(NOLOCK)
				JOIN USERS B(NOLOCK) ON A.ROLE_ID=B.ROLE_ID
				WHERE USER_CODE=@CUSERCODE 
				AND FORM_NAME='FrmTranPurchaseInvoice' 
				AND FORM_OPTION='Allow_To_cancelled_Group_Purchase'	

				SELECT TOP 1 @cXnLocationCode=location_code FROM pim01106 (NOLOCK) WHERE mrr_id=@CMEMOID
			   IF @BCANCELXN=1 AND  @CALLOWTOCANCELLEDGROUPPURCHASE='1' and @cXnLocationCode=@CLOCID
			     SET @CERRORMSG=''
			   ELSE
			   BEGIN

					SET @CERRORMSG='You Can Not Edit/canccel Group Purchase '
					RETURN

				END

			END



		END
		ELSE
		IF @CXNTYPE='WSL'
		BEGIN
			DECLARE @CERPINTEGRATIONENABLED VARCHAR(4)
 
			SELECT  TOP 1 @CERPINTEGRATIONENABLED = VALUE FROM CONFIG WHERE CONFIG_OPTION = 'ENABLE_ERP_INTEGRATION'		
			
			SET @CERPINTEGRATIONENABLED=ISNULL(@CERPINTEGRATIONENABLED,'')
			
			IF @CERPINTEGRATIONENABLED='1'
				SET @BFLAG=1
			ELSE
			SELECT TOP 1 @cXnLocationCode=location_code FROM inm01106 (NOLOCK) WHERE inv_id=@CMEMOID
			SET @BFLAG=(CASE WHEN @cXnLocationCode<>@CCURLOCID THEN 0 ELSE 1 END)     
		END
		ELSE IF @CXNTYPE='VCH'  OR @CXNTYPE = '_WOD'--@ROHIT : ADDED AS PER INSTRUCTION OF MR. SANJIV BHATIA REGARDING MEENA BAAZAR TICKET ID 04-0541
		BEGIN
			SET @BFLAG=1
		END
		ELSE
		BEGIN
			SET @BFLAG=(CASE WHEN @cXnLocationCode<>@CCURLOCID THEN 0 ELSE 1 END)     
		END	
		
		IF ISNULL(@BFLAG,0)=0
		BEGIN
			SET @CERRORMSG='MEMO HAS BEEN GENERATED FROM OTHER LOCATION ..... CANNOT EDIT/CANCEL'
			RETURN
		END
		
	END	
	

	
	IF EXISTS (SELECT TOP 1 MEMO_ID FROM POSTACT_VOUCHER_LINK A JOIN VM01106 B ON A.VM_ID=B.VM_ID
			   WHERE XN_TYPE=@CXNTYPE AND MEMO_ID=@CMEMOID AND B.CANCELLED=0) AND @CUSERCODE<>'0000000'
			   
	BEGIN	

		SELECT @CVALIDUSERCODE=A.USER_CODE FROM USERS A JOIN USER_ROLE_DET B ON A.ROLE_ID=B.ROLE_ID
		WHERE A.USER_CODE=@CUSERCODE AND B.FORM_OPTION='EDIT_POSTED_BILLS' AND FORM_NAME='FRMVCHPOSTING'
		AND VALUE='1'
		
	
		
		IF @CXNTYPE='PUR'
		 BEGIN
			SELECT @CVALIDUSERCODE1=A.USER_CODE FROM USERS A JOIN USER_ROLE_DET B ON A.ROLE_ID=B.ROLE_ID
			WHERE A.USER_CODE=@CUSERCODE AND B.FORM_OPTION='DONOT_EDIT_POSTED_INVOICE' AND FORM_NAME='FRMTRANPURCHASEINVOICE'
			AND VALUE='1' 
		END 


		IF @CXNTYPE='PRT'
		 BEGIN
			SELECT @CVALIDUSERCODE1=A.USER_CODE FROM USERS A JOIN USER_ROLE_DET B ON A.ROLE_ID=B.ROLE_ID
			WHERE A.USER_CODE=@CUSERCODE AND B.FORM_OPTION='DONOT_EDIT_POSTED_INVOICE' AND FORM_NAME='FRMTRANPURCHASERETURN'
			AND VALUE='1' 
		END 
		IF @CXNTYPE='SLS'
		 BEGIN
			SELECT @CVALIDUSERCODE1=A.USER_CODE FROM USERS A JOIN USER_ROLE_DET B ON A.ROLE_ID=B.ROLE_ID
			WHERE A.USER_CODE=@CUSERCODE AND B.FORM_OPTION='DONOT_EDIT_POSTED_INVOICE' AND FORM_NAME='FRMSALE'
			AND VALUE='1' 
		END 
		IF @CXNTYPE='WSL'
		 BEGIN
			SELECT @CVALIDUSERCODE1=A.USER_CODE FROM USERS A JOIN USER_ROLE_DET B ON A.ROLE_ID=B.ROLE_ID
			WHERE A.USER_CODE=@CUSERCODE AND B.FORM_OPTION='DONOT_EDIT_POSTED_INVOICE' AND FORM_NAME='FRMWSLINVOICE'
			AND VALUE='1' 
		END
		IF @CXNTYPE='WSR'
		 BEGIN
			SELECT @CVALIDUSERCODE1=A.USER_CODE FROM USERS A JOIN USER_ROLE_DET B ON A.ROLE_ID=B.ROLE_ID
			WHERE A.USER_CODE=@CUSERCODE AND B.FORM_OPTION='DONOT_EDIT_POSTED_INVOICE' AND FORM_NAME='FRMWSCRNOTE'
			AND VALUE='1' 
		END
		IF @CXNTYPE='PTC'
		 BEGIN
		
			SELECT @CVALIDUSERCODE1=A.USER_CODE FROM USERS A JOIN USER_ROLE_DET B ON A.ROLE_ID=B.ROLE_ID
			WHERE A.USER_CODE=@CUSERCODE AND B.FORM_OPTION='DONOT_EDIT_POSTED_INVOICE' AND FORM_NAME='FRMPCEXPENSE'
			AND VALUE='1' 
			
		END
			   		--SELECT ISNULL(@CVALIDUSERCODE,''),ISNULL(@CVALIDUSERCODE1,'')
		--IF ISNULL(@CVALIDUSERCODE,'')=''	OR ISNULL(@CVALIDUSERCODE1,'')<>''
		IF ISNULL(@CVALIDUSERCODE1,'')<>''
		BEGIN
			SET @CERRORMSG='THIS MEMO HAS BEEN POSTED INTO ACCOUNTS.........CAN NOT EDIT/CANCEL'
			RETURN
		END
	END
	
	IF @CXNTYPE='PUR'
		SELECT	@CMASTERTABLENAME='PIM01106',@CKEYFIELD='MRR_ID' 
	ELSE
	IF @CXNTYPE='PRT'
		SELECT	@CMASTERTABLENAME='RMM01106',@CKEYFIELD='RM_ID' 
	ELSE
	IF @CXNTYPE='SLS'
		SELECT	@CMASTERTABLENAME='CMM01106',@CKEYFIELD='CM_ID' 
	ELSE
	IF @CXNTYPE='APP'
		SELECT	@CMASTERTABLENAME='APM01106',@CKEYFIELD='MEMO_ID' 
	ELSE
	IF @CXNTYPE='APR'
		SELECT	@CMASTERTABLENAME='APPROVAL_RETURN_MST',@CKEYFIELD='MEMO_ID' 
	ELSE
	IF @CXNTYPE='WSL'
		SELECT	@CMASTERTABLENAME='INM01106',@CKEYFIELD='INV_ID' 
	ELSE
	IF @CXNTYPE='WSR'
		SELECT	@CMASTERTABLENAME='CNM01106',@CKEYFIELD='CN_ID' 
	ELSE
	IF @CXNTYPE='CNC'
		SELECT	@CMASTERTABLENAME='ICM01106',@CKEYFIELD='CNC_MEMO_ID' 
	ELSE
	IF @CXNTYPE='PTC'
		SELECT	@CMASTERTABLENAME='PEM01106',@CKEYFIELD='PEM_MEMO_ID' 
	ELSE
	IF @CXNTYPE='ARC'
		SELECT	@CMASTERTABLENAME='ARC01106',@CKEYFIELD='ADV_REC_ID' 
	ELSE
	IF @CXNTYPE='RPS'
		SELECT	@CMASTERTABLENAME='RPS_MST',@CKEYFIELD='CM_ID' 
	ELSE
	IF @CXNTYPE='SNC'
		SELECT	@CMASTERTABLENAME='SNC_MST',@CKEYFIELD='MEMO_ID' 
		ELSE
	IF @CXNTYPE='JWI'
		SELECT	@CMASTERTABLENAME='JOBWORK_ISSUE_MST',@CKEYFIELD='ISSUE_ID' 
		ELSE
	IF @CXNTYPE='JWR'
		SELECT	@CMASTERTABLENAME='JOBWORK_RECEIPT_MST',@CKEYFIELD='RECEIPT_ID' 		
	    ELSE
	IF @CXNTYPE='PRD_JWI'
		SELECT	@CMASTERTABLENAME='PRD_JOBWORK_ISSUE_MST',@CKEYFIELD='ISSUE_ID' 
	ELSE
	IF @CXNTYPE='PRD_JWR'
		SELECT	@CMASTERTABLENAME='PRD_JOBWORK_RECEIPT_MST',@CKEYFIELD='RECEIPT_ID' 
	ELSE
	IF @CXNTYPE='WPS'
		SELECT	@CMASTERTABLENAME='WPS_MST',@CKEYFIELD='PS_ID' 
	ELSE
	IF @CXNTYPE='WOD'
		SELECT	@CMASTERTABLENAME='BUYER_ORDER_MST',@CKEYFIELD='ORDER_ID' 	
	ELSE
	IF @CXNTYPE='WPL'
		SELECT	@CMASTERTABLENAME='PLM01106',@CKEYFIELD='MEMO_ID'
    ELSE 
    IF @CXNTYPE='BDGPL'
		SELECT	@CMASTERTABLENAME='BUDGET_PLAN_MST',@CKEYFIELD='MEMO_NO'  	
    ELSE 
    IF @CXNTYPE='VCH'
		SELECT	@CMASTERTABLENAME='VM01106',@CKEYFIELD='VM_ID'
	ELSE 
    IF @CXNTYPE='BOM_ISU'
		SELECT	@CMASTERTABLENAME='BOM_ISSUE_MST',@CKEYFIELD='ISSUE_ID'   	
	ELSE 
    IF @CXNTYPE='JOB_CARD'
		SELECT	@CMASTERTABLENAME='ORD_PLAN_MST',@CKEYFIELD='MEMO_ID'
	ELSE 
    IF @CXNTYPE='TRF_TRD'
		SELECT	@CMASTERTABLENAME='TRANSFER_TO_TRADING_MST',@CKEYFIELD='MEMO_ID' 		
		   													
	IF ISNULL(@CMASTERTABLENAME,'')<>''
	BEGIN
		SET @CCMD=N'SELECT @BCANCELLEDOUT=CANCELLED FROM '+@CMASTERTABLENAME+'
					WHERE '+@CKEYFIELD+'='''+@CMEMOID+''''
		EXEC SP_EXECUTESQL @CCMD,N'@BCANCELLEDOUT BIT OUTPUT',@BCANCELLEDOUT=@BCANCELLED OUTPUT
		IF @BCANCELLED=1
		BEGIN
			SET @CERRORMSG='THIS MEMO IS ALREADY CANCELLED ..... CANNOT '+(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)
			RETURN
		END				
	END
	
	IF @CXNTYPE='BOM_ISU'
		EXEC VALIDATEXN_BOM_ISU_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE IF @CXNTYPE='JOB_CARD'
		EXEC VALIDATEXN_JOB_CARD_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT,@CUSERCODE
	ELSE IF @CXNTYPE='TRF_TRD'
		EXEC VALIDATEXN_TRF_TRD_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE IF @CXNTYPE='PUR'
		EXEC VALIDATEXN_PUR_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE
	IF @CXNTYPE='PRT'
		EXEC VALIDATEXN_PRT_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE	
	IF @CXNTYPE='SLS'
		EXEC VALIDATEXN_SLS_BEFORE_EDIT 
		@CMEMOID=@CMEMOID,
		@BCANCELXN=@BCANCELXN,
		@CERRORMSG=@CERRORMSG OUTPUT,
		@CEXPRERRORMSG=@CEXPRERRORMSG OUTPUT,
		@nUpdatemode=@nUpdatemode
	ELSE	
	IF @CXNTYPE='APP'
		EXEC VALIDATEXN_APP_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE	
	IF @CXNTYPE='APR'
		EXEC VALIDATEXN_APR_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE	
	IF @CXNTYPE='ARC'
		EXEC VALIDATEXN_ARC_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE   
    IF @CXNTYPE='WSL'  
		EXEC VALIDATEXN_WSL_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT 
    ELSE     
    IF @CXNTYPE='WSR'    
		EXEC VALIDATEXN_WSR_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
    ELSE     
    IF @CXNTYPE='RPS'    
		EXEC VALIDATEXN_RPS_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE		
	IF @CXNTYPE='SNC'    
		EXEC VALIDATEXN_SNC_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE		    
    IF @CXNTYPE='JWI'    
		EXEC VALIDATEXN_JWI_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE		    
    IF @CXNTYPE='JWR'    
	    EXEC VALIDATEXN_JWR_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE			
	IF @CXNTYPE='WOD'    
	    EXEC VALIDATEXN_WOD_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
	ELSE			
	IF @CXNTYPE='WPS'    
	    EXEC VALIDATEXN_WPS_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	 
	ELSE			
	IF @CXNTYPE='WPL'    
	    EXEC VALIDATEXN_WPL_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	 
	ELSE		    
    IF @CXNTYPE='BDGPL'    
	    EXEC VALIDATEXN_BDGPL_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	
	ELSE		    
    IF @CXNTYPE='CHO'    
	    EXEC VALIDATEXN_CHO_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	     	      
	ELSE		    
    IF @CXNTYPE='VCCH'    
	    EXEC VALIDATEXN_VCH_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	     	      
	ELSE		    
    IF @CXNTYPE='ARC'    
	    EXEC VALIDATEXN_ARC_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	     	      
    ELSE		    
    IF @CXNTYPE='hbd'    
	    EXEC VALIDATEXN_hbd_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	     	      
    ELSE		    
    IF @CXNTYPE='XNSPOM'    
	    EXEC VALIDATEXN_XNSPOM_BEFORE_EDIT @CMEMOID,@BCANCELXN,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT	     	      
   

	IF ISNULL(@CERRORMSG,'')<>''
		GOTO END_PROC
	
		IF @CXNTYPE='WOD'
		   SET @CXNTYPE='WSLORD'

	IF EXISTS (SELECT TOP 1 DEPT_ID FROM LOC_XNSAPPROVAL WHERE DEPT_ID=@CCURLOCID AND XN_TYPE=@CXNTYPE)
	BEGIN
	  
	

		EXEC SP3S_VALIDATEXN_EDIT_BY_LEVELUSER 
		@CXNTYPE=@CXNTYPE,
		@CMEMOID=@CMEMOID,
		@BCANCELXN=@BCANCELXN,
		@CUSERCODE=@CUSERCODE,
		@CERRORMSG=@CERRORMSG OUTPUT		
	END

END_PROC:
	
END
