CREATE PROCEDURE SP_PPC_TRANSFER_TO_MAIN
(
 @NQUERYID INT=0,
 @CORDER_ID VARCHAR(100)='',
 @CFIN_YEAR VARCHAR(10)='',
 @CMEMO_ID VARCHAR(30)=''
)
AS
BEGIN
   
	DECLARE @CORDER_STATUS VARCHAR(MAX)  
	IF @CORDER_ID=''  
	BEGIN  
	   SET @CORDER_STATUS=''  
	   SET @CORDER_ID='IN('''')'  
	END  
    ELSE   
	BEGIN  
	   SET @CORDER_STATUS='LATER'  
	END     
     DECLARE @DSSMS NVARCHAR(MAX)
      IF @NQUERYID IN (1,2,3)    
      BEGIN    
		IF OBJECT_ID('TEMPDB..#MAXJOB_DETAILS') IS NOT NULL     
		 DROP TABLE #MAXJOB_DETAILS    
		
        CREATE TABLE #MAXJOB_DETAILS    
		(    
		ORDER_ID VARCHAR(50)    
		,ROW_ID VARCHAR(100)    
		,JOB_CODE VARCHAR(50)    
		,JOB_ORDER INT    
		,BILL_NO  VARCHAR(100)    
        ,ARTICLE_CODE VARCHAR(100)
        ,RATE NUMERIC(10,2)
        ,CURRENCY_CODE VARCHAR(10)
		) 
		   
	  ---INSERT DETAILS WITH MAX JOB_ORDER---------------    
	    
	 SET @DSSMS=N' SELECT A.ORDER_ID ,A.ROW_ID, MAX(C.JOB_ORDER) AS [JOB_ORDER],B.BILL_NO 
            ,ARTICLE_CODE,RATE,A.CURRENCY_CODE       
			FROM PPC_BUYER_ORDER_DET A    
	  JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID =B.ORDER_ID     
	  JOIN PPC_BO_ART_JOBS C ON A.ROW_ID=C.REF_ROW_ID     
	  WHERE CANCELLED=0  
	  AND ('''+RTRIM(LTRIM(@CORDER_STATUS))+'''='''' OR B.ORDER_ID '+@CORDER_ID+')  
	  GROUP BY A.ORDER_ID ,A.ROW_ID,B.BILL_NO ,ARTICLE_CODE,RATE ,A.CURRENCY_CODE    '
	  PRINT @DSSMS
	   INSERT INTO #MAXJOB_DETAILS(ORDER_ID,ROW_ID,JOB_ORDER,BILL_NO,ARTICLE_CODE,RATE,CURRENCY_CODE)
	    EXEC SP_EXECUTESQL  @DSSMS 
	  ---------UPDATE MAX JOB CODE-------------------    
	  UPDATE #MAXJOB_DETAILS SET JOB_CODE = (SELECT A.JOB_CODE FROM DBO.PPC_BO_ART_JOBS A WITH(NOLOCK)    
				  WHERE A.REF_ROW_ID =#MAXJOB_DETAILS.ROW_ID     
				  AND A.JOB_ORDER=#MAXJOB_DETAILS.JOB_ORDER    
				  )    
	                                               
		  --SELECT FIRST GRID DATA------------    
		  IF OBJECT_ID('TEMPDB..#TEMPTABLE') IS NOT NULL    
			 DROP TABLE #TEMPTABLE    
		  SELECT   TMP.ORDER_ID,  
			  ART_ROW_ID=ART.ARTICLE_NO+SG.SIZEGROUP_NAME+P1.PARA1_NAME ,    
			  A.AC_CODE,LM.AC_NAME ,    
			  B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,    
			  B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,    
			  B.PARA1_CODE,P1.PARA1_NAME AS COLOR,    
			  B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,    
			  SKU.PARA2_CODE,P2.PARA2_NAME SIZE,    
			  SKU.PRODUCT_CODE ,    
			  1 AS QUANTITY,    
			  PMT.QUANTITY_IN_STOCK,    
			  RATE AS RATE, 
			  TMP.CURRENCY_CODE,   
			  CAST(0 AS NUMERIC(10,2)) AS AMOUNT     
			 ,TMP.JOB_ORDER,TMP.JOB_CODE,TMP.BILL_NO    
			,B.BO_DET_ROW_ID,TMP.ROW_ID 
			,ART.MRP
			,ART.WHOLESALE_PRICE AS WS_PRICE   
			INTO #TEMPTABLE    
			FROM PPC_FGBCG_MST A    
			JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID ---BO_DET_ROW_ID    
			JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID     
			JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE     
			JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE     
			JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE     
			JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE     
			JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE     
			JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE     
			JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE     
			JOIN #MAXJOB_DETAILS TMP ON TMP.ROW_ID = B.BO_DET_ROW_ID  
			JOIN    
		   (    
		   SELECT B.AC_CODE ,A.PRODUCT_CODE ,B.JOB_CODE ,A.QUANTITY      
		   FROM PPC_AGENCY_REC_FG_DET A    
		   JOIN PPC_AGENCY_REC_FG_MST B ON A.MEMO_ID =B.MEMO_ID     
		   WHERE B.CANCELLED =0 AND ISNULL(MEMO_TYPE,0)=1    
		   )REC ON REC.PRODUCT_CODE =SKU.PRODUCT_CODE AND REC.JOB_CODE=TMP.JOB_CODE    
		   WHERE 
		   --PMT.QUANTITY_IN_STOCK=1    AND
		   SKU.PARA2_CODE<>'0000000'   
		   
		   DELETE  FROM #TEMPTABLE WHERE ORDER_ID NOT IN
		   (SELECT ORDER_ID FROM #TEMPTABLE WHERE QUANTITY_IN_STOCK =1)
		    
    END    
IF @NQUERYID=1          
   GOTO LBLORDER        
ELSE IF @NQUERYID=2
   GOTO LBLGETDATE 
ELSE IF @NQUERYID=3
   GOTO LBLPARA2DATA
ELSE IF @NQUERYID=4
   GOTO LBLMST
ELSE IF @NQUERYID=5
   GOTO LCLSUMMARY
ELSE IF @NQUERYID=6
   GOTO LBLBARCODEPRINT      
    
ELSE
GOTO END_PROC    
 
 LBLORDER:
      
      SELECT A.ORDER_ID,A.BILL_NO FROM
      #TEMPTABLE A
      GROUP BY A.ORDER_ID,A.BILL_NO
      ORDER BY ORDER_ID 
 
 
  GOTO END_PROC
  
  
 LBLGETDATE:   
    SELECT A.ORDER_ID,    
		CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,    
		ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100))            
		,A.AC_CODE,A.AC_NAME ,    
		A.BILL_NO,    
		A.ARTICLE_CODE,A.ARTICLE_NO,A.PARA1_CODE, A.COLOR AS [PARA1_NAME],A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,    
		A.PARA3_CODE,A.BUYER_STYLE_NO AS [PARA3_NAME]--,JOB_ORDER, --,A.PARA2_CODE,A.SIZE,    
		 ,A.BO_DET_ROW_ID    
		,SUM(A.QUANTITY) AS [ALLOTED_QTY],     
		SUM(A.QUANTITY) AS [SELECT_QUANTITY],     
		RATE AS [RATE],    
		0 AS [AMOUNT],    
		0 AS [QUANTITY],
		'' AS [MANUAL_INVOICE_NO]  ,
		ISNULL(A.CURRENCY_CODE,'') AS CURRENCY_CODE ,
		ISNULL(CM.CURRENCY_NAME,'') AS CURRENCY_NAME,
		BO.SHIPPING_MODE ,
		BO.SHIPPING_NAME ,
		WS_PRICE ,
		MRP 
		
	FROM #TEMPTABLE A  
	JOIN 
	(
	   SELECT A.ROW_ID ,A.SHIPPING_MODE,C.SHIPPING_NAME  
	   FROM PPC_BUYER_ORDER_DET A
	   JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID =B.ORDER_ID 
	   JOIN PPC_SHIPPING_DETAILS C ON A.SHIPPING_MODE =C.SHIPPING_MODE 
	   WHERE B.CANCELLED =0
	)  BO ON BO.ROW_ID =A.BO_DET_ROW_ID    
	LEFT OUTER JOIN PPC_CURRENCY_MST CM ON CM.CURRENCY_CODE=A.CURRENCY_CODE
	GROUP BY A.AC_CODE,A.AC_NAME ,    
		A.BILL_NO,  A.ORDER_ID,   
		A.ARTICLE_CODE,A.ARTICLE_NO,A.PARA1_CODE, A.COLOR ,A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,    
		A.PARA3_CODE,A.BUYER_STYLE_NO,A.BO_DET_ROW_ID,RATE ,A.CURRENCY_CODE,CM.CURRENCY_NAME,BO.SHIPPING_MODE ,
		BO.SHIPPING_NAME ,WS_PRICE ,
		MRP     
       

GOTO END_PROC

LBLPARA2DATA:
   
		   IF OBJECT_ID('TEMPDB..#CALCULATE_ISSUE_PENDING_QTY') IS NOT NULL
		   DROP TABLE #CALCULATE_ISSUE_PENDING_QTY

			CREATE TABLE #CALCULATE_ISSUE_PENDING_QTY
			(
			PRODUCT_CODE VARCHAR(100)
			,ISSUED_QUANTITY INT
			)
			
		  SET @DSSMS=N'SELECT D.PRODUCT_CODE,D.QUANTITY
		  FROM PPC_TRANSFER_TO_TRADING_DET D WITH(NOLOCK) 
		  JOIN PPC_TRANSFER_TO_TRADING_MST M WITH(NOLOCK) ON D.MEMO_ID = M.MEMO_ID
		  WHERE  M.CANCELLED = 0'
		  PRINT @DSSMS
		  INSERT INTO #CALCULATE_ISSUE_PENDING_QTY (PRODUCT_CODE,ISSUED_QUANTITY )
		  EXEC SP_EXECUTESQL @DSSMS
		  
		  
		  SELECT DISTINCT     
		  CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,T.ROW_ID    
				,T.PARA2_CODE,T.SIZE AS [PARA2_NAME],T.BO_DET_ROW_ID    
		  ,SUM(CAST(T.QUANTITY AS NUMERIC(10,0))) AS [ALLOTED_QTY] 
		  ,CAST(0 AS NUMERIC(10,0)) AS [SELECT_QUANTITY]    
		  , SUM(ISNULL(ISSUED_QUANTITY,0)) AS [ISSUED_QTY]
		  ,(SUM(CAST(T.QUANTITY AS NUMERIC(10,0))) - SUM(ISNULL(ISSUED_QUANTITY,0))) AS [PENDING_QTY]
		 FROM #TEMPTABLE  T
		LEFT JOIN #CALCULATE_ISSUE_PENDING_QTY C ON T.PRODUCT_CODE = C.PRODUCT_CODE
		  GROUP BY T.ROW_ID,T.PARA2_CODE,T.SIZE,    
		 T.BO_DET_ROW_ID  
		     
   GOTO END_PROC
   
   LBLMST:
      SELECT DISTINCT  REPLACE(CONVERT(VARCHAR(11),M.MEMO_DT ,106),' ','-') AS MEMO_DT , M.MEMO_ID AS [MEMO_ID] 
		 ,CASE WHEN M.CANCELLED =0 THEN 'NO' ELSE 'YES' END AS CANCELLED ,
		 M.REMARKS,M.MEMO_DT  AS DT,M.MEMO_NO,M.REMARKS ,M.NET_AMOUNT ,M.SUBTOTAL 
		 FROM PPC_TRANSFER_TO_TRADING_MST M WITH(NOLOCK)    
		 WHERE (@CFIN_YEAR='' OR M.FIN_YEAR=@CFIN_YEAR) 
		 ORDER BY M.MEMO_DT  DESC ,M.MEMO_NO  DESC
		
   
   GOTO END_PROC
   
  LCLSUMMARY: 
   
    --DECLARE LOCAL VARIABLE----------
  DECLARE @SELECT_QTY INT,@RATE INT,@AMOUNT NUMERIC(10,2)    
               ,@SUBTOTAL NUMERIC(10,2)    
               ,@DISCOUNT_PERCENTAGE NUMERIC(10,2)    
               ,@DISCOUNT_AMOUNT NUMERIC(10,2)    
               ,@OTHER_CHARGE NUMERIC(10,2)   
               ,@QUANTITY INT 
               ,@ROUND_OFF NUMERIC(10,2)
               ,@CMEMO_NO VARCHAR(50) 
  
  ---SET VALUE INTO LOCAL VARIABLE  FROM MASTER TABLE PPC_INM01106
  SELECT @SUBTOTAL=SUBTOTAL, @CMEMO_NO = MEMO_NO 
  FROM PPC_TRANSFER_TO_TRADING_MST  WITH(NOLOCK) WHERE MEMO_ID  = @CMEMO_ID    
           
  ---CREATE TEMP TABLE FOR SELECT MAX JOB DETAIL----
  IF OBJECT_ID('TEMPDB..#MAXJOB_DETAILS1') IS NOT NULL     
     DROP TABLE #MAXJOB_DETAILS1    
  CREATE TABLE #MAXJOB_DETAILS1    
  (    
    ORDER_ID VARCHAR(50)    
   ,ROW_ID VARCHAR(100)    
   ,JOB_CODE VARCHAR(50)    
   ,JOB_ORDER INT    
   ,BILL_NO  VARCHAR(100)  
   ,CURRENCY_CODE VARCHAR(10)  
  )    
  ---INSERT DETAILS WITH MAX JOB_ORDER---------------    
   SET @DSSMS=N' SELECT A.ORDER_ID ,A.ROW_ID, MAX(C.JOB_ORDER) AS [JOB_ORDER],B.BILL_NO ,A.CURRENCY_CODE    
        FROM PPC_BUYER_ORDER_DET A    
  JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID =B.ORDER_ID     
  JOIN PPC_BO_ART_JOBS C ON A.ROW_ID=C.REF_ROW_ID     
  WHERE CANCELLED=0     
  GROUP BY A.ORDER_ID ,A.ROW_ID,B.BILL_NO,A.CURRENCY_CODE  '
  
  PRINT @DSSMS
  INSERT INTO #MAXJOB_DETAILS1(ORDER_ID,ROW_ID,JOB_ORDER,BILL_NO,CURRENCY_CODE)  
  EXEC SP_EXECUTESQL  @DSSMS 
     
  ---------UPDATE MAX JOB CODE-------------------    
  UPDATE #MAXJOB_DETAILS1 SET JOB_CODE = (SELECT A.JOB_CODE FROM DBO.PPC_BO_ART_JOBS A WITH(NOLOCK)    
              WHERE A.REF_ROW_ID =#MAXJOB_DETAILS1.ROW_ID     
             AND A.JOB_ORDER=#MAXJOB_DETAILS1.JOB_ORDER    
              )    
                                                                          
            
  --SELECT FIRST GRID DATA------------    
  IF OBJECT_ID('TEMPDB..#TEMPTABLE_DETAILS') IS NOT NULL    
     DROP TABLE #TEMPTABLE_DETAILS    
  SELECT     
		ART_ROW_ID=ART.ARTICLE_NO+SG.SIZEGROUP_NAME+P1.PARA1_NAME ,    
		A.AC_CODE,LM.AC_NAME ,    
		B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,    
		B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,    
		B.PARA1_CODE,P1.PARA1_NAME AS COLOR,    
		B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,    
		SKU.PARA2_CODE,P2.PARA2_NAME SIZE,    
		SKU.PRODUCT_CODE ,    
		PINM.QUANTITY AS QUANTITY,    
		CINM.QUANTITY AS SELECT_QTY,    
		PMT.QUANTITY_IN_STOCK,    
		CINM.RATE AS RATE,    
		ISNULL(CINM.QUANTITY,0)* ISNULL(CINM.RATE,0) AS AMOUNT     
		,TMP.JOB_ORDER,TMP.JOB_CODE,TMP.BILL_NO    
		,B.BO_DET_ROW_ID,TMP.ROW_ID ,
        1 AS [TOTAL_STOCK],
        TMP.CURRENCY_CODE ,
        CINM.MRP,
	    CINM.WS_PRICE AS WS_PRICE    
    INTO #TEMPTABLE_DETAILS    
    FROM PPC_FGBCG_MST A    
    JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID ---BO_DET_ROW_ID    
    JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID     
    JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE     
    JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE     
    JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE     
    JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE     
    JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE     
    JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE     
    JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE     
    JOIN #MAXJOB_DETAILS1 TMP ON TMP.ROW_ID = B.BO_DET_ROW_ID    
    JOIN    
   (    
   SELECT B.AC_CODE ,A.PRODUCT_CODE ,B.JOB_CODE ,A.QUANTITY      
   FROM PPC_AGENCY_REC_FG_DET A    
   JOIN PPC_AGENCY_REC_FG_MST B ON A.MEMO_ID =B.MEMO_ID     
   WHERE B.CANCELLED =0 AND ISNULL(MEMO_TYPE,0)=1    
   )REC ON REC.PRODUCT_CODE =SKU.PRODUCT_CODE AND REC.JOB_CODE=TMP.JOB_CODE    
   LEFT OUTER JOIN    
    (    
     SELECT A.PRODUCT_CODE,A.QUANTITY ,A.PURCHASE_PRICE AS RATE,A.AMOUNT,A.MRP ,A.WS_PRICE  
     FROM PPC_TRANSFER_TO_TRADING_DET  A    
     JOIN PPC_TRANSFER_TO_TRADING_MST  B ON A.MEMO_ID =B.MEMO_ID    
     WHERE B.CANCELLED=0    
     AND A.MEMO_ID = @CMEMO_ID    
     )CINM ON CINM.PRODUCT_CODE=PMT.PRODUCT_CODE    
   LEFT OUTER JOIN    
    (    
     SELECT A.PRODUCT_CODE,A.QUANTITY     
     FROM PPC_TRANSFER_TO_TRADING_DET A    
     JOIN PPC_TRANSFER_TO_TRADING_MST  B ON A.MEMO_ID=B.MEMO_ID    
     WHERE B.CANCELLED=0    
     AND A.MEMO_ID<= @CMEMO_ID    
     )PINM ON PINM.PRODUCT_CODE=PMT.PRODUCT_CODE    
   WHERE A.CANCELLED=0 --AND ISNULL(PINM.QUANTITY ,0) <> 0    
    
    
      --SELECT DATA FOR MASTER TABLE PPC_INM01106 

	IF OBJECT_ID('TEMPDB..#STOCK_DETAILS') IS NOT NULL
	  DROP TABLE #STOCK_DETAILS

	SELECT DISTINCT     
	@CMEMO_ID AS MEMO_ID,TEM.ROW_ID    
	,TEM.PARA2_CODE,TEM.SIZE AS [PARA2_NAME],TEM.BO_DET_ROW_ID    
	,SUM(CAST(TEM.TOTAL_STOCK  AS NUMERIC(10,0))) AS [ALLOTED_QTY]    
	,SUM(CAST(ISNULL(TEM .SELECT_QTY,0) AS NUMERIC(10,0))) AS [SELECT_QUANTITY]
	,CAST(0 AS NUMERIC(10,0)) AS ISSUED_QTY   
	,CAST(0 AS NUMERIC(10,0)) AS PENDING_QTY
	,TEM.CURRENCY_CODE 
	INTO #STOCK_DETAILS
	FROM #TEMPTABLE_DETAILS TEM    
	-- WHERE ISNULL(TEM .SELECT_QTY,0) <> 0
	GROUP BY TEM.ROW_ID,TEM.PARA2_CODE,TEM.SIZE,    
	TEM.BO_DET_ROW_ID,TEM.CURRENCY_CODE    
    
    ---UPDATE ISSUE QUANTITY--------------
	UPDATE S SET S.ISSUED_QTY = ISNULL(SPD.SHIPED_QUANTITY,0)
	FROM #STOCK_DETAILS S 
	JOIN
	(
	SELECT SUM(D.QUANTITY) AS [SHIPED_QUANTITY],T.SIZE FROM PPC_TRANSFER_TO_TRADING_MST M WITH(NOLOCK)
	JOIN PPC_TRANSFER_TO_TRADING_DET  D WITH(NOLOCK) ON M.MEMO_ID  =D.MEMO_ID
	LEFT JOIN #TEMPTABLE_DETAILS T ON D.PRODUCT_CODE = T.PRODUCT_CODE
	WHERE RIGHT(M.MEMO_NO ,LEN(M.MEMO_NO)-2) < RIGHT(@CMEMO_NO ,LEN(@CMEMO_NO )-2)
	AND M.CANCELLED = 0
	GROUP BY T.SIZE 
	) SPD ON S.PARA2_NAME = SPD.SIZE
   
    ---UPDATE PENDING QUANTITY-------------
    UPDATE #STOCK_DETAILS SET PENDING_QTY=ISNULL(ALLOTED_QTY,0) - ISNULL(ISSUED_QTY,0)

      
    ---SELECT MASTER DETAILS FOR MASTER LIST---------------
	SELECT     
		@CMEMO_ID AS MEMO_ID,    
		ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100))            
		,A.AC_CODE,A.AC_NAME ,    
		A.BILL_NO,    
		A.ARTICLE_CODE,A.ARTICLE_NO,A.PARA1_CODE, A.COLOR AS [PARA1_NAME],A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,    
		A.PARA3_CODE,A.BUYER_STYLE_NO AS [PARA3_NAME]--,JOB_ORDER, --,A.PARA2_CODE,A.SIZE,    
		,A.BO_DET_ROW_ID    
		,SUM(A.QUANTITY) AS [ALLOTED_QTY]    
		,SUM(A.SELECT_QTY) AS [SELECT_QUANTITY]    
		, SUM(A.SELECT_QTY) AS  [QUANTITY]
		,A.RATE AS [RATE],SUM(A.AMOUNT) AS [AMOUNT] 
		,@SUBTOTAL AS [SUBTOTAL],@DISCOUNT_PERCENTAGE AS [DISCOUNT_PERCENTAGE]    
		,@DISCOUNT_AMOUNT AS [DISCOUNT_AMOUNT]    
		,@OTHER_CHARGE AS [OTHER_CHARGE]  
		,@ROUND_OFF AS [ROUND_OFF]  
		,((ISNULL(@SUBTOTAL,0)+ISNULL(@OTHER_CHARGE,0)) -(ISNULL(@ROUND_OFF,0)+(ISNULL(@DISCOUNT_AMOUNT,0)))) AS [NET_AMOUNT]
		,'' AS MANUAL_INVOICE_NO
		,ISNULL(A.CURRENCY_CODE,'') AS CURRENCY_CODE
		,ISNULL(CM.CURRENCY_NAME,'') AS CURRENCY_NAME,
		CAST('' AS VARCHAR(100)) AS IMAGE_1,
		BO.SHIPPING_MODE ,
		BO.SHIPPING_NAME 
	FROM #TEMPTABLE_DETAILS A   
	JOIN 
	(
	   SELECT A.ROW_ID ,A.SHIPPING_MODE,C.SHIPPING_NAME  
	   FROM PPC_BUYER_ORDER_DET A
	   JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID =B.ORDER_ID 
	   JOIN PPC_SHIPPING_DETAILS C ON A.SHIPPING_MODE =C.SHIPPING_MODE 
	   WHERE B.CANCELLED =0
	)  BO ON BO.ROW_ID =A.BO_DET_ROW_ID   
	LEFT OUTER JOIN PPC_CURRENCY_MST CM ON CM.CURRENCY_CODE=A.CURRENCY_CODE
	WHERE ISNULL(SELECT_QTY,0) <> 0     
	GROUP BY A.AC_CODE,A.AC_NAME ,    
		A.BILL_NO,    
		A.ARTICLE_CODE,A.ARTICLE_NO,A.PARA1_CODE, A.COLOR ,A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,    
		A.PARA3_CODE,A.BUYER_STYLE_NO,A.BO_DET_ROW_ID ,
		A.RATE ,ISNULL(A.CURRENCY_CODE,''),
		ISNULL(CM.CURRENCY_NAME,'')  ,BO.SHIPPING_MODE ,
		BO.SHIPPING_NAME 
               
    ---SELECT DATA FOR DISPLAY DETAILS---------------
    SELECT * FROM #STOCK_DETAILS

GOTO END_PROC
LBLBARCODEPRINT:
      
          SELECT  CAST(1 AS BIT ) AS CHK,
                   BM.BILL_NO,
                   BM.ORDER_NO ,
                   CONVERT(VARCHAR,BM.ORDER_DT ,105) AS ORDER_DT,
				   IM.MEMO_ID AS MEMO_ID,
				   IM.MEMO_NO,
				   CONVERT(VARCHAR,IM.MEMO_DT,105) AS MEMO_DT,
				   ROW_ID=ID.ROW_ID,
				   A.AC_CODE,LM.AC_NAME ,
				   B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
				   B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				   B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
				   B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
				   SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
				   ID.PRODUCT_CODE,
				   ID.QUANTITY,
				   PMT.QUANTITY_IN_STOCK,
				   ID.PURCHASE_PRICE AS  RATE,
				   ID.AMOUNT,	
		           ID.ROW_ID 
				FROM PPC_FGBCG_MST A
				JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
				JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
				JOIN PPC_FG_PMT PMT ON SKU.PRODUCT_CODE=PMT.PRODUCT_CODE 
				JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
				JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
				JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
				JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
				JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
				JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
				JOIN PPC_TRANSFER_TO_TRADING_DET  ID ON ID.PRODUCT_CODE=SKU.PRODUCT_CODE
				JOIN PPC_TRANSFER_TO_TRADING_MST  IM ON ID.MEMO_ID=IM.MEMO_ID
				JOIN PPC_BUYER_ORDER_MST BM ON BM.ORDER_ID =ID.ORDER_ID 
				WHERE IM.MEMO_ID=@CMEMO_ID	

GOTO END_PROC


END_PROC:
END
