create PROCEDURE SAVETRAN_XN_APPROVAL_CHECKLIST_LEVEL_DETAILS
(
	 @CSPID			VARCHAR(50)
)
--WITH ENCRYPTION
AS
BEGIN

DECLARE @CERRMSG VARCHAR(500),@CSTEP VARCHAR(10)
	   ,@CCMD NVARCHAR(MAX),@BREFEXISTS BIT
	  

DECLARE @TOUTPUT TABLE(CHECKLIST_CODE VARCHAR(50),LEVEL_CODE VARCHAR(50),ERRMSG VARCHAR(500))

---LIST OF TABLES TO SAVE
DECLARE @TXN_APPROVAL_CHECKLIST_LEVEL_DETAILS VARCHAR(100)

SET @TXN_APPROVAL_CHECKLIST_LEVEL_DETAILS='MSTLOC_XN_APPROVAL_CHECKLIST_LEVEL_DETAILS_UPLOAD'

BEGIN TRY
BEGIN TRANSACTION
		    SET @CSTEP=10
		    
		    --FK_LEVEL_CODE
		    
		     SET @CCMD = N'DELETE A FROM XN_APPROVAL_CHECKLIST_LEVEL_DETAILS A
		         JOIN '+@TXN_APPROVAL_CHECKLIST_LEVEL_DETAILS+' B ON A.CHECKLIST_CODE=B.CHECKLIST_CODE AND A.LEVEL_CODE=B.LEVEL_CODE 
		         WHERE ISNULL(B.CHK,0)=0 AND B.SP_ID= '''+@CSPID+''' '
		     PRINT @CCMD
		     EXEC SP_EXECUTESQL @CCMD
		   
		   SET @CSTEP=20    
		   SET @CCMD = N'DELETE A  FROM '+@TXN_APPROVAL_CHECKLIST_LEVEL_DETAILS+' A  WHERE ISNULL(A.CHK,0)=0  AND SP_ID= '''+@CSPID+''''
		   PRINT @CCMD
		   EXEC SP_EXECUTESQL @CCMD
		   
		   

			--VALIDATION FOR BLANK CHECKLIST_DESC
			SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TXN_APPROVAL_CHECKLIST_LEVEL_DETAILS+' WHERE ISNULL(CHECKLIST_CODE,'''')='''' OR ISNULL(LEVEL_CODE,'''')='''' AND SP_ID= '''+@CSPID+''')
					        SET @CERRMSG=''CHECKLIST_CODE OR LEVEL CODE  CANNOT BE BLANK.'''
			PRINT @CCMD					        
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT
			
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC
			
			SET @CSTEP=70
			--VALIDATION FOR UNIQUE CHECKLISTDESC
	
	
SET @CCMD=N'DELETE A FROM  XN_APPROVAL_CHECKLIST_LEVEL_DETAILS A 
            JOIN '+@TXN_APPROVAL_CHECKLIST_LEVEL_DETAILS+' B ON A.CHECKLIST_CODE=B.CHECKLIST_CODE AND A.LEVEL_CODE=B.LEVEL_CODE
			WHERE B.SP_ID= '''+@CSPID+''' '
PRINT @CCMD				        
EXEC SP_EXECUTESQL @CCMD


		DECLARE @CWHERECLAUSE VARCHAR(1000)
        SET @CWHERECLAUSE = 'SP_ID='''+LTRIM(RTRIM((@CSPID)))+''''
				
	SET @CSTEP=160
	--UPDATING XN_APPROVAL_CHECKLIST_MST MASTER
	EXEC UPDATEMASTERXN 
			 @CSOURCEDB=''
			,@CSOURCETABLE=@TXN_APPROVAL_CHECKLIST_LEVEL_DETAILS
			,@CDESTDB=''
			,@CDESTTABLE='XN_APPROVAL_CHECKLIST_LEVEL_DETAILS'
			,@CKEYFIELD1='CHECKLIST_CODE'
			,@CKEYFIELD2='LEVEL_CODE'
			,@CKEYFIELD3=''
			,@LINSERTONLY=0
			,@CFILTERCONDITION=@CWHERECLAUSE
			,@LUPDATEXNS=0
			,@CXNTYPE=''
			,@LUPDATEONLY=0
			,@CUSERID=''
			,@BALWAYSUPDATE=1

	
END TRY
BEGIN CATCH 
	SET @CERRMSG='SAVETRAN_XN_APPROVAL_CHECKLIST_LEVEL_DETAILS: STEP - '+ISNULL(@CSTEP,'')+', MESSAGE - '+ERROR_MESSAGE() 
END CATCH

END_PROC:

IF @@TRANCOUNT>0  
 BEGIN  
  IF ISNULL(@CERRMSG,'')='' 
   COMMIT TRANSACTION  
  ELSE  
   ROLLBACK  
 END  
 
IF @CERRMSG<>''
BEGIN
INSERT @TOUTPUT(CHECKLIST_CODE,LEVEL_CODE  ,ERRMSG)	
SELECT '','',@CERRMSG
END
ELSE
BEGIN
SET @CCMD=N'SELECT CHECKLIST_CODE,LEVEL_CODE,'''' AS ERRMSG FROM '+@TXN_APPROVAL_CHECKLIST_LEVEL_DETAILS+''
PRINT @CCMD	
INSERT @TOUTPUT(CHECKLIST_CODE,LEVEL_CODE  ,ERRMSG)				        
EXEC SP_EXECUTESQL @CCMD

IF (SELECT COUNT(*) FROM @TOUTPUT)=0
BEGIN
INSERT @TOUTPUT(CHECKLIST_CODE,LEVEL_CODE  ,ERRMSG)	
SELECT 'SUCESS','',@CERRMSG
END
END


DELETE A FROM MSTLOC_XN_APPROVAL_CHECKLIST_LEVEL_DETAILS_UPLOAD A (NOLOCK) WHERE SP_ID=@CSPID


SELECT * FROM @TOUTPUT
END
--END OF PROCEDURE - SAVETRAN_XN_APPROVAL_CHECKLIST_LEVEL_DETAILS
