UPDATE A SET REF_MEMO_NO=CASE WHEN PIM.MRR_NO IS NOT NULL THEN PIM.MRR_NO
                              WHEN INM.INV_NO IS NOT NULL THEN INM.INV_NO
							  WHEN RMM.RM_NO IS NOT NULL THEN RMM.RM_NO ELSE RIGHT(A.REF_MEMO_ID ,10) END
FROM PARCEL_DET A (NOLOCK)
JOIN PARCEL_MST B (NOLOCK) ON A.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID 
LEFT JOIN PIM01106 PIM (NOLOCK) ON PIM.MRR_ID =A.REF_MEMO_ID AND B.XN_TYPE='PUR'
LEFT JOIN INM01106 INM (NOLOCK) ON INM.INV_ID =A.REF_MEMO_ID AND B.XN_TYPE='wsl'
LEFT JOIN RMM01106 RMM (NOLOCK) ON RMM.RM_ID =A.REF_MEMO_ID AND B.XN_TYPE='pRT'
WHERE ISNULL(A.REF_MEMO_ID,'')<>''
and   ISNULL(A.REF_MEMO_no,'')=''

	
UPDATE P1 SET XN_NO_LIST= ISNULL(STUFF((
        SELECT DISTINCT ', ' +   rtrim( ltrim( a.PARTY_INV_NO  ))+'/'+rtrim( ltrim(CONVERT(VARCHAR(20), a.PARTY_INV_DT,105)))+'('+rtrim( ltrim( a.REF_MEMO_NO  )) +')'
        FROM PARCEL_DET  A  (NOLOCK)  
		WHERE  P1.PARCEL_MEMO_ID = A.PARCEL_MEMO_ID      
        FOR XML PATH('')
    ),1,2,'') ,'')
FROM PARCEL_MST  P1 (NOLOCK)
WHERE CANCELLED =0
AND  ISNULL(P1.XN_NO_LIST,'')=''

