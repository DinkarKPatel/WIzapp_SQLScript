
/*  
CREATE TABLE PURCHASE_ALLOCATION_LINK (MRR_ID VARCHAR(22) NOT NULL,PS_ID VARCHAR(22) NOT NULL)  
  
ALTER TABLE PURCHASE_ALLOCATION_LINK ADD CONSTRAINT UNQ_PURCHASE_ALLOCATION_LINK UNIQUE (MRR_ID,PS_ID)  
  
ALTER TABLE PURCHASE_ALLOCATION_LINK ADD CONSTRAINT FK_PURCHASE_ALLOCATION_LINK_MRR  
FOREIGN KEY (MRR_ID) REFERENCES PIM01106 (MRR_ID)  
  
ALTER TABLE PURCHASE_ALLOCATION_LINK ADD CONSTRAINT FK_PURCHASE_ALLOCATION_LINK_WPS  
FOREIGN KEY (PS_ID) REFERENCES WPS_MST (PS_ID)  
*/  

  
CREATE PROCEDURE SP3S_PURCHASE_ALLOCATION  
(
@CMRRID VARCHAR(40) 
,@CDEPT_ID	VARCHAR(10)='' 
)
AS  
BEGIN  
 DECLARE @CCMD NVARCHAR(MAX),@CCURLOCID VARCHAR(5),@CHOLOCID VARCHAR(5),@BALLOCATED BIT  
  if @CDEPT_ID	=''
    SELECT TOP 1 @CCURLOCID = DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID             
	else
	SET @CCURLOCID =@CDEPT_ID
           
 SELECT TOP 1 @CHOLOCID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'       
   
 SET @BALLOCATED=0  
   
 IF EXISTS (SELECT TOP 1 MRR_ID FROM PURCHASE_ALLOCATION_LINK (NOLOCK) WHERE MRR_ID=@CMRRID)  
  SET @BALLOCATED=1  
    
 SET @CCMD=N'SELECT CONVERT(BIT,0) AS [CHK],DEPT_ID,DEPT_NAME,CONVERT(NUMERIC(10,2),0) AS [RATIO],CONVERT(NUMERIC(10,2),0) AS [PREFERENCE_ORDER] 
			FROM LOCATION A WHERE DEPT_ID<>'''+@CHOLOCID+'''  AND PUR_LOC=0 
			AND '+(CASE WHEN @BALLOCATED=1 THEN '1=2' ELSE '1=1' END) +' AND ''''<>'''+@CMRRID+''''  
			PRINT @CCMD
 EXEC SP_EXECUTESQL @CCMD     
  
  
 SELECT A.PRODUCT_CODE,K.SECTION_NAME, J.SUB_SECTION_NAME, I.UOM_NAME, C.PARA1_NAME,      
  D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,B.ARTICLE_NO,       
  B.ARTICLE_NAME,FORM_NAME,A.QUANTITY  ,B.CODING_SCHEME,I.UOM_TYPE
       
  FROM PID01106 A (NOLOCK)     
  JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE       
  JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE      
  JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE      
  JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE      
  JOIN PARA4 F (NOLOCK) ON A.PARA4_CODE = F.PARA4_CODE      
  JOIN PARA5 G (NOLOCK) ON A.PARA5_CODE = G.PARA5_CODE      
  JOIN PARA6 H (NOLOCK) ON A.PARA6_CODE = H.PARA6_CODE      
  JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE      
  JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE      
  JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE   
  JOIN FORM (NOLOCK) ON FORM.FORM_ID=A.FORM_ID   
  WHERE A.MRR_ID = @CMRRID AND @BALLOCATED=0  
  ORDER BY A.SRNO,A.PRODUCT_CODE                      
  
  SELECT B.PS_ID, B.PS_NO,B.PARTY_DEPT_ID,SUM(QUANTITY) AS QUANTITY ,CONVERT(BIT,0) AS [PRINT],CONVERT(BIT,0) AS [REMOVE] FROM WPS_DET A (NOLOCK)  
  JOIN WPS_MST B (NOLOCK) ON A.PS_ID=B.PS_ID  
  JOIN PURCHASE_ALLOCATION_LINK C (NOLOCK) ON C.PS_ID=B.PS_ID  
  WHERE C.MRR_ID=@CMRRID  
  GROUP BY B.PS_ID,B.PS_NO,B.PARTY_DEPT_ID  
  
  SELECT A.PRODUCT_CODE,'PURCHASED QUANTITY IS NOT AVAILABLE IN STOCK.' AS ERRMSG FROM PID01106 A
  JOIN PMT01106 B ON A.PRODUCT_CODE=B.PRODUCT_CODE
  WHERE A.MRR_ID=@CMRRID AND B.DEPT_ID=@CCURLOCID AND B.QUANTITY_IN_STOCK<A.QUANTITY  
    
END  
  
