-- PROCEDURE TO SAVE ALL MASTER REGARDING CHALLAN IN
create PROCEDURE UPDATEMASTERS
(
	@NSPID INT
)
--WITH ENCRYPTION
AS
BEGIN

	SET NOCOUNT ON 
	--BEGIN TRY
		DECLARE @CCMD NVARCHAR(4000), @CLOCATIONID VARCHAR(2), @CSOURCETABLENAME VARCHAR(100), @LTABLEEXISTS BIT
		
		DECLARE @TBTABLELIST TABLE (CTABLENAME VARCHAR(100), CKEYFIELD1 VARCHAR(50),  CKEYFIELD2 VARCHAR(50),	 
									CKEYFIELD3 VARCHAR(50))
								
		SELECT TOP 1 @CLOCATIONID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
		
		INSERT @TBTABLELIST VALUES ( 'HD01106',  'HEAD_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'LM01106', 'AC_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'REGIONM', 'REGION_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'STATE', 'STATE_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'CITY', 'CITY_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'AREA', 'AREA_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'FORM', 'FORM_ID','', '')
		INSERT @TBTABLELIST VALUES ( 'USERS', 'USER_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'LMP01106', 'AC_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'LOCATION', 'DEPT_ID','', '')
		INSERT @TBTABLELIST VALUES ( 'SECTIONM', 'SECTION_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'SECTIOND', 'SUB_SECTION_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'LOCSST_MST', 'MEMO_ID','', '')
		INSERT @TBTABLELIST VALUES ( 'LOCSST', 'ROW_ID','', '')
		INSERT @TBTABLELIST VALUES ( 'LOCSSTADD', 'ROW_ID','', '')
		INSERT @TBTABLELIST VALUES ( 'PARA1', 'PARA1_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'PARA2', 'PARA2_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'PARA3', 'PARA3_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'PARA4', 'PARA4_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'PARA5', 'PARA5_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'PARA6', 'PARA6_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'UOM', 'UOM_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'ARTICLE', 'ARTICLE_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'ART_DET', 'ROW_ID','', '')
		INSERT @TBTABLELIST VALUES ( 'ART_PARA1', 'ARTICLE_CODE','PARA1_CODE', '')
		INSERT @TBTABLELIST VALUES ( 'SKU', 'PRODUCT_CODE','', '')
		INSERT @TBTABLELIST VALUES ( 'SKU_OH', 'PRODUCT_CODE','', '')


		DECLARE @CTABLENAME VARCHAR(100), @CTARGETTABLE VARCHAR(100), @CKEYFIELD1 VARCHAR(50),  
				@CKEYFIELD2 VARCHAR(50), @CKEYFIELD3 VARCHAR(50), @CTARGETTABLENAME VARCHAR(100),
				@CSOURCEDB VARCHAR(100), @CTARGETDB VARCHAR(100)

		
		SET @CSOURCEDB = '['+DB_NAME()+'].[DBO].'

		SET @CTARGETDB = '['+DB_NAME()+'].[DBO].'
		
		DECLARE TB1 CURSOR FOR 
		SELECT CTABLENAME, CKEYFIELD1,  CKEYFIELD2, CKEYFIELD3 FROM @TBTABLELIST
		
		OPEN TB1
		FETCH NEXT FROM TB1 INTO @CTABLENAME, @CKEYFIELD1,  @CKEYFIELD2, @CKEYFIELD3
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			SET @CSOURCETABLENAME = 'TEMP_'+LTRIM(RTRIM(@CTABLENAME))+'_'+LTRIM(RTRIM(STR(@NSPID)))
			
			PRINT 'UPDATING TABLE : '+LTRIM(RTRIM(@CTABLENAME))
			
			SET @LTABLEEXISTS = 0
			SET @CCMD = N'IF EXISTS( SELECT NAME FROM ' + @CSOURCEDB + 'SYSOBJECTS WHERE NAME = '''+ @CSOURCETABLENAME + ''')
						  BEGIN
								DELETE FROM ' + @CSOURCEDB + @CSOURCETABLENAME + N'
								WHERE ' + @CKEYFIELD1 + ' = ''''
								
								SET @LTABLEEXISTS = 1
						  END'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD, N'@LTABLEEXISTS BIT OUTPUT', @LTABLEEXISTS OUTPUT
			
			IF @LTABLEEXISTS = 1
			BEGIN
				EXEC UPDATEMASTER @CSOURCEDB, @CSOURCETABLENAME, @CTARGETDB, @CTABLENAME, @CKEYFIELD1,  @CKEYFIELD2, @CKEYFIELD3
				PRINT 'TABLE EXISTS'
			END
			ELSE
				PRINT 'TABLE DOES NOT EXISTS'
		
			FETCH NEXT FROM TB1 INTO @CTABLENAME, @CKEYFIELD1,  @CKEYFIELD2, @CKEYFIELD3
		END
		CLOSE TB1
		DEALLOCATE TB1
	--END TRY
	--BEGIN CATCH
	--	--SELECT	ERROR_NUMBER() AS ERRORNUMBER,
	--	--		ERROR_SEVERITY() AS ERRORSEVERITY,
	--	--		ERROR_STATE() AS ERRORSTATE,
	--	--		ERROR_PROCEDURE() AS ERRORPROCEDURE,
	--	--		ERROR_LINE() AS ERRORLINE,
	--	--		ERROR_MESSAGE() AS ERRORMESSAGE;
	--END CATCH

END	
---***************************END OF UPDATEMASTERS
