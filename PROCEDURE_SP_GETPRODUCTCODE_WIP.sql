CREATE  PROCEDURE SP_GETPRODUCTCODE_WIP
@CUSERCODE VARCHAR(100),  
@NQTY  NUMERIC(14,3),
@BWIP BIT =0,  
@NTYPE INT=1  ,
@CPRODUCTCODE VARCHAR(MAX)  
--WITH ENCRYPTION

AS  
BEGIN  
IF @NTYPE=1
BEGIN
  IF(@BWIP=0)
  BEGIN
   SELECT DISTINCT TOP 50 SKU.PRODUCT_CODE,SKU.ARTICLE_CODE,isnull(P.QUANTITY_IN_STOCK,0) AS [QUANTITY],isnull(P.BIN_ID,'') as BIN_ID ,
   '' AS JOB_NAME,'' AS WIP_UID,B.BIN_NAME,SKU.PURCHASE_PRICE,SKU.INV_NO  + (CASE WHEN ISNULL(SKU.CHALLAN_NO,'') ='' THEN '' ELSE '/'+ SKU.CHALLAN_NO END) AS [DESC]   ,
   '' AS PRODUCT_UID      
   FROM SKU  (NOLOCK)  
   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE       
   LEFT OUTER JOIN PMT01106 P (NOLOCK) ON P.PRODUCT_CODE=SKU.PRODUCT_CODE  
   LEFT OUTER JOIN BIN B (NOLOCK) ON B.BIN_ID=P.BIN_ID      
   LEFT OUTER JOIN BINUSERS LOC (NOLOCK) ON LOC.BIN_ID=P.BIN_ID AND LOC.USER_CODE=@CUSERCODE    
   WHERE  SKU.PRODUCT_CODE<>''     
   AND (ART.STOCK_NA=1 OR  isnull(P.QUANTITY_IN_STOCK,0)>=(CASE WHEN @NQTY>0 THEN @NQTY ELSE isnull(P.QUANTITY_IN_STOCK,0) END))    
   AND @CUSERCODE=(CASE WHEN @CUSERCODE='0000000' THEN @CUSERCODE ELSE isnull(LOC.USER_CODE,@CUSERCODE) END)    
   AND SKU.PRODUCT_CODE LIKE @CPRODUCTCODE    
   ORDER BY SKU.PRODUCT_CODE  
  END
  ELSE 
  BEGIN

   SELECT DISTINCT TOP 50 P.PRODUCT_CODE,P.ARTICLE_CODE,P.QUANTITY_IN_STOCK AS [QUANTITY],P.BIN_ID,J.JOB_NAME +' - PP : '+CONVERT(VARCHAR(50),P.BASE_PRICE) AS JOB_NAME,
   P.WIP_UID,B.BIN_NAME,P.BASE_PRICE PURCHASE_PRICE,ART.ARTICLE_NAME AS [DESC] ,
   '' AS PRODUCT_UID           
   FROM WIP_PMT P  (NOLOCK) 
   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=P.ARTICLE_CODE       
   JOIN BIN B (NOLOCK) ON B.BIN_ID=P.BIN_ID       
   JOIN JOBS J (NOLOCK) ON J.JOB_CODE=P.JOB_CODE    
   LEFT OUTER JOIN BINUSERS LOC (NOLOCK) ON LOC.BIN_ID=P.BIN_ID AND LOC.USER_CODE=@CUSERCODE      
   WHERE isnull( P.PRODUCT_CODE,'')<>''     
   AND  (ART.STOCK_NA=1 OR P.QUANTITY_IN_STOCK>=(CASE WHEN @NQTY>0 THEN @NQTY ELSE P.QUANTITY_IN_STOCK END)    )
   AND @CUSERCODE=(CASE WHEN @CUSERCODE='0000000' THEN @CUSERCODE ELSE LOC.USER_CODE END)    
   AND P.PRODUCT_CODE LIKE @CPRODUCTCODE    
   ORDER BY P.PRODUCT_CODE  

  END
END  
ELSE 
BEGIN
   SELECT DISTINCT TOP 50 SKU.PRODUCT_CODE,SKU.ARTICLE_CODE,P.QUANTITY_IN_STOCK AS [QUANTITY],'' AS BIN_ID,
   '' AS JOB_NAME,'' AS WIP_UID,'' AS BIN_NAME,SKU.PURCHASE_PRICE,ART.ARTICLE_NAME AS [DESC]  ,
   SKU.PRODUCT_UID  AS PRODUCT_UID       
   FROM PRD_SKU SKU (NOLOCK)  
   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE       
   JOIN PRD_PMT P (NOLOCK) ON P.PRODUCT_UID =SKU.PRODUCT_UID    
   WHERE  SKU.PRODUCT_CODE<>''     
   AND (ART.STOCK_NA=1 OR  P.QUANTITY_IN_STOCK>=(CASE WHEN @NQTY>0 THEN @NQTY ELSE P.QUANTITY_IN_STOCK END))    
   AND SKU.PRODUCT_CODE LIKE @CPRODUCTCODE    
   ORDER BY SKU.PRODUCT_CODE  
   


END
END
