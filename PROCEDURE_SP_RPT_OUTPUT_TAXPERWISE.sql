CREATE PROCEDURE SP_RPT_OUTPUT_TAXPERWISE      
(      
@FROMDT DATETIME,      
@TODT  DATETIME    
)      
AS      
BEGIN      
      
        
          DECLARE @BPICKFREIGHT BIT,
                  @BPICKOC BIT,@BPICKRO BIT,
                  @CPICKFREIGHT VARCHAR(2),
                  @CPICKOC VARCHAR(2),
                  @CPICKRO VARCHAR(2),      
                  @NSTOCKADJVALUE NUMERIC(10,2) ,
                  @CFROMFILTER VARCHAR(500),
                  @CREPORTSOURCE INT,
                  @CFILTER NVARCHAR(200),
                  @CCMD NVARCHAR(MAX) ,
                  @CFROMDATE VARCHAR(MAX),
                  @CTODATE VARCHAR(MAX)
                  
                  SET @CFROMDATE=''
                  SET @CTODATE=''  
                  
SET @CFROMDATE=@FROMDT  
SET @CTODATE=@TODT                
                     
 
	SET @CFILTER=''
	SELECT @CFILTER= DB_NAME()+'_RFOPT'+'.DBO.RF_OPT'
    
     
	 SELECT @CREPORTSOURCE=ISNULL(VALUE,0) FROM CONFIG WHERE CONFIG_OPTION='REPORTING_SOURCE'    
	  SET @CFROMFILTER=''    
	 IF ISNULL(@CREPORTSOURCE,0)=1    
	  SET @CFROMFILTER='VW_XNSREPS'    
	 IF ISNULL(@CREPORTSOURCE,0)=2    
	  SET @CFROMFILTER=@CFILTER
     
       
      

SET @CCMD=N'SELECT [TAX_PERCENTAGE],
                               SUM(ISNULL(OBS , 0)) AS CAL_OBS,
                               SUM(ISNULL(OBP1 , 0)) AS CAL_OBP1,
                               SUM(ISNULL(PPQ , 0)) AS CAL_PPQ,
                               SUM(ISNULL(PPP1 , 0)) AS CAL_PPP1,
                               SUM(ISNULL(PRQ , 0)) AS CAL_PRQ,
                               SUM(ISNULL(PRP1 , 0)) AS CAL_PRP1,
                               SUM(ISNULL(SPQ , 0)) AS CAL_SPQ,
                               SUM(ISNULL(SPP1 , 0)) AS CAL_SPP1,
                               SUM(ISNULL(SRQ , 0)) AS CAL_SRQ,
                               SUM(ISNULL(SRP1 , 0)) AS CAL_SRP1,
                               SUM(ISNULL(WPQ , 0)) AS CAL_WPQ,
                               SUM(ISNULL(WPP1 , 0)) AS CAL_WPP1,
                               SUM(ISNULL(WRQ , 0)) AS CAL_WRQ,
                               SUM(ISNULL(WRP1 , 0)) AS CAL_WRP1,
                               SUM(ISNULL(APQ , 0)) AS CAL_APQ,
                               SUM(ISNULL(APP1 , 0)) AS CAL_APP1,
                               SUM(ISNULL(ARQ , 0)) AS CAL_ARQ,
                               SUM(ISNULL(ARP1 , 0)) AS CAL_ARP1,
                               SUM(ISNULL(CNQ , 0)) AS CAL_CNQ,
                               SUM(ISNULL(CNP1 , 0)) AS CAL_CNP1,
                               SUM(ISNULL(UNQ , 0)) AS CAL_UNQ,
                               SUM(ISNULL(UNP1 , 0)) AS CAL_UNP1,
                               SUM(ISNULL(CBS , 0)) AS CAL_CBS,
                               SUM(ISNULL(CBP1 , 0)) AS CAL_CBP1
	FROM       
	(      
			SELECT DBO.FN_POSTACT_GETTAXACDETAILS( '''+@CFROMDATE+''',A.PRODUCT_CODE,1,STATE_CODE, 3 ) AS [TAX_PERCENTAGE]      
              ,CAST(SUM( (CASE WHEN A.XN_TYPE=''OPS'' OR (A.XN_TYPE IN (''TTM'',''API'',''SCF'',''OPS'',''PRD'', ''PUR'', ''CHI'', ''SLR'',''UNC'',''APR'', ''WSR'', ''PFI'', ''PFG'', ''BCG'',''MRP'',''DCI'',''PSB'',''JWR'') AND XN_DT < '''+@CFROMDATE+''' AND ARTICLE.STOCK_NA=0) THEN 1 WHEN A.XN_TYPE IN (''APO'',''SCC'',''BOC'',''PRT'',''CHO'',''SLS'',''CNC'',''APP'',''WSL'',''CIP'', ''CRM'', ''DCO'',''MIP'',''CSB'',''JWI'',''DLM'') AND XN_DT < '''+@CFROMDATE+''' AND ARTICLE.STOCK_NA=0 THEN -1 ELSE 0 END) * ([XN_QTY])) AS NUMERIC(14,2)) AS OBS
              ,CAST(SUM( (CASE WHEN A.XN_TYPE=''OPS'' OR (A.XN_TYPE IN (''TTM'',''API'',''SCF'',''OPS'', ''PRD'',''PUR'', ''CHI'',''SLR'',''UNC'',''APR'', ''WSR'', ''PFI'', ''PFG'', ''BCG'',''MRP'',''DCI'',''PSB'',''JWR'') AND XN_DT < '''+@CFROMDATE+''' AND ARTICLE.STOCK_NA=0) THEN (XN_QTY*(SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) ) ) WHEN A.XN_TYPE IN (''APO'',''WIP-SCC'',''SCC'',''BOC'',''PRT'',''CHO'',''SLS'',''CNC'',''APP'',''WSL'', ''CIP'', ''CRM'', ''DCO'',''MIP'',''CSB'',''JWI'',''DLM'') AND XN_DT <  '''+@CFROMDATE+'''  AND ARTICLE.STOCK_NA=0 THEN - (XN_QTY*(SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) ) ) WHEN A.XN_TYPE=''SAC'' AND XN_DT <  '''+@CFROMDATE+'''  THEN -XN_NET WHEN A.XN_TYPE=''SAU'' AND XN_DT <  '''+@CFROMDATE+''' THEN XN_NET ELSE 0 END)) AS NUMERIC(14,2)) AS OBP1
             ,CAST(SUM( CASE WHEN A.XN_TYPE=''PUR'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN XN_QTY  ELSE 0 END) AS NUMERIC(14,2)) AS PPQ
              ,CAST(SUM ( CASE WHEN A.XN_TYPE =''PUR'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN ((SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) )  * XN_QTY) ELSE 0 END) AS NUMERIC(14,2)) AS PPP1
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''PRT'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN XN_QTY  ELSE 0 END) AS NUMERIC(14,2)) AS PRQ
              ,CAST(SUM ( CASE WHEN A.XN_TYPE =''PRT'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN ((SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) )  * XN_QTY) ELSE 0 END) AS NUMERIC(14,2)) AS PRP1
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''SLS'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN XN_QTY  ELSE 0 END) AS NUMERIC(14,2)) AS SPQ
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''SLS'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN ((SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) )  * XN_QTY)  ELSE 0 END) AS NUMERIC(14,2)) AS SPP1
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''SLR'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN XN_QTY  ELSE 0 END) AS NUMERIC(14,2)) AS SRQ
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''SLR'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN ((SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) )  * XN_QTY)  ELSE 0 END) AS NUMERIC(14,2)) AS SRP1
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''WSL'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN XN_QTY  ELSE 0 END) AS NUMERIC(14,2)) AS WPQ
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''WSL'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN ((SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) ) *XN_QTY)  ELSE 0 END) AS NUMERIC(14,2)) AS WPP1
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''WSR'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN XN_QTY  ELSE 0 END) AS NUMERIC(14,2)) AS WRQ
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''WSR'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN ((SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) ) *XN_QTY)  ELSE 0 END) AS NUMERIC(14,2)) AS WRP1
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''APP'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +'''  THEN XN_QTY  ELSE 0 END) AS NUMERIC(14,2)) AS APQ
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''APP'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +'''  THEN ((SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) )  * XN_QTY)  ELSE 0 END) AS NUMERIC(14,2)) AS APP1
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''APR'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN XN_QTY  ELSE 0 END) AS NUMERIC(14,2)) AS ARQ
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''APR'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN ((SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) )  * XN_QTY)  ELSE 0 END) AS NUMERIC(14,2)) AS ARP1
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''CNC'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN XN_QTY  ELSE 0 END) AS NUMERIC(14,2)) AS CNQ
              ,CAST(SUM ( CASE WHEN A.XN_TYPE =''CNC'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN ((SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) )  * XN_QTY) ELSE 0 END) AS NUMERIC(14,2)) AS CNP1
              ,CAST(SUM( CASE WHEN A.XN_TYPE=''UNC'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN XN_QTY  ELSE 0 END) AS NUMERIC(14,2)) AS UNQ
              ,CAST(SUM ( CASE WHEN A.XN_TYPE =''UNC'' AND XN_DT BETWEEN '''+@CFROMDATE+''' AND '''+@CTODATE +''' THEN ((SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) )  * XN_QTY) ELSE 0 END) AS NUMERIC(14,2)) AS UNP1
              ,CAST(SUM( (CASE WHEN A.XN_TYPE=''OPS'' OR (A.XN_TYPE IN (''TTM'',''API'',''SCF'',''OPS'',''PRD'', ''PUR'', ''CHI'', ''SLR'',''UNC'',''APR'', ''WSR'', ''PFI'', ''PFG'', ''BCG'',''MRP'',''DCI'',''PSB'',''JWR'') AND XN_DT <= '''+@CTODATE +''' AND ARTICLE.STOCK_NA=0 ) THEN 1 WHEN A.XN_TYPE IN (''APO'',''SCC'',''BOC'',''PRT'',''CHO'',''SLS'',''CNC'',''APP'',''WSL'',''CIP'', ''CRM'', ''DCO'',''MIP'',''CSB'',''JWI'',''DLM'') AND XN_DT <= '''+@CTODATE +''' AND ARTICLE.STOCK_NA=0 THEN -1 ELSE 0 END) * (XN_QTY)) AS NUMERIC(14,2)) AS CBS
              ,CAST(SUM( (CASE WHEN A.XN_TYPE=''OPS'' OR (A.XN_TYPE IN (''TTM'',''API'',''SCF'',''OPS'', ''PRD'',''PUR'', ''CHI'',''SLR'',''UNC'',''APR'', ''WSR'', ''PFI'', ''PFG'', ''BCG'',''MRP'',''DCI'',''PSB'',''JWR'') AND XN_DT <= '''+@CTODATE +''' AND ARTICLE.STOCK_NA=0) THEN (XN_QTY*(SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) ) ) WHEN A.XN_TYPE IN (''APO'',''WIP-SCC'',''SCC'',''BOC'',''PRT'',''CHO'',''SLS'',''CNC'',''APP'',''WSL'', ''CIP'', ''CRM'', ''DCO'',''MIP'',''CSB'',''JWI'',''DLM'') AND XN_DT <= '''+@CTODATE +'''  AND ARTICLE.STOCK_NA=0 THEN - (XN_QTY*(SKU.PURCHASE_PRICE + (CASE WHEN FF.POST_TAX_SEPARATELY =0 THEN ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ ISNULL(SKU_OH.VALUE_ADD,0))     + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0) ) ) WHEN A.XN_TYPE=''SAC'' AND XN_DT <= '''+@CTODATE +'''  THEN -XN_NET WHEN A.XN_TYPE=''SAU'' AND XN_DT <= '''+@CTODATE +'''  THEN XN_NET ELSE 0 END)) AS NUMERIC(14,2)) AS CBP1
              
        FROM '+@CFROMFILTER+' A  (NOLOCK) 
        JOIN SKU (NOLOCK) ON A.PRODUCT_CODE = SKU.PRODUCT_CODE 
        JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE 
         JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
         JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE 
         JOIN LOC_VIEW  (NOLOCK) ON A.DEPT_ID = LOC_VIEW.DEPT_ID
LEFT OUTER JOIN SKU_OH  ON SKU.PRODUCT_CODE = SKU_OH.PRODUCT_CODE 
LEFT OUTER JOIN FORM FF ON SKU.FORM_ID = FF.FORM_ID       
  WHERE  ( LOC_VIEW.INACTIVE IN (0) AND LOC_VIEW.REPORT_BLOCKED IN (0)) 
  AND  SKU.ER_FLAG IN (''0'' , ''1'' )

        GROUP BY DBO.FN_POSTACT_GETTAXACDETAILS( '''+@CFROMDATE+''',A.PRODUCT_CODE,1,STATE_CODE, 3 )

	        
	 ) B       

      
 GROUP BY [TAX_PERCENTAGE]      
 ----HAVING NOT(SUM(ISNULL(CAL_OBS,0))= 0 AND SUM(ISNULL(CAL_PPQ,0))= 0 AND SUM(ISNULL(CAL_PRT,0))= 0)       
 --AND SUM(ISNULL(SPQ,0))= 0 AND SUM(ISNULL(SRQ,0))= 0       
 --AND SUM(ISNULL(CBS,0))= 0 )      
 ORDER BY [TAX_PERCENTAGE]' 
 PRINT @CCMD
 EXEC SP_EXECUTESQL @CCMD         
   
      
END
