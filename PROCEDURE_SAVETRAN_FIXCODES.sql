-- PROCEDURE TO SAVE FIX CODES ITEM MASTER
create PROCEDURE SAVETRAN_FIXCODES
(
	@NUPDATEMODE		NUMERIC(1,0),
	@NSPID				INT,
	@CMEMONOPREFIX		VARCHAR(50),
	@CFINYEAR			VARCHAR(10),
	@CMACHINENAME		VARCHAR(100)='',
	@CWINDOWUSERNAME	VARCHAR(100)='',
	@CWIZAPPUSERCODE	VARCHAR(10)='0000000',
	@CMEMOID			VARCHAR(40)='',
	@CBINID				VARCHAR(5)='',
	@cLocId CHAR(4)=''
)
--WITH ENCRYPTION
AS
BEGIN
	-- @NUPDATEMODE:	1- ITEM RATE REVISION
	--					2- TAG PRINTING
	
	DECLARE @CTEMPDBNAME			VARCHAR(100),
			@CMASTERTABLENAME		VARCHAR(100),
			@CDETAILTABLENAME		VARCHAR(100),
			@CTEMPMASTERTABLENAME	VARCHAR(100),
			@CTEMPDETAILTABLENAME	VARCHAR(100),
			@CTEMPMASTERTABLE		VARCHAR(100),
			@CTEMPDETAILTABLE		VARCHAR(100),
			@CERRORMSG				VARCHAR(500),
			@LDONOTUPDATESTOCK		BIT,
			@CKEYFIELD1				VARCHAR(50),
			@CKEYFIELDVAL1			VARCHAR(50),
			@CMEMONO				VARCHAR(20),
			@NMEMONOLEN				NUMERIC(20,0),
			@CMEMONOVAL				VARCHAR(50),
			@CMEMODEPTID			VARCHAR(4),
			@CLOCATIONID			VARCHAR(4),
			@CHODEPTID				VARCHAR(4),
			@CCMD					NVARCHAR(4000),
			@CCMDOUTPUT				NVARCHAR(4000),
			@NSAVETRANLOOP			BIT,
			@NSTEP					INT,
			@LENABLETEMPDATABASE	BIT,@BNEGSTOCKFOUND BIT,
			@CTEMPBARCODE			VARCHAR(50),
			@CLOCATIONID_CURRENT    VARCHAR(2)

	DECLARE @OUTPUT TABLE ( ERRMSG VARCHAR(2000), MEMO_ID VARCHAR(100))

	SET @NSTEP = 0		-- SETTTING UP ENVIRONMENT
	--CHANGES TO STORE LOCATION ID 
	SELECT @CLOCATIONID=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'

	
	SET @CLOCATIONID_CURRENT=@cLocId
	
	-- TEMPORARY DATABASE Discarded now onwards as per Meeting on 30-10-2020 mentioned in Client issues List
	SET @CTEMPDBNAME = ''

	SET @CMASTERTABLENAME	= 'SKU'

	SET @CTEMPMASTERTABLENAME	= 'TEMP_SKU_'+LTRIM(RTRIM(STR(@NSPID)))
	
	SET @CCMD=N'UPDATE SK SET SK.HSN_CODE= (CASE WHEN ISNULL(ART.HSN_CODE,'''')='''' THEN ''0000000000'' ELSE ART.HSN_CODE END) FROM '+@CTEMPMASTERTABLENAME+' SK
				JOIN ARTICLE(NOLOCK) ART ON SK.ARTICLE_CODE=ART.ARTICLE_CODE
				JOIN SECTIOND(NOLOCK) SD ON SD.SUB_SECTION_CODE=ART.SUB_SECTION_CODE'
	EXEC SP_EXECUTESQL @CCMD

	SET @CTEMPMASTERTABLE	= @CTEMPDBNAME + @CTEMPMASTERTABLENAME
	
	SET @CKEYFIELD1='PRODUCT_CODE'
	
	SET @CERRORMSG			= ''

	SET @NSTEP = 10		-- GETTING DEPTID INFO FROM TEMP TABLE
	
	BEGIN TRANSACTION
	
	BEGIN TRY

	 IF ISNULL(@CLOCATIONID,'')=''
	 BEGIN
		SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' LOCATION ID CAN NOT BE BLANK  '  
		GOTO END_PROC    
	 END
		
		SET @CCMD=N'UPDATE '+@CTEMPMASTERTABLENAME+' SET BARCODE_CODING_SCHEME=1'
		EXEC SP_EXECUTESQL @CCMD
		
		-- UPDATING MASTER TABLE (PIM01106) FROM TEMP TABLE
		SET @NSTEP = 100		-- UPDATING MASTER TABLE

		EXEC UPDATEMASTERXN 
			  @CSOURCEDB	= @CTEMPDBNAME
			, @CSOURCETABLE = @CTEMPMASTERTABLENAME
			, @CDESTDB		= ''
			, @CDESTTABLE	= @CMASTERTABLENAME
			, @CKEYFIELD1	= @CKEYFIELD1
			, @BALWAYSUPDATE = 1
		
		SET @NSTEP = 110	
		
		EXEC VALIDATEXN
			  @CXNTYPE	= 'FIXSKU'
			, @CXNID	= @CKEYFIELDVAL1
			, @NUPDATEMODE = @NUPDATEMODE			
			, @CCMD		= @CCMDOUTPUT OUTPUT

		IF @CCMDOUTPUT <> ''
		BEGIN
			SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' DATA VALIDATION FAILED : ' + @CCMDOUTPUT + '...'
			GOTO END_PROC
		END
		ELSE
		BEGIN
			SET @NSTEP = 120
			PRINT '@CMEMOID.......'+@CMEMOID
			PRINT '@@CLOCATIONID.......'+@CLOCATIONID
			SELECT @CTEMPBARCODE = PRODUCT_CODE FROM PMT01106 WHERE PRODUCT_CODE = @CMEMOID
			IF ISNULL(@CTEMPBARCODE,'') = ''
			BEGIN
				IF ISNULL(@CBINID,'')='' SET @CBINID='000'
				INSERT PMT01106	(LAST_UPDATE, REP_ID, PRODUCT_CODE, QUANTITY_IN_STOCK, DEPT_ID,BIN_ID ) 
				VALUES(	GETDATE(), '', @CMEMOID, 0,@CLOCATIONID_CURRENT,@CBINID)
			END
		END
		--END HERE

		-- AFTER SUCCESSFUL SAVING , JUST DROP THE TEMP TABLES CREATED BY APPLICATION
		SET @NSTEP = 160
		
	
	END TRY
	
	BEGIN CATCH
		SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		-- SET @CRETCMD= N'SELECT '''+@CERRORMSG+''' AS ERRMSG, '''' AS MEMO_ID'
		
		GOTO END_PROC
	END CATCH
	
END_PROC:
	
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')='' AND ISNULL(@CCMDOUTPUT,'')=''
			COMMIT TRANSACTION
		ELSE
			ROLLBACK
	END
	
	INSERT @OUTPUT ( ERRMSG, MEMO_ID)
			VALUES ( ISNULL(@CERRORMSG,''), ISNULL(@CKEYFIELDVAL1,'') )

	SELECT * FROM @OUTPUT	

	EXEC SP_DROPTEMPTABLES_XNS 'MSTSKU',@NSPID	
END						
------------------------------------------------------ END OF PROCEDURE SAVETRAN_FIXCODES
