CREATE PROCEDURE SP_VALIDATEXN_BEFORESAVE_XNSAPPROVAL--(LocId 3 digit change by Sanjay:30-10-2024)
(
	@NSPID			NUMERIC(5),
	@CUSERCODE		NVARCHAR(10),
	@NUPDATEMODE	INT,
	@CRETVAL		NVARCHAR(MAX) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
BEGIN TRY
DECLARE @CCMD			NVARCHAR(MAX),
		@CDEPTID		VARCHAR(4) ,
		@CTEMPMASTERTABLE		NVARCHAR(MAX),
		@CTEMPDETAILTABLE		NVARCHAR(MAX),
		@CTEMPDBNAME	VARCHAR(100),
		@NSTEP	INT

PRINT 'ENTER TEMP DATA VALIDATION'

SET @NSTEP=10
SET @CTEMPDBNAME = (SELECT DBO.FN_GETTEMPDBNAME())
SET @NSTEP=20

SET @CTEMPMASTERTABLE=@CTEMPDBNAME+'TEMP_XN_APPROVAL_DONE_MST_'+LTRIM(RTRIM(STR(@NSPID)))
SET @CTEMPDETAILTABLE=@CTEMPDBNAME+'TEMP_XN_APPROVAL_DONE_DET_'+LTRIM(RTRIM(STR(@NSPID)))

SELECT @CDEPTID= DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 

	IF ISNULL(@CDEPTID,'')=''
	 BEGIN
		SET @CRETVAL =' LOCATION ID CAN NOT BE BLANK  '  
		GOTO ATLAST    
	 END

SET @CRETVAL=''

SET @NSTEP=30
--VALIDATING RECORD COUNT
SET @CCMD=N'IF (SELECT COUNT(*) FROM '+@CTEMPMASTERTABLE+')=0
				SET @CRETVAL1=''NO RECORD FOUND AT MASTER LEVEL..... CANNOT PROCEED'''

EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
GOTO ATLAST

SET @NSTEP=40
--VALIDATING FINYEAR
SET @CCMD=N'SELECT @CRETVAL1=(CASE WHEN ''01'' + LTRIM(RTRIM((DBO.FN_GETFINYEAR(MEMO_DT))))=FIN_YEAR THEN '''' 
			ELSE ''MEMO DATE IS NOT IN CURRENT FINANCIAL YEAR...CAN NOT PROCEED'' END)
			FROM '+ @CTEMPMASTERTABLE 
EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
GOTO ATLAST

SET @NSTEP=50
--VALIDATING USER CODE
IF @NUPDATEMODE=1
BEGIN
	SET @CCMD=N'UPDATE '+ @CTEMPMASTERTABLE + N' SET USER_CODE='''+@CUSERCODE+''' WHERE LTRIM(RTRIM(USER_CODE)) = '''''
	EXEC SP_EXECUTESQL @CCMD
END

SET @NSTEP=60
SET @CCMD=N'IF EXISTS (SELECT TOP 1 A.USER_CODE FROM '+ @CTEMPMASTERTABLE + N' A 
						LEFT OUTER JOIN USERS B ON B.USER_CODE=A.USER_CODE
						WHERE B.USER_CODE IS NULL)
				SET @CRETVAL1=''INVALID USER DETAILS FOUND....CAN NOT PROCEED'''
EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
	GOTO ATLAST

SET @NSTEP=70	
--VALIDATING RECORD COUNT
SET @CCMD=N'IF NOT EXISTS (SELECT TOP 1 MEMO_ID FROM '+@CTEMPDETAILTABLE+')
				SET @CRETVAL1=''BLANK DETAILS CAN NOT BE SAVED..... PLEASE CHECK'''
EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
GOTO ATLAST

SET @NSTEP=80
SET @CCMD=N'IF NOT EXISTS	(SELECT TOP 1 MEMO_ID FROM '+ @CTEMPDETAILTABLE + ' WHERE APPROVAL_STATUS IN (2,3))
				SET @CRETVAL1=''NO ENTRY MARKED AS APPROVED FULLY/PARTIALLY..... PLEASE CHECK'''
EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
GOTO ATLAST

SET @CRETVAL=''

ATLAST:
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
	SET @CRETVAL=ISNULL(@CRETVAL,'') +'(SP_VALIDATEXN_BEFORESAVE_XNSAPPROVAL)'

END TRY
BEGIN CATCH
	SET @CRETVAL=N'ERROR FOUND IN PROCEDURE : SP_VALIDATEXN_BEFORESAVE_XNSAPPROVAL STEP:'+LTRIM(RTRIM(STR(@NSTEP)))+
	' MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')  
END CATCH
END
