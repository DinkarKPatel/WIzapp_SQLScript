CREATE PROCEDURE [DBO].[SP3S_INV_JOBCARD_ISSUE_11]          
(          
  @IMODE INT ,          
  @CWHERE VARCHAR(MAX)='',      
  @CAGENCYCODE VARCHAR(20)='',      
  @FINYEAR VARCHAR(10)=''  ,    
  @DEPTID VARCHAR(10)='' ,
  @NRETURNMODE INT=0      
)      
----WITH ENCRYPTION
AS          
          
BEGIN        
 DECLARE @CCMD NVARCHAR(MAX) ,@CERRORMSG VARCHAR(100)

 IF @DEPTID=''
 SELECT  @DEPTID=DEPT_ID FROM NEW_APP_LOGIN_INFO WHERE SPID=@@SPID 

 IF ISNULL(@DEPTID,'')=''
	 BEGIN
		SET @CERRORMSG =' LOCATION ID CAN NOT BE BLANK  '  
		GOTO END_PROC    
	 END
	


        DECLARE @LEVEL_NO INT
		SELECT TOP 1 @LEVEL_NO=LEVEL_NO  FROM XN_APPROVAL_CHECKLIST_LEVEL_USERS A  
		WHERE A.XN_TYPE ='jC'	AND DEPT_ID =@DEPTID

		SET @LEVEL_NO=ISNULL(@LEVEL_NO,0)


		IF OBJECT_ID('TEMPDB..#SP3S_INV_JOBCARD_ISSUE_11','U') IS NOT NULL
			DROP TABLE #SP3S_INV_JOBCARD_ISSUE_11

		SET @cCMD=N'IF OBJECT_ID(''SP3S_INV_JOBCARD_ISSUE_11_'+LTRIM(RTRIM(COnvert(VARCHAR(5),@@SPID)))+''',''U'') IS NOT NULL
				DROP TABLE SP3S_INV_JOBCARD_ISSUE_11_'+LTRIM(RTRIM(COnvert(VARCHAR(5),@@SPID)))
		
		PRINT @cCMD

		EXEC SP_EXECUTESQL @cCMD

  --LBLPENDINGJOBCARD_MST: 11
	;WITH LIST_OF_PC
	AS
	(
	    SELECT T1.ARTICLE_CODE,A.PRODUCT_CODE,T1.ROW_ID,PMT.JOB_CODE,T2.MEMO_ID,T3.JOB_ORDER,MEMO_NO,
	    T2.MEMO_DT,T2.AC_CODE,PMT.QUANTITY_IN_STOCK	,A3.REF_NO AS BUYER_ORDER_REF_NO
		FROM ORD_PLAN_BARCODE_DET A (NOLOCK) 
		JOIN ORD_PLAN_DET T1 (NOLOCK) ON  A.REFROW_ID=T1.ROW_ID
		JOIN ORD_PLAN_MST T2 (NOLOCK) ON  T1.MEMO_ID=T2.MEMO_ID 
		JOIN JOBWORK_PMT PMT (NOLOCK) ON  PMT.PRODUCT_CODE=A.PRODUCT_CODE
		LEFT JOIN ORD_PLAN_JOB T3 (NOLOCK) ON   T2.MEMO_ID=T3.MEMO_ID AND T3.ARTICLE_CODE=T1.ARTICLE_CODE and isnull(T3.JOB_ORDER,0)>0
		LEFT JOIN
		(
		  SELECT PJ.MEMO_ID,PJ.ARTICLE_CODE  ,PJ.JOB_CODE ,PJ.JOB_ORDER  
		  FROM ORD_PLAN_JOB  PJ (NOLOCK)
		) PJ ON  T3.MEMO_ID=PJ.MEMO_ID AND T3.ARTICLE_CODE=PJ.ARTICLE_CODE AND T3.JOB_ORDER-1 =PJ.JOB_ORDER  
		LEFT JOIN BUYER_ORDER_DET A1 (NOLOCK) ON T1.WOD_ROW_ID=A1.ROW_ID
		LEFT JOIN  BUYER_ORDER_MST A3 (NOLOCK) ON A1.ORDER_ID=A3.ORDER_ID
		WHERE PMT.QUANTITY_IN_STOCK>0 AND T2.CANCELLED=0 AND ISNULL(T2.SHORT_CLOSE,0)=0
		AND( ISNULL(T2.ENFORCE_JOB_ORDER,0) =0 OR  ((ISNULL(PMT.JOB_CODE,'')='' AND ISNULL(T3.JOB_ORDER,0) =1)OR ( PMT.JOB_CODE =PJ.JOB_CODE )))
		AND (ISNULL(T2.ENFORCE_JOB_ORDER,0) =0 OR T3.JOB_CODE=@CWHERE)
		AND @CWHERE<>''
		and (@LEVEL_NO=0 OR T2.APPROVEDLEVELNO =99)
		AND T2.MEMO_NO LIKE @CAGENCYCODE 
		AND T2.location_code =@DEPTID
		
	)
	SELECT CAST(0 AS BIT) AS [CHK],A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.AC_CODE,A.BUYER_ORDER_REF_NO,SUM(A.QUANTITY_IN_STOCK) AS QUANTITY,LM.AC_NAME
	,ISNULL(@CERRORMSG,'') AS ERRMSG
	INTO #SP3S_INV_JOBCARD_ISSUE_11
	FROM LIST_OF_PC A 
	JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=A.AC_CODE
	GROUP BY A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.AC_CODE,LM.AC_NAME,A.BUYER_ORDER_REF_NO

	IF ISNULL(@CWHERE,'')=''
		SELECT * FROM #SP3S_INV_JOBCARD_ISSUE_11
	ELSE
	BEGIN
		SET @CCMD=N'SELECT * INTO SP3S_INV_JOBCARD_ISSUE_11_'+LTRIM(RTRIM(Convert(VARCHAR(5),@@SPID)))+'  FROM #SP3S_INV_JOBCARD_ISSUE_11'
		PRINT @cCMD
		EXEC SP_EXECUTESQL @cCMD
	END
	END_PROC:
	IF ISNULL(@CERRORMSG,'')<>''
	SELECT @CERRORMSG AS ERRMSG
	--SELECT CAST(0 AS BIT) AS [CHK], T2.MEMO_ID,MEMO_NO,MEMO_DT,T2.AC_CODE,SUM(B1.QUANTITY_IN_STOCK) AS QUANTITY,LM.AC_NAME
	--FROM ORD_PLAN_BARCODE_DET A
	--JOIN ORD_PLAN_DET T1 (NOLOCK) ON  A.REFROW_ID=T1.ROW_ID
	--JOIN ORD_PLAN_MST T2 (NOLOCK) ON  T1.MEMO_ID=T2.MEMO_ID 
	--JOIN ORD_PLAN_JOB T3 (NOLOCK) ON  T3.MEMO_ID=T2.MEMO_ID AND T3.REF_ROW_ID=T1.ROW_ID
	--JOIN 
	--( 
	--	  SELECT PRODUCT_CODE ,SUM(QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK
	--	  FROM JOBWORK_PMT  
	--	  --WHERE QUANTITY_IN_STOCK>0
	--	  GROUP BY PRODUCT_CODE
	-- )B1 ON B1.PRODUCT_CODE=A.PRODUCT_CODE 
	--JOIN LM01106 LM ON LM.AC_CODE=T2.AC_CODE
	--WHERE T3.JOB_CODE=@CWHERE 
	--GROUP BY T2.MEMO_ID,T2.MEMO_NO,T2.MEMO_DT,T2.AC_CODE,LM.AC_NAME  
END
