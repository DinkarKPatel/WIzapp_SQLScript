CREATE VIEW VW_PERFORMANCE_REPORT  

AS  
SELECT WOM.EMP_CODE, ISNULL(AI.AC_CODE,'') AS AC_CODE,OM.REF_NO,OM.ORDER_NO
,ISNULL(CONVERT(VARCHAR,OM.ORDER_DT ,105),'01-01-1900') AS ORDER_DT
,ISNULL(CONVERT(VARCHAR,OM.TRAIL_DT ,105),'01-01-1900') AS TRIAL_DT 
,ISNULL(CONVERT(VARCHAR,OM.DELIVERY_DT ,105),'01-01-1900') AS DELIVERY_DT,  
LM.AC_NAME,ODA.ARTICLE_NO AS SET_NO,OD.QUANTITY,WOM.MEMO_ID AS WORK_ORDER_ID,WODA.ARTICLE_NO AS COMP_NO,  
ISNULL(AI.K_NAME,'') AS K_NAME,ISNULL(AI.CHALLAN_NO,'') AS CHALLAN_NO,ISNULL(AI.DEPARTMENT ,'') AS DEPARTMENT,  
ISNULL(CONVERT(VARCHAR,AI.ISSUE_DT ,105),'') AS ISSUE_DT
,ISNULL(CONVERT(VARCHAR,ISNULL(AI.DELIVERY_DT,''),105),'') AS  DEPT_DELIVERY_DT 
,ISNULL(CONVERT(VARCHAR,AI.RECEIVE_DT,105),'') AS RECEIVE_DT
,ISNULL(EMP.EMP_FNAME,'')+' '+ISNULL(EMP.EMP_LNAME,'') AS ALLOCATED_TO
,ISNULL(CONVERT(VARCHAR,DTM.MEMO_DT,105),'01-01-1900') AS COMPLETION_DT
,ISNULL(CONVERT(VARCHAR,PRD_JOBS.START_DT ,105),'01-01-1900') AS START_DT 
,ISNULL(CONVERT(VARCHAR,PRD_JOBS.TARGET_DT ,105),'01-01-1900') AS TARGET_DT

,CASE WHEN ISNULL(AI.DELIVERY_DT,'01-01-1900')<>'01-01-1900'THEN   
  CONVERT(VARCHAR,DATEDIFF(DAY,AI.DELIVERY_DT,AI.RECEIVE_DT))
ELSE    
  'N/A'   
END AS [VARIANCE]   

,CASE WHEN ISNULL(CONVERT(VARCHAR,DTM.MEMO_DT,105),'01-01-1900')<>'01-01-1900'THEN   
	CASE WHEN DATEDIFF(DAY,OM.DELIVERY_DT,DTM.MEMO_DT) <0  THEN '0'  ELSE CONVERT(VARCHAR,DATEDIFF(DAY,OM.DELIVERY_DT,DTM.MEMO_DT)) END   
ELSE    
 'N/A'--CASE WHEN DATEDIFF(DAY,OM.DELIVERY_DT,GETDATE())<0 THEN 0 ELSE DATEDIFF(DAY,OM.DELIVERY_DT,GETDATE()) END   
END AS NET_DELAY   
  
,CASE WHEN ISNULL(CONVERT(VARCHAR,DTM.MEMO_DT,105),'01-01-1900')<>'01-01-1900'THEN   
 CASE WHEN DATEDIFF(DAY,DTM.MEMO_DT,OM.DELIVERY_DT) <0  THEN '0' ELSE CONVERT(VARCHAR,DATEDIFF(DAY,DTM.MEMO_DT,OM.DELIVERY_DT)) END   
ELSE    
 'N/A' --CASE WHEN DATEDIFF(DAY,GETDATE(),OM.DELIVERY_DT)<0 THEN 0 ELSE DATEDIFF(DAY,GETDATE(),OM.DELIVERY_DT) END   
END   
AS DAYS_TO_GO

,ISNULL(PRD_JOBS.JOB_ORDER,0) AS JOB_ORDER  
  
FROM  WSL_ORDER_MST OM  
JOIN WSL_ORDER_DET OD ON OD.ORDER_ID=OM.ORDER_ID  
JOIN ARTICLE ODA ON ODA.ARTICLE_CODE=OD.ARTICLE_CODE  
JOIN PRD_WO_MST WOM ON WOM.ARTICLE_SET_CODE=OD.ARTICLE_CODE AND WOM.REF_NO=OM.REF_NO  
JOIN LMV01106 LM ON LM.AC_CODE=OM.AC_CODE  
JOIN PRD_WO_DET WOD ON WOD.MEMO_ID=WOM.MEMO_ID  
JOIN ARTICLE WODA ON WODA.ARTICLE_CODE=WOD.ARTICLE_CODE  
LEFT OUTER JOIN EMP_MST EMP ON EMP.EMP_ID=WOM.EMP_CODE  
LEFT OUTER JOIN   
(  
  SELECT B.REF_PRD_WORKORDER_MEMOID,AJ.AGENCY_NAME AS K_NAME,D.AGENCY_CHALLAN_NO AS CHALLAN_NO,B.REF_COMPONENT_ARTICLE_CODE ,ART.ARTICLE_NO,E.JOB_NAME AS DEPARTMENT,  
  B.ARTICLE_CODE,  
  F.MEMO_DT AS ISSUE_DT,F.DELIVERY_DT,D.MEMO_DT AS RECEIVE_DT,E.JOB_CODE,AJ.AC_CODE  
  FROM PRD_AGENCY_MATERIAL_RECEIPT_DET C     
  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST D ON D.MEMO_ID=C.MEMO_ID              
  JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B ON B.ROW_ID=C.REF_ROW_ID            
  JOIN ARTICLE ART ON ART.ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE      
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST F ON F.MEMO_ID=B.MEMO_ID          
  JOIN JOBS E ON E.JOB_CODE=B.JOB_CODE  
  JOIN PRD_AGENCY_MST AJ ON AJ.AGENCY_CODE=D.AGENCY_CODE  
  WHERE D.CANCELLED=0   
    
  UNION ALL           
    
  SELECT B.REF_PRD_WORKORDER_MEMOID,'IN HOUSE' AS K_NAME,'' AS CHALLAN_NO,B.REF_COMPONENT_ARTICLE_CODE ,ART.ARTICLE_NO,  
  DM.DEPARTMENT_NAME AS DEPARTMENT,IM.ARTICLE_CODE,IM.MEMO_DT AS ISSUE_DT ,IM.DELIVERY_DT, B.MEMO_DT AS RECEIVE_DT,IM.JOB_CODE AS JOB_CODE  ,'' AS AC_CODE
  FROM PRD_OP_MATERIAL_CON_DET C            
  JOIN PRD_OP_MATERIAL_CON_MST B ON B.MEMO_ID=C.MEMO_ID         
  JOIN ARTICLE ART ON ART.ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE            
  JOIN   
  (  
   SELECT IM.TARGET_DEPARTMENT_ID, IM.MEMO_DT,ID.REF_PRD_WORKORDER_MEMOID,ID.REF_COMPONENT_ARTICLE_CODE ,ID.ARTICLE_CODE,ID.PARA1_CODE  
   ,ID.JOB_CODE,ID.PARA2_CODE,IM.DELIVERY_DT  
   FROM PRD_MATERIAL_RECEIPT_MST M --  
   JOIN PRD_ISSUE_MATERIAL_MST IM ON IM.MEMO_ID=M.REF_PRD_MATERIAL_ISSUE_MEMOID  
   JOIN PRD_ISSUE_MATERIAL_DET ID ON ID.MEMO_ID=IM.MEMO_ID  
  ) IM ON IM.REF_PRD_WORKORDER_MEMOID=B.REF_PRD_WORKORDER_MEMOID AND IM.REF_COMPONENT_ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE  
  JOIN PRD_DEPARTMENT_MST DM ON DM.DEPARTMENT_ID=IM.TARGET_DEPARTMENT_ID   
  WHERE B.CANCELLED=0     
           
  UNION ALL  
    
  SELECT  E.REF_WO_ID AS REF_PRD_WORKORDER_MEMOID,LM.AC_NAME AS K_NAME,PM.MRR_NO AS CHALLAN_NO,WOD.ARTICLE_CODE AS REF_COMPONENT_ARTICLE_CODE,  
  ART.ARTICLE_NO,'PURCHASE' AS DEPARTMENT_NAME,A.ARTICLE_CODE,  
  E.PS_DT AS ISSUE_DT ,BM.DELIVERY_DT, PM.INV_DT AS RECEIVE_DT,'0000000' AS JOB_CODE  ,PM.AC_CODE
  FROM PRD_PID01106 A              
  JOIN PRD_PIM01106 PM ON PM.MRR_ID=A.MRR_ID           
  JOIN PRD_POD01106 B ON B.ROW_ID=A.PO_ROW_ID              
  JOIN PRD_POM01106 BM ON BM.PO_ID=B.PO_ID  
  JOIN PRD_PO_WSL C ON B.PO_ID=C.PO_ID              
  JOIN PRD_PS_MST E ON C.INV_ID=E.PS_ID              
  JOIN PRD_WO_DET WOD ON WOD.MEMO_ID=E.REF_WO_ID  
  JOIN ARTICLE ART ON ART.ARTICLE_CODE=WOD.ARTICLE_CODE             
  JOIN ARTICLE ART1 ON ART1.ARTICLE_CODE=A.ARTICLE_CODE             
  JOIN LMV01106 LM ON LM.AC_CODE=PM.AC_CODE  
) AI ON AI.REF_PRD_WORKORDER_MEMOID=WOD.MEMO_ID AND WOD.ARTICLE_CODE=AI.REF_COMPONENT_ARTICLE_CODE  
LEFT OUTER JOIN PRD_STK_TRANSFER_DTM_MST DTM ON WOD.MEMO_ID=DTM.REF_WO_ID AND DTM.CANCELLED=0  
LEFT OUTER JOIN PRD_WO_ART_JOBS PRD_JOBS ON PRD_JOBS.REF_ROW_ID=WOD.ROW_ID AND  PRD_JOBS.JOB_CODE=AI.JOB_CODE
