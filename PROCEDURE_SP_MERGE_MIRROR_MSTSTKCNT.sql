CREATE PROCEDURE SP_MERGE_MIRROR_MSTSTKCNT
@nMode numeric(1,0)
AS
BEGIN
	DECLARE @cStep VARCHAR(2),@cErrormsg VARCHAR(MAX)
BEGIN TRY

	IF @nMode=1
		GOTO END_PROC
	
	BEGIN TRAN

	SET @cStep='10'
	DELETE a FROM STOCK_COUNT_SETUP_link_loc a JOIN  MSTSTKCNT_STOCK_COUNT_SETUP_mst_MIRROR B ON a.STK_COUNT_SETUP_ID=b.STK_COUNT_SETUP_ID
	DELETE a FROM STOCK_COUNT_SETUP_col_list a JOIN  MSTSTKCNT_STOCK_COUNT_SETUP_col_list_MIRROR B ON a.STK_COUNT_SETUP_ID=b.STK_COUNT_SETUP_ID


	SET @cStep='20'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE='MSTSTKCNT_STOCK_COUNT_SETUP_mst_MIRROR',@CDESTDB=''
							,@CDESTTABLE='STOCK_COUNT_SETUP_mst',@CKEYFIELD1='STK_COUNT_SETUP_ID',@CKEYFIELD2='',@CKEYFIELD3=''
							,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1,@BUPDATEXNS=1
	
	SET @cStep='30'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE='MSTSTKCNT_STOCK_COUNT_SETUP_link_loc_MIRROR',@CDESTDB=''
							,@CDESTTABLE='STOCK_COUNT_SETUP_link_loc',@CKEYFIELD1='STK_COUNT_SETUP_ID',@CKEYFIELD2='',@CKEYFIELD3=''
							,@LINSERTONLY=1,@CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1,@BUPDATEXNS=1

	SET @cStep='40'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE='MSTSTKCNT_STOCK_COUNT_SETUP_col_list_MIRROR',@CDESTDB=''
							,@CDESTTABLE='STOCK_COUNT_SETUP_col_list',@CKEYFIELD1='STK_COUNT_SETUP_ID',@CKEYFIELD2='',@CKEYFIELD3=''
							,@LINSERTONLY=1,@CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1,@BUPDATEXNS=1	
	GOTO END_PROC
END TRY

BEGIN CATCH
	SET @cErrormsg='Error in Procedure SP3S_MERGE_MANUAL_STOCKCOUNTSETUP at step#'+@cStep+' '+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:
	DELETE FROM MSTSTKCNT_STOCK_COUNT_SETUP_mst_MIRROR
	DELETE FROM MSTSTKCNT_STOCK_COUNT_SETUP_link_loc_MIRROR
	DELETE FROM MSTSTKCNT_STOCK_COUNT_SETUP_col_list_MIRROR

	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@cErrormsg,'')=''
			COMMIT
		ELSE
			ROLLBACK
	END

	SELECT 'MSTSTKCNT' AS MEMO_ID,ISNULL(@CERRORMSG,'') AS ERRMSG
END