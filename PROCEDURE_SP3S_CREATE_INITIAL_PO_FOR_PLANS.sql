CREATE PROCEDURE SP3S_CREATE_INITIAL_PO_FOR_PLANS(@QUERYID INT,@Plan VARCHAR(100)='',@AC_CODE VARCHAR(100)='')
AS
BEGIN
SET NOCOUNT ON
DECLARE @SQL VARCHAR(MAX)

IF @QUERYID=1
   GOTO RET_ALL_PLANS
ELSE IF @QUERYID=2
   GOTO RET_PLAN_FILTERS
ELSE IF @QUERYID=3
   GOTO RET_PO_SPLIT
ELSE IF @QUERYID=4
   GOTO RET_LIST_SUPPLIERS
ELSE IF @QUERYID=5
   GOTO GROUP_SUPPLIERS_PO
ELSE IF @QUERYID=6
   GOTO CREATE_SUPPLIER_PO

   
CREATE_SUPPLIER_PO:
IF OBJECT_ID('tempdb..#POD') IS NOT NULL DROP TABLE #POD
SELECT TOP 0 CAST(0 AS INT)RNO,* INTO #POD FROM POD01106(NOLOCK)
--OLD--SET @SQL='SELECT * FROM TEMP_INITIAL_PO_'+LTRIM(RTRIM(@Plan))+'  WHERE AC_CODE='''+@AC_CODE+''''
SELECT TOP 1 @SQL=VALUE FROM CONFIG WHERE config_option='HO_LOCATION_ID'
SET @SQL='SELECT 1,A.ARTICLE_CODE,P1.PARA1_CODE,P2.PARA2_CODE,P3.PARA3_CODE,P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE
,RIGHT(DELIVERY_DT,4)+''-''+RIGHT(LEFT(DELIVERY_DT,5),2)+''-''+LEFT(DELIVERY_DT,2)DELIVERY_DT
,CAST(PO_QTY AS FLOAT)QUANTITY,AUTO_SRNO=ROW_NUMBER()OVER(ORDER BY A.ARTICLE_CODE,P1.PARA1_CODE,P2.PARA2_CODE,P3.PARA3_CODE,P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE)
,0 wholesale_price,''000''BIN_ID,0 purchase_price,GETDATE() last_update
,0 amount,'''' product_code,0 mrp,'''' po_id
,1 print_label,0 wsp_percentage,0 adj_quantity,t.po_qty invoice_quantity,0 scheme_quantity,'''' form_id,0 tax_percentage
,0 tax_amount,0 discount_percentage,0 discount_amount,ISNULL(A.gross_purchase_price,0) gross_purchase_price,0 Fix_mrp,0 PI_QTY,0 manual_mrp,0 manual_discount,0 manual_wsp,0 WD_PERCENTAGE,NEWID() ROW_ID
FROM TEMP_INITIAL_PO_'+LTRIM(RTRIM(@Plan))+' T 
LEFT JOIN ARTICLE A (NOLOCK) ON A.ARTICLE_NO=T.ARTICLE_NO
LEFT JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_NAME=T.PARA1_NAME
LEFT JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_NAME=T.PARA2_NAME
LEFT JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_NAME=T.PARA3_NAME
LEFT JOIN PARA4 P4 (NOLOCK) ON P4.PARA4_NAME=T.PARA4_NAME
LEFT JOIN PARA5 P5 (NOLOCK) ON P5.PARA5_NAME=T.PARA5_NAME
LEFT JOIN PARA6 P6 (NOLOCK) ON P6.PARA6_NAME=T.PARA6_NAME
WHERE A.PARA2_SET=0 AND T.AC_CODE='''+@AC_CODE+''''
PRINT '47'+@SQL
INSERT #POD(RNO,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PARA3_CODE,PARA4_CODE,PARA5_CODE,PARA6_CODE,DELIVERY_DT
,QUANTITY,AUTO_SRNO,wholesale_price,BIN_ID,purchase_price,last_update,amount,product_code,mrp,po_id,print_label
,wsp_percentage,adj_quantity,invoice_quantity,scheme_quantity,form_id,tax_percentage,tax_amount,discount_percentage
,discount_amount,gross_purchase_price,Fix_mrp,PI_QTY,manual_mrp,manual_discount,manual_wsp,WD_PERCENTAGE,ROW_ID)
EXEC(@SQL)

SET @SQL='
;WITH CTE AS
(
SELECT RNO=ROW_NUMBER()OVER(PARTITION BY T.ARTICLE_NO,T.PARA1_NAME,T.PARA2_NAME ORDER BY T.ARTICLE_NO,T.PARA1_NAME,T.PARA2_NAME)
,A.ARTICLE_CODE,P1.PARA1_CODE,P2.PARA2_CODE,P3.PARA3_CODE,P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE
,RIGHT(DELIVERY_DT,4)+''-''+RIGHT(LEFT(DELIVERY_DT,5),2)+''-''+LEFT(DELIVERY_DT,2)DELIVERY_DT
,CAST(PO_QTY AS FLOAT)QUANTITY
,AUTO_SRNO=ROW_NUMBER()OVER(ORDER BY A.ARTICLE_CODE,P1.PARA1_CODE,P2.PARA2_CODE,P3.PARA3_CODE,P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE)
,ART_DET.WS_PRICE wholesale_price--1
,''000''BIN_ID
,ART_DET.PURCHASE_PRICE purchase_price--2
,GETDATE() last_update
,ART_DET.PURCHASE_PRICE*CAST(PO_QTY AS FLOAT) amount
,'''' product_code
,ART_DET.mrp
,'''' po_id
,1 print_label,0 wsp_percentage,0 adj_quantity,t.po_qty invoice_quantity,0 scheme_quantity,'''' form_id,0 tax_percentage
,0 tax_amount,0 discount_percentage,0 discount_amount
,ISNULL(ART_DET.PURCHASE_PRICE,0) gross_purchase_price--4
,0 Fix_mrp,0 PI_QTY,0 manual_mrp,0 manual_discount,0 manual_wsp,0 WD_PERCENTAGE,NEWID() ROW_ID
FROM TEMP_INITIAL_PO_'+LTRIM(RTRIM(@Plan))+' T 
JOIN ARTICLE A (NOLOCK) ON A.ARTICLE_NO=T.ARTICLE_NO
JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_NAME = T.PARA2_NAME
JOIN ART_DET (NOLOCK) ON ART_DET.ARTICLE_CODE=A.ARTICLE_CODE AND ART_DET.para2_code=P2.PARA2_CODE
JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_NAME=T.PARA1_NAME
JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_NAME=T.PARA3_NAME
JOIN PARA4 P4 (NOLOCK) ON P4.PARA4_NAME=T.PARA4_NAME
JOIN PARA5 P5 (NOLOCK) ON P5.PARA5_NAME=T.PARA5_NAME
JOIN PARA6 P6 (NOLOCK) ON P6.PARA6_NAME=T.PARA6_NAME
WHERE A.PARA2_SET=1 AND T.AC_CODE='''+@AC_CODE+'''
)
SELECT * FROM CTE WHERE RNO=1'
PRINT '76'+@SQL
INSERT #POD(RNO,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PARA3_CODE,PARA4_CODE,PARA5_CODE,PARA6_CODE,DELIVERY_DT
,QUANTITY,AUTO_SRNO,wholesale_price,BIN_ID,purchase_price,last_update,amount,product_code,mrp,po_id,print_label
,wsp_percentage,adj_quantity,invoice_quantity,scheme_quantity,form_id,tax_percentage,tax_amount,discount_percentage
,discount_amount,gross_purchase_price,Fix_mrp,PI_QTY,manual_mrp,manual_discount,manual_wsp,WD_PERCENTAGE,ROW_ID)
EXEC(@SQL)

SELECT A.*,CAST(0 AS NUMERIC(14,0)) AS SERIAL_NO,B.DT_CREATED,B.GEN_EAN_CODES,    
B.ARTICLE_NO, B.ARTICLE_NAME, B.CODING_SCHEME,  B.PARA1_SET, B.PARA2_SET,I.UOM_CODE, I.UOM_NAME, I.UOM_TYPE,  
C.PARA1_NAME,D.PARA2_NAME,E.PARA3_NAME, F.PARA4_NAME, G.PARA5_NAME, H.PARA6_NAME, B.STOCK_NA,B.GEN_EAN_CODES,    
'' AS JRD_ROW_ID, '' AS JID_ROW_ID, '' AS JOD_ROW_ID , D.PARA2_ORDER,SKU.PRODUCT_NAME,B.STOCK_NA,B.GEN_EAN_CODES, 
M.SUB_SECTION_NAME,N.SECTION_NAME,  ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],        
ISNULL(SKU.DT_CREATED,'') AS [SKU_DT_CREATED],    '' AS OTHER_XN_PRODUCT_CODE,  B.SIZE_RATE_DIFF ,B.SIZE_CENTER_POINT,    
FORM.FORM_NAME, ISNULL(SKU.PRODUCT_NAME,B.ARTICLE_NAME) AS PRODUCT_NAME ,'' AS PI_PO_ROW_ID ,
B.FIX_PRICE_ARTICLE,B.ALIAS AS ARTICLE_ALIAS ,SKU.ONLINE_PRODUCT_CODE,M.ALIAS AS SUB_SECTION_ALIAS,
N.ALIAS AS SECTION_ALIAS,W.REMARKS AS BUYER_ORDER_REMARKS,C.PARA1_SET AS P1_SET,D.PARA2_SET AS P2_SET
,AC_NAME=(SELECT AC_NAME FROM LMV01106 WHERE AC_CODE=@AC_CODE)
FROM #POD A  (NOLOCK)   
LEFT OUTER JOIN ARTICLE B   (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE     
LEFT OUTER JOIN PARA1 C     (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE    
LEFT OUTER JOIN PARA2 D     (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE     
LEFT OUTER JOIN PARA3 E     (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE     
LEFT OUTER JOIN PARA4 F     (NOLOCK) ON A.PARA4_CODE = F.PARA4_CODE     
LEFT OUTER JOIN PARA5 G     (NOLOCK) ON A.PARA5_CODE = G.PARA5_CODE     
LEFT OUTER JOIN PARA6 H     (NOLOCK) ON A.PARA6_CODE = H.PARA6_CODE     
LEFT OUTER JOIN UOM I       (NOLOCK) ON B.UOM_CODE = I.UOM_CODE     
LEFT OUTER JOIN POM01106 R  (NOLOCK) ON R.PO_ID= A.PO_ID     
LEFT OUTER JOIN SECTIOND M  (NOLOCK) ON B.SUB_SECTION_CODE = M.SUB_SECTION_CODE   
LEFT OUTER JOIN SECTIONM N  (NOLOCK) ON M.SECTION_CODE = N.SECTION_CODE   
LEFT OUTER JOIN FORM        (NOLOCK) ON FORM.FORM_ID=A.FORM_ID   
LEFT OUTER JOIN SKU         (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE 
LEFT OUTER JOIN WSL_ORDER_DET W (NOLOCK) ON A.WOD_ROW_ID= W.ROW_ID    
ORDER BY SRNO  
IF OBJECT_ID('tempdb..#POD') IS NOT NULL DROP TABLE #POD
GOTO END_PROC


GROUP_SUPPLIERS_PO:
IF OBJECT_ID('tempdb..#POM') IS NOT NULL DROP TABLE #POM
SELECT TOP 0 * INTO #POM FROM POM01106(NOLOCK)
SELECT TOP 1 @SQL=VALUE FROM CONFIG WHERE config_option='HO_LOCATION_ID'
SET @SQL='SELECT AC_CODE
,RIGHT(DELIVERY_DT,4)+''-''+RIGHT(LEFT(DELIVERY_DT,5),2)+''-''+LEFT(DELIVERY_DT,2)DELIVERY_DT
,SUM(CAST(PO_QTY AS FLOAT))TOTAL_QUANTITY
,0 freight,0 round_off,'''+@SQL+''' po_for_dept_id,0 tax_amount,'''' edt_user_code,'''' PO_TIME
,0 approved,30 credit_days,0 freight_mode,'''' delivery_mode,'''' form_id,1 MODE,'''' cancelled_on
,0 uploaded_to_activstream,1 taxform_storage_mode,''AUTO GENEATED FROM INITIAL PO'' REMARKS
,1 bill_level_tax_method,0 manual_discount
,0 manual_roundoff,1 PUR_CAL_METHOD,0 excise_duty_amount,0 cr_discount_percentage,''000'' BIN_ID,'''' po_no,''''PO_DT,0 total_amount,GETDATE()last_update
,0 CANCELLED,''01'' company_code,''0000000'' user_code,0 sent_to_ho,'''' po_id,'''' fin_year,'''+@SQL+''' DEPT_ID
,'''' CHECKED_BY,'''' SENT_BY,0 SENT,0 tax_percentage,1 xn_item_type,1 PO_RECEIVING_MODE,0 as discount_percentage
FROM TEMP_INITIAL_PO_'+LTRIM(RTRIM(@Plan))+' GROUP BY AC_CODE,DELIVERY_DT'
INSERT #POM(AC_CODE,DELIVERY_DT,TOTAL_QUANTITY,freight,round_off,po_for_dept_id,tax_amount,edt_user_code,PO_TIME
,approved,credit_days,freight_mode,delivery_mode,form_id,MODE,cancelled_on
,uploaded_to_activstream,taxform_storage_mode,REMARKS,bill_level_tax_method,manual_discount
,manual_roundoff,PUR_CAL_METHOD,excise_duty_amount,cr_discount_percentage,BIN_ID,po_no,PO_DT,total_amount,last_update
,CANCELLED,company_code,user_code,sent_to_ho,po_id,fin_year,DEPT_ID
,CHECKED_BY,SENT_BY,SENT,tax_percentage,xn_item_type,PO_RECEIVING_MODE,discount_percentage)
EXEC(@SQL)

UPDATE #POM SET po_dt=CONVERT(DATE,GETDATE())

SELECT  A.*, 0.00 AS TOTAL_QTY,  
D.AC_NAME, C.DEPT_NAME,C.DEPT_ID , ISNULL(B.ADDRESS0,'') AS ADDRESS0,    
ISNULL(B.ADDRESS1,'') AS ADDRESS1, ISNULL(B.ADDRESS2,'') AS ADDRESS2, 
ISNULL(AREA_NAME,'') AS AREA_NAME, ISNULL(CITY,'') AS CITY, ISNULL(PINCODE,'') AS PINCODE, 
ISNULL(STATE,'') AS STATE, ISNULL(B.SST_NO,'') AS SST_NO,    
ISNULL(B.SST_DT,'') AS SST_DT, ISNULL(B.TIN_NO,'') AS TIN_NO, ISNULL(B.TIN_DT,'') AS TIN_DT,
U.USERNAME,E.USERNAME AS EDT_USERNAME,  
(C.ADDRESS1 +' '+ C.ADDRESS2) AS STORE_ADDRESS ,'' AS FORM_NAME,D.ALIAS,
ISNULL(B.ADDRESS0,'') + ' ' + ISNULL(B.ADDRESS1,'') + ' ' + ISNULL(B.ADDRESS2,'') + ' ' + ISNULL(AREA_NAME,'') + ' ' + ISNULL(CITY,'') + ' ' + ISNULL(STATE,'') AS SUPP_ADDRESS,
XN.*  ,B.MP_PERCENTAGE,B.WP_PERCENTAGE,OEM_MST.OEM_NAME,G.DEPT_NAME AS PO_FOR_DEPT_NAME,
ISNULL(A.FREIGHT_CGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0) +ISNULL(A.FREIGHT_IGST_AMOUNT,0) AS  FREIGHT_GST_AMT,
ISNULL(A.FREIGHT,0)+CASE WHEN ISNULL(A.OH_TAX_METHOD,0)=1 THEN
ISNULL(A.FREIGHT_CGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0) +ISNULL(A.FREIGHT_IGST_AMOUNT,0) 
ELSE 0 END AS FREIGHT_TOTAL,
ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) +ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0) AS  OTHER_CHARGES_GST_AMT,
ISNULL(A.OTHER_CHARGES,0)+CASE WHEN ISNULL(A.OH_TAX_METHOD,0)=1 THEN
ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) +ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0)
ELSE 0 END AS OTHER_CHARGES_TOTAL
FROM #POM A 
JOIN LM01106 D (NOLOCK) ON A.AC_CODE = D.AC_CODE     
LEFT JOIN LMP01106 B (NOLOCK) ON A.AC_CODE=B.AC_CODE
LEFT JOIN AREA (NOLOCK) ON AREA.AREA_CODE=B.AREA_CODE
LEFT JOIN CITY (NOLOCK) ON CITY.CITY_CODE=AREA.CITY_CODE
LEFT JOIN [STATE] (NOLOCK) ON [STATE].STATE_CODE=CITY.STATE_CODE
LEFT JOIN OEM_MST (NOLOCK) ON A.OEM_CODE=OEM_MST.OEM_CODE
LEFT OUTER JOIN USERS U(NOLOCK) ON A.USER_CODE = U.USER_CODE     
LEFT OUTER JOIN USERS E(NOLOCK) ON A.EDT_USER_CODE = E.USER_CODE     
JOIN LOCATION C(NOLOCK) ON A.DEPT_ID = C.DEPT_ID 
JOIN LOCATION G(NOLOCK) ON A.PO_FOR_DEPT_ID = G.DEPT_ID       
LEFT OUTER JOIN XN_APPROVAL_DET XN (NOLOCK) ON XN.XN_ID=A.PO_ID AND XN.XN_TYPE='XNSPO'  
IF OBJECT_ID('tempdb..#POM') IS NOT NULL DROP TABLE #POM
GOTO END_PROC


RET_LIST_SUPPLIERS:
SELECT AC_CODE,AC_NAME FROM LMV01106 WHERE HEAD_CODE='0000000021'
GOTO END_PROC


RET_PO_SPLIT:
SELECT TOP 1 @Plan=PLAN_NAME FROM ARS_MST (NOLOCK) WHERE ARS_ID=@Plan
EXEC SP3S_ARS_INITIAL_PO_FOR_PLAN @PLAN,0,''
GOTO END_PROC


RET_ALL_PLANS:
DECLARE @TAB VARCHAR(1000),@MYSQL VARCHAR(MAX)
SET @TAB='tempdb..##PLAN_'+CAST(@@SPID AS VARCHAR)
SET @MYSQL='IF OBJECT_ID('''+@TAB+''') IS NOT NULL DROP TABLE '+REPLACE(@TAB,'tempdb..','')
EXEC(@MYSQL)

SET @MYSQL='CREATE TABLE '+REPLACE(@TAB,'tempdb..','')+'(ARS_ID VARCHAR(100),PLAN_NAME VARCHAR(100),REQ_STOCK FLOAT,CURR_STOCK FLOAT,PO_TRANSIT_STOCK FLOAT,PO_STOCK_REQUIRED FLOAT,ROW_ID VARCHAR(40))'
EXEC(@MYSQL)

IF ISNULL(@Plan,'')=''
   BEGIN
     DECLARE PLN CURSOR FOR SELECT PLAN_NAME FROM ARS_MST (NOLOCK) WHERE CANCELLED=0
     OPEN PLN
     FETCH NEXT FROM PLN INTO @PLAN
     WHILE @@FETCH_STATUS=0
		BEGIN
		  EXEC SP3S_ARS_INITIAL_PO_FOR_PLAN @PLAN,1,@TAB
		  FETCH NEXT FROM PLN INTO @PLAN
		END
     CLOSE PLN
     DEALLOCATE PLN
   END
ELSE
   EXEC SP3S_ARS_INITIAL_PO_FOR_PLAN @PLAN,1,@TAB

SET @MYSQL='UPDATE '+REPLACE(@TAB,'tempdb..','')+' SET ROW_ID=LEFT(NEWID(),40),ARS_ID=(SELECT TOP 1 ARS_ID FROM ARS_MST WHERE ARS_MST.INACTIVE=0 AND ARS_MST.PLAN_NAME='+REPLACE(@TAB,'tempdb..','')+'.PLAN_NAME)'
EXEC(@MYSQL)
   
SET @MYSQL='SELECT * FROM '+REPLACE(@TAB,'tempdb..','')
EXEC(@MYSQL)

SET @MYSQL='IF OBJECT_ID('''+@TAB+''') IS NOT NULL DROP TABLE '+REPLACE(@TAB,'tempdb..','')
EXEC(@MYSQL)
GOTO END_PROC


RET_PLAN_FILTERS:
SELECT STK_LEVEL_PARA_NAME TABLE_NAME FROM ARS_STOCK_LEVEL_MST WHERE ARS_ID=@Plan
GOTO END_PROC


END_PROC:
SET NOCOUNT OFF
END