CREATE PROCEDURE SP_RETAILSALE_23--(LocId 3 digit change only increased the parameter width by Sanjay:30-10-2024)
(  
	 @CQUERYID			NUMERIC(2)=0,  
	 @CWHERE			VARCHAR(MAX)='',  
	 @CFINYEAR			VARCHAR(5)='',  
	 @CDEPTID			VARCHAR(4)='',  
	 @NNAVMODE			NUMERIC(2)=1,  
	 @CWIZAPPUSERCODE	VARCHAR(10)='',  
	 @CREFMEMOID		VARCHAR(40)='',  
	 @CREFMEMODT		DATETIME='',  
	 @BINCLUDEESTIMATE	BIT=1,  
	 @CFROMDT			DATETIME='',  
	 @CTODT				VARCHAR(50)='',
	 @bCardDiscount		BIT=0,
	 @nProductCodeMrp	NUMERIC(10,2)=0,
	 @nQty NUMERIC(10,2) = 1,
	 @cCustCode			VARCHAR(15)=''
) 
AS  
BEGIN  
	 DECLARE @NDISCPICKINGMODE NUMERIC(1,0),@CERRORMSG VARCHAR(MAX)

	 DECLARE @CCMD NVARCHAR(MAX),@CFLATDISC VARCHAR(10)  
	 SET @CCMD=''  

	 DECLARE @tSlsBc TABLE (DISCOUNT_PERCENTAGE NUMERIC(6,2),net NUMERIC(10,2),discount_amount NUMERIC(10,2))

	 IF @nQty>0
		 INSERT @tSlsBc (DISCOUNT_PERCENTAGE,net,discount_amount)
		 SELECT TOP 1 a.DISCOUNT_PERCENTAGE,a.NET_price*@Nqty as net,a.DISCOUNT_AMOUNT*@Nqty as discount_amount
		 FROM scheme_Setup_slsbc a (NOLOCK)
		 JOIN scheme_Setup_det b (NOLOCK) on  a.scheme_setup_det_row_id=b.row_id
		 JOIN scheme_Setup_mst c (NOLOCK) ON c.memo_no=b.memo_no
		 left JOIN scheme_setup_loc d (NOLOCK) ON d.memo_no=c.memo_no AND d.dept_id=@CDEPTID
		 WHERE PRODUCT_CODE = @CWHERE and @CREFMEMODT BETWEEN applicable_from_dt AND applicable_to_dt AND
		 (c.loc_applicable_mode=1 OR d.memo_no IS NOT NULL) AND scheme_mode=1
	 
	 IF NOT EXISTS (SELECT TOP 1 discount_percentage FROM @tSlsBc)
	 BEGIN
		SET @NDISCPICKINGMODE=(CASE WHEN @nQty>0 THEN 1 ELSE 2 END)


		SELECT A.PRODUCT_CODE,CONVERT(CHAR(7),'') AS SUB_SECTION_CODE,A.QUANTITY,A.DISCOUNT_AMOUNT,A.QUANTITY AS SCHEME_APPLIED_QTY,
		A.DISCOUNT_AMOUNT AS SCHEME_APPLIED_AMOUNT,A.SLSDET_ROW_ID AS SCHEME_SETUP_DET_ROW_ID,A.SLSDET_ROW_ID AS SCHEME_ID,
		A.DISCOUNT_PERCENTAGE,A.MRP,A.NET,A.ROW_ID AS CMD_ROW_ID,A.PACK_SLIP_ID,CONVERT(CHAR(7),'') AS USER_CODE,
		A.DISCOUNT_PERCENTAGE AS BILL_LEVEL_DISCOUNT_PERCENTAGE,B.SCHEME_NAME AS SLS_TITLE,A.QUANTITY AS BNGN_QTY,
		A.DISCOUNT_AMOUNT AS BNGN_DISCOUNT,A.DISCOUNT_PERCENTAGE AS WEIGHTED_AVG_DISC_PCT,A.DISCOUNT_AMOUNT AS WEIGHTED_AVG_DISC_AMT,
		A.ITEM_ROUND_OFF,B.APPLY_EXCLUSIVE_TAX,B.EXCLUSIVE_VAT_TO_DISC,CONVERT(BIT,0) AS CARD_DISCOUNT,
		A.DISCOUNT_AMOUNT AS BILL_LEVEL_DISCOUNT_AMOUNT, CONVERT(CHAR(7),'') AS FORM_ID,A.ROW_ID AS PACK_SLIP_ROW_ID,
		MANUAL_TAX_METHOD,A.CARD_DISCOUNT_PERCENTAGE,A.BASIC_DISCOUNT_PERCENTAGE,A.CARD_DISCOUNT_AMOUNT,A.BASIC_DISCOUNT_AMOUNT,
		B.ROW_ID AS BNGN_ROW_ID,@@spid as sp_id,CONVERT(BIT,0) AS cut_size,a.row_id as ref_cmd_row_id,scheme_discount,
		a.mrp as cmd_mrp,convert(bit,0) fix_mrp_item
		INTO #TMPCMD FROM CMD01106 A (NOLOCK) JOIN SCHEME_SETUP_DET B (NOLOCK) ON B.ROW_ID=A.SLSDET_ROW_ID WHERE 1=2

		INSERT #tmpCmd (PRODUCT_CODE,SUB_SECTION_CODE,QUANTITY,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,
		SCHEME_APPLIED_AMOUNT,SCHEME_SETUP_DET_ROW_ID,SCHEME_ID,DISCOUNT_PERCENTAGE,MRP,NET,
		CMD_ROW_ID,PACK_SLIP_ID,USER_CODE,BILL_LEVEL_DISCOUNT_PERCENTAGE,SLS_TITLE,BNGN_QTY,
		BNGN_DISCOUNT,WEIGHTED_AVG_DISC_PCT,WEIGHTED_AVG_DISC_AMT,ITEM_ROUND_OFF,APPLY_EXCLUSIVE_TAX,
		EXCLUSIVE_VAT_TO_DISC,CARD_DISCOUNT,BILL_LEVEL_DISCOUNT_AMOUNT,FORM_ID,PACK_SLIP_ROW_ID,
		MANUAL_TAX_METHOD,CARD_DISCOUNT_PERCENTAGE,BASIC_DISCOUNT_PERCENTAGE,CARD_DISCOUNT_AMOUNT,
		BASIC_DISCOUNT_AMOUNT,BNGN_ROW_ID,sp_id,cut_size,ref_cmd_row_id,cmd_mrp)

		SELECT PRODUCT_CODE,B.SUB_SECTION_CODE,@nQty AS QUANTITY,0 AS DISCOUNT_AMOUNT,0 AS SCHEME_APPLIED_QTY,
		0 AS SCHEME_APPLIED_AMOUNT,'' AS SCHEME_SETUP_DET_ROW_ID,'' AS SCHEME_ID,
		0 AS DISCOUNT_PERCENTAGE,(CASE WHEN @nProductCodeMrp=0 THEN  A.MRP ELSE @nProductCodeMrp END),
		(CASE WHEN @nProductCodeMrp=0 THEN  A.MRP ELSE @nProductCodeMrp END) AS NET,@cWhere AS CMD_ROW_ID,'' AS PACK_SLIP_ID,'' AS USER_CODE,
		0 AS BILL_LEVEL_DISCOUNT_PERCENTAGE ,'' AS SLS_TITLE,0 AS BNGN_QTY,0 AS BNGN_DISCOUNT,
		0 AS WEIGHTED_AVG_DISC_PCT,0 AS WEIGHTED_AVG_DISC_AMT,0 AS ITEM_ROUND_OFF,0 AS APPLY_EXCLUSIVE_TAX,0 AS EXCLUSIVE_VAT_TO_DISC,@BCARDDISCOUNT AS CARD_DISCOUNT,
		0 AS BILL_LEVEL_DISCOUNT_AMOUNT,'0000000'  AS FORM_ID,'' AS PACK_SLIP_ROW_ID,0 AS MANUAL_TAX_METHOD,
		0 AS CARD_DISCOUNT_PERCENTAGE,0 AS BASIC_DISCOUNT_PERCENTAGE,
		0 AS CARD_DISCOUNT_AMOUNT,0 AS BASIC_DISCOUNT_AMOUNT,'' AS BNGN_ROW_ID,@@SpId as sp_id,0 as cut_size,'' as ref_cmd_row_id,
		(CASE WHEN @nProductCodeMrp=0 THEN  A.MRP ELSE @nProductCodeMrp END) as cmd_mrp
		FROM SKU A WITH (NOLOCK)
		JOIN article b (NOLOCK) ON b.article_code=a.article_code
		WHERE A.PRODUCT_CODE=@cWhere

	

		SELECT product_code as CMD_ROW_ID  ,PRODUCT_CODE  
		INTO #TMPCMDBATCH 
		FROM sku (nolock)  WHERE 1=2
	
		EXEC SP3S_EOSS_GETDISCOUNTS
		@DXNDT=@cRefMemoDt,
		@BSALESSETUPINEFFECT=1,
		@BGETBCDISC=1,
		@cLocationId=@cDeptId,
		@CERRORMSG=@CERRORMSG output

		INSERT @tSlsBc (DISCOUNT_PERCENTAGE,net,discount_amount)
		SELECT discount_percentage,net,discount_amount FROM #tmpCmd
	 END     

	 SELECT *,convert(bit,0) manual_discount,isnull(@cErrormsg,'') errmsg FROM @tSlsBc
end
