CREATE PROCEDURE SP_PPC_PO_PRINT
(
  @PO_ID VARCHAR(50)=''
)
AS
BEGIN

 IF OBJECT_ID('TEMPDB..#TMPPO','U') IS NOT NULL
    DROP TABLE #TMPPO       
 SELECT   REPLACE (CONVERT(VARCHAR, FM_DT, 106),' ','/')  AS FM_DT1,
 REPLACE (CONVERT(VARCHAR, DELIVERY_DT, 106),' ','/')  AS DELIVERY_DT1,A.*,  CAST(0 AS NUMERIC(14,0)) AS SERIAL_NO,B.DT_CREATED,        
   B.ARTICLE_NO, B.ARTICLE_NAME, B.CODING_SCHEME,  B.PARA1_SET, B.PARA2_SET,I.UOM_CODE, I.UOM_NAME, I.UOM_TYPE,        
   C.PARA1_NAME,D.PARA2_NAME,E.PARA3_NAME,       
   '' AS JRD_ROW_ID, '' AS JID_ROW_ID, '' AS JOD_ROW_ID ,        
   M.SUB_SECTION_NAME,N.SECTION_NAME,B.FIX_MRP,      
   ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],            
   '' AS [SKU_DT_CREATED],'' AS [IMAGE_1]  ,
   ISNULL(CM.CURRENCY_NAME,'') AS CURRENCY_NAME,
   B.ARTICLE_DESC 
 INTO #TMPPO   
 FROM PPC_POD01106 A (NOLOCK)          
 JOIN PPC_POM01106 R (NOLOCK) ON R.PO_ID= A.PO_ID           
 LEFT OUTER JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE        
 LEFT OUTER JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE          
 LEFT OUTER JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE           
 LEFT OUTER JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE             
 LEFT OUTER JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE           
 LEFT OUTER JOIN SECTIOND M (NOLOCK) ON B.SUB_SECTION_CODE = M.SUB_SECTION_CODE         
 LEFT OUTER JOIN SECTIONM N (NOLOCK) ON M.SECTION_CODE = N.SECTION_CODE     
 LEFT OUTER JOIN PPC_CURRENCY_MST CM (NOLOCK) ON CM.CURRENCY_CODE=A.CURRENCY_CODE             
 WHERE A.PO_ID = @PO_ID        
 ORDER BY  SRNO        

 
 SELECT FM_DT1,DELIVERY_DT1,ARTICLE_CODE ,PARA1_CODE ,PARA2_CODE ,
        SUM(QUANTITY) AS QUANTITY,
        SUM(ADDITIONAL_QTY ) AS ADDITIONAL_QTY,
        PURCHASE_PRICE AS  PURCHASE_PRICE,
        GROSS_PURCHASE_PRICE AS GROSS_PURCHASE_PRICE ,
        SUM(AMOUNT) AS AMOUNT,
        ITEM_DISCOUNT_PERCENTAGE AS ITEM_DISCOUNT_PERCENTAGE,
        SUM(ITEM_DISCOUNT_AMOUNT) AS ITEM_DISCOUNT_AMOUNT,
        ITEM_TAX_PERCENTAGE AS ITEM_TAX_PERCENTAGE,
        SUM(ITEM_TAX_AMOUNT) AS ITEM_TAX_AMOUNT,
        SUM(MRP) AS MRP,
        PARA3_CODE ,
        PO_ID ,
        FM_DT ,
        DELIVERY_DT ,
        ARTICLE_NO,
        ARTICLE_NAME,
        UOM_NAME ,
        PARA1_NAME,
        PARA2_NAME,
        PARA3_NAME,
        SUB_SECTION_NAME ,
        SECTION_NAME ,
        CURRENCY_NAME ,
        NEWID() AS ROW_ID,
        [IMAGE_1],
        ARTICLE_DESC ,
        CAST('' AS VARCHAR(100)) AS GSTNO
 INTO #DATASET1        
 FROM #TMPPO
 GROUP BY FM_DT1,DELIVERY_DT1,ARTICLE_CODE ,PARA1_CODE ,PARA2_CODE  ,PARA3_CODE ,PO_ID ,FM_DT ,DELIVERY_DT ,
 ARTICLE_NO,ARTICLE_NAME,UOM_NAME ,PARA1_NAME,PARA2_NAME,
 PARA3_NAME,SUB_SECTION_NAME ,SECTION_NAME ,CURRENCY_NAME,[IMAGE_1],ARTICLE_DESC ,
 PURCHASE_PRICE ,GROSS_PURCHASE_PRICE,ITEM_DISCOUNT_PERCENTAGE,ITEM_TAX_PERCENTAGE
 
 ;WITH CTE AS (SELECT SR_NO=ROW_NUMBER()OVER(PARTITION BY ARTICLE_NO ORDER BY ARTICLE_NO),* FROM #DATASET1)
 SELECT * FROM CTE
 
 SELECT UOM_NAME, SUM(QUANTITY)  AS QUANTITY  
 FROM #TMPPO  
 GROUP BY UOM_NAME
 ORDER BY UOM_NAME 
END
