CREATE  VIEW VW_AGENCY_ISSUE_MATERIAL_LIST

AS   
SELECT    

 T1.MEMO_NO  
,T1.MEMO_DT AS MEMO_DATE 
, K.AGENCY_NAME 
,ISNULL(J.JOB_NAME,'') AS MST_JOB_NAME  
, I.WORK_ORDER_NO AS [WORK_ORDER_NO]
, I.REF_NO AS [REFRENCE NO]
,T1.REMARKS AS MST_REMARKS   
,CASE WHEN T1.CANCELLED =0 THEN '' ELSE 'CANCELLED' END AS CANCELLED  
,T2.USERNAME AS USER_NAME 
,T1.MEMO_ID
,T1.DEPARTMENT_ID  
,T1.FIN_YEAR 
,(CASE WHEN I.ISSUE_QTY = I.REC_QTY THEN 'SETTLED' ELSE 'PENDING' END) AS [STATUS],  
I.ISSUE_QTY,I.REC_QTY,(I.ISSUE_QTY - I.REC_QTY) AS PENDING_QTY 

FROM PRD_AGENCY_ISSUE_MATERIAL_MST T1 
JOIN USERS T2 ON T1.USER_CODE = T2.USER_CODE  
JOIN PRD_AGENCY_MST  K ON T1.REF_AGENCY_CODE = K.AGENCY_CODE  	
JOIN  
(  
  SELECT WO.MEMO_NO AS  WORK_ORDER_NO, WO.REF_NO , A.JOB_CODE , B.MEMO_ID, SUM(A.QUANTITY) AS ISSUE_QTY ,SUM(ISNULL(REC_QTY,0)) AS REC_QTY    
  FROM PRD_AGENCY_ISSUE_MATERIAL_DET A (NOLOCK)   
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID 
  JOIN PRD_WO_MST WO ON A.REF_PRD_WORKORDER_MEMOID=WO.MEMO_ID   
  LEFT OUTER JOIN   
  (	
	  SELECT A.REF_ROW_ID,SUM(A.QUANTITY) AS REC_QTY 
	  FROM  PRD_AGENCY_MATERIAL_RECEIPT_DET A (NOLOCK) 
	  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID  
	  JOIN PRD_AGENCY_ISSUE_MATERIAL_DET  C (NOLOCK) ON C.ROW_ID=A.REF_ROW_ID  
	  WHERE B.CANCELLED=0 
	  GROUP BY A.REF_ROW_ID
  ) C ON A.ROW_ID = C.REF_ROW_ID    
  GROUP BY B.MEMO_ID,WO.REF_NO , A.JOB_CODE ,WO.MEMO_NO   
) I ON T1.MEMO_ID = I.MEMO_ID  
JOIN JOBS J ON J.JOB_CODE=I.JOB_CODE
