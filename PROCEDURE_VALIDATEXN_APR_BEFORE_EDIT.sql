CREATE PROC VALIDATEXN_APR_BEFORE_EDIT 
@CMEMOID VARCHAR(30),
@BCANCELXN BIT,
@CERRORMSG VARCHAR(200) OUTPUT,
@CEXPRERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
	   
 DECLARE @CTEXT VARCHAR(10)  
   
 SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)  
  
IF EXISTS(SELECT TOP 1 REF_CM_ID FROM APM01106 A
            JOIN APD01106 B ON B.MEMO_ID=A.MEMO_ID
			JOIN APPROVAL_RETURN_DET C ON C.APD_ROW_ID=B.ROW_ID
			JOIN APPROVAL_RETURN_MST MST ON C.MEMO_ID=MST.MEMO_ID      
            WHERE  ISNULL(REF_CM_ID,'')<>''  AND MST.MEMO_ID=@CMEMOID AND A.CANCELLED=0)            
 BEGIN  
  SET @CERRORMSG='BILL HAS BEEN RAISED AGAINST THIS APPROVAL MEMO.........CAN NOT '+@CTEXT  
  RETURN  
 END  
 
  IF EXISTS(SELECT TOP 1 A.REF_INV_ID FROM INM01106 A JOIN APM01106 B ON A.REF_INV_ID=B.MEMO_ID
		   JOIN APD01106 C ON C.MEMO_ID=B.MEMO_ID
		   JOIN APPROVAL_RETURN_DET D  ON D.APD_ROW_ID=C.ROW_ID	  
		   WHERE D.MEMO_ID=@CMEMOID AND A.CANCELLED=0  )        
   
 BEGIN  
  SET @CERRORMSG='BILL HAS BEEN RAISED AGAINST THIS APPROVAL MEMO.........CAN NOT '+@CTEXT  
  RETURN  
 END 
 			
END
