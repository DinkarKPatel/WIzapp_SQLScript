CREATE VIEW VW_RETAILPS_PRINT_MST  

AS  
SELECT * FROM  
(  
	SELECT A.CM_TIME,A.CM_ID,A.CM_NO,A.CM_DT,A.SUBTOTAL,A.DISCOUNT_PERCENTAGE,A.DISCOUNT_AMOUNT,  
	A.NET_AMOUNT,A.CANCELLED,A.REMARKS,C.USERNAME  
	,X.TOTAL_QTY,X.TOTAL_TAX,''  AS AMOUNT_IN_WORDS ,ISNULL(CMM.CMM_CM_NO,'') AS [CMM_CM_NO], ISNULL(CMM.CMM_USER_NAME,'') AS [CMM_USER_NAME],
	 ISNULL(CMM.CMM_CM_DT,'') AS [CMM_CM_DT],ISNULL(E.EMP_NAME,'') AS [CMM_EMP_NAME],ISNULL(E.EMP_ALIAS,'') AS [CMM_EMP_ALIAS]
	FROM RPS_MST A    
	JOIN USERS C ON C.USER_CODE=A.USER_CODE  
	JOIN   
	( 
		SELECT CM_ID ,SUM(QUANTITY) AS TOTAL_QTY,SUM(TAX_AMOUNT) AS TOTAL_TAX FROM RPS_DET  GROUP BY CM_ID
	)X ON X.CM_ID=A.CM_ID
	JOIN RPS_DET DET ON DET.CM_ID=A.CM_ID
	LEFT OUTER JOIN EMPLOYEE E ON E.EMP_CODE=DET.EMP_CODE
	LEFT OUTER JOIN 
	(
		SELECT DISTINCT CM.CM_ID,CM.CM_NO AS [CMM_CM_NO], U.USERNAME AS [CMM_USER_NAME],
		CM.CM_DT AS [CMM_CM_DT]--,E.EMP_NAME AS [CMM_EMP_NAME],E.EMP_ALIAS AS [CMM_EMP_ALIAS]
		FROM CMM01106 CM 
		JOIN CMD01106 CMD ON CMD.CM_ID=CM.CM_ID
		JOIN USERS U ON U.USER_CODE=CM.USER_CODE
		--LEFT OUTER JOIN EMPLOYEE E ON E.EMP_CODE=CMD.EMP_CODE
	)CMM ON CMM.CM_ID=A.REF_CM_ID
)R
