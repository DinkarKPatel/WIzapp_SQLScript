-- SP_SEND_MIRROR_MSTSCH_NEW '07'
CREATE PROCEDURE DBO.SP_SEND_MIRROR_MSTSCH_NEW
(
 @CTARGETLOCID VARCHAR(5)
)
AS
 BEGIN
   DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION NVARCHAR(MAX)
           ,@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPLMTABLE VARCHAR(100)
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CCURDEPTID VARCHAR(5)
           ,@CHODEPTID VARCHAR(5),@CERRORMSG VARCHAR(MAX),@CREPLOCTABLE VARCHAR(500),@NLOCTYPE INT
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(2),@JOINMASTERTABLE VARCHAR(200),@JOINTEMPTABLE VARCHAR(200),
           @CTEMPLMTABLE1 VARCHAR(100),@JOINTEMPTABLE1 VARCHAR(200),@CCOUNTRYCODE CHAR(7),@NCOUNTRYTYPE BIT

    
    BEGIN TRY
    
	SET @CSTEP=10
	
	 
	SET @CSTEP=20

	SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
	
	IF @CCURDEPTID<>@CHODEPTID
	BEGIN
		SELECT '' AS LAST_UPDATE,'' AS ERRMSG
		
		GOTO END_PROC
	END	
	


		SET @CSTEP=40--LOCSLSSET
			SELECT 'MSTSCH_LOCSLSSET_MIRROR' AS TARGET_TABLENAME,*,1 AS PICK_FROM_CURRENT_DB 
			FROM LOCSLSSET(NOLOCK) WHERE DEPT_ID=@CTARGETLOCID


		SET @CSTEP=40--SLSMST
			SELECT 'MSTSCH_SLSMST_MIRROR' AS TARGET_TABLENAME,A.*,1 AS PICK_FROM_CURRENT_DB 
			FROM SLSMST A(NOLOCK) 
			JOIN LOCSLSSET B(NOLOCK) ON A.SLS_MEMO_NO=B.SLS_MEMO_NO WHERE DEPT_ID=@CTARGETLOCID


		SET @CSTEP=40--SLSDET
			SELECT 'MSTSCH_SLSDET_MIRROR' AS TARGET_TABLENAME,A.*,1 AS PICK_FROM_CURRENT_DB 
			FROM SLSDET A(NOLOCK) 
			JOIN LOCSLSSET B(NOLOCK) ON A.SLS_MEMO_NO=B.SLS_MEMO_NO WHERE DEPT_ID=@CTARGETLOCID
			


		SET @CSTEP=40--SLSART
			SELECT 'MSTSCH_SLSART_MIRROR' AS TARGET_TABLENAME,A.*,1 AS PICK_FROM_CURRENT_DB 
			FROM SLSART A(NOLOCK) 
			JOIN LOCSLSSET B(NOLOCK) ON A.SLS_MEMO_NO=B.SLS_MEMO_NO WHERE DEPT_ID=@CTARGETLOCID


		SET @CSTEP=40--SLSBC
			SELECT 'MSTSCH_SLSBC_MIRROR' AS TARGET_TABLENAME,A.*,1 AS PICK_FROM_CURRENT_DB 
			FROM SLSBC A(NOLOCK) 
			JOIN LOCSLSSET B(NOLOCK) ON A.SLS_MEMO_NO=B.SLS_MEMO_NO WHERE DEPT_ID=@CTARGETLOCID
    
     
END TRY
	
BEGIN CATCH
	    SET @CERRORMSG='P: SP_SEND_MIRROR_MSTSCH_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()+ 'ERROR QUERY || '+@DTSQL
	    GOTO END_PROC
END CATCH 
    
END_PROC:
    
    IF ISNULL(@CERRORMSG,'') <> ''
      SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
    ELSE
      SELECT '' AS ERRMSG
    --ELSE
    --   SELECT '' AS ORG_TABLENAME , '' AS TMP_TABLENAME,@CERRORMSG AS [ERRMSG]
END
