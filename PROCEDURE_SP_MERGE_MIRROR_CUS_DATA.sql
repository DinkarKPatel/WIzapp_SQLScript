create PROCEDURE SP_MERGE_MIRROR_CUS_DATA
(
	@CMEMOID VARCHAR(50),  
    @CLOCID VARCHAR(4), 
    @CSOURCEDB VARCHAR(100),
	@CMERGEDB VARCHAR(100),
	@BMSTINSERTONLY BIT, 
    @CERRMSG VARCHAR(MAX) OUTPUT  
)
AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@CSTEP VARCHAR(10),@CTABLE_SUFFIX VARCHAR(100),
	@CTABLENAME VARCHAR(100),@CTMP_TABLENAME VARCHAR(100),@CKEYFIELD VARCHAR(100),@CREF_CUSTOMER_CODE VARCHAR(100),
	@CTABLESSTR VARCHAR(MAX),@CKEYFIELD1 VARCHAR(100),@bInsertOnly BIT,@cHOID VARCHAR(5)

	SELECT @cHOID= VALUE FROM CONFIG WHERE CONFIG_OPTION ='HO_LOCATION_ID'

	 IF ISNULL(@cHOID,'')=@CLOCID
		SET @bInsertOnly=1
	ELSE
		SET @bInsertOnly=0
	
	DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(40))
	BEGIN TRY 
			
			DECLARE @CFILTERCONDITION VARCHAR(100)
			SET @CFILTERCONDITION=' B.SP_ID='''+@CMEMOID+''''

			SET @CSOURCEDB=''
			SET @CERRMSG=''
			--IF EXISTS (SELECT TOP 1 'U' FROM custdym (NOLOCK) WHERE customer_code =@CMEMOID)
			--    GOTO  EXIT_PROC
			--SET @CTABLE_SUFFIX = REPLACE(@CMEMOID,'-','_') 
			
			--INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('REGIONM')
			--INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('STATE')
			--INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('CITY') 
			--INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('AREA')   
			--INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('CUSTDYM') 

			 SET @CTABLE_SUFFIX='UPLOAD'

			SET @CSTEP = 20 
			SET @CTABLENAME='REGIONM'  
			SET @CTMP_TABLENAME='CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
			SET @CKEYFIELD='REGION_CODE'  
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=0 
				 ,@CFILTERCONDITION=@CFILTERCONDITION


			SET @CSTEP = 30 
			SET @CTABLENAME='STATE'  
			SET @CTMP_TABLENAME='CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
			SET @CKEYFIELD='STATE_CODE'  
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=0 
				 ,@CFILTERCONDITION=@CFILTERCONDITION
		   
			SET @CSTEP = 60
			SET @CTABLENAME='CITY'  
			SET @CTMP_TABLENAME='CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
			SET @CKEYFIELD='CITY_CODE'  
			SET @CSTEP=80 
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=0 
				 ,@CFILTERCONDITION=@CFILTERCONDITION
		    
			SET @CSTEP = 100
			SET @CTABLENAME='AREA'  
			SET @CTMP_TABLENAME='CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
			SET @CKEYFIELD='AREA_CODE'  
			SET @CSTEP= 120 
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=@bInsertOnly,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=0 ,@CFILTERCONDITION=@CFILTERCONDITION

			--SELECT * FROM MIRRORXNSINFO where tablename='AREA'
		    
			SET @CSTEP = 140
			SET @CTABLENAME='CUSTDYM'  
			SET @CTMP_TABLENAME='[CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
			SET @CKEYFIELD='CUSTOMER_CODE'  
			SET @CSTEP= 150
			
			SET @CCMD = N'UPDATE '+@CSOURCEDB+@CTMP_TABLENAME+' SET REF_CUSTOMER_CODE = ''000000000000''
			WHERE sp_id='''+@CMEMOID+'''' 
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

				
			SET @CSTEP= 160
			
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION=@CFILTERCONDITION     
		
		
		declare @CLOCATION_ID varchar(2),@CHOLOCATION_ID varchar(2)
		SELECT @CLOCATION_ID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'  
        SELECT @CHOLOCATION_ID= VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'  
   
		-- On demand customer merge In Location

		if @CLOCATION_ID<>@CHOLOCATION_ID
		begin
			SET @CSTEP= 170
			DECLARE @NCOUNT INT,@BLOOP INT,@CCMD1 NVARCHAR(MAX)
			SET @NCOUNT=25
			SET @BLOOP=1
			WHILE (@BLOOP <=@NCOUNT )
			BEGIN
	      
		 

					SET @CTABLENAME='CUST_ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST'
					SET @CTMP_TABLENAME='Cus_CUST_ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST_upload'
					SET @CKEYFIELD='CUST_ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_KEY_CODE'
					
				   SET @CSTEP=30	

					EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
					 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
					 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
					 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=''
			
	       
				   SET @BLOOP=@BLOOP +1  			
			END
   
			SET @CSTEP=180	
		
			SET @CTABLENAME='customer_fix_attr'
			SET @CTMP_TABLENAME='Cus_'+@CTABLENAME+'_upload'
			SET @CKEYFIELD='customer_code'
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
				 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
				 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION        
        
		  end

			--SET @CSTEP = 170
			--SET @CTABLENAME='ATTRM'  
			--SET @CTMP_TABLENAME='[CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
			--SET @CKEYFIELD='attribute_code'  
				
			--SET @CSTEP= 180
			
			--EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
			--	 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
			--	 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
			--	 ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION=@CFILTERCONDITION    

			--SET @CSTEP = 190
			--SET @CTABLENAME='ATTR_KEY'  
			--SET @CTMP_TABLENAME='[CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
			--SET @CKEYFIELD='key_code'  
				
			--SET @CSTEP= 200
			
			--EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
			--	 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
			--	 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
			--	 ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION=@CFILTERCONDITION    
        
			--SET @CSTEP = 210
			--SET @CTABLENAME='CUST_ATTR'  
			--SET @CTMP_TABLENAME='[CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
			--SET @CKEYFIELD='customer_code' 
			--SET @CKEYFIELD1='attribute_code'
				
			--SET @CSTEP= 220
			
			--EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
			--	 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''  
			--	 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
			--	 ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION=@CFILTERCONDITION 

	END TRY
    
	BEGIN CATCH
	 SET @CERRMSG='P:SP_MERGE_MIRROR_CUS_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH

EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0  
		COMMIT  
	ELSE
	IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0  
		ROLLBACK  
		  

      DELETE a FROM CUS_custdym_UPLOAD a (nolock) WHERE SP_ID  =@CMEMOID 
	  DELETE FROM CUS_AREA_UPLOAD WHERE SP_ID  =@CMEMOID 
	  DELETE FROM CUS_CITY_UPLOAD WHERE SP_ID  =@CMEMOID 
	  DELETE FROM CUS_STATE_UPLOAD WHERE SP_ID  =@CMEMOID 
	  DELETE FROM CUS_REGIONM_UPLOAD WHERE SP_ID  =@CMEMOID 
	  DELETE FROM CUS_ATTRM_UPLOAD WHERE SP_ID  =@CMEMOID 
	  DELETE FROM CUS_ATTR_KEY_UPLOAD WHERE SP_ID  =@CMEMOID 
	  DELETE FROM CUS_CUST_ATTR_UPLOAD WHERE SP_ID  =@CMEMOID 
	
	  if @CLOCATION_ID<>@CHOLOCATION_ID 
	  begin
	
		DELETE FROM Cus_customer_fix_attr_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR1_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR2_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR3_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR4_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR5_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR6_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR7_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR8_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR9_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR10_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR11_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR12_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR13_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR14_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR15_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR16_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR17_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR18_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR19_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR20_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR21_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR22_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR23_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR24_MST_upload WHERE SP_ID  =@CMEMOID 
		DELETE FROM Cus_CUST_ATTR25_MST_upload WHERE SP_ID  =@CMEMOID 
	end
		
END
--END OF THE PROCEDURES SP_MERGE_MIRROR_CUS_DATA