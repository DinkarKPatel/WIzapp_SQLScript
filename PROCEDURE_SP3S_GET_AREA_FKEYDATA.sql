CREATE PROCEDURE SP3S_GET_AREA_FKEYDATA
@CSOURCEDB VARCHAR(200),
@CSOURCETABLE VARCHAR(200),
@CSOURCEKEYFIELD VARCHAR(200),
@CXNTYPE VARCHAR(10),
@CTABLESUFFIX VARCHAR(40),
@CLOCID VARCHAR(5),
@CERRORMSG VARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	BEGIN TRY
		DECLARE @CCMD NVARCHAR(MAX),@CTEMPTABLE VARCHAR(1000),@CTEMPTABLE1 VARCHAR(1000),@CTEMPTABLE2 VARCHAR(1000),
				@CTEMPTABLE3 VARCHAR(1000),@CTEMPTABLE4 VARCHAR(1000),@CKEYFIELDVAL VARCHAR(40),@CDESTDB VARCHAR(200),@CFILTERCONDITION VARCHAR(MAX),
				@NSTEP INT
		
		SET @NSTEP = 10
		SET @CDESTDB='WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.'
		
		IF OBJECT_ID('TEMPDB..#TMPMISSINGCITYDATA','U') IS NOT NULL
			DROP TABLE #TMPMISSINGCITYDATA
		
		SELECT CITY_CODE INTO #TMPMISSINGCITYDATA FROM CITY WHERE 1=2

		IF OBJECT_ID('TEMPDB..#TMPMISSINGSTATEDATA','U') IS NOT NULL
			DROP TABLE #TMPMISSINGSTATEDATA
		
		SELECT STATE_CODE INTO #TMPMISSINGSTATEDATA FROM STATE WHERE 1=2

		IF OBJECT_ID('TEMPDB..#TMPMISSINGREGIONMDATA','U') IS NOT NULL
			DROP TABLE #TMPMISSINGREGIONMDATA
		
		SELECT REGION_CODE INTO #TMPMISSINGREGIONMDATA FROM REGIONM WHERE 1=2
									
		SET @NSTEP = 20
		
		SET @CTEMPTABLE=(CASE WHEN LEFT(@CSOURCETABLE,1)='#' THEN @CSOURCETABLE ELSE @CSOURCEDB+'TMP_'+@CXNTYPE+'_'+@CSOURCETABLE+'_'+@CTABLESUFFIX END)
		SET @CTEMPTABLE1=@CSOURCEDB+'TMP_'+@CXNTYPE+'_REGIONM_'+@CTABLESUFFIX
		SET @CTEMPTABLE2=@CSOURCEDB+'TMP_'+@CXNTYPE+'_STATE_'+@CTABLESUFFIX
		SET @CTEMPTABLE3=@CSOURCEDB+'TMP_'+@CXNTYPE+'_CITY_'+@CTABLESUFFIX
		SET @CTEMPTABLE4=@CSOURCEDB+'TMP_'+@CXNTYPE+'_AREA_'+@CTABLESUFFIX

		SET @NSTEP = 40
		IF OBJECT_ID(@CTEMPTABLE3,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT B.CITY_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE4+'  B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN '+@CTEMPTABLE3+'  C ON C.CITY_CODE=B.CITY_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.CITY D ON D.CITY_CODE=C.CITY_CODE
						WHERE C.CITY_CODE IS NULL AND D.CITY_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE4,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT B.CITY_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE4+'  B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.CITY C ON C.CITY_CODE=B.CITY_CODE
						WHERE C.CITY_CODE IS NULL
						UNION
						SELECT DISTINCT B.CITY_CODE FROM '+@CTEMPTABLE+'  A
						JOIN AREA B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN CITY C ON C.CITY_CODE=B.CITY_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.CITY D ON D.CITY_CODE=C.CITY_CODE
						WHERE D.CITY_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE4,'U') IS NULL
			SET @CCMD=N'SELECT DISTINCT B.CITY_CODE FROM '+@CTEMPTABLE+'  A
						JOIN AREA B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN CITY C ON C.CITY_CODE=B.CITY_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.CITY D ON D.CITY_CODE=C.CITY_CODE
						WHERE D.CITY_CODE IS NULL'
		
		INSERT #TMPMISSINGCITYDATA
		EXEC SP_EXECUTESQL @CCMD
		
		SET @NSTEP = 50
		IF OBJECT_ID(@CTEMPTABLE2,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT C.STATE_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE4+'  B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN '+@CTEMPTABLE3+'  C ON C.CITY_CODE=B.CITY_CODE
						LEFT OUTER JOIN '+@CTEMPTABLE2+'  D ON D.STATE_CODE=C.STATE_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.STATE E ON E.STATE_CODE=D.STATE_CODE
						WHERE D.STATE_CODE IS NULL AND E.STATE_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE4,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT C.STATE_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE4+'  B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN CITY C ON C.CITY_CODE=B.CITY_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.STATE D ON D.STATE_CODE=C.STATE_CODE
						WHERE D.STATE_CODE IS NULL
						UNION
						SELECT DISTINCT C.STATE_CODE FROM '+@CTEMPTABLE+'  A
						JOIN AREA B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN CITY C ON C.CITY_CODE=B.CITY_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.STATE D ON D.STATE_CODE=C.STATE_CODE
						WHERE D.STATE_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE4,'U') IS NULL
			SET @CCMD=N'SELECT DISTINCT C.STATE_CODE FROM '+@CTEMPTABLE+'  A
						JOIN AREA B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN CITY C ON C.CITY_CODE=B.CITY_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.STATE D ON D.STATE_CODE=C.STATE_CODE
						WHERE D.STATE_CODE IS NULL'
		
		PRINT @CCMD
		INSERT #TMPMISSINGSTATEDATA
		EXEC SP_EXECUTESQL @CCMD
		
		SET @NSTEP = 65
		IF OBJECT_ID(@CTEMPTABLE1,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT D.REGION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE4+'  B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN '+@CTEMPTABLE3+'  C ON C.CITY_CODE=B.CITY_CODE
						JOIN '+@CTEMPTABLE2+'  D ON D.STATE_CODE=C.STATE_CODE
						LEFT OUTER JOIN '+@CTEMPTABLE1+'  E ON E.REGION_CODE=D.REGION_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.REGIONM F ON F.REGION_CODE=D.REGION_CODE
						WHERE D.REGION_CODE IS NULL AND E.REGION_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE4,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT D.REGION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE4+'  B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN '+@CTEMPTABLE3+'  C ON C.CITY_CODE=B.CITY_CODE
						JOIN '+@CTEMPTABLE2+'  D ON D.STATE_CODE=C.STATE_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.REGIONM F ON F.REGION_CODE=D.REGION_CODE
						WHERE F.REGION_CODE IS NULL
						UNION
						SELECT DISTINCT C.REGION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN AREA B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN CITY C ON C.CITY_CODE=B.CITY_CODE
						JOIN STATE D ON D.STATE_CODE=C.STATE_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.REGIONM E ON E.REGION_CODE=D.REGION_CODE
						WHERE E.REGION_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE4,'U') IS NULL
			SET @CCMD=N'SELECT DISTINCT D.REGION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN AREA B ON B.AREA_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN CITY C ON C.CITY_CODE=B.CITY_CODE
						JOIN STATE D ON D.STATE_CODE=C.STATE_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.REGIONM E ON E.REGION_CODE=D.REGION_CODE
						WHERE E.REGION_CODE IS NULL'
		PRINT @CCMD
		
		INSERT #TMPMISSINGREGIONMDATA
		EXEC SP_EXECUTESQL @CCMD
		
		IF EXISTS (SELECT TOP 1 REGION_CODE FROM #TMPMISSINGREGIONMDATA)
		BEGIN
			SET @NSTEP = 70		
			SET @CFILTERCONDITION= 'B.REGION_CODE IN (SELECT REGION_CODE FROM #TMPMISSINGREGIONMDATA)'
			
			EXEC UPDATEMASTERXN_MIRROR
			@CSOURCEDB='',
			@CSOURCETABLE='REGIONM',
			@CDESTDB=@CDESTDB,
			@CDESTTABLE='REGIONM',
			@CKEYFIELD1='REGION_CODE',
			@LINSERTONLY=0,
			@CFILTERCONDITION=@CFILTERCONDITION,
			
			
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1
		END

		IF EXISTS (SELECT TOP 1 STATE_CODE FROM #TMPMISSINGSTATEDATA)
		BEGIN
			SET @NSTEP = 80		
			SET @CFILTERCONDITION= 'B.STATE_CODE IN (SELECT STATE_CODE FROM #TMPMISSINGSTATEDATA)'
			
			EXEC UPDATEMASTERXN_MIRROR
			@CSOURCEDB='',
			@CSOURCETABLE='STATE',
			@CDESTDB=@CDESTDB,
			@CDESTTABLE='STATE',
			@CKEYFIELD1='STATE_CODE',
			@LINSERTONLY=0,
			@CFILTERCONDITION=@CFILTERCONDITION,
			
			
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1
		END

		IF EXISTS (SELECT TOP 1 CITY_CODE FROM #TMPMISSINGCITYDATA)
		BEGIN
			SET @NSTEP = 90		
			SET @CFILTERCONDITION= 'B.CITY_CODE IN (SELECT CITY_CODE FROM #TMPMISSINGCITYDATA)'
			
			EXEC UPDATEMASTERXN_MIRROR
			@CSOURCEDB='',
			@CSOURCETABLE='CITY',
			@CDESTDB=@CDESTDB,
			@CDESTTABLE='CITY',
			@CKEYFIELD1='CITY_CODE',
			@LINSERTONLY=0,
			@CFILTERCONDITION=@CFILTERCONDITION,
			
			
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1
		END

		SET @NSTEP = 100		
		SET @CFILTERCONDITION= 'B.AREA_CODE IN (SELECT AREA_CODE FROM #TMPMISSINGAREADATA)'
		
		EXEC UPDATEMASTERXN_MIRROR
		@CSOURCEDB='',
		@CSOURCETABLE='AREA',
		@CDESTDB=@CDESTDB,
		@CDESTTABLE='AREA',
		@CKEYFIELD1='AREA_CODE',
		@LINSERTONLY=0,
		@CFILTERCONDITION=@CFILTERCONDITION,
		
		
		@LUPDATEONLY=0,
		@BALWAYSUPDATE=1
		
		GOTO END_PROC									
		
	END TRY
	
	BEGIN CATCH
		SELECT @CERRORMSG='PROCEDURE SP3S_GET_AREA_FKEYDATA : '+ISNULL(ERROR_PROCEDURE(),'NULL P')+'STEP :'+STR(ISNULL(@NSTEP,0))+ ' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		GOTO END_PROC
	END CATCH
	
END_PROC:
		
END
----'END OF PROCEDURE SP3S_GET_AREA_FKEYDATA'
