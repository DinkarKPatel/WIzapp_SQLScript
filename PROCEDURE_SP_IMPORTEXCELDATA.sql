CREATE PROCEDURE SP_IMPORTEXCELDATA
@PATH VARCHAR(511),
@SHEETNAME VARCHAR(127),
@LINKEDSERVER SYSNAME = 'TEMPEXCELIMPORT'
AS
BEGIN

	-- COLUMN WILL BE RECOGNIZED:
	-- PLEASE UNREMARK THESE COMMANDS IF ANY ERROR COMES WHILE CREATING OR EXECUTE THIS PROCEDURE FOR ONCE ONLY
--	EXEC MASTER..XP_REGWRITE
--	@ROOTKEY='HKEY_LOCAL_MACHINE',
--	@KEY='SOFTWARE\MICROSOFT\JET\4.0\ENGINES\EXCEL',
--	@VALUE_NAME='TYPEGUESSROWS',
--	@TYPE='REG_DWORD',
--	@VALUE=200
--
--	-- IMPORT MIXED-TYPE COLUMNS AS TEXT:
--	EXEC MASTER..XP_REGWRITE
--	@ROOTKEY='HKEY_LOCAL_MACHINE',
--	@KEY='SOFTWARE\MICROSOFT\JET\4.0\ENGINES\EXCEL',
--	@VALUE_NAME='IMPORTMIXEDTYPES',
--	@TYPE='REG_SZ',
--	@VALUE='TEXT'

	SET NOCOUNT ON
	DECLARE @CCMD NVARCHAR(4000),@CCOLNAME VARCHAR(50),@CMES VARCHAR(1000),@CRETCMD NVARCHAR(1000)

	-- DROP SERVER IF IT ALREADY EXISTS
	DECLARE @SERVERS TABLE (
	SRV_NAME SYSNAME NULL,
	SRV_PROVIDERNAME NVARCHAR(128) NULL,
	SRV_PRODUCT NVARCHAR(128) NULL,
	SRV_DATASOURCE NVARCHAR(4000) NULL,
	SRV_PROVIDERSTRING NVARCHAR(4000),
	SRV_LOCATION NVARCHAR(4000) NULL,
	SRV_CAT SYSNAME NULL)

	INSERT INTO @SERVERS
	EXEC SP_LINKEDSERVERS

	IF EXISTS (SELECT * FROM @SERVERS
	WHERE SRV_NAME = @LINKEDSERVER)
	BEGIN
		EXEC SP_DROPSERVER
		@SERVER = @LINKEDSERVER,
		@DROPLOGINS = 'DROPLOGINS';
	END

	-- ADD LINKED SERVER
	EXEC SP_ADDLINKEDSERVER
	@SERVER = @LINKEDSERVER,
	@SRVPRODUCT = 'JET 4.0',
	@PROVIDER = 'MICROSOFT.JET.OLEDB.4.0',
	@DATASRC = @PATH,
	@PROVSTR = 'EXCEL 8.0;HDR=NO;IMEX=1';

	EXEC SP_DROPLINKEDSRVLOGIN @LINKEDSERVER, NULL;
	EXEC SP_ADDLINKEDSRVLOGIN @LINKEDSERVER, FALSE, NULL, NULL, NULL;

	-- CHECK IF DESIRED SHEET EXISTS
	DECLARE @SHEETS TABLE (
	TABLE_SERVER SYSNAME NULL,
	TABLE_NAME SYSNAME NULL,
	TABLE_SCHEMA SYSNAME NULL,
	TABLE_CATALOG SYSNAME NULL,
	FUSEPATTERN BIT);

	INSERT INTO @SHEETS
	EXEC SP_TABLES_EX @LINKEDSERVER;
	
	--SELECT * FROM @SHEETS

	IF EXISTS(SELECT * FROM @SHEETS WHERE TABLE_SCHEMA = @SHEETNAME)
	BEGIN
		-- OUTPUT SHEET DATA
		IF OBJECT_ID('TMPEXCELDATA','U') IS NOT NULL 
			  DROP TABLE TMPEXCELDATA 	

		SET @CCMD = 'SELECT * INTO TMPEXCELDATA FROM ' +
				   @LINKEDSERVER + '...[' + @SHEETNAME +'] WHERE 1=2 ';
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD;

		SET @CCMD=''

		
		DECLARE ABC CURSOR FOR SELECT NAME FROM SYSCOLUMNS WHERE ID = OBJECT_ID('TMPEXCELDATA')
		OPEN ABC
		FETCH NEXT FROM ABC INTO @CCOLNAME
		WHILE @@FETCH_STATUS=0
		BEGIN
			SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END)+'CONVERT(VARCHAR,'+@CCOLNAME+') AS '+@CCOLNAME
			FETCH NEXT FROM ABC INTO @CCOLNAME
		END
		CLOSE ABC
		DEALLOCATE ABC

		IF OBJECT_ID('TMPEXCELDATA','U') IS NOT NULL 
			  DROP TABLE TMPEXCELDATA 	

		SET @CCMD = 'SELECT '+@CCMD+' INTO TMPEXCELDATA FROM ' +
				   @LINKEDSERVER + '...[' + @SHEETNAME +'] ';
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD;
	END
	ELSE
	BEGIN 
		SET @CMES = 'NO EXCEL SHEET FOUND WITH THE NAME SHEET1....PLEASE CHECK'
		SET @CRETCMD = 'SELECT '''+@CMES+''' AS MSG '
	END

	-- DROP LINKED SERVER
	EXEC SP_DROPSERVER
	@SERVER = @LINKEDSERVER,
	@DROPLOGINS = 'DROPLOGINS';

	RETURN 0
END
