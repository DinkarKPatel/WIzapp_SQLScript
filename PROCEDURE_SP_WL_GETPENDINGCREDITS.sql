CREATE PROCEDURE SP_WL_GETPENDINGCREDITS
(
	@CCUSTOMERCODE VARCHAR(20),
	@CCMID VARCHAR(40)='',
	@NGETPENDING NUMERIC(2)=0
)
--WITH ENCRYPTION
AS
BEGIN  
  
 DECLARE @cCutoffDate VARCHAR(10)  
   
 SELECT TOP 1 @cCutoffDate=value FROM config(NOLOCK) WHERE config_option='CUTOFF_DATE_FOR_PENDING_ADV_CN_CR'  
   
 IF OBJECT_ID('TEMPDB..#D1','U') IS NOT NULL 
	DROP TABLE #D1
  CREATE TABLE #D1(ADJ_MEMO_ID VARCHAR(50),CREDIT_REFUND_AMOUNT NUMERIC(14,2))
   CREATE INDEX IX_D1 ON #D1(CREDIT_REFUND_AMOUNT) INCLUDE (ADJ_MEMO_ID)
   
 IF @NGETPENDING=0  
 BEGIN  
  
  
  INSERT INTO #D1(ADJ_MEMO_ID ,CREDIT_REFUND_AMOUNT)
  SELECT A.ADJ_MEMO_ID,ISNULL(SUM(ABS(A.AMOUNT)),0) AS CREDIT_REFUND_AMOUNT  
   FROM PAYMODE_XN_DET A (NOLOCK)  
   JOIN CMM01106 B (NOLOCK) ON A.MEMO_ID = B.CM_ID   AND A.xn_type='SLS' 
   WHERE  (B.CUSTOMER_CODE=@CCUSTOMERCODE OR B.AC_CODE =@CCUSTOMERCODE)  
   AND B.CM_ID <> @CCMID  
   AND B.CANCELLED = 0  
   AND ISNULL(A.ADJ_MEMO_ID,'')<>''
   GROUP BY A.ADJ_MEMO_ID
  ;WITH B
  AS
  (
	SELECT A.MEMO_ID, SUM(A.AMOUNT) AS CREDIT_AMOUNT   
	FROM PAYMODE_XN_DET A (NOLOCK)  
	JOIN CMM01106 B (NOLOCK) ON A.MEMO_ID=B.CM_ID  
	WHERE B.CANCELLED=0 AND XN_TYPE = 'SLS'   
	AND PAYMODE_CODE = '0000004'   
	AND A.AMOUNT > 0   
	AND (B.CUSTOMER_CODE = @CCUSTOMERCODE OR B.AC_CODE =@CCUSTOMERCODE)  
	GROUP BY A.MEMO_ID  
  ),
  C
  AS
  (
	SELECT A.CM_ID,SUM(RECEIPT_AMOUNT) AS RECEIPT_AMT FROM CMM_CREDIT_RECEIPT A (NOLOCK)  
	JOIN ARC01106 B (NOLOCK) ON A.ADV_REC_ID=B.ADV_REC_ID  
	WHERE (B.CUSTOMER_CODE=@CCUSTOMERCODE OR B.AC_CODE =@CCUSTOMERCODE)  
	AND B.CANCELLED = 0  
	GROUP BY A.CM_ID 
   )
  
  SELECT A.CM_ID, A.CM_NO, A.CM_DT, A.NET_AMOUNT
  ,  
    B.CREDIT_AMOUNT
     ,(ISNULL(C.RECEIPT_AMT,0)+ISNULL(D.CREDIT_REFUND_AMOUNT,0)) AS RECEIVED_AMOUNT
     ,  CAST(0 AS NUMERIC(10,2) ) AS ADJ_AMOUNT    
   FROM CMM01106 A (NOLOCK)  
   JOIN  B ON A.CM_ID = B.MEMO_ID  
	LEFT OUTER JOIN   C ON C.CM_ID=A.CM_ID  
	 LEFT OUTER JOIN #D1  D ON D.ADJ_MEMO_ID=A.CM_ID  
      
  WHERE a.CM_DT>=@cCutoffDate AND  A.CANCELLED=0 AND   
  (A.CUSTOMER_CODE = @CCUSTOMERCODE OR A.AC_CODE =@CCUSTOMERCODE)   
  AND (B.CREDIT_AMOUNT -  ( ISNULL(C.RECEIPT_AMT,0)+ ISNULL(D.CREDIT_REFUND_AMOUNT,0)))  > 0    
   
 END  
 ELSE  
 BEGIN  
  SELECT B.CM_ID,B.CM_NO,B.CM_DT,B.NET_AMOUNT,C.CREDIT_AMOUNT,  
  CONVERT(NUMERIC(14,2) ,0) AS RECEIVED_AMOUNT,A.CREDIT_REFUND_AMOUNT  AS  ADJ_AMOUNT  
  FROM CMM01106 B (NOLOCK)  
  JOIN CMR01106 A (NOLOCK) ON B.CM_ID=A.REF_CM_ID  
  JOIN  
  (  
   SELECT MEMO_ID, SUM(AMOUNT) AS CREDIT_AMOUNT   
   FROM PAYMODE_XN_DET (NOLOCK)  
   WHERE XN_TYPE = 'SLS'   
   AND PAYMODE_CODE = '0000004'   
   AND AMOUNT > 0   
   GROUP BY MEMO_ID  
  )C ON B.CM_ID = C.MEMO_ID  
  WHERE B.CANCELLED=0 AND A.CM_ID=@CCMID  
 END  
 END
--********************************* END OF PROCEDURE SP_WL_GETPENDINGCREDITS
