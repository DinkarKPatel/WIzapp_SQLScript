CREATE PROCEDURE SP_GETLOCATIONLIST_DN   
@BIMPLEMENTBILLINGRULE BIT=0,   
@ISLOCATION BIT=0,    
@ISPURLOCATION BIT=0,   
@CDEPTID VARCHAR(MAX)='',   
@CUSER_CODE VARCHAR(10)='',   
@CWHERE VARCHAR(MAX)=''    
  
--WITH ENCRYPTION  
AS    
BEGIN   
 DECLARE @CLOC VARCHAR(5),@CHOLOC VARCHAR(5),@ALLOW_TO_SELECT_BIN INT  
       
 IF @CDEPTID=''   
  SELECT @CLOC=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
 ELSE  
  SELECT @CLOC= @CDEPTID   
    
  
  SELECT @CHOLOC=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'  
    
    
  SELECT TOP 1  @ALLOW_TO_SELECT_BIN=VALUE FROM USER_ROLE_DET A  
  JOIN USERS B ON A.ROLE_ID=B.ROLE_ID   
  WHERE USER_CODE=@CUSER_CODE   
  AND FORM_NAME='STOCKTRANSFER'  
  AND FORM_OPTION='ALLOW_TO_SELECT_BIN'  
  
  
  IF @BIMPLEMENTBILLINGRULE=1    
  BEGIN  
  
  SELECT A.DEPT_ID,A.DEPT_ID+'-'+DEPT_NAME AS DEPT_NAME,  
  (CASE WHEN (locS.loc_type=2 AND locS.account_posting_at_ho=1) OR (a.loc_type=2 AND a.account_posting_at_ho=1)  
          THEN flls.ac_code ELSE a.DEPT_AC_CODE END) as DEPT_AC_CODE, R.*,  
  AC_NAME,a.LOC_TYPE,UPD_PURINFO,PUR_LOC,XFER_ACT,LOC_DISCOUNT_PERCENTAGE,  
  ISNULL(B1.BIN_ID,'000') AS [BIN_ID],ISNULL(B2.BIN_NAME,'DEFAULT BIN') AS [BIN_NAME],  
  A.STATE_CODE,A.LOC_TYPE,A.FR_TYPE,  
  ISNULL(A.ADDRESS1,'') + ' ' + ISNULL(A.ADDRESS2,'') + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +         
  A.STATE AS 'LOC_ADDRESS'  ,A.loc_gst_no,A.invoice_control_ac_code,B.Ac_gst_no AS party_gst_no
  FROM LOC_VIEW A (NOLOCK)   
  JOIN LOC_BILLING_RULES R (NOLOCK) ON R.TARGET_DEPT_ID=A.DEPT_ID  
  JOIN LMV01106 B  (NOLOCK) ON A.DEPT_AC_CODE = B.AC_CODE   
  LEFT OUTER JOIN BIN_LOC B1 ON B1.DEPT_ID=A.DEPT_ID  
  LEFT OUTER JOIN BIN B2 ON B2.BIN_ID=B1.BIN_ID  
  LEFT OUTER JOIN FRANCHISE_LOC_LEDGER_SETUP FLLS (NOLOCK) ON FLLS.source_dept_id=@cLoc AND FLLS.target_Dept_id=a.dept_id  
  JOIN (SELECT dept_id,loc_type,account_posting_at_ho FROM location WHERE dept_id=@cLoc) locS ON 1=1   
  WHERE (DOC_TYPE=2 OR DOC_TYPE=3) AND A.INACTIVE=0   
  AND (ISNULL(@ALLOW_TO_SELECT_BIN,0)=1 OR ISNULL(B1.BIN_ID,'000')='000')  
  AND R.SOURCE_DEPT_ID=@CDEPTID   
  AND (@CWHERE='' OR (A.DEPT_ID LIKE @CWHERE OR A.DEPT_ALIAS LIKE @CWHERE OR A.DEPT_NAME LIKE @CWHERE))    
    
   END  
 ELSE IF @ISLOCATION=1 OR @ISPURLOCATION=1  
 BEGIN  
    SELECT A.DEPT_ID,A.DEPT_ID+'-'+DEPT_NAME AS DEPT_NAME,  
    (CASE WHEN (locS.loc_type=2 AND locS.account_posting_at_ho=1) OR (a.loc_type=2 AND a.account_posting_at_ho=1)  
          THEN flls.ac_code ELSE a.DEPT_AC_CODE END) as dept_ac_code,AC_NAME,a.LOC_TYPE,UPD_PURINFO,PUR_LOC,XFER_ACT,  
    LOC_DISCOUNT_PERCENTAGE ,ISNULL(B1.BIN_ID,'000') AS [BIN_ID],ISNULL(B2.BIN_NAME,'DEFAULT BIN') AS [BIN_NAME],A.STATE_CODE,  
    A.LOC_TYPE,A.FR_TYPE,  
    ISNULL(A.ADDRESS1,'') + ' ' + ISNULL(A.ADDRESS2,'') + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +         
    A.STATE AS 'LOC_ADDRESS'   ,A.loc_gst_no,A.invoice_control_ac_code,B.Ac_gst_no AS party_gst_no
    FROM LOC_VIEW A (NOLOCK)   
    JOIN LMV01106 B  (NOLOCK) ON A.DEPT_AC_CODE = B.AC_CODE   
    LEFT OUTER JOIN BIN_LOC B1 ON B1.DEPT_ID=A.DEPT_ID  
    LEFT OUTER JOIN BIN B2 ON B2.BIN_ID=B1.BIN_ID  
    LEFT OUTER JOIN FRANCHISE_LOC_LEDGER_SETUP FLLS (NOLOCK) ON FLLS.source_dept_id=@cLoc AND FLLS.target_Dept_id=a.dept_id  
    JOIN (SELECT dept_id,loc_type,account_posting_at_ho FROM location WHERE dept_id=@cLoc) locS ON 1=1   
    WHERE A.DEPT_ID <> @CDEPTID AND A.INACTIVE=0   
    AND (ISNULL(@ALLOW_TO_SELECT_BIN,0)=1 OR ISNULL(B1.BIN_ID,'000')='000')  
    AND (PUR_LOC = 1 OR A.DEPT_ID=@CHOLOC)  
    AND (@CWHERE='' OR (A.DEPT_ID LIKE @CWHERE OR A.DEPT_ALIAS LIKE @CWHERE OR A.DEPT_NAME LIKE @CWHERE))  
 END    
 ELSE  
 BEGIN  
  SELECT A.DEPT_ID,A.DEPT_ID+'-'+DEPT_NAME AS DEPT_NAME,  
  (CASE WHEN (locS.loc_type=2 AND locS.account_posting_at_ho=1) OR (a.loc_type=2 AND a.account_posting_at_ho=1)  
          THEN flls.ac_code ELSE a.DEPT_AC_CODE END) as DEPT_AC_CODE,AC_NAME,a.LOC_TYPE,  
  UPD_PURINFO,PUR_LOC,XFER_ACT,LOC_DISCOUNT_PERCENTAGE ,  
  ISNULL(B1.BIN_ID,'000') AS [BIN_ID],ISNULL(B2.BIN_NAME,'DEFAULT BIN') AS [BIN_NAME],A.STATE_CODE,  
  A.LOC_TYPE,A.FR_TYPE,  
  ISNULL(A.ADDRESS1,'') + ' ' + ISNULL(A.ADDRESS2,'') + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +         
  A.STATE AS 'LOC_ADDRESS'   ,A.loc_gst_no,A.invoice_control_ac_code,B.Ac_gst_no AS party_gst_no
  FROM LOC_VIEW A (NOLOCK)   
  JOIN LMV01106 B (NOLOCK) ON A.DEPT_AC_CODE = B.AC_CODE   
  LEFT OUTER JOIN BIN_LOC B1 ON B1.DEPT_ID=A.DEPT_ID  
  LEFT OUTER JOIN BIN B2 ON B2.BIN_ID=B1.BIN_ID  
  LEFT OUTER JOIN FRANCHISE_LOC_LEDGER_SETUP FLLS (NOLOCK) ON FLLS.source_dept_id=@cLoc AND FLLS.target_Dept_id=a.dept_id  
  JOIN (SELECT dept_id,loc_type,account_posting_at_ho FROM location WHERE dept_id=@cLoc) locS ON 1=1   
  WHERE A.DEPT_ID <> @CDEPTID AND A.INACTIVE=0 AND a.LOC_TYPE=1  
  AND (ISNULL(@ALLOW_TO_SELECT_BIN,0)=1 OR ISNULL(B1.BIN_ID,'000')='000')  
  AND (@CWHERE='' OR (A.DEPT_ID LIKE @CWHERE OR A.DEPT_ALIAS LIKE @CWHERE OR A.DEPT_NAME LIKE @CWHERE))  
 END  
END  