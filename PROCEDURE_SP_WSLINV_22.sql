CREATE procEDURE SP_WSLINV_22--(LocId 3 digit change by Sanjay:04-11-2024)
	@CMEMOID	VARCHAR(40) = '',
	@CWHERE1	VARCHAR(500) = '',
	@NNAVMODE	NUMERIC(1,0) = 0,
	@CWHERE2	NVARCHAR(MAX)='',
	@DMEMODT DATETIME='',
	@CLOCID		VARCHAR(4)=''
----WITH ENCRYPTION
AS
BEGIN
/*
	   @NNAVMODE : 1 IS FOR ADD MODE, RETURN ALL PENDING WSL ORDERS WHOSE INVOICE HAS NOT BEEN RAISED.
				   2 IS FOR EDIT MODE, RETURN ALL PENDING WSL ORDERS AND CURRENT INVOICE WSL ORDER DETAILS 		
	   @CMEMOID  : REQUIRED IF CALLED FOR EDIT MODE.
	*/

	    DECLARE @LEVEL_NO INT
		SELECT TOP 1 @LEVEL_NO=LEVEL_NO  FROM XN_APPROVAL_CHECKLIST_LEVEL_USERS A  
		WHERE A.XN_TYPE ='WSLORD'	AND DEPT_ID =@CLOCID

		

	IF @NNAVMODE=1
	BEGIN
			SELECT  CAST(0 AS BIT) AS CHK,A.ORDER_ID,A.ORDER_NO,A.ORDER_DT,A.ORDER_TIME,A.REF_NO,
		    SUM(CASE WHEN memo_type<>2 THEN B.QUANTITY ELSE ISNULL(PL_QTY,0) END) AS TOTAL_QUANTITY ,
			 CAST(0 AS NUMERIC(18,2)) AS RECEIVED_QTY,CAST(0 AS NUMERIC(18,2)) AS PENDING_QTY,
			U.username,(CASE WHEN A.MEMO_TYPE=1 THEN 'Direct' WHEN memo_type=2 THEN 'PickList' ELSE 'CUSTOMIZE' END) AS TYPE  
			FROM BUYER_ORDER_MST A (NOLOCK)
			JOIN buyer_order_det b (NOLOCK) ON b.order_id=a.order_id
			JOIN USERS U (NOLOCK) ON A.USER_CODE=U.user_code
			WHERE A.MEMO_TYPE IN (1,2) AND A.CANCELLED = 0 
			AND A.AC_CODE = @CWHERE1  
			and ApprovedLevelNo=99
			 and (ISNULL(A.Short_close,0)  <> 1 OR memo_type<>1)
			AND (@CLOCID='' OR ISNULL(WBO_FOR_DEPT_ID,A.location_code)=@CLOCID)
			GROUP BY memo_type,A.ORDER_ID,A.ORDER_NO,A.ORDER_DT,A.ORDER_TIME,A.REF_NO,username
			HAVING SUM((CASE WHEN memo_type<>2 THEN B.QUANTITY ELSE ISNULL(PL_QTY,0) END)-ISNULL(inv_qty,0))>0
			ORDER BY A.ORDER_DT,A.ORDER_ID
			
			
	END
	ELSE 
	BEGIN
			SELECT  (CASE WHEN C1.ORDER_ID IS NULL THEN 0 ELSE 1 END)  AS CHK,A.ORDER_ID,A.ORDER_NO,A.ORDER_DT,A.ORDER_TIME,A.REF_NO,
			(CASE WHEN A.MEMO_TYPE=1 THEN 'Direct' WHEN memo_type=2 THEN 'PickList' ELSE 'CUSTOMIZE' END) AS TYPE  
			,SUM(CASE WHEN  memo_type<>2 THEN B.QUANTITY ELSE ISNULL(PL_QTY,0) END) AS TOTAL_QUANTITY,CAST(0 AS NUMERIC(18,2)) AS RECEIVED_QTY,CAST(0 AS NUMERIC(18,2)) AS PENDING_QTY,U.username
			FROM BUYER_ORDER_MST A
			JOIN USERS U (NOLOCK) ON A.USER_CODE=U.user_code
			JOIN buyer_order_det b (NOLOCK) ON b.order_id=a.order_id
			LEFT OUTER JOIN
			(
				SELECT DISTINCT B.ORDER_ID
				FROM IND01106 B 
				JOIN INM01106 C ON B.INV_ID = C.INV_ID
				WHERE C.CANCELLED=0  AND C.INV_ID=@CMEMOID
			)C1 ON A.ORDER_ID   = C1.ORDER_ID
			WHERE A.MEMO_TYPE IN (1,2) AND A.CANCELLED = 0 
			AND A.AC_CODE =@CWHERE1 
			and (ISNULL(A.Short_close,0)  <> 1 OR memo_type<>1)
			AND (@CLOCID='' OR ISNULL(WBO_FOR_DEPT_ID,A.location_code)=@CLOCID)
			GROUP BY memo_type,(CASE WHEN C1.ORDER_ID IS NULL THEN 0 ELSE 1 END) ,A.ORDER_ID,A.ORDER_NO,A.ORDER_DT,A.ORDER_TIME,A.REF_NO,username
			HAVING SUM((CASE WHEN memo_type<>2 THEN B.QUANTITY ELSE ISNULL(PL_QTY,0) END)-ISNULL(inv_qty,0))>0
			ORDER BY A.ORDER_DT,A.ORDER_ID
	END
END
