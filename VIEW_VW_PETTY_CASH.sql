create VIEW VW_PETTY_CASH

AS


SELECT PEM_MEMO_NO AS MEMO_NO , PEM_MEMO_DT AS MEMO_DT,
       DATENAME (YYYY,PEM_MEMO_DT) AS MEMO_YEAR,DATENAME (M,PEM_MEMO_DT) AS MEMO_MONTH,
       DATEPART(M,PEM_MEMO_DT) AS  MEMO_MONTH_NO,
       C.AC_NAME,C.ADDRESS0 , C.ADDRESS1 ,C.ADDRESS2 ,
       C.ALIAS,C.AREA_NAME AS SUPP_AREA_NAME,C.CITY AS SUPP_CITY,C.STATE AS SUPP_STATE,
       D.DEPT_ID,D.DEPT_NAME,D.AREA_NAME ,D.CITY ,D.STATE,
       XN_AMOUNT, 
	   CASE WHEN XN_TYPE='DR' THEN 'CR' ELSE 'DR' END as XN_TYPE ,
	   NARRATION ,B.REF_NO,D.dept_alias 
FROM PEM01106 A (NOLOCK)
JOIN PED01106 B (NOLOCK) ON A.PEM_MEMO_ID = B.PEM_MEMO_ID 
JOIN LMV01106 C (NOLOCK) ON  B.AC_CODE= C.AC_CODE
JOIN LOC_VIEW D ON A.location_code/*LEFT(A.PEM_MEMO_ID,2)*//*Rohit 04-11-2024*/ = D.DEPT_ID
LEFT JOIN LOC_REQ (NOLOCK) ON loc_req.dept_id=D.DEPT_ID AND loc_req.OPENING_CASH_BALANCE<>0
where a.cancelled=0 AND PEM_MEMO_DT>ISNULL(LOC_REQ.OPENING_CASH_DATE,'')
UNION ALL

SELECT  MEMO_NO , receipt_dt,  
       DATENAME (YYYY,receipt_dt) AS MEMO_YEAR,DATENAME (M,receipt_dt) AS MEMO_MONTH,  
       DATEPART(M,receipt_dt) AS  MEMO_MONTH_NO,  
       ISNULL(C.TILL_NAME ,D.DEPT_NAME) AS AC_NAME,'' AS ADDRESS0 , '' AS ADDRESS1 ,'' AS ADDRESS2 ,  
       '' AS ALIAS,'' AS  SUPP_AREA_NAME,'' AS  SUPP_CITY,'' AS  SUPP_STATE,  
       D.DEPT_ID,D.DEPT_NAME,D.AREA_NAME ,D.CITY ,D.STATE,  
       AMOUNT AS XN_AMOUNT, 'Dr' AS XN_TYPE,REMARKS AS NARRATION  ,'' AS REF_NO ,dept_alias
FROM PCI_MST A (NOLOCK) 
LEFT OUTER JOIN TILL_SHIFT_MST B ON A.SHIFT_ID = B.SHIFT_ID 
LEFT OUTER JOIN  TILL_MST  C ON B.TILL_ID= C.TILL_ID
JOIN LOC_VIEW D ON A.location_code/*substring(A.MEMO_NO,3,2)*//*Rohit 04-11-2024*/ = D.DEPT_ID
LEFT JOIN LOC_REQ (NOLOCK) ON loc_req.dept_id=D.DEPT_ID AND loc_req.OPENING_CASH_BALANCE<>0
where a.cancelled=0 AND receipt_dt>ISNULL(LOC_REQ.OPENING_CASH_DATE,'') and receipt_dt<>''
UNION ALL

 SELECT MEMO_NO , MEMO_DT,  
       DATENAME (YYYY,MEMO_DT) AS MEMO_YEAR,DATENAME (M,MEMO_DT) AS MEMO_MONTH,  
       DATEPART(M,MEMO_DT) AS  MEMO_MONTH_NO,  
       ISNULL(D.DEPT_NAME,'') AS AC_NAME,'' AS ADDRESS0 , '' AS ADDRESS1 ,'' AS ADDRESS2 ,  
       '' AS ALIAS,'' AS  SUPP_AREA_NAME,'' AS  SUPP_CITY,'' AS  SUPP_STATE,  
       D.DEPT_ID,D.DEPT_NAME,D.AREA_NAME ,D.CITY ,D.STATE,  
       AMOUNT AS XN_AMOUNT, 'CR' AS XN_TYPE,REMARKS AS NARRATION  ,'' AS REF_NO ,dept_alias
FROM PCO_MST M (NOLOCK)
JOIN LOC_VIEW D ON M.location_code/*SUBSTRING(M.MEMO_NO,1,2)*//*Rohit 04-11-2024*/= D.DEPT_ID
LEFT JOIN LOC_REQ (NOLOCK) ON loc_req.dept_id=D.DEPT_ID AND loc_req.OPENING_CASH_BALANCE<>0
where m.cancelled=0 AND MEMO_DT>ISNULL(LOC_REQ.OPENING_CASH_DATE,'')

UNION ALL

 SELECT CM_NO , CM_DT,  
       DATENAME (YYYY,CM_DT) AS MEMO_YEAR,DATENAME (M,CM_DT) AS MEMO_MONTH,  
       DATEPART(M,CM_DT) AS  MEMO_MONTH_NO,  
       ISNULL(C.TILL_NAME ,l.DEPT_NAME) AS AC_NAME,'' AS ADDRESS0 , '' AS ADDRESS1 ,'' AS ADDRESS2 ,  
       '' AS ALIAS,'' AS  SUPP_AREA_NAME,'' AS  SUPP_CITY,'' AS  SUPP_STATE,  
       l.DEPT_ID,l.DEPT_NAME,l.AREA_NAME ,l.CITY ,l.STATE,  
       CASH_AMOUNT AS XN_AMOUNT, 'CR' AS XN_TYPE,REMARKS AS NARRATION  ,'' AS REF_NO ,dept_alias
FROM CMM01106 A  
JOIN VW_BILL_PAYMODE D ON A.CM_ID = D.MEMO_ID AND D.XN_TYPE = 'SLS'  
LEFT OUTER JOIN TILL_SHIFT_MST B ON A.SHIFT_ID = B.SHIFT_ID 
LEFT OUTER JOIN  TILL_MST  C ON B.TILL_ID= C.TILL_ID
JOIN LOC_VIEW L ON A.location_code/*LEFT(A.cm_id,2)*//*Rohit 04-11-2024*/ = l.DEPT_ID	
join 
(SELECT TOP 1 VALUE as CONSIDERALLCASHXN FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='CONSIDER_ALL_CASH_RECEIPTS'	) con on 1=1
LEFT JOIN LOC_REQ (NOLOCK) ON loc_req.dept_id=L.DEPT_ID AND loc_req.OPENING_CASH_BALANCE<>0
WHERE A.CANCELLED = 0 AND CONSIDERALLCASHXN=1
AND   ISNULL(D.CASH_AMOUNT,0) <> 0 and a.CANCELLED=0 AND CM_DT>ISNULL(LOC_REQ.OPENING_CASH_DATE,'')

union all	  
SELECT adv_rec_no , adv_rec_dt,  
       DATENAME (YYYY,adv_rec_dt) AS MEMO_YEAR,DATENAME (M,adv_rec_dt) AS MEMO_MONTH,  
       DATEPART(M,adv_rec_dt) AS  MEMO_MONTH_NO,  
       ISNULL(C.TILL_NAME ,l.DEPT_NAME) AS AC_NAME,'' AS ADDRESS0 , '' AS ADDRESS1 ,'' AS ADDRESS2 ,  
       '' AS ALIAS,'' AS  SUPP_AREA_NAME,'' AS  SUPP_CITY,'' AS  SUPP_STATE,  
       l.DEPT_ID,l.DEPT_NAME,l.AREA_NAME ,l.CITY ,l.STATE,  
       CASH_AMOUNT AS XN_AMOUNT, 'CR' AS XN_TYPE,REMARKS AS NARRATION  ,'' AS REF_NO ,dept_alias

FROM ARC01106 A  
JOIN VW_BILL_PAYMODE D ON A.ADV_REC_ID = D.MEMO_ID AND D.XN_TYPE = 'ARC'  
LEFT OUTER JOIN TILL_SHIFT_MST B ON A.SHIFT_ID = B.SHIFT_ID 
LEFT OUTER JOIN  TILL_MST  C ON B.TILL_ID= C.TILL_ID
JOIN LOC_VIEW L ON A.location_code/*LEFT(A.adv_rec_id,2)*//*Rohit 04-11-2024*/ = l.DEPT_ID		 
join 
(SELECT TOP 1 VALUE as CONSIDERALLCASHXN FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='CONSIDER_ALL_CASH_RECEIPTS'	) con on 1=1
LEFT JOIN LOC_REQ (NOLOCK) ON loc_req.dept_id=L.DEPT_ID AND loc_req.OPENING_CASH_BALANCE<>0
WHERE A.CANCELLED = 0  AND D.CASH_AMOUNT <> 0  
AND CONSIDERALLCASHXN=1	AND adv_rec_dt>ISNULL(LOC_REQ.OPENING_CASH_DATE,'')

UNION ALL

 SELECT m.DEPT_ID MEMO_NO ,OPENING_CASH_DATE MEMO_DT,  
       DATENAME (YYYY,OPENING_CASH_DATE) AS MEMO_YEAR,DATENAME (M,OPENING_CASH_DATE) AS MEMO_MONTH,  
       DATEPART(M,OPENING_CASH_DATE) AS  MEMO_MONTH_NO,  
       ISNULL(D.DEPT_NAME,'') AS AC_NAME,'' AS ADDRESS0 , '' AS ADDRESS1 ,'' AS ADDRESS2 ,  
       '' AS ALIAS,'' AS  SUPP_AREA_NAME,'' AS  SUPP_CITY,'' AS  SUPP_STATE,  
       D.DEPT_ID,D.DEPT_NAME,D.AREA_NAME ,D.CITY ,D.STATE,  
       OPENING_CASH_BALANCE AS XN_AMOUNT, 'CR' AS XN_TYPE,'OPENING PETTY CASH' AS NARRATION  ,'' AS REF_NO ,dept_alias
FROM LOC_REQ M (NOLOCK)
JOIN LOC_VIEW D ON M.dept_id= D.DEPT_ID
WHERE OPENING_CASH_BALANCE<>0
