CREATE VIEW VW_WORKORDER    
AS    
SELECT T1.MEMO_NO ,T1.MEMO_ID ,T1.MEMO_DT ,T1.REF_NO ,T1.REMARKS ,T2.USERNAME ,T3.ARTICLE_NO AS ARTICLE_SET_NAME  
,[APPROVED]=CASE WHEN T1.MARK_AS_COMPLETED=1 THEN 'APPROVED'   
                 ELSE (CASE WHEN MARK_AS_COMPLETED=2 THEN 'COMPLETED' ELSE 'PENDING' END)  
            END  
,[CANCELLED]=CASE WHEN T1.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END   
,[WO_STATUS]=CASE WHEN T5.REF_WO_ID <>'' THEN 'COMPLETED' ELSE 'IN PROCESS' END  
,ISNULL(T1.TARGET_DT,'01-01-1900') AS TARGET_DT  
,ISNULL(T4.EMP_TITLE,'') +' '+ ISNULL(T4.EMP_FNAME,'') +' '+ ISNULL(T4.EMP_LNAME,'') AS ALLOCATED_TO  
,T1.FIN_YEAR    
,BO.DELIVERY_DT  
,ISNULL(T6.PRODUCT_CODE,'') AS BARCODE  
,[SOLD_STATUS]=CASE WHEN ISNULL(IND.PRODUCT_CODE,'')='' OR ISNULL(INM.INV_NO,'')='' THEN 'NOT SOLD'   
      ELSE 'SOLD'   
      END  
,ISNULL(INM.INV_NO,'') AS INV_NO  
,LM.AC_NAME AS BUYER_NAME  
,Q1.QUANTITY AS TOTAL_QTY
--,(SELECT SUM(A.QUANTITY)/COUNT(DISTINCT A.PARA1_CODE)   
--  FROM PRD_WO_SUB_DET A JOIN PRD_WO_DET B ON A.REF_ROW_ID= B.ROW_ID   
--  WHERE B.MEMO_ID= T1.MEMO_ID  
--  ) AS TOTAL_QTY  
FROM PRD_WO_MST T1 WITH (NOLOCK)   
LEFT JOIN
(
  SELECT A.MEMO_ID, SUM(QUANTITY) AS QUANTITY
  FROM
  (
  SELECT B.MEMO_ID,QUANTITY ,PARA1_CODE 
  FROM PRD_WO_SUB_DET A 
  JOIN PRD_WO_DET B ON A.REF_ROW_ID= B.ROW_ID   
  GROUP BY B.MEMO_ID,QUANTITY ,PARA1_CODE 
  ) A
  GROUP BY A.MEMO_ID
  )Q1 ON T1.MEMO_ID =Q1.MEMO_ID 
JOIN USERS T2 WITH (NOLOCK) ON T1.USER_CODE = T2.USER_CODE    
JOIN ARTICLE T3 WITH (NOLOCK) ON T1.ARTICLE_SET_CODE = T3.ARTICLE_CODE    
LEFT OUTER JOIN EMP_MST T4 WITH (NOLOCK) ON T4.EMP_ID=T1.EMP_CODE    
LEFT OUTER JOIN WSL_ORDER_MST BO WITH (NOLOCK) ON BO.REF_NO=T1.REF_NO       
LEFT OUTER JOIN PRD_STK_TRANSFER_DTM_MST T5 WITH (NOLOCK) ON T5.REF_WO_ID=T1.MEMO_ID     
LEFT OUTER JOIN PRD_STK_TRANSFER_DTM_DET T6 WITH (NOLOCK) ON T5.MEMO_ID=T6.MEMO_ID     
LEFT OUTER JOIN IND01106 IND WITH (NOLOCK) ON T6.PRODUCT_CODE= IND.PRODUCT_CODE    
LEFT OUTER JOIN INM01106 INM WITH (NOLOCK) ON IND.INV_ID= INM.INV_ID AND INM.CANCELLED =0    
LEFT OUTER JOIN LM01106 LM WITH (NOLOCK) ON LM.AC_CODE=BO.AC_CODE
