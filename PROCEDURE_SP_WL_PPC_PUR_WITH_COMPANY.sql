CREATE PROCEDURE SP_WL_PPC_PUR_WITH_COMPANY  
(    
 @CQUERYID  NUMERIC(2),  
 @CWHERE   VARCHAR(100)='',  
 @CFINYEAR  VARCHAR(5)='',  
 @CDEPTID  VARCHAR(7)='',  
 @NNAVMODE  NUMERIC(2)=1 ,
 @CWHERE1   VARCHAR(100)='' 

   
)
----WITH ENCRYPTION
AS  
BEGIN  
DECLARE @CCMD NVARCHAR(MAX)  
 
 IF @CQUERYID=2  
  GOTO LBLMST  
 ELSE   
  GOTO LAST  
  
LBLMST:  
 SELECT A.CHALLAN_NO,CONVERT(VARCHAR,A.CHALLAN_DT,105) AS CHALLAN_DT,D.USERNAME AS 'CREATED_USERNAME', E.USERNAME AS 'MODIFIED_USERNAME',     
    C.AC_NAME AS SUPP_NAME,C.ADDRESS0+' '+ C.ADDRESS1 + ' ' + C.ADDRESS2 + ', ' + C.AREA_NAME +     
    ' ' + C.CITY + ' ' + C.STATE AS 'SUPP_ADDRESS',  A.*,'' AS WSL_INV_ID  ,
    CONVERT(VARCHAR,A.RECEIPT_DT,105) AS RECEIPT_DT1,
    CONVERT(VARCHAR,A.BILL_DT,105) AS BILL_DT1,
    ISNULL(CNT_PO,0) AS CNT_PO
    ,CP.COMPANY_NAME,COMPANY_ADDRESS=CP.ADDRESS1+' '+CP.ADDRESS2, CP.CITY AS COMPANY_CITY,CP.[STATE] COMPANY_STATE,CP.PIN AS COMPANY_PIN,AR.AREA_NAME AS COMPANY_AREA ,
    CP.LOGO_PATH,
    A.CANCELLED,
    A.SUBTOTAL,
    A.DISCOUNT_PERCENTAGE,
    A.DISCOUNT_AMOUNT,
    A.TOTAL_AMOUNT,
    ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0)+ISNULL(A.FREIGHT_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
    ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(A.FREIGHT_CGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0) AS CGST_AMOUNT,
    ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0) AS SGST_AMOUNT,
    ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(A.FREIGHT_IGST_AMOUNT,0)+ISNULL(B.IGST_AMOUNT,0) AS IGST_AMOUNT,  
    ISNULL(A.OTHER_CHARGES,0)+ISNULL(A.FREIGHT,0) AS XN_VALUE_WITH_GST,
    'GST NO: '+ISNULL(CP.GST_NO,'''')  AS GST_NO,
    'GST NO: '+ISNULL(C.AC_GST_NO,'''')  AS AC_GST_NO
 FROM PPC_PIM01106 A  
 LEFT JOIN 
 (
  SELECT MRR_ID, COUNT(PO_ROW_ID) AS CNT_PO
  --14 APR 2018
  ,SUM(ISNULL(CGST_AMOUNT,0))CGST_AMOUNT
  ,SUM(ISNULL(SGST_AMOUNT,0))SGST_AMOUNT 
  ,SUM(ISNULL(IGST_AMOUNT,0))IGST_AMOUNT
  FROM PPC_PID01106 
  --WHERE ISNULL(PO_ROW_ID,'')<>''
  GROUP BY MRR_ID
 )  B ON A.MRR_ID=B.MRR_ID
 JOIN LMV01106 C (NOLOCK) ON A.AC_CODE = C.AC_CODE    
 JOIN USERS D (NOLOCK) ON A.USER_CODE = D.USER_CODE    
 JOIN USERS E (NOLOCK) ON A.EDT_USER_CODE = E.USER_CODE  
 LEFT JOIN COMPANY CP ON CP.COMPANY_CODE='01'
 LEFT JOIN AREA AR ON AR.AREA_CODE=CP.AREA_CODE         
 WHERE A.MRR_ID = @CWHERE    
    
    GOTO LAST  
      
LAST:  
END
