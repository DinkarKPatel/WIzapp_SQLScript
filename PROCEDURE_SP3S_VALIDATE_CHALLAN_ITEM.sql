
create PROCEDURE SP3S_VALIDATE_CHALLAN_ITEM
@CPRODUCTCODE VARCHAR(50),
@CTARGETLOCID VARCHAR(10),
@CDEPT_ID VARCHAR(5)=''
AS
BEGIN
    DECLARE @CCMD NVARCHAR(MAX),@CENABLEALERT VARCHAR(2),@CALERTARTICLENO VARCHAR(2),@CALERTPARA1 VARCHAR(2),@CALERTPARA2 VARCHAR(2),
    @CALERTPARA3 VARCHAR(2),@CALERTPARA4 VARCHAR(2),@CALERTPARA5 VARCHAR(2),@CALERTPARA6 VARCHAR(2),@CERRORMSG VARCHAR(1000),
    @CARTICLENO VARCHAR(500),@CPARA1NAME VARCHAR(500),@CPARA2NAME VARCHAR(500),@CPARA3NAME VARCHAR(500),@CPARA4NAME VARCHAR(500),
    @CPARA5NAME VARCHAR(500),@CPARA6NAME VARCHAR(500),@CWHERECLAUSE VARCHAR(MAX),@CERRDETAILS VARCHAR(MAX),
    @CINVNO VARCHAR(20),@DINVDT DATETIME,@cPmtTableName VARCHAR(200),
    @CPSNO VARCHAR(20),@DPSDT DATETIME,@cCurLocId VARCHAR(5),@cHoLocId VARCHAR(5),
    @CPARA1CAPTION VARCHAR(200),@CPARA2CAPTION VARCHAR(200),@CPARA3CAPTION VARCHAR(200),@CPARA4CAPTION VARCHAR(200),
    @CPARA5CAPTION VARCHAR(200),@CPARA6CAPTION VARCHAR(200),@nStockQty NUMERIC(10,2)

	 IF @CDEPT_ID=''
     SELECT @cCurLocId=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
	 ELSE
	 SET @cCurLocId=@CDEPT_ID

  
	SELECT @cHoLocId=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'


	SET @CERRORMSG='' 
	SELECT TOP 1 @CENABLEALERT=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_ALERT_MSG'
	
	SET @CENABLEALERT=ISNULL(@CENABLEALERT,'')
		
	IF (@CENABLEALERT<>'1')
	BEGIN
		SELECT '' AS ALERTMSG
		RETURN
	END	
	
	SELECT TOP 1  @CALERTARTICLENO=VALUE FROM CONFIG WHERE CONFIG_OPTION='ALERT_ARTICLE_NO'
	SELECT TOP 1  @CALERTPARA1=VALUE FROM CONFIG WHERE CONFIG_OPTION='ALERT_PARA1'
	SELECT TOP 1  @CALERTPARA2=VALUE FROM CONFIG WHERE CONFIG_OPTION='ALERT_PARA2'
	SELECT TOP 1  @CALERTPARA3=VALUE FROM CONFIG WHERE CONFIG_OPTION='ALERT_PARA3'
	SELECT TOP 1  @CALERTPARA4=VALUE FROM CONFIG WHERE CONFIG_OPTION='ALERT_PARA4'
	SELECT TOP 1  @CALERTPARA5=VALUE FROM CONFIG WHERE CONFIG_OPTION='ALERT_PARA5'
	SELECT TOP 1  @CALERTPARA6=VALUE FROM CONFIG WHERE CONFIG_OPTION='ALERT_PARA6'
	
	SELECT @CALERTARTICLENO=ISNULL(@CALERTARTICLENO,''),@CALERTPARA1=ISNULL(@CALERTPARA1,''),@CALERTPARA2=ISNULL(@CALERTPARA2,''),
	@CALERTPARA3=ISNULL(@CALERTPARA3,''),@CALERTPARA4=ISNULL(@CALERTPARA4,''),@CALERTPARA5=ISNULL(@CALERTPARA5,''),
	@CALERTPARA6=ISNULL(@CALERTPARA6,'')
	
	SELECT TOP 1 @CARTICLENO=ARTICLE_NO,@CPARA1NAME=PARA1_NAME,@CPARA2NAME=PARA2_NAME,@CPARA3NAME=PARA3_NAME,
				 @CPARA4NAME=PARA4_NAME,@CPARA5NAME=PARA5_NAME,@CPARA6NAME=PARA6_NAME
	FROM SKU (nolock)
    JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE
	JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
	JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
	JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
	JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
	JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
	JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
	WHERE SKU.PRODUCT_CODE=@CPRODUCTCODE			 
	
	SET @CWHERECLAUSE=(CASE WHEN @CALERTARTICLENO='1' THEN ' AND ARTICLE_NO='''+@CARTICLENO+'''' ELSE '' END)
	
	SET @CWHERECLAUSE=@CWHERECLAUSE+(CASE WHEN @CALERTPARA1='1' THEN (CASE WHEN @CWHERECLAUSE<>'' THEN ' AND ' ELSE '' END)+'PARA1_NAME='''+@CPARA1NAME+'''' ELSE '' END)			
	
	SET @CWHERECLAUSE=@CWHERECLAUSE+(CASE WHEN @CALERTPARA2='1' THEN (CASE WHEN @CWHERECLAUSE<>'' THEN ' AND ' ELSE '' END)+'PARA2_NAME='''+@CPARA2NAME+'''' ELSE '' END)				
	
	SET @CWHERECLAUSE=@CWHERECLAUSE+(CASE WHEN @CALERTPARA3='1' THEN (CASE WHEN @CWHERECLAUSE<>'' THEN ' AND ' ELSE '' END)+'PARA3_NAME='''+@CPARA3NAME+'''' ELSE '' END)				
	
	SET @CWHERECLAUSE=@CWHERECLAUSE+(CASE WHEN @CALERTPARA4='1' THEN (CASE WHEN @CWHERECLAUSE<>'' THEN ' AND ' ELSE '' END)+'PARA4_NAME='''+@CPARA4NAME+'''' ELSE '' END)				
	
	SET @CWHERECLAUSE=@CWHERECLAUSE+(CASE WHEN @CALERTPARA5='1' THEN (CASE WHEN @CWHERECLAUSE<>'' THEN ' AND ' ELSE '' END)+'PARA5_NAME='''+@CPARA5NAME+'''' ELSE '' END)				
	
	SET @CWHERECLAUSE=@CWHERECLAUSE+(CASE WHEN @CALERTPARA6='1' THEN (CASE WHEN @CWHERECLAUSE<>'' THEN ' AND ' ELSE '' END)+'PARA6_NAME='''+@CPARA6NAME+'''' ELSE '' END)			
	
	SET @CCMD=N'SELECT TOP 1 @CINVNO=A.INV_NO,@DINVDT=A.INV_DT FROM INM01106 A (nolock)
				JOIN IND01106 B (nolock) ON A.INV_ID=B.INV_ID
				JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE
				JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE
				JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
				JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
				JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
				JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
				JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
				JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
				WHERE A.PARTY_DEPT_ID='''+@CTARGETLOCID+'''  '+@CWHERECLAUSE+'
				AND CANCELLED=0 ORDER BY A.INV_DT DESC'
	PRINT @CCMD				
	EXEC SP_EXECUTESQL @CCMD,N'@CINVNO VARCHAR(20) OUTPUT,@DINVDT DATETIME OUTPUT',@CINVNO OUTPUT,@DINVDT OUTPUT
	
	SET @CCMD=N'SELECT TOP 1 @CPSNO=A.PS_NO,@DPSDT=A.PS_DT FROM WPS_MST A (nolock)
				JOIN WPS_DET B (nolock) ON A.PS_ID=B.PS_ID
				JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE
				JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE
				JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE
				JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE
				JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE
				JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE = PARA4.PARA4_CODE
				JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE = PARA5.PARA5_CODE
				JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE = PARA6.PARA6_CODE
				WHERE A.PARTY_DEPT_ID='''+@CTARGETLOCID+'''  '+@CWHERECLAUSE+'
				AND CANCELLED=0 ORDER BY A.PS_DT DESC'
	PRINT @CCMD				
	EXEC SP_EXECUTESQL @CCMD,N'@CPSNO VARCHAR(20) OUTPUT,@DPSDT DATETIME OUTPUT',@CPSNO OUTPUT,@DPSDT OUTPUT
	
	IF (ISNULL(@CINVNO,'') <> '' OR ISNULL(@CPSNO,'')<>'' ) 
	BEGIN
		SELECT TOP 1 @CPARA1CAPTION=VALUE FROM CONFIG WHERE CONFIG_OPTION='PARA1_caption' 
		SELECT TOP 1 @CPARA2CAPTION=VALUE FROM CONFIG WHERE CONFIG_OPTION='PARA2_caption' 
		SELECT TOP 1 @CPARA3CAPTION=VALUE FROM CONFIG WHERE CONFIG_OPTION='PARA3_caption'
		SELECT TOP 1 @CPARA4CAPTION=VALUE FROM CONFIG WHERE CONFIG_OPTION='PARA4_caption' 
		SELECT TOP 1 @CPARA5CAPTION=VALUE FROM CONFIG WHERE CONFIG_OPTION='PARA5_caption' 
		SELECT TOP 1 @CPARA6CAPTION=VALUE FROM CONFIG WHERE CONFIG_OPTION='PARA6_caption' 

		SET @CERRDETAILS=(CASE WHEN @CALERTARTICLENO='1' THEN 'ARTICLE_NO='''+@CARTICLENO+'''' ELSE '' END)
		
		SET @CERRDETAILS=@CERRDETAILS+(CASE WHEN @CALERTPARA1='1' THEN (CASE WHEN @CERRDETAILS<>'' THEN ' AND ' ELSE '' END)+@CPARA1CAPTION+'='''+@CPARA1NAME+'''' ELSE '' END)			
		
		SET @CERRDETAILS=@CERRDETAILS+(CASE WHEN @CALERTPARA2='1' THEN (CASE WHEN @CERRDETAILS<>'' THEN ' AND ' ELSE '' END)+@CPARA2CAPTION+'='''+@CPARA2NAME+'''' ELSE '' END)				
		
		SET @CERRDETAILS=@CERRDETAILS+(CASE WHEN @CALERTPARA3='1' THEN (CASE WHEN @CERRDETAILS<>'' THEN ' AND ' ELSE '' END)+@CPARA3CAPTION+'='''+@CPARA3NAME+'''' ELSE '' END)
		
		SET @CERRDETAILS=@CERRDETAILS+(CASE WHEN @CALERTPARA4='1' THEN (CASE WHEN @CERRDETAILS<>'' THEN ' AND ' ELSE '' END)+@CPARA4CAPTION+'='''+@CPARA4NAME+'''' ELSE '' END)
		
		SET @CERRDETAILS=@CERRDETAILS+(CASE WHEN @CALERTPARA5='1' THEN (CASE WHEN @CERRDETAILS<>'' THEN ' AND ' ELSE '' END)+@CPARA5CAPTION+'='''+@CPARA5NAME+'''' ELSE '' END)
		
		SET @CERRDETAILS=@CERRDETAILS+(CASE WHEN @CALERTPARA6='1' THEN (CASE WHEN @CERRDETAILS<>'' THEN ' AND ' ELSE '' END)+@CPARA6CAPTION+'='''+@CPARA6NAME+'''' ELSE '' END)

		IF @cCurLocId=@cHoLocId
		BEGIN
			SET @cPmtTableName=DB_NAME()+'_PMT.DBO.PMTLOCS_'+CONVERT(VARCHAR,GETDATE(),112)
			IF object_id(@cPmtTableName,'U') IS NOT NULL
			BEGIN
				SET @cCmd=N'SELECT @nStockQty=cbs_qty FROM '+@cPmtTableName+' WHERE product_code='''+@CPRODUCTCODE+''' AND dept_id='''+@CTARGETLOCID+''''
				EXEC SP_EXECUTESQL @cCmd,N'@nStockQty NUMERIC(10,2) OUTPUT',@nStockQty OUTPUT

				IF @nStockQty IS NOT NULL
					SET @CERRDETAILS=@CERRDETAILS+' Current Stock:'+ltrim(rtrim(str(@nStockQty,10,2)))
			END	
		END		

		SET @CERRORMSG='THE ITEM HAVING FOLLOWING DETAILS HAS ALREADY BEEN DISPATCHED AGAINST CHALLAN NO.:'+@CINVNO+
		' DATED :'+CONVERT(VARCHAR,@DINVDT,105)+CHAR(13)+CHAR(10)+@CERRDETAILS
	END	


	SELECT ISNULL(@CERRORMSG,'') AS ALERTMSG				
END

