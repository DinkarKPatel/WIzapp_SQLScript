--**** START OF PROCEDURE UPDATEMASTERXN
CREATE PROCEDURE UPDATEMASTERXN 
			@CSOURCEDB VARCHAR(1000),
			@CSOURCETABLE VARCHAR(1000),
			@CDESTDB VARCHAR(100),
			@CDESTTABLE VARCHAR(100),
			@CKEYFIELD1 VARCHAR(40)='',
			@CKEYFIELD2 VARCHAR(40)='',
			@CKEYFIELD3 VARCHAR(40)='',
			@LINSERTONLY BIT = 0,
			@CFILTERCONDITION VARCHAR(500)='',
			@LUPDATEXNS BIT=0,
			@CXNTYPE VARCHAR(20)='',
			@LUPDATEONLY BIT = 0,
			@CUSERID VARCHAR(30)='',
			@BALWAYSUPDATE BIT=0,
			@cJoinStr VARCHAR(1000)='',
			@cReplaceInsCol VARCHAR(100)='',
			@cReplaceInsColName VARCHAR(100)='',
			@cKeyFieldJoin VARCHAR(1000)=''
--WITH ENCRYPTION			
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @CWC VARCHAR(1000),
			@CINSERTSTR NVARCHAR(MAX),
			@CINSERTSTRVALUE NVARCHAR(MAX),
			@CWHERECLAUSE NVARCHAR(MAX),
			@CCMD NVARCHAR(MAX),@CCURLOCID VARCHAR(5)/*Rohit 06-11-2024*/,
			@LDONOTREPLNULLS BIT,@CUSERIDPREFIX VARCHAR(30),
			@CSOURCETABLESTR VARCHAR(100),@CDESTTABLESTR VARCHAR(100)
	
	IF @CUSERID<>''
	BEGIN
		SET @CUSERID=STUFF(@CUSERID,CHARINDEX('[',@CUSERID),1,'')
		SET @CUSERID=STUFF(@CUSERID,CHARINDEX(']',@CUSERID),1,'')
	END
		
	SET @CUSERIDPREFIX=(CASE WHEN @CUSERID<>'' THEN @CUSERID+'.' ELSE '' END)
	SELECT @CCURLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	
	SET @CDESTTABLESTR=(CASE WHEN LEFT(@CDESTTABLE,1)<>'[' THEN '[' ELSE '' END)+
				  @CDESTTABLE+(CASE WHEN RIGHT(@CDESTTABLE,1)<>']' THEN ']' ELSE '' END)

	SET @CSOURCETABLESTR=(CASE WHEN LEFT(@CSOURCETABLE,1)<>'[' THEN '[' ELSE '' END)+
				  @CSOURCETABLE+(CASE WHEN RIGHT(@CSOURCETABLE,1)<>']' THEN ']' ELSE '' END)

	SET @CWC = ''
	if @cKeyFieldJoin<>''
	begin
		set @CWC=@cKeyFieldJoin
	end		
	else		
	begin
		IF @CKEYFIELD1 <> ''
			SET @CWC = 'A.' + @CKEYFIELD1 + ' = B.' + @CKEYFIELD1
		IF @CKEYFIELD2 <> ''
			SET @CWC = @CWC + ( CASE WHEN @CWC<>'' THEN ' AND ' ELSE '' END ) + 'A.' + @CKEYFIELD2 + ' = B.' + @CKEYFIELD2
		IF @CKEYFIELD3 <> ''
			SET @CWC = @CWC + ( CASE WHEN @CWC<>'' THEN ' AND ' ELSE '' END ) + 'A.' + @CKEYFIELD3 + ' = B.' + @CKEYFIELD3
		SET @CWC = ' ON ' + @CWC 		
	end	



	IF OBJECT_ID('TEMPDB..#TTARGETCOL','U') IS NOT NULL
		DROP TABLE #TTARGETCOL
	
	CREATE TABLE #TTARGETCOL (COLNAME VARCHAR(100),COLTYPE VARCHAR(20),SOURCECOLNAME VARCHAR(100),ISNULLABLE BIT)
	
	
	SET @CCMD = 'SELECT A.NAME AS COLNAME, B.NAME AS COLTYPE,'''',C.ISNULLABLE 
				 FROM ' + @CSOURCEDB + 'SYSCOLUMNS A 
				 JOIN ' + @CSOURCEDB + 'SYSTYPES B ON A.XTYPE = B.XTYPE  AND B.NAME<>''SYSNAME''
				 JOIN ' + @CDESTDB + 'SYSCOLUMNS C ON A.NAME = C.NAME
				 JOIN ' + @CDESTDB + 'SYSOBJECTS D ON D.ID = C.ID 
				 LEFT OUTER JOIN SYS.IDENTITY_COLUMNS E ON E.OBJECT_ID=D.ID AND E.NAME=C.NAME				 
				 WHERE A.ID = ( SELECT ID FROM ' + @CSOURCEDB + 'SYSOBJECTS 
								WHERE NAME = ''' + @CSOURCETABLE + '''
								AND XTYPE = ''U'') 
				 AND   D.NAME = ''' + @CDESTTABLE + ''' 
				 AND   A.NAME <> ''TS'' AND E.OBJECT_ID IS NULL'
	INSERT #TTARGETCOL
	EXEC SP_EXECUTESQL @CCMD		

--	PRINT '3'
	IF @LINSERTONLY = 0 AND @LUPDATEXNS=0
	BEGIN

		EXEC SP_UPDATECOLUMNLIST @CSOURCETABLE, @CKEYFIELD1, @CKEYFIELD2, @CKEYFIELD3, 1,@CUSERID,@CINSERTSTR OUTPUT 

		SET @CWHERECLAUSE=(CASE WHEN @BALWAYSUPDATE<>1 THEN ' WHERE A.LAST_UPDATE<>B.LAST_UPDATE ' ELSE '' END)

		SET @CCMD = N'UPDATE A SET ' + @CINSERTSTR +
					 ' FROM ' + @CSOURCEDB + @CSOURCETABLESTR + ' B' + 
					 ' JOIN ' + @CDESTDB + @CDESTTABLESTR + ' A ' + @CWC + @CWHERECLAUSE + 
					 (CASE WHEN @CFILTERCONDITION<>'' THEN (CASE WHEN @CWHERECLAUSE='' THEN ' WHERE ' ELSE ' AND ' END)
					  ELSE '' END)+@CFILTERCONDITION
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
	END
	
	IF @LUPDATEONLY = 1
		RETURN

	---- BUILDING INSERT COMMAND
	---- PRINT 'INSERTING RECORDS INTO ' + @CDESTDB + @CDESTTABLE
	--SET @CWC = ''
	--IF @CKEYFIELD2 <> ''
	--	SET @CWC = @CKEYFIELD2 + ' = B.' + @CKEYFIELD2
	--IF @CKEYFIELD3 <> ''
	--	SET @CWC = @CWC + ( CASE WHEN @CWC<>'' THEN ' AND ' ELSE '' END ) + @CKEYFIELD3 + ' = B.' + @CKEYFIELD3
	--IF @CWC <> ''
	--	SET @CWC = ' WHERE ' + @CWC 
	

	DELETE FROM #TTARGETCOL

    SET @CCMD='SELECT A.NAME AS COLNAME, B.NAME AS COLTYPE,E.NAME AS SOURCECOLNAME,A.ISNULLABLE
			   FROM '+ @CDESTDB + 'SYSCOLUMNS A 
			   JOIN '+ @CDESTDB + 'SYSTYPES B ON A.XTYPE = B.XTYPE AND B.NAME<>''SYSNAME''
			 JOIN '+ @CDESTDB + 'SYSOBJECTS C ON C.ID = A.ID 
			   JOIN '+ @CSOURCEDB+'SYSOBJECTS D ON D.NAME = '''+@CSOURCETABLE+'''
			   LEFT OUTER JOIN '+@CSOURCEDB+'SYSCOLUMNS E ON E.ID = D.ID AND E.NAME=A.NAME
				LEFT OUTER JOIN SYS.IDENTITY_COLUMNS F ON F.OBJECT_ID=A.ID AND F.NAME=A.NAME			   
			   WHERE A.ID = ( SELECT ID FROM '+@CDESTDB+'SYSOBJECTS 
							WHERE NAME = '''+@CDESTTABLE+'''
							AND XTYPE = ''U'') 
			 AND   C.NAME = '''+@CDESTTABLE+''' 
			 AND   A.NAME <> ''TS'' AND F.OBJECT_ID IS NULL'
	
	INSERT #TTARGETCOL
	EXEC SP_EXECUTESQL @CCMD		
	
	SET @LDONOTREPLNULLS=(CASE WHEN @CKEYFIELD1='' THEN 1 ELSE 0 END)
	
	-- PRINT 'GENERATE INSERT STATEMENT'	
	EXEC SP_INSERTCOLUMNLIST @CSOURCETABLE,@LDONOTREPLNULLS,@CUSERID, @CINSERTSTR OUTPUT, @CINSERTSTRVALUE OUTPUT, 'B'
	
	--SET @CCMD = N' INSERT ' + @CDESTDB + @CDESTTABLE + ' ( ' + @CINSERTSTR + ' ) ' +
	--			 ' SELECT ' + @CINSERTSTRVALUE + 
	--			 ' FROM ' + @CSOURCEDB + @CSOURCETABLE + ' B ' + 
	--			  + ( CASE WHEN @LUPDATEXNS=0 AND @CKEYFIELD1<>'' THEN 
	--				' WHERE ' + @CKEYFIELD1 + ' NOT IN ( 
	--					SELECT DISTINCT ' + @CKEYFIELD1 + ' FROM ' + @CDESTDB + @CDESTTABLE + @CWC + ' ) ' + 
	--			        @CFILTERCONDITION 
	--						   ELSE 
	--						  (	CASE WHEN @CFILTERCONDITION<>'' THEN ' WHERE '+@CFILTERCONDITION ELSE '' END ) END )

	IF ISNULL(@cReplaceInsCol,'')<>''
	BEGIN
		DECLARE @cOldReplCol VARCHAR(100),@cNewReplCol VARCHAR(100)
		
		SET @CINSERTSTRVALUE=REPLACE(@CINSERTSTRVALUE,'b.'+@cReplaceInsColName,@cReplaceInsCol)
	END
		
	SET @CCMD = N' INSERT ' + @CDESTDB + @CDESTTABLESTR+
				  ' ( ' + @CINSERTSTR + ' ) ' +
				 ' SELECT ' + @CINSERTSTRVALUE + 
				 ' FROM ' + @CSOURCEDB + @CSOURCETABLESTR+ ' B ' + 
				 @CJOINSTR+
				 ( CASE WHEN @LUPDATEXNS=0 AND @CKEYFIELD1<>'' THEN 
					' LEFT OUTER JOIN ' + @CDESTDB + @CDESTTABLESTR + ' A ' + @CWC +
					' WHERE A.' + @CKEYFIELD1 + ' IS NULL ' 
				   ELSE '' END )

	IF (@CFILTERCONDITION<>'')
	BEGIN
		SET @CCMD = @CCMD + 
					( CASE WHEN @LUPDATEXNS=0 AND @CKEYFIELD1<>'' THEN ' AND ' ELSE ' WHERE ' END ) + 
					@CFILTERCONDITION
	END

	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
END
--*************************************** END OF PROCEDURE UPDATEMASTERXN