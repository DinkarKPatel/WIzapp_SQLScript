CREATE PROCEDURE SP_GETREFBILLBYBILLNO (@CXNTYPE VARCHAR(10),@CACCODE CHAR(10),@CREFBILLNO VARCHAR(50),
@NPOSTEDAMT NUMERIC(10,2),@NCURRENTAMT NUMERIC(10,2),@CRETREFBILLNO VARCHAR(50) OUTPUT)
--WITH ENCRYPTION

AS
BEGIN
	
	DECLARE @NAMOUNT NUMERIC(14,2), 
			@NPOSADJ NUMERIC(14,2), 
			@NNEGADJ NUMERIC(14,2), 
			@CXTYPE  VARCHAR(10), 
			@LRETVAL BIT,
			@CVDNID VARCHAR(50),@CBILLTYPE VARCHAR(10),@NCTR INT,@CREFBILLNOPARA VARCHAR(50)
	
	SET @CBILLTYPE=(CASE WHEN @CXNTYPE='PRT' THEN 'PUR' ELSE 'WSL' END)
	
	SET @NCTR=1
	
	SET @CREFBILLNOPARA=@CREFBILLNO
	
	DECLARE @TBILLSREF TABLE (VDN_ID VARCHAR(50))
LBLNEXT:	
	
	SELECT @CRETREFBILLNO='',@NPOSADJ=0,@NNEGADJ=0
	
	SELECT TOP 1 @CVDNID=A.VDN_ID,@CRETREFBILLNO=A.REF_NO FROM VDN01106 A 
	JOIN VD01106 B ON A.VD_ID=B.VD_ID
	JOIN VM01106 C ON C.VM_ID=B.VM_ID
	LEFT OUTER JOIN @TBILLSREF D ON D.VDN_ID=A.VDN_ID
	LEFT OUTER JOIN 
	(SELECT	VDN_ID, SUM( CASE WHEN A.X_TYPE = @CXTYPE THEN A.AMOUNT ELSE -A.AMOUNT END) AS ADJ_AMT
	FROM VDA01106 A
	JOIN VD01106 B ON A.VD_ID = B.VD_ID
	JOIN VM01106 C ON B.VM_ID = C.VM_ID
	WHERE B.AC_CODE=@CACCODE AND C.CANCELLED = 0 GROUP BY VDN_ID) E ON E.VDN_ID=A.VDN_ID
	WHERE ((@NCTR=1 AND A.REF_NO=@CREFBILLNOPARA) OR (@NCTR>1 AND D.VDN_ID IS NULL))  
	AND B.AC_CODE=@CACCODE AND C.BILL_TYPE=@CBILLTYPE AND C.CANCELLED=0 
	AND A.INV_AMT+ISNULL(E.ADJ_AMT,0)-@NPOSTEDAMT-@NCURRENTAMT>0
	
	
	SET @CREFBILLNOPARA=@CRETREFBILLNO
	
	IF  @NCTR>=2 OR @CRETREFBILLNO<>''
		GOTO END_FUNC
	
	SET @NCTR=@NCTR+1
	GOTO LBLNEXT
	

END_FUNC:
	
	--RETURN @CRETREFBILLNO
END
