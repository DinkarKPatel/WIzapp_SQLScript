CREATE PROCEDURE SP_WL_PICKLASTDISCOUNT--(LocId 3 digit change by Sanjay:30-10-2024)
(
	@CPRODUCTCODE		VARCHAR(200)='',
	@CLOCID VARCHAR(5)='',
	@BPICKFROMANYWHERE  BIT = 0,
	@BCALLEDFROMPACKSLIP BIT=0
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CCMID VARCHAR(50),@CCMDROWID VARCHAR(50),@NTAXMETHOD INT
	
	IF ISNULL(@CLOCID,'')=''
		SELECT TOP 1 @CLOCID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 


	
	PRINT 'CHECK SLR FOR LOCATION ID:'+@CLOCID+'-'+@CPRODUCTCODE
		
	SELECT TOP 1 @CCMID=CMD.CM_ID,@CCMDROWID=CMD.ROW_ID,@NTAXMETHOD=CMD.TAX_METHOD
	FROM CMD01106 CMD 
	JOIN CMM01106 CMM ON CMD.CM_ID=CMM.CM_ID
	WHERE CMM.CANCELLED=0 AND CMD.QUANTITY>0 AND CMD.PRODUCT_CODE=@CPRODUCTCODE
	AND (cmm.location_code=@CLOCID OR @BPICKFROMANYWHERE=1)
	ORDER BY CM_DT DESC ,CM_TIME DESC
	
	PRINT 'CHECK SLR FOR CMID:'+@CCMID
	IF @BCALLEDFROMPACKSLIP=1
		SELECT TOP 1 CMD.DISCOUNT_PERCENTAGE,@NTAXMETHOD AS TAX_METHOD
		FROM CMD01106 CMD 
		JOIN
		
		(SELECT SUM(RFNET) AS SUBTOTAL,B.DISCOUNT_PERCENTAGE FROM CMD01106 A 
		 JOIN CMM01106 B ON A.CM_ID=B.CM_ID WHERE A.CM_ID=@CCMID AND QUANTITY>0
		 GROUP BY B.DISCOUNT_PERCENTAGE) CMM ON 1=1
		WHERE CMD.ROW_ID=@CCMDROWID
	ELSE	
		SELECT TOP 1 CONVERT(NUMERIC(14,2),
		(CASE WHEN OLD_MRP<>MRP AND ISNULL(OLD_MRP,0)<>0 
			  THEN (100-(((CMD.OLD_MRP-(CMD.OLD_MRP*ISNULL(CMD.BASIC_DISCOUNT_PERCENTAGE,0)/100))-((CMD.OLD_MRP-(CMD.OLD_MRP*
					ISNULL(CMD.BASIC_DISCOUNT_PERCENTAGE,0)/100))*CMM.DISCOUNT_PERCENTAGE/100))/CMD.OLD_MRP)*100) 
			  WHEN WEIGHTED_AVG_DISC_PCT<>0 
			  THEN ((WEIGHTED_AVG_DISC_AMT+ISNULL(CMM_DISCOUNT_AMOUNT,0))/(MRP*QUANTITY))*100
			  ELSE (100-(((CMD.MRP-(CMD.MRP*ISNULL(CMD.BASIC_DISCOUNT_PERCENTAGE,0)/100))-((CMD.MRP-(CMD.MRP*
			  ISNULL(CMD.BASIC_DISCOUNT_PERCENTAGE,0)/100))*CMM.DISCOUNT_PERCENTAGE/100))/CMD.MRP)*100) END)) 
		AS DISCOUNT_PERCENTAGE,@NTAXMETHOD AS TAX_METHOD
		FROM CMD01106 CMD 
		JOIN
		
		(SELECT SUM(RFNET) AS SUBTOTAL,B.DISCOUNT_PERCENTAGE FROM CMD01106 A 
		 JOIN CMM01106 B ON A.CM_ID=B.CM_ID WHERE A.CM_ID=@CCMID AND QUANTITY>0
		 GROUP BY B.DISCOUNT_PERCENTAGE) CMM ON 1=1
		WHERE CMD.ROW_ID=@CCMDROWID
END
