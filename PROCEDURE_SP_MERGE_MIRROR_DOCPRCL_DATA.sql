CREATE PROCEDURE SP_MERGE_MIRROR_DOCPRCL_DATA          
(          
  @CMEMOID VARCHAR(50),          
  @CERRMSG VARCHAR(MAX) OUTPUT          
)          
AS          
BEGIN   
  SET NOCOUNT ON          
  DECLARE @DTSQL NVARCHAR(MAX),@CSOURCEDB VARCHAR(200),@CTMP_TABLENAME VARCHAR(200)         
   ,@CJOINSTR VARCHAR(MAX),@CERRORMSG VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100)          
   ,@CTABLENAME VARCHAR(200),@CERRMSGOUT VARCHAR(MAX),@CSTEP VARCHAR(20),@CKEYFIELD VARCHAR(100)          
   ,@CKEYFIELD1 VARCHAR(100),@CMERGEDB VARCHAR(50),@CTABLE_SUFFIX VARCHAR(50)          
   ,@INV_MODE INT,@CFINYEAR VARCHAR(10),@MRR_NO VARCHAR(50),@MRR_ID VARCHAR(50),@INV_ID VARCHAR(50)        
   ,@TEMP_TABLE1 VARCHAR(20),@CCMD NVARCHAR(MAX),@CCURDEPTID CHAR(2),@CHODEPTID CHAR(2)  
   ,@BSOURCEPURLOC BIT,@BTARGETPURLOC BIT,@BGENERATEAUTOSERIES BIT,@CSOURCELOCID CHAR(2), @BHOLOC BIT,@BSKU_OH BIT  
   ,@NTARGETLOCTYPE INT,@BMSTINSERTONLY BIT,@CMEMONOPREFIX VARCHAR(100),@CPARTYDEPTID VARCHAR(5)  
   ,@BCHALLANRECEIVEDPREV BIT,@CCMDOUTPUT VARCHAR(MAX),@BNEGSTOCKFOUND BIT  
     
   
 BEGIN TRY          
    
  SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'  
  SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'  
    
  SELECT TOP 1 @CSOURCELOCID=DEPT_ID,@BSOURCEPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=LEFT(@CMEMOID,2)   
      
  SET @BHOLOC=0  
  IF @CCURDEPTID=@CHODEPTID  
   SET @BHOLOC=1  
    
  SET @CSTEP = 10          
  SET @CMERGEDB=DB_NAME()+'.DBO.'        
  SET @CERRORMSG=''          
  SET @CTABLESUFFIX=REPLACE(@CMEMOID,'-','_')          
    
    
  IF @BHOLOC=1  
 SET @BMSTINSERTONLY = 1  
  ELSE  
 SET @BMSTINSERTONLY = 0  
  IF @BHOLOC=0  
 BEGIN TRANSACTION          
   
/*INM,IND,PAYMODE_XN_DET,PAYMODE_MST,PAYMODE_GRP_MST*/          
    SET @CSTEP = 20          
    SET @CSOURCEDB=DB_NAME()+'_TEMP..'          
    --SET @CSOURCEDB=DB_NAME()     
      
    SET @CTABLE_SUFFIX=REPLACE(@CMEMOID,'-','_')          
                                              
    SET @CSTEP=30  
 SET @CTABLENAME='PARCEL_MST'  
 SET @CTMP_TABLENAME='TMP_DOCPRCL_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
 SET @CKEYFIELD='PARCEL_MEMO_ID'  
   
 EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB          
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''          
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0,@BALWAYSUPDATE=1           
           
    SET @CSTEP=40  
 SET @CTABLENAME='PARCEL_DET'  
 SET @CTMP_TABLENAME='TMP_DOCPRCL_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
 SET @CKEYFIELD='PARCEL_MEMO_ID'  
   
 EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB          
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='ROW_ID',@CKEYFIELD3=''          
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
      
      
    SET @CSTEP=50  
 SET @CTABLENAME='PARCEL_BILLS'  
 SET @CTMP_TABLENAME='TMP_DOCPRCL_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
 SET @CKEYFIELD='PARCEL_MEMO_ID'  
   
 EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB          
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='ROW_ID',@CKEYFIELD3=''          
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
                
                                 
 END TRY          
 BEGIN CATCH  
  PRINT 'CATCH START'         
  SET @CERRMSG='P:SP_MERGE_MIRROR_DOCPRCL_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()          
  GOTO EXIT_PROC  
 END CATCH          
          
EXIT_PROC:          
   
 PRINT 'LAST STEP:'+@CSTEP  
   
 IF @@TRANCOUNT>0 AND @BHOLOC=0  
 BEGIN  
  IF ISNULL(@CERRORMSG,'')='' AND ISNULL(@CCMDOUTPUT,'')=''  
  BEGIN  
   COMMIT TRANSACTION  
  END   
  ELSE  
   ROLLBACK  
 END  
   
 IF ISNULL(@CERRORMSG,'')='' AND ISNULL(@CCMDOUTPUT,'')=''   
 BEGIN  
    
   SET @CSOURCEDB=DB_NAME()+'_TEMP..'   
   SET @CTABLESUFFIX = LTRIM(RTRIM(@CTABLESUFFIX))   
   SET @DTSQL = N'IF OBJECT_ID('''+@CSOURCEDB+'TMP_DOCPRCL_PARCEL_MST_'+@CTABLESUFFIX+''',''U'') IS NOT NULL  
       DROP TABLE '+@CSOURCEDB+'TMP_DOCPRCL_PARCEL_MST_'+@CTABLESUFFIX+'  
      IF OBJECT_ID('''+@CSOURCEDB+'TMP_DOCPRCL_PARCEL_DET_'+@CTABLESUFFIX+''',''U'') IS NOT NULL  
       DROP TABLE '+@CSOURCEDB+'TMP_DOCPRCL_PARCEL_DET_'+@CTABLESUFFIX+'  
      IF OBJECT_ID('''+@CSOURCEDB+'TMP_DOCPRCL_PARCEL_BILLS_'+@CTABLESUFFIX+''',''U'') IS NOT NULL  
       DROP TABLE '+@CSOURCEDB+'TMP_DOCPRCL_PARCEL_BILLS_'+@CTABLESUFFIX+''  
     
   PRINT @DTSQL   
   EXEC SP_EXECUTESQL @DTSQL   
  END  
    
END 
---END OF PROCEDURE - SP_MERGE_MIRROR_DOCPRCL_DATA
