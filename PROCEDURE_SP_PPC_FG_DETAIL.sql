CREATE PROCEDURE SP_PPC_FG_DETAIL
(
@CORDER_NO CHAR(50)='',
@CBUYER_CODE CHAR(10)='',
@CFIN_YEAR VARCHAR(5)
)
AS
BEGIN
 
 
        DECLARE @CFILTER NVARCHAR(MAX),@CFILTER1 NVARCHAR(MAX),@CCMD NVARCHAR(MAX)
        

        SET @CFILTER=''
        IF ISNULL(@CORDER_NO,'')='' 
        SET @CFILTER='1=1'
        ELSE 
        SET @CFILTER='BILL_NO='''+@CORDER_NO+''''
        
        SET @CFILTER1=''
        IF ISNULL(@CBUYER_CODE,'')='' 
        SET @CFILTER1=' 1=1'
        ELSE 
        SET @CFILTER1=' B.AC_CODE='''+@CBUYER_CODE+''''
        
  		
	SET @CCMD=N'SELECT CASE WHEN A.CANCELLED=0 THEN ''UNCANCELLED'' ELSE ''CANCELLED'' END AS CANCELLED, 
	    A.MEMO_NO, A.MEMO_ID,A.MEMO_DT,
	     B.AC_CODE,AC_NAME,BILL_NO AS ORDER_NO,
	     CAST(C.QUANTITY AS NUMERIC(10,0)) AS QUANTITY,
	     CAST(C.PENDING_QUANTITY AS NUMERIC(10,0)) AS TOTAL_QUANTITY,
		CAST((C.PENDING_QUANTITY - C.QUANTITY)AS NUMERIC(10,0)) AS PENDING_QUANTITY,C.ROW_ID
		FROM PPC_FGBCG_MST A JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
		JOIN PPC_FGBCG_DET C ON A.MEMO_ID=C.MEMO_ID
		JOIN PPC_BUYER_ORDER_DET D ON D.ROW_ID=C.BO_DET_ROW_ID
		JOIN PPC_BUYER_ORDER_MST E ON D.ORDER_ID=E.ORDER_ID
		WHERE '+@CFILTER+' AND '+ @CFILTER1 +'  
		AND ('''+RTRIM(LTRIM(@CFIN_YEAR))+'''='''' OR A.FIN_YEAR='''+RTRIM(LTRIM(@CFIN_YEAR))+''')
		ORDER BY A.MEMO_DT DESC,A.MEMO_ID DESC'
   PRINT @CCMD
  EXEC SP_EXECUTESQL @CCMD		
		
		

END
