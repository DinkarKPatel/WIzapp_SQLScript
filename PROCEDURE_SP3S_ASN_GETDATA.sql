CREATE PROCEDURE SP3S_ASN_GETDATA    
(    
 @NQUERYID INT,-- 1 FOR PO LIST, 2 FOR PENDING PO LIST BARCODE WISE , 3 FOR MASTER LIST, 4 FOR DETAILS LIST    
 @CAC_CODE VARCHAR(10)='',    
 @CPO_ID VARCHAR(50)='',    
 @CMEMO_ID VARCHAR(50)='',
 @APPROVALLEVEL INT =2,  
 @CWHERE VARCHAR(1000)='',      
 @CPARA1 VARCHAR(100)=''   
)    
AS    
BEGIN

IF  @APPROVALLEVEL =1
SET @APPROVALLEVEL=99  

    
IF @NQUERYID IN(1,2)    
   BEGIN   
   
    DECLARE @IMAXLEVEL INT 
      
      SELECT @IMAXLEVEL=MAX(LEVEL_NO) 
			FROM XN_APPROVAL_CHECKLIST_LEVELS (NOLOCK)
			WHERE XN_TYPE='PO' AND INACTIVE=0 
		SET @IMAXLEVEL=ISNULL(@IMAXLEVEL,0)
		
              
              
          IF OBJECT_ID ('TEMPDB..#TMPPENDIGPO','U') IS NOT NULL    
             DROP TABLE #TMPPENDIGPO    
            
          SELECT B.PO_DT,B.PO_NO ,B.PO_ID ,    
                 A.ROW_ID ,A.PRODUCT_CODE ,    
                 A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE,    
                 A.QUANTITY,ISNULL(C.ASN_QTY ,0) AS ASN_QTY,    
                 CONVERT(NUMERIC(10,3),A.QUANTITY-ISNULL(C.ASN_QTY ,0)) AS PENDING_QTY ,
                 C.BOX_NO   
          INTO #TMPPENDIGPO    
		FROM POD01106 A(NOLOCK)    
		JOIN POM01106 B(NOLOCK) ON A.PO_ID =B.PO_ID     
		LEFT OUTER JOIN    
		(    
			SELECT A.PO_ROW_ID ,SUM(A.QUANTITY) AS ASN_QTY ,A.BOX_NO    
			FROM ASN_DET A(NOLOCK)    
			JOIN ASN_MST B(NOLOCK) ON A.MEMO_ID =B.MEMO_ID     
			WHERE B.CANCELLED =0 GROUP BY A.PO_ROW_ID,A.BOX_NO    
		) C ON A.ROW_ID =C.PO_ROW_ID     
		WHERE B.CANCELLED =0 AND ISNULL(B.PO_RECEIVING_MODE,0)=2    
		AND (@CAC_CODE='' OR B.AC_CODE =@CAC_CODE)
		AND (@IMAXLEVEL=0 OR B.APPROVEDLEVELNO=99)     
		AND (@CPO_ID='' OR A.PO_ID  =@CPO_ID)    
		AND CONVERT(NUMERIC(10,3),A.QUANTITY-ISNULL(C.ASN_QTY ,0))>0  
       
        
    END    
    
IF @NQUERYID=1    
   GOTO LBLPENDINGPOSUMMARY    
ELSE IF @NQUERYID=2    
   GOTO LBLPENDINGPODET    
ELSE IF @NQUERYID=3    
   GOTO LBLMST    
ELSE IF @NQUERYID=4    
   GOTO LBLDET 
ELSE IF @NQUERYID=5    
   GOTO LBLCLOSINGREMARKS 
ELSE IF @NQUERYID=6      
   GOTO LBLEXPORTLIST 
ELSE IF @NQUERYID=7      
   GOTO LBLUOM              
ELSE IF @NQUERYID=8           
   GOTO LBLEXPORT              
ELSE IF @NQUERYID=9               
   GOTO GET_QC_QTY  
ELSE IF @NQUERYID=10               
   GOTO GET_PO_ITEM_DETAILS  
ELSE          
   GOTO END_PROC    
       

GET_PO_ITEM_DETAILS:
IF EXISTS(SELECT TOP 1 PO_ID FROM POM01106 (NOLOCK) WHERE CANCELLED=0 AND AC_CODE=@CAC_CODE AND PO_ID=@CPO_ID)
   IF EXISTS(SELECT * FROM POD01106 WITH (INDEX=IX_POD01106_PRODUCT_CODE,NOLOCK) WHERE PRODUCT_CODE=@CWHERE AND PO_ID=@CPO_ID)		  
		BEGIN		  
			SELECT A.PRODUCT_CODE ,A.ARTICLE_CODE ,ART.ARTICLE_NO
			,A.PARA1_CODE ,P1.PARA1_NAME
			,A.PARA2_CODE ,P2.PARA2_NAME
			,SD.SUB_SECTION_NAME ,SM.SECTION_NAME
			,A.ROW_ID AS PO_ROW_ID
			,A.QUANTITY AS POQUANTITY
			,CASE @CPARA1 WHEN 0 THEN 1 ELSE @CPARA1 END AS QUANTITY
			,CAST('LATER' AS VARCHAR(22)) AS  MEMO_ID
			,CAST('LATER' AS VARCHAR(40)) AS  ROW_ID
			,UOM.UOM_NAME
			,@CMEMO_ID BOX_NO
            ,CAST('' AS VARCHAR(1000))REMARKS
			FROM POD01106 A WITH (INDEX=IX_POD01106_PRODUCT_CODE,NOLOCK)     
			JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =A.ARTICLE_CODE     
			JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =A.PARA1_CODE     
			JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =A.PARA2_CODE     
			JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE     
			JOIN SECTIONM SM (NOLOCK) ON SM.SECTION_CODE =SD.SECTION_CODE     
			JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE     
			WHERE A.PRODUCT_CODE=@CWHERE AND A.PO_ID=@CPO_ID
		END
   ELSE 
	    SELECT 'ERR' ERRMSG	
ELSE
	SELECT 'ERR' ERRMSG
GOTO END_PROC


LBLPENDINGPOSUMMARY:    
SELECT CAST(0 AS BIT) AS CHK, A.PO_DT,A.PO_NO ,A.PO_ID ,    
SUM(PENDING_QTY) AS PENDING_QTY    
FROM #TMPPENDIGPO A    
GROUP BY A.PO_DT,A.PO_NO ,A.PO_ID    
GOTO END_PROC    
          
          
LBLPENDINGPODET:    
SELECT A.PRODUCT_CODE ,A.ARTICLE_CODE ,ART.ARTICLE_NO ,     
                   A.PARA1_CODE ,P1.PARA1_NAME ,    
                   A.PARA2_CODE ,P2.PARA2_NAME,     
                   SD.SUB_SECTION_NAME ,    
                   SM.SECTION_NAME ,    
                   A.ROW_ID AS PO_ROW_ID,  
                   A.QUANTITY AS POQUANTITY  ,
                   A.PENDING_QTY AS QUANTITY ,    
                   CAST('LATER' AS VARCHAR(22)) AS  MEMO_ID,    
                   CAST('LATER' AS VARCHAR(40)) AS  ROW_ID,    
                   UOM.UOM_NAME,A.BOX_NO     
                   ,CAST('' AS VARCHAR(1000))REMARKS
FROM #TMPPENDIGPO A    
JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =A.ARTICLE_CODE     
JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =A.PARA1_CODE     
JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =A.PARA2_CODE     
JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE     
JOIN SECTIONM SM (NOLOCK) ON SM.SECTION_CODE =SD.SECTION_CODE     
JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE     
GOTO END_PROC    
          



LBLMST:          
DECLARE @EDIT_PERM INT=0
IF EXISTS(SELECT TOP 1 VALUE FROM USER_ROLE_DET UD (NOLOCK)
JOIN USERS U (NOLOCK) ON U.ROLE_ID=UD.ROLE_ID
WHERE U.AC_CODE=@CPO_ID AND GROUP_NAME='MASTERS' AND FORM_OPTION='EDIT' AND VALUE=1 AND FORM_NAME='ASN')
   SET @EDIT_PERM=1

SELECT A.MEMO_ID ,A.MEMO_NO ,CONVERT(VARCHAR(10),A.MEMO_DT,105)MEMO_DT , A.AC_CODE,LM.AC_NAME ,POM.PO_DT ,POM.PO_NO 
	   ,A.NO_OF_CARTONS,A.TOTAL_WEIGHT_SHIPMENT, CONVERT(VARCHAR(10) ,DATE_TIME_SHIPMENT ,105) DATE_TIME_SHIPMENT
	   ,CONVERT(VARCHAR(10) ,A.EXPECTED_TIME_ARRIVAL ,105) EXPECTED_TIME_ARRIVAL
	   ,A.REMARKS,A.USER_CODE,U .USERNAME  ,A.CANCELLED,STATUS,A.FIN_YEAR 
       ,(CASE WHEN A.APPROVEDLEVELNO=99 THEN 1 ELSE 0 END) AS APPROVED_STATUS 
       ,A.TOTAL_QUANTITY 
       ,POM.DEPT_ID AS DELIVER_AT ,ISNULL(GRN_QTY,0)GRN_QTY,ISNULL(ASN_INV_NO,'')ASN_INV_NO
       ,CONVERT(VARCHAR(10),ISNULL(ASN_INV_DT,''),103)ASN_INV_DT,POM.PO_ID
       ,ISNULL(ASN_INV_AMT,0)ASN_INV_AMT,STATUS,ISNULL(UOM_NAME,'') AS UOM_NAME 
       ,ISNULL(A.UOM_CODE,'') AS UOM_CODE,ISNULL(A.MEMO_PREFIX,'') AS MEMO_PREFIX      
       ,ISNULL(A.INVOICE_NO,'') AS INVOICE_NO
	   ,@EDIT_PERM AS EDIT_STATUS
FROM ASN_MST A (NOLOCK)          
JOIN LM01106 LM(NOLOCK) ON LM.AC_CODE =A.AC_CODE           
JOIN USERS U (NOLOCK) ON U.USER_CODE =A.USER_CODE           
JOIN POM01106 POM (NOLOCK) ON POM .PO_ID =A.PO_ID      
LEFT JOIN UOM(NOLOCK) ON UOM.UOM_CODE=A.UOM_CODE      
LEFT JOIN      
(      
    SELECT A.REF_MEMO_ID,PARTY_INV_NO as ASN_INV_NO,PARTY_INV_DT as ASN_INV_DT,PARTY_INV_AMT as ASN_INV_AMT       
    FROM PARCEL_det A(NOLOCK)      
    JOIN PARCEL_MST B(NOLOCK) ON A.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID      
    JOIN ASN_MST (NOLOCK) ON ASN_MST.MEMO_ID=A.REF_MEMO_ID      
    WHERE XN_TYPE='ASN'      
) Z ON Z.REF_MEMO_ID=A.MEMO_ID            
 WHERE (@CMEMO_ID='' OR A.MEMO_ID =@CMEMO_ID)  
 AND (@CAC_CODE='' OR A.AC_CODE =@CAC_CODE)  
 AND (@APPROVALLEVEL=2 OR ISNULL(A.APPROVEDLEVELNO,0)=@APPROVALLEVEL)      
        
        
 SELECT A.MEMO_ID ,B.PRODUCT_CODE ,          
       A.QUANTITY ,          
       ART.ARTICLE_CODE ,ART.ARTICLE_NO ,           
       P1.PARA1_CODE ,P1.PARA1_NAME ,          
       P2.PARA2_CODE ,P2.PARA2_NAME,           
       SD.SUB_SECTION_NAME ,          
      SM.SECTION_NAME ,          
       UOM.UOM_NAME           
FROM ASN_DET A(NOLOCK)          
JOIN POD01106 B(NOLOCK) ON A.PO_ROW_ID =B.ROW_ID           
JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =B.ARTICLE_CODE           
JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =B.PARA1_CODE           
JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =B.PARA2_CODE           
JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE           
JOIN SECTIONM SM (NOLOCK) ON SM.SECTION_CODE =SD.SECTION_CODE           
JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE           
WHERE A.MEMO_ID =@CMEMO_ID          
GOTO END_PROC          
                 




LBLDET:          
                      
            SELECT A.MEMO_ID ,B.PRODUCT_CODE ,          
                   A.QUANTITY AS ASN_QTY ,          
                   B.QUANTITY AS PO_QTY ,        
              ART.ARTICLE_CODE ,ART.ARTICLE_NO ,           
                   P1.PARA1_CODE ,P1.PARA1_NAME ,          
                   P2.PARA2_CODE ,P2.PARA2_NAME,           
                   SD.SUB_SECTION_NAME ,          
                   SM.SECTION_NAME ,          
                   UOM.UOM_NAME   ,        
                   A.PO_ROW_ID,A.ROW_ID,      
     A.REMARKS,      
                   ISNULL(A.BOX_NO,'1') AS BOX_NO    
                   ,A.QUANTITY,  
                   B.QUANTITY AS POQUANTITY       
                   ,CAST('' AS VARCHAR(1000))REMARKS      
            FROM ASN_DET A(NOLOCK)          
            JOIN POD01106 B(NOLOCK) ON A.PO_ROW_ID =B.ROW_ID           
            JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =B.ARTICLE_CODE           
            JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =B.PARA1_CODE           
JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =B.PARA2_CODE           
            JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE           
            JOIN SECTIONM SM (NOLOCK) ON SM.SECTION_CODE =SD.SECTION_CODE           
            JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE           
            WHERE A.MEMO_ID =@CMEMO_ID          
                 
       GOTO END_PROC 
       
        LBLEXPORT:          
                      
            SELECT CONVERT(NUMERIC,B.PRODUCT_CODE) AS PRODUCT_CODE ,          
                  
                   ISNULL(A.BOX_NO,'1') AS BOX_NO    
                   ,A.QUANTITY 
                       
            FROM ASN_DET A(NOLOCK)          
            JOIN POD01106 B(NOLOCK) ON A.PO_ROW_ID =B.ROW_ID           
            JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =B.ARTICLE_CODE           
            JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =B.PARA1_CODE           
JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =B.PARA2_CODE           
            JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE           
            JOIN SECTIONM SM (NOLOCK) ON SM.SECTION_CODE =SD.SECTION_CODE           
            JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE           
            WHERE A.MEMO_ID =@CMEMO_ID          
                 
       GOTO END_PROC  
       
       
LBLCLOSINGREMARKS:

        SELECT DISTINCT POD01106.PRODUCT_CODE,ARTICLE_NO,PARA1_NAME,PARA2_NAME,ASN_DET.QUANTITY ASN_QTY,
        ISNULL(Z.GRN_PS_DET_QUANTITY,0) GRN_QTY,ISNULL(ASN_DET.REMARKS,'') CLOSING_REMARKS,
        ( ASN_DET.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) PENDIING_QTY,
        ASN_DET.ROW_ID
		FROM ASN_DET (NOLOCK)
		JOIN ASN_MST(NOLOCK) ON ASN_MST.MEMO_ID=ASN_DET.MEMO_ID
		JOIN POD01106 (NOLOCK) ON POD01106.ROW_ID=ASN_DET.PO_ROW_ID
		JOIN POM01106(NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
		LEFT JOIN
		(
		SELECT ASN_ROW_ID,ISNULL(SUM(A.QUANTITY),0) GRN_PS_DET_QUANTITY FROM GRN_PS_DET A(NOLOCK)
		JOIN GRN_PS_MST B(NOLOCK) ON A.MEMO_ID=B.MEMO_ID
		JOIN ASN_DET C(NOLOCK) ON C.ROW_ID=A.ASN_ROW_ID
		WHERE C.MEMO_ID=@CMEMO_ID AND B.CANCELLED=0
		GROUP BY ASN_ROW_ID
		)Z ON Z.ASN_ROW_ID=ASN_DET.ROW_ID 
		JOIN SKU(NOLOCK) ON SKU.PRODUCT_CODE=POD01106.PRODUCT_CODE
		JOIN ARTICLE(NOLOCK)ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
		JOIN PARA1(NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
		JOIN PARA2(NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
		WHERE  ( ASN_DET.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) > 0
		AND ASN_MST.MEMO_ID=@CMEMO_ID
		
LBLEXPORTLIST:      
                
            SELECT A.MEMO_ID ,A.MEMO_NO ,A.MEMO_DT , A.AC_CODE,LM.AC_NAME ,POM.PO_DT ,POM.PO_NO ,      
                   A.NO_OF_CARTONS,A.TOTAL_WEIGHT_SHIPMENT, CONVERT(VARCHAR ,DATE_TIME_SHIPMENT ,103) DATE_TIME_SHIPMENT,  
                   CONVERT(VARCHAR ,A.EXPECTED_TIME_ARRIVAL ,103) EXPECTED_TIME_ARRIVAL,      
                   A.REMARKS,A.USER_CODE,U .USERNAME  ,  
                   A.TOTAL_QUANTITY ,  
                   POM.DEPT_ID AS DELIVER_AT ,ISNULL(GRN_QTY,0)GRN_QTY,ISNULL(ASN_INV_NO,'')ASN_INV_NO,  
                   CONVERT(VARCHAR(10),ISNULL(ASN_INV_DT,''),103)ASN_INV_DT,  
                ISNULL(ASN_INV_AMT,0)ASN_INV_AMT  
            FROM ASN_MST A (NOLOCK)      
            JOIN LM01106 LM(NOLOCK) ON LM.AC_CODE =A.AC_CODE       
            JOIN USERS U (NOLOCK) ON U.USER_CODE =A.USER_CODE       
            JOIN POM01106 POM (NOLOCK) ON POM .PO_ID =A.PO_ID  
            LEFT JOIN  
            (  
                SELECT A.REF_MEMO_ID,PARTY_INV_NO as ASN_INV_NO,PARTY_INV_DT as ASN_INV_DT,PARTY_INV_AMT as ASN_INV_AMT     
                FROM parcel_det  A(NOLOCK)  
                JOIN PARCEL_MST B(NOLOCK) ON A.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID  
                JOIN ASN_MST (NOLOCK) ON ASN_MST.MEMO_ID=A.REF_MEMO_ID  
                WHERE XN_TYPE='ASN'  
            ) Z ON Z.REF_MEMO_ID=A.MEMO_ID        
             WHERE   
            (@CMEMO_ID='' OR A.MEMO_ID =@CMEMO_ID)  AND    
             (@CAC_CODE='' OR A.AC_CODE =@CAC_CODE)  AND   
             (@APPROVALLEVEL=2 OR ISNULL(A.APPROVEDLEVELNO,0)=@APPROVALLEVEL)  
                
                
             SELECT A.MEMO_ID ,B.PRODUCT_CODE ,      
                   A.QUANTITY ,      
                   ART.ARTICLE_CODE ,ART.ARTICLE_NO ,       
                   P1.PARA1_CODE ,P1.PARA1_NAME ,      
                   P2.PARA2_CODE ,P2.PARA2_NAME,       
                   SD.SUB_SECTION_NAME ,      
                  SM.SECTION_NAME ,      
                   UOM.UOM_NAME       
            FROM ASN_DET A(NOLOCK)      
            JOIN POD01106 B(NOLOCK) ON A.PO_ROW_ID =B.ROW_ID       
              
            JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =B.ARTICLE_CODE       
            JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =B.PARA1_CODE       
            JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =B.PARA2_CODE       
            JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE       
            JOIN SECTIONM SM (NOLOCK) ON SM.SECTION_CODE =SD.SECTION_CODE       
            JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE       
            WHERE A.MEMO_ID =@CMEMO_ID      
            
            
       GOTO END_PROC
       
LBLUOM:
  
       SELECT UOM_CODE,UOM_NAME FROM UOM (NOLOCK)      		
       GOTO END_PROC       
         
GET_QC_QTY:  
 SELECT PO.PO_NO,ISNULL(ART.ARTICLE_NO,'')ARTICLE_NO,ISNULL(P1.PARA1_NAME,'')PARA1_NAME,QC_QUANTITY  
 FROM QC_XN_MST  QM  (NOLOCK)  
 JOIN QC_XN_DET_1 QD  (NOLOCK) ON QM.MEMO_ID=QD.MEMO_ID  
 JOIN POM01106  PO  (NOLOCK) ON PO.PO_ID=QD.PO_ID  
 LEFT JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=QD.ARTICLE_CODE  
 LEFT JOIN PARA1  P1  (NOLOCK) ON ART.PARA1_CODE=QD.PARA1_CODE  
 WHERE QM.CANCELLED=0   
 AND QM.AC_CODE=@CAC_CODE   
 AND QD.ROW_ID=@CPO_ID  
 AND ART.ARTICLE_NO=@CWHERE  
 AND P1.PARA1_NAME=@CPARA1     
 GOTO END_PROC            

 
END_PROC: 
END
