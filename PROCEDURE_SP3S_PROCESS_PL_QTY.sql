create PROCEDURE SP3S_PROCESS_PL_QTY
(
  @CKEYFIELDVAL1 VARCHAR(100)='',
  @CORDER_ID VARCHAR(100)='',
  @NREVERTFLAG INT=0,
  @CERRORMSG VARCHAR(1000) OUTPUT
)
AS
BEGIN
    
      DECLARE @NOUTFLAG INT 
      
	
	  
	   IF @NREVERTFLAG = 1  
		SET @NOUTFLAG =  1  
       ELSE  
		SET @NOUTFLAG = -1  
	  
	
	     
  SET @CERRORMSG=''
  BEGIN TRY  
     
     
      
		IF EXISTS (SELECT TOP 1 'U' FROM BUYER_ORDER_DET (NOLOCK) WHERE ORDER_ID=@CORDER_ID AND ISNULL(PRODUCT_CODE,'')<>'')
		BEGIN
	    
			UPDATE A SET PL_QTY=ISNULL(A.PL_QTY,0)-(@NOUTFLAG*B.PL_QTY)  FROM BUYER_ORDER_DET  A (NOLOCK)
			JOIN
			(   
				SELECT A.ORDER_ID,
					   LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE ))) AS PRODUCT_CODE,
					   SUM(B.QUANTITY) AS PL_QTY
				FROM FLOOR_ST_MST A (NOLOCK)
				JOIN FLOOR_ST_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
				WHERE A.MEMO_ID =@CKEYFIELDVAL1
				AND ISNULL(A.ORDER_ID ,'')<>''
				GROUP BY A.ORDER_ID,LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE )))
		    
			) B ON A.order_id =B.ORDER_ID AND A.product_code =B.PRODUCT_CODE 
			WHERE A.product_code <>'' and a.order_id =@CORDER_ID
		    
		 END 
		 ELSE
		 BEGIN
		 
	         DECLARE @CCONSIDER_PARA1 VARCHAR(10),@CCONSIDER_PARA2 VARCHAR(10),@CCONSIDER_PARA3 VARCHAR(10),
                      @CCONSIDER_PARA4 VARCHAR(10),@CCONSIDER_PARA5 VARCHAR(10),@CCONSIDER_PARA6 VARCHAR(10)
                    
              
        
              SELECT TOP 1 @CCONSIDER_PARA1=VALUE FROM CONFIG WHERE  CONFIG_OPTION LIKE 'CONSIDER_PARA1'
              
              SELECT TOP 1 @CCONSIDER_PARA2=VALUE FROM CONFIG WHERE  CONFIG_OPTION LIKE 'CONSIDER_PARA2'
              
              SELECT TOP 1 @CCONSIDER_PARA3=VALUE FROM CONFIG WHERE CONFIG_OPTION LIKE 'CONSIDER_PARA3'
              
              SELECT TOP 1 @CCONSIDER_PARA4=VALUE FROM CONFIG WHERE CONFIG_OPTION LIKE 'CONSIDER_PARA4'
              
              SELECT TOP 1 @CCONSIDER_PARA5=VALUE FROM CONFIG WHERE CONFIG_OPTION LIKE 'CONSIDER_PARA5'
                         
			  SELECT TOP 1 @CCONSIDER_PARA6=VALUE FROM CONFIG WHERE  CONFIG_OPTION LIKE 'CONSIDER_PARA6'
              
          
	     
		    
			UPDATE A SET PL_QTY=ISNULL(A.PL_QTY,0)-(@NOUTFLAG*B.PL_QTY)  FROM BUYER_ORDER_DET  A (NOLOCK)
			JOIN
			(   
				  SELECT B.ORDER_ID, SKU.article_code ,
					   CASE WHEN @CCONSIDER_PARA1='1' THEN SKU.PARA1_CODE ELSE '0000000' END AS PARA1_CODE,
		               CASE WHEN @CCONSIDER_PARA2='1' THEN SKU.PARA2_CODE ELSE '0000000' END AS PARA2_CODE,
			           CASE WHEN @CCONSIDER_PARA3='1' THEN SKU.PARA3_CODE ELSE '0000000' END AS PARA3_CODE,
			           CASE WHEN @CCONSIDER_PARA4='1' THEN SKU.PARA4_CODE ELSE '0000000' END AS PARA4_CODE,
			           CASE WHEN @CCONSIDER_PARA5='1' THEN SKU.PARA5_CODE ELSE '0000000' END AS PARA5_CODE,
			           CASE WHEN @CCONSIDER_PARA6='1' THEN SKU.PARA6_CODE ELSE '0000000' END AS PARA6_CODE,
					 SUM(A.quantity ) AS PL_QTY
					 FROM FLOOR_ST_DET  A (NOLOCK)
					 JOIN FLOOR_ST_MST B (NOLOCK) ON A.MEMO_ID  =B.MEMO_ID 
					 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE =SKU.product_code 
					 WHERE B.CANCELLED =0
					 AND  B.MEMO_ID =@CKEYFIELDVAL1
					 AND ISNULL(B.ORDER_ID,'')<>''
					 GROUP BY  B.ORDER_ID,SKU.article_code,
					CASE WHEN @CCONSIDER_PARA1='1' THEN SKU.PARA1_CODE ELSE '0000000' END,
					CASE WHEN @CCONSIDER_PARA2='1' THEN SKU.PARA2_CODE ELSE '0000000' END,
			        CASE WHEN @CCONSIDER_PARA3='1' THEN SKU.PARA3_CODE ELSE '0000000' END,
			        CASE WHEN @CCONSIDER_PARA4='1' THEN SKU.PARA4_CODE ELSE '0000000' END,
			        CASE WHEN @CCONSIDER_PARA5='1' THEN SKU.PARA5_CODE ELSE '0000000' END,
			        CASE WHEN @CCONSIDER_PARA6='1' THEN SKU.PARA6_CODE ELSE '0000000' END
		    
			) B ON A.order_id =B.ORDER_ID AND A.article_code  =B.article_code
			and a.para1_code=CASE WHEN @CCONSIDER_PARA1='1' THEN b.PARA1_CODE ELSE a.para1_code  END
			and a.para2_code=CASE WHEN @CCONSIDER_PARA2='1' THEN b.PARA2_CODE ELSE a.para2_code  END
			and a.para3_code=CASE WHEN @CCONSIDER_PARA3='1' THEN b.PARA3_CODE ELSE a.para3_code  END
			and a.para4_code=CASE WHEN @CCONSIDER_PARA4='1' THEN b.PARA3_CODE ELSE a.para4_code  END
			and a.para5_code=CASE WHEN @CCONSIDER_PARA5='1' THEN b.PARA5_CODE ELSE a.para5_code  END
			and a.para6_code=CASE WHEN @CCONSIDER_PARA6='1' THEN b.PARA6_CODE ELSE a.para6_code  END
			WHERE ISNULL(A.product_code,'') ='' and a.order_id =@CORDER_ID
			
		
		 
		 
		 END  
		    
		    
	    
	   UPDATE A  SET TOTAL_PICK_LIST_QTY=ISNULL(A.TOTAL_PICK_LIST_QTY,0)-(@NOUTFLAG*ISNULL(B.PICK_LIST_QTY,0))
	   FROM BUYER_ORDER_MST A (NOLOCK)
	   JOIN
	   (
		SELECT A.ORDER_ID ,SUM(B.QUANTITY) AS PICK_LIST_QTY 
		FROM FLOOR_ST_MST A (NOLOCK)
		JOIN FLOOR_ST_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
		WHERE A.MEMO_ID =@CKEYFIELDVAL1
		AND ISNULL(A.ORDER_ID ,'')<>''
		GROUP BY A.ORDER_ID
		) B ON A.order_id =B.ORDER_ID 
		where a. order_id =@CORDER_ID
     
     
 END TRY  
 BEGIN CATCH  
  SET @CERRORMSG = 'STEP-  SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()  
  GOTO END_PROC  
 END CATCH  
   
   
END_PROC:  

END
--new
