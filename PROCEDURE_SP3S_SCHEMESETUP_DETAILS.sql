CREATE PROCEDURE SP3S_SCHEMESETUP_DETAILS
(
 @NQUERYID INT, --1 1 FOR DISPLAY DETAILS OF SCHEME
 @CMEMO_NO VARCHAR(MAX)=''
)
--WITH ENCRYPTION
AS
BEGIN
    
  IF @NQUERYID=1
  BEGIN
	SELECT DISTINCT A.MEMO_NO,SCHEME_SET_NAME,SCHEME_NAME
	FROM SCHEME_SETUP_MST A 
	LEFT JOIN SCHEME_SETUP_DET B ON A.MEMO_NO=B.MEMO_NO
	LEFT JOIN SCHEME_SETUP_SLSBC  C ON C.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID 
	WHERE  CONVERT(VARCHAR,GETDATE(),110) BETWEEN APPLICABLE_FROM_DT AND APPLICABLE_TO_DT
	
	GOTO END_PROC
  END
  IF @NQUERYID=2
  BEGIN 
    
    DECLARE @DTSQL NVARCHAR(MAX),@NSTEP VARCHAR(10),@CROWFILTER VARCHAR(MAX),
            @CERRORMSG VARCHAR(1000)
    
    SET @CROWFILTER = N' B.MEMO_NO IN ( ' + @CMEMO_NO + ' )'
    BEGIN TRY
	BEGIN TRANSACTION   
	SET @NSTEP=10
	SET @DTSQL=N'DELETE A FROM SCHEME_SETUP_SLSPARA_GET A 
	             JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	             WHERE  '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @NSTEP=20
	SET @DTSQL=N'DELETE A FROM SCHEME_SETUP_SLSPARA A 
	             JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	             WHERE  '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @NSTEP=30
	SET @DTSQL=N'DELETE A FROM SCHEME_SETUP_SLSART_GET A 
	             JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	             WHERE '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @NSTEP=40
	SET @DTSQL=N'DELETE A FROM SCHEME_SETUP_SLSART A 
	             JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	             WHERE '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @NSTEP=50
	SET @DTSQL=N'DELETE A FROM SCHEME_SETUP_SLSBC_GET A 
	             JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	             WHERE '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @NSTEP=60
	SET @DTSQL=N'DELETE A FROM SCHEME_SETUP_SLSBC A 
	             JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	             WHERE '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @NSTEP=70
	SET @DTSQL=N'DELETE A FROM SCHEME_SETUP_SCH0002_1 A 
	             JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	             WHERE '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @NSTEP=80
	SET @DTSQL=N'DELETE B FROM SCHEME_SETUP_HAPPYHOURS B  WHERE '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @NSTEP=90
	SET @DTSQL=N'DELETE B FROM SCHEME_SETUP_DET B  WHERE '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @NSTEP=100
	SET @DTSQL=N'DELETE B FROM SCHEME_SETUP_LOC B  WHERE '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	
	SET @NSTEP=110
	SET @DTSQL=N'DELETE B FROM SCHEME_SETUP_MST B  WHERE '+@CROWFILTER+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
    END TRY
	BEGIN CATCH
		SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		GOTO END_PROC
	END CATCH
END_PROC:

	IF @@TRANCOUNT>0
	BEGIN
		
		IF ISNULL(@CERRORMSG,'')='' 
		BEGIN
			COMMIT TRANSACTION
		END
		ELSE
			ROLLBACK
		
		SELECT ISNULL(@CERRORMSG,'') AS ERRMSG	
	END

END
END
--END OF PROCEDURE SP3S_SCHEMESETUP_DETAILS
