CREATE PROCEDURE DBO.SP_SEND_MIRROR_MSTBGT_NEW  --(LocId 3 digit change by Sanjay:06-11-2024)
(  
 @CTARGETLOCID VARCHAR(5)  
)  
AS  
 BEGIN  
   DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION NVARCHAR(MAX)  
           ,@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPLMTABLE VARCHAR(100)  
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CCURDEPTID VARCHAR(5)  
           ,@CHODEPTID VARCHAR(5),@CERRORMSG VARCHAR(MAX),@CREPLOCTABLE VARCHAR(500),@NLOCTYPE INT  
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(4),@JOINMASTERTABLE VARCHAR(200),@JOINTEMPTABLE VARCHAR(200)  
             
           , @FINYEAR VARCHAR(10)  
  
    DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),ERRMSG VARCHAR(MAX))   
      
    BEGIN TRY  
      
      
 SET @CSTEP=0  
  
 SET @CTEMPDBNAME = ''  
    
 SET @CSTEP=00  
    
 SET @CSTEP=10  
   
 PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)  
 SET @CFILTERCONDITION=''  
    
 SET @CSTEP=20  
  
 SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'  
 SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'    
   
 SELECT @NLOCTYPE=LOC_TYPE FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID  
   
 PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)  
   
 IF @CCURDEPTID<>@CHODEPTID  
 BEGIN  
  SELECT '' AS LAST_UPDATE,'' AS ERRMSG  
    
  GOTO END_PROC  
 END    
    SET @CSTEP=30  

   
 --INSERT DATA FROM MAIN TABLE TO TEMP TABLE  
    SET @CSTEP=40  
    ---SELECT DATA FROM PRD_AGENCY_MST TABLE  
 SET @CTABLENAME = 'MONTHLYBUDGET_HEAD'  
 SELECT DISTINCT  'MSTBGT_MONTHLYBUDGET_HEAD_MIRROR' AS TARGET_TABLENAME,MONTHLYBUDGET_HEAD.*,1 AS PICK_FROM_CURRENT_DB FROM MONTHLYBUDGET_HEAD (NOLOCK)
 WHERE DEPT_ID =@CTARGETLOCID 

   
 SET @CSTEP=50  
  ---SELECT DATA FROM HD01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106    
 SET @CTABLENAME = 'LM01106'  
 
 SELECT DISTINCT  'MSTBGT_LM01106_MIRROR' AS TARGET_TABLENAME,LM01106.*,1 AS PICK_FROM_CURRENT_DB FROM LM01106 (NOLOCK)
 JOIN MONTHLYBUDGET_HEAD (NOLOCK) B ON LM01106.AC_CODE =B.AC_CODE 
 WHERE B.DEPT_ID =@CTARGETLOCID 
  
    SET @CSTEP=60  
  ---SELECT DATA FROM LMP01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106    
 SET @CTABLENAME = 'LMP01106'  

 SELECT DISTINCT  'MSTBGT_LMP01106_MIRROR' AS TARGET_TABLENAME,LMP01106.*,1 AS PICK_FROM_CURRENT_DB FROM LMP01106 (NOLOCK)
 JOIN MONTHLYBUDGET_HEAD (NOLOCK) B ON LMP01106.AC_CODE =B.AC_CODE 
 WHERE B.DEPT_ID =@CTARGETLOCID    
   

 SET @CSTEP=70  
  ---SELECT DATA FROM HD01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106    
 SET @CTABLENAME = 'HD01106'  

 SELECT DISTINCT  'MSTBGT_HD01106_MIRROR' AS TARGET_TABLENAME,HD01106.*,1 AS PICK_FROM_CURRENT_DB FROM HD01106 (NOLOCK)
 JOIN  LM01106 (NOLOCK) ON HD01106.HEAD_CODE =LM01106.HEAD_CODE
 JOIN MONTHLYBUDGET_HEAD (NOLOCK) B ON LM01106.AC_CODE =B.AC_CODE 
 WHERE B.DEPT_ID =@CTARGETLOCID 
  

  SET @CSTEP=80  
 --SELECT DATA FROM AREA TABLE   
 SET @CTABLENAME = 'AREA'  
 
 SELECT DISTINCT  'MSTBGT_AREA_MIRROR' AS TARGET_TABLENAME,AREA.*,1 AS PICK_FROM_CURRENT_DB FROM AREA (NOLOCK)
 JOIN LMP01106 (NOLOCK) ON AREA.area_code =LMP01106.area_code
 JOIN MONTHLYBUDGET_HEAD (NOLOCK) B ON LMP01106.AC_CODE =B.AC_CODE 
 WHERE B.DEPT_ID =@CTARGETLOCID    
   
   
   
 --INSERT DATA FROM MAIN TABLE TO TEMP TABLE  
    SET @CSTEP=90  
    ---SELECT DATA FROM MONTHLYBUDGET TABLE  
 SET @CTABLENAME = 'MONTHLYBUDGET'  

 SELECT DISTINCT  'MSTBGT_MONTHLYBUDGET_MIRROR' AS TARGET_TABLENAME,MONTHLYBUDGET.*,1 AS PICK_FROM_CURRENT_DB FROM MONTHLYBUDGET (NOLOCK)
   
   
 SET @CSTEP=100  

  --SELECT DATA FROM AREA TABLE   
 SET @CTABLENAME = 'CITY'  

 SELECT DISTINCT  'MSTBGT_CITY_MIRROR' AS TARGET_TABLENAME,CITY.*,1 AS PICK_FROM_CURRENT_DB FROM CITY (NOLOCK)
 JOIN AREA (NOLOCK) ON CITY.CITY_CODE =area .city_code 
 JOIN LMP01106 (NOLOCK) ON AREA.area_code =LMP01106.area_code
 JOIN MONTHLYBUDGET_HEAD (NOLOCK) B ON LMP01106.AC_CODE =B.AC_CODE 
 WHERE B.DEPT_ID =@CTARGETLOCID    

  
    SET @CSTEP=110  
 --SELECT DATA FROM STATE TABLE   
 SET @CTABLENAME = 'STATE'  

 SELECT DISTINCT  'MSTBGT_STATE_MIRROR' AS TARGET_TABLENAME,STATE.*,1 AS PICK_FROM_CURRENT_DB FROM STATE (NOLOCK)
 JOIN CITY (NOLOCK) ON CITY .state_code =state .state_code 
 JOIN AREA (NOLOCK) ON CITY.CITY_CODE =area .city_code 
 JOIN LMP01106 (NOLOCK) ON AREA.area_code =LMP01106.area_code
 JOIN MONTHLYBUDGET_HEAD (NOLOCK) B ON LMP01106.AC_CODE =B.AC_CODE 
 WHERE B.DEPT_ID =@CTARGETLOCID   


  
    SET @CSTEP=120  
 --SELECT DATA FROM STATE TABLE   
 SET @CTABLENAME = 'REGIONM'  
SELECT DISTINCT  'MSTBGT_REGIONM_MIRROR' AS TARGET_TABLENAME,REGIONM.*,1 AS PICK_FROM_CURRENT_DB FROM REGIONM (NOLOCK)
JOIN  STATE (NOLOCK) ON STATE.REGION_CODE =REGIONM .REGION_CODE
 JOIN CITY (NOLOCK) ON CITY .state_code =state .state_code 
 JOIN AREA (NOLOCK) ON CITY.CITY_CODE =area .city_code 
 JOIN LMP01106 (NOLOCK) ON AREA.area_code =LMP01106.area_code
 JOIN MONTHLYBUDGET_HEAD (NOLOCK) B ON LMP01106.AC_CODE =B.AC_CODE 
 WHERE B.DEPT_ID =@CTARGETLOCID   
   
   
 END TRY  
   
 BEGIN CATCH  
     SET @CERRORMSG='P: SP_SEND_MIRROR_MSTBGT_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()+ 'ERROR QUERY || '+@DTSQL  
     GOTO END_PROC  
    END CATCH   
      
    END_PROC:  
      
   SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
 END
