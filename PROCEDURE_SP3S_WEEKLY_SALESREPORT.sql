CREATE PROCEDURE SP3S_WEEKLY_SALESREPORT
(
 @NPERIOD_FILTER INT=1,-- 1-- FROM TO DATE , 2 FOR MONTH AND DATE 3 FOR YEAR AND DATE
 @FM_DT VARCHAR(20)='',
 @DTO_DT VARCHAR(20)='',
 @CCONVERSIONFACTOR	   INT=1,--1 FOR DIVIDE BY THOUSAND 2 FOR LAKH 3 FOR CARORE   
 @CDEPT_ID VARCHAR(5)='', ---'' FOR ALL LOCATION AND AND LOC FILTER
 @NRV_QTY INT =1---1 FOR NRV 2 FOR QTY
)
--WITH ENCRYPTION 
AS
BEGIN
    IF @DTO_DT=''
    SET @DTO_DT=GETDATE()
    
    
    
    DECLARE @TBLREPORT TABLE (ORDER_NO INT,DY_NAME CHAR(3),CNT INT,NRV NUMERIC(12,2),PER_DAY_NRV NUMERIC(12,2), NRV_CONT_PER NUMERIC(10,0),QTY NUMERIC(12,2),PER_DAY_QTY NUMERIC(10,2),QTY_CONT_PER NUMERIC(10,0))
    DECLARE @TBLDAY TABLE (ORDER_NO INT,DY_NAME CHAR(3))
    
    DECLARE @DTSQL NVARCHAR(MAX),@CFILTER VARCHAR(MAX),@NCONVERSIONAMOUNT NUMERIC(18,0),@ERROR VARCHAR(1000)
    DECLARE @CURYEAR AS VARCHAR(10),@TQTY NUMERIC(12,2),@TNRV NUMERIC(12,2)
    SET @CFILTER=''
    SET @CURYEAR=(SELECT '01'+ DBO.FN_GETFINYEAR(@DTO_DT))
     
    IF @NPERIOD_FILTER =1 AND @FM_DT =''
		SELECT @ERROR='PLEASE SELECT FROM DATE.' 
	IF ISNULL(@ERROR,'')<>''
	BEGIN
	   SELECT  @ERROR AS ERRMSG 
	   GOTO END_PROC
	END
	 
    SET @CFILTER= (CASE WHEN @NPERIOD_FILTER = 1 THEN ' A.CM_DT BETWEEN  '''+CONVERT(VARCHAR(11),@FM_DT,120)+'''  AND  '''+CONVERT(VARCHAR(11),@DTO_DT,120)+''' '    
                        WHEN @NPERIOD_FILTER = 2 THEN ' MONTH(A.CM_DT) = MONTH('''+@DTO_DT+''') AND A.FIN_YEAR='''+@CURYEAR+''' AND A.CM_DT <= '''+CONVERT(VARCHAR(11),@DTO_DT,120)+''' '    
                        WHEN @NPERIOD_FILTER = 3 THEN ' A.FIN_YEAR='''+@CURYEAR+'''' ELSE ''  END)    
    
    
    
     IF @NPERIOD_FILTER=3
     SET @CFILTER=@CFILTER+ 'AND  A.CM_DT <= '''+CONVERT(VARCHAR(11),@DTO_DT,120)+''' '
  
     IF @CFILTER<>''
     SET @CFILTER=' AND '+@CFILTER
     
    IF @CCONVERSIONFACTOR=0
        SET @NCONVERSIONAMOUNT=1
    ELSE IF @CCONVERSIONFACTOR=1
       SET @NCONVERSIONAMOUNT=1000
    ELSE IF @CCONVERSIONFACTOR=2
       SET @NCONVERSIONAMOUNT=100000
    ELSE IF @CCONVERSIONFACTOR=3
       SET @NCONVERSIONAMOUNT=10000000
       
    INSERT INTO @TBLDAY(ORDER_NO,DY_NAME)
	 SELECT 1 AS ORDER_NO, 'MON' AS WK_NAME UNION
	 SELECT 2 AS ORDER_NO, 'TUE' AS WK_NAME UNION
	 SELECT 3 AS ORDER_NO, 'WED' AS WK_NAME UNION
	 SELECT 4 AS ORDER_NO, 'THU' AS WK_NAME UNION
	 SELECT 5 AS ORDER_NO, 'FRI' AS WK_NAME UNION
	 SELECT 6 AS ORDER_NO, 'SAT' AS WK_NAME UNION
	 SELECT 7 AS ORDER_NO, 'SUN' AS WK_NAME  
 
 
 IF @CDEPT_ID<>''
 SET @CFILTER=@CFILTER+' AND LEFT (A.CM_ID,2)='''+@CDEPT_ID+''''
 
 IF @NRV_QTY=1
  GOTO LBL_NRV   
 ELSE IF @NRV_QTY=2 
  GOTO LBL_QTY   
     --SELECT * FROM @TBLREPORT
  LBL_NRV:
	
  
		 --INSERT INTO @TBLREPORT(ORDER_NO,DY_NAME,CNT ,NRV)
  SET @DTSQL =N'SELECT A.DY_NAME, COUNT(*) AS CNT,SUM(ISNULL(NRV,0)) AS NRV 
		 FROM 
		 (
		 SELECT CM_DT ,LEFT(DATENAME(DW ,CM_DT),3) AS DY_NAME,
				SUM(NET_AMOUNT) AS NRV
		 FROM CMM01106 A (NOLOCK)
		 WHERE A.CANCELLED=0'+@CFILTER+  
		 'GROUP BY CM_DT,LEFT(DATENAME(DW ,CM_DT),3) 
		 ) A
		 GROUP BY A.DY_NAME'
		
		 PRINT @DTSQL
		 INSERT INTO @TBLREPORT(DY_NAME,CNT ,NRV )
		 EXEC SP_EXECUTESQL @DTSQL
		 
		 
		
		 UPDATE @TBLREPORT SET PER_DAY_NRV =NRV /CNT 
		 SELECT @TNRV=SUM(ISNULL(PER_DAY_NRV ,0)) FROM @TBLREPORT
		 UPDATE @TBLREPORT SET NRV_CONT_PER =(PER_DAY_NRV *100)/CASE WHEN @TNRV=0 THEN 1 ELSE @TNRV END 
		 
		
            
		 UPDATE @TBLREPORT SET NRV=NRV/@NCONVERSIONAMOUNT, PER_DAY_NRV=PER_DAY_NRV/@NCONVERSIONAMOUNT
         
          SELECT A.DY_NAME,CNT ,NRV ,PER_DAY_NRV ,NRV_CONT_PER 
          FROM @TBLDAY A
		  JOIN @TBLREPORT B ON A.DY_NAME =B.DY_NAME 
		  ORDER BY A.ORDER_NO
		  
         GOTO END_PROC
         
   LBL_QTY:
   
   
		SET @DTSQL=N'SELECT A.DY_NAME, COUNT(*) AS CNT,SUM(ISNULL(QUANTITY,0)) AS QUANTITY 
		  FROM 
		 (
		 SELECT CM_DT ,LEFT(DATENAME(DW ,CM_DT),3) AS DY_NAME,SUM(QUANTITY) AS QUANTITY 
		 FROM CMM01106 A (NOLOCK)
		 JOIN CMD01106 B (NOLOCK)  ON A.CM_ID=B.CM_ID
		 WHERE   A.CANCELLED=0'+ @CFILTER +'
		 GROUP BY CM_DT ,LEFT(DATENAME(DW ,CM_DT),3)
		 ) A
		 GROUP BY A.DY_NAME'
		 PRINT @DTSQL
		 INSERT INTO @TBLREPORT(DY_NAME,CNT ,QTY)
		 EXEC SP_EXECUTESQL @DTSQL
	     
	    
		  UPDATE @TBLREPORT SET PER_DAY_QTY =QTY /CNT 
		  SELECT @TQTY=SUM(ISNULL(PER_DAY_QTY,0)) FROM @TBLREPORT
		  UPDATE @TBLREPORT SET QTY_CONT_PER =(PER_DAY_QTY *100)/CASE WHEN @TQTY=0 THEN 1 ELSE @TQTY END 
	      
	      
		 SELECT A.DY_NAME,CNT ,QTY ,PER_DAY_QTY ,QTY_CONT_PER 
		 FROM @TBLDAY A
		 JOIN @TBLREPORT B ON A.DY_NAME =B.DY_NAME 
		 ORDER BY A.ORDER_NO
         GOTO END_PROC
     
     
     
END_PROC:

END
