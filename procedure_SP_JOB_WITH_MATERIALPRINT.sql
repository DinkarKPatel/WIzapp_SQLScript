
create PROCEDURE SP_JOB_WITH_MATERIALPRINT 
(
	@CWHERE	NVARCHAR(100)
)
AS
BEGIN
	SET NOCOUNT ON 
	DECLARE @ADD VARCHAR(MAX)='',@AGENCY_NAME VARCHAR(MAX)='',@AGENCY_GST_NO VARCHAR(MAX)='',
	@EWAY_BILL_NO VARCHAR(100)='',@TIME VARCHAR(100)
	SET @TIME='START= '+CONVERT(VARCHAR,GETDATE(),114)
	--RAISERROR(@TIME,0,1) WITH NOWAIT
    
    
	
	SELECT TOP 1 @ADD = ISNULL(LMV.ADDRESS0,'')
	+ISNULL(' '+LMV.ADDRESS1,'')
	+ISNULL(' '+LMV.ADDRESS2,'') 
	+ISNULL(' '+LMV.AREA_NAME,'')
	+ISNULL(' '+LMV.CITY,'')
	+ISNULL(' '+LMV.PINCODE,'')
	+ISNULL(' '+LMV.[STATE],'')
	+ISNULL(' ('+LMV.[COUNTRY_NAME]+')',''),@AGENCY_NAME = ISNULL(LMV.AC_NAME,''),
	@EWAY_BILL_NO = ISNULL(A.EWAY_BILL_NO,''),
	@AGENCY_GST_NO = ISNULL(LMV.AC_GST_NO,'')
	FROM JOBWORK_ISSUE_MST A WITH (NOLOCK)
	JOIN PRD_AGENCY_MST AG WITH (NOLOCK) ON AG.AGENCY_CODE=A.AGENCY_CODE
	JOIN LMV01106 LMV WITH (NOLOCK) ON LMV.AC_CODE=AG.AC_CODE
	WHERE A.ISSUE_ID=LTRIM(RTRIM(@CWHERE))

	
	SELECT 'BOM' AS XN_TYPE, B.ISSUE_NO,B.ISSUE_DT, B.ISSUE_ID  ,@EWAY_BILL_NO AS EWAY_BILL_NO,
	       B.JOBWORK_ISSUE_ID AS JOBWORK_ISSUE_ID,
	       ART.ARTICLE_NO,ART.ARTICLE_NAME,
	       SUM(A.QUANTITY) AS BOM_QTY,
	       SUM(A.STOCK_QTY ) AS QUANTITY,
	       SUM(XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST,
	       A.HSN_CODE ,A.PURCHASE_PRICE,
	       A.GST_PERCENTAGE,
	       SUM(IGST_AMOUNT) AS IGST_AMOUNT,
	       SUM(CGST_AMOUNT) AS CGST_AMOUNT,
	       SUM(SGST_AMOUNT) AS SGST_AMOUNT,
	       SUM(XN_VALUE_WITH_GST) AS XN_VALUE_WITH_GST,
	       SD.SUB_SECTION_NAME,
	       SM.SECTION_NAME,
	       UM.UOM_NAME,P1.PARA1_NAME,P2.PARA2_NAME, cast('' as varchar(100)) as DESIGN_NO,
	       @ADD AS AGENCY_ADDRESS,@AGENCY_NAME  AS AGENCY_NAME,@AGENCY_GST_NO AS AGENCY_GST_NO,
	       '' AS BUYER_REF_NO,'' AS ORDER_NO,'' AS ODRER_DT
	FROM BOM_ISSUE_DET A (NOLOCK)
	JOIN BOM_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID =B.ISSUE_ID
	JOIN SKU (NOLOCK) ON A.PRODUCT_CODE =SKU.PRODUCT_CODE
	JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
	JOIN SECTIOND SD WITH (NOLOCK) ON SD.SUB_SECTION_CODE=ART.SUB_SECTION_CODE 
	JOIN SECTIONM SM WITH (NOLOCK) ON SD.SECTION_CODE=SM.SECTION_CODE
	JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=SKU.PARA1_CODE 
	JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=SKU.PARA2_CODE    
	JOIN UOM UM WITH (NOLOCK) ON UM.UOM_CODE=ART.UOM_CODE 
	WHERE B.CANCELLED=0
	AND B.JOBWORK_ISSUE_ID=@CWHERE
	GROUP BY B.ISSUE_NO,B.ISSUE_DT, B.ISSUE_ID ,
	B.JOBWORK_ISSUE_ID ,ART.ARTICLE_NO,ART.ARTICLE_NAME,A.GST_PERCENTAGE,
	SD.SUB_SECTION_NAME,SM.SECTION_NAME,UM.UOM_NAME,A.HSN_CODE,P1.PARA1_NAME,P2.PARA2_NAME,A.PURCHASE_PRICE
	UNION ALL
	SELECT 'JWI' AS XN_TYPE, B.ISSUE_NO,B.ISSUE_DT, B.ISSUE_ID ,@EWAY_BILL_NO AS EWAY_BILL_NO,
	       B.ISSUE_ID AS JOBWORK_ISSUE_ID,
	       ART.ARTICLE_NO,ART.ARTICLE_NAME,
	       0 AS BOM_QTY,
	       SUM(A.QUANTITY) AS QUANTITY,
	       SUM(XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST,
	       A.HSN_CODE,A.PURCHASE_PRICE,
	       A.GST_PERCENTAGE,
	       SUM(IGST_AMOUNT) AS IGST_AMOUNT,
	       SUM(CGST_AMOUNT) AS CGST_AMOUNT,
	       SUM(SGST_AMOUNT) AS SGST_AMOUNT,
	       SUM(XN_VALUE_WITH_GST) AS XN_VALUE_WITH_GST,
	       SD.SUB_SECTION_NAME,
	       SM.SECTION_NAME,
	       UM.UOM_NAME,P1.PARA1_NAME,P2.PARA2_NAME, D3.DESIGN_NO , 
	       @ADD AS AGENCY_ADDRESS,@AGENCY_NAME  AS AGENCY_NAME,@AGENCY_GST_NO AS AGENCY_GST_NO,
	       ISNULL(REF.REF_NO,'') AS BUYER_REF_NO,
		   ORD.MEMO_NO AS Jobcard_NO,
		   ORD.MEMO_DT  AS Jobcard_DT
	FROM JOBWORK_ISSUE_DET A (NOLOCK)
	JOIN JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID =B.ISSUE_ID
	JOIN SKU (NOLOCK) ON A.PRODUCT_CODE =SKU.PRODUCT_CODE
	JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
	JOIN SECTIOND SD WITH (NOLOCK) ON SD.SUB_SECTION_CODE=ART.SUB_SECTION_CODE 
	JOIN SECTIONM SM WITH (NOLOCK) ON SD.SECTION_CODE=SM.SECTION_CODE
	JOIN UOM UM WITH (NOLOCK) ON UM.UOM_CODE=ART.UOM_CODE
	JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=SKU.PARA1_CODE 
	JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=SKU.PARA2_CODE    
	left JOIN designm d3 (NOLOCK) ON d3.design_code  =a.design_code 
	LEFT JOIN VW_BUYER_REF_NO REF WITH (NOLOCK) ON REF.PRODUCT_CODE=A.PRODUCT_CODE 
	join(
	
		SELECT D.MEMO_ID ,D.MEMO_NO ,d.MEMO_DT  ,A.PRODUCT_CODE 
		FROM JOBWORK_ISSUE_DET A
		JOIN ORD_PLAN_BARCODE_DET B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
		JOIN ORD_PLAN_DET C ON B.REFROW_ID =C.ROW_ID 
		JOIN ORD_PLAN_MST D ON C.MEMO_ID =D.MEMO_ID 
		WHERE D.CANCELLED =0 
		AND A.ISSUE_ID= @CWHERE

	) ord on ord.product_code =a.product_code
	WHERE B.CANCELLED=0
	AND B.ISSUE_ID=@CWHERE
	GROUP BY B.ISSUE_NO,B.ISSUE_DT, B.ISSUE_ID 
	,ART.ARTICLE_NO,ART.ARTICLE_NAME,A.GST_PERCENTAGE,A.HSN_CODE,A.PURCHASE_PRICE,
	SD.SUB_SECTION_NAME,SM.SECTION_NAME,UM.UOM_NAME,P1.PARA1_NAME,P2.PARA2_NAME,ISNULL(REF.REF_NO,''),d3.DESIGN_NO,
	ORD.MEMO_NO,ORD.MEMO_DT 
	
	
	
;WITH CTE AS
  (
   SELECT 'JWI' AS XN_TYPE, A.ISSUE_ID , A.PRODUCT_CODE ,A.QUANTITY,A.HSN_CODE ,A.GST_PERCENTAGE ,
   A.XN_VALUE_WITHOUT_GST ,A.XN_VALUE_WITH_GST ,
   A.IGST_AMOUNT ,A.CGST_AMOUNT ,A.SGST_AMOUNT  
   FROM JOBWORK_ISSUE_DET A (NOLOCK)
   JOIN JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID =B.ISSUE_ID 
   WHERE B.CANCELLED =0
   AND A.ISSUE_ID=@CWHERE
   UNION ALL
   SELECT 'BOM' AS XN_TYPE, JOBWORK_ISSUE_ID , A.PRODUCT_CODE ,A.QUANTITY,A.HSN_CODE ,
   A.GST_PERCENTAGE ,A.XN_VALUE_WITHOUT_GST ,A.XN_VALUE_WITH_GST  ,
   A.IGST_AMOUNT ,A.CGST_AMOUNT ,A.SGST_AMOUNT 
   FROM BOM_ISSUE_DET A  (NOLOCK)
   JOIN BOM_ISSUE_MST B (NOLOCK)  ON A.ISSUE_ID=B.ISSUE_ID 
   WHERE B.CANCELLED=0 AND B.JOBWORK_ISSUE_ID=@CWHERE
  )
  
  SELECT A.XN_TYPE , C.ARTICLE_NO,C.HSN_CODE ,A.GST_PERCENTAGE ,
          SUM(ISNULL(A.XN_VALUE_WITHOUT_GST,0)) AS XN_VALUE_WITHOUT_GST,
          SUM(ISNULL(A.XN_VALUE_WITH_GST,0)) AS XN_VALUE_WITH_GST,
          SUM(ISNULL(A.IGST_AMOUNT,0)) AS IGST_AMOUNT,
          SUM(ISNULL(A.CGST_AMOUNT,0)) AS CGST_AMOUNT,
          SUM(ISNULL(A.SGST_AMOUNT,0)) AS SGST_AMOUNT
		  
  FROM CTE A 
  JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
  JOIN ARTICLE C (NOLOCK) ON B.ARTICLE_CODE=C.ARTICLE_CODE 
  GROUP BY A.XN_TYPE ,C.ARTICLE_NO,C.HSN_CODE ,A.GST_PERCENTAGE
  
  
	
END