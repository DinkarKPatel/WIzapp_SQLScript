CREATE PROCEDURE SP3S_MBO_PENDING_WSR_REPORT
(
	 @DTO_DATE DATETIME
	,@NMODE NUMERIC(1)=1
)
--WITH ENCRYPTION 
AS
BEGIN
	
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @NMODE=1
BEGIN
	SELECT BIN.BIN_NAME,LM.AC_NAME,A.CN_NO,CONVERT(VARCHAR(10),A.CN_DT,105) AS CN_DT,A.TOTAL_AMOUNT AS NET_AMOUNT
	FROM CNM01106 A
	JOIN BIN ON A.AC_CODE=BIN.MBO_LEDGER_AC_CODE
	JOIN LM01106 LM ON BIN.MBO_LEDGER_AC_CODE=LM.AC_CODE
	LEFT JOIN MBO_WSR_WSL_LINK C ON A.CN_ID=C.CN_ID
	WHERE A.CANCELLED=0 AND A.CN_TYPE=1 AND A.CN_DT<=@DTO_DATE AND A.MODE=3 AND C.CN_ID IS NULL	
	ORDER BY BIN.BIN_NAME,A.CN_DT,A.CN_NO
END
ELSE IF @NMODE=2
BEGIN
	SELECT BIN.BIN_NAME,LM.AC_NAME,A.CN_NO,CONVERT(VARCHAR(10),A.CN_DT,105) AS CN_DT,B.PRODUCT_CODE,B.QUANTITY,B.RATE
		  ,CONVERT(NUMERIC(18,2),(B.QUANTITY*B.RATE)) AS NET_AMOUNT
	FROM CNM01106 A
	JOIN CND01106 B ON A.CN_ID=B.CN_ID
	JOIN BIN ON A.AC_CODE=BIN.MBO_LEDGER_AC_CODE
	JOIN LM01106 LM ON BIN.MBO_LEDGER_AC_CODE=LM.AC_CODE
	LEFT JOIN MBO_WSR_WSL_LINK C ON A.CN_ID=C.CN_ID
	WHERE A.CANCELLED=0 AND A.CN_TYPE=1 AND A.CN_DT<=@DTO_DATE AND A.MODE=3 AND C.CN_ID IS NULL	
	ORDER BY BIN.BIN_NAME,A.CN_DT,A.CN_NO	
END

END
--END OF PROCEDURE - SP3S_MBO_PENDING_WSR_REPORT
