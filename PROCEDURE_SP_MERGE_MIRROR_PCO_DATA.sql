CREATE PROCEDURE SP_MERGE_MIRROR_PCO_DATA
(
    @CMEMOID VARCHAR(50)
   ,@CLOCID VARCHAR(2)
   ,@CSOURCEDB VARCHAR(200)
   ,@CMERGEDB VARCHAR(200)
   ,@BMSTINSERTONLY BIT
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
      DECLARE @DTSQL NVARCHAR(MAX),@CTMP_TABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(100),
      @CTABLESUFFIX VARCHAR(100),
      @CERRORMSG VARCHAR(MAX),@CSTEP VARCHAR(10),@CKEYFIELD  VARCHAR(50),@CTABLENAME VARCHAR(100),
      @CERRMSGOUT VARCHAR(500),@CCMD NVARCHAR(MAX),@CPARTY_DEPT_ID VARCHAR(10),@CHOLOCATIONID VARCHAR(10)
      
    BEGIN TRY	
      --SET @CSTEP = 10  
      --SET @CMERGEDB= DB_NAME()
      --SET @CERRORMSG=''   
      SET @CTABLESUFFIX=REPLACE(@CMEMOID,'-','_') 
	 
	 BEGIN TRANSACTION
	  --SET @CSOURCEDB=DB_NAME()+'_TEMP.DBO.'
	  SET @CTABLE_SUFFIX=REPLACE(@CMEMOID,'-','_')  
	   
	    SELECT @CHOLOCATIONID= VALUE FROM CONFIG WHERE  CONFIG_OPTION = 'HO_LOCATION_ID'
	    
	    SET @CSTEP = 20  
        SET @CTABLENAME='PCO_MST'  
        SET @CTMP_TABLENAME='TMP_PCO_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
        SET @CKEYFIELD='MEMO_ID'  
        
        
        SET @CSTEP=30
	    SET @CCMD = N'SELECT @CPARTY_DEPT_ID =  SUBSTRING(MEMO_NO,3,2) FROM '+@CSOURCEDB+@CTMP_TABLENAME+''
	    PRINT @CCMD
	    EXEC SP_EXECUTESQL @CCMD,N'@CPARTY_DEPT_ID VARCHAR(10) OUTPUT',@CPARTY_DEPT_ID OUTPUT		
		
		SET @CSTEP=40
        EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
         ,@BALWAYSUPDATE=1   
	
		IF(@CPARTY_DEPT_ID=@CHOLOCATIONID) 
		BEGIN
			SET @CSTEP=50 

			DELETE FROM docpco_pco_mst_upload WITH (ROWLOCk) WHERE memo_id=@CMEMOID		

			SET @CSTEP=55 
			INSERT docpco_pco_mst_upload	( amount, BANK_AC_CODE, cancelled, doc_synch_last_update, fin_year,
			HO_SYNCH_LAST_UPDATE, last_update, memo_dt, memo_id, memo_no,REMARKS,  TRANSFER_MODE, USER_CODE,location_Code,target_location_Code )  
			SELECT 	  amount, BANK_AC_CODE, cancelled, doc_synch_last_update, fin_year, HO_SYNCH_LAST_UPDATE, 
			last_update, memo_dt, memo_id, memo_no,REMARKS, TRANSFER_MODE, USER_CODE ,location_Code,target_location_Code
			FROM pco_mst (NOLOCK) WHERE memo_id=@CMEMOID


			SET @CSTEP=60
			PRINT 'SP_MERGE_MIRROR_DOCPCO_DATA START'+@CMEMOID+' '+@CLOCID+' '
			EXEC SP_MERGE_MIRROR_DOCPCO_DATA 
			@CMEMOID=@CMEMOID,
			@bHoLoc=1,
			@CERRMSG=@CERRMSG OUTPUT

		END
	 
		 IF ISNULL(@CERRMSGOUT,'')<>''  
		 BEGIN  
			  SET @CERRMSG='P:SP_MERGE_MIRROR_PCO_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+N''+@CERRMSGOUT+''''  
		 END 

END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP_MERGE_MIRROR_PCO_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
END CATCH
     
     

EXIT_PROC:
	 IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0  
     BEGIN  
		 COMMIT  
		 SET @CSTEP=70  
		 SET @CTMP_TABLENAME='TMP_PCO_'+@CTABLENAME+'_'+LTRIM(RTRIM(REPLACE(@CMEMOID,'-','_')))  
		 SET @DTSQL=N'IF OBJECT_ID('''+@CSOURCEDB+@CTMP_TABLENAME+''',''U'') IS NOT NULL    
					DROP TABLE '+@CSOURCEDB+''+@CTMP_TABLENAME+''  
		 PRINT @DTSQL      
		 EXEC SP_EXECUTESQL @DTSQL    
     END  
     ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0  
			ROLLBACK  

END
