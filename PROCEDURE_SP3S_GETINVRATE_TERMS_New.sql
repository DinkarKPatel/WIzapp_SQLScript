CREATE PROCEDURE SP3S_GETINVRATE_TERMS_NEW                  
	@NSPID INT,
	@CXNTYPE VARCHAR(10)='',
	@CERRORMSG VARCHAR(MAX) OUTPUT
AS                  
BEGIN                  
  
	DECLARE @BCREDITOUTPUTVAT BIT,@NINVTYPE INT,@BCREDITPURCHASETAX BIT,@NINVMODE INT,@CTARGETLOCID VARCHAR(5),@CSTEP VARCHAR(5)

BEGIN TRY	
	PRINT 'ENTER LEDGER TERMS PROC'
	
	SET @CSTEP=10
	IF @CXNTYPE='WSR'	
	BEGIN
		UPDATE WSL_INV_SETTINGS SET INV_TYPE=(CASE WHEN LOCAL_STATE_CODE=PARTY_STATE_CODE THEN 2 ELSE 1 END)
		WHERE SP_ID=@NSPID
	END
	
	SET @CSTEP=20
	UPDATE WSL_ITEM_DETAILS SET	RATE=MRP WHERE SP_ID=@NSPID	
	AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	
	SELECT TOP 1 @BCREDITOUTPUTVAT=REIMUBURSE_OUTPUT_VAT,@NINVTYPE=INV_TYPE,@BCREDITPURCHASETAX=REIMUBURSE_PURCHASE_TAX,@CTARGETLOCID=TARGET_LOCATION_ID
	FROM WSL_INV_SETTINGS WHERE SP_ID=@NSPID
	

	IF @BCREDITOUTPUTVAT=1
	BEGIN
		SET @CSTEP=30
		UPDATE A SET CREDIT_VAT_PERCENTAGE=(CASE WHEN A.MRP BETWEEN ISNULL(LSADD.MIN_MRP,0) AND ISNULL(LSADD.MAX_MRP,0)
		THEN LSADD.TAX_PERCENTAGE ELSE LS.TAX_PERCENTAGE END) FROM WSL_ITEM_DETAILS A
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
		JOIN ARTICLE B ON B.ARTICLE_CODE=SKU.ARTICLE_CODE
		JOIN LOCSST LS ON LS.SUB_SECTION_CODE=B.SUB_SECTION_CODE
		LEFT OUTER JOIN LOCSSTADD LSADD ON LSADD.LOCSST_ROW_ID=LS.ROW_ID
		JOIN WSL_INV_SETTINGS C ON A.SP_ID=C.SP_ID
		WHERE A.SP_ID=@NSPID AND LS.MEMO_ID=C.PARTY_LOCSST_MEMO_ID
		AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
		
		SET @CSTEP=40
		UPDATE A SET CREDIT_VAT_AMOUNT=(CASE WHEN INV_TYPE=1 THEN (100*CREDIT_VAT_PERCENTAGE)/(100+CREDIT_VAT_PERCENTAGE)
		ELSE  ISNULL(TERMS_DISC_PCT,0)*CREDIT_VAT_PERCENTAGE/100 END)	
		FROM WSL_ITEM_DETAILS A JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
		WHERE A.SP_ID=@NSPID 
		AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	END
	
	SET @CSTEP=50
	IF @NINVTYPE=1
		UPDATE WSL_ITEM_DETAILS SET CHARGE_TAX_PCT=B.TAX_PERCENTAGE FROM FORM B 
		WHERE B.FORM_ID=WSL_ITEM_DETAILS.ITEM_FORM_ID AND SP_ID=@NSPID 
		AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	ELSE
	BEGIN
		UPDATE A SET CHARGE_TAX_PCT=(CASE WHEN A.MRP BETWEEN ISNULL(LSADD.MIN_MRP,0) AND ISNULL(LSADD.MAX_MRP,0)
		THEN LSADD.TAX_PERCENTAGE ELSE LS.TAX_PERCENTAGE END) FROM WSL_ITEM_DETAILS A
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
		JOIN ARTICLE B ON B.ARTICLE_CODE=SKU.ARTICLE_CODE
		JOIN LOCSST LS ON LS.SUB_SECTION_CODE=B.SUB_SECTION_CODE
		LEFT OUTER JOIN LOCSSTADD LSADD ON LSADD.LOCSST_ROW_ID=LS.ROW_ID
		JOIN WSL_INV_SETTINGS C ON A.SP_ID=C.SP_ID
		WHERE A.SP_ID=@NSPID AND LS.MEMO_ID=C.PARTY_LOCSST_MEMO_ID
		AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	END		
	
	IF @BCREDITPURCHASETAX=1 
	BEGIN
		SET @CSTEP=60
		--- DESCARDED THIS BECAUSE OF PROBLEM COMING AT JASHN WS LOCATION FOR MAKING INVOICE FOR SIS LOCATION G8
		--- HAVING PROBLEM  IN INVOICE NO.: WSG8-16010
		--UPDATE WSL_ITEM_DETAILS SET CREDIT_CENTRAL_TAX_PCT=(CASE WHEN @NINVTYPE=2 THEN CREDIT_VAT_PERCENTAGE ELSE  
		--CHARGE_TAX_PCT END)	WHERE SP_ID=@NSPID
		
		PRINT 'ENTER CREDIT PURCHASE TAX CALC'
		UPDATE WSL_ITEM_DETAILS SET CREDIT_CENTRAL_TAX_PCT=CHARGE_TAX_PCT 	WHERE SP_ID=@NSPID
		AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
		
		--((100-(100*(@NTERMSDISCPER+@NCREDITLOCALVAT)/100))*@NCREDITCENTRALPCT/(100+@NCREDITCENTRALPCT))
		
		UPDATE A SET CREDIT_PURCHASE_TAX_PCT=((100-(100*(ISNULL(B.TERMS_DISC_PCT,0)+ISNULL(CREDIT_VAT_AMOUNT,0))
		/100))*CREDIT_CENTRAL_TAX_PCT/(100+CREDIT_CENTRAL_TAX_PCT)) 
		FROM WSL_ITEM_DETAILS A
		JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
		WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	END	
	ELSE
	BEGIN
		SET @CSTEP=70
		UPDATE WSL_ITEM_DETAILS SET CREDIT_PURCHASE_TAX_PCT=0 WHERE SP_ID=@NSPID
		AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	END	
	
	SET @CSTEP=80
	UPDATE A SET DISCOUNT_PERCENTAGE=ISNULL(TERMS_DISC_PCT,0)+ISNULL(CREDIT_VAT_AMOUNT,0)+ISNULL(CREDIT_PURCHASE_TAX_PCT,0)
	FROM WSL_ITEM_DETAILS A
	JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
	WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0

	SET @CSTEP=90
	UPDATE WSL_ITEM_DETAILS SET DISCOUNT_AMOUNT=(RATE * INVOICE_QUANTITY * DISCOUNT_PERCENTAGE) / 100
	WHERE SP_ID=@NSPID	AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0

	UPDATE WSL_ITEM_DETAILS SET NET_RATE=RATE-(RATE* DISCOUNT_PERCENTAGE/ 100)
	WHERE SP_ID=@NSPID	AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0

END TRY

BEGIN CATCH
	SET @CERRORMSG='PROCEDURE SP3S_GETINVRATE_TERMS_NEW STEP#'+@CSTEP+':'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:

END
