CREATE PROCEDURE SP3S_GETDATA_FOR_ALTERATION(@CMID VARCHAR(50))
AS 
BEGIN
	--DECLARE @CMID VARCHAR(50)='J10111800000J100-00001'
	DECLARE @LOC VARCHAR(10),@QTY FLOAT,@PROD VARCHAR(500),@SS VARCHAR(500)
	,@Q FLOAT, @cCMID VARCHAR(50),@cROW_ID VARCHAR(100),@cSUB_SECTION_CODE VARCHAR(50)
	,@nDISCOUNT_PERCENTAGE NUMERIC(14,3)
	
	IF OBJECT_ID('tempdb..#TEMP') IS NOT NULL DROP TABLE #TEMP

	SELECT CAST('' AS VARCHAR(5)) AS DEPT_ID,CAST(0 AS NUMERIC(14,2)) AS QUANTITY,
	CAST('' AS VARCHAR(100)) AS PRODUCT_CODE,CAST('' AS VARCHAR(500)) AS sub_section_NAME,
	CAST('' AS VARCHAR(20)) AS JOB_CODE,CAST('' AS VARCHAR(500)) AS CM_ID,
	CAST('' AS VARCHAR(500)) AS ROW_ID,CAST('' AS VARCHAR(500)) AS SUB_SECTION_CODE
	,CAST(0 AS NUMERIC(14,3)) AS DISCOUNT_PERCENTAGE
	INTO #TEMP
	WHERE 1=2

	DECLARE NMLZ CURSOR 
	FOR
	SELECT LEFT(M.cm_id,2) AS DEPT_ID,D.QUANTITY,D.PRODUCT_CODE,
	SD.sub_section_NAME,M.CM_ID,D.ROW_ID,SD.SUB_SECTION_CODE,D.DISCOUNT_PERCENTAGE
	FROM CMM01106 M (NOLOCK) 
	JOIN CMD01106 D (NOLOCK) ON M.cm_id=D.cm_id
	JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE=D.PRODUCT_CODE
	JOIN ARTICLE (NOLOCK) ON ARTICLE.article_code=S.article_code
	JOIN SECTIOND SD(NOLOCK) ON SD.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
	JOIN 
	( 
		SELECT DEPT_ID, sub_section_code FROM ALTERATIONSETUP (NOLOCK) GROUP BY DEPT_ID, sub_section_code
	)A ON A.sub_section_code=SD.SUB_SECTION_CODE and (a.dept_id=left(D.cm_id,2) OR ISNULL(A.dept_id,'')='')
	WHERE M.CANCELLED=0 AND M.cm_id=@CMID
	
	BEGIN TRY
		OPEN NMLZ
	END TRY
	BEGIN CATCH
		CLOSE NMLZ
		DEALLOCATE NMLZ
		OPEN NMLZ	
	END CATCH

	FETCH NEXT FROM NMLZ INTO @LOC,@QTY,@PROD,@SS,@cCMID ,@cROW_ID,@cSUB_SECTION_CODE,@nDISCOUNT_PERCENTAGE
	WHILE @@FETCH_STATUS=0
	BEGIN
	 SET @Q=@QTY
	 WHILE @Q>0
	   BEGIN
		  INSERT #TEMP(DEPT_ID,QUANTITY,PRODUCT_CODE,sub_section_NAME,JOB_CODE,CM_ID,ROW_ID,SUB_SECTION_CODE,DISCOUNT_PERCENTAGE) 
		  SELECT @LOC,1,@PROD,@SS,'',@cCMID ,@cROW_ID,@cSUB_SECTION_CODE,@nDISCOUNT_PERCENTAGE
		  SET @Q-=1
	   END
	 FETCH NEXT FROM NMLZ INTO @LOC,@QTY,@PROD,@SS,@cCMID ,@cROW_ID,@cSUB_SECTION_CODE,@nDISCOUNT_PERCENTAGE
	END
	CLOSE NMLZ
	DEALLOCATE NMLZ
	--SELECT ROW_NUMBER() OVER (PARTITION BY CM_ID,PRODUCT_CODE ORDER BY CM_ID,PRODUCT_CODE) AS SR_NO, T.*
	----CM_ID,COUNT(CM_ID)
	--FROM #TEMP T 
	--LEFT JOIN ALTERATIONSETUP S (NOLOCK) 
	--JOIN Sectiond SD (NOLOCK) ON SD.sub_section_code=S.SUB_SECTION_CODE
	--ON T.DEPT_ID=S.DEPT_ID AND T.SUB_SECTION_NAME=SD.SUB_SECTION_NAME
	--GROUP BY CM_ID
	--ORDER BY 2 DESC
	--INSERT CMM_ALTERATION	( CM_ID, PRODUCT_CODE, JOB_CODE, SYS_RATE, RATE, REMARKS, LAST_UPDATE, ROW_ID )  
	--SELECT CM_ID, PRODUCT_CODE, JOB_CODE, SYS_RATE, RATE,REMARKS, LAST_UPDATE,ROW_ID 
	--FROM
	--(
	--	SELECT ROW_NUMBER() OVER (PARTITION BY CM_ID,PRODUCT_CODE ORDER BY CM_ID,PRODUCT_CODE) AS SR_NO,	  
	--	CM_ID, PRODUCT_CODE,'DEF0004' JOB_CODE, 100 SYS_RATE, 50 RATE,'TESTING' REMARKS, GETDATE() LAST_UPDATE,NEWID() ROW_ID 
	--	FROM #TEMP
	--)X 
	--WHERE X.SR_NO=1

	;with saved_jobs
	AS
	(
		SELECT ROW_NUMBER() OVER (PARTITION BY CM_ID,PRODUCT_CODE ORDER BY CM_ID,PRODUCT_CODE) AS SR_NO, A.*
		FROM CMM_ALTERATION A(NOLOCK)
		--JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE=A.PRODUCT_CODE
		--JOIN ARTICLE (NOLOCK) ON ARTICLE.article_code=S.article_code
		--JOIN SECTIOND SD(NOLOCK) ON SD.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
		WHERE CM_ID=@cCMID
	)
	,Current_jobs
	AS
	(
		SELECT ROW_NUMBER() OVER (PARTITION BY CM_ID,PRODUCT_CODE ORDER BY CM_ID,PRODUCT_CODE) AS SR_NO, *
		FROM #TEMP  
	)
	SELECT CAST(1 AS BIT) AS CHK, A.SR_NO,A.CM_ID,A.PRODUCT_CODE,A.JOB_CODE,A.SYS_RATE,A.RATE,A.REMARKS,A.LAST_UPDATE,A.ROW_ID AS ROW_ID,B.sub_section_NAME,B.DISCOUNT_PERCENTAGE,B.SUB_SECTION_CODE
	FROM saved_jobs A
	JOIN Current_jobs B ON b.product_code=a.product_code AND b.CM_ID=A.CM_ID AND A.SR_NO=B.sr_NO
	UNION ALL
	SELECT CAST(0 AS BIT) AS CHK,A.SR_NO,A.CM_ID,A.PRODUCT_CODE,'0000000' JOB_CODE,0 SYS_RATE,0 RATE,'' REMARKS,GETDATE() LAST_UPDATE,CONVERT(VARCHAR(100),NEWID()) AS ROW_ID,A.sub_section_NAME,A.DISCOUNT_PERCENTAGE,A.SUB_SECTION_CODE
	FROM  Current_jobs A
	LEFT OUTER JOIN saved_jobs  B ON b.product_code=a.product_code AND b.CM_ID=A.CM_ID AND A.SR_NO=B.SR_NO
	WHERE B.SR_NO IS NULL

END
