CREATE PROCEDURE SP3S_GET_COMPANY_FKEYDATA
@CLOCID VARCHAR(5),
@CERRORMSG VARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	BEGIN TRY
		DECLARE @CCMD NVARCHAR(MAX),@CTEMPTABLE VARCHAR(1000),@CTEMPTABLE1 VARCHAR(1000),@CTEMPTABLE2 VARCHAR(1000),
				@CTEMPTABLE3 VARCHAR(1000),@CTEMPTABLE4 VARCHAR(1000),@CTEMPTABLE5 VARCHAR(1000),
				@CKEYFIELDVAL VARCHAR(40),@CDESTDB VARCHAR(200),@CFILTERCONDITION VARCHAR(MAX),@NSTEP INT,
				@BPROCEED BIT
		
		SET @CDESTDB='WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.'
		
		SET @NSTEP=10		
		
		SET @CCMD=N'IF NOT EXISTS (SELECT TOP 1 * FROM '+@CDESTDB+'COMPANY)
						SET @BPROCEED=1
					ELSE
						SET @BPROCEED=0'
		EXEC SP_EXECUTESQL @CCMD,N'@BPROCEED BIT OUTPUT',@BPROCEED OUTPUT
		
		IF @BPROCEED=0
			GOTO END_PROC
		
		IF OBJECT_ID('TEMPDB..#TMPMISSINGAREADATA','U') IS NOT NULL
			DROP TABLE #TMPMISSINGAREADATA
		
		SET @NSTEP=20
								
		SELECT DISTINCT AREA_CODE INTO #TMPMISSINGAREADATA FROM COMPANY

		IF EXISTS (SELECT TOP 1 AREA_CODE FROM #TMPMISSINGAREADATA)
		BEGIN
			SET @NSTEP=30
			EXEC SP3S_GET_AREA_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGAREADATA',
			@CSOURCEKEYFIELD='AREA_CODE',
			@CXNTYPE='',
			@CTABLESUFFIX='',
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT
		END	
		
		SET @NSTEP=40
		PRINT 'INSERT COMPANY'
		
		EXEC UPDATEMASTERXN
		@CSOURCEDB='',
		@CSOURCETABLE='COMPANY',
		@CDESTDB=@CDESTDB,
		@CDESTTABLE='COMPANY',
		@CKEYFIELD1='COMPANY_CODE',
		@LINSERTONLY=0,
		@CFILTERCONDITION='',
		
		
		@LUPDATEONLY=0,
		@BALWAYSUPDATE=1
							
		GOTO END_PROC									
	END TRY
	
	BEGIN CATCH
		SELECT @CERRORMSG='PROCEDURE SP3S_GET_COMPANY_FKEYDATA : '+ISNULL(ERROR_PROCEDURE(),'NULL P')+'STEP :'+STR(ISNULL(@NSTEP,0))+ ' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		GOTO END_PROC
	END CATCH
	
END_PROC:
		
END
----'END OF PROCEDURE SP3S_GET_COMPANY_FKEYDATA'
