CREATE PROCEDURE CREATEBACKUPINFO
(
	 @CDATABASENAME VARCHAR(1000)
	,@CERRORMSG VARCHAR(MAX)
	,@CBACKUP_TYPE CHAR(1)
)	
--WITH ENCRYPTION
AS 
BEGIN
	DECLARE @CCMD NVARCHAR(MAX)
		IF OBJECT_ID('MASTER..BACKUP_INFO','U') IS NULL
	BEGIN
		CREATE TABLE MASTER..BACKUP_INFO 
		(
			 BACKUP_SET_ID INT
			,PHYSICAL_DEVICE_NAME NVARCHAR(520)
			,TYPE CHAR(1)
			,DATABASE_NAME NVARCHAR(256)
			,ERROR_MSG VARCHAR(MAX)
			,LAST_UPDATE DATETIME
		)
	END
	ELSE
	BEGIN
		IF NOT EXISTS(SELECT NAME FROM  MASTER..SYSCOLUMNS WHERE NAME= 'ERROR_MSG' AND ID=OBJECT_ID('MASTER..BACKUP_INFO','U'))
			ALTER TABLE MASTER..BACKUP_INFO ADD ERROR_MSG VARCHAR(MAX)
		IF NOT EXISTS(SELECT NAME FROM  MASTER..SYSCOLUMNS WHERE NAME= 'LAST_UPDATE' AND ID=OBJECT_ID('MASTER..BACKUP_INFO','U'))
			ALTER TABLE MASTER..BACKUP_INFO ADD LAST_UPDATE DATETIME
	END
	IF ISNULL(@CERRORMSG,'')=''
	BEGIN	
		DELETE FROM MASTER..BACKUP_INFO WHERE DATABASE_NAME=@CDATABASENAME
		
		SET @CCMD=N'INSERT MASTER..BACKUP_INFO	( BACKUP_SET_ID, PHYSICAL_DEVICE_NAME, TYPE, DATABASE_NAME,ERROR_MSG,LAST_UPDATE )  
		SELECT B.BACKUP_SET_ID,M.PHYSICAL_DEVICE_NAME,B.TYPE,B.DATABASE_NAME,'''',B.BACKUP_FINISH_DATE
		FROM MSDB.DBO.BACKUPSET B
		JOIN MSDB.DBO.BACKUPMEDIAFAMILY M ON B.MEDIA_SET_ID = M.MEDIA_SET_ID
		WHERE B.DATABASE_NAME='''+@CDATABASENAME+''' AND B.BACKUP_SET_ID >=
		(SELECT MAX(BACKUP_SET_ID) AS BACKUP_SET_ID FROM MSDB..BACKUPSET WHERE DATABASE_NAME='''+@CDATABASENAME+''' AND TYPE=''D'')'
		EXEC SP_EXECUTESQL @CCMD	
	END
	ELSE
	BEGIN
		SET @CCMD=N'INSERT MASTER..BACKUP_INFO(BACKUP_SET_ID, PHYSICAL_DEVICE_NAME, TYPE, DATABASE_NAME,ERROR_MSG,LAST_UPDATE )  
		SELECT NULL,'''','''+@CBACKUP_TYPE+''','''+@CDATABASENAME+''','''+@CERRORMSG+''',GETDATE()'
		EXEC SP_EXECUTESQL @CCMD
	END
END
