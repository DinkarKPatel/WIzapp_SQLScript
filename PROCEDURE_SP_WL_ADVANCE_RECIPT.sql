CREATE PROCEDURE SP_WL_ADVANCE_RECIPT--(LocId 3 digit change only increased the parameter width by Sanjay:01-11-2024)
(
	@CQUERYID		NUMERIC(2),
	@CWHERE			VARCHAR(100)='',
	@CFINYEAR		VARCHAR(5)='',
	@CDEPTID		VARCHAR(4)='',
	@NNAVMODE		NUMERIC(2)=1,
	@CWIZAPPUSERCODE VARCHAR(10)='',
	@CREFMEMOID VARCHAR(40)='',
	@CREFMEMODT DATETIME='',
	@CPARTYACCODE CHAR(10)=''
)
AS
BEGIN
DECLARE @CCMD NVARCHAR(MAX)
SET @CCMD=''
    IF @CQUERYID=1
		GOTO LBLARCLU
	ELSE IF @CQUERYID=2
		GOTO LBLARC01106
	ELSE IF @CQUERYID=3
		GOTO LBLCUSTOMER
	ELSE IF @CQUERYID=4
		GOTO LBLPAYMENTDETAILS
    ELSE IF @CQUERYID=5  
		GOTO LBLEMPLOYEE  
	ELSE IF @CQUERYID=6  
		GOTO LBLCREDIAMOUNT
	ELSE IF @CQUERYID = 7
		GOTO LBLAGNSTMEMO
	ELSE IF @CQUERYID = 8
		GOTO LBLLEDGER
		ELSE IF @CQUERYID = 9
		GOTO CMM_CREDIT_RECEIPT
	ELSE IF @CQUERYID = 10
		GOTO LBLLISTOFPEMDINGBILLS
	ELSE IF @CQUERYID = 11
		GOTO LBLCUSTLIST
	ELSE IF @CQUERYID = 12
		GOTO LBLGVDETAILS	
	ELSE   
		GOTO LAST  

	
		
LBLARCLU:
		EXEC SP_NAVIGATE	@CTABLENAME ='ARC01106',
							@NNAVMODE=@NNAVMODE,
							@CMEMONO=@CREFMEMOID,
							@CFINYEAR=@CFINYEAR,
							@CMEMONOCOL='ADV_REC_NO',
							@CMEMODTCOL='ADV_REC_DT',
							@CMEMOIDCOL='ADV_REC_ID',
							@CWHERECLAUSE=@CWHERE
		GOTO LAST
LBLARC01106:
		SELECT A.*,B.*,'' AS CUSTOMER_NAME,C.USERNAME,'' AS ADDRESS,
		ISNULL(ST.STATE,'') AS [STATE],ISNULL(AR.AREA_NAME,'') AS  AREA,
  		ISNULL(CI.CITY,'') AS CITY,ISNULL(AR.PINCODE,'') AS PINCODE,E.EMP_NAME ,C1.USERNAME AS [EDT_USER_NAME]
  		,LM.AC_NAME ,LM.STATE AS AC_STATE,LM.AREA_NAME AS AC_AREA,LM.CITY AS AC_CITY,LM.PINCODE AS AC_PIN,
  		 LM.ADDRESS0 + ' ' + LM.ADDRESS1 + ' ' + LM.ADDRESS2 + ' ' + LM.AREA_NAME + ' ' + LM.CITY + ' ' +  LM.STATE + ' ' + LM.MOBILE + ' ' AS AC_ADDRESS,
  		BM.CARD_NAME AS  DISCOUNTED_CARD_TYPE,GST.GST_STATE_NAME AS PARTY_STATE_NAME
		FROM ARC01106 A (NOLOCK) 
		JOIN CUSTDYM B (NOLOCK) ON B.CUSTOMER_CODE=A.CUSTOMER_CODE 
		JOIN LMV01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE
		LEFT OUTER JOIN AREA AR (NOLOCK) ON AR.AREA_CODE=B.AREA_CODE
		LEFT OUTER JOIN CITY CI (NOLOCK) ON CI.CITY_CODE=AR.CITY_CODE
		LEFT OUTER JOIN STATE ST (NOLOCK) ON ST.STATE_CODE=CI.STATE_CODE
		LEFT OUTER JOIN USERS C (NOLOCK) ON C.USER_CODE=A.USER_CODE
		LEFT OUTER JOIN USERS C1 (NOLOCK) ON C1.USER_CODE=A.EDT_USER_CODE  
		LEFT OUTER JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE=A.EMP_CODE
		LEFT OUTER JOIN BWD_MST BM (NOLOCK) ON BM.MEMO_ID=B.CARD_CODE
		LEFT OUTER JOIN GST_STATE_MST GST (NOLOCK) ON A.PARTY_STATE_CODE=GST.GST_STATE_CODE
		WHERE  A.ADV_REC_ID=@CWHERE
        GOTO LAST
LBLCUSTOMER:
		DECLARE @CCUSCODE VARCHAR(20)
		SELECT @CCUSCODE=CUSTOMER_CODE FROM CUSTDYM WHERE CUSTOMER_CODE<>'000000000000' AND USER_CUSTOMER_CODE=@CWHERE 
	    IF(ISNULL(@CCUSCODE,'')='')
			SELECT CUSTOMER_CODE, USER_CUSTOMER_CODE, CUSTOMER_TITLE, CUSTOMER_FNAME, CUSTOMER_LNAME, 
  			ISNULL(ST.STATE,'') AS [STATE],ADDRESS1, ADDRESS2,ISNULL(AR.AREA_NAME,'') AS  AREA,
  			ISNULL(CI.CITY,'') AS CITY,ISNULL(AR.PINCODE,'') AS PINCODE, PHONE1, 
			PHONE2, MOBILE, EMAIL
			FROM CUSTDYM A (NOLOCK)
			LEFT OUTER JOIN AREA AR (NOLOCK) ON AR.AREA_CODE=A.AREA_CODE
			LEFT OUTER JOIN CITY CI (NOLOCK) ON CI.CITY_CODE=AR.CITY_CODE
			LEFT OUTER JOIN STATE ST (NOLOCK) ON ST.STATE_CODE=CI.STATE_CODE
			WHERE A.INACTIVE=0 AND CUSTOMER_CODE<>'000000000000' AND 
			(USER_CUSTOMER_CODE LIKE @CWHERE+'%' OR CUSTOMER_FNAME LIKE @CWHERE+'%' OR CUSTOMER_LNAME LIKE @CWHERE+'%' OR
			MOBILE LIKE @CWHERE+'%' OR PHONE1 LIKE @CWHERE+'%' OR PHONE2 LIKE @CWHERE+'%' OR EMAIL LIKE @CWHERE+'%' )
		 ELSE
  			SELECT CUSTOMER_CODE, USER_CUSTOMER_CODE, CUSTOMER_TITLE, CUSTOMER_FNAME, CUSTOMER_LNAME, 
  			ISNULL(ST.STATE,'') AS [STATE],ADDRESS1, ADDRESS2,ISNULL(AR.AREA_NAME,'') AS  AREA,
  			ISNULL(CI.CITY,'') AS CITY,ISNULL(AR.PINCODE,'') AS PINCODE, PHONE1, 
			PHONE2, MOBILE, EMAIL
			FROM CUSTDYM A (NOLOCK)
			LEFT OUTER JOIN AREA AR (NOLOCK) ON AR.AREA_CODE=A.AREA_CODE
			LEFT OUTER JOIN CITY CI (NOLOCK) ON CI.CITY_CODE=AR.CITY_CODE
			LEFT OUTER JOIN STATE ST (NOLOCK) ON ST.STATE_CODE=CI.STATE_CODE
			WHERE A.INACTIVE=0 AND CUSTOMER_CODE=@CCUSCODE 
				
        GOTO LAST
LBLPAYMENTDETAILS:
		EXEC SP_PYMTDETAILS 1,'ARC',@CWHERE
		GOTO LAST

LBLEMPLOYEE:  
	SELECT EMP_CODE, EMP_NAME, EMP_NAME AS EMP_NAME_ORG,0 AS ALIASENTRY   
	FROM EMPLOYEE   
	WHERE INACTIVE = 0 AND EMP_TYPE IN (1,3)  
	UNION   
	SELECT EMP_CODE, EMP_ALIAS AS EMP_NAME, EMP_NAME AS EMP_NAME_ORG,1 AS ALIASENTRY    
	FROM EMPLOYEE   
	WHERE INACTIVE = 0 AND EMP_TYPE IN (1,3) AND EMP_ALIAS <>''  
	ORDER BY EMP_NAME   
	GOTO LAST     

LBLCREDIAMOUNT:
	   IF @CWHERE IN ('0000000000','000000000000') --- This is being called in Loading...Putting retun after 
			RETURN								   --- discussion with Sir (04-06-2020)	

   

			
	   IF ISNULL(@CPARTYACCODE,'')='' OR ISNULL(@CPARTYACCODE,'')='0000000000'
		BEGIN

			 DECLARE @CCUSTDETAILS TABLE(CUSTOMER_CODE VARCHAR(50),USER_CUSTOMER_CODE VARCHAR(50), MOBILE VARCHAR(50),CUSTOMER_NAME VARCHAR(1000))

			INSERT INTO @CCUSTDETAILS(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE,CUSTOMER_NAME)
			SELECT CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE,USER_CUSTOMER_CODE+'-'+ CUSTOMER_FNAME+' '+CUSTOMER_LNAME AS CUSTOMER_NAME
			FROM CUSTDYM (NOLOCK)
			WHERE CUSTOMER_CODE=@CWHERE 
			--AND ISNULL(BILL_BY_BILL,0)=1
	
			INSERT INTO @CCUSTDETAILS(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE,CUSTOMER_NAME)
			SELECT A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE,A.USER_CUSTOMER_CODE+'-'+ A.CUSTOMER_FNAME+' '+A.CUSTOMER_LNAME AS CUSTOMER_NAME
			FROM CUSTDYM A (NOLOCK)
			JOIN @CCUSTDETAILS B ON B.USER_CUSTOMER_CODE=A.USER_CUSTOMER_CODE
			WHERE B.CUSTOMER_CODE<>A.CUSTOMER_CODE
			--AND ISNULL(A.BILL_BY_BILL,0)=1
			AND ISNULL(B.USER_CUSTOMER_CODE,'') <>''

			INSERT INTO @CCUSTDETAILS(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE,CUSTOMER_NAME)
			SELECT A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE,A.USER_CUSTOMER_CODE+'-'+ A.CUSTOMER_FNAME+' '+A.CUSTOMER_LNAME AS CUSTOMER_NAME
			FROM CUSTDYM A (NOLOCK)
			JOIN @CCUSTDETAILS B ON B.MOBILE=A.MOBILE
			LEFT JOIN @CCUSTDETAILS C ON A.CUSTOMER_CODE =C.CUSTOMER_CODE 
			WHERE B.CUSTOMER_CODE<>A.CUSTOMER_CODE
			AND ISNULL(B.MOBILE,'') <>'' AND C.CUSTOMER_CODE IS NULL
			--AND ISNULL(A.BILL_BY_BILL,0)=1
			GROUP BY A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE,
			A.USER_CUSTOMER_CODE+'-'+ A.CUSTOMER_FNAME+' '+A.CUSTOMER_LNAME

			
			DECLARE  @TBLCREDIT TABLE (CUSTOMER_CODE VARCHAR(20),CUSTOMER_NAME VARCHAR(1000),CM_NO VARCHAR(15),CM_ID VARCHAR(40),
					 AMOUNT NUMERIC(14,2),CM_DT DATETIME)

			INSERT INTO @TBLCREDIT(CUSTOMER_CODE,CUSTOMER_NAME,CM_NO,CM_ID,AMOUNT,CM_DT)
			SELECT A.CUSTOMER_CODE,CUSTOMER_NAME,A.CM_NO,A.CM_ID,B.AMOUNT AS CREDIT_AMOUNT,A.CM_DT
			FROM CMM01106 A (NOLOCK)
			JOIN PAYMODE_XN_DET B (NOLOCK) ON B.MEMO_ID = A.CM_ID 
			JOIN @CCUSTDETAILS CUS ON A.CUSTOMER_CODE =CUS.CUSTOMER_CODE 
			WHERE A.CANCELLED=0 AND B.XN_TYPE = 'SLS' AND  B.PAYMODE_CODE='0000004'
			AND B.AMOUNT > 0 AND @CWHERE<>'0000000000'	


			 DECLARE  @TBLRECEIPTAMT TABLE (CM_ID VARCHAR(40),RECEIPT_AMOUNT NUMERIC(14,2),DISCOUNT_AMOUNT NUMERIC(14,2))

			 INSERT INTO @TBLRECEIPTAMT(CM_ID,RECEIPT_AMOUNT,DISCOUNT_AMOUNT)
			 SELECT A1.CM_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT],SUM(B2.DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT
			 FROM CMM_CREDIT_RECEIPT A1 (NOLOCK)
			 join @TBLCREDIT tmp on tmp.cm_id =a1.cm_id 
			 JOIN CMM01106 B1 (NOLOCK) ON B1.CM_ID=A1.CM_ID 
			 JOIN ARC01106 B2 (NOLOCK) ON B2.ADV_REC_ID=A1.ADV_REC_ID
			 WHERE (B1.CANCELLED=0 AND B2.CANCELLED=0) 
			 AND A1.ADV_REC_ID<>@CREFMEMOID
			 GROUP BY A1.CM_ID 

			 DECLARE  @TBLCURRENTRECEIPT TABLE (CM_ID VARCHAR(40),RECEIPT_AMOUNT NUMERIC(14,2))

			 INSERT INTO @TBLCURRENTRECEIPT(CM_ID,RECEIPT_AMOUNT)
			  SELECT A1.CM_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT]
			  FROM CMM_CREDIT_RECEIPT A1 (NOLOCK)
			  JOIN ARC01106 B1 (NOLOCK) ON B1.ADV_REC_ID=A1.ADV_REC_ID 
			  JOIN CMM01106 B2 (NOLOCK) ON B2.CM_ID=A1.CM_ID
			  WHERE B1.CANCELLED=0 AND B2.CANCELLED=0 
			  AND A1.ADV_REC_ID=@CREFMEMOID
			  GROUP BY A1.CM_ID 

			 DECLARE  @TBLREFUNDAMT TABLE (CM_ID VARCHAR(40),RECEIPT_AMOUNT NUMERIC(14,2))

			 INSERT INTO @TBLREFUNDAMT(CM_ID,RECEIPT_AMOUNT)
			  SELECT A.ADJ_MEMO_ID AS [CM_ID],SUM(ABS(ISNULL(A.AMOUNT,0))) AS RECEIPT_AMOUNT 
			  FROM PAYMODE_XN_DET  A (NOLOCK)
			  JOIN CMM01106 B (NOLOCK) ON B.CM_ID=A.MEMO_ID
			  JOIN CMM01106 C (NOLOCK) ON C.CM_ID=A.ADJ_MEMO_ID
			  JOIN @CCUSTDETAILS CUS ON B.CUSTOMER_CODE =CUS.CUSTOMER_CODE 
			  WHERE B.CANCELLED=0 AND C.CANCELLED=0 AND A.XN_TYPE='SLS'
			  AND A.PAYMODE_CODE='CMR0001'
			  GROUP BY A.ADJ_MEMO_ID

		   SELECT A.CUSTOMER_CODE,A.CUSTOMER_NAME,
				ISNULL(D1.RECEIPT_AMOUNT,0) AS PENDING,(A.AMOUNT-ISNULL(D.RECEIPT_AMOUNT,0)) AS PENDING_ORG,
				ISNULL(D.RECEIPT_AMOUNT,0)+ISNULL(D2.RECEIPT_AMOUNT,0) AS RECEIPT_AMOUNT, 
				A.CM_NO,CAST((CASE WHEN ISNULL(D1.RECEIPT_AMOUNT,0)<>0 THEN 1 ELSE 0 END) AS BIT) AS CHK,A.CM_ID,
				A.AMOUNT as credit_amount,A.CM_DT
            FROM @TBLCREDIT A
			LEFT JOIN @TBLRECEIPTAMT D ON D.CM_ID = A.CM_ID
			LEFT JOIN @TBLCURRENTRECEIPT D1 ON D1.CM_ID = A.CM_ID
		    LEFT JOIN @TBLREFUNDAMT D2 ON D2.CM_ID=A.CM_ID
			WHERE (A.AMOUNT-(ISNULL(D.RECEIPT_AMOUNT,0)+ISNULL(D2.RECEIPT_AMOUNT,0)) <> 0)
			




		/*

		 DECLARE @cCustDetails TABLE(CUSTOMER_CODE VARCHAR(50),USER_CUSTOMER_CODE VARCHAR(50), MOBILE VARCHAR(50))

		INSERT INTO @cCustDetails(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE)
		SELECT CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE
		FROM CUSTDYM
		WHERE CUSTOMER_CODE=@CWHERE 
	
		INSERT INTO @cCustDetails(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE)
		SELECT A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE
		FROM CUSTDYM A
		JOIN @cCustDetails B ON B.USER_CUSTOMER_CODE=A.user_customer_code
		WHERE B.CUSTOMER_CODE<>A.customer_code
		AND ISNULL(B.USER_CUSTOMER_CODE,'') <>''

		INSERT INTO @cCustDetails(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE)
		SELECT A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE
		FROM CUSTDYM A
		JOIN @cCustDetails B ON B.MOBILE=A.mobile
		left join @cCustDetails c on a.customer_code =c.CUSTOMER_CODE 
		WHERE B.CUSTOMER_CODE<>A.customer_code
		AND ISNULL(B.MOBILE,'') <>'' AND C.CUSTOMER_CODE IS NULL
		group by A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE

		

			SELECT A.CUSTOMER_CODE,C.USER_CUSTOMER_CODE+'-'+ C.CUSTOMER_FNAME+' '+C.CUSTOMER_LNAME AS CUSTOMER_NAME,
				ISNULL(D1.RECEIPT_AMOUNT,0) AS PENDING,(B.AMOUNT-ISNULL(D.RECEIPT_AMOUNT,0)) AS PENDING_ORG,
				ISNULL(D.RECEIPT_AMOUNT,0)+ISNULL(D2.RECEIPT_AMOUNT,0) AS RECEIPT_AMOUNT, 
				A.CM_NO,CAST((CASE WHEN ISNULL(D1.RECEIPT_AMOUNT,0)<>0 THEN 1 ELSE 0 END) AS BIT) AS CHK,A.CM_ID,
				B.AMOUNT as credit_amount,A.CM_DT
				FROM CMM01106 A (NOLOCK)
				JOIN paymode_xn_det B (NOLOCK) ON B.MEMO_ID = A.CM_ID 
				join @cCustDetails cus on a.CUSTOMER_CODE =cus.CUSTOMER_CODE 
				JOIN CUSTDYM C (NOLOCK) ON cus.CUSTOMER_CODE = C.CUSTOMER_CODE
    
				LEFT OUTER JOIN 
				( 
				 SELECT A1.CM_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT],SUM(B2.DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT
				 FROM CMM_CREDIT_RECEIPT A1 (NOLOCK)
				 JOIN CMM01106 B1 (NOLOCK) ON B1.CM_ID=A1.CM_ID 
				 JOIN ARC01106 B2 (NOLOCK) ON B2.ADV_REC_ID=A1.ADV_REC_ID
				 WHERE (B1.CANCELLED=0 AND B2.CANCELLED=0) 
				 AND A1.ADV_REC_ID<>@CREFMEMOID
				 GROUP BY A1.CM_ID 
				)D ON D.CM_ID = A.CM_ID
				LEFT OUTER JOIN 
				( 
				 SELECT A1.CM_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT]
				 FROM CMM_CREDIT_RECEIPT A1 (NOLOCK)
				 JOIN ARC01106 B1 (NOLOCK) ON B1.ADV_REC_ID=A1.ADV_REC_ID 
				 JOIN CMM01106 B2 (NOLOCK) ON B2.CM_ID=A1.CM_ID
				 WHERE B1.CANCELLED=0 AND B2.CANCELLED=0 AND A1.ADV_REC_ID=@CREFMEMOID
				 GROUP BY A1.CM_ID 
				)D1 ON D1.CM_ID = A.CM_ID
    
				LEFT OUTER JOIN
				 (
				  SELECT A.ADJ_MEMO_ID AS [CM_ID],SUM(ABS(ISNULL(A.AMOUNT,0))) AS RECEIPT_AMOUNT 
				  FROM PAYMODE_XN_DET  A (NOLOCK)
				  JOIN CMM01106 B (NOLOCK) ON B.CM_ID=A.MEMO_ID
				  JOIN CMM01106 C (NOLOCK) ON C.CM_ID=A.ADJ_MEMO_ID
				  join @cCustDetails cus on b.CUSTOMER_CODE =cus.CUSTOMER_CODE 
				  WHERE B.CANCELLED=0 AND C.CANCELLED=0 AND A.XN_TYPE='SLS'
				 -- AND  (B.CUSTOMER_CODE = @CWHERE OR B.AC_CODE =@CWHERE) 
				  AND A.PAYMODE_CODE='CMR0001'
				  GROUP BY A.ADJ_MEMO_ID
				 ) D2 ON D2.CM_ID=A.CM_ID
     
     
				WHERE A.CANCELLED=0 AND ISNULL(C.BILL_BY_BILL,0)=1 AND b.XN_TYPE = 'SLS' AND  b.paymode_code='0000004'
			  --  AND (A.CUSTOMER_CODE = @CWHERE  OR A.AC_CODE =@CWHERE)
				AND b.AMOUNT > 0 
				AND (B.AMOUNT-(ISNULL(D.RECEIPT_AMOUNT,0)+ISNULL(D2.RECEIPT_AMOUNT,0)) <> 0)
				and @CWHERE<>'0000000000'	

              */


				GOTO LAST
	END

	  IF ISNULL(@CPARTYACCODE,'')<>'' OR ISNULL(@CPARTYACCODE,'')<>'0000000000'
		BEGIN 
		
	  SELECT A.AC_CODE,C.AC_NAME AS CUSTOMER_NAME,
		ISNULL(D1.RECEIPT_AMOUNT,0) AS PENDING,(B.AMOUNT-ISNULL(D.RECEIPT_AMOUNT,0)) AS PENDING_ORG,
		ISNULL(D.RECEIPT_AMOUNT,0) AS RECEIPT_AMOUNT, 
		A.INV_NO AS CM_NO,CAST((CASE WHEN ISNULL(D1.RECEIPT_AMOUNT,0)<>0 THEN 1 ELSE 0 END) AS BIT) AS CHK,A.INV_ID AS CM_ID,
		B.AMOUNT,A.INV_DT AS CM_DT
		FROM INM01106 A (NOLOCK)
		JOIN paymode_xn_det B (NOLOCK) ON B.MEMO_ID = A.inv_ID 
		JOIN LM01106 C (NOLOCK) ON C.AC_CODE=A.AC_CODE  
		JOIN LMP01106 lmp (NOLOCK) ON lmp.AC_CODE=A.AC_CODE  
		LEFT OUTER JOIN 
		(	
			SELECT A1.INV_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT],SUM(B2.DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT
			FROM WSL_CREDIT_RECEIPT A1 (NOLOCK)
			JOIN INM01106 B1 (NOLOCK) ON B1.INV_ID=A1.INV_ID
			JOIN ARC01106 B2 (NOLOCK) ON B2.ADV_REC_ID=A1.ADV_REC_ID
			WHERE (B1.CANCELLED=0 AND B2.CANCELLED=0) 
			AND A1.ADV_REC_ID<>@CREFMEMOID
			GROUP BY A1.INV_ID 
		)D ON D.INV_ID = A.INV_ID
		LEFT OUTER JOIN 
		(	
			SELECT A1.INV_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT]
			FROM WSL_CREDIT_RECEIPT A1 (NOLOCK)
			JOIN ARC01106 B1 (NOLOCK) ON B1.ADV_REC_ID=A1.ADV_REC_ID 
			JOIN INM01106 B2 (NOLOCK) ON B2.INV_ID=A1.INV_ID
			WHERE B1.CANCELLED=0 AND B2.CANCELLED=0 AND A1.ADV_REC_ID=@CREFMEMOID
			GROUP BY A1.INV_ID 
		)D1 ON D1.INV_ID = A.INV_ID
		
		LEFT OUTER JOIN
		 (
			 SELECT A.ADJ_MEMO_ID AS [INV_ID],SUM(ABS(ISNULL(A.AMOUNT,0))) AS RECEIPT_AMOUNT 
			 FROM PAYMODE_XN_DET  A (NOLOCK)
			 JOIN CNM01106  B (NOLOCK) ON B.CN_ID=A.MEMO_ID
			 JOIN CNM01106 C (NOLOCK) ON C.CN_ID=A.ADJ_MEMO_ID
			 WHERE B.CANCELLED=0 AND C.CANCELLED=0 AND A.XN_TYPE='WSR'
			 AND  ( B.AC_CODE =@CPARTYACCODE) AND A.PAYMODE_CODE='CMR0001'
			 GROUP BY A.ADJ_MEMO_ID
		 ) D2 ON D2.INV_ID=A.INV_ID
		 
		 
		WHERE A.CANCELLED=0 --AND ISNULL(lmp.BILL_BY_BILL,0)=1  
		AND b.XN_TYPE = 'WSL' AND  b.paymode_code='0000004'
		 AND (A.AC_CODE = @CPARTYACCODE )
		AND b.amount > 0 
		AND (B.AMOUNT-(ISNULL(D.RECEIPT_AMOUNT,0)) <> 0)

		
		UNION ALL
		
		SELECT  A.AC_CODE,C.AC_NAME AS CUSTOMER_NAME,
				ISNULL(D1.RECEIPT_AMOUNT,0) AS PENDING,(B.AMOUNT-ISNULL(D.RECEIPT_AMOUNT,0)) AS PENDING_ORG,
				ISNULL(D.RECEIPT_AMOUNT,0)+ISNULL(D2.RECEIPT_AMOUNT,0) AS RECEIPT_AMOUNT, 
				A.CM_NO,CAST((CASE WHEN ISNULL(D1.RECEIPT_AMOUNT,0)<>0 THEN 1 ELSE 0 END) AS BIT) AS CHK,A.CM_ID,
				B.AMOUNT,A.CM_DT
				FROM CMM01106 A (NOLOCK)
				JOIN paymode_xn_det B (NOLOCK) ON B.MEMO_ID = A.CM_ID 
				JOIN LMV01106 C (NOLOCK) ON A.AC_CODE = C.AC_CODE
				LEFT OUTER JOIN 
				(	
					SELECT A1.CM_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT],SUM(B2.DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT
					FROM CMM_CREDIT_RECEIPT A1 (NOLOCK)
					JOIN CMM01106 B1 (NOLOCK) ON B1.CM_ID=A1.CM_ID 
					JOIN ARC01106 B2 (NOLOCK) ON B2.ADV_REC_ID=A1.ADV_REC_ID
					WHERE (B1.CANCELLED=0 AND B2.CANCELLED=0) 
					AND A1.ADV_REC_ID<>@CREFMEMOID
					GROUP BY A1.CM_ID 
				)D ON D.CM_ID = A.CM_ID
				LEFT OUTER JOIN 
				(	
					SELECT A1.CM_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT]
					FROM CMM_CREDIT_RECEIPT A1 (NOLOCK)
					JOIN ARC01106 B1 (NOLOCK) ON B1.ADV_REC_ID=A1.ADV_REC_ID 
					JOIN CMM01106 B2 (NOLOCK) ON B2.CM_ID=A1.CM_ID
					WHERE B1.CANCELLED=0 AND B2.CANCELLED=0 AND A1.ADV_REC_ID=@CREFMEMOID
					GROUP BY A1.CM_ID 
				)D1 ON D1.CM_ID = A.CM_ID
				
				LEFT OUTER JOIN
				 (
					 SELECT A.ADJ_MEMO_ID AS [CM_ID],SUM(ABS(ISNULL(A.AMOUNT,0))) AS RECEIPT_AMOUNT 
					 FROM PAYMODE_XN_DET  A (NOLOCK)
					  JOIN CMM01106 B (NOLOCK) ON B.CM_ID=A.MEMO_ID
					 JOIN CMM01106 C (NOLOCK) ON C.CM_ID=A.ADJ_MEMO_ID
					 WHERE B.CANCELLED=0 AND C.CANCELLED=0 AND A.XN_TYPE='SLS'
					 AND  ( B.AC_CODE =@CPARTYACCODE) AND A.PAYMODE_CODE='CMR0001'
					 GROUP BY A.ADJ_MEMO_ID
				 ) D2 ON D2.CM_ID=A.CM_ID
				 
				 
				WHERE A.CANCELLED=0 --AND ISNULL(C.BILL_BY_BILL,0)=1  
				AND b.XN_TYPE = 'SLS' AND  b.paymode_code='0000004' AND 
				( A.AC_CODE =@CPARTYACCODE)
				AND b.AMOUNT > 0 
				AND (B.AMOUNT-(ISNULL(D.RECEIPT_AMOUNT,0)+ISNULL(D2.RECEIPT_AMOUNT,0)) <> 0)
	GOTO LAST
 END	
	
--+ISNULL(D1.RECEIPT_AMOUNT,0)
LBLAGNSTMEMO:
 IF ISNULL(@CPARTYACCODE,'')='' OR ISNULL(@CPARTYACCODE,'')='0000000000'
		BEGIN

	SELECT A.*,UPPER(RTRIM(C.CM_NO))+'('+CONVERT(VARCHAR(50),C.CM_DT,105)+') Amt:'+cast(receipt_amount as varchar(50)) AS [CM_NO] 
	FROM CMM_CREDIT_RECEIPT A (NOLOCK)
	JOIN ARC01106 B (NOLOCK) ON B.ADV_REC_ID=A.ADV_REC_ID
	JOIN CMM01106 C (NOLOCK) ON C.CM_ID=A.CM_ID
	WHERE A.ADV_REC_ID = @CREFMEMOID
	END
	
	-- IF ISNULL(@CPARTYACCODE,'')<>'' AND ISNULL(@CPARTYACCODE,'')<>'0000000000'
	ELSE
	BEGIN

	SELECT A.*,UPPER(RTRIM(C.INV_NO))+'('+CONVERT(VARCHAR(50),C.INV_DT,105)+') Amt:'+cast(receipt_amount as varchar(50)) AS [CM_NO] 
	FROM WSL_CREDIT_RECEIPT A (NOLOCK)
	JOIN ARC01106 B (NOLOCK) ON B.ADV_REC_ID=A.ADV_REC_ID
	JOIN INM01106 C (NOLOCK) ON C.INV_ID=A.INV_ID
	WHERE A.ADV_REC_ID = @CREFMEMOID
	END
	GOTO LAST
	
	GOTO LAST
	
LBLLEDGER:

	--SELECT  A.AC_CODE, A.AC_NAME
	--, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,    
 --   ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE, A.CITY, A.ADDRESS0 + ' ' +    
 --   A.ADDRESS1 + ' ' + A.ADDRESS2 + ' ' + A.AREA_NAME + ' ' + A.CITY + ' ' +    
 --   A.STATE + ' ' + A.MOBILE + ' ' AS SUPP_ADDRESS, AC_NAME AS REPCOLNAME    
 --   FROM LMV01106 A (NOLOCK)           
 --   WHERE ( CHARINDEX ( HEAD_CODE, DBO.FN_ACT_TRAVTREE ('0000000018') ) > 0      
 --   OR ALLOW_CREDITOR_DEBTOR = 1 )           
 --   AND INACTIVE = 0 AND A.AC_CODE <> '0000000000' AND A.HEAD_CODE = '0000000018'    
    SELECT  AC_CODE, AC_NAME, '' AS SUPP_ADDRESS FROM LM01106 (NOLOCK)  WHERE 1=2
     
     
    
    GOTO LAST
CMM_CREDIT_RECEIPT:

    SELECT * FROM CMM_CREDIT_RECEIPT (NOLOCK) WHERE ADV_REC_ID=@CWHERE and receipt_amount > 0
    UNION
    SELECT * FROM WSL_CREDIT_RECEIPT (NOLOCK) WHERE ADV_REC_ID=@CWHERE and receipt_amount > 0
	GOTO LAST

LBLLISTOFPEMDINGBILLS:

	SELECT A.CUSTOMER_CODE,C.USER_CUSTOMER_CODE+'-'+ C.CUSTOMER_FNAME+' '+C.CUSTOMER_LNAME AS CUSTOMER_NAME,  
	ISNULL(D.RECEIPT_AMOUNT,0) AS PENDING,(B.AMOUNT-ISNULL(D.RECEIPT_AMOUNT,0)) AS PENDING_ORG,  
	ISNULL(D.RECEIPT_AMOUNT,0)+ISNULL(D2.RECEIPT_AMOUNT,0) AS RECEIPT_AMOUNT,   
	A.CM_NO,CAST((CASE WHEN ISNULL(D.RECEIPT_AMOUNT,0)<>0 THEN 1 ELSE 0 END) AS BIT) AS CHK,A.CM_ID,  
	B.AMOUNT as credit_amount,A.CM_DT  
	FROM CMM01106 A  (NOLOCK) 
	JOIN paymode_xn_det B (NOLOCK) ON B.MEMO_ID = A.CM_ID AND XN_TYPE = 'SLS'  
	JOIN CUSTDYM C (NOLOCK) ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
	LEFT OUTER JOIN   
	(   
		SELECT A1.CM_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT]  
		FROM CMM_CREDIT_RECEIPT A1  (NOLOCK) 
		JOIN CMM01106 B1 (NOLOCK) ON B1.CM_ID=A1.CM_ID   
		JOIN ARC01106 B2 (NOLOCK) ON B2.ADV_REC_ID=A1.ADV_REC_ID  
		WHERE (B1.CANCELLED=0 AND B2.CANCELLED=0)   
		--AND A1.ADV_REC_ID<>@CREFMEMOID  
		GROUP BY A1.CM_ID   
	)D ON D.CM_ID = A.CM_ID  
	LEFT OUTER JOIN  
	(  
		SELECT A.REF_CM_ID AS [CM_ID],SUM(ISNULL(CREDIT_REFUND_AMOUNT,0)) AS RECEIPT_AMOUNT   
		FROM CMR01106 A (NOLOCK)  
		JOIN CMM01106 B (NOLOCK) ON B.CM_ID=A.CM_ID  
		JOIN CMM01106 C (NOLOCK) ON C.CM_ID=A.REF_CM_ID  
		WHERE B.CANCELLED=0 AND C.CANCELLED=0  
		GROUP BY A.REF_CM_ID  
	) D2 ON D2.CM_ID=A.CM_ID  

	WHERE 1=2
	GOTO LAST
		
		
	LBLCUSTLIST:
	
	SELECT @CCUSCODE=CUSTOMER_CODE FROM CUSTDYM WHERE CUSTOMER_CODE<>'000000000000' AND USER_CUSTOMER_CODE=@CWHERE 
	IF(ISNULL(@CCUSCODE,'')='')
		SELECT CUSTOMER_CODE, USER_CUSTOMER_CODE, CUSTOMER_TITLE + ' ' + CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME AS CUSTOMER_NAME
		FROM CUSTDYM A (NOLOCK) 			
		WHERE INACTIVE=0 AND CUSTOMER_CODE<>'000000000000' AND 
		(USER_CUSTOMER_CODE LIKE @CWHERE+'%' OR CUSTOMER_FNAME LIKE @CWHERE+'%' OR CUSTOMER_LNAME LIKE @CWHERE+'%' OR
		MOBILE LIKE @CWHERE+'%' OR PHONE1 LIKE @CWHERE+'%' OR PHONE2 LIKE @CWHERE+'%' OR EMAIL LIKE @CWHERE+'%' )
	 ELSE
		SELECT CUSTOMER_CODE, USER_CUSTOMER_CODE, CUSTOMER_TITLE + ' ' + CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME AS CUSTOMER_NAME 
		FROM CUSTDYM A  (NOLOCK)
		WHERE INACTIVE=0 AND CUSTOMER_CODE=@CCUSCODE 
	
	
	GOTO LAST
	
	LBLGVDETAILS:
	
	SELECT *,CONVERT(VARCHAR(100),'') AS [GV_SCRATCH_NO] 
	,CAST('' AS VARCHAR(100)) AS CUSTOMER_CODE 
	,CAST('' AS VARCHAR(100)) AS USER_CUSTOMER_CODE
	,CAST('' AS VARCHAR(100)) AS MOBILE
	FROM ARC_GVSALE_DETAILS A (NOLOCK)
	JOIN SKU_GV_MST B (NOLOCK) ON B.GV_SRNO=A.GV_SRNO
	WHERE A.ADV_REC_ID=@CWHERE
	
	GOTO LAST
LAST:

END
