IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_RFNET_SLSWSL' AND VALUE=1)
AND OBJECT_ID('FN_GETRFNETVALUE','FN') IS NOT NULL
BEGIN

	PRINT 'UPDATING RFNET COLUMN IN SALE & WHOLESALE TABLES'
	

	IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_RFNET_SLSWSL')
		INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
			   VALUES ('UPDATE_RFNET_SLSWSL','1','',GETDATE())	
	ELSE
		UPDATE CONFIG SET VALUE='1' WHERE CONFIG_OPTION='UPDATE_RFNET_SLSWSL'

	UPDATE A SET RFNET =
	DBO.FN_GETRFNETVALUE(A.NET ,1 ,B.SUBTOTAL,- B.DISCOUNT_AMOUNT+B.ROUND_OFF)
	FROM CMD01106 A
	JOIN CMM01106 B ON A.CM_ID = B.CM_ID 
	
	DELETE FROM XNNOS
	
	INSERT XNNOS ( XN_TYPE,  XN_ID, SP_ID ) 
	SELECT 'SLS' AS XN_TYPE,A.CM_ID AS XN_ID,@@SPID AS SP_ID
	FROM CMM01106 A
	JOIN (SELECT CM_ID,SUM(RFNET) AS NET_AMOUNT FROM CMD01106 
		  GROUP BY CM_ID) B ON A.CM_ID=B.CM_ID	
	WHERE A.NET_AMOUNT<>B.NET_AMOUNT
	
	IF EXISTS (SELECT TOP 1 XN_ID FROM XNNOS WHERE XN_TYPE='SLS')
		EXEC UPDATERFNET 'SLS','',@@SPID
		
	UPDATE IND01106 SET RFNET =
		DBO.FN_GETRFNETVALUE( A.NET_RATE, A.QUANTITY, B.SUBTOTAL, ( ISNULL(C.EXCL_TAX,0) + B.FREIGHT + 
		B.OTHER_CHARGES + B.ROUND_OFF - B.DISCOUNT_AMOUNT+B.OCTROI_AMOUNT+B.INSURANCE+B.EXCISE_DUTY_AMOUNT+
		B.EXCISE_EDU_CESS_AMOUNT+B.EXCISE_HEDU_CESS_AMOUNT)),
		RFNET_WOTAX =
		DBO.FN_GETRFNETVALUE( A.NET_RATE, A.QUANTITY, B.SUBTOTAL-ISNULL(C.INCL_TAX,0) ,
		 (B.FREIGHT + B.OTHER_CHARGES + B.ROUND_OFF - B.DISCOUNT_AMOUNT+B.OCTROI_AMOUNT+B.INSURANCE ))				
	FROM IND01106 A
	JOIN INM01106 B ON A.INV_ID = B.INV_ID
	JOIN 
	(SELECT A.INV_ID,SUM(CASE WHEN BILL_LEVEL_TAX_METHOD=2 THEN ITEM_TAX_AMOUNT ELSE 0 END) AS INCL_TAX,
				   SUM(CASE WHEN BILL_LEVEL_TAX_METHOD<>2 THEN ITEM_TAX_AMOUNT ELSE 0 END) AS EXCL_TAX
	 FROM IND01106 A JOIN INM01106 B ON A.INV_ID=B.INV_ID GROUP BY A.INV_ID) C ON C.INV_ID=A.INV_ID			   
	
	DELETE FROM XNNOS
	
	INSERT XNNOS ( XN_TYPE,  XN_ID, SP_ID ) 
	SELECT 'WSL' AS XN_TYPE,A.INV_ID AS XN_ID,@@SPID AS SP_ID
	FROM INM01106 A
	JOIN (SELECT INV_ID,SUM(RFNET) AS NET_AMOUNT FROM IND01106 
		  GROUP BY INV_ID) B ON A.INV_ID=B.INV_ID	
	WHERE A.NET_AMOUNT<>B.NET_AMOUNT
	
	IF EXISTS (SELECT TOP 1 XN_ID FROM XNNOS WHERE XN_TYPE='WSL')
		EXEC UPDATERFNET 'WSL','',@@SPID	 
END

