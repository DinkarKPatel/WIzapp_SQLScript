CREATE PROCEDURE SPPPC_FG_ISSUE_BAROCDE  
(  
 @NQUERYID INT=0,  
 @CBILL_NO VARCHAR(50)='',  
 @CJOB_CODE CHAR(7) ='',  
 @CAGENCY_CODE VARCHAR(10)='',  
 @CPARA1_CODE VARCHAR(100)='',  
 @CSIZEGROUP_CODE VARCHAR(100)='',  
 @CMEMO_ID VARCHAR(50)='',
 @CPRODUCT_CODE VARCHAR(100)='' ,
 @NRETURN INT=0,
 @CAC_CODE VARCHAR(10)='',
 @CARTICLE_CODE VARCHAR(10)=''
  
)  
AS  
BEGIN  
   
 IF @NQUERYID=1  
    GOTO LBLAGENCY 
 ELSE IF @NQUERYID=2  
    GOTO LBLBILL_NO  
 ELSE IF @NQUERYID=3  
    GOTO LBLJOBS         
 ELSE IF @NQUERYID=4  
    GOTO LBLMST  
 ELSE IF @NQUERYID=5  
    GOTO LBLDET  
 ELSE IF @NQUERYID=6  
    GOTO LBLAGENCY_VIEW         
 ELSE IF @NQUERYID=7  
    GOTO LBLBILL_NO_VIEW  
 ELSE IF @NQUERYID=8  
    GOTO LBLMEMO_VIEW  
  ELSE IF @NQUERYID=9  
    GOTO LBLBUYER  
 ELSE IF @NQUERYID=10  
    GOTO LBLBARCODEPRINT     
 ELSE  
 GOTO END_PROC  
   
     
       LBLBUYER:
        
        SELECT A.AC_CODE,B.AC_NAME 
        FROM PPC_BUYER_ORDER_MST  A
        JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
        WHERE CANCELLED =0
        GROUP BY A.AC_CODE,B.AC_NAME
        
      GOTO END_PROC 
      
     LBLAGENCY:  
     
      SELECT A.AC_CODE,B.AC_NAME
      FROM PRD_AGENCY_MST A
      JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
    
    GOTO END_PROC 
      
    LBLBILL_NO:  
         
       SELECT BILL_NO AS ORDER_NO   
       FROM PPC_BUYER_ORDER_MST A  
       WHERE CANCELLED=0  
       AND (@CAC_CODE='' OR A.AC_CODE=@CAC_CODE)
       GROUP BY BILL_NO  
         
    GOTO END_PROC  
      
    LBLJOBS: --FOR FIRST TIME  
        
       SELECT  JOBS.JOB_CODE,JOBS.JOB_NAME ,J.JOB_ORDER  --+' -'+CAST(J.JOB_ORDER AS VARCHAR(10))  
       FROM PPC_BUYER_ORDER_MST A  
       JOIN PPC_BUYER_ORDER_DET B ON A.ORDER_ID =B.ORDER_ID   
       JOIN PPC_BO_ART_JOBS J ON B.ROW_ID =J.REF_ROW_ID AND JOB_ORDER>1  
       JOIN ARTICLE  ART ON ART.ARTICLE_CODE=B.ARTICLE_CODE  
       JOIN JOBS ON JOBS.JOB_CODE=J.JOB_CODE  
       WHERE  (@CBILL_NO ='' OR A.BILL_NO =@CBILL_NO )  
       GROUP BY J.JOB_ORDER   ,JOBS.JOB_CODE,JOBS.JOB_NAME  
          
    GOTO END_PROC  
      
  
    LBLMST:  
         
       SELECT  A.MEMO_ID,A.MEMO_NO,CONVERT(VARCHAR,A.MEMO_DT,105) AS MEMO_DT,
              A.LAST_UPDATE,JOBS.JOB_NAME,  
              CASE WHEN A.MEMO_TYPE=1 THEN 'REGULAR' ELSE 'RETURN' END AS MEMO_TYPE,
              A.AC_CODE,LM.AC_NAME,MST.BILL_NO,A.FIN_YEAR,A.CANCELLED,A.APPROVED,
              LM1.AC_NAME AS BUYER_NAME,
              CAST(SUM(B.QUANTITY) AS NUMERIC(10,0)) AS TOTAL_QTY,
              C.LOGO_PATH,
             'GST NO: '+ISNULL(C.GST_NO,'')  AS GST_NO,
             'GST NO: '+ISNULL(LMP.AC_GST_NO,'')  AS AC_GST_NO,
             ISNULL(A.APPROVED,0) AS APPROVED,
             A.CANCELLED 
       FROM  PPC_AGENCY_ISSUE_FG_MST A  
       JOIN  PPC_AGENCY_ISSUE_FG_DET B ON A.MEMO_ID=B.MEMO_ID
       JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE 
       JOIN LMP01106 LMP ON LMP.AC_CODE=LM.AC_CODE 
       JOIN
       (
        SELECT A.PRODUCT_CODE,MST.BILL_NO ,MST.AC_CODE
        FROM PPC_FG_SKU A
        JOIN PPC_FGBCG_DET B ON A.PPC_FGBCG_DET_ROW_ID=B.ROW_ID
        JOIN PPC_FGBCG_MST C ON C.MEMO_ID=B.MEMO_ID
        JOIN PPC_BUYER_ORDER_DET DET ON DET.ROW_ID=B.BO_DET_ROW_ID
        JOIN PPC_BUYER_ORDER_MST MST ON MST.ORDER_ID=DET.ORDER_ID
        GROUP BY A.PRODUCT_CODE,MST.BILL_NO,MST.AC_CODE
       ) MST ON MST.PRODUCT_CODE=B.PRODUCT_CODE
       JOIN LM01106 LM1 ON LM1.AC_CODE=MST.AC_CODE 
       JOIN JOBS  ON JOBS.JOB_CODE=A.JOB_CODE
       JOIN COMPANY C ON C.COMPANY_CODE='01'
       WHERE  (@CMEMO_ID ='' OR A.MEMO_ID =@CMEMO_ID ) 
       AND (@CBILL_NO ='' OR A.BILL_NO =@CBILL_NO )  
       AND (@CAGENCY_CODE='' OR A.AC_CODE=@CAGENCY_CODE)  
       GROUP BY A.MEMO_ID,A.MEMO_NO,CONVERT(VARCHAR,A.MEMO_DT,105) ,
       A.LAST_UPDATE,JOBS.JOB_NAME,  
       CASE WHEN A.MEMO_TYPE=1 THEN 'REGULAR' ELSE 'RETURN' END ,
       A.AC_CODE,LM.AC_NAME,MST.BILL_NO,A.FIN_YEAR,A.CANCELLED,A.APPROVED,
       LM1.AC_NAME ,C.LOGO_PATH, 'GST NO: '+ISNULL(C.GST_NO,'') ,
       'GST NO: '+ISNULL(LMP.AC_GST_NO,''),ISNULL(A.APPROVED,0) ,A.CANCELLED 
       
    GOTO END_PROC  
      
      
    LBLDET:  
         
         IF @CMEMO_ID=''
         BEGIN
             IF @NRETURN=1
             BEGIN
			 SELECT CAST(1 AS BIT) AS CHK,
				   CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
				   ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
				   A.AC_CODE,LM.AC_NAME ,
				   DET.BILL_NO,
				   DET.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
				   B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				   B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
				   B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
				   SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
				   PR.JOB_CODE,
				   PR.JOB_NAME,
				   PR.PRODUCT_CODE,
				   PMT.QUANTITY_IN_STOCK AS QUANTITY
				FROM PPC_FGBCG_MST A
				JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
				JOIN
				(
				  SELECT  B.AC_CODE,A.ARTICLE_CODE ,
					ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
					JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
					WHERE B.CANCELLED=0
				  GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
				) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
			    JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID
			    JOIN PPC_FG_PMT PMT ON SKU.PRODUCT_CODE =PMT.PRODUCT_CODE  
				JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
				JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
				JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
				JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
				JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
				JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
				JOIN
				(
					SELECT JOBS.JOB_CODE,JOBS.JOB_NAME,
					B.MEMO_ID,B.MEMO_NO,B.MEMO_DT, PRODUCT_CODE,QUANTITY AS QUANTITY
					FROM PPC_AGENCY_ISSUE_FG_FIRST_DET  A
					JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID 
					JOIN JOBS  ON B.JOB_CODE=JOBS.JOB_CODE
					WHERE B.CANCELLED=0
					AND A.PRODUCT_CODE=@CPRODUCT_CODE
				) PR ON PR.PRODUCT_CODE =PMT.PRODUCT_CODE	
				AND A.CANCELLED=0
				AND (@CBILL_NO='' OR DET.BILL_NO=@CBILL_NO)
				WHERE PMT.QUANTITY_IN_STOCK>0
		    END
		    ELSE
		    BEGIN
		        
		        SELECT CAST(1 AS BIT) AS CHK,
				   CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
				   ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
				   A.AC_CODE,A.AC_NAME ,
				   A.BILL_NO,
				   A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,
				   A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,
				   A.PARA1_CODE,A.PARA1_NAME AS COLOR,
				   A.PARA3_CODE,A.PARA3_NAME BUYER_STYLE_NO,
				   A.PARA2_CODE,A.PARA2_NAME SIZE,
				   A.JOB_CODE,
				   A.JOB_NAME,
				   A.PRODUCT_CODE,
				   A.ISSUE_QTY AS QUANTITY
				FROM
				(
				SELECT SKU.ARTICLE_CODE , C.BILL_NO, A.AC_CODE , SKU.PRODUCT_CODE ,
				LM.AC_NAME ,ART.ARTICLE_NO,ART.ARTICLE_NAME,SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				P1.PARA1_CODE,P1.PARA1_NAME, 
				P2.PARA2_CODE,P2.PARA2_NAME,
				P3.PARA3_CODE,P3.PARA3_NAME,
				J1.JOB_CODE,J1.JOB_NAME ,    
				SUM(C.ISSUE_QTY) AS ISSUE_QTY
				FROM PPC_FGBCG_MST A
				JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
				JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
				JOIN
				(
					SELECT  B.BILL_NO, B.AC_CODE , B.JOB_CODE, PRODUCT_CODE,
						   SUM(A.QUANTITY)   AS ISSUE_QTY
					FROM PPC_AGENCY_REC_FG_DET  A
					JOIN PPC_AGENCY_REC_FG_MST  B ON A.MEMO_ID =B.MEMO_ID 
					WHERE B.CANCELLED=0 AND ISNULL(MEMO_TYPE,0)=2
					AND B.AC_CODE=@CAGENCY_CODE
					AND (@CBILL_NO='' OR B.BILL_NO=@CBILL_NO)
					GROUP BY  B.JOB_CODE, B.BILL_NO, B.AC_CODE , B.JOB_CODE, PRODUCT_CODE
				) C ON SKU.PRODUCT_CODE=C.PRODUCT_CODE
				JOIN PPC_BO_ART_JOBS JOBS ON JOBS .REF_ROW_ID=B.BO_DET_ROW_ID  AND JOBS.JOB_CODE =C.JOB_CODE
				JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE 
				JOIN ARTICLE ART ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
				JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE=SKU.SIZEGROUP_CODE
				JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
				JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
				JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
				JOIN JOBS J1 ON J1.JOB_CODE=J1.JOB_CODE
				WHERE JOB_ORDER>1
				AND A.CANCELLED =0
				GROUP BY SKU.ARTICLE_CODE , C.BILL_NO, A.AC_CODE , SKU.PRODUCT_CODE ,
				LM.AC_NAME ,ART.ARTICLE_NO,ART.ARTICLE_NAME,SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				P1.PARA1_CODE,P1.PARA1_NAME, 
				P2.PARA2_CODE,P2.PARA2_NAME,
				P3.PARA3_CODE,P3.PARA3_NAME,
				J1.JOB_CODE,J1.JOB_NAME  
				) A
				LEFT JOIN
				(
				 SELECT PRODUCT_CODE,B.JOB_CODE,
						SUM(QUANTITY ) AS RE_ISS_QTY
				 FROM PPC_AGENCY_ISSUE_FG_DET A
				 JOIN PPC_AGENCY_ISSUE_FG_MST B ON A.MEMO_ID =B.MEMO_ID 
				 WHERE B.CANCELLED =0 AND ISNULL(MEMO_TYPE,0)=2
				 AND (@CBILL_NO='' OR B.BILL_NO=@CBILL_NO)
				 AND B.AC_CODE=@CAGENCY_CODE
				 GROUP BY PRODUCT_CODE,B.JOB_CODE
				) B ON A.PRODUCT_CODE=B.PRODUCT_CODE AND A.JOB_CODE=B.JOB_CODE 
				JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=A.PRODUCT_CODE
				WHERE A.PRODUCT_CODE=@CPRODUCT_CODE AND PMT.QUANTITY_IN_STOCK >0
				AND ISNULL(ISSUE_QTY,0)-ISNULL(RE_ISS_QTY,0)>0
		    
		    END
           END 
           ELSE
           BEGIN
               
                SELECT CAST(1 AS BIT) AS CHK,
				   PR.MEMO_ID AS MEMO_ID,
				   ROW_ID=PR.ROW_ID,
				   A.AC_CODE,LM.AC_NAME ,
				   DET.BILL_NO,
				   DET.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
				   B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				   B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
				   B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
				   SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
				   PR.JOB_CODE,
				   PR.JOB_NAME,
				   PR.PRODUCT_CODE,
				   PR.QUANTITY AS QUANTITY
				FROM PPC_FGBCG_MST A
				JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
				JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
				JOIN
				(
				  SELECT  B.AC_CODE,A.ARTICLE_CODE ,
					ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
					JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
					WHERE B.CANCELLED=0
				  GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
				) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
				JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
				JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
				JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
				JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
				JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
				JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
				JOIN
				(
					SELECT JOBS.JOB_CODE,JOBS.JOB_NAME,A.ROW_ID,
					B.MEMO_ID,B.MEMO_NO,B.MEMO_DT, PRODUCT_CODE,QUANTITY AS QUANTITY
					FROM PPC_AGENCY_ISSUE_FG_DET  A
					JOIN PPC_AGENCY_ISSUE_FG_MST B ON A.MEMO_ID =B.MEMO_ID 
					JOIN JOBS  ON B.JOB_CODE=JOBS.JOB_CODE
					WHERE B.CANCELLED=0
					AND A.MEMO_ID=@CMEMO_ID
				) PR ON PR.PRODUCT_CODE =SKU.PRODUCT_CODE	
				
           
           
           END
    
    
  
    GOTO END_PROC  
    
    
     LBLAGENCY_VIEW:  
     
      SELECT DISTINCT A.AC_CODE,B.AC_NAME
      FROM PPC_AGENCY_ISSUE_FG_MST A
      JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
    
    GOTO END_PROC 
      
    LBLBILL_NO_VIEW:  
         
       SELECT BILL_NO AS ORDER_NO   
       FROM PPC_AGENCY_ISSUE_FG_MST A  
       WHERE CANCELLED=0  
       AND (@CAGENCY_CODE='' OR AC_CODE=@CAGENCY_CODE)
       GROUP BY BILL_NO  
         
    GOTO END_PROC  
      
    LBLMEMO_VIEW: --FOR FIRST TIME  
        
       SELECT DISTINCT A.MEMO_NO,A.MEMO_ID  
       FROM PPC_AGENCY_ISSUE_FG_MST A  
       WHERE  (@CBILL_NO ='' OR A.BILL_NO =@CBILL_NO )  
       AND (@CAGENCY_CODE='' OR AC_CODE=@CAGENCY_CODE)  
   
          
    GOTO END_PROC  
    
    LBLBARCODEPRINT:
           
        SELECT CAST(PR.MISSING_PRODUCT_CODE AS BIT) AS CHK,
			PR.MEMO_ID AS MEMO_ID,
		    ROW_ID=PR.ROW_ID,
			A.AC_CODE,LM.AC_NAME ,
			DET.BILL_NO,
			DET.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
		    B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
		    B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
			B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
			SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
			PR.JOB_CODE,
			PR.JOB_NAME,
			PR.PRODUCT_CODE,
			PR.QUANTITY AS QUANTITY,
			ISNULL(PR.MISSING_PRODUCT_CODE,0) AS MISSING_PRODUCT_CODE,
			PR.MEMO_NO,PR.MEMO_DT
	    FROM PPC_FGBCG_MST A
		JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
		JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
		JOIN
		(
		  SELECT  B.AC_CODE,A.ARTICLE_CODE ,
		  ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
		  JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
		  WHERE B.CANCELLED=0
		  GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
		) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
		JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
		JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
		JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
		JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
		JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
		JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
		JOIN
		(
			SELECT  ISNULL(A.MISSING_PRODUCT_CODE,0) AS MISSING_PRODUCT_CODE,  JOBS.JOB_CODE,JOBS.JOB_NAME,A.ROW_ID,
			B.MEMO_ID,B.MEMO_NO,B.MEMO_DT, PRODUCT_CODE,QUANTITY AS QUANTITY
			FROM PPC_AGENCY_ISSUE_FG_DET  A
			JOIN PPC_AGENCY_ISSUE_FG_MST B ON A.MEMO_ID =B.MEMO_ID 
			JOIN JOBS  ON B.JOB_CODE=JOBS.JOB_CODE
			WHERE B.CANCELLED=0
			AND A.MEMO_ID=@CMEMO_ID
		) PR ON PR.PRODUCT_CODE =SKU.PRODUCT_CODE	
		WHERE (@CARTICLE_CODE='' OR ART.ARTICLE_CODE=@CARTICLE_CODE)
				
         

   GOTO END_PROC  
   
 END_PROC:  
  
  
END
