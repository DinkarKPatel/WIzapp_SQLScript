CREATE  VIEW VW_WL_PRD_PURCHASEORDERLIST   

AS             
SELECT     
A.PO_DT AS 'MEMO_DT',     
A.PO_NO AS 'MEMO_NO', 
A.REF_NO AS 'REF_NO',     

A.CHECKED_BY AS 'CHECKED_BY',    
(CASE WHEN A.CANCELLED = 0 THEN A.TOTAL_AMOUNT  ELSE 0 END) AS 'NET_PURCHASE_VALUE',         

(CASE WHEN A.CANCELLED = 0 THEN A.DISCOUNT_AMOUNT  ELSE 0 END)  AS 'BILL_DISCOUNT_AMOUNT',    
A.DISCOUNT_PERCENTAGE AS 'DISCOUNT_PERCENTAGE',    
(CASE WHEN A.CANCELLED = 0 THEN A.FREIGHT  ELSE 0 END) AS 'FREIGHT',    
(CASE WHEN A.CANCELLED = 0 THEN A.OTHER_CHARGES  ELSE 0 END) AS 'OTHER_CHARGES',    
(CASE WHEN A.CANCELLED = 0 THEN A.ROUND_OFF  ELSE 0 END) AS 'ROUND_OFF',  

A.REMARKS AS 'REMARKS',    
(CASE WHEN A.CANCELLED = 0 THEN A.SUBTOTAL  ELSE 0 END) AS 'SUBTOTAL',    
(CASE WHEN A.CANCELLED = 0 THEN A.TAX_AMOUNT ELSE 0 END) AS 'TAX_AMOUNT',    
A.TAX_PERCENTAGE AS 'TAX_PERCENTAGE',    
B.AC_NAME AS 'SUPPLIER_NAME',      
H.USERNAME AS 'CREATED_BY_USER',  
(CASE WHEN A.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END) AS CANCELLED,
(CASE WHEN I.PO_QTY = I.PUR_QTY THEN 'SETTLED' ELSE 'PENDING' END) AS [STATUS],
I.PO_QTY,I.PUR_QTY,(I.PO_QTY - I.PUR_QTY) AS PENDING_QTY ,A.FIN_YEAR,A.PO_ID  AS 'MEMO_ID' 
,I.MRR_NO AS MRR_NUMBER 
FROM PRD_POM01106 A (NOLOCK)             
JOIN LM01106 B (NOLOCK)  ON A.AC_CODE = B.AC_CODE       
JOIN USERS H (NOLOCK) ON A.USER_CODE = H.USER_CODE    
JOIN
(
	SELECT C.MRR_NO,B.PO_ID,SUM(A.QUANTITY) AS PO_QTY ,SUM(ISNULL(PUR_QTY,0)) AS PUR_QTY
	FROM PRD_POD01106 A (NOLOCK) 
	JOIN PRD_POM01106 B (NOLOCK) ON A.PO_ID=B.PO_ID  
	LEFT OUTER JOIN 
	(
		SELECT B.MRR_NO,PO_ROW_ID,SUM(A.QUANTITY) AS PUR_QTY FROM  
		PRD_PID01106 A (NOLOCK) JOIN PRD_PIM01106 B (NOLOCK) ON A.MRR_ID=B.MRR_ID
		JOIN PRD_POD01106 C (NOLOCK) ON C.ROW_ID=A.PO_ROW_ID
		WHERE B.CANCELLED=0 GROUP BY PO_ROW_ID,B.MRR_NO
	) C ON A.ROW_ID = C.PO_ROW_ID  
	GROUP BY B.PO_ID ,C.MRR_NO
) I ON A.PO_ID = I.PO_ID 
LEFT OUTER JOIN PRD_PO_PUR POR ON POR.PO_ID=A.PO_ID
LEFT OUTER JOIN PRD_PIM01106 PIM ON PIM.MRR_ID=POR.MRR_ID
