CREATE PROCEDURE SP_VALIDATEXN_BEFORESAVE_WSR--(LocId 3 digit change by Sanjay:30-10-2024)
(
	@NSPID			varchar(40),
	@CUSERCODE		NVARCHAR(10),
	@NUPDATEMODE	INT,
	@CRETVAL		NVARCHAR(MAX) OUTPUT,
	@BNEGSTOCKFOUND	BIT OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
BEGIN TRY

DECLARE @CCMD			NVARCHAR(MAX),
		@CTEMPCNM		NVARCHAR(MAX),
		@CTEMPCND		NVARCHAR(MAX),
		@NSTEP			INT,
		@CERRPRODUCTCODE	VARCHAR(50),@CWHERECLAUSE VARCHAR(400),
		@CTEMPDBNAME	VARCHAR(50),
		@CSTATECODE CHAR(7),@CLOCSSTMEMOID VARCHAR(40),@CCMDSUBSECTION VARCHAR(100),
		@CSTATENAME VARCHAR(100),@CERREMPCODE CHAR(7),@NCMMDISCOUNT NUMERIC(6,2),@NCRDISCOUNTPCT NUMERIC(10,2),
		@NCRDAYS INT,@NDISCOUNTAMT NUMERIC(10,2),@NTAXAMT NUMERIC(10,2),@NDISCOUNTPCT NUMERIC(6,2),@NTAXPCT NUMERIC(6,2),
		@CERRARTICLENO VARCHAR(100),@CERRPARA1NAME VARCHAR(50),@CERRPARA2NAME VARCHAR(50),@CALLOWBLANKINVOICE VARCHAR(5)


SET @NSTEP=0
 SET @CTEMPDBNAME =''


SET @NSTEP=1


SET @CTEMPCNM=@CTEMPDBNAME+ 'WSR_CNM01106_UPLOAD'
SET @CTEMPCND=@CTEMPDBNAME+ 'WSR_CND01106_UPLOAD'
SET @CRETVAL=''

SET @NSTEP=2
--********************************************VALIDATION FOR CMM01106****************************************************
--VALIDATING RECORD COUNT
SET @CCMD=N'IF (SELECT COUNT(*) FROM '+@CTEMPCNM+' WHERE SP_ID='''+LTRIM(RTRIM((@NSPID)))+''')=0
				SET @CRETVAL1=''NO RECORD FOUND AT MASTER LEVEL..... CANNOT PROCEED'''

EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
GOTO ATLAST


SET @NSTEP=4
--VALIDATING FINYEAR
SET @CCMD=N'SELECT @LRETVAL1=(CASE WHEN ''01'' + LTRIM(RTRIM((DBO.FN_GETFINYEAR(CN_DT))))=FIN_YEAR THEN '''' 
			ELSE ''MEMO DATE IS NOT IN CURRENT FINANCIAL YEAR...CAN NOT PROCEED'' END)
			FROM '+ @CTEMPCNM  +' WHERE SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
EXEC SP_EXECUTESQL @CCMD,N'@LRETVAL1 NVARCHAR(MAX) OUTPUT',@LRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
GOTO ATLAST

SET @NSTEP=5

--VALIDATING DISCOUNT AMOUNT
SET @CCMD=N'SELECT TOP 1 @NDISCOUNTAMTOUT=DISCOUNT_AMOUNT FROM '+@CTEMPCNM+' WHERE DISCOUNT_AMOUNT<0 AND SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
EXEC SP_EXECUTESQL @CCMD,N'@NDISCOUNTAMTOUT NUMERIC(10,2) OUTPUT',@NDISCOUNTAMTOUT=@NDISCOUNTAMT OUTPUT

IF ISNULL(@NDISCOUNTAMT,0)<>0
BEGIN
	SET @CRETVAL='BILL LEVEL DISCOUNT AMOUNT SHOULD BE MORE THAN OR EQUAL TO ZERO..... CANNOT PROCEED'
	GOTO ATLAST
END

--SET @NSTEP=8
----VALIDATING TAX AMOUNT
--SET @CCMD=N'SELECT TOP 1 @NTAXAMTOUT=TAX_AMOUNT FROM '+@CTEMPCNM+' WHERE TAX_AMOUNT<0'
--EXEC SP_EXECUTESQL @CCMD,N'@NTAXAMTOUT NUMERIC(10,2) OUTPUT',@NTAXAMTOUT=@NTAXAMT OUTPUT

--IF ISNULL(@NTAXAMT,0)<>0
--BEGIN
--	SET @CRETVAL='BILL LEVEL TAX AMOUNT SHOULD BE MORE THAN OR EQUAL TO ZERO..... CANNOT PROCEED'
--	GOTO ATLAST
--END

SET @NSTEP=10
--VALIDATING DISCOUNT PERCENTAGE
SET @CCMD=N'SELECT TOP 1 @NDISCOUNTPCTOUT=DISCOUNT_PERCENTAGE FROM '+@CTEMPCNM+' WHERE 
			DISCOUNT_PERCENTAGE NOT BETWEEN 0 AND 100 AND  SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
EXEC SP_EXECUTESQL @CCMD,N'@NDISCOUNTPCTOUT NUMERIC(6,2) OUTPUT',@NDISCOUNTPCTOUT=@NDISCOUNTPCT OUTPUT

IF ISNULL(@NDISCOUNTPCT,0)<>0
BEGIN
	SET @CRETVAL='DISCOUNT PERCENTAGE SHOULD BE BETWEEN 0 AND 100..... CANNOT PROCEED'
	GOTO ATLAST
END


--SET @NSTEP=12
----VALIDATING TAX PERCENTAGE
--SET @CCMD=N'SELECT TOP 1 @NTAXPCTOUT=TAX_PERCENTAGE FROM '+@CTEMPCNM+' WHERE 
--			TAX_PERCENTAGE NOT BETWEEN 0 AND 100'
--EXEC SP_EXECUTESQL @CCMD,N'@NTAXPCTOUT NUMERIC(6,2) OUTPUT',@NTAXPCTOUT=@NTAXPCT OUTPUT

--IF ISNULL(@NTAXPCT,0)<>0
--BEGIN
--	SET @CRETVAL='TAX PERCENTAGE SHOULD BE BETWEEN 0 AND 100..... CANNOT PROCEED'
--	GOTO ATLAST
--END


--VALIDATING USER CODE
IF @NUPDATEMODE=1
BEGIN
	SET @NSTEP=15
	
	SET @CCMD=N'UPDATE '+ @CTEMPCNM + N' SET USER_CODE='''+@CUSERCODE+''' WHERE LTRIM(RTRIM(USER_CODE)) = ''''AND SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
	EXEC SP_EXECUTESQL @CCMD

END

SET @NSTEP=17
SET @CCMD=N'IF EXISTS (SELECT TOP 1 A.USER_CODE FROM '+ @CTEMPCNM + N' A 
						LEFT OUTER JOIN USERS B ON B.USER_CODE=A.USER_CODE
						WHERE B.USER_CODE IS NULL AND A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''')
				SET @CRETVAL1=''INVALID USER DETAILS FOUND....CAN NOT PROCEED'''
EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
	GOTO ATLAST

IF @NUPDATEMODE=1
BEGIN
	SET @NSTEP=20
	
	SET @CCMD=N'UPDATE '+ @CTEMPCNM + N' SET EDT_USER_CODE='''+@CUSERCODE+''' 
	WHERE LTRIM(RTRIM(EDT_USER_CODE)) = '''' AND SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
	EXEC SP_EXECUTESQL @CCMD

END

SET @NSTEP=22
SET @CCMD=N'IF EXISTS (SELECT TOP 1 A.USER_CODE FROM '+ @CTEMPCNM + N' A 
						LEFT OUTER JOIN USERS B ON B.USER_CODE=A.EDT_USER_CODE
						WHERE B.USER_CODE IS NULL AND A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''')
				SET @CRETVAL1=''INVALID EDITING USER DETAILS FOUND....CAN NOT PROCEED'''
EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
	GOTO ATLAST

--VALIDATING EMPLOYEE
--SET @NSTEP=25

--SET @CCMD=N'UPDATE '+ @CTEMPCNM + N' SET FORM_ID=''0000000'' WHERE ISNULL(FORM_ID,'''')='''''
--EXEC SP_EXECUTESQL @CCMD

 DECLARE @DMEMO_DT DATETIME,@CGSTCUTOFFDATE VARCHAR(10),@CCN_DT DATETIME,@GSTDATE DATETIME
   SELECT @CGSTCUTOFFDATE=VALUE FROM CONFIG WHERE CONFIG_OPTION ='GST_CUT_OFF_DATE'
 
 
 IF ISNULL(@CGSTCUTOFFDATE,'')<>''
 BEGIN  
	 SELECT @GSTDATE=CAST(@CGSTCUTOFFDATE AS DATETIME)
	
	 SET @CCMD=N'SELECT TOP 1 @CCN_DT=CN_DT FROM '+ @CTEMPCNM + N' A  WHERE SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
	 EXEC SP_EXECUTESQL @CCMD,N'@CCN_DT DATETIME OUTPUT',@CCN_DT=@CCN_DT OUTPUT
	 PRINT @CCMD
END

IF @CCN_DT<@GSTDATE
BEGIN
SET @NSTEP=27
SET @CCMD=N'IF EXISTS (SELECT TOP 1 A.ITEM_FORM_ID FROM '+ @CTEMPCND + N' A 
						LEFT OUTER JOIN FORM B ON B.FORM_ID=A.ITEM_FORM_ID
						WHERE (B.FORM_ID IS NULL OR A.ITEM_FORM_ID=''0000000'') AND A.PRODUCT_CODE<>''''
						AND A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''' )
				SET @CRETVAL1=''INVALID FORM NAME FOUND....CAN NOT PROCEED'''
EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
	GOTO ATLAST
END
--VALIDATING PARTY
SET @NSTEP=29
SET @CCMD=N'IF EXISTS (SELECT TOP 1 A.AC_CODE FROM '+ @CTEMPCNM + N' A 
						LEFT OUTER JOIN LM01106 B ON B.AC_CODE=A.AC_CODE WHERE B.AC_CODE IS NULL
						OR A.AC_CODE IN ('''',''0000000000'') AND A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''')
				SET @CRETVAL1=''INVALID PARTY DETAILS FOUND....CAN NOT PROCEED'''
EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
PRINT @CCMD
IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
	GOTO ATLAST

SET @NSTEP=32

--VALIDATING EMPLOYEE 
SET @CCMD=N'UPDATE '+ @CTEMPCND + N' SET EMP_CODE= (CASE WHEN LTRIM(RTRIM(EMP_CODE))='''' 
THEN ''0000000'' ELSE EMP_CODE END) WHERE SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
EXEC SP_EXECUTESQL @CCMD

SET @NSTEP=33

SET @CCMD=N'SELECT TOP 1 @CEMPCODEOUT=A.EMP_CODE FROM '+@CTEMPCND+' A
			LEFT OUTER JOIN EMPLOYEE B ON B.EMP_CODE=A.EMP_CODE 
			WHERE B.EMP_CODE IS NULL
			AND A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
EXEC SP_EXECUTESQL @CCMD,N'@CEMPCODEOUT CHAR(7) OUTPUT',@CEMPCODEOUT=@CERREMPCODE OUTPUT

IF ISNULL(@CERRPRODUCTCODE,'')<>''
	SET @CRETVAL='INVALID EMPLOYEE CODE '+@CERREMPCODE+' FOUND..... CANNOT PROCEED'

IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
GOTO ATLAST

SELECT TOP 1 @CALLOWBLANKINVOICE=VALUE FROM CONFIG WHERE  CONFIG_OPTION='CREATE_BLANK_INVOICE' 

IF ISNULL(@CALLOWBLANKINVOICE,'')<>'1'
BEGIN
	SET @NSTEP=35
	--VALIDATING RECORD COUNT
	SET @CCMD=N'IF NOT EXISTS (SELECT TOP 1 PRODUCT_CODE FROM '+@CTEMPCND+' WHERE SP_ID='''+LTRIM(RTRIM((@NSPID)))+''')
					SET @CRETVAL1=''BLANK DETAIL CAN NOT BE SAVED..... PLEASE CHECK'''
	EXEC SP_EXECUTESQL @CCMD,N'@CRETVAL1 NVARCHAR(MAX) OUTPUT',@CRETVAL1=@CRETVAL OUTPUT
	PRINT @CCMD

	IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
	GOTO ATLAST
END

SET @NSTEP=37

--VALIDATING PURCHASE PRICE
SET @CCMD=N'SELECT TOP 1 @CERRPRODUCTCODE=PRODUCT_CODE FROM '+@CTEMPCND+' A WHERE A.RATE<0 AND A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
EXEC SP_EXECUTESQL @CCMD,N'@CERRPRODUCTCODE VARCHAR(50) OUTPUT',@CERRPRODUCTCODE OUTPUT

IF ISNULL(@CERRPRODUCTCODE,'')<>'' OR ISNULL(@CERRARTICLENO,'')<>''
	SET @CRETVAL='ITEM CODE: '+@CERRPRODUCTCODE+'...RATE SHOULD NOT BE LESS THAN OR EQUAL TO ZERO..... CANNOT PROCEED'

IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
GOTO ATLAST

SET @NSTEP=41

--VALIDATING NEGATIVE VALUES OF QUANTITY
SET @CCMD=N'SELECT TOP 1 @CERRPRODUCTCODE=PRODUCT_CODE FROM '+@CTEMPCND+' A  WHERE A.QUANTITY<0 AND  SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
				
EXEC SP_EXECUTESQL @CCMD,N'@CERRPRODUCTCODE VARCHAR(50) OUTPUT',@CERRPRODUCTCODE OUTPUT

IF ISNULL(@CERRPRODUCTCODE,'')<>'' OR ISNULL(@CERRARTICLENO,'')<>''
	SET @CRETVAL='QUANTITY CANNOT BE NEGATIVE FOR ITEM CODE: '+@CERRPRODUCTCODE+'........ CANNOT PROCEED'
IF ISNULL(@CRETVAL,'')<>''
GOTO ATLAST

SET @NSTEP=45
--VALIDATING PRODUCT CODE
SET @CCMD=N'SELECT TOP 1 @CERRPRODUCTCODE=A.PRODUCT_CODE FROM '+@CTEMPCND+' A
			LEFT OUTER JOIN SKU B ON B.PRODUCT_CODE=A.PRODUCT_CODE WHERE B.PRODUCT_CODE IS NULL
			AND A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
EXEC SP_EXECUTESQL @CCMD,N'@CERRPRODUCTCODE VARCHAR(50) OUTPUT',@CERRPRODUCTCODE OUTPUT

IF ISNULL(@CERRPRODUCTCODE,'')<>''
	SET @CRETVAL='INVALID ITEM CODE '+@CERRPRODUCTCODE+' FOUND..... CANNOT PROCEED'

IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
GOTO ATLAST

SET @CWHERECLAUSE=' AND SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''

EXEC SP3S_VALIDATEXN_ITEMTYPE
@CTEMPMASTERTABLE=@CTEMPCNM,
@CTEMPDETAILTABLE=@CTEMPCND,
@CWHERECLAUSE=@CWHERECLAUSE,
@CERRORMSG=@CRETVAL OUTPUT

IF @CRETVAL<>''
	GOTO ATLAST
				
SET @CRETVAL=''

ATLAST:

IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
	SET @CRETVAL=ISNULL(@CRETVAL,'') +'(SP_VALIDATEXN_BEFORESAVE_WSR)'
		
END TRY

BEGIN CATCH
	SET @CRETVAL=N'ERROR FOUND IN '+ISNULL(ERROR_PROCEDURE(),'SP_VALIDATEXN_BEFORESAVE_WSR ')+
	  'STEP :'+LTRIM(RTRIM(STR(@NSTEP)))  +' MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')  
	  
END CATCH
END
--------- END OF PROCEDURE SP_VALIDATEXN_BEFORESAVE_WSR
