CREATE PROCEDURE SP_PRD_PRODUCTION_STATUS_REPORT_UPC  
(  
 @DASON AS DATETIME='',  
 @CARTICLE_CODE VARCHAR(MAX)='',  
 @CAC_CODE VARCHAR(MAX)='',  
 @MERCHANT_CODE VARCHAR(MAX)='',  
 @CAC_CODE_NOTIN VARCHAR(10)='',  
 @NSUMMARY INT=0  
)  
AS  
BEGIN  
  
DECLARE @DTSQL NVARCHAR(MAX),@CART_STATUS VARCHAR(MAX),@AAC_STATUS VARCHAR(MAX),  
        @CMERCHANTSTATUS VARCHAR(MAX)  
  
  
IF @CARTICLE_CODE=''  
BEGIN  
   SET @CART_STATUS=''  
   SET @CARTICLE_CODE='IN('''')'  
END  
ELSE   
BEGIN  
   SET @CART_STATUS='LATER'  
END  
  
IF @CAC_CODE=''  
BEGIN  
   SET @AAC_STATUS=''  
   SET @CAC_CODE='IN('''')'  
END  
ELSE   
BEGIN  
   SET @AAC_STATUS='LATER'  
END  
  
  
IF @MERCHANT_CODE=''  
BEGIN  
   SET @CMERCHANTSTATUS=''  
   SET @MERCHANT_CODE='IN('''')'  
END  
ELSE   
BEGIN  
   SET @CMERCHANTSTATUS='LATER'  
END  
  
  
--BUYER ORDER AGEAINST WORK ORDER  
	  
	   
	   
	

	IF OBJECT_ID('TEMPDB..#TMPWO','U') IS NOT NULL  
	   DROP TABLE #TMPWO  
	     
	   SELECT M.AC_CODE, A.ORDER_ID,A.MEMO_ID ,B.ARTICLE_CODE,Q.PARA1_CODE,Q.PARA2_CODE,       
	   CAST(SUM(B.QUANTITY) AS NUMERIC(10,0)) AS QTY, SUM(Q.QUANTITY) AS PRD_QUANTITY ,
	   ALLOCATE_QTY=CAST(0 AS NUMERIC(10,0)) ,
	   WO_QTY=CAST(0 AS NUMERIC(10,0)),
	   WIP_STOCK=CAST(0 AS NUMERIC(10,0)),
	   M.ORDER_NO,M.ORDER_DT,M.DELIVERY_DT,
	   DATEDIFF(DAY,M.DELIVERY_DT,GETDATE()) AS DTD ,
	   SR=CAST(0 AS INT)
	 INTO #TMPWO   
	 FROM  (SELECT DISTINCT * FROM PRD_WO_ORDERS) A       
	 JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID       
	 JOIN PRD_WO_DET P ON C.MEMO_ID=P.MEMO_ID       
	 JOIN PRD_WO_SUB_DET Q ON P.ROW_ID =Q.REF_ROW_ID       
	 JOIN BUYER_ORDER_DET B ON A.ORDER_ID=B.ORDER_ID       
	 AND B.PARA1_CODE = Q.PARA1_CODE       
	 AND B.PARA2_CODE = Q.PARA2_CODE       
	 AND B.ARTICLE_CODE = C.ARTICLE_SET_CODE       
	 JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID     
	 WHERE C.CANCELLED=0  AND M.CANCELLED=0  
	 AND 1=2  
	 GROUP BY M.AC_CODE,A.ORDER_ID,A.MEMO_ID,B.ARTICLE_CODE,Q.PARA1_CODE,Q.PARA2_CODE,
	 M.ORDER_NO,M.ORDER_DT,M.DELIVERY_DT,
	 DATEDIFF(DAY,M.DELIVERY_DT,GETDATE())   
	     
	
	SET @DTSQL=N' SELECT M.AC_CODE,B.ORDER_ID,ISNULL(PMT1.WO_ID,ISNULL(A.MEMO_ID,'''')) AS MEMO_ID ,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,       
	   SUM(B.QUANTITY) AS QTY, SUM(ISNULL(PRD_QTY,A.QUANTITY)) AS PRD_QUANTITY,
	   ALLOCATE_QTY=CAST(0 AS NUMERIC(10,0)),
	   WO_QTY=CAST(0 AS NUMERIC(10,0)),
	   WIP_STOCK=CAST(0 AS NUMERIC(10,0)),
	   M.ORDER_NO,M.ORDER_DT,M.DELIVERY_DT,
	   DATEDIFF(DAY,M.DELIVERY_DT,GETDATE()) AS DTD,
	   SR=ROW_NUMBER() OVER (PARTITION BY  B.ARTICLE_CODE,B.ORDER_ID,M.AC_CODE ORDER BY B.ARTICLE_CODE,B.ORDER_ID,M.AC_CODE )
	 FROM BUYER_ORDER_DET B   
	 JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID   
	 LEFT JOIN  
	 (  
	  SELECT A.ORDER_ID,C.ARTICLE_SET_CODE ,A.MEMO_ID,PMT.PARA1_CODE,PMT.PARA2_CODE,ISNULL(PMT.PRD_QTY,0) AS QUANTITY
	  FROM  
	 (SELECT DISTINCT * FROM PRD_WO_ORDERS) A       
	 JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID         
	 JOIN
	 (
	  SELECT A.WO_ID,A.PARA1_CODE,A.PARA2_CODE,COUNT(*) AS PRD_QTY 
	  FROM PRD_UPCPMT  A
	  WHERE ISNULL(ORDER_ID,'''')=''''
	  GROUP BY A.WO_ID,A.PARA1_CODE,A.PARA2_CODE
	 ) PMT ON PMT.WO_ID=C.MEMO_ID   
	 WHERE C.CANCELLED=0   
	 ) A ON A.ORDER_ID=B.ORDER_ID       
	 AND B.PARA1_CODE = A.PARA1_CODE       
	 AND B.PARA2_CODE = A.PARA2_CODE       
	 AND B.ARTICLE_CODE = A.ARTICLE_SET_CODE 
	 LEFT JOIN
	 (
	  SELECT A.ORDER_ID, A.WO_ID,A.PARA1_CODE,A.PARA2_CODE,COUNT(*) AS PRD_QTY 
	  FROM PRD_UPCPMT A
	  WHERE ISNULL(ORDER_ID,'''')<>'''' 
	  GROUP BY A.ORDER_ID, A.WO_ID,A.PARA1_CODE,A.PARA2_CODE
	 ) PMT1 ON PMT1.ORDER_ID=M.ORDER_ID   
	 AND B.PARA1_CODE=PMT1.PARA1_CODE
	 AND B.PARA2_CODE=PMT1.PARA2_CODE 
	 WHERE  M.CANCELLED=0  
	 AND M.ORDER_DT<='''+CONVERT(VARCHAR(11),@DASON,120)+''' 
	 AND M.ORDER_DT>=''2017-01-01''   
	 AND ('''+RTRIM(LTRIM(@CART_STATUS))+'''='''' OR B.ARTICLE_CODE '+@CARTICLE_CODE+')    
	 AND ('''+RTRIM(LTRIM(@AAC_STATUS))+'''='''' OR M.AC_CODE '+@CAC_CODE+')    
	 AND ('''+RTRIM(LTRIM(@CMERCHANTSTATUS))+'''='''' OR B.ITEM_MERCHANT_CODE '+@MERCHANT_CODE+')    
	 AND ('''+RTRIM(LTRIM(@CAC_CODE_NOTIN))+'''='''' OR M.AC_CODE<>'''+@CAC_CODE_NOTIN+''')   
	 GROUP BY M.AC_CODE,B.ORDER_ID,ISNULL(PMT1.WO_ID,ISNULL(A.MEMO_ID,'''')),B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE ,
	 M.ORDER_NO,M.ORDER_DT,M.DELIVERY_DT,
	 DATEDIFF(DAY,M.DELIVERY_DT,GETDATE()) '  
	 PRINT @DTSQL  
	 INSERT INTO #TMPWO  
	 EXEC SP_EXECUTESQL @DTSQL  
	 
	 
	

	
	 IF OBJECT_ID('TEMPDB..#TMPALLOCATION','U') IS NOT NULL  
	   DROP TABLE #TMPALLOCATION  
	     
	 SELECT ORDER_ID,WO_ID AS MEMO_ID ,CAST('' AS VARCHAR(100)) AS ARTICLE_CODE,
	 PARA1_CODE,PARA2_CODE,PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE   
	 INTO #TMPALLOCATION
	 FROM PRD_UPCPMT WHERE 1=2
	 
	
	 SET @DTSQL=N' SELECT B.ORDER_ID,ISNULL(PMT1.WO_ID,ISNULL(A.MEMO_ID,'''')) AS MEMO_ID ,
	 B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,ISNULL(PMT1.PRODUCT_CODE,ISNULL(A.PRODUCT_CODE,'''')) AS PRODUCT_CODE,
	 ISNULL(PMT1.QUANTITY_IN_STOCK,ISNULL(A.QUANTITY_IN_STOCK,0)) AS QUANTITY_IN_STOCK,
	 ISNULL(PMT1.JOB_CODE,ISNULL(A.JOB_CODE,'''')) AS JOB_CODE      
	 FROM BUYER_ORDER_DET B   
	 JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID   
	 LEFT JOIN  
	 (  
	  SELECT A.ORDER_ID,C.ARTICLE_SET_CODE ,A.MEMO_ID,PMT.PARA1_CODE,PMT.PARA2_CODE,
	  PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE
	  FROM  
	 (SELECT DISTINCT * FROM PRD_WO_ORDERS) A       
	 JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID         
	 JOIN
	 (
	  SELECT A.WO_ID,A.PARA1_CODE,A.PARA2_CODE,A.PRODUCT_CODE,A.QUANTITY_IN_STOCK,A.JOB_CODE
	  FROM PRD_UPCPMT A

	  WHERE ISNULL(A.ORDER_ID,'''')=''''
	 ) PMT ON PMT.WO_ID=C.MEMO_ID   
	 WHERE C.CANCELLED=0   
	 ) A ON A.ORDER_ID=B.ORDER_ID       
	 AND B.PARA1_CODE = A.PARA1_CODE       
	 AND B.PARA2_CODE = A.PARA2_CODE       
	 AND B.ARTICLE_CODE = A.ARTICLE_SET_CODE 
	 LEFT JOIN
	 (
	  SELECT A.ORDER_ID, A.WO_ID,A.PARA1_CODE,A.PARA2_CODE,A.PRODUCT_CODE,A.QUANTITY_IN_STOCK,A.JOB_CODE
	  FROM PRD_UPCPMT A
	  WHERE ISNULL(A.ORDER_ID,'''')<>''''
	 ) PMT1 ON PMT1.ORDER_ID=M.ORDER_ID   
	 AND B.PARA1_CODE=PMT1.PARA1_CODE
	 AND B.PARA2_CODE=PMT1.PARA2_CODE 
	 WHERE  M.CANCELLED=0  
	 AND M.ORDER_DT<='''+CONVERT(VARCHAR(11),@DASON,120)+'''    
	 AND M.ORDER_DT>=''2017-01-01''  
     AND ('''+RTRIM(LTRIM(@CART_STATUS))+'''='''' OR B.ARTICLE_CODE '+@CARTICLE_CODE+')    
     AND ('''+RTRIM(LTRIM(@AAC_STATUS))+'''='''' OR M.AC_CODE '+@CAC_CODE+')    
     AND ('''+RTRIM(LTRIM(@CMERCHANTSTATUS))+'''='''' OR B.ITEM_MERCHANT_CODE '+@MERCHANT_CODE+')    
     AND ('''+RTRIM(LTRIM(@CAC_CODE_NOTIN))+'''='''' OR M.AC_CODE<>'''+@CAC_CODE_NOTIN+''')   '  
	 PRINT @DTSQL+'CHECK'  
	 INSERT INTO #TMPALLOCATION  
	 EXEC SP_EXECUTESQL @DTSQL  
	 
	 
	 --SELECT * FROM #TMPWO A WHERE WIP_STOCK <>0
	 	  
	DELETE A FROM #TMPALLOCATION A
	JOIN
	(
	 SELECT PRODUCT_CODE FROM PRD_TRANSFER_TO_TRADING_UPC A
	 JOIN PRD_TRANSFER_MAIN_MST B ON A.MEMO_ID =B.MEMO_ID 
	 WHERE B.CANCELLED =0
	) B ON A.PRODUCT_CODE=B.PRODUCT_CODE 
	
	
	
	 UPDATE A SET WO_QTY=B.WO_QTY FROM #TMPWO A
	 JOIN
	 (
	 SELECT ORDER_ID,MEMO_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,COUNT(*) AS WO_QTY 
	 FROM #TMPALLOCATION WHERE MEMO_ID<>'' AND JOB_CODE=''
	 GROUP BY ORDER_ID,MEMO_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE
	 ) B ON A.ORDER_ID=B.ORDER_ID
	 AND A.MEMO_ID=B.MEMO_ID
	 AND A.ARTICLE_CODE=B.ARTICLE_CODE
	 AND A.PARA1_CODE=B.PARA1_CODE
	 AND A.PARA2_CODE=B.PARA2_CODE
	 
	 
	  
	 UPDATE A SET WIP_STOCK=B.WIP_STOCK FROM #TMPWO A
	 JOIN
	 (
	 SELECT ORDER_ID,MEMO_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,
	 SUM(QUANTITY_IN_STOCK) AS WIP_STOCK 
	 FROM #TMPALLOCATION WHERE   JOB_CODE<>''
	 AND QUANTITY_IN_STOCK<>0
	 GROUP BY ORDER_ID,MEMO_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE
	 ) B ON A.ORDER_ID=B.ORDER_ID
	 AND A.MEMO_ID=B.MEMO_ID
	 AND A.ARTICLE_CODE=B.ARTICLE_CODE
	 AND A.PARA1_CODE=B.PARA1_CODE
	 AND A.PARA2_CODE=B.PARA2_CODE
	
	  
	
	  
	
  IF OBJECT_ID('TEMPDB..#TMPWSP','U') IS NOT NULL
      DROP TABLE #TMPWSP
     
     SELECT B.AC_CODE, A.ORDER_ID,A.PACKSLIP_ARTICLE_CODE, 
     A.PACKSLIP_PARA1_CODE AS PARA1_CODE,
     A.PACKSLIP_PARA2_CODE AS PARA2_CODE,
     CAST(SUM(QUANTITY) AS NUMERIC(10,0)) AS WPS_QTY
     INTO #TMPWSP
     FROM WPS_DET A
     JOIN WPS_MST B ON A.PS_ID=B.PS_ID
     WHERE B.CANCELLED=0 AND A.ORDER_ID<>''
     GROUP BY B.AC_CODE,A.ORDER_ID,A.PACKSLIP_ARTICLE_CODE , A.PACKSLIP_PARA1_CODE ,
     A.PACKSLIP_PARA2_CODE
   
   
   
  
    
	SELECT  A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE
		   ,A.AC_CODE,A.ORDER_ID,A.ORDER_NO,A.WO_QTY,A.WIP_STOCK
		   ,A.ORDER_DT,A.DELIVERY_DT,A.DTD,A.QTY,A.SR ,
			WPS.WPS_QTY,
			ISNULL(WPS.WPS_QTY,0) AS DLVRD,
			A.QTY -ISNULL(WPS.WPS_QTY,0) AS PENDING_WSL,
			   
			   CASE WHEN  (A.QTY)-ISNULL(WPS.WPS_QTY,0) <=0  THEN 2
					WHEN  (A.QTY)-ISNULL(WPS.WPS_QTY,0)=(A.QTY) THEN 0
			   ELSE 1 END AS TYPE
    INTO #TMPORDER
	FROM #TMPWO A
	--JOIN #TMPWO B ON A.ARTICLE_CODE=B.ARTICLE_CODE AND A.ORDER_ID=B.ORDER_ID  AND B.SR<=A.SR
	LEFT JOIN #TMPWSP WPS ON A.ORDER_ID=WPS.ORDER_ID
			AND A.ARTICLE_CODE=WPS.PACKSLIP_ARTICLE_CODE
			AND A.AC_CODE=WPS.AC_CODE AND A.PARA1_CODE=WPS.PARA1_CODE AND A.PARA2_CODE=WPS.PARA2_CODE 
	GROUP BY A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE
		   ,A.AC_CODE,A.ORDER_ID,A.ORDER_NO,A.WO_QTY,A.WIP_STOCK
		   ,A.ORDER_DT,A.DELIVERY_DT,A.DTD
		   ,A.QTY,A.SR ,WPS.WPS_QTY
	ORDER BY A.ORDER_ID,A.SR
	
	
	   
	IF OBJECT_ID('TEMPDB..#TMPJOBS','U') IS NOT NULL  
	   DROP TABLE #TMPJOBS  
	     
	 SELECT A.ORDER_ID,A.MEMO_ID AS WORK_ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.JOB_CODE,JOBS.JOB_NAME,
	 COUNT(*) AS ISSUE_QTY 
	 INTO #TMPJOBS 
	 FROM #TMPALLOCATION A 
	 JOIN JOBS ON A.JOB_CODE=JOBS.JOB_CODE
	 WHERE   A.JOB_CODE<>''
	 AND A.QUANTITY_IN_STOCK=0
	 GROUP BY A.ORDER_ID,A.MEMO_ID ,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.JOB_CODE,JOBS.JOB_NAME
	 
	-- SELECT * FROM #TMPORDER
	--RETURN
	 --SELECT * FROM #TMPWO
	 --ORDER BY ARTICLE_CODE,ORDER_ID
	 --RETURN
	 
    
	IF OBJECT_ID('TEMPDB..#TMPORDER_WO','U') IS NOT NULL  
	   DROP TABLE #TMPORDER_WO  
	     
	  SELECT ART.ARTICLE_CODE,ART.ARTICLE_NO,
	         A.PARA1_CODE ,P1.PARA1_NAME,
	         A.PARA2_CODE,P2.PARA2_NAME,
	         A.AC_CODE,LM.AC_NAME,
	         A.ORDER_ID,A.ORDER_DT,A.ORDER_NO,
	         A.DELIVERY_DT,
	         A.DTD,
	         DET.ITEM_EMP_CODE AS SALE_EMP_CODE,
	         EMP.EMP_NAME  AS EMP_NAME,
	         DET.ITEM_MERCHANT_CODE AS MERCHANT_CODE,
	         EMP1.EMP_NAME  AS MERCHANT,
	         A.QTY AS QTY,
	         0 AS QUANTITY_IN_STOCK,
	         WPS_QTY,
	         DLVRD,
	         0 AS CUMM_SUM,
	         PENDING_WSL,
	         TYPE,
	         SUM(A.WO_QTY) AS WO,
	        -- A.WIP_STOCK AS WIP_QTY,
	         SUM(A.WIP_STOCK ) AS WIP_STOCK
	  INTO #TMPORDER_WO
	  FROM #TMPORDER A
	  JOIN BUYER_ORDER_DET DET ON DET.ORDER_ID =A.ORDER_ID AND A.ARTICLE_CODE =DET.ARTICLE_CODE 
	  AND A.PARA1_CODE=DET.PARA1_CODE AND A.PARA2_CODE =DET.PARA2_CODE 
	  LEFT OUTER JOIN EMPLOYEE EMP ON EMP.EMP_CODE=DET.ITEM_EMP_CODE
	  LEFT OUTER JOIN EMPLOYEE EMP1 ON EMP1.EMP_CODE=DET.ITEM_MERCHANT_CODE
	  JOIN ARTICLE ART ON A.ARTICLE_CODE=ART.ARTICLE_CODE
	  JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
	  JOIN PARA2 P2 ON P2.PARA2_CODE=A.PARA2_CODE
	  JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
	  GROUP BY ART.ARTICLE_CODE,ART.ARTICLE_NO,
	         A.PARA1_CODE ,P1.PARA1_NAME,
	         A.PARA2_CODE,P2.PARA2_NAME,
	         A.AC_CODE,LM.AC_NAME,
	         A.ORDER_ID,A.ORDER_DT,A.ORDER_NO,
	         A.DELIVERY_DT,
	         A.DTD,
	         DET.ITEM_EMP_CODE ,
	         EMP.EMP_NAME ,
	         DET.ITEM_MERCHANT_CODE ,
	         EMP1.EMP_NAME ,
	         A.QTY ,
	         WPS_QTY,
	         DLVRD,
	         PENDING_WSL,
	         TYPE
	        -- A.WO_QTY AS WO,
	        ---- A.WIP_STOCK AS WIP_QTY,
	        -- A.WIP_STOCK
	   

	  
	 UPDATE A SET QUANTITY_IN_STOCK=STK.QUANTITY_IN_STOCK FROM #TMPORDER_WO A
	 JOIN 
	(  
	 SELECT  A.ARTICLE_CODE,--A.PARA1_CODE,A.PARA2_CODE,  
	 SUM(QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK   
	 FROM SKU A (NOLOCK)  
	 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE  
	 GROUP BY A.ARTICLE_CODE--,A.PARA1_CODE,A.PARA2_CODE  
	) STK ON  A.ARTICLE_CODE=STK.ARTICLE_CODE  
	  
	
		    
	 DECLARE @CCOLNAME VARCHAR(MAX),@CDISPCOLNAME VARCHAR(MAX),@CJOB_QTY VARCHAR(MAX) ,@CFILTERCOLNAME VARCHAR(MAX),
	          @CFILTER VARCHAR(MAX) 
	 SET @CCOLNAME=''  
	 SET @CDISPCOLNAME='' 
	 SET @CJOB_QTY='' 
	 
	 SET @CFILTERCOLNAME=''
	 SET @CFILTER=''
	   
	 IF OBJECT_ID('TEMPDB..#TMPJOBMST','U') IS NOT NULL  
		DROP TABLE #TMPJOBMST  
	   
	 SELECT DISTINCT JOB_NAME,JOB_CODE INTO #TMPJOBMST FROM #TMPJOBS   
	   
	 SELECT   @CCOLNAME=ISNULL(@CCOLNAME+',','')+'SUM(CASE WHEN JOB_NAME= '''+(JOB_NAME) + ''' THEN ISSUE_QTY ELSE 0 END) AS '+QUOTENAME(JOB_NAME)  
	 FROM #TMPJOBMST  
	 WHERE JOB_NAME<>'' 
	 
     --
     SELECT   @CFILTER=ISNULL(@CFILTER+',','')+'(SELECT TOP 1 JOB_CODE FROM JOBS WHERE JOB_NAME='''+(JOB_NAME) + ''') AS '+QUOTENAME(JOB_NAME+'_1')  
	 FROM #TMPJOBMST  
	 WHERE JOB_NAME<>'' 
    
     ----
	   
	 SELECT   @CDISPCOLNAME=ISNULL(@CDISPCOLNAME+',','') + 'ISNULL('+QUOTENAME(JOB_NAME)+',0) AS '+QUOTENAME(JOB_NAME)  
	 FROM #TMPJOBMST  
	 WHERE JOB_NAME<>''  
	 IF @CCOLNAME IS NULL
	 SET @CCOLNAME=''
	   
	 SELECT   @CJOB_QTY=ISNULL(@CJOB_QTY+'','') + '+ISNULL('+QUOTENAME(JOB_NAME)+',0)  '
	 FROM #TMPJOBMST  
	 WHERE JOB_NAME<>''
	 
	
	 IF @CCOLNAME IS NULL
	 SET @CCOLNAME=''
	 --
	 IF @CCOLNAME<>''  
	 SET @CCOLNAME=' '+@CCOLNAME  
	   
	 IF @CDISPCOLNAME<>''  
	 SET @CDISPCOLNAME=' '+@CDISPCOLNAME
	 
	 IF @CJOB_QTY<>''
	 BEGIN
	 SET @CJOB_QTY=' '+@CJOB_QTY  
	 END
	 ELSE
	 BEGIN
	     SET @CJOB_QTY='0'
	 END
	 SET @CFILTER=SUBSTRING(@CFILTER,2,LEN(@CFILTER))
	 
	 IF ISNULL(@CFILTER,'')<>''
	 SET @CFILTER=','+@CFILTER
	  
	 
 --  EXEC SP_PRD_PRODUCTION_STATUS_REPORT_UPC '2017-01-14','IN (''010001063'')','','','',0 

	IF @NSUMMARY=1  
	BEGIN  
	    
	   -- SELECT * INTO TMPJOBS FROM #TMPJOBS
	SET @DTSQL=N' SELECT A.ARTICLE_NO,A.PARA1_NAME,A.PARA2_NAME,
	          PENDING=SUM( CASE WHEN ISNULL(MST.ORDER_STATUS,0)<>1  THEN QTY ELSE 0 END) ,
	          SUM(WO) AS WO,
              QUANTITY_IN_STOCK,
              SUM(WIP_STOCK)+SUM('+@CJOB_QTY+') AS WIP_STOCK,
              REQ_QTY=SUM( CASE WHEN ISNULL(MST.ORDER_STATUS,0)<>1  THEN QTY-ISNULL(DLVRD,0) ELSE 0 END)
              -(SUM(WO)+QUANTITY_IN_STOCK+SUM(WIP_STOCK)+SUM('+@CJOB_QTY+')) 
            FROM #TMPORDER_WO A  
			JOIN BUYER_ORDER_MST MST ON MST.ORDER_ID=A.ORDER_ID
			LEFT OUTER JOIN   
			(  
			 SELECT A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE   
			 '+@CCOLNAME+'  
			 FROM #TMPJOBS A  
			 GROUP BY A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE   
			  
			) B ON A.ORDER_ID=B.ORDER_ID  
			AND A.ARTICLE_CODE=B.ARTICLE_CODE  
			AND A.PARA1_CODE=B.PARA1_CODE  
			AND A.PARA2_CODE=B.PARA2_CODE
			GROUP BY A.ARTICLE_NO,A.PARA1_NAME,A.PARA2_NAME  ,QUANTITY_IN_STOCK'
	PRINT @DTSQL    
	EXEC SP_EXECUTESQL @DTSQL

	  
	  
	END  
	ELSE  
	BEGIN  
	
	--QTY-(WO+WIP_STOCK '+@CJOB_QTY+') 

--EXEC SP_PRD_PRODUCTION_STATUS_REPORT_UPC '2017-01-03'
	SET @DTSQL=N'SELECT A.*,PENDING=CASE WHEN ISNULL(MST.ORDER_STATUS,0)<>1  THEN QTY-ISNULL(DLVRD,0) ELSE 0 END,
	CASE WHEN DTD>0 THEN 1 ELSE 0 END AS TYPE  
	'+@CDISPCOLNAME+'  
	'+@CFILTER+'
	FROM #TMPORDER_WO A  
	JOIN BUYER_ORDER_MST MST ON MST.ORDER_ID=A.ORDER_ID
	LEFT OUTER JOIN   
	(  
	 SELECT A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE   
	 '+@CCOLNAME+'  
	 FROM #TMPJOBS A  
	 GROUP BY A.ORDER_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE   
	  
	) B ON A.ORDER_ID=B.ORDER_ID  
	AND A.ARTICLE_CODE=B.ARTICLE_CODE  
	AND A.PARA1_CODE=B.PARA1_CODE  
	AND A.PARA2_CODE=B.PARA2_CODE  
	ORDER BY ORDER_ID'  
	  
	PRINT @DTSQL  
	EXEC SP_EXECUTESQL @DTSQL  
	  
	END  

END
