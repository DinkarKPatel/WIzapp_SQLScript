CREATE PROCEDURE VALIDATEXN_PCR
(
		@CXNID VARCHAR(40),
		@NUPDATEMODE INT,					
		@CCMD VARCHAR(1000) OUTPUT
		--*** PARAMETERS :
		--*** @CXNID - TRANSACTION ID ( MEMO ID OF MASTER TABLE )
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CPEMTABLE TABLE ( PEM_MEMO_ID VARCHAR(22), PEM_MEMO_NO VARCHAR(10), PEM_MEMO_DT DATETIME, 
							   FIN_YEAR VARCHAR(10), CANCELLED BIT )
	
	INSERT @CPEMTABLE
	SELECT PEM_MEMO_ID, PEM_MEMO_NO, PEM_MEMO_DT, FIN_YEAR, CANCELLED
	FROM PEM01106 WHERE PEM_MEMO_ID = @CXNID

	SET @CCMD = ''

	IF EXISTS ( SELECT PEM_MEMO_ID FROM @CPEMTABLE WHERE CANCELLED = 1 )
		GOTO END_PROC


	IF EXISTS (SELECT PEM_MEMO_ID FROM @CPEMTABLE WHERE FIN_YEAR<>'01'+DBO.FN_GETFINYEAR(PEM_MEMO_DT))
		SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'MISMATCH BETWEEN MEMO DATE & FIN YEAR ..... '

	IF EXISTS (SELECT PEM_MEMO_ID FROM @CPEMTABLE WHERE FIN_YEAR<>SUBSTRING(PEM_MEMO_ID,3,5))
		SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'MISMATCH BETWEEN MEMO ID & FIN YEAR ..... '

END_PROC:
END
--*********************************************** END OF PROCEDURE VALIDATEXN_PCR
