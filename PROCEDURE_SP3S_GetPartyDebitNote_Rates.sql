CREATE PROCEDURE SP3S_GETPARTYDEBITNOTE_RATES
(  
    @CACCODE      VARCHAR(10)=''  
   ,@CPRODUCTCODE VARCHAR(50)
   ,@NITEMTYPE NUMERIC(1,0)=1
   ,@NAGAINSTPACKSLIP NUMERIC(1,0)=0
   ,@nBillLevelTaxmethod NUMERIC(1,0)=0
   ,@CDEPTID VARCHAR(5)=''
   ,@nBillChallanMode NUMERIC(1,0)=0
   ,@CSHIPPINGAc_CODE varchar(15)=''
   ,@nshippintMode int=0
)  
AS   
BEGIN  
	 DECLARE @DLASTPURCHASEDATE DATETIME,@CPURCHASEDAYS VARCHAR(5),@DFROMDATE DATETIME,@CSTEP VARCHAR(10),  
	 @CSEARCHPRODUCTCODE VARCHAR(100),@CCURLOCID VARCHAR(5),@CSTATECODE CHAR(7),@CLOCSSTMEMOID VARCHAR(40),
	 @CTMPTABLE VARCHAR(40),@CERRORMSG VARCHAR(MAX),@BVATFOUND BIT,@CFORMID CHAR(7),@BLOCALDEBITNOTE BIT,
	 @CMRRID VARCHAR(40),@CCMD NVARCHAR(MAX),@NBILL_CHALLAN_MODE INT,
	 @cDbName VARCHAR(max),@cpREVDbName VARCHAR(200),@cDnPc varchar(50)
	 
	
BEGIN TRY
	 
	 SET @CSTEP=10

  DECLARE @CLOC_ID VARCHAR(4),@CDONOTCHECKSTOCK VARCHAR(10),@CSP_ID varchar(40)  
  IF ISNULL(@CDEPTID,'')=''   
     SELECT TOP 1 @CLOC_ID=VALUE FROM CONFIG (NOLOCK) WHERE  CONFIG_OPTION='LOCATION_ID'  
  ELSE  
     SELECT @CLOC_ID= @CDEPTID  
	 	 
	  SELECT A.product_code ROW_ID, PRODUCT_CODE ,CAST('' AS VARCHAR(100)) AS DbNAME,  
			 MRR_ID =CAST('' AS VARCHAR(50)),BILL_CHALLAN_MODE=CAST(0 AS INT),  
		     1 QUANTITY  ,cast('' as varchar(50)) AS PS_ID,convert(varchar(50),'000') as BIN_ID,convert(varchar(500),bm.BIN_NAME) bin_name ,
			 CAST('' AS VARCHAR(50)) PS_NO,'' PS_DT,
		     CAST('' AS VARCHAR(50)) AS PID_ROW_ID,
		     CAST(0 AS NUMERIC(12,2)) AS MRP,
		     CAST('' AS VARCHAR(15)) AS AC_CODE,
			 CAST('' AS VARCHAR(15)) AS SHIPPING_AC_CODE,
			 cast('' as varchar(50)) as Stock_Product_code
	   INTO #TMPPURDETAILS  
	  FROM sku a (NOLOCK)
	  left join bin bm (nolock) on bm.bin_id= '000'
	  where a.product_code=@CPRODUCTCODE
	   
	 SET @CSTEP=20
   set @CSP_ID=CONVERT(VARCHAR(40),NEWID())

	EXEC SP3S_CALPARTYDN_RATES
	@CACCODE=@CACCODE  
	,@NAGAINSTPACKSLIP=@NAGAINSTPACKSLIP
	,@nBillLevelTaxmethod=@nBillLevelTaxmethod
	,@nBillChallanMode=@nBillChallanMode
	,@CLOC_ID=@CLOC_ID
	,@CSP_ID=@CSP_ID
	,@CERRORMSG=@CERRORMSG OUTPUT
	,@CSHIPPINGAc_CODE =@CSHIPPINGAc_CODE
    ,@nshippintMode =@nshippintMode

	GOTO END_PROC  
END TRY

BEGIN CATCH
	SET @CERRORMSG='PROCEDURE SP3S_GETPARTYDEBITNOTE_RATES STEP#'+@CSTEP+ERROR_MESSAGE()
	GOTO END_PROC  
END CATCH

END_PROC:
	SELECT ISNULL(@CERRORMSG,'') AS ERRMSG

	IF ISNULL(@CERRORMSG,'')=''
	BEGIN
		SELECT * FROM prt_item_details (nolock) where sp_id=@CSP_ID

	END		  

	DELETE FROM prt_item_details with (rowlock) where sp_id=@CSP_ID
END  