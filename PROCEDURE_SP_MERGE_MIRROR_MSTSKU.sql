CREATE PROCEDURE SP_MERGE_MIRROR_MSTSKU
(
	@NMODE INT
)
----WITH ENCRYPTION
AS


SET NOCOUNT ON
BEGIN

DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
	   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
	   ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	   ,@CERRMSG VARCHAR(1000),@CTABLESSTR VARCHAR(MAX),@CMRRIDSEARCH VARCHAR(100),@CERRORUPDPMT VARCHAR(MAX)
	    ,@EDITPUR BIT,@CMERGEDB VARCHAR(50),@CSOURCEDB VARCHAR(50),@CENABLEOPTIMIZEDSCHEMES BIT ,@NUPDATEMODENEW INT
BEGIN TRY
 
IF EXISTS(SELECT TOP 1 U.product_code FROM MSTSKU_SKU_UPLOAD U (NOLOCK)
 LEFT JOIN SKU S (NOLOCK) ON U.product_code=S.product_code WHERE S.product_code IS NULL)
   SET @NMODE=2
   
IF @NMODE=1
   GOTO EXIT_PROC
		
BEGIN TRANSACTION 

	
    SELECT @CMERGEDB='',@CSOURCEDB=''
    
    

	update A SET AC_CODE='0000000000' FROM MSTSKU_SKU_UPLOAD A
	LEFT JOIN LM01106 B ON A.AC_CODE =B.AC_CODE 
	WHERE B.AC_CODE IS NULL


    SET @CSTEP=20
	SET @CTABLENAME='SECTIONM'
	SET @CTMP_TABLENAME='MSTSKU_SECTIONM_UPLOAD'
	SET @CKEYFIELD='SECTION_CODE'
	SET @CSTEP = 21  

    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='SECTION_NAME',@CCOLKEYNAME=@CKEYFIELD

	SET @CSTEP=30
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
							  
							  
	SET @CSTEP=40
	SET @CTABLENAME='SECTIOND'
	SET @CTMP_TABLENAME='MSTSKU_SECTIOND_UPLOAD'
	SET @CKEYFIELD='SUB_SECTION_CODE'

	SET @CSTEP = 41  
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='SUB_SECTION_NAME',@CCOLKEYNAME=@CKEYFIELD

	SET @CSTEP=42
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 							  

	
	
	SET @CSTEP=44
	SET @CTABLENAME='HSN_MST'
	SET @CTMP_TABLENAME='MSTSKU_HSN_MST_UPLOAD'
	SET @CKEYFIELD='HSN_CODE'

	SET @CSTEP=45
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 							  

	
	SET @CSTEP=46
	SET @CTABLENAME='HSN_DET'
	SET @CTMP_TABLENAME='MSTSKU_HSN_DET_UPLOAD'
	SET @CKEYFIELD='Row_ID'

	SET @CSTEP=50
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 	
							  
							  
	
	SET @CSTEP=60
	SET @CTABLENAME='ARTICLE'
	SET @CTMP_TABLENAME='MSTSKU_ARTICLE_UPLOAD'
	SET @CKEYFIELD='ARTICLE_CODE'

	SET @CSTEP = 61  
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='ARTICLE_NO',@CCOLKEYNAME=@CKEYFIELD

	SET @CSTEP=70
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
    SET @CSTEP=80
	SET @CTABLENAME='PARA1'
	SET @CTMP_TABLENAME='MSTSKU_PARA1_UPLOAD'
	SET @CKEYFIELD='PARA1_CODE'

	SET @CSTEP = 81  
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA1_NAME',@CCOLKEYNAME=@CKEYFIELD

	SET @CSTEP=90
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
    SET @CSTEP=100
	SET @CTABLENAME='PARA2'
	SET @CTMP_TABLENAME='MSTSKU_PARA2_UPLOAD'
	SET @CKEYFIELD='PARA2_CODE'

	SET @CSTEP = 101  
	EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA2_NAME',@CCOLKEYNAME=@CKEYFIELD
	
	SET @CSTEP=110
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 

    SET @CSTEP=120
	SET @CTABLENAME='PARA3'
	SET @CTMP_TABLENAME='MSTSKU_PARA3_UPLOAD'
	SET @CKEYFIELD='PARA3_CODE'

	SET @CSTEP = 121  
	
	EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA3_NAME',@CCOLKEYNAME=@CKEYFIELD

	SET @CSTEP=130
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
    SET @CSTEP=140
	SET @CTABLENAME='PARA4'
	SET @CTMP_TABLENAME='MSTSKU_PARA4_UPLOAD'
	SET @CKEYFIELD='PARA4_CODE'

	SET @CSTEP = 141  

	EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA4_NAME',@CCOLKEYNAME=@CKEYFIELD

	SET @CSTEP=150
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
    SET @CSTEP=160
	SET @CTABLENAME='PARA5'
	SET @CTMP_TABLENAME='MSTSKU_PARA5_UPLOAD'
	SET @CKEYFIELD='PARA5_CODE'

	SET @CSTEP = 161  
	
	EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA5_NAME',@CCOLKEYNAME=@CKEYFIELD

	SET @CSTEP=170
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
    SET @CSTEP=180
	SET @CTABLENAME='PARA6'
	SET @CTMP_TABLENAME='MSTSKU_PARA6_UPLOAD'
	SET @CKEYFIELD='PARA6_CODE'

	SET @CSTEP = 101  
	EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA6_NAME',@CCOLKEYNAME=@CKEYFIELD

	SET @CSTEP=90
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
    SET @CSTEP=190
	SET @CTABLENAME='SKU'
	SET @CTMP_TABLENAME='MSTSKU_SKU_UPLOAD'
	SET @CKEYFIELD='PRODUCT_CODE'
	SET @CSTEP=200
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
							  
SET @CSTEP = 764
		SELECT TOP 1 @CENABLEOPTIMIZEDSCHEMES=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_OPTIMIZED_EOSS_SCHEMES'		
				
		IF ISNULL(@CENABLEOPTIMIZEDSCHEMES,'')='1'
		BEGIN
		   SET @CSTEP = 768
		   IF OBJECT_ID('TEMPDB..#TMPCMD','U') IS NOT NULL
				DROP TABLE #TMPCMD
				
		   
	       
		   SELECT  PRODUCT_CODE  INTO #TMPCMD  from  MSTSKU_SKU_UPLOAD 

		   IF OBJECT_ID('TEMPDB..#TMPFILTERCHANGE','U') IS NOT NULL
				DROP TABLE #TMPFILTERCHANGE
			
		   SELECT ROW_ID INTO #TMPFILTERCHANGE FROM SCHEME_SETUP_DET WHERE 1=2
			       
		   EXEC SP3S_GETFILTERED_TITLES 
		   @NMODE=1,
		   @CERRORMSG=@CERRMSG OUTPUT
		END
	   							  							  							  							  							  							  							  							  
    
    
	
END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP_MERGE_MIRROR_MSTSKU, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
END CATCH

EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
	END
	ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK

   		
	   DELETE FROM MSTSKU_ARTICLE_UPLOAD 
	   DELETE FROM MSTSKU_SECTIOND_UPLOAD 
	   DELETE FROM MSTSKU_SECTIONM_UPLOAD 
	   DELETE FROM MSTSKU_SKU_UPLOAD
	   DELETE FROM MSTSKU_PARA1_UPLOAD
	   DELETE FROM MSTSKU_PARA2_UPLOAD
	   DELETE FROM MSTSKU_PARA3_UPLOAD
	   DELETE FROM MSTSKU_PARA4_UPLOAD
	   DELETE FROM MSTSKU_PARA5_UPLOAD
	   DELETE FROM MSTSKU_PARA6_UPLOAD
	   DELETE FROM MSTSKU_HSN_MST_UPLOAD
	   DELETE FROM MSTSKU_HSN_DET_UPLOAD
  
   
   SELECT 'MSTSKU' AS MEMO_ID,ISNULL(@CERRMSG,'') AS ERRMSG   	  		
   
END	
---END OF PROCEDURE - SP_MERGE_MIRROR_MSTSKU
