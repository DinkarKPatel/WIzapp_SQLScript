CREATE PROCEDURE SPPPC_FG_REC_BAROCDE  
(  
 @NQUERYID INT=0,  
 @CBILL_NO VARCHAR(50)='',  
 @CJOB_CODE CHAR(7) ='',   
 @CAGENCY_CODE VARCHAR(100)='',  
 @CMEMO_ID VARCHAR(50)='',
 @CPRODUCT_CODE VARCHAR(100)='',
 @CFIN_YEAR VARCHAR(5)='',
 @CARTICLE_CODE VARCHAR(10)=''
)  
AS  
BEGIN  
   
 IF @NQUERYID=1  
    GOTO LBLAGENCY 
 ELSE IF @NQUERYID=2  
    GOTO LBLBILL_NO  
 ELSE IF @NQUERYID=3  
    GOTO LBLJOBS         
 ELSE IF @NQUERYID=4  
    GOTO LBLMST  
 ELSE IF @NQUERYID=5  
    GOTO LBLDET  
 ELSE IF @NQUERYID=6  
    GOTO MISSING_BARCODE  
 ELSE IF @NQUERYID=7  
    GOTO LBLAGENCY_VIEW         
 ELSE IF @NQUERYID=8  
    GOTO LBLBILL_NO_VIEW  
 ELSE IF @NQUERYID=9  
    GOTO LBLMEMO_VIEW 
  ELSE IF @NQUERYID=10   
    GOTO LBLBARCODEPRINT_CROSSTAB 
   
 ELSE  
 GOTO END_PROC  
   
     
      
     LBLAGENCY:  
     
      SELECT DISTINCT A.AC_CODE,B.AC_NAME
      FROM PPC_AGENCY_ISSUE_FG_MST A
      JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
      WHERE A.CANCELLED=0
      UNION
      SELECT DISTINCT A.AC_CODE,B.AC_NAME
      FROM PPC_AGENCY_ISSUE_FG_FIRST_MST A
      JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
      WHERE A.CANCELLED=0
       
    GOTO END_PROC 
      
    LBLBILL_NO:  
         
         
          IF OBJECT_ID ('TEMPDB..#TMPBARCODE','U') IS NOT NULL
			DROP TABLE #TMPBARCODE
		    
		 SELECT B.PRODUCT_CODE 
		 INTO #TMPBARCODE
		 FROM PPC_AGENCY_ISSUE_FG_MST A (NOLOCK)
		 JOIN PPC_AGENCY_ISSUE_FG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
		 WHERE A.CANCELLED =0 
		  AND (@CAGENCY_CODE='' OR A.AC_CODE =@CAGENCY_CODE)
		 UNION 
		 SELECT B.PRODUCT_CODE 
		 FROM PPC_AGENCY_ISSUE_FG_FIRST_MST A (NOLOCK)
		 JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET  B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
		 WHERE A.CANCELLED =0 
		 AND (@CAGENCY_CODE='' OR A.AC_CODE =@CAGENCY_CODE)



		 SELECT F.BILL_NO  AS ORDER_NO
		 FROM #TMPBARCODE A
		 JOIN PPC_FG_SKU B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
		 JOIN PPC_FGBCG_DET C ON C.ROW_ID =B.PPC_FGBCG_DET_ROW_ID
		 JOIN PPC_FGBCG_MST D ON C.MEMO_ID =D.MEMO_ID 
		 JOIN PPC_BUYER_ORDER_DET E ON E.ROW_ID =C.BO_DET_ROW_ID 
		 JOIN PPC_BUYER_ORDER_MST F ON F.ORDER_ID=E.ORDER_ID 
		 WHERE D.CANCELLED =0 AND F.CANCELLED =0
		 GROUP BY F.BILL_NO 
		 
		 
       --SELECT BILL_NO AS ORDER_NO   
       --FROM PPC_AGENCY_ISSUE_FG_MST A  
       --WHERE CANCELLED=0 
       --AND (@CAGENCY_CODE='' OR A.AC_CODE=@CAGENCY_CODE)
       --GROUP BY BILL_NO 
       --UNION 
       --SELECT BILL_NO AS ORDER_NO   
       --FROM PPC_AGENCY_ISSUE_FG_FIRST_MST A  
       --WHERE CANCELLED=0  
       --AND (@CAGENCY_CODE='' OR A.AC_CODE=@CAGENCY_CODE)
       --GROUP BY BILL_NO 
     
    GOTO END_PROC  
      
    LBLJOBS: --FOR FIRST TIME  
        
       SELECT  JOBS.JOB_CODE,JOBS.JOB_NAME,0 AS JOB_ORDER    
       FROM PPC_AGENCY_ISSUE_FG_MST A  
       JOIN PPC_AGENCY_ISSUE_FG_DET B ON A.MEMO_ID =B.MEMO_ID
       JOIN JOBS ON JOBS.JOB_CODE=A.JOB_CODE  
       WHERE  (@CBILL_NO ='' OR A.BILL_NO =@CBILL_NO ) 
       AND CANCELLED=0   
       GROUP BY JOBS.JOB_CODE,JOBS.JOB_NAME  
       UNION 
       SELECT  JOBS.JOB_CODE,JOBS.JOB_NAME,0 AS JOB_ORDER    
       FROM PPC_AGENCY_ISSUE_FG_FIRST_MST A  
       JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET B ON A.MEMO_ID =B.MEMO_ID
       JOIN JOBS ON JOBS.JOB_CODE=A.JOB_CODE  
       WHERE  (@CBILL_NO ='' OR A.BILL_NO =@CBILL_NO ) 
       AND CANCELLED=0   
       GROUP BY JOBS.JOB_CODE,JOBS.JOB_NAME     
          
    GOTO END_PROC  
     
    LBLMST:  
         
       SELECT CASE WHEN ISNULL(A.MEMO_TYPE,0)=1 THEN 'REGULAR' ELSE 'RETURN' END AS MEMO_TYPE,
              A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.LAST_UPDATE,  
              A.AC_CODE,LM.AC_NAME,B.BILL_NO,A.FIN_YEAR,A.NET_AMOUNT,A.CANCELLED,
              SUM(C.QUANTITY) AS TOTAL_QTY,
              ART.ARTICLE_CODE,ART.ARTICLE_NO,
              A.JOB_CODE,JOBS.JOB_NAME,
              'GST NO: '+ISNULL(COMP.GST_NO,'')  AS GST_NO,
             'GST NO: '+ISNULL(LMP.AC_GST_NO,'')  AS AC_GST_NO
       FROM  PPC_AGENCY_REC_FG_MST A  
       JOIN PPC_AGENCY_REC_FG_DET C ON A.MEMO_ID=C.MEMO_ID
       JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE  
       JOIN LMP01106 LMP ON LM.AC_CODE=LMP.AC_CODE 
       JOIN COMPANY COMP ON COMP.COMPANY_CODE='01' 
       JOIN
       (
        SELECT A.MEMO_ID,F.BILL_NO ,E.ARTICLE_CODE
        FROM PPC_AGENCY_REC_FG_DET A
        JOIN PPC_FG_SKU B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
        JOIN PPC_FGBCG_DET C ON C.ROW_ID =B.PPC_FGBCG_DET_ROW_ID
        JOIN PPC_FGBCG_MST D ON C.MEMO_ID =D.MEMO_ID 
        JOIN PPC_BUYER_ORDER_DET E ON E.ROW_ID =C.BO_DET_ROW_ID 
        JOIN PPC_BUYER_ORDER_MST F ON F.ORDER_ID=E.ORDER_ID 
        WHERE D.CANCELLED =0 AND F.CANCELLED =0
        GROUP BY A.MEMO_ID,F.BILL_NO,E.ARTICLE_CODE 
       ) B ON A.MEMO_ID =B.MEMO_ID 
       JOIN ARTICLE ART ON ART.ARTICLE_CODE=B.ARTICLE_CODE
       JOIN JOBS ON JOBS.JOB_CODE=A.JOB_CODE
       WHERE  (@CMEMO_ID ='' OR A.MEMO_ID =@CMEMO_ID ) 
       AND (@CAGENCY_CODE='' OR LM.AC_CODE=@CAGENCY_CODE) 
       AND(@CFIN_YEAR='' OR A.FIN_YEAR=@CFIN_YEAR)
       AND (@CBILL_NO='' OR B.BILL_NO=@CBILL_NO)
       AND (@CJOB_CODE='' OR JOBS.JOB_CODE =@CJOB_CODE)
       GROUP BY CASE WHEN ISNULL(A.MEMO_TYPE,0)=1 THEN 'REGULAR' ELSE 'RETURN' END ,
       A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.LAST_UPDATE,  
       A.AC_CODE,LM.AC_NAME,B.BILL_NO,A.FIN_YEAR,A.NET_AMOUNT,A.CANCELLED,
       ART.ARTICLE_CODE,ART.ARTICLE_NO,A.JOB_CODE,JOBS.JOB_NAME,
       'GST NO: '+ISNULL(COMP.GST_NO,'')  , 'GST NO: '+ISNULL(LMP.AC_GST_NO,'')
       ORDER BY A.MEMO_DT DESC,A.MEMO_ID DESC
    GOTO END_PROC  
      
      
    LBLDET:  
         
         IF @CMEMO_ID=''
         BEGIN
			 SELECT CAST(1 AS BIT) AS CHK,
				   CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
				   ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
				   A.AC_CODE,LM.AC_NAME ,
				   IM.BILL_NO,
				   B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
				   B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				   B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
				   B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
				   SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
				   IM.JOB_CODE,
				   JOBS.JOB_NAME,
				   ID.PRODUCT_CODE,
				   1 AS QUANTITY,
				   PMT.QUANTITY_IN_STOCK,
				   CAST(0 AS NUMERIC(10,2)) AS RATE,
				   CAST(0 AS NUMERIC(10,2)) AS AMOUNT,
				   ID.ROW_ID AS REF_ROW_ID ,
				   B.BO_DET_ROW_ID AS BO_ROW_ID
				FROM PPC_FGBCG_MST A
				JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
				JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
				JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE 
				JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
				JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
				JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
				JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
				JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
				JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
				JOIN PPC_AGENCY_ISSUE_FG_DET ID ON ID.PRODUCT_CODE=PMT.PRODUCT_CODE
				JOIN PPC_AGENCY_ISSUE_FG_MST IM ON ID.MEMO_ID=IM.MEMO_ID
				JOIN JOBS ON JOBS.JOB_CODE=IM.JOB_CODE
				WHERE PMT.QUANTITY_IN_STOCK=0 AND IM.CANCELLED=0
				AND PMT.PRODUCT_CODE=@CPRODUCT_CODE
				AND JOBS.JOB_CODE=@CJOB_CODE
				AND IM.AC_CODE=@CAGENCY_CODE
				UNION ALL
				 SELECT CAST(1 AS BIT) AS CHK,
				   CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
				   ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
				   A.AC_CODE,LM.AC_NAME ,
				   IM.BILL_NO,
				   B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
				   B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				   B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
				   B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
				   SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
				   JOBS.JOB_CODE,
				   JOBS.JOB_NAME,
				   ID.PRODUCT_CODE,
				   1 AS QUANTITY,
				   PMT.QUANTITY_IN_STOCK,
				   CAST(0 AS NUMERIC(10,2)) AS RATE,
				   CAST(0 AS NUMERIC(10,2)) AS AMOUNT ,
				   ID.ROW_ID AS REF_ROW_ID,
				   B.BO_DET_ROW_ID AS BO_ROW_ID
				FROM PPC_FGBCG_MST A
				JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
				JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
				JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE 
				JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
				JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
				JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
				JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
				JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
				JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
				JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET ID ON ID.PRODUCT_CODE=PMT.PRODUCT_CODE
				JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST IM ON ID.MEMO_ID=IM.MEMO_ID
				JOIN JOBS ON JOBS.JOB_CODE=IM.JOB_CODE
				WHERE PMT.QUANTITY_IN_STOCK=0 AND IM.CANCELLED=0
				AND PMT.PRODUCT_CODE=@CPRODUCT_CODE
				AND JOBS.JOB_CODE=@CJOB_CODE
				AND IM.AC_CODE=@CAGENCY_CODE
				
           END 
           ELSE
          BEGIN
               
                SELECT CAST(CASE WHEN ISNULL(ID.MISSING_PRODUCT_CODE,0) =1 THEN 1 ELSE 0 END AS BIT) AS CHK,
				   IM.MEMO_ID AS MEMO_ID,
				   IM.MEMO_NO,
				   CONVERT(VARCHAR,IM.MEMO_DT,105) AS MEMO_DT,
				   ROW_ID=ID.ROW_ID,
				   A.AC_CODE,LM.AC_NAME ,
				   IM.BILL_NO,
				   B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
				   B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				   B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
				   B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
				   SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
				   IM.JOB_CODE,
				   JOBS.JOB_NAME,
				   ID.PRODUCT_CODE,
				   ID.QUANTITY,
				   PMT.QUANTITY_IN_STOCK,
				   ID.RATE,
				   ID.AMOUNT,
		           ISNULL(ID.MISSING_PRODUCT_CODE,0) AS MISSING_PRODUCT_CODE,
		           ID.REF_ROW_ID
				FROM PPC_FGBCG_MST A
				JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
				JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
				JOIN PPC_FG_PMT PMT ON SKU.PRODUCT_CODE=PMT.PRODUCT_CODE 
				JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
				JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
				JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
				JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
				JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
				JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
				JOIN PPC_AGENCY_REC_FG_DET ID ON ID.PRODUCT_CODE=SKU.PRODUCT_CODE
				JOIN PPC_AGENCY_REC_FG_MST IM ON ID.MEMO_ID=IM.MEMO_ID
				JOIN JOBS ON JOBS.JOB_CODE=IM.JOB_CODE
				WHERE IM.MEMO_ID=@CMEMO_ID	
           END
    GOTO END_PROC  
     
     
     MISSING_BARCODE:
     
        IF OBJECT_ID ('TEMPDB..#TMPPENDING','U') IS NOT NULL
           DROP TABLE #TMPPENDING
 
		 SELECT A.AC_CODE,LM.AC_NAME ,
				IM.BILL_NO,
				B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
				B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				B.PARA1_CODE,P1.PARA1_NAME ,
				B.PARA3_CODE,P3.PARA3_NAME,
				SKU.PARA2_CODE,P2.PARA2_NAME,
				IM.JOB_CODE,
				JOBS.JOB_NAME,
				ID.PRODUCT_CODE,
				1 AS QUANTITY,
				PMT.QUANTITY_IN_STOCK
		 INTO #TMPPENDING
		 FROM PPC_FGBCG_MST A
		 JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
		 JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
		 JOIN PPC_FG_PMT PMT ON SKU.PRODUCT_CODE=PMT.PRODUCT_CODE 
		 JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
		 JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
		 JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
		 JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
		 JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
		 JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
		 JOIN PPC_AGENCY_ISSUE_FG_DET ID ON ID.PRODUCT_CODE=SKU.PRODUCT_CODE
		 JOIN PPC_AGENCY_ISSUE_FG_MST IM ON ID.MEMO_ID=IM.MEMO_ID
		 JOIN JOBS ON JOBS.JOB_CODE=IM.JOB_CODE
		WHERE PMT.QUANTITY_IN_STOCK=0 AND IM.CANCELLED=0
		AND JOBS.JOB_CODE=@CJOB_CODE
		AND IM.AC_CODE=@CAGENCY_CODE
		AND IM.BILL_NO=@CBILL_NO
		UNION ALL
		 SELECT A.AC_CODE,LM.AC_NAME ,
				IM.BILL_NO,
				B.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
				B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				B.PARA1_CODE,P1.PARA1_NAME ,
				B.PARA3_CODE,P3.PARA3_NAME,
				SKU.PARA2_CODE,P2.PARA2_NAME,
				IM.JOB_CODE,
				JOBS.JOB_NAME,
				ID.PRODUCT_CODE,
				1 AS QUANTITY,
				PMT.QUANTITY_IN_STOCK
		 FROM PPC_FGBCG_MST A
		 JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
		 JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
		 JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE
		 JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
		 JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
		 JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
		 JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
		 JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
		 JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
		 JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET ID ON ID.PRODUCT_CODE=PMT.PRODUCT_CODE
		 JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST IM ON ID.MEMO_ID=IM.MEMO_ID
		 JOIN JOBS ON JOBS.JOB_CODE=IM.JOB_CODE
		WHERE PMT.QUANTITY_IN_STOCK=0 AND IM.CANCELLED=0
		AND JOBS.JOB_CODE=@CJOB_CODE
		AND IM.AC_CODE=@CAGENCY_CODE
		AND IM.BILL_NO=@CBILL_NO
		--AND JOBS.JOB_CODE=@CJOB_CODE

		SELECT   CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
				 ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
				A.AC_CODE,A.AC_NAME ,
				A.BILL_NO,
				A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,
				A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,
				A.PARA1_CODE,A.PARA1_NAME ,
				A.PARA3_CODE,A.PARA3_NAME
		FROM #TMPPENDING A
		GROUP BY A.AC_CODE,A.AC_NAME ,
				A.BILL_NO,
				A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,
				A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,
				A.PARA1_CODE,A.PARA1_NAME ,
				A.PARA3_CODE,A.PARA3_NAME 

		SELECT  CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
				ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
				A.AC_CODE,A.AC_NAME ,
				A.BILL_NO,
				A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,
				A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,
				A.PARA1_CODE,A.PARA1_NAME ,
				A.PARA3_CODE,A.PARA3_NAME,
				A.PARA2_CODE,A.PARA2_NAME,
				CAST(0 AS NUMERIC(10,0)) AS SELECT_QTY
		FROM #TMPPENDING A
		GROUP BY A.AC_CODE,A.AC_NAME ,
				A.BILL_NO,
				A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,
				A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,
				A.PARA1_CODE,A.PARA1_NAME ,
				A.PARA3_CODE,A.PARA3_NAME, A.PARA2_CODE,A.PARA2_NAME

						
     GOTO END_PROC  
     
    LBLAGENCY_VIEW:  
     
      SELECT DISTINCT A.AC_CODE,B.AC_NAME
      FROM PPC_AGENCY_REC_FG_MST A
      JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
    
    GOTO END_PROC 
      
    LBLBILL_NO_VIEW:  
         
       SELECT DISTINCT BILL_NO AS ORDER_NO   
       FROM PPC_AGENCY_ISSUE_FG_MST A  
       WHERE CANCELLED=0  
       AND (@CAGENCY_CODE='' OR AC_CODE=@CAGENCY_CODE)
       GROUP BY BILL_NO  
         
    GOTO END_PROC  
      
    LBLMEMO_VIEW: --FOR FIRST TIME  
        
       SELECT DISTINCT A.MEMO_NO,A.MEMO_ID  
       FROM PPC_AGENCY_ISSUE_FG_MST A  
       WHERE  (@CBILL_NO ='' OR A.BILL_NO =@CBILL_NO )  
       AND (@CAGENCY_CODE='' OR AC_CODE=@CAGENCY_CODE)  
   
          
    GOTO END_PROC  
     
     LBLBARCODEPRINT_CROSSTAB:
        

        IF OBJECT_ID ('TEMPDB..#TMPALLOTEDPRINT','P') IS NOT NULL
           DROP TABLE #TMPALLOTEDPRINT
           
	
				      
			SELECT PR.ROW_ID, PR.MEMO_ID,A.AC_CODE,LM.AC_NAME,DET.BILL_NO,
				B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,
				SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				SKU.PARA1_CODE,P1.PARA1_NAME,
				SKU.PARA2_CODE,P2.PARA2_NAME,
				SKU.PARA3_CODE,P3.PARA3_NAME ,
				SKU.PRODUCT_CODE,
				PR.JOB_CODE,
				PR.JOB_NAME,
				CASE WHEN ISNULL(PR.MISSING_PRODUCT_CODE,0)=0 THEN  PR.REC_QTY ELSE 0 END AS REC_QTY,
				CASE WHEN ISNULL(PR.MISSING_PRODUCT_CODE,0)=1 THEN  PR.REC_QTY ELSE 0 END AS MISSING_QTY,
				PR.MISSING_PRODUCT_CODE,
				DET.ROW_ID AS BO_ROW_ID
				INTO #TMPALLOTEDPRINT
			FROM PPC_FGBCG_MST A
			JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
			JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
			JOIN
			(
			  SELECT  B.AC_CODE,A.ARTICLE_CODE ,
				ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
				JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
				WHERE B.CANCELLED=0
			  GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
			JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
			JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
			JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
			JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
			JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
			JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
		    JOIN
			(
				SELECT ISNULL(A.MISSING_PRODUCT_CODE,0) AS MISSING_PRODUCT_CODE,A.ROW_ID, B.JOB_CODE,JOBS.JOB_NAME, A.MEMO_ID, PRODUCT_CODE
				,A.QUANTITY AS REC_QTY
				FROM PPC_AGENCY_REC_FG_DET  A
				JOIN PPC_AGENCY_REC_FG_MST B ON A.MEMO_ID =B.MEMO_ID 
				JOIN JOBS ON JOBS.JOB_CODE=B.JOB_CODE
				WHERE B.CANCELLED=0
				AND A.MEMO_ID=@CMEMO_ID
			) PR ON PR.PRODUCT_CODE =SKU.PRODUCT_CODE
			
			
	
			
			SELECT 
				A.AC_CODE,
				A.AC_NAME,
				A.BILL_NO,
				A.ARTICLE_CODE,
				A.ARTICLE_NO,
				A.PARA1_CODE,
				A.PARA1_NAME,
				A.SIZEGROUP_CODE,
				A.SIZEGROUP_NAME,
				A.PARA3_CODE,
				A.PARA3_NAME,
				--A.MISSING_PRODUCT_CODE,
                CAST(SUM(ISNULL(REC_QTY,0)) AS NUMERIC(10,0)) AS REC_QTY,
                CAST(SUM(ISNULL(MISSING_QTY,0)) AS NUMERIC(10,0)) AS MISSING_QTY,
                CAST('' AS VARCHAR(100)) AS IMAGE_1,
                A.BO_ROW_ID
				FROM #TMPALLOTEDPRINT A 
				GROUP BY A.AC_CODE,A.AC_NAME,A.BILL_NO,
				A.PARA1_CODE,A.PARA1_NAME,A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,
				A.PARA3_CODE,A.PARA3_NAME, A.ARTICLE_CODE,
				A.ARTICLE_NO, A.BO_ROW_ID
				
			    
				
				
		SELECT MEMO_ID,
        ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
        A.AC_CODE,A.AC_NAME,A.BILL_NO,A.ARTICLE_CODE,
		A.ARTICLE_NO,A.PARA1_CODE,
		A.PARA1_NAME,A.SIZEGROUP_CODE,
		A.SIZEGROUP_NAME,A.PARA3_CODE,A.PARA3_NAME,
        PARA2_CODE,PARA2_NAME,
       -- A.MISSING_PRODUCT_CODE,
         CAST(SUM(ISNULL(REC_QTY,0)) AS NUMERIC(10,0)) AS REC_QTY,
        CAST(SUM(ISNULL(MISSING_QTY,0)) AS NUMERIC(10,0)) AS MISSING_QTY,
        A.BO_ROW_ID
        FROM #TMPALLOTEDPRINT A
        GROUP BY MEMO_ID,PARA2_CODE,PARA2_NAME,A.AC_CODE,A.AC_NAME,A.BILL_NO,A.ARTICLE_CODE,
		A.ARTICLE_NO,A.PARA1_CODE,
		A.PARA1_NAME,A.SIZEGROUP_CODE,
		A.SIZEGROUP_NAME,A.PARA3_CODE,A.PARA3_NAME,A.BO_ROW_ID
		
		
		
           
 END_PROC:  
   
END
