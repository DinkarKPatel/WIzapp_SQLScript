CREATE PROCEDURE SP_SYNCH_MIRRORDATA_SNC_SINGLE
(
	@CLOCID VARCHAR(3)
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN

	DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
		   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
		   ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
		   ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(MAX)
		   ,@CMEMOID VARCHAR(100),@NVERSIONNO INT,
	        @CMEMOIDSEARCH varchar(100),@BADDMODE bit,@CMERGEDB varchar(100),@CSOURCEDB varchar(100),
	        @BMSTINSERTONLY bit
	BEGIN TRY
  

	LBLSTART:
	 SET @CMERGEDB=''
	 SET @CSOURCEDB=''
     SELECT @CMEMOID='',@NVERSIONNO=0
	 set @BMSTINSERTONLY=1
  BEGIN TRANSACTION 
    SELECT TOP 1 @CMEMOID = B.MEMO_ID ,@NVERSIONNO=VERSION_NO
    FROM SNC_SNC_MST_MIRROR  B (NOLOCK)
    LEFT OUTER JOIN MIRROR_SYNCH_LOG C (NOLOCK) ON C.MEMO_ID=B.MEMO_ID  AND C.XN_TYPE='IRR'
    WHERE (LEFT(B.MEMO_ID,2)=@CLOCID )  AND DATEDIFF(SS,B.VERSION_LAST_UPDATE,GETDATE())>60 
	AND C.MEMO_ID IS NULL
    ORDER BY B.MEMO_ID,VERSION_NO DESC
    
    IF ISNULL(@CMEMOID,'')=''
		GOTO EXIT_PROC
		
    SET @CFILTERCONDITION = 'B.SNC_MEMO_ID='''+@CMEMOID+''' AND B.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO)))
	
	SET @CMEMOIDSEARCH=''
	SELECT TOP 1 @CMEMOIDSEARCH=A.irm_memo_id  FROM irm01106  A (NOLOCK) WHERE A.irm_memo_id =@CMEMOID
	
	IF ISNULL(@CMEMOIDSEARCH,'')<>''
		SET @BADDMODE=0
	ELSE
		SET @BADDMODE=1

	
LBLMERGE:
	---DELETING EXISTING RECORD IF BILL COMES AGAIN FOR MERGING
	IF @BADDMODE=0
		PRINT 'ADDMODE:N'
	ELSE
		PRINT 'ADDMODE:Y'	


  IF ISNULL(@BADDMODE,0)=0
  BEGIN

		SET @CSTEP=5
		DELETE A FROM SNC_BARCODE_DET A (NOLOCK)
		JOIN SNC_SNC_DET_MIRROR B ON A.REFROW_ID=B.ROW_ID
		WHERE B.MEMO_ID=@CMEMOID

		DELETE  FROM SNC_CONSUMABLE_DET WHERE MEMO_ID =@CMEMOID
		DELETE  FROM SNC_DET WHERE MEMO_ID =@CMEMOID
	
	END
	   DECLARE @CWHERE VARCHAR(100)
	   SET @CWHERE=' AND SNC_MEMO_ID='''+@CMEMOID+''''
		
		SET @CTABLENAME='PARA1'
		SET @CTMP_TABLENAME='SNC_PARA1_MIRROR'
		SET @CKEYFIELD='PARA1_CODE'
		SET @CSTEP=120
		
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA1_NAME',@CCOLKEYNAME=@CKEYFIELD ,@CWHERE=@CWHERE

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
		SET @CSTEP=130
		SET @CTABLENAME='PARA2'
		SET @CTMP_TABLENAME='SNC_PARA2_MIRROR'
		SET @CKEYFIELD='PARA2_CODE'
		SET @CSTEP=140
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA2_NAME',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
								  
		SET @CSTEP=150
		SET @CTABLENAME='PARA3'
		SET @CTMP_TABLENAME='SNC_PARA3_MIRROR'
		SET @CKEYFIELD='PARA3_CODE'
		SET @CSTEP=160
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA3_NAME',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1		
		SET @CSTEP=170
		SET @CTABLENAME='PARA4'
		SET @CTMP_TABLENAME='SNC_PARA4_MIRROR'
		SET @CKEYFIELD='PARA4_CODE'
		SET @CSTEP=180
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA4_NAME',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
		SET @CSTEP=190
		SET @CTABLENAME='PARA5'
		SET @CTMP_TABLENAME='SNC_PARA5_MIRROR'
		SET @CKEYFIELD='PARA5_CODE'
		SET @CSTEP=200
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA5_NAME',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
								  								  								  						  						  						  
		SET @CSTEP=210
		SET @CTABLENAME='PARA6'
		SET @CTMP_TABLENAME='SNC_PARA6_MIRROR'
		SET @CKEYFIELD='PARA6_CODE'
		SET @CSTEP=220
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA6_NAME',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
							  
		
		SET @CSTEP=250
		SET @CTABLENAME='SECTIONM'
		SET @CTMP_TABLENAME='SNC_SECTIONM_MIRROR'
		SET @CKEYFIELD='SECTION_CODE'
		SET @CSTEP=260
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='SECTION_NAME',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1	
		
		SET @CSTEP=250
		SET @CTABLENAME='SECTIOND'
		SET @CTMP_TABLENAME='SNC_SECTIOND_MIRROR'
		SET @CKEYFIELD='SUB_SECTION_CODE'
		SET @CSTEP=260
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='SUB_SECTION_NAME',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1	
								  
		
										  
        SET @CSTEP=230
		SET @CTABLENAME='ARTICLE'
		SET @CTMP_TABLENAME='SNC_ARTICLE_MIRROR'
		SET @CKEYFIELD='ARTICLE_CODE'
		SET @CSTEP=240
				
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='ARTICLE_NO',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1	
								  
       								  									  								  							  
		
		SET @CSTEP=250
		SET @CTABLENAME='SKU'
		SET @CTMP_TABLENAME='SNC_SKU_MIRROR'
		SET @CKEYFIELD='PRODUCT_CODE'
		SET @CSTEP=260
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1	
								  						  
		SET @CSTEP=250
		SET @CTABLENAME='SKU_OH'
		SET @CTMP_TABLENAME='SNC_SKU_OH_MIRORR'
		SET @CKEYFIELD='PRODUCT_CODE'
		SET @CSTEP=260
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1							  						  						  
		SET @CFILTERCONDITION  = 'B.MEMO_ID='''+@CMEMOID+''' AND B.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO)))
							  
		SET @CSTEP=300
		SET @CTABLENAME='SNC_MST'
		SET @CTMP_TABLENAME='SNC_SNC_MST_MIRROR'
		SET @CKEYFIELD='MEMO_ID'
		SET @CSTEP=320
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1 
		
		SET @CSTEP=350
		SET @CTABLENAME='SNC_DET'
		SET @CTMP_TABLENAME='SNC_SNC_DET_MIRROR'
		SET @CKEYFIELD='MEMO_ID'
		SET @CSTEP=360
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1 						  
		

		SET @CSTEP=400
		SET @CTABLENAME='SNC_CONSUMABLE_DET'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='MEMO_ID'
		SET @CSTEP=500
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1 
		
		
			SET @CFILTERCONDITION  = 'B.SNC_MEMO_ID='''+@CMEMOID+''' AND B.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO)))
			

		SET @CSTEP=600
		SET @CTABLENAME='SNC_BARCODE_DET'
		SET @CTMP_TABLENAME='TMP_SNC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='REFROW_ID'
		SET @CSTEP=700
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1 
							

		SET @CSTEP=705 
		
	EXEC SP3S_MERGE_LOCPMT  
	@cTempTable='SNC_PMT01106_MIRROR',  
	@cMemoIdCol='SNC_MEMO_ID',  
	@cMemoId =@CMEMOID

		SET @cStep=710
	
	DELETE A FROM SNC_ARTICLE_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_PARA1_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_PARA2_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_PARA3_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_PARA4_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_PARA5_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_PARA6_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_PMT01106_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_SECTIOND_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_SECTIONM_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_SKU_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_SKU_OH_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_SNC_BARCODE_DET_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID
	DELETE A FROM SNC_SNC_CONSUMABLE_DET_MIRROR A (NOLOCK) WHERE SNC_MEMO_ID=@CMEMOID

	DELETE A FROM SNC_SNC_DET_MIRROR A (NOLOCK) WHERE MEMO_ID=@CMEMOID
	DELETE A FROM SNC_SNC_MST_MIRROR A (NOLOCK) WHERE MEMO_ID=@CMEMOID
	
	 IF ISNULL(@CERRMSG,'')=''
		COMMIT
	ELSE
		GOTO EXIT_PROC
	
    GOTO LBLSTART
								  						  
	END TRY
	BEGIN CATCH
		SET @CERRMSG='P:SP_SYNCH_MIRRORDATA_SNC_SINGLE, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH

EXIT_PROC:	
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
	END
	ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK
END
