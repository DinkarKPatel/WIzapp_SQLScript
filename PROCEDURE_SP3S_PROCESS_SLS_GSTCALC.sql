CREATE PROCEDURE SP3S_PROCESS_SLS_GSTCALC
@NSPID VARCHAR(40),
@BDEBUGMODE BIT,
@DXNDT DATETIME,
@CERRORMSG VARCHAR(MAX) OUTPUT
AS
BEGIN
	DECLARE @NSTEP INT,@CPARTYSTATECODE CHAR(7),@NPARTYTYPE NUMERIC(2,0),@CPARTY_GSTN_NO VARCHAR(40)
	
	SET @NSTEP = 270
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,@BDEBUGMODE		

	DECLARE @BLOCALBILL BIT,@NATDCHARGES NUMERIC(10,2)
	
	SELECT @CPARTYSTATECODE='',@BLOCALBILL=0
	
				
	DELETE FROM GST_TAXINFO_CALC WHERE SP_ID=@NSPID
	
	INSERT GST_TAXINFO_CALC	( PRODUCT_CODE, SP_ID ,NET_VALUE,TAX_METHOD,ROW_ID,QUANTITY )  
	SELECT PRODUCT_CODE,@NSPID AS SP_ID,(NET-ISNULL(CMM_DISCOUNT_AMOUNT,0)) AS NET_VALUE,
	(CASE WHEN TAX_METHOD=2 THEN 1 ELSE 2 END) AS TAX_METHOD,ROW_ID,QUANTITY FROM SLS_CMD01106_UPLOAD WHERE SP_ID=@NSPID


	SET @NSTEP = 280
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,@BDEBUGMODE		
	SET @CPARTY_GSTN_NO = ''

	IF EXISTS (SELECT TOP 1 CUSTOMER_CODE FROM SLS_CMM01106_UPLOAD WHERE SP_ID=@NSPID AND
		CUSTOMER_CODE IN ('','000000000000') AND PARTY_TYPE<>2 )
		SET @BLOCALBILL=1
	ELSE
	BEGIN
		
		SET @NSTEP = 290
		EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,@BDEBUGMODE		
	
		SELECT @NPARTYTYPE=PARTY_TYPE FROM SLS_CMM01106_UPLOAD WHERE SP_ID=@NSPID
		IF @NPARTYTYPE=2
			SELECT @CPARTY_GSTN_NO=AC_GST_NO,@CPARTYSTATECODE=A.PARTY_STATE_CODE
			FROM SLS_CMM01106_UPLOAD A JOIN LMP01106 B ON A.AC_CODE=B.AC_CODE
			WHERE SP_ID=@NSPID
		ELSE
			SELECT @CPARTY_GSTN_NO=ISNULL(CUS_GST_NO,''),@CPARTYSTATECODE=A.PARTY_STATE_CODE
			FROM SLS_CMM01106_UPLOAD A JOIN CUSTDYM B ON A.CUSTOMER_CODE=B.CUSTOMER_CODE
			WHERE SP_ID=@NSPID				
	END

	SET @NSTEP = 300
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,@BDEBUGMODE		
							
	EXEC SP3S_GST_TAX_CAL
	@CXN_TYPE='SLS',
	@CMEMO_ID='',
	@DMEMO_DT=@DXNDT,
	@NSPID=@NSPID,
	@CPARTYSTATE_CODE=@CPARTYSTATECODE,
	@BLOCALBILL=@BLOCALBILL,
	@CPARTY_GSTN_NO=@CPARTY_GSTN_NO,
	@CERRMSG=@CERRORMSG OUTPUT
	
	IF ISNULL(@CERRORMSG,'')<>''
		GOTO END_PROC

	SET @NSTEP = 305
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,@BDEBUGMODE		
	
	UPDATE SLS_CMD01106_UPLOAD SET TAX_AMOUNT=0,TAX_PERCENTAGE=0,
	HSN_CODE=B.HSN_CODE,GST_PERCENTAGE=B.GST_PERCENTAGE,IGST_AMOUNT=B.IGST_AMOUNT,
	CGST_AMOUNT=B.CGST_AMOUNT,SGST_AMOUNT=B.SGST_AMOUNT,
	XN_VALUE_WITHOUT_GST=B.XN_VALUE_WITHOUT_GST,XN_VALUE_WITH_GST=B.XN_VALUE_WITH_GST
	FROM GST_TAXINFO_CALC B WHERE B.ROW_ID=SLS_CMD01106_UPLOAD.ROW_ID AND B.SP_ID=SLS_CMD01106_UPLOAD.SP_ID
	AND SLS_CMD01106_UPLOAD.SP_ID=@NSPID						
	AND (SLS_CMD01106_UPLOAD.QUANTITY>0 OR SLS_CMD01106_UPLOAD.REF_SLS_MEMO_DT>'2017-06-30')
	
	SET @NSTEP = 307
	EXEC SP_CHKXNSAVELOG 'SLS_TMP',@NSTEP,0,@NSPID,@BDEBUGMODE		
	PRINT 'CALL REPROCESS GST FOR SLS-2'
	EXEC SP3S_REPROCESS_GST_CALCULATION '','SLS',@NSPID,@CERRORMSG OUTPUT 
	IF ISNULL(@CERRORMSG,'')<>''
		 GOTO END_PROC


END_PROC:		 
			
END
