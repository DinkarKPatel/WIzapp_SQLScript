CREATE PROCEDURE DBO.SP_SEND_MIRROR_MSTANGM_NEW--(LocId 3 digit change by Sanjay:06-11-2024)
(
 @CTARGETLOCID VARCHAR(5)
)
AS
 BEGIN
   DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION NVARCHAR(MAX)
           ,@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPLMTABLE VARCHAR(100)
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CCURDEPTID VARCHAR(5)
           ,@CHODEPTID VARCHAR(5),@CERRORMSG VARCHAR(MAX),@CREPLOCTABLE VARCHAR(500),@NLOCTYPE INT
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(4),@JOINMASTERTABLE VARCHAR(200),@JOINTEMPTABLE VARCHAR(200)
           , @JOINMASTERTABLE1 VARCHAR(MAX), @JOINTEMPTABLE1 VARCHAR(MAX)
    DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),ERRMSG VARCHAR(MAX)) 
    
    BEGIN TRY
    
	SET @CSTEP=0

	SET @CTEMPDBNAME = ''
	 
	SET @CSTEP=00
	 
	SET @CSTEP=10
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	SET @CFILTERCONDITION=''
	 
	SET @CSTEP=20

	SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
	
	SELECT @NLOCTYPE=LOC_TYPE FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	
	IF @CCURDEPTID<>@CHODEPTID
	BEGIN
		SELECT '' AS LAST_UPDATE,'' AS ERRMSG
		
		GOTO END_PROC
	END		
 --   SET @CSTEP=30
	--SELECT TOP 1 @CLOCMERGINGTHRUWIZCOM=VALUE FROM CONFIG WHERE CONFIG_OPTION='MSTLOC_THRU_WIZCOM'
	
	
	--IF ISNULL(@CLOCMERGINGTHRUWIZCOM,'')='1'
	--BEGIN
	--	SET @CERRORMSG='MSTANGM MASTER MERGING THROUGN MIRRORSERVICE HAS BEEN DISABLED'
	--	GOTO END_PROC
	--END
	
	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=40
    ---SELECT DATA FROM PRD_AGENCY_MST TABLE
	SET @CTABLENAME = 'ANGM'

   SELECT DISTINCT  'MSTANGM_ANGM_MIRROR' AS TARGET_TABLENAME,ANGM.*,1 AS PICK_FROM_CURRENT_DB FROM ANGM (NOLOCK)

	
	SET @CSTEP=50
	 ---SELECT DATA FROM HD01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106  
	SET @CTABLENAME = 'LM01106'
	SELECT DISTINCT  'MSTANGM_LM01106_MIRROR' AS TARGET_TABLENAME,LM01106.*,1 AS PICK_FROM_CURRENT_DB FROM LM01106 (NOLOCK)
	JOIN ANGM (NOLOCK) ON LM01106.AC_CODE = ANGM.AC_CODE

 
	
	---INSERT TEMP TABLE AND ORGINAL TABLE NAME INTO OUTPUT TABLE

	SET @CSTEP=60
	 ---SELECT DATA FROM LMP01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106  
	SET @CTABLENAME = 'LMP01106'

	SELECT DISTINCT  'MSTANGM_LMP01106_MIRROR' AS TARGET_TABLENAME,LMP01106.*,1 AS PICK_FROM_CURRENT_DB FROM LMP01106 (NOLOCK)
	JOIN ANGM (NOLOCK) ON LMP01106.AC_CODE = ANGM.AC_CODE
	
	---INSERT TEMP TABLE AND ORGINAL TABLE NAME INTO OUTPUT TABLE

	
	SET @CSTEP=70
	 ---SELECT DATA FROM HD01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106  
	SET @CTABLENAME = 'HD01106'

	SELECT DISTINCT  'MSTANGM_HD01106_MIRROR' AS TARGET_TABLENAME,HD01106.*,1 AS PICK_FROM_CURRENT_DB FROM HD01106 (NOLOCK)
	JOIN LM01106 (NOLOCK) ON LM01106.HEAD_CODE=HD01106.HEAD_CODE 
	JOIN ANGM (NOLOCK) ON LM01106.AC_CODE = ANGM.AC_CODE
 
	 
	 SET @CSTEP=80
	--SELECT DATA FROM AREA TABLE 
	SET @CTABLENAME = 'AREA'

	IF OBJECT_ID('TEMPDB..#TMPAREA','U') IS NOT NULL
	   DROP TABLE #TMPAREA

	   SELECT AREA_CODE into #TMPAREA  FROM ANGM (NOLOCK)
	   UNION
	   SELECT LMP01106.AREA_CODE FROM LMP01106 (NOLOCK)
	   JOIN ANGM (NOLOCK) ON LMP01106.AC_CODE = ANGM.AC_CODE

      SELECT DISTINCT  'MSTANGM_AREA_MIRROR' AS TARGET_TABLENAME,AREA.*,1 AS PICK_FROM_CURRENT_DB FROM AREA (NOLOCK)
	  JOIN #TMPAREA TMP ON AREA.AREA_CODE=TMP.AREA_CODE
	
	---INSERT TEMP TABLE AND ORGINAL TABLE NAME INTO OUTPUT TABLE


    SET @CSTEP=90
   --SELECT DATA FROM AREA TABLE 
	SET @CTABLENAME = 'CITY'

	SELECT DISTINCT  'MSTANGM_CITY_MIRROR' AS TARGET_TABLENAME,CITY.*,1 AS PICK_FROM_CURRENT_DB FROM CITY (NOLOCK)
	join  AREA (NOLOCK) on CITY .CITY_CODE =area .city_code 
	JOIN #TMPAREA TMP ON AREA.AREA_CODE=TMP.AREA_CODE

	   

    SET @CSTEP=100
 --SELECT DATA FROM STATE TABLE 
	SET @CTABLENAME = 'STATE'
	SELECT DISTINCT  'MSTANGM_STATE_MIRROR' AS TARGET_TABLENAME,STATE.*,1 AS PICK_FROM_CURRENT_DB FROM STATE (NOLOCK)
	join CITY (NOLOCK) on state .state_code =CITY .state_code 
	join  AREA (NOLOCK) on CITY .CITY_CODE =area .city_code 
	JOIN #TMPAREA TMP ON AREA.AREA_CODE=TMP.AREA_CODE


	


    SET @CSTEP=110
 --SELECT DATA FROM STATE TABLE 
	SET @CTABLENAME = 'REGIONM'

	SELECT DISTINCT  'MSTANGM_REGIONM_MIRROR' AS TARGET_TABLENAME,REGIONM.*,1 AS PICK_FROM_CURRENT_DB FROM REGIONM (NOLOCK)
	join STATE (NOLOCK) on REGIONM.region_code =state .region_code 
	join CITY (NOLOCK) on state .state_code =CITY .state_code 
	join  AREA (NOLOCK) on CITY .CITY_CODE =area .city_code 
	JOIN #TMPAREA TMP ON AREA.AREA_CODE=TMP.AREA_CODE
	
	
     

	
	END TRY
	
	BEGIN CATCH
	    SET @CERRORMSG='P: SP_SEND_MIRROR_MSTANGM_new, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()+ 'ERROR QUERY || '+@DTSQL
	    GOTO END_PROC
    END CATCH 
    
    END_PROC:
    
    SELECT  ISNULL(@CERRORMSG,'') AS ERRMSG
 END
