CREATE PROCEDURE SP_TRANHISTORY
@NQUERYID NUMERIC(3,0),      
@CWHERE  VARCHAR(500),      
@CFINYEAR VARCHAR(5),      
@NNAVMODE NUMERIC(1,0),      
@CMEMOID VARCHAR(40)      
--      WITH ENCRYPTION

AS        
BEGIN        
       
DECLARE @CCMD NVARCHAR(4000)       
 IF @NQUERYID=1      
GOTO LBLMEMOMASTER           
ELSE IF @NQUERYID=2      
GOTO LBLSUPP    
    
    
      
ELSE      
GOTO LAST      
           
      
LBLMEMOMASTER:     
   --AC_NAME  
  SELECT TOP 1 A.*,B.*,D.SECTION_NAME,C.SUB_SECTION_NAME,E.PARA1_NAME,ISNULL(PMT.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,    
         F.PARA2_NAME,G.PARA3_NAME,H.PARA4_NAME,I.PARA5_NAME,J.PARA6_NAME, K.AC_NAME    
         ,B.DT_CREATED AS ART_DT_CREATED,G.DT_CREATED AS PARA3_DT_CREATED ,A.DT_CREATED AS SKU_DT_CREATED ,  
         ABS((CASE WHEN ISNULL(POST_TAX_SEPARATELY,0)=0   
               THEN  ISNULL(SKU_OH.TAX_AMOUNT,0) ELSE 0 END) - ISNULL(SKU_OH.DISCOUNT_AMOUNT,0) +   
         ISNULL(SKU_OH.VALUE_ADD,0)  + ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0)  +   
         ISNULL(SKU_OH.FREIGHT,0)  + ISNULL(SKU_OH.OTHER_CHARGES,0)  +  ISNULL(SKU_OH.ROUND_OFF,0)) AS OH  
            
   FROM SKU A (NOLOCK)        
   JOIN FORM  (NOLOCK) ON FORM.FORM_ID=A.FORM_ID     
   JOIN ARTICLE B(NOLOCK) ON  A.ARTICLE_CODE= B.ARTICLE_CODE       
   JOIN SECTIOND C(NOLOCK) ON B.SUB_SECTION_CODE= C.SUB_SECTION_CODE      
   JOIN SECTIONM D ON C.SECTION_CODE= D.SECTION_CODE      
   JOIN PARA1 E(NOLOCK) ON A.PARA1_CODE= E.PARA1_CODE      
   JOIN PARA2 F(NOLOCK) ON A.PARA2_CODE= F.PARA2_CODE      
   JOIN PARA3 G(NOLOCK) ON A.PARA3_CODE= G.PARA3_CODE      
   JOIN PARA4 H(NOLOCK) ON A.PARA4_CODE= H.PARA4_CODE      
   JOIN PARA5 I(NOLOCK) ON A.PARA5_CODE= I.PARA5_CODE      
   JOIN PARA6 J(NOLOCK) ON A.PARA6_CODE= J.PARA6_CODE      
   JOIN LMV01106  K(NOLOCK) ON A.AC_CODE= K.AC_CODE    
   LEFT OUTER JOIN PMT01106 PMT(NOLOCK) ON A.PRODUCT_CODE = PMT.PRODUCT_CODE         
   LEFT OUTER JOIN SKU_OH(NOLOCK) ON A.PRODUCT_CODE=SKU_OH.PRODUCT_CODE     
   WHERE (@NNAVMODE=1 AND A.PRODUCT_CODE= @CWHERE) OR (@NNAVMODE=2 AND B.ARTICLE_NO=@CWHERE)  OR (@NNAVMODE=3 AND G.PARA3_NAME=@CWHERE) 
      
GOTO LAST      
   
 LBLSUPP:  
 DECLARE @CCODE VARCHAR(4000)   
 SELECT  @CCODE = DBO.FN_ACT_TRAVTREE('0000000021')   
 SELECT B.AC_CODE, B.AC_NAME,B.ALIAS,(B.ADDRESS0 + ' '+ B.ADDRESS1 +' ' + B.ADDRESS2) AS ADDRESS_F,  
 B.AREA_NAME ,B.CITY,B.STATE,B.MOBILE   
 FROM LMV01106 B WHERE CHARINDEX(HEAD_CODE,@CCODE)>0     
    
   GOTO LAST     
       
LAST:        
END
