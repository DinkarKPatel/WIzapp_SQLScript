CREATE PROCEDURE SP3S_RUNSTRUCMDS
@NMODE INT
AS
BEGIN
	DECLARE @CSTRUCOMPTABLE VARCHAR(200),@DEXETIME DATETIME,@CCMD NVARCHAR(MAX),@BFLAG BIT,@CSTEP VARCHAR(10),
			@CERRORMSG VARCHAR(MAX),@NROWID INT
	
BEGIN TRY	
	SET @CSTRUCOMPTABLE='WIZAPP3S_STRUCOMP.DBO.STRUCOMP_MAIN_COMP_'+DB_NAME()
	
	SET @CSTEP='10'	
	
	SET @CERRORMSG=''
	
	SELECT @DEXETIME=CONVERT(DATE,LAST_UPDATE) FROM EXE_TIME
	
	IF OBJECT_ID('TEMPDB..#TMPSTRU','U') IS NOT NULL
		DROP TABLE #TMPSTRU
	
	CREATE TABLE #TMPSTRU (CMD VARCHAR(MAX) NOT NULL,ROW_ID INT NOT NULL)	
	
	SET @CSTEP='20'
	SET @CCMD=N'SELECT CMD,ROW_ID  FROM '+@CSTRUCOMPTABLE+'
				WHERE XN_DT>='''+CONVERT(VARCHAR,@DEXETIME,110)+''' AND MODE='+LTRIM(RTRIM(STR(@NMODE)))+' ORDER BY ROW_ID'
	
	INSERT #TMPSTRU					
	EXEC SP_EXECUTESQL @CCMD 		
	
	SET @BFLAG=1
	
	SET @CSTEP='30'
	WHILE @BFLAG=1
	BEGIN
		SET @CCMD=''
		SELECT TOP 1 @CCMD=CMD,@NROWID=ROW_ID FROM #TMPSTRU ORDER BY ROW_ID
		
		SET @CSTEP='40'
		IF ISNULL(@CCMD,'')=''
			BREAK
		
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD	 
		
		SET @CSTEP='50'
		DELETE FROM #TMPSTRU WHERE ROW_ID=@NROWID
	END
	GOTO END_PROC
END TRY

BEGIN CATCH
	SET @CERRORMSG='ERROR IN PROCEDURE SP3S_RUNSTRUCMDS AT STEP#'+@CSTEP+ERROR_MESSAGE()
	GOTO END_PROC		
END CATCH

END_PROC:
	SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
END
