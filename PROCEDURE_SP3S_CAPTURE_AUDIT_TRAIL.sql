CREATE PROCEDURE SP3S_CAPTURE_AUDIT_TRAIL
(
 @XN_TYPE VARCHAR(10)
,@XN_ID VARCHAR(1000)
,@XN_HDR_TEMP_TABLE VARCHAR(1000)
,@XN_DTL_TEMP_TABLE VARCHAR(1000)
,@XN_SP_ID VARCHAR(40)=''
,@COMPUTER_NAME VARCHAR(1000)
,@WINUSERNAME VARCHAR(1000)
,@CWIZUSERCODE VARCHAR(1000)
,@CANCEL INT=0 
,@XN_CM_DT DATETIME='1900-01-01'
,@EDIT_CLICKED BIT=0
)
AS
BEGIN
  SET NOCOUNT ON

  DECLARE @CWIZUSERNAME VARCHAR(1000)
  
  IF @XN_TYPE NOT IN ('SLS','PUR','WSL','PRT','VCH','PO','BO','WSR','ARC')
     RETURN 
  

		   	  
  IF EXISTS(SELECT TOP 1 * FROM XN_AUDIT_TRIAL_DET (NOLOCK) WHERE XN_ID IS NULL) AND 1=2
     BEGIN
        UPDATE XN_AUDIT_TRIAL_DET SET XN_ID=KEY_VALUE WHERE TABLE_NAME LIKE '%M01106%' AND XN_ID IS NULL
        UPDATE XN_AUDIT_TRIAL_DET SET XN_ID=LEFT(KEY_VALUE,LEN(KEY_VALUE)-LEN(PRODUCT_CODE)) WHERE TABLE_NAME LIKE '%D01106%' AND XN_ID IS NULL
     END
     
  DECLARE @SQL VARCHAR(MAX),@SQL2 VARCHAR(MAX),@COL VARCHAR(MAX)
  ,@HDR_TABLE VARCHAR(5000),@DTL_TABLE VARCHAR(5000)
  ,@HDR_KEY VARCHAR(5000),@DTL_KEY VARCHAR(5000)
  ,@ROWID VARCHAR(1000),@MODE VARCHAR(100),@CNT_NEW INT,@CNT_OLD INT
  ,@JOIN_ON VARCHAR(MAX),@FIELDS VARCHAR(1000),@KEY_ID VARCHAR(1000)
  ,@INS_TABLE VARCHAR(1000),@DEL_TABLE VARCHAR(1000),@TABLE VARCHAR(1000)  
  ,@FIELD VARCHAR(500),@DATA VARCHAR(500),@FIELD_LIST VARCHAR(MAX)
  ,@PROCESS_HDR BIT,@UPDATED_ON DATETIME
  ,@TAB VARCHAR(500),@AGE VARCHAR(500),@EDITED BIT,@SQLLOC NVARCHAR(MAX)
  
  SET @EDITED=0
  
  IF @XN_TYPE='SLS'
     SELECT @HDR_TABLE='CMM01106',@DTL_TABLE='CMD01106',@XN_HDR_TEMP_TABLE='[##CMM_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@XN_DTL_TEMP_TABLE='[##CMD_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@JOIN_ON='CM_ID'
  ELSE IF @XN_TYPE='PUR'
     SELECT @HDR_TABLE='PIM01106',@DTL_TABLE='PID01106',@XN_HDR_TEMP_TABLE='[##PIM_'+CAST(@XN_SP_ID AS VARCHAR (40))+'_'+@XN_ID+']',@XN_DTL_TEMP_TABLE='[##PID_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@JOIN_ON='MRR_ID'
  ELSE IF @XN_TYPE='WSL'
     SELECT @HDR_TABLE='INM01106',@DTL_TABLE='IND01106',@XN_HDR_TEMP_TABLE='[##INM_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@XN_DTL_TEMP_TABLE='[##IND_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@JOIN_ON='INV_ID'
  ELSE IF @XN_TYPE='PRT'
     SELECT @HDR_TABLE='RMM01106',@DTL_TABLE='RMD01106',@XN_HDR_TEMP_TABLE='[##RMM_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@XN_DTL_TEMP_TABLE='[##RMD_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@JOIN_ON='RM_ID'
  --17 MAR 2018
  ELSE IF @XN_TYPE='VCH'
     SELECT @HDR_TABLE='VM01106' ,@DTL_TABLE='VD01106' ,@XN_HDR_TEMP_TABLE='[##VMM_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@XN_DTL_TEMP_TABLE='[##VMD_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@JOIN_ON='VM_ID'     
  --15 DEC 2018
  ELSE IF @XN_TYPE='PO'
     SELECT @HDR_TABLE='POM01106' ,@DTL_TABLE='POD01106' ,@XN_HDR_TEMP_TABLE='[##POM_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@XN_DTL_TEMP_TABLE='[##POD_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@JOIN_ON='PO_ID'          
  ELSE IF @XN_TYPE='BO'
     SELECT @HDR_TABLE='BUYER_ORDER_MST' ,@DTL_TABLE='BUYER_ORDER_DET' ,@XN_HDR_TEMP_TABLE='[##BOM_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@XN_DTL_TEMP_TABLE='[##BOD_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@JOIN_ON='ORDER_ID'
  ELSE IF @XN_TYPE='WSR'
     SELECT @HDR_TABLE='CNM01106' ,@DTL_TABLE='CND01106' ,@XN_HDR_TEMP_TABLE='[##CNM_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@XN_DTL_TEMP_TABLE='[##CND_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@JOIN_ON='CN_ID'
ELSE IF @XN_TYPE='ARC'
     SELECT @HDR_TABLE='Arc01106' ,@DTL_TABLE='' ,@XN_HDR_TEMP_TABLE='[##ARC_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']',@XN_DTL_TEMP_TABLE='',@JOIN_ON='ADV_rec_id'
  
  /*Rohit 03-01-2025 Start : Taiga :  #1123 DATA NOT SHOWING IN AUDIT TRAIL*/
  DECLARE @cLOCATION_CODE NVARCHAR(10)
  SET @SQLLOC=N'SELECT @cLOCATION_CODE = LOCATION_CODE FROM '+@HDR_TABLE +' WHERE '+@JOIN_ON+' = '''+@XN_ID+''''
   EXEC SP_EXECUTESQL @SQLLOC, N'@cLOCATION_CODE varchar(10) OUTPUT',@cLOCATION_CODE=@cLOCATION_CODE OUTPUT
    /*Rohit 03-01-2025 End : Taiga :  #1123 DATA NOT SHOWING IN AUDIT TRAIL*/
	SET @SQL=''
  SET @ROWID=LEFT(NEWID(),40)
  
  SELECT @CWIZUSERNAME=ISNULL(U.USERNAME,'') FROM USERS U WHERE U.USER_CODE=@CWIZUSERCODE
  
  SET @UPDATED_ON=GETDATE()
  
  IF @CANCEL=1
     BEGIN
        INSERT XN_AUDIT_TRIAL_DET WITH (ROWLOCK) (LOCATION_CODE,XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME ,WINUSERNAME ,CWIZUSERCODE,CWIZUSERNAME,PRODUCT_CODE)
        SELECT TOP 1 @cLOCATION_CODE,@XN_ID,@XN_TYPE,@HDR_TABLE,@XN_ID,'CANCELLED','BIT','CANCEL',@ROWID,'NO','YES',CONVERT(VARCHAR(40),@UPDATED_ON,113),@COMPUTER_NAME,@WINUSERNAME,@CWIZUSERCODE,@CWIZUSERNAME,'' 
        RETURN
     END
     
  IF @CANCEL=4
     BEGIN 
		INSERT XN_AUDIT_TRIAL_DET WITH (ROWLOCK) (LOCATION_CODE,XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME ,WINUSERNAME ,CWIZUSERCODE,CWIZUSERNAME,PRODUCT_CODE)
        SELECT @cLOCATION_CODE,@XN_ID,@XN_TYPE,@HDR_TABLE,@XN_ID,'CM_DT','DATETIME','UPDATE',@ROWID
        ,(SELECT TOP 1 REPLACE(CONVERT(VARCHAR,CM_DT,102),'.','-') FROM CMM01106 (NOLOCK) WHERE CM_ID=@XN_ID)
        ,REPLACE(CONVERT(VARCHAR,@XN_CM_DT,102),'.','-')
        ,CONVERT(VARCHAR,@UPDATED_ON,113),@COMPUTER_NAME,@WINUSERNAME,@CWIZUSERCODE,@CWIZUSERNAME,''
        RETURN
     END
  
  IF ISNULL(@EDIT_CLICKED,0)=0
     RETURN

	

  SET @SQL='UPDATE T SET '
  SELECT @SQL=COALESCE(@SQL,'')+'T.NEW_'+FIELD_NAME+' = I.'+FIELD_NAME+',' FROM XN_AUDIT_TRIAL_MST (NOLOCK) WHERE TABLE_NAME=@HDR_TABLE AND TRIG='UPDATE' ORDER BY ORDER_ID
  SET @SQL=LEFT(@SQL,LEN(@SQL)-1)+' FROM [##'+CASE @XN_TYPE WHEN 'VCH' THEN 'VMM' WHEN 'BO' THEN 'BOM' ELSE LEFT(@HDR_TABLE,3) END+'_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+'] T JOIN '+@HDR_TABLE+' I (NOLOCK) ON I.'+@JOIN_ON+'='''+@XN_ID+''';'
  print @sql	
  EXEC(@SQL)



  SET @SQL=''
  --CAPTURE HDR
  SELECT @SQL=COALESCE(@SQL,'')+'INSERT XN_AUDIT_TRIAL_DET (LOCATION_CODE,XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)
  SELECT '''+@cLOCATION_CODE+''','''+@XN_ID+''','''+@XN_TYPE+''', '''+@HDR_TABLE+''', OLD_'+LEFT(KEY_FIELDS,LEN(KEY_FIELDS)-1)+', '''+FIELD_NAME+''', '''+DATA_TYPE+''', '''+TRIG+''', '''+@ROWID+''', OLD_'+FIELD_NAME+' , NEW_'+FIELD_NAME+' , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@COMPUTER_NAME+''', '''+@WINUSERNAME+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',''''
  FROM [##'+CASE @XN_TYPE WHEN 'VCH' THEN 'VMM' WHEN 'BO' THEN 'BOM' ELSE LEFT(@HDR_TABLE,3) END+'_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+'] 
  WHERE NEW_'+FIELD_NAME+'<>OLD_'+FIELD_NAME+';'
  FROM XN_AUDIT_TRIAL_MST (NOLOCK) 
  WHERE TABLE_NAME=@HDR_TABLE AND TRIG='UPDATE'
  print @sql
  EXEC(@SQL)

  
 if @XN_TYPE='arc'
   return

  SET @SQL=''
  SET @SQL='UPDATE T SET '
  SELECT @SQL=COALESCE(@SQL,'')+'T.NEW_'+FIELD_NAME+' = ISNULL(I.'+FIELD_NAME+',''-999''),' FROM XN_AUDIT_TRIAL_MST (NOLOCK) WHERE TABLE_NAME=@DTL_TABLE AND TRIG='UPDATE' ORDER BY ORDER_ID
  SET @SQL=LEFT(@SQL,LEN(@SQL)-1)+' FROM [##'+CASE @XN_TYPE WHEN 'BO' THEN 'BOD' WHEN 'VCH' THEN 'VMD' ELSE LEFT(@DTL_TABLE,3) END+'_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+'] T LEFT JOIN '+@DTL_TABLE+' I (NOLOCK) ON I.'+@JOIN_ON+'='''+@XN_ID
  +CASE @XN_TYPE WHEN 'VCH' THEN ''' AND I.VD_ID=T.NEW_PRODUCT_CODE;' ELSE ''' AND I.PRODUCT_CODE=T.NEW_PRODUCT_CODE;' END
  SET @COL=REPLACE(@COL,'NEW_VD_ID','NEW_PRODUCT_CODE')
  IF @XN_TYPE='VCH'
     SET @SQL=REPLACE(@SQL,',T.NEW_VD_ID',',T.NEW_PRODUCT_CODE')
  
  print @sql
  EXEC(@SQL)
  
  
  
  SET @SQL2='' 
  --CAPTURE DTL
  /*
  SELECT @SQL2=COALESCE(@SQL2,'')
  +'INSERT XN_AUDIT_TRIAL_DET (XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)'+CHAR(13)
  +'SELECT '''+@XN_TYPE+''', '''+@DTL_TABLE+''', OLD_'+REPLACE(LEFT(KEY_FIELDS,LEN(KEY_FIELDS)-1),'+','+OLD_')+', '''+FIELD_NAME+''', '''+DATA_TYPE+''', '''+TRIG+''', '''+@ROWID+''', OLD_'+FIELD_NAME+' , ''DELETED'' , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@COMPUTER_NAME+''', '''+@WINUSERNAME+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',OLD_PRODUCT_CODE
  FROM [##'+CASE @XN_TYPE WHEN 'VCH' THEN 'VMD' ELSE LEFT(@DTL_TABLE,3) END+'_'+CAST(@XN_SP_ID AS VARCHAR)+'_'+@XN_ID+']'
  +CASE FIELD_NAME WHEN 'PRODUCT_CODE' THEN ' WHERE NEW_PRODUCT_CODE=''-999'';' ELSE '''' END
  FROM XN_AUDIT_TRIAL_MST (NOLOCK) 
  WHERE TABLE_NAME=@DTL_TABLE AND TRIG='UPDATE' AND FIELD_NAME='PRODUCT_CODE'
  */
  
  SELECT @SQL2=COALESCE(@SQL2,'')
  +'INSERT XN_AUDIT_TRIAL_DET (LOCATION_CODE,XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)'+CHAR(13)
  +'SELECT '''+@cLOCATION_CODE+''','''+@XN_ID+''','''+@XN_TYPE+''', '''+@DTL_TABLE+''', OLD_'+REPLACE(LEFT(KEY_FIELDS,LEN(KEY_FIELDS)-1),'+','+OLD_')+', '''+FIELD_NAME+''', '''+DATA_TYPE+''', '''+TRIG+''', '''+@ROWID+''', OLD_'+CASE @XN_TYPE WHEN 'VCH' THEN 'PRODUCT_CODE' ELSE FIELD_NAME END+' , ''DELETED'' , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@COMPUTER_NAME+''', '''+@WINUSERNAME+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',OLD_PRODUCT_CODE
  FROM [##'+CASE @XN_TYPE WHEN 'BO' THEN 'BOD' WHEN 'VCH' THEN 'VMD' ELSE LEFT(@DTL_TABLE,3) END+'_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']'
  +CASE @XN_TYPE WHEN 'VCH' THEN CASE FIELD_NAME WHEN 'VD_ID' THEN ' WHERE NEW_PRODUCT_CODE=''-999'';' ELSE '''' END
                 ELSE			 CASE FIELD_NAME WHEN 'PRODUCT_CODE' THEN ' WHERE NEW_PRODUCT_CODE=''-999'';' ELSE '''' END
   END
  FROM XN_AUDIT_TRIAL_MST (NOLOCK) 
  WHERE TABLE_NAME=@DTL_TABLE AND TRIG='UPDATE' AND FIELD_NAME=CASE @XN_TYPE WHEN 'VCH' THEN 'VD_ID' ELSE 'PRODUCT_CODE' END


  -- AS Per DISCUSS WITH SANJIV SIR AND VE JI REMOVE AND ADD Qty Store in Audit Trail 24-11-2022
  IF @XN_TYPE='SLS'
  BEGIN
       
	 SELECT @SQL2=COALESCE(@SQL2,'')    
	  +'INSERT XN_AUDIT_TRIAL_DET (LOCATION_CODE,XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)'+CHAR(13)    
	  +'SELECT '''+@cLOCATION_CODE+''','''+@XN_ID+''','''+@XN_TYPE+''', '''+@DTL_TABLE+''', isnull(  OLD_'+REPLACE(LEFT(KEY_FIELDS,LEN(KEY_FIELDS)-1),'+','+OLD_')+',b.cm_id+b.product_code) , '''+FIELD_NAME+''', '''+DATA_TYPE+''', '''+TRIG+''', '''+@ROWID+''', isnull(OLD_'+FIELD_NAME+',0) , isnull(b.quantity,0) , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@COMPUTER_NAME+''', '''+@WINUSERNAME+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',isnull(OLD_PRODUCT_CODE,product_code)
	  FROM [##'+LEFT(@DTL_TABLE,3) +'_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+'] a' +
	  ' full outer JOIN CMD01106 B (nolock) ON A.OLD_CM_ID=B.CM_ID AND A.old_PRODUCT_CODE=B.PRODUCT_CODE '
	  + ' where ( NEW_PRODUCT_CODE=''-999'' or isnull(a.old_product_code,'''')='''') and isnull(b.cm_id,a.old_cm_id)='''+@XN_ID+''' ;' 
	  FROM XN_AUDIT_TRIAL_MST (NOLOCK)     
	  WHERE TABLE_NAME=@DTL_TABLE AND TRIG='UPDATE' AND FIELD_NAME='Quantity'


	   --for paymode_xn_det

   DECLARE @SQL3 VARCHAR(MAX),@dtsql nvarchar(max),@PAYMODE_TABLE varchar(100),
          @COLD_PAYMODENAME varchar(1000),@CNEW_PAYMODENAME varchar(1000)
   SET @PAYMODE_TABLE='PAYMODE_XN_DET'

  SET @DTSQL=N' SELECT @CPAYMODENAME=ISNULL(@CPAYMODENAME+'','','''')+ 
       QUOTENAME(A.OLD_PAYMODE_NAME+'':''+CAST(SUM(OLD_AMOUNT) AS VARCHAR(100))  ) 
   FROM [##'+LEFT(@PAYMODE_TABLE,7) +'_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+'] A
   GROUP BY OLD_PAYMODE_NAME
   ORDER BY OLD_PAYMODE_NAME'
   EXEC SP_EXECUTESQL @DTSQL, N'@CPAYMODENAME varchar(1000) OUTPUT',@CPAYMODENAME=@COLD_PAYMODENAME OUTPUT

    SELECT @CNEW_PAYMODENAME=ISNULL(@CNEW_PAYMODENAME+',','')+ 
       QUOTENAME(B.PAYMODE_NAME+':'+CAST(SUM(AMOUNT) AS VARCHAR(100))  ) 
	FROM PAYMODE_XN_DET  A (nolock)
	JOIN PAYMODE_MST B (nolock) ON A.PAYMODE_CODE =B.PAYMODE_CODE 
	WHERE MEMO_ID=@XN_ID
	GROUP BY PAYMODE_NAME
	ORDER BY PAYMODE_NAME


	IF ISNULL(@COLD_PAYMODENAME,'')<>ISNULL(@CNEW_PAYMODENAME,'')
	BEGIN
	    
	   SELECT @SQL2=COALESCE(@SQL2,'')       
	   +'INSERT XN_AUDIT_TRIAL_DET (LOCATION_CODE,XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)'+CHAR(13)      
	   +'SELECT '''+@cLOCATION_CODE+''','''+@XN_ID+''','''+@XN_TYPE+''', '''+@PAYMODE_TABLE+''','''+@XN_ID+''' , ''PAYMODE_NAME'', ''Varchar'', ''Update'', 
	   '''+@ROWID+''', '''+@COLD_PAYMODENAME+''' , '''+@CNEW_PAYMODENAME+''' , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@COMPUTER_NAME+''', '''+@WINUSERNAME+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',
	   '''' AS  PRODUCT_CODE '

	END
  

  END
  

  --SELECT @SQL2=COALESCE(@SQL2,'')
  --+'INSERT XN_AUDIT_TRIAL_DET (XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)'+CHAR(13)
  --+'SELECT '''+@XN_TYPE+''', '''+@DTL_TABLE+''', OLD_'+REPLACE(LEFT(KEY_FIELDS,LEN(KEY_FIELDS)-1),'+','+OLD_')+', '''+FIELD_NAME+''', '''+DATA_TYPE+''', '''+TRIG+''', '''+@ROWID+''', OLD_'+FIELD_NAME+' , ISNULL(NEW_'+FIELD_NAME+',''DELETED'') , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@COMPUTER_NAME+''', '''+@WINUSERNAME+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',OLD_PRODUCT_CODE
  --FROM [##'+CASE @XN_TYPE WHEN 'VCH' THEN 'VMD' ELSE LEFT(@DTL_TABLE,3) END+'_'+CAST(@XN_SP_ID AS VARCHAR)+'_'+@XN_ID+']'
  --+' WHERE OLD_'+FIELD_NAME+'<>NEW_'+FIELD_NAME+' AND NEW_PRODUCT_CODE<>''-999'';'
  --FROM XN_AUDIT_TRIAL_MST (NOLOCK) 
  --WHERE TABLE_NAME=@DTL_TABLE AND TRIG='UPDATE' AND FIELD_NAME!='PRODUCT_CODE'  
  
  IF @XN_TYPE<>'VCH'
	 SELECT @SQL2=COALESCE(@SQL2,'')
	 +'INSERT XN_AUDIT_TRIAL_DET (LOCATION_CODE,XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)'+CHAR(13)
	 +'SELECT '''+@cLOCATION_CODE+''','''+@XN_ID+''','''+@XN_TYPE+''','''+@DTL_TABLE+''', OLD_'+REPLACE(LEFT(KEY_FIELDS,LEN(KEY_FIELDS)-1),'+','+OLD_')+', '''+FIELD_NAME+''', '''+DATA_TYPE+''', '''+TRIG+''', '''+@ROWID+''', OLD_'+FIELD_NAME+' , ISNULL(NEW_'+FIELD_NAME+',''DELETED'') , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@COMPUTER_NAME+''', '''+@WINUSERNAME+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',OLD_PRODUCT_CODE
	 FROM [##'+CASE @XN_TYPE WHEN 'BO' THEN 'BOD' WHEN 'VCH' THEN 'VMD' ELSE LEFT(@DTL_TABLE,3) END+'_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']'
	 +' WHERE OLD_'+FIELD_NAME+'<>NEW_'+FIELD_NAME+' AND NEW_PRODUCT_CODE<>''-999'';'
	 FROM XN_AUDIT_TRIAL_MST (NOLOCK) 
	 WHERE TABLE_NAME=@DTL_TABLE AND TRIG='UPDATE' AND FIELD_NAME!='PRODUCT_CODE'  
  ELSE
	BEGIN
		SELECT @SQL2=COALESCE(@SQL2,'')
		+'INSERT XN_AUDIT_TRIAL_DET (LOCATION_CODE,XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)'+CHAR(13)
		+'SELECT '''+@cLOCATION_CODE+''','''+@XN_ID+''','''+@XN_TYPE+''','''+@DTL_TABLE+''', OLD_'+REPLACE(LEFT(KEY_FIELDS,LEN(KEY_FIELDS)-1),'+','+OLD_')+', '''+FIELD_NAME+''', '''+DATA_TYPE+''', '''+TRIG+''', '''+@ROWID+''', OLD_'+FIELD_NAME+' , ISNULL(NEW_'+FIELD_NAME+',''DELETED'') , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@COMPUTER_NAME+''', '''+@WINUSERNAME+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',OLD_PRODUCT_CODE
		FROM [##'+CASE @XN_TYPE WHEN 'BO' THEN 'BOD' WHEN 'VCH' THEN 'VMD' ELSE LEFT(@DTL_TABLE,3) END+'_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']'
		+' WHERE OLD_'+FIELD_NAME+'<>NEW_'+FIELD_NAME+' AND NEW_PRODUCT_CODE<>''-999'';'+CHAR(13)
		FROM XN_AUDIT_TRIAL_MST (NOLOCK) 
		WHERE TABLE_NAME=@DTL_TABLE AND TRIG='UPDATE' AND FIELD_NAME!='VD_ID'  

		SELECT @SQL2=COALESCE(@SQL2,'')
		+'INSERT XN_AUDIT_TRIAL_DET (LOCATION_CODE,XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)'+CHAR(13)
		+'SELECT '''+@cLOCATION_CODE+''','''+@XN_ID+''','''+@XN_TYPE+''', '''+@DTL_TABLE+''', OLD_'+REPLACE(LEFT(KEY_FIELDS,LEN(KEY_FIELDS)-1),'+','+OLD_')+', '''+FIELD_NAME+''', '''+DATA_TYPE+''', '''+TRIG+''', '''+@ROWID+''', OLD_PRODUCT_CODE , ISNULL(NEW_PRODUCT_CODE,''DELETED'') , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@COMPUTER_NAME+''', '''+@WINUSERNAME+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',OLD_PRODUCT_CODE
		FROM [##'+CASE @XN_TYPE WHEN 'BO' THEN 'BOD' WHEN 'VCH' THEN 'VMD' ELSE LEFT(@DTL_TABLE,3) END+'_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+']'
		+' WHERE OLD_PRODUCT_CODE<>NEW_PRODUCT_CODE AND NEW_PRODUCT_CODE<>''-999'';'+CHAR(13)
		FROM XN_AUDIT_TRIAL_MST (NOLOCK) 
		WHERE TABLE_NAME=@DTL_TABLE AND TRIG='UPDATE' AND FIELD_NAME='VD_ID'  
	END  
	print @SQL2
	
  EXEC(@SQL2)

  
  IF @XN_TYPE='VCH'  
     BEGIN  
       UPDATE XN_AUDIT_TRIAL_DET WITH (ROWLOCK)
       SET OLDVAL=CONVERT(VARCHAR,CONVERT(DATE,OLDVAL),106),NEWVAL=CONVERT(VARCHAR,CONVERT(DATE,NEWVAL),106)  
       WHERE XN_TYPE='VCH' AND FIELD_NAME='VOUCHER_DT' AND KEY_VALUE=@XN_ID AND XN_ID=@XN_ID
       
	   UPDATE X SET	 OLDVAL=V1.AC_NAME ,NEWVAL=V2.AC_NAME   
	   FROM XN_AUDIT_TRIAL_DET X WITH (ROWLOCK)  
	   JOIN LM01106 V1 (NOLOCK) ON V1.AC_CODE=X.OLDVAL  
	   JOIN LM01106 V2 (NOLOCK) ON V2.AC_CODE=X.NEWVAL  
	   WHERE X.XN_TYPE='VCH' AND X.FIELD_NAME='AC_CODE' AND KEY_VALUE=@XN_ID AND XN_ID=@XN_ID  

	   UPDATE X SET	 OLDVAL=V1.VOUCHER_TYPE	,NEWVAL=V2.VOUCHER_TYPE
	   FROM XN_AUDIT_TRIAL_DET X WITH (ROWLOCK)  
	   JOIN VCHTYPE V1 (NOLOCK) ON V1.VOUCHER_CODE=X.OLDVAL  
	   JOIN VCHTYPE V2 (NOLOCK) ON V2.VOUCHER_CODE=X.NEWVAL  
	   WHERE X.XN_TYPE='VCH' AND X.FIELD_NAME='VOUCHER_CODE' AND KEY_VALUE=@XN_ID AND XN_ID=@XN_ID 
     END   
  SET NOCOUNT OFF
END
