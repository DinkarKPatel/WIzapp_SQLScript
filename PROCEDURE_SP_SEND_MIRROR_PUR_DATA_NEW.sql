create PROCEDURE SP_SEND_MIRROR_PUR_DATA_NEW  
(  
  @CUPLOADEDXNID VARCHAR(50)  
 ,@CCURLOCID VARCHAR(5)  
 ,@BDONOTCHKPENDINGLM BIT=0
 ,@BACKNOWLEDGE BIT=0 
 ,@CERRMSG VARCHAR(1000) OUTPUT  
)  
--WITH ENCRYPTION  
AS  
BEGIN  
 DECLARE @CMEMOID VARCHAR(50),@CSTEP VARCHAR(5)  
BEGIN TRY   
 SET @CSTEP=00  

 
   
 DECLARE @CTEMPDBNAME1 VARCHAR(40),@CTEMPDBNAME VARCHAR(40),@DTSQL NVARCHAR(MAX)  
   
 PRINT 'ENTER PURCHASE SENDING'   
   
 SET @CSTEP=10     
 
   
  SET @CMEMOID=@CUPLOADEDXNID  
 ---- IF NO MEMO FOUND , JUST END THE PROCESS  
 IF ISNULL(@CMEMOID,'')=''  
  GOTO END_PROC  

  DECLARE @BPENDINGMSTFOUND BIT
  SET @BPENDINGMSTFOUND=0

  DECLARE @nInvMode NUMERIC(1,0)
  SELECT @nInvMode=inv_mode FROM pim01106 (NOLOCK) WHERE mrr_id=@CUPLOADEDXNID
	
  IF @BDONOTCHKPENDINGLM=0 AND @nInvMode<>2
  BEGIN
		EXEC SP_SEND_MIRROR_XNSMST_DATA_NEW 'PUR',@CMEMOID,@CCURLOCID,@BDONOTCHKPENDINGLM
		,@BPENDINGMSTFOUND OUTPUT
		,@CERRMSG OUTPUT
  END

	PRINT (CASE WHEN @BPENDINGMSTFOUND=1 THEN 'PMST-Y' ELSE 'PMST-N' END)

	IF ISNULL(@BPENDINGMSTFOUND,0)=1
	BEGIN
		PRINT 'PENDING MASTER FOUND'
		GOTO END_PROC
	END
	
LBLTABLEINFO:  
 SET @CSTEP=50  
  
 IF @BACKNOWLEDGE=1  
  GOTO END_PROC  
    
 SET @CSTEP=55  
 ---- SEND THE PURCHASE MEMO MASTER TABLE  
 SELECT DISTINCT 'PUR_PIM01106_upload' AS TARGET_TABLENAME,A.* ,@CMEMOID AS XN_ID FROM PIM01106(NOLOCK) A 
 WHERE A.MRR_ID=@CMEMOID  
 
 ------ No other tables need to be sent in case of Group Invoices
 IF @nInvMode=2
	GOTO LBLPMT

 SET @CSTEP=60  
 ---- SEND THE PURCHASE MEMO DETAIL TABLE  
 SELECT DISTINCT 'PUR_PID01106_upload' AS TARGET_TABLENAME,A.* FROM PID01106(NOLOCK) A WHERE A.MRR_ID=@CMEMOID  
   
 SET @CSTEP=65  
  --SEND THE DOCUMENT REFERENCE TABLE RELATED TO GIVEN CASH MEMO  
 SELECT DISTINCT 'PUR_DAILOGFILE_upload' AS TARGET_TABLENAME,A.* , @CMEMOID AS PUR_MEMO_ID FROM DAILOGFILE A (NOLOCK)  WHERE  A.UPLOADED=0 AND A.MEMONO=@CMEMOID   
   
 SET @CSTEP=70  
 ---- SEND THE DEBITNOTE MEMO SKU TABLE  
 SELECT DISTINCT 'PUR_SKU_upload' AS TARGET_TABLENAME,B.*, @CMEMOID AS PUR_MEMO_ID    
 FROM PID01106(NOLOCK) A  
 JOIN SKU (NOLOCK) B ON A.PRODUCT_CODE  =B.PRODUCT_CODE  
 WHERE A.MRR_ID=@CMEMOID  
 UNION
 SELECT DISTINCT 'PUR_SKU_upload' AS TARGET_TABLENAME,B.*, @CMEMOID AS PUR_MEMO_ID    
 FROM PID01106(NOLOCK) A  
 JOIN SKU (NOLOCK) B ON LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))  =B.PRODUCT_CODE  
 WHERE A.MRR_ID=@CMEMOID 
 AND CHARINDEX ('@',A.product_code )<>0
   
   
   
 SET @CSTEP=75  
 ---- SEND THE SKU_OH RELATED TO GIVEN PUR MEMO  
 SELECT DISTINCT 'PUR_SKU_OH_upload' AS TARGET_TABLENAME,A.* , @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106  (NOLOCK) B  
 JOIN SKU_OH (NOLOCK) A  ON A.PRODUCT_CODE=B.PRODUCT_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 UNION
 SELECT DISTINCT 'PUR_SKU_OH_upload' AS TARGET_TABLENAME,b.* , @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106  (NOLOCK) a  
 JOIN SKU_OH (NOLOCK) b  ON LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))=B.PRODUCT_CODE   
 WHERE a.MRR_ID=@CMEMOID  
 AND CHARINDEX ('@',a.product_code )<>0  

    
    

 SET @CSTEP=80  
 ---- SEND THE ARTICLE RELATED TO GIVEN PUR MEMO  
 IF OBJECT_ID ('TEMPDB..#TMPARTICLE','U') IS NOT NULL  
    DROP TABLE #TMPARTICLE  
 SELECT 'PUR_ARTICLE_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 INTO #TMPARTICLE  
 FROM PID01106(NOLOCK) B  
 JOIN ARTICLE A (NOLOCK)  ON A.ARTICLE_CODE=B.ARTICLE_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 UNION   
 SELECT 'PUR_ARTICLE_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B (NOLOCK)   
 JOIN SKU SK (NOLOCK)  ON B.PRODUCT_CODE =SK.PRODUCT_CODE   
 JOIN ARTICLE (NOLOCK) A ON SK.ARTICLE_CODE =A.ARTICLE_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 union      
 SELECT 'PUR_ARTICLE_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID     
 FROM PID01106 B (NOLOCK)     
 JOIN SKU SK (NOLOCK)  ON  LEFT(b.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',b.PRODUCT_CODE)-1,-1),LEN(b.PRODUCT_CODE )))  =sk.PRODUCT_CODE   
 JOIN ARTICLE (NOLOCK) A ON SK.ARTICLE_CODE =A.ARTICLE_CODE     
 WHERE B.MRR_ID=@CMEMOID    
 AND CHARINDEX ('@',b.product_code )<>0  
   
 SELECT DISTINCT  A.* FROM #TMPARTICLE A  
   
 SET @CSTEP=85  
 ---- SEND THE SECTIOND RELATED TO GIVEN PUR MEMO  
 SELECT DISTINCT 'PUR_SECTIOND_upload' AS TARGET_TABLENAME,SD.*, @CMEMOID AS PUR_MEMO_ID   
 FROM #TMPARTICLE A  
 JOIN SECTIOND SD(NOLOCK) ON A.SUB_SECTION_CODE  =SD.SUB_SECTION_CODE  
   
   
   
   
 SET @CSTEP=90  
 ---- SEND THE SECTIONM RELATED TO GIVEN PUR MEMO  
 SELECT DISTINCT 'PUR_SECTIONM_upload' AS TARGET_TABLENAME,SM.*, @CMEMOID AS PUR_MEMO_ID   
 FROM #TMPARTICLE A  
 JOIN SECTIOND SD(NOLOCK) ON A.SUB_SECTION_CODE  =SD.SUB_SECTION_CODE  
 JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE =SM.SECTION_CODE   
   
   
 SET @CSTEP=95  
 ---- SEND THE PARA1 RELATED TO GIVEN PUR MEMO  
 SELECT  DISTINCT 'PUR_PARA1_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)  
 JOIN PARA1 A(NOLOCK)   ON A.PARA1_CODE=B.PARA1_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 UNION   
 SELECT  DISTINCT 'PUR_PARA1_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)  
 JOIN  SKU(NOLOCK) ON B.PRODUCT_CODE =SKU.PRODUCT_CODE   
 JOIN PARA1 A(NOLOCK) ON A.PARA1_CODE =SKU.PARA1_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 UNION   --WITHOUT BATCH PARA SEND
 SELECT  DISTINCT 'PUR_PARA1_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)  
 JOIN  SKU(NOLOCK) ON LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE ))) =SKU.PRODUCT_CODE   
 JOIN PARA1 A(NOLOCK) ON A.PARA1_CODE =SKU.PARA1_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 AND CHARINDEX ('@',B.product_code )<>0
   
 SET @CSTEP=100  
 ---- SEND THE PARA2 RELATED TO GIVEN PUR MEMO  
 SELECT DISTINCT 'PUR_PARA2_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)  
 JOIN PARA2 A(NOLOCK)  ON A.PARA2_CODE=B.PARA2_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 UNION   
 SELECT DISTINCT 'PUR_PARA2_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B  (NOLOCK)  
 JOIN SKU (NOLOCK)   ON SKU.PRODUCT_CODE=B.PRODUCT_CODE   
 JOIN PARA2 A (NOLOCK) ON  SKU.PARA2_CODE=A.PARA2_CODE   
 WHERE B.MRR_ID=@CMEMOID 
 UNION   --WITHOUT BATCH PARA SEND
 SELECT DISTINCT 'PUR_PARA2_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B  (NOLOCK)  
 JOIN SKU (NOLOCK)   ON SKU.PRODUCT_CODE=LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE ))) 
 JOIN PARA2 A (NOLOCK) ON  SKU.PARA2_CODE=A.PARA2_CODE   
 WHERE B.MRR_ID=@CMEMOID 
 AND CHARINDEX ('@',B.product_code )<>0
   

 SET @CSTEP=105  
 ---- SEND THE PARA3 RELATED TO GIVEN PUR MEMO  
 SELECT DISTINCT 'PUR_PARA3_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)  
 JOIN PARA3 A(NOLOCK) ON A.PARA3_CODE=B.PARA3_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 UNION   
 SELECT DISTINCT 'PUR_PARA3_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B  (NOLOCK)   
 JOIN SKU  (NOLOCK) ON  SKU.PRODUCT_CODE=B.PRODUCT_CODE   
 JOIN PARA3 A  (NOLOCK) ON SKU.PARA3_CODE=A.PARA3_CODE  
 WHERE B.MRR_ID=@CMEMOID  
 UNION   
 SELECT DISTINCT 'PUR_PARA3_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B  (NOLOCK)   
 JOIN SKU  (NOLOCK) ON  SKU.PRODUCT_CODE=LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE )))    
 JOIN PARA3 A  (NOLOCK) ON SKU.PARA3_CODE=A.PARA3_CODE  
 WHERE B.MRR_ID=@CMEMOID  
 AND CHARINDEX ('@',B.product_code )<>0
 

 SET @CSTEP=110  
 ---- SEND THE PARA4 RELATED TO GIVEN PUR MEMO  
 SELECT DISTINCT 'PUR_PARA4_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)   
 JOIN PARA4 A(NOLOCK)  ON A.PARA4_CODE=B.PARA4_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 UNION   
 SELECT DISTINCT 'PUR_PARA4_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)   
 JOIN SKU SK(NOLOCK) ON SK.PRODUCT_CODE=B.PRODUCT_CODE   
 JOIN  PARA4 A(NOLOCK) ON SK.PARA4_CODE=A.PARA4_CODE  
 WHERE B.MRR_ID=@CMEMOID  
 UNION   
 SELECT DISTINCT 'PUR_PARA4_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)   
 JOIN SKU SK(NOLOCK) ON SK.PRODUCT_CODE=LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE ))) 
 JOIN  PARA4 A(NOLOCK) ON SK.PARA4_CODE=A.PARA4_CODE  
 WHERE B.MRR_ID=@CMEMOID 
 AND CHARINDEX ('@',B.product_code )<>0

   
 SET @CSTEP=115  
 ---- SEND THE PARA5 RELATED TO GIVEN PUR MEMO  
 SELECT DISTINCT 'PUR_PARA5_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)  
 JOIN PARA5 A(NOLOCK)  ON A.PARA5_CODE=B.PARA5_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 UNION   
 SELECT DISTINCT 'PUR_PARA5_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)  
 JOIN SKU SK(NOLOCK)  ON SK.PRODUCT_CODE=B.PRODUCT_CODE   
 JOIN PARA5 A(NOLOCK) ON SK.PARA5_CODE=A.PARA5_CODE  
 WHERE B.MRR_ID=@CMEMOID 
 UNION   
 SELECT DISTINCT 'PUR_PARA5_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)  
 JOIN SKU SK(NOLOCK)  ON SK.PRODUCT_CODE=LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE )))    
 JOIN PARA5 A(NOLOCK) ON SK.PARA5_CODE=A.PARA5_CODE  
 WHERE B.MRR_ID=@CMEMOID  
 AND CHARINDEX ('@',B.product_code )<>0
   
 SET @CSTEP=120  
 ---- SEND THE PARA6 RELATED TO GIVEN PUR MEMO  
 SELECT DISTINCT 'PUR_PARA6_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)    
 JOIN PARA6 A(NOLOCK)  ON A.PARA6_CODE=B.PARA6_CODE   
 WHERE B.MRR_ID=@CMEMOID  
 UNION   
 SELECT DISTINCT 'PUR_PARA6_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)  
 JOIN SKU(NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE   
 JOIN PARA6 A(NOLOCK)  ON SKU.PARA6_CODE=A.PARA6_CODE  
 WHERE B.MRR_ID=@CMEMOID  
 UNION   
 SELECT DISTINCT 'PUR_PARA6_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PID01106 B(NOLOCK)  
 JOIN SKU(NOLOCK) ON SKU.PRODUCT_CODE=LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE )))    
 JOIN PARA6 A(NOLOCK)  ON SKU.PARA6_CODE=A.PARA6_CODE  
 WHERE B.MRR_ID=@CMEMOID    
 AND CHARINDEX ('@',B.product_code )<>0  
  
  
SELECT  DISTINCT 'PUR_ARTICLE_FIX_ATTR_upload' AS TARGET_TABLENAME,@CMEMOID AS PUR_MEMO_ID,A.* FROM ARTICLE_FIX_ATTR A (NOLOCK)  
 JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE  
 JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
 JOIN PID01106 D (NOLOCK) ON D.PRODUCT_CODE=C.PRODUCT_CODE  
 WHERE MRR_ID=@CMEMOID  
   
     
  DECLARE @NCOUNT INT,@BLOOP INT,@CCMD NVARCHAR(MAX)  
 SET @NCOUNT=25  
 SET @BLOOP=1  
 WHILE (@BLOOP <=@NCOUNT )  
 BEGIN  
         
       
     SET @CCMD=N' IF EXISTS(SELECT  TOP 1 ''U''  
   FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)  
   JOIN ARTICLE_FIX_ATTR A (NOLOCK) ON ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code=A.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code  
   JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE  
   JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
   JOIN PID01106 D (NOLOCK) ON D.PRODUCT_CODE=C.PRODUCT_CODE  
   WHERE MRR_ID='''+@CMEMOID+''' AND  
   ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000'' )  
    SELECT  DISTINCT ''PUR_ATTR'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_MST_upload'' AS TARGET_TABLENAME,'''+@CMEMOID+''' AS PUR_MEMO_ID,ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.*   
    FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)  
    JOIN ARTICLE_FIX_ATTR A (NOLOCK) ON ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code=A.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code  
    JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE  
    JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
    JOIN PID01106 D (NOLOCK) ON D.PRODUCT_CODE=C.PRODUCT_CODE  
    WHERE MRR_ID='''+@CMEMOID+'''  
    and  ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000'' '  
      
     PRINT  @CCMD  
     EXEC SP_EXECUTESQL @CCMD  
          
     SET @BLOOP=@BLOOP +1  
     
 END  
  
   
 --SET @CSTEP=125  
 ------ SEND THE ART_ATTR RELATED TO GIVEN PUR MEMO  
 --SELECT DISTINCT 'PUR_ART_ATTR_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 --FROM PID01106 B(NOLOCK)  
 --JOIN ART_ATTR A(NOLOCK)  ON A.ARTICLE_CODE=B.ARTICLE_CODE   
 --WHERE B.MRR_ID=@CMEMOID  
  
   
 --SET @CSTEP=130  
 ------ SEND THE ATTRM RELATED TO GIVEN PUR MEMO  
 --SELECT DISTINCT 'PUR_ATTRM_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 --FROM PID01106 B(NOLOCK)  
 --JOIN ART_ATTR AA(NOLOCK) ON AA.ARTICLE_CODE=B.ARTICLE_CODE   
 --JOIN ATTRM A(NOLOCK)  ON AA.ATTRIBUTE_CODE=A.ATTRIBUTE_CODE    
 --WHERE B.MRR_ID=@CMEMOID  
   
 --SET @CSTEP=135  
 ------ SEND THE ATTR_KEY RELATED TO GIVEN PUR MEMO  
 --SELECT DISTINCT 'PUR_ATTR_KEY_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 --FROM PID01106 B(NOLOCK)   
 --JOIN ART_ATTR AA(NOLOCK) ON AA.ARTICLE_CODE=B.ARTICLE_CODE    
 --JOIN  ATTR_KEY A(NOLOCK) ON AA.ATTRIBUTE_CODE=A.ATTRIBUTE_CODE AND AA.KEY_CODE =A.KEY_CODE   
 --WHERE B.MRR_ID=@CMEMOID  
   
   
 --START : 19 JAN 2018  
 SET @CSTEP=136  
    SELECT DISTINCT 'PUR_BOXM_upload' AS TARGET_TABLENAME,BM.*, @CMEMOID AS PUR_MEMO_ID   
 FROM BOXM BM (NOLOCK)   
    WHERE BM.REF_MRR_ID=@CMEMOID  
      
 SET @CSTEP=137  
 ---- SEND THE BOXD RELATED TO GIVEN PUR MEMO  
 SELECT DISTINCT 'PUR_BOXD_upload' AS TARGET_TABLENAME,BD.*, @CMEMOID AS PUR_MEMO_ID   
 FROM BOXM BM (NOLOCK)   
 JOIN BOXD BD (NOLOCK) ON BM.BOX_ID=BD.BOX_ID  
    WHERE BM.REF_MRR_ID =@CMEMOID  
    --END : 19 JAN 2018  
      
    SET @CSTEP=138  
    SELECT DISTINCT 'PUR_LOC_WISE_PURHISTORY_upload' AS TARGET_TABLENAME,A.*, @CMEMOID AS PUR_MEMO_ID   
 FROM PIM01106 B(NOLOCK)  
 JOIN PID01106 C(NOLOCK) ON B.MRR_ID=C.MRR_ID  
 JOIN LOC_WISE_PURHISTORY A(NOLOCK)  ON A.ARTICLE_CODE=C.ARTICLE_CODE  AND A.DEPT_ID=B.PUR_FOR_DEPT_ID  
 WHERE B.MRR_ID=@CMEMOID  


    SET @CSTEP=140

	SELECT 'PUR_XN_AUDIT_TRIAL_DET_UPLOAD' AS TARGET_TABLENAME,A.*,@CMEMOID AS PUR_MEMO_ID FROM XN_AUDIT_TRIAL_DET A WHERE XN_TYPE ='PUR' AND XN_ID=@CMEMOID


	SELECT DISTINCT  'PUR_POD_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS PUR_MEMO_ID,A.ROW_ID ,A.PI_QTY  FROM POD01106 A (NOLOCK) 
	JOIN PID01106 B (NOLOCK) ON A.ROW_ID =B.po_row_id  
	WHERE B.MRR_ID=@CMEMOID  

	 SELECT a.hsn_code  
	    into #tmphsn
	 FROM PID01106(NOLOCK) A  
	 WHERE A.MRR_ID=@CMEMOID  
	 group by a.hsn_code
	 UNION
	 SELECT b.hsn_code
	 FROM PID01106(NOLOCK) A  
	 JOIN SKU (NOLOCK) B ON LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))  =B.PRODUCT_CODE  
	 WHERE A.MRR_ID=@CMEMOID 
	 AND CHARINDEX ('@',A.product_code )<>0
	 group by b.hsn_code
	 union 
	 select other_charges_hsn_code  from pim01106 a (nolock)  WHERE A.MRR_ID=@CMEMOID  and other_charges_hsn_code<>'0000000000'
	 union 
	 select Freight_hsn_code  from pim01106 a (nolock)  WHERE A.MRR_ID=@CMEMOID  and Freight_hsn_code<>'0000000000'

	 SELECT DISTINCT 'PUR_HSN_MST_UPLOAD' AS TARGET_TABLENAME,HM.*, @CMEMOID AS PUR_MEMO_ID   
     FROM HSN_MST HM (NOLOCK)   
	 join #tmphsn tmp on hm.hsn_code =tmp.hsn_code 
    
	 SELECT DISTINCT 'PUR_HSN_DET_UPLOAD' AS TARGET_TABLENAME,HD.*, @CMEMOID AS PUR_MEMO_ID   
     FROM HSN_DET HD (NOLOCK)   
	 join #tmphsn tmp on HD.hsn_code =tmp.hsn_code 

	


 LBLPMT:

  SELECT DISTINCT 'PUR_PMT01106_upload' AS TARGET_TABLENAME, @CMEMOID AS PUR_MEMO_ID ,A.DEPT_ID,A.product_code,A.BIN_ID,A.quantity_in_stock  
  FROM PMT01106 A (NOLOCK)  
  JOIN PID01106 B (NOLOCK) ON B.product_code=A.product_code
  WHERE B.MRR_ID=@CMEMOID 
  
  SET @CTEMPDBNAME=DB_NAME()+'_IMAGE'
  
  SET @DTSQL=N'SELECT DISTINCT *,''PUR_IMAGE_INFO_DOC_UPLOAD'' AS TARGET_TABLENAME FROM '+@CTEMPDBNAME+'..IMAGE_INFO_DOC WHERE XN_TYPE=''frmTranPurchaseInvoice'' AND MEMO_ID='''+@CMEMOID+''''
  PRINT @DTSQL
  EXEC SP_EXECUTESQL @DTSQL
  
  
  SELECT 'PUR_PURCHASEORDERPROCESSINGNEW_UPLOAD' AS TARGET_TABLENAME,A.*,@CMEMOID AS PUR_MEMO_ID 
  FROM PURCHASEORDERPROCESSINGNEW A (nolock)
  JOIN PID01106 B (nolock) ON A.ROWID=B.ROW_ID
  WHERE XNTYPE ='PURCHASEINVOICE' AND B.mrr_id =@CMEMOID
  
  
  
  
  
       
LBLCHECKDATA:  
  
END TRY  
BEGIN CATCH  
 SET @CERRMSG='P: SP_SEND_MIRROR_PUR_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
 GOTO END_PROC  
END CATCH   
   
END_PROC:  
  
END   
---END OF PROCEDURE - SP_SEND_MIRROR_PUR_DATA_NEW  

