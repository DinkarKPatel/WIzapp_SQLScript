create PROCEDURE SP_GETDEBITNOTEPRINT_EXCEL      
@CRMID VARCHAR(40),      
@BOX_NO NUMERIC(9,2)=0      
AS      
BEGIN      
  
 DECLARE @AC_CODE VARCHAR(10),@TERMS VARCHAR(MAX),@MTRMSNAME VARCHAR(MAX),@CFILTERCONDITION VARCHAR(200)      
 SET @AC_CODE=(SELECT AC_CODE FROM RMM01106 WHERE RM_ID =@CRMID)      
      
 SELECT @TERMS=(SELECT STUFF((SELECT CASE WHEN ISNULL(TERMS,'') <> '' THEN ' , ' ELSE '' END +TERMS    
 FROM        
 (      
 SELECT A.AC_CODE ,B.TERMS            
 FROM  LM_TERMS  A      
 JOIN LEDGER_TERMS B ON A.TERMS_CODE =B.TERMS_CODE      
 WHERE A.AC_CODE =@AC_CODE      
 GROUP BY A.AC_CODE ,B.TERMS       
 ) LM       
 FOR XML PATH('')),1,2,'')),      
 @MTRMSNAME=(SELECT STUFF((SELECT CASE WHEN ISNULL(TERMS_NAME,'') <> '' THEN ' , ' ELSE '' END +TERMS_NAME  FROM        
 (      
 SELECT A.AC_CODE ,B.TERMS_NAME            
 FROM  LM_TERMS  A      
 JOIN LEDGER_TERMS B ON A.TERMS_CODE =B.TERMS_CODE      
 WHERE A.AC_CODE =@AC_CODE      
 GROUP BY A.AC_CODE ,B.TERMS_NAME       
 ) LM       
 FOR XML PATH('')),1,2,''))       
       
 SET @TERMS=ISNULL(@TERMS,'')  
       
 SET @CFILTERCONDITION=''      
   
 IF ISNULL(@BOX_NO,0) <> 0       
    SET @CFILTERCONDITION=' C.BOX_NO='''+RTRIM(LTRIM(STR(@BOX_NO)))+''' AND A.RM_ID='''+@CRMID+''''      
 ELSE      
    SET @CFILTERCONDITION=' A.RM_ID='''+@CRMID+''''      
   
 SET @MTRMSNAME=ISNULL(@MTRMSNAME,'')  
 --SELECT @MTRMSNAME      
 DECLARE @CCOL VARCHAR(40), @CRETCOLSTR NVARCHAR(MAX),@CCMD NVARCHAR(MAX)    
 SET @CRETCOLSTR = N''      
  --old method attributer calling so article attributer remove (bachoomalsons 28-02-2023)         
     
 DECLARE @CCMD1 NVARCHAR(MAX)   
 
 DECLARE @cpara1Name varchar(50),@cpara2Name varchar(50),@cpara3Name varchar(50),@cpara4Name varchar(50),@cpara5Name varchar(50),@cpara6Name varchar(50),    
     @CPARANAME VARCHAR(5000)    
    
   SELECT @cpara1Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA1_NAME' ELSE Quotename(VALUE) END  FROM CONFIG WHERE CONFIG_OPTION ='PARA1_CAPTION'    
   SELECT @cpara2Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA2_NAME' ELSE Quotename(VALUE) END  FROM CONFIG WHERE CONFIG_OPTION ='PARA2_CAPTION'    
   SELECT @cpara3Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA3_NAME' ELSE Quotename(VALUE) END  FROM CONFIG WHERE CONFIG_OPTION ='PARA3_CAPTION'    
   SELECT @cpara4Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA4_NAME' ELSE Quotename(VALUE) END  FROM CONFIG WHERE CONFIG_OPTION ='PARA4_CAPTION'    
   SELECT @cpara5Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA5_NAME' ELSE Quotename(VALUE) END  FROM CONFIG WHERE CONFIG_OPTION ='PARA5_CAPTION'    
   SELECT @cpara6Name=CASE WHEN ISNULL(VALUE,'')='' THEN 'PARA6_NAME' ELSE Quotename(VALUE) END  FROM CONFIG WHERE CONFIG_OPTION ='PARA6_CAPTION'    
     
 SET @CCMD=N'SELECT      
   A.RM_ID,        
   A.RM_DT AS ''MST_XN_DT'',             
   A.RM_NO  AS ''MST_RM_NO'',          
   A.SUBTOTAL  AS ''MST_SUBTOTAL'',            
   A.DISCOUNT_AMOUNT AS ''MST_DISCOUNT_AMOUNT'',            
   A.DISCOUNT_PERCENTAGE AS ''MST_DISCOUNT_PERCENTAGE'',            
   C.ITEM_TAX_AMOUNT AS ''MST_TAX_AMOUNT'',            
   C.ITEM_TAX_PERCENTAGE AS ''MST_TAX_PERCENTAGE'',            
   A.FREIGHT AS ''MST_FREIGHT'',            
   A.OTHER_CHARGES AS ''MST_OTHER_CHARGES'',            
   A.ROUND_OFF AS ''MST_ROUND_OFF'',            
   A.TOTAL_AMOUNT AS ''MST_TOTAL_AMOUNT'',       
   C.PRODUCT_CODE AS ''PRODUCT_CODE'',           
   C.BILL_NO,           
   C.GROSS_PURCHASE_PRICE ,      
   C.PURCHASE_PRICE AS ''PURCHASE_PRICE'',      
   SKU.MRP * C.QUANTITY  AS RSP_VALUE,            
   C.QUANTITY AS ''QUANTITY'',           
   C.DISCOUNT_PERCENTAGE,           
   C.DISCOUNT_AMOUNT,           
   D.ARTICLE_NO AS ''ARTICLE_NO'',           
   P1.PARA1_NAME AS  '+ @cpara1Name + ',             
   P2.PARA2_NAME AS '+ @cpara2Name + ',                   
   P3.PARA3_NAME AS  '+ @cpara3Name + ',         
   P4.PARA4_NAME AS '+ @cpara4Name + ',                  
   P5.PARA5_NAME AS '+ @cpara5Name + ',                
   P6.PARA6_NAME AS  '+ @cpara6Name + ',       
   C.QUANTITY AS ''QUANTITY'',            
   E.SUB_SECTION_NAME AS ''SUB_SECTION_NAME'',               
   F.SECTION_NAME AS ''SECTION_NAME'',             
   SKU.INV_NO  AS ''INV_NO'',            
   SKU.INV_DT AS ''INV_DT'',            
   (C.QUANTITY*C.PURCHASE_PRICE)  AS ''AMOUNT'',                  
   C.PURCHASE_PRICE 
   --02 JAN 2018 : AS PER PANKAJ/ANIL FOR BUG 112 - GST RELATED COLUMNS REQUIRED IN EXCEL DOWNLOAD OF DEBIT NOTE  
   ,C.HSN_CODE,C.GST_PERCENTAGE,C.IGST_AMOUNT,C.CGST_AMOUNT,C.SGST_AMOUNT,C.XN_VALUE_WITHOUT_GST,C.XN_VALUE_WITH_GST  
   --02 JAN 2018 : AS PER PANKAJ/ANIL FOR BUG 112 - GST RELATED COLUMNS REQUIRED IN EXCEL DOWNLOAD OF DEBIT NOTE  
   ,B.AC_NAME AS SUPPLIER_NAME  
   '    
  SET @CCMD1=N'  FROM RMM01106 A (NOLOCK)                   
   JOIN LMV01106 B (NOLOCK)  ON A.AC_CODE = B.AC_CODE                  
   LEFT JOIN RMD01106 C (NOLOCK) ON A.RM_ID = C.RM_ID          
   LEFT JOIN SKU (NOLOCK) ON C.PRODUCT_CODE = SKU.PRODUCT_CODE              
   LEFT JOIN ARTICLE D (NOLOCK)  ON SKU.ARTICLE_CODE = D.ARTICLE_CODE                  
   LEFT JOIN SECTIOND E (NOLOCK)  ON D.SUB_SECTION_CODE = E.SUB_SECTION_CODE                   
   LEFT JOIN SECTIONM F (NOLOCK) ON E.SECTION_CODE = F.SECTION_CODE                   
   LEFT JOIN PARA1 P1 (NOLOCK)  ON SKU.PARA1_CODE = P1.PARA1_CODE              
   LEFT JOIN PARA2 P2 (NOLOCK)  ON SKU.PARA2_CODE = P2.PARA2_CODE                  
   LEFT JOIN PARA3 P3 (NOLOCK)  ON SKU.PARA3_CODE = P3.PARA3_CODE           
   LEFT JOIN PARA4 P4 (NOLOCK)  ON SKU.PARA4_CODE = P4.PARA4_CODE           
   LEFT JOIN PARA5 P5 (NOLOCK)  ON SKU.PARA5_CODE = P5.PARA5_CODE             
   LEFT JOIN PARA6 P6 (NOLOCK)  ON SKU.PARA6_CODE = P6.PARA6_CODE                 
   JOIN USERS U (NOLOCK)  ON A.USER_CODE = U.USER_CODE            
   LEFT JOIN UOM H (NOLOCK)  ON D.UOM_CODE = H.UOM_CODE            
   LEFT JOIN FORM DG (NOLOCK)  ON C.ITEM_FORM_ID = DG.FORM_ID           
   LEFT OUTER JOIN LOCATION LCT (NOLOCK) ON A.PARTY_DEPT_ID=LCT.DEPT_ID          
   LEFT OUTER JOIN AREA LA ON LCT.AREA_CODE=LA.AREA_CODE          
   LEFT OUTER JOIN CITY LC ON LA.CITY_CODE=LC.CITY_CODE          
   LEFT OUTER JOIN STATE LS ON LC.STATE_CODE=LS.STATE_CODE          
   LEFT OUTER JOIN REGIONM LRG ON LS.REGION_CODE=LRG.REGION_CODE          
   JOIN COMPANY COM ON COM.COMPANY_CODE =''01''           
   LEFT OUTER JOIN DNPS_MST PM ON PM.PS_ID=C.PS_ID        
   LEFT OUTER JOIN LOCATION L (NOLOCK) ON A.ACCOUNTS_DEPT_ID = L.DEPT_ID        
   LEFT OUTER JOIN USERS EU (NOLOCK)  ON A.EDT_USER_CODE = EU.USER_CODE        
   WHERE '+@CFILTERCONDITION+'ORDER BY A.TS'      
 PRINT @CCMD       
 PRINT @CCMD1        
      
 SET  @CCMD=@CCMD+@CCMD1    
     
 EXEC SP_EXECUTESQL @CCMD       
END  