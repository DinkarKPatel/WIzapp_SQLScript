CREATE PROCEDURE VALIDATE_XN_DATA_FREEZE
(
   @CXNTYPE VARCHAR(10),
   @CUSERCODE CHAR(7),
   @CMEMOID  VARCHAR(30),
   @DMEMODTPARA DATETIME='',
   @CERRORMSG VARCHAR(200)=' ' OUTPUT


)
AS
BEGIN
	  --- This Procedure is discarded and its working shifted to GET_DATAFREEZE_STATUS
	  GOTO END_PROC	
	  
	  DECLARE @CCMD NVARCHAR(MAX),@CSTEP INT,@CERRMSG NVARCHAR(MAX),@ISENABLE INT,@FREEZEDT DATE,
	  @FREEZEDAYS INT ,   @DMEMODT DATETIME,@DMEMODT2 DATETIME,@CMASTERTABLENAME VARCHAR(200),@MEMODTNAME VARCHAR(200),
	  @CKEYFIELD VARCHAR(200),@LAST_RUN_DATE DATE, @CXNTYPE_FIN VARCHAR(10),@CROLEID CHAR(7),@CMSGDATE VARCHAR(20),
	  @BVALIDITYEXTENDED BIT,@BFLAG BIT

          
BEGIN TRY
	   
	   SET @CSTEP=9	 	
	   SET @DMEMODT2=''
	   
	   --IF @CXNTYPE='SLS'
		--	SELECT @CUSERCODE
				
	   SELECT @ISENABLE=ISNULL(ISENABLED,0)  FROM FIXEDFREEZE 
       IF ISNULL(@ISENABLE,0)=0
		  GOTO END_PROC

       SET @CSTEP=10
		IF @CXNTYPE='PUR'
				SELECT	@CMASTERTABLENAME='PIM01106',@CKEYFIELD='MRR_ID' ,@MEMODTNAME='RECEIPT_DT'
		ELSE
			IF @CXNTYPE='PRT'
				SELECT	@CMASTERTABLENAME='RMM01106',@CKEYFIELD='RM_ID' ,@MEMODTNAME='RM_DT'
		ELSE
			IF @CXNTYPE='SLS'
				SELECT	@CMASTERTABLENAME='CMM01106',@CKEYFIELD='CM_ID' ,@MEMODTNAME='CM_DT'
		ELSE
			IF @CXNTYPE='APP'
				SELECT	@CMASTERTABLENAME='APM01106',@CKEYFIELD='MEMO_ID' ,@MEMODTNAME='MEMO_DT'
		ELSE
			IF @CXNTYPE='APR'
				SELECT	@CMASTERTABLENAME='APPROVAL_RETURN_MST',@CKEYFIELD='MEMO_ID' ,@MEMODTNAME='MEMO_DT'
		ELSE
			IF @CXNTYPE='WSL'
				SELECT	@CMASTERTABLENAME='INM01106',@CKEYFIELD='INV_ID' ,@MEMODTNAME='INV_DT'
		ELSE
			IF @CXNTYPE='WSR'
				SELECT	@CMASTERTABLENAME='CNM01106',@CKEYFIELD='CN_ID' ,@MEMODTNAME='CN_DT'
		ELSE
			IF @CXNTYPE='CNC'
				SELECT	@CMASTERTABLENAME='ICM01106',@CKEYFIELD='CNC_MEMO_ID' ,@MEMODTNAME='CNC_MEMO_DT'
		ELSE
			IF @CXNTYPE='PTC'
				SELECT	@CMASTERTABLENAME='PEM01106',@CKEYFIELD='PEM_MEMO_ID' ,@MEMODTNAME='PEM_MEMO_DT'
		ELSE
			IF @CXNTYPE='ARC'
				SELECT	@CMASTERTABLENAME='ARC01106',@CKEYFIELD='ADV_REC_ID' ,@MEMODTNAME='ADV_REC_DT'
		ELSE
			IF @CXNTYPE='RPS'
				SELECT	@CMASTERTABLENAME='RPS_MST',@CKEYFIELD='CM_ID',@MEMODTNAME='CM_DT' 
		ELSE
			IF @CXNTYPE='SNC'
				SELECT	@CMASTERTABLENAME='SNC_MST',@CKEYFIELD='MEMO_ID',@MEMODTNAME='RECEIPT_DT' 
		ELSE
			IF @CXNTYPE='JWI'
				SELECT	@CMASTERTABLENAME='JOBWORK_ISSUE_MST',@CKEYFIELD='ISSUE_ID' ,@MEMODTNAME='ISSUE_DT'
		ELSE
			IF @CXNTYPE='JWR'
				SELECT	@CMASTERTABLENAME='JOBWORK_RECEIPT_MST',@CKEYFIELD='RECEIPT_ID' ,@MEMODTNAME='RECEIPT_DT'		
		ELSE
			IF @CXNTYPE='PRD_JWI'
				SELECT	@CMASTERTABLENAME='PRD_JOBWORK_ISSUE_MST',@CKEYFIELD='ISSUE_ID' ,@MEMODTNAME='ISSUE_DT'
		ELSE
			IF @CXNTYPE='PRD_JWR'
				SELECT	@CMASTERTABLENAME='PRD_JOBWORK_RECEIPT_MST',@CKEYFIELD='RECEIPT_ID' ,@MEMODTNAME='RECEIPT_DT'
	   ELSE
			IF @CXNTYPE='WPS' 
				SELECT	@CMASTERTABLENAME='WPS_MST',@CKEYFIELD='PS_ID' ,@MEMODTNAME='PS_DT'		
	     ELSE
			
			IF @CXNTYPE='IRR'
				SELECT	@CMASTERTABLENAME='IRM01106',@CKEYFIELD='IRM_MEMO_ID' ,@MEMODTNAME='IRM_MEMO_DT'		
		ELSE
			IF @CXNTYPE='WSLORD'
				SELECT	@CMASTERTABLENAME='WSL_ORDER_MST',@CKEYFIELD='ORDER_ID' ,@MEMODTNAME='ORDER_DT'	
	    ELSE
			IF @CXNTYPE='DNPS'
				SELECT	@CMASTERTABLENAME='DNPS_MST',@CKEYFIELD='PS_ID' ,@MEMODTNAME='PS_DT'	
		ELSE
       GOTO END_PROC  		
			                     
			
         IF EXISTS(SELECT * FROM CONFIG WHERE CONFIG_OPTION='DO_NOT_ENFORCE_LAST_RUN_DT' AND VALUE='1')
         	SET @LAST_RUN_DATE=  ''
         ELSE
		   SELECT @LAST_RUN_DATE= DATEADD(DD,1,dbo.fn_getlastrundate())

          IF ISNULL(@DMEMODTPARA,'')<>''
		  BEGIN
			   SET @DMEMODT=@DMEMODTPARA
		  END
          ELSE
		  BEGIN
			  SET @CSTEP=20	 
			  SET @CCMD=N'  SELECT  @DMEMODT = CAST('+@MEMODTNAME+'  AS DATE)FROM   '+@CMASTERTABLENAME+' WHERE  '+@CKEYFIELD+'='''+@CMEMOID+'''' 
			  PRINT @CCMD
	          
			  EXEC SP_EXECUTESQL @CCMD, N'@DMEMODT DATETIME OUTPUT',
			  @DMEMODT OUTPUT  
			  
			  IF @CXNTYPE='PUR'
					SELECT @DMEMODT2=INV_DT FROM PIM01106 WHERE MRR_ID=@CMEMOID
	      END
          
          --SELECT @CUSERCODE
          IF @CUSERCODE=''
          BEGIN
			  SET @CCMD=N'  SELECT  @CUSERCODEOUT = USER_CODE FROM   '+@CMASTERTABLENAME+' WHERE  '+@CKEYFIELD+'='''+@CMEMOID+'''' 
			  PRINT @CCMD
	          
			  EXEC SP_EXECUTESQL @CCMD, N'@CUSERCODEOUT CHAR(7) OUTPUT',
			  @CUSERCODEOUT=@CUSERCODE OUTPUT             
          END
                 
          SET @CXNTYPE_FIN=(CASE WHEN @CXNTYPE='WPS' THEN 'WSL'
                                 WHEN @CXNTYPE='PBG' THEN 'PUR'
                                 WHEN @CXNTYPE='APR' THEN 'APP'
                                 WHEN @CXNTYPE='RPS' THEN 'SLS'
                                 WHEN @CXNTYPE='JWR' THEN 'JWI' 
                                 WHEN @CXNTYPE='WSLORD' THEN 'WSL'
                                 WHEN @CXNTYPE='DNPS' THEN 'PRT' 
							     ELSE @CXNTYPE END)  
             
          SELECT  @CROLEID=ROLE_ID FROM USERS WHERE USER_CODE=@CUSERCODE
                        
          SELECT @FREEZEDT=ISNULL(FIXEDDATE,'') FROM FIXEDFREEZE                
          
          IF EXISTS (SELECT ISNULL(FREEZEDAYS,0) FROM ROLLINGFREEZE WHERE XN_TYPE=@CXNTYPE_FIN AND ROLE_ID=@CROLEID)  
          BEGIN
			  SET @BVALIDITYEXTENDED=1
			  
              SELECT @FREEZEDAYS=ISNULL(FREEZEDAYS,0) FROM ROLLINGFREEZE WHERE XN_TYPE=@CXNTYPE_FIN AND ROLE_ID=@CROLEID                   
			   			   
		      SET @LAST_RUN_DATE=  CAST(DATEADD(DD,-(@FREEZEDAYS),@LAST_RUN_DATE) AS DATE)  
		  END

		  --IF @CXNTYPE_FIN='PUR'	
		--		SELECT @CXNTYPE_FIN,@CROLEID,@LAST_RUN_DATE,@DMEMODT,@FREEZEDT,@DMEMODT2
		  
		  SET @BFLAG=0
		  
		  IF NOT ( ISNULL(@DMEMODT,'') >=ISNULL(@LAST_RUN_DATE,'') AND ISNULL(@DMEMODT,'') > ISNULL(@FREEZEDT,''))				
				SET @BFLAG=1
				
		  IF @BFLAG=0 AND @DMEMODT2<>''
		  BEGIN
				IF NOT ( ISNULL(@DMEMODT2,'') >=ISNULL(@LAST_RUN_DATE,'') AND ISNULL(@DMEMODT2,'') > ISNULL(@FREEZEDT,''))
					SET @BFLAG=1
		  END
		  	
	      IF @BFLAG=1
	      BEGIN
				SET @CMSGDATE=(CASE WHEN DATEADD(DD,-1,@LAST_RUN_DATE) <ISNULL(@FREEZEDT,'') 
								    THEN CONVERT(VARCHAR,ISNULL(@FREEZEDT,''),105)
									ELSE CONVERT(VARCHAR,DATEADD(DD,-1,@LAST_RUN_DATE),105) END) 
				
				--IF @CXNTYPE='SLS'
				--	SELECT 'CHECK',@DMEMODT,@FREEZEDT,@LAST_RUN_DATE,@CROLEID,@CUSERCODE
									
	            SET @CERRMSG='DATA FREEZED UPTO '+@CMSGDATE
	            GOTO END_PROC 
	      END              
	
                   

END TRY
BEGIN CATCH

   SET @CERRMSG='ERROR IN VALIDATE_XN_DATA_FREEZE : STEP # '+@CSTEP+' - '+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH


END_PROC:


	SET @CERRORMSG=ISNULL(@CERRMSG,'') 
END
--*************************************** END OF PROCEDURE VALIDATE_XN_DATA_FREEZE
