CREATE PROCEDURE SP_PPC_RMREQUIREMENT
(
 @NQUERYID INT=0,
 @CAC_CODE VARCHAR(MAX)='',
 @BILL_NO VARCHAR(MAX)='',
 @CUSER_CODE VARCHAR(10)='',
 @NPENDING INT=0,
 @ACRTICLE_CODE VARCHAR(MAX)='',
 @CRM_ARTICLE VARCHAR(MAX)=''
)
AS
BEGIN
    
    
DECLARE @DTSQL NVARCHAR(MAX),@CFILTER VARCHAR(MAX),@CRM_FILTER VARCHAR(MAX)
SET @CFILTER=''
SET @CRM_FILTER=''
    
	IF ISNULL(@CAC_CODE,'')<>''
	SET @CFILTER=' AND B.AC_CODE '+@CAC_CODE+''  
	
	IF ISNULL(@BILL_NO,'')<>''
	SET @CFILTER=@CFILTER+' AND B.BILL_NO '+@BILL_NO+'' 
	
	IF ISNULL(@ACRTICLE_CODE,'')<>''
	SET @CFILTER=@CFILTER+' AND ART.ARTICLE_CODE '+@ACRTICLE_CODE+''  
	
	IF ISNULL(@CRM_ARTICLE,'')<>''
	SET @CRM_FILTER=' AND BOM.BOM_ARTICLE_CODE '+@CRM_ARTICLE+''
	
	
 
     IF OBJECT_ID('TEMPDB..#TMPORDER','U') IS NOT NULL
     DROP TABLE #TMPORDER
     
     SELECT B.ORDER_DT,B.BILL_NO AS  ORDER_NO, 
			LM.AC_NAME,B.BILL_NO,
		    A.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,
			A.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
			A.PARA1_CODE,P1.PARA1_NAME,
			A.PARA3_CODE,P3.PARA3_NAME ,
			A.QUANTITY  AS QUANTITY,
			A.ORDER_ID,
			A.QUANTITY AS  ORDER_QTY ,
			A.ROW_ID AS BO_ROW_ID
	 INTO #TMPORDER
     FROM PPC_BUYER_ORDER_DET A
     JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID =B.ORDER_ID 
	 JOIN LM01106 LM ON LM.AC_CODE =B.AC_CODE 
     JOIN ARTICLE ART ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
	 JOIN PARA1 P1 ON P1.PARA1_CODE =A.PARA1_CODE 
	 JOIN PARA3 P3 ON P3.PARA3_CODE =A.PARA3_CODE 
	 JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =A.SIZEGROUP_CODE 
     WHERE B.CANCELLED =0
     AND 1=2
     
  SET @DTSQL=N'INSERT INTO  #TMPORDER(ORDER_DT ,ORDER_NO,AC_NAME,BILL_NO,ARTICLE_CODE,ARTICLE_NO,ARTICLE_NAME,SIZEGROUP_CODE,SIZEGROUP_NAME,
     PARA1_CODE,PARA1_NAME,PARA3_CODE,PARA3_NAME,QUANTITY,ORDER_ID,ORDER_QTY,BO_ROW_ID)
      SELECT B.ORDER_DT,B.BILL_NO AS ORDER_NO, 
			LM.AC_NAME,B.BILL_NO,
		    A.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,
			A.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
			A.PARA1_CODE,P1.PARA1_NAME,
			A.PARA3_CODE,P3.PARA3_NAME ,
			A.QUANTITY  AS QUANTITY,
			A.ORDER_ID,
			A.QUANTITY AS  ORDER_QTY ,
			A.ROW_ID AS BO_ROW_ID
	 
     FROM PPC_BUYER_ORDER_DET A
     JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID =B.ORDER_ID 
	 JOIN LM01106 LM ON LM.AC_CODE =B.AC_CODE 
     JOIN ARTICLE ART ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
	 JOIN PARA1 P1 ON P1.PARA1_CODE =A.PARA1_CODE 
	 JOIN PARA3 P3 ON P3.PARA3_CODE =A.PARA3_CODE 
	 JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =A.SIZEGROUP_CODE 
     WHERE B.CANCELLED =0 
     '+@CFILTER
     PRINT @DTSQL
     EXEC SP_EXECUTESQL @DTSQL
    
     
     
     
	IF OBJECT_ID('TEMPDB..#TMPPENDING','U') IS NOT NULL
     DROP TABLE #TMPPENDING  	
		
		SELECT A.ORDER_DT, A.ORDER_NO,A.AC_NAME,
			   A.BILL_NO,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA3_CODE,A.SIZEGROUP_CODE,
			   A.PARA3_NAME,A.ARTICLE_NO,A.PARA1_NAME,A.SIZEGROUP_NAME,
			   A.BO_ROW_ID ,
			   A.QUANTITY AS ORDER_QTY,
			   CN.BOM_ARTICLE_CODE,
			   BOM_QTY,
		       CAST('' AS VARCHAR(100)) AS UOM_NAME,
		       CAST(0 AS NUMERIC(10,2))CONVERSION_VALUE,
		       CAST('' AS VARCHAR(10)) AS UOM_CODE,
		       BOM_QTY AS AVG_QTY,
		       CN.JOB_CODE,
		       CAST('' AS VARCHAR(100)) AS JOB_NAME,
		       CONSUME_QTY AS CONSUME_QTY,
		       REQ_QTY=CAST(0 AS NUMERIC(10,2)),
		       CAST(0 AS NUMERIC(10,2))   AS STOCK_QTY
		INTO #TMPPENDING
		FROM #TMPORDER A
		JOIN PPC_BO_ART_JOBS_CONSUME CN ON CN.REF_ROW_ID=A.BO_ROW_ID 
		JOIN PPC_BO_ART_BOM BOM ON BOM.REF_ROW_ID=A.BO_ROW_ID AND BOM.BOM_ARTICLE_CODE=CN.BOM_ARTICLE_CODE
		WHERE 1=2
		
	
	 SET @DTSQL=N'	SELECT A.ORDER_DT, A.ORDER_NO,A.AC_NAME,
			   A.BILL_NO,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA3_CODE,A.SIZEGROUP_CODE,
			   A.PARA3_NAME,A.ARTICLE_NO,A.PARA1_NAME,A.SIZEGROUP_NAME,
			   A.BO_ROW_ID ,
			   A.QUANTITY AS ORDER_QTY,
			   CN.BOM_ARTICLE_CODE,
			   BOM_QTY,
		       ISNULL(BU.CONVERSION_UOM_NAME,UOM_NAME) AS UOM_NAME,
		       UC.CONVERSION_VALUE,
		       UOM.UOM_CODE,
		       BOM_QTY AS AVG_QTY,
		       CN.JOB_CODE,
		       JOBS.JOB_NAME,
		       CONSUME_QTY AS CONSUME_QTY,
		       REQ_QTY=CONVERT(NUMERIC(12,2),CASE WHEN UC.CONVERSION_VALUE =0 THEN (A.QUANTITY*CONSUME_QTY )
		       ELSE (A.QUANTITY*CONSUME_QTY) /UC.CONVERSION_VALUE END ),
		       CAST(ISNULL(PMT.QUANTITY_IN_STOCK,0) AS NUMERIC(10,2))   AS STOCK_QTY
		FROM #TMPORDER A
		JOIN PPC_BO_ART_JOBS_CONSUME CN ON CN.REF_ROW_ID=A.BO_ROW_ID 
		JOIN PPC_BO_ART_BOM BOM ON BOM.REF_ROW_ID=A.BO_ROW_ID AND BOM.BOM_ARTICLE_CODE=CN.BOM_ARTICLE_CODE
		JOIN ARTICLE ART ON ART.ARTICLE_CODE=CN.BOM_ARTICLE_CODE
		JOIN UOM ON UOM.UOM_CODE=ART.UOM_CODE
		LEFT OUTER JOIN PPC_UOM_CONVERSION UC ON UC.UOM_CODE=UOM.UOM_CODE
		LEFT OUTER JOIN PPC_BOM_UOM BU ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE
		LEFT JOIN
		(
			SELECT SKU.ARTICLE_CODE,SUM(QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK 
			FROM PPC_PMT A
			JOIN PPC_SKU SKU ON A.PRODUCT_UID=SKU.PRODUCT_UID
			GROUP BY SKU.ARTICLE_CODE
		) PMT ON PMT.ARTICLE_CODE =BOM.BOM_ARTICLE_CODE
		JOIN JOBS ON JOBS.JOB_CODE =CN.JOB_CODE 
		WHERE CN.CONSUME_QTY>0 '+@CRM_FILTER
		
	 PRINT @DTSQL
	 INSERT INTO #TMPPENDING(ORDER_DT, ORDER_NO,AC_NAME,BILL_NO,ARTICLE_CODE,PARA1_CODE,PARA3_CODE,SIZEGROUP_CODE,
     PARA3_NAME,ARTICLE_NO,PARA1_NAME,SIZEGROUP_NAME,BO_ROW_ID ,ORDER_QTY,BOM_ARTICLE_CODE,
     BOM_QTY,UOM_NAME,CONVERSION_VALUE,UOM.UOM_CODE,AVG_QTY,JOB_CODE,JOB_NAME,CONSUME_QTY,REQ_QTY,STOCK_QTY)
     EXEC SP_EXECUTESQL @DTSQL
       
	SELECT  A.AC_NAME,A.ORDER_NO,
	        CONVERT(VARCHAR(10),A.ORDER_DT,105) AS ORDER_DT,
	        A.ARTICLE_CODE,A.ARTICLE_NO AS FG_ARTICLE_NO,
	        A.PARA1_CODE,A.PARA1_NAME,
	        A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,
	        A.PARA3_CODE,A.PARA3_NAME,
	        A.ORDER_QTY AS ORDER_QTY,
	        A.BOM_ARTICLE_CODE ,
	        ART.ARTICLE_NO AS BOM_ARTICLE_NO,
			A.JOB_CODE,
			A.JOB_NAME,
			CAST(A.BOM_QTY AS NUMERIC(10,3)) AS BOM_QTY,
			CAST(A.CONSUME_QTY AS NUMERIC(10,3)) AS CONSUME_QTY,
			CAST(A.AVG_QTY AS NUMERIC(10,3)) AS AVG_QTY,
			CONVERT(NUMERIC(10,3),REQ_QTY) AS REQ_QTY,
			A.UOM_CODE,
			A.UOM_NAME,
			UOM.UOM_NAME AS STOCK_UOM,
			STOCK_QTY AS STOCK_QTY,
			ART.ARTICLE_TYPE,
			CASE WHEN ART.ARTICLE_TYPE=1 THEN 'FINISH GOOD'
			     WHEN ART.ARTICLE_TYPE=2 THEN 'RAW ARTICLE'
			     WHEN ART.ARTICLE_TYPE=3 THEN 'ACCESSORIES'
			     WHEN ART.ARTICLE_TYPE=4 THEN 'TRIM'
			     ELSE 'PACKING MATERIAL' END AS ARTICLE_TYPE_NAME
	FROM #TMPPENDING A
	JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.BOM_ARTICLE_CODE
	JOIN UOM ON UOM.UOM_CODE=ART.UOM_CODE
	LEFT JOIN PPC_UOM_CONVERSION UC ON UC.UOM_CODE =UOM.UOM_CODE
	WHERE ISNULL(STOCK_QTY,0)>=0
	ORDER BY A.ORDER_DT ,ORDER_NO,FG_ARTICLE_NO,A.PARA1_NAME,A.SIZEGROUP_NAME,
	ART.ARTICLE_NO,A.JOB_NAME
 
 
 END_PROC:
END
