CREATE PROCEDURE SP3S_POSTSALE_JOBWORK_ISSUE
(
	----LIST OF INPUT PARAMETERS WITH DESCRIPTION
	 @DFROM_DT DATETIME
	,@DTO_DT DATETIME
	,@AGENCYCODE VARCHAR(20)=''
	,@CANCELLED NUMERIC(1)=2
	,@LOC VARCHAR(5)=''
	
)
--WITH ENCRYPTION
AS
BEGIN    
          
         SELECT  ISSMST.ISSUE_NO,ISSMST.ISSUE_ID AS MEMO_ID,ISSMST.ISSUE_DT,
         COUNT(P.ISSUE_ID ) AS ISSUE_QUANTITY,
         ISSMST.SUBTOTAL,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,ISSMST.ROUND_OFF,TOTAL_AMOUNT,
         ISSMST.LAST_UPDATE,ISSMST.FIN_YEAR,
         ISSMST.ISSUED_BY,ISSMST.CHECKED_BY,
         USER_NMAE=U.USERNAME ,
         EDT_USER_NAME=U1.USERNAME,
         CANCELLED=CASE WHEN ISSMST.CANCELLED <>0 THEN 'CANCELLED' ELSE '' END,
         ISSMST.REF_NO,
         D.AGENCY_NAME,
         ISSUE_TYPE,ISSMST.REMARKS,ISSMST.BIN_ID,
		 EMPLOYEE=H.EMP_NAME ,
		 C.COMPANY_NAME,
		 DEPT_NAME
		 FROM POST_SALES_JOBWORK_ISSUE_MST ISSMST (NOLOCK)        
		 JOIN POST_SALES_JOBWORK_ISSUE_DET P (NOLOCK) ON ISSMST.ISSUE_ID=P.ISSUE_ID
		 JOIN PRD_AGENCY_MST D (NOLOCK) ON ISSMST.AGENCY_CODE = D.AGENCY_CODE                           
		 LEFT JOIN EMPLOYEE  H (NOLOCK) ON ISSMST.EMP_CODE = H.EMP_CODE                      
		 JOIN LOCATION ON LOCATION.DEPT_ID=ISSMST.location_Code   
		 LEFT JOIN USERS U ON U.USER_CODE=ISSMST.USER_CODE
		 LEFT JOIN USERS U1 ON U1.USER_CODE=ISSMST.EDT_USER_CODE
		 LEFT JOIN COMPANY C ON C.COMPANY_CODE=ISSMST.COMPANY_CODE 
		 WHERE P.JOB_CODE <> '0000000' 
		 AND ISSMST.ISSUE_DT BETWEEN @DFROM_DT AND @DTO_DT
		 AND (@AGENCYCODE='' OR  ISSMST.AGENCY_CODE=@AGENCYCODE)
		 AND (@CANCELLED=2 OR ISSMST.CANCELLED =@CANCELLED) 
		 AND (@LOC='' OR ISSMST.location_Code=@LOC)	
		 GROUP BY ISSMST.ISSUE_NO,ISSMST.ISSUE_ID,ISSMST.ISSUE_DT,
         C.COMPANY_NAME,ISSMST.LAST_UPDATE,ISSMST.FIN_YEAR,
         ISSMST.ISSUED_BY,ISSMST.CHECKED_BY,
         U.USERNAME ,U1.USERNAME,ISSMST.CANCELLED,
         ISSMST.SUBTOTAL,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,ISSMST.ROUND_OFF,TOTAL_AMOUNT,ISSMST.REF_NO,
         D.AGENCY_NAME,ISSUE_TYPE,ISSMST.REMARKS,ISSMST.BIN_ID,
		 H.EMP_NAME ,DEPT_NAME
       
        
 
END
---END PROCEDURE SP3S_POSTSALE_JOBWORK_ISSUE
