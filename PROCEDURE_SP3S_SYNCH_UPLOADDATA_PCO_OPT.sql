create PROCEDURE SP3S_SYNCH_UPLOADDATA_PCO_OPT
(
    @CSPID VARCHAR(50)
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
      DECLARE @DTSQL NVARCHAR(MAX),@CTMP_TABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(100),
      @CTABLESUFFIX VARCHAR(100),
      @CERRORMSG VARCHAR(MAX),@CSTEP VARCHAR(10),@CKEYFIELD  VARCHAR(50),@CTABLENAME VARCHAR(100),
      @CERRMSGOUT VARCHAR(500),@CCMD NVARCHAR(MAX),@CPARTY_DEPT_ID VARCHAR(10),@CHOLOCATIONID VARCHAR(10),
	   @CMEMOID VARCHAR(50),@CLOCID VARCHAR(5),@CSOURCEDB VARCHAR(200),@CMERGEDB VARCHAR(200),@BMSTINSERTONLY BIT,
	   @CFILTERCONDITION VARCHAR(500)
      
    BEGIN TRY	
      SET @CSTEP = 10  
    
      SET @CERRORMSG=''   
      SET @CTABLESUFFIX='UPLOAD'
	 
	 BEGIN TRANSACTION
	  --SET @CSOURCEDB=DB_NAME()+'_TEMP.DBO.'
	  SET @CTABLE_SUFFIX=@CTABLESUFFIX
	     
    
	    SELECT @CHOLOCATIONID= VALUE FROM CONFIG WHERE  CONFIG_OPTION = 'HO_LOCATION_ID'
	    
		  SET @CSOURCEDB=''
	      SET @CMERGEDB=''

	  	SELECT TOP 1 @CMEMOID = B.MEMO_ID 
		FROM PCO_PCO_MST_UPLOAD B (NOLOCK)
		WHERE  SP_ID=@CSPID 
   
        SET @CSTEP = 15
		IF ISNULL(@CMEMOID,'')=''
			GOTO EXIT_PROC
		
		SET @CFILTERCONDITION = ' B.SP_ID='''+LTRIM(RTRIM((@CSPID)))+''''
	
  
        SET @CTABLENAME='PCO_MST'  
        SET @CTMP_TABLENAME='PCO_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
        SET @CKEYFIELD='MEMO_ID'  
        
        
	    SET @CCMD = N'SELECT @CPARTY_DEPT_ID =  SUBSTRING(MEMO_NO,3,2) FROM '+@CSOURCEDB+@CTMP_TABLENAME+''
	    PRINT @CCMD
	    EXEC SP_EXECUTESQL @CCMD,N'@CPARTY_DEPT_ID VARCHAR(10) OUTPUT',@CPARTY_DEPT_ID OUTPUT		
	  
        EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
         ,@BALWAYSUPDATE=1   ,@CFILTERCONDITION=@CFILTERCONDITION
	 

		IF(@CPARTY_DEPT_ID=@CHOLOCATIONID) 
		BEGIN
			SET @CSTEP=20 

			INSERT docpco_pco_mst_upload	( amount, BANK_AC_CODE, cancelled, doc_synch_last_update, fin_year,
			HO_SYNCH_LAST_UPDATE, last_update, memo_dt, memo_id, memo_no,REMARKS,  TRANSFER_MODE, USER_CODE,location_Code,target_location_Code  )  
			SELECT 	  amount, BANK_AC_CODE, cancelled, doc_synch_last_update, fin_year, HO_SYNCH_LAST_UPDATE, 
			last_update, memo_dt, memo_id, memo_no,REMARKS, TRANSFER_MODE, USER_CODE ,location_Code,target_location_Code
			FROM pco_mst (NOLOCK) WHERE memo_id=@CMEMOID

		
			SET @CSTEP=30
			PRINT 'SP_MERGE_MIRROR_DOCPCO_DATA START'+@CMEMOID+' '+@CLOCID+' '
			EXEC SP_MERGE_MIRROR_DOCPCO_DATA 
			@CMEMOID=@CMEMOID,
			@CERRMSG=@CERRMSG OUTPUT
			
			SET @CSTEP=40
			DELETE FROM docpco_pco_mst_upload with (rowlock) where memo_id=@cMemoId
		END

		SET @CSTEP=50
		 DELETE FROM PCO_PCO_MST_UPLOAD WHERE SP_ID=@CSPID 
END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP_MERGE_MIRROR_PCO_DATA, STEP:'+LTRIM(RTRIM((@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
END CATCH
     
     

EXIT_PROC:
	 IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0  
     BEGIN  
		 COMMIT    

     END  
     ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0  
			ROLLBACK  

END
