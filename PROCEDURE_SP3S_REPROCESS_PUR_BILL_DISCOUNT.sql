create PROCEDURE SP3S_REPROCESS_PUR_BILL_DISCOUNT
(
 @CMEMO_ID VARCHAR(100),
 @NSPID varchar(40)=''
,@ERRMSG VARCHAR(MAX) OUTPUT
)
AS
BEGIN
 BEGIN TRY
       
       DECLARE @CTMPMASTERTABLE VARCHAR(100),@CTMPDETAILTABLE VARCHAR(100),
       @NTOTAL_DISCOUNT_AMOUNT NUMERIC(10,2),@NITEM_DISCOUNT_AMOUNT NUMERIC(10,2),@DTSQL NVARCHAR(MAX),
       @NTOTALDIFF NUMERIC(10,2),@CIN_VALUE NUMERIC(10,2),
       @NNEWDIFF NUMERIC(10,2),@NPREVDIFF NUMERIC(10,2),@CTEMPDBNAME VARCHAR(100)

	   SET @CTEMPDBNAME = ''
       SET @NPREVDIFF=0
       
      
		SELECT  @NTOTAL_DISCOUNT_AMOUNT= ISNULL(DISCOUNT_AMOUNT,0)  FROM #tMstTable 
	       
LBLCALCULATE: 
	         
		   SELECT  @NITEM_DISCOUNT_AMOUNT= SUM(ISNULL(PIMDISCOUNTAMOUNT,0))  FROM #tDetTable
		   
	         
			SET @NNEWDIFF=ABS( ISNULL(@NTOTAL_DISCOUNT_AMOUNT,0)-ISNULL(@NITEM_DISCOUNT_AMOUNT,0))
	        
			IF ISNULL(@NPREVDIFF,0)=ISNULL(@NNEWDIFF,0)
			GOTO END_PROC
	        
			SET @NTOTALDIFF=ABS( ISNULL(@NTOTAL_DISCOUNT_AMOUNT,0)-ISNULL(@NITEM_DISCOUNT_AMOUNT,0))*100
	        
		   IF (@NTOTAL_DISCOUNT_AMOUNT=0   OR @NTOTALDIFF=0)
		   GOTO END_PROC
	      
	     
	      
		  IF ISNULL(@NTOTAL_DISCOUNT_AMOUNT,0)>ISNULL(@NITEM_DISCOUNT_AMOUNT,0)
			  SET @CIN_VALUE=.01
		  ELSE
			  SET @CIN_VALUE=-.01
	          
	    
			;WITH CTE AS
			(SELECT A.*,SR=ROW_NUMBER() OVER (ORDER BY ROW_ID)
			 FROM  #tDetTable a
			 ) 
	         
			 UPDATE CTE SET PIMDISCOUNTAMOUNT=PIMDISCOUNTAMOUNT+@CIN_VALUE WHERE SR<=@NTOTALDIFF
	       
		  --SET @NPREVDIFF=@NNEWDIFF
		  --GOTO LBLCALCULATE  
		  
		  GOTO END_PROC
END TRY
BEGIN CATCH
  SET @ERRMSG =' SPID : '+LTRIM(RTRIM((@NSPID)))+' || ERROR IN PROCEDURE || SP3S_REPROCESS_PUR_BILL_DISCOUNT ERROR MESSAGE || '+ ERROR_MESSAGE();
END CATCH

END_PROC:
END
