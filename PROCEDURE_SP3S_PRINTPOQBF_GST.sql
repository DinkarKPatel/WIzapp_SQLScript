CREATE PROCEDURE SP3S_PRINTPOQBF_GST(@PO_ID VARCHAR(100))
AS 
BEGIN
  SET NOCOUNT ON 
  SELECT A.CHECKED_BY AS MST_CHECKED_BY,A.DISCOUNT_AMOUNT AS MST_DISCOUNT_AMOUNT,A.DISCOUNT_PERCENTAGE AS MST_DISCOUNT_PERCENTAGE,  
  A.FREIGHT AS MST_FREIGHT,A.OTHER_CHARGES AS MST_OTHER_CHARGES,A.PO_DT AS MST_XN_DT,A.PO_ID,A.PO_NO AS MST_PO_NO,  
  A.REMARKS AS MST_REMARKS,A.ROUND_OFF AS MST_ROUND_OFF,A.SUBTOTAL AS MST_SUBTOTAL,D.TAX_AMOUNT AS MST_TAX_AMOUNT,  
  D.TAX_PERCENTAGE AS MST_TAX_PERCENTAGE,A.TOTAL_AMOUNT AS MST_TOTAL_AMOUNT,A.FIN_YEAR AS MST_FIN_YEAR,B.PRINT_NAME,  
  B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.PINCODE,B.CITY,B.[STATE],B.CST_NO,B.CST_DT,B.SST_NO,B.SST_DT,B.TIN_NO,  
  B.TIN_DT,B.PHONES_R,B.PHONES_O,B.PHONES_FAX,B.MOBILE,B.E_MAIL,B.TAX_CODE,B.CREDIT_LIMIT,B.PAN_NO,B.GLN_NO,C.USERNAME AS MST_CREATED_USERNAME,  
  C.USERNAME AS MST_USERNAME,P1.PARA1_NAME,P2.PARA2_NAME,P3.PARA3_NAME,P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME,E.ARTICLE_NO,  
  D.AMOUNT,D.MP_PERCENTAGE,D.MRP,D.PRODUCT_CODE,D.PURCHASE_PRICE,D.QUANTITY,D.WHOLESALE_PRICE,D.WD_PERCENTAGE,U.UOM_NAME,A.PO_NO  
  ,A.PO_DT,A.AC_CODE,B.AC_GST_NO,A.TOTAL_AMOUNT,A.REMARKS,A.LAST_UPDATE,A.TS,A.SUBTOTAL,D.DISCOUNT_PERCENTAGE AS DISCOUNT_PERCENTAGE  
  ,D.DISCOUNT_AMOUNT AS DISCOUNT_AMOUNT,A.OTHER_CHARGES,A.CANCELLED,A.REF_NO,A.REF_NO AS MST_REF_NO,A.COMPANY_CODE,A.USER_CODE,A.SENT_TO_HO  
  ,A.FIN_YEAR,A.DEPT_ID,A.MEMO_PREFIX AS MST_MEMO_PREFIX,A.CHECKED_BY,A.SENT_BY,A.BILL_LEVEL_TAX_METHOD AS MST_BILL_LEVEL_TAX_METHOD  
  ,A.PUR_CAL_METHOD AS MST_PUR_CAL_METHOD,A.[SENT],A.TAX_PERCENTAGE,A.FREIGHT,A.ROUND_OFF,A.TAX_AMOUNT,A.EDT_USER_CODE,A.PO_TIME,A.APPROVED  
  ,A.FREIGHT_HSN_CODE,A.FREIGHT_GST_PERCENTAGE,A.FREIGHT_IGST_AMOUNT,A.FREIGHT_CGST_AMOUNT,A.FREIGHT_SGST_AMOUNT,A.FREIGHT_TAXABLE_VALUE  
  ,A.CREDIT_DAYS,A.FREIGHT_MODE,A.DELIVERY_MODE,A.FORM_ID,A.MODE,A.MODE AS MST_MODE,A.CREDIT_DAYS AS MST_CREDIT_DAYS,A.TAXFORM_STORAGE_MODE AS MST_TAXFORM_STORAGE_MODE  
  ,A.CANCELLED_ON,A.UPLOADED_TO_ACTIVSTREAM,B.TDS_CODE,B.INACTIVE,B.AC_NAME,B.AC_NAME AS MST_AC_NAME,B.ALIAS,B.HEAD_CODE,B.CLOSING_BALANCE,B.CLOSING_BALANCE_CR_DR  
  ,B.PRINT_LEDGER,C.USERNAME,C.MAJOR_USER_CODE,C.USER_ALIAS,C.DISCOUNT_PERCENTAGE_LEVEL,C.VIEW_DATA_AFTER_DFM,D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,D.ROW_ID  
  ,D.PARA3_CODE,D.SRNO,D.PRINT_LABEL,D.PARA4_CODE,D.PARA5_CODE,D.PARA6_CODE,D.WSP_PERCENTAGE,D.ADJ_QUANTITY,D.INVOICE_QUANTITY,D.SCHEME_QUANTITY,P1.PARA1_ORDER  
  ,P1.PARA1_SET,P2.PARA2_ORDER,P2.PARA2_SET,P3.DT_CREATED,E.CODING_SCHEME,E.UOM_CODE,E.SKU_CODE,E.ARTICLE_NAME,E.ARTICLE_DESC,E.SUB_SECTION_CODE,E.DISCON,SKU.FIX_MRP AS MIN_PRICE  
  ,E.STOCK_NA,E.ARTICLE_TYPE,E.CREATED_ON,E.ARTICLE_GROUP_CODE,E.GENERATE_BARCODES_WITHARTICLE_PREFIX,E.ARTICLE_GEN_MODE,E.ARTICLE_PRD_MODE,E.ARTICLE_SET_CODE,E.OH_PERCENTAGE  
  ,E.OH_AMOUNT,U.UOM_TYPE,CMP.WORKABLE,CMP.PIN,CMP.LOGO_PATH,CMP.WEB_ADDRESS,CMP.SSPL_FIRST_HDSR,CMP.POLICY_NO,CMP.PAN_NO AS COMPANY_PAN_NO,CMP.EMAIL_ID AS COMPANY_EMAIL_ID  
  ,CMP.COUNTRY AS COMPANY_COUNTRY,CMP.MOBILE AS COMPANY_MOBILE,CMP.CONTACT_NAME AS COMPANY_CONTACT_NAME,CMP.TDS_AC_NO AS COMPANY_TDS_AC_NO,CMP.COMPANY_NAME
  ,CMP.ALIAS AS COMPANY_ALIAS,CMP.ADDRESS1 AS COMPANY_ADDRESS1,CMP.ADDRESS2 AS COMPANY_ADDRESS2,CMP.PHONES_FAX AS COMPANY_PHONES_FAX,CMP.CST_NO AS COMPANY_CST_NO,CMP.CST_DT AS COMPANY_CST_DT  
  ,CMP.SST_NO AS COMPANY_SST_NO,CMP.SST_DT AS COMPANY_SST_DT,CMP.PIN AS COMPANY_PIN,CMP.TIN_NO AS COMPANY_TIN,CMP.GST_NO AS COMPANY_GST_NO,CMP.CIN AS COMPANY_CIN  
  ,CMP.WEB_ADDRESS AS COMPANY_WEB_ADDRESS,CMP.GRP_CODE AS COMPANY_GRP_CODE,CMP.ADDRESS9 AS COMPANY_ADDRESS9,CA.AREA_NAME AS COMPANY_AREA,CMP.CITY AS COMPANY_CITY
  ,CS.[STATE] AS COMPANY_STATE,CRG.REGION_NAME AS COMPANY_REGION,LCT.DEPT_ID AS LOCATION_DEPT_ID,LCT.DEPT_NAME AS LOCATION_DEPT_NAME
  ,LA.PINCODE as LOCATION_PINCODE ,LCT.LOC_GST_NO as LOCATION_GST_NO,LCT.MAJOR_DEPT_ID AS LOCATION_MAJOR_DEPT_ID,LCT.AREA_CODE AS LOCATION_AREA_CODE  
  ,LCT.PRIMARY_EMAIL AS LOCATION_PRIMARY_EMAIL,LCT.PRIMARY_EMAIL_SMTP AS LOCATION_PRIMARY_EMAIL_SMTP,LCT.PRIMARY_EMAIL_PWD AS LOCATION_PRIMARY_EMAIL_PWD
  ,LCT.PRIMARY_EMAIL_SSL AS LOCATION_PRIMARY_EMAIL_SSL  
  ,LCT.SSPL_GRP_CODE AS LOCATION_SSPL_GRP_CODE,LCT.PUR_LOC AS LOCATION_PUR_LOC,LCT.ADDRESS1 AS LOCATION_ADDRESS1,LCT.ADDRESS2 AS LOCATION_ADDRESS2,LCT.DEPT_AC_CODE AS LOCATION_DEPT_AC_CODE  
  ,LCT.CST_NO AS LOCATION_CST_NO,LCT.CST_DT AS LOCATION_CST_DT,LCT.LST_NO AS LOCATION_LST_NO,LCT.LST_DT AS LOCATION_LST_DT,LCT.DEPT_ALIAS AS LOCATION_DEPT_ALIAS,LCT.PHONE AS LOCATION_PHONE  
  ,LCT.DATE_OF_OPENING AS LOCATION_DATE_OF_OPENING,LCT.REPORT_BLOCKED AS LOCATION_REPORT_BLOCKED,LCT.INACTIVE AS LOCATION_INACTIVE,LCT.LOC_TYPE AS LOCATION_LOC_TYPE,LCT.ACCOUNTS_POSTING_DEPT_ID AS LOCATION_ACCOUNTS_POSTING_DEPT_ID,LCT.CONTROL_AC_CODE AS LOCATION_CONTROL_AC_CODE,LCT.UPD_PURINFO AS LOCATION_UPD_PURINFO,LCT.SSPL_REG_KEY AS LOCATION_SSPL_REG_KEY,LCT.WIZCOM_ENABLED AS LOCATION_WIZCOM_ENABLED  
  ,LCT.EXCISABLE AS LOCATION_EXCISABLE,LCT.TIN_NO AS LOCATION_TIN_NO,LCT.FR_TYPE AS LOCATION_FR_TYPE,LCT.PRIMARY_EMAIL_PORT AS LOCATION_PRIMARY_EMAIL_PORT,LA.AREA_NAME AS LOCATION_AREA  
  ,LC.CITY AS LOCATION_CITY  
  ,LS.[STATE] AS LOCATION_STATE,LRG.REGION_NAME AS LOCATION_REGION,HD.HEAD_NAME,HD.MAJOR_HEAD_CODE,HD.PHYSICAL,HD.PRINT_HEAD,HD.CREDITOR_DEBTOR_CODE,SD.SECTION_CODE,SD.SUB_SECTION_NAME,SD.MFG_CATEGORY  
  ,SM.SECTION_NAME,SKU.PRODUCT_NAME,D.GROSS_PURCHASE_PRICE,ISNULL(D.MD_PERCENTAGE ,0) AS MD_PERCENTAGE,D.FIX_MRP,D.SLS_QTY,D.CBS_QTY,TLOC.ADDRESS1 TARGETLOCADDRESS1,TLOC.ADDRESS2 TARGETLOCADDRESS2,TLOC.LOC_GST_NO TARGETLOC_GST_NO  
  ,(CASE WHEN ISNULL(D.MBQ_QTY,0) = 0 THEN ISNULL(MBQ.MBQ,0) ELSE ISNULL(D.MBQ_QTY,0) END) AS MBQ_QTY,F.FORM_NAME AS MST_FORM_NAME,A.PO_FOR_DEPT_ID AS TARGETLOC,TLOC.DEPT_NAME TARGETLOCNAME  
  ,TLA.AREA_NAME AS TARGETLOC_AREA,TLC.CITY AS TARGETLOC_CITY,TLS.[STATE] AS TARGETLOC_STATE,TLA.PINCODE AS TARGETLOC_PIN
  ,LCT.LOC_GST_NO,D.GST_PERCENTAGE,D.HSN_CODE,D.IGST_AMOUNT,D.CGST_AMOUNT,D.SGST_AMOUNT,D.XN_VALUE_WITHOUT_GST
  ,D.XN_VALUE_WITH_GST,D.DELIVERY_DT,LCT.LOC_GST_DT AS LOCATION_GST_DT
   ,AT1.attr1_key_name,AT2.attr2_key_name,AT3.attr3_key_name,AT4.attr4_key_name,AT5.attr5_key_name,AT6.attr6_key_name,
   AT7.attr7_key_name,AT8.attr8_key_name,AT9.attr9_key_name,AT10.attr10_key_name,AT11.attr11_key_name,AT12.attr12_key_name,
   AT13.attr13_key_name,AT14.attr14_key_name,AT15.attr15_key_name,AT16.attr16_key_name,AT17.attr17_key_name,AT18.attr18_key_name,
   AT19.attr19_key_name,AT20.attr20_key_name,AT21.attr21_key_name,AT22.attr22_key_name,AT23.attr23_key_name,AT24.attr24_key_name,
	AT25.attr25_key_name  
  INTO #VW_PO_QBF
  FROM POM01106 A (NOLOCK)  
  JOIN LMV01106 B (NOLOCK) ON A.AC_CODE = B.AC_CODE  
  JOIN USERS C (NOLOCK) ON A.USER_CODE = C.USER_CODE  
  JOIN POD01106 D (NOLOCK) ON A.PO_ID = D.PO_ID  
  JOIN PARA1 P1 (NOLOCK) ON D.PARA1_CODE = P1.PARA1_CODE  
  JOIN PARA2 P2 (NOLOCK) ON D.PARA2_CODE = P2.PARA2_CODE  
  JOIN PARA3 P3 (NOLOCK) ON D.PARA3_CODE = P3.PARA3_CODE  
  JOIN PARA4 P4 (NOLOCK) ON D.PARA4_CODE = P4.PARA4_CODE  
  JOIN PARA5 P5 (NOLOCK) ON D.PARA5_CODE = P5.PARA5_CODE  
  JOIN PARA6 P6 (NOLOCK) ON D.PARA6_CODE = P6.PARA6_CODE  
  JOIN ARTICLE E (NOLOCK) ON D.ARTICLE_CODE = E.ARTICLE_CODE  
LEFT OUTER JOIN ARTICLE_FIX_ATTR ATTR  (NOLOCK) ON E.ARTICLE_CODE = ATTR.ARTICLE_CODE 
LEFT OUTER JOIN ATTR1_MST AT1 (NOLOCK) ON AT1.ATTR1_KEY_CODE=ATTR.ATTR1_KEY_CODE
LEFT OUTER JOIN ATTR2_MST AT2 (NOLOCK) ON AT2.ATTR2_KEY_CODE=ATTR.ATTR2_KEY_CODE
LEFT OUTER JOIN ATTR3_MST AT3 (NOLOCK) ON AT3.ATTR3_KEY_CODE=ATTR.ATTR3_KEY_CODE
LEFT OUTER JOIN ATTR4_MST AT4 (NOLOCK) ON AT4.ATTR4_KEY_CODE=ATTR.ATTR4_KEY_CODE
LEFT OUTER JOIN ATTR5_MST AT5 (NOLOCK) ON AT5.ATTR5_KEY_CODE=ATTR.ATTR5_KEY_CODE
LEFT OUTER JOIN ATTR6_MST AT6 (NOLOCK) ON AT6.ATTR6_KEY_CODE=ATTR.ATTR6_KEY_CODE
LEFT OUTER JOIN ATTR7_MST AT7 (NOLOCK) ON AT7.ATTR7_KEY_CODE=ATTR.ATTR7_KEY_CODE
LEFT OUTER JOIN ATTR8_MST AT8 (NOLOCK) ON AT8.ATTR8_KEY_CODE=ATTR.ATTR8_KEY_CODE
LEFT OUTER JOIN ATTR9_MST AT9 (NOLOCK) ON AT9.ATTR9_KEY_CODE=ATTR.ATTR9_KEY_CODE
LEFT OUTER JOIN ATTR10_MST AT10 (NOLOCK) ON AT10.ATTR10_KEY_CODE=ATTR.ATTR10_KEY_CODE
LEFT OUTER JOIN ATTR11_MST AT11 (NOLOCK) ON AT11.ATTR11_KEY_CODE=ATTR.ATTR11_KEY_CODE
LEFT OUTER JOIN ATTR12_MST AT12 (NOLOCK) ON AT12.ATTR12_KEY_CODE=ATTR.ATTR12_KEY_CODE
LEFT OUTER JOIN ATTR13_MST AT13 (NOLOCK) ON AT13.ATTR13_KEY_CODE=ATTR.ATTR13_KEY_CODE
LEFT OUTER JOIN ATTR14_MST AT14 (NOLOCK) ON AT14.ATTR14_KEY_CODE=ATTR.ATTR14_KEY_CODE
LEFT OUTER JOIN ATTR15_MST AT15 (NOLOCK) ON AT15.ATTR15_KEY_CODE=ATTR.ATTR15_KEY_CODE
LEFT OUTER JOIN ATTR16_MST AT16 (NOLOCK) ON AT16.ATTR16_KEY_CODE=ATTR.ATTR16_KEY_CODE
LEFT OUTER JOIN ATTR17_MST AT17 (NOLOCK) ON AT17.ATTR17_KEY_CODE=ATTR.ATTR17_KEY_CODE
LEFT OUTER JOIN ATTR18_MST AT18 (NOLOCK) ON AT18.ATTR18_KEY_CODE=ATTR.ATTR18_KEY_CODE
LEFT OUTER JOIN ATTR19_MST AT19 (NOLOCK) ON AT19.ATTR19_KEY_CODE=ATTR.ATTR19_KEY_CODE
LEFT OUTER JOIN ATTR20_MST AT20 (NOLOCK) ON AT20.ATTR20_KEY_CODE=ATTR.ATTR20_KEY_CODE
LEFT OUTER JOIN ATTR21_MST AT21 (NOLOCK) ON AT21.ATTR21_KEY_CODE=ATTR.ATTR21_KEY_CODE
LEFT OUTER JOIN ATTR22_MST AT22 (NOLOCK) ON AT22.ATTR22_KEY_CODE=ATTR.ATTR22_KEY_CODE
LEFT OUTER JOIN ATTR23_MST AT23 (NOLOCK) ON AT23.ATTR23_KEY_CODE=ATTR.ATTR23_KEY_CODE
LEFT OUTER JOIN ATTR24_MST AT24 (NOLOCK) ON AT24.ATTR24_KEY_CODE=ATTR.ATTR24_KEY_CODE
LEFT OUTER JOIN ATTR25_MST AT25(NOLOCK) ON AT25.ATTR25_KEY_CODE=ATTR.ATTR25_KEY_CODE  JOIN UOM U (NOLOCK) ON E.UOM_CODE = U.UOM_CODE  
  LEFT OUTER JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE = D.PRODUCT_CODE  
  JOIN COMPANY CMP (NOLOCK) ON A.COMPANY_CODE=CMP.COMPANY_CODE  
  JOIN AREA CA (NOLOCK) ON CMP.AREA_CODE=CA.AREA_CODE  
  JOIN CITY CC (NOLOCK) ON CA.CITY_CODE=CC.CITY_CODE  
  JOIN [STATE] CS (NOLOCK) ON CC.CITY_CODE=CS.STATE_CODE  
  JOIN REGIONM CRG (NOLOCK) ON CS.REGION_CODE=CRG.REGION_CODE  
  JOIN LOCATION LCT (NOLOCK) ON A.DEPT_ID=LCT.DEPT_ID  
  JOIN AREA LA (NOLOCK) ON LCT.AREA_CODE=LA.AREA_CODE  
  JOIN CITY LC (NOLOCK) ON LA.CITY_CODE=LC.CITY_CODE  
  JOIN [STATE] LS (NOLOCK) ON LC.STATE_CODE=LS.STATE_CODE  
  JOIN REGIONM LRG (NOLOCK) ON LS.REGION_CODE=LRG.REGION_CODE  
  JOIN HD01106 HD (NOLOCK) ON B.HEAD_CODE=HD.HEAD_CODE  
  JOIN SECTIOND SD (NOLOCK) ON E.SUB_SECTION_CODE=SD.SUB_SECTION_CODE  
  JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE=SM.SECTION_CODE  
  LEFT JOIN FORM F (NOLOCK) ON F.FORM_ID = D.FORM_ID  
  LEFT JOIN MBQ_DET MBQ ON MBQ.PRODUCT_CODE = D.PRODUCT_CODE  
  AND MBQ.MONTH=DATEPART(MONTH ,A.PO_DT) AND MBQ.YEAR= DATEPART(YEAR ,A.PO_DT)  
  AND MBQ.DEPT_ID = A.location_Code 
  LEFT OUTER JOIN LOCATION TLOC (NOLOCK)  
  JOIN AREA TLA (NOLOCK) ON TLOC.AREA_CODE=TLA.AREA_CODE  
  JOIN CITY TLC (NOLOCK) ON TLA.CITY_CODE=TLC.CITY_CODE  
  JOIN [STATE] TLS (NOLOCK) ON TLC.STATE_CODE=TLS.STATE_CODE ON TLOC.DEPT_ID=A.PO_FOR_DEPT_ID
  WHERE A.PO_ID=@PO_ID

  UPDATE #VW_PO_QBF SET QUANTITY=0 WHERE QUANTITY IS NULL  
  UPDATE #VW_PO_QBF SET INVOICE_QUANTITY=0 WHERE INVOICE_QUANTITY IS NULL
  UPDATE #VW_PO_QBF SET IGST_AMOUNT=0 WHERE IGST_AMOUNT IS NULL
  UPDATE #VW_PO_QBF SET CGST_AMOUNT=0 WHERE CGST_AMOUNT IS NULL
  UPDATE #VW_PO_QBF SET SGST_AMOUNT=0 WHERE SGST_AMOUNT IS NULL
  UPDATE #VW_PO_QBF SET XN_VALUE_WITHOUT_GST=0 WHERE XN_VALUE_WITHOUT_GST IS NULL
  UPDATE #VW_PO_QBF SET XN_VALUE_WITH_GST=0 WHERE XN_VALUE_WITH_GST IS NULL
  
  SELECT * FROM #VW_PO_QBF
  
  SELECT HSN_CODE,SUM(QUANTITY)QUANTITY,SUM(INVOICE_QUANTITY)INVOICE_QUANTITY
  ,SUM(IGST_AMOUNT)IGST_AMOUNT,SUM(CGST_AMOUNT)CGST_AMOUNT,SUM(SGST_AMOUNT)SGST_AMOUNT,SUM(XN_VALUE_WITHOUT_GST)XN_VALUE_WITHOUT_GST,SUM(XN_VALUE_WITH_GST)XN_VALUE_WITH_GST
  FROM #VW_PO_QBF GROUP BY HSN_CODE
  SET NOCOUNT OFF
END
