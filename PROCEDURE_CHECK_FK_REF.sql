CREATE PROCEDURE CHECK_FK_REF
(  
	@CTABLENAME VARCHAR(50),   
	@CCOLNAME VARCHAR(50) = '',   
	@CVALUE VARCHAR(50) = ''
)  
--WITH ENCRYPTION
AS  
BEGIN  
	DECLARE @CCHILDTABLE VARCHAR(50), @CCHILDCOL VARCHAR(50), @LVALUEFOUND BIT, @CCMD NVARCHAR(2000)
	
	DECLARE @OUTCURSOR TABLE ( CHILDTABLENAME VARCHAR(50), CHILDCOLNAME VARCHAR(50) )
	
	DECLARE FKREF CURSOR FOR
	   SELECT C.NAME AS CHILDTABLENAME,E.NAME AS CHILDCOLNAME
	   FROM SYSREFERENCES A    
	   JOIN SYSOBJECTS B ON A.CONSTID = B.ID     
	   JOIN SYSOBJECTS C ON A.FKEYID = C.ID    
	   JOIN SYSOBJECTS D ON A.RKEYID = D.ID    
	   JOIN SYSCOLUMNS E ON A.FKEY1 = E.COLID AND A.FKEYID = E.ID    
	   JOIN SYSCOLUMNS F ON A.RKEY1 = F.COLID AND A.RKEYID = F.ID    
	   WHERE D.NAME=@CTABLENAME
	
	OPEN FKREF
	FETCH NEXT FROM FKREF INTO @CCHILDTABLE, @CCHILDCOL
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @LVALUEFOUND = 0
	
		SET @CCMD = N'IF EXISTS ( SELECT ' + @CCHILDCOL + N' FROM ' + @CCHILDTABLE + 
					N' WHERE ' + @CCHILDCOL + ' = ''' + @CVALUE + ''') 
				    SET @LVALUEFOUND = 1'
	--	PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD, N'@LVALUEFOUND BIT OUTPUT', @LVALUEFOUND OUTPUT
	
		IF @LVALUEFOUND = 1
			INSERT @OUTCURSOR VALUES ( @CCHILDTABLE, @CCHILDCOL )
	
		FETCH NEXT FROM FKREF INTO @CCHILDTABLE, @CCHILDCOL
	END
	CLOSE FKREF
	DEALLOCATE FKREF
	
	SELECT * FROM @OUTCURSOR
END
