CREATE PROCEDURE SPPPC_RM_PRINT
(
 @CMEMO_ID VARCHAR(100)=''
)
AS
BEGIN
    
    IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL
       DROP TABLE #TMPISSUE
	SELECT CAST(0 AS BIT) AS CHK,
	       B.MEMO_NO,B.MEMO_DT AS MEMO_DT,B.CANCELLED ,
	       C.PRODUCT_CODE ,
	       SUM(A.QUANTITY) AS ISSUE_QTY,
	       ART.ARTICLE_CODE ,ART.ARTICLE_NO,
	       P1.PARA1_CODE,P1.PARA1_NAME ,
	       P2.PARA2_CODE,P2.PARA2_NAME ,
	       P3.PARA3_CODE,P3.PARA3_NAME,
	       SD.SUB_SECTION_CODE,
	       SM.SECTION_CODE ,
	       PMT.BAL_QTY AS BAL_QTY
	INTO #TMPISSUE
	FROM PPC_AGENCY_ISSUE_MATERIAL_DET A
	JOIN PPC_AGENCY_ISSUE_MATERIAL_MST  B ON A.MEMO_ID =B.MEMO_ID 
	JOIN PPC_SKU  C ON A.PRODUCT_UID=C.PRODUCT_UID
	JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE 
	JOIN
	(
	 SELECT PRODUCT_CODE,SUM(QUANTITY_IN_STOCK) AS BAL_QTY
	 FROM PPC_PMT 
	 GROUP BY PRODUCT_CODE
	) PMT ON PMT.PRODUCT_CODE=C.PRODUCT_CODE
	JOIN SECTIOND SD ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE
	JOIN SECTIONM SM ON SD.SECTION_CODE =SM.SECTION_CODE 
	JOIN PARA1 P1 ON P1.PARA1_CODE =C.PARA1_CODE 
	JOIN PARA2 P2 ON P2.PARA2_CODE =C.PARA2_CODE 
	JOIN PARA3 P3 ON P3.PARA3_CODE =C.PARA3_CODE 
	WHERE  B.MEMO_ID  =@CMEMO_ID AND CANCELLED=0
	AND BAL_QTY>0
	GROUP BY  B.MEMO_NO,B.MEMO_DT ,B.CANCELLED ,
	C.PRODUCT_CODE ,ART.ARTICLE_CODE ,ART.ARTICLE_NO,
	P1.PARA1_CODE,P1.PARA1_NAME ,P2.PARA2_CODE,P2.PARA2_NAME ,
	P3.PARA3_CODE,P3.PARA3_NAME,SD.SUB_SECTION_CODE,SM.SECTION_CODE ,
	PMT.BAL_QTY
	
	
	SELECT CHK,
	       MEMO_NO,MEMO_DT AS MEMO_DT,CANCELLED ,
	       PRODUCT_CODE ,
	       ISSUE_QTY,
	       ARTICLE_CODE ,ARTICLE_NO,
	       PARA1_CODE,PARA1_NAME ,
	       PARA2_CODE,PARA2_NAME ,
	       PARA3_CODE,PARA3_NAME,
	       SUB_SECTION_CODE,
	       SECTION_CODE ,
	       LBL_TYPE='ISSUE',
	       ISSUE_QTY AS BAL_QTY
	FROM #TMPISSUE
	UNION ALL
	SELECT CHK,
	       MEMO_NO,MEMO_DT AS MEMO_DT,CANCELLED ,
	       PRODUCT_CODE ,
	       BAL_QTY AS ISSUE_QTY,
	       ARTICLE_CODE ,ARTICLE_NO,
	       PARA1_CODE,PARA1_NAME ,
	       PARA2_CODE,PARA2_NAME ,
	       PARA3_CODE,PARA3_NAME,
	       SUB_SECTION_CODE,
	       SECTION_CODE ,
	       LBL_TYPE='BAL',
	       BAL_QTY AS BAL_QTY 
	 FROM #TMPISSUE
	 WHERE BAL_QTY>0
	 ORDER BY PRODUCT_CODE,ISSUE_QTY
	
	
	

END
