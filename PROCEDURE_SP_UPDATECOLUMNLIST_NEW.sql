CREATE PROCEDURE SP_UPDATECOLUMNLIST_NEW 
				@CSOURCETABLENAME VARCHAR(50),
				@CKEYFIELD1 VARCHAR(40),
				@CKEYFIELD2 VARCHAR(40)='',
				@CKEYFIELD3 VARCHAR(40)='',
				@NMODE INT = 1,
				@CRETFIELDS NVARCHAR(MAX) OUTPUT
--WITH ENCRYPTION				

AS
BEGIN
	DECLARE @CCOLNAME VARCHAR(50), 
			@CCOLTYPE VARCHAR(50),
			@CCOLVALUE VARCHAR(100),
			@CCMD NVARCHAR(1000),
			@CTARGETCOLNAME VARCHAR(50), 
			@CISNULLVALUE VARCHAR(10),
			@LEXCLUSIONS BIT,@BISNULLABLE BIT,@CDEFAULTVALUE VARCHAR(100),
			@CLEFTSTR VARCHAR(20),@CRIGHTSTR VARCHAR(20),@NSOURCECOLWIDTH INT,@NTARGETCOLWIDTH INT
	

	
	SET @CRETFIELDS = N''
	SET @LEXCLUSIONS = 0

	IF EXISTS ( SELECT NAME FROM SYSOBJECTS WHERE NAME = '__EXCLUSIONS' )
	BEGIN	
		IF EXISTS ( SELECT TABLE_NAME FROM __EXCLUSIONS WHERE TABLE_NAME = @CSOURCETABLENAME )
		SET @LEXCLUSIONS = 1
	END
	
	IF CURSOR_STATUS('GLOBAL','TARGETCUR') IN (0,1)
	BEGIN
		CLOSE TARGETCUR
		DEALLOCATE TARGETCUR
	END

	DECLARE TARGETCUR CURSOR FOR 
	SELECT COLNAME, COLTYPE,ISNULLABLE,SOURCE_COLWIDTH,TARGET_COLWIDTH FROM #TTARGETCOL
			
	OPEN TARGETCUR
	FETCH NEXT FROM TARGETCUR INTO @CCOLNAME, @CCOLTYPE,@BISNULLABLE,@NSOURCECOLWIDTH,@NTARGETCOLWIDTH
	WHILE @@FETCH_STATUS = 0
	BEGIN
		
		IF @CCOLTYPE IN ( 'INT', 'SMALLINT', 'NUMERIC', 'BIT','TINYINT' )
			SET @CISNULLVALUE = '0'
		ELSE 
			SET @CISNULLVALUE = ''''''
		
		IF NOT EXISTS (SELECT COLNAME FROM #TCONSTRAINTSCOL WHERE COLNAME=@CCOLNAME) AND
		 @CCOLTYPE IN('VARCHAR','CHAR','NVARCHAR') AND @NSOURCECOLWIDTH<>@NTARGETCOLWIDTH
			SELECT @CLEFTSTR = 'LEFT(',@CRIGHTSTR=','+LTRIM(RTRIM(STR(@NTARGETCOLWIDTH)))+')'
		ELSE
			SELECT @CLEFTSTR = '',@CRIGHTSTR=''	
		
		IF @CCOLNAME NOT IN ( @CKEYFIELD1, @CKEYFIELD2, @CKEYFIELD3 ) -- AND @CTARGETCOLNAME=@CCOLNAME
		BEGIN
			IF @LEXCLUSIONS=1 
				SELECT @CDEFAULTVALUE = DEFAULT_VALUE FROM __EXCLUSIONS 
				WHERE TABLE_NAME = @CSOURCETABLENAME
				AND COLUMN_NAME = @CCOLNAME


			IF @CDEFAULTVALUE IS NULL
				SET @CCOLVALUE = (CASE WHEN @BISNULLABLE=1 THEN @CLEFTSTR+'B.'+@CCOLNAME+@CRIGHTSTR ELSE 
								' ISNULL( '+@CLEFTSTR+'B.' + @CCOLNAME +@CRIGHTSTR+', ' + @CISNULLVALUE + ')' END)
			ELSE
			BEGIN
				IF @CCOLTYPE IN ( 'INT', 'SMALLINT', 'NUMERIC', 'BIT','TINYINT' )
					SET @CCOLVALUE = @CDEFAULTVALUE
				ELSE 
					SET @CCOLVALUE = '''' + @CDEFAULTVALUE + ''''
			END

			IF @NMODE = 1
				SET @CRETFIELDS = @CRETFIELDS + ( CASE WHEN @CRETFIELDS<>'' THEN ', ' + CHAR(13) ELSE '' END )  +  
								  @CCOLNAME + ' = ' + @CCOLVALUE
			ELSE
				SET @CRETFIELDS = @CRETFIELDS + ( CASE WHEN @CRETFIELDS<>'' THEN ' AND ' + CHAR(13) ELSE '' END )  +  
								  'A.'+@CCOLNAME + ' <> ' + @CCOLVALUE
			
			IF @LEXCLUSIONS = 1
				SET @CDEFAULTVALUE = NULL

		END
		
		FETCH NEXT FROM TARGETCUR INTO @CCOLNAME, @CCOLTYPE ,@BISNULLABLE,@NSOURCECOLWIDTH,@NTARGETCOLWIDTH
	END

	CLOSE TARGETCUR
	DEALLOCATE TARGETCUR

	IF @NMODE = 2 AND @CRETFIELDS <> ''
		SET @CRETFIELDS = ' WHERE ' + @CRETFIELDS

END
