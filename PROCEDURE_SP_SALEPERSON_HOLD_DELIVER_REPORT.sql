CREATE PROCEDURE SP_SALEPERSON_HOLD_DELIVER_REPORT--(LocId 3 digit change by Sanjay:30-10-2024)
(
	@CEMPCODE CHAR(7)='',
	@DT_FILTER INT,--1 FOR FILTER ON HOLD MEMO DATE 2 FOR FILTER ON DELIVER_DT 
	@DFROMDT DATETIME,
	@DTODT DATETIME,        
	@NMODE INT=0,  --0 FOR SUMMARY 1 FOR DETAILS
	@NPENDING NUMERIC=0 ,--0 FOR ALL 1 FOR PENDING -- 2 FOR DELIVER
	@CDEPTID VARCHAR(5)=''
)
----WITH ENCRYPTION
AS
BEGIN
     
   IF OBJECT_ID('TEMPDB..#TMPHOLD','U') IS NOT NULL
       DROP TABLE #TMPHOLD
    
    SELECT DISTINCT  CMM.CM_ID ,cmm.location_Code
    INTO #TMPHOLD
	FROM CMM01106 CMM
	JOIN CMD01106 CMD ON CMM.CM_ID =CMD.CM_ID 
	JOIN 
	(
	  SELECT ROW_ID, REF_CMD_ROW_ID,MEMO_NO AS DELIVERY_SLIP_NO,MEMO_DT AS DELIVERY_DT,1 AS HOLD_QUANTITY  
	  FROM HOLD_BACK_DELIVER_MST M
	  JOIN HOLD_BACK_DELIVER_DET D ON M.MEMO_ID =D.MEMO_ID 
	  WHERE M.CANCELLED =0 --AND DELIVERED =0
	) HLD ON ISNULL(HLD.REF_CMD_ROW_ID,'')=ISNULL(CMD.ROW_ID,'') 
    WHERE (@DT_FILTER=0 OR @DT_FILTER=2 OR  ISNULL(DELIVERY_DT,'') BETWEEN @DFROMDT AND @DTODT)
    
    IF @CDEPTID!='' DELETE #TMPHOLD WHERE location_code<>@CDEPTID--19 FEB 2019
    
	IF OBJECT_ID ('TEMPDB..#TEMPSLSDATA','U') IS NOT NULL
	   DROP TABLE #TEMPSLSDATA
	   
	SELECT A.CM_ID, A.CM_DT,A.CM_NO,B.PRODUCT_CODE,CONVERT(NUMERIC(18,2),B.QUANTITY) AS SLS_QUANTITY,B.MRP, 
	       CONVERT(NUMERIC(18,2),(B.MRP*B.QUANTITY)) AS AMOUNT,A.CUSTOMER_CODE ,ROW_ID,
	       (CASE WHEN EMP_CODE<>'0000000' THEN EMP_CODE WHEN EMP_CODE1<>'0000000'
	THEN EMP_CODE1 ELSE EMP_CODE2 END) AS EMP_CODE	
	INTO #TEMPSLSDATA
	FROM #TMPHOLD T
	JOIN  CMM01106 A  ON A.CM_ID =T.CM_ID 
	JOIN CMD01106 B ON A.CM_ID =B.CM_ID 
	WHERE A.CANCELLED =0 
	AND (@CEMPCODE='' OR @CEMPCODE =(CASE WHEN EMP_CODE<>'0000000' THEN EMP_CODE WHEN EMP_CODE1<>'0000000'
	THEN EMP_CODE1 ELSE EMP_CODE2 END) )
	
	IF OBJECT_ID ('TEMPDB..#TEMPHOLDDATA','U') IS NOT NULL
	   DROP TABLE #TEMPHOLDDATA
	
	SELECT T.CM_ID, T.CM_DT,T.CM_NO,T.PRODUCT_CODE,T.SLS_QUANTITY,T.AMOUNT,T.CUSTOMER_CODE,
	       ISNULL(DELIVERY_SLIP_NO,'') AS DELIVERY_SLIP_NO,DELIVERY_DT,CONVERT(NUMERIC(18,2),HOLD_QUANTITY) AS HOLD_QUANTITY,
	       CONVERT(NUMERIC(18,2),ISNULL(HOLD_QUANTITY,0)*(T.MRP)) AS HOLD_AMT,
	       MRP ,HLD.ROW_ID ,EMP_CODE,CASE WHEN ISNULL(DELIVERED,0)=0 THEN '' ELSE 'Y' END AS DEL 
	INTO #TEMPHOLDDATA       
	FROM #TEMPSLSDATA T
	LEFT  JOIN 
	(
	  SELECT ROW_ID, REF_CMD_ROW_ID, MEMO_NO AS DELIVERY_SLIP_NO,MEMO_DT AS DELIVERY_DT,1 AS HOLD_QUANTITY,DELIVERED   
	  FROM HOLD_BACK_DELIVER_MST M
	  JOIN HOLD_BACK_DELIVER_DET D ON M.MEMO_ID =D.MEMO_ID 
	  WHERE M.CANCELLED =0 --AND DELIVERED =0
	
	) HLD ON ISNULL(HLD.REF_CMD_ROW_ID,'')=ISNULL(T.ROW_ID,'') 
	WHERE (@DT_FILTER=0 OR @DT_FILTER=2 OR  ISNULL(DELIVERY_DT,'') BETWEEN @DFROMDT AND @DTODT)
	
    
    IF OBJECT_ID ('TEMPDB..#TEMPDELIVERDATA','U') IS NOT NULL
	   DROP TABLE #TEMPDELIVERDATA
	
	SELECT T.CM_ID, T.CM_DT,T.CM_NO,T.PRODUCT_CODE,T.SLS_QUANTITY,T.AMOUNT,T.CUSTOMER_CODE, 
	       DELIVERY_SLIP_NO,DELIVERY_DT,HOLD_QUANTITY,HOLD_AMT,
	       DELIVER_DT =DEL.MEMO_DT ,DEL.DELIVER_QUANTITY,ISNULL(DELIVER_QUANTITY,0)*MRP AS DELIVER_AMT,
	       CAST(ISNULL(DEL.MEMO_NO,'') AS VARCHAR(100)) AS DELIVER_NO,EMP_CODE,DEL 
	INTO #TEMPDELIVERDATA
	FROM #TEMPHOLDDATA T
	LEFT JOIN
	(
       SELECT REF_HBD_ROW_ID , A.MEMO_DT,1 AS DELIVER_QUANTITY,MEMO_NO 
       FROM SLS_DELIVERY_MST A
       JOIN SLS_DELIVERY_DET B ON A.MEMO_ID =B.MEMO_ID 
       WHERE A.CANCELLED =0 
	) DEL ON ISNULL(DEL.REF_HBD_ROW_ID,'')=ISNULL(T.ROW_ID,'') 
	
	
	
	UPDATE #TEMPDELIVERDATA SET DELIVER_QUANTITY=HOLD_QUANTITY,DELIVER_AMT=HOLD_AMT,DELIVER_NO=DELIVERY_SLIP_NO,DELIVER_DT =DELIVERY_DT  WHERE DEL='Y'
	UPDATE #TEMPDELIVERDATA SET DELIVERY_SLIP_NO='',DELIVERY_DT=NULL,HOLD_QUANTITY=0,HOLD_AMT =0  WHERE DEL='Y'
	
	
	
	IF ISNULL(@NMODE ,0)=0
	BEGIN
	   
	    DECLARE @DTSQL NVARCHAR(MAX)
	    DECLARE @FILTER NVARCHAR(MAX)
	    
	    SET @FILTER='(CASE WHEN ISNULL(DELIVERY_DT,'') BETWEEN @DFROMDT AND @DTODT)'
	    
	      IF OBJECT_ID ('TEMPDB..#TEMPSUMMARY','U') IS NOT NULL
	          DROP TABLE #TEMPSUMMARY
	          
	           SELECT CONVERT(VARCHAR,T.CM_DT,105) AS CM_DT,T.CM_NO,
	           CASE WHEN ROW_NUMBER () OVER (PARTITION BY CM_NO ORDER BY CM_NO)=1 THEN T1.SLS_QUANTITY ELSE 0 END AS SLS_QUANTITY,
	           CASE WHEN ROW_NUMBER () OVER (PARTITION BY CM_NO ORDER BY CM_NO)=1 THEN T1.AMOUNT ELSE 0 END AS AMOUNT,
	           C.USER_CUSTOMER_CODE AS CUSTOMER_CODE,
	           ISNULL(C.CUSTOMER_FNAME,'')+' '+ ISNULL(C.CUSTOMER_LNAME,'')+ CASE WHEN ISNULL(C.MOBILE,'')<>'' THEN '- ' +MOBILE ELSE '' END AS CUSTOMER_NAME,
	           DELIVERY_SLIP_NO,ISNULL(CONVERT(VARCHAR,DELIVERY_DT,105),'') AS DELIVERY_DT,
	           SUM(ISNULL(HOLD_QUANTITY,0)) AS HOLD_QUANTITY,SUM(ISNULL(HOLD_AMT,0)) AS HOLD_AMT,
	           ISNULL(CONVERT(VARCHAR,DELIVER_DT,105),'') AS  DELIVER_DT,DELIVER_DT AS DEL_DT,
	           CONVERT(NUMERIC(18,2),SUM(ISNULL(T.DELIVER_QUANTITY,0))) AS DELIVER_QUANTITY,SUM(ISNULL(DELIVER_AMT,0)) AS DELIVER_AMT,
	           DELIVER_NO,T.EMP_CODE ,CASE WHEN EMP_NAME='' THEN 'MISC' ELSE EMP_NAME END AS EMP_NAME,
	           PENDING_QTY=CASE WHEN SUM(ISNULL(HOLD_QUANTITY,0))>0 THEN CONVERT(NUMERIC(18,2),SUM(ISNULL(HOLD_QUANTITY,0))-SUM(ISNULL(T.DELIVER_QUANTITY,0))) ELSE 0 END,
	           PENDING_AMOUNT=CASE WHEN SUM(ISNULL(HOLD_QUANTITY,0))>0 THEN CONVERT(NUMERIC(18,2),SUM(ISNULL(HOLD_AMT,0))-SUM(ISNULL(DELIVER_AMT,0))) ELSE 0 END,
	           AGEING_DAYS=CASE WHEN CONVERT(NUMERIC(18,2),SUM(ISNULL(HOLD_QUANTITY,0))-SUM(ISNULL(T.DELIVER_QUANTITY,0)))>0 THEN DATEDIFF (DD,CM_DT,@DTODT) ELSE 0 END 
	    INTO #TEMPSUMMARY
	    FROM #TEMPDELIVERDATA T
	    JOIN
	    (
	      SELECT CM_ID, SUM(ISNULL(T.SLS_QUANTITY,0)) AS SLS_QUANTITY,
	           SUM(ISNULL(T.AMOUNT,0)) AS AMOUNT
	       FROM #TEMPDELIVERDATA T
	       GROUP BY CM_ID
	    ) T1 ON T.CM_ID =T1.CM_ID 
	    JOIN CUSTDYM C ON C.CUSTOMER_CODE =T.CUSTOMER_CODE
	    JOIN EMPLOYEE E ON E.EMP_CODE =T.EMP_CODE
	    WHERE (@DT_FILTER=1 OR  (ISNULL(DELIVER_DT,'') BETWEEN @DFROMDT AND @DTODT OR ISNULL(DELIVERY_DT,'') BETWEEN @DFROMDT AND @DTODT))
	     AND (@DT_FILTER=2 OR  (ISNULL(DELIVER_DT,'') BETWEEN @DFROMDT AND @DTODT OR ISNULL(DELIVERY_DT,'') BETWEEN @DFROMDT AND @DTODT))
	     AND (@DT_FILTER=0 OR @DT_FILTER=1 OR  ISNULL(DELIVER_DT,'') BETWEEN @DFROMDT AND @DTODT)
	           AND ( @DT_FILTER=0 OR @DT_FILTER=2 OR  ISNULL(DELIVERY_DT,'') BETWEEN @DFROMDT AND @DTODT)
	    GROUP BY CONVERT(VARCHAR,T.CM_DT,105),T.CM_NO,
	             C.USER_CUSTOMER_CODE,
	           	           ISNULL(C.CUSTOMER_FNAME,'')+' '+ ISNULL(C.CUSTOMER_LNAME,'')+ CASE WHEN ISNULL(C.MOBILE,'')<>'' THEN '- ' +MOBILE ELSE '' END,
	           DELIVERY_SLIP_NO,ISNULL(CONVERT(VARCHAR,DELIVERY_DT,105),'') ,
	           ISNULL(CONVERT(VARCHAR,DELIVER_DT,105),''),DELIVER_NO,T.EMP_CODE ,
	           CASE WHEN EMP_NAME='' THEN 'MISC' ELSE EMP_NAME END  ,DATEDIFF (DD,CM_DT,@DTODT),T1.SLS_QUANTITY,T1.AMOUNT,DELIVER_DT
	      
	      
	      IF @NPENDING =0
	      SELECT * FROM #TEMPSUMMARY  
	      ORDER BY EMP_NAME,CM_DT  ,CM_NO,SLS_QUANTITY DESC,DELIVERY_DT,DELIVERY_SLIP_NO 
	      ELSE IF @NPENDING =1
	      SELECT * FROM #TEMPSUMMARY WHERE PENDING_QTY >0 
	      ORDER BY EMP_NAME,CM_DT  ,CM_NO,SLS_QUANTITY DESC,DELIVERY_DT,DELIVERY_SLIP_NO 
	      ELSE
	      SELECT * FROM #TEMPSUMMARY WHERE DELIVER_QUANTITY >0  
	      ORDER BY EMP_NAME,CM_DT  ,CM_NO,SLS_QUANTITY DESC,DELIVERY_DT,DELIVERY_SLIP_NO 
	   
		END
		ELSE
		BEGIN
		
		
		      IF OBJECT_ID ('TEMPDB..#TEMPDETAILS','U') IS NOT NULL
	              DROP TABLE #TEMPDETAILS
	          
		     SELECT CM_ID, CONVERT(VARCHAR,T.CM_DT,105) AS CM_DT,T.CM_NO,T.PRODUCT_CODE,
		       T.SLS_QUANTITY,
		       T.AMOUNT,
		       C.USER_CUSTOMER_CODE AS CUSTOMER_CODE,
			   ISNULL(C.CUSTOMER_FNAME,'')+' '+ ISNULL(C.CUSTOMER_LNAME,'')+ CASE WHEN ISNULL(C.MOBILE,'')<>'' THEN '- ' +MOBILE ELSE '' END AS CUSTOMER_NAME,
			   DELIVERY_SLIP_NO,ISNULL(CONVERT(VARCHAR,DELIVERY_DT,105),'') AS DELIVERY_DT,ISNULL(HOLD_QUANTITY,0) AS HOLD_QUANTITY,HOLD_AMT,
			   ISNULL(CONVERT(VARCHAR,DELIVER_DT,105),'') AS  DELIVER_DT,CONVERT(NUMERIC(18,2),ISNULL(T.DELIVER_QUANTITY,0)) AS DELIVER_QUANTITY,DELIVER_AMT ,
			   DELIVER_NO,T.EMP_CODE ,CASE WHEN EMP_NAME='' THEN 'MISC' ELSE EMP_NAME END AS EMP_NAME,DELIVER_DT AS DEL_DT,
			   PENDING_QTY=CASE WHEN HOLD_QUANTITY >0 THEN CONVERT(NUMERIC(18,2),(ISNULL(HOLD_QUANTITY,0))-(ISNULL(T.DELIVER_QUANTITY,0))) ELSE 0 END,
	           PENDING_AMOUNT=CASE WHEN HOLD_QUANTITY >0 THEN CONVERT(NUMERIC(18,2),(ISNULL(HOLD_AMT,0))-(ISNULL(DELIVER_AMT,0))) ELSE 0 END,
	           AGEING_DAYS=CASE WHEN DELIVER_DT IS NULL THEN DATEDIFF (DD,CM_DT,@DTODT) ELSE 0 END 
	           INTO #TEMPDETAILS
			   FROM #TEMPDELIVERDATA T
			   JOIN CUSTDYM C ON C.CUSTOMER_CODE =T.CUSTOMER_CODE
			   JOIN EMPLOYEE E ON E.EMP_CODE =T.EMP_CODE
			  WHERE (@DT_FILTER=1 OR  (ISNULL(DELIVER_DT,'') BETWEEN @DFROMDT AND @DTODT OR ISNULL(DELIVERY_DT,'') BETWEEN @DFROMDT AND @DTODT))
	           AND (@DT_FILTER=2 OR  (ISNULL(DELIVER_DT,'') BETWEEN @DFROMDT AND @DTODT OR ISNULL(DELIVERY_DT,'') BETWEEN @DFROMDT AND @DTODT))
	            AND (@DT_FILTER=0 OR @DT_FILTER=1 OR  ISNULL(DELIVER_DT,'') BETWEEN @DFROMDT AND @DTODT)
	           AND ( @DT_FILTER=0 OR @DT_FILTER=2 OR  ISNULL(DELIVERY_DT,'') BETWEEN @DFROMDT AND @DTODT)
           
      
		  IF @NPENDING =0
	      SELECT * FROM #TEMPDETAILS  
	      ORDER BY EMP_NAME,CM_DT  ,CM_NO,DELIVERY_DT,DELIVERY_SLIP_NO 
	      ELSE IF @NPENDING =1
	      SELECT * FROM #TEMPDETAILS WHERE PENDING_QTY >0 
	      ORDER BY EMP_NAME,CM_DT  ,CM_NO,DELIVERY_DT,DELIVERY_SLIP_NO 
	      ELSE
	      SELECT * FROM #TEMPDETAILS WHERE DELIVER_QUANTITY >0 
	      ORDER BY EMP_NAME,CM_DT  ,CM_NO,DELIVERY_DT,DELIVERY_SLIP_NO 
		
		END

END
--************ END OF PROCEDURE SP_SALEPERSON_HOLD_DELIVER_REPORT******************************
