CREATE PROCEDURE SP_PUR_HISTORY
(
 @CPARA1 VARCHAR(10)='',
 @CPARA2 VARCHAR(10)='',
 @CPARA3 VARCHAR(10)='',
 @CPARA4 VARCHAR(10)='',
 @CPARA5 VARCHAR(10)='',
 @CPARA6 VARCHAR(10)='',
 @CARTICLECODE VARCHAR(15)='',
 @CACCODE VARCHAR(20)=''
 
)
--WITH ENCRYPTION

AS
BEGIN

DECLARE @CCMD NVARCHAR  (MAX)
DECLARE @CFILTER VARCHAR(1000)
SET @CFILTER = ''

IF ISNULL(@CPARA1,'') = ''
	SET @CFILTER=@CFILTER+' 1 = 1 '
ELSE
	SET @CFILTER=@CFILTER+' P1.PARA1_CODE = '''+@CPARA1+''''
	
IF ISNULL(@CPARA2,'') = ''
	SET @CFILTER=@CFILTER+' AND  1 = 1 '
ELSE
	SET @CFILTER=@CFILTER+' AND  P2.PARA2_CODE = '''+@CPARA2+''''	
	

IF ISNULL(@CPARA3,'') = ''
	SET @CFILTER=@CFILTER+' AND  1 = 1 '
ELSE
	SET @CFILTER=@CFILTER+' AND  P3.PARA3_CODE = '''+@CPARA3+''''	
	

IF ISNULL(@CPARA4,'') = ''
	SET @CFILTER=@CFILTER+' AND  1 = 1 '
ELSE
	SET @CFILTER=@CFILTER+' AND  P4.PARA4_CODE = '''+@CPARA4+''''
	
IF ISNULL(@CPARA5,'') = ''
	SET @CFILTER=@CFILTER+' AND  1 = 1 '
ELSE
	SET @CFILTER=@CFILTER+' AND  P5.PARA5_CODE = '''+@CPARA5+''''		

	
IF ISNULL(@CPARA6,'') = ''
	SET @CFILTER=@CFILTER+' AND  1 = 1 '
ELSE
	SET @CFILTER=@CFILTER+' AND  P6.PARA6_CODE = '''+@CPARA6+''''
	
IF ISNULL(@CARTICLECODE,'') = ''
	SET @CFILTER=@CFILTER+' AND  1 = 1 '
ELSE
	SET @CFILTER=@CFILTER+' AND  B.ARTICLE_CODE = '''+@CARTICLECODE+''''			
	
IF ISNULL(@CACCODE,'') = ''
	SET @CFILTER=@CFILTER+' AND  1 = 1 '
ELSE
	SET @CFILTER=@CFILTER+' AND  LMV.AC_CODE = '''+@CACCODE+''''		

SET @CCMD = N' SELECT  TOP 1 LMV.AC_NAME,A.MRR_NO,B.gross_purchase_price, B.PURCHASE_PRICE,B.MRP, A.DISCOUNT_PERCENTAGE,
ARTICLE_CODE,A.LAST_UPDATE,P1.PARA1_NAME,P2.PARA2_NAME,P3.PARA3_NAME,P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME
FROM PIM01106 A (NOLOCK)  
JOIN PID01106 B (NOLOCK) ON B.MRR_ID=A.MRR_ID  AND A.CANCELLED=0
JOIN PARA1 P1 (NOLOCK) ON B.PARA1_CODE = P1.PARA1_CODE          
JOIN PARA2 P2 (NOLOCK) ON B.PARA2_CODE = P2.PARA2_CODE          
JOIN PARA3 P3 (NOLOCK) ON B.PARA3_CODE = P3.PARA3_CODE          
JOIN PARA4 P4 (NOLOCK) ON B.PARA4_CODE = P4.PARA4_CODE          
JOIN PARA5 P5 (NOLOCK) ON B.PARA5_CODE = P5.PARA5_CODE          
JOIN PARA6 P6 (NOLOCK) ON B.PARA6_CODE = P6.PARA6_CODE 
JOIN LM01106 LMV (NOLOCK) ON A.AC_CODE=LMV.AC_CODE 
WHERE '+@CFILTER+'
ORDER BY A.LAST_UPDATE DESC'

PRINT @CCMD
EXEC SP_EXECUTESQL @CCMD
END
