create PROCEDURE SP3S_PUR_DIFFERENCE_REPORT
(
	@DTFROM					DATETIME,
	@DTTO					DATETIME,
	@CLOC					VARCHAR(5),
	@BAGAINSTLEDGERTERNS	BIT,
	@NMEMOTYPE INT=0 --0 for Regular Purchase  and 1 for all
)
AS
BEGIN

    DECLARE @SHOW_ALL BIT=0,@PUR_LOC BIT=0
    IF @CLOC='' SET @SHOW_ALL=1

	SET @BAGAINSTLEDGERTERNS=0 

    IF EXISTS(SELECT DEPT_ID FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CLOC AND ISNULL(PUR_LOC,0)=1 AND @CLOC!='')
       SET @PUR_LOC=1
       
    IF  @SHOW_ALL=1   
		SELECT A.MRR_DT,A.MRR_ID, A.MRR_NO,A.AC_CODE,B.AC_NAME,C.ADDRESS0,C.ADDRESS1,C.ADDRESS2
		,D.AREA_NAME,E.CITY,F.STATE,A.TERMS,A.TOTAL_AMOUNT,A.PARTY_INV_AMOUNT,CAST(A.TOTAL_AMOUNT-A.PARTY_INV_AMOUNT AS NUMERIC(14,2)) AS [DIFFERENCE_AMT]
		,CONVERT(VARCHAR,A.RECEIPT_DT,105) AS RECEIPT_DT,DATEDIFF(DAY,A.RECEIPT_DT,GETDATE()) AS [AGEING]
		FROM PIM01106 A (NOLOCK)
		JOIN LM01106 B (NOLOCK) ON B.AC_CODE=A.AC_CODE
		JOIN LMP01106 C (NOLOCK) ON C.AC_CODE=B.AC_CODE 
		JOIN AREA D (NOLOCK) ON D.AREA_CODE=C.AREA_CODE
		JOIN CITY E (NOLOCK) ON E.CITY_CODE=D.CITY_CODE
		JOIN [STATE] F (NOLOCK) ON F.STATE_CODE=E.STATE_CODE
		WHERE INV_MODE=1 AND PARTY_INV_AMOUNT<>TOTAL_AMOUNT 
		AND A.RECEIPT_DT BETWEEN @DTFROM AND @DTTO
		AND (ISNULL(@BAGAINSTLEDGERTERNS,0)=0 OR ISNULL(TERMS,'') <>'')
		and (@NMEMOTYPE=1 or a.memo_type in(0,1)) 
		ORDER BY MRR_DT,RECEIPT_DT
	ELSE	
		SELECT A.MRR_DT,A.MRR_ID, A.MRR_NO,A.AC_CODE,B.AC_NAME,C.ADDRESS0,C.ADDRESS1,C.ADDRESS2
		,D.AREA_NAME,E.CITY,F.STATE,A.TERMS,A.TOTAL_AMOUNT,A.PARTY_INV_AMOUNT,CAST(A.TOTAL_AMOUNT-A.PARTY_INV_AMOUNT AS NUMERIC(14,2)) AS [DIFFERENCE_AMT]
		,CONVERT(VARCHAR,A.RECEIPT_DT,105) AS RECEIPT_DT,DATEDIFF(DAY,A.RECEIPT_DT,GETDATE()) AS [AGEING]
		FROM PIM01106 A (NOLOCK)
		JOIN LM01106 B (NOLOCK) ON B.AC_CODE=A.AC_CODE
		JOIN LMP01106 C (NOLOCK) ON C.AC_CODE=B.AC_CODE 
		JOIN AREA D (NOLOCK) ON D.AREA_CODE=C.AREA_CODE
		JOIN CITY E (NOLOCK) ON E.CITY_CODE=D.CITY_CODE
		JOIN [STATE] F (NOLOCK) ON F.STATE_CODE=E.STATE_CODE
		WHERE INV_MODE=1 AND PARTY_INV_AMOUNT<>TOTAL_AMOUNT 
		AND A.RECEIPT_DT BETWEEN @DTFROM AND @DTTO
		AND (ISNULL(@BAGAINSTLEDGERTERNS,0)=0 OR ISNULL(TERMS,'') <>'')
		AND A.DEPT_ID=@CLOC AND @PUR_LOC=1
		and (@NMEMOTYPE=1 or a.memo_type in(0,1))
		ORDER BY MRR_DT,RECEIPT_DT
END
