CREATE PROCEDURE SPPPC_PRD_MULTIPLE_WSLORD_BOM  
(
 @NQUERYID INT=0,
 @CARTICLE_CODE VARCHAR(10)='',
 @CSIZEGROUPCODE VARCHAR(10)='',
 @CORDER_ID VARCHAR(100)='',
 @CPARA1_CODE VARCHAR(10)=''
)
AS
BEGIN 

IF @NQUERYID=1
BEGIN

     IF OBJECT_ID('TEMPDB..#TMPARTBOM','U') IS NOT NULL
       DROP TABLE #TMPARTBOM
    
      SELECT  CAST(1 AS BIT) AS CHK,CASE WHEN ART .ARTICLE_TYPE=1 THEN 'FINISH GOOD'
       WHEN ART.ARTICLE_TYPE=2 THEN 'RAW MATERIAL'
       WHEN ART.ARTICLE_TYPE=3 THEN 'FABRIC'
       WHEN ART.ARTICLE_TYPE=4 THEN 'TRIM' ELSE 'PACKING' END AS ARTICLE_TYPE, 
       A.ARTICLE_CODE,C.BOM_ARTICLE_CODE,
       C.AVG_QTY,
	   C.ROW_ID,
	   B.LAST_UPDATE,
	   C.RATE,
	   A.PARA1_CODE AS BOM_PARA1_CODE,
	   USES=CAST('' AS VARCHAR(10)),
	   A.SIZEGROUP_CODE AS BOM_SIZEGROUP_CODE,
	   ADD_AVG_QTY=CAST(0 AS NUMERIC(10,4)),
	   CONVERT(NUMERIC(12,2),(C.RATE*C.AVG_QTY)) AS TOTALCOST ,  
	  ART.ARTICLE_NO AS BOM_ARTICLE_NO,     
	  ART.ARTICLE_NAME AS BOM_ARTICLE_NAME,     
	  UOM.UOM_NAME AS BOM_UOM_NAME, UOM.UOM_TYPE,
	  SD.SUB_SECTION_NAME,
	  SD.SUB_SECTION_CODE,
	  SM.SECTION_NAME,
	  SM.SECTION_CODE,
	  P1.PARA1_NAME AS BOM_PARA1_NAME,
	  SG.SIZEGROUP_NAME AS BOM_SIZEGROUP_NAME
    INTO #TMPARTBOM
    FROM PPC_BUYER_ORDER_DET A
    JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
    JOIN PPC_BO_ART_BOM C ON A.ROW_ID=C.REF_ROW_ID
    JOIN ARTICLE ART ON C.BOM_ARTICLE_CODE = ART.ARTICLE_CODE 
    JOIN UOM UOM ON ART.UOM_CODE = UOM.UOM_CODE    
    JOIN SECTIOND SD ON SD.SUB_SECTION_CODE=ART.SUB_SECTION_CODE
	JOIN SECTIONM SM ON SD.SECTION_CODE=SM.SECTION_CODE 
	JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE=A.SIZEGROUP_CODE  
	LEFT JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
    WHERE B.CANCELLED=0 AND A.ORDER_ID=@CORDER_ID AND A.ARTICLE_CODE=@CARTICLE_CODE
    AND A.PARA1_CODE=@CPARA1_CODE 
    AND A.SIZEGROUP_CODE=@CSIZEGROUPCODE
    
    IF NOT EXISTS (SELECT TOP 1 'U' FROM #TMPARTBOM)
    BEGIN
	SELECT CAST(CASE WHEN BOM.ARTICLE_CODE IS NULL THEN 0 ELSE 1 END AS BIT) AS CHK,
	CASE WHEN A.ARTICLE_TYPE=1 THEN 'FINISH GOOD'
    WHEN A.ARTICLE_TYPE=2 THEN 'RAW MATERIAL'
    WHEN A.ARTICLE_TYPE=3 THEN 'FABRIC'
    WHEN A.ARTICLE_TYPE=4 THEN 'TRIM' ELSE 'PACKING' END AS ARTICLE_TYPE,
	 @CARTICLE_CODE AS ARTICLE_CODE,--@CARTICLE_CODE
	A.ARTICLE_CODE AS BOM_ARTICLE_CODE,
	AVG_QTY=ISNULL(BOM.AVG_QTY,0),
	ROW_ID=CAST('LATER'+CAST(NEWID () AS VARCHAR(40)) AS VARCHAR(40)),
	LAST_UPDATE=GETDATE(),
	COMPANY_CODE=COM.COMPANY_CODE,
	RATE=ISNULL(BOM.RATE,0),
	BOM_PARA1_CODE=CAST('0000000' AS VARCHAR(100)),
	USES=CAST('' AS VARCHAR(10)),
	@CSIZEGROUPCODE AS BOM_SIZEGROUP_CODE,
	ADD_AVG_QTY=CAST(0 AS NUMERIC(10,4)),
	CAST(ISNULL(BOM.AVG_QTY,0)*ISNULL(BOM.RATE,0) AS NUMERIC(12,2)) AS TOTALCOST,     
	A.ARTICLE_NO AS BOM_ARTICLE_NO,     
	A.ARTICLE_NAME AS BOM_ARTICLE_NAME,     
	E.UOM_NAME AS BOM_UOM_NAME, E.UOM_TYPE,
	0 AS QUANTITY_IN_STOCK,
	B.SUB_SECTION_NAME,
	B.SUB_SECTION_CODE,
	C.SECTION_NAME,
	C.SECTION_CODE,
	('NA') AS BOM_PARA1_NAME,
	ISNULL(S.SIZEGROUP_NAME,S.SIZEGROUP_NAME) AS BOM_SIZEGROUP_NAME 
	FROM ARTICLE A
	JOIN SECTIOND B ON A.SUB_SECTION_CODE=B.SUB_SECTION_CODE
	JOIN SECTIONM C ON B.SECTION_CODE=C.SECTION_CODE
	JOIN COMPANY COM ON COM.COMPANY_CODE='01'
	JOIN UOM E ON A.UOM_CODE = E.UOM_CODE 
	JOIN PPC_SIZEGROUP S ON S.SIZEGROUP_CODE=@CSIZEGROUPCODE
	LEFT OUTER JOIN PPC_ART_BOM BOM ON BOM.BOM_ARTICLE_CODE=A.ARTICLE_CODE 
	AND BOM.ARTICLE_CODE=@CARTICLE_CODE AND BOM_SIZEGROUP_CODE=@CSIZEGROUPCODE
	--LEFT OUTER JOIN ART_PARA1 P1 ON P1.ARTICLE_CODE=A.ARTICLE_CODE
	--LEFT JOIN PARA1 ON PARA1.PARA1_CODE=P1.PARA1_CODE
	WHERE  A.INACTIVE=0 AND A.ARTICLE_TYPE<>1  --AND BOM.BOM_ARTICLE_CODE IS NULL
	END
	ELSE
	BEGIN
	
	   SELECT * FROM #TMPARTBOM
	   UNION ALL
	   SELECT CAST(0 AS BIT) AS CHK,
	CASE WHEN A.ARTICLE_TYPE=1 THEN 'FINISH GOOD'
    WHEN A.ARTICLE_TYPE=2 THEN 'RAW MATERIAL'
    WHEN A.ARTICLE_TYPE=3 THEN 'FABRIC'
    WHEN A.ARTICLE_TYPE=4 THEN 'TRIM' ELSE 'PACKING' END AS ARTICLE_TYPE,
	 @CARTICLE_CODE AS ARTICLE_CODE,--@CARTICLE_CODE
	A.ARTICLE_CODE AS BOM_ARTICLE_CODE,
	AVG_QTY=ISNULL(BOM.AVG_QTY,0),
	ROW_ID=CAST('LATER'+CAST(NEWID () AS VARCHAR(40)) AS VARCHAR(40)),
	LAST_UPDATE=GETDATE(),
	RATE=ISNULL(BOM.RATE,0),
	BOM_PARA1_CODE=CAST('0000000' AS VARCHAR(100)),
	USES=CAST('' AS VARCHAR(10)),
	@CSIZEGROUPCODE AS BOM_SIZEGROUP_CODE,
	ADD_AVG_QTY=CAST(0 AS NUMERIC(10,4)),
	CAST(ISNULL(BOM.AVG_QTY,0)*ISNULL(BOM.RATE,0) AS NUMERIC(12,2)) AS TOTALCOST,     
	A.ARTICLE_NO AS BOM_ARTICLE_NO,     
	A.ARTICLE_NAME AS BOM_ARTICLE_NAME,     
	E.UOM_NAME AS BOM_UOM_NAME, E.UOM_TYPE,
	B.SUB_SECTION_NAME,
	B.SUB_SECTION_CODE,
	C.SECTION_NAME,
	C.SECTION_CODE,
	('NA') AS BOM_PARA1_NAME,
	ISNULL(S.SIZEGROUP_NAME,S.SIZEGROUP_NAME) AS BOM_SIZEGROUP_NAME 
	FROM ARTICLE A
	JOIN SECTIOND B ON A.SUB_SECTION_CODE=B.SUB_SECTION_CODE
	JOIN SECTIONM C ON B.SECTION_CODE=C.SECTION_CODE
	JOIN COMPANY COM ON COM.COMPANY_CODE='01'
	JOIN UOM E ON A.UOM_CODE = E.UOM_CODE 
	JOIN PPC_SIZEGROUP S ON S.SIZEGROUP_CODE=@CSIZEGROUPCODE
	LEFT OUTER JOIN PPC_ART_BOM BOM ON BOM.BOM_ARTICLE_CODE=A.ARTICLE_CODE 
	AND BOM.ARTICLE_CODE=@CARTICLE_CODE AND BOM_SIZEGROUP_CODE=@CSIZEGROUPCODE
	LEFT OUTER JOIN #TMPARTBOM TMP ON TMP.BOM_ARTICLE_CODE=A.ARTICLE_CODE
	WHERE  A.INACTIVE=0 AND A.ARTICLE_TYPE<>1  AND BOM.BOM_ARTICLE_CODE IS NULL
	AND TMP.ARTICLE_CODE IS NULL
	ORDER BY CHK DESC
	
	END
	
	
END
	
END
