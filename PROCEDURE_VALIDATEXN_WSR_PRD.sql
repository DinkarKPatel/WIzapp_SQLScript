CREATE PROCEDURE VALIDATEXN_WSR_PRD
 @CXNID VARCHAR(50),	
 @NUPDATEMODE INT,			 
 @CERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CPRODUCTCODE VARCHAR(50),@CCMD NVARCHAR(MAX),@NSUMCNDNET NUMERIC(10,2),@NSUBTOTAL NUMERIC(10,2),
			@NCALCTOTALAMOUNT NUMERIC(10,2),@NCNMTOTALAMOUNT NUMERIC(10,2),@NCALCDISCOUNTAMT NUMERIC(10,2),
			@NDISCOUNTAMT NUMERIC(10,2),@NCALCTAXVAL NUMERIC(10,2),@NUPDTAXVAL NUMERIC(10,2)
		
	SELECT TOP 1 @CPRODUCTCODE=PRODUCT_UID FROM PRD_CND01106 WHERE CN_ID=@CXNID  AND RATE=0
			   
	IF ISNULL(@CPRODUCTCODE,'')<>''
	BEGIN
		SET @CCMD = 'INVALID RATE FOR ITEM CODE : '+@CPRODUCTCODE  +' ..... CANNOT SAVE '
		RETURN
	END
					
	SELECT @NSUMCNDNET=SUM((A.RATE-(A.DISCOUNT_AMOUNT/A.QUANTITY))*A.QUANTITY) FROM PRD_CND01106 A
	JOIN PRD_SKU B ON A.PRODUCT_UID=B.PRODUCT_UID
	JOIN ARTICLE C ON C.ARTICLE_CODE=B.ARTICLE_CODE
	WHERE CN_ID=@CXNID

	-- CHECKING DISCOUNT AMOUNT AT ITEM LEVEL
	SELECT TOP 1 @CPRODUCTCODE=PRODUCT_UID,@NCALCDISCOUNTAMT=ROUND(QUANTITY*DISCOUNT_PERCENTAGE/100,0),
	@NDISCOUNTAMT=DISCOUNT_AMOUNT FROM PRD_CND01106 WHERE CN_ID=@CXNID AND 
	ABS(ROUND(QUANTITY*DISCOUNT_PERCENTAGE/100,0)-@NDISCOUNTAMT)>1
	
	IF ISNULL(@CPRODUCTCODE,'')<>''
	BEGIN
		SET @CERRORMSG='ITEM CODE : '+@CPRODUCTCODE+' MISMATCH BETWEEN EXPECTED DISCOUNT AMOUNT ('+
						LTRIM(RTRIM(STR(ISNULL(@NCALCDISCOUNTAMT,0),10,2)))+') &
						UPDATED DISCOUNT AMOUNT ('+LTRIM(RTRIM(STR(ISNULL(@NDISCOUNTAMT,0),10,2)))+')..... CANNOT SAVE '

		RETURN
	END

	SELECT @NSUBTOTAL =SUBTOTAL FROM PRD_CNM01106 WHERE CN_ID=@CXNID

	IF ABS(ISNULL(@NSUMCNDNET,0)-ISNULL(@NSUBTOTAL,0))>1
	BEGIN
		SET @CERRORMSG = 'MISMATCH BETWEEN ITEM LEVEL TOTAL AMOUNT & BILL LEVEL SUBTOTAL.....' -- CANNOT SAVE '
		RETURN
	END
	
	-- CHECKING DISCOUNT AMOUNT AT BILL LEVEL
	SELECT @NCALCDISCOUNTAMT = ROUND(SUBTOTAL*DISCOUNT_PERCENTAGE/100,0) FROM PRD_CNM01106 WHERE CN_ID=@CXNID
	
	SELECT @NDISCOUNTAMT = DISCOUNT_AMOUNT FROM  PRD_CNM01106 WHERE CN_ID=@CXNID
		
	IF 	ABS(@NDISCOUNTAMT-ISNULL(@NCALCDISCOUNTAMT,0))>1
	BEGIN
		SET @CERRORMSG='MISMATCH BETWEEN BILL LEVEL EXPECTED DISCOUNT AMOUNT ('+LTRIM(RTRIM(STR(
						ISNULL(@NCALCDISCOUNTAMT,0),10,2)))+') &
						UPDATED DISCOUNT AMOUNT ('+LTRIM(RTRIM(STR(ISNULL(@NDISCOUNTAMT,0),10,2)))+')..... CANNOT SAVE '

		RETURN
	END
	
	DECLARE @NTAXFLAG NUMERIC(1,0)
	
	SELECT @NTAXFLAG=BILL_LEVEL_TAX_METHOD FROM PRD_CNM01106 WHERE CN_ID=@CXNID
	
	IF EXISTS (SELECT TOP 1 CN_ID FROM PRD_CNM01106 WHERE CN_ID=@CXNID AND SUBTOTAL<>0)
	BEGIN
		PRINT 'VALIDATE TAX OF INVOICE ID :'+@CXNID
		
		
	
		SELECT TOP 1 @CPRODUCTCODE=PRODUCT_UID,@NUPDTAXVAL=A.ITEM_TAX_AMOUNT,
		@NCALCTAXVAL=(((A.NET_RATE*A.QUANTITY)-(A.NET_RATE*A.QUANTITY*B.DISCOUNT_PERCENTAGE/100)+
			   (((B.EXCISE_DUTY_AMOUNT+B.EXCISE_EDU_CESS_AMOUNT+B.EXCISE_HEDU_CESS_AMOUNT)/B.SUBTOTAL)*
			   (A.NET_RATE*A.QUANTITY)))*A.ITEM_TAX_PERCENTAGE/
				(CASE WHEN @NTAXFLAG=1 THEN 100 ELSE 100+A.ITEM_TAX_PERCENTAGE END))
		FROM PRD_CND01106 A JOIN PRD_CNM01106 B ON A.CN_ID=B.CN_ID
		WHERE A.CN_ID=@CXNID AND (ABS(CONVERT(NUMERIC(10,2),(((A.NET_RATE*A.QUANTITY)-(A.NET_RATE*A.QUANTITY*B.DISCOUNT_PERCENTAGE/100)+
			   (((B.EXCISE_DUTY_AMOUNT+B.EXCISE_EDU_CESS_AMOUNT+B.EXCISE_HEDU_CESS_AMOUNT)/B.SUBTOTAL)*
			   (A.NET_RATE*A.QUANTITY)))*A.ITEM_TAX_PERCENTAGE/
				(CASE WHEN @NTAXFLAG=1 THEN 100 ELSE 100+A.ITEM_TAX_PERCENTAGE END))))-A.ITEM_TAX_AMOUNT)>.1
		

		IF ISNULL(@CPRODUCTCODE,'')<>''
		BEGIN
			SET @CERRORMSG='MISMATCH BETWEEN EXPECTED TAX AMOUNT ('+LTRIM(RTRIM(STR(@NCALCTAXVAL,10,2)))+') &
							EXISTING TAX AMOUNT ('+LTRIM(RTRIM(STR(@NUPDTAXVAL,10,2)))+') FOR ITEM CODE :'+@CPRODUCTCODE+'..... CANNOT SAVE '

			RETURN
		END
	
	END	
	
	SELECT @NCALCTAXVAL=SUM(ITEM_TAX_AMOUNT) FROM PRD_CND01106 WHERE CN_ID=@CXNID
	
	SELECT @NCALCTOTALAMOUNT = SUBTOTAL + FREIGHT -DISCOUNT_AMOUNT + OTHER_CHARGES+ROUND_OFF+
							   (CASE WHEN BILL_LEVEL_TAX_METHOD=1 THEN ISNULL(@NCALCTAXVAL,0) ELSE ISNULL(@NCALCTAXVAL,0) END)
							    FROM PRD_CNM01106 WHERE CN_ID=@CXNID	

	SELECT @NCNMTOTALAMOUNT=TOTAL_AMOUNT FROM PRD_CNM01106 WHERE CN_ID=@CXNID
	
	IF ABS(ISNULL(@NCNMTOTALAMOUNT,0)-ISNULL(@NCALCTOTALAMOUNT,0))>1
	BEGIN
		SET @CERRORMSG = 'MISMATCH BETWEEN CALCULATED NET AMOUNT '+LTRIM(RTRIM(STR(ISNULL(@NCALCTOTALAMOUNT,0),14,4)))+
					' & BILL LEVEL NET AMOUNT '+LTRIM(RTRIM(STR(ISNULL(@NCNMTOTALAMOUNT,0),14,4))) -- +'..... CANNOT SAVE '
		RETURN
	END
	
END 
------- 'END OF CREATING PROCEDURE VALIDATEXN_WSR_PRD'
