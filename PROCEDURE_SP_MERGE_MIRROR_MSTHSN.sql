create PROCEDURE DBO.SP_MERGE_MIRROR_MSTHSN
 ( @NMODE INT
  )
AS
 BEGIN
       DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
              ,@CTEMPLOCTABLE VARCHAR(100),@CSTATECODEOUT CHAR(7),@CSTATECODE VARCHAR(10)
              ,@CCURDEPTID VARCHAR(10),@CHODEPTID VARCHAR(10),@BHOLOC BIT,@NLOCTYPE VARCHAR(50)
              ,@BPURLOC VARCHAR(10),@CTABLENAME VARCHAR(100),@CTMP_TABLENAME VARCHAR(100)
              ,@CKEYFIELD1 VARCHAR(100),@CTEMPLOCSSTTABLE VARCHAR(500),@CTEMPTABLE VARCHAR(500)
              ,@CTEMPLOCSSTMSTTABLE VARCHAR(500),@BPROCEED BIT,@CKEYFIELD2 VARCHAR(500),@CKEYFIELD3 VARCHAR(500) 
	          ,@CSOURCETABLE VARCHAR(1000),@NXNSMERGINGORDER INT,@CSOURCEDB VARCHAR(200),@CERRORMSG VARCHAR(MAX)	
	          ,@XN_TYPE VARCHAR(10)
BEGIN TRY
	  SELECT @CSOURCEDB=''	

	  IF ISNULL(@NMODE,0) = 1
        GOTO END_PROC;
   	
	  BEGIN TRANSACTION
      
      SET @CSTEP = 00  
               
	  SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'  
	  SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'  
	  
	  IF @CCURDEPTID=@CHODEPTID
	  BEGIN
			SET @CERRORMSG='P:SP_MERGE_MIRROR_MSTHSN, CANNOT CALL MERGING PROC AT HEAD OFFICE'
			GOTO END_PROC
  	  END					

	  SET @CSTEP = 05    
	    
	  SELECT @NLOCTYPE=LOC_TYPE,@BPURLOC=PUR_LOC FROM LOCATION WHERE DEPT_ID=@CCURDEPTID  
	  
	   DELETE A FROM HSN_DET A with (nolock)
	   join MSTHSN_HSN_DET_MIRROR b  with (nolock) on a.HSN_CODE=b.HSN_CODE 
	  DELETE FROM TCS_MST
	       
		   
           
	  SET @CSTEP = 10   

	   SET @CKEYFIELD2 =''
	   SET @CKEYFIELD3 =''
	 --INSERT DATA INTO LOCATION TABLE
	   
	   SET @XN_TYPE='MSTHSN'

	   SET @CSTEP = 20
	   SET @CTABLENAME = 'GST_STATE_MST'
	   SET @CSOURCETABLE ='MSTHSN_GST_STATE_MST_MIRROR'
	   SET @CKEYFIELD1 ='GST_STATE_CODE'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	  --TRUNCATE TABLE GST_STATE_DET
	   
	   SET @CSTEP = 25
	   SET @CTABLENAME = 'GST_STATE_DET'
	   SET @CSOURCETABLE ='MSTHSN_GST_STATE_DET_MIRROR'
	   SELECT @CKEYFIELD1 ='GST_STATE_CODE'
	   
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=1,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=0
	   
	   --INSERT AND UPDATE DATA INTO LICENSE_INFO_HO TABLE
	   SET @CSTEP = 40
	   SET @CTABLENAME = 'HSN_MST'
	   SET @CSOURCETABLE ='MSTHSN_HSN_MST_MIRROR'
	   SET @CKEYFIELD1 ='HSN_CODE'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	      --INSERT AND UPDATE DATA INTO LICENSE_INFO_HO TABLE
	   SET @CSTEP = 45
	   SET @CTABLENAME = 'HSN_DET'
	   SET @CSOURCETABLE ='MSTHSN_HSN_DET_MIRROR'
	   SET @CKEYFIELD1 ='HSN_CODE'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	   
	   
	   SET @CSTEP = 70
	   SET @CTABLENAME = 'GST_OH_CONFIG'   
	   SET @CSOURCETABLE ='MSTHSN_GST_OH_CONFIG_MIRROR'
	   SET @CKEYFIELD1 ='OH_NAME'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2='XN_TYPE',@CKEYFIELD3='',@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1


	    SET @CSTEP = 100
	   SET @CTABLENAME = 'TCS_MST'   
	   SET @CSOURCETABLE ='MSTHSN_TCS_MST_MIRROR'
	   SET @CKEYFIELD1 ='ROW_ID'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2='',@CKEYFIELD3='',@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   	   
    GOTO END_PROC
END TRY

BEGIN CATCH
	SET @CERRORMSG='P:SP_MERGE_MIRROR_MSTHSN, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:
	
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')='' 
			COMMIT
		ELSE
			ROLLBACK	
	END
	
	IF ISNULL(@CERRORMSG,'')='' 
	BEGIN   
	    
		DELETE FROM MSTHSN_GST_STATE_MST_MIRROR
		DELETE FROM MSTHSN_GST_STATE_DET_MIRROR
		DELETE FROM MSTHSN_HSN_MST_MIRROR
		DELETE FROM MSTHSN_HSN_DET_MIRROR
		DELETE FROM MSTHSN_GST_OH_CONFIG_MIRROR
		DELETE FROM MSTHSN_TCS_MST_MIRROR

	 
	   
	END
		
	SELECT @XN_TYPE AS MEMO_ID,@CERRORMSG AS ERRMSG   	  
END
-------- ' END OF CREATING PROCEDURE SP_MERGE_MIRROR_MSTHSN'
