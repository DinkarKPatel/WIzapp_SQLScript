create PROCEDURE sp3s_wz_maintainance_postmonitor_run_NEW   
AS
BEGIN
	DECLARE @cLOC_ID VARCHAR(5)
	SELECT @cLOC_ID=VALUE FROM config WHERE config_option='LOCATION_ID'
	
	;WITH EXECHANGE  
	AS  
	(  
		
		SELECT 99 AS STATEMENT_ID, 'EXEC SP3S_REBUILD_optimized_schemes' AS STATEMENT_EXPR  
		UNION   
		SELECT 101 AS STATEMENT_ID, 'EXEC RUNCMD_WITH_CONFIG' AS STATEMENT_EXPR  
		UNION   
		SELECT 102 AS STATEMENT_ID,'EXEC SP3S_INSDEFAULT_ACCOUNTS_CONFIG' AS STATEMENT_EXPR  
		UNION  
		SELECT 104 AS STATEMENT_ID,'EXEC SP_CREATEPAYMODEVIEW' AS STATEMENT_EXPR  
		UNION  
		SELECT 105 AS STATEMENT_ID,'EXEC SP3S_MISMATCH_COLUMNS ''_UPLOAD''' AS STATEMENT_EXPR   
		UNION  
		SELECT 107 AS STATEMENT_ID,'EXEC SP3S_UPDATE_WEIGHTED_VALUE_SLS' AS STATEMENT_EXPR  
		UNION  
		SELECT 100 AS STATEMENT_ID,'EXEC SP3S_SYNCH_CONFIG' AS STATEMENT_EXPR  
		UNION  
		SELECT 110 AS STATEMENT_ID,'EXEC SP3S_DROPCOLS_DOCMIRRORTABLES' AS STATEMENT_EXPR  
		UNION  
		SELECT 111 AS STATEMENT_ID,'EXEC SP_REFRESH_APPVIEWS'  AS STATEMENT_EXPR  
		UNION  
		SELECT 114 AS STATEMENT_ID,'EXEC SP3S_Reporting_expressions' AS STATEMENT_EXPR  
		UNION  
		SELECT 115 AS STATEMENT_ID,'IF EXISTS(SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME=''ACT_BILL_BY_BILL_REF_UPLOAD'' AND COLUMN_NAME=''REF_TYPE'') 	ALTER TABLE ACT_BILL_BY_BILL_REF_UPLOAD DROP COLUMN REF_TYPE' AS STATEMENT_EXPR  
		UNION  
		SELECT 116 AS STATEMENT_ID,'IF EXISTS(SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME=''BILL_BY_BILL_REF'' AND COLUMN_NAME=''REF_TYPE'')	ALTER TABLE BILL_BY_BILL_REF DROP COLUMN REF_TYPE	' AS STATEMENT_EXPR  
		UNION  
		SELECT 117 AS STATEMENT_ID,'EXEC SP3S_INSNEWCOLS_PENDINGDOCS' AS STATEMENT_EXPR  
		UNION  
		SELECT 118 AS STATEMENT_ID,'EXEC SP3S_RECAL_TOTALQTYCOLS' AS STATEMENT_EXPR  
		UNION  
		SELECT 122 AS STATEMENT_ID,'EXEC SP3S_COMPARE_STRUCOLS' AS STATEMENT_EXPR 

		UNION
		SELECT 231 AS STATEMENT_ID,'EXEC SP3S_CREATE_MASTERSLOV' AS STATEMENT_EXPR 
		UNION
		SELECT 235 AS STATEMENT_ID,'EXEC SP3S_RUN_ENDSCRIPTS' AS STATEMENT_EXPR 
		UNION
		SELECT 305 AS STATEMENT_ID,'EXEC SP3S_RECREATE_INFSCHEMA_COLS' AS STATEMENT_EXPR  
		UNION
		SELECT 308 AS STATEMENT_ID,'EXEC SP3S_INS_AGEXFPCOLS_PMTLOCS' AS STATEMENT_EXPR  
		UNION
		SELECT 90 AS STATEMENT_ID,'EXEC SP3S_UPDATE_SLSKEYSTABLE_LASTCMDT' AS STATEMENT_EXPR  
		UNION
		SELECT 340 AS STATEMENT_ID,'EXEC SP3S_UPD_BBREF_CDBASEAMOUNT' AS STATEMENT_EXPR  
		UNION
		SELECT 352 AS STATEMENT_ID,'EXEC SP3S_PMTBUILD_expressions' AS STATEMENT_EXPR  		
		UNION
		SELECT 355 AS STATEMENT_ID,'EXEC SP3S_CREATE_TRG_ATTRS_LASTMODIFIEDON' AS STATEMENT_EXPR  		
		UNION
		SELECT 360 AS STATEMENT_ID,'EXEC SP3S_BUILD_LOCWISESKU' AS STATEMENT_EXPR  		
		UNION
		SELECT 365 AS STATEMENT_ID,'EXEC SP3S_REBUILD_XN_RFNET' AS STATEMENT_EXPR  		
		
		----Commented as it is still taking time found at Stelatoes becuase of 
		--- which their merging got stopped altogether after New Update (Sanjay:21-09-2021)
		--UNION
		--SELECT 354 AS STATEMENT_ID,'EXEC SP_UPDATE_MEMO_PREFIX' AS STATEMENT_EXPR  

		UNION
		SELECT 356 AS STATEMENT_ID,'EXEC SP3S_WIPPMT_BUILD_expressions' AS STATEMENT_EXPR  
		UNION
		SELECT 359 AS STATEMENT_ID,'EXEC SPSIS_UPDATE_XNSSENDING_COLS' AS STATEMENT_EXPR  
		UNION
		SELECT 370 AS STATEMENT_ID,'EXEC SP3S_BUILD_WEEKNO_DATES' AS STATEMENT_EXPR 			
		UNION
		SELECT 372 AS STATEMENT_ID,'EXEC SP3S_UPDATE_CMDRFNET_WITH_ATD' AS STATEMENT_EXPR 			
		UNION
		SELECT 300 AS STATEMENT_ID,'EXEC SP3S_CREATE_PMTDB' AS STATEMENT_EXPR 
		UNION
		SELECT 306 AS STATEMENT_ID,'EXEC SP3S_CREATE_IMAGEDB' AS STATEMENT_EXPR 
		UNION
		SELECT 318 AS STATEMENT_ID,'SPWOW_INSDEFAULT_MENUITEMS'
		
		UNION
		SELECT 374 AS STATEMENT_ID,'EXEC SP3S_UPDATE_IMGINFO_BARCODES 1' AS STATEMENT_EXPR  	
		UNION  
		SELECT 376 AS STATEMENT_ID,'EXEC SP3S_BUILDPMT_LOC ' AS STATEMENT_EXPR  
		UNION  
		SELECT 430 AS STATEMENT_ID,'EXEC SP3S_SHRINKLOG_FORCLY' AS STATEMENT_EXPR 	
		UNION  
		SELECT 440 AS STATEMENT_ID,'EXEC SP3S_DROP_CMD_ROWID_DEPENDENCY' AS STATEMENT_EXPR 	
		UNION  
		SELECT 445 AS STATEMENT_ID,'EXEC SP3S_CREATE_CMD_ROWID_DEPENDENCY' AS STATEMENT_EXPR 	
		UNION  
		SELECT 468 AS STATEMENT_ID,'EXEC SP3S_INSDUMMY_B2BENTRIES' AS STATEMENT_EXPR 	
		UNION  
		SELECT 448 AS STATEMENT_ID,'EXEC sp3s_insdummy_cmm' AS STATEMENT_EXPR 	
		UNION  
		SELECT 457 AS STATEMENT_ID,'EXEC sp3s_insdummy_wps' AS STATEMENT_EXPR 	
		UNION  
		SELECT 450 AS STATEMENT_ID,'EXEC SP3S_CRTINDEX_INDEXVIEW' AS STATEMENT_EXPR 	

		--UNION  (as discuss with sanjiv sir vw_xnsreps has been discarded)
		--SELECT 455 AS STATEMENT_ID,'exec SP3S_UPDATEPMT_WITHXNSRPT '''',''''' AS STATEMENT_EXPR 	
		UNION
		SELECT 458 AS STATEMENT_ID,'EXEC SP_WL_DROPTEMPTABLES' AS STATEMENT_EXPR  
		UNION 
		SELECT 460  AS STATEMENT_ID ,'EXEC SP3S_INSDUMMY_RPS'  AS STATEMENT_EXPR  
		
	)  
	,DAYCHANGE  
	AS  
	(  
		SELECT 200 AS STATEMENT_ID,'EXEC SP_WL_DROPTEMPTABLES' AS STATEMENT_EXPR  
		UNION  
		SELECT 201 AS STATEMENT_ID,'TRUNCATE TABLE POS_NRV ' AS STATEMENT_EXPR  
		UNION  
		SELECT 202 AS STATEMENT_ID,'EXEC ' + DB_NAME()+ '..SP_UPDATESTATS ' AS STATEMENT_EXPR  
		UNION  
		SELECT 203 AS STATEMENT_ID,'EXEC ' + DB_NAME()+ '_RFOPT..SP_UPDATESTATS ' AS STATEMENT_EXPR  
		UNION  
		SELECT 215 AS STATEMENT_ID,'EXEC ' + DB_NAME()+ '_IMAGE..SP_UPDATESTATS ' AS STATEMENT_EXPR  
		UNION  
		--SELECT 207 AS STATEMENT_ID,'EXEC SP3S_UPDATEIRRMRP' AS STATEMENT_EXPR  (Commented the calling of this procedure as it was doing
																				  --wrong mrp updations at MBKB as per Dinkar (Date:24-09-2024)
		--UNION  
		SELECT 208 AS STATEMENT_ID,'EXEC SP3S_INSERTDEFAULTBIN' AS STATEMENT_EXPR  
		UNION  
		SELECT 209 AS STATEMENT_ID,'EXEC SP3S_INACTIVE_DUP_PARA ' AS STATEMENT_EXPR  
		UNION  
		SELECT 210 AS STATEMENT_ID,'UPDATE SEND_MASTERS_LOV SET RUNNING=0' AS STATEMENT_EXPR  
		UNION  
		SELECT 229 AS STATEMENT_ID,'EXEC sp3s_restore_config_entries' AS STATEMENT_EXPR
		UNION
		SELECT 312 AS STATEMENT_ID,'EXEC SP3S_RECREATE_INFSCHEMA_COLS' AS STATEMENT_EXPR  
		UNION
		SELECT 307 AS STATEMENT_ID,'EXEC SP3S_SYNCH_LEDGERBALANCES' AS STATEMENT_EXPR  
		UNION
		SELECT 313 AS STATEMENT_ID,'EXEC SP3S_UPDATE_LOCATION_CM_DT' AS STATEMENT_EXPR  
		UNION
		SELECT 319 AS STATEMENT_ID,'EXEC SP3S_LEDGER_NET_AMOUNT' AS STATEMENT_EXPR  
		UNION
		SELECT 323 AS STATEMENT_ID,'EXEC SP3S_GEN_BILLBYBILL_PURHISTORY' AS STATEMENT_EXPR  
		UNION
		SELECT 327 AS STATEMENT_ID,'EXEC SP3S_AUTOSETTLE_POSBO' AS STATEMENT_EXPR  
		union 
		SELECT 328 AS STATEMENT_ID,'EXEC SP3S_UPDATE_CUSTOMERBALANCES '''','''',''''  ' AS STATEMENT_EXPR  
		union 
		SELECT 330 AS STATEMENT_ID,'EXEC SP3S_CREATE_LOCNAMES ' AS STATEMENT_EXPR  
		union 
		SELECT 332 AS STATEMENT_ID,'EXEC SP3S_POPULATE_CUSTOMERCRM_CUBE   ' AS STATEMENT_EXPR  
		UNION  
		SELECT 227 AS STATEMENT_ID,'EXEC SP3S_CREATE_SKUNAMES' AS STATEMENT_EXPR 	
		UNION 
		SELECT 358 AS STATEMENT_ID,'EXEC SP3S_BUILD_WEEKNO_DATES 1' AS STATEMENT_EXPR 		
		UNION
		SELECT 380 AS STATEMENT_ID,'EXEC SP3S_GETPROFITAMOUNT_TRIALBALANCE @bResetOldEntries=1' AS STATEMENT_EXPR  
		UNION 
		SELECT 390 AS STATEMENT_ID,'EXEC SP_CASHXN_OPS 1,0,1' AS STATEMENT_EXPR 
		UNION  
		SELECT 425 AS STATEMENT_ID,'EXEC SP3S_SHRINKLOG_FORCLY' AS STATEMENT_EXPR 		
		UNION  
		SELECT 435 AS STATEMENT_ID,'EXEC SP3S_DELETE_DUPCMMVERSIONS @bDeleteDummyEntries=1' AS STATEMENT_EXPR 		
		UNION  
		SELECT 465 AS STATEMENT_ID,'EXEC SP3S_DELETE_DUMMYENTRIES' AS STATEMENT_EXPR 		
		UNION  
		SELECT 449 AS STATEMENT_ID,'EXEC SP3S_CREATE_SKUNAMES_OLD' AS STATEMENT_EXPR 
		UNION  
		SELECT 485 AS STATEMENT_ID,'EXEC SP3S_UPDATE_CUSTDYM_TOTALSALEANDRETURN' AS STATEMENT_EXPR 
		--(Reactivated auto build of SKu_names again on Day change by default and not run it as per config for Offline CLient
		--(It should not run automatic on cloud clients strictly ) (Tickit#0124-00041 Date:15-01-2024)	
		UNION 
		SELECT 486  AS STATEMENT_ID ,'TRUNCATE TABLE ACT_FILTER_LOC'  AS STATEMENT_EXPR  

	)  
	,EVERYSTART  
	AS  
	(  
	    SELECT 301 AS STATEMENT_ID,'UPDATE BIN SET MAJOR_BIN_ID=BIN_ID WHERE ISNULL(MAJOR_BIN_ID,'''')=''''' AS STATEMENT_EXPR  
		UNION
		SELECT 310 AS STATEMENT_ID,'EXEC SP3S_RECREATE_INFSCHEMA_COLS' AS STATEMENT_EXPR  
		UNION
		SELECT 314 AS STATEMENT_ID,'EXEC SP3S_GETPROFITAMOUNT_TRIALBALANCE' AS STATEMENT_EXPR  
		UNION
		SELECT 320 AS STATEMENT_ID,'EXEC SP3S_BUILD_NEGATIVECASH' AS STATEMENT_EXPR  
		UNION
		SELECT 325 AS STATEMENT_ID,'EXEC SP3S_SYNCH_VCHFINYEAR' AS STATEMENT_EXPR  
		UNION
		SELECT 335 AS STATEMENT_ID,'DELETE FROM CONFIG WHERE CONFIG_OPTION=''ENABLE_TEMP_DATABASE''' AS STATEMENT_EXPR
		UNION  
		SELECT 232 AS STATEMENT_ID,'EXEC SP3S_CREATE_ARTNAMES' AS STATEMENT_EXPR 
		UNION 
		SELECT 337 AS STATEMENT_ID,'INSDEFAULT_PROMOTIONAL_SCHEMES' AS STATEMENT_EXPR 
		UNION  
		SELECT 228 AS STATEMENT_ID,'EXEC SP3S_CREATE_LOCNAMES' AS STATEMENT_EXPR 
		UNION
		SELECT 350 AS STATEMENT_ID,'EXEC SP3S_BUILD_XPERTREPORTING_EXPRESSIONS' AS STATEMENT_EXPR  		
	)  

	SELECT A.STATEMENT_ID,A.STATEMENT_EXPR, A.RUN_ON_EXECHANGE,A.RUN_ON_DAYCHANGE,A.RUN_ON_EVERYSTART  
	INTO #events
	FROM   
	(  
		SELECT STATEMENT_ID ,STATEMENT_EXPR,1 AS RUN_ON_EXECHANGE,0 AS RUN_ON_DAYCHANGE,0 AS RUN_ON_EVERYSTART FROM EXECHANGE  
		UNION  
		SELECT STATEMENT_ID ,STATEMENT_EXPR,0 AS RUN_ON_EXECHANGE,1 AS RUN_ON_DAYCHANGE,0 AS RUN_ON_EVERYSTART  FROM DAYCHANGE  
		UNION  
		SELECT STATEMENT_ID ,STATEMENT_EXPR,0 AS RUN_ON_EXECHANGE,0 AS RUN_ON_DAYCHANGE,1 AS RUN_ON_EVERYSTART   FROM EVERYSTART  
	)A

	UPDATE a set RUN_ON_DAYCHANGE=b.RUN_ON_DAYCHANGE,RUN_ON_EXECHANGE=b.RUN_ON_EXECHANGE,RUN_ON_EVERYSTART=b.RUN_ON_EVERYSTART,statement_expr=b.STATEMENT_EXPR
	FROM wz_maintainance_postmonitor_run A  
	JOIN #events B ON B.STATEMENT_ID=A.STATEMENT_ID  
	

	INSERT INTO wz_maintainance_postmonitor_run(STATEMENT_ID,STATEMENT_EXPR, RUN_ON_EXECHANGE,RUN_ON_DAYCHANGE,RUN_ON_EVERYSTART)  
	SELECT A.STATEMENT_ID,A.STATEMENT_EXPR, A.RUN_ON_EXECHANGE,A.RUN_ON_DAYCHANGE,A.RUN_ON_EVERYSTART  
	FROM #events A  
	LEFT OUTER JOIN wz_maintainance_postmonitor_run B ON B.STATEMENT_ID=A.STATEMENT_ID  
	WHERE B.STATEMENT_ID IS NULL  


	if object_id('master.dbo.cloud_dbinfo','u') is not null
		DELETE FROM #events WHERE statement_id=449 -- Automatic build of Complete sku names should not happen on Cloud clients

	---- Need to do this because some processes e.g. sp_synch_sku_purchase have been discarded & 
	---- its reference need to be removed from client's database	(05-02-2021)
	DELETE A FROM wz_maintainance_postmonitor_run A LEFT JOIN #events B on A.STATEMENT_ID=B.STATEMENT_ID
	where B.STATEMENT_ID IS NULL

	update a set RUN_ON_DAYCHANGE=0,RUN_ON_EVERYSTART=1
	FROM wz_maintainance_postmonitor_run a JOIN #events b ON a.STATEMENT_ID=b.STATEMENT_ID
	WHERE b.RUN_ON_EVERYSTART=1

	SELECT a.*,
	(CASE WHEN (A.RUN_ON_EXECHANGE=1 AND ISNULL(a.RUN_ON,'')<>b.LAST_UPDATE) OR
	    (A.RUN_ON_DAYCHANGE=1 AND ((DATEDIFF(d,ISNULL(a.RUN_ON,''),GETDATE() )<> 0 
		AND DATEPART(HH,GETDATE()) BETWEEN 0 AND 12) or a.RUN_ON IS NULL)) OR A.RUN_ON_EVERYSTART=1 THEN 1 
		 ELSE 0 END) AS RUN 
	FROM wz_maintainance_postmonitor_run a
	LEFT JOIN  exe_time b on 1=1
	ORDER BY a.STATEMENT_ID
	
	
END