create PROC [DBO].[SP3S_TRANSFER_TO_TRADING]          
(          
  @IMODE INT ,          
  @CWHERE VARCHAR(MAX)='',      
  @CAGENCYCODE CHAR(7)='',      
  @FINYEAR VARCHAR(10)=''  ,    
  @DEPTID VARCHAR(10)=''         
)      
----WITH ENCRYPTION
AS          
          
BEGIN          
     
	 
	 
declare @SHOW_PRODUCT_CODE_IN_PRD varchar(10)
select @SHOW_PRODUCT_CODE_IN_PRD=value  from config where config_option='SHOW_PRODUCT_CODE_IN_PRD'
     
		IF @IMODE =1         GOTO LBLLOOKUP          
		ELSE IF @IMODE =2    GOTO LBLMST          
		ELSE IF @IMODE =3	 GOTO LBLDET          		   
		ELSE IF @IMODE =4	 GOTO LBLDET_REF          		   
		ELSE IF @IMODE =5    GOTO LBLJOBS    
		ELSE IF @IMODE =6    GOTO LBLRM
    	ELSE				 GOTO LAST        
       
 DECLARE @CCMD NVARCHAR(MAX) 
 
    

LBLLOOKUP:        
    
  SELECT MEMO_ID FROM TRANSFER_TO_TRADING_MST (NOLOCK)    
  WHERE FIN_YEAR=@FINYEAR AND location_code =@CWHERE     
    
 GOTO LAST           
          
LBLMST:          
	SELECT A.*,	U.USERNAME AS [USER_NAME] --,B.AC_NAME
	FROM TRANSFER_TO_TRADING_MST A (NOLOCK)    
	--JOIN LM01106 B (NOLOCK) ON B.AC_CODE=A.AC_CODE
	LEFT OUTER JOIN USERS U (NOLOCK) ON U.USER_CODE = A.USER_CODE     
	WHERE A.MEMO_ID = @CWHERE             
       
 GOTO LAST           
           
LBLDET: 

   if @SHOW_PRODUCT_CODE_IN_PRD=1
   begin      

	SELECT CAST(0 AS BIT) AS CHKBILL, A.MEMO_NO,G.*,      
	ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
	PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
	CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,      
	SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
	P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
	PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
	ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
	ART.STOCK_NA,(0*G.QUANTITY) AS AMOUNT,ART.ALIAS AS ARTICLE_ALIAS,B.BIN_NAME,'' AS SP_ID,'' AS DEPT_ID,
	G.BIN_ID, A.REMARKS AS MST_REMARKS ,LM.AC_NAME,cast('' as varchar(50)) as jobcard_id,JPMT.Trading_Product_code,ISNULL(PMT01106.QUANTITY_IN_STOCK,0) AS [PMT_QUANTITY]
	FROM TRANSFER_TO_TRADING_MST A (NOLOCK)             
	JOIN TRANSFER_TO_TRADING_DET G (NOLOCK)  ON A.MEMO_ID = G.MEMO_ID                        
	JOIN SKU ON SKU.PRODUCT_CODE=G.PRODUCT_CODE
	JOIN ARTICLE ART ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE          
	JOIN SECTIOND SD ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
	JOIN SECTIONM SM ON SD.SECTION_CODE = SM.SECTION_CODE        
	JOIN PARA1 P1 ON SKU.PARA1_CODE = P1.PARA1_CODE          
	JOIN PARA2 P2 ON SKU.PARA2_CODE = P2.PARA2_CODE          
	JOIN PARA3 P3 ON SKU.PARA3_CODE = P3.PARA3_CODE          
	JOIN PARA4 P4 ON SKU.PARA4_CODE = P4.PARA4_CODE          
	JOIN PARA5 P5 ON SKU.PARA5_CODE = P5.PARA5_CODE          
	JOIN PARA6 P6 ON SKU.PARA6_CODE = P6.PARA6_CODE          
	JOIN UOM E ON ART.UOM_CODE = E.UOM_CODE 
	JOIN BIN B ON B.BIN_ID=G.BIN_ID 
	JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE = G.AC_CODE     
	LEFT OUTER JOIN JOBWORK_PMT JPMT (NOLOCK) ON JPMT.PRODUCT_CODE=G.product_code
	LEFT OUTER JOIN PMT01106 (NOLOCK) ON JPMT.Trading_Product_code=PMT01106.PRODUCT_CODE AND '000'= PMT01106.BIN_ID AND A.location_code = pmt01106 .DEPT_ID and isnull(PMT01106.bo_order_id,'')=''
	WHERE A.MEMO_ID = @CWHERE
	order by art.article_no ,p1.para1_name ,p2.para2_order 
	
	
	end  
	else
	begin

			

	  SELECT CAST(0 AS BIT) AS CHKBILL, A.MEMO_NO,
			G.MEMO_ID,G.ARTICLE_CODE,G.PARA1_CODE,G.PARA2_CODE,
			G.PARA3_CODE,G.PARA4_CODE,G.PARA5_CODE,g.PARA6_CODE,
			CAST('LIST' AS VARCHAR(10)) AS PRODUCT_CODE,
			G.BIN_ID, 0 AS SR_NO,
			CAST('LATER'+SKU.ARTICLE_CODE +SKU.PARA1_CODE +SKU.PARA2_CODE AS VARCHAR(40)) AS ROW_ID, getdate() LAST_UPDATE,
			SUM(G.QUANTITY) AS QUANTITY,
			g.PURCHASE_PRICE,g.MRP,g.WS_PRICE,AMOUNT,PRINT_LABEL,g.AC_CODE,
			OH_Cost_Percentage,OH_Cost_Amount,
			ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
			PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
			CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,      
			SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
			P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
			PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
			ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
			ART.STOCK_NA,0 AS AMOUNT,ART.ALIAS AS ARTICLE_ALIAS,B.BIN_NAME,'' AS SP_ID,'' AS DEPT_ID,
			G.BIN_ID, A.REMARKS AS MST_REMARKS ,LM.AC_NAME,cast('' as varchar(50)) as jobcard_id,
			g.ACTUAL_COST ,g.ARTICLE_PP ,JPMT.Trading_Product_code,SUM(ISNULL(PMT01106.QUANTITY_IN_STOCK,0)) AS [PMT_QUANTITY]
			FROM TRANSFER_TO_TRADING_MST A (NOLOCK)             
			JOIN TRANSFER_TO_TRADING_DET G (NOLOCK)  ON A.MEMO_ID = G.MEMO_ID                        
			JOIN SKU ON SKU.PRODUCT_CODE=G.PRODUCT_CODE
			JOIN ARTICLE ART ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE          
			JOIN SECTIOND SD ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
			JOIN SECTIONM SM ON SD.SECTION_CODE = SM.SECTION_CODE        
			JOIN PARA1 P1 ON SKU.PARA1_CODE = P1.PARA1_CODE          
			JOIN PARA2 P2 ON SKU.PARA2_CODE = P2.PARA2_CODE          
			JOIN PARA3 P3 ON SKU.PARA3_CODE = P3.PARA3_CODE          
			JOIN PARA4 P4 ON SKU.PARA4_CODE = P4.PARA4_CODE          
			JOIN PARA5 P5 ON SKU.PARA5_CODE = P5.PARA5_CODE          
			JOIN PARA6 P6 ON SKU.PARA6_CODE = P6.PARA6_CODE          
			JOIN UOM E ON ART.UOM_CODE = E.UOM_CODE 
			JOIN BIN B ON B.BIN_ID=G.BIN_ID 
			JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE = G.AC_CODE
			LEFT OUTER JOIN JOBWORK_PMT JPMT (NOLOCK) ON JPMT.PRODUCT_CODE=G.product_code
			LEFT OUTER JOIN PMT01106 (NOLOCK) ON JPMT.Trading_Product_code=PMT01106.PRODUCT_CODE AND '000'= PMT01106.BIN_ID AND A.location_code = pmt01106 .DEPT_ID and isnull(PMT01106.bo_order_id,'')=''
			WHERE A.MEMO_ID = @CWHERE      
			group by  A.MEMO_NO,G.MEMO_ID,G.ARTICLE_CODE,G.PARA1_CODE,G.PARA2_CODE,
			G.PARA3_CODE,G.PARA4_CODE,G.PARA5_CODE,g.PARA6_CODE,
			G.BIN_ID, g.PURCHASE_PRICE,g.MRP,g.WS_PRICE,AMOUNT,PRINT_LABEL,g.AC_CODE,
			OH_Cost_Percentage,OH_Cost_Amount,
			ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
			PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
			CODING_SCHEME,     SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
			P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
			PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) ,        
			ART.DT_CREATED ,P3.DT_CREATED ,SKU.DT_CREATED ,p2.para2_order ,        
			ART.STOCK_NA,ART.ALIAS ,B.BIN_NAME,G.BIN_ID, A.REMARKS ,LM.AC_NAME,
			CAST('LATER'+SKU.ARTICLE_CODE +SKU.PARA1_CODE +SKU.PARA2_CODE AS VARCHAR(40)),
			g.ACTUAL_COST ,g.ARTICLE_PP ,JPMT.Trading_Product_code
			order by art.article_no ,p1.para1_name ,p2.para2_order 


	end




	GOTO LAST  
LBLDET_REF:	
	SELECT CAST(0 AS BIT) AS CHKBILL, A.MEMO_NO,G.*,      
	ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
	PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
	CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,     
	SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
	P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
	PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
	ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
	ART.STOCK_NA,(0*G.QUANTITY) AS AMOUNT,ART.ALIAS AS ARTICLE_ALIAS,B.BIN_NAME,'' AS SP_ID,'' AS DEPT_ID,
	G.BIN_ID, A.REMARKS AS MST_REMARKS 
	FROM TRANSFER_TO_TRADING_MST A (NOLOCK)             
	JOIN TRANSFER_TO_TRADING_SUB_DET G (NOLOCK)  ON A.MEMO_ID = G.MEMO_ID                        
	JOIN SKU ON SKU.PRODUCT_CODE=G.PRODUCT_CODE
	JOIN ARTICLE ART ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE          
	JOIN SECTIOND SD ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
	JOIN SECTIONM SM ON SD.SECTION_CODE = SM.SECTION_CODE        
	JOIN PARA1 P1 ON SKU.PARA1_CODE = P1.PARA1_CODE          
	JOIN PARA2 P2 ON SKU.PARA2_CODE = P2.PARA2_CODE          
	JOIN PARA3 P3 ON SKU.PARA3_CODE = P3.PARA3_CODE          
	JOIN PARA4 P4 ON SKU.PARA4_CODE = P4.PARA4_CODE          
	JOIN PARA5 P5 ON SKU.PARA5_CODE = P5.PARA5_CODE          
	JOIN PARA6 P6 ON SKU.PARA6_CODE = P6.PARA6_CODE          
	JOIN UOM E ON ART.UOM_CODE = E.UOM_CODE 
	JOIN BIN B ON B.BIN_ID=G.BIN_ID      
	WHERE A.MEMO_ID = @CWHERE            
	GOTO LAST
         

 LBLJOBS:
    
    SELECT A.* ,JOBS.JOB_NAME 
    FROM TRANSFER_TO_TRADING_JOBS A (NOLOCK)
    JOIN JOBS (NOLOCK) ON A.JOB_CODE =JOBS.JOB_CODE 
    WHERE A.MEMO_ID =@CWHERE
 
 GOTO LAST
 
 LBLRM:
    
    SELECT A.* ,ART.ARTICLE_NO ,P1.PARA1_NAME ,P2.PARA2_NAME ,UOM .UOM_NAME
    FROM TRANSFER_TO_TRADING_BOM A (NOLOCK)
    JOIN ARTICLE ART (NOLOCK) ON A.ARTICLE_CODE = ART.ARTICLE_CODE               
	JOIN PARA1 P1 (NOLOCK) ON A.PARA1_CODE = P1.PARA1_CODE          
	JOIN PARA2 P2 (NOLOCK) ON A.PARA2_CODE = P2.PARA2_CODE  
	JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE   
    WHERE A.MEMO_ID =@CWHERE
 
 GOTO LAST
          
LAST:          
              
END
