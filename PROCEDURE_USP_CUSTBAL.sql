create PROCEDURE USP_CUSTBAL  
(  
@CUSTOMER_CODE VARCHAR(12),
@CCMID VARCHAR(40)=''  
)  
AS  
BEGIN  
       DECLARE @CREDIT_ISSUE_AMT NUMERIC(10,2),@CREDIT_NOTE_ISSUE_AMT NUMERIC(10,2),  
       @CREDIT_NOTE_AMT_ADJ NUMERIC(10,2),  
                  @ADAVANCE_AMT_ADJ NUMERIC(10,2),@ADAVANCE_AMT_ADJ1 NUMERIC(10,2),@ADAVANCE_AMT_ADJ2 NUMERIC(10,2),@CREDIT_REFUND_AMT NUMERIC(10,2),  
                  @RECEIPT_AMT NUMERIC(10,2), @PAYMENT_AMT NUMERIC(10,2),  
                  @CREDIT_AMT NUMERIC(10,2),@DEBIT_AMT NUMERIC(10,2),  
                  @AMOUNT NUMERIC(10,2),@CREDIT_NOTE_AMT_ADJ_ARC NUMERIC(10,2),@OPN_BALANCE NUMERIC(10,2)  ,@NORDERAMT NUMERIC(10,2),@NORDDLVAMT NUMERIC(10,2)
                    
                    
    SELECT @OPN_BALANCE=ISNULL(OPENING_BALANCE,0) FROM CUSTDYM WHERE  CUSTOMER_CODE=@CUSTOMER_CODE                   
                    
                    
       SELECT @CREDIT_ISSUE_AMT=ABS(ISNULL(SUM(B.AMOUNT),0)) FROM CMM01106 A JOIN PAYMODE_XN_DET B ON A.CM_ID=B.MEMO_ID  
           WHERE CANCELLED=0 AND PAYMODE_CODE='0000004' AND XN_TYPE='SLS' AND CUSTOMER_CODE=@CUSTOMER_CODE  
           AND SUBSTRING(A.CM_NO,5,1)<>'N'  
  
             
           SELECT @CREDIT_NOTE_ISSUE_AMT=ABS(ISNULL(SUM(B.AMOUNT),0)) FROM CMM01106 A   
           JOIN PAYMODE_XN_DET B ON A.CM_ID=B.MEMO_ID  
           WHERE CANCELLED=0 AND PAYMODE_CODE='0000004' AND XN_TYPE='SLS' AND CUSTOMER_CODE=@CUSTOMER_CODE  
           AND SUBSTRING(A.CM_NO,5,1)='N'  AND A.CM_ID<>@CCMID
            
             
       SELECT @CREDIT_NOTE_AMT_ADJ=ABS(ISNULL(SUM(B.AMOUNT),0)) FROM CMM01106 A JOIN PAYMODE_XN_DET B ON A.CM_ID=B.MEMO_ID  
       WHERE CANCELLED=0 AND PAYMODE_CODE='0000001'AND XN_TYPE='SLS' AND CUSTOMER_CODE=@CUSTOMER_CODE  
       AND A.CM_ID<>@CCMID     
       
       
       SELECT @CREDIT_NOTE_AMT_ADJ_ARC=ABS(ISNULL(SUM(B.AMOUNT),0)) FROM ARC01106 A JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID=B.MEMO_ID  
       WHERE CANCELLED=0 AND PAYMODE_CODE='0000001'AND XN_TYPE ='ARC' AND CUSTOMER_CODE=@CUSTOMER_CODE  
       AND ARC_TYPE<>2   
             
       SELECT @ADAVANCE_AMT_ADJ1=ABS(ISNULL(SUM(B.AMOUNT),0)) FROM CMM01106 A JOIN PAYMODE_XN_DET B ON A.CM_ID=B.MEMO_ID  
       WHERE CANCELLED=0 AND PAYMODE_CODE='0000002' AND XN_TYPE='SLS'AND CUSTOMER_CODE=@CUSTOMER_CODE  AND A.CM_ID<>@CCMID  

       SELECT @ADAVANCE_AMT_ADJ2=ABS(ISNULL(SUM(B.AMOUNT*(CASE WHEN ARC_TYPE=2 THEN -1 ELSE 1 END)),0)) FROM ARC01106 A JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID=B.MEMO_ID  
       WHERE CANCELLED=0 AND PAYMODE_CODE='0000002' AND XN_TYPE='ARC'AND CUSTOMER_CODE=@CUSTOMER_CODE  
       AND ARC_TYPE<>2
		
		SET @ADAVANCE_AMT_ADJ=@ADAVANCE_AMT_ADJ1+@ADAVANCE_AMT_ADJ2

       SELECT @CREDIT_REFUND_AMT=ABS(ISNULL(SUM(B.AMOUNT),0)) FROM CMM01106 A JOIN PAYMODE_XN_DET B ON A.CM_ID=B.MEMO_ID  
       WHERE CANCELLED=0 AND PAYMODE_CODE='CMR0001'AND XN_TYPE='SLS'AND CUSTOMER_CODE=@CUSTOMER_CODE  
       AND A.CM_ID<>@CCMID
             
             
       SELECT @RECEIPT_AMT=ABS(ISNULL(SUM(AMOUNT),0)) FROM ARC01106 WHERE CANCELLED=0 AND  ARC_TYPE=1 
       AND ARCT IN(1,2)
       AND CUSTOMER_CODE=@CUSTOMER_CODE  
       SELECT @PAYMENT_AMT=ABS(ISNULL(SUM(AMOUNT),0)) FROM ARC01106 WHERE CANCELLED=0 
       AND  ARC_TYPE=2 AND CUSTOMER_CODE=@CUSTOMER_CODE  
             

		SELECT @NORDERAMT=SUM(total_amount) FROM  WSL_ORDER_MST B 
		WHERE CUSTOMER_CODE=@CUSTOMER_CODE AND B.CANCELLED=0

		
		;with cte as
		(
		SELECT A.CM_ID,A.NET_AMOUNT,
			SR=ROW_NUMBER() OVER(PARTITION BY A.CM_ID ORDER BY B.ROW_ID)
		FROM CMM01106 A (NOLOCK) 
		JOIN CMD01106 B (NOLOCK) ON A.CM_ID=B.CM_ID
		JOIN WSL_ORDER_DET C (NOLOCK) ON B.PRODUCT_CODE=(CASE WHEN C.ORDER_TYPE=0 THEN C.PRODUCT_CODE ELSE C.REF_PRODUCT_CODE END)
		JOIN WSL_ORDER_MST D (NOLOCK) ON D.ORDER_ID=C.ORDER_ID AND A.CUSTOMER_CODE=D.CUSTOMER_CODE
		WHERE A.CANCELLED=0 AND D.CANCELLED=0 AND A.CM_ID<>@CCMID
		AND A.CUSTOMER_CODE=@CUSTOMER_CODE and NET_AMOUNT>0
		)

		SELECT @NORDDLVAMT=sum(net_amount) FROM CTE WHERE SR=1
	   
	   
	   declare @hbdamount numeric(10,2),@ocamount numeric(10,2)

	   SELECT @hbdamount=SUM(A.TOTAL_AMOUNT) 
	  FROM HOLD_BACK_DELIVER_MST A  
	  JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE 
	  WHERE A.TOTAL_AMOUNT <> 0  AND A.ENTRY_MODE =2 AND A.CANCELLED = 0  
	  AND A.CUSTOMER_CODE=@CUSTOMER_CODE 
	  
	    select @ocamount=SUM(A.AMOUNT)
	    FROM ARC01106 A  
		JOIN EMPLOYEE E ON A.EMP_CODE=E.EMP_CODE  
		JOIN CUSTDYM b ON A.CUSTOMER_CODE = b.CUSTOMER_CODE 
		JOIN HBD_RECEIPT HR (NOLOCK) ON HR.ADV_REC_ID =A.ADV_REC_ID 
		WHERE A.arc_type =1 and arct=3  AND A.CANCELLED =0 
		 AND A.CUSTOMER_CODE=@CUSTOMER_CODE 

	   
       SELECT @CREDIT_AMT=@CREDIT_NOTE_ISSUE_AMT+@CREDIT_REFUND_AMT+@RECEIPT_AMT+ISNULL(@NORDDLVAMT,0)  +ISNULL(@ocamount,0)
      
       SELECT @DEBIT_AMT=@CREDIT_ISSUE_AMT+@CREDIT_NOTE_AMT_ADJ+@ADAVANCE_AMT_ADJ+@PAYMENT_AMT+@CREDIT_NOTE_AMT_ADJ_ARC+@OPN_BALANCE +ISNULL(@NORDERAMT,0) +isnull(@hbdamount,0)
        
    
    
		--SELECT @CREDIT_NOTE_ISSUE_AMT,@CREDIT_REFUND_AMT,@RECEIPT_AMT,@CREDIT_ISSUE_AMT,@CREDIT_NOTE_AMT_ADJ,@ADAVANCE_AMT_ADJ,@PAYMENT_AMT,@CREDIT_NOTE_AMT_ADJ_ARC,
		--@OPN_BALANCE,@NORDERAMT,@NORDDLVAMT
          
       SELECT (@DEBIT_AMT-@CREDIT_AMT) AS CLOSING_BALANCE  
   
      
END
