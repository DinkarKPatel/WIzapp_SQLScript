CREATE PROCEDURE SP3S_NEWSEIRES_SETUP
@CMEMOID VARCHAR(40)
AS
BEGIN
	
	DECLARE @CTABLENAME VARCHAR(300),@CKEYSTABLE VARCHAR(300),@CCOLUMNNAME VARCHAR(300),
			@CXNTYPESEARCH VARCHAR(10),@CSOURCELOCID VARCHAR(5),@CCMD NVARCHAR(MAX)
	
	SELECT TOP 1 @CXNTYPESEARCH=XN_TYPE,@CSOURCELOCID=DEPT_ID FROM SERIES_SETUP_MST WHERE MEMO_ID=@CMEMOID
	
	
	SET @CTABLENAME =	 ( CASE WHEN  @CXNTYPESEARCH LIKE '%PUR%' THEN 'PIM01106' 	
							 WHEN @CXNTYPESEARCH LIKE '%PRT%' THEN 'RMM01106'
							 WHEN @CXNTYPESEARCH LIKE '%WSL%' THEN 'INM01106'
							 WHEN @CXNTYPESEARCH LIKE '%WSR%' THEN 'CNM01106' END)

	
	SET @CKEYSTABLE =	  ( CASE WHEN  @CXNTYPESEARCH LIKE '%PUR%' THEN 'KEYS_PUR' 	
							 WHEN @CXNTYPESEARCH LIKE '%PRT%' THEN 'KEYS_PRT'
							 WHEN @CXNTYPESEARCH LIKE '%WSL%' THEN 'KEYS_INM'
							 WHEN @CXNTYPESEARCH LIKE '%WSR%' THEN 'KEYS_CNM' END )

	SET @CCOLUMNNAME =	  ( CASE WHEN  @CXNTYPESEARCH LIKE '%PUR%' THEN 'MRR_NO' 	
							 WHEN @CXNTYPESEARCH LIKE '%PRT%' THEN 'RM_NO'
							 WHEN @CXNTYPESEARCH LIKE '%WSL%' THEN 'INV_NO'
							 WHEN @CXNTYPESEARCH LIKE '%WSR%' THEN 'CN_NO' END )
	
	IF OBJECT_ID('TEMPDB..#TMPSERIESSETUP','U') IS NOT NULL
		DROP TABLE #TMPSERIESSETUP
	
	SELECT CONVERT(BIT,1) AS ALLOW_CHANGE,A.*,PREFIX AS SEARCH_PREFIX INTO #TMPSERIESSETUP FROM SERIES_SETUP_MANUAL_DET A 
	WHERE MEMO_ID=@CMEMOID
	
	UPDATE #TMPSERIESSETUP SET SEARCH_PREFIX=@CSOURCELOCID+PREFIX 
	
	UPDATE #TMPSERIESSETUP SET SEARCH_PREFIX=SEARCH_PREFIX+'-' WHERE RIGHT(SEARCH_PREFIX,1)<>'-'
	
	IF OBJECT_ID('TEMPDB..#KEYS','U') IS NOT NULL
		DROP TABLE #KEYS
	 
	SELECT TABLENAME,COLUMNNAME, PREFIX INTO #KEYS
	FROM KEYS WHERE 1=2
	 
	SET @CCMD=N'SELECT '''+@CTABLENAME+''' AS TABLENAME,'''+@CCOLUMNNAME+''' AS COLUMNNAME,SEARCH_PREFIX
				FROM #TMPSERIESSETUP'
	
	PRINT @CCMD 
	INSERT #KEYS	( TABLENAME, COLUMNNAME, PREFIX) 			 			   
	EXEC SP_EXECUTESQL @CCMD 
	
	SET @CCMD=N'UPDATE A SET ALLOW_CHANGE=0 FROM #TMPSERIESSETUP A
			    JOIN #KEYS B ON  A.SEARCH_PREFIX=B.PREFIX
			    JOIN '+@CKEYSTABLE+' C ON B.TABLENAME=C.TABLENAME AND B.COLUMNNAME=C.COLUMNNAME AND C.PREFIX=B.PREFIX'
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD 
	
	SELECT * FROM #TMPSERIESSETUP
END
