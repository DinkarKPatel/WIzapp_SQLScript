CREATE PROCEDURE SP_SEND_MIRROR_MSTATTR_NEW--(LocId 3 digit change by Sanjay:06-11-2024)
(
 @CTARGETLOCID VARCHAR(5)
)
AS
 BEGIN
   DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION NVARCHAR(MAX)
           ,@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPLMTABLE VARCHAR(100)
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CCURDEPTID VARCHAR(5)
           ,@CHODEPTID VARCHAR(5),@CERRORMSG VARCHAR(MAX),@CREPLOCTABLE VARCHAR(500),@NLOCTYPE INT
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(4),@JOINMASTERTABLE VARCHAR(200),@JOINTEMPTABLE VARCHAR(200)
           , @JOINMASTERTABLE1 VARCHAR(MAX), @JOINTEMPTABLE1 VARCHAR(MAX)
    DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),ERRMSG VARCHAR(MAX)) 
    
    BEGIN TRY
    
	SET @CSTEP=0

	SET @CTEMPDBNAME = ''
	 
	SET @CSTEP=00
	 
	SET @CSTEP=10
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	SET @CFILTERCONDITION=''
	 
	SET @CSTEP=20

	SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
	
	SELECT @NLOCTYPE=LOC_TYPE FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	
	IF @CCURDEPTID<>@CHODEPTID
	BEGIN
		SELECT '' AS LAST_UPDATE,'' AS ERRMSG
		
		GOTO END_PROC
	END		
 
	
	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=40
    ---SELECT DATA FROM PRD_AGENCY_MST TABLE


    SELECT 	DISTINCT 'MSTATTR_SD_ATTR_AVATAR_MIRROR' AS TARGET_TABLENAME,A.* FROM SD_ATTR_AVATAR A (NOLOCK)

	

    SELECT 	DISTINCT 'MSTATTR_SECTIOND_MIRROR' AS TARGET_TABLENAME,A.* FROM SECTIOND A (NOLOCK)
	JOIN SD_ATTR_AVATAR B (NOLOCK) ON A.sub_section_code =B.SUB_SECTION_CODE 
 
 

    SELECT 	DISTINCT 'MSTATTR_SECTIONM_MIRROR' AS TARGET_TABLENAME,A.* FROM SECTIONM A (NOLOCK)
	JOIN SECTIOND SD (NOLOCK) ON A.section_code =SD.section_code
	JOIN SD_ATTR_AVATAR B (NOLOCK) ON sd.sub_section_code =B.SUB_SECTION_CODE 
    
	
     
 DECLARE @NCOUNT INT,@BLOOP INT,@CCMD NVARCHAR(MAX)  
 SET @NCOUNT=25  
 SET @BLOOP=1  
 WHILE (@BLOOP <=@NCOUNT )  
 BEGIN  
         
       
   SET @CCMD=N' IF EXISTS(SELECT  TOP 1 ''U''  
   FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)  
   WHERE 
   ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000'' )  
    SELECT  DISTINCT ''MSTATTR_ATTR'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_MST_MIRROR'' AS TARGET_TABLENAME,ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.*   
    FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)  
    WHERE ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000'' '  
      
     PRINT  @CCMD  
     EXEC SP_EXECUTESQL @CCMD  
     SET @BLOOP=@BLOOP +1  
     
 END  


	
	END TRY
	
	BEGIN CATCH
	    SET @CERRORMSG='P: SP_SEND_MIRROR_MSTATTR_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()+ 'ERROR QUERY || '+@DTSQL
	    GOTO END_PROC
    END CATCH 
    
    END_PROC:
    
    SELECT  ISNULL(@CERRORMSG,'') AS ERRMSG
 END
