create PROCEDURE SP3S_JOBWORKISSUEPRINT
(
 @CISSUEID VARCHAR(50)=''
)
AS
BEGIN
     
	 DECLARE @BWIPJOBWORK BIT ,@DTsql nvarchar(max),@cimgdbname varchar(100)
	 SET @BWIPJOBWORK=0

	 SET @cimgdbname=db_name()+'_image'
   
   IF EXISTS ( SELECT TOP 1 'U' FROM JOBWORK_ISSUE_MST A WHERE ISSUE_ID=@CISSUEID AND  WIP=1 AND ISNULL(A.ISSUE_MODE,0)=0)
      SET @BWIPJOBWORK=1

IF @BWIPJOBWORK=0
BEGIN

  SET @DTSQL=N' SELECT A.ISSUE_ID,G.PRODUCT_CODE,G.JOB_RATE,G.QUANTITY,G.ROW_ID,A.CANCELLED,A.ISSUE_NO,A.ISSUE_DT,
	A.TOTAL_AMOUNT ,F.JOB_NAME,A.NON_RECEIVABLE,
	ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,  
	PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,     
	CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,SKU.PURCHASE_PRICE,
	SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,  
	P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,  
	PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],  
	ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],  
	ART.STOCK_NA,D.AGENCY_NAME,D.AGENCY_CODE ,A.REMARKS AS MST_REMARKS,G.REMARKS AS REMARKS_DET
	,ART.DT_CREATED,'''' AS ADDRESS ,G.DUE_DT ,G.REF_NO, A.ISSUE_TYPE,LM.* ,
	'''' AS PICT_PATH ,
    ISNULL(REF.REF_NO,'''') AS BUYER_REF_NO,
    G.HSN_CODE AS JWI_HSN_CODE,
    G.PURCHASE_PRICE AS JWI_PURCHASE_PRICE ,
    G.GST_PERCENTAGE AS JWI_GST_PERCENTAGE,
    G.IGST_AMOUNT AS JWI_IGST_AMOUNT ,
    G.CGST_AMOUNT AS JWI_CGST_AMOUNT,
    G.SGST_AMOUNT AS JWI_SGST_AMOUNT,
    G.XN_VALUE_WITHOUT_GST AS JWI_XN_VALUE_WITHOUT_GST,
    G.XN_VALUE_WITH_GST AS JWI_XN_VALUE_WITH_GST
    ,LM.ADDRESS0+''-''+LM.ADDRESS1+''-''+ LM.ADDRESS2+''-''+LM.CITY+''-''+ LM.AREA_NAME+''-''+ LM.STATE+''-''+LM.PINCODE+''-''+''GST NO:''+AC_GST_NO AS AGENCY_ADDRESS
    ,P2.PARA2_ORDER,ISNULL(DM.DESIGN_NO,'''') AS DESIGN_NO
	,REF.JOBCARD_NO,REF.JOBCARD_DT
	,PLM.AC_NAME AS PUR_AC_NAME,IMAGE.PROD_IMAGE
	FROM JOBWORK_ISSUE_MST A (NOLOCK)       
	JOIN JOBWORK_ISSUE_DET G (NOLOCK)  ON A.ISSUE_ID = G.ISSUE_ID 
  	JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=G.PRODUCT_CODE
	JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE    
	JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE  
	JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE  
	JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE    
	JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE    
	JOIN PARA3 P3 (NOLOCK)ON SKU.PARA3_CODE = P3.PARA3_CODE    
	JOIN PARA4 P4 (NOLOCK)ON SKU.PARA4_CODE = P4.PARA4_CODE    
	JOIN PARA5 P5 (NOLOCK)ON SKU.PARA5_CODE = P5.PARA5_CODE    
    JOIN PARA6 P6 (NOLOCK)ON SKU.PARA6_CODE = P6.PARA6_CODE    
    LEFT JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE --15 MAR 2018 JOIN TO LEFT JOIN
    LEFT JOIN JOBS F (NOLOCK) ON F.JOB_CODE = G.JOB_CODE --15 MAR 2018 JOIN TO LEFT JOIN        
    JOIN PRD_AGENCY_MST D (NOLOCK) ON A.AGENCY_CODE = D.AGENCY_CODE  
    JOIN LMV01106 LM (NOLOCK) ON LM.AC_CODE=D.AC_CODE
    LEFT JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION=''ART_PICT_PATH'')PIC ON 1=1 --15 MAR 2018 JOIN TO LEFT JOIN
    LEFT JOIN VW_BUYER_REF_NO REF ON REF.PRODUCT_CODE=G.PRODUCT_CODE
	LEFT JOIN DESIGNM DM (NOLOCK) ON DM.DESIGN_CODE =G.DESIGN_CODE
    LEFT JOIN LM01106 PLM (NOLOCK) ON PLM.AC_CODE =SKU.AC_CODE 
	LEFT JOIN (select product_code,barcode_img_id from SKU_NAMES SN (NOLOCK) ) sn ON SN.PRODUCT_CODE=G.PRODUCT_CODE	
	LEFT JOIN '+@CIMGDBNAME+'.DBO.IMAGE_INFO IMAGE ON IMAGE.IMG_ID=SN.BARCODE_IMG_ID
	WHERE (WIP=0 OR ISNULL(ISSUE_MODE,0)<>0) 
	and a.issue_id='''+@CISSUEID+'''     	ORDER BY art.article_no ,p1.para1_name ,p2.para2_order '
	print @DTSQL
	Exec sp_executesql @DTSQL

END
ELSE 
BEGIN
	 SELECT A.ISSUE_ID,G.PRODUCT_CODE,G.JOB_RATE,G.QUANTITY,G.ROW_ID,A.CANCELLED,A.ISSUE_NO,A.ISSUE_DT,
	A.TOTAL_AMOUNT ,F.JOB_NAME,A.NON_RECEIVABLE,
	ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,  
	PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,     
	CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,0 PURCHASE_PRICE,
	0 MRP,0 WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,  
	P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,  
	PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],  
	ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],'' AS [SKU_DT_CREATED],  
	ART.STOCK_NA,D.AGENCY_NAME,D.AGENCY_CODE ,A.REMARKS AS MST_REMARKS,G.REMARKS AS REMARKS_DET
	,ART.DT_CREATED,'' AS ADDRESS ,G.DUE_DT ,G.REF_NO, A.ISSUE_TYPE,LM.* ,
	CAST(VALUE+''+IMAGE_SUBFOLDER+'\'+ART.ARTICLE_NO+'.JPG' AS VARCHAR(1000)) AS PICT_PATH ,
    ISNULL(REF.REF_NO,'') AS BUYER_REF_NO,
    G.HSN_CODE AS JWI_HSN_CODE,
    G.PURCHASE_PRICE AS JWI_PURCHASE_PRICE ,
    G.GST_PERCENTAGE AS JWI_GST_PERCENTAGE,
    G.IGST_AMOUNT AS JWI_IGST_AMOUNT ,
    G.CGST_AMOUNT AS JWI_CGST_AMOUNT,
    G.SGST_AMOUNT AS JWI_SGST_AMOUNT,
    G.XN_VALUE_WITHOUT_GST AS JWI_XN_VALUE_WITHOUT_GST,
    G.XN_VALUE_WITH_GST AS JWI_XN_VALUE_WITH_GST
    ,LM.ADDRESS0+'-'+LM.ADDRESS1+'-'+ LM.ADDRESS2+'-'+LM.CITY+'-'+ LM.AREA_NAME+'-'+ LM.STATE+'-'+LM.PINCODE+'-'+'GST NO:'+AC_GST_NO AS AGENCY_ADDRESS
    ,P2.PARA2_ORDER,ISNULL(DM.DESIGN_NO,'') AS DESIGN_NO,'' AS JOBCARD_NO ,'' AS JOBCARD_DT ,
	'' AS PUR_AC_NAME
	FROM JOBWORK_ISSUE_MST A (NOLOCK)       
	JOIN JOBWORK_ISSUE_DET G (NOLOCK)  ON A.ISSUE_ID = G.ISSUE_ID 
  	JOIN WIP_PMT SKU (NOLOCK) ON SKU.PRODUCT_CODE=G.PRODUCT_CODE
	JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE    
	JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE  
	JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE  
	JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE    
	JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE    
	JOIN PARA3 P3 (NOLOCK)ON SKU.PARA3_CODE = P3.PARA3_CODE    
	JOIN PARA4 P4 (NOLOCK)ON SKU.PARA4_CODE = P4.PARA4_CODE    
	JOIN PARA5 P5 (NOLOCK)ON SKU.PARA5_CODE = P5.PARA5_CODE    
    JOIN PARA6 P6 (NOLOCK)ON SKU.PARA6_CODE = P6.PARA6_CODE    
    LEFT JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE --15 MAR 2018 JOIN TO LEFT JOIN
    LEFT JOIN JOBS F (NOLOCK) ON F.JOB_CODE = G.JOB_CODE --15 MAR 2018 JOIN TO LEFT JOIN        
    JOIN PRD_AGENCY_MST D (NOLOCK) ON A.AGENCY_CODE = D.AGENCY_CODE  
    JOIN LMV01106 LM (NOLOCK) ON LM.AC_CODE=D.AC_CODE
    LEFT JOIN IMAGE_INFO IMG (NOLOCK) ON IMG.ARTICLE_CODE=ART.ARTICLE_CODE
    LEFT JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='ART_PICT_PATH')PIC ON 1=1 --15 MAR 2018 JOIN TO LEFT JOIN
    LEFT JOIN VW_BUYER_REF_NO REF ON REF.PRODUCT_CODE=G.PRODUCT_CODE
	LEFT JOIN DESIGNM DM (NOLOCK) ON DM.DESIGN_CODE =G.DESIGN_CODE
	WHERE WIP=1 AND ISNULL(A.ISSUE_MODE,0)=0  	
	and a.issue_id=@CISSUEID
	
	ORDER BY art.article_no ,p1.para1_name ,p2.para2_order

END


END



