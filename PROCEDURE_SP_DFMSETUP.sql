CREATE PROCEDURE SP_DFMSETUP
(
	@NQUERYID	INT
)	
AS
BEGIN
	IF @NQUERYID=1
		GOTO DFM_XNTYPE
	ELSE IF @NQUERYID=2
		GOTO FIXEDFREEZE
	ELSE IF @NQUERYID=3
		GOTO ROLLINGFREEZE
	
	FIXEDFREEZE:
		SELECT A.XN_TYPE,A.XN_DESC,CAST(ISNULL(ISENABLED,0) AS BIT) AS [ISENABLED],
		CAST(ISNULL(USER_CODE,'0000000') AS VARCHAR(10)) AS [USER_CODE],
		CAST(ISNULL(FIXEDDATE,GETDATE()) AS DATETIME) AS [FIXEDDATE] 
        FROM DFM_XNTYPE A (NOLOCK)
        LEFT OUTER JOIN FIXEDFREEZE B (NOLOCK) ON B.XN_TYPE=A.XN_TYPE
        ORDER BY A.XN_DESC
		GOTO ENDPROC		
		
	ROLLINGFREEZE:
		SELECT URM.ROLE_ID AS ROLE_ID,ROLE_NAME AS ROLENAME,DFM.XN_TYPE,
        CONVERT(BIT,(CASE WHEN ISNULL(XFD.ROLE_ID,'')='' THEN 0 ELSE 1 END)) AS ALLOWROLE,
        ISNULL(FREEZEDAYS,0) AS FREEZEDAYS,ISNULL(ALLOWREAD,0) AS ALLOWREAD,
        ROW_NUMBER()OVER ( ORDER BY DFM.XN_TYPE,URM.ROLE_ID)AS ROW_ID ,DFM.DISPLAY_FORM_NAME
        FROM USER_ROLE_MST AS URM (NOLOCK)
        JOIN 
        (
			SELECT B.XN_TYPE,B.XN_DESC AS DISPLAY_FORM_NAME 
            FROM DFM_XNTYPE B (NOLOCK) 
            --SELECT A.FORM_NAME AS XN_TYPE,B.XN_DESC AS DISPLAY_FORM_NAME 
            --FROM (SELECT FORM_NAME FROM USER_ROLE_DET (NOLOCK) WHERE ROLE_ID='0000000' GROUP BY FORM_NAME)A
            --JOIN DFM_XNTYPE B (NOLOCK) ON B.XN_TYPE=A.FORM_NAME

        )DFM ON 1=1 
        LEFT OUTER JOIN ROLLINGFREEZE AS XFD (NOLOCK) ON URM.ROLE_ID=XFD.ROLE_ID AND XFD.XN_TYPE=DFM.XN_TYPE
        ORDER BY DFM.DISPLAY_FORM_NAME,ROLE_NAME
		GOTO ENDPROC		
		
	DFM_XNTYPE:
		SELECT B.XN_TYPE,B.XN_DESC AS DISPLAY_FORM_NAME 
        FROM DFM_XNTYPE B (NOLOCK) 
		--SELECT A.FORM_NAME AS XN_TYPE,B.XN_DESC AS DISPLAY_FORM_NAME 
  --      FROM (SELECT FORM_NAME FROM USER_ROLE_DET (NOLOCK) WHERE ROLE_ID='0000000' GROUP BY FORM_NAME)A
  --      JOIN DFM_XNTYPE B (NOLOCK) ON B.XN_TYPE=A.FORM_NAME
        --SELECT A.FORM_NAME AS XN_TYPE,A.DISPLAY_FORM_NAME 
        --FROM USER_ROLE_DET A (NOLOCK)
        --JOIN DFM_XNTYPE B (NOLOCK) ON B.XN_TYPE=A.FORM_NAME
        --WHERE ROLE_ID='0000000' AND A.DISPLAY_FORM_NAME NOT IN ('CREATE ONLINE PARAS')
        --GROUP BY FORM_NAME,DISPLAY_FORM_NAME
        ORDER BY B.XN_DESC
		
		GOTO ENDPROC		

	ENDPROC:

END
