create PROCEDURE SP_GETMASTERS        
 @CFINYEAR VARCHAR(10),         
 @NFILEFORMAT NUMERIC(2,0)=1,  
 @CERRORMSG VARCHAR(MAX) OUTPUT ,  
 @CAC_CODE VARCHAR(100)=''  ,  
 @NIMPORTFROM INT=1,--1 FOR ALL 2 FOR MAST IMPORT   
 @cdept_id varchar(4)='',
 @nSpId varchar(40)='',
 @NMEMOTYPE NUMERIC(1,0)=1,
 @cSrcUploadTable VARCHAR(200)=''
AS        
BEGIN        
  
  
--(dinkar) Replace  left(memoid,2) to Location_code 
  
 DECLARE @DONOTUPDATEMASTERS_DEPRECIATION VARCHAR(50)
 SELECT @DONOTUPDATEMASTERS_DEPRECIATION=VALUE  FROM config WHERE config_option ='DONOTUPDATEMASTERS_DEPRECIATION'--ON LY DEPRECIATION HAS TO BE ENTER SUVIDHA DONOT OVERWRITE MASTER 

  
  INSERT IMPORT_INFO VALUES (0,GETDATE())    
       
  PRINT 'IMPORT MASTERS-START0'    
  
  BEGIN TRY      
    
   PRINT 'IMPORT MASTERS-START'    
   
   declare @NSTEP varchar(10)   
   set @nStep=30.5
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        

   INSERT IMPORT_INFO VALUES (0.2,GETDATE())     
   DECLARE @UPDATEVALUE NUMERIC(10,0),@UPDATEVALUE1 NUMERIC(10,0),@UPDATEVALUE2 NUMERIC(10,0),@CMES VARCHAR(500),        
     @CATTRCODE1 VARCHAR(10),@CATTRCODE2 VARCHAR(10),@CCMD NVARCHAR(MAX),@CATTRNAME VARCHAR(100),        
     @CCOLNAME VARCHAR(1000),@CFORMATFILE VARCHAR(100),@CTMPTABLENAME VARCHAR(1000),@CARTICLENOCOL VARCHAR(100),        
     @DCURDT DATETIME,@CLOCID  CHAR(2)  ,@BLOOP BIT, @BCODING_SCHEME CHAR(2)  ,@COVERWRITE VARCHAR(2),  
     @CERPINTEGRATIONENABLED VARCHAR(2) ,@chodept_id varchar(2) ,@PICK_CODING_SCHEME_FROM_IMPORTFILE varchar(5)
         
   set @nStep=30.10
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        
    
    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())         
  --  SELECT TOP 1 @BCODING_SCHEME=value  FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='CODING_SCHEME' 
    SET @BCODING_SCHEME=1 --AS PER SIR (FIRST PICK EXCEL BARCODE CODING DCHEME OTHER WISE FIX)

	--SELECT @PICK_CODING_SCHEME_FROM_IMPORTFILE=value FROM CONFIG WHERE CONFIG_OPTION ='PICK_CODING_SCHEME_FROM_IMPORTFILE'

    SELECT  @COVERWRITE = VALUE FROM CONFIG WHERE CONFIG_OPTION = 'OVERWRITE_MASTERS_IN_FILE_IMPORT'
  
    SELECT  TOP 1 @CERPINTEGRATIONENABLED = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION = 'ENABLE_ERP_INTEGRATION'  
	
    SET @BCODING_SCHEME=ISNULL(@BCODING_SCHEME,0)
	--after discuss with sanjiv sir always pick coding scheme from excel sheet(31072024)
	--if isnull(@PICK_CODING_SCHEME_FROM_IMPORTFILE,'')<>'1'
	--begin

	--    UPDATE #TMPMASTERSENC SET CODING_SCHEME=1 WHERE PRODUCT_CODE<>'' and CODING_SCHEME<>1

	--end


      
    SET @COVERWRITE=ISNULL(@COVERWRITE,'')  
     
   set @nStep=30.20
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())  
    
   SET @CERRORMSG = ''       
   SET @CFORMATFILE = (CASE WHEN @NFILEFORMAT=1 THEN 'TMPEXCELDATA' ELSE 'TMPDBFDATA' END)        
   SET @CARTICLENOCOL = (CASE WHEN @NFILEFORMAT=1 THEN 'F3' ELSE 'ARTICLENO' END)        
          
   IF @CDEPT_ID=''     
      SELECT TOP 1 @CLOCID = DEPT_ID FROM NEW_APP_LOGIN_INFO (NOLOCK) WHERE SPID=@@SPID    
   ELSE
      SET @CLOCID=@CDEPT_ID   
   
   	IF ISNULL(@CLOCID,'')=''
	 BEGIN
		SET @CERRORMSG =' LOCATION ID CAN NOT BE BLANK  '  
		GOTO END_PROC    
	 END     


	 SELECT @CHODEPT_ID=VALUE  FROM CONFIG WHERE CONFIG_OPTION ='HO_LOCATION_ID'
	 
          
   SET @DCURDT = GETDATE()    

   
   
   set @nStep=30.25
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	            
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())  
    
         
   set @nStep=30.30
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	         
   

   IF EXISTS (SELECT TOP 1 'U' FROM   #TMPMASTERSENC A
   JOIN HSN_MST B (NOLOCK) ON A.HSN_CODE=B.HSN_CODE 
   WHERE B.INACTIVE =1)
   BEGIN
      SET @CERRORMSG =' INACTIVE HSN CODE FOUND PLEASE CHECK  '  
	  GOTO END_PROC   

   END
   
   IF ISNULL(@DONOTUPDATEMASTERS_DEPRECIATION,'')<>'1'
   BEGIN   
		UPDATE A   SET HSN_CODE=B.HSN_CODE FROM SKU A (nolock)
		JOIN #TMPMASTERSENC B   ON A.PRODUCT_CODE=B.PRODUCT_CODE   WHERE ISNULL(B.HSN_CODE,'')<>''  
		AND a.product_code<>'' and a.hsn_code <>b.hsn_code 
   END
    --HSN_CODE IS NOT SKU_NAMES, HENCE NOT INSERTING IN ##GEN_BARCODES
    
	   set @nStep=30.35
    EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	          
    UPDATE A WITH (ROWLOCK) SET HSN_CODE=B.HSN_CODE FROM ARTICLE A  
	JOIN #TMPMASTERSENC B   ON  LTRIM(RTRIM(A.ARTICLE_NO))=LTRIM(RTRIM(B.ARTICLE_NO))   
    WHERE ISNULL(B.HSN_CODE,'')<>'' AND ISNULL(a.hsn_code,'')<>ISNULL(b.hsn_code,'')

   set @nStep=30.40
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	                 
      INSERT HSN_MST ( HSN_CODE, TAXABLE_ITEM, HSN_TYPE, GST_VARIATION, GST_CAL_BASIS )    
      SELECT DISTINCT   A.HSN_CODE, 1 AS TAXABLE_ITEM,1 AS  HSN_TYPE,0 AS  GST_VARIATION, 1 AS GST_CAL_BASIS   
      FROM #TMPMASTERSENC A  
      LEFT OUTER JOIN HSN_MST B (NOLOCK) ON A.HSN_CODE=B.HSN_CODE  
      WHERE ISNULL(A.HSN_CODE,'')<>'' AND  B.HSN_CODE IS NULL  
  
 
   set @nStep=30.42
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())  
      
       UPDATE A SET SUB_SECTION_ALIAS=ISNULL(B.ALIAS,'') FROM #TMPMASTERSENC A JOIN SECTIOND B 
	   WITH (INDEX=ix_sectiond_sub_section_name,rowlOCK)  
       ON LTRIM(RTRIM(A.SUB_SECTION_NAME))=LTRIM(RTRIM(B.SUB_SECTION_NAME))   
       WHERE ISNULL(A.SUB_SECTION_ALIAS,'')=''  
         
   set @nStep=30.45
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        
       UPDATE A SET SECTION_ALIAS=ISNULL(B.ALIAS,'') FROM #TMPMASTERSENC A JOIN SECTIONM B WITH (INDEX=ix_sectionm_section_name,NOLOCK)  
       ON LTRIM(RTRIM(A.SECTION_NAME))=LTRIM(RTRIM(B.SECTION_NAME))   
       WHERE ISNULL(A.SECTION_ALIAS,'')=''  
      
   set @nStep=30.50
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())  

	   DECLARE @DO_NOT_CREATE_SECTION VARCHAR(10)  
	   SELECT TOP 1 @DO_NOT_CREATE_SECTION=VALUE  FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION ='DO_NOT_CREATE_SECTION_MASTERS_IN_FILE_IMPORT'  
         
       IF ISNULL(@DO_NOT_CREATE_SECTION,'')<>'1'
		   UPDATE A SET ALIAS=ISNULL(B.SECTION_ALIAS,'') FROM SECTIONM A JOIN #TMPMASTERSENC B   
		   ON LTRIM(RTRIM(A.SECTION_NAME))=LTRIM(RTRIM(B.SECTION_NAME))   
		   WHERE B.SECTION_ALIAS IS NOT NULL  
         

             
   set @nStep=30.55
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        
	   DECLARE @DO_NOT_CREATE_SUB_SECTION VARCHAR(10)  
	   SELECT TOP 1 @DO_NOT_CREATE_SUB_SECTION=VALUE  FROM CONFIG WHERE CONFIG_OPTION ='DO_NOT_CREATE_SUB_SECTION_MASTERS_IN_FILE_IMPORT'  
	   
       IF ISNULL(@DO_NOT_CREATE_SUB_SECTION,'')<>'1'
		   UPDATE A WITH (ROWLOCK) SET ALIAS=ISNULL(B.SUB_SECTION_ALIAS,'') 
		   FROM SECTIOND A 
		   JOIN #TMPMASTERSENC B   ON LTRIM(RTRIM(A.SUB_SECTION_NAME))=LTRIM(RTRIM(B.SUB_SECTION_NAME))   
		   WHERE B.SUB_SECTION_ALIAS IS NOT NULL  
         
         
     
   
   set @nStep=30.57
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	          
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())       
   SELECT DISTINCT CONVERT(CHAR(7),'') AS SECTION_CODE,LTRIM(RTRIM(SECTION_NAME)) AS SECTION_NAME,'   ' AS ALIAS    
   INTO #TMPSECTIONM   
   FROM #TMPMASTERSENC        
   WHERE LTRIM(RTRIM(SECTION_NAME)) NOT IN (SELECT LTRIM(RTRIM(SECTION_NAME)) FROM SECTIONM (NOLOCK))        
     
   DECLARE @CNEWSM VARCHAR(200),@CNEWSD VARCHAR(500)  
   IF EXISTS (SELECT TOP 1 SECTION_CODE FROM #TMPSECTIONM)  AND ISNULL(@CERPINTEGRATIONENABLED,'')<>'1' AND ISNULL(@DO_NOT_CREATE_SECTION,'')='1'     
   BEGIN  
	  SELECT TOP 1 @CNEWSM=SECTION_NAME FROM #TMPSECTIONM  
	    
	  SET @CERRORMSG='NEW SECTION :'+@CNEWSM+' NOT FOUND IN MASTERS'  
	  GOTO END_PROC  
   END  
               
   SET @DCURDT = GETDATE()          
   ----PRINT 'INSERTING SUB SECTIONS...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) ) +'SECONDS ...'        
          
      set @nStep=30.60
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                
          
   SELECT DISTINCT CONVERT(CHAR(7),'') AS SUB_SECTION_CODE
   ,RTRIM(LTRIM(M.SECTION_NAME)) AS SECTION_NAME
   ,LTRIM(RTRIM(M.SUB_SECTION_NAME)) AS SUB_SECTION_NAME
   ,'' AS ALIAS,0 AS TAX        
   INTO #TMPSUB_SECTIONM   
   FROM #TMPMASTERSENC M
   LEFT JOIN SECTIOND A WITH (INDEX=IX_SECTIOND_SECTION_CODE,NOLOCK) JOIN SECTIONM B WITH (NOLOCK) ON A.SECTION_CODE=B.SECTION_CODE 
   ON LTRIM(RTRIM(M.SECTION_NAME))+LTRIM(RTRIM(M.SUB_SECTION_NAME))=LTRIM(RTRIM(B.SECTION_NAME))+LTRIM(RTRIM(A.SUB_SECTION_NAME)) 
   WHERE ISNULL(LTRIM(RTRIM(B.SECTION_NAME)),'')+ISNULL(LTRIM(RTRIM(A.SUB_SECTION_NAME)),'')=''
  
     
      set @nStep=30.63
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	          
   
   IF EXISTS (SELECT TOP 1 SUB_SECTION_CODE FROM #TMPSUB_SECTIONM) AND ISNULL(@CERPINTEGRATIONENABLED,'')<>'1' AND ISNULL(@DO_NOT_CREATE_SUB_SECTION,'')='1'  
   BEGIN  
	  SELECT TOP 1 @CNEWSD=SUB_SECTION_NAME+'('+SECTION_NAME+')' FROM #TMPSUB_SECTIONM  
    
	  SET @CERRORMSG='NEW SUB SECTION :'+@CNEWSD+' NOT FOUND IN MASTERS'  
	  GOTO END_PROC  
   END  
             
   ----PRINT 'INSERTING SUH SECTIONS...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) ) +'SECONDS ...'        
    
 
          
   SET @UPDATEVALUE = 0        
   --SELECT @UPDATEVALUE = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0) FROM         
   --  KEYS WHERE TABLENAME='SECTIONM' AND COLUMNNAME='SECTION_CODE'        
   set @nStep=30.67
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	                  

   SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
          
   SELECT @UPDATEVALUE1 = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0) FROM         
     KEYS (NOLOCK) WHERE TABLENAME='SECTIONM' AND COLUMNNAME='SECTION_CODE'   AND ISNULL(LASTKEYVAL,'')<>''     
     AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))=0        
       
   PRINT 'IMPORT MASTERS-'+(@NSTEP)    
         
   SELECT @UPDATEVALUE2 = MAX(ISNULL(CONVERT(NUMERIC,SUBSTRING(SECTION_CODE,3,LEN(LTRIM(RTRIM(SECTION_CODE))))),0))        
   FROM  SECTIONM (NOLOCK) 
   WHERE PATINDEX('%[A-Z]%',SUBSTRING(SECTION_CODE,3,LEN(SECTION_CODE)))=0 AND SECTION_CODE<>''  
          
   IF ISNULL(@UPDATEVALUE1,0)>ISNULL(@UPDATEVALUE2,0)        
    SET @UPDATEVALUE=ISNULL(@UPDATEVALUE1,0)        
   ELSE        
    SET @UPDATEVALUE=ISNULL(@UPDATEVALUE2,0)        
         
   set @nStep=30.69
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        
   
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())           
   PRINT 'IMPORT MASTERS-'+(@NSTEP)    
      
   SET @BLOOP=0    
   WHILE @BLOOP=0    
   BEGIN      
		set @nStep=30.72
		EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        

		UPDATE #TMPSECTIONM SET SECTION_CODE = @CLOCID+REPLICATE('0',5-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
		@UPDATEVALUE = @UPDATEVALUE + 1        
        
		IF NOT EXISTS(SELECT TOP 1 A.SECTION_CODE FROM SECTIONM A (NOLOCK) JOIN #TMPSECTIONM B ON A.SECTION_CODE=B.SECTION_CODE)    
			SET @BLOOP=1               
		ELSE
			 set @UPDATEVALUE=@UPDATEVALUE+1   	 	
   END    
     
   set @nStep=30.75
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        
   
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                      
   INSERT SECTIONM (SECTION_CODE,SECTION_NAME,REMARKS,LAST_UPDATE,ALIAS)        
   SELECT DISTINCT SECTION_CODE,SECTION_NAME,'' AS REMARKS,'' AS LAST_UPDATE,      
   ALIAS  FROM #TMPSECTIONM WHERE ISNULL(SECTION_NAME,'')<>'' AND SECTION_CODE<>''       
     
   set @nStep=30.80
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                 
   IF  EXISTS (SELECT LASTKEYVAL FROM KEYS WHERE TABLENAME='SECTIONM')         
    UPDATE KEYS WITH (ROWLOCK) SET LASTKEYVAL = @CLOCID+REPLICATE('0',5-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))        
    WHERE TABLENAME='SECTIONM' AND @UPDATEVALUE<>0        
   ELSE        
    INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
    VALUES  ('SECTIONM',@CLOCID+REPLICATE('0',5-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
     'SECTION_CODE','01','01109')         
          
   ----PRINT 'INSERTING SECTIONS...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) ) +'SECONDS ...'        
          
   SET @DCURDT = GETDATE()          
   ----PRINT 'INSERTING SUB SECTIONS...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) ) +'SECONDS ...'        
          
   SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
         
   set @nStep=30.82
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	             
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())           
         
   SELECT @UPDATEVALUE1 = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0) FROM         
     KEYS WITH (NOLOCK) WHERE TABLENAME='SECTIOND'  AND COLUMNNAME='SUB_SECTION_CODE'   AND ISNULL(LASTKEYVAL,'')<>''     
     AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))=0          
          
   SELECT @UPDATEVALUE2 = MAX(ISNULL(CONVERT(NUMERIC,SUBSTRING(SUB_SECTION_CODE,3,LEN(LTRIM(RTRIM(SUB_SECTION_CODE))))),0))         
   FROM  SECTIOND  WITH (NOLOCK) WHERE PATINDEX('%[A-Z]%',SUBSTRING(SUB_SECTION_CODE,3,LEN(LTRIM(RTRIM(SUB_SECTION_CODE)))))=0   
   AND SUB_SECTION_CODE<>''         
          
   IF ISNULL(@UPDATEVALUE1,0)>ISNULL(@UPDATEVALUE2,0)        
    SET @UPDATEVALUE=ISNULL(@UPDATEVALUE1,0)        
   ELSE        
    SET @UPDATEVALUE=ISNULL(@UPDATEVALUE2,0)        
         
   set @nStep=30.85
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	            
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())           
   SET @BLOOP=0    
   WHILE @BLOOP=0    
   BEGIN      
		UPDATE #TMPSUB_SECTIONM SET SUB_SECTION_CODE = @CLOCID+REPLICATE('0',5-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
		@UPDATEVALUE = @UPDATEVALUE + 1        
	        
		IF NOT EXISTS (SELECT TOP 1 A.SUB_SECTION_CODE FROM SECTIOND A WITH (NOLOCK) 
		  JOIN #TMPSUB_SECTIONM B ON A.SUB_SECTION_CODE=B.SUB_SECTION_CODE)    
			SET @BLOOP=1               
		ELSE
			set @UPDATEVALUE=@UPDATEVALUE+1   	 			
   END    
   
   Declare @bsoPara1 bit ,@bsoPara2 bit,@bsoPara3 bit 
   
   SELECT  @bsoPara1=OPEN_KEY  FROM CONFIG_BUYERORDER A (NOLOCK)where COLUMN_NAME ='PARA1_NAME' and OPEN_KEY =1
   SELECT  @bsoPara2=OPEN_KEY  FROM CONFIG_BUYERORDER A (NOLOCK)where COLUMN_NAME ='PARA2_NAME' and OPEN_KEY =1
   SELECT  @bsoPara3=OPEN_KEY  FROM CONFIG_BUYERORDER A (NOLOCK)where COLUMN_NAME ='PARA3_NAME' and OPEN_KEY =1
        
   set @nStep=30.88
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	             
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                
   INSERT SECTIOND ( SECTION_CODE, SUB_SECTION_CODE, SUB_SECTION_NAME,      
      REMARKS, LAST_UPDATE,  ALIAS,soArticle,soPara1,soPara2,soPara3,PoArticle,PoPara1,poPara2,poPara3)        
   SELECT DISTINCT SECTION_CODE, SUB_SECTION_CODE, SUB_SECTION_NAME,       
       '' AS REMARKS, '' AS LAST_UPDATE,       
       '' AS ALIAS ,1 soArticle,isnull(@bsoPara1,0) soPara1,isnull(@bsoPara2,0) soPara2,isnull(@bsoPara3,0) soPara3,
       1 PoArticle,1 PoPara1,1 poPara2,1 poPara3        
   FROM #TMPSUB_SECTIONM A
   JOIN SECTIONM B WITH (NOLOCK) ON A.SECTION_NAME = B.SECTION_NAME         
   WHERE ISNULL(SUB_SECTION_NAME,'')<>'' AND A.SUB_SECTION_CODE<>''       
   AND B.SECTION_CODE=(SELECT TOP 1 SECTION_CODE FROM SECTIONM  
   WHERE SECTION_NAME=B.SECTION_NAME)  
         
   set @nStep=30.91
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	             
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                  
   IF  EXISTS (SELECT LASTKEYVAL FROM KEYS WHERE TABLENAME='SECTIOND')         
    UPDATE KEYS WITH (ROWLOCK) SET LASTKEYVAL = @CLOCID+REPLICATE('0',5-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))        
    WHERE TABLENAME='SECTIOND' AND @UPDATEVALUE<>0        
   ELSE        
    INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
    VALUES  ('SECTIOND',@CLOCID+REPLICATE('0',5-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
     'SUB_SECTION_CODE','01','01109')        
          
   ----PRINT 'INSERTING SUH SECTIONS...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) ) +'SECONDS ...'        
    
         
   set @nStep=30.94
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	             

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                  
   IF EXISTS (SELECT TOP 1 UOM_NAME FROM #TMPMASTERSENC WHERE ISNULL(UOM_NAME,'')<>'')        
   BEGIN        
     set @nStep=30.97
     EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	        
           
     SELECT DISTINCT CONVERT(CHAR(7),'') AS UOM_CODE,LTRIM(RTRIM(UOM_NAME))   AS UOM_NAME        
     INTO #TMPUOM FROM #TMPMASTERSENC        
     WHERE LTRIM(RTRIM(UOM_NAME)) NOT IN (SELECT LTRIM(RTRIM(UOM_NAME)) FROM UOM)        
       
      DECLARE @DO_NOT_CREATE_UOM VARCHAR(10)  
      SELECT TOP 1 @DO_NOT_CREATE_UOM=VALUE  FROM CONFIG WITH (NOLOCK) WHERE CONFIG_OPTION ='DO_NOT_CREATE_UOM_MASTERS_IN_FILE_IMPORT'      
        
       
      IF (ISNULL(@DO_NOT_CREATE_UOM,'')='1'  or @CHODEPT_ID<>@cdept_id)
      BEGIN  
		  IF EXISTS(SELECT TOP 1 'U' FROM #TMPUOM)  
		  BEGIN  
			  SELECT TOP 1 @CNEWSD=UOM_NAME  FROM #TMPUOM  
			  SET @CERRORMSG='NEW UOM :'+@CNEWSD+' NOT FOUND IN MASTERS'  
			  GOTO END_PROC  
		  END  
      END     
     
	    set @nStep=30.102
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
     SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
           
     SELECT @UPDATEVALUE1 = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0) FROM         
       KEYS WITH (NOLOCK) WHERE TABLENAME='UOM' AND COLUMNNAME='UOM_CODE'        
       AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))=0        
           
   set @nStep=30.106
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())     
 PRINT 'IMPORT MASTERS-'+(@NSTEP)           
    SELECT @UPDATEVALUE2 = MAX(ISNULL(CONVERT(NUMERIC,SUBSTRING(UOM_CODE,3,LEN(LTRIM(RTRIM(UOM_CODE))))),0))        
    FROM  UOM WITH (NOLOCK) WHERE PATINDEX('%[A-Z]%',SUBSTRING(UOM_CODE,3,LEN(LTRIM(RTRIM(UOM_CODE)))))=0        
    AND LTRIM(RTRIM(ISNULL(UOM_NAME,'')))<>''  
           
     IF ISNULL(@UPDATEVALUE1,0)>ISNULL(@UPDATEVALUE2,0)        
      SET @UPDATEVALUE=ISNULL(@UPDATEVALUE1,0)        
     ELSE        
      SET @UPDATEVALUE=ISNULL(@UPDATEVALUE2,0)        
       
   set @nStep=30.110
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
      
     INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())         
     UPDATE #TMPUOM SET UOM_CODE = @CLOCID+REPLICATE('0',5-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
     @UPDATEVALUE = @UPDATEVALUE + 1        
       
      
     INSERT UOM ( UOM_CODE, UOM_NAME, LAST_UPDATE, UOM_TYPE )        
     SELECT  UOM_CODE, UOM_NAME, GETDATE() AS LAST_UPDATE, 1 AS UOM_TYPE      
     FROM #TMPUOM        
           
	    set @nStep=30.113
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

     INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())     
    
  PRINT 'IMPORT MASTERS-'+(@NSTEP)           
     IF  EXISTS (SELECT LASTKEYVAL FROM KEYS WITH (NOLOCK) WHERE TABLENAME='UOM')         
		  UPDATE KEYS WITH (ROWLOCK) SET LASTKEYVAL = @CLOCID+REPLICATE('0',5-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))        
		  WHERE TABLENAME='UOM'  AND @UPDATEVALUE<>0        
     ELSE        
		  INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
		  VALUES  ('UOM',@CLOCID+REPLICATE('0',5-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
		   'UOM_CODE','01','01109')        
          
   END        

   set @nStep=30.117
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
          
   PRINT 'IMPORT MASTERS-'+(@NSTEP)         
  
   set @nStep=30.120
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
   
  INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())            
   ----PRINT '1'        
  SELECT DISTINCT CONVERT(CHAR(9),'') AS ARTICLE_CODE,   
         LTRIM(RTRIM(ARTICLE_NO)) AS ARTICLE_NO,   
        CONVERT(VARCHAR(300),'') AS SECTION_NAME, CONVERT(VARCHAR(300),'') AS SUB_SECTION_NAME,         
        CONVERT(NUMERIC(1,0),0) AS CODING_SCHEME,     
        CONVERT(CHAR(7),'')  AS UOM_CODE,        
        CONVERT(NUMERIC(10,2),0) AS PURCHASE_PRICE,   
        CONVERT(NUMERIC(10,2),0) AS [MRP],   
        CONVERT(NUMERIC(10,2),0) AS WS_PRICE,   
        CONVERT(VARCHAR(300),'') AS UOM_NAME,CONVERT(NUMERIC(3,0),1) AS DISCON,    
       CONVERT(BIT,'0') AS STOCK_NA ,    
       CONVERT(BIT,'0') AS [GEN_EAN_CODES] , 
	   EAN_PREFIX,
       CONVERT(VARCHAR(300),'') AS [ARTICLE_NAME],  
       CONVERT(VARCHAR(50),'') AS [ALIAS] ,  
        HSN_CODE ,PERISHABLE,
	   isnull(article_desc,'') as article_desc,
	   CONVERT(VARCHAR(30),'') AS SUB_SECTION_CODE,
	   isnull(article_type,0) as article_type,
	   SEASON_NAME ,CONVERT(CHAR(7),'') AS SEASON_id,
	   CAST(0 AS BIT ) AS season_specific_article,
	   MRP_RESTRICTION,
	   MRP_RESTRICTION_FROM,
	   MRP_RESTRICTION_TO
   INTO #TMPARTICLE         
   FROM #TMPMASTERSENC 

   
   
     -- FOR DUPLICATE ARTICLE
   ;WITH CTE AS
   (
      SELECT *,SR=ROW_NUMBER() OVER(PARTITION BY ARTICLE_NO ORDER BY ISNULL(HSN_CODE,'') DESC) FROM #TMPARTICLE 
   )
   DELETE FROM CTE WHERE SR>1
            
      
   set @nStep=30.125
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
    
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())      
     
   UPDATE A  SET     
   A.SECTION_NAME = B.SECTION_NAME,  
   A.SUB_SECTION_NAME = B.SUB_SECTION_NAME,  
   A.CODING_SCHEME = B.CODING_SCHEME,  
   A.UOM_CODE = B.UOM_CODE,  
   A.PURCHASE_PRICE = B.PURCHASE_PRICE,A.MRP=B.MRP,A.WS_PRICE=B.WS_PRICE,A.UOM_NAME=B.UOM_NAME,  
   A.STOCK_NA=B.STOCK_NA,A.GEN_EAN_CODES=B.GEN_EAN_CODES,A.ARTICLE_NAME = B.ARTICLE_NAME,  
   A.ALIAS=B.ALIAS  ,DISCON=b.DISCON 
   FROM #TMPARTICLE A  
   JOIN (  
   SELECT DISTINCT CONVERT(CHAR(9),'') AS ARTICLE_CODE, LTRIM(RTRIM(ARTICLE_NO)) AS ARTICLE_NO,   
   LTRIM(RTRIM(SECTION_NAME)) AS SECTION_NAME, LTRIM(RTRIM(SUB_SECTION_NAME)) AS SUB_SECTION_NAME,         
     (CASE WHEN ( ISNULL(A.CODING_SCHEME,0)<>0) THEN A.CODING_SCHEME   ELSE @BCODING_SCHEME END) AS CODING_SCHEME,     
     (CASE WHEN ISNULL(UOM_CODE,'')='' THEN '0000001' ELSE LTRIM(RTRIM(UOM_CODE)) END) AS UOM_CODE,        
     ISNULL(PURCHASE_PRICE,0) AS PURCHASE_PRICE, ISNULL(MRP,0) AS [MRP], ISNULL(WS_PRICE,0) AS WS_PRICE, LTRIM(RTRIM(B.UOM_NAME)) AS UOM_NAME, ISNULL(B.UOM_TYPE,1) AS DISCON,    
     (CASE WHEN STOCK_NA='1' THEN 1 ELSE 0 END) AS STOCK_NA ,    
     ISNULL(A.GEN_EAN_CODES,0) AS [GEN_EAN_CODES] ,ISNULL(LTRIM(RTRIM(A.ARTICLE_NAME)),'') AS [ARTICLE_NAME]  
     ,ISNULL(LTRIM(RTRIM(A.ARTICLE_ALIAS)),'') AS [ALIAS] 
   FROM #TMPMASTERSENC A         
   LEFT OUTER JOIN UOM B WITH (NOLOCK) ON B.UOM_NAME=A.UOM_NAME 
   ) B ON A.ARTICLE_NO = B.ARTICLE_NO  
           
   ----PRINT '1INSERTING ARTICLES...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) )+'SECONDS ...'     
   
   --SEASON uPDATE 
   IF EXISTS (SELECT TOP 1 'Ú' FROM #TMPARTICLE WHERE ISNULL(SEASON_NAME,'') <>'')
   BEGIN
      
	  UPDATE A SET SEASON_ID =B.SEASON_ID ,SEASON_SPECIFIC_ARTICLE =1
	  FROM #TMPARTICLE A
	  JOIN SEASON_MST B (NOLOCK) ON A.SEASON_NAME=B.SEASON_NAME 
	  WHERE ISNULL(A.SEASON_NAME,'') <>''

   END

     
   set @nStep=30.130
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())          
   SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
          
   SELECT @UPDATEVALUE1 = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0) FROM         
     KEYS WHERE TABLENAME='ARTICLE' AND COLUMNNAME='ARTICLE_CODE' AND ISNULL(LASTKEYVAL,'')<>''       
     AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))=0         
        
   SELECT @UPDATEVALUE2 = MAX(ISNULL(CONVERT(NUMERIC,SUBSTRING(ARTICLE_CODE,3,LEN(LTRIM(RTRIM(ARTICLE_CODE))))),0))         
   FROM  ARTICLE WHERE PATINDEX('%[A-Z]%',SUBSTRING(ARTICLE_CODE,3,LEN(LTRIM(RTRIM(ARTICLE_CODE)))))=0 AND ARTICLE_CODE<>''        
    
   PRINT 'IMPORT MASTERS-'+(@NSTEP)          
   --PRINT '21'        
   IF ISNULL(@UPDATEVALUE1,0)>ISNULL(@UPDATEVALUE2,0)        
    SET @UPDATEVALUE=ISNULL(@UPDATEVALUE1,0)        
   ELSE        
    SET @UPDATEVALUE=ISNULL(@UPDATEVALUE2,0)        
         
   set @nStep=30.132
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

     
   
 DECLARE @DO_NOT_CREATE_ARTICLE VARCHAR(10)  
 SELECT TOP 1 @DO_NOT_CREATE_ARTICLE= VALUE  FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION ='DO_NOT_CREATE_ARTICLE_MASTERS_IN_FILE_IMPORT'  
 --select 'article max value-1',@UPDATEVALUE   
 
 IF ISNULL(@DO_NOT_CREATE_ARTICLE,'')='1'  
 BEGIN  

	    set @nStep=30.135
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

     IF EXISTS(SELECT TOP 1 'U' FROM #TMPARTICLE a
        LEFT OUTER JOIN article b (NOLOCK) ON  LTRIM(RTRIM(a.article_No))=LTRIM(RTRIM(b.article_no))      
		WHERE b.article_code IS NULL AND LTRIM(RTRIM(ISNULL(a.article_no,'')))<>'' )  
     BEGIN  
         SELECT TOP 1 @CNEWSD=A.ARTICLE_NO  FROM #TMPARTICLE a
        LEFT OUTER JOIN article b (NOLOCK) ON  LTRIM(RTRIM(a.article_No))=LTRIM(RTRIM(b.article_no))      
		WHERE b.article_code IS NULL AND LTRIM(RTRIM(ISNULL(a.article_no,'')))<>''
		
		SET @CERRORMSG='NEW ARTICLE :'+@CNEWSD+' NOT FOUND IN MASTERS'  
       GOTO END_PROC  
     END  
 END  
 
   
   --select 'article max value-2',@UPDATEVALUE 
   declare @nCnt int
   set @nStep=30.138
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
   
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())            
   IF  EXISTS (SELECT TOP 1 A.ARTICLE_CODE FROM  #TMPARTICLE a 
			   left outer join ARTICLE b (NOLOCK) on ltrim(rtrim(a.ARTICLE_NO))=ltrim(rtrim(b.article_no))
			   where b.article_no is null and ltrim(rtrim(a.ARTICLE_NO))<>'' )
		set @BLOOP=0
   else			          
		SET @BLOOP=1    

	set @nCnt=0
   WHILE @BLOOP=0    
   BEGIN      
	  
 	    set @nStep=30.141
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

	  set @nCnt=@nCnt+1
--	  select @UPDATEVALUE ,@nCnt,@CLOCID
	  INSERT IMPORT_INFO VALUES (@UPDATEVALUE,GETDATE())
	                 
	  UPDATE a SET ARTICLE_CODE = @CLOCID+REPLICATE('0'  
	  ,7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))  
	  ,@UPDATEVALUE = @UPDATEVALUE + 1
	  FROM #tmparticle a        
	   LEFT OUTER JOIN article b (NOLOCK) ON  LTRIM(RTRIM(a.article_no))=LTRIM(RTRIM(b.article_no))      
	   WHERE b.article_no IS NULL AND LTRIM(RTRIM(ISNULL(a.article_no,'')))<>''

	    set @nStep=30.143
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
	  
      
	  IF NOT EXISTS (SELECT TOP 1 A.ARTICLE_CODE FROM ARTICLE A (NOLOCK) JOIN 
		(SELECT a.article_code FROM #tmparticle a        
		 LEFT OUTER JOIN article b (NOLOCK) ON  LTRIM(RTRIM(a.article_no))=LTRIM(RTRIM(b.article_no))      
	      WHERE b.article_no IS NULL AND LTRIM(RTRIM(ISNULL(a.article_no,'')))<>'') b ON 
	      a.article_code=b.ARTICLE_CODE)    
		 SET @BLOOP=1               
	  ELSE
		 set @UPDATEVALUE=@UPDATEVALUE+1   	 
   END    
 
 
 IF ISNULL(@DO_NOT_CREATE_ARTICLE,'')<>'1'  
 BEGIN
 	    set @nStep=30.145
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		DECLARE @cActiveArticle VARCHAR(100),@cActiveSubsection VARCHAR(200)

		SELECT c.section_name,c.sub_section_name,a.section_code 
		   into #tmpsubsection
		FROM sectiond a (NOLOCK)
		JOIN sectionm b (NOLOCK) ON a.section_code=b.section_code
		JOIN #TMPARTICLE c ON c.SECTION_NAME=b.section_name AND c.sub_section_name=a.sub_section_name
	    WHERE a.inactive=0 and b.inactive=0
		group by c.section_name,c.sub_section_name,a.section_code
		
		SELECT TOP 1 @cActiveArticle=a.article_no,@cActiveSubsection=a.SUB_SECTION_NAME+'('+a.SECTION_NAME+')'  
		FROM #TMPARTICLE A         
	   LEFT JOIN #tmpsubsection b ON a.SECTION_NAME=b.section_name AND a.SUB_SECTION_NAME=b.SUB_SECTION_NAME       
	   LEFT OUTER JOIN ARTICLE E WITH (NOLOCK,INDEX=IX_ARTICLE_ARTICLE_NO) ON E.ARTICLE_NO = LTRIM(RTRIM(A.ARTICLE_NO))        
	   WHERE A.ARTICLE_CODE<>''   
	   AND E.ARTICLE_NO IS NULL  AND b.SECTION_NAME IS NULL



		--SELECT TOP 1 @cActiveArticle=a.article_no,@cActiveSubsection=a.SUB_SECTION_NAME+'('+a.SECTION_NAME+')'  
		--FROM #TMPARTICLE A         
	 --  LEFT JOIN (SELECT c.section_name,c.sub_section_name,a.section_code FROM sectiond a (NOLOCK)
		--		  JOIN sectionm b (NOLOCK) ON a.section_code=b.section_code
		--		  JOIN #TMPARTICLE c ON c.SECTION_NAME=b.section_name AND c.sub_section_name=a.sub_section_name
		--		  WHERE a.inactive=0 and b.inactive=0) b ON a.SECTION_NAME=b.section_name AND a.SUB_SECTION_NAME=b.SUB_SECTION_NAME       
	 --  LEFT OUTER JOIN ARTICLE E WITH (NOLOCK,INDEX=IX_ARTICLE_ARTICLE_NO) ON E.ARTICLE_NO = LTRIM(RTRIM(A.ARTICLE_NO))        
	 --  WHERE A.ARTICLE_CODE<>''   
	 --  AND E.ARTICLE_NO IS NULL  AND b.SECTION_NAME IS NULL


	 --  if @@spid=57
		--select 'check inactive articles', @cActiveSubsection,* from #tmparticle

	   IF ISNULL(@cActiveSubsection,'')<>''
	   BEGIN
			SET @CERRORMSG='No active Sub Section :'+@cActiveSubsection+' found for article no.:'+@cActiveArticle+'.... Please check'
			GOTO END_PROC
       END
 END
 
 
   
   set @nStep=30.150
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())   
               
 IF @COVERWRITE<>'1'  
 BEGIN  
	  UPDATE A SET SUB_SECTION_CODE = D.SUB_SECTION_CODE, 
	  ARTICLE_NAME =(CASE WHEN ISNULL(B.ARTICLE_NAME,'')='' and isnull(a.article_name,'')='' THEN C.section_name+'-'+D.SUB_SECTION_NAME ELSE ISNULL(B.ARTICLE_NAME,'') END),      
	  UOM_CODE = B.UOM_CODE, GEN_EAN_CODES = B.GEN_EAN_CODES ,
	  A.ALIAS= (CASE WHEN ISNULL(B.ALIAS,'')<>'' THEN  B.ALIAS ELSE A.ALIAS END )  ,  
	 -- A.CODING_SCHEME=B.CODING_SCHEME ,  --donot over write coding scheme
	  A.PURCHASE_PRICE =B.PURCHASE_PRICE,
	  a.PERISHABLE =isnull(b.PERISHABLE,0),
	  a.EAN_PREFIX =(CASE WHEN ISNULL(B.EAN_PREFIX,'')<>'' THEN  B.EAN_PREFIX ELSE A.EAN_PREFIX END ) ,
	  ARTICLE_DESC =(CASE WHEN ISNULL(B.ARTICLE_DESC,'')<>'' THEN  B.ARTICLE_DESC ELSE A.ARTICLE_DESC END ) ,
	  article_type=(CASE WHEN ISNULL(B.article_type,0)<>0 THEN  B.article_type ELSE A.article_type END ) ,
	  MRP_RESTRICTION=(CASE WHEN ISNULL(B.MRP_RESTRICTION,0)<>0 THEN  B.MRP_RESTRICTION ELSE A.MRP_RESTRICTION END ),
	  MRP_RESTRICTION_FROM=(CASE WHEN ISNULL(B.MRP_RESTRICTION,0)<>0 THEN  B.MRP_RESTRICTION_FROM ELSE A.MRP_RESTRICTION_FROM END ),
	  MRP_RESTRICTION_TO=(CASE WHEN ISNULL(B.MRP_RESTRICTION,0)<>0 THEN  B.MRP_RESTRICTION_TO ELSE A.MRP_RESTRICTION_TO END )
	  
	  FROM ARTICLE A WITH (ROWLOCK)         
	  JOIN #TMPARTICLE B ON A.ARTICLE_NO = B.ARTICLE_NO        
	  JOIN SECTIONM C WITH (NOLOCK,INDEX=ix_sectionm_section_name) ON C.SECTION_NAME = B.SECTION_NAME         
	  JOIN SECTIOND D WITH (NOLOCK,INDEX=ix_sectiond_sub_section_name) ON D.SUB_SECTION_NAME = B.SUB_SECTION_NAME         
	  AND D.SECTION_CODE=C.SECTION_CODE         
 END    



 --as per new discussion article coding scheme change without barcode 

	 UPDATE A SET  A.CODING_SCHEME=B.CODING_SCHEME 
	 FROM ARTICLE A WITH (ROWLOCK)         
	 JOIN #TMPMASTERSENC B ON A.ARTICLE_NO = B.ARTICLE_NO   
	 WHERE ISNULL(B.PRODUCT_CODE,'')=''


  --PRINT '4INSERTING ARTICLES...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) )+'SECONDS ...'        
        
    set @nStep=30.155
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                  
   UPDATE #TMPARTICLE SET DISCON=2 WHERE UOM_NAME='MTR'        
          
   set @nStep=30.160
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())            
   PRINT 'IMPORT MASTERS-'+(@NSTEP)      
      
   CREATE INDEX IX_ARTICLE_SECTION_NAME ON #TMPARTICLE(SECTION_NAME)  
   CREATE INDEX IX_ARTICLE_ARTICLE_NO ON #TMPARTICLE(ARTICLE_NO)   

   set @nStep=30.165
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	  

   Update a set SUB_SECTION_CODE=d.sub_section_code
   FROM #TMPARTICLE A         
   JOIN SECTIONM B WITH (NOLOCK,INDEX=ix_sectionm_section_name) ON A.SECTION_NAME = B.SECTION_NAME /*ADDED 23 NOV 18*/AND B.INACTIVE=0       
   JOIN SECTIOND D WITH (NOLOCK,INDEX=ix_sectiond_sub_section_name) ON  LTRIM(RTRIM(D.SUB_SECTION_NAME)) = LTRIM(RTRIM(A.SUB_SECTION_NAME))         
                       AND LTRIM(RTRIM(D.SECTION_CODE))=LTRIM(RTRIM(B.SECTION_CODE))   
   
      
   INSERT ARTICLE ( CODING_SCHEME, LAST_UPDATE, UOM_CODE, ALIAS,  STOCK_NA, MP_PERCENTAGE,        
     DISCON, PURCHASE_PRICE, MRP, WHOLESALE_PRICE ,   INACTIVE, MIN_PRICE,        
     WSP_PERCENTAGE,SKU_CODE, ARTICLE_CODE, ARTICLE_NO, ARTICLE_NAME, ARTICLE_DESC, SUB_SECTION_CODE,      
     REMARKS,PARA1_SET,PARA2_SET,GEN_EAN_CODES,HSN_CODE,PERISHABLE,EAN_PREFIX,article_type,Season_Id ,
     season_specific_article ,ARTICLE_PACK_SIZE,MRP_RESTRICTION,MRP_RESTRICTION_FROM,MRP_RESTRICTION_TO  )      

	 SELECT  DISTINCT A.CODING_SCHEME, GETDATE() AS LAST_UPDATE, A.UOM_CODE, A.ALIAS AS ALIAS,      
     A.STOCK_NA, 0 AS MP_PERCENTAGE, A.DISCON, A.PURCHASE_PRICE AS PURCHASE_PRICE, A.MRP AS MRP,        
     A.WS_PRICE AS WS_PRICE,  0 AS INACTIVE, 0 AS MIN_PRICE, 0 AS WP_PERCENTAGE,          
     0 AS SKU_CODE, LTRIM(RTRIM(A.ARTICLE_CODE)), LTRIM(RTRIM(A.ARTICLE_NO)), 
	 (CASE WHEN ISNULL(A.ARTICLE_NAME,'')='' THEN LTRIM(RTRIM(A.SECTION_NAME))+'-'+ LTRIM(RTRIM(A.SUB_SECTION_NAME)) ELSE LTRIM(RTRIM(ISNULL(A.ARTICLE_NAME,''))) END) AS ARTICLE_NAME,        
     a.ARTICLE_DESC, 
	 a.SUB_SECTION_CODE,  '' AS REMARKS,0 AS PARA1_SET,0 AS PARA2_SET ,    
     A.GEN_EAN_CODES ,  
     CASE WHEN ISNULL(A.HSN_CODE,'')='' THEN '0000000000' ELSE A.HSN_CODE END  ,
	 a.PERISHABLE  ,a.EAN_PREFIX,isnull(a.article_type,0) as article_type,
	 a.Season_Id ,a.season_specific_article ,1 ARTICLE_PACK_SIZE,a.MRP_RESTRICTION,a.MRP_RESTRICTION_FROM,a.MRP_RESTRICTION_TO 
   FROM #TMPARTICLE A         
   LEFT OUTER JOIN ARTICLE E WITH (NOLOCK,INDEX=IX_ARTICLE_ARTICLE_NO) ON E.ARTICLE_NO = LTRIM(RTRIM(A.ARTICLE_NO))        
   WHERE A.ARTICLE_CODE<>''   
   AND E.ARTICLE_NO IS NULL        
   

  /*            
   SELECT  DISTINCT A.CODING_SCHEME, GETDATE() AS LAST_UPDATE, A.UOM_CODE, A.ALIAS AS ALIAS,      
     A.STOCK_NA, 0 AS MP_PERCENTAGE, A.DISCON, A.PURCHASE_PRICE AS PURCHASE_PRICE, A.MRP AS MRP,        
     A.WS_PRICE AS WS_PRICE,  0 AS INACTIVE, 0 AS MIN_PRICE, 0 AS WP_PERCENTAGE,          
     0 AS SKU_CODE, LTRIM(RTRIM(A.ARTICLE_CODE)), LTRIM(RTRIM(A.ARTICLE_NO)), 
	 (CASE WHEN ISNULL(A.ARTICLE_DESC,'')='' THEN LTRIM(RTRIM(A.SECTION_NAME))+'-'+ LTRIM(RTRIM(A.SUB_SECTION_NAME)) ELSE LTRIM(RTRIM(ISNULL(A.ARTICLE_NAME,''))) END) AS ARTICLE_NAME,        
     a.ARTICLE_DESC, 
	 D.SUB_SECTION_CODE,  '' AS REMARKS,0 AS PARA1_SET,0 AS PARA2_SET ,    
     A.GEN_EAN_CODES ,  
     CASE WHEN ISNULL(A.HSN_CODE,'')='' THEN '0000000000' ELSE A.HSN_CODE END  ,
	 a.PERISHABLE  ,a.EAN_PREFIX
   FROM #TMPARTICLE A         
   JOIN SECTIONM B WITH (NOLOCK,INDEX=ix_sectionm_section_name) ON A.SECTION_NAME = B.SECTION_NAME /*ADDED 23 NOV 18*/AND B.INACTIVE=0       
   JOIN SECTIOND D WITH (NOLOCK,INDEX=ix_sectiond_sub_section_name) ON  LTRIM(RTRIM(D.SUB_SECTION_NAME)) = LTRIM(RTRIM(A.SUB_SECTION_NAME))         
                       AND LTRIM(RTRIM(D.SECTION_CODE))=LTRIM(RTRIM(B.SECTION_CODE))   
                       /*ADDED 23 NOV 18*/AND D.INACTIVE=0       
   LEFT OUTER JOIN ARTICLE E WITH (NOLOCK,INDEX=IX_ARTICLE_ARTICLE_NO) ON E.ARTICLE_NO = LTRIM(RTRIM(A.ARTICLE_NO))        
   WHERE A.CODING_SCHEME=(SELECT TOP 1 CODING_SCHEME FROM #TMPARTICLE WHERE ARTICLE_NO=A.ARTICLE_NO)        
   AND A.ARTICLE_CODE<>''   
   AND E.ARTICLE_NO IS NULL        
   AND B.SECTION_CODE=(SELECT TOP 1 SECTION_CODE   
					   FROM SECTIONM (NOLOCK) 
					   WHERE SECTION_NAME=B.SECTION_NAME AND SECTION_CODE =B.SECTION_CODE)  
   AND D.SUB_SECTION_CODE=(SELECT TOP 1 SUB_SECTION_CODE   
						   FROM SECTIOND (NOLOCK) 
						   WHERE SECTION_CODE=D.SECTION_CODE   
						   AND SUB_SECTION_NAME=D.SUB_SECTION_NAME   
						   AND SUB_SECTION_CODE =D.SUB_SECTION_CODE)         
   */ 
   set @nStep=30.170
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())            
    IF  EXISTS (SELECT LASTKEYVAL FROM KEYS (NOLOCK) WHERE TABLENAME='ARTICLE')         
    UPDATE KEYS WITH (ROWLOCK) SET LASTKEYVAL = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))        
    WHERE TABLENAME='ARTICLE' AND @UPDATEVALUE<>0         
   ELSE        
    INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
    VALUES  ('ARTICLE',@CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
     'ARTICLE_CODE','01','01109')        
          
   set @nStep=30.172
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())            
     
    set @nStep=30.175
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())             
   SELECT DISTINCT CONVERT(CHAR(9),'') AS PARA1_CODE,LTRIM(RTRIM(a.PARA1_NAME)) AS PARA1_NAME ,
          LTRIM(RTRIM(P1_SET)) AS PARA1_SET,
		  isnull(LTRIM(RTRIM(PARA1_ALIAS)),'') AS PARA1_ALIAS
   INTO #TMPPARA1 
   FROM #TMPMASTERSENC a
   LEFT OUTER JOIN para1 b (NOLOCK) ON  LTRIM(RTRIM(a.PARA1_NAME))=LTRIM(RTRIM(b.PARA1_NAME))      
   WHERE b.para1_code IS NULL AND LTRIM(RTRIM(ISNULL(a.PARA1_NAME,'')))<>''       
   
   
     
  DECLARE @DO_NOT_CREATE_PARA1 VARCHAR(10)  
  SELECT TOP 1 @DO_NOT_CREATE_PARA1 =VALUE  FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION ='DO_NOT_CREATE_PARA1_MASTERS_IN_FILE_IMPORT'  
  IF ISNULL(@DO_NOT_CREATE_PARA1,'')='1'  
  BEGIN  
    set @nStep=30.180
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

     IF EXISTS(SELECT TOP 1 'U' FROM #TMPPARA1)  
     BEGIN  
		 SELECT TOP 1 @CNEWSD=PARA1_NAME  FROM #TMPPARA1   
		 SET @CERRORMSG='NEW PARA1 :'+@CNEWSD+' NOT FOUND IN MASTERS'  
		  GOTO END_PROC  
    END  
   
    
  END  
    
	    set @nStep=30.185
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
   
   SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
         
   SELECT @UPDATEVALUE1 = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0) FROM         
   KEYS (NOLOCK) WHERE TABLENAME='PARA1' AND COLUMNNAME='PARA1_CODE' AND ISNULL(LASTKEYVAL,'')<>''       
   AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))=0        
     
   set @nStep=30.190
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
       
   SELECT @UPDATEVALUE2 = MAX(ISNULL(CONVERT(NUMERIC,SUBSTRING(PARA1_CODE,3,LEN(LTRIM(RTRIM(PARA1_CODE))))),0))         
   FROM  PARA1 (NOLOCK) WHERE PATINDEX('%[A-Z]%',SUBSTRING(PARA1_CODE,3,LEN(LTRIM(RTRIM(PARA1_CODE)))))=0        
   AND LTRIM(RTRIM(ISNULL(PARA1_CODE,'')))<>''  
     
    
   IF ISNULL(@UPDATEVALUE1,0)>ISNULL(@UPDATEVALUE2,0)        
    SET @UPDATEVALUE=ISNULL(@UPDATEVALUE1,0)        
   ELSE        
    SET @UPDATEVALUE=ISNULL(@UPDATEVALUE2,0)        
    
   PRINT 'IMPORT MASTERS-'+(@NSTEP)    
    
   set @nStep=30.193
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())             
   SET @BLOOP=0    
   WHILE @BLOOP=0    
   BEGIN      
	    set @nStep=30.196
		EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		UPDATE #TMPPARA1 SET PARA1_CODE = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
		@UPDATEVALUE = @UPDATEVALUE + 1        
	        
		IF NOT EXISTS (SELECT TOP 1 A.PARA1_CODE FROM PARA1 A (NOLOCK) JOIN #TMPPARA1 B ON A.PARA1_CODE=    
		   B.PARA1_CODE)    
			SET @BLOOP=1               
		ELSE
			 set @UPDATEVALUE=@UPDATEVALUE+1   	 			
   END    
          
   set @nStep=30.198
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())             
   INSERT PARA1 ( PARA1_CODE, PARA1_NAME,  REMARKS,         
      LAST_UPDATE, ALIAS,PARA1_SET )        
   SELECT LTRIM(RTRIM(PARA1_CODE)), LTRIM(RTRIM(PARA1_NAME)),  '' AS REMARKS,         
     GETDATE() AS LAST_UPDATE, PARA1_ALIAS AS ALIAS, LTRIM(RTRIM(PARA1_SET))      
   FROM #TMPPARA1 WHERE PARA1_CODE<>''       
     
   set @nStep=30.202
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                  
   IF  EXISTS (SELECT LASTKEYVAL FROM KEYS (NOLOCK) WHERE TABLENAME='PARA1')         
    UPDATE KEYS WITH (ROWLOCK) SET LASTKEYVAL = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))        
    WHERE TABLENAME='PARA1'  AND @UPDATEVALUE<>0        
   ELSE        
    INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
    VALUES  ('PARA1',@CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
     'PARA1_CODE','01','01109')        
         
   SET @NSTEP=205
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                  

   SELECT DISTINCT CONVERT(CHAR(9),'') AS PARA2_CODE,
   LTRIM(RTRIM(a.PARA2_NAME)) AS PARA2_NAME,
   LTRIM(RTRIM(P2_SET)) AS PARA2_SET,
   isnull(LTRIM(RTRIM(PARA2_ALIAS)),'') AS PARA2_ALIAS
   INTO #TMPPARA2 FROM #TMPMASTERSENC a       
   LEFT OUTER JOIN para2 b (NOLOCK) ON  LTRIM(RTRIM(a.PARA2_NAME))=LTRIM(RTRIM(b.PARA2_NAME))      
   WHERE b.para2_code IS NULL AND LTRIM(RTRIM(ISNULL(a.PARA2_NAME,'')))<>''
      
      
  DECLARE @DO_NOT_CREATE_PARA2 VARCHAR(10)  
  SELECT TOP 1 @DO_NOT_CREATE_PARA2 =VALUE  FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION ='DO_NOT_CREATE_PARA2_MASTERS_IN_FILE_IMPORT'  
  IF ISNULL(@DO_NOT_CREATE_PARA2,'')='1'  
  BEGIN  
   set @nStep=30.207
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    IF EXISTS(SELECT TOP 1 'U' FROM #TMPPARA2)  
    BEGIN  
		 SELECT TOP 1 @CNEWSD=PARA2_NAME  FROM #TMPPARA2   
		 SET @CERRORMSG='NEW PARA2 :'+@CNEWSD+' NOT FOUND IN MASTERS'  
		 GOTO END_PROC  
    END  
    
  END  
   
   set @nStep=30.210
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
    
   SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
          
   SELECT @UPDATEVALUE1 = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0) FROM         
   KEYS (NOLOCK) WHERE TABLENAME='PARA2' AND COLUMNNAME='PARA2_CODE'  AND ISNULL(LASTKEYVAL,'')<>''      
   AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))=0        
          
   SELECT @UPDATEVALUE2 = MAX(ISNULL(CONVERT(NUMERIC,SUBSTRING(PARA2_CODE,3,LEN(LTRIM(RTRIM(PARA2_CODE))))),0))        
   FROM  PARA2 (NOLOCK) WHERE PATINDEX('%[A-Z]%',SUBSTRING(PARA2_CODE,3,LEN(PARA2_CODE)))=0        
   AND LTRIM(RTRIM(ISNULL(PARA2_CODE,'')))<>''  
         
	    set @nStep=30.220
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                  
   IF ISNULL(@UPDATEVALUE1,0)>ISNULL(@UPDATEVALUE2,0)        
    SET @UPDATEVALUE=ISNULL(@UPDATEVALUE1,0)        
   ELSE        
    SET @UPDATEVALUE=ISNULL(@UPDATEVALUE2,0)        
   
   set @nStep=30.230
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                           
   SET @BLOOP=0    
   WHILE @BLOOP=0    
   BEGIN      
		UPDATE #TMPPARA2 SET PARA2_CODE = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
		@UPDATEVALUE = @UPDATEVALUE + 1        
	        
		IF NOT EXISTS (SELECT TOP 1 A.PARA2_CODE FROM PARA2 A (NOLOCK) JOIN #TMPPARA2 B ON A.PARA2_CODE=B.PARA2_CODE)    
		   SET @BLOOP=1               
		ELSE
		   set @UPDATEVALUE=@UPDATEVALUE+1   	 			   
   END    
    
   set @nStep=30.240
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                       
   INSERT PARA2 ( PARA2_CODE, PARA2_NAME,  REMARKS, LAST_UPDATE,ALIAS,PARA2_SET )        
   SELECT  LTRIM(RTRIM(PARA2_CODE)), LTRIM(RTRIM(PARA2_NAME)),  '' AS REMARKS, 
   GETDATE() AS LAST_UPDATE,PARA2_ALIAS AS ALIAS    , LTRIM(RTRIM(PARA2_SET))  
   FROM #TMPPARA2        
   
  -- if @@spid=64
		--select 'check tmppara2',* from #tmppara2

   set @nStep=30.250
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                  
   IF  EXISTS (SELECT LASTKEYVAL FROM KEYS (NOLOCK) WHERE TABLENAME='PARA2')         
    UPDATE KEYS WITH (ROWLOCK) SET LASTKEYVAL = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))        
    WHERE TABLENAME='PARA2' AND @UPDATEVALUE<>0        
   ELSE        
    INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
    VALUES  ('PARA2',@CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
     'PARA2_CODE','01','01109')        
          
   set @nStep=30.260
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                  
DECLARE @CCREATEARTSIZESET VARCHAR(2)  
     
   SELECT TOP 1 @CCREATEARTSIZESET=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='CREATE_PARA_SET'  
              
  IF ISNULL(@CCREATEARTSIZESET,'')='1'   
  BEGIN  
  	    set @nStep=30.265
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
      
		INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())    
		
		SELECT DISTINCT CONVERT(VARCHAR(40),'') AS ROW_ID,LTRIM(RTRIM(a.ARTICLE_NO)) AS ARTICLE_NO,  
		LTRIM(RTRIM(a.PARA1_NAME)) AS PARA1_NAME ,
		CAST('' AS VARCHAR(10)) AS PARA1_CODE,
		CAST('' AS VARCHAR(10)) AS article_code,
		LTRIM(RTRIM(a.replaceable_color)) AS replaceable_color ,
		CAST('' AS VARCHAR(10)) AS replaceable_para1_code
		INTO #TMPARTPARA1         
		FROM #TMPMASTERSENC  a
		LEFT OUTER JOIN       
	  ( SELECT LTRIM(RTRIM(ARTICLE_NO)) AS article_no,LTRIM(RTRIM(PARA1_NAME)) as para1_name         
		FROM ART_PARA1 A (NOLOCK)        
		JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE        
		JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE=C.PARA1_CODE ) b
		ON  LTRIM(RTRIM(a.ARTICLE_NO))=b.article_no AND LTRIM(RTRIM(a.PARA1_NAME))=b.para1_name
		WHERE b.article_no IS NULL


		UPDATE A SET ARTICLE_CODE=B.ARTICLE_CODE ,PARA1_CODE =ISNULL(C.PARA1_CODE,'')
		FROM #TMPARTPARA1 A         
		JOIN ARTICLE B WITH (NOLOCK,INDEX=IX_ARTICLE_ARTICLE_NO)ON A.ARTICLE_NO=B.ARTICLE_NO        
		LEFT JOIN PARA1 C WITH (NOLOCK,INDEX=IX_PARA1_PARA1_NAME)ON A.PARA1_NAME = C.PARA1_NAME AND C.INACTIVE =0  
		
		UPDATE A SET replaceable_para1_code =ISNULL(C.PARA1_CODE,'')
		FROM #TMPARTPARA1 A            
		LEFT JOIN PARA1 C WITH (NOLOCK,INDEX=IX_PARA1_PARA1_NAME)ON A.replaceable_color = C.PARA1_NAME AND C.INACTIVE =0  
		

		IF EXISTS (SELECT TOP 1 'U' FROM #TMPARTPARA1 WHERE ISNULL(PARA1_CODE,'')='')
		begin

		    UPDATE A SET PARA1_CODE =ISNULL(C.PARA1_CODE,'')
			FROM #TMPARTPARA1 A                
			JOIN PARA1 C WITH (NOLOCK,INDEX=IX_PARA1_PARA1_NAME)ON A.PARA1_NAME = C.PARA1_NAME        
		
		end
		IF EXISTS (SELECT TOP 1 'U' FROM #TMPARTPARA1 WHERE ISNULL(replaceable_para1_code,'')='')
		begin

		    UPDATE A SET replaceable_para1_code =ISNULL(C.PARA1_CODE,'')
			FROM #TMPARTPARA1 A                
			JOIN PARA1 C WITH (NOLOCK,INDEX=IX_PARA1_PARA1_NAME)ON A.replaceable_color = C.PARA1_NAME        
		end


	           
		SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
	       
	    set @nStep=30.270
	    EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                            
		INSERT ART_PARA1 (ARTICLE_CODE,PARA1_CODE,ROW_ID,LAST_UPDATE,replaceable_para1_code)   

		SELECT LTRIM(RTRIM(a.ARTICLE_CODE)),LTRIM(RTRIM(a.PARA1_CODE)), NEWID() AS ROW_ID, GETDATE() AS LAST_UPDATE ,
		       a.replaceable_para1_code
		FROM #TMPARTPARA1 A                   
		LEFT OUTER JOIN ART_PARA1 X WITH (NOLOCK)        
		  ON  a.ARTICLE_CODE = X.ARTICLE_CODE        
		  AND a.PARA1_CODE = X.PARA1_CODE        
			WHERE X.ARTICLE_CODE IS NULL      
	         
	           
	    set @nStep=30.275
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                       
		SELECT DISTINCT CONVERT(VARCHAR(40),'') AS ROW_ID,LTRIM(RTRIM(ARTICLE_NO)) AS ARTICLE_NO,LTRIM(RTRIM(PARA2_NAME)) AS PARA2_NAME,  
		MRP,PURCHASE_PRICE,WS_PRICE ,CAST('' AS VARCHAR(10)) AS PARA2_CODE,CAST('' AS VARCHAR(10)) AS article_code       
		INTO #TMPARTDET         
		FROM #TMPMASTERSENC         
	           
		SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
	       
		UPDATE A SET MRP = D.MRP ,  
		 A.PURCHASE_PRICE =D.PURCHASE_PRICE,
		 WS_PRICE=d.WS_PRICE
		FROM ART_DET A WITH (ROWLOCK)
		JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE        
		JOIN PARA2 C (NOLOCK) ON A.PARA2_CODE=C.PARA2_CODE        
		JOIN #TMPARTDET D ON  D.ARTICLE_NO=B.ARTICLE_NO         
		AND D.PARA2_NAME=C.PARA2_NAME  

		
		UPDATE A SET ARTICLE_CODE=B.ARTICLE_CODE ,PARA2_CODE =ISNULL(C.PARA2_CODE,'')
		FROM #TMPARTDET A         
		JOIN ARTICLE B WITH (NOLOCK) ON A.ARTICLE_NO=B.ARTICLE_NO        
		LEFT JOIN PARA2 C WITH (NOLOCK) ON A.PARA2_NAME = C.PARA2_NAME AND C.INACTIVE =0            
		
		
		IF EXISTS (SELECT TOP 1 'U' FROM #TMPARTDET WHERE ISNULL(PARA2_CODE,'')='')
		begin

		    UPDATE A SET PARA2_CODE =ISNULL(C.PARA2_CODE,'')
			FROM #TMPARTDET A                
			 JOIN PARA2 C WITH (NOLOCK) ON A.PARA2_NAME = C.PARA2_NAME     
		

		end
		
		
	      
	    set @nStep=30.280
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                       
		INSERT ART_DET (ARTICLE_CODE,PARA2_CODE,MRP,ROW_ID,LAST_UPDATE,WS_PRICE,COMPANY_CODE,MRP_INC_AMT,MRP2,PARA1_CODE  
		,PARA2_RATIO,PURCHASE_PRICE,CENTER_POINT)        
		SELECT LTRIM(RTRIM(a.ARTICLE_CODE)), LTRIM(RTRIM(a.PARA2_CODE)),  A.MRP,        
	   NEWID() AS ROW_ID, GETDATE() AS LAST_UPDATE ,A.WS_PRICE ,'01',0,0,'0000000',0,A.PURCHASE_PRICE,0  
		FROM #TMPARTDET A             
		LEFT OUTER JOIN ART_DET X (NOLOCK) ON  a.ARTICLE_CODE = X.ARTICLE_CODE   AND a.PARA2_CODE = X.PARA2_CODE        
		WHERE X.ARTICLE_CODE IS NULL        
	      
	    set @nStep=30.285
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

	  INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                             
		UPDATE ARTICLE WITH (ROWLOCK) SET PARA1_SET=1 WHERE ARTICLE_CODE IN (SELECT ARTICLE_CODE FROM ART_PARA1 (NOLOCK))  
		AND ARTICLE_CODE IN (SELECT ARTICLE_CODE FROM ART_DET (NOLOCK) WHERE PARA2_CODE<>'0000000')                  
	      
	    set @nStep=30.290
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

	  INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                             
	  
	  UPDATE ARTICLE WITH (ROWLOCK) SET PARA2_SET=1 WHERE ARTICLE_CODE IN (SELECT ARTICLE_CODE FROM ART_DET (NOLOCK) WHERE PARA2_CODE<>'0000000')        
 END  
         
   set @nStep=30.295
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

 INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                     

      
   set @nStep=30.300
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

 INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())   
   
 DECLARE @CALIAS_WITH_PARA3 VARCHAR(10),@CALIAS VARCHAR(10)  
   
 SELECT TOP 1 @CALIAS_WITH_PARA3=VALUE  FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='PRIFIX_SUPP_ALIAS_WITH_PARA3'  
   
 IF ISNULL(@CALIAS_WITH_PARA3,'')='1'  
 SELECT TOP 1 @CALIAS=ALIAS_TO_BE_SUFFIXED  FROM LM01106 (NOLOCK) WHERE AC_CODE =@CAC_CODE   
   
 IF ISNULL(@CALIAS,'')<>''  
	 UPDATE #TMPMASTERSENC SET PARA3_NAME=PARA3_NAME+'-'+@CALIAS                  

   set @nStep=30.305
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())   
   
	DECLARE @AUTO_GENERATE_PARA3_IN_CASE_OF_BLANK VARCHAR(5)
	SELECT @AUTO_GENERATE_PARA3_IN_CASE_OF_BLANK=VALUE  FROM CONFIG WHERE CONFIG_OPTION='AUTO_GENERATE_PARA3_IN_CASE_OF_BLANK'

  if ISNULL(@AUTO_GENERATE_PARA3_IN_CASE_OF_BLANK,'')=1 AND @cSrcUploadTable<>''
  BEGIN
	SET @CCMD=N'UPDATE b SET para3_name=e.para3_name  
          FROM   '+@cSrcUploadTable+' A (NOLOCK)   
		 JOIN #TMPMASTERSENC B ON A.ROW_ID=B.ROW_ID    
         JOIN PARA3 E (NOLOCK) ON E.PARA3_code = a.PARA3_code
         WHERE ISNULL(E.PARA3_NAME,'''') NOT IN (''NA'','''') AND A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''' ' 
	PRINT @cCmd
	EXEC SP_EXECUTESQL @cCmd

  END   

   set @nStep=30.307
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())   

    SELECT DISTINCT CONVERT(CHAR(9),'') AS PARA3_CODE,LTRIM(RTRIM(a.PARA3_NAME)) AS PARA3_NAME,
	      isnull(LTRIM(RTRIM(a.PARA3_ALIAS)),'') AS PARA3_ALIAS
    INTO #TMPPARA3 FROM #TMPMASTERSENC  a      
    LEFT OUTER JOIN para3 b (NOLOCK) ON  LTRIM(RTRIM(a.PARA3_NAME))=LTRIM(RTRIM(b.PARA3_NAME))      
   WHERE b.para3_code IS NULL AND LTRIM(RTRIM(ISNULL(a.PARA3_NAME,'')))<>''
      
    set @nStep=30.310
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

 INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())   
  
  DECLARE @DO_NOT_CREATE_PARA3 VARCHAR(10)  
  SELECT TOP 1 @DO_NOT_CREATE_PARA3 =VALUE  FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION ='DO_NOT_CREATE_PARA3_MASTERS_IN_FILE_IMPORT'  
  IF ISNULL(@DO_NOT_CREATE_PARA3,'')='1'  
  BEGIN  
	    set @nStep=30.314
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

       IF EXISTS(SELECT TOP 1 'U' FROM #TMPPARA3)  
       BEGIN  
		 SELECT TOP 1 @CNEWSD=PARA3_NAME  FROM #TMPPARA3   
		 SET @CERRORMSG='NEW PARA3 :'+@CNEWSD+' NOT FOUND IN MASTERS'  
		 GOTO END_PROC  
    END  
    
  END  

   set @nStep=30.317
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
   
    -- SELECT * FROM #TMPPARA3     
    SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
          
    SELECT @UPDATEVALUE1 = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0) FROM         
      KEYS (NOLOCK) WHERE TABLENAME='PARA3' AND COLUMNNAME='PARA3_CODE'  AND ISNULL(LASTKEYVAL,'')<>''      
      AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))=0        
          
    SELECT @UPDATEVALUE2 = MAX(ISNULL(CONVERT(NUMERIC,SUBSTRING(PARA3_CODE,3,LEN(LTRIM(RTRIM(PARA3_CODE))))),0))        
    FROM  PARA3 (NOLOCK) WHERE PATINDEX('%[A-Z]%',SUBSTRING(PARA3_CODE,3,LEN(LTRIM(RTRIM(PARA3_CODE)))))=0        
    AND LTRIM(RTRIM(ISNULL(PARA3_CODE,'')))<>''  
          
   set @nStep=30.320
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
    
      
 INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                 
    IF ISNULL(@UPDATEVALUE1,0)>ISNULL(@UPDATEVALUE2,0)        
     SET @UPDATEVALUE=ISNULL(@UPDATEVALUE1,0)        
    ELSE        
     SET @UPDATEVALUE=ISNULL(@UPDATEVALUE2,0)        
          
   SET @BLOOP=0    
       
   WHILE @BLOOP=0    
   BEGIN      
			    set @nStep=30.325
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		UPDATE #TMPPARA3 SET PARA3_CODE = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
		@UPDATEVALUE = @UPDATEVALUE + 1        
	        
		IF NOT EXISTS (SELECT TOP 1 A.PARA3_CODE FROM PARA3 A JOIN #TMPPARA3 B ON A.PARA3_CODE=B.PARA3_CODE)    
			 SET @BLOOP=1               
		ELSE
			 set @UPDATEVALUE=@UPDATEVALUE+1   	 			  
   END    
    
   PRINT 'IMPORT MASTERS-'+(@NSTEP)    
     
   set @nStep=30.330
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                  
   INSERT PARA3 (PARA3_CODE,PARA3_NAME,REMARKS,LAST_UPDATE,ALIAS)        
   SELECT LTRIM(RTRIM(PARA3_CODE)),LTRIM(RTRIM(PARA3_NAME)),        
    '' AS REMARKS,GETDATE() AS LAST_UPDATE,PARA3_ALIAS AS ALIAS      
   FROM #TMPPARA3        
          
  
          
    IF  EXISTS (SELECT LASTKEYVAL FROM KEYS WHERE TABLENAME='PARA3')         
     UPDATE KEYS SET LASTKEYVAL = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))        
     WHERE TABLENAME='PARA3'  AND @UPDATEVALUE<>0        
    ELSE        
     INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
     VALUES  ('PARA3',@CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
      'PARA3_CODE','01','01109')        
          
   set @nStep=30.335
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                  
          
    SELECT DISTINCT CONVERT(CHAR(9),'') AS PARA4_CODE,LTRIM(RTRIM(a.PARA4_NAME)) AS PARA4_NAME,
	       isnull(LTRIM(RTRIM(a.PARA4_ALIAS)),'') AS PARA4_ALIAS
    INTO #TMPPARA4 FROM #TMPMASTERSENC a       
    LEFT OUTER JOIN para4 b (NOLOCK) ON  LTRIM(RTRIM(a.PARA4_NAME))=LTRIM(RTRIM(b.PARA4_NAME))      
    WHERE b.para4_code IS NULL AND LTRIM(RTRIM(ISNULL(a.PARA4_NAME,'')))<>''

   set @nStep=30.338
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
      
  DECLARE @DO_NOT_CREATE_PARA4 VARCHAR(10)  
  SELECT TOP 1 @DO_NOT_CREATE_PARA4 =VALUE  FROM CONFIG WHERE CONFIG_OPTION ='DO_NOT_CREATE_PARA4_MASTERS_IN_FILE_IMPORT'  
  IF ISNULL(@DO_NOT_CREATE_PARA4,'')='1'  
  BEGIN  
	    set @nStep=30.340
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

      IF EXISTS(SELECT TOP 1 'U' FROM #TMPPARA4)  
       BEGIN  
		 SELECT TOP 1 @CNEWSD=PARA4_NAME  FROM #TMPPARA4   
		 SET @CERRORMSG='NEW PARA4 :'+@CNEWSD+' NOT FOUND IN MASTERS'  
		 GOTO END_PROC  
    END  
    
  END  
         
   set @nStep=30.350
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
          
    SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
          
    SELECT @UPDATEVALUE1 = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0) FROM         
      KEYS WHERE TABLENAME='PARA4' AND COLUMNNAME='PARA4_CODE'  AND ISNULL(LASTKEYVAL,'')<>''      
      AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))=0        
          
    SELECT @UPDATEVALUE2 = MAX(ISNULL(CONVERT(NUMERIC,SUBSTRING(PARA4_CODE,3,LEN(LTRIM(RTRIM(PARA4_CODE))))),0))        
    FROM  PARA4 WHERE PATINDEX('%[A-Z]%',SUBSTRING(PARA4_CODE,3,LEN(LTRIM(RTRIM(PARA4_CODE)))))=0        
    AND LTRIM(RTRIM(ISNULL(PARA4_CODE,'')))<>''  
         
   set @nStep=30.355
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                      
    IF ISNULL(@UPDATEVALUE1,0)>ISNULL(@UPDATEVALUE2,0)        
     SET @UPDATEVALUE=ISNULL(@UPDATEVALUE1,0)        
    ELSE        
     SET @UPDATEVALUE=ISNULL(@UPDATEVALUE2,0)        
  

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                           
   SET @BLOOP=0    
   WHILE @BLOOP=0    
   BEGIN      
	    set @nStep=30.360
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		UPDATE #TMPPARA4 SET PARA4_CODE = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
		@UPDATEVALUE = @UPDATEVALUE + 1        
	        
		IF NOT EXISTS (SELECT TOP 1 A.PARA4_CODE FROM PARA4 A JOIN #TMPPARA4 B ON A.PARA4_CODE=B.PARA4_CODE)    
		   SET @BLOOP=1               
		ELSE
		   set @UPDATEVALUE=@UPDATEVALUE+1   	 			   
   END    
     
    
   set @nStep=30.365
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                      
    INSERT PARA4 (PARA4_CODE,PARA4_NAME,REMARKS,LAST_UPDATE,ALIAS)        
    SELECT LTRIM(RTRIM(PARA4_CODE)),LTRIM(RTRIM(PARA4_NAME)),        
    '' AS REMARKS,GETDATE() AS LAST_UPDATE,PARA4_ALIAS AS ALIAS        
    FROM #TMPPARA4        
          
   set @nStep=30.370
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                      
    IF  EXISTS (SELECT LASTKEYVAL FROM KEYS WHERE TABLENAME='PARA4')         
     UPDATE KEYS SET LASTKEYVAL = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))        
     WHERE TABLENAME='PARA4' AND @UPDATEVALUE<>0        
    ELSE        
     INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
     VALUES  ('PARA4',@CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
      'PARA4_CODE','01','01109')        
          
   set @nStep=30.375
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
       
    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                  
    SELECT DISTINCT CONVERT(CHAR(9),'') AS PARA5_CODE,LTRIM(RTRIM(a.PARA5_NAME)) AS PARA5_NAME,
	       isnull(LTRIM(RTRIM(a.PARA5_ALIAS)),'') AS PARA5_ALIAS
    INTO #TMPPARA5 
	FROM #TMPMASTERSENC a       
    LEFT OUTER JOIN para5 b (NOLOCK) ON  LTRIM(RTRIM(a.PARA5_NAME))=LTRIM(RTRIM(b.PARA5_NAME))      
    WHERE b.para5_code IS NULL AND LTRIM(RTRIM(ISNULL(a.PARA5_NAME,'')))<>''

   set @nStep=30.380
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
      
  DECLARE @DO_NOT_CREATE_PARA5 VARCHAR(10)  
  SELECT TOP 1 @DO_NOT_CREATE_PARA5 =VALUE  FROM CONFIG WHERE CONFIG_OPTION ='DO_NOT_CREATE_PARA5_MASTERS_IN_FILE_IMPORT'  
  IF ISNULL(@DO_NOT_CREATE_PARA5,'')='1'  
  BEGIN  
	    set @nStep=30.385
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

       IF EXISTS(SELECT TOP 1 'U' FROM #TMPPARA5)  
       BEGIN  
     SELECT TOP 1 @CNEWSD=PARA5_NAME  FROM #TMPPARA5   
     SET @CERRORMSG='NEW PARA5 :'+@CNEWSD+' NOT FOUND IN MASTERS'  
     GOTO END_PROC  
   END  
    
  END  
         
   set @nStep=30.390
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
         
    SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
          
    SELECT @UPDATEVALUE1 = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0) FROM         
      KEYS WHERE TABLENAME='PARA5' AND COLUMNNAME='PARA5_CODE' AND ISNULL(LASTKEYVAL,'')<>''        
      AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))=0        
          
    SELECT @UPDATEVALUE2 = MAX(ISNULL(CONVERT(NUMERIC,SUBSTRING(PARA5_CODE,3,LEN(LTRIM(RTRIM(PARA5_CODE))))),0))        
    FROM  PARA5 WHERE PATINDEX('%[A-Z]%',SUBSTRING(PARA5_CODE,3,LEN(LTRIM(RTRIM(PARA5_CODE)))))=0        
    AND LTRIM(RTRIM(ISNULL(PARA5_CODE,'')))<>''  
          
   set @nStep=30.395
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                  
          
    IF ISNULL(@UPDATEVALUE1,0)>ISNULL(@UPDATEVALUE2,0)        
     SET @UPDATEVALUE=ISNULL(@UPDATEVALUE1,0)        
    ELSE        
     SET @UPDATEVALUE=ISNULL(@UPDATEVALUE2,0)        
     
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                       
   SET @BLOOP=0    
   WHILE @BLOOP=0    
   BEGIN      
	    set @nStep=30.400
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		UPDATE #TMPPARA5 SET PARA5_CODE = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
		@UPDATEVALUE = @UPDATEVALUE + 1        
	        
		IF NOT EXISTS (SELECT TOP 1 A.PARA5_CODE FROM PARA5 A JOIN #TMPPARA5 B ON A.PARA5_CODE=B.PARA5_CODE)    
		   SET @BLOOP=1               
		ELSE
		   set @UPDATEVALUE=@UPDATEVALUE+1   	 			   
   END    
    
 PRINT 'IMPORT MASTERS-'+(@NSTEP)          
   set @nStep=30.405
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                        
    INSERT PARA5 (PARA5_CODE,PARA5_NAME,REMARKS,LAST_UPDATE,ALIAS)        
    SELECT DISTINCT LTRIM(RTRIM(PARA5_CODE)),LTRIM(RTRIM(PARA5_NAME)),        
    '' AS REMARKS,GETDATE() AS LAST_UPDATE,PARA5_ALIAS AS ALIAS        
    FROM #TMPPARA5        
                 
    IF  EXISTS (SELECT LASTKEYVAL FROM KEYS WHERE TABLENAME='PARA5')         
     UPDATE KEYS SET LASTKEYVAL = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))        
     WHERE TABLENAME='PARA5'  AND @UPDATEVALUE<>0        
    ELSE        
     INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
     VALUES  ('PARA5',@CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
      'PARA5_CODE','01','01109')        
     
     
	    set @nStep=30.410
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                  
    --PRINT 'CREATING PARA6...'        
          
    SELECT DISTINCT CONVERT(CHAR(9),'') AS PARA6_CODE,LTRIM(RTRIM(a.PARA6_NAME)) AS PARA6_NAME,
	       isnull(LTRIM(RTRIM(a.PARA6_ALIAS)),'') AS PARA6_ALIAS
    INTO #TMPPARA6 FROM #TMPMASTERSENC a       
    LEFT OUTER JOIN para6 b (NOLOCK) ON  LTRIM(RTRIM(a.PARA6_NAME))=LTRIM(RTRIM(b.PARA6_NAME))      
    WHERE b.para6_code IS NULL AND LTRIM(RTRIM(ISNULL(a.PARA6_NAME,'')))<>''
      
  DECLARE @DO_NOT_CREATE_PARA6 VARCHAR(10)  
  SELECT TOP 1 @DO_NOT_CREATE_PARA6 =VALUE  FROM CONFIG WHERE CONFIG_OPTION ='DO_NOT_CREATE_PARA6_MASTERS_IN_FILE_IMPORT'  
  IF ISNULL(@DO_NOT_CREATE_PARA6,'')='1'  
  BEGIN  
	   set @nStep=30.415
	   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

       IF EXISTS(SELECT TOP 1 'U' FROM #TMPPARA6)  
       BEGIN  
     SELECT TOP 1 @CNEWSD=PARA6_NAME  FROM #TMPPARA6   
     SET @CERRORMSG='NEW PARA6 :'+@CNEWSD+' NOT FOUND IN MASTERS'  
     GOTO END_PROC  
    END  
    
  END  
   
   set @nStep=30.420
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
   
    SELECT @UPDATEVALUE = 0,@UPDATEVALUE1 = 0,@UPDATEVALUE2 = 0        
          
    SELECT @UPDATEVALUE1 = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0)         
    FROM KEYS         
    WHERE TABLENAME = 'PARA6'         
    AND COLUMNNAME = 'PARA6_CODE'  AND ISNULL(LASTKEYVAL,'')<>''      
    AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL))) = 0        
          
      
    SELECT @UPDATEVALUE2 = MAX(ISNULL(CONVERT(NUMERIC,SUBSTRING(PARA6_CODE,3,LEN(LTRIM(RTRIM(PARA6_CODE))))),0))        
    FROM  PARA6         
    WHERE PATINDEX('%[A-Z]%',SUBSTRING(PARA6_CODE,3,LEN(LTRIM(RTRIM(PARA6_CODE)))))=0        
    AND LTRIM(RTRIM(ISNULL(PARA6_CODE,'')))<>''  
          
    IF ISNULL(@UPDATEVALUE1,0)>ISNULL(@UPDATEVALUE2,0)        
     SET @UPDATEVALUE=ISNULL(@UPDATEVALUE1,0)        
    ELSE        
     SET @UPDATEVALUE=ISNULL(@UPDATEVALUE2,0)        

   set @nStep=30.425
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
          
   SET @BLOOP=0    
     

   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                    
   WHILE @BLOOP=0    
   BEGIN      
		UPDATE #TMPPARA6 SET PARA6_CODE = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
		@UPDATEVALUE = @UPDATEVALUE + 1        
	        
		IF NOT EXISTS (SELECT TOP 1 A.PARA6_CODE FROM PARA6 A JOIN #TMPPARA6 B ON A.PARA6_CODE=    
		   B.PARA6_CODE)    
		   SET @BLOOP=1               
		ELSE
    	   set @UPDATEVALUE=@UPDATEVALUE+1   	 			   
   END    
    
   set @nStep=30.430
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                  
 PRINT 'IMPORT MASTERS-'+(@NSTEP)          
    INSERT PARA6 (PARA6_CODE,PARA6_NAME,REMARKS,LAST_UPDATE,ALIAS)        
    SELECT DISTINCT LTRIM(RTRIM(PARA6_CODE)),LTRIM(RTRIM(PARA6_NAME)),        
    '' AS REMARKS,GETDATE() AS LAST_UPDATE,PARA6_ALIAS AS ALIAS        
    FROM #TMPPARA6        
      
    IF  EXISTS (SELECT LASTKEYVAL FROM KEYS WHERE TABLENAME='PARA6')         
     UPDATE KEYS SET LASTKEYVAL = @CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE))        
     WHERE TABLENAME='PARA6' AND @UPDATEVALUE<>0        
    ELSE        
     INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
     VALUES  ('PARA6',@CLOCID+REPLICATE('0',7-LEN(LTRIM(STR(@UPDATEVALUE))))+LTRIM(STR(@UPDATEVALUE)),        
      'PARA6_CODE','01','01109')        
          
   set @nStep=30.435
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                      
      
    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                            
    SELECT DISTINCT CONVERT(CHAR(7),'') AS FORM_ID,LTRIM(RTRIM(FORM_NAME)) AS FORM_NAME          
    INTO #TMPFORM FROM #TMPMASTERSENC          
    WHERE LTRIM(RTRIM(FORM_NAME)) NOT IN (SELECT LTRIM(RTRIM(FORM_NAME)) FROM FORM)   AND LTRIM(RTRIM(ISNULL(FORM_NAME,'')))<>''   
      
  DECLARE @DO_NOT_CREATE_FORM VARCHAR(10)  
  SELECT TOP 1 @DO_NOT_CREATE_FORM =VALUE  FROM CONFIG WHERE CONFIG_OPTION ='DO_NOT_CREATE_FORM_MASTERS_IN_FILE_IMPORT'  
  IF ISNULL(@DO_NOT_CREATE_FORM,'')='1'  
  BEGIN  
	  set @nStep=30.440
	   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

      IF EXISTS(SELECT TOP 1 'U' FROM #TMPFORM)  
       BEGIN  
     SELECT TOP 1 @CNEWSD=FORM_NAME  FROM #TMPFORM   
     SET @CERRORMSG='NEW FORM :'+@CNEWSD+' NOT FOUND IN MASTERS'  
     GOTO END_PROC  
   END  
  END       
   --PRINT 'INSERTING SUPPLIERS ...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) )         
     
   IF EXISTS(SELECT TOP 1 AC_NAME FROM #TMPMASTERSENC WHERE ISNULL(AC_NAME,'')<>'')        
   BEGIN        

   set @nStep=30.450
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
         
    
    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                                    
          
    SELECT DISTINCT CONVERT(CHAR(10),'') AS AC_CODE,LTRIM(RTRIM(a.AC_NAME)) AS AC_NAME  
    INTO #TMPLMV FROM #TMPMASTERSENC a
    LEFT OUTER JOIN lm01106 b ON LTRIM(RTRIM(a.AC_NAME))=LTRIM(RTRIM(b.AC_NAME))
    WHERE LTRIM(RTRIM(ISNULL(a.AC_NAME,'')))<>'' AND b.AC_CODE IS NULL       
      
      DECLARE @DO_NOT_CREATE_AC VARCHAR(10)  
	  SELECT TOP 1 @DO_NOT_CREATE_AC =VALUE  FROM CONFIG WHERE CONFIG_OPTION ='DO_NOT_CREATE_AC_MASTERS_IN_FILE_IMPORT'  
	  IF ISNULL(@DO_NOT_CREATE_AC,'')='1'  
	  BEGIN  
		  set @nStep=30.454
		  EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		  IF EXISTS(SELECT TOP 1 'U' FROM #TMPFORM)  
		   BEGIN  
		 SELECT TOP 1 @CNEWSD=AC_NAME  FROM #TMPLMV   
		 SET @CERRORMSG='NEW AC NAME :'+@CNEWSD+' NOT FOUND IN MASTERS'  
		 GOTO END_PROC  
	   END   
    
     END  
    
   set @nStep=30.458
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                            
    SELECT @UPDATEVALUE = ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,LEN(LASTKEYVAL)))),0)         
    FROM KEYS         
    WHERE TABLENAME = 'LMV01106'         
    AND COLUMNNAME = 'AC_CODE'        
    AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,LEN(LTRIM(RTRIM(LASTKEYVAL)))))=0    
    
  
 SET @NSTEP=670  
    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                            
 SET @BLOOP=0    
    WHILE @BLOOP=0    
    BEGIN      
	   set @nStep=30.462
	   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
    
	         
	  UPDATE #TMPLMV SET         
	  AC_CODE = @CLOCID + REPLICATE('0',8-LEN(LTRIM(STR(@UPDATEVALUE)))) + LTRIM(STR(@UPDATEVALUE)),        
	  @UPDATEVALUE = @UPDATEVALUE + 1        
	         
	  IF NOT EXISTS (SELECT TOP 1 A.AC_CODE FROM LM01106 A JOIN #TMPLMV B ON A.AC_CODE=B.AC_CODE)    
			SET @BLOOP=1               
	  ELSE
	 	 set @UPDATEVALUE=@UPDATEVALUE+1   	 			
  	END    
    
    PRINT 'IMPORT MASTERS-'+(@NSTEP)             
    
   set @nStep=30.465
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                            
    INSERT LMV01106 ( AC_CODE, AC_NAME, ALIAS, HEAD_CODE, CLOSING_BALANCE, CLOSING_BALANCE_CR_DR,         
    PRINT_LEDGER, LAST_UPDATE, PRINT_NAME, ADDRESS0, ADDRESS1, ADDRESS2,         
    AREA_CODE, AREA_NAME, PINCODE, CITY_CODE, CITY, STATE_CODE, STATE,        
    CST_NO, CST_DT, SST_NO, SST_DT, TIN_NO, TIN_DT, PHONES_R, PHONES_O,         
    PHONES_FAX, MOBILE, E_MAIL, TAX_CODE, CREDIT_DAYS, DISCOUNT_PERCENTAGE,         
    BILL_BY_BILL, ON_HOLD, THROUGH_BROKER, BROKER_AC_CODE, BROKER_COMM_PERCENT,         
    CREDIT_LIMIT, OUTSTATION_PARTY, ALLOW_CREDITOR_DEBTOR, COMPANY_CODE, DPWEF_DT,         
    CST_PERCENTAGE, PAN_NO, FORM_ID, INV_RATE_TYPE, CUSTOMER_CODE,     
    GLN_NO, MP_PERCENTAGE, MRP_CALC_MODE, TDS_CODE,  REGION_NAME,INACTIVE,DEFAULT_RATE_TYPE,MAJOR_AC_CODE)        
    SELECT  DISTINCT a.AC_CODE, a.AC_NAME, '' AS ALIAS, '0000000021' AS HEAD_CODE, 0 AS CLOSING_BALANCE, '' AS CLOSING_BALANCE_CR_DR,        
    0 AS PRINT_LEDGER, GETDATE() AS LAST_UPDATE, a.AC_NAME AS PRINT_NAME, '' AS ADDRESS0, '' AS ADDRESS1,        
    '' AS ADDRESS2, '0000000' AS AREA_CODE, '' AS AREA_NAME, '' AS PINCODE, '0000000' AS CITY_CODE,        
    '' AS CITY, '0000000' AS STATE_CODE, '' AS STATE, '' AS CST_NO, '' AS CST_DT, '' AS SST_NO,         
    '' AS SST_DT, '' AS TIN_NO, '' AS TIN_DT, '' AS PHONES_R, '' AS PHONES_O, '' AS PHONES_FAX,        
    '' AS MOBILE, '' AS E_MAIL, '' AS TAX_CODE, 0 AS CREDIT_DAYS, 0 AS DISCOUNT_PERCENTAGE,        
    0 AS BILL_BY_BILL, 0 AS ON_HOLD, 0 AS THROUGH_BROKER, '' AS BROKER_AC_CODE, 0 AS BROKER_COMM_PERCENT,         
    0 AS CREDIT_LIMIT, 0 AS OUTSTATION_PARTY, 0 AS ALLOW_CREDITOR_DEBTOR, '01' AS COMPANY_CODE,        
    '' AS DPWEF_DT, 0 AS CST_PERCENTAGE, '' AS PAN_NO, '0000000' AS FORM_ID, 1 AS INV_RATE_TYPE,        
    '000000000000' AS CUSTOMER_CODE,  '' AS GLN_NO,     
    0 AS MP_PERCENTAGE, 0 AS MRP_CALC_MODE, '' AS TDS_CODE, '' AS REGION_NAME,0 AS INACTIVE,0 AS DEFAULT_RATE_TYPE,  
    a.AC_CODE        
   FROM #TMPLMV a LEFT OUTER JOIN
    LM01106 b ON LTRIM(RTRIM(a.AC_NAME))=LTRIM(RTRIM(b.AC_NAME))
    WHERE b.AC_CODE IS NULL
          
          
    set @nStep=30.469
    EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

    INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                            
    IF EXISTS (SELECT LASTKEYVAL FROM KEYS WHERE TABLENAME='LMV01106')         
    UPDATE KEYS SET LASTKEYVAL = @CLOCID + REPLICATE('0',8-LEN(LTRIM(STR(@UPDATEVALUE)))) + LTRIM(STR(@UPDATEVALUE))  
    WHERE TABLENAME='LMV01106' AND @UPDATEVALUE<>0        
    ELSE        
     INSERT KEYS (TABLENAME,LASTKEYVAL,COLUMNNAME,PREFIX,FINYEAR)        
     VALUES  ('LMV01106',@CLOCID + REPLICATE('0',8-LEN(LTRIM(STR(@UPDATEVALUE)))) + LTRIM(STR(@UPDATEVALUE)),        
     'AC_CODE',@CLOCID,'01109')        
   END        
    
    
   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                            
   --PRINT 'INSERTING SUPPLIERS ...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) ) +' SECONDS...'       
	
   set @nStep=30.482
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

	   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                                  
	   IF EXISTS ( SELECT TOP 1 A.PRODUCT_CODE FROM #TMPMASTERSENC A         
		  JOIN article c ON c.article_no=a.article_no
		  WHERE (isnull(A.PRODUCT_CODE,'') = '' and c.gen_ean_codes=1)  
		 )         
	   BEGIN        
		   --EAN CODE GENERATION IN CASE OF MASTER IMPORT  
		   --- comment by sumit on behalf of Dinkar sir   
		   --- Again UnComment by Sanjay on behalf of discussion between Sir & Dinkar for Patanjali
		   --- requirement of generating EAN in Maters Import/Article save (16-05-2019)
		   IF ISNULL(@NIMPORTFROM,0)=2 
		   BEGIN  
		
			   set @nStep=30.488
			   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

			   --as Slow Process No need to add Cloumn In #table (02072022)

			 --  IF NOT EXISTS (SELECT TOP 1 * FROM tempdb.INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME='row_id'
				--			  AND TABLE_NAME LIKE '%#TMPMASTERSENC%')		
				--	ALTER TABLE #TMPMASTERSENC ADD ROW_ID VARCHAR(40)  
					
				--IF NOT EXISTS (SELECT TOP 1 * FROM tempdb.INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME='ARTICLE_CODE'
				--			  AND TABLE_NAME LIKE '%#TMPMASTERSENC%')		
				--	ALTER TABLE #TMPMASTERSENC ADD ARTICLE_CODE VARCHAR(10)  
						
				--IF NOT EXISTS (SELECT TOP 1 * FROM tempdb.INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME='PARA1_CODE'
				--			  AND TABLE_NAME LIKE '%#TMPMASTERSENC%')		
				--	ALTER TABLE #TMPMASTERSENC ADD PARA1_CODE VARCHAR(10)  
					
				--IF NOT EXISTS (SELECT TOP 1 * FROM tempdb.INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME='PARA2_CODE'
				--			  AND TABLE_NAME LIKE '%#TMPMASTERSENC%')		
				--	ALTER TABLE #TMPMASTERSENC ADD PARA2_CODE VARCHAR(10) 
			
			   set @nStep=30.492
			   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
	
			   UPDATE #TMPMASTERSENC SET ROW_ID=CAST(NEWID() AS VARCHAR(40))  

			 
			   set @nStep=30.495
			   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		
			   EXEC SAVETRAN_GENBARCODES    
				 @CXNID  = ''    
			   , @CPREFIX  = ''    
			   , @NMODE  = 13    
			   , @LOCID  = @cdept_id   
			   , @CERRORMSG = @CERRORMSG OUTPUT   
			   
 
				IF ISNULL(@CERRORMSG,'')<>''    
				  GOTO END_PROC    
		         
		   END  
		
		END

		
 
  
	    IF EXISTS (SELECT TOP 1 PRODUCT_CODE FROM #TMPMASTERSENC WHERE ISNULL(PRODUCT_CODE,'')<>'')        
        BEGIN        				     
		   set @nStep=30.504
		   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
		       
		   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                              
		       
		   set @nStep=30.507
		   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
		       
		  SELECT  DISTINCT LTRIM(RTRIM(A.PRODUCT_CODE)) AS PRODUCT_CODE,
		  ISNULL(LTRIM(RTRIM(A.PRODUCT_NAME)),'') AS PRODUCT_NAME,  
		  CONVERT(VARCHAR(10),'00000000') AS ARTICLE_CODE,    
		  CONVERT(VARCHAR(10),'0000000') AS PARA1_CODE,CONVERT(VARCHAR(10),'0000000') AS PARA2_CODE,
		  A.MRP,GETDATE() AS LAST_UPDATE, A.PURCHASE_PRICE,        
		  CONVERT(VARCHAR(10),'0000000') AS PARA3_CODE,A.WS_PRICE,        
		  isnull(PUR_BILL_DATE,'') AS INV_DT,  isnull(PUR_BILL_NO,'') AS INV_NO,        
		  CONVERT(VARCHAR(10),'0000000000') AS AC_CODE, '' AS RECEIPT_DT,        
		  CONVERT(VARCHAR(10),'0000000') AS  PARA4_CODE,         
		  CONVERT(VARCHAR(10),'0000000') AS PARA5_CODE,        
		  CONVERT(VARCHAR(10),'0000000') AS PARA6_CODE,  
		  LTRIM(RTRIM(A.CODING_SCHEME)) AS CODING_SCHEME,  
		  LTRIM(RTRIM(ARTICLE_NO)) AS ARTICLE_NO,  
		  LTRIM(RTRIM(PARA1_NAME)) AS PARA1_NAME,  
		  LTRIM(RTRIM(PARA2_NAME)) AS PARA2_NAME,  
		  LTRIM(RTRIM(PARA3_NAME)) AS PARA3_NAME,    
		  LTRIM(RTRIM(PARA4_NAME)) AS PARA4_NAME,LTRIM(RTRIM(PARA5_NAME)) AS PARA5_NAME,  
		  LTRIM(RTRIM(PARA6_NAME)) AS PARA6_NAME,  
		  LTRIM(RTRIM(AC_NAME)) AS AC_NAME,  
		  LTRIM(RTRIM(A.HSN_CODE)) AS HSN_CODE ,
		  a.VENDOR_EAN_NO
		  ,a.BATCH_NO,a.EXPIRY_DT,CONVERT(BIT,0) DEPRICIATION_PC
	
		  INTO #TMPSKU 
		  FROM #TMPMASTERSENC A         
		--  LEFT OUTER JOIN SKU K (NOLOCK) ON RTRIM(LTRIM(K.PRODUCT_CODE)) = RTRIM(LTRIM(A.PRODUCT_CODE))  
		  WHERE ISNULL(A.PRODUCT_CODE,'')<>''         
		--   AND ((@COVERWRITE<>'1' AND @NIMPORTFROM=2) or K.PRODUCT_CODE IS NULL)        
		   AND A.SECTION_NAME+A.SUB_SECTION_NAME+A.ARTICLE_NO+ISNULL(A.PARA1_NAME,'')+ISNULL(A.PARA2_NAME,'')+        
		   ISNULL(A.PARA3_NAME,'')+ISNULL(A.PARA4_NAME,'')+ISNULL(A.PARA5_NAME,'')+ISNULL(A.PARA6_NAME,'')+        
		   ISNULL(A.UOM_NAME,'')+ISNULL(A.AC_NAME,'')+STR(ISNULL(A.MRP,0),10,2)+STR(ISNULL(A.PURCHASE_PRICE,0),10,2)        
		   =(SELECT TOP 1 SECTION_NAME+SUB_SECTION_NAME+ARTICLE_NO+ISNULL(PARA1_NAME,'')+ISNULL(PARA2_NAME,'')+        
		   ISNULL(PARA3_NAME,'')+ISNULL(PARA4_NAME,'')+ISNULL(PARA5_NAME,'')+ISNULL(PARA6_NAME,'')+        
		   ISNULL(UOM_NAME,'')+ISNULL(AC_NAME,'')+STR(ISNULL(MRP,0),10,2)+STR(ISNULL(PURCHASE_PRICE,0),10,2)    
		   FROM #TMPMASTERSENC WHERE PRODUCT_CODE=A.PRODUCT_CODE)       
		   
		   IF @COVERWRITE='1'
		      DELETE A FROM #TMPSKU A
			  JOIN SKU B (NOLOCK)  ON A.PRODUCT_CODE=B.PRODUCT_CODE
		      
   set @nStep=30.510
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	  
   
 
   set @nStep=30.5102
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	  
    
	--if isnull(@DONOTUPDATEMASTERS_DEPRECIATION,'')<>'1'
	--begin           
	UPDATE A SET VENDOR_EAN_NO=B. VENDOR_EAN_NO,BARCODE_CODING_SCHEME=B.CODING_SCHEME
	FROM SKU A (NOLOCK)
	JOIN #TMPMASTERSENC B ON A.PRODUCT_CODE=B.PRODUCT_CODE 

	--end
						   
		UPDATE A SET MRP=CASE WHEN ISNULL(A.MRP,0)=0 THEN B.MRP ELSE A.MRP END,
		PURCHASE_PRICE=CASE WHEN ISNULL(A.PURCHASE_PRICE,0)=0 THEN B.PURCHASE_PRICE ELSE A.PURCHASE_PRICE END,
		WS_PRICE=CASE WHEN ISNULL(A.WS_PRICE,0)=0 THEN B.WS_PRICE ELSE A.WS_PRICE END
		FROM #tmpSKU A 
		JOIN #TMPMASTERSENC B ON A.PRODUCT_CODE =B.PRODUCT_CODE

		
		SET @DCURDT = GETDATE()          
	          
	   set @nStep=30.5104
	   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                            
		PRINT 'UPDATING SKU ...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) ) 
		
		UPDATE A WITH (ROWLOCK) SET ARTICLE_CODE=(CASE WHEN ISNULL(B.ARTICLE_NO,'')<>'' THEN ISNULL(C.ARTICLE_CODE,A.ARTICLE_CODE) ELSE A.ARTICLE_CODE END),        
		 PARA1_CODE = (CASE WHEN ISNULL(B.PARA1_NAME,'')<>'' THEN ISNULL(D.PARA1_CODE,A.PARA1_CODE) ELSE A.PARA1_CODE END),        
		 PARA2_CODE = (CASE WHEN ISNULL(B.PARA2_NAME,'')<>'' THEN ISNULL(E.PARA2_CODE,A.PARA2_CODE) ELSE A.PARA2_CODE END),        
		 PARA3_CODE = (CASE WHEN ISNULL(B.PARA3_NAME,'')<>'' THEN ISNULL(F.PARA3_CODE,A.PARA3_CODE) ELSE A.PARA3_CODE END),        
		 PARA4_CODE = (CASE WHEN ISNULL(B.PARA4_NAME,'')<>'' THEN ISNULL(G.PARA4_CODE,A.PARA4_CODE) ELSE A.PARA4_CODE END),        
		 PARA5_CODE = (CASE WHEN ISNULL(B.PARA5_NAME,'')<>'' THEN ISNULL(H.PARA5_CODE,A.PARA5_CODE) ELSE A.PARA5_CODE END),        
		 PARA6_CODE = (CASE WHEN ISNULL(B.PARA6_NAME,'')<>'' THEN ISNULL(I.PARA6_CODE,A.PARA6_CODE) ELSE A.PARA6_CODE END),        
		 AC_CODE = (CASE WHEN ISNULL(B.AC_NAME,'')<>'' THEN ISNULL(J.AC_CODE,A.AC_CODE) ELSE A.AC_CODE END),        
		 PURCHASE_PRICE = (CASE WHEN ISNULL(B.PURCHASE_PRICE,0)<>0 THEN B.PURCHASE_PRICE ELSE A.PURCHASE_PRICE END),        
		 MRP  = (CASE WHEN ISNULL(B.MRP,0)<>0 THEN B.MRP ELSE A.MRP END),        
		 WS_PRICE = (CASE WHEN ISNULL(B.WS_PRICE,0)<>0 THEN B.WS_PRICE ELSE A.WS_PRICE END),        
		 PRODUCT_NAME=(CASE WHEN ISNULL(B.PRODUCT_NAME,'')<>'' THEN B.PRODUCT_NAME ELSE isnull(C.ARTICLE_NAME,'') END),
		 CODING_SCHEME =CASE WHEN ISNULL(B.CODING_SCHEME,0)<>0 THEN ISNULL(B.CODING_SCHEME,0)
		 ELSE @BCODING_SCHEME END
		FROM #tmpSKU A         
		JOIN #TMPMASTERSENC B ON A.PRODUCT_CODE=B.PRODUCT_CODE
		LEFT JOIN sku (NOLOCK) ON sku.product_code=a.PRODUCT_CODE        
		LEFT OUTER JOIN ARTICLE C WITH (NOLOCK) ON C.ARTICLE_NO=B.ARTICLE_NO        
		LEFT OUTER JOIN PARA1 D WITH (NOLOCK) ON D.PARA1_NAME=B.PARA1_NAME        
		LEFT OUTER JOIN PARA2 E WITH (NOLOCK) ON E.PARA2_NAME=B.PARA2_NAME        
		LEFT OUTER JOIN PARA3 F WITH (NOLOCK) ON F.PARA3_NAME=B.PARA3_NAME        
		LEFT OUTER JOIN PARA4 G WITH (NOLOCK) ON G.PARA4_NAME=B.PARA4_NAME        
		LEFT OUTER JOIN PARA5 H WITH (NOLOCK) ON H.PARA5_NAME=B.PARA5_NAME        
		LEFT OUTER JOIN PARA6 I WITH (NOLOCK) ON I.PARA6_NAME=B.PARA6_NAME        
		LEFT OUTER JOIN LM01106 J WITH (NOLOCK) ON J.AC_NAME=B.AC_NAME        
		LEFT OUTER JOIN UOM K WITH (NOLOCK) ON K.UOM_NAME=B.UOM_NAME    
		
		    
	 
   PRINT 'UPDATING SKU Finished ...'+ CAST( DATEDIFF( SS, @DCURDT, GETDATE() ) AS VARCHAR(10) )         
		      
   set @nStep=30.515
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

	IF @CAC_CODE<>''  
		UPDATE #TMPSKU SET AC_CODE=@CAC_CODE  
		      
   set @nStep=30.518
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
		      
	--CHANGES FOR DUPLICATE BARCODE FOUND IN SIYARAM IMPORT ERP CHALLAN  
	;WITH CTE AS  
	(  
	SELECT SR=ROW_NUMBER () OVER (PARTITION BY PRODUCT_CODE ORDER BY WS_PRICE DESC), * FROM  
	#TMPSKU  
	)  
	DELETE  FROM CTE WHERE SR >1  
		      

	set @nStep=30.520
	EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

   
	 IF ISNULL(@DONOTUPDATEMASTERS_DEPRECIATION,'')='1'
		UPDATE #tmpsku SET DEPRICIATION_PC=b.DEPRECIATION FROM sku_oh b (NOLOCK)
		WHERE b.product_code=#tmpsku.product_code

	set @nStep=30.522
	EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              


    
   UPDATE sku WITH (ROWLOCK) SET 
   ARTICLE_CODE=b.ARTICLE_CODE,
		 PARA1_CODE =b.PARA1_CODE,
		 PARA2_CODE = b.PARA2_CODE,
		 PARA3_CODE = b.PARA3_CODE,
		 PARA4_CODE = b.PARA4_CODE,
		 PARA5_CODE = b.PARA5_CODE,
		 PARA6_CODE = b.PARA6_CODE,
		 AC_CODE = b.ac_code,
		 PURCHASE_PRICE = b.purchase_price,
		 MRP  = b.mrp,
		 WS_PRICE = b.ws_price,
		 PRODUCT_NAME=B.PRODUCT_NAME,
		 barcode_CODING_SCHEME = b.coding_scheme,
		 BATCH_NO=b.BATCH_NO,
		 EXPIRY_DT=b.EXPIRY_DT,
		 VENDOR_EAN_NO=b. VENDOR_EAN_NO
	FROM #tmpsku b WHERE b.PRODUCT_CODE=sku.product_code
	AND ISNULL(b.DEPRICIATION_PC,0)=0
	and ( b.coding_scheme<> 1 or CHARINDEX ('@',b.product_code)>0)

	IF EXISTS (SELECT TOP 1'U' FROM #TMPSKU WHERE ISNULL(coding_scheme,0) NOT IN(1,2,3))
	begin
           SET @CERRORMSG =' Please Input correct Barcode coding Scheme(1,2,3)  '  
		   GOTO END_PROC  
	end



	set @nStep=30.524
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
		   INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                               
		   INSERT SKU ( PRODUCT_CODE,PRODUCT_NAME, ARTICLE_CODE, PARA1_CODE, PARA2_CODE, MRP,  LAST_UPDATE,         
		   PURCHASE_PRICE, PARA3_CODE, WS_PRICE,  INV_DT,          
		   INV_NO, AC_CODE, RECEIPT_DT, PARA4_CODE, PARA5_CODE, PARA6_CODE,
		   BARCODE_CODING_SCHEME,HSN_CODE,VENDOR_EAN_NO,BATCH_NO,EXPIRY_DT,ER_FLAG,purchaseLocId  )    
		   
		   SELECT  DISTINCT a.PRODUCT_CODE,a.PRODUCT_NAME,a.ARTICLE_CODE,a.PARA1_CODE,        
		   a.PARA2_CODE,a.MRP,a.LAST_UPDATE,a.PURCHASE_PRICE,a.PARA3_CODE,a.WS_PRICE,a.INV_DT,a.INV_NO,
		   a.AC_CODE,a.RECEIPT_DT,a.PARA4_CODE,a.PARA5_CODE,a.PARA6_CODE,
		   a.CODING_SCHEME,
		   a.HSN_CODE ,
		   a.VENDOR_EAN_NO ,a.BATCH_NO,a.EXPIRY_DT ,@NMEMOTYPE as ER_FLAG,@CLOCID as purchaseLocId
		   FROM #TMPSKU a 
		   LEFT JOIN sku b (NOLOCK) ON a.PRODUCT_CODE=b.product_code
		   WHERE b.product_code IS NULL  
		     
		     
		     
   set @nStep=30.525
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		   INSERT SKU_OH( PRODUCT_CODE, DISCOUNT_AMOUNT, TAX_AMOUNT, FREIGHT, OTHER_CHARGES, ROUND_OFF, VALUE_ADD,EXCISE_DUTY_AMOUNT )    
		   SELECT DISTINCT a.PRODUCT_CODE,0 AS  DISCOUNT_AMOUNT, 0 AS TAX_AMOUNT,0 AS  FREIGHT,
		   0 AS OTHER_CHARGES, 0 AS ROUND_OFF,0 AS  VALUE_ADD,0 AS  EXCISE_DUTY_AMOUNT  
		   FROM #TMPSKU  a left join  sku_oh b (NOLOCK) ON a.product_code=b.product_CODE
		   WHERE b.product_code IS NULL
		   
		   --SKU_NAMES
   set @nStep=30.530
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
	
		INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())                                                    
		INSERT PMT01106 ( PRODUCT_CODE,  QUANTITY_IN_STOCK,  DEPT_ID,               
		 LAST_UPDATE, REP_ID,BIN_ID )        
	          
		SELECT DISTINCT A.PRODUCT_CODE,0 AS QUANTITY_IN_STOCK,        
		   @CLOCID AS DEPT_ID,      
		  '' AS LAST_UPDATE, '' AS REP_ID  ,ISNULL(A.BIN_ID,'000')      
		FROM #TMPMASTERSENC A         
		JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE = B.PRODUCT_CODE        
		LEFT OUTER JOIN PMT01106 C WITH (NOLOCK,INDEX=IND_PMT01106_PC) ON B.PRODUCT_CODE = C.PRODUCT_CODE        
		WHERE A.PRODUCT_CODE <> ''        
		AND   C.PRODUCT_CODE IS NULL        
	   	
   set @nStep=30.540
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())    
		                                       
		UPDATE A SET        
		 ARTICLE_CODE= B.ARTICLE_CODE,        
		 PARA1_CODE = B.PARA1_CODE,        
		 PARA2_CODE = B.PARA2_CODE,        
		 PARA3_CODE = B.PARA3_CODE,        
		 PARA4_CODE = B.PARA4_CODE,        
		 PARA5_CODE = B.PARA5_CODE,        
		 PARA6_CODE = B.PARA6_CODE        
		FROM PID01106 A         
		JOIN SKU B (NOLOCK)  ON A.PRODUCT_CODE = B.PRODUCT_CODE        
		JOIN #TMPMASTERSENC C  ON B.PRODUCT_CODE = C.PRODUCT_CODE        
		WHERE (          
		 A.ARTICLE_CODE <> B.ARTICLE_CODE OR        
		 A.PARA1_CODE <> B.PARA1_CODE OR        
		 A.PARA2_CODE <> B.PARA2_CODE OR        
		 A.PARA3_CODE <> B.PARA3_CODE OR        
		 A.PARA4_CODE <> B.PARA4_CODE OR        
		 A.PARA5_CODE <> B.PARA5_CODE OR        
		 A.PARA6_CODE <> B.PARA6_CODE )   
		 AND C.PRODUCT_CODE<>''
	    
   set @nStep=30.550
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              

		INSERT IMPORT_INFO VALUES (@NSTEP,GETDATE())  
		
		                                          
		UPDATE A SET          
		 ARTICLE_CODE= B.ARTICLE_CODE,          
		 PARA1_CODE = B.PARA1_CODE,          
		 PARA2_CODE = B.PARA2_CODE,          
		 PARA3_CODE = B.PARA3_CODE,          
		 PARA4_CODE = B.PARA4_CODE,          
		 PARA5_CODE = B.PARA5_CODE,          
		 PARA6_CODE = B.PARA6_CODE          
		FROM POD01106 A           
		JOIN SKU B (NOLOCK)  ON A.PRODUCT_CODE = B.PRODUCT_CODE          
		JOIN #TMPMASTERSENC C  ON B.PRODUCT_CODE = C.PRODUCT_CODE          
		WHERE (            
		 A.ARTICLE_CODE <> B.ARTICLE_CODE OR          
		 A.PARA1_CODE <> B.PARA1_CODE OR          
		 A.PARA2_CODE <> B.PARA2_CODE OR          
		 A.PARA3_CODE <> B.PARA3_CODE OR          
		 A.PARA4_CODE <> B.PARA4_CODE OR          
		 A.PARA5_CODE <> B.PARA5_CODE OR          
		 A.PARA6_CODE <> B.PARA6_CODE )   
		 AND C.PRODUCT_CODE<>''
	    
		PRINT 'IMPORT MASTERS-'+(@NSTEP)                
	          
   set @nStep=30.556
   EXEC SP_CHKXNSAVELOG 'PUR',@nStep,1,@nSpId,'',1	              
	
	END  
	
	
 END TRY      
       
 BEGIN CATCH      
  SET @CERRORMSG = 'ERROR IN UPDATING MASTERS (SP_GETMASTERS) AT STEP- ' + LTRIM(@NSTEP) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()      
        
 END CATCH   
  
END_PROC:  
        
END  
---END OF PROCEDURE - SP_GETMASTERS  
