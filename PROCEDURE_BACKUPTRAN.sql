CREATE PROCEDURE BACKUPTRAN
		@CDB VARCHAR(40),
		@CBACKUPPATH VARCHAR(1000),
		@cErrormsg VARCHAR(MAX) OUTPUT
AS
BEGIN	
	DECLARE @CCMD NVARCHAR(4000),
			@CDBDEVICE VARCHAR(100),
			@CBACKUPFILE VARCHAR(1000),
			@CROWID VARCHAR(50),@cStep VARCHAR(2)

BEGIN TRY			
	SET @cStep='10'
	SELECT @CROWID=NEWID()
	INSERT BACKUPLOG(BKP_TYPE,START_TIME, END_TIME, ROW_ID )
	SELECT 2 AS BKP_TYPE,GETDATE() AS START_TIME,'' AS END_TIME,@CROWID AS ROW_ID
	
	SET @cStep='20'

	IF UPPER(RIGHT(@CBACKUPPATH,4)) <> '.TRN'
		SET @CBACKUPFILE = @CBACKUPPATH + @CDBDEVICE + '.TRN'
	ELSE 
		SET @CBACKUPFILE = @CBACKUPPATH
	
	SET @cStep='30'
	SET @CCMD = N' BACKUP LOG ' + @CDB + ' TO DISK=''' + @CBACKUPFILE+''''--@CDBDEVICE
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD

	SET @cStep='40'
	UPDATE BACKUPLOG SET END_TIME=GETDATE() WHERE ROW_ID=@CROWID AND BKP_TYPE=2

	GOTO END_PROC
END TRY

BEGIN CATCH
	SET @cErrormsg='Error in BackupTran at Step#'+@cStep+' '+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:
	
END