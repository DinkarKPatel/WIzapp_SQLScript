CREATE PROCEDURE DBO.SP_SEND_MIRROR_MSTACT_NEW --(LocId 3 digit change by Sanjay:06-11-2024)
(  
 @CTARGETLOCID VARCHAR(5) 
)  
AS  
 BEGIN  
   DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION NVARCHAR(MAX)  
           ,@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPLMTABLE VARCHAR(100)  
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CCURDEPTID VARCHAR(5)  
           ,@CHODEPTID VARCHAR(5),@CERRORMSG VARCHAR(MAX),@CREPLOCTABLE VARCHAR(500),@NLOCTYPE INT  
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(4),@JOINMASTERTABLE VARCHAR(200),@JOINTEMPTABLE VARCHAR(200)  
    DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),ERRMSG VARCHAR(MAX))   
      
 BEGIN TRY  
      
     SET @CSTEP=0  
      
	  
        
     SET @CSTEP=00  
       
     PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)  
     SET @CFILTERCONDITION=''  
        
     SET @CSTEP=20  
      
     SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'  
     SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'    
       
     SELECT @NLOCTYPE=LOC_TYPE FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID  
       
     PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)  
       
     IF @CCURDEPTID<>@CHODEPTID  
     BEGIN  
      SELECT '' AS LAST_UPDATE,'' AS ERRMSG  
        
      GOTO END_PROC  
     END    
     
     SET @CSTEP=30  
     
     --CHECK CONDITION FORM LOCATION TABLE FOR WHICH TYPE DATA WILL BE SELECTED
     IF EXISTS(SELECT * FROM DBO.LOCATION WITH(NOLOCK) WHERE DEPT_ID= @CTARGETLOCID AND PUR_LOC = 1)
        SET @CFILTERCONDITION  = 'SHARE_WITH_WH = 1'
     ELSE IF EXISTS(SELECT * FROM DBO.LOCATION WITH(NOLOCK) WHERE DEPT_ID= @CTARGETLOCID AND  LOC_TYPE = 1 AND PUR_LOC = 0)
        SET @CFILTERCONDITION  = 'SHARE_WITH_COMPANY_OWNED_POS = 1'
     ELSE IF EXISTS(SELECT * FROM DBO.LOCATION WITH(NOLOCK) WHERE DEPT_ID= @CTARGETLOCID AND LOC_TYPE= 2 AND FR_TYPE = 1)
        SET @CFILTERCONDITION  = 'SHARE_WITH_FRANCHISE_CONSIGNEE = 1'
     ELSE IF EXISTS(SELECT * FROM DBO.LOCATION WITH(NOLOCK) WHERE DEPT_ID= @CTARGETLOCID AND LOC_TYPE= 2 AND FR_TYPE = 2)
        SET @CFILTERCONDITION  = 'SHARE_WITH_FRANCHISE_OUTRIGHT = 1'
     
     SET @CSTEP=40
     IF ISNULL(@CFILTERCONDITION,'')=''
        BEGIN
         SET @CERRORMSG ='CONDITION NOT MATCH INTO LOCATION TABLE'
         GOTO END_PROC;
        END

     SET @CSTEP=50

	 IF OBJECT_ID ('TEMPDB..#TMPLM','U') IS NOT NULL
	    DROP TABLE #TMPLM

	  SELECT AC_CODE INTO #TMPLM FROM LM01106 A (NOLOCK) WHERE 1=2

	 SET @DTSQL=N'SELECT DISTINCT AC_CODE  FROM LM01106 (NOLOCK)  WHERE '+@CFILTERCONDITION+' '
     PRINT @DTSQL
	 INSERT INTO #TMPLM(AC_CODE)
     EXEC SP_EXECUTESQL @DTSQL


	  INSERT INTO #TMPLM(AC_CODE)
	 SELECT shipping_ac_code  FROM LM_SHIPPING_DETAILS (NOLOCK)
	 JOIN #TMPLM TMP ON LM_SHIPPING_DETAILS.AC_CODE=TMP.AC_CODE 
	 LEFT JOIN #TMPLM TMP1 ON TMP1 .AC_CODE =LM_SHIPPING_DETAILS.shipping_ac_code
	 WHERE TMP1.AC_CODE IS NULL and isnull(shipping_ac_code,'')<>''
	 GROUP BY shipping_ac_code

     --SEND DATA FROM LMTABLE BASED ON HEAD_CODE OF TEMP TABLE OF LM01106
     SET @CSTEP=60 

     SELECT DISTINCT  'MSTACT_LM01106_MIRROR' AS TARGET_TABLENAME,LM01106.*,1 AS PICK_FROM_CURRENT_DB FROM LM01106 (NOLOCK)
	 JOIN #TMPLM B ON LM01106.AC_CODE=B.AC_CODE 
      
     SET @CSTEP=61
     --SEND DATA FROM LMTABLE BASED ON HEAD_CODE OF TEMP TABLE OF LM_TERMS
     
     SELECT DISTINCT  'MSTACT_LM_TERMS_MIRROR' AS TARGET_TABLENAME,LM_TERMS.*,1 AS PICK_FROM_CURRENT_DB FROM LM_TERMS (NOLOCK)
	 JOIN #TMPLM B ON LM_TERMS.AC_CODE=B.AC_CODE 


     
     SET @CSTEP=62
     --SEND DATA FROM LMTABLE BASED ON HEAD_CODE OF TEMP TABLE OF LEDGER_TERMS
       SELECT DISTINCT  'MSTACT_LEDGER_TERMS_MIRROR' AS TARGET_TABLENAME,LEDGER_TERMS.*,1 AS PICK_FROM_CURRENT_DB FROM LEDGER_TERMS (NOLOCK)
	   JOIN LM_TERMS (NOLOCK) ON LM_TERMS .terms_code =LEDGER_TERMS .terms_code 
	   JOIN #TMPLM TMP ON LM_TERMS.AC_CODE=TMP.AC_CODE 
	
  
     SET @CSTEP=70
     SET @CTABLENAME = 'HD01106'  
	 SELECT DISTINCT  'MSTACT_HD01106_MIRROR' AS TARGET_TABLENAME,HD01106.*,1 AS PICK_FROM_CURRENT_DB FROM HD01106 (NOLOCK)

    
     
     SET @CSTEP=90
     --SEND DATA FROM LMP01106 TABLE BASED ON AC_CODE OF LMP01106
     SET @CTABLENAME = 'LMP01106'  
     SELECT DISTINCT  'MSTACT_LMP01106_MIRROR' AS TARGET_TABLENAME,LMP01106.*,1 AS PICK_FROM_CURRENT_DB FROM LMP01106 (NOLOCK)
	 JOIN #TMPLM B ON LMP01106.AC_CODE=B.AC_CODE 	
	
     SET @CSTEP=110
     --SEND DATA FROM AREA TABLE BASED ON AC_CODE OF LM01106
  
	 SELECT DISTINCT  'MSTACT_AREA_MIRROR' AS TARGET_TABLENAME,AREA.*,1 AS PICK_FROM_CURRENT_DB FROM AREA (NOLOCK)
	 JOIN LMP01106 (NOLOCK) ON AREA .area_code =LMP01106.area_code
	 JOIN #TMPLM TMP ON LMP01106.AC_CODE=TMP.AC_CODE 	
	

     
     SET @CSTEP=130
     --SEND DATA FROM CITY TABLE BASED ON AC_CODE OF LM01106
  
	  SELECT DISTINCT  'MSTACT_CITY_MIRROR' AS TARGET_TABLENAME,CITY.*,1 AS PICK_FROM_CURRENT_DB FROM CITY (NOLOCK)
	  JOIN AREA (NOLOCK) ON AREA.city_code =CITY .city_code 
	  JOIN LMP01106 (NOLOCK) ON AREA .area_code =LMP01106.area_code
	  JOIN #TMPLM TMP ON LMP01106.AC_CODE=TMP.AC_CODE 


   
     SET @CSTEP=150
     --SEND DATA FROM STATE TABLE BASED ON AC_CODE OF LM01106
     
	 SELECT DISTINCT  'MSTACT_STATE_MIRROR' AS TARGET_TABLENAME,STATE.*,1 AS PICK_FROM_CURRENT_DB FROM STATE (NOLOCK)
	 JOIN CITY (NOLOCK) ON CITY.state_code =STATE .state_code 
	 JOIN AREA (NOLOCK) ON AREA.city_code =CITY .city_code 
	 JOIN LMP01106 (NOLOCK) ON AREA .area_code =LMP01106.area_code
	 JOIN #TMPLM TMP ON LMP01106.AC_CODE=TMP.AC_CODE 

   
     SET @CSTEP=160
     --SEND DATA FROM REGIONM TABLE BASED ON AC_CODE OF LM01106
     SET @CTABLENAME = 'REGIONM'  
	 SELECT DISTINCT  'MSTACT_REGIONM_MIRROR' AS TARGET_TABLENAME,REGIONM.*,1 AS PICK_FROM_CURRENT_DB FROM REGIONM (NOLOCK)
	 JOIN  STATE (NOLOCK) ON state .region_code =regionM .region_code
	 JOIN CITY (NOLOCK) ON CITY.state_code =STATE .state_code 
	 JOIN AREA (NOLOCK) ON AREA.city_code =CITY .city_code 
	 JOIN LMP01106 (NOLOCK) ON AREA .area_code =LMP01106.area_code
	 JOIN #TMPLM TMP ON LMP01106.AC_CODE=TMP.AC_CODE 

     SET @CSTEP=165

     SET @CTABLENAME = 'NRM'  
	 SELECT DISTINCT  'MSTACT_NRM_MIRROR' AS TARGET_TABLENAME,NRM.*,1 AS PICK_FROM_CURRENT_DB FROM NRM (NOLOCK)
	    
 
     ---SEND DATA LM_SHIPPING_DETAILS
     SET @CSTEP=170  
     
	 SELECT DISTINCT  'MSTACT_LM_SHIPPING_DETAILS_MIRROR' AS TARGET_TABLENAME,LM_SHIPPING_DETAILS.*,1 AS PICK_FROM_CURRENT_DB FROM LM_SHIPPING_DETAILS (NOLOCK)
	 JOIN #TMPLM TMP ON LM_SHIPPING_DETAILS.AC_CODE=TMP.AC_CODE 

 END TRY  
   
 BEGIN CATCH  
     SET @CERRORMSG='P: SP_SEND_MIRROR_MSTACT_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()+ 'ERROR QUERY || '+@DTSQL  
     GOTO END_PROC  
    END CATCH   
      
    END_PROC:  

	SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
    
  
  
 END  
 
