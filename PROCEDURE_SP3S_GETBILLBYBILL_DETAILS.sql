CREATE PROCEDURE SP3S_GETBILLBYBILL_DETAILS
(
	 @CVMID	VARCHAR(40)='',
	 @CREFNO VARCHAR(50)='',
	 @CACCODE CHAR(10)=''
)
AS
BEGIN
	DECLARE @CDEBTORHEADS VARCHAR(2000),@CCREDITORHEADS VARCHAR(2000)

	
	SELECT	@CDEBTORHEADS = DBO.FN_ACT_TRAVTREE( '0000000018' ),
		    @CCREDITORHEADS = DBO.FN_ACT_TRAVTREE( '0000000021' ) 
	

	IF OBJECT_ID('TEMPDB..#TMPBILLS','U') IS NOT NULL
		DROP TABLE #TMPBILLS
	
	SELECT AC_CODE,A.REF_NO INTO #TMPBILLS	
	FROM BILL_BY_BILL_REF A
	JOIN VD01106 B ON A.VD_ID=B.VD_ID
	WHERE 1=2
						
	IF OBJECT_ID('TEMPDB..#TMPPYTADV_BILLS','U') IS NOT NULL
		DROP TABLE #TMPPYTADV_BILLS

	IF OBJECT_ID('TEMPDB..#TMPPYTADV_ADJUSTMENTS','U') IS NOT NULL
		DROP TABLE #TMPPYTADV_ADJUSTMENTS
						
	PRINT 'POPULATE BILLS DATA'	
	
	IF @CVMID<>''
		INSERT #TMPBILLS (AC_CODE,REF_NO)
		SELECT DISTINCT AC_CODE,REF_NO FROM BILL_BY_BILL_REF A
		JOIN VD01106 B ON A.VD_ID=B.VD_ID
		WHERE B.VM_ID=@CVMID
	ELSE
		INSERT #TMPBILLS (AC_CODE,REF_NO)
		SELECT @CACCODE AS AC_CODE,@CREFNO AS REF_NO
	
	SELECT A.REF_NO,A.AMOUNT*(CASE WHEN A.X_TYPE='CR' THEN -1 ELSE 1 END) AS BILL_AMOUNT,VOUCHER_DT,A.pur_mrr_id
	INTO #TMPPYTADV_BILLS
	FROM BILL_BY_BILL_REF A (NOLOCK) 
	JOIN VD01106 B  (NOLOCK) ON A.VD_ID = B.VD_ID 
	JOIN VM01106 V  (NOLOCK) ON B.VM_ID = V.VM_ID 
	JOIN LMP01106 LMP  (NOLOCK) ON LMP.AC_CODE=B.AC_CODE
	JOIN LM01106 LM  (NOLOCK) ON LM.AC_CODE=B.AC_CODE
	JOIN #TMPBILLS BB ON BB.AC_CODE=B.AC_CODE AND BB.REF_NO=A.REF_NO
	WHERE CANCELLED=0 AND ((CHARINDEX(LM.HEAD_CODE,@CDEBTORHEADS)>0 AND A.X_TYPE='DR') OR
		 (CHARINDEX(LM.HEAD_CODE,@CCREDITORHEADS)>0 AND A.X_TYPE='CR')
	 OR (B.AC_CODE+'-'+A.REF_NO) NOT IN 
	(SELECT B.AC_CODE+'-'+A.REF_NO FROM BILL_BY_BILL_REF A (NOLOCK) 
	JOIN VD01106 B  (NOLOCK) ON A.VD_ID = B.VD_ID 
	JOIN VM01106 V  (NOLOCK) ON B.VM_ID = V.VM_ID 
	JOIN LM01106 LM (NOLOCK) ON LMP.AC_CODE=B.AC_CODE
	JOIN #TMPBILLS BB ON BB.AC_CODE=B.AC_CODE AND BB.REF_NO=A.REF_NO
	WHERE   ((CHARINDEX(LM.HEAD_CODE,@CDEBTORHEADS)>0 AND A.X_TYPE='DR') OR
			(CHARINDEX(LM.HEAD_CODE,@CCREDITORHEADS)>0 AND A.X_TYPE='CR'))))
	
	
	PRINT 'POPULATE ADJUSTMENTS DATA'
		
	IF OBJECT_ID('TEMPDB..#TMPPYTADV_ADJUSTMENTS','U') IS NOT NULL
		DROP TABLE #TMPPYTADV_ADJUSTMENTS
					
	SELECT (CASE WHEN ISNULL(VM_ADJ.BILL_NO,'')='' THEN VM_ADJ.VOUCHER_NO ELSE VM_ADJ.BILL_NO END) AS ADJ_MEMO_NO,
	VM_ADJ.VOUCHER_DT AS ADJ_MEMO_DT,(BB_ADJ.AMOUNT*
	(CASE WHEN BB_ADJ.X_TYPE='DR' THEN 1 ELSE -1 END)) AS ADJ_AMOUNT,ADJ_REMARKS,
	(CASE WHEN REPLACE(BB_ADJ.REF_NO,'/'+DBO.FN_GETDATE_DDMMYY(VM_ADJ.VOUCHER_DT),'')=VM_ADJ.BILL_NO OR
			   REPLACE(BB_ADJ.REF_NO,'/'+CONVERT(VARCHAR,VM_ADJ.VOUCHER_DT,112),'')=VM_ADJ.BILL_NO THEN '' ELSE BB_ADJ.REF_NO END) AS REF_NO
	,BB_ADJ.pur_mrr_id

	INTO #TMPPYTADV_ADJUSTMENTS FROM BILL_BY_BILL_REF BB_ADJ 
	JOIN VD01106 VD_ADJ ON VD_ADJ.VD_ID=BB_ADJ.VD_ID
	JOIN VM01106 VM_ADJ ON VM_ADJ.VM_ID=VD_ADJ.VM_ID
	JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=VD_ADJ.AC_CODE
	JOIN #TMPBILLS BB ON BB.AC_CODE=VD_ADJ.AC_CODE AND BB.REF_NO=BB_ADJ.REF_NO
	WHERE (CHARINDEX(LM.HEAD_CODE,@CDEBTORHEADS)>0 AND BB_ADJ.X_TYPE='CR') OR
		  (CHARINDEX(LM.HEAD_CODE,@CCREDITORHEADS)>0 AND BB_ADJ.X_TYPE='DR')	
	AND CANCELLED=0
	
	SELECT REF_NO,(CASE WHEN BILL_AMOUNT>0 THEN BILL_AMOUNT ELSE 0 END) AS DEBIT_AMOUNT,
	(CASE WHEN BILL_AMOUNT<0 THEN ABS(BILL_AMOUNT) ELSE 0 END) AS CREDIT_AMOUNT,VOUCHER_DT,pur_mrr_id  FROM #TMPPYTADV_BILLS
	
	SELECT ADJ_MEMO_NO,ADJ_MEMO_DT,ADJ_REMARKS,REF_NO,(CASE WHEN ADJ_AMOUNT>0 THEN ADJ_AMOUNT ELSE 0 END) AS DEBIT_AMOUNT,
	(CASE WHEN ADJ_AMOUNT<0 THEN ABS(ADJ_AMOUNT) ELSE 0 END) AS CREDIT_AMOUNT,pur_mrr_id FROM #TMPPYTADV_ADJUSTMENTS	
ENDPROC:

END
--END OF PROCEDURE - SP3S_GETBILLBYBILL_DETAILS
