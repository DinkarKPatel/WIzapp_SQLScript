CREATE PROCEDURE SPPPC_FG_BAROCDE_PRINT
(
 @NQUERYID INT=0,
 @CAC_CODE VARCHAR(10)='',--BUYER
 @CBILL_NO VARCHAR(50)='',
 @CAGENCY_CODE VARCHAR(10)='',--AGENCY
 @CMEMO_ID VARCHAR(50)='',
 @CARTICLE_CODE VARCHAR(10)='',
 @CPARA1_CODE VARCHAR(10)='',
 @CSIZEGROUP_CODE VARCHAR(10)='',
 @CFIN_YEAR VARCHAR(5)=''
 )
AS
BEGIN

       IF @NQUERYID IN(4,5,6)
	   BEGIN
	    
		   IF OBJECT_ID('TEMPDB..#TMPPRODUCT','U') IS NOT NULL
				DROP TABLE #TMPPRODUCT
			
				   
			SELECT A.AC_CODE,LM.AC_NAME,DET.BILL_NO,
				B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,
				SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				SKU.PARA1_CODE,P1.PARA1_NAME,
				SKU.PARA2_CODE,P2.PARA2_NAME,
				SKU.PARA3_CODE,P3.PARA3_NAME ,
				SKU.PRODUCT_CODE,
				J.JOB_CODE,
				J.JOB_NAME,
				1 AS JOB_ORDER,
				CAST(PR.QUANTITY AS INT) AS QUANTITY_IN_STOCK,
				ISNULL(PR1.ISSUE_QTY,0) AS ISSUE_QTY,
				isnull(PR.APPROVED ,0) as APPROVED,
				DET.ROW_ID AS BO_ROW_ID
				INTO #TMPPRODUCT
			FROM PPC_FGBCG_MST A
			JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
			JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
			join
			(
			  SELECT  b.ac_code,a.article_code ,
				ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
				JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
				WHERE B.CANCELLED=0
			  group by b.ac_code,a.article_code ,ROW_ID,B.BILL_NO
			) det on det.row_id=B.BO_DET_ROW_ID 
			JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_CODE 
			JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
			JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
			JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
			JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
			JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
			left JOIN
			(
				SELECT B.AC_CODE , B.BILL_NO , B.JOB_CODE, PRODUCT_CODE,A.QUANTITY ,b.APPROVED 
				FROM PPC_AGENCY_ISSUE_FG_FIRST_DET  A
				JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID 
				WHERE B.CANCELLED=0 
				AND (@CAGENCY_CODE='' OR b.AC_CODE =@CAGENCY_CODE)
				--and ISNULL(MEMO_TYPE,0)=1
			) PR ON PR.PRODUCT_CODE =SKU .PRODUCT_CODE
			LEFT JOIN
			(
				SELECT B.JOB_CODE, PRODUCT_CODE,A.QUANTITY AS ISSUE_QTY
				FROM PPC_FG_BARCODE_PRINT_DET  A
				JOIN PPC_FG_BARCODE_PRINT_MST B ON A.MEMO_ID =B.MEMO_ID 
				WHERE B.CANCELLED=0
				AND (@CAGENCY_CODE='' OR b.AC_CODE =@CAGENCY_CODE) 
			) PR1 ON PR1.PRODUCT_CODE =SKU .PRODUCT_CODE
			left JOIN JOBS J ON J.job_code =PR.JOB_CODE 
			WHERE (@CBILL_NO ='' OR det.BILL_NO =@CBILL_NO )
            AND (@CAC_CODE='' OR A.AC_CODE =@CAC_CODE)
            
          --  AND SKU.PARA2_CODE<>'0000000'
            and a.CANCELLED =0
           -- AND PR1.PRODUCT_CODE IS NULL
            
            --SELECT * FROM TMPPRODUC
            
           --select * INTO TMPPRODUC FROM #TMPPRODUCT
            
		END						 	   
	

 IF @NQUERYID=1
    GOTO LBLBUYER
 ELSE IF @NQUERYID=2
    GOTO LBLBILL_NO
 ELSE IF @NQUERYID=3
    GOTO LBLAGENCY
 ELSE IF @NQUERYID=4
    GOTO LBLMST
 ELSE IF @NQUERYID=5
    GOTO LBLDET
 ELSE IF @NQUERYID=6
    GOTO LBLPARA2DET 
 ELSE IF @NQUERYID=7
    GOTO LBLBARCODEPRINT   
 ELSE IF @NQUERYID=8
    GOTO LBLBARCODEPRINT_CROSSTAB  
 ELSE IF @NQUERYID=9
    GOTO LBLAGENCY_VIEW
 
 ELSE
 GOTO END_PROC
 
   LBLBUYER:
        
        SELECT A.AC_CODE ,LM.AC_NAME 
        FROM PPC_FGBCG_MST A (NOLOCK)
		JOIN PPC_FGBCG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
		JOIN PPC_FG_SKU SKU (NOLOCK) ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
		JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET DET (NOLOCK) ON DET.PRODUCT_CODE=SKU.PRODUCT_CODE
		JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST MST (NOLOCK) ON MST.MEMO_ID =DET .MEMO_ID 
		LEFT OUTER JOIN
        (
         SELECT PRODUCT_CODE 
         FROM  PPC_FG_BARCODE_PRINT_DET A (NOLOCK)
         JOIN  PPC_FG_BARCODE_PRINT_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
         WHERE B.CANCELLED =0
        ) C ON SKU.PRODUCT_CODE=C.PRODUCT_CODE
        JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE  
        WHERE A.CANCELLED =0 AND ISNULL(MEMO_TYPE,0)=1 AND C.PRODUCT_CODE IS NULL
		AND MST.CANCELLED =0
		GROUP BY A.AC_CODE ,LM.AC_NAME 
		
   GOTO END_PROC
   
   LBLBILL_NO:
   
        SELECT BO.BILL_NO 
       FROM PPC_FGBCG_MST A (NOLOCK)
		JOIN PPC_FGBCG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
		JOIN PPC_FG_SKU SKU (NOLOCK) ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
		JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET DET (NOLOCK) ON DET.PRODUCT_CODE=SKU.PRODUCT_CODE
		JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST MST (NOLOCK) ON MST.MEMO_ID =DET .MEMO_ID 
		JOIN
		(
		 SELECT A.ROW_ID ,B.BILL_NO  
		 FROM  PPC_BUYER_ORDER_DET A
		 JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
		 WHERE B.CANCELLED=0
		 AND (@CAC_CODE='' OR B.AC_CODE=@CAC_CODE)
		 GROUP BY A.ROW_ID ,B.BILL_NO
		 ) BO ON BO.ROW_ID =B.BO_DET_ROW_ID  
		LEFT OUTER JOIN
        (
         SELECT PRODUCT_CODE ,B.AC_CODE
         FROM  PPC_FG_BARCODE_PRINT_DET A (NOLOCK)
         JOIN  PPC_FG_BARCODE_PRINT_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
         WHERE B.CANCELLED =0
        ) C ON SKU.PRODUCT_CODE=C.PRODUCT_CODE
        WHERE A.CANCELLED =0  AND C.PRODUCT_CODE IS NULL
		AND MST.CANCELLED =0
		--AND (@CAC_CODE='' OR MST.AC_CODE=@CAC_CODE)
		GROUP BY BO.BILL_NO 
   
   
   GOTO END_PROC
   
   
    
    LBLAGENCY:  
      
        SELECT MST.AC_CODE ,LM.AC_NAME 
        FROM PPC_FGBCG_MST A (NOLOCK)
		JOIN PPC_FGBCG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
		JOIN PPC_FG_SKU SKU (NOLOCK) ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
		JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET DET (NOLOCK) ON DET.PRODUCT_CODE=SKU.PRODUCT_CODE
		JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST MST (NOLOCK) ON MST.MEMO_ID =DET .MEMO_ID 
		JOIN
		(
		 SELECT A.ROW_ID ,B.BILL_NO  
		 FROM  PPC_BUYER_ORDER_DET A
		 JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
		 WHERE B.CANCELLED=0
		 AND (@CAC_CODE='' OR B.AC_CODE=@CAC_CODE)
		 GROUP BY A.ROW_ID ,B.BILL_NO
		 ) BO ON BO.ROW_ID =B.BO_DET_ROW_ID  
		LEFT OUTER JOIN
        (
         SELECT PRODUCT_CODE 
         FROM  PPC_FG_BARCODE_PRINT_DET A (NOLOCK)
         JOIN  PPC_FG_BARCODE_PRINT_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
         WHERE B.CANCELLED =0
        ) C ON SKU.PRODUCT_CODE=C.PRODUCT_CODE
        JOIN LM01106 LM ON LM.AC_CODE=MST.AC_CODE  
        WHERE A.CANCELLED =0  AND C.PRODUCT_CODE IS NULL
		AND MST.CANCELLED =0
		--AND (@CAC_CODE='' OR BO.AC_CODE=@CAC_CODE)
		AND (@CBILL_NO='' OR BO.BILL_NO =@CBILL_NO)
		GROUP BY MST.AC_CODE ,LM.AC_NAME
   
    
    GOTO END_PROC
    
    
    LBLMST:
       
       SELECT JOBS.JOB_NAME, A.JOB_CODE,A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.LAST_UPDATE,
              A.AC_CODE,LM.AC_NAME,A.BILL_NO,A.FIN_YEAR,A.CANCELLED,
              LM1.AC_NAME AS BUYER_NAME,LM1.AC_CODE AS BUYER_CODE,
              b.PRINT_QTY
       FROM  PPC_FG_BARCODE_PRINT_MST A (nolock)
       join
       (
        select MEMO_ID ,SUM(quantity) as PRINT_QTY 
        from PPC_FG_BARCODE_PRINT_DET (nolock)
        group by MEMO_ID
       ) b on a.MEMO_ID =b.MEMO_ID 
       JOIN PPC_BUYER_ORDER_MST MST ON A.BILL_NO=MST.BILL_NO 
       JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
       JOIN LM01106 LM1 ON LM1.AC_CODE=mst.AC_CODE
       JOIN JOBS ON JOBS.JOB_CODE =A.JOB_CODE
       WHERE (@CBILL_NO ='' OR A.BILL_NO =@CBILL_NO )
       AND (@CAC_CODE='' OR MST.AC_CODE =@CAC_CODE)
       AND (@CAGENCY_CODE='' OR A.AC_CODE =@CAGENCY_CODE)
       AND (@CFIN_YEAR='' OR MST.FIN_YEAR=@CFIN_YEAR)
       order by A.MEMO_DT desc,A.MEMO_ID desc
       

    GOTO END_PROC
    
    LBLDET:
       
      --  SELECT * into TMPPRODUCT1 FROM #TMPPRODUCT
      
        SELECT CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
        ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
        A.AC_CODE,
        A.AC_NAME,
        A.BILL_NO,
        A.ARTICLE_CODE,
        A.ARTICLE_NO,
		A.PARA1_CODE,
		A.PARA1_NAME,
		A.SIZEGROUP_CODE,
		A.SIZEGROUP_NAME,
		A.PARA3_CODE,
		A.PARA3_NAME,
		A.JOB_NAME,
		A.JOB_ORDER,
		SUM(QUANTITY_IN_STOCK) AS AVAILABLE_QTY,
		SUM(ISSUE_QTY) AS ISSUED,
		PENDING=CAST(SUM(QUANTITY_IN_STOCK)-SUM(ISSUE_QTY) AS NUMERIC(10,0)),
		SELECT_QTY=CAST(0 AS NUMERIC(10,0)),
		BO_ROW_ID
		FROM #TMPPRODUCT A 
		where a.APPROVED =1
		GROUP BY  A.JOB_NAME,
		A.JOB_ORDER,A.AC_CODE,A.AC_NAME,A.BILL_NO,
		A.PARA1_CODE,A.PARA1_NAME,A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,
		A.PARA3_CODE,A.PARA3_NAME, A.ARTICLE_CODE,
        A.ARTICLE_NO,BO_ROW_ID

    GOTO END_PROC
   
  LBLPARA2DET:
        
        
      
        SELECT SP.SR_NO,CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
               ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
               A.AC_CODE,
			   A.AC_NAME,
			   A.BILL_NO,
			   A.ARTICLE_CODE,
			   A.ARTICLE_NO,
			   A.PARA1_CODE,
			   A.PARA1_NAME,
			   A.SIZEGROUP_CODE,
			   A.SIZEGROUP_NAME,
			   A.PARA3_CODE,
			   A.PARA3_NAME,
			   A.JOB_NAME,
			   A.JOB_ORDER,
        A.PARA2_CODE,PARA2_NAME,
        CAST(SUM(QUANTITY_IN_STOCK) AS NUMERIC(10,0)) AS ALLOTED_QTY,
        CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0)) AS ISSUED_QTY,
        CAST(SUM(QUANTITY_IN_STOCK)-SUM(ISNULL(ISSUE_QTY,0))AS NUMERIC(10,0)) AS BAL_QTY,
        CAST(0 AS NUMERIC(10,0)) AS SELECT_QUANTITY,
        BO_ROW_ID
        FROM #TMPPRODUCT A
        LEFT JOIN PPC_SIZEGROUP_PARA2 SP ON A.SIZEGROUP_CODE=SP.SIZEGROUP_CODE AND A.PARA2_CODE=SP.PARA2_CODE
        WHERE ( @CARTICLE_CODE='' OR A.ARTICLE_CODE=@CARTICLE_CODE) 
        AND (@CPARA1_CODE ='' OR A.PARA1_CODE=@CARTICLE_CODE)
        AND (@CSIZEGROUP_CODE='' OR A.SIZEGROUP_CODE=@CSIZEGROUP_CODE)
        GROUP BY  SP.SR_NO,A.AC_CODE,
		A.AC_NAME,A.BILL_NO,A.ARTICLE_CODE, A.ARTICLE_NO,
	    A.PARA1_CODE,A.PARA1_NAME,A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,
	    A.PARA3_CODE,A.PARA3_NAME,A.JOB_NAME, A.JOB_ORDER,
        A.PARA2_CODE,PARA2_NAME,BO_ROW_ID
        HAVING CAST(SUM(QUANTITY_IN_STOCK)-SUM(ISNULL(ISSUE_QTY,0))AS NUMERIC(10,0))>0
        ORDER BY SP.SR_NO

   
   GOTO END_PROC
   
   
   LBLBARCODEPRINT:
        
        IF OBJECT_ID('TEMPDB..#TMPBARCODEPRINT','') IS NOT NULL
           DROP TABLE #TMPBARCODEPRINT 
           
        SELECT CAST(1 AS BIT) AS CHK, PR.MEMO_ID,PR.MEMO_NO,PR.MEMO_DT,
               A.AC_CODE,LM.AC_NAME ,
               det.BILL_NO,
               det.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
               B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
               B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
               B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
               SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
               PR.JOB_CODE,
               PR.JOB_NAME,
               PR.PRODUCT_CODE,
               PR.QUANTITY
          --  INTO #TMPBARCODEPRINT
		    FROM PPC_FGBCG_MST A (NOLOCK)
			JOIN PPC_FGBCG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
			JOIN PPC_FG_SKU SKU (NOLOCK) ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
			join
			(
			  SELECT  b.ac_code,a.article_code ,
				ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A (NOLOCK)
				JOIN PPC_BUYER_ORDER_MST B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID
				WHERE B.CANCELLED=0
			  group by b.ac_code,a.article_code ,ROW_ID,B.BILL_NO
			) det on det.row_id=B.BO_DET_ROW_ID 
			JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
			JOIN PARA1 P1(NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE 
			JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE 
			JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE =SKU.PARA3_CODE 
			JOIN PPC_SIZEGROUP SG (NOLOCK) ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
			JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
			JOIN
			(
				SELECT JOBS.JOB_CODE,JOBS.JOB_NAME,
				b.MEMO_ID,B.MEMO_NO,B.MEMO_DT, PRODUCT_CODE,QUANTITY AS QUANTITY
				FROM PPC_FG_BARCODE_PRINT_DET  A (NOLOCK)
				JOIN PPC_FG_BARCODE_PRINT_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
				JOIN JOBS  ON B.JOB_CODE=JOBS.JOB_CODE
				WHERE B.CANCELLED=0
				AND A.MEMO_ID=@CMEMO_ID
			) PR ON PR.PRODUCT_CODE =SKU.PRODUCT_CODE	
			JOIN PPC_SIZEGROUP_PARA2 SP (NOLOCK) ON SP.PARA2_CODE =P2.para2_code AND SP.SIZEGROUP_CODE =SG.SIZEGROUP_CODE 
			ORDER BY article_no, Para1_name, SP.SR_NO ,SKU .PRODUCT_CODE 
			

		
        
        
    GOTO END_PROC
    
    LBLBARCODEPRINT_CROSSTAB:
        

        IF OBJECT_ID ('TEMPDB..#TMPALLOTEDPRINT','P') IS NOT NULL
           DROP TABLE #TMPALLOTEDPRINT
           
	
				      
			SELECT PR.MEMO_ID,PR.ROW_ID,A.AC_CODE,LM.AC_NAME,DET.BILL_NO,
				B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,
				SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				SKU.PARA1_CODE,P1.PARA1_NAME,
				SKU.PARA2_CODE,P2.PARA2_NAME,
				SKU.PARA3_CODE,P3.PARA3_NAME ,
				SKU.PRODUCT_CODE,
				J.JOB_CODE,
				J.JOB_NAME,
				1 AS JOB_ORDER,
				CAST(1 AS INT) AS QUANTITY_IN_STOCK,
				ISNULL(PR.ISSUE_QTY,0) AS ISSUE_QTY,
				ISNULL(PR1.ISSUE_QTY,0) AS ISSUED,
				 SELECT_QTY=CAST(0 AS NUMERIC(10,0)),
				 DET.ROW_ID AS BO_ROW_ID
				INTO #TMPALLOTEDPRINT
			FROM PPC_FGBCG_MST A
			JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
			JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
			JOIN
			(
			  SELECT  B.AC_CODE,A.ARTICLE_CODE ,
				ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
				JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
				WHERE B.CANCELLED=0
			  GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
			JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
			JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
			JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
			JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
			JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
			JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
			JOIN
			(
			 SELECT A.REF_ROW_ID, A.JOB_CODE,B.JOB_NAME FROM PPC_BO_ART_JOBS A
			 JOIN JOBS B ON A.JOB_CODE=B.JOB_CODE
			 WHERE JOB_ORDER=1
			 GROUP BY A.REF_ROW_ID, A.JOB_CODE,B.JOB_NAME
			) J ON J.REF_ROW_ID=B.BO_DET_ROW_ID
			JOIN
			(
				SELECT distinct PRODUCT_CODE,CAST(1 AS INT) AS ISSUE_QTY
				FROM PPC_AGENCY_ISSUE_FG_FIRST_DET  A
				JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST   B ON A.MEMO_ID =B.MEMO_ID 
				WHERE B.CANCELLED=0
				AND (@CAGENCY_CODE='' or B.AC_CODE=@CAGENCY_CODE)
			) TPR ON TPR.PRODUCT_CODE =SKU.PRODUCT_CODE
			LEFT  JOIN
			(
				SELECT A.MEMO_ID,A.ROW_ID, PRODUCT_CODE,CAST(1 AS INT) AS ISSUE_QTY
				FROM PPC_FG_BARCODE_PRINT_DET  A
				JOIN PPC_FG_BARCODE_PRINT_MST  B ON A.MEMO_ID =B.MEMO_ID 
				WHERE B.CANCELLED=0
				AND A.MEMO_ID=@CMEMO_ID 
				AND (@CAGENCY_CODE='' or B.AC_CODE=@CAGENCY_CODE)
			) PR ON PR.PRODUCT_CODE =SKU.PRODUCT_CODE
			LEFT  JOIN
			(
				SELECT A.MEMO_ID,A.ROW_ID, PRODUCT_CODE,CAST(1 AS INT) AS ISSUE_QTY
				FROM PPC_FG_BARCODE_PRINT_DET  A
				JOIN PPC_FG_BARCODE_PRINT_MST  B ON A.MEMO_ID =B.MEMO_ID 
				WHERE B.CANCELLED=0
				AND A.MEMO_ID<@CMEMO_ID
				AND (@CAGENCY_CODE='' or B.AC_CODE=@CAGENCY_CODE)
			) PR1 ON PR1.PRODUCT_CODE =SKU.PRODUCT_CODE
			WHERE det.bill_no=@CBILL_NO
			

			SELECT 
				A.AC_CODE,
				A.AC_NAME,
				A.BILL_NO,
				A.ARTICLE_CODE,
				A.ARTICLE_NO,
				A.PARA1_CODE,
				A.PARA1_NAME,
				A.SIZEGROUP_CODE,
				A.SIZEGROUP_NAME,
				A.PARA3_CODE,
				A.PARA3_NAME,
				A.JOB_CODE,
				A.JOB_NAME,
				JOB_ORDER,
				CAST(SUM(QUANTITY_IN_STOCK) AS NUMERIC(10,0)) AS ALLOTED_QTY,
                CAST(SUM(ISNULL(ISSUED,0)) AS NUMERIC(10,0)) AS ISSUED_QTY,
                CAST(SUM(QUANTITY_IN_STOCK)-SUM(ISNULL(ISSUED,0))AS NUMERIC(10,0)) AS BAL_QTY,
                CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0))  AS SELECT_QUANTITY,
                BO_ROW_ID
				FROM #TMPALLOTEDPRINT A 
				GROUP BY A.AC_CODE,A.AC_NAME,A.BILL_NO,
				A.PARA1_CODE,A.PARA1_NAME,A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,
				A.PARA3_CODE,A.PARA3_NAME, A.ARTICLE_CODE,
				A.ARTICLE_NO,A.JOB_CODE,
				A.JOB_NAME,JOB_ORDER,BO_ROW_ID
				HAVING CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0))>0
				
				
		SELECT CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
        ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
        A.AC_CODE,A.AC_NAME,A.BILL_NO,A.ARTICLE_CODE,
		A.ARTICLE_NO,A.PARA1_CODE,
		A.PARA1_NAME,A.SIZEGROUP_CODE,
		A.SIZEGROUP_NAME,A.PARA3_CODE,A.PARA3_NAME,
        PARA2_CODE,PARA2_NAME,
        CAST(SUM(QUANTITY_IN_STOCK) AS NUMERIC(10,0)) AS ALLOTED_QTY,
        CAST(SUM(ISNULL(ISSUED,0)) AS NUMERIC(10,0)) AS ISSUED_QTY,
        CAST(SUM(QUANTITY_IN_STOCK)-SUM(ISNULL(ISSUED,0))AS NUMERIC(10,0)) AS BAL_QTY,
         CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0))  AS SELECT_QUANTITY,
         BO_ROW_ID
        FROM #TMPALLOTEDPRINT a
        group by PARA2_CODE,PARA2_NAME,A.AC_CODE,A.AC_NAME,A.BILL_NO,A.ARTICLE_CODE,
		A.ARTICLE_NO,A.PARA1_CODE,
		A.PARA1_NAME,A.SIZEGROUP_CODE,
		A.SIZEGROUP_NAME,A.PARA3_CODE,A.PARA3_NAME,BO_ROW_ID
		HAVING  CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0))>0
      
	
    
     GOTO END_PROC
     
     LBLAGENCY_VIEW:
     
     SELECT  DISTINCT A.AC_CODE ,AC_NAME  
     FROM PPC_FG_BARCODE_PRINT_MST A
     JOIN LM01106 B ON A.AC_CODE =B.AC_CODE 
     
      GOTO END_PROC
     
   
 END_PROC:


END
