CREATE PROCEDURE SP_STK_TRANSFER_DTM
@NQUERYID NUMERIC (2,0),
@CMEMOID VARCHAR(40),
@CWHERE VARCHAR(500),
@CPRODUCTCODE VARCHAR(50),
@CFINYEAR VARCHAR(5),
@NNAVMODE NUMERIC(2,0)
--WITH ENCRYPTION

AS
BEGIN


IF 
@NQUERYID = 1
GOTO LBLNAVIGATE

ELSE IF 
@NQUERYID = 2
GOTO LBLGETMASTERS

ELSE IF 
@NQUERYID = 3
GOTO LBLGETDETAILS

ELSE IF 
@NQUERYID = 4
GOTO LBLGETDEPARTMENT

ELSE IF
@NQUERYID = 5
GOTO LBLGETPRODUCTLIST

ELSE IF
@NQUERYID = 6
GOTO LBLGETWORKORDERMASTER

ELSE IF
@NQUERYID = 7
GOTO LBLGETWODET

ELSE IF
@NQUERYID = 8
GOTO LBLWOCOMPLETED

LBLNAVIGATE:
	EXECUTE SP_NAVIGATE 'PRD_STK_TRANSFER_DTM_MST',@NNAVMODE,@CMEMOID,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERE
GOTO LAST

LBLGETMASTERS:
	SELECT T1.*, T4.DEPARTMENT_NAME AS SOURCE_DEPARTMENT_NAME
	,T5.MEMO_NO AS WO_NO,T5.REF_NO 
	FROM PRD_STK_TRANSFER_DTM_MST T1
	JOIN PRD_DEPARTMENT_MST T4 ON T4.DEPARTMENT_ID = T1.SOURCE_DEPARTMENT_ID 
	JOIN PRD_WO_MST T5 ON T5.MEMO_ID=T1.REF_WO_ID
	WHERE T1.MEMO_ID = @CMEMOID
	
GOTO LAST

LBLGETDETAILS:
	
	SELECT CAST(1 AS BIT)CHCK,D.*,S.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,A.ARTICLE_DESC,SM.SECTION_NAME,SD.SUB_SECTION_NAME,
	P.QUANTITY_IN_STOCK,M.DEPT_ID ,P1.PARA1_NAME ,P2.PARA2_NAME,UOM.UOM_NAME ,A.CODING_SCHEME ,'' AS ESTIMATEDMRP
	,P3.PARA3_NAME,P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME
	FROM PRD_STK_TRANSFER_DTM_DET D
	JOIN PRD_STK_TRANSFER_DTM_MST M ON D.MEMO_ID = M.MEMO_ID 
	JOIN SKU S ON D.PRODUCT_CODE = S.PRODUCT_CODE 
	JOIN PMT01106 P ON D.PRODUCT_CODE = P.PRODUCT_CODE AND M.DEPT_ID = P.DEPT_ID 
	JOIN ARTICLE A ON S.ARTICLE_CODE = A.ARTICLE_CODE
	JOIN SECTIOND SD ON SD.SUB_SECTION_CODE = A.SUB_SECTION_CODE
	JOIN SECTIONM SM ON SM.SECTION_CODE = SD.SECTION_CODE
	JOIN PARA1 P1 ON S.PARA1_CODE = P1.PARA1_CODE 
	JOIN PARA2 P2 ON S.PARA2_CODE = P2.PARA2_CODE 
	JOIN PARA3 P3 ON D.PARA3_CODE = P3.PARA3_CODE   
    JOIN PARA4 P4 ON D.PARA4_CODE = P4.PARA4_CODE   
    JOIN PARA5 P5 ON D.PARA5_CODE = P5.PARA5_CODE   
    JOIN PARA6 P6 ON D.PARA6_CODE = P6.PARA6_CODE 
	JOIN UOM ON UOM.UOM_CODE = A.UOM_CODE 
	WHERE M.MEMO_ID = @CMEMOID
	ORDER BY D.TS 
	
	GOTO LAST



LBLGETDEPARTMENT:
	SELECT * FROM PRD_DEPARTMENT_MST 
	WHERE (DEPARTMENT_ID <> @CWHERE) AND INACTIVE = 0
	ORDER BY DEPARTMENT_NAME 
GOTO LAST

LBLGETPRODUCTLIST:
	SELECT S.*,S.PRODUCT_UID AS PRODUCT_CODE, A.ARTICLE_NO,A.ARTICLE_NAME,A.ARTICLE_DESC,
	SM.SECTION_NAME,SD.SUB_SECTION_NAME,
	P1.PARA1_NAME ,P2.PARA2_NAME ,UOM.UOM_NAME ,A.CODING_SCHEME 
	FROM PRD_SKU S (NOLOCK)
	JOIN ARTICLE A  (NOLOCK) ON S.ARTICLE_CODE = A.ARTICLE_CODE
	JOIN SECTIOND SD  (NOLOCK)  ON SD.SUB_SECTION_CODE = A.SUB_SECTION_CODE
	JOIN SECTIONM SM  (NOLOCK) ON SM.SECTION_CODE = SD.SECTION_CODE
	JOIN PARA1 P1  (NOLOCK) ON S.PARA1_CODE = P1.PARA1_CODE 
	JOIN PARA2 P2  (NOLOCK) ON S.PARA2_CODE = P2.PARA2_CODE 
	JOIN UOM  (NOLOCK) ON UOM.UOM_CODE = A.UOM_CODE 
	JOIN PRD_PMT PMT  (NOLOCK)  ON S.PRODUCT_UID = PMT.PRODUCT_UID   
    WHERE PMT.DEPARTMENT_ID= @CWHERE
GOTO LAST


LBLGETWORKORDERMASTER:
	SELECT DISTINCT T1.*,CONVERT(CHAR(10),ISNULL(T1.MEMO_DT,''),105) AS MEMO_DATE,ART.ARTICLE_NO ,ART.CODING_SCHEME
    FROM PRD_WO_MST T1
    JOIN PRD_WO_DET T2 ON T2.MEMO_ID = T1.MEMO_ID
    JOIN ARTICLE ART ON T1.ARTICLE_SET_CODE = ART.ARTICLE_CODE 
    WHERE T1.CANCELLED = 0 AND T1.MARK_AS_COMPLETED =1
GOTO LAST


LBLGETWODET:
	
	SELECT CAST(1 AS BIT)CHCK, B.ARTICLE_NO,B.ARTICLE_NAME,B.ARTICLE_DESC,A.MEMO_ID
	,D.UOM_NAME ,PARA1.PARA1_CODE,PARA1.PARA1_NAME,PARA2.PARA2_CODE,PARA2.PARA2_NAME
	,SM.SECTION_NAME,SD.SUB_SECTION_NAME
	,P.QUANTITY_IN_STOCK,P.DEPARTMENT_ID,OD.QUANTITY-ISNULL(PRD_STK_QTY,0) AS QUANTITY
	,A.ARTICLE_SET_CODE AS ARTICLE_CODE,S.PRODUCT_UID ,'' AS PRODUCT_CODE
	,S.MRP AS ESTIMATEDMRP, S.MRP,S.PURCHASE_PRICE,B.WHOLESALE_PRICE AS WS_PRICE ,B.CODING_SCHEME
	FROM PRD_WO_MST A 
	JOIN PRD_WO_ORDERS OM ON A.MEMO_ID = OM.MEMO_ID
	JOIN BUYER_ORDER_DET OD ON OM.ORDER_ID = OD.ORDER_ID AND OD.ARTICLE_CODE = A.ARTICLE_SET_CODE 
	JOIN ARTICLE B ON A.ARTICLE_SET_CODE = B.ARTICLE_CODE 
	JOIN SECTIOND SD ON B.SUB_SECTION_CODE=SD.SUB_SECTION_CODE
	JOIN SECTIONM SM ON SD.SECTION_CODE=SM.SECTION_CODE
	JOIN PARA1 ON PARA1.PARA1_CODE = OD.PARA1_CODE 
	JOIN PARA2 ON PARA2.PARA2_CODE = OD.PARA2_CODE
	JOIN UOM D ON B.UOM_CODE = D.UOM_CODE 
	JOIN PRD_SKU S ON A.ARTICLE_SET_CODE = S.ARTICLE_CODE AND S.WORK_ORDER_ID=A.MEMO_ID AND S.PARA1_CODE = OD.PARA1_CODE 
	AND S.PARA2_CODE = OD.PARA2_CODE 
	JOIN PRD_PMT P ON S.PRODUCT_UID = P.PRODUCT_UID 
	JOIN 
	(
		SELECT SM.ARTICLE_SET_CODE , K.PARA1_CODE , K.PARA2_CODE
		FROM PRD_WO_DET A 
		JOIN PRD_WO_MST SM ON SM.MEMO_ID = A.MEMO_ID 
		JOIN PRD_WO_SUB_DET K ON A.ROW_ID = K.REF_ROW_ID 
		WHERE A.MEMO_ID =@CMEMOID
		GROUP BY SM.ARTICLE_SET_CODE,K.PARA1_CODE,K.PARA2_CODE
	) WO ON WO.ARTICLE_SET_CODE = B.ARTICLE_CODE 
		AND WO.PARA1_CODE = OD.PARA1_CODE 
		AND WO.PARA2_CODE = OD.PARA2_CODE
     LEFT OUTER JOIN
    (
     SELECT PRODUCT_UID,SOURCE_DEPARTMENT_ID AS DEPARTMENT_ID,SUM(QUANTITY) AS PRD_STK_QTY  
     FROM PRD_STK_TRANSFER_DTM_DET A
     JOIN PRD_STK_TRANSFER_DTM_MST B ON A.MEMO_ID=B.MEMO_ID
     WHERE B.CANCELLED=0
     AND  B.REF_WO_ID=@CMEMOID
     AND SOURCE_DEPARTMENT_ID=@CWHERE
     GROUP BY PRODUCT_UID,SOURCE_DEPARTMENT_ID
    ) M ON M.DEPARTMENT_ID=P.DEPARTMENT_ID AND S.PRODUCT_UID=M.PRODUCT_UID
	WHERE  P.DEPARTMENT_ID =@CWHERE 
	AND A.MEMO_ID =@CMEMOID
	AND OD.QUANTITY-ISNULL(M.PRD_STK_QTY,0)>0
	
	GOTO LAST
	
	LBLWOCOMPLETED:
	
	
		    
	SELECT X.ARTICLE_CODE,  X.PARA1_CODE,X.PARA2_CODE, 
	ISNULL(X.QTY,0) AS WO_QTY , ISNULL(Y.QTY,0) AS GEN_QTY   
	   
	FROM         
	(         
		SELECT SM.ARTICLE_SET_CODE AS ARTICLE_CODE ,K.PARA1_CODE , K.PARA2_CODE ,K.QUANTITY AS QTY 
		FROM PRD_WO_DET A (NOLOCK)  
		JOIN PRD_WO_MST SM (NOLOCK)  ON SM.MEMO_ID = A.MEMO_ID   
		JOIN PRD_WO_SUB_DET K (NOLOCK)  ON A.ROW_ID = K.REF_ROW_ID   
		WHERE A.MEMO_ID =@CMEMOID   AND SM.CANCELLED =0
		GROUP BY SM.ARTICLE_SET_CODE,K.PARA1_CODE,K.PARA2_CODE,K.QUANTITY        
	) X        
	LEFT OUTER JOIN        
	(        
		SELECT S.ARTICLE_CODE ,  S.PARA1_CODE , S.PARA2_CODE ,SUM(D.QUANTITY ) AS QTY
		FROM PRD_STK_TRANSFER_DTM_DET D (NOLOCK)  
		JOIN PRD_STK_TRANSFER_DTM_MST M (NOLOCK)  ON D.MEMO_ID = M.MEMO_ID 
		JOIN SKU S (NOLOCK)  ON D.PRODUCT_CODE = S.PRODUCT_CODE
		JOIN ARTICLE A (NOLOCK)  ON S.ARTICLE_CODE = A.ARTICLE_CODE   
		WHERE M.REF_WO_ID = @CMEMOID AND M.CANCELLED = 0 
		GROUP BY S.ARTICLE_CODE ,  S.PARA1_CODE , S.PARA2_CODE
	) Y ON X.ARTICLE_CODE = Y.ARTICLE_CODE  AND X.PARA1_CODE= Y.PARA1_CODE AND X.PARA2_CODE= Y.PARA2_CODE         
	       
	WHERE ISNULL(X.QTY,0) <> ISNULL(Y.QTY,0)  
		
	GOTO LAST
	

LAST:
END
