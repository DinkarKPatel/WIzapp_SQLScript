CREATE PROCEDURE SP3S_APRPRINT_DYNAMIC --(LocId 3 digit change by Sanjay:04-11-2024)
(
@cMemoId VARCHAR(40),
@CWHERE NVARCHAR(50)=''
)
AS
BEGIN
	SET NOCOUNT ON
	   DECLARE @cCmdCols NVARCHAR(MAX),@cCmd NVARCHAR(MAX),@cCols NVARCHAR(MAX),@cCmd1 NVARCHAR(MAX),@cCmd2 NVARCHAR(MAX),@cCmd3 NVARCHAR(MAX),@cCmdIMG NVARCHAR(MAX)
	   ,@PARA1 NVARCHAR(10),@PARA2 NVARCHAR(10),@PARA3 NVARCHAR(10),@PARA4 NVARCHAR(10),@PARA5 NVARCHAR(10),@PARA6 NVARCHAR(10)
	
	   

        
		

		DECLARE @IMG_SECTION BIT,@IMG_SUB_SECTION BIT,@IMG_ARTICLE BIT,@IMG_PARA1 BIT,@IMG_PARA2 BIT,@IMG_PARA3 BIT,@IMG_PARA4 BIT,@IMG_PARA5 BIT,@IMG_PARA6 BIT,@IMG_PRODUCT BIT
		SELECT @IMG_SECTION=SECTION,@IMG_SUB_SECTION=SUB_SECTION,@IMG_ARTICLE=ARTICLE        
		,@IMG_PARA1=PARA1 ,@IMG_PARA2=PARA2, @IMG_PARA3=PARA3,@IMG_PARA4=PARA4        
		,@IMG_PARA5=PARA5 ,@IMG_PARA6=PARA6, @IMG_PRODUCT=PRODUCT        
		FROM DBO.IMAGE_INFO_CONFIG WITH(NOLOCK)  
		--END: 30 NOV 2019
		
		
	  
        
        SELECT TOP 1 @PARA1=VALUE FROM CONFIG WHERE config_option='PARA1_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA2=VALUE FROM CONFIG WHERE config_option='PARA2_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA3=VALUE FROM CONFIG WHERE config_option='PARA3_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA4=VALUE FROM CONFIG WHERE config_option='PARA4_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA5=VALUE FROM CONFIG WHERE config_option='PARA5_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA6=VALUE FROM CONFIG WHERE config_option='PARA6_caption' AND ISNULL(VALUE,'') <>''
	    SET @PARA1=CASE WHEN ISNULL(@PARA1,'')='' THEN 'Para1' ELSE ISNULL(@PARA1,'') END
	    SET @PARA2=CASE WHEN ISNULL(@PARA2,'')='' THEN 'Para2' ELSE ISNULL(@PARA2,'') END
	    SET @PARA3=CASE WHEN ISNULL(@PARA3,'')='' THEN 'Para3' ELSE ISNULL(@PARA3,'') END
	    SET @PARA4=CASE WHEN ISNULL(@PARA4,'')='' THEN 'Para4' ELSE ISNULL(@PARA4,'') END
	    SET @PARA5=CASE WHEN ISNULL(@PARA5,'')='' THEN 'Para5' ELSE ISNULL(@PARA5,'') END
	    SET @PARA6=CASE WHEN ISNULL(@PARA6,'')='' THEN 'Para6' ELSE ISNULL(@PARA6,'') END
	   
	    SELECT @cCols=COALESCE(@cCols+',','')+column_name+' ['+DISPLAY_COLUMN_NAME+']' 
	    FROM dynamic_print_cols	
	    WHERE LTRIM(RTRIM(xn_type))='APR' AND selected=1
	   
	
       

	   DECLARE @CSPID VARCHAR(50),@CTABLENAME VARCHAR(50)

		SET @CSPID=LTRIM(RTRIM(STR(@@SPID )))
		SET @CTABLENAME  ='##TMPINVPRINT'+@CSPID

		SET @CCMD = N'IF OBJECT_ID(''TEMPDB..'+@CTABLENAME+''',''U'') IS NOT NULL
			DROP TABLE '+@CTABLENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
                

	   SET @cCmdCols=N'
	   SELECT '+@cCols+',
	   '''+@para1 +''' AS PARA1_CONFIG,'''+@PARA2 +''' AS PARA2_CONFIG,'''+@PARA3 +''' AS PARA3_CONFIG,
	   '''+@PARA4 +''' AS PARA4_CONFIG,'''+@PARA5 +''' AS PARA5_CONFIG,'''+@PARA6 +''' AS PARA6_CONFIG	 
	   '
	   +' INTO '+@CTABLENAME+' '
	   SET @cCmd1=N'  FROM APPROVAL_RETURN_DET APPROVAL_RETURN (NOLOCK)  
	   JOIN APPROVAL_RETURN_MST APR (NOLOCK) ON APR.MEMO_ID=APPROVAL_RETURN.MEMO_ID       
	   JOIN USERS  (NOLOCK) ON USERS.USER_CODE=APR.USER_CODE   
	   LEFT JOIN COMPANY CMP (NOLOCK) ON CMP.COMPANY_CODE=''01''   
	   LEFT OUTER JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID =APR.LOCATION_CODE
	   LEFT JOIN AREA SLA (NOLOCK) ON SL.AREA_CODE=SLA.AREA_CODE                  
	   LEFT JOIN CITY SLC (NOLOCK) ON SLA.CITY_CODE=SLC.CITY_CODE                  
	   LEFT JOIN GST_STATE_MST APRST (NOLOCK) ON APRST.GST_STATE_CODE=SL.GST_STATE_CODE
	   LEFT JOIN STATE SLST (nolock) on SL.gst_state_code =SLST.state_code
	   LEFT JOIN REGIONM SLR (NOLOCK) ON SLST.region_code=SLR.region_code '
       SET @cCmd2=N'       
        JOIN SKU_NAMES (NOLOCK) ON SKU_NAMES.PRODUCT_CODE =APPROVAL_RETURN.APD_PRODUCT_CODE '        
       SET @cCmd3=N' 
                
	   LEFT JOIN CUSTDYM CUST (NOLOCK) ON CUST.cus_gst_state_code=APR.CUSTOMER_CODE  
	   LEFT JOIN GST_STATE_MST CUSTST (NOLOCK) ON CUST.cus_gst_state_code=CUSTST.GST_STATE_CODE
	   LEFT JOIN AREA CUSTAR (NOLOCK) ON CUSTAR.AREA_CODE=CUST.AREA_CODE                  
	   LEFT JOIN CITY CUSTCT (NOLOCK) ON CUSTCT.CITY_CODE=CUSTAR.CITY_CODE    
	   LEFT JOIN EMPLOYEE ON EMPLOYEE.EMP_CODE=APPROVAL_RETURN.EMP_CODE   
	   join bin (nolock) on bin.bin_id=APPROVAL_RETURN.bin_id
	   '

       
       IF CHARINDEX('PROD_IMAGE',@CCOLS)>0
       SET @cCmdIMG=N' JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =APPROVAL_RETURN.APD_PRODUCT_CODE
	                       LEFT OUTER JOIN ' + DB_NAME()+ '_IMAGE..IMAGE_INFO IMG (NOLOCK) ON 1=2 ' +
                            (CASE WHEN @IMG_SECTION = 1 THEN 'AND IMG.SECTION_CODE=SECTIONM.SECTION_CODE' ELSE ''  END) +
                            (CASE WHEN @IMG_SUB_SECTION = 1 THEN ' AND IMG.SUB_SECTION_CODE=SECTIOND.SUB_SECTION_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_ARTICLE = 1 THEN ' AND IMG.ARTICLE_CODE=ARTICLE.ARTICLE_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA1 = 1 THEN ' AND IMG.PARA1_CODE=SKU.PARA1_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA2 = 1 THEN ' AND IMG.PARA2_CODE=SKU.PARA2_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA3 = 1 THEN ' AND IMG.PARA3_CODE=SKU.PARA3_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA4 = 1 THEN  ' AND IMG.PARA4_CODE=SKU.PARA4_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA5 = 1 THEN  ' AND IMG.PARA5_CODE=SKU.PARA5_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA6 = 1 THEN  ' AND IMG.PARA6_CODE=SKU.PARA6_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PRODUCT = 1 THEN  'AND IMG.PRODUCT_CODE=SKU.PRODUCT_CODE' ELSE '' END)
                            +' WHERE APR.MEMO_ID='''+@cMemoId+''''       
       ELSE
          SET @cCmdIMG=N' WHERE WHERE.MEMO_ID='''+@cMemoId+''''
     print 'cCmdCols '+@cCmdCols
    
       PRINT @ccmd1
       PRINT @ccmd2
       PRINT @ccmd3
       PRINT 'IMG '+@cCmdIMG
       EXEC(@cCmdCols+@ccmd1+@ccmd2+@ccmd3+@cCmdIMG)

	   DECLARE  @CERRMSG VARCHAR(100)

	  
	   
 END_PROC:

	   IF ISNULL(@CERRMSG,'')<>'' 
	   BEGIN
		   SELECT @CERRMSG AS ERRMSG 
	   END
	   ELSE 
	   BEGIN
	        
		SET @CCMD = N'SELECT * FROM '+@CTABLENAME+' '
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

	   END

	    SET @CCMD = N'IF OBJECT_ID(''TEMPDB..'+@CTABLENAME+''',''U'') IS NOT NULL
			DROP TABLE '+@CTABLENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

SET NOCOUNT OFF
END


