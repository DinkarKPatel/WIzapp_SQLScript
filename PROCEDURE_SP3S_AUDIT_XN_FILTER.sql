CREATE PROCEDURE SP3S_AUDIT_XN_FILTER--(LocId 3 digit change by Sanjay:04-11-2024)
(
 @XN_TYPE VARCHAR(10),@FROM DATETIME=NULL,@TILL DATETIME=NULL,@LOC VARCHAR(10)='', @UserCode VARCHAR(100)='' 
)
AS 
BEGIN
SET NOCOUNT ON
DECLARE @SQL VARCHAR(MAX),@MTABLE VARCHAR(100),@DTABLE VARCHAR(100),@ID VARCHAR(100),@NO VARCHAR(100),@DT VARCHAR(100)
IF ISNULL(@FROM,'')='' SET @FROM='2000-01-01'
IF ISNULL(@TILL,'')='' SET @TILL=REPLACE(CONVERT(VARCHAR,GETDATE(),102),'.','-')
IF @XN_TYPE='PRT'
   SELECT @MTABLE='RMM01106',@DTABLE='RMD01106',@ID='RM_ID',@NO='RM_NO',@DT='RM_DT'
ELSE IF @XN_TYPE='PUR'
   SELECT @MTABLE='PIM01106',@DTABLE='PID01106',@ID='MRR_ID',@NO='MRR_NO',@DT='MRR_DT'
ELSE IF @XN_TYPE='SLS'
   SELECT @MTABLE='CMM01106',@DTABLE='CMD01106',@ID='CM_ID',@NO='CM_NO',@DT='CM_DT'
ELSE IF @XN_TYPE='WSL'
   SELECT @MTABLE='INM01106',@DTABLE='IND01106',@ID='INV_ID',@NO='INV_NO',@DT='INV_DT'
ELSE IF @XN_TYPE='VCH'
   SELECT @MTABLE='VM01106',@DTABLE='VD01106',@ID='KEY_VALUE',@NO='VOUCHER_NO',@DT='VOUCHER_DT'
ELSE IF @XN_TYPE='PO'
   SELECT @MTABLE='POM01106',@DTABLE='POD01106',@ID='PO_ID',@NO='PO_NO',@DT='PO_DT'
ELSE IF @XN_TYPE='BO'
   SELECT @MTABLE='BUYER_ORDER_MST',@DTABLE='BUYER_ORDER_DET',@ID='ORDER_ID',@NO='ORDER_NO',@DT='ORDER_DT'
ELSE IF @XN_TYPE='WSR'
   SELECT @MTABLE='CNM01106',@DTABLE='CND01106',@ID='CN_ID',@NO='CN_NO',@DT='CN_DT'
 ELSE IF @XN_TYPE='ARC'
   SELECT @MTABLE='ARC01106',@DTABLE='',@ID='ADV_REC_ID',@NO='ADV_REC_NO',@DT='ADV_REC_Dt'
   
IF OBJECT_ID('tempdb..#XN_ID') IS NOT NULL DROP TABLE #XN_ID 
CREATE TABLE #XN_ID(XN_TYPE VARCHAR(500),XN_ID VARCHAR(500),XN_NO VARCHAR(500),XN_DT DATETIME,XN_DT_STR VARCHAR(50))


IF @XN_TYPE='ARC'
BEGIN
     

	  SET @SQL='
		SELECT '''+@XN_TYPE+''',M.'+@ID+',M.'+@NO+',M.'+@DT+',CONVERT(VARCHAR,M.'+@DT+',105)
		FROM (SELECT DISTINCT KEY_VALUE FROM XN_AUDIT_TRIAL_DET X (NOLOCK) WHERE X.TABLE_NAME='''+@MTABLE+''' AND CONVERT(DATE,AUDITED_ON) BETWEEN '''+REPLACE(CONVERT(VARCHAR,@FROM,102),'.','-')+''' AND '''+REPLACE(CONVERT(VARCHAR,@TILL,102),'.','-')+'''
		'+CASE @LOC WHEN '' THEN '' ELSE +' AND location_code='''+@LOC+'''' END+'
		'+CASE @UserCode WHEN '' THEN '' ELSE +' AND X.CWIZUSERCODE='''+@UserCode+'''' END+'
		    )X
		JOIN '+@MTABLE+' M (NOLOCK) ON M.'+@ID+'=X.KEY_VALUE '
		
		PRINT  @SQL
INSERT #XN_ID EXEC(@SQL)
SELECT *,CAST(0 AS BIT)Visit FROM #XN_ID
RETURN
END




IF @XN_TYPE='VCH'
	SET @SQL='SELECT '''+@XN_TYPE+''',X.'+@ID+',v.'+@NO+',V.VOUCHER_DT,CONVERT(VARCHAR,V.VOUCHER_DT,105)
			FROM (SELECT DISTINCT KEY_VALUE FROM XN_AUDIT_TRIAL_DET X (NOLOCK) WHERE X.XN_TYPE='''+@XN_TYPE+'''
			AND CONVERT(DATE,AUDITED_ON) BETWEEN '''+REPLACE(CONVERT(VARCHAR,@FROM,102),'.','-')+''' AND '''+REPLACE(CONVERT(VARCHAR,@TILL,102),'.','-')+'''
			'+CASE @LOC WHEN '' THEN '' ELSE +' AND location_code='''+@LOC+'''' END+')X
			JOIN VM01106 V (NOLOCK) ON V.VM_ID=X.KEY_VALUE'
ELSE
	SET @SQL='
		SELECT '''+@XN_TYPE+''',M.'+@ID+',M.'+@NO+',M.'+@DT+',CONVERT(VARCHAR,M.'+@DT+',105)
		FROM (SELECT DISTINCT KEY_VALUE FROM XN_AUDIT_TRIAL_DET X (NOLOCK) WHERE X.TABLE_NAME='''+@MTABLE+''' AND CONVERT(DATE,AUDITED_ON) BETWEEN '''+REPLACE(CONVERT(VARCHAR,@FROM,102),'.','-')+''' AND '''+REPLACE(CONVERT(VARCHAR,@TILL,102),'.','-')+'''
		'+CASE @LOC WHEN '' THEN '' ELSE +' AND location_code='''+@LOC+'''' END+'
		'+CASE @UserCode WHEN '' THEN '' ELSE +' AND X.CWIZUSERCODE='''+@UserCode+'''' END+'
		UNION 
		SELECT DISTINCT XN_ID FROM XN_AUDIT_TRIAL_DET X (NOLOCK) WHERE X.TABLE_NAME=''PAYMODE_XN_DET'' AND CONVERT(DATE,AUDITED_ON) BETWEEN '''+REPLACE(CONVERT(VARCHAR,@FROM,102),'.','-')+''' AND '''+REPLACE(CONVERT(VARCHAR,@TILL,102),'.','-')+'''
		'+CASE @LOC WHEN '' THEN '' ELSE +' AND location_code='''+@LOC+'''' END+'
		'+CASE @UserCode WHEN '' THEN '' ELSE +' AND X.CWIZUSERCODE='''+@UserCode+'''' END+'
		    )X
		JOIN '+@MTABLE+' M (NOLOCK) ON M.'+@ID+'=X.KEY_VALUE '
		+CASE WHEN @XN_TYPE='SLS' THEN ' WHERE M.'+@ID+'<>''XXXXXXXXXX''' ELSE '' END+
		' UNION
		SELECT '''+@XN_TYPE+''',M.'+@ID+',M.'+@NO+',M.'+@DT+',CONVERT(VARCHAR,M.'+@DT+',105)
		FROM (SELECT DISTINCT KEY_VALUE FROM XN_AUDIT_TRIAL_DET X (NOLOCK) WHERE X.TABLE_NAME='''+@DTABLE+''' AND CONVERT(DATE,AUDITED_ON) BETWEEN '''+REPLACE(CONVERT(VARCHAR,@FROM,102),'.','-')+''' AND '''+REPLACE(CONVERT(VARCHAR,@TILL,102),'.','-')+'''
		'+CASE @LOC WHEN '' THEN '' ELSE +' AND location_code='''+@LOC+'''' END+'
		'+CASE @UserCode WHEN '' THEN '' ELSE +' AND X.CWIZUSERCODE='''+@UserCode+'''' END+'		
		)X
		JOIN '+@DTABLE+' D (NOLOCK) ON D.'+@ID+'+D.PRODUCT_CODE=X.KEY_VALUE
		JOIN '+@MTABLE+' M (NOLOCK) ON D.'+@ID+'=M.'+@ID
		

		

		PRINT  @SQL
INSERT #XN_ID EXEC(@SQL)
SELECT *,CAST(0 AS BIT)Visit FROM #XN_ID
SET NOCOUNT OFF
END
