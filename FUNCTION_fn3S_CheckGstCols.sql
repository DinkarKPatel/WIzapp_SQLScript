CREATE FUNCTION FN3S_CHECKGSTCOLS(@CSOURCETABLE VARCHAR(200),@CKEYFIELD VARCHAR(200),@CXNID VARCHAR(40))
RETURNS VARCHAR(300)
AS
BEGIN
	DECLARE @CGSTCUTOFFDATE VARCHAR(10),@BGSTBILL BIT,@CCMD NVARCHAR(MAX),@CERRPC VARCHAR(50),@BRETVAL BIT,@DXNDT DATETIME,
	@CERRORMSG VARCHAR(300)

	SELECT @BGSTBILL=0,@CERRORMSG=''

				
	SELECT TOP 1  @CGSTCUTOFFDATE=VALUE FROM CONFIG WHERE CONFIG_OPTION='GST_CUT_OFF_DATE'
	IF ISNULL(@CGSTCUTOFFDATE,'')<>''
	BEGIN
		
		IF @CSOURCETABLE='PID01106'
		BEGIN
			SELECT TOP 1 @DXNDT=(CASE WHEN INV_MODE=1 THEN MRR_DT ELSE INV_DT END) FROM PIM01106 B WHERE B.MRR_ID=@CXNID
  		END	
		ELSE
		IF @CSOURCETABLE='RMD01106'
		BEGIN
			SELECT TOP 1 @DXNDT=RM_DT FROM RMM01106 B WHERE B.RM_ID=@CXNID
		END					  		
		ELSE
		IF @CSOURCETABLE='IND01106'
		BEGIN
			SELECT TOP 1 @DXNDT=INV_DT FROM INM01106 B WHERE B.INV_ID=@CXNID
		END	
		ELSE
		IF @CSOURCETABLE='CND01106'
		BEGIN
			SELECT TOP 1 @DXNDT=CN_DT FROM CNM01106 B WHERE B.CN_ID=@CXNID
		END	
		ELSE
		IF @CSOURCETABLE='CMD01106'
		BEGIN
			SELECT TOP 1 @DXNDT=CM_DT FROM CMM01106 B WHERE B.CM_ID=@CXNID				
		END
		
		IF @DXNDT>=CONVERT(DATE,@CGSTCUTOFFDATE)
			SET @BGSTBILL=1
			
	END
		

	IF @CSOURCETABLE='PID01106'
	BEGIN
		SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM PID01106 WHERE MRR_ID=@CXNID
					 AND (( @BGSTBILL=1 AND ISNULL(HSN_CODE,'') IN ('0000000000','')) 
						  OR ( @BGSTBILL=0 AND ISNULL(HSN_CODE,'') NOT IN ('0000000000','')))
		
		IF ISNULL(@CERRPC,'')=''
			SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM PID01106 WHERE MRR_ID=@CXNID
					AND ((@BGSTBILL=1 AND (GST_PERCENTAGE IS NULL OR IGST_AMOUNT IS NULL OR
						  CGST_AMOUNT IS NULL OR SGST_AMOUNT IS NULL))
					  OR (@BGSTBILL=0 AND (ISNULL(GST_PERCENTAGE,0)<>0 OR ISNULL(IGST_AMOUNT,0)<>0 OR
						  ISNULL(CGST_AMOUNT,0)<>0 OR ISNULL(SGST_AMOUNT,0)<>0)))
  	END	
	ELSE
	IF @CSOURCETABLE='RMD01106'
	BEGIN
		SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM RMD01106 WHERE RM_ID=@CXNID
					 AND (( @BGSTBILL=1 AND ISNULL(HSN_CODE,'') IN ('0000000000','')) 
						  OR ( @BGSTBILL=0 AND ISNULL(HSN_CODE,'') NOT IN ('0000000000','')))
		
		IF ISNULL(@CERRPC,'')=''
			SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM RMD01106 WHERE RM_ID=@CXNID
					AND ((@BGSTBILL=1 AND (GST_PERCENTAGE IS NULL OR IGST_AMOUNT IS NULL OR
						  CGST_AMOUNT IS NULL OR SGST_AMOUNT IS NULL))
					  OR (@BGSTBILL=0 AND (ISNULL(GST_PERCENTAGE,0)<>0 OR ISNULL(IGST_AMOUNT,0)<>0 OR
						  ISNULL(CGST_AMOUNT,0)<>0 OR ISNULL(SGST_AMOUNT,0)<>0)))
	END					  		
	ELSE
	IF @CSOURCETABLE='IND01106'
	BEGIN
		SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM IND01106 WHERE INV_ID=@CXNID
					 AND (( @BGSTBILL=1 AND ISNULL(HSN_CODE,'') IN ('0000000000','')) 
						  OR ( @BGSTBILL=0 AND ISNULL(HSN_CODE,'') NOT IN ('0000000000','')))
		
		IF ISNULL(@CERRPC,'')=''
			SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM IND01106 WHERE INV_ID=@CXNID
					  AND ((@BGSTBILL=1 AND (GST_PERCENTAGE IS NULL OR IGST_AMOUNT IS NULL OR
						  CGST_AMOUNT IS NULL OR SGST_AMOUNT IS NULL))
					  OR (@BGSTBILL=0 AND (ISNULL(GST_PERCENTAGE,0)<>0 OR ISNULL(IGST_AMOUNT,0)<>0 OR
						  ISNULL(CGST_AMOUNT,0)<>0 OR ISNULL(SGST_AMOUNT,0)<>0)))
	END	
	ELSE
	IF @CSOURCETABLE='CND01106'
	BEGIN
		SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM CND01106 WHERE CN_ID=@CXNID
					 AND (( @BGSTBILL=1 AND ISNULL(HSN_CODE,'') IN ('0000000000','')) 
						  OR ( @BGSTBILL=0 AND ISNULL(HSN_CODE,'') NOT IN ('0000000000','')))
		
		IF ISNULL(@CERRPC,'')=''
			SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM CND01106 WHERE CN_ID=@CXNID
			AND ((@BGSTBILL=1 AND (GST_PERCENTAGE IS NULL OR IGST_AMOUNT IS NULL OR
						  CGST_AMOUNT IS NULL OR SGST_AMOUNT IS NULL))
					  OR (@BGSTBILL=0 AND (ISNULL(GST_PERCENTAGE,0)<>0 OR ISNULL(IGST_AMOUNT,0)<>0 OR
						  ISNULL(CGST_AMOUNT,0)<>0 OR ISNULL(SGST_AMOUNT,0)<>0)))
	END	
	ELSE
	IF @CSOURCETABLE='CMD01106'
	BEGIN
		SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM CMD01106 WHERE CM_ID=@CXNID
					 AND (( @BGSTBILL=1 AND ISNULL(HSN_CODE,'') IN ('0000000000','')) 
						  OR ( @BGSTBILL=0 AND ISNULL(HSN_CODE,'') NOT IN ('0000000000','')))
		
		IF ISNULL(@CERRPC,'')=''
			SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM CMD01106 WHERE CM_ID=@CXNID
					AND ((@BGSTBILL=1 AND (GST_PERCENTAGE IS NULL OR IGST_AMOUNT IS NULL OR
						  CGST_AMOUNT IS NULL OR SGST_AMOUNT IS NULL))
					  OR (@BGSTBILL=0 AND (ISNULL(GST_PERCENTAGE,0)<>0 OR ISNULL(IGST_AMOUNT,0)<>0 OR
						  ISNULL(CGST_AMOUNT,0)<>0 OR ISNULL(SGST_AMOUNT,0)<>0)))
	END
	
	IF ISNULL(@CERRPC,'')<>''
		SET @CERRORMSG='GST VALIDATION FAILED FOR CN ID:'+@CXNID+' AND PRODUCT CODE:'+@CERRPC
	
	RETURN @CERRORMSG
END
-------------END OF CREATING FUNCTION FN3S_CHECKGSTCOLS
