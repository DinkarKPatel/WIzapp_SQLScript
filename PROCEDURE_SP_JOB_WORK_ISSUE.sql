CREATE PROCEDURE [DBO].[SP_JOB_WORK_ISSUE]          
(          
  @IMODE INT ,          
  @CWHERE VARCHAR(4000)='',      
  @CAGENCYCODE CHAR(7)='',      
  @BMODE BIT = 0 ,    
  @FINYEAR VARCHAR(10)=''  ,    
  @DEPTID VARCHAR(10)=''        
)      
----WITH ENCRYPTION
AS          
          
BEGIN          
   --(dinkar) Replace  left(memoid,2) to Location_code        
		  

declare @SHOW_PRODUCT_CODE_IN_PRD varchar(10)
select @SHOW_PRODUCT_CODE_IN_PRD=value  from config where config_option='SHOW_PRODUCT_CODE_IN_PRD'

 IF @IMODE =1          
 GOTO LBLLOOKUP          
           
 ELSE IF @IMODE =2          
 GOTO LBLMST          
           
 ELSE IF @IMODE =3          
 GOTO LBLDET          
           
 ELSE IF @IMODE =4          
 GOTO LBLHBDDET          
           
 ELSE IF @IMODE =5          
 GOTO LBLAGENCY          
           
 ELSE IF @IMODE =6          
 GOTO LBLAGJOBS          
       
 ELSE IF @IMODE=7       
  GOTO LBLGRID        
      
 ELSE IF @IMODE=8          
	GOTO LBLCANCELCHECK        
 ELSE IF @IMODE=9          
	GOTO BUYER_ORDER_REF_NO      
ELSE IF @IMODE=10          
	GOTO JOB_CARD_LIST    
ELSE IF @IMODE=11          
	GOTO ISSUEDET_WO_BAROCDE    
ELSE IF @IMODE=12         
	GOTO LBLTERM    
 ELSE          
 GOTO LAST        
       
 DECLARE @CCMD NVARCHAR(MAX)         

 LBLTERM:
 	select TERM_NAME,MEMO_ID from PPC_TERM_CONDITION_MST WHERE XN_TYPE='JWI' ORDER BY TERM_NAME
	GOTO LAST
           
LBLLOOKUP:        
    
  SELECT ISSUE_ID FROM JOBWORK_ISSUE_MST (NOLOCK)    
  WHERE FIN_YEAR=@FINYEAR AND location_Code =@CWHERE     
    
 GOTO LAST        
          
LBLMST:	          
 SELECT A.*,B.*,
 '' AS ADDRESS_F,U.USERNAME AS USER_NAME,  
 U1.USERNAME AS EDT_USER_NAME ,BIN.BIN_NAME ,ISNULL(TNC.TERM_NAME,'') AS TERM_NAME  ,
 ISNULL(SHIP.AC_NAME,'') AS SHIPPING_AC_NAME,
 ISNULL(SHIP.address0,'') AS Shipping_address, 
ISNULL(SHIP.address1,'') AS shipping_address2,
ISNULL(SHIP.address2,'') AS shipping_address3,
ISNULL(SHIP.AREA_NAME,'') AS SHIPPING_AREA_NAME,
 ISNULL(SHIP.CITY, '' ) AS SHIPPING_CITY_NAME,
 ISNULL(SHIP.STATE,'') AS SHIPPING_STATE_NAME,
 ISNULL(SHIP.PINCODE,'') AS shipping_pin
 FROM JOBWORK_ISSUE_MST A (NOLOCK)             
 JOIN PRD_AGENCY_MST B (NOLOCK) ON A.AGENCY_CODE = B.AGENCY_CODE             
 --CHANGE JOIN JOBS C (NOLOCK) ON A.COMPANY_CODE = C.COMPANY_CODE            
 LEFT OUTER JOIN USERS U (NOLOCK) ON U.USER_CODE = A.USER_CODE     
 LEFT OUTER  JOIN USERS U1 (NOLOCK) ON U1.USER_CODE = A.EDT_USER_CODE   
 LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID  
 LEFT OUTER JOIN PPC_TERM_CONDITION_MST TNC(NOLOCK) ON TNC.MEMO_ID=A.TERMS_MEMO_ID
 LEFT OUTER JOIN LMV01106 SHIP(NOLOCK) ON SHIP.AC_CODE=A.SHIPPING_AC_CODE
 WHERE A.ISSUE_ID = @CWHERE             
       
 GOTO LAST           
           
LBLDET:          
   if exists (select top 1 'u' FROM JOBWORK_ISSUE_MST (NOLOCK) WHERE issue_id = @CWHERE and wip=1 and isnull(issue_mode,0)=0)
	begin
         

		 SELECT CAST(0 AS BIT) AS CHKBILL, A.ISSUE_NO,A.ISSUE_ID,A.NON_RECEIVABLE,
		G.*,      
		art.ARTICLE_CODE, art.ARTICLE_NO, art.ARTICLE_NAME, p1.PARA1_CODE,        
		PARA1_NAME, p2.PARA2_CODE,PARA2_NAME,p3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
		CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,pmt.BASE_PRICE PURCHASE_PRICE,      
		0 MRP,0 WS_PRICE,   sm.SECTION_NAME, sd.SUB_SECTION_NAME,        
		p4.PARA4_CODE,p5.PARA5_CODE,p6.PARA6_CODE,        
		PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
		ART.DT_CREATED AS [ART_DT_CREATED],'' AS [PARA3_DT_CREATED],'' AS [SKU_DT_CREATED],        
		ART.STOCK_NA,JOBS.JOB_CODE,JOBS.JOB_NAME,G.DUE_DT AS DELIVERY_DT ,  
		(G.JOB_RATE*G.QUANTITY) AS AMOUNT,ART.ALIAS AS ARTICLE_ALIAS,B.BIN_NAME,G.BIN_ID,'' AS PREV_JOB_NAME ,
		A.REMARKS AS MST_REMARKS,'' AS JOB_CARD_NO,'' AS JOB_CARD_ID,ISNULL(dm.design_no,'') as DESIGN_NO,
		'' AS JOB_CARD_NO,G.MERCHANT_NAME,G.BUYER_NAME
		 ,AT1.attr1_key_name,AT2.attr2_key_name,AT3.attr3_key_name,AT4.attr4_key_name,AT5.attr5_key_name,AT6.attr6_key_name,    
					AT7.attr7_key_name,AT8.attr8_key_name,AT9.attr9_key_name,AT10.attr10_key_name,AT11.attr11_key_name,AT12.attr12_key_name,    
					AT13.attr13_key_name,AT14.attr14_key_name,AT15.attr15_key_name,AT16.attr16_key_name,AT17.attr17_key_name,AT18.attr18_key_name,    
					AT19.attr19_key_name,AT20.attr20_key_name,AT21.attr21_key_name,AT22.attr22_key_name,AT23.attr23_key_name,AT24.attr24_key_name,    
					AT25.attr25_key_name ,CAST(0 AS BIT) AS [PRINT]
		FROM JOBWORK_ISSUE_MST A (NOLOCK)             
		JOIN JOBWORK_ISSUE_DET G (NOLOCK)  ON A.ISSUE_ID = G.ISSUE_ID    
		JOIN WIP_PMT PMT (NOLOCK) ON PMT.PRODUCT_CODE=g.PRODUCT_CODE    
		JOIN ARTICLE ART (NOLOCK) ON PMT.article_Code = ART.article_Code 
		JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE 
		JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE
		JOIN PARA1 P1 (NOLOCK) ON pmt.PARA1_CODE = P1.PARA1_CODE          
		JOIN PARA2 P2 (NOLOCK) ON pmt.PARA2_CODE = P2.PARA2_CODE          
		JOIN PARA3 P3 (NOLOCK) ON pmt.PARA3_CODE = P3.PARA3_CODE          
		JOIN PARA4 P4 (NOLOCK) ON pmt.PARA4_CODE = P4.PARA4_CODE          
		JOIN PARA5 P5 (NOLOCK) ON pmt.PARA5_CODE = P5.PARA5_CODE          
		JOIN PARA6 P6 (NOLOCK) ON pmt.PARA6_CODE = P6.PARA6_CODE   
		
               LEFT OUTER JOIN article_fix_attr ATTR  (NOLOCK) ON ART.article_code = ATTR.ARTICLE_CODE     
				LEFT OUTER JOIN attr1_mst at1 (NOLOCK) ON at1.attr1_key_code=ATTR.attr1_key_code    
				LEFT OUTER JOIN attr2_mst at2 (NOLOCK) ON at2.attr2_key_code=ATTR.attr2_key_code    
				LEFT OUTER JOIN attr3_mst at3 (NOLOCK) ON at3.attr3_key_code=ATTR.attr3_key_code    
				LEFT OUTER JOIN attr4_mst at4 (NOLOCK) ON at4.attr4_key_code=ATTR.attr4_key_code    
				LEFT OUTER JOIN attr5_mst at5 (NOLOCK) ON at5.attr5_key_code=ATTR.attr5_key_code    
				LEFT OUTER JOIN attr6_mst at6 (NOLOCK) ON at6.attr6_key_code=ATTR.attr6_key_code    
				LEFT OUTER JOIN attr7_mst at7 (NOLOCK) ON at7.attr7_key_code=ATTR.attr7_key_code    
				LEFT OUTER JOIN attr8_mst at8 (NOLOCK) ON at8.attr8_key_code=ATTR.attr8_key_code    
				LEFT OUTER JOIN attr9_mst at9 (NOLOCK) ON at9.attr9_key_code=ATTR.attr9_key_code    
				LEFT OUTER JOIN attr10_mst at10 (NOLOCK) ON at10.attr10_key_code=ATTR.attr10_key_code    
				LEFT OUTER JOIN attr11_mst at11 (NOLOCK) ON at11.attr11_key_code=ATTR.attr11_key_code    
				LEFT OUTER JOIN attr12_mst at12 (NOLOCK) ON at12.attr12_key_code=ATTR.attr12_key_code    
				LEFT OUTER JOIN attr13_mst at13 (NOLOCK) ON at13.attr13_key_code=ATTR.attr13_key_code    
				LEFT OUTER JOIN attr14_mst at14 (NOLOCK) ON at14.attr14_key_code=ATTR.attr14_key_code    
				LEFT OUTER JOIN attr15_mst at15 (NOLOCK) ON at15.attr15_key_code=ATTR.attr15_key_code    
				LEFT OUTER JOIN attr16_mst at16 (NOLOCK) ON at16.attr16_key_code=ATTR.attr16_key_code    
				LEFT OUTER JOIN attr17_mst at17 (NOLOCK) ON at17.attr17_key_code=ATTR.attr17_key_code    
				LEFT OUTER JOIN attr18_mst at18 (NOLOCK) ON at18.attr18_key_code=ATTR.attr18_key_code    
				LEFT OUTER JOIN attr19_mst at19 (NOLOCK) ON at19.attr19_key_code=ATTR.attr19_key_code    
				LEFT OUTER JOIN attr20_mst at20 (NOLOCK) ON at20.attr20_key_code=ATTR.attr20_key_code    
				LEFT OUTER JOIN attr21_mst at21 (NOLOCK) ON at21.attr21_key_code=ATTR.attr21_key_code    
				LEFT OUTER JOIN attr22_mst at22 (NOLOCK) ON at22.attr22_key_code=ATTR.attr22_key_code    
				LEFT OUTER JOIN attr23_mst at23 (NOLOCK) ON at23.attr23_key_code=ATTR.attr23_key_code    
				LEFT OUTER JOIN attr24_mst at24 (NOLOCK) ON at24.attr24_key_code=ATTR.attr24_key_code    
				LEFT OUTER JOIN attr25_mst at25(NOLOCK) ON at25.attr25_key_code=ATTR.attr25_key_code   		
		
		JOIN UOM E (NOLOCK) ON ART.UOM_CODE = E.UOM_CODE       
		JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE=G.JOB_CODE   
		JOIN BIN B (NOLOCK) ON B.BIN_ID =G.BIN_ID 
		LEFT OUTER JOIN designm dm (NOLOCK) ON dm.design_code=g.design_code
		WHERE A.ISSUE_ID = @CWHERE 
		ORDER BY art.article_no ,p1.para1_name ,p2.para2_order


	 end
	 else
	 begin

	IF ISNULL(@SHOW_PRODUCT_CODE_IN_PRD,'') in ('1') OR ((SELECT ISSUE_MODE FROM JOBWORK_ISSUE_MST (NOLOCK) WHERE ISSUE_ID = @CWHERE)<>1)
	BEGIN

		SELECT CAST(0 AS BIT) AS CHKBILL, A.ISSUE_NO,A.ISSUE_ID,A.NON_RECEIVABLE,
		G.*,      
		sku.ARTICLE_CODE, sn.ARTICLE_NO, sn.ARTICLE_NAME, sku.PARA1_CODE,        
		PARA1_NAME, sku.PARA2_CODE,PARA2_NAME,sku.PARA3_CODE,PARA3_NAME,UOM_NAME,           
		CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,SKU.PURCHASE_PRICE,      
		SKU.MRP,SKU.WS_PRICE,   sn.SECTION_NAME, sn.SUB_SECTION_NAME,        
		sku.PARA4_CODE,sku.PARA5_CODE,sku.PARA6_CODE,        
		PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
		ART.DT_CREATED AS [ART_DT_CREATED],'' AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
		ART.STOCK_NA,JOBS.JOB_CODE,JOBS.JOB_NAME,G.DUE_DT AS DELIVERY_DT ,  
		(G.JOB_RATE*G.QUANTITY) AS AMOUNT,ART.ALIAS AS ARTICLE_ALIAS,B.BIN_NAME,G.BIN_ID,'' AS PREV_JOB_NAME ,
		A.REMARKS AS MST_REMARKS,'' AS JOB_CARD_NO,'' AS JOB_CARD_ID,ISNULL(dm.design_no,'') as DESIGN_NO,
		'' AS JOB_CARD_NO,G.MERCHANT_NAME,G.BUYER_NAME
		,sn.attr1_key_name,sn.attr2_key_name,sn.attr3_key_name,sn.attr4_key_name,sn.attr5_key_name,sn.attr6_key_name,
		sn.attr7_key_name,sn.attr8_key_name,sn.attr9_key_name,sn.attr10_key_name,sn.attr11_key_name,sn.attr12_key_name,
		sn.attr13_key_name,sn.attr14_key_name,sn.attr15_key_name,sn.attr16_key_name,sn.attr17_key_name,sn.attr18_key_name,
		sn.attr19_key_name,sn.attr20_key_name,sn.attr21_key_name,sn.attr22_key_name,sn.attr23_key_name,sn.attr24_key_name,
		sn.attr25_key_name ,CAST(0 AS BIT) AS [PRINT],JPMT.Trading_Product_code
		FROM JOBWORK_ISSUE_MST A (NOLOCK)             
		JOIN JOBWORK_ISSUE_DET G (NOLOCK)  ON A.ISSUE_ID = G.ISSUE_ID    
		join sku_names sn (nolock) on sn.product_Code =g.product_code                     
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=G.PRODUCT_CODE      
		JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE               
		JOIN UOM E (NOLOCK) ON ART.UOM_CODE = E.UOM_CODE       
		JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE=G.JOB_CODE   
		JOIN BIN B (NOLOCK) ON B.BIN_ID =G.BIN_ID 
		LEFT OUTER JOIN designm dm (NOLOCK) ON dm.design_code=g.design_code
		LEFT OUTER JOIN JOBWORK_PMT JPMT (NOLOCK) ON JPMT.PRODUCT_CODE=G.product_code
		WHERE A.ISSUE_ID = @CWHERE 
		ORDER BY sn.article_no ,sn.para1_name ,sn.para2_order 
  
	END   
	ELSE
	BEGIN
        
			;WITH CTE AS
		   (
		  SELECT G.product_code  ,G.issue_id ,G.quantity,
				 G.JOB_RATE,G.REMARKS,G.DEPT_ID,G.COMPANY_CODE,
				 G.NO_HRS,G.JOB_CODE,G.DUE_DT,G.BIN_ID,G.WIP_UID,G.PREV_JOB_CODE,G.PREV_JOB_RATE,
				 G.REF_NO,DESIGN_CODE,G.HSN_CODE,G.GST_PERCENTAGE,
				 G.IGST_AMOUNT AS IGST_AMOUNT,
				 G.CGST_AMOUNT AS CGST_AMOUNT,
				 G.SGST_AMOUNT AS SGST_AMOUNT,
				 G.XN_VALUE_WITHOUT_GST AS XN_VALUE_WITHOUT_GST,
				 G.XN_VALUE_WITH_GST AS XN_VALUE_WITH_GST ,
				 G.PURCHASE_PRICE,
				 CESS_AMOUNT AS CESS_AMOUNT,
				 G.GST_CESS_PERCENTAGE,
				 GST_CESS_AMOUNT AS GST_CESS_AMOUNT,
				 G.BUYER_NAME ,G.MERCHANT_NAME 
		
		  FROM JOBWORK_ISSUE_DET G (NOLOCK) 
		  WHERE G.issue_id =@CWHERE
		)

		SELECT  CAST(0 AS BIT) AS CHKBILL, A.ISSUE_NO,A.ISSUE_ID,A.NON_RECEIVABLE,
				 'LIST'   AS PRODUCT_CODE,
				 SUM(G.QUANTITY) AS QUANTITY,G.JOB_RATE,G.REMARKS,G.DEPT_ID,G.COMPANY_CODE,
				 CAST('LATER'+SKU.ARTICLE_CODE +SKU.PARA1_CODE +SKU.PARA2_CODE AS VARCHAR(40)) AS ROW_ID,GETDATE() LAST_UPDATE,
				 G.NO_HRS,G.JOB_CODE,G.DUE_DT,G.BIN_ID,G.WIP_UID,G.PREV_JOB_CODE,G.PREV_JOB_RATE,
				 G.REF_NO,DESIGN_CODE,G.HSN_CODE,G.GST_PERCENTAGE,
				 SUM(G.IGST_AMOUNT) AS IGST_AMOUNT,
				 SUM(G.CGST_AMOUNT) AS CGST_AMOUNT,
				 SUM(G.SGST_AMOUNT) AS SGST_AMOUNT,
				 SUM(G.XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST,
				 SUM(G.XN_VALUE_WITH_GST) AS XN_VALUE_WITH_GST ,
				 SUM(G.JOB_RATE*G.QUANTITY) AS AMOUNT,
				 avg(G.PURCHASE_PRICE) as PURCHASE_PRICE,
				 SUM(CESS_AMOUNT) AS CESS_AMOUNT,
				 G.GST_CESS_PERCENTAGE,
				 SUM(GST_CESS_AMOUNT) AS  GST_CESS_AMOUNT ,
				 SKU.article_code ,SN.ARTICLE_NO, SN.ARTICLE_NAME,
				 SKU.PARA1_CODE, PARA1_NAME, SKU.PARA2_CODE,PARA2_NAME,SKU.PARA3_CODE,PARA3_NAME,'PCS' AS UOM_NAME,

				SKU.BARCODE_CODING_SCHEME  CODING_SCHEME,G.DUE_DT,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,      
				SKU.MRP,SKU.WS_PRICE,   SN.SECTION_NAME, SN.SUB_SECTION_NAME, SKU.PARA4_CODE,SKU.PARA5_CODE,SKU.PARA6_CODE,        
				PARA4_NAME,PARA5_NAME,PARA6_NAME, '' AS MST_REMARKS,
				 '' UOM_CODE,1 AS [UOM_TYPE],
				''  AS [ART_DT_CREATED],'' AS [PARA3_DT_CREATED],''AS [SKU_DT_CREATED],        
				0 AS STOCK_NA,jobs.job_name  JOB_NAME,'' AS DELIVERY_DT ,  
				'' AS ARTICLE_ALIAS,'' BIN_NAME,'' AS PREV_JOB_NAME ,
			   '' AS JOB_CARD_NO,'' AS JOB_CARD_ID,'' AS DESIGN_NO,
				G.MERCHANT_NAME,G.BUYER_NAME,
				 sn.attr1_key_name,sn.attr2_key_name,sn.attr3_key_name,sn.attr4_key_name,sn.attr5_key_name,sn.attr6_key_name,
				 sn.attr7_key_name,sn.attr8_key_name,sn.attr9_key_name,sn.attr10_key_name,sn.attr11_key_name,sn.attr12_key_name,
				 sn.attr13_key_name,sn.attr14_key_name,sn.attr15_key_name,sn.attr16_key_name,sn.attr17_key_name,sn.attr18_key_name,
				 sn.attr19_key_name,sn.attr20_key_name,sn.attr21_key_name,sn.attr22_key_name,sn.attr23_key_name,sn.attr24_key_name,
				 sn.attr25_key_name ,CAST(0 AS BIT) AS [PRINT],JPMT.Trading_Product_code
		FROM CTE G
		JOIN JOBWORK_ISSUE_MST A (NOLOCK)   ON A.issue_id =G.issue_id       
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=G.PRODUCT_CODE   
		JOIN SKU_NAMES SN (NOLOCK) ON SN.PRODUCT_CODE =SKU.PRODUCT_CODE   
		join jobs (nolock) on jobs.job_code =g.job_code 
		LEFT OUTER JOIN JOBWORK_PMT JPMT (NOLOCK) ON JPMT.PRODUCT_CODE=G.product_code
		GROUP BY  A.ISSUE_NO,A.ISSUE_ID,A.NON_RECEIVABLE,
		 G.JOB_RATE,G.REMARKS,G.DEPT_ID,G.COMPANY_CODE,
		 CAST('LATER'+SKU.ARTICLE_CODE +SKU.PARA1_CODE +SKU.PARA2_CODE AS VARCHAR(40)),
		 G.ISSUE_ID,G.NO_HRS,G.JOB_CODE,G.DUE_DT,G.BIN_ID,G.WIP_UID,G.PREV_JOB_CODE,G.PREV_JOB_RATE, G.REF_NO,DESIGN_CODE,G.HSN_CODE,G.GST_PERCENTAGE,
		  G.GST_CESS_PERCENTAGE, SKU.article_code , SN.ARTICLE_NO, SN.ARTICLE_NAME, 
		 SKU.PARA1_CODE,PARA1_NAME, SKU.PARA2_CODE,PARA2_NAME,SKU.PARA3_CODE,PARA3_NAME,          
		 SKU.BARCODE_CODING_SCHEME ,A.REMARKS,  jobs.job_name ,    
		 SKU.MRP,SKU.WS_PRICE,   SN.SECTION_NAME, SN.SUB_SECTION_NAME,SKU.PARA4_CODE,SKU.PARA5_CODE,SKU.PARA6_CODE,        
		 PARA4_NAME,PARA5_NAME,PARA6_NAME,SKU.DT_CREATED ,G.DUE_DT ,sn.para2_order  ,  
		 sn.attr1_key_name,sn.attr2_key_name,sn.attr3_key_name,sn.attr4_key_name,sn.attr5_key_name,sn.attr6_key_name,
		 sn.attr7_key_name,sn.attr8_key_name,sn.attr9_key_name,sn.attr10_key_name,sn.attr11_key_name,sn.attr12_key_name,
		 sn.attr13_key_name,sn.attr14_key_name,sn.attr15_key_name,sn.attr16_key_name,sn.attr17_key_name,sn.attr18_key_name,
		 sn.attr19_key_name,sn.attr20_key_name,sn.attr21_key_name,sn.attr22_key_name,sn.attr23_key_name,sn.attr24_key_name,sn.attr25_key_name  ,G.MERCHANT_NAME,G.BUYER_NAME
		 ,JPMT.Trading_Product_code
		ORDER BY sn.article_no ,sn.para1_name ,sn.para2_order  

  end
 

 end
  --WHERE A.ISSUE_ID = @CWHERE  
  --ORDER BY G.PRODUCT_CODE          
 GOTO LAST           
      
LBLHBDDET:          
     
  SELECT CAST(0 AS BIT) AS CHKBILL,'' AS CM_ID,'' AS CM_NO,'' AS ROW_ID,CAST('01-01-1900' AS DATETIME) AS DELIVERY_DT,PMT.PRODUCT_CODE,PMT.QUANTITY_IN_STOCK,      
  CAST('1.00' AS NUMERIC(10,2)) AS QUANTITY,          
  ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
  PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
  CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,SKU.PURCHASE_PRICE,      
   SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
  P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
  PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
  ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
  ART.STOCK_NA,'' AS EMP_NAME ,'' AS JOB_NAME ,'' AS JOB_CODE ,0 AS JOB_RATE,ART.ALIAS AS ARTICLE_ALIAS 
   ,AT1.attr1_key_name,AT2.attr2_key_name,AT3.attr3_key_name,AT4.attr4_key_name,AT5.attr5_key_name,AT6.attr6_key_name,
   AT7.attr7_key_name,AT8.attr8_key_name,AT9.attr9_key_name,AT10.attr10_key_name,AT11.attr11_key_name,AT12.attr12_key_name,
   AT13.attr13_key_name,AT14.attr14_key_name,AT15.attr15_key_name,AT16.attr16_key_name,AT17.attr17_key_name,AT18.attr18_key_name,
   AT19.attr19_key_name,AT20.attr20_key_name,AT21.attr21_key_name,AT22.attr22_key_name,AT23.attr23_key_name,AT24.attr24_key_name,
	AT25.attr25_key_name ,CAST(0 AS BIT) AS [PRINT]           
  FROM PMT01106 PMT (NOLOCK)          
  JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=PMT.PRODUCT_CODE      
  JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE          
  JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
  JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE        
  JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE          
  JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE          
  JOIN PARA3 P3 (NOLOCK) ON SKU.PARA3_CODE = P3.PARA3_CODE          
  JOIN PARA4 P4 (NOLOCK) ON SKU.PARA4_CODE = P4.PARA4_CODE          
  JOIN PARA5 P5 (NOLOCK) ON SKU.PARA5_CODE = P5.PARA5_CODE          
  JOIN PARA6 P6 (NOLOCK) ON SKU.PARA6_CODE = P6.PARA6_CODE          
  JOIN UOM E (NOLOCK) ON ART.UOM_CODE = E.UOM_CODE 
  LEFT OUTER JOIN ARTICLE_FIX_ATTR ATTR  (NOLOCK) ON ART.ARTICLE_CODE = ATTR.ARTICLE_CODE 
LEFT OUTER JOIN ATTR1_MST AT1 (NOLOCK) ON AT1.ATTR1_KEY_CODE=ATTR.ATTR1_KEY_CODE
LEFT OUTER JOIN ATTR2_MST AT2 (NOLOCK) ON AT2.ATTR2_KEY_CODE=ATTR.ATTR2_KEY_CODE
LEFT OUTER JOIN ATTR3_MST AT3 (NOLOCK) ON AT3.ATTR3_KEY_CODE=ATTR.ATTR3_KEY_CODE
LEFT OUTER JOIN ATTR4_MST AT4 (NOLOCK) ON AT4.ATTR4_KEY_CODE=ATTR.ATTR4_KEY_CODE
LEFT OUTER JOIN ATTR5_MST AT5 (NOLOCK) ON AT5.ATTR5_KEY_CODE=ATTR.ATTR5_KEY_CODE
LEFT OUTER JOIN ATTR6_MST AT6 (NOLOCK) ON AT6.ATTR6_KEY_CODE=ATTR.ATTR6_KEY_CODE
LEFT OUTER JOIN ATTR7_MST AT7 (NOLOCK) ON AT7.ATTR7_KEY_CODE=ATTR.ATTR7_KEY_CODE
LEFT OUTER JOIN ATTR8_MST AT8 (NOLOCK) ON AT8.ATTR8_KEY_CODE=ATTR.ATTR8_KEY_CODE
LEFT OUTER JOIN ATTR9_MST AT9 (NOLOCK) ON AT9.ATTR9_KEY_CODE=ATTR.ATTR9_KEY_CODE
LEFT OUTER JOIN ATTR10_MST AT10 (NOLOCK) ON AT10.ATTR10_KEY_CODE=ATTR.ATTR10_KEY_CODE
LEFT OUTER JOIN ATTR11_MST AT11 (NOLOCK) ON AT11.ATTR11_KEY_CODE=ATTR.ATTR11_KEY_CODE
LEFT OUTER JOIN ATTR12_MST AT12 (NOLOCK) ON AT12.ATTR12_KEY_CODE=ATTR.ATTR12_KEY_CODE
LEFT OUTER JOIN ATTR13_MST AT13 (NOLOCK) ON AT13.ATTR13_KEY_CODE=ATTR.ATTR13_KEY_CODE
LEFT OUTER JOIN ATTR14_MST AT14 (NOLOCK) ON AT14.ATTR14_KEY_CODE=ATTR.ATTR14_KEY_CODE
LEFT OUTER JOIN ATTR15_MST AT15 (NOLOCK) ON AT15.ATTR15_KEY_CODE=ATTR.ATTR15_KEY_CODE
LEFT OUTER JOIN ATTR16_MST AT16 (NOLOCK) ON AT16.ATTR16_KEY_CODE=ATTR.ATTR16_KEY_CODE
LEFT OUTER JOIN ATTR17_MST AT17 (NOLOCK) ON AT17.ATTR17_KEY_CODE=ATTR.ATTR17_KEY_CODE
LEFT OUTER JOIN ATTR18_MST AT18 (NOLOCK) ON AT18.ATTR18_KEY_CODE=ATTR.ATTR18_KEY_CODE
LEFT OUTER JOIN ATTR19_MST AT19 (NOLOCK) ON AT19.ATTR19_KEY_CODE=ATTR.ATTR19_KEY_CODE
LEFT OUTER JOIN ATTR20_MST AT20 (NOLOCK) ON AT20.ATTR20_KEY_CODE=ATTR.ATTR20_KEY_CODE
LEFT OUTER JOIN ATTR21_MST AT21 (NOLOCK) ON AT21.ATTR21_KEY_CODE=ATTR.ATTR21_KEY_CODE
LEFT OUTER JOIN ATTR22_MST AT22 (NOLOCK) ON AT22.ATTR22_KEY_CODE=ATTR.ATTR22_KEY_CODE
LEFT OUTER JOIN ATTR23_MST AT23 (NOLOCK) ON AT23.ATTR23_KEY_CODE=ATTR.ATTR23_KEY_CODE
LEFT OUTER JOIN ATTR24_MST AT24 (NOLOCK) ON AT24.ATTR24_KEY_CODE=ATTR.ATTR24_KEY_CODE
LEFT OUTER JOIN ATTR25_MST AT25(NOLOCK) ON AT25.ATTR25_KEY_CODE=ATTR.ATTR25_KEY_CODE    
 WHERE PMT.PRODUCT_CODE <> '' AND PMT.PRODUCT_CODE=@CWHERE     
 AND PMT.DEPT_ID=@DEPTID     
      
 GOTO LAST           
          
LBLAGENCY:          
      
    SELECT * FROM PRD_AGENCY_MST (NOLOCK) WHERE  INACTIVE = 0 AND AGENCY_NAME <> ''         
 GOTO LAST           
          
LBLAGJOBS: 

--select * from PRD_AGENCY_MST
 SELECT A.*,B.JOB_RATE ,B.AGENCY_CODE,'' AS ADDRESS_F 
 FROM JOBS (NOLOCK) A 
 JOIN AGENCY_JOBS B (NOLOCK)   ON A.JOB_CODE = B.JOB_CODE           
 JOIN PRD_AGENCY_MST C (NOLOCK) ON B.AGENCY_CODE = C.AGENCY_CODE      
 WHERE  B.AGENCY_CODE = @CWHERE           
 GOTO LAST           
          
LBLGRID:          
  SELECT  A.ISSUE_NO,G.QUANTITY,G.JOB_RATE,G.ROW_ID,G.REF_NO,A.NON_RECEIVABLE,    
    ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
 PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
 CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,SKU.PURCHASE_PRICE,      
 SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
 P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
 PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
 ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
 ART.STOCK_NA ,JOBS.JOB_CODE,JOBS.JOB_NAME,ART.ALIAS AS ARTICLE_ALIAS,
 A.REMARKS          
FROM JOBWORK_ISSUE_MST A (NOLOCK)           
JOIN JOBWORK_ISSUE_DET G (NOLOCK)  ON A.ISSUE_ID = G.ISSUE_ID           
 JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=G.PRODUCT_CODE      
 JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE          
 JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
 JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE        
 JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE          
 JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE          
 JOIN PARA3 P3 (NOLOCK)ON SKU.PARA3_CODE = P3.PARA3_CODE          
 JOIN PARA4 P4 (NOLOCK)ON SKU.PARA4_CODE = P4.PARA4_CODE          
 JOIN PARA5 P5 (NOLOCK)ON SKU.PARA5_CODE = P5.PARA5_CODE          
 JOIN PARA6 P6 (NOLOCK)ON SKU.PARA6_CODE = P6.PARA6_CODE          
 JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE        
 JOIN JOBS  (NOLOCK) ON G.JOB_CODE=JOBS.JOB_CODE          
 WHERE A.ISSUE_ID =@CWHERE          
            
  GOTO LAST          
        
        
LBLCANCELCHECK:      
       
 SELECT Q.ISSUE_ID
 FROM JOBWORK_RECEIPT_MST A (NOLOCK)                       
 JOIN JOBWORK_RECEIPT_DET B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID          
 JOIN JOBWORK_ISSUE_DET M (NOLOCK) ON M.ROW_ID = B.REF_ROW_ID       
 JOIN JOBWORK_ISSUE_MST Q (NOLOCK) ON Q.ISSUE_ID = M.ISSUE_ID       
 WHERE Q.ISSUE_ID = @CWHERE AND A.CANCELLED =0
 UNION 
 SELECT ISSUE_ID  FROM BOM_ISSUE_MST WHERE JOBWORK_ISSUE_ID =@CWHERE
 AND CANCELLED =0
 
 --SELECT * FROM JOBWORK_ISSUE_MST A
 --JOIN JOBWORK_ISSUE_DET 
      
 GOTO LAST      
BUYER_ORDER_REF_NO:
     EXEC SP3S_ORDER_DETAILS_JWI @CWHERE=@CWHERE
	--EXEC SP3S_ORDER_DETAILS @CXNTYPE='JWI',@CMEMO_ID=@CWHERE
    GOTO LAST     
    
JOB_CARD_LIST:
	SELECT C.MEMO_NO,C.MEMO_ID 
	FROM ORD_PLAN_BARCODE_DET a (NOLOCK)
	JOIN ORD_PLAN_DET b (NOLOCK) ON b.ROW_ID=a.REFROW_ID
	JOIN ORD_PLAN_MST c (NOLOCK) ON c.MEMO_ID=b.MEMO_ID
	JOIN jobwork_issue_det d(NOLOCK) ON d.product_code=a.PRODUCT_CODE
	where 1=2
	GROUP BY C.MEMO_NO,C.MEMO_ID 
	GOTO LAST



ISSUEDET_WO_BAROCDE:

    SELECT  MST.AGENCY_CODE ,
	        CAST('LATER'+B.ARTICLE_CODE +B.PARA1_CODE +B.PARA2_CODE AS VARCHAR(40)) AS ROW_ID,
	        A.JOB_RATE ,A.DUE_DT ,B.ARTICLE_CODE ,B.PARA1_CODE ,B.PARA2_CODE ,A.JOB_RATE AS RATE,
			A.JOB_CODE ,SUM(QUANTITY) AS REC_QTY,CAST('' AS VARCHAR(40)) AS SP_ID,CAST('' AS VARCHAR(40)) AS JOBCARD_ID
	       
	FROM JOBWORK_ISSUE_DET A
	JOIN JOBWORK_ISSUE_MST MST (NOLOCK) ON MST.ISSUE_ID =A.ISSUE_ID 
	JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
	WHERE A.ISSUE_ID =@CWHERE AND MST.CANCELLED =0
	and isnull(@SHOW_PRODUCT_CODE_IN_PRD,'')<>'1'
	GROUP BY MST.AGENCY_CODE ,A.JOB_RATE ,A.DUE_DT ,B.ARTICLE_CODE ,B.PARA1_CODE ,B.PARA2_CODE ,A.JOB_RATE ,
			A.JOB_CODE 


    GOTO LAST

LAST:          
              
END

