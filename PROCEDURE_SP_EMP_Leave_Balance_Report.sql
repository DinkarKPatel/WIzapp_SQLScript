CREATE PROCEDURE SP_EMP_LEAVE_BALANCE_REPORT
(  
 @NYEAR INT,   
 @NMONTH INT,
 @BINACTIVE BIT = 0,
 @CEMPIDPARA VARCHAR(20)=''  
)  
--WITH ENCRYPTION
AS  
BEGIN  
	 DECLARE @CEMPID VARCHAR(20)  
	  
	 DECLARE @OUTPUTC TABLE 
	 ( 
		EMP_ID VARCHAR(20), 
		ATT_YEAR INT, 
		ATT_MONTH INT,   
		OPS NUMERIC(10,2), 
		ATD_ABSENT NUMERIC(10,2), 
		LEAVE_DR_FL NUMERIC(10,2), 
		LEAVE_DR_HL NUMERIC(10,2),   
		LEAVE_DR_SL  NUMERIC(10,2), 
		LEAVE_CR_FL NUMERIC(10,2), 
		LEAVE_CR_HL NUMERIC(10,2),  
		LEAVE_CR_SL NUMERIC(10,2), 
		LEAVES_TAKEN NUMERIC(10,2), 
		LEAVES_CREDITED NUMERIC(10,2),  
		CBS NUMERIC(10,2), 
		LWP_DAYS NUMERIC(10,2),
		PRESENT_DAYS INT,
		WEEKLY_OFF_TAKEN INT 
	 )  

	   
	 DECLARE @TEMP_OUTPUTC TABLE 
	 ( 
		OPS NUMERIC(10,2), 
		ATD_ABSENT NUMERIC(10,2), 
		LEAVE_DR_FL NUMERIC(10,2), 
		LEAVE_DR_HL NUMERIC(10,2),   
		LEAVE_DR_SL  NUMERIC(10,2), 
		LEAVE_CR_FL NUMERIC(10,2), 
		LEAVE_CR_HL NUMERIC(10,2),  
		LEAVE_CR_SL NUMERIC(10,2), 
		LEAVES_TAKEN NUMERIC(10,2), 
		LEAVES_CREDITED NUMERIC(10,2),  
		CBS NUMERIC(10,2), 
		LWP_DAYS NUMERIC(10,2),
		PRESENT_DAYS INT,
		WEEKLY_OFF_TAKEN INT,
		SALARY_DAYS INT,
		WORKING_DAYS INT,
	    ATD_EARLY_GOING INT,
	    ATD_LATE_COING INT,
	    ATD_HALF_DAYINT INT,
	    ERRMSG VARCHAR(MAX)
		
	 )  
	  
	  
	 DECLARE EMP_CUR CURSOR FOR  
	 SELECT A.EMP_ID  
	 FROM EMP_MST A  
	 WHERE  A.EMP_STATUS = (CASE WHEN @BINACTIVE = 0 THEN @BINACTIVE 
							ELSE  A.EMP_STATUS END )	
	 
	 AND (EMP_ID=@CEMPIDPARA OR @CEMPIDPARA='')
	 
	 OPEN EMP_CUR  
	   
	 FETCH NEXT FROM EMP_CUR INTO @CEMPID  
	 WHILE @@FETCH_STATUS = 0  
	 BEGIN  
		  DELETE FROM @TEMP_OUTPUTC  
		   
		  INSERT @TEMP_OUTPUTC   
		  EXEC SP_EMP_PAYSLIP_LEAVESCALC_MAIN @CEMPID, @NYEAR, @NMONTH,1  

		  INSERT @OUTPUTC ( EMP_ID, ATT_YEAR, ATT_MONTH, OPS, ATD_ABSENT, LEAVE_DR_FL, LEAVE_DR_HL, LEAVE_DR_SL,  
				LEAVE_CR_FL, LEAVE_CR_HL, LEAVE_CR_SL, LEAVES_TAKEN, LEAVES_CREDITED, CBS, LWP_DAYS,PRESENT_DAYS,WEEKLY_OFF_TAKEN )   
		  SELECT @CEMPID AS EMP_ID, @NYEAR AS ATT_YEAR, @NMONTH AS ATT_MONTH, OPS, ATD_ABSENT, LEAVE_DR_FL, LEAVE_DR_HL, LEAVE_DR_SL,  
				LEAVE_CR_FL, LEAVE_CR_HL, LEAVE_CR_SL, LEAVES_TAKEN, LEAVES_CREDITED, CBS, LWP_DAYS,  
				PRESENT_DAYS,WEEKLY_OFF_TAKEN
		  FROM @TEMP_OUTPUTC  
		  
		  FETCH NEXT FROM EMP_CUR INTO @CEMPID  
	 END  
	 CLOSE EMP_CUR  
	 DEALLOCATE EMP_CUR  
	  
	 SELECT A.EMP_ID, 
	 B.REF_ID, 
	 B.EMP_FNAME + ' ' + B.EMP_LNAME AS EMP_NAME,   
	   B.DEPT_ID, 
	   C.DEPT_ALIAS, 
	   C.DEPT_NAME,   
	   B.DEPARTMENT_ID, 
	   D.DEPARTMENT_NAME,  
	   A.ATT_YEAR, 
	   A.ATT_MONTH, 
	   A.PRESENT_DAYS AS PRESENT, 
	   A.WEEKLY_OFF_TAKEN AS WEEKLY_OFF, 
	   A.ATD_ABSENT,   
	   A.OPS, 
	   A.LEAVE_DR_FL, 
	   A.LEAVE_DR_HL, 
	   A.LEAVE_DR_SL,  
	   A.LEAVE_CR_FL AS LEAVE_CR_FL, 
	   A.LEAVE_CR_HL, 
	   A.LEAVE_CR_SL,   
	   A.LWP_DAYS, 
	   A.CBS, 
	   A.LEAVES_TAKEN, 
	   A.LEAVES_CREDITED  
	 FROM @OUTPUTC A   
	 JOIN EMP_MST B ON A.EMP_ID = B.EMP_ID  
	 JOIN LOCATION C ON B.DEPT_ID = C.DEPT_ID  
	 JOIN EMP_DEPARTMENT D ON B.DEPARTMENT_ID = D.DEPARTMENT_ID  
	 LEFT OUTER JOIN VW_ATTSUMMARY E ON  A.EMP_ID = E.EMP_ID  
			 AND A.ATT_YEAR = E.ATT_YEAR  
			 AND A.ATT_MONTH = E.ATT_MONTH  
END
