CREATE TRIGGER IO_TRIG_LMV01106 ON  LMV01106 
--WITH ENCRYPTION
INSTEAD OF INSERT, UPDATE, DELETE
AS
BEGIN											-- START OF THE MAIN BLOCK
	SET NOCOUNT ON
	DECLARE @BPHYSICAL BIT,
			@CACCODE VARCHAR(10),
			@CHEADCODE VARCHAR(10),
			@CCITYCODE VARCHAR(10),
			@CSTATECODE VARCHAR(10),
			@CNEXTCITYCODE VARCHAR(10),
			@CNEXTSTATECODE VARCHAR(10),
			@CCOMPANYCODE CHAR(2),
			@CPREFIX VARCHAR(2), 
			@NBOOL BIT
	
	IF EXISTS ( SELECT AC_CODE FROM INSERTED )		-- TRIGGERING ACTION, INSERT OR UPDATE OCCURED
	BEGIN 
		-- STORE THE VALUE OF NEW ACCODE AND HEADCODE IN VARIABLES
		SELECT 	@CACCODE = AC_CODE,
				@CHEADCODE = HEAD_CODE 
				FROM INSERTED	
	
        --UPLOADED_TO_ACTIVSTREAM, GLN_NO
		-- INSERT/UPDATE IN LM01106 TABLE
		-- CHECK WHETHER THE INSERTED LEDGER IS EXIST IN LM, IF NOT DO AN INSERT
		IF (NOT EXISTS (SELECT AC_CODE FROM LM01106 WHERE AC_CODE = @CACCODE))
			INSERT INTO LM01106 (AC_CODE, AC_NAME, ALIAS, HEAD_CODE,OPENING_BALANCE,OPENING_BALANCE_CR_DR,
						CLOSING_BALANCE, CLOSING_BALANCE_CR_DR, PRINT_LEDGER, LAST_UPDATE,
						TDS_CODE, INACTIVE,USER_CODE,EDT_USER_CODE,COMPANY_CODE ,ALIAS_TO_BE_SUFFIXED
						,SHARE_WITH_WH,SHARE_WITH_COMPANY_OWNED_POS,SHARE_WITH_FRANCHISE_CONSIGNEE 
						,SHARE_WITH_FRANCHISE_OUTRIGHT,hsn_code,lm_REMARKS,major_ac_code,sor_party,GSTR3B)
			SELECT 	AC_CODE, AC_NAME, ALIAS, HEAD_CODE,0 AS OPENING_BALANCE,' ' AS OPENING_BALANCE_CR_DR, 
						CLOSING_BALANCE, CLOSING_BALANCE_CR_DR, PRINT_LEDGER, LAST_UPDATE, 
						TDS_CODE, INACTIVE,ISNULL(USER_CODE,'0000000'),ISNULL(EDT_USER_CODE,'0000000'),
						COMPANY_CODE,ALIAS_TO_BE_SUFFIXED
						,SHARE_WITH_WH,SHARE_WITH_COMPANY_OWNED_POS,SHARE_WITH_FRANCHISE_CONSIGNEE ,SHARE_WITH_FRANCHISE_OUTRIGHT ,
						isnull(hsn_code,'') as hsn_code,isnull(lm_REMARKS,'') as REMARKS,
			(CASE WHEN major_ac_code='' THEN AC_CODE ELSE major_ac_code END),sor_party	,ISNULL(GSTR3B,0)		
			FROM INSERTED
		ELSE
			-- THE INSERTED LEDGER IS ALREADY EXIST SO UPDATE THE ENTRY
			UPDATE LM01106
				SET AC_NAME 		= I.AC_NAME, 
					ALIAS 			= I.ALIAS, 
					HEAD_CODE 		= I.HEAD_CODE, 
					CLOSING_BALANCE = I.CLOSING_BALANCE, 
					CLOSING_BALANCE_CR_DR = I.CLOSING_BALANCE_CR_DR, 
					PRINT_LEDGER 	= I.PRINT_LEDGER, 
					LAST_UPDATE 	= I.LAST_UPDATE,
					TDS_CODE		= I.TDS_CODE,
					INACTIVE		= I.INACTIVE,
					EDT_USER_CODE	= ISNULL(I.EDT_USER_CODE,'0000000'),
					COMPANY_CODE	= I.COMPANY_CODE,
					ALIAS_TO_BE_SUFFIXED= I.ALIAS_TO_BE_SUFFIXED,
					SHARE_WITH_WH=I.SHARE_WITH_WH ,
					SHARE_WITH_COMPANY_OWNED_POS=I.SHARE_WITH_COMPANY_OWNED_POS,
					SHARE_WITH_FRANCHISE_CONSIGNEE=I.SHARE_WITH_FRANCHISE_CONSIGNEE, 
					SHARE_WITH_FRANCHISE_OUTRIGHT=I.SHARE_WITH_FRANCHISE_OUTRIGHT ,
					hsn_code=isnull(i.hsn_code,'') ,
					lm_REMARKS=isnull(i.lm_REMARKS,''),
					major_ac_code=i.major_ac_code,
				    sor_party=i.sor_party,
					GSTR3B=ISNULL(I.GSTR3B,0)
				FROM LM01106 LM, INSERTED I
				WHERE LM.AC_CODE = I.AC_CODE
		
		-- INSERT/UPDATE/DELETE IN LMP01106 TABLE
		-- IF THE INSERTED RECORD IS PHYSICAL, THEN INSERT A CORRESPONDING RECORD IN LMP	
		SELECT @BPHYSICAL = PHYSICAL FROM HD01106 WHERE HEAD_CODE = @CHEADCODE
		IF @BPHYSICAL = 1 
		BEGIN
			IF NOT EXISTS (SELECT AC_CODE FROM LMP01106 WHERE AC_CODE = @CACCODE)
				INSERT INTO LMP01106 (AC_CODE, PRINT_NAME, ADDRESS0, ADDRESS1, ADDRESS2, AREA_CODE, 
							CST_NO, CST_DT, SST_NO, SST_DT, TIN_NO, TIN_DT, PHONES_R, PHONES_O, PHONES_FAX, MOBILE, 
							E_MAIL, TAX_CODE, CREDIT_DAYS, DISCOUNT_PERCENTAGE,  
							ON_HOLD, THROUGH_BROKER, BROKER_AC_CODE, BROKER_COMM_PERCENT, CREDIT_LIMIT, 
							 ALLOW_CREDITOR_DEBTOR, LAST_UPDATE, DPWEF_DT , 
							CST_PERCENTAGE, PAN_NO, FORM_ID,  CUSTOMER_CODE,BILL_BY_BILL,
							 GLN_NO,MP_PERCENTAGE,MRP_CALC_MODE,CITY_CODE,COMPANY_CODE,
							 OUTSTATION_PARTY,INV_RATE_TYPE,DEFAULT_RATE_TYPE,PUR_CAL_METHOD,RESTRICT_PUR_ENTRY,WP_PERCENTAGE
							 ,WSL_RATE_CALC_METHOD,EOSS_DISCOUNT_SHARE,EOSS_DISCOUNT_PER,Purchase_Against_terms,shipping_address,shipping_address2 ,shipping_address3,
							 custom_rate_type,DO_NOT_ALLOW_DIRECT_PUR,Enable_Email,WhatsApp_no,Ac_gst_no,registered_gst_dealer,THRU_RTGS,PARTY_ERP_CODE,Angadia_code,ac_gst_state_code
							 ,PARTY_RATE_MEMO_ID
							 --14 Mar 2018
							 ,PARTY_RATE_SUPP
							 ,order_allocation_priority,
							 hold_for_payment,
							 AR_ID,
							 CONTACT_PERSON_NAME,
							 export_gst_mode,
							 export_gst_percentage,
							 TRADE_DISCOUNT_PERCENTAGE,
							 ROUND_OFF_GST_AMT,
							 export_gst_percentage_Applicable,
							 rcm_applicable,
							  ALLOW_ALLOCATION_WIP_STK,
							  e_mail_cc,cd_calc_based_on,
							  fc_code,mp_calc_based_on,PT_ID,LMP_MSME,LMP_MSME_NO
							  ,LMP_MSME_ACITIVITY,LMP_MSME_NIC,LMP_MSME_AGREEMENT,
							  LMP_MSME_TYPE,DoNotDebitGoodsTCS,freightPaidBy
							 
							
							 )
					SELECT  AC_CODE, PRINT_NAME, ADDRESS0, ADDRESS1, ADDRESS2, AREA_CODE, 
							CST_NO, CST_DT, SST_NO, SST_DT, TIN_NO, TIN_DT, PHONES_R, PHONES_O, PHONES_FAX, MOBILE, 
							E_MAIL, TAX_CODE, CREDIT_DAYS, DISCOUNT_PERCENTAGE,  
							ON_HOLD, THROUGH_BROKER, BROKER_AC_CODE, BROKER_COMM_PERCENT, CREDIT_LIMIT, 
							 ALLOW_CREDITOR_DEBTOR, LAST_UPDATE, DPWEF_DT, 
							CST_PERCENTAGE, PAN_NO, FORM_ID,  CUSTOMER_CODE,BILL_BY_BILL,
							 GLN_NO,MP_PERCENTAGE,MRP_CALC_MODE,CITY_CODE,COMPANY_CODE,OUTSTATION_PARTY,
							 INV_RATE_TYPE
							 ,ISNULL(DEFAULT_RATE_TYPE,1),ISNULL(PUR_CAL_METHOD,1)
							 ,ISNULL(RESTRICT_PUR_ENTRY,0),ISNULL(WP_PERCENTAGE,0),ISNULL(WSL_RATE_CALC_METHOD,0)
							 ,ISNULL(EOSS_DISCOUNT_SHARE,0),ISNULL(EOSS_DISCOUNT_PER,0),ISNULL(Purchase_Against_terms,0),ISNULL(shipping_address,'')
							 ,ISNULL(shipping_address2,''),ISNULL(shipping_address3,''),custom_rate_type,ISNULL(DO_NOT_ALLOW_DIRECT_PUR,0),
							 ISNULL(Enable_Email,0), ISNULL(WhatsApp_no,''),ISNULL(Ac_gst_no,''),ISNULL(registered_gst_dealer,0),isnull(THRU_RTGS,0),isnull(PARTY_ERP_CODE,''),
							 ISNULL(Angadia_code,'0000000'),ISNULL(ac_gst_state_code,'00') 
							 ,ISNULL(PARTY_RATE_MEMO_ID,'')
							 ,PARTY_RATE_SUPP--14 Mar 2018
							 ,order_allocation_priority
							 ,isnull(hold_for_payment,0)
							 ,isnull(AR_ID,'')
							 ,isnull(CONTACT_PERSON_NAME,'')
							 ,export_gst_mode
							 ,export_gst_PERCENTAGE
							 ,TRADE_DISCOUNT_PERCENTAGE
							 ,ROUND_OFF_GST_AMT,export_gst_percentage_Applicable
							 ,rcm_applicable
							 ,ISNULL(ALLOW_ALLOCATION_WIP_STK,0) 
							 ,e_mail_cc,cd_calc_based_on
							 ,fc_code,isnull(mp_calc_based_on,1)
							 ,PT_ID,LMP_MSME,LMP_MSME_NO,LMP_MSME_ACITIVITY,
							 LMP_MSME_NIC,LMP_MSME_AGREEMENT,LMP_MSME_TYPE,
							 isnull(DoNotDebitGoodsTCS,0),
							 isnull(freightPaidBy,1)
					FROM INSERTED
			ELSE
				UPDATE LMP01106
					SET	PRINT_NAME 		= I.PRINT_NAME, 
						ADDRESS0 		= I.ADDRESS0, 
						ADDRESS1 		= I.ADDRESS1, 
						ADDRESS2 		= I.ADDRESS2,
						AREA_CODE		= I.AREA_CODE, 
						CST_NO 			= I.CST_NO, 
						CST_DT 			= I.CST_DT, 
						SST_NO 			= I.SST_NO, 
						SST_DT 			= I.SST_DT, 
						TIN_NO 			= I.TIN_NO, 
						TIN_DT 			= I.TIN_DT, 
						PHONES_R 		= I.PHONES_R, 
						PHONES_O 		= I.PHONES_O, 
						PHONES_FAX 		= I.PHONES_FAX, 
						MOBILE 			= I.MOBILE, 
						E_MAIL 			= I.E_MAIL, 	
						TAX_CODE 		= I.TAX_CODE, 
						CREDIT_DAYS 	= I.CREDIT_DAYS, 
						DISCOUNT_PERCENTAGE = I.DISCOUNT_PERCENTAGE, 
						BILL_BY_BILL 	= I.BILL_BY_BILL, 
						ON_HOLD 		= I.ON_HOLD, 	
						THROUGH_BROKER 	= I.THROUGH_BROKER, 
						BROKER_AC_CODE 	= I.BROKER_AC_CODE, 
						BROKER_COMM_PERCENT = I.BROKER_COMM_PERCENT, 
						CREDIT_LIMIT 	= I.CREDIT_LIMIT, 
						ALLOW_CREDITOR_DEBTOR = I.ALLOW_CREDITOR_DEBTOR, 
						LAST_UPDATE 	= I.LAST_UPDATE,
						DPWEF_DT 		= I.DPWEF_DT,
						CST_PERCENTAGE	= I.CST_PERCENTAGE,
						PAN_NO			= I.PAN_NO,
						FORM_ID			= I.FORM_ID,
						CUSTOMER_CODE	= I.CUSTOMER_CODE,
						GLN_NO			= I.GLN_NO,
						MP_PERCENTAGE   = I.MP_PERCENTAGE,
						MRP_CALC_MODE   = I.MRP_CALC_MODE,
						OUTSTATION_PARTY = I.OUTSTATION_PARTY,
						INV_RATE_TYPE	 =I.INV_RATE_TYPE,
						COMPANY_CODE	= I.COMPANY_CODE,
						DEFAULT_RATE_TYPE	 =I.DEFAULT_RATE_TYPE,
						PUR_CAL_METHOD = I.PUR_CAL_METHOD,
						RESTRICT_PUR_ENTRY= I.RESTRICT_PUR_ENTRY,
						WP_PERCENTAGE= I.WP_PERCENTAGE,
						WSL_RATE_CALC_METHOD=I.WSL_RATE_CALC_METHOD
						,EOSS_DISCOUNT_SHARE=ISNULL(I.EOSS_DISCOUNT_SHARE,0)
						,EOSS_DISCOUNT_PER=ISNULL(I.EOSS_DISCOUNT_PER,0)
						,Purchase_Against_terms=ISNULL(I.Purchase_Against_terms,0)
						,shipping_address =ISNULL(I.shipping_address,'')
						,shipping_address2 =ISNULL(I.shipping_address2,'')
						,shipping_address3 =ISNULL(I.shipping_address3,'')
						,custom_rate_type=isnull(I.custom_rate_type,0)
						,DO_NOT_ALLOW_DIRECT_PUR=isnull(I.DO_NOT_ALLOW_DIRECT_PUR,0)
						,Enable_Email= ISNULL(I.Enable_Email,0)
						,WhatsApp_no= ISNULL(I.WhatsApp_no,'')
						,Ac_gst_no= ISNULL(I.Ac_gst_no,'')
						,registered_gst_dealer= ISNULL(I.registered_gst_dealer,0)						
						,THRU_RTGS=isnull(I.THRU_RTGS,0) 
						,PARTY_ERP_CODE= isnull(I.PARTY_ERP_CODE,'')
						,Angadia_code = isnull(I.Angadia_code,'')
						,ac_gst_state_code = isnull(I.ac_gst_state_code,'00')	
						,PARTY_RATE_MEMO_ID	= isnull(I.PARTY_RATE_MEMO_ID,'')				
						--14 Mar 2018
						,PARTY_RATE_SUPP=ISNULL(I.PARTY_RATE_SUPP,0)
						,order_allocation_priority=ISNULL(i.order_allocation_priority,0)
						,hold_for_payment= isnull(I.hold_for_payment,0)
						,AR_ID =isnull(I.AR_ID,'')
						,CONTACT_PERSON_NAME= isnull(I.CONTACT_PERSON_NAME,'')
						,export_gst_mode=ISNULL(I.export_gst_mode,0)
						,export_gst_percentage=ISNULL(I.export_gst_percentage,0)						
						,TRADE_DISCOUNT_PERCENTAGE= ISNULL(I.TRADE_DISCOUNT_PERCENTAGE,0)
					    ,ROUND_OFF_GST_AMT = ISNULL(I.ROUND_OFF_GST_AMT,0)
					    ,export_gst_percentage_Applicable = isnull(I.export_gst_percentage_Applicable,0)
						,rcm_applicable=ISNULL(i.rcm_applicable,0)
						, ALLOW_ALLOCATION_WIP_STK= isnull(I.ALLOW_ALLOCATION_WIP_STK,0)
						,e_mail_cc=i.e_mail_cc
						,cd_calc_based_on=i.cd_calc_based_on
						,fc_code= I.fc_code
						,mp_calc_based_on=isnull(i.mp_calc_based_on,1),
						PT_ID= I.PT_ID,
						LMP_MSME= I.LMP_MSME,
						LMP_MSME_NO= I.LMP_MSME_NO,
						LMP_MSME_ACITIVITY=I.LMP_MSME_ACITIVITY,
						LMP_MSME_NIC=I.LMP_MSME_NIC,
						LMP_MSME_AGREEMENT=I.LMP_MSME_AGREEMENT,
						LMP_MSME_TYPE=I.LMP_MSME_TYPE,
						DoNotDebitGoodsTCS=ISNULL(I.DoNotDebitGoodsTCS,0),
						freightPaidBy= isnull(I.freightPaidBy,1)
					FROM LMP01106 LMP, INSERTED I
					WHERE LMP.AC_CODE = I.AC_CODE
		END
		ELSE-- HEAD IS NOT PHYSICAL, SO CHECK IF ANY ENTRY LIES IN THE LMP, DELETE IT
			IF EXISTS (SELECT AC_CODE FROM LMP01106 WHERE AC_CODE = @CACCODE)
				DELETE FROM LMP01106 WHERE AC_CODE = @CACCODE
		
	END
	ELSE			-- TRIGGERING ACTION 'DELETE' HAS OCCURED, THAT'S WHY INSERTED TABLE IS BLANK
		IF EXISTS ( SELECT AC_CODE FROM DELETED )
		BEGIN
--			SELECT @CACCODE = AC_CODE FROM DELETED
			
			-- DELETE THE ENTRY FROM LMP FIRST AND THEN FROM LM TABLES
			IF EXISTS ( SELECT AC_CODE FROM LMP01106 WHERE AC_CODE IN ( SELECT AC_CODE FROM DELETED ) )
				DELETE FROM LMP01106 WHERE AC_CODE IN ( SELECT AC_CODE FROM DELETED )
			IF EXISTS ( SELECT AC_CODE FROM LM01106 WHERE AC_CODE IN ( SELECT AC_CODE FROM DELETED ) )
				DELETE FROM LM01106 WHERE AC_CODE IN ( SELECT AC_CODE FROM DELETED )
		
		END
END				-- END OF THE MAIN BLOCK
--END OF TRIGGER - IO_TRIG_LMV01106

