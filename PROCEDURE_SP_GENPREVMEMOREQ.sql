CREATE PROCEDURE SP_GENPREVMEMOREQ
@CXNTYPE VARCHAR(10),
@CTABLENAME VARCHAR(200),
@CKEYFIELD VARCHAR(100),
@CMERGEMEMOID VARCHAR(40),
@CMISSINGMEMOID VARCHAR(40),
@NMEMONOLEN INT,
@NGRPCHARS INT
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CMEMOLOCID CHAR(2),@NPREVNO INT,@CERRORMSG VARCHAR(500),@CGRPCODE VARCHAR(10),@BRETVAL BIT,
			@CCMD NVARCHAR(MAX),@CPREVMEMOID VARCHAR(40),@NPREVMEMOID INT
	
	IF @CXNTYPE='XNSCHI'
		SELECT @CMEMOLOCID=MAJOR_DEPT_ID FROM LOCATION WHERE DEPT_ID=SUBSTRING(RIGHT(@CMISSINGMEMOID,10),3,2)	
	ELSE
		SELECT @CMEMOLOCID=MAJOR_DEPT_ID FROM LOCATION WHERE DEPT_ID=LEFT(@CMISSINGMEMOID,2)	

	SELECT @NPREVMEMOID=1,@BRETVAL=1

			
	SET @CERRORMSG='PREVIOUS MEMO ID :'+@CMISSINGMEMOID+' FOUND MISSING WHILE MERGING : '+@CMERGEMEMOID
	
	SELECT TOP 1 @CGRPCODE=GRP_CODE FROM COMPANY (NOLOCK) WHERE COMPANY_CODE='01'
	
	INSERT XN_HISTORY	( GRP_CODE, XN_TYPE, MEMO_ID, TARGET_DEPT_ID, LAST_UPDATE, REQ, ERRMSG,REQ_SENT )
	SELECT @CGRPCODE AS GRP_CODE,@CXNTYPE AS XN_TYPE,@CMERGEMEMOID AS MEMO_ID,@CMEMOLOCID 
	AS TARGET_DEPT_ID,GETDATE() AS LAST_UPDATE,1 AS  REQ,@CERRORMSG AS ERRMSG,0 AS REQ_SENT
							
	PRINT 'MISSING CM : '+@CMISSINGMEMOID
	 
	DECLARE @CFLOORID CHAR(2),@CORGMISSINGMEMOID VARCHAR(40),@BFIRSTENTRY BIT
    
    
    PRINT 'MISSING CM : '+@CMISSINGMEMOID  
  
   --- INSERT REQUEST ENTRIES FOR ALL PREVIOUS MISSING MEMO ID'S  
	WHILE @BRETVAL=1 AND @NPREVMEMOID>0  
	BEGIN  
		  
		  PRINT 'REQ-1'	
		  SET @CERRORMSG='PREVIOUS MEMO ID :'+@CMISSINGMEMOID+' FOUND MISSING WHILE MERGING : '+@CMERGEMEMOID  
	        
		  SET @CCMD=N'IF EXISTS(SELECT TOP 1 '+@CKEYFIELD+' FROM '+@CTABLENAME+' (NOLOCK)
								WHERE '+@CKEYFIELD+'='''+@CMISSINGMEMOID+''')  
							SET @BRETVALOUT=0  
						  ELSE
							SET @BRETVALOUT=1'	
		  EXEC SP_EXECUTESQL @CCMD,N'@BRETVALOUT BIT OUTPUT',@BRETVALOUT=@BRETVAL OUTPUT				
			  
		 PRINT 'REQ-2'
			  
		  IF @BRETVAL=0				
			BREAK	
			  
	  	  INSERT XN_HISTORY ( GRP_CODE, XN_TYPE, MEMO_ID, TARGET_DEPT_ID, LAST_UPDATE, REQ, ERRMSG )  
		  SELECT @CGRPCODE AS GRP_CODE,@CXNTYPE AS XN_TYPE,@CMISSINGMEMOID AS MEMO_ID,@CMEMOLOCID   
		  AS TARGET_DEPT_ID,GETDATE() AS LAST_UPDATE,1 AS  REQ,@CERRORMSG AS ERRMSG  

PRINT 'REQ-3-'+@CMISSINGMEMOID+'-'+STR(@NMEMONOLEN)			  
		  SET @NPREVMEMOID=CONVERT(NUMERIC,RIGHT(RIGHT(@CMISSINGMEMOID,@NMEMONOLEN),@NMEMONOLEN-@NGRPCHARS))-1  
		  
		  IF @NPREVMEMOID=0  	  
				BREAK	

PRINT 'REQ-4'				
		  SET @CMISSINGMEMOID=SUBSTRING(@CMISSINGMEMOID,1,LEN(@CMISSINGMEMOID)-(@NMEMONOLEN-@NGRPCHARS))+REPLICATE('0',@NMEMONOLEN-@NGRPCHARS  
			   -LEN(LTRIM(RTRIM(STR(@NPREVMEMOID)))))+LTRIM(RTRIM(STR(@NPREVMEMOID)))  
	    
	 END 
END
---- 'END OF CREATING PROCEDURE SP_GENPREVMEMOREQ'
