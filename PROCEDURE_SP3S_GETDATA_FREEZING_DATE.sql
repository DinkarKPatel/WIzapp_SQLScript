CREATE PROCEDURE SP3S_GETDATA_FREEZING_DATE
@CXNTYPE VARCHAR(10),
@DFREEZINGDATE DATETIME OUTPUT
AS
BEGIN
	DECLARE @CARCHIVEDDATE VARCHAR(15),@DARCHIVEDDATE DATETIME  ,@DATAFREEZE DATETIME
   
		 SET @DFREEZINGDATE=''  SET @DATAFREEZE =''
		 SELECT TOP 1 @CARCHIVEDDATE= VALUE FROM CONFIG WHERE CONFIG_OPTION='DATA_ARCHIVED_UPTO'  
		  
		    
		IF @CXNTYPE='SLS' 
		  BEGIN
		     SELECT TOP 1 @DATAFREEZE =FIXEDDATE FROM FIXEDFREEZE WHERE XN_TYPE='FRMSALE' 
		      IF ISNULL(@DATAFREEZE,'')<>''
		        BEGIN
		            
				 IF ISNULL(@CARCHIVEDDATE,'')<>'' 
					  BEGIN
						 SET @DFREEZINGDATE=(CASE WHEN CONVERT(DATE,@CARCHIVEDDATE)  > CONVERT(DATE,@DATAFREEZE) THEN
						 CONVERT(DATE,@CARCHIVEDDATE)  ELSE CONVERT(DATE,@DATAFREEZE) END)
					  END 
				  ELSE
					  SET @DFREEZINGDATE=CONVERT(DATE,@DATAFREEZE) 
		        END
		  END
		  
		  
		  IF @CXNTYPE='WSL' 
		  BEGIN
		     SELECT TOP 1 @DATAFREEZE =FIXEDDATE FROM FIXEDFREEZE WHERE XN_TYPE='FRMWSLINVOICE' 
		      IF ISNULL(@DATAFREEZE,'')<>''
		        BEGIN
		            
				 IF ISNULL(@CARCHIVEDDATE,'')<>'' 
					  BEGIN
						 SET @DFREEZINGDATE=(CASE WHEN CONVERT(DATE,@CARCHIVEDDATE)  > CONVERT(DATE,@DATAFREEZE) THEN
						 CONVERT(DATE,@CARCHIVEDDATE)  ELSE CONVERT(DATE,@DATAFREEZE) END)
					  END 
				  ELSE
					  SET @DFREEZINGDATE=CONVERT(DATE,@DATAFREEZE) 
		        END
		  END
		  
		  IF @CXNTYPE='PUR' 
		  BEGIN
		     SELECT TOP 1 @DATAFREEZE =FIXEDDATE FROM FIXEDFREEZE WHERE XN_TYPE='FRMTRANPURCHASEINVOICE' 
		      IF ISNULL(@DATAFREEZE,'')<>''
		        BEGIN
		            
				 IF ISNULL(@CARCHIVEDDATE,'')<>'' 
					  BEGIN
						 SET @DFREEZINGDATE=(CASE WHEN CONVERT(DATE,@CARCHIVEDDATE)  > CONVERT(DATE,@DATAFREEZE) THEN
						 CONVERT(DATE,@CARCHIVEDDATE)  ELSE CONVERT(DATE,@DATAFREEZE) END)
					  END 
				  ELSE
					  SET @DFREEZINGDATE=CONVERT(DATE,@DATAFREEZE) 
		        END
		  END
		  
	      IF @CXNTYPE='PRT' 
		  BEGIN
		     SELECT TOP 1 @DATAFREEZE =FIXEDDATE FROM FIXEDFREEZE WHERE XN_TYPE='FRMTRANPURCHASERETURN' 
		      IF ISNULL(@DATAFREEZE,'')<>''
		        BEGIN
		            
				 IF ISNULL(@CARCHIVEDDATE,'')<>'' 
					  BEGIN
						 SET @DFREEZINGDATE=(CASE WHEN CONVERT(DATE,@CARCHIVEDDATE)  > CONVERT(DATE,@DATAFREEZE) THEN
						 CONVERT(DATE,@CARCHIVEDDATE)  ELSE CONVERT(DATE,@DATAFREEZE) END)
					  END 
				  ELSE
					  SET @DFREEZINGDATE=CONVERT(DATE,@DATAFREEZE) 
		        END
		  END
		  
		  IF @CXNTYPE='WSR' 
		  BEGIN
		     SELECT TOP 1 @DATAFREEZE =FIXEDDATE FROM FIXEDFREEZE WHERE XN_TYPE='FRMWSCRNOTE' 
		      IF ISNULL(@DATAFREEZE,'')<>''
		        BEGIN
		            
				 IF ISNULL(@CARCHIVEDDATE,'')<>'' 
					  BEGIN
						 SET @DFREEZINGDATE=(CASE WHEN CONVERT(DATE,@CARCHIVEDDATE)  > CONVERT(DATE,@DATAFREEZE) THEN
						 CONVERT(DATE,@CARCHIVEDDATE)  ELSE CONVERT(DATE,@DATAFREEZE) END)
					  END 
				  ELSE
					  SET @DFREEZINGDATE=CONVERT(DATE,@DATAFREEZE) 
		        END
		  END
		  
	
  
  
END
