---EXEC SP_JOB_MATERIAL_PRINT  '0101120000000100000129'
CREATE PROCEDURE SP_JOB_MATERIAL_PRINT
(
	@CWHERE	NVARCHAR(100),
	@NPRINTWITHOUTJOBWORK INT=0
)
AS
BEGIN
	SET NOCOUNT ON 
	
	
	DECLARE @CJOBWORK_ISSUE_ID VARCHAR(50),@CBOM_ISSUE_NO VARCHAR(15),@DBOM_ISSUE_DT DATETIME,@ccancelled varchar(100)
	
	DECLARE @ADD VARCHAR(MAX)='',@REMARKS VARCHAR(MAX)='',@REF_NO VARCHAR(MAX)='',@AGENCY_NAME VARCHAR(MAX)='',@AGENCY_GST_NO VARCHAR(MAX)='',
	@EWAY_BILL_NO VARCHAR(100)='',@JWI_REF_NO VARCHAR(15)='',@TIME VARCHAR(100)
	SET @TIME='START= '+CONVERT(VARCHAR,GETDATE(),114)
	--RAISERROR(@TIME,0,1) WITH NOWAIT
	
	SELECT @CJOBWORK_ISSUE_ID=JOBWORK_ISSUE_ID  FROM BOM_ISSUE_MST WHERE issue_id =@CWHERE
	
	if ISNULL(@NPRINTWITHOUTJOBWORK,0)=1
	set @CJOBWORK_ISSUE_ID=''

	SELECT TOP 1 @ADD = ISNULL(LMV.ADDRESS0,'')
	+ISNULL(' '+LMV.ADDRESS1,'')
	+ISNULL(' '+LMV.ADDRESS2,'') 
	+ISNULL(' '+LMV.AREA_NAME,'')
	+ISNULL(' '+LMV.CITY,'')
	+ISNULL(' '+LMV.PINCODE,'')
	+ISNULL(' '+LMV.[STATE],'')
	+ISNULL(' ('+LMV.[COUNTRY_NAME]+')',''),@AGENCY_NAME = ISNULL(LMV.AC_NAME,''),
	@EWAY_BILL_NO = ISNULL(A.EWAY_BILL_NO,''),@REMARKS = ISNULL(A.REMARKS,''),
	@AGENCY_GST_NO = ISNULL(LMV.AC_GST_NO,''),@REF_NO = ISNULL(A.REF_NO,''),
	@CBOM_ISSUE_NO=A.ISSUE_NO , @JWI_REF_NO=RIGHT(A.JOBWORK_ISSUE_ID,10) ,
	@DBOM_ISSUE_DT=A.ISSUE_DT 
	FROM BOM_ISSUE_MST A WITH (NOLOCK)
	JOIN PRD_AGENCY_MST AG WITH (NOLOCK) ON AG.AGENCY_CODE=A.AGENCY_CODE
	JOIN LMV01106 LMV WITH (NOLOCK) ON LMV.AC_CODE=AG.AC_CODE
	WHERE A.ISSUE_ID=LTRIM(RTRIM(@CWHERE))


	    SELECT D.MEMO_ID ,D.MEMO_NO ,d.MEMO_DT  ,a.issue_id 
		   into #tmpjobcard
		FROM JOBWORK_ISSUE_DET A (nolock)
		JOIN ORD_PLAN_BARCODE_DET B (nolock) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
		JOIN ORD_PLAN_DET C (nolock) ON B.REFROW_ID =C.ROW_ID 
		JOIN ORD_PLAN_MST D (nolock) ON C.MEMO_ID =D.MEMO_ID 
		WHERE A.ISSUE_ID= @CJOBWORK_ISSUE_ID and d.CANCELLED=0
		group by D.MEMO_ID ,D.MEMO_NO ,d.MEMO_DT  ,a.issue_id

	
	SELECT 'BOM' AS XN_TYPE, B.ISSUE_NO AS MEMO_NO,B.ISSUE_DT AS MEMO_DT, B.ISSUE_ID,@EWAY_BILL_NO AS EWAY_BILL_NO,@REMARKS AS REMARKS,
	       @CBOM_ISSUE_NO AS ISSUE_NO,@REF_NO AS REF_NO,@JWI_REF_NO AS JWI_REF_NO,
	       @DBOM_ISSUE_DT AS ISSUE_DT,
	       B.JOBWORK_ISSUE_ID AS JOBWORK_ISSUE_ID,
	       ART.ARTICLE_NO,ART.ARTICLE_NAME,
	       SUM(A.QUANTITY) AS BOM_QTY,
	       SUM(A.STOCK_QTY ) AS QUANTITY,
	       SUM( CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN XN_VALUE_WITHOUT_GST ELSE 0 END) AS XN_VALUE_WITHOUT_GST,
	       A.HSN_CODE ,
		   CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN A.PURCHASE_PRICE ELSE 0 END  AS PURCHASE_PRICE,
	       CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN A.GST_PERCENTAGE ELSE 0 END  AS GST_PERCENTAGE,
	       SUM(CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN IGST_AMOUNT ELSE 0 END) AS IGST_AMOUNT,
	       SUM(CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN CGST_AMOUNT ELSE 0 END ) AS CGST_AMOUNT,
	       SUM(CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN SGST_AMOUNT ELSE 0 END) AS SGST_AMOUNT,
	       SUM(CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN XN_VALUE_WITH_GST ELSE 0 END) AS XN_VALUE_WITH_GST,
	       SD.SUB_SECTION_NAME,
	       SM.SECTION_NAME,
	       UM.UOM_NAME,P1.PARA1_NAME,P2.PARA2_NAME, 
	       @ADD AS AGENCY_ADDRESS,@AGENCY_NAME  AS AGENCY_NAME,@AGENCY_GST_NO AS AGENCY_GST_NO,
	       '' AS BUYER_REF_NO,
		   art.Material_print_without_value,MEMO_NO as Jobcard_NO,
		   MEMO_dt as Jobcard_dt,
		   CASE WHEN B.CANCELLED =1 THEN 'CANCELLED' ELSE  '' END  AS CANCELLED
	FROM BOM_ISSUE_MST b (NOLOCK)
	LEFT JOIN BOM_ISSUE_DET a (NOLOCK) ON A.ISSUE_ID =B.ISSUE_ID
	LEFT JOIN SKU (NOLOCK) ON A.PRODUCT_CODE =SKU.PRODUCT_CODE
	LEFT JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
	LEFT JOIN SECTIOND SD WITH (NOLOCK) ON SD.SUB_SECTION_CODE=ART.SUB_SECTION_CODE 
	LEFT JOIN SECTIONM SM WITH (NOLOCK) ON SD.SECTION_CODE=SM.SECTION_CODE
	LEFT JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=SKU.PARA1_CODE 
	LEFT JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=SKU.PARA2_CODE    
	LEFT JOIN UOM UM WITH (NOLOCK) ON UM.UOM_CODE=ART.UOM_CODE 
	join #tmpjobcard ord on ord.issue_id =b.JOBWORK_ISSUE_ID
	WHERE  ISNULL(ART.ARTICLE_NO,'')<>''
	---AND A.XN_VALUE_WITHOUT_GST <>0
	AND B.issue_id =@CWHERE
	GROUP BY B.ISSUE_NO,B.ISSUE_DT, B.ISSUE_ID ,
	B.JOBWORK_ISSUE_ID ,ART.ARTICLE_NO,ART.ARTICLE_NAME,A.GST_PERCENTAGE,
	SD.SUB_SECTION_NAME,SM.SECTION_NAME,UM.UOM_NAME,A.HSN_CODE,P1.PARA1_NAME,P2.PARA2_NAME,
	A.PURCHASE_PRICE,art.Material_print_without_value,MEMO_NO ,MEMO_dt,CASE WHEN B.CANCELLED =1 THEN 'CANCELLED' ELSE  '' END
	UNION ALL
	SELECT 'JWI' AS XN_TYPE, B.ISSUE_NO,B.ISSUE_DT, B.ISSUE_ID ,@EWAY_BILL_NO AS EWAY_BILL_NO,@REMARKS AS REMARKS,
	       @CBOM_ISSUE_NO AS ISSUE_NO,@REF_NO AS REF_NO,@JWI_REF_NO AS JWI_REF_NO,
	       @DBOM_ISSUE_DT AS ISSUE_DT,
	       B.ISSUE_ID AS JOBWORK_ISSUE_ID,
	       ART.ARTICLE_NO,ART.ARTICLE_NAME,
	       0 AS BOM_QTY,
	       SUM(A.QUANTITY) AS QUANTITY,
	       SUM(XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST,
	       A.HSN_CODE,A.PURCHASE_PRICE,
	       CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN A.GST_PERCENTAGE ELSE 0 END  AS GST_PERCENTAGE,
	       SUM(IGST_AMOUNT) AS IGST_AMOUNT,
	       SUM(CGST_AMOUNT) AS CGST_AMOUNT,
	       SUM(SGST_AMOUNT) AS SGST_AMOUNT,
	       SUM(XN_VALUE_WITH_GST) AS XN_VALUE_WITH_GST,
	       SD.SUB_SECTION_NAME,
	       SM.SECTION_NAME,
	       UM.UOM_NAME,P1.PARA1_NAME,P2.PARA2_NAME, 
	       @ADD AS AGENCY_ADDRESS,@AGENCY_NAME  AS AGENCY_NAME,@AGENCY_GST_NO AS AGENCY_GST_NO,
	       ISNULL(REF.REF_NO,'') AS BUYER_REF_NO,
		   art.Material_print_without_value,
		   ORD.MEMO_NO AS Jobcard_NO,
		   ORD.MEMO_DT  AS Jobcard_DT,
		   CASE WHEN B.CANCELLED =1 THEN 'CANCELLED' ELSE  '' END  AS CANCELLED
	FROM JOBWORK_ISSUE_DET A (NOLOCK)
	JOIN JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID =B.ISSUE_ID
	JOIN SKU (NOLOCK) ON A.PRODUCT_CODE =SKU.PRODUCT_CODE
	JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
	JOIN SECTIOND SD WITH (NOLOCK) ON SD.SUB_SECTION_CODE=ART.SUB_SECTION_CODE 
	JOIN SECTIONM SM WITH (NOLOCK) ON SD.SECTION_CODE=SM.SECTION_CODE
	JOIN UOM UM WITH (NOLOCK) ON UM.UOM_CODE=ART.UOM_CODE
	JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=SKU.PARA1_CODE 
	JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=SKU.PARA2_CODE    
	LEFT JOIN VW_BUYER_REF_NO REF WITH (NOLOCK) ON REF.PRODUCT_CODE=A.PRODUCT_CODE 
	join #tmpjobcard ord on ord.issue_id =b.issue_id
	WHERE B.CANCELLED=0 
	AND A.XN_VALUE_WITHOUT_GST <>0
	AND B.ISSUE_ID=@CJOBWORK_ISSUE_ID
	GROUP BY B.ISSUE_NO,B.ISSUE_DT, B.ISSUE_ID 
	,ART.ARTICLE_NO,ART.ARTICLE_NAME,A.GST_PERCENTAGE,A.HSN_CODE,A.PURCHASE_PRICE,
	SD.SUB_SECTION_NAME,SM.SECTION_NAME,UM.UOM_NAME,P1.PARA1_NAME,P2.PARA2_NAME,
	ISNULL(REF.REF_NO,''),art.Material_print_without_value,ORD.MEMO_NO ,ORD.MEMO_DT ,
	CASE WHEN B.CANCELLED =1 THEN 'CANCELLED' ELSE  '' END
	
	
;WITH CTE AS
  (
   SELECT 'JWI' AS XN_TYPE, A.ISSUE_ID , A.PRODUCT_CODE ,A.QUANTITY,A.HSN_CODE ,A.GST_PERCENTAGE ,
   A.XN_VALUE_WITHOUT_GST ,
   A.XN_VALUE_WITH_GST ,
   A.IGST_AMOUNT ,A.CGST_AMOUNT ,A.SGST_AMOUNT  
   FROM JOBWORK_ISSUE_DET A (NOLOCK)
   JOIN JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID =B.ISSUE_ID 
   WHERE B.CANCELLED =0
   AND A.ISSUE_ID=@CJOBWORK_ISSUE_ID
   AND A.XN_VALUE_WITHOUT_GST <>0  
   UNION ALL
   SELECT 'BOM' AS XN_TYPE, JOBWORK_ISSUE_ID , A.PRODUCT_CODE ,A.STOCK_QTY,A.HSN_CODE ,
   A.GST_PERCENTAGE ,
   CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN A.XN_VALUE_WITHOUT_GST ELSE 0 END AS  Material_print_without_value,
   CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN  A.XN_VALUE_WITH_GST ELSE 0 END AS  XN_VALUE_WITH_GST ,
   CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN A.IGST_AMOUNT ELSE 0 END IGST_AMOUNT,
   CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN A.CGST_AMOUNT ELSE 0 END CGST_AMOUNT,
   CASE WHEN  ISNULL(art.Material_print_without_value,0)=0 THEN A.SGST_AMOUNT ELSE 0 END SGST_AMOUNT
   FROM BOM_ISSUE_DET A  (NOLOCK)
   JOIN BOM_ISSUE_MST B (NOLOCK)  ON A.ISSUE_ID=B.ISSUE_ID 
   JOIN SKU (NOLOCK) ON A.PRODUCT_CODE =SKU.PRODUCT_CODE
   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
   WHERE  B.ISSUE_ID=@CWHERE
  )
  
  SELECT A.XN_TYPE , C.ARTICLE_NO,A.HSN_CODE ,A.GST_PERCENTAGE ,
          SUM(ISNULL(A.XN_VALUE_WITHOUT_GST,0)) AS XN_VALUE_WITHOUT_GST,
          SUM(ISNULL(A.XN_VALUE_WITH_GST,0)) AS XN_VALUE_WITH_GST,
          SUM(ISNULL(A.IGST_AMOUNT,0)) AS IGST_AMOUNT,
          SUM(ISNULL(A.CGST_AMOUNT,0)) AS CGST_AMOUNT,
          SUM(ISNULL(A.SGST_AMOUNT,0)) AS SGST_AMOUNT,
		  sum(ISNULL(A.QUANTITY,0)) AS QUANTITY_HSN
  FROM CTE A 
  JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
  JOIN ARTICLE C (NOLOCK) ON B.ARTICLE_CODE=C.ARTICLE_CODE 
  GROUP BY A.XN_TYPE ,C.ARTICLE_NO,A.HSN_CODE ,A.GST_PERCENTAGE

	
END



