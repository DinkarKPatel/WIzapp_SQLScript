create PROCEDURE SP3S_VALIDATE_SERVERLOCSTOCK_PRT
(
   @CXNID VARCHAR(50),
   @CERRORMSG VARCHAR(MAX)  OUTPUT,
   @NUPDATEMODE int =0
)
AS
BEGIN

               DECLARE @CSOURCESERVERLOC BIT,@CTARGETSERVERLOC BIT,@NINVMODE INT

			   SELECT @CSOURCESERVERLOC=L.SERVER_LOC ,@CTARGETSERVERLOC=L1.SERVER_LOC
			   FROM rmm01106 A (NOLOCK)
			   JOIN LOCATION L (NOLOCK) ON L.DEPT_ID =A.location_Code 
			   JOIN LOCATION L1 (NOLOCK) ON L1.DEPT_ID =PARTY_DEPT_ID
			   WHERE RM_ID =@CXNID AND A.MODE =2
		       


				 IF ISNULL(@CSOURCESERVERLOC,0)=1 AND   ISNULL(@CTARGETSERVERLOC,0)=1 
				 AND  EXISTS (SELECT TOP 1'U' FROM CNM01106 (NOLOCK) WHERE RM_ID=@CXNID AND RECEIPT_DT <>'')
				 BEGIN
				      
					  
					IF EXISTS (SELECT TOP 1 'U'  FROM CNM01106  WHERE RM_ID =@CXNID  AND CANCELLED=0 AND ISNULL(IRN_QR_CODE,'')<>''   )
					BEGIN
	     					SELECT @CERRORMSG='IRN_QR_CODE has been Generated.You cannot change it.'
							 RETURN
					END

		    
					 SELECT A.DEPT_ID,A.BIN_ID , A.PRODUCT_CODE ,SUM(A.CHI_QTY ) AS CHI_QTY
					 INTO #TMPSTOCK
					 FROM 
					 (
						 SELECT B.BILLED_FROM_DEPT_ID AS DEPT_ID, B.BIN_ID , A.PRODUCT_CODE ,SUM(A.QUANTITY)*-1 AS CHI_QTY 
						 FROM cnd01106 A (NOLOCK)
						 JOIN cnm01106 B (NOLOCK) ON A.CN_ID  =B.CN_ID 
						 WHERE B.CANCELLED =0 
						 AND B.RM_ID  =@CXNID and b.receipt_dt <>''
						 GROUP BY B.BILLED_FROM_DEPT_ID, B.BIN_ID , A.PRODUCT_CODE
						 UNION ALL
						 SELECT B.PARTY_DEPT_ID,  B.TARGET_BIN_ID, A.PRODUCT_CODE ,SUM(A.QUANTITY) AS CHI_QTY 
						 FROM rmd01106 A (NOLOCK)
						 JOIN rmm01106 B (NOLOCK) ON A.RM_ID =B.RM_ID 
						 WHERE B.CANCELLED =0 
						 AND B.RM_ID =@CXNID 
						 GROUP BY B.PARTY_DEPT_ID,  B.TARGET_BIN_ID, A.PRODUCT_CODE
					) A
				   GROUP BY A.DEPT_ID,A.BIN_ID , A.PRODUCT_CODE 



				  IF EXISTS (SELECT TOP 1 'U'  FROM   #TMPSTOCK A
				   LEFT JOIN  PMT01106 B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE AND A.DEPT_ID =B.DEPT_ID AND A.BIN_ID =B.BIN_ID 
				   WHERE ISNULL(CHI_QTY,0)+ISNULL(B.QUANTITY_IN_STOCK,0)<0
				   )
				   BEGIN
				       
					   	SET @CERRORMSG = 'ITEM HAS BEEN SOLD AT TARGET LOCATION CAN NOT EDIT' 
						RETURN

				   END


				   
				   if @NUPDATEMODE=3
				   begin
				        
					   UPDATE  B SET QUANTITY_IN_STOCK =ISNULL(CHI_QTY,0)+ISNULL(B.QUANTITY_IN_STOCK,0)
					   FROM   #TMPSTOCK A
				       JOIN  PMT01106 B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE AND A.DEPT_ID =B.DEPT_ID AND A.BIN_ID =B.BIN_ID 
					   
					   IF EXISTS (SELECT TOP 1 rm_id FROM cnm01106  A (NOLOCK) WHERE rm_id =@CXNID AND CANCELLED =0)
					      UPDATE A SET CANCELLED =1 FROM cnm01106 A (NOLOCK) WHERE rm_id =@CXNID AND CANCELLED =0

					  IF EXISTS (SELECT TOP 1 rm_id FROM DOCPRT_RMM01106_MIRROR A (NOLOCK) WHERE rm_id =@CXNID )
					  BEGIN

					      DELETE A FROM DOCPRT_RMM01106_MIRROR A (NOLOCK) WHERE rm_id =@CXNID 
						  DELETE A FROM DOCPRT_RMM01106_MIRROR A (NOLOCK) WHERE rm_id =@CXNID 

					  END


				   end

			 END


END