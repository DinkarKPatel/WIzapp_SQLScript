CREATE PROCEDURE SPSLS_PRINT_PRG
@NSPID NUMERIC(5,0),
@CMEMOID NVARCHAR(50),
@NMODE INT,
@CLOCID VARCHAR(5),
@BCASHIER BIT=0,
@CRETVAL	NVARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN

DECLARE  @CREPFILEPATH NVARCHAR(MAX),@CT NVARCHAR(MAX) ,@CTCOMP NVARCHAR(MAX) ,@CTPAY NVARCHAR(MAX) ,@CPAYXNDT NVARCHAR(MAX) ,
@CPACSLIPMST VARCHAR(MAX),@CPRINTDETAILS VARCHAR(MAX),@CEXPR NVARCHAR(MAX) ,@BMULTILOCPRINT BIT,@NSTEP INT
,@CDSD VARCHAR(MAX),@CDSM VARCHAR(MAX),@BCUSTOMPRINTING BIT,@CSPID NVARCHAR(50)

BEGIN TRY
	

	SET @NSTEP=5
	
	SET @BCUSTOMPRINTING = 0
	
	IF EXISTS (SELECT TOP 1 TABLE_NAME FROM DYNAMICPRINT_COLS (NOLOCK))
		SET @BCUSTOMPRINTING=1

	SET @CSPID=LTRIM(RTRIM((STR(@NSPID))))
				
	SET @CT = 'MASTER..[TEMP_SLS_' + @CSPID+']'
	SET @CTCOMP = 'MASTER..[TEMP_COMPANY_' +@CSPID+']'
	SET @CTPAY= '[TEMP_PAYSLS_' + @CSPID+']'
	SET @CPAYXNDT= N'MASTER..[TEMP_PAYXNSLS_' + @CSPID+']'
	SET @CPACSLIPMST= N'MASTER..[TEMP_RPSSLS_' + @CSPID+']'
	SET @CPRINTDETAILS= N'MASTER..[TEMP_PRINTSLS_' + @CSPID+']'
	SET @CDSM= N'MASTER..[TEMP_PRINTDSM_' + @CSPID+']'
	SET @CRETVAL=''



	SET @NSTEP=10
	SET @CEXPR = N'IF OBJECT_ID(''' + @CPRINTDETAILS + ''',''U'') IS NOT NULL 
					SELECT @CREFAPPMEMOIDOUT=REP_PATH FROM '+ @CPRINTDETAILS
	PRINT @CEXPR				
	EXEC SP_EXECUTESQL @CEXPR ,N'@CREFAPPMEMOIDOUT NVARCHAR(MAX) OUTPUT',@CREFAPPMEMOIDOUT=@CREPFILEPATH OUTPUT
	
	IF ISNULL(@CREPFILEPATH,'')='' 
		RETURN

	IF @BCUSTOMPRINTING=1
	BEGIN
		EXEC SP3S_MEMOPRINT_DYNAMIC 'SLS',@CMEMOID,@NSPID
		GOTO LBLINSPRINTMGR
	END
		
	
	IF OBJECT_ID('TEMPDB..#CMIDS','U') IS NOT NULL
		DROP TABLE #CMIDS
		
	CREATE TABLE #CMIDS(CM_ID VARCHAR(22))
	
	IF @BCASHIER=1
		INSERT #CMIDS(CM_ID)
		SELECT CM_ID FROM DSD01106(NOLOCK) WHERE DS_ID=@CMEMOID
	ELSE 
		INSERT #CMIDS(CM_ID)
		SELECT @CMEMOID
	
	
	SET @CEXPR = N'IF OBJECT_ID(''' + @CT + ''',''U'') IS NOT NULL DROP TABLE ' + @CT
	PRINT '@NSTEP=10 : ' + @CEXPR
	EXEC SP_EXECUTESQL @CEXPR
	
	SET @NSTEP=15
	SET @CEXPR = N'IF OBJECT_ID(''' + @CDSM + ''',''U'') IS NOT NULL DROP TABLE ' + @CDSM
	PRINT '@NSTEP=10 : ' + @CEXPR
	EXEC SP_EXECUTESQL @CEXPR
	
	SET @NSTEP=20
	SET @CEXPR = N'IF OBJECT_ID(''' + @CTCOMP + ''',''U'') IS NOT NULL DROP TABLE ' + @CTCOMP
	PRINT '@NSTEP=20 : ' + @CEXPR
	EXEC SP_EXECUTESQL @CEXPR
	
	SET @NSTEP=25
	IF @BCASHIER=1
	BEGIN
		PRINT '@NSTEP=25 : SP_PAY  ' 
		SET @CEXPR='SELECT DSM.DS_NO,DSM.DS_ID,DSM.CANCELLED,DSM.DS_DT,DSD.ROW_ID,DSD.CM_ID 
					INTO '+@CDSM+' FROM DSM01106 DSM 
					JOIN DSD01106 DSD ON DSM.DS_ID=DSD.DS_ID 
					WHERE DSM.DS_ID='''+@CMEMOID+''''
		PRINT '@NSTEP=25 : ' + @CEXPR
		EXEC SP_EXECUTESQL @CEXPR  			
	END
	
	SET @NSTEP=30
	PRINT '@NSTEP=30 : SP_PAY  ' 
	EXEC SP_PAY  @CMEMOID , 'SLS',@CTPAY,@BCASHIER
	
	SET @NSTEP=40
	PRINT '@NSTEP=40 : SP_SLSMST_QBF ' 
	EXEC SP_SLSMST_QBF @CMEMOID,@CTPAY,@CT,@BCASHIER

	SET @NSTEP=50
	SET @CEXPR = N'IF OBJECT_ID(''' + @CPAYXNDT + ''',''U'') IS NOT NULL DROP TABLE ' + @CPAYXNDT;
	PRINT '@NSTEP=50 : ' + @CEXPR
	EXEC SP_EXECUTESQL @CEXPR

	SET @NSTEP=60
	SET @CEXPR = N'SELECT	A.MEMO_ID,B.PAYMODE_NAME ,REF_NO,REMARKS,A.CURRENCY_CONVERSION_RATE, SUM(AMOUNT) AS AMOUNT 
	INTO ' + @CPAYXNDT + ' FROM PAYMODE_XN_DET A (NOLOCK) 
	JOIN PAYMODE_MST	B (NOLOCK) ON A.PAYMODE_CODE = B.PAYMODE_CODE 
	JOIN #CMIDS CMS ON A.MEMO_ID=CMS.CM_ID
	WHERE  A.XN_TYPE= ''SLS'' 
	GROUP BY A.MEMO_ID,B.PAYMODE_NAME ,REF_NO,REMARKS,A.CURRENCY_CONVERSION_RATE 
	ORDER BY A.MEMO_ID,B.PAYMODE_NAME ,REF_NO,REMARKS,A.CURRENCY_CONVERSION_RATE '
	
	PRINT '@NSTEP=60 : ' + @CEXPR
	EXEC SP_EXECUTESQL @CEXPR            

	SET @NSTEP=70
	PRINT '@NSTEP=70 : ' 
	SELECT @BMULTILOCPRINT= ISNULL(SERVER_LOC,0) FROM LOCATION  (NOLOCK) WHERE DEPT_ID=@CLOCID

	SET @NSTEP=80
	IF @BMULTILOCPRINT=1
		SET @CEXPR = N'SELECT * INTO ' + @CTCOMP + ' FROM LOCATION  WHERE DEPT_ID = ''' + @CLOCID + ''''
	ELSE
		SET @CEXPR=N'SELECT * INTO ' + @CTCOMP + ' FROM COMPANY  WHERE COMPANY_NAME <> '''''
	PRINT '@NSTEP=80 : ' + @CEXPR
	SET @NSTEP=90
	EXEC SP_EXECUTESQL @CEXPR

	SET @NSTEP=100
	SET @CEXPR = N'IF OBJECT_ID(''' + @CPACSLIPMST + ''',''U'') IS NOT NULL DROP TABLE ' + @CPACSLIPMST
	PRINT '@NSTEP=100 : ' + @CEXPR
	EXEC SP_EXECUTESQL @CEXPR
	
	SET @NSTEP=110
	
	IF @BCASHIER=0
	BEGIN
		PRINT '@NSTEP=110 : SP_RPSMST_QBF'
		EXEC SP_RPSMST_QBF @CMEMOID ,@CPACSLIPMST ,1
	END

LBLINSPRINTMGR:		

	SET @NSTEP=130
	INSERT PRINTMGR( SP_ID, FORMAT_FILENAME, MEMO_ID, DOC_TYPE,MODE ) 
	VALUES (@CSPID, @CREPFILEPATH,@CMEMOID, 'SLS',@NMODE)
	
	UPDATE CMM01106 SET COPIES_PTD=COPIES_PTD+1 WHERE CM_ID=@CMEMOID
END TRY

BEGIN CATCH
	PRINT 'CATCH OF SLSPRINT_PRG'
	SET @CRETVAL= 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()  
END CATCH	
	
	
	PRINT 'LAST STEP OF SLSPRINT_PRG:'
END
