CREATE FUNCTION FN_JOBNAME
(
 @CPRODUCT_CODE VARCHAR(100)='',
 @CJOB_ORDER INT=0
)
RETURNS @TBLBILLNO TABLE (JOB_CODE VARCHAR(10),JOB_NAME VARCHAR(100),JOB_ORDER INT)	
AS
BEGIN
    
    INSERT INTO @TBLBILLNO(JOB_CODE,JOB_NAME,JOB_ORDER)
    SELECT DET.JOB_CODE,DET.JOB_NAME,DET.JOB_ORDER
	FROM PPC_FGBCG_MST A
	JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
	JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
	JOIN
	(
	 SELECT  JOBS.JOB_NAME,C.JOB_CODE,C.JOB_ORDER,
	 A.ROW_ID FROM PPC_BUYER_ORDER_DET A
	 JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
	 JOIN PPC_BO_ART_JOBS C ON A.ROW_ID=C.REF_ROW_ID
	 JOIN JOBS ON JOBS.JOB_CODE=C.JOB_CODE
	 WHERE B.CANCELLED=0
	 GROUP BY JOBS.JOB_NAME,C.JOB_CODE,C.JOB_ORDER,A.ROW_ID 
	 ) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
	  WHERE SKU.PRODUCT_CODE=@CPRODUCT_CODE 
	  AND (@CJOB_ORDER=0 OR DET.JOB_ORDER=@CJOB_ORDER)
	 ORDER BY JOB_ORDER

 RETURN 
END
