create PROCEDURE SP3S_REP_GST_HSN_SUMMARY
(
  @DFMDATE DATETIME,
  @DTODATE DATETIME,
  @CDEPT_ID VARCHAR(5)='',
  @CGSTN_NO VARCHAR(100)=''
)
AS
BEGIN
    
     --****** 1 RETAIL SALE **********  
      
      IF OBJECT_ID('TEMPDB..#TMCMID','U') IS NOT NULL
         DROP TABLE #TMCMID
      
      
      SELECT DISTINCT A.CM_ID INTO #TMCMID FROM 
      CMM01106  (NOLOCK) A 
      JOIN CMD01106  (NOLOCK) B ON A.CM_ID=B.CM_ID
      WHERE B.QUANTITY >0 AND A.CANCELLED =0
      AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      
      
        IF OBJECT_ID('TEMPDB..#TMCMID1','U') IS NOT NULL
         DROP TABLE #TMCMID1
      
      
      SELECT DISTINCT A.CM_ID INTO #TMCMID1 FROM 
      CMM01106  (NOLOCK) A 
      JOIN CMD01106  (NOLOCK) B ON A.CM_ID=B.CM_ID
      WHERE B.QUANTITY <0 AND A.CANCELLED =0
      AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      
       IF OBJECT_ID('TEMPDB..#TMCMID1OTH','U') IS NOT NULL
         DROP TABLE #TMCMID1OTH
         
      
      SELECT A.CM_ID INTO #TMCMID1OTH FROM #TMCMID1 A
      LEFT OUTER JOIN #TMCMID B ON A.CM_ID =B.CM_ID 
      WHERE B.CM_ID IS NULL


      IF OBJECT_ID('TEMPDB..#TMPSUMMARY','U') IS NOT NULL
         DROP TABLE #TMPSUMMARY
         
      SELECT 1 AS SR ,0 AS GST_TYPE,CAST('SLS' AS VARCHAR(10)) AS XN_TYPE, CAST('RETAIL SALE' AS VARCHAR(100)) AS DETAILS, 
           A.CM_ID AS MEMO_ID,
           CAST(A.CM_NO AS VARCHAR(100)) AS MEMO_NO,
           A.CM_DT AS MEMO_DT,
           A.ROUND_OFF ,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code  AS DEPT_ID,
           B.DEPT_NAME ,
           A.OTHER_CHARGES_HSN_CODE AS HSN_CODE,
           ISNULL(A.ATD_CHARGES,0)+ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) AS XN_VALUE_WITH_GST,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) <>0 THEN A.ATD_CHARGES ELSE 0 END IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) <>0 THEN ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0) ELSE 0 END AS IGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) <>0 THEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) <>0 THEN A.ATD_CHARGES ELSE 0 END CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) <>0 THEN ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0) ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) <>0 THEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) ELSE 0 END CGST_AMOUNT ,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=0 THEN A.ATD_CHARGES ELSE 0 END SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=0 THEN ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0) ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=0 THEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END SGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=1 THEN A.ATD_CHARGES ELSE 0 END UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=1 THEN ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0) ELSE 0 END AS UTGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=1 THEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END UTGST_AMOUNT,
           0 AS VAT_AMOUNT
      INTO #TMPSUMMARY
      FROM CMM01106 A (NOLOCK)
      JOIN #TMCMID TMP ON A.CM_ID =TMP.CM_ID 
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code 
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code =@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
      UNION ALL
      SELECT 1 AS SR ,0 AS GST_TYPE,'SLS' AS XN_TYPE, 'RETAIL SALE' AS DETAILS, 
           A.CM_ID ,
           A.CM_NO AS MEMO_NO,
           A.CM_DT AS MEMO_DT,
           0 AS ROUND_OFF,
           C.LOC_GST_NO AS GSTN_ID,
          A.location_Code AS DEPT_ID,
           C.DEPT_NAME ,
           B.HSN_CODE  AS HSN_CODE,
           SUM(ISNULL(B.XN_VALUE_WITH_GST,0)) AS XN_VALUE_WITH_GST,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)<>0 THEN ISNULL(B.XN_VALUE_WITHOUT_GST ,0) ELSE 0 END) AS IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(IGST_AMOUNT,0) <>0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS IGST_RATE,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)<>0 THEN ISNULL(B.IGST_AMOUNT ,0) ELSE 0 END)  AS IGST_AMOUNT,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)<>0 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(CGST_AMOUNT,0) <>0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS CGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)<>0 THEN ISNULL(B.CGST_AMOUNT ,0) ELSE 0 END)  AS CGST_AMOUNT,
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)<>0  AND ISNULL(D.UT,0)=0  THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) <>0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS SGST_RATE,
           SUM(CASE WHEN  ISNULL(SGST_AMOUNT,0)<>0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS SGST_AMOUNT,
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)<>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) <>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS UTGST_RATE,
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)<>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS UTGST_AMOUNT,
           SUM(B.TAX_AMOUNT) AS VAT_AMOUNT 
      FROM CMM01106 A (NOLOCK) 
      JOIN #TMCMID TMP ON A.CM_ID =TMP.CM_ID 
      JOIN CMD01106 B (NOLOCK)  ON A.CM_ID =B.CM_ID
      JOIN LOCATION C (NOLOCK) ON C.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST D (NOLOCK)  ON C.GST_STATE_CODE =D.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR C.LOC_GST_NO=@CGSTN_NO)
      AND B.QUANTITY>0
      AND ISNULL(A.MEMO_TYPE,0)=1
       AND ISNULL(B.GST_PERCENTAGE,0)>0
      GROUP BY A.CM_ID , A.CM_NO ,
      A.CM_DT, B.HSN_CODE,
      C.LOC_GST_NO,
      LEFT (A.CM_ID,2),C.DEPT_NAME,
      CASE WHEN ISNULL(IGST_AMOUNT,0) <>0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(CGST_AMOUNT,0) <>0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) <>0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) <>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END
      
      
     
      --***WHOSALE***
      
    
      INSERT INTO #TMPSUMMARY(SR,GST_TYPE,XN_TYPE,DETAILS,MEMO_ID,MEMO_NO ,MEMO_DT ,ROUND_OFF   ,GSTN_ID,DEPT_ID,DEPT_NAME,HSN_CODE,XN_VALUE_WITH_GST,
                              IGST_TAXABLE_VALUE,IGST_RATE,IGST_AMOUNT,CGST_TAXABLE_VALUE,CGST_RATE,CGST_AMOUNT,
                              SGST_TAXABLE_VALUE,SGST_RATE,SGST_AMOUNT,UTGST_TAXABLE_VALUE,UTGST_RATE,UTGST_AMOUNT)
      SELECT 2 AS SR ,0 AS GST_TYPE,'WSL' AS XN_TYPE, 'WHOLESALE' AS DETAILS, 
           A.INV_ID ,
           A.INV_NO ,
           A.INV_DT ,
           A.ROUND_OFF   AS ROUND_OFF,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.OTHER_CHARGES_HSN_CODE AS  HSN_CODE,
           ISNULL(A.OTHER_CHARGES,0)+ ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES ELSE 0 END AS IGST_TAXABLE_VALUE,  
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS IGST_RATE,     
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES ELSE 0 END  CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0) ELSE 0 END AS CGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.OTHER_CHARGES ELSE 0 END  AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END  AS SGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.OTHER_CHARGES ELSE 0 END AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.OTHER_CHARGES_GST_PERCENTAGE   ELSE 0 END AS UTGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END  AS UTGST_AMOUNT
              
      FROM INM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0)>0
      UNION ALL
       SELECT 2 AS SR ,0 AS GST_TYPE,'WSL' AS XN_TYPE, 'WHOLESALE' AS DETAILS, 
           A.INV_ID ,
           A.INV_NO ,
           A.INV_DT ,
           0  AS ROUND_OFF,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.FREIGHT_HSN_CODE ,
           ISNULL(A.FREIGHT,0)+ ISNULL(A.FREIGHT_IGST_AMOUNT,0)+ISNULL(A.FREIGHT_CGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0) AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN A.FREIGHT ELSE 0 END AS IGST_TAXABLE_VALUE,  
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS IGST_RATE,     
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN ISNULL(A.FREIGHT_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN A.FREIGHT ELSE 0 END  CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN ISNULL(A.FREIGHT_CGST_AMOUNT,0) ELSE 0 END AS CGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.FREIGHT ELSE 0 END  AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.FREIGHT_SGST_AMOUNT,0) ELSE 0 END  AS SGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.FREIGHT ELSE 0 END AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.FREIGHT_GST_PERCENTAGE   ELSE 0 END AS UTGST_RATE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.FREIGHT_SGST_AMOUNT,0) ELSE 0 END  AS UTGST_AMOUNT
              
      FROM INM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.FREIGHT_GST_PERCENTAGE,0)>0
       UNION ALL
       SELECT 2 AS SR ,0 AS GST_TYPE,'WSL' AS XN_TYPE, 'WHOLESALE' AS DETAILS, 
           A.INV_ID ,
           A.INV_NO ,
           A.INV_DT ,
           0  AS ROUND_OFF,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.INSURANCE_HSN_CODE ,
           ISNULL(A.INSURANCE,0)+ ISNULL(A.INSURANCE_IGST_AMOUNT,0)+ISNULL(A.INSURANCE_CGST_AMOUNT,0)+ISNULL(A.INSURANCE_SGST_AMOUNT,0) AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(INSURANCE_IGST_AMOUNT,0) >0 THEN A.INSURANCE ELSE 0 END AS IGST_TAXABLE_VALUE,  
           CASE WHEN ISNULL(INSURANCE_IGST_AMOUNT,0) >0 THEN A.INSURANCE_GST_PERCENTAGE  ELSE 0 END AS IGST_RATE,     
           CASE WHEN ISNULL(INSURANCE_IGST_AMOUNT,0) >0 THEN ISNULL(A.INSURANCE_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(INSURANCE_CGST_AMOUNT,0) >0 THEN A.INSURANCE ELSE 0 END  CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(INSURANCE_CGST_AMOUNT,0) >0 THEN A.INSURANCE_GST_PERCENTAGE  ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(INSURANCE_CGST_AMOUNT,0) >0 THEN ISNULL(A.INSURANCE_CGST_AMOUNT,0) ELSE 0 END AS CGST_AMOUNT,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.INSURANCE ELSE 0 END  AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.INSURANCE_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.INSURANCE_SGST_AMOUNT,0) ELSE 0 END  AS SGST_AMOUNT,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.INSURANCE ELSE 0 END AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.INSURANCE_GST_PERCENTAGE   ELSE 0 END AS UTGST_RATE,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.INSURANCE_SGST_AMOUNT,0) ELSE 0 END  AS UTGST_AMOUNT
              
      FROM INM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.INSURANCE_GST_PERCENTAGE,0)>0
      UNION ALL
       SELECT 2 AS SR ,0 AS GST_TYPE,'WSL' AS XN_TYPE, 'WHOLESALE' AS DETAILS, 
           A.INV_ID ,
           A.INV_NO ,
           A.INV_DT ,
           0  AS ROUND_OFF,
           B.LOC_GST_NO AS GSTN_ID,
          A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.PACKING_HSN_CODE ,
           ISNULL(A.PACKING,0)+ ISNULL(A.PACKING_IGST_AMOUNT,0)+ISNULL(A.PACKING_CGST_AMOUNT,0)+ISNULL(A.PACKING_SGST_AMOUNT,0) AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(PACKING_IGST_AMOUNT,0) >0 THEN A.PACKING ELSE 0 END AS IGST_TAXABLE_VALUE,  
           CASE WHEN ISNULL(PACKING_IGST_AMOUNT,0) >0 THEN A.PACKING_GST_PERCENTAGE  ELSE 0 END AS IGST_RATE,     
           CASE WHEN ISNULL(PACKING_IGST_AMOUNT,0) >0 THEN ISNULL(A.PACKING_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(PACKING_CGST_AMOUNT,0) >0 THEN A.PACKING ELSE 0 END  CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(PACKING_CGST_AMOUNT,0) >0 THEN A.PACKING_GST_PERCENTAGE  ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(PACKING_CGST_AMOUNT,0) >0 THEN ISNULL(A.PACKING_CGST_AMOUNT,0) ELSE 0 END AS CGST_AMOUNT,
           CASE WHEN ISNULL(PACKING_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.PACKING ELSE 0 END  AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(PACKING_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.PACKING_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(PACKING_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.PACKING_SGST_AMOUNT,0) ELSE 0 END  AS SGST_AMOUNT,
           CASE WHEN ISNULL(PACKING_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.PACKING ELSE 0 END AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(PACKING_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.PACKING_GST_PERCENTAGE   ELSE 0 END AS UTGST_RATE,
           CASE WHEN ISNULL(PACKING_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.PACKING_SGST_AMOUNT,0) ELSE 0 END  AS UTGST_AMOUNT
              
      FROM INM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.PACKING_GST_PERCENTAGE,0)>0
     UNION ALL
     SELECT 2 AS SR ,0 AS GST_TYPE,'WSL' AS XN_TYPE, 'WHOLESALE' AS DETAILS, 
           A.INV_ID ,
           A.INV_NO ,
           A.INV_DT ,
           0 AS ROUND_OFF,
           C.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           C.DEPT_NAME ,
           B.HSN_CODE ,
           SUM(ISNULL(B.XN_VALUE_WITH_GST,0)) AS XN_VALUE_WITH_GST,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)>0 THEN ISNULL(B.XN_VALUE_WITHOUT_GST ,0) ELSE 0 END) AS IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS IGST_RATE,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.IGST_AMOUNT,0) ELSE 0 END) IGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)>0 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS CGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.CGST_AMOUNT,0) ELSE 0 END) CGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)>0  AND ISNULL(D.UT,0)=0  THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS SGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0  AND  ISNULL(D.UT,0)=0 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS SGST_AMOUNT,
           SUM(CASE WHEN  ISNULL(SGST_AMOUNT,0)>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS UTGST_RATE,
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS UTGST_AMOUNT
            
      FROM INM01106 A (NOLOCK) 
      JOIN IND01106 B (NOLOCK)  ON A.INV_ID =B.INV_ID
      JOIN LOCATION C (NOLOCK) ON C.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST D (NOLOCK)  ON C.GST_STATE_CODE =D.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.INV_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR C.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(B.GST_PERCENTAGE,0)>0
      GROUP BY A.INV_ID ,  A.INV_NO ,
      A.INV_DT,C.LOC_GST_NO,
      a.location_Code ,C.DEPT_NAME,B.HSN_CODE ,
      CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END
      
  --END OF WHOSALE****
  
   INSERT INTO #TMPSUMMARY(SR,GST_TYPE,XN_TYPE,DETAILS,MEMO_ID,MEMO_NO ,MEMO_DT ,ROUND_OFF ,GSTN_ID,DEPT_ID,DEPT_NAME,HSN_CODE,XN_VALUE_WITH_GST,
                              IGST_TAXABLE_VALUE,IGST_RATE,IGST_AMOUNT,CGST_TAXABLE_VALUE,CGST_RATE,CGST_AMOUNT,
                              SGST_TAXABLE_VALUE,SGST_RATE,SGST_AMOUNT,UTGST_TAXABLE_VALUE,UTGST_RATE,UTGST_AMOUNT)
      SELECT 3 AS SR ,0 AS GST_TYPE,'PRT' AS XN_TYPE, 'DEBIT NOTE' AS DETAILS, 
           A.RM_ID ,
           A.RM_NO ,
           A.RM_DT,
           A.ROUND_OFF ,
           B.LOC_GST_NO AS GSTN_ID,
          A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.OTHER_CHARGES_HSN_CODE,
           ISNULL(A.OTHER_CHARGES,0)+ ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0)  AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES ELSE 0 END  AS IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES_GST_PERCENTAGE   ELSE 0 END AS IGST_RATE,
          
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0) ELSE 0 END  AS IGST_AMOUNT,    
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES ELSE 0 END  AS CGST_TAXABLE_VALUE,
           
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0) ELSE 0 END AS CGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.OTHER_CHARGES ELSE 0 END  AS SGST_TAXABLE_VALUE, 
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END AS SGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.OTHER_CHARGES ELSE 0 END  AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS UTGST_RATE,     
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END AS UTGST_AMOUNT
           
           
      FROM RMM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.RM_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
      UNION ALL
       SELECT 3 AS SR ,0 AS GST_TYPE,'PRT' AS XN_TYPE, 'DEBIT NOTE' AS DETAILS, 
           A.RM_ID ,
           A.RM_NO ,
           A.RM_DT,
           0 AS ROUND_OFF ,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.FREIGHT_HSN_CODE,
           ISNULL(A.FREIGHT,0)+ ISNULL(A.FREIGHT_IGST_AMOUNT,0)+ISNULL(A.FREIGHT_CGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0)  AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN A.FREIGHT ELSE 0 END  AS IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN A.FREIGHT_GST_PERCENTAGE   ELSE 0 END AS IGST_RATE,
          
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN ISNULL(A.FREIGHT_IGST_AMOUNT,0) ELSE 0 END  AS IGST_AMOUNT,    
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES ELSE 0 END  AS CGST_TAXABLE_VALUE,
           
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN ISNULL(A.FREIGHT_CGST_AMOUNT,0) ELSE 0 END AS CGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.FREIGHT ELSE 0 END  AS SGST_TAXABLE_VALUE, 
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.FREIGHT_SGST_AMOUNT,0) ELSE 0 END AS SGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.FREIGHT ELSE 0 END  AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS UTGST_RATE,     
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.FREIGHT_SGST_AMOUNT,0) ELSE 0 END AS UTGST_AMOUNT
           
           
      FROM RMM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.RM_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.FREIGHT_GST_PERCENTAGE,0)>0
     UNION ALL
     SELECT 3 AS SR ,0 AS GST_TYPE,'PRT' AS XN_TYPE, 'DEBIT NOTE' AS DETAILS, 
           A.RM_ID ,
           A.RM_NO ,
           A.RM_DT,
           0 AS ROUND_OFF ,
           C.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           C.DEPT_NAME ,
           B.HSN_CODE ,
           SUM(ISNULL(B.XN_VALUE_WITH_GST,0)) AS XN_VALUE_WITH_GST,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)>0 THEN ISNULL(B.XN_VALUE_WITHOUT_GST ,0) ELSE 0 END) AS IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS IGST_RATE,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.IGST_AMOUNT,0) ELSE 0 END) IGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)>0 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS CGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.CGST_AMOUNT,0) ELSE 0 END) CGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)>0  AND ISNULL(D.UT,0)=0  THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS SGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0  AND  ISNULL(D.UT,0)=0 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS SGST_AMOUNT,
           SUM(CASE WHEN  ISNULL(SGST_AMOUNT,0)>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS UTGST_RATE,
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS UTGST_AMOUNT
            
      FROM RMM01106  A (NOLOCK) 
      JOIN RMD01106  B (NOLOCK)  ON A.RM_ID =B.RM_ID
      JOIN LOCATION C (NOLOCK) ON C.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST D (NOLOCK)  ON C.GST_STATE_CODE =D.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.RM_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR C.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(B.GST_PERCENTAGE,0)>0
      GROUP BY A.RM_ID , A.RM_NO ,
      A.RM_DT, C.LOC_GST_NO,B.HSN_CODE ,
      A.location_Code,C.DEPT_NAME,
      CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END
      
   
  ----END OF DEBIT NOTE ****
  
  INSERT INTO #TMPSUMMARY(SR,GST_TYPE,XN_TYPE,DETAILS,MEMO_ID,MEMO_NO ,MEMO_DT ,ROUND_OFF ,GSTN_ID,DEPT_ID,DEPT_NAME,HSN_CODE,XN_VALUE_WITH_GST,
                              IGST_TAXABLE_VALUE,IGST_RATE,IGST_AMOUNT,CGST_TAXABLE_VALUE,CGST_RATE,CGST_AMOUNT,
                              SGST_TAXABLE_VALUE,SGST_RATE,SGST_AMOUNT,UTGST_TAXABLE_VALUE,UTGST_RATE,UTGST_AMOUNT)
      
     SELECT 4 AS SR ,0 AS GST_TYPE,'ARC' AS XN_TYPE, 
     CASE WHEN ARCT=2 THEN 'ADVANCE' ELSE 'OTHER CHARGES' END  AS DETAILS, 
           B.ADV_REC_ID ,
           B.ADV_REC_NO ,
           B.ADV_REC_DT ,
           0 AS ROUND_OFF,
           C.LOC_GST_NO AS GSTN_ID,
           B.location_Code AS DEPT_ID,
           C.DEPT_NAME ,
           B.HSN_CODE ,
           SUM(ISNULL(B.NET_AMOUNT,0)) AS XN_VALUE_WITH_GST,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)>0 THEN ISNULL(B.NET_AMOUNT ,0)-(ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0)) ELSE 0 END) AS IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS IGST_RATE,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.IGST_AMOUNT,0) ELSE 0 END) IGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)>0 THEN ISNULL(B.NET_AMOUNT,0)-(ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0)) ELSE 0 END) AS CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS CGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.CGST_AMOUNT,0) ELSE 0 END) CGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)>0  AND ISNULL(D.UT,0)=0  THEN ISNULL(B.NET_AMOUNT,0)-(ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0)) ELSE 0 END) AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS SGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0  AND  ISNULL(D.UT,0)=0 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS SGST_AMOUNT,
           SUM(CASE WHEN  ISNULL(SGST_AMOUNT,0)>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.NET_AMOUNT,0)-(ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0)) ELSE 0 END) AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS UTGST_RATE,
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS UTGST_AMOUNT
          
      FROM ARC01106   B (NOLOCK) 
      JOIN LOCATION C (NOLOCK) ON C.DEPT_ID =B.location_Code
      JOIN GST_STATE_MST D (NOLOCK)  ON C.GST_STATE_CODE =D.GST_STATE_CODE 
      WHERE B.CANCELLED =0
      AND ARC_TYPE =1 
      AND ( ARCT=2 OR ARCT=3)
      AND ISNULL(B.GST_PERCENTAGE,0)>0
      AND B.ADV_REC_DT   BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR B.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR C.LOC_GST_NO=@CGSTN_NO)
      GROUP BY B.ADV_REC_ID , C.LOC_GST_NO,B.HSN_CODE ,
      B.ADV_REC_NO ,B.ADV_REC_DT,
       B.location_Code,C.DEPT_NAME,
      CASE WHEN ARCT=2 THEN 'ADVANCE' ELSE 'OTHER CHARGES' END,
      CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END
      
      
  --END ADVANCE
  
       
     INSERT INTO #TMPSUMMARY(SR,GST_TYPE,XN_TYPE,DETAILS,MEMO_ID,MEMO_NO ,MEMO_DT ,ROUND_OFF ,GSTN_ID,DEPT_ID,DEPT_NAME,HSN_CODE,XN_VALUE_WITH_GST,
                              IGST_TAXABLE_VALUE,IGST_RATE,IGST_AMOUNT,CGST_TAXABLE_VALUE,CGST_RATE,CGST_AMOUNT,
                              SGST_TAXABLE_VALUE,SGST_RATE,SGST_AMOUNT,UTGST_TAXABLE_VALUE,UTGST_RATE,UTGST_AMOUNT,VAT_AMOUNT)    
      SELECT 1 AS SR ,0 AS GST_TYPE,'SLSCR' AS XN_TYPE, 'RETAIL CREDIT NOTE' AS DETAILS, 
           A.CM_ID ,
           A.CM_NO,
           A.CM_DT ,
           A.ROUND_OFF ,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.OTHER_CHARGES_HSN_CODE ,
           ISNULL(A.ATD_CHARGES,0)+ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) AS XN_VALUE_WITH_GST,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) <>0 THEN A.ATD_CHARGES ELSE 0 END IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) <>0 THEN ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0) ELSE 0 END AS IGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) <>0 THEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) <>0 THEN A.ATD_CHARGES ELSE 0 END CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) <>0 THEN ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0) ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) <>0 THEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) ELSE 0 END CGST_AMOUNT ,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=0 THEN A.ATD_CHARGES ELSE 0 END SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=0 THEN ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0) ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=0 THEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END SGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=1 THEN A.ATD_CHARGES ELSE 0 END UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=1 THEN ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0) ELSE 0 END AS UTGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) <>0 AND ISNULL(C.UT,0)=1 THEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END UTGST_AMOUNT,
           0 AS VAT_AMOUNT
      FROM CMM01106 A (NOLOCK)
      JOIN #TMCMID1OTH TMP ON A.CM_ID =TMP.CM_ID 
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
      UNION ALL
      SELECT 1 AS SR ,0 AS GST_TYPE,'SLSCR' AS XN_TYPE, 'RETAIL CREDIT NOTE' AS DETAILS, 
           A.CM_ID ,
           A.CM_NO,
           A.CM_DT ,
           0 AS ROUND_OFF ,
           C.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           C.DEPT_NAME ,
           B.HSN_CODE ,
            (SUM(CASE WHEN ISNULL(B.XN_VALUE_WITH_GST,0)>0 THEN ISNULL(B.XN_VALUE_WITH_GST,0) ELSE NET-CMM_DISCOUNT_AMOUNT END +CASE WHEN B.TAX_METHOD =2 THEN B.TAX_AMOUNT ELSE 0 END )) AS XN_VALUE_WITH_GST,
           (SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)<>0 THEN 
            CASE WHEN ISNULL(B.XN_VALUE_WITHOUT_GST,0)<>0 THEN ISNULL(B.XN_VALUE_WITHOUT_GST,0) ELSE NET-CMM_DISCOUNT_AMOUNT END  ELSE 0 END)) AS IGST_TAXABLE_VALUE,
           (CASE WHEN ISNULL(IGST_AMOUNT,0) <>0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END) AS IGST_RATE,
           (SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)<>0 THEN ISNULL(B.IGST_AMOUNT ,0) ELSE 0 END))  AS IGST_AMOUNT,
           (SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)<>0 THEN 
           CASE WHEN ISNULL(B.XN_VALUE_WITHOUT_GST,0)<>0 THEN ISNULL(B.XN_VALUE_WITHOUT_GST,0) ELSE NET-CMM_DISCOUNT_AMOUNT END ELSE 0 END)) AS CGST_TAXABLE_VALUE,
           (CASE WHEN ISNULL(CGST_AMOUNT,0) <>0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END) AS CGST_RATE,
           (SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)<>0 THEN ISNULL(B.CGST_AMOUNT ,0) ELSE 0 END))  AS CGST_AMOUNT,
           (SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)<>0  AND ISNULL(D.UT,0)=0  THEN 
           CASE WHEN ISNULL(B.XN_VALUE_WITHOUT_GST,0)<>0 THEN ISNULL(B.XN_VALUE_WITHOUT_GST,0) ELSE NET-CMM_DISCOUNT_AMOUNT END ELSE 0 END)) AS SGST_TAXABLE_VALUE,
           (CASE WHEN ISNULL(SGST_AMOUNT,0) <>0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END) AS SGST_RATE,
           (SUM(CASE WHEN  ISNULL(SGST_AMOUNT,0)<>0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END)) AS SGST_AMOUNT,
           (SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)<>0 AND ISNULL(D.UT,0)=1 THEN 
           CASE WHEN ISNULL(B.XN_VALUE_WITHOUT_GST,0)<>0 THEN ISNULL(B.XN_VALUE_WITHOUT_GST,0) ELSE NET-CMM_DISCOUNT_AMOUNT END ELSE 0 END)) AS UTGST_TAXABLE_VALUE,
           (CASE WHEN ISNULL(SGST_AMOUNT,0) <>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END) AS UTGST_RATE,
           (SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)<>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END)) AS UTGST_AMOUNT,
          
           --(SUM(ISNULL(B.XN_VALUE_WITH_GST,0)+ISNULL(B.TAX_AMOUNT,0))) AS XN_VALUE_WITH_GST,
           --(SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)<>0 THEN ISNULL(B.XN_VALUE_WITHOUT_GST ,0) ELSE 0 END)) AS IGST_TAXABLE_VALUE,
           --(CASE WHEN ISNULL(IGST_AMOUNT,0) <>0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END) AS IGST_RATE,
           --(SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)<>0 THEN ISNULL(B.IGST_AMOUNT ,0) ELSE 0 END))  AS IGST_AMOUNT,
           --(SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)<>0 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END)) AS CGST_TAXABLE_VALUE,
           --(CASE WHEN ISNULL(CGST_AMOUNT,0) <>0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END) AS CGST_RATE,
           --(SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)<>0 THEN ISNULL(B.CGST_AMOUNT ,0) ELSE 0 END))  AS CGST_AMOUNT,
           --(SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)<>0  AND ISNULL(D.UT,0)=0  THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END)) AS SGST_TAXABLE_VALUE,
           --(CASE WHEN ISNULL(SGST_AMOUNT,0) <>0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END) AS SGST_RATE,
           --(SUM(CASE WHEN  ISNULL(SGST_AMOUNT,0)<>0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END)) AS SGST_AMOUNT,
           --(SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)<>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END)) AS UTGST_TAXABLE_VALUE,
           --(CASE WHEN ISNULL(SGST_AMOUNT,0) <>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END) AS UTGST_RATE,
           --(SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)<>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END)) AS UTGST_AMOUNT,
            SUM(B.TAX_AMOUNT) AS VAT_AMOUNT 
      FROM CMM01106 A (NOLOCK) 
      JOIN #TMCMID1 TMP ON A.CM_ID =TMP.CM_ID 
      JOIN CMD01106 B (NOLOCK)  ON A.CM_ID =B.CM_ID
      JOIN LOCATION C (NOLOCK) ON C.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST D (NOLOCK)  ON C.GST_STATE_CODE =D.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR C.LOC_GST_NO=@CGSTN_NO)
      AND B.QUANTITY<0
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(B.GST_PERCENTAGE,0)>0
      GROUP BY A.CM_ID ,A.CM_NO,B.HSN_CODE ,
       A.CM_DT , C.LOC_GST_NO,
      A.location_Code,C.DEPT_NAME,
      CASE WHEN ISNULL(IGST_AMOUNT,0) <>0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(CGST_AMOUNT,0) <>0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) <>0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) <>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END
      
  
  --***END RETAIL SALE CREDIT NOTE***--

  INSERT INTO #TMPSUMMARY(SR,GST_TYPE,XN_TYPE,DETAILS,MEMO_ID,MEMO_NO ,MEMO_DT ,ROUND_OFF ,GSTN_ID,DEPT_ID,DEPT_NAME,HSN_CODE,XN_VALUE_WITH_GST,
                              IGST_TAXABLE_VALUE,IGST_RATE,IGST_AMOUNT,CGST_TAXABLE_VALUE,CGST_RATE,CGST_AMOUNT,
                              SGST_TAXABLE_VALUE,SGST_RATE,SGST_AMOUNT,UTGST_TAXABLE_VALUE,UTGST_RATE,UTGST_AMOUNT)
      
     SELECT 5 AS SR ,1 AS GST_TYPE,'SLSADV' AS XN_TYPE, 'ADVANCE ADJUSTED' AS DETAILS, 
           B.ADV_REC_ID ,
           B.ADV_REC_NO ,
           CM.CM_DT ,
           0 AS ROUND_OFF,
           C.LOC_GST_NO AS GSTN_ID,
           B.location_Code AS DEPT_ID,
           C.DEPT_NAME ,
           B.HSN_CODE ,
          SUM(ISNULL(B.NET_AMOUNT,0)) AS XN_VALUE_WITH_GST,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)>0 THEN ISNULL(B.NET_AMOUNT ,0)-(ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0)) ELSE 0 END) AS IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS IGST_RATE,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.IGST_AMOUNT,0) ELSE 0 END) IGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)>0 THEN ISNULL(B.NET_AMOUNT,0)-(ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0)) ELSE 0 END) AS CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS CGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.CGST_AMOUNT,0) ELSE 0 END) CGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)>0  AND ISNULL(D.UT,0)=0  THEN ISNULL(B.NET_AMOUNT,0)-(ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0)) ELSE 0 END) AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS SGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0  AND  ISNULL(D.UT,0)=0 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS SGST_AMOUNT,
           SUM(CASE WHEN  ISNULL(SGST_AMOUNT,0)>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.NET_AMOUNT,0)-(ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0)) ELSE 0 END) AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS UTGST_RATE,
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS UTGST_AMOUNT
          
      FROM ARC01106   B (NOLOCK) 
      JOIN LOCATION C (NOLOCK) ON C.DEPT_ID =B.location_Code
      JOIN GST_STATE_MST D (NOLOCK)  ON C.GST_STATE_CODE =D.GST_STATE_CODE 
	  JOIN PAYMODE_XN_DET PX (NOLOCK) ON PX.ADJ_MEMO_ID=B.ADV_REC_ID
	  JOIN CMM01106 CM (NOLOCK) ON CM.CM_ID=PX.MEMO_ID      
      WHERE B.CANCELLED =0 AND CM.CANCELLED=0 AND PAYMODE_CODE='0000002'
      AND ARC_TYPE =1 AND ARCT=2
      AND CM.CM_DT   BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR B.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR C.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(B.GST_PERCENTAGE,0)>0
      GROUP BY B.ADV_REC_ID , C.LOC_GST_NO,B.HSN_CODE ,
      B.ADV_REC_NO ,CM.CM_DT,
      B.location_Code,C.DEPT_NAME,
      CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END
  
    --***END RETAIL SALE ADVANCE ADJUSTMENT***--
  
  INSERT INTO #TMPSUMMARY(SR,GST_TYPE,XN_TYPE,DETAILS,MEMO_ID,MEMO_NO ,MEMO_DT ,ROUND_OFF ,GSTN_ID,DEPT_ID,DEPT_NAME,HSN_CODE,XN_VALUE_WITH_GST,
                              IGST_TAXABLE_VALUE,IGST_RATE,IGST_AMOUNT,CGST_TAXABLE_VALUE,CGST_RATE,CGST_AMOUNT,
                              SGST_TAXABLE_VALUE,SGST_RATE,SGST_AMOUNT,UTGST_TAXABLE_VALUE,UTGST_RATE,UTGST_AMOUNT)
      SELECT 6 AS SR ,1 AS GST_TYPE,'PUR' AS XN_TYPE, 'PURCHASE' AS DETAILS, 
           A.MRR_ID  ,
           A.MRR_NO ,
           A.INV_DT ,
           A.ROUND_OFF ,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.OTHER_CHARGES_HSN_CODE ,
           ISNULL(A.OTHER_CHARGES,0)+ ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0)  AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES ELSE 0 END AS IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS IGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES ELSE 0 END  AS CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES_GST_PERCENTAGE ELSE 0 END AS CGST_RATE,    
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0) ELSE 0 END  AS CGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.OTHER_CHARGES ELSE 0 END AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END  AS SGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.OTHER_CHARGES ELSE 0 END AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS UTGST_RATE,  
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END  AS UTGST_AMOUNT
               
      FROM PIM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.INV_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
     UNION ALL
       SELECT 6 AS SR ,1 AS GST_TYPE,'PUR' AS XN_TYPE, 'PURCHASE' AS DETAILS, 
           A.MRR_ID ,
           A.BILL_NO  ,
           A.INV_DT ,
           0  AS ROUND_OFF,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.FREIGHT_HSN_CODE ,
           ISNULL(A.FREIGHT,0)+ ISNULL(A.FREIGHT_IGST_AMOUNT,0)+ISNULL(A.FREIGHT_CGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0) AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN A.FREIGHT ELSE 0 END AS IGST_TAXABLE_VALUE,  
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS IGST_RATE,     
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN ISNULL(A.FREIGHT_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN A.FREIGHT ELSE 0 END  CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN ISNULL(A.FREIGHT_CGST_AMOUNT,0) ELSE 0 END AS CGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.FREIGHT ELSE 0 END  AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.FREIGHT_SGST_AMOUNT,0) ELSE 0 END  AS SGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.FREIGHT ELSE 0 END AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.FREIGHT_GST_PERCENTAGE   ELSE 0 END AS UTGST_RATE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.FREIGHT_SGST_AMOUNT,0) ELSE 0 END  AS UTGST_AMOUNT
              
      FROM PIM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.challan_source_location_code 
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.FREIGHT_GST_PERCENTAGE,0)>0
     UNION ALL
     SELECT 6 AS SR ,1 AS GST_TYPE,'PUR' AS XN_TYPE, 'PURCHASE' AS DETAILS, 
           A.MRR_ID ,
           A.BILL_NO ,
           A.INV_DT ,
           0 AS ROUND_OFF ,
           C.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           C.DEPT_NAME ,
           B.HSN_CODE ,
           SUM(ISNULL(B.XN_VALUE_WITH_GST,0)) AS XN_VALUE_WITH_GST,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)>0 THEN ISNULL(B.XN_VALUE_WITHOUT_GST ,0) ELSE 0 END) AS IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS IGST_RATE,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.IGST_AMOUNT,0) ELSE 0 END) IGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)>0 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS CGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.CGST_AMOUNT,0) ELSE 0 END) CGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)>0  AND ISNULL(D.UT,0)=0  THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS SGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0  AND  ISNULL(D.UT,0)=0 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS SGST_AMOUNT,
           SUM(CASE WHEN  ISNULL(SGST_AMOUNT,0)>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS UTGST_RATE,
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS UTGST_AMOUNT
            
      FROM PIM01106 A (NOLOCK) 
      JOIN PID01106 B (NOLOCK)  ON A.MRR_ID =B.MRR_ID
      JOIN LOCATION C (NOLOCK) ON C.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST D (NOLOCK)  ON C.GST_STATE_CODE =D.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.INV_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR C.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(B.GST_PERCENTAGE,0)>0
      GROUP BY A.MRR_ID , A.BILL_NO ,
           A.INV_DT , C.LOC_GST_NO,
      A.location_Code,C.DEPT_NAME, B.HSN_CODE ,
      CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END
      
  --END OF PURCHASE****
  
  
   --***WHOSALE****
   INSERT INTO #TMPSUMMARY(SR,GST_TYPE,XN_TYPE,DETAILS,MEMO_ID,MEMO_NO ,MEMO_DT ,ROUND_OFF ,GSTN_ID,DEPT_ID,DEPT_NAME,HSN_CODE,XN_VALUE_WITH_GST,
                              IGST_TAXABLE_VALUE,IGST_RATE,IGST_AMOUNT,CGST_TAXABLE_VALUE,CGST_RATE,CGST_AMOUNT,
                              SGST_TAXABLE_VALUE,SGST_RATE,SGST_AMOUNT,UTGST_TAXABLE_VALUE,UTGST_RATE,UTGST_AMOUNT)
      SELECT 7 AS SR ,1 AS GST_TYPE,'WSR' AS XN_TYPE, 'WHOLESALE CREDIT NOTE' AS DETAILS, 
           A.CN_ID ,
           A.CN_NO  ,
           A.CN_DT ,
           A.ROUND_OFF ,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.OTHER_CHARGES_HSN_CODE ,
           ISNULL(A.OTHER_CHARGES,0)+ ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES ELSE 0 END AS IGST_TAXABLE_VALUE,  
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS IGST_RATE,     
           CASE WHEN ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) >0 THEN ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES ELSE 0 END  CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0) >0 THEN ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0) ELSE 0 END AS CGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.OTHER_CHARGES ELSE 0 END  AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.OTHER_CHARGES_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END  AS SGST_AMOUNT,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.OTHER_CHARGES ELSE 0 END AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.OTHER_CHARGES_GST_PERCENTAGE   ELSE 0 END AS UTGST_RATE,
           CASE WHEN ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) ELSE 0 END  AS UTGST_AMOUNT
             
      FROM CNM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.CN_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
      UNION ALL
       
      SELECT 7 AS SR ,1 AS GST_TYPE,'WSR' AS XN_TYPE, 'WHOLESALE CREDIT NOTE' AS DETAILS, 
           A.CN_ID ,
           A.CN_NO  ,
           A.CN_DT ,
           0 AS ROUND_OFF ,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.INSURANCE_HSN_CODE ,
            ISNULL(A.INSURANCE,0)+ ISNULL(A.INSURANCE_IGST_AMOUNT,0)+ISNULL(A.INSURANCE_CGST_AMOUNT,0)+ISNULL(A.INSURANCE_SGST_AMOUNT,0) AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(INSURANCE_IGST_AMOUNT,0) >0 THEN A.INSURANCE ELSE 0 END AS IGST_TAXABLE_VALUE,  
           CASE WHEN ISNULL(INSURANCE_IGST_AMOUNT,0) >0 THEN A.INSURANCE_GST_PERCENTAGE  ELSE 0 END AS IGST_RATE,     
           CASE WHEN ISNULL(INSURANCE_IGST_AMOUNT,0) >0 THEN ISNULL(A.INSURANCE_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(INSURANCE_CGST_AMOUNT,0) >0 THEN A.INSURANCE ELSE 0 END  CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(INSURANCE_CGST_AMOUNT,0) >0 THEN A.INSURANCE_GST_PERCENTAGE  ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(INSURANCE_CGST_AMOUNT,0) >0 THEN ISNULL(A.INSURANCE_CGST_AMOUNT,0) ELSE 0 END AS CGST_AMOUNT,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.INSURANCE ELSE 0 END  AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.INSURANCE_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.INSURANCE_SGST_AMOUNT,0) ELSE 0 END  AS SGST_AMOUNT,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.INSURANCE ELSE 0 END AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.INSURANCE_GST_PERCENTAGE   ELSE 0 END AS UTGST_RATE,
           CASE WHEN ISNULL(INSURANCE_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.INSURANCE_SGST_AMOUNT,0) ELSE 0 END  AS UTGST_AMOUNT
             
      FROM CNM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.CN_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.INSURANCE_GST_PERCENTAGE,0)>0
      UNION ALL
      SELECT 7 AS SR ,1 AS GST_TYPE,'WSR' AS XN_TYPE, 'WHOLESALE CREDIT NOTE' AS DETAILS, 
           A.CN_ID ,
           A.CN_NO  ,
           A.CN_DT ,
           0 AS ROUND_OFF ,
           B.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           B.DEPT_NAME ,
           A.FREIGHT_HSN_CODE ,
           ISNULL(A.FREIGHT,0)+ ISNULL(A.FREIGHT_IGST_AMOUNT,0)+ISNULL(A.FREIGHT_CGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0) AS XN_VALUE_WITH_GST ,
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN A.FREIGHT ELSE 0 END AS IGST_TAXABLE_VALUE,  
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS IGST_RATE,     
           CASE WHEN ISNULL(FREIGHT_IGST_AMOUNT,0) >0 THEN ISNULL(A.FREIGHT_IGST_AMOUNT,0) ELSE 0 END AS IGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN A.FREIGHT ELSE 0 END  CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS CGST_RATE,
           CASE WHEN ISNULL(FREIGHT_CGST_AMOUNT,0) >0 THEN ISNULL(A.FREIGHT_CGST_AMOUNT,0) ELSE 0 END AS CGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.FREIGHT ELSE 0 END  AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=0 THEN A.FREIGHT_GST_PERCENTAGE  ELSE 0 END AS SGST_RATE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=0 THEN ISNULL(A.FREIGHT_SGST_AMOUNT,0) ELSE 0 END  AS SGST_AMOUNT,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.FREIGHT ELSE 0 END AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0 AND ISNULL(C.UT,0)=1 THEN A.FREIGHT_GST_PERCENTAGE   ELSE 0 END AS UTGST_RATE,
           CASE WHEN ISNULL(FREIGHT_SGST_AMOUNT,0) >0  AND ISNULL(C.UT,0)=1 THEN ISNULL(A.FREIGHT_SGST_AMOUNT,0) ELSE 0 END  AS UTGST_AMOUNT
             
      FROM CNM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.CN_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(A.FREIGHT_GST_PERCENTAGE,0)>0
    
     UNION ALL
     SELECT 7 AS SR ,1 AS GST_TYPE,'WSR' AS XN_TYPE, 'WHOLESALE CREDIT NOTE' AS DETAILS, 
           A.CN_ID ,
           A.CN_NO  ,
           A.CN_DT ,
           0 AS ROUND_OFF ,
           C.LOC_GST_NO AS GSTN_ID,
           A.location_Code AS DEPT_ID,
           C.DEPT_NAME ,
           B.HSN_CODE ,
           SUM(ISNULL(B.XN_VALUE_WITH_GST,0)) AS XN_VALUE_WITH_GST,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0)>0 THEN ISNULL(B.XN_VALUE_WITHOUT_GST ,0) ELSE 0 END) AS IGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS IGST_RATE,
           SUM(CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.IGST_AMOUNT,0) ELSE 0 END) IGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0)>0 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS CGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS CGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.CGST_AMOUNT,0) ELSE 0 END) CGST_AMOUNT,
           
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0)>0  AND ISNULL(D.UT,0)=0  THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS SGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS SGST_RATE,
           SUM(CASE WHEN ISNULL(CGST_AMOUNT,0) >0  AND  ISNULL(D.UT,0)=0 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS SGST_AMOUNT,
           SUM(CASE WHEN  ISNULL(SGST_AMOUNT,0)>0 AND ISNULL(D.UT,0)=1 THEN ISNULL(XN_VALUE_WITHOUT_GST,0) ELSE 0 END) AS UTGST_TAXABLE_VALUE,
           CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END AS UTGST_RATE,
           SUM(CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.SGST_AMOUNT,0) ELSE 0 END) AS UTGST_AMOUNT
            
      FROM CNM01106 A (NOLOCK) 
      JOIN CND01106 B (NOLOCK)  ON A.CN_ID =B.CN_ID
      JOIN LOCATION C (NOLOCK) ON C.DEPT_ID =A.location_Code
      JOIN GST_STATE_MST D (NOLOCK)  ON C.GST_STATE_CODE =D.GST_STATE_CODE 
      WHERE A.CANCELLED =0
      AND A.CN_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
      AND (@CGSTN_NO='' OR C.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0)=1
      AND ISNULL(B.GST_PERCENTAGE,0)>0
      GROUP BY A.CN_ID,A.CN_NO  ,
      A.CN_DT , C.LOC_GST_NO,B.HSN_CODE,
      A.location_Code,C.DEPT_NAME,
      CASE WHEN ISNULL(IGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(CGST_AMOUNT,0) >0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=0 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END,
      CASE WHEN ISNULL(SGST_AMOUNT,0) >0 AND ISNULL(D.UT,0)=1 THEN ISNULL(B.GST_PERCENTAGE,0) ELSE 0 END
      
  --END OF WHOSALE CREDIT NOTE ****
    
    IF OBJECT_ID ('TEMPDB..#TMPROUNDOFF','U') IS NOT NULL
       DROP TABLE #TMPROUNDOFF
       
       SELECT MEMO_ID,ROUND_OFF
       INTO #TMPROUNDOFF
       FROM #TMPSUMMARY
       WHERE ROUND_OFF<>0
       UPDATE #TMPSUMMARY SET ROUND_OFF =0
       
       ;WITH CTE AS
      (
       SELECT MEMO_ID ,XN_VALUE_WITH_GST ,ROUND_OFF,
              ROW_NUMBER () OVER (PARTITION BY MEMO_ID ORDER BY MEMO_ID) AS SR
       FROM #TMPSUMMARY A
       WHERE A.XN_VALUE_WITH_GST<>0 
      )
      UPDATE A SET ROUND_OFF=B.ROUND_OFF  FROM CTE A
      JOIN #TMPROUNDOFF B ON A.MEMO_ID =B.MEMO_ID 
      WHERE A.SR =1
  
  
    SELECT A.SR,A.GST_TYPE , A.XN_TYPE ,A.DETAILS ,A.GSTN_ID ,A.DEPT_NAME ,
            ISNULL(A.HSN_CODE,'0000000000') AS HSN_CODE,
            CAST(SUM(A.ROUND_OFF ) AS NUMERIC(18,2)) AS  ROUND_OFF,
            --0 AS ROUND_OFF,
            ((CAST(SUM(A.XN_VALUE_WITH_GST ) AS NUMERIC(18,2)))) AS  XN_VALUE_WITH_GST,
            ((CAST(SUM(A.IGST_TAXABLE_VALUE) AS NUMERIC(18,2)))) AS IGST_TAXABLE_VALUE,
            (A.IGST_RATE) AS IGST_RATE ,
            ((CAST(SUM(A.IGST_AMOUNT ) AS NUMERIC(18,2)))) AS IGST_AMOUNT,
            ((CAST(SUM(A.CGST_TAXABLE_VALUE) AS NUMERIC(18,2)))) AS CGST_TAXABLE_VALUE,
            ( CAST(A.CGST_RATE/2 AS NUMERIC(5,2))) AS CGST_RATE ,
            ((CAST(SUM(A.CGST_AMOUNT ) AS NUMERIC(18,2)))) AS CGST_AMOUNT,
            ((CAST(SUM(A.SGST_TAXABLE_VALUE) AS NUMERIC(18,2)))) AS SGST_TAXABLE_VALUE,
            ( CAST(A.SGST_RATE/2 AS NUMERIC(5,2))) AS SGST_RATE,
            ( (CAST(SUM(A.SGST_AMOUNT ) AS NUMERIC(18,2)))) AS SGST_AMOUNT,
            ((CAST(SUM(A.UTGST_TAXABLE_VALUE) AS NUMERIC(18,2)))) AS UGST_TAXABLE_VALUE,
            ( CAST(A.UTGST_RATE/2 AS NUMERIC(5,2))) AS UGST_RATE ,
            ((CAST(SUM(A.UTGST_AMOUNT ) AS NUMERIC(18,2)))) AS UGST_AMOUNT,
            ((CAST(SUM(A.VAT_AMOUNT ) AS NUMERIC(18,2)))) AS VAT_AMOUNT,
            CAST(CASE WHEN IGST_RATE<>0 THEN IGST_RATE 
                 WHEN CGST_RATE<>0 THEN CGST_RATE 
            ELSE SGST_RATE END AS NUMERIC(10,0)) AS RATE
     FROM #TMPSUMMARY A
     WHERE A.XN_VALUE_WITH_GST<>0
     GROUP BY A.SR,ISNULL(A.HSN_CODE,'0000000000'),A.GST_TYPE ,A.XN_TYPE ,A.DETAILS ,A.GSTN_ID ,A.DEPT_NAME,
     A.IGST_RATE ,A.CGST_RATE ,A.SGST_RATE,A.UTGST_RATE
     ORDER BY DEPT_NAME,A.XN_TYPE ,GST_TYPE,SR,ISNULL(A.HSN_CODE,'0000000000')
    
 

    
END
