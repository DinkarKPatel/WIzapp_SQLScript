CREATE PROCEDURE SP_RESENDXNSDATA_DOCDTR
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CTABLENAME VARCHAR(100),@CCMD NVARCHAR(MAX),@CKEYFIELD VARCHAR(100),@CREFXNTYPE VARCHAR(10),
			@NSTEP INT,@CERRORMSG VARCHAR(MAX),@CXNTYPE VARCHAR(10),@CSEARCHXNTYPE VARCHAR(10)
	
	BEGIN TRY
		
		BEGIN TRANSACTION
		
		DECLARE @TRETMSG TABLE (ERRMSG VARCHAR(MAX))	
		
		SET @NSTEP=10	
		
		SET @CERRORMSG=''
				
		IF NOT EXISTS (SELECT TOP 1 XN_TYPE FROM DOWNLOAD_LOG WHERE LEFT(XN_TYPE,6)='DOCDTR')
			GOTO LBLLAST
				
		IF CURSOR_STATUS('GLOBAL','DOCDTRCUR') IN (0,1)  
		BEGIN  
		  CLOSE DOCDTRCUR  
		  DEALLOCATE DOCDTRCUR  
		END  

		IF OBJECT_ID('TEMPDB..#TMPDOCDTR','U') IS NOT NULL
			DROP TABLE #TMPDOCDTR
			
		SELECT DISTINCT SUBSTRING(XN_TYPE,7,LEN(XN_TYPE)) AS XN_TYPE,MEMO_ID
		INTO #TMPDOCDTR FROM  DOWNLOAD_LOG(NOLOCK)	WHERE LEFT(XN_TYPE,6)='DOCDTR'
		
		DECLARE DOCDTRCUR CURSOR FOR SELECT DISTINCT  XN_TYPE FROM #TMPDOCDTR
	
		OPEN DOCDTRCUR
		FETCH NEXT FROM DOCDTRCUR INTO @CXNTYPE
		
		WHILE @@FETCH_STATUS=0
		BEGIN
			
			SET @CSEARCHXNTYPE=(CASE WHEN @CXNTYPE='XNSUNC' THEN 'XNSCNC' WHEN @CXNTYPE='XNSCHO' THEN 'XNSWSL'
									 WHEN @CXNTYPE='XNSCHI' THEN 'XNSPUR' ELSE @CXNTYPE END)
									 
			SELECT TOP 1  @CTABLENAME=TABLENAME,@CKEYFIELD=KEYFIELD FROM XNSINFO 
			WHERE XN_TYPE=@CSEARCHXNTYPE AND (ISNULL(MEMODTCOL,'')<>'' OR TABLENAME='COM01106')
			
			SET @NSTEP=20
			IF @CSEARCHXNTYPE='DOCCHO_WSL'
			BEGIN
				SET @CCMD=N'UPDATE INM01106 SET UPLOADED_TO_ACTIVSTREAM=0,EXPORTED=1 WHERE INV_ID IN ('
			END	
			ELSE
			IF @CSEARCHXNTYPE='DOCCHO_PRT'
			BEGIN
				SET @CCMD=N'UPDATE RMM01106 SET UPLOADED_TO_ACTIVSTREAM=0,EXPORTED=1 WHERE RM_ID IN ('
			END	
			ELSE
			IF @CSEARCHXNTYPE='XNSAPR'
			BEGIN
				SET @CCMD=N'UPDATE CMM01106 SET LAST_UPDATE=GETDATE() WHERE CM_ID IN ('			
			END	
			ELSE
			IF @CSEARCHXNTYPE='XNSPUR'
			BEGIN
				SET @CCMD=N'UPDATE PIM01106 SET LAST_UPDATE=GETDATE() WHERE MRR_ID IN ('			
			END	
			ELSE
			IF @CSEARCHXNTYPE='XNSOPS'
			BEGIN
				SET @CCMD=N'UPDATE OPS01106 SET LAST_UPDATE=GETDATE()'			
			END			
			ELSE				
			BEGIN
				SET @CCMD=N'UPDATE '+@CTABLENAME+' SET LAST_UPDATE=GETDATE() WHERE '+@CKEYFIELD +' IN ('
			END
								
			SET @NSTEP=30
			SET @CCMD=@CCMD+' SELECT MEMO_ID FROM #TMPDOCDTR (NOLOCK) WHERE XN_TYPE='''+@CXNTYPE+''')'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

		
			FETCH NEXT FROM DOCDTRCUR INTO @CXNTYPE
		END	
		
		CLOSE DOCDTRCUR
		DEALLOCATE DOCDTRCUR
		
		SET @NSTEP=40
		DELETE A FROM DOWNLOAD_LOG A JOIN #TMPDOCDTR B ON A.MEMO_ID=B.MEMO_ID
		WHERE LEFT(A.XN_TYPE,6)='DOCDTR'
		
		GOTO LBLLAST
		
	END TRY
	
	BEGIN CATCH
		
		SELECT @CERRORMSG='PROCEDURE : SP_RESENDXNSDATA_DOCDTR STEP: '+STR(@NSTEP)+' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
	END CATCH

LBLLAST:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			COMMIT TRANSACTION
		ELSE
			ROLLBACK	
	END 
		
	INSERT @TRETMSG 
	SELECT ISNULL(@CERRORMSG,'')
	
	SELECT * FROM @TRETMSG
END
--********************************************** END OF PROCEDURE SP_RESENDXNSDATA_DOCDTR
