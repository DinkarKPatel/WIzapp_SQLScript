CREATE PROCEDURE SP_RETAILSALE_RPT--(LocId 3 digit change by Sanjay:06-11-2024)
(
	@NOPTTYPE		NUMERIC(2),
	@NOPTPENTYPE	NUMERIC(2),
	@CCUST			VARCHAR(20),
	@CDEPT_ID		VARCHAR(10),
	@CUSERCODE		VARCHAR(10),
	@DTFROM			VARCHAR(20),
	@DTTO			VARCHAR(20)
)
--WITH ENCRYPTION
AS
BEGIN
--@NOPTTYPE = 1. ALL
--@NOPTTYPE = 2. CREDIT DETAILS
--@NOPTTYPE = 3. CREDIT NOTES
--@NOPTTYPE = 4. CASH REFUNDS
--@NOPTTYPE = 5. APPROVAL MEMOS
--@NOPTTYPE = 6. CREDIT REFUND DETAILS

--@NOPTPENTYPE= 1. ALL
--@NOPTPENTYPE= 2. PENDING	
--@NOPTPENTYPE= 3. ADJUSTED


DECLARE  @CWC NVARCHAR(MAX),@CCMD NVARCHAR(MAX),
		@CGC VARCHAR(4),
		@LDISPLAY_BILLS_CURRENT_USER_ONLY BIT

SELECT TOP 1 @CGC = COMPANY_CODE FROM COMPANY WHERE COMPANY_CODE<>'00'

SELECT @LDISPLAY_BILLS_CURRENT_USER_ONLY=ISNULL(VALUE,0) FROM USER_ROLE_DET A
JOIN USERS B ON A.ROLE_ID=B.ROLE_ID
WHERE FORM_NAME='CASHMEMO' AND FORM_OPTION='DISPLAY_BILLS_ALL_USERS' AND USER_CODE=@CUSERCODE


SET @CWC = N' (A.CM_DT BETWEEN '''  + (@DTFROM) + ''' AND ''' + (@DTTO) + ''''+(CASE WHEN @NOPTTYPE<>5 THEN 
			  ' AND A.MEMO_TYPE=1 ' ELSE '' END)+' )';

--PRINT @CWC        	
        	
SET @CWC = @CWC + (CASE WHEN LTRIM(RTRIM(@CWC))<>'' AND @NOPTTYPE<>1 THEN N' AND ' ELSE  '' END )

--PRINT @CWC
SET @CWC=@CWC+(CASE WHEN @NOPTTYPE=2 THEN N' A.CM_MODE =1 AND PAY.CREDIT_AMOUNT>0 AND SUBSTRING(A.CM_NO,len(A.location_code)+3,1)<>''N'' '
					WHEN @NOPTTYPE=3 THEN N' A.CM_MODE = 1 AND PAY.CREDIT_AMOUNT<0 AND SUBSTRING(A.CM_NO,len(A.location_code)+3,1)=''N'' '
					WHEN @NOPTTYPE=4 THEN N' A.CM_MODE = 1 AND PAY.CASH_AMOUNT <0 '
					WHEN @NOPTTYPE=5 THEN N' SUBSTRING(A.CM_NO,len(A.location_code)+3,1)=''E'' '
					WHEN @NOPTTYPE=6 THEN N' A.CM_MODE =1 AND PAY.CREDIT_REFUND_AMOUNT<>0 '
					ELSE '' END)
--PRINT @CWC					
--FILTER ON COMPANY CODE
SET @CWC =(CASE WHEN LTRIM(RTRIM(@CWC ))<>'' 
				THEN N' WHERE '+@CWC--+ N' AND A.COMPANY_CODE = ''' + @CGC +'''' 
				ELSE @CWC + N' WHERE ' END)
--A.COMPANY_CODE = ''' + @CGC +'''				
--PRINT @CWC				
--FILTER ON DEPT ID 
SET @CWC = @CWC + (CASE WHEN @CDEPT_ID<>'' THEN N' AND a.location_code='''+@CDEPT_ID+'''' ELSE '' END)
--PRINT @CWC
--FILTER ON CUSTOMER CODE         	
SET @CWC = @CWC + (CASE WHEN LTRIM(RTRIM(@CCUST))<>'' THEN N' AND A.CUSTOMER_CODE = ''' + @CCUST + '''' ELSE '' END)
--PRINT @CWC
-- FILTER FOR USER         	
SET @CWC =@CWC +(CASE WHEN (@CUSERCODE!='0000000') AND @LDISPLAY_BILLS_CURRENT_USER_ONLY=1 THEN ' AND A.USER_CODE = ''' + @CUSERCODE + '''' ELSE '' END)
--PRINT @CWC
IF(@NOPTTYPE=2) 
BEGIN
SET @CWC =@CWC+ 
(CASE	 WHEN @NOPTPENTYPE=2 THEN N' AND ( ( PAY.CREDIT_AMOUNT ) - DBO.FN_ARC_AMOUNT( A.CM_ID ) - DBO.FN_CREDIT_REFUND_AMOUNT( A.CM_ID, '''' ) ) <> 0 '
		 WHEN @NOPTPENTYPE=3 THEN N' AND ( ( PAY.CREDIT_AMOUNT ) - DBO.FN_ARC_AMOUNT( A.CM_ID ) - DBO.FN_CREDIT_REFUND_AMOUNT( A.CM_ID, '''' ) ) = 0 '
		 ELSE '' END)
 
SET @CCMD=N' SELECT ( CASE WHEN A.CANCELLED =0 THEN B.CUSTOMER_FNAME ELSE ''CANCELLED'' END ) AS CUSTOMER_FNAME, 
             ( CASE WHEN A.CANCELLED =0 THEN B.CUSTOMER_LNAME ELSE '''' END ) AS CUSTOMER_LNAME, 
             A.CM_ID, A.CM_DT, A.CM_NO, 
             ( CASE WHEN A.CANCELLED =0 THEN A.NET_AMOUNT ELSE 0 END ) AS NET_AMOUNT, 
             ( CASE WHEN A.CANCELLED =0 THEN A.DISCOUNT_AMOUNT ELSE 0 END ) AS DISCOUNT_AMOUNT, 
             ( CASE WHEN A.CANCELLED =0 THEN 0 ELSE 0 END ) AS AMOUNT_RCVD, 
             ( CASE WHEN A.CANCELLED =0 THEN PAY.CREDIT_AMOUNT ELSE 0 END ) AS [CREDIT_AMOUNT], 
             ( CASE WHEN A.CANCELLED =0 
            		 THEN DBO.FN_ARC_AMOUNT( A.CM_ID ) + DBO.FN_CREDIT_REFUND_AMOUNT( A.CM_ID, '''' ) 
            		 ELSE 0 END ) AS RCV_AMOUNT, 
             ( CASE WHEN A.CANCELLED =0 
             		 THEN ( PAY.CREDIT_AMOUNT ) - DBO.FN_ARC_AMOUNT( A.CM_ID ) - DBO.FN_CREDIT_REFUND_AMOUNT( A.CM_ID, '''' ) 
             		 ELSE 0 END ) AS BAL_AMOUNT, 
             ( CASE WHEN A.CANCELLED =0 THEN A.ATD_CHARGES ELSE 0 END ) AS ATD_CHARGES 
             FROM CMM01106 A 
             JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE
             JOIN VW_BILL_PAYMODE PAY ON A.CM_ID = PAY.MEMO_ID AND PAY.XN_TYPE=''SLS'''
             + @CWC + 
            N' ORDER BY A.CM_DT, A.CM_NO '		 
		 
END
ELSE IF (@NOPTTYPE=5)
BEGIN
DECLARE @CWC1 NVARCHAR(MAX) 
SET @CWC1 =
(CASE	 WHEN @NOPTPENTYPE=2 THEN N' HAVING A.CM_ID NOT IN (SELECT REF_CM_ID FROM CMM01106 WHERE CANCELLED=0) 
                                    AND SUM(C.QUANTITY)<>ISNULL((SELECT SUM(A1.QUANTITY) FROM CMA01106 A1 JOIN CMD01106 B ON B.ROW_ID=A1.CMD_ROW_ID WHERE B.CM_ID=A.CM_ID),0) '
		 WHEN @NOPTPENTYPE=3 THEN N' HAVING (A.CM_ID IN (SELECT REF_CM_ID FROM CMM01106 WHERE CANCELLED=0) 
                                       OR SUM(C.QUANTITY)=ISNULL((SELECT SUM(A1.QUANTITY) FROM CMA01106 A1 JOIN CMD01106 B ON B.ROW_ID=A1.CMD_ROW_ID WHERE B.CM_ID=A.CM_ID),0)) '
		 ELSE '' END)

SET @CCMD=N'SELECT ( CASE WHEN A.CANCELLED =0 THEN B.CUSTOMER_FNAME ELSE ''CANCELLED'' END ) AS CUSTOMER_FNAME, 
					( CASE WHEN A.CANCELLED =0 THEN B.CUSTOMER_LNAME ELSE '''' END ) AS CUSTOMER_LNAME, 
					A.CM_DT, A.CM_NO, A.CM_ID, 
					( CASE WHEN A.CANCELLED =0 THEN A.NET_AMOUNT ELSE 0 END ) AS NET_AMOUNT, 
					( CASE WHEN A.CANCELLED =0 THEN A.DISCOUNT_AMOUNT ELSE 0 END ) AS DISCOUNT_AMOUNT, 
					0 AS AMOUNT_RCVD, 0 AS [CREDIT_AMOUNT], 0 AS RCV_AMOUNT, 0 AS BAL_AMOUNT, 
					A.ATD_CHARGES AS ATD_CHARGES 
					FROM CMM01106 A 
					JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE 
					JOIN CMD01106 C ON A.CM_ID = C.CM_ID 
					JOIN VW_BILL_PAYMODE PAY ON A.CM_ID = PAY.MEMO_ID AND PAY.XN_TYPE=''SLS'''
					+ @CWC +
					N' GROUP BY B.CUSTOMER_FNAME, B.CUSTOMER_LNAME, A.CM_DT, A.CM_NO, A.CM_ID, 
					A.NET_AMOUNT, A.DISCOUNT_AMOUNT,  A.CANCELLED, A.ATD_CHARGES '+
					@CWC1+ N' 
					ORDER BY A.CM_DT, A.CM_NO,B.CUSTOMER_FNAME, B.CUSTOMER_LNAME'


END
ELSE
BEGIN
IF @NOPTTYPE=3
BEGIN
	--SET @CWC =@CWC+ 
	--(CASE	 WHEN @NOPTPENTYPE=2 THEN N' AND PAY.CREDIT_AMOUNT <> 0 AND ( A.REF_CM_ID = '''' OR ( A.REF_CM_ID <> '''' AND REFCM.CM_DT > ''' + @DTTO + ''')) '
	--		 WHEN @NOPTPENTYPE=3 THEN N' AND PAY.CREDIT_AMOUNT <> 0 AND A.REF_CM_ID <> '''' '
	--		 ELSE N'  AND PAY.CREDIT_AMOUNT <> 0 ' END)
			 
--SET @CWC =@CWC+ 
--	(CASE	 WHEN @NOPTPENTYPE=2 THEN N' AND PAY.CREDIT_AMOUNT <> 0 AND ( A.REF_CM_ID = '''' OR (A.REF_CM_ID <> '''' AND REFCM.CM_DT > ''' + @DTTO + ''')) '
--			 WHEN @NOPTPENTYPE=3 THEN N' AND PAY.CREDIT_AMOUNT <> 0 AND A.REF_CM_ID <> '''' '
--			 ELSE N'  AND PAY.CREDIT_AMOUNT <> 0 ' END)	
SET @CWC =@CWC+   
 (CASE  WHEN @NOPTPENTYPE=2 THEN N' AND A.CM_ID NOT IN (SELECT A.CM_ID FROM CMM01106 A
		JOIN PAYMODE_XN_DET B ON B.ADJ_MEMO_ID=A.CM_ID AND B.XN_TYPE=''SLS'' WHERE A.CANCELLED=0)'
    WHEN @NOPTPENTYPE=3 THEN N' AND A.CM_ID IN (SELECT A.CM_ID FROM CMM01106 A
		JOIN PAYMODE_XN_DET B ON B.ADJ_MEMO_ID=A.CM_ID AND B.XN_TYPE=''SLS'' WHERE A.CANCELLED=0)'  
    ELSE N'   ' END)     
		 
END		 
--N'  AND A.CREDIT_AMOUNT <> 0 '		 
SET @CCMD=N'SELECT ( CASE WHEN A.CANCELLED =0 THEN B.CUSTOMER_FNAME ELSE ''CANCELLED'' END ) AS CUSTOMER_FNAME, 
			( CASE WHEN A.CANCELLED =0 THEN B.CUSTOMER_LNAME ELSE '''' END ) AS CUSTOMER_LNAME, 
			A.CM_DT, A.CM_NO, A.CM_ID, 
			( CASE WHEN A.CANCELLED =0 THEN A.NET_AMOUNT ELSE 0 END ) AS NET_AMOUNT, 
			A.DISCOUNT_AMOUNT, 0 AS AMOUNT_RCVD, ( CASE WHEN A.CANCELLED =0 THEN PAY.CREDIT_AMOUNT ELSE 0 END ) AS [CREDIT_AMOUNT], 0 AS RCV_AMOUNT, 0 AS BAL_AMOUNT, 
			A.ATD_CHARGES AS ATD_CHARGES, 
			A.REF_CM_ID, ISNULL(REFCM.CM_DT, A.CM_DT) AS REF_CM_DT 
			FROM CMM01106 A 
			JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE 
			LEFT OUTER JOIN CMM01106 REFCM ON A.REF_CM_ID = REFCM.CM_ID 
			JOIN VW_BILL_PAYMODE PAY ON A.CM_ID = PAY.MEMO_ID AND PAY.XN_TYPE=''SLS'''
			+ @CWC + 
			N'ORDER BY A.CM_DT, A.CM_NO, B.CUSTOMER_FNAME,B.CUSTOMER_LNAME '
				 
END

PRINT @CWC
PRINT @CCMD

EXEC SP_EXECUTESQL @CCMD



END
