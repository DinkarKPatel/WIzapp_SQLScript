CREATE PROCEDURE SP3S_CREATEEXPR_DYNAMICMEMOPRINT
@CXNTYPE VARCHAR(10)='SLS'
AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@CLAYOUTEXPR VARCHAR(MAX),@CJOINEXPR VARCHAR(MAX),@CTABLENAME VARCHAR(1000),
	@CCOLEXPR VARCHAR(1000),@CCOLHEADER VARCHAR(1000),@CTARGETTABLENAME VARCHAR(1000),@CPARENTTABLENAME VARCHAR(1000),
	@CPARENTCOLNAME VARCHAR(1000),@CCHILDCOLNAME VARCHAR(1000),@CERRORMSG VARCHAR(MAX),@CSTEP VARCHAR(5)

BEGIN TRY
	
	IF CURSOR_STATUS('GLOBAL','DYNAMICPRINTCUR') IN (0,1)
	BEGIN
		CLOSE DYNAMICPRINTCUR
		DEALLOCATE DYNAMICPRINTCUR
	END
	
	SET @CERRORMSG = ''
	
	SET @CSTEP = 10
	
	SET @CLAYOUTEXPR=''
	
	DECLARE DYNAMICPRINTCUR CURSOR FOR SELECT TABLE_NAME, COL_EXPR ,COL_HEADER_NAME
	FROM DYNAMICPRINT_COLS 
	
	OPEN DYNAMICPRINTCUR
	FETCH NEXT FROM DYNAMICPRINTCUR INTO @CTABLENAME,@CCOLEXPR,@CCOLHEADER
	
	SET @CSTEP = 20
	
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @CCOLHEADER=(CASE WHEN ISNULL(@CCOLHEADER,'')='' THEN @CCOLEXPR ELSE @CCOLHEADER END)
		
		SET @CLAYOUTEXPR=@CLAYOUTEXPR+(CASE WHEN @CLAYOUTEXPR<>'' THEN ',' ELSE '' END)+
						 (CASE WHEN @CTABLENAME<>'' THEN @CTABLENAME+'.' ELSE '' END)+@CCOLEXPR+' AS '+@CCOLHEADER  	
						 
		
		SET @CSTEP = 30					 
		FETCH NEXT FROM DYNAMICPRINTCUR INTO @CTABLENAME,@CCOLEXPR,@CCOLHEADER	
	END
	
	CLOSE DYNAMICPRINTCUR
	DEALLOCATE DYNAMICPRINTCUR 
	
	
	SET @CSTEP = 40
	SET @CJOINEXPR=''	
	
	DECLARE DYNAMICPRINTCUR CURSOR FOR SELECT TABLE_NAME,PARENT_TABLE_NAME, CHILD_COLNAME, PARENT_COLNAME
	FROM DYNAMICPRINT_TABLES WHERE XN_TYPE=@CXNTYPE AND PARENT_TABLE_NAME<>''
	ORDER BY TABLES_JOIN_ORDER
	
	OPEN DYNAMICPRINTCUR
	FETCH NEXT FROM DYNAMICPRINTCUR INTO @CTABLENAME,@CPARENTTABLENAME,@CCHILDCOLNAME,@CPARENTCOLNAME
	
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @CSTEP = 50
		SET @CJOINEXPR=@CJOINEXPR+ ' JOIN '+@CTABLENAME+' ON '+@CPARENTTABLENAME+'.'+@CPARENTCOLNAME+'='+
					   @CTABLENAME+'.'+	@CCHILDCOLNAME
					   
		FETCH NEXT FROM DYNAMICPRINTCUR INTO @CTABLENAME,@CPARENTTABLENAME,@CCHILDCOLNAME,@CPARENTCOLNAME
	END
	CLOSE DYNAMICPRINTCUR
	DEALLOCATE DYNAMICPRINTCUR 
	
	SET @CSTEP = 60
	UPDATE DYNAMICPRINT_EXPR SET LAYOUT_EXPR=@CLAYOUTEXPR,JOIN_EXPR= @CJOINEXPR WHERE XN_TYPE=@CXNTYPE
	
	GOTO END_PROC
END TRY

BEGIN CATCH
	SELECT @CERRORMSG='PROCEDURE SP3S_MEMOPRINT_DYNAMIC STEP: '+@CSTEP+ ' LINE NO. :'+
	ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
	
	GOTO END_PROC
END CATCH

END_PROC:
	IF ISNULL(@CERRORMSG,'')<>''
		SELECT 	@CERRORMSG AS ERRMSG
END
------ END OF PROCEDURE SP3S_CREATEEXPR_DYNAMICMEMOPRINT
