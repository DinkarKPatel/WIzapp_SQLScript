
CREATE  PROCEDURE SP_JOBWORK_REPORT_PCS_DETAILS  

(  
 @CAGENCY_CODE VARCHAR(MAX)='',  
 @NPENDING INT=0,
 @NSUMMARY INT=0,  -- 1 FOR SUMMARY 2 FOR DETAILS
 @CARTICLE_CODE VARCHAR(10)='',
 @DAS_ON DATETIME=''
)  
AS  
BEGIN  
  
  
     DECLARE @DTSQL NVARCHAR(MAX),@AC_CODE VARCHAR(MAX)  
     IF @CAGENCY_CODE=''  
     BEGIN  
     SET @AC_CODE=''  
     SET @CAGENCY_CODE='IN('''')'  
     END  
     ELSE   
     BEGIN  
     SET @AC_CODE='LATER'  
     END  
    
     IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL  
        DROP TABLE #TMPISSUE  
  
     
     SELECT  CAST('' AS VARCHAR(50)) AS ORDER_ID, CAST('' AS VARCHAR(50)) AS ORDER_NO,A.AGENCY_CODE,
			 SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.ARTICLE_CODE,    
			 AM.AGENCY_NAME,P1.PARA1_NAME,P2.PARA2_NAME,    
			 ART.ARTICLE_NO AS FG_ARTICLE_NO,    
			 ART.ARTICLE_NAME AS FG_ARTICLE_NAME,    
			 B.QUANTITY  AS ISSUE_QTY,
			 A.ISSUE_NO  AS ISSUE_NO,  
			 A.ISSUE_DT  AS ISSUE_DT ,
			 A.ISSUE_ID  AS ISSUE_ID,
			 B.ROW_ID,B.PRODUCT_CODE  ,
			 p3.para3_code ,p3.para3_name 
     INTO #TMPISSUE
     FROM JOBWORK_ISSUE_MST  A (NOLOCK)
     JOIN JOBWORK_ISSUE_DET B ON A.ISSUE_ID =B.ISSUE_ID 
     JOIN PRD_AGENCY_MST AM (NOLOCK) ON A.AGENCY_CODE=AM.AGENCY_CODE 
     JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =B.PRODUCT_CODE 
     JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
     JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE 
     JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE 
     join para3 p3 (nolock) on p3.para3_code =sku.para3_code 
     WHERE A.CANCELLED =0 
     AND 1=2
     
     
     
          
    SET @DTSQL=N' SELECT  CAST('''' AS VARCHAR(50)) AS ORDER_ID, 
             CAST('''' AS VARCHAR(50)) AS ORDER_NO,A.AGENCY_CODE,
			 SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.ARTICLE_CODE,    
			 AM.AGENCY_NAME,P1.PARA1_NAME,P2.PARA2_NAME,    
			 ART.ARTICLE_NO AS FG_ARTICLE_NO,    
			 ART.ARTICLE_NAME AS FG_ARTICLE_NAME,    
			 B.QUANTITY  AS ISSUE_QTY,
			 A.ISSUE_NO  AS ISSUE_NO,  
			 A.ISSUE_DT  AS ISSUE_DT ,
			 A.ISSUE_ID  AS ISSUE_ID,
			 B.ROW_ID,B.PRODUCT_CODE  ,
			 P3.PARA3_CODE,P3.PARA3_NAME
     FROM JOBWORK_ISSUE_MST  A (NOLOCK)
     JOIN JOBWORK_ISSUE_DET B ON A.ISSUE_ID =B.ISSUE_ID 
     JOIN PRD_AGENCY_MST AM (NOLOCK) ON A.AGENCY_CODE=AM.AGENCY_CODE 
     JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =B.PRODUCT_CODE 
     JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
     JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE 
     JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE 
     join para3 p3 (nolock) on p3.para3_code =sku.para3_code 
     WHERE A.CANCELLED =0 
     AND  ('''+@AC_CODE+'''='''' OR AM.AC_CODE  '+@CAGENCY_CODE+' )  
     AND ('''+@CARTICLE_CODE+'''='''' OR SKU.ARTICLE_CODE='''+@CARTICLE_CODE+''')  
     AND ('''+CONVERT(VARCHAR(10), @DAS_ON,121)+'''=''1900-01-01'' OR A.ISSUE_DT<='''+CONVERT(VARCHAR(10), @DAS_ON,121)+''')      
    '
     
     PRINT @DTSQL  
     INSERT INTO #TMPISSUE  
     EXEC SP_EXECUTESQL @DTSQL  
     
      
	   UPDATE A SET ORDER_NO=MST.MEMO_NO  ,ORDER_ID =MST.MEMO_ID --(as discuss with arun sir & surendra display jow work no)
	   FROM #TMPISSUE A     
	   JOIN
	  (
		SELECT C.PRODUCT_CODE,A.MEMO_NO,A.MEMO_DT,a.memo_id,
			   ISNULL(BM.ORDER_NO,'''') AS  ORDER_NO,
			   ISNULL(BM.ORDER_DT,'''') AS  ORDER_DT,
			   ISNULL(BM.ORDER_ID,'''') AS  ORDER_ID
		FROM ORD_PLAN_MST A (NOLOCK)
		JOIN ORD_PLAN_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
		JOIN ORD_PLAN_BARCODE_DET C (NOLOCK) ON B.ROW_ID=C.REFROW_ID
		LEFT JOIN BUYER_ORDER_DET BD (NOLOCK) ON BD.ROW_ID=WOD_ROW_ID
		LEFT JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID=BD.ORDER_ID
		WHERE A.CANCELLED=0 AND ISNULL(BM.CANCELLED,0)=0
	  ) MST ON A.PRODUCT_CODE=MST.PRODUCT_CODE
	  LEFT OUTER JOIN JOBWORK_PMT UPC ON UPC.PRODUCT_CODE =A.PRODUCT_CODE 
	  LEFT OUTER JOIN BUYER_ORDER_MST BO ON BO.ORDER_ID= ISNULL(UPC.ORDER_ID ,MST.ORDER_ID )     
	
	
	IF OBJECT_ID ('TEMPDB..#TMPISSUE_REC','U') IS NOT NULL
	   DROP TABLE #TMPISSUE_REC
	       
	 SELECT A.ORDER_ID ,A.ORDER_NO ,A.ARTICLE_CODE ,A.FG_ARTICLE_NO,A.FG_ARTICLE_NAME ,
            A.PARA1_CODE ,A.PARA1_NAME ,A.PARA2_CODE ,A.PARA2_NAME ,
            a.para3_code,a.para3_name ,
            A.AGENCY_NAME,A.AGENCY_CODE ,
            A.ISSUE_ID,A.ISSUE_NO ,A.ISSUE_DT ,A.ISSUE_QTY ,
           ISNULL(B.RECEIPT_NO,'') AS RECEIVE_NO,ISNULL(B.RECEIPT_DT,'') AS RECEIVE_DT, ISNULL(B.REC_QTY,0) AS REC_QTY,
           SR=ROW_NUMBER() OVER(PARTITION BY A.ORDER_ID ,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.ISSUE_ID
           ORDER BY A.ORDER_ID ,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.ISSUE_ID,ISNULL(RECEIPT_ID,''),ISNULL(RECEIPT_DT ,''))
     INTO #TMPISSUE_REC
     FROM
	 ( 
     SELECT ISNULL(A.ORDER_ID,'') AS  ORDER_ID,ISNULL(A.ORDER_NO,'') AS ORDER_NO ,A.ARTICLE_CODE ,
            A.FG_ARTICLE_NO,A.FG_ARTICLE_NAME ,
            A.PARA1_CODE ,A.PARA1_NAME ,A.PARA2_CODE ,A.PARA2_NAME ,
            a.para3_code ,a.para3_name ,
            A.ISSUE_ID,A.ISSUE_NO ,A.ISSUE_DT ,A.AGENCY_NAME,A.AGENCY_CODE ,
            SUM(A.ISSUE_QTY) AS  ISSUE_QTY
     FROM #TMPISSUE A
     GROUP BY ISNULL(A.ORDER_ID,'') ,ISNULL(A.ORDER_NO,'') ,A.ARTICLE_CODE ,A.FG_ARTICLE_NO,A.FG_ARTICLE_NAME ,
     A.PARA1_CODE ,A.PARA1_NAME ,A.PARA2_CODE ,A.PARA2_NAME ,a.para3_code ,a.para3_name ,
     A.ISSUE_ID,A.ISSUE_NO ,A.ISSUE_DT,A.AGENCY_NAME,A.AGENCY_CODE
     ) A
     LEFT JOIN
     (
       SELECT ISNULL(A.ORDER_ID,'') AS  ORDER_ID,
              A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE ,A.ISSUE_ID,
              C.RECEIPT_NO ,C.RECEIPT_DT ,C.receipt_id ,
              SUM(B.QUANTITY) AS REC_QTY
       FROM #TMPISSUE A
       JOIN JOBWORK_RECEIPT_DET B (NOLOCK) ON A.ROW_ID =B.REF_ROW_ID 
       JOIN JOBWORK_RECEIPT_MST C (NOLOCK) ON B.RECEIPT_ID =C.RECEIPT_ID 
       WHERE ISNULL(C.CANCELLED,0)=0
       GROUP BY ISNULL(A.ORDER_ID,''),A.ARTICLE_CODE ,A.PARA1_CODE ,A.PARA2_CODE ,A.ISSUE_ID ,
       C.RECEIPT_NO ,C.RECEIPT_DT,C.receipt_id 
     
     ) B ON A.ORDER_ID =B.ORDER_ID AND A.ARTICLE_CODE =B.ARTICLE_CODE AND A.PARA1_CODE =B.PARA1_CODE 
     AND A.PARA2_CODE =B.PARA2_CODE AND A.ISSUE_ID =B.ISSUE_ID 
     
     
     
     IF OBJECT_ID('TEMPDB..#TMPFINAL','U') IS NOT NULL
    DROP TABLE #TMPFINAL
 
   SELECT A.ORDER_ID,A.ORDER_NO,
          A.AGENCY_NAME,A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME, A.PARA1_NAME AS FG_COLOR, 
          A.PARA2_NAME AS FG_SIZE, 
          A.para3_NAME AS MISC,
          A.ISSUE_ID,A.ISSUE_NO,
          A.ISSUE_DT ,A.SR,
          CASE WHEN A.SR=1 THEN  A.ISSUE_QTY ELSE 0 END AS ISSUE_QTY,
          ISNULL(A.RECEIVE_NO,'') AS RECEIVE_NO,
          ISNULL(A.RECEIVE_DT,'') AS  RECEIVE_DT,
          ISNULL(A.REC_QTY,0) AS  REC_QTY,
          SUM(B.REC_QTY ) AS CUMM_REC,
          A.ISSUE_QTY-SUM(ISNULL(B.REC_QTY,0)) AS PENDING_QTY 
   INTO #TMPFINAL 
   FROM #TMPISSUE_REC A
   JOIN #TMPISSUE_REC B ON A.ISSUE_ID=B.ISSUE_ID AND  A.ORDER_ID=B.ORDER_ID AND a.article_code=b.article_code and  A.PARA1_CODE =B.PARA1_CODE AND A.PARA2_CODE =B.PARA2_CODE AND  B.SR<=A.SR
   GROUP BY A.ORDER_ID,
          A.ORDER_NO,A.AGENCY_CODE,A.AGENCY_NAME,A.PARA1_CODE,A.PARA1_NAME,
          A.PARA2_CODE,A.PARA2_NAME,a.para3_name ,
          A.ARTICLE_CODE,A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME,A.ISSUE_ID,A.ISSUE_NO,A.ISSUE_DT ,
          A.ISSUE_QTY,A.RECEIVE_NO,A.RECEIVE_DT ,A.REC_QTY,A.SR,
          CASE WHEN A.SR=1 THEN  A.ISSUE_QTY ELSE 0 END
   ORDER BY A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID,A.SR
       
       
       
   IF ISNULL(@NPENDING,0)=1
	BEGIN   
	 
	 DELETE A FROM #TMPFINAL A
	 JOIN
	 (
	 SELECT A.* FROM #TMPFINAL A
	 JOIN
	 (
	 SELECT  A.AGENCY_NAME, A.FG_COLOR,A.FG_SIZE,A.FG_ARTICLE_NO ,A.ORDER_ID,A.ISSUE_ID,MAX(SR)AS SR
	 FROM #TMPFINAL A 
	 GROUP BY  A.AGENCY_NAME, A.FG_COLOR,A.FG_SIZE,A.FG_ARTICLE_NO ,A.ORDER_ID,A.ISSUE_ID
	 ) B ON A.AGENCY_NAME=B.AGENCY_NAME 
	 AND  A.FG_COLOR=B.FG_COLOR 
	 AND A.FG_SIZE=B.FG_SIZE
	 AND A.FG_ARTICLE_NO=B. FG_ARTICLE_NO
	 AND A.ORDER_ID=B.ORDER_ID
	 AND A.ISSUE_ID=B.ISSUE_ID
	 AND A.SR=B.SR AND A.PENDING_QTY=0
	 ) B 
	 ON A.AGENCY_NAME=B.AGENCY_NAME 
	 AND  A.FG_COLOR=B.FG_COLOR 
	 AND A.FG_SIZE=B.FG_SIZE
	 AND A.FG_ARTICLE_NO=B. FG_ARTICLE_NO
	 AND A.ORDER_ID=B.ORDER_ID
	 AND A.ISSUE_ID=B.ISSUE_ID
   
   
    END
     
      
	  SELECT A.ORDER_ID,A.ORDER_NO,A.AGENCY_NAME,
          A.FG_ARTICLE_NO,A.FG_ARTICLE_NAME, A. FG_COLOR, 
          A. FG_SIZE, a.MISC ,
          A.ISSUE_ID,A.ISSUE_NO,A.ISSUE_DT ,
          A.SR,CASE WHEN A.SR=1 THEN  A.ISSUE_QTY ELSE 0 END AS ISSUE_QTY,
          ISNULL(A.RECEIVE_NO,'') AS RECEIVE_NO,
          ISNULL(A.RECEIVE_DT,'') AS  RECEIVE_DT,
          ISNULL(A.REC_QTY,0) AS  REC_QTY,
          CUMM_REC AS CUMM_REC,
          PENDING_QTY AS PENDING_QTY  
      FROM #TMPFINAL A
      ORDER BY A.AGENCY_NAME,a.issue_dt, A.ISSUE_ID  ,   A. FG_COLOR,A.SR
  
END

