CREATE PROCEDURE SP_PRD_AGENCY_RE_RECEIPT
(
 @NQUERTID INT,
 @DFM_DT DATETIME,
 @DTODT DATETIME,
 @CAGENCY_CODE VARCHAR(100)='',
 @CMEMO_ID VARCHAR(100)='',
 @CWHERE VARCHAR(MAX)=''

)
AS
BEGIN
     DECLARE @CCMD NVARCHAR(MAX)
IF @NQUERTID=1
GOTO LBLMASTER
ELSE 
IF @NQUERTID=2
GOTO LBLDETAILS
ELSE
IF @NQUERTID=3
GOTO LBLSUBDETAILS
ELSE
IF @NQUERTID=4
GOTO LBLAPPLU

LBLMASTER:
 
	 SELECT A.*,B.AGENCY_NAME AS AGENCY_NAME 
	 FROM PRD_AGENCY_RE_RECEIPT_MST A
	 JOIN PRD_AGENCY_MST B ON A.AGENCY_CODE=B.AGENCY_CODE
	 WHERE A.MEMO_ID=@CMEMO_ID
 
GOTO END_PROC

LBLDETAILS:
    
    IF OBJECT_ID('TEMPDB..#TMPRE_REC','U') IS NOT NULL
       DROP TABLE #TMPRE_REC
       
	SELECT A.MEMO_NO,A.MEMO_DT,A.MEMO_ID,B.ROW_ID,B.QUANTITY,ISNULL(C.QUANTITY ,0) AS RE_REC_QTY
	INTO #TMPRE_REC
	FROM PRD_AGENCY_RE_ISSUE_MST A
	JOIN PRD_AGENCY_RE_ISSUE_DET B ON A.MEMO_ID=B.MEMO_ID
	LEFT OUTER JOIN
	(
	 SELECT REF_ROW_ID,SUM(B.QUANTITY) AS  QUANTITY
	 FROM PRD_AGENCY_RE_RECEIPT_MST A
	 JOIN PRD_AGENCY_RE_RECEIPT_DET B ON A.MEMO_ID=B.MEMO_ID
	 WHERE A.CANCELLED=0 
	 GROUP BY REF_ROW_ID
	) C ON  B.ROW_ID=C.REF_ROW_ID
	WHERE A.CANCELLED=0 AND A.REF_AGENCY_CODE=@CAGENCY_CODE 
	AND A.MEMO_DT BETWEEN @DFM_DT AND @DTODT
    AND B.QUANTITY-ISNULL(C.QUANTITY ,0)>0
    
    
    SELECT CAST(0  AS INT) AS CHK, A.MEMO_NO AS ISSUE_NO,A.MEMO_DT AS ISSUE_DT,A.MEMO_ID AS ISSUE_ID
    FROM #TMPRE_REC A
    GROUP BY A.MEMO_NO,A.MEMO_DT,A.MEMO_ID
    ORDER BY A.MEMO_NO,A.MEMO_DT,A.MEMO_ID
    
    
    
GOTO END_PROC

LBLSUBDETAILS:
     
     IF @CMEMO_ID=''
     BEGIN
	 SELECT CAST(0 AS BIT) AS CHK,
	        CAST('LATER' AS VARCHAR(100)) AS MEMO_ID,
	        B.QUANTITY AS ISSUE_QTY,
	        ISNULL(C.QUANTITY,0) AS ALREADY_REC_QTY,
	        B.QUANTITY-ISNULL(C.QUANTITY,0) AS QUANTITY,
	        ROW_ID=CAST('LATER'+CAST(NEWID() AS VARCHAR(100)) AS VARCHAR(40)),
            B.ROW_ID AS REF_ROW_ID,
            LAST_UPDATE=GETDATE(),
			B.PRODUCT_UID AS PRODUCT_UID,
			B.PRODUCT_CODE,
			B.REF_REC_ID AS RECEIPT_ID,
			A.MEMO_ID AS ISSUE_ID
	 FROM PRD_AGENCY_RE_ISSUE_MST A
	 JOIN PRD_AGENCY_RE_ISSUE_DET B ON A.MEMO_ID=B.MEMO_ID
	 LEFT OUTER JOIN
	 (
	 SELECT REF_ROW_ID,SUM(B.QUANTITY) AS  QUANTITY
	 FROM PRD_AGENCY_RE_RECEIPT_MST A
	 JOIN PRD_AGENCY_RE_RECEIPT_DET B ON A.MEMO_ID=B.MEMO_ID
	 WHERE A.CANCELLED=0 
	 GROUP BY REF_ROW_ID
	 ) C ON  B.ROW_ID=C.REF_ROW_ID
	 WHERE A.CANCELLED=0 AND A.REF_AGENCY_CODE=@CAGENCY_CODE 
	 AND A.MEMO_DT BETWEEN @DFM_DT AND @DTODT
     AND B.QUANTITY-ISNULL(C.QUANTITY ,0)>0
	END
	ELSE
	BEGIN
	

	  SELECT CAST(0 AS BIT) AS CHK,
			B.PRODUCT_UID AS PRODUCT_UID,
			B.QUANTITY AS ISSUE_QTY,
			B.QUANTITY AS ALREADY_REC_QTY,
			B.QUANTITY AS QUANTITY,
			B.ROW_ID,
			A.LAST_UPDATE,
			A.MEMO_ID,
			D.PRODUCT_CODE,
			D.REF_REC_ID AS RECEIPT_ID,
			A.MEMO_ID AS ISSUE_ID
	  FROM PRD_AGENCY_RE_RECEIPT_MST A
	  JOIN PRD_AGENCY_RE_RECEIPT_DET B ON A.MEMO_ID=B.MEMO_ID
	  JOIN PRD_AGENCY_RE_ISSUE_DET D ON B.REF_ROW_ID=D.ROW_ID 
	  JOIN PRD_AGENCY_RE_ISSUE_MST E ON E.MEMO_ID=D.MEMO_ID
	  WHERE  A.MEMO_ID=@CMEMO_ID
	
	END
	
	
	
GOTO END_PROC
LBLAPPLU:                        
	SET @CCMD=N'SELECT MEMO_ID,MEMO_NO FROM PRD_AGENCY_RE_RECEIPT_MST '+(CASE WHEN ISNULL(@CWHERE,'')='' THEN ''                  
	 ELSE ' WHERE '+@CWHERE END)                 
	 SET @CCMD=@CCMD+' ORDER BY PRD_AGENCY_RE_RECEIPT_MST.MEMO_DT'                     
	                  
	PRINT @CCMD                  
	EXEC SP_EXECUTESQL @CCMD                   
GOTO END_PROC  

END_PROC:

END
