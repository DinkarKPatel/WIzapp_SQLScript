CREATE PROCEDURE [DBO].[SP_IMAGE_INFO_GET]    
(  
  @PRODUCT_CODE  VARCHAR(100)=''
 ,@ARTICLE_CODE  VARCHAR(100)='00000000 '    
 ,@PARA1_CODE    VARCHAR(100)='0000000  '
 ,@PARA2_CODE    VARCHAR(100)='0000000  '
 ,@PARA3_CODE	 VARCHAR(100)='0000000  '
 ,@PARA4_CODE    VARCHAR(100)='0000000  '    
 ,@PARA5_CODE    VARCHAR(100)='0000000  '
 ,@PARA6_CODE    VARCHAR(100)='0000000  ' 
 ,@bFromRepair	BIT=0
 ,@cMemoID	VARCHAR(50)=''
)    
AS    
  BEGIN    
    --DECLARE LOCAL VARIABLE    
    DECLARE @SECTION BIT,@SUB_SECTION BIT,@ARTICLE BIT,@PARA1 BIT    
    ,@PARA2 BIT,@PARA3 BIT,@PARA4 BIT,@PARA5 BIT,@PARA6 BIT    
    ,@PRODUCT BIT,@CSTR NVARCHAR(MAX),@DTSQLWHERE NVARCHAR(MAX)    
    ,@DTSQLSELECT NVARCHAR(MAX)    
    ,@SECTION_CODE  VARCHAR(100)
    ,@SUB_SECTION_CODE  VARCHAR(100)

	DECLARE @cIMGID	NVARCHAR(MAX)=''    
        
    ---SET VALE INTO LOCAL VARIABLE    
    SELECT @SECTION=SECTION,@SUB_SECTION=SUB_SECTION,@ARTICLE=ARTICLE    
    ,@PARA1=PARA1,@PARA2 = PARA2,@PARA3 = PARA3,@PARA4 = PARA4    
    ,@PARA5 = PARA5 , @PARA6 = PARA6, @PRODUCT = PRODUCT    
    FROM DBO.IMAGE_INFO_CONFIG WITH(NOLOCK)     
      
	  

	IF NOT EXISTS(SELECT NAME FROM SYS.DATABASES WHERE NAME =DB_NAME()+'_IMAGE')
	BEGIN
		SELECT '' AS IMG_ID  WHERE 1=2
		RETURN
	END


    ---SET VALUE FOR LOCAL VARIABLE TO FOR FILTER DATA    
	IF ISNULL(@PRODUCT_CODE,'')<>''
	BEGIN
		SELECT @cIMGID=barcode_img_id FROM SKU_NAMES (NOLOCK) WHERE product_Code=@PRODUCT_CODE

		SET @CSTR=N' SELECT '''' AS IMAGE_NAME,'''' AS IMAGE_SUBFOLDER,PROD_IMAGE   
		FROM '+DB_NAME()+'_IMAGE.DBO.IMAGE_INFO  (NOLOCK)
		WHERE  LEN(PROD_IMAGE)>100 AND  IMG_ID='''+ ISNULL(@cIMGID,'') +''''    
		PRINT @CSTR     
		EXEC SP_EXECUTESQL @CSTR
		
		RETURN

		--SELECT --@SECTION_CODE = D.SECTION_CODE,@SUB_SECTION_CODE = AC.SUB_SECTION_CODE,
		--@ARTICLE_CODE = A.ARTICLE_CODE, @PARA1_CODE= A.PARA1_CODE, @PARA2_CODE= A.PARA2_CODE    
		--, @PARA3_CODE= A.PARA3_CODE, @PARA4_CODE= A.PARA4_CODE, @PARA5_CODE= A.PARA5_CODE    
		--, @PARA6_CODE= A.PARA6_CODE    
		--FROM DBO.SKU A WITH(NOLOCK)     
		--JOIN DBO.ARTICLE AC WITH(NOLOCK) ON A.ARTICLE_CODE = AC.ARTICLE_CODE    
		----JOIN SECTIOND D WITH(NOLOCK) ON D.SUB_SECTION_CODE = AC.SUB_SECTION_CODE    
		--WHERE A.PRODUCT_CODE= @PRODUCT_CODE    
	END

	IF ISNULL(@cMemoID,'')<>''
	BEGIN
		SELECT @cIMGID=barcode_img_id FROM SKU_NAMES (NOLOCK) WHERE product_Code=@PRODUCT_CODE

		SET @CSTR=N' SELECT '''' AS IMAGE_NAME,'''' AS IMAGE_SUBFOLDER,PROD_IMAGE ,B.product_code  
		FROM '+DB_NAME()+'_IMAGE.DBO.IMAGE_INFO A (NOLOCK)
		JOIN SKU_NAMES B (NOLOCK) ON B.barcode_img_id =A.IMG_ID
		JOIN CMD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
		WHERE  LEN(PROD_IMAGE)>100 AND  C.CM_ID='''+ ISNULL(@cMemoID,'') +'''
		ORDER BY C.SR_NO'    
		PRINT @CSTR     
		EXEC SP_EXECUTESQL @CSTR
		
		RETURN

		--SELECT --@SECTION_CODE = D.SECTION_CODE,@SUB_SECTION_CODE = AC.SUB_SECTION_CODE,
		--@ARTICLE_CODE = A.ARTICLE_CODE, @PARA1_CODE= A.PARA1_CODE, @PARA2_CODE= A.PARA2_CODE    
		--, @PARA3_CODE= A.PARA3_CODE, @PARA4_CODE= A.PARA4_CODE, @PARA5_CODE= A.PARA5_CODE    
		--, @PARA6_CODE= A.PARA6_CODE    
		--FROM DBO.SKU A WITH(NOLOCK)     
		--JOIN DBO.ARTICLE AC WITH(NOLOCK) ON A.ARTICLE_CODE = AC.ARTICLE_CODE    
		----JOIN SECTIOND D WITH(NOLOCK) ON D.SUB_SECTION_CODE = AC.SUB_SECTION_CODE    
		--WHERE A.PRODUCT_CODE= @PRODUCT_CODE    
	END
        
    SET @DTSQLWHERE= ''    
    SET @DTSQLSELECT = ''    
        
    -- IF ISNULL(@SECTION,0) = 1    
    --BEGIN    
    --   SET @DTSQLWHERE = ' AND ISNULL(SECTION_CODE,'''') = '''+LTRIM(RTRIM(@SECTION_CODE))+''' '    
    --END    
        
    --IF ISNULL(@SUB_SECTION,0) = 1    
    --BEGIN    
    --   SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(SUB_SECTION_CODE,'''') = '''+LTRIM(RTRIM(@SUB_SECTION_CODE))+''' '    
    --END    
     IF ISNULL(@PRODUCT,0) <> 1 AND @bFromRepair=0   
     BEGIN
    IF ISNULL(@ARTICLE,0) = 1    
    BEGIN    
       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(ARTICLE_CODE,'''') = '''+LTRIM(RTRIM(@ARTICLE_CODE))+''''    
    END    
        
    IF ISNULL(@PARA1,0) = 1    
    BEGIN    
       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA1_CODE,'''') = '''+LTRIM(RTRIM(@PARA1_CODE))+''''    
    END    
        
    IF ISNULL(@PARA2,0) = 1    
    BEGIN    
       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA2_CODE,'''') = '''+LTRIM(RTRIM(@PARA2_CODE))+''''    
    END    
        
    IF ISNULL(@PARA3,0) = 1    
    BEGIN    
       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA3_CODE,'''') = '''+LTRIM(RTRIM(@PARA3_CODE))+''' '    
    END    
        
    IF ISNULL(@PARA4,0) = 1    
    BEGIN    
       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA4_CODE,'''') = '''+LTRIM(RTRIM(@PARA4_CODE))+''''    
    END    
        
    IF ISNULL(@PARA5,0) = 1    
    BEGIN    
       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA5_CODE,'''') = '''+LTRIM(RTRIM(@PARA5_CODE))+''' '    
    END    
       
    IF ISNULL(@PARA6,0) = 1    
    BEGIN    
       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA6_CODE,'''') = '''+LTRIM(RTRIM(@PARA6_CODE))+''''    
    END    
    END
    ELSE
    --IF ISNULL(@PRODUCT,0) = 1  OR ISNULL(@DTSQLWHERE,'')=''
    BEGIN    
       SET @DTSQLWHERE = CASE WHEN LTRIM(RTRIM(@PRODUCT_CODE))='' THEN '' ELSE ' AND PRODUCT_CODE = '''+LTRIM(RTRIM(@PRODUCT_CODE))+''''    END
    END    

    
    IF LEN(@DTSQLWHERE) > 0    
    BEGIN 
	
       SET @CSTR=N' SELECT @cIMGID=IMG_ID  
		 FROM '+DB_NAME()+'_IMAGE.DBO.IMAGE_INFO  (NOLOCK)
		 WHERE '''' <> '''+(CASE WHEN ISNULL(@DTSQLWHERE,'')<>'' THEN '1' ELSE '' END) +''' ' +@DTSQLWHERE+'  '     
       PRINT @CSTR     
       EXEC SP_EXECUTESQL @CSTR  ,N'@cIMGID NVARCHAR(MAX) OUTPUT'  ,@cIMGID=@cIMGID OUTPUT

	   --SET @CSTR=N' SELECT '''' AS IMAGE_NAME,'''' AS IMAGE_SUBFOLDER,PROD_IMAGE   
    -- FROM '+DB_NAME()+'_IMAGE.DBO.IMAGE_INFO  (NOLOCK)
    -- WHERE  LEN(PROD_IMAGE)>100 AND  IMG_ID='''+ @cIMGID+''''    
    --   PRINT @CSTR     
    --   EXEC SP_EXECUTESQL @CSTR 

    END   
	ELSE IF ISNULL(@PRODUCT_CODE,'')='' and ISNULL(@PRODUCT,0) = 1
	begin
	    

		 SET @CSTR=N' SELECT TOP 1  @cIMGID=IMG_ID  
		 FROM '+DB_NAME()+'_IMAGE.DBO.IMAGE_INFO B WITH(NOLOCK) 
		 --JOIN SKU A (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
		 WHERE  B.ARTICLE_CODE ='''+@ARTICLE_CODE+''' 
		 AND ('''+@PARA1_CODE+'''=''0000000'' OR  B.PARA1_CODE ='''+@PARA1_CODE+''' )
		 AND ('''+@PARA2_CODE+'''=''0000000  '' OR  B.PARA2_CODE ='''+@PARA2_CODE+''' ) 
		 AND ('''+@PARA3_CODE+'''=''0000000  '' OR  B.PARA3_CODE ='''+@PARA3_CODE+''' ) 
		 AND ('''+@PARA4_CODE+'''=''0000000  '' OR  B.PARA4_CODE ='''+@PARA4_CODE+''' ) 
		 AND ('''+@PARA5_CODE+'''=''0000000  '' OR  B.PARA5_CODE ='''+@PARA5_CODE+''' ) 
		 AND ('''+@PARA6_CODE+'''=''0000000  '' OR  B.PARA6_CODE ='''+@PARA6_CODE+''' ) 
		 '     
		 PRINT @CSTR     
         EXEC SP_EXECUTESQL @CSTR   ,N'@cIMGID NVARCHAR(MAX) OUTPUT'  ,@cIMGID=@cIMGID OUTPUT
		 
		 --SET @CSTR=N' SELECT '''' AS IMAGE_NAME,'''' AS IMAGE_SUBFOLDER,PROD_IMAGE   
		 --FROM '+DB_NAME()+'_IMAGE.DBO.IMAGE_INFO  (NOLOCK)
		 --WHERE  LEN(PROD_IMAGE)>100 AND  IMG_ID='''+ @cIMGID+''''    
   --    PRINT @CSTR     
   --    EXEC SP_EXECUTESQL @CSTR 
    END   
    --ELSE    
    --   SELECT '' AS IMAGE_NAME,'' AS IMAGE_SUBFOLDER, NULL   AS PROD_IMAGE  
	SET @CSTR=N' SELECT '''' AS IMAGE_NAME,'''' AS IMAGE_SUBFOLDER,PROD_IMAGE   
	FROM '+DB_NAME()+'_IMAGE.DBO.IMAGE_INFO  (NOLOCK)
	WHERE  LEN(PROD_IMAGE)>100 AND  IMG_ID='''+ ISNULL(@cIMGID,'') +''''    
	PRINT @CSTR     
	EXEC SP_EXECUTESQL @CSTR     
        
        
  END  
--CREATE PROCEDURE [DBO].[SP_IMAGE_INFO_GET]  
--(
--	@PRODUCT_CODE VARCHAR(100)
--)  
--AS  
--  BEGIN  
--    --DECLARE LOCAL VARIABLE  
--    DECLARE @SECTION BIT,@SUB_SECTION BIT,@ARTICLE BIT,@PARA1 BIT  
--    ,@PARA2 BIT,@PARA3 BIT,@PARA4 BIT,@PARA5 BIT,@PARA6 BIT  
--    ,@PRODUCT BIT,@CSTR NVARCHAR(MAX),@DTSQLWHERE NVARCHAR(MAX)  
--    ,@DTSQLSELECT NVARCHAR(MAX)  
--    ,@SECTION_CODE  VARCHAR(100),@SUB_SECTION_CODE  VARCHAR(100),@ARTICLE_CODE  VARCHAR(100)  
--    ,@PARA1_CODE  VARCHAR(100),@PARA2_CODE  VARCHAR(100),@PARA3_CODE  VARCHAR(100),@PARA4_CODE  VARCHAR(100)  
--    ,@PARA5_CODE  VARCHAR(100),@PARA6_CODE  VARCHAR(100)  
      
--    ---SET VALE INTO LOCAL VARIABLE  
--    SELECT @SECTION=SECTION,@SUB_SECTION=SUB_SECTION,@ARTICLE=ARTICLE  
--    ,@PARA1=PARA1,@PARA2 = PARA2,@PARA3 = PARA3,@PARA4 = PARA4  
--    ,@PARA5 = PARA5 , @PARA6 = PARA6, @PRODUCT = PRODUCT  
--    FROM DBO.IMAGE_INFO_CONFIG WITH(NOLOCK)   
      
--    ---SET VALUE FOR LOCAL VARIABLE TO FOR FILTER DATA  
     
--    SELECT @SECTION_CODE = D.SECTION_CODE,@SUB_SECTION_CODE = AC.SUB_SECTION_CODE   
--    ,@ARTICLE_CODE = A.ARTICLE_CODE, @PARA1_CODE= A.PARA1_CODE, @PARA2_CODE= A.PARA2_CODE  
--    , @PARA3_CODE= A.PARA3_CODE, @PARA4_CODE= A.PARA4_CODE, @PARA5_CODE= A.PARA5_CODE  
--    , @PARA6_CODE= A.PARA6_CODE  
--    FROM DBO.SKU A WITH(NOLOCK)   
--    JOIN DBO.ARTICLE AC WITH(NOLOCK) ON A.ARTICLE_CODE = AC.ARTICLE_CODE  
--    JOIN SECTIOND D WITH(NOLOCK) ON D.SUB_SECTION_CODE = AC.SUB_SECTION_CODE  
--    WHERE A.PRODUCT_CODE= @PRODUCT_CODE  
       
      
--    SET @DTSQLWHERE= ''  
--    SET @DTSQLSELECT = ''  
      
--     IF ISNULL(@SECTION,0) = 1  
--    BEGIN  
--       SET @DTSQLWHERE = ' AND ISNULL(SECTION_CODE,'''') = '''+LTRIM(RTRIM(@SECTION_CODE))+''' '  
--    END  
      
--    IF ISNULL(@SUB_SECTION,0) = 1  
--    BEGIN  
--       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(SUB_SECTION_CODE,'''') = '''+LTRIM(RTRIM(@SUB_SECTION_CODE))+''' '  
--    END  
      
--    IF ISNULL(@ARTICLE,0) = 1  
--    BEGIN  
--       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(ARTICLE_CODE,'''') = '''+LTRIM(RTRIM(@ARTICLE_CODE))+''''  
--    END  
      
--    IF ISNULL(@PARA1,0) = 1  
--    BEGIN  
--       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA1_CODE,'''') = '''+LTRIM(RTRIM(@PARA1_CODE))+''''  
--    END  
      
--    IF ISNULL(@PARA2,0) = 1  
--    BEGIN  
--       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA2_CODE,'''') = '''+LTRIM(RTRIM(@PARA2_CODE))+''''  
--    END  
      
--    IF ISNULL(@PARA3,0) = 1  
--    BEGIN  
--       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA3_CODE,'''') = '''+LTRIM(RTRIM(@PARA3_CODE))+''' '  
--    END  
      
--    IF ISNULL(@PARA4,0) = 1  
--    BEGIN  
--       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA4_CODE,'''') = '''+LTRIM(RTRIM(@PARA4_CODE))+''''  
--    END  
      
--    IF ISNULL(@PARA5,0) = 1  
--    BEGIN  
--       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA5_CODE,'''') = '''+LTRIM(RTRIM(@PARA5_CODE))+''' '  
--    END  
     
--    IF ISNULL(@PARA6,0) = 1  
--    BEGIN  
--       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PARA6_CODE,'''') = '''+LTRIM(RTRIM(@PARA6_CODE))+''''  
--    END  
      
--    IF ISNULL(@PRODUCT,0) = 1  
--    BEGIN  
--       SET @DTSQLWHERE = @DTSQLWHERE+' AND ISNULL(PRODUCT_CODE,'''') = '''+LTRIM(RTRIM(@PRODUCT_CODE))+''''  
--    END  
      
--    IF LEN(@DTSQLWHERE) > 0  
--    BEGIN  
--       SET @CSTR=N'	SELECT '''' AS IMAGE_NAME,'''' AS IMAGE_SUBFOLDER,PROD_IMAGE 
--					FROM '+DB_NAME()+'_IMAGE.DBO.IMAGE_INFO WITH(NOLOCK)   
--					WHERE '''' <> '''+@PRODUCT_CODE +''' ' +@DTSQLWHERE+'  '   
--       PRINT @CSTR   
--       EXEC SP_EXECUTESQL @CSTR  
--    END  
--    ELSE  
--       SELECT '' AS IMAGE_NAME,'' AS IMAGE_SUBFOLDER, NULL   AS PROD_IMAGE
      
      
      
--  END
