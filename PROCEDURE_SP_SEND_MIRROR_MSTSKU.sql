CREATE PROCEDURE SP_SEND_MIRROR_MSTSKU
(
@CTARGETLOCID VARCHAR(5)=''
)
--WITH ENCRYPTION
AS
BEGIN

    DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10)
           ,@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100)
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CCURDEPTID VARCHAR(5),@CTMP_TABLENAME VARCHAR(100)
           ,@CHODEPTID VARCHAR(5),@CERRORMSG VARCHAR(MAX),@NLOCTYPE INT,@CFILTERCONDITION VARCHAR(200)
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(2),@STATE_CODE CHAR(7),@CMEMOID CHAR(22),@CKEYFIELD VARCHAR(200)
           ,@NSPIDNEW INT,@CJOINSTR VARCHAR(MAX),@NSPID INT,@CERRMSG VARCHAR(MAX)
     
    DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(500),TMP_TABLENAME VARCHAR(500),XN_ID VARCHAR(40))  
    
    BEGIN TRY

	 
	SET @CSTEP=20

	SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
	
	SELECT @NLOCTYPE=LOC_TYPE FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID
	
	IF @CCURDEPTID<>@CHODEPTID
	BEGIN
		SELECT '' AS LAST_UPDATE,'' AS ERRMSG
		
		RETURN
	END		


	
	SET @NSPID=@@SPID


DELSPID:

   DELETE FROM MSTSKU_SKU_UPLOAD WHERE SP_ID=@NSPID
   DELETE FROM MSTSKU_ARTICLE_UPLOAD WHERE SP_ID=@NSPID
   DELETE FROM MSTSKU_SECTIOND_UPLOAD WHERE SP_ID=@NSPID
   DELETE FROM MSTSKU_SECTIONM_UPLOAD WHERE SP_ID=@NSPID
   DELETE FROM MSTSKU_PARA1_UPLOAD WHERE SP_ID=@NSPID
   DELETE FROM MSTSKU_PARA1_UPLOAD WHERE SP_ID=@NSPID
   DELETE FROM MSTSKU_PARA3_UPLOAD WHERE SP_ID=@NSPID
   DELETE FROM MSTSKU_PARA4_UPLOAD WHERE SP_ID=@NSPID
   DELETE FROM MSTSKU_PARA5_UPLOAD WHERE SP_ID=@NSPID
   DELETE FROM MSTSKU_PARA6_UPLOAD WHERE SP_ID=@NSPID
   

   

       
		
LBLGETDATA:
	
	SET @CSTEP=30
	
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('MSTSKU_SKU_UPLOAD')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('MSTSKU_ARTICLE_UPLOAD')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('MSTSKU_SECTIOND_UPLOAD')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('MSTSKU_SECTIONM_UPLOAD')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('MSTSKU_PARA1_UPLOAD')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('MSTSKU_PARA2_UPLOAD')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('MSTSKU_PARA3_UPLOAD')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('MSTSKU_PARA4_UPLOAD')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('MSTSKU_PARA5_UPLOAD')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('MSTSKU_PARA6_UPLOAD')




    SET @CSTEP=40
	SET @CTABLENAME='SKU'
	SET @CTMP_TABLENAME='MSTSKU_SKU_UPLOAD'
	SET @CKEYFIELD='PRODUCT_CODE'
	SET @CFILTERCONDITION=' BARCODE_CODING_SCHEME=1' 
	SET @CSTEP=50
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
							  ,@CDESTTABLE=@CTMP_TABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@NINSSPID=@NSPID,@BUPDATEXNS=1,@CSEARCHTABLE='SKU' 
							  
    UPDATE MSTSKU_SKU_UPLOAD SET AC_CODE='0000000000'							  


    SET @CSTEP=60
	SET @CTABLENAME='ARTICLE'
	SET @CTMP_TABLENAME='MSTSKU_ARTICLE_UPLOAD'
	SET @CKEYFIELD='ARTICLE_CODE'
	SET @CFILTERCONDITION=''
	SET @CJOINSTR=' JOIN MSTSKU_SKU_UPLOAD C ON  B.ARTICLE_CODE=C.ARTICLE_CODE' 
	SET @CSTEP=70
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
							  ,@CDESTTABLE=@CTMP_TABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@NINSSPID=@NSPID,@BUPDATEXNS=1,@CSEARCHTABLE='ARTICLE'
							  
    SET @CSTEP=80
	SET @CTABLENAME='SECTIOND'
	SET @CTMP_TABLENAME='MSTSKU_SECTIOND_UPLOAD'
	SET @CKEYFIELD='SUB_SECTION_CODE'
	SET @CJOINSTR=' JOIN MSTSKU_ARTICLE_UPLOAD C ON  B.SUB_SECTION_CODE=C.SUB_SECTION_CODE' 
	SET @CSTEP=90
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
							  ,@CDESTTABLE=@CTMP_TABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CJOINSTR=@CJOINSTR,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@NINSSPID=@NSPID,@BUPDATEXNS=1,@CSEARCHTABLE='SECTIOND'
							  
    SET @CSTEP=100
	SET @CTABLENAME='SECTIONM'
	SET @CTMP_TABLENAME='MSTSKU_SECTIONM_UPLOAD'
	SET @CKEYFIELD='SECTION_CODE'
	SET @CJOINSTR=' JOIN MSTSKU_SECTIOND_UPLOAD C ON  B.SECTION_CODE=C.SECTION_CODE' 
	SET @CSTEP=110
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
							  ,@CDESTTABLE=@CTMP_TABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CJOINSTR=@CJOINSTR,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@NINSSPID=@NSPID,@BUPDATEXNS=1,@CSEARCHTABLE='SECTIONM'						  							  
							  

    SET @CSTEP=120
	SET @CTABLENAME='PARA1'
	SET @CTMP_TABLENAME='MSTSKU_PARA1_UPLOAD'
	SET @CKEYFIELD='PARA1_CODE'
	SET @CJOINSTR=' JOIN MSTSKU_SKU_UPLOAD C ON  B.PARA1_CODE=C.PARA1_CODE' 
	SET @CSTEP=130
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
							  ,@CDESTTABLE=@CTMP_TABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@NINSSPID=@NSPID,@BUPDATEXNS=1,@CSEARCHTABLE='PARA1'
							  

    SET @CSTEP=140
	SET @CTABLENAME='PARA2'
	SET @CTMP_TABLENAME='MSTSKU_PARA2_UPLOAD'
	SET @CKEYFIELD='PARA2_CODE'
	SET @CJOINSTR=' JOIN MSTSKU_SKU_UPLOAD C ON  B.PARA2_CODE=C.PARA2_CODE' 
	SET @CSTEP=150
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
							  ,@CDESTTABLE=@CTMP_TABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@NINSSPID=@NSPID,@BUPDATEXNS=1,@CSEARCHTABLE='PARA2'
							  

    SET @CSTEP=160
	SET @CTABLENAME='PARA3'
	SET @CTMP_TABLENAME='MSTSKU_PARA3_UPLOAD'
	SET @CKEYFIELD='PARA3_CODE'
	SET @CJOINSTR=' JOIN MSTSKU_SKU_UPLOAD C ON  B.PARA3_CODE=C.PARA3_CODE' 
	SET @CSTEP=170
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
							  ,@CDESTTABLE=@CTMP_TABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@NINSSPID=@NSPID,@BUPDATEXNS=1,@CSEARCHTABLE='PARA3'
							  

    SET @CSTEP=180
	SET @CTABLENAME='PARA4'
	SET @CTMP_TABLENAME='MSTSKU_PARA4_UPLOAD'
	SET @CKEYFIELD='PARA4_CODE'
	SET @CJOINSTR=' JOIN MSTSKU_SKU_UPLOAD C ON  B.PARA4_CODE=C.PARA4_CODE' 
	SET @CSTEP=190
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
							  ,@CDESTTABLE=@CTMP_TABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@NINSSPID=@NSPID,@BUPDATEXNS=1,@CSEARCHTABLE='PARA4'
							  

    SET @CSTEP=200
	SET @CTABLENAME='PARA5'
	SET @CTMP_TABLENAME='MSTSKU_PARA5_UPLOAD'
	SET @CKEYFIELD='PARA5_CODE'
	SET @CJOINSTR=' JOIN MSTSKU_SKU_UPLOAD C ON  B.PARA5_CODE=C.PARA5_CODE' 
	SET @CSTEP=210
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
							  ,@CDESTTABLE=@CTMP_TABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@NINSSPID=@NSPID,@BUPDATEXNS=1,@CSEARCHTABLE='PARA5'
							  

    SET @CSTEP=220
	SET @CTABLENAME='PARA6'
	SET @CTMP_TABLENAME='MSTSKU_PARA6_UPLOAD'
	SET @CKEYFIELD='PARA6_CODE'
	SET @CJOINSTR=' JOIN MSTSKU_SKU_UPLOAD C ON  B.PARA6_CODE=C.PARA6_CODE' 
	SET @CSTEP=230
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE=@CTABLENAME,@CDESTDB=''
							  ,@CDESTTABLE=@CTMP_TABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1,@NINSSPID=@NSPID,@BUPDATEXNS=1,@CSEARCHTABLE='PARA6'		  							  							  							  							  							  

	
	SET @CSTEP=240
	UPDATE @TXNSSENDINFO SET TMP_TABLENAME=ORG_TABLENAME,XN_ID=@CMEMOID
		
	GOTO END_PROC
	
     
END TRY

BEGIN CATCH
	SET @CERRMSG='P: SP_SEND_MIRROR_MSTSKU, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 	
	
END_PROC:
	 
	 IF ISNULL(@CERRMSG,'')=''	
		SELECT *,ISNULL(@CERRMSG,'') AS ERRMSG,CONVERT(BIT,1) AS PICK_FROM_CURRENT_DB,@NSPID AS SP_ID FROM @TXNSSENDINFO
	 ELSE
		SELECT @CERRMSG AS ERRMSG		
END
------------- END OF PROCEDURE SP_SEND_MIRROR_MSTSKU
