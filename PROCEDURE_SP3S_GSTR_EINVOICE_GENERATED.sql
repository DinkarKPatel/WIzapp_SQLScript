CREATE PROCEDURE SP3S_GSTR_EINVOICE_GENERATED
(
	@cGST_NO	VARCHAR(50)=''
)
AS
BEGIN
	;WITH APITYPE
	AS
	(
		SELECT 'Reprint EWay/Bills' AS APITYPE , 'ASP' AS APITYPE_T
		UNION ALL
		SELECT 'E-Way' AS APITYPE , 'DEWB' AS APITYPE_T
		UNION ALL
		SELECT 'E-Invoice' AS APITYPE , 'DINV' AS APITYPE_T
		UNION ALL
		SELECT 'GST Search' AS APITYPE , 'PUB' AS APITYPE_T
	)
	,TAXPRO
	AS
	(
	SELECT intTxnMonth AS [Month_No], STRTXNMONTH AS [Month],GSTIN,ISNULL(C.AC_NAME,ISNULL( B.TCD_ac_name,'')) AS [Party Name],API.APITYPE,CAST(BALUSED AS BIGINT) AS APICOUNT
	--CAST(APICOUNT AS BIGINT) AS APICOUNT--,CAST(BALUSED AS BIGINT) AS BALUSED  
	FROM TAXPRO_USED_BY_CLIENT A
	JOIN APITYPE API ON API.APITYPE_T=A.ApiType
	LEFT OUTER JOIN TAXPRO_CLIENT_DETAILS B ON B.TCD_AC_GST_NO=A.GSTIN
	LEFT OUTER JOIN LMV01106 C ON C.Ac_gst_no=A.GSTIN
	WHERE A.GSTIN<>''
	AND (@cGST_NO='' OR @cGST_NO=A.GSTIN)
	--GROUP BY STRTXNMONTH,GSTIN,AC_NAME,APITYPE
	)
	SELECT * FROM 
	(
		SELECT * FROM TAXPRO 
	)t
	PIVOT
	(
		SUM(APICOUNT)
		FOR APITYPE IN ([E-Invoice],[E-Way],[Reprint EWay/Bills],[GST Search])
	)PVT
	ORDER BY Month_No
/*

;WITH TAXPRO
AS
(
	SELECT STRTXNMONTH,GSTIN,AC_NAME,APITYPE,CAST(BALUSED AS BIGINT) AS BALUSED  
	FROM TAXPRO_USED_BY_CLIENT A
	LEFT OUTER JOIN LMP01106 B ON B.AC_GST_NO=A.GSTIN
	LEFT OUTER JOIN LM01106 C ON C.AC_CODE=B.AC_CODE
	WHERE A.GSTIN<>''
	--GROUP BY STRTXNMONTH,GSTIN,AC_NAME,APITYPE
)
SELECT * FROM 
(
	SELECT * FROM TAXPRO
)t
PIVOT
(
	SUM(BALUSED)
	FOR APITYPE IN (ASP,DEWB,DINV,PUB)
)PVT
*/
END
