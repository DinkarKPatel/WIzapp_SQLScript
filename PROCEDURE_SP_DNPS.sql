CREATE PROCEDURE SP_DNPS    

@NQUERYID NUMERIC(2,0),    
@CFROMDATE NVARCHAR(50),    
@CTODATE NVARCHAR(50),    
@CWHERE  NVARCHAR(MAX),    
@CWHERE1 VARCHAR(100)=''    
--WITH ENCRYPTION

AS    
BEGIN    

DECLARE @CCMD NVARCHAR(MAX)    

IF @NQUERYID = 1    
GOTO LBLSUPPLIERSLOV    

ELSE IF @NQUERYID = 2    
GOTO LBLGETMST    

ELSE IF @NQUERYID = 3    
GOTO LBLGETDETAILS          

ELSE    
GOTO LAST    


LBLSUPPLIERSLOV:    
DECLARE @CHEADCODE VARCHAR(MAX),@CHEADCODE1 VARCHAR(MAX),@CHEADCODE2 VARCHAR(4000),@CHEADCODE3 VARCHAR(4000) 
SET @CHEADCODE=DBO.FN_ACT_TRAVTREE(@CWHERE)
SELECT  A.AC_CODE, A.AC_NAME, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,       
ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE,      
A.ADDRESS1 + ' ' + A.ADDRESS2 + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +       
A.STATE AS 'SUPP_ADDRESS', AC_NAME AS REPCOLNAME ,  A.FORM_ID      ,ISNULL(A.ON_HOLD,0) AS ON_HOLD   
FROM LMV01106 A       
WHERE ( CHARINDEX ( HEAD_CODE,@CHEADCODE ) > 0  OR ALLOW_CREDITOR_DEBTOR = 1 )       
AND INACTIVE = 0 AND A.AC_NAME <> ''     
UNION ALL      
SELECT A.AC_CODE, ALIAS, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,       
ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE,       
A.ADDRESS1 + ' ' + A.ADDRESS2 + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +       
A.STATE AS 'SUPP_ADDRESS', AC_NAME AS REPCOLNAME ,  A.FORM_ID     ,ISNULL(A.ON_HOLD,0) AS ON_HOLD     
FROM LMV01106 A       
WHERE ( CHARINDEX ( HEAD_CODE, @CHEADCODE ) > 0  OR ALLOW_CREDITOR_DEBTOR = 1 )       
AND INACTIVE = 0 AND A.ALIAS <> ''     
ORDER BY A.AC_NAME       

GOTO LAST    

LBLGETMST:   

SELECT  USERS.USERNAME,  C.AC_NAME AS SUPP_NAME,     
C.ADDRESS1 + ' ' + C.ADDRESS2 + ', ' + C.AREA_NAME + ' ' + C.CITY + ' ' + C.STATE AS 'SUPP_ADDRESS',    
MST.*, CONVERT(CHAR(10),CASE WHEN PS_DT='' THEN NULL ELSE PS_DT END ,105)  AS RM_DT1 ,LOCATION.DEPT_NAME,BIN.BIN_NAME,
CAST('' AS VARCHAR(50)) AS SP_ID  ,RMM.RM_NO
FROM DNPS_MST MST (NOLOCK)        
JOIN USERS (NOLOCK)  ON MST.USER_CODE = USERS.USER_CODE     
JOIN LMV01106 C ON MST.AC_CODE = C.AC_CODE   
LEFT OUTER JOIN LOCATION (NOLOCK)  ON MST.PARTY_DEPT_ID = LOCATION.DEPT_ID  
LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=MST.TARGET_BIN_ID   
LEFT OUTER JOIN RMM01106 RMM(NOLOCK) ON RMM.RM_ID=MST.prt_rm_id
WHERE MST.PS_ID =@CWHERE    

GOTO LAST    

LBLGETDETAILS:    

SELECT  A.PRODUCT_CODE,A.QUANTITY, 
A.ROW_ID,A.LAST_UPDATE,A.DEPT_ID,A.PS_ID, B.UOM_CODE,       
RMM.CANCELLED,B.DISCON,E.UOM_TYPE,  B.ARTICLE_CODE,       
B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC, C.PARA1_CODE,       
C.PARA1_NAME, D.PARA2_CODE, D.PARA2_ORDER, D.PARA2_NAME, E.UOM_NAME, I.AC_CODE,        
CONVERT(VARCHAR, S.INV_DT, 105) AS 'INV_DT', S.RECEIPT_DT,   
S.INV_NO AS BILL_NO, S.CHALLAN_NO , E.UOM_TYPE,  
G.SUB_SECTION_NAME, H.PARA3_CODE,S.PURCHASE_PRICE,     
H.PARA3_NAME, I.AC_NAME, J.SECTION_NAME, S.MRP,S.WS_PRICE AS WSP, B.CODING_SCHEME, '' AS BRAND_NAME,     
X.PARA4_NAME, X.PARA4_CODE, Y.PARA5_NAME, Y.PARA5_CODE,     
Z.PARA6_NAME, Z.PARA6_CODE, A.QUANTITY ,
ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(H.DT_CREATED,'') AS [PARA3_DT_CREATED],    
ISNULL(S.DT_CREATED,'') AS [SKU_DT_CREATED],I.CITY  ,S.PRODUCT_NAME,S.FIX_MRP,  
S.ER_FLAG,S.MRP,S.WS_PRICE , A.BIN_ID,BIN.BIN_NAME ,B.STOCK_NA,B.ALIAS AS ARTICLE_ALIAS,
CAST('' AS Varchar(50)) AS SP_ID,
A.PRODUCT_CODE AS ORG_PRODUCT_CODE,ISNULL(A.BOX_ID,'') AS BOX_ID,pur_bill_challan_mode,CAST(0 AS NUMERIC(14,3)) AS QUANTITY_IN_STOCK,
a.DNPS_CD_PERCENTAGE,a.DNPS_Terms
FROM DNPS_DET A (NOLOCK)        
JOIN DNPS_MST RMM (NOLOCK) ON A.PS_ID = RMM.PS_ID        
JOIN SKU S (NOLOCK)  ON A.PRODUCT_CODE = S.PRODUCT_CODE      
LEFT OUTER JOIN SKU_OH F ON S.PRODUCT_CODE = F.PRODUCT_CODE      
JOIN ARTICLE B (NOLOCK)  ON S.ARTICLE_CODE = B.ARTICLE_CODE        
JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE        
JOIN PARA2 D (NOLOCK)  ON S.PARA2_CODE = D.PARA2_CODE       
JOIN PARA3 H (NOLOCK)  ON S.PARA3_CODE = H.PARA3_CODE        
JOIN PARA4 X (NOLOCK)  ON S.PARA4_CODE = X.PARA4_CODE        
JOIN PARA5 Y (NOLOCK)  ON S.PARA5_CODE = Y.PARA5_CODE        
JOIN PARA6 Z (NOLOCK)  ON S.PARA6_CODE = Z.PARA6_CODE       
JOIN UOM E  (NOLOCK)  ON B.UOM_CODE = E.UOM_CODE       
JOIN SECTIOND G (NOLOCK)  ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE        
JOIN LMV01106 I (NOLOCK)  ON S.AC_CODE = I.AC_CODE    
JOIN SECTIONM J (NOLOCK) ON G.SECTION_CODE = J.SECTION_CODE  
LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID            
WHERE A.PS_ID =@CWHERE          
GOTO LAST    


LAST:    
END
