CREATE PROCEDURE SP3S_POSTSALE_JOBWORK_DELIVER
(
	 @DFROM_DT DATETIME
	,@DTO_DT DATETIME
	,@CUST_CODE VARCHAR(20)=''
	,@CANCELLED NUMERIC(1)=2--0 FOR UN-CANCELLED 1 FOR UN-CANCELLED 2 FOR ALL
	,@LOC VARCHAR(5)=''
	,@Mobile varchar(12)=''
)
--WITH ENCRYPTION
AS
BEGIN  

      SELECT A.MEMO_ID,A.MEMO_NO,CONVERT(VARCHAR,A.MEMO_DT,105) AS MEMO_DT,
      CUSTOMER_NAME=CUSTOMER_TITLE+CUSTOMER_FNAME+CUSTOMER_LNAME,c.Mobile,
      A.DELIVERED_TO,CONVERT(VARCHAR,A.LAST_UPDATE,105) AS LAST_UPDATE,
      CANCELLED=CASE WHEN A.CANCELLED<>0 THEN 'CANCELLED' ELSE '' END,
      CASE WHEN A.CANCELLED=0 THEN COUNT(B.MEMO_ID) ELSE 0 END  AS DELIVER_QUANTITY,
      ISNULL(FN.BILL_NO,HD.memo_no) AS BILL_NO,ISNULL(FN.BILL_DATE,HD.memo_dt) AS CM_DT 
	  ,(CASE WHEN ISNULL(DELIVERED_THROUGH_OTP,0)=1 THEN 'Yes' ELSE '' END) AS DELIVERED_THROUGH_OTP,ISNULL(U.username,'') AS OTP_BYPASSED_BY_USER_NAME
      FROM SLS_DELIVERY_MST A (NOLOCK)
      JOIN SLS_DELIVERY_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
      JOIN
      (
         SELECT HM.MEMO_ID ,ROW_ID ,HM.memo_no,HM.memo_dt
		 FROM  HOLD_BACK_DELIVER_MST HM (NOLOCK)
         JOIN HOLD_BACK_DELIVER_DET HD (NOLOCK) ON HD.MEMO_ID=HM.MEMO_ID 
         WHERE HM.CANCELLED =0
      ) HD ON HD.ROW_ID=B.REF_HBD_ROW_ID 
      LEFT OUTER JOIN FN_BILL_NO(@DFROM_DT,@DTO_DT,@CANCELLED,@CUST_CODE,2) FN ON FN.MEMO_ID =HD.MEMO_ID 
      JOIN CUSTDYM C  (NOLOCK) ON C.CUSTOMER_CODE=A.CUSTOMER_CODE
	  LEFT OUTER JOIN USERS U (NOLOCK) ON U.user_code=A.OTP_BYPASSED_BY_USER_CODE
      WHERE A.MEMO_DT BETWEEN @DFROM_DT AND @DTO_DT
      AND (@CUST_CODE='' OR A.CUSTOMER_CODE=@CUST_CODE)
      AND (@CANCELLED=2 OR A.CANCELLED=@CANCELLED)
      AND (@LOC='' OR A.location_code=@LOC)
	  AND (@Mobile='' OR c.mobile=@Mobile)	
      GROUP BY  A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.CUSTOMER_CODE,A.DELIVERED_TO,A.LAST_UPDATE,
      A.CANCELLED,CUSTOMER_TITLE+CUSTOMER_FNAME+CUSTOMER_LNAME,c.Mobile,
	  ISNULL(FN.BILL_NO,HD.memo_no),ISNULL(FN.BILL_DATE,HD.memo_dt)
	  ,DELIVERED_THROUGH_OTP,U.username

END      
--END PROCEDURE SP3S_POSTSALE_JOBWORK_DELIVER
