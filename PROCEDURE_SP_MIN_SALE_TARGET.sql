CREATE PROCEDURE SP_MIN_SALE_TARGET

@NQUERYID	NUMERIC(3,0),
@CMEMOID	VARCHAR(22) = '',
@CWHERE		VARCHAR(200)= '',
@CFINYEAR	VARCHAR(10) ='',
@NMONTH		NUMERIC(2) = 0,
@NYEAR		NUMERIC(4) = 0,
@DFROMDT	DATETIME	= '',
@DTODT		DATETIME	= '',
@DEPTID	VARCHAR(10) ='',
@CSECTIONCODE	VARCHAR(50) =''
--WITH ENCRYPTION

AS
BEGIN

DECLARE @CCMD NVARCHAR(4000)
DECLARE @CCMD2 NVARCHAR(4000)

IF @NQUERYID = 1
GOTO LBLSUBSECTION

ELSE 
IF @NQUERYID = 2
GOTO LBLGETINLIST

ELSE 
IF @NQUERYID = 3
GOTO LBLGETINCROSSTAB

ELSE 
IF @NQUERYID = 4
GOTO LBLGETINLISTIMPORT
ELSE 
IF @NQUERYID = 5
GOTO LBLGETLOCATION

LBLSUBSECTION:
	SELECT D.SUB_SECTION_NAME,M.SECTION_NAME,D.SUB_SECTION_CODE,D.SECTION_CODE    
	FROM SECTIONM M JOIN SECTIOND D ON M.SECTION_CODE = D.SECTION_CODE WHERE D.SUB_SECTION_NAME <> '' 
	AND D.INACTIVE =0 AND M.SECTION_CODE <> '0000000'
	
	GOTO LAST

LBLGETINLIST:

		SET @CCMD = N'IF OBJECT_ID(''TEMPDB..##TEMPL'')IS NOT NULL  DROP TABLE ##TEMPL
		SELECT DISTINCT C.SUB_SECTION_NAME,
		D.SECTION_NAME,B.ARTICLE_NO,B.ARTICLE_NAME,B.ARTICLE_CODE,B.ARTICLE_DESC,
		E.PARA2_CODE,E.PARA2_NAME,E.PARA2_ORDER
		,C.SUB_SECTION_CODE
		,D.SECTION_CODE
		,F.DEPT_ID,F.DEPT_NAME,F.DEPT_ALIAS
		,ISNULL(M.MBQ,0) AS MBQ,ISNULL(M.MST,0) AS MST
		,ISNULL(M.MONTH,'+ STR(@NMONTH) +') AS MONTH,ISNULL(M.YEAR,'+ STR(@NYEAR) +') AS YEAR
		INTO ##TEMPL
		FROM SKU A 
		JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE 
		JOIN SECTIOND C ON B.SUB_SECTION_CODE = C.SUB_SECTION_CODE 
		JOIN SECTIONM D ON C.SECTION_CODE = D.SECTION_CODE 
		JOIN PARA2 E ON A.PARA2_CODE = E.PARA2_CODE 
		JOIN LOCATION F ON 1=1
		LEFT OUTER JOIN MIN_SALE_TARGET M ON (M.ARTICLE_CODE = A.ARTICLE_CODE 
		AND M.SUB_SECTION_CODE = C.SUB_SECTION_CODE AND M.PARA2_CODE = E.PARA2_CODE AND M.DEPT_ID = F.DEPT_ID 
		AND M.MONTH = '+ STR(@NMONTH) +' AND M.YEAR = '+ STR(@NYEAR) +') 
		WHERE  F.DEPT_ID = F.MAJOR_DEPT_ID 
		'+ CASE WHEN @CMEMOID <> '' THEN  ' AND C.SUB_SECTION_CODE = '''+ @CMEMOID +''' ' ELSE '' END +'
		AND D.SECTION_CODE = '''+ @CWHERE +'''
		AND F.INACTIVE = 0
		AND F.DEPT_ID = (CASE WHEN '''+ @DEPTID +''' = '''' THEN F.MAJOR_DEPT_ID ELSE '''+ @DEPTID +''' END)
		
		SELECT * FROM ##TEMPL '
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
		
		DECLARE @CRETCOLSTR NVARCHAR(4000)

		EXEC CROSSTABSTR  '##TEMPL', 'DEPT_ID', 'DEPT_ID', 'MBQ', 'MST', '',@CRETCOLSTR OUTPUT 
		SET @CRETCOLSTR =  CASE WHEN @CRETCOLSTR <> '' THEN ','+ @CRETCOLSTR ELSE '' END 
		
		SET @CCMD = N'SELECT ARTICLE_NO AS ARTICLE_NO,ARTICLE_CODE,
					PARA2_CODE,SUB_SECTION_CODE,MONTH,YEAR,
		PARA2_NAME AS SIZE '+ @CRETCOLSTR + '
		FROM ##TEMPL 
		GROUP BY ARTICLE_NO,ARTICLE_CODE,PARA2_CODE,PARA2_NAME,SUB_SECTION_CODE,MONTH,YEAR 
		ORDER BY ARTICLE_NO'
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

GOTO LAST

LBLGETINCROSSTAB:
	
	DECLARE @CPARA2 NVARCHAR(50)
	DECLARE @CSUBSECTION NVARCHAR(400)
	SET @CSUBSECTION = ''
	
	SET @CPARA2 = ',H.PARA2_NAME'
	IF @CWHERE = '1' SET @CPARA2 =''

IF @CWHERE <> '2'
	BEGIN
		IF @CSECTIONCODE <> '' 
		BEGIN 
			SET @CSUBSECTION = ' WHERE A.SECTION_CODE = '''+ @CSECTIONCODE +''' '
			IF @CMEMOID <> '' SET @CSUBSECTION = @CSUBSECTION + ' AND A.SUB_SECTION_CODE = '''+ @CMEMOID +''' '
		END
		SET @CCMD = N'SELECT A.*,B.MBQ_QTY,B.MST_QTY FROM 
		(
			SELECT D.ARTICLE_CODE,G.DEPT_ID,G.DEPT_NAME,G.DEPT_ALIAS,E.SUB_SECTION_CODE,F.SECTION_CODE,
			J.PARA1_NAME AS SECTION_NAME,
			B.PRODUCT_NAME AS SUB_SECTION_NAME,ARTICLE_NO,(B.MRP) AS MRP,H.PARA2_SET AS PARA2_CODE,
			SUM( CASE WHEN A.XN_TYPE=''SLS'' AND XN_DT BETWEEN '''+CONVERT(NVARCHAR,@DFROMDT,120)+''' AND '''+CONVERT(NVARCHAR,@DTODT,120)+'''  
			THEN XN_QTY  WHEN A.XN_TYPE=''SLR'' AND XN_DT BETWEEN '''+CONVERT(NVARCHAR,@DFROMDT,120)+''' AND '''+CONVERT(NVARCHAR,@DTODT,120)+'''  
			THEN - (ABS(XN_QTY)) ELSE 0 END) AS SLS_QTY,
			SUM( (CASE WHEN A.XN_TYPE=''OPS'' OR (A.XN_TYPE IN (''OPS'', ''PUR'', ''CHI'', ''SLR'',''UNC'',''APR'', ''WSR'', ''PFI'', 
			''PFG'', ''BCG'',''MRP'',''DCI'',''PSB'',''JWR'') AND XN_DT <= '''+CONVERT(NVARCHAR,@DTODT,120)+''') 
			THEN 1 WHEN A.XN_TYPE IN (''PRT'',''CHO'',''SLS'',''CNC'',''APP'',''WSL'',''CIP'', ''CRM'', ''DCO'',''MIP'',''CSB'',
			''JWI'',''DLM'') AND XN_DT <= '''+CONVERT(NVARCHAR,@DTODT,120)+''' THEN -1 ELSE 0 END) * (XN_QTY)) AS STOCK_QTY
			FROM VW_XNSREPS	A 
			JOIN SKU B ON A.PRODUCT_CODE= B.PRODUCT_CODE 
			JOIN ARTICLE D ON B.ARTICLE_CODE= D.ARTICLE_CODE 
			JOIN SECTIOND E	ON D.SUB_SECTION_CODE= E.SUB_SECTION_CODE 
			JOIN SECTIONM F	ON E.SECTION_CODE= F.SECTION_CODE 
			JOIN PARA2 H ON B.PARA2_CODE = H.PARA2_CODE 
			JOIN PARA1 J ON B.PARA1_CODE = J.PARA1_CODE 
			JOIN LOCATION G	ON A.DEPT_ID = G.DEPT_ID '
			+(CASE WHEN @DEPTID = '' THEN '' ELSE ' WHERE A.DEPT_ID = '''+ @DEPTID +''' ' END)+
			' GROUP BY G.DEPT_ID,G.DEPT_NAME,G.DEPT_ALIAS 
			,B.PRODUCT_NAME,J.PARA1_NAME,E.SUB_SECTION_CODE,F.SECTION_CODE 
			,D.ARTICLE_CODE,ARTICLE_NO,H.PARA2_SET,B.MRP 
		) A 
		JOIN 
		(
			SELECT B.ARTICLE_CODE,B.ARTICLE_NO,E.SUB_SECTION_CODE,H.PARA2_SET AS PARA2_CODE,
			SUM(E.MBQ) AS MBQ_QTY,SUM(ISNULL(E.MST,0)) AS MST_QTY,E.DEPT_ID 
			FROM MIN_SALE_TARGET E 
			JOIN ARTICLE B ON E.ARTICLE_CODE= B.ARTICLE_CODE 
			JOIN PARA2 H ON E.PARA2_CODE = H.PARA2_CODE 
			WHERE E.DEPT_ID <> ''W1'' AND E.MONTH = '+ STR(@NMONTH)+'  AND E.YEAR = '+STR(@NYEAR)+' '
			+(CASE WHEN @DEPTID = '' THEN '' ELSE ' AND E.DEPT_ID = '''+ @DEPTID +''' ' END)+
			' GROUP BY B.ARTICLE_CODE,B.ARTICLE_NO,E.SUB_SECTION_CODE,H.PARA2_SET,E.DEPT_ID
		) B 
		ON A.ARTICLE_CODE = B.ARTICLE_CODE AND A.DEPT_ID = B.DEPT_ID '+ @CSUBSECTION +'
		ORDER BY SLS_QTY DESC'
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
	END
ELSE
	BEGIN
		SET @CPARA2 =',H.PARA2_SET'
		IF @CSECTIONCODE <> '' 
		BEGIN 
			SET @CSUBSECTION = ' WHERE F.SECTION_CODE = '''+ @CSECTIONCODE +''' '
			IF @CMEMOID <> '' SET @CSUBSECTION = @CSUBSECTION + ' AND E.SUB_SECTION_CODE = '''+ @CMEMOID +''' '
		END
		
		SET @CCMD = N'SELECT D.ARTICLE_CODE,J.PARA1_NAME AS SECTION_NAME,
		B.PRODUCT_NAME AS SUB_SECTION_NAME,ARTICLE_NO,(B.MRP) AS MRP,H.PARA2_SET,
		
		SUM( CASE WHEN A.XN_TYPE=''SLS'' AND XN_DT BETWEEN '''+CONVERT(NVARCHAR,@DFROMDT,120)+''' AND '''+CONVERT(NVARCHAR,@DTODT,120)+'''  AND  LO.PUR_LOC=0
			THEN XN_QTY  WHEN A.XN_TYPE=''SLR'' AND XN_DT BETWEEN '''+CONVERT(NVARCHAR,@DFROMDT,120)+''' AND '''+CONVERT(NVARCHAR,@DTODT,120)+'''  AND  LO.PUR_LOC=0 
			THEN - (ABS(XN_QTY)) ELSE 0 END) AS SLS_QTY,
			
		SUM( (CASE WHEN A.XN_TYPE=''OPS'' OR (A.XN_TYPE IN (''OPS'', ''PUR'', ''CHI'', ''SLR'',''UNC'',''APR'', ''WSR'', ''PFI'', 
			''PFG'', ''BCG'',''MRP'',''DCI'',''PSB'',''JWR'') AND XN_DT <= '''+CONVERT(NVARCHAR,@DTODT,120)+''' AND LO.PUR_LOC=0 ) 
			THEN 1 WHEN A.XN_TYPE IN (''PRT'',''CHO'',''SLS'',''CNC'',''APP'',''WSL'',''CIP'', ''CRM'', ''DCO'',''MIP'',''CSB'',
			''JWI'',''DLM'') AND XN_DT <= '''+ CONVERT(NVARCHAR,@DTODT,120) +''' AND LO.PUR_LOC=0 THEN -1 ELSE 0 END) * (XN_QTY)) AS STOCK_QTY,
		
		SUM( CASE WHEN A.XN_TYPE=''SLS'' AND XN_DT BETWEEN '''+ CONVERT(NVARCHAR,@DFROMDT,120) +''' AND '''+ CONVERT(NVARCHAR,@DTODT,120) +''' AND LO.PUR_LOC=0   
			THEN (XN_QTY)  WHEN A.XN_TYPE=''SLR'' AND XN_DT BETWEEN '''+ CONVERT(NVARCHAR,@DFROMDT,120) +''' AND '''+ CONVERT(NVARCHAR,@DTODT,120) +''' AND LO.PUR_LOC=0   
			THEN - (ABS(XN_QTY)) ELSE 0 END) * (B.MRP) AS SLS_VAL,
			
		SUM( CASE WHEN LO.PUR_LOC=0 THEN ISNULL(MST.MBQ,0) ELSE 0 END) AS MBQ_QTY,
		SUM( CASE WHEN LO.PUR_LOC=0 THEN ISNULL(MST.MST,0) ELSE 0 END) AS MST_QTY,
		SUM( CASE WHEN LO.PUR_LOC=1 AND LO.DEPT_ID= ''W1'' THEN ISNULL(MST.MBQ,0) ELSE 0 END) AS MBQ_QTY_WH,
		SUM( CASE WHEN LO.PUR_LOC=1 AND LO.DEPT_ID= ''W1'' THEN ISNULL(MST.MST,0) ELSE 0 END) AS MST_QTY_WH,
		
		SUM( CASE WHEN A.XN_TYPE=''SLS'' AND XN_DT BETWEEN '''+CONVERT(NVARCHAR,@DFROMDT,120)+''' AND '''+CONVERT(NVARCHAR,@DTODT,120)+''' AND  LO.PUR_LOC=1 AND LO.DEPT_ID= ''W1''
		          THEN XN_QTY  
		          WHEN A.XN_TYPE=''SLR'' AND XN_DT BETWEEN '''+CONVERT(NVARCHAR,@DFROMDT,120)+''' AND '''+CONVERT(NVARCHAR,@DTODT,120)+''' AND LO.PUR_LOC=1 AND LO.DEPT_ID= ''W1'' 
		          THEN - (ABS(XN_QTY)) ELSE 0 END) AS SLS_QTY_WH
		
		FROM VW_XNSREPS A
		JOIN SKU B ON A.PRODUCT_CODE = B.PRODUCT_CODE
		JOIN ARTICLE D ON B.ARTICLE_CODE = D.ARTICLE_CODE
		JOIN SECTIOND E ON D.SUB_SECTION_CODE = E.SUB_SECTION_CODE
		JOIN SECTIONM F ON E.SECTION_CODE = F.SECTION_CODE 
		JOIN PARA2 H ON B.PARA2_CODE = H.PARA2_CODE 
		JOIN PARA1 J ON B.PARA1_CODE = J.PARA1_CODE
		JOIN LOCATION LO ON LO.DEPT_ID = A.DEPT_ID
		JOIN 
		(
			SELECT ARTICLE_CODE,SUM(MBQ) AS MBQ,SUM(ISNULL(MST,0)) AS MST  FROM  MIN_SALE_TARGET MST 
			JOIN LOCATION LO ON LO.DEPT_ID = MST.DEPT_ID
			WHERE MST.MONTH = '+ STR(@NMONTH) +'  AND MST.YEAR = '+ STR(@NYEAR) +' 
			GROUP BY ARTICLE_CODE
		)	MST 
		ON MST.ARTICLE_CODE= B.ARTICLE_CODE '+ @CSUBSECTION +'
		GROUP BY J.PARA1_NAME,B.PRODUCT_NAME,D.ARTICLE_CODE,ARTICLE_NO,H.PARA2_SET,B.MRP,ISNULL(MST.MBQ,0),ISNULL(MST.MST,0) 
		ORDER BY SLS_VAL DESC'
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
	END

GOTO LAST

LBLGETINLISTIMPORT:

		IF OBJECT_ID('TEMPDB..##TEMPL')IS NOT NULL  DROP TABLE ##TEMPL
	
		SET @CCMD = N'SELECT B.ARTICLE_NO,B.ARTICLE_NAME,B.ARTICLE_CODE
		,''0000000'' AS PARA2_CODE,''NA'' AS PARA2_NAME,C.SUB_SECTION_CODE,D.SECTION_CODE
		,F.DEPT_ID,F.DEPT_NAME,F.DEPT_ALIAS
		,ISNULL(SUM(CAST(MST.MBQ AS NUMERIC(14,3))),0) AS MBQ, ISNULL(SUM(CAST(MST.MST AS NUMERIC(14,3))),0) AS MST
		,'+ STR(@NMONTH)+' AS MONTH,'+STR(@NYEAR)+' AS YEAR 
		INTO ##TEMPL
		FROM TEMP_EXCEL_IMPORT_MONTHLY_SALE_TARGET_'+@CMEMOID+' MST 
		JOIN ARTICLE B ON MST.ARTICLE_NO = B.ARTICLE_NO 
		JOIN SECTIOND C ON B.SUB_SECTION_CODE = C.SUB_SECTION_CODE 
		JOIN SECTIONM D ON C.SECTION_CODE = D.SECTION_CODE 
		JOIN LOCATION F ON MST.DEPT_ID = F.DEPT_ID 
		WHERE F.DEPT_ID = F.MAJOR_DEPT_ID AND F.INACTIVE = 0
		GROUP BY B.ARTICLE_NO
		,B.ARTICLE_NAME,B.ARTICLE_CODE
		,C.SUB_SECTION_CODE,D.SECTION_CODE
		,F.DEPT_ID,F.DEPT_NAME,F.DEPT_ALIAS
		
		SELECT * FROM ##TEMPL '
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
		
		DECLARE @CRETCOLSTR1 NVARCHAR(4000)

		EXEC CROSSTABSTR  '##TEMPL','DEPT_ID','DEPT_ID','MBQ','MST','', @CRETCOLSTR1 OUTPUT 
		SET @CCMD = N'SELECT ARTICLE_NO AS ARTICLE_NO,ARTICLE_CODE,
					PARA2_CODE,SUB_SECTION_CODE,MONTH,YEAR,
		PARA2_NAME AS SIZE  ' + CASE WHEN @CRETCOLSTR1 <> '' THEN ','+ @CRETCOLSTR1 ELSE '' END + '
		FROM ##TEMPL 
		GROUP BY ARTICLE_NO,ARTICLE_CODE,PARA2_CODE,PARA2_NAME,SUB_SECTION_CODE,MONTH,YEAR 
		ORDER BY ARTICLE_NO'
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
		

GOTO LAST
LBLGETLOCATION:
		SELECT * FROM LOCATION WHERE DEPT_ID = MAJOR_DEPT_ID AND INACTIVE = 0
GOTO LAST
LAST:
END
