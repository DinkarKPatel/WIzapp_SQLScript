CREATE PROCEDURE SP3S_VALIDATE_SERVERLOCSTOCK
(
   @CXNID VARCHAR(50),
   @CERRORMSG VARCHAR(MAX)  OUTPUT,
   @NUPDATEMODE int =2
)
AS
BEGIN

               DECLARE @CSOURCESERVERLOC BIT,@CTARGETSERVERLOC BIT,@NINVMODE INT

			   SELECT @CSOURCESERVERLOC=L.SERVER_LOC ,@CTARGETSERVERLOC=L1.SERVER_LOC
			   FROM INM01106 A (NOLOCK)
			   JOIN LOCATION L (NOLOCK) ON L.DEPT_ID =A.location_Code 
			   JOIN LOCATION L1 (NOLOCK) ON L1.DEPT_ID =PARTY_DEPT_ID
			   WHERE INV_ID =@CXNID AND A.inv_mode =2
		       


				 IF ISNULL(@CSOURCESERVERLOC,0)=1 AND   ISNULL(@CTARGETSERVERLOC,0)=1 
				 AND  EXISTS (SELECT TOP 1'U' FROM PIM01106 (NOLOCK) WHERE INV_ID=@CXNID AND RECEIPT_DT <>'')
				 BEGIN

		    
					 SELECT A.DEPT_ID,A.BIN_ID , A.PRODUCT_CODE ,SUM(A.CHI_QTY ) AS CHI_QTY
					 INTO #TMPSTOCK
					 FROM 
					 (
						 SELECT B.DEPT_ID, B.BIN_ID , A.PRODUCT_CODE ,SUM(A.QUANTITY)*-1 AS CHI_QTY 
						 FROM PID01106 A (NOLOCK)
						 JOIN PIM01106 B (NOLOCK) ON A.MRR_ID =B.MRR_ID 
						 WHERE B.CANCELLED =0 
						 AND B.INV_ID =@CXNID and b.receipt_dt <>''
						 GROUP BY B.DEPT_ID, B.BIN_ID , A.PRODUCT_CODE
						 UNION ALL
						 SELECT B.PARTY_DEPT_ID,  B.TARGET_BIN_ID, A.PRODUCT_CODE ,SUM(A.QUANTITY) AS CHI_QTY 
						 FROM IND01106 A (NOLOCK)
						 JOIN INM01106 B (NOLOCK) ON A.INV_ID =B.INV_ID 
						 WHERE B.CANCELLED =0 
						 AND B.INV_ID =@CXNID 
						 GROUP BY B.PARTY_DEPT_ID,  B.TARGET_BIN_ID, A.PRODUCT_CODE
					) A
				   GROUP BY A.DEPT_ID,A.BIN_ID , A.PRODUCT_CODE 



				  IF EXISTS (SELECT TOP 1 'U'  FROM   #TMPSTOCK A
				   LEFT JOIN  PMT01106 B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE AND A.DEPT_ID =B.DEPT_ID AND A.BIN_ID =B.BIN_ID 
				   WHERE ISNULL(CHI_QTY,0)+ISNULL(B.QUANTITY_IN_STOCK,0)<0
				   )
				   BEGIN
				       
					   	SET @CERRORMSG = 'ITEM HAS BEEN SOLD AT TARGET LOCATION CAN NOT EDIT' 
						RETURN

				   END


				   if @NUPDATEMODE=3
				   begin
				        
					   UPDATE  B SET QUANTITY_IN_STOCK =ISNULL(CHI_QTY,0)+ISNULL(B.QUANTITY_IN_STOCK,0)
					   FROM   #TMPSTOCK A
				       JOIN  PMT01106 B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE AND A.DEPT_ID =B.DEPT_ID AND A.BIN_ID =B.BIN_ID 
					   
					   IF EXISTS (SELECT TOP 1 MRR_ID FROM PIM01106 A (NOLOCK) WHERE INV_ID =@CXNID AND CANCELLED =0)
					      UPDATE A SET CANCELLED =1 FROM PIM01106 A (NOLOCK) WHERE INV_ID =@CXNID AND CANCELLED =0

					  IF EXISTS (SELECT TOP 1 INV_ID FROM DOCWSL_INM01106_MIRROR A (NOLOCK) WHERE INV_ID =@CXNID )
					  BEGIN

					      DELETE A FROM DOCWSL_IND01106_MIRROR A (NOLOCK) WHERE INV_ID =@CXNID 
						  DELETE A FROM DOCWSL_INM01106_MIRROR A (NOLOCK) WHERE INV_ID =@CXNID 

					  END


				   end


			 END


END