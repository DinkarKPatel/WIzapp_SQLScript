create PROCEDURE SP3S_SYNCH_UPLOADDATA_STREC_OPT
(
    @CSPID VARCHAR(50)
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
----WITH ENCRYPTION
AS
BEGIN
    DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
	   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
	   ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	   ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100),@CMEMOID VARCHAR(50)
      ,@CLOCID VARCHAR(5),@CSOURCEDB VARCHAR(200),@CMERGEDB VARCHAR(200),@BMSTINSERTONLY BIT
	
     
      BEGIN TRY
		SET @CSTEP=20
		SET @CTABLE_SUFFIX='UPLOAD'
		BEGIN TRANSACTION
		SET @CTABLESUFFIX=@CTABLE_SUFFIX

		SET @CSOURCEDB=''
		SET @CMERGEDB=''

		SELECT TOP 1 @CMEMOID = B.memo_id 
		FROM STREC_STMH01106_UPLOAD B (NOLOCK)
		WHERE  SP_ID=@CSPID 
   
                 
    IF ISNULL(@CMEMOID,'')=''
		GOTO EXIT_PROC
		
    SET @CFILTERCONDITION = 'B.memo_id='''+@CMEMOID+''' AND B.SP_ID='''+LTRIM(RTRIM(@CSPID))+''''
	

		
			SET @CSTEP=60
			SET @CTABLENAME='STMH01106'
			SET @CTMP_TABLENAME='STREC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
			SET @CKEYFIELD='memo_id'
			SET @CSTEP=80
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
									  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							          ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							           ,@BALWAYSUPDATE=1
			
	   
	   DELETE FROM stockReconDetails WHERE memo_id=@CMEMOID

	   SET @CTABLENAME='stockReconDetails'
	   SET @CTMP_TABLENAME='STREC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='memo_id'

	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							    ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							    ,@BALWAYSUPDATE=1

	
	 
	   
	END TRY
	BEGIN CATCH
		SET @CERRMSG='P:SP3S_SYNCH_UPLOADDATA_STREC_OPT, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH
	EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
		
	END
	ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK   
	   
	   DELETE FROM STREC_STMH01106_UPLOAD WHERE SP_ID=@CSPID 
	   DELETE FROM STREC_stockReconDetails_UPLOAD WHERE SP_ID=@CSPID 
	  
END
