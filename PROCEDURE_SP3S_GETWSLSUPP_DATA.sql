CREATE PROCEDURE SP3S_GETWSLSUPP_DATA  
(          
 @NSPID INT,  
 @CAC_CODE VARCHAR(100),
 @NMODE INT=1 ,  
 @NUPDATEMODE INT=1,  
 @NBOXNO INT=0 ,  
 @CINVID VARCHAR(40)='',  
 @CXNTYPE VARCHAR(10)='WSL'  
   
 --- @NMODE  
 --- 1.BARCODE SCAN / PASTE ,2. QUANTITY CHANGED 3.RATE CHANGE, 4. DISCOUNT CHANGED ,  
 --- 5.NET RATE CHANGED, 6. FORM NAME CHANGED, 7. RECALCULATE BUTTON PRESSED   
)                        
AS                          
BEGIN                          
      DECLARE @CPARTYRATEFILTER VARCHAR(1000)
      ,@NDEFAULTRATETYPE INT
      ,@CSTEP VARCHAR(5)
      ,@CUTERRORMSG VARCHAR(MAX)
      ,@CTERRMSG VARCHAR(MAX)
      ,@CERRPC VARCHAR(50)
      ,@CERRORMSG VARCHAR(MAX)
      ,@NINVTYPE INT
      ,@NRATEPICKINGMETHOD INT
      ,@CPRODUCTCODE VARCHAR(50)
      ,@CPARTYRATEMEMOID VARCHAR(40)
      ,@NCALMODE INT
      ,@CROUNDNETRATE VARCHAR(2)
      ,@CCURLOCID VARCHAR(5)
      ,@DINVDT DATETIME
      ,@BGROUPINV BIT  
      --SKIPPED
      --,@NCUSTOMRATETYPE INT
      --,@CTARGETLOCID VARCHAR(5)
      --,@CSOURCELOCID VARCHAR(5)
      --,@BDONOTCALEXCISE BIT
      --,@CPARTYSTATECODE CHAR(7)
      
      --ADDED WITH DEFAULT VAL
      ,@NXFERTYPE INT=0
      ,@NLOTPRICE NUMERIC(10,2)=0
      ,@NPARTYDISCPCT NUMERIC(7,3)
      ,@CTERMSCODE VARCHAR(20)=''
      ,@BGSTBILL BIT
      ,@BCUSTOMPROCEXISTS BIT=0
      ,@BPARTYRATEFILTERAPPLICABLE BIT=0
      ,@BENABLEEXCISDUTY BIT=0
      ,@BDONOTCALEXCISE BIT=0
	  ,@NBILLLEVELTAXMETHOD INT=0      
   BEGIN TRY  
      SET @CSTEP=10  
      
    SET @CUTERRORMSG=''  
      
    UPDATE WSL_ITEM_DETAILS SET ERRMSG='' WHERE SP_ID=@NSPID  
  
    SET @CSTEP=15  
      
    SELECT TOP 1 @CROUNDNETRATE=VALUE FROM CONFIG WHERE CONFIG_OPTION='WSL_ITEM_LEVEL_ROUND_OFF'  
    SELECT @CCURLOCID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'  
         
    SET @CROUNDNETRATE=ISNULL(@CROUNDNETRATE,'')  
      
    --SELECT @CPARTYRATEMEMOID=PARTY_RATE_MEMO_ID FROM WSL_INV_SETTINGS WHERE SP_ID=@NSPID  
    SELECT TOP 1 @CPARTYRATEMEMOID=MEMO_ID 
    FROM PARTY_RATE_MST 
    WHERE MEMO_ID IN (SELECT PARTY_RATE_SUPP FROM LMP01106 WHERE AC_CODE=@CAC_CODE)
    
    SELECT TOP 1 
    @NINVTYPE=1
    ,@NDEFAULTRATETYPE=DEFAULT_RATE_TYPE
    ,@NRATEPICKINGMETHOD=ISNULL(C.RATE_PICKING_METHOD,0)
    ,@NCALMODE=MST_CAL_MODE
    ,@DINVDT=CONVERT(DATE,GETDATE())
    --,@NXFERTYPE=ISNULL(XFER_TYPE,0)
    --,@NCUSTOMRATETYPE=ISNULL(A.CUSTOM_RATE_TYPE,0)
    --,@BPARTYRATEFILTERAPPLICABLE=ISNULL(PARTYRATE_FILTER_APPLICABLE,0)
    --,@CTERMSCODE=ISNULL(TERMS_CODE,'')
    --,@CTARGETLOCID=TARGET_LOCATION_ID
    --,@CSOURCELOCID=A.LOCATION_ID
    --,@BENABLEEXCISDUTY=ISNULL(ENABLE_EXCISE_DUTY,0)
    --,@BCUSTOMPROCEXISTS=ISNULL(CUSTOM_PROC_EXISTS,0)
    --,@NBILLLEVELTAXMETHOD=BILL_LEVEL_TAX_METHOD
    --,@NPARTYDISCPCT=(CASE WHEN ISNULL(DISCOUNT_PICKING_MODE,0)=2 THEN 0 ELSE PARTY_DISCOUNT_PCT END)
    --,@BDONOTCALEXCISE=ISNULL(DONOT_CALC_EXCISE,0)
    --,@NLOTPRICE=A.LOT_PRICE
    --,@BGSTBILL=ISNULL(GST_BILL,0)
    --,@CPARTYSTATECODE=PARTY_STATE_CODE  
    FROM LMP01106 A (NOLOCK)  
    --LEFT OUTER JOIN LOCATION B ON A.LOCATION_ID=B.DEPT_ID  
    LEFT OUTER JOIN (SELECT MEMO_ID,RATE_PICKING_METHOD,DISCOUNT_PICKING_MODE,MST_CAL_MODE   
					 FROM PARTY_RATE_MST 
					 --WHERE MEMO_ID=@CPARTYRATEMEMOID
					 ) C 
					 --ON C.MEMO_ID=A.PARTY_RATE_MEMO_ID  
					 ON C.MEMO_ID=A.PARTY_RATE_SUPP
    WHERE A.AC_CODE=@CAC_CODE

    IF ISNULL(@CPARTYRATEMEMOID,'')=''  
    BEGIN  
    SELECT @NDEFAULTRATETYPE=(CASE WHEN @CXNTYPE='PRT' THEN 3 ELSE 1 END),@NPARTYDISCPCT=0  
    END  
      
     
    IF @NRATEPICKINGMETHOD=1 AND ISNULL(@CTERMSCODE,'')=''  
    BEGIN  
    SET @CERRORMSG='PLEASE SELECT A VALID TERMS NAME FOR INVOICING'  
    GOTO END_PROC  
    END  
         
    IF @NMODE=5  
    BEGIN  
     UPDATE WSL_ITEM_DETAILS SET ERRMSG='NET RATE CANNOT BE MORE THAN RATE....PLEASE CHECK'  
     WHERE SP_ID=@NSPID AND NET_RATE>RATE  
  
     SELECT TOP 1 @CTERRMSG=ERRMSG FROM WSL_ITEM_DETAILS WHERE SP_ID=@NSPID AND ISNULL(ERRMSG,'')<>''  
       
     IF ISNULL(@CTERRMSG,'')<>''  
     GOTO END_PROC  
    END  
      
    SET @CSTEP=20         
  
  
    UPDATE WSL_ITEM_DETAILS SET FORM_NAME=FORM.FORM_NAME  
    FROM FORM  WHERE SP_ID=@NSPID  AND FORM.FORM_ID= WSL_ITEM_DETAILS.ITEM_FORM_ID   
      
    IF NOT (@NXFERTYPE=2 AND @NINVTYPE=2)  
     UPDATE WSL_ITEM_DETAILS SET ITEM_TAX_PERCENTAGE=FORM.TAX_PERCENTAGE,FORM_TAX_PERCENTAGE=FORM.TAX_PERCENTAGE,  
     FORM_NAME=FORM.FORM_NAME  
     FROM FORM  WHERE SP_ID=@NSPID  AND FORM.FORM_ID= WSL_ITEM_DETAILS.ITEM_FORM_ID   
    ELSE  
     UPDATE WSL_ITEM_DETAILS SET ITEM_TAX_PERCENTAGE=0 WHERE SP_ID=@NSPID  
            
    UPDATE WSL_ITEM_DETAILS SET QUANTITY=ISNULL(INVOICE_QUANTITY,0)+ISNULL(SCHEME_QUANTITY,0)  
    WHERE SP_ID=@NSPID   
      
    IF  @CXNTYPE='WSL'      
    BEGIN  
     IF @NMODE IN (1,2)   
     BEGIN  
     SET @CSTEP=25             
     EXEC SP3S_CHECKSTOCK_NEW @NSPID=@NSPID,@NMODE=@NMODE,@NUPDATEMODE=@NUPDATEMODE,@CMEMOID=@CINVID  
     END    
     ELSE  
     BEGIN  
  
     UPDATE A SET UOM_TYPE =  U.UOM_TYPE,   STOCK_NA =  B.STOCK_NA,   CODING_SCHEME = B.CODING_SCHEME,   PURCHASE_PRICE =  SKU.PURCHASE_PRICE,   MRP = SKU.MRP,   WS_PRICE = SKU.WS_PRICE,  
     ER_FLAG =  SKU.ER_FLAG,   FIX_MRP =  B.FIX_MRP,   ARTICLE_NO =  B.ARTICLE_NO,   ARTICLE_NAME =  B.ARTICLE_NAME,   PARA1_NAME =  C.PARA1_NAME,   PARA2_NAME =  D.PARA2_NAME,   PARA3_NAME =  F.PARA3_NAME,   ONLINE_BAR_CODE = SKU.ONLINE_PRODUCT_CODE,   
     VENDOR_EAN_NO = SKU.VENDOR_EAN_NO,   PRODUCT_NAME =  SKU.PRODUCT_NAME,   ARTICLE_ALIAS =  B.ALIAS,   BIN_NAME =  BIN.BIN_NAME,   PARA6_NAME =  I.PARA6_NAME,   ART_DT_CREATED = B.DT_CREATED,   PARA3_DT_CREATED = F.DT_CREATED,   SKU_DT_CREATED = SKU.DT_CREATED,   EAN = EAN_SYNC.EAN,   UOM_NAME = U.UOM_NAME,   SECTION_NAME =  SM.SECTION_NAME,   SECTION_CODE =  SM.SECTION_CODE,  
     SUB_SECTION_CODE =  SD.SUB_SECTION_CODE,   SUB_SECTION_NAME =  SD.SUB_SECTION_NAME,   PARA4_NAME =  G.PARA4_NAME,   PARA5_NAME =  H.PARA5_NAME,   ARTICLE_CODE = B.ARTICLE_CODE,   PARA1_CODE =  B.PARA1_CODE,   PARA2_CODE =  B.PARA2_CODE,   PARA3_CODE 
  
     =  B.PARA3_CODE,   PARA4_CODE =  B.PARA4_CODE,   PARA5_CODE =  B.PARA5_CODE,   PARA6_CODE =  B.PARA6_CODE,   UOM_CODE =  U.UOM_CODE  
     ,HSN_CODE=SKU.HSN_CODE  
     FROM [WSL_ITEM_DETAILS] A  
     JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
     JOIN ARTICLE B  (NOLOCK) ON B.ARTICLE_CODE = SKU.ARTICLE_CODE          
     JOIN SECTIOND SD  (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
     JOIN SECTIONM SM  (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE        
     JOIN PARA1 C  (NOLOCK) ON SKU.PARA1_CODE = C.PARA1_CODE          
     JOIN PARA2 D  (NOLOCK) ON SKU.PARA2_CODE = D.PARA2_CODE          
     JOIN PARA3 F  (NOLOCK) ON SKU.PARA3_CODE = F.PARA3_CODE          
     JOIN PARA4 G  (NOLOCK) ON SKU.PARA4_CODE = G.PARA4_CODE          
     JOIN PARA5 H  (NOLOCK) ON SKU.PARA5_CODE = H.PARA5_CODE          
     JOIN PARA6 I  (NOLOCK) ON SKU.PARA6_CODE = I.PARA6_CODE       
     LEFT OUTER JOIN UOM U  (NOLOCK) ON B.UOM_CODE = U.UOM_CODE     
     JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID  
     LEFT OUTER JOIN EAN_SYNC (NOLOCK) ON EAN_SYNC.PRODUCT_CODE=SKU.PRODUCT_CODE  
     WHERE SP_ID=@NSPID AND A.SUB_SECTION_CODE IS NULL  
       
     IF @NMODE NOT IN (7)  
     BEGIN  
      UPDATE A SET MRP=B.MRP,WS_PRICE=B.WS_PRICE,HSN_CODE=B.HSN_CODE  
      FROM WSL_ITEM_DETAILS A  
      JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE  
      JOIN ARTICLE C ON C.ARTICLE_CODE=B.ARTICLE_CODE  
      JOIN SECTIOND D ON D.SUB_SECTION_CODE=C.SUB_SECTION_CODE  
      --JOIN WSL_INV_SETTINGS E ON A.SP_ID=E.SP_ID  
      LEFT OUTER JOIN SKU_OH (NOLOCK) ON SKU_OH.PRODUCT_CODE=B.PRODUCT_CODE  
      WHERE A.SP_ID=@NSPID   
        
      GOTO LBLRECALAMOUNT  
     END  
     END  
           
     SET @CSTEP=30  
     SELECT TOP 1 @CTERRMSG=ERRMSG FROM WSL_ITEM_DETAILS WHERE SP_ID=@NSPID AND ISNULL(ERRMSG,'')<>''  
       
     IF ISNULL(@CTERRMSG,'')<>''  
     GOTO END_PROC  
       
     SET @CSTEP=40     
     UPDATE A SET MRP=B.MRP,WS_PRICE=B.WS_PRICE,HSN_CODE=B.HSN_CODE  
     FROM WSL_ITEM_DETAILS A  
     JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE  
     JOIN ARTICLE C ON C.ARTICLE_CODE=B.ARTICLE_CODE  
     JOIN SECTIOND D ON D.SUB_SECTION_CODE=C.SUB_SECTION_CODE  
     --JOIN WSL_INV_SETTINGS E ON A.SP_ID=E.SP_ID  
     LEFT OUTER JOIN SKU_OH (NOLOCK) ON SKU_OH.PRODUCT_CODE=B.PRODUCT_CODE  
     WHERE A.SP_ID=@NSPID   
    END  
          
          
    SET @CSTEP=45   
   
       
    UPDATE A SET  RATE=(CASE WHEN ISNULL(MANUAL_RATE,0)=1 THEN RATE WHEN @NLOTPRICE<>0 THEN @NLOTPRICE   
							 --CHECK
							 --WHEN ISNULL(B.MRP_WSP_MODE,0)=2 OR @NDEFAULTRATETYPE=1 AND ISNULL(SKU.WS_PRICE,0)>0 THEN SKU.WS_PRICE
							 --CHECK
							 WHEN @NDEFAULTRATETYPE=3 THEN (SKU.PURCHASE_PRICE
															+(CASE WHEN POST_TAX_SEPARATELY=1  OR SKU.FORM_ID IN ('','0000000') THEN 0 ELSE ISNULL(SKU_OH.TAX_AMOUNT,0) END)  
															-ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+ISNULL(SKU_OH.EXCISE_DUTY_AMOUNT,0))  
							 ELSE SKU.MRP 
						END)
	,DISCOUNT_AMOUNT=0
	,DISCOUNT_PERCENTAGE=(CASE WHEN @NLOTPRICE<>0 THEN 0 ELSE ISNULL(@NPARTYDISCPCT,0)* (CASE WHEN ISNULL(@NCALMODE,3)=1 THEN -1 ELSE 1 END) END)  
    ,HSN_CODE=SKU.HSN_CODE  
    FROM WSL_ITEM_DETAILS A      
    JOIN SKU  (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE   
    LEFT OUTER JOIN SKU_OH (NOLOCK) ON SKU_OH.PRODUCT_CODE=SKU.PRODUCT_CODE  
    --JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID  
    JOIN FORM C ON C.FORM_ID=SKU.FORM_ID  
    WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0   
    AND ISNULL(MANUAL_DISCOUNT,0)=0  
      
    IF @CPARTYRATEMEMOID IS NULL AND @CXNTYPE='WSL'  
       UPDATE A SET RATE=B.MRP ,HSN_CODE=B.HSN_CODE 
       FROM WSL_ITEM_DETAILS A  
       JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE  
       WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0   
     AND ISNULL(MANUAL_DISCOUNT,0)=0 AND A.RATE=0  
       
    SET @CSTEP=50  
          
    UPDATE WSL_ITEM_DETAILS SET DISCOUNT_AMOUNT=(RATE * INVOICE_QUANTITY * DISCOUNT_PERCENTAGE) / 100  
    WHERE SP_ID=@NSPID   
  
    UPDATE WSL_ITEM_DETAILS SET NET_RATE=RATE-(RATE * DISCOUNT_PERCENTAGE/ 100) WHERE SP_ID=@NSPID  
         
       IF @CXNTYPE NOT IN('WSL','PRT')  
    RETURN  
      
    PRINT 'UPDATE RATE-2:'+@CPARTYRATEFILTER  
      
    IF @NINVTYPE=2 AND @NXFERTYPE<>2  
    BEGIN  
     PRINT 'UPDATE RATE-2 TAX%'  
     UPDATE A SET ITEM_TAX_PERCENTAGE=(CASE WHEN LSADD.MIN_MRP IS NOT NULL AND A.MRP BETWEEN ISNULL(LSADD.MIN_MRP,0) AND ISNULL(LSADD.MAX_MRP,0) THEN LSADD.TAX_PERCENTAGE 
											ELSE LS.TAX_PERCENTAGE 
									   END)
	 ,ITEM_FORM_ID=LS.FORM_ID
	 ,HSN_CODE=SKU.HSN_CODE  
     FROM WSL_ITEM_DETAILS A  
     JOIN SKU ON A.PRODUCT_CODE=SKU.PRODUCT_CODE  
     JOIN ARTICLE B ON B.ARTICLE_CODE=SKU.ARTICLE_CODE  
     JOIN LOCSST LS ON LS.SUB_SECTION_CODE=B.SUB_SECTION_CODE  
     LEFT OUTER JOIN LOCSSTADD LSADD ON LSADD.LOCSST_ROW_ID=LS.ROW_ID  
     --JOIN WSL_INV_SETTINGS C ON A.SP_ID=C.SP_ID  
     WHERE A.SP_ID=@NSPID 
     --CHECK
     --AND LS.MEMO_ID=C.LOCSST_MEMO_ID  
     --CHECK
    END  
      
    SELECT TOP 1 @CPRODUCTCODE=PRODUCT_CODE FROM WSL_ITEM_DETAILS   
    WHERE SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0    
     
   --SELECT @NLOTPRICE, @CPRODUCTCODE,@NRATEPICKINGMETHOD,@BPARTYRATEFILTERAPPLICABLE     
         
    IF @NLOTPRICE=0  
    BEGIN  
     IF @NRATEPICKINGMETHOD=1 AND ISNULL(@CTERMSCODE,'')<>'' AND ISNULL(@CPRODUCTCODE,'')<>''  
     BEGIN  
     PRINT 'UPDATE RATES FOR TERMS'  
     SET @CSTEP=60       
     IF @BGSTBILL=1  
      EXEC SP3S_GETINVRATE_TERMS_GST  @NSPID,'WSL',@CERRORMSG OUTPUT       
     ELSE   
      EXEC SP3S_GETINVRATE_TERMS_NEW @NSPID,'WSL',@CERRORMSG OUTPUT  
       
     IF ISNULL(@CERRORMSG,'')<>''  
      GOTO END_PROC  
     END    
     ELSE  
     IF @NRATEPICKINGMETHOD=2 AND @BCUSTOMPROCEXISTS=1 AND ISNULL(@CPRODUCTCODE,'')<>''  
     BEGIN  
     PRINT 'UPDATE RATES FOR CUSTOM PROC'  
     SET @CSTEP=70       
     EXEC SP3S_GETINVRATE_CUSTOM @NSPID  
     END   
     ELSE  
     IF @NRATEPICKINGMETHOD=3 AND @BPARTYRATEFILTERAPPLICABLE=1 AND ISNULL(@CPRODUCTCODE,'')<>''  
     BEGIN  
     PRINT 'UPDATE RATES FOR PARTY RATE:'+STR(@NSPID)  
     SET @CSTEP=65       
     EXEC SP3S_APPLY_PARTY_RATE_NEW @NSPID,@CERRORMSG OUTPUT  
       
     IF ISNULL(@CERRORMSG,'')<>''  
      GOTO END_PROC  
     END    
     ELSE  
    PRINT 'UPDATE BASIC RATES'  
    END  
           
    IF EXISTS (SELECT TOP 1 RATE FROM WSL_ITEM_DETAILS  WHERE SP_ID=@NSPID AND RATE=0)  
    BEGIN  
    SELECT TOP 1 @CERRPC=PRODUCT_CODE FROM WSL_ITEM_DETAILS WHERE SP_ID=@NSPID AND RATE=0  
    SET @CERRORMSG='(2)RATE CANNOT BE ZERO FOR THE ITEM CODE :'+@CERRPC  
    GOTO END_PROC  
    END  
  
LBLRECALAMOUNT:              
      
    IF @BENABLEEXCISDUTY=1 AND @BDONOTCALEXCISE=0  
    BEGIN  
       
     SET @CSTEP=80  
     UPDATE WSL_ITEM_DETAILS SET ITEM_EXCISE_ACCESSIBLE_AMOUNT=0,ITEM_EXCISE_DUTY_PERCENTAGE=0,ITEM_EXCISE_DUTY_AMOUNT=0,ITEM_EXCISE_EDU_CESS_PERCENTAGE=0,  
     ITEM_EXCISE_EDU_CESS_AMOUNT=0,ITEM_EXCISE_HEDU_CESS_PERCENTAGE=0,ITEM_EXCISE_HEDU_CESS_AMOUNT=0,  
     ITEM_EXCISE_MRP=0 WHERE SP_ID=@NSPID    
     
     SET @CSTEP=90       
     UPDATE A  SET ITEM_EXCISE_MRP=A.MRP FROM WSL_ITEM_DETAILS A   
     --JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID  
     JOIN FORM C ON C.FORM_ID=A.ITEM_FORM_ID  
     WHERE A.SP_ID=@NSPID AND C.EXCISE_DUTY_PERCENTAGE<>0 
     --AND A.MRP>=B.MIN_EXCISABLE_MRP --CHECK
           
       
     SET @CSTEP=100    
     UPDATE WSL_ITEM_DETAILS SET ITEM_EXCISE_MRPVAL= (ITEM_EXCISE_MRP*INVOICE_QUANTITY) WHERE SP_ID=@NSPID    
       
     UPDATE A SET ITEM_EXCISE_ACCESSIBLE_PERCENTAGE=B.EXCISE_ACCESSIBLE_PERCENTAGE,  
     ITEM_EXCISE_ACCESSIBLE_AMOUNT=ITEM_EXCISE_MRPVAL*B.EXCISE_ACCESSIBLE_PERCENTAGE/100       
     FROM WSL_ITEM_DETAILS A JOIN FORM B ON A.ITEM_FORM_ID=B.FORM_ID  
     WHERE A.SP_ID=@NSPID    
       
     SET @CSTEP=110     
     UPDATE A SET ITEM_EXCISE_DUTY_PERCENTAGE=B.EXCISE_DUTY_PERCENTAGE,  
     ITEM_EXCISE_DUTY_AMOUNT=ITEM_EXCISE_ACCESSIBLE_AMOUNT*B.EXCISE_DUTY_PERCENTAGE/100    
     FROM WSL_ITEM_DETAILS A JOIN FORM B ON A.ITEM_FORM_ID=B.FORM_ID  
     WHERE A.SP_ID=@NSPID    
       
     SET @CSTEP=115    
     --UPDATE A SET ITEM_EXCISE_EDU_CESS_PERCENTAGE=B.EXCISE_EDU_CESS_PERCENTAGE,  
     --ITEM_EXCISE_EDU_CESS_AMOUNT=ITEM_EXCISE_DUTY_AMOUNT*B.EXCISE_EDU_CESS_PERCENTAGE/100,  
     --ITEM_EXCISE_HEDU_CESS_PERCENTAGE=B.EXCISE_HEDU_CESS_PERCENTAGE,  
     --ITEM_EXCISE_HEDU_CESS_AMOUNT=ITEM_EXCISE_DUTY_AMOUNT*B.EXCISE_HEDU_CESS_PERCENTAGE/100  
     --FROM WSL_ITEM_DETAILS A 
     ----JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID  
     --WHERE A.SP_ID=@NSPID AND A.ITEM_EXCISE_DUTY_PERCENTAGE<>0 
     ----AND A.MRP>=B.MIN_EXCISABLE_MRP  --CHECK
     
    END    
      
      
    SET @CSTEP=130  
    IF @NMODE NOT IN (4,5)  
     UPDATE WSL_ITEM_DETAILS SET  DISCOUNT_AMOUNT = (RATE*ISNULL(DISCOUNT_PERCENTAGE,0)*INVOICE_QUANTITY/100)  
     WHERE SP_ID=@NSPID  AND ISNULL(MANUAL_DISCOUNT,0)=0    
    ELSE  
    IF @NMODE=5  
    BEGIN  
     SET @CSTEP=120  
     PRINT 'CHANGE DISCOUNT'  
     UPDATE WSL_ITEM_DETAILS SET  DISCOUNT_AMOUNT = (RATE-NET_RATE)*INVOICE_QUANTITY,MANUAL_DISCOUNT=0    
     WHERE SP_ID=@NSPID   
  
     UPDATE WSL_ITEM_DETAILS SET  DISCOUNT_PERCENTAGE = (ISNULL(DISCOUNT_AMOUNT,0)*100)/(RATE*INVOICE_QUANTITY)  
     WHERE SP_ID=@NSPID   
    END  
  
    SET @CSTEP=140     
    IF @NMODE<>6  
    BEGIN  
     SET @CSTEP=125  
     UPDATE WSL_ITEM_DETAILS SET NET_RATE=(RATE-(DISCOUNT_AMOUNT/INVOICE_QUANTITY))  
     WHERE SP_ID=@NSPID AND ISNULL(MANUAL_NET_RATE,0)=0  
       
     SET @CSTEP=130       
     IF @CROUNDNETRATE='1'  
      UPDATE WSL_ITEM_DETAILS SET NET_RATE=ROUND(NET_RATE,0) WHERE SP_ID=@NSPID  
      AND ISNULL(MANUAL_NET_RATE,0)=0  
       
  
    END  
  
    SET @CSTEP=135  
    UPDATE WSL_ITEM_DETAILS SET ITEM_ROUND_OFF=(NET_RATE-(RATE-(DISCOUNT_AMOUNT/INVOICE_QUANTITY)))  
    WHERE SP_ID=@NSPID     
                         
    SET @CSTEP=145   
    UPDATE WSL_ITEM_DETAILS SET  BASEAMOUNT_FOR_TAX = NET_RATE WHERE SP_ID=@NSPID     
      
    --CHECK
    --UPDATE A SET  BASEAMOUNT_FOR_TAX = BASEAMOUNT_FOR_TAX - (BASEAMOUNT_FOR_TAX*B.BILL_DISC_PCT/100)  
    --FROM WSL_ITEM_DETAILS A 
    ----JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID  
    --WHERE A.SP_ID=@NSPID     
      
    SET @CSTEP=150  
    UPDATE WSL_ITEM_DETAILS SET  BASEAMOUNT_FOR_TAX = (BASEAMOUNT_FOR_TAX*INVOICE_QUANTITY)+   
    ISNULL(ITEM_EXCISE_DUTY_AMOUNT,0)+ISNULL(ITEM_EXCISE_EDU_CESS_AMOUNT,0)+ISNULL(ITEM_EXCISE_HEDU_CESS_AMOUNT,0)  
    WHERE SP_ID=@NSPID   
  
      
      
    IF @BGSTBILL=0  
    BEGIN  
     SET @CSTEP=155  
  
     IF @NINVTYPE=1  
      UPDATE WSL_ITEM_DETAILS SET ITEM_TAX_PERCENTAGE=FORM.TAX_PERCENTAGE,FORM_TAX_PERCENTAGE=FORM.TAX_PERCENTAGE,  
      FORM_NAME=FORM.FORM_NAME  
      FROM FORM  WHERE SP_ID=@NSPID  AND FORM.FORM_ID= WSL_ITEM_DETAILS.ITEM_FORM_ID   
      
     SET @CSTEP=157  
       
     PRINT 'CALCULATE FINAL TAX:'+ISNULL(STR(@NBILLLEVELTAXMETHOD),'NULL BLTM')  
     UPDATE WSL_ITEM_DETAILS SET  ITEM_TAX_AMOUNT = (BASEAMOUNT_FOR_TAX*ITEM_TAX_PERCENTAGE/  
     (100+(CASE WHEN ISNULL(@NBILLLEVELTAXMETHOD,0)=2 THEN ITEM_TAX_PERCENTAGE ELSE 0  END)))  
     WHERE SP_ID=@NSPID   
    END  
    ELSE  
    BEGIN  
     SET @CSTEP=159  
  
     UPDATE WSL_ITEM_DETAILS SET ITEM_FORM_ID='0000000',ITEM_TAX_PERCENTAGE=0,ITEM_TAX_AMOUNT=0,  
     ROW_ID=(CASE WHEN ISNULL(ROW_ID,'')='' THEN CONVERT(VARCHAR(40),NEWID()) ELSE ROW_ID END)  
     WHERE SP_ID=@NSPID     
          
    END  
       
    SET @CSTEP=170     
    UPDATE WSL_ITEM_DETAILS SET AMOUNT=NET_RATE*INVOICE_QUANTITY  
    WHERE SP_ID=@NSPID   
          
    GOTO END_PROC  
   END TRY  
     
   BEGIN CATCH  
   PRINT 'ENTER CATCH BLOCK'  
   SET @CUTERRORMSG='ERROR IN PROCEDURE SP3S_GETWSL_DATA : STEP #'+@CSTEP+' '+ERROR_MESSAGE()  
   GOTO END_PROC   
   END CATCH  
  
END_PROC:  
  PRINT 'LAST STEP:'+@CSTEP  
    
   IF ISNULL(@CUTERRORMSG,'')<>''  
   UPDATE WSL_ITEM_DETAILS SET ERRMSG=@CUTERRORMSG WHERE SP_ID=@NSPID  
   ELSE  
   IF ISNULL(@CERRORMSG,'')<>''  
     UPDATE WSL_ITEM_DETAILS SET ERRMSG=@CERRORMSG WHERE SP_ID=@NSPID  
     
   IF ISNULL(@CUTERRORMSG,'')='' AND ISNULL(@CUTERRORMSG,'')=''  
   SELECT TOP 1 @CERRORMSG=ERRMSG FROM  WSL_ITEM_DETAILS WHERE SP_ID=@NSPID AND ISNULL(ERRMSG,'')<>''  
     
   IF @CXNTYPE='WSL'  
   BEGIN    
    IF ISNULL(@CERRORMSG,'')=''  
    SELECT * FROM WSL_ITEM_DETAILS WHERE SP_ID=@NSPID  
    ELSE  
    SELECT * FROM WSL_ITEM_DETAILS WHERE SP_ID=@NSPID AND ISNULL(ERRMSG,'')<>''  
   END     
END  
------------- END OF PROCEDURE SP3S_GETWSLSUPP_DATA 

PRINT 'CREATE PROCEDURE SP3S_INSERT_WIZBIT_ATTRIBUTE_DETAILS_NEW'
