CREATE Procedure SP3S_CHECK_DUPLICATE_BARCODE--(LocId 3 digit change only increased the parameter width by Sanjay:04-11-2024)
(
    @csp_id varchar(50)='',
	@CUSERCODE varchar(10)='',
	@cdept_id varchar(4)='',
	@nmode numeric(1,0)=1,
	@BMULTIPLEMRP bit Output 

)
as
begin


  
	Print 'Pick locskusp mrp '
	 CREATE TABLE #TMPLOCSKUSP ( PRODUCT_CODE VARCHAR(100),MRP  NUMERIC(14,2),LASTSR NUMERIC(5))

	IF @NMODE IN (1,2)
	BEGIN

		;WITH CTE_LOCSKUSP AS
		 (
		SELECT B.PRODUCT_CODE ,A.MRP ,
			   LASTSR=ROW_NUMBER() OVER(PARTITION BY A.PRODUCT_CODE ORDER BY A.FROM_DT DESC)
		FROM LOCSKUSP A (NOLOCK)
		JOIN WSL_ITEM_DETAILS B (nolock) ON A.PRODUCT_CODE=B.PRODUCT_CODE
		 WHERE A.DEPT_ID=@CDEPT_ID AND B.SP_ID =@CSP_ID
		)
		INSERT INTO #TMPLOCSKUSP(PRODUCT_CODE ,MRP ,LASTSR)
		SELECT PRODUCT_CODE ,MRP ,LASTSR FROM CTE_LOCSKUSP

   END

  
	
    	
IF @nmode=1
   GOTO lblBarcodeDuplicate --(user Import only Barcode )
Else IF @nmode=2 
   GOTO lblBarcodebinDuplicate--(user Import only Barcode,bin )
Else IF @nmode=3 
   GOTO lblBarcodeMrpDuplicate--(user Import only Barcode,mrp )
Else IF @nmode=4 
   GOTO lblBarcodemrpbinDuplicate--(user Import  Barcode,bin,mrp )


   lblBarcodeDuplicate:
            
			 --MARK SA DONOT MAINTAIN STOCK 
				IF EXISTS (SELECT TOP 1 'U' FROM WSL_ITEM_DETAILS A (NOLOCK)
				   JOIN SKU_NAMES B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
				   WHERE A.SP_ID=@CSP_ID AND ISNULL(B.STOCK_NA,0)=1)
				BEGIN

					   UPDATE A SET STOCK_NA =1,QUANTITY_IN_STOCK =QUANTITY,BIN_ID='000',
								MRP=B.MRP 
					   FROM WSL_ITEM_DETAILS A (NOLOCK)
					   JOIN SKU_NAMES B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
					   WHERE A.SP_ID=@CSP_ID AND ISNULL(B.STOCK_NA,0)=1

				END
		

		    INSERT INTO #TMPMULTIPLEMRP(PRODUCT_CODE,BATCH_BARCODE,MRP,BIN_ID,SRNO,quantity_in_stock,logged_bin_id,major_bin_id)
			 SELECT A.PRODUCT_CODE,b.PRODUCT_CODE as BATCH_BARCODE ,isnull(skusp.mrp,D.MRP) as MRP,B.BIN_ID,
					 SR=dense_rank() OVER(partition  by a.PRODUCT_CODE ORDER BY 
					 (CASE WHEN A.LOGGED_BIN_ID=BIN.MAJOR_BIN_ID THEN 0 ELSE 1 END),
					 b.Quantity_in_stock desc, A.PRODUCT_CODE,isnull(skusp.mrp,D.MRP) ,b.bin_id),
					 b.quantity_in_stock,A.LOGGED_BIN_ID,BIN.MAJOR_BIN_ID
			 FROM WSL_ITEM_DETAILS A (NOLOCK)
			 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE=LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE )))
			 JOIN SKU D (NOLOCK) ON D.PRODUCT_CODE=B.PRODUCT_CODE	
			 JOIN BIN  (NOLOCK) ON BIN.BIN_ID=B.BIN_ID
			 JOIN BINUSERS C ON C.BIN_ID=BIN.MAJOR_BIN_ID AND C.USER_CODE =@CUSERCODE
			 LEFT JOIN #TMPLOCSKUSP SKUSP ON SKUSP.PRODUCT_CODE= A.PRODUCT_CODE
			 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND B.QUANTITY_IN_STOCK >0  AND B.DEPT_ID= @CDEPT_ID
			 AND B.BIN_ID<>'999' and isnull(b.pick_list_id,'')=''
			 and isnull(a.STOCK_NA ,0)=0
			 and a.PRODUCT_CODE not like '%@%'
			 --AND CHARINDEX('@',A.PRODUCT_CODE)=0 slow process
			 
			 Delete A
			 from #TMPMULTIPLEMRP A
			 Join
			 (
			 SELECT product_code FROM #TMPMULTIPLEMRP a
			 WHERE A.MAJOR_BIN_ID =A.LOGGED_BIN_ID
			 ) B on a.product_code=b.product_code
			 where SRNO>1
			 
			
			
	

			 IF EXISTS (SELECT TOP 1'U' FROM WSL_ITEM_DETAILS A (NOLOCK)  WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND CHARINDEX('@',A.PRODUCT_CODE)>0)
			 BEGIN
			      INSERT INTO #TMPMULTIPLEMRP(PRODUCT_CODE,BATCH_BARCODE,MRP,BIN_ID,SRNO,quantity_in_stock)
				 SELECT A.PRODUCT_CODE,b.PRODUCT_CODE as BATCH_BARCODE ,D.MRP,B.BIN_ID,
						 SR=dense_rank() OVER(partition  by a.PRODUCT_CODE ORDER BY A.PRODUCT_CODE,d.mrp,b.bin_id),b.quantity_in_stock
				 FROM WSL_ITEM_DETAILS A (NOLOCK)
				 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE=b.product_code
				 JOIN SKU D (NOLOCK) ON D.PRODUCT_CODE=B.PRODUCT_CODE	
				 JOIN BIN  (NOLOCK) ON BIN.BIN_ID=B.BIN_ID
				 JOIN BINUSERS C ON C.BIN_ID=BIN.MAJOR_BIN_ID AND C.USER_CODE =@CUSERCODE
				 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND B.QUANTITY_IN_STOCK >0  AND B.DEPT_ID= @CDEPT_ID
				 AND B.BIN_ID<>'999' and isnull(b.pick_list_id,'')=''
				 and isnull(a.STOCK_NA ,0)=0
				 and a.PRODUCT_CODE  like '%@%'

			 END


		    IF EXISTS (SELECT TOP 1 'U' FROM #TMPMULTIPLEMRP WHERE SRNO>1)
			 BEGIN
				  SET @BMULTIPLEMRP=1
				  GOTO END_PROC
			 END

			 UPDATE A SET BIN_ID =B.BIN_ID ,MRP=B.MRP ,QUANTITY_IN_STOCK=b.quantity_in_stock
			 FROM WSL_ITEM_DETAILS A (NOLOCK)
			 JOIN #TMPMULTIPLEMRP B ON A.PRODUCT_CODE=B.PRODUCT_CODE
			 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))

			  
       
   GOTO END_PROC



    lblBarcodebinDuplicate:

	         --MARK SA DONOT MAINTAIN STOCK 
				IF EXISTS (SELECT TOP 1 'U' FROM WSL_ITEM_DETAILS A (NOLOCK)
				   JOIN SKU_NAMES B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
				   WHERE A.SP_ID=@CSP_ID AND ISNULL(B.STOCK_NA,0)=1)
				BEGIN

					   UPDATE A SET STOCK_NA =1,QUANTITY_IN_STOCK =QUANTITY,MRP=B.MRP 
					   FROM WSL_ITEM_DETAILS A (NOLOCK)
					   JOIN SKU_NAMES B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
					   WHERE A.SP_ID=@CSP_ID AND ISNULL(B.STOCK_NA,0)=1

				END

	         INSERT INTO #TMPMULTIPLEMRP(PRODUCT_CODE,BATCH_BARCODE,MRP,BIN_ID,SRNO,quantity_in_stock)
			 SELECT A.PRODUCT_CODE,b.PRODUCT_CODE as BATCH_BARCODE ,isnull(skusp.mrp,D.MRP) as MRP,a.BIN_ID,
					 SR=dense_rank() OVER(PARTITION BY A.PRODUCT_CODE,a.bin_id ORDER BY a.PRODUCT_CODE,a.bin_id,isnull(skusp.mrp,D.MRP)),b.quantity_in_stock
			 FROM WSL_ITEM_DETAILS A (NOLOCK)
			 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE=LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE )))
			 and a.BIN_ID =b.BIN_ID 
			 JOIN SKU D (NOLOCK) ON D.PRODUCT_CODE=B.PRODUCT_CODE	
			 JOIN BIN  (NOLOCK) ON BIN.BIN_ID=B.BIN_ID
			 JOIN BINUSERS C ON C.BIN_ID=BIN.MAJOR_BIN_ID AND C.USER_CODE =@CUSERCODE
			 LEFT JOIN #TMPLOCSKUSP SKUSP ON SKUSP.PRODUCT_CODE= A.PRODUCT_CODE
			 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND B.QUANTITY_IN_STOCK >0  AND B.DEPT_ID= @CDEPT_ID
			 AND B.BIN_ID<>'999' and isnull(b.pick_list_id,'')=''
			 and isnull(a.STOCK_NA ,0)=0
             and a.PRODUCT_CODE not like '%@%'

			

			 IF EXISTS (SELECT TOP 1'U' FROM WSL_ITEM_DETAILS A (NOLOCK)  WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND CHARINDEX('@',A.PRODUCT_CODE)>0)
			 BEGIN
			     
				INSERT INTO #TMPMULTIPLEMRP(PRODUCT_CODE,BATCH_BARCODE,MRP,BIN_ID,SRNO,quantity_in_stock)
				 SELECT A.PRODUCT_CODE,b.PRODUCT_CODE as BATCH_BARCODE ,D.MRP,a.BIN_ID,
						 SR=dense_rank() OVER(PARTITION BY A.PRODUCT_CODE,a.bin_id ORDER BY a.PRODUCT_CODE,a.bin_id,d.mrp),b.quantity_in_stock
				 FROM WSL_ITEM_DETAILS A (NOLOCK)
				 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE=b.product_code AND A.BIN_ID=B.BIN_ID
				 JOIN SKU D (NOLOCK) ON D.PRODUCT_CODE=B.PRODUCT_CODE	
				 JOIN BIN  (NOLOCK) ON BIN.BIN_ID=B.BIN_ID
				 JOIN BINUSERS C ON C.BIN_ID=BIN.MAJOR_BIN_ID AND C.USER_CODE =@CUSERCODE
				 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND B.QUANTITY_IN_STOCK >0  AND B.DEPT_ID= @CDEPT_ID
				 AND B.BIN_ID<>'999' and isnull(b.pick_list_id,'')=''
				 and isnull(a.STOCK_NA ,0)=0
				  and a.PRODUCT_CODE  like '%@%'

			 END
			 

		    IF EXISTS (SELECT TOP 1 'U' FROM #TMPMULTIPLEMRP WHERE SRNO>1)
			 BEGIN
				  SET @BMULTIPLEMRP=1
				  GOTO END_PROC
			 END

			 Update a set MRP=b.MRP ,QUANTITY_IN_STOCK=b.quantity_in_stock
			 from WSL_ITEM_DETAILS a (nolock)
			 join #TMPMULTIPLEMRP b on a.PRODUCT_CODE=b.product_code and a.BIN_ID =b.BIN_ID
			 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))



   GOTO END_PROC


    lblBarcodeMrpDuplicate:
	         
			  --MARK SA DONOT MAINTAIN STOCK 
				IF EXISTS (SELECT TOP 1 'U' FROM WSL_ITEM_DETAILS A (NOLOCK)
				   JOIN SKU_NAMES B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
				   WHERE A.SP_ID=@CSP_ID AND ISNULL(B.STOCK_NA,0)=1)
				BEGIN

					   UPDATE A SET STOCK_NA =1,QUANTITY_IN_STOCK =QUANTITY,BIN_ID='000'
					   FROM WSL_ITEM_DETAILS A (NOLOCK)
					   JOIN SKU_NAMES B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
					   WHERE A.SP_ID=@CSP_ID AND ISNULL(B.STOCK_NA,0)=1

				END
	       
		     INSERT INTO #TMPMULTIPLEMRP(PRODUCT_CODE,BATCH_BARCODE,MRP,BIN_ID,SRNO ,quantity_in_stock)
			 SELECT A.PRODUCT_CODE,b.PRODUCT_CODE as BATCH_BARCODE ,D.MRP,b.BIN_ID,
					 SR=dense_rank() OVER(PARTITION BY A.PRODUCT_CODE,d.mrp ORDER BY A.PRODUCT_CODE,b.bin_id,d.mrp),b.quantity_in_stock
			 FROM WSL_ITEM_DETAILS A (NOLOCK)
			 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE=LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE )))
			             
			 JOIN SKU D (NOLOCK) ON D.PRODUCT_CODE=B.PRODUCT_CODE and a.mrp=d.mrp
			 JOIN BIN  (NOLOCK) ON BIN.BIN_ID=B.BIN_ID
			 JOIN BINUSERS C ON C.BIN_ID=BIN.MAJOR_BIN_ID AND C.USER_CODE =@CUSERCODE
			 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND B.QUANTITY_IN_STOCK >0  AND B.DEPT_ID= @CDEPT_ID
			 AND B.BIN_ID<>'999' and isnull(b.pick_list_id,'')=''
			 and isnull(a.STOCK_NA ,0)=0
			 and a.PRODUCT_CODE not like '%@%'




			 IF EXISTS (SELECT TOP 1'U' FROM WSL_ITEM_DETAILS A (NOLOCK)  WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND CHARINDEX('@',A.PRODUCT_CODE)>0)
			 BEGIN
			     
				INSERT INTO #TMPMULTIPLEMRP(PRODUCT_CODE,BATCH_BARCODE,MRP,BIN_ID,SRNO,quantity_in_stock)
				 SELECT A.PRODUCT_CODE,b.PRODUCT_CODE as BATCH_BARCODE ,D.MRP,b.BIN_ID,
						 SR=dense_rank() OVER(PARTITION BY A.PRODUCT_CODE,d.mrp ORDER BY A.PRODUCT_CODE,b.bin_id,d.mrp),b.quantity_in_stock
				 FROM WSL_ITEM_DETAILS A (NOLOCK)
				 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE=b.product_code
				 JOIN SKU D (NOLOCK) ON D.PRODUCT_CODE=B.PRODUCT_CODE	 and a.mrp=d.mrp
				 JOIN BIN  (NOLOCK) ON BIN.BIN_ID=B.BIN_ID
				 JOIN BINUSERS C ON C.BIN_ID=BIN.MAJOR_BIN_ID AND C.USER_CODE =@CUSERCODE
				 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND B.QUANTITY_IN_STOCK >0  AND B.DEPT_ID= @CDEPT_ID
				 AND B.BIN_ID<>'999' and isnull(b.pick_list_id,'')=''
				 and isnull(a.STOCK_NA ,0)=0
				 and a.PRODUCT_CODE  like '%@%'


			 END

		    IF EXISTS (SELECT TOP 1 'U' FROM #TMPMULTIPLEMRP WHERE SRNO>1)
			 BEGIN
				  SET @BMULTIPLEMRP=1
				  GOTO END_PROC
			 END

			 Update a set BIN_ID=b.BIN_ID ,QUANTITY_IN_STOCK=b.quantity_in_stock
			 from WSL_ITEM_DETAILS a (nolock)
			 join #TMPMULTIPLEMRP b on a.PRODUCT_CODE=b.product_code and a.mrp =b.mrp 
			 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))
			

    GOTO END_PROC



   lblBarcodemrpbinDuplicate:
        
		 --MARK SA DONOT MAINTAIN STOCK 
				IF EXISTS (SELECT TOP 1 'U' FROM WSL_ITEM_DETAILS A (NOLOCK)
				   JOIN SKU_NAMES B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
				   WHERE A.SP_ID=@CSP_ID AND ISNULL(B.STOCK_NA,0)=1)
				BEGIN

					   UPDATE A SET STOCK_NA =1,QUANTITY_IN_STOCK =QUANTITY
					   FROM WSL_ITEM_DETAILS A (NOLOCK)
					   JOIN SKU_NAMES B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
					   WHERE A.SP_ID=@CSP_ID AND ISNULL(B.STOCK_NA,0)=1

				END
       
	    INSERT INTO #TMPMULTIPLEMRP(PRODUCT_CODE,BATCH_BARCODE,MRP,BIN_ID,SRNO,quantity_in_stock)
			 SELECT A.PRODUCT_CODE,b.PRODUCT_CODE as BATCH_BARCODE ,a.MRP,a.BIN_ID,
					 SR=dense_rank() OVER(PARTITION BY A.PRODUCT_CODE,a.mrp,a.bin_id ORDER BY A.PRODUCT_CODE,a.mrp,a.bin_id),b.quantity_in_stock
			 FROM WSL_ITEM_DETAILS A (NOLOCK)
			 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE=LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE ))) and a.BIN_ID =b.BIN_ID
			 JOIN SKU D (NOLOCK) ON D.PRODUCT_CODE=B.PRODUCT_CODE	and a.mrp =d.mrp
			 JOIN BIN  (NOLOCK) ON BIN.BIN_ID=B.BIN_ID
			 JOIN BINUSERS C ON C.BIN_ID=BIN.MAJOR_BIN_ID AND C.USER_CODE =@CUSERCODE
			 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND B.QUANTITY_IN_STOCK >0  AND B.DEPT_ID= @CDEPT_ID
			 AND B.BIN_ID<>'999' and isnull(b.pick_list_id,'')=''
			 and isnull(a.STOCK_NA ,0)=0
			  and a.PRODUCT_CODE not like '%@%'

			 IF EXISTS (SELECT TOP 1'U' FROM WSL_ITEM_DETAILS A (NOLOCK)  WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND CHARINDEX('@',A.PRODUCT_CODE)>0)
			 BEGIN
			     
				INSERT INTO #TMPMULTIPLEMRP(PRODUCT_CODE,BATCH_BARCODE,MRP,BIN_ID,SRNO,quantity_in_stock)
				 SELECT A.PRODUCT_CODE,b.PRODUCT_CODE as BATCH_BARCODE ,a.MRP,a.BIN_ID,
						 SR=dense_rank() OVER(PARTITION BY A.PRODUCT_CODE,a.mrp,a.bin_id ORDER BY A.PRODUCT_CODE,a.mrp,a.bin_id),b.quantity_in_stock
				 FROM WSL_ITEM_DETAILS A (NOLOCK)
				 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE=b.product_code and a.BIN_ID =b.BIN_ID
				 JOIN SKU D (NOLOCK) ON D.PRODUCT_CODE=B.PRODUCT_CODE	and a.mrp =d.mrp
				 JOIN BIN  (NOLOCK) ON BIN.BIN_ID=B.BIN_ID
				 JOIN BINUSERS C ON C.BIN_ID=BIN.MAJOR_BIN_ID AND C.USER_CODE =@CUSERCODE
				 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))  AND B.QUANTITY_IN_STOCK >0  AND B.DEPT_ID= @CDEPT_ID
				 AND B.BIN_ID<>'999' and isnull(b.pick_list_id,'')=''
				 and isnull(a.STOCK_NA ,0)=0
				 and a.PRODUCT_CODE  like '%@%'

			 END

		    IF EXISTS (SELECT TOP 1 'U' FROM #TMPMULTIPLEMRP WHERE SRNO>1)
			 BEGIN
				  SET @BMULTIPLEMRP=1
				  GOTO END_PROC
			 END

			 Update a set QUANTITY_IN_STOCK=b.quantity_in_stock
			 from WSL_ITEM_DETAILS a (nolock)
			 join #TMPMULTIPLEMRP b on a.PRODUCT_CODE=b.product_code and a.BIN_ID =b.bin_id and a.mrp =b.mrp 
			 WHERE A.SP_ID=RTRIM(LTRIM(@csp_id))

   GOTO END_PROC


   end_proc:


end