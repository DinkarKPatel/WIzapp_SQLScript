create PROCEDURE SP3S_STOCK_LEVEL_REPORT
(
  @CMEMOID VARCHAR(50),
  @cFrom Varchar(10)='',
  @cTo Varchar(10)=''
)
with recompile
AS
BEGIN

             DECLARE @CCMD NVARCHAR(MAX),@COLNAME NVARCHAR(MAX),
             @SHOW_ARTICLE BIT,@SHOW_SUB_SECTION BIT,@SHOW_SECTION BIT,
             @SHOW_PARA1 BIT,@SHOW_PARA2 BIT,@SHOW_PARA3 BIT,@SHOW_PARA4 BIT,@SHOW_PRODUCT BIT,
             @SHOW_PARA5 BIT,@SHOW_PARA6 BIT,@SHOWCOL VARCHAR(MAX),
             @JOINSTR VARCHAR(MAX),@CFILTER VARCHAR(MAX),@CORDERCOL VARCHAR(MAX),@SHOW_MRP BIT,
             @CSKUJIONS VARCHAR(MAX),@CSKUCOLUMNS VARCHAR(MAX),@CCMD1 nvarchar(max)
             

			SELECT @SHOW_ARTICLE=SHOW_ARTICLE,@SHOW_SUB_SECTION=SHOW_SUB_SECTION,@SHOW_SECTION=SHOW_SECTION,
			@SHOW_PARA1=SHOW_PARA1,@SHOW_PARA2=SHOW_PARA2,@SHOW_PARA3=SHOW_PARA3,@SHOW_PARA4=SHOW_PARA4,
			@SHOW_PARA5=SHOW_PARA5,@SHOW_PARA6=SHOW_PARA6,@SHOW_PRODUCT= SHOW_PRODUCT,@SHOW_MRP= SHOW_MRP
			FROM LOC_STOCK_LEVEL_COL_DET 
			WHERE MEMO_ID=@CMEMOID

			SET @SHOW_ARTICLE=1
			SET @SHOW_SECTION=1
			SET @SHOW_SUB_SECTION=1

			Select  @SHOW_PARA1 = OPEN_KEY
			from CONFIG_BUYERORDER  where COLUMN_NAME = 'PARA1_NAME'

			Select  @SHOW_PARA2 = OPEN_KEY
			from CONFIG_BUYERORDER  where COLUMN_NAME = 'PARA2_NAME'

			Select  @SHOW_PARA3 = OPEN_KEY
			from CONFIG_BUYERORDER  where COLUMN_NAME = 'PARA3_NAME'
			

			   SELECT @SHOWCOL='',@COLNAME='',@JOINSTR='',@CFILTER='',@COLNAME='',@CORDERCOL='',@CSKUCOLUMNS='',@CSKUJIONS=''
                    
               SET @CFILTER=' AB.MEMO_ID= '''+ @CMEMOID + ''''
                  

            
            IF 1=1
               SET @CORDERCOL='SECTION_NAME,'
            IF 1=1
                SET @CORDERCOL=@CORDERCOL+'SUB_SECTION_NAME,'
            IF 1=1
                 SET @CORDERCOL=@CORDERCOL+'ARTICLE_NO,'  
				 
            IF @SHOW_PRODUCT=1
                 SET @CORDERCOL=@CORDERCOL+'PRODUCT_CODE,'  
            IF @SHOW_PARA1=1
                 SET @CORDERCOL=@CORDERCOL+'PARA1_NAME,'  
            IF @SHOW_PARA2=1
              SET @CORDERCOL=@CORDERCOL+'PARA2_NAME,'
            IF @SHOW_PARA3=1
             SET @CORDERCOL=@CORDERCOL+'PARA3_NAME,'
            IF @SHOW_PARA4=1
               SET @CORDERCOL=@CORDERCOL+'PARA4_NAME,'
            IF @SHOW_PARA5=1
               SET @CORDERCOL=@CORDERCOL+'PARA5_NAME,'
            IF @SHOW_PARA6=1
               SET @CORDERCOL=@CORDERCOL+'PARA6_NAME,'
                    
            
        
        
             IF @SHOW_ARTICLE=1 
             BEGIN
                SET @COLNAME='ARTICLE.[ARTICLE_CODE],ARTICLE.[ARTICLE_NO],ARTICLE.[ARTICLE_NAME],'
                SET @SHOWCOL='B.ARTICLE_CODE,B.ARTICLE_NO,[ARTICLE_NAME],'
                SET @JOINSTR=' JOIN ARTICLE (NOLOCK) ON ab.ARTICLE_CODE = ARTICLE.ARTICLE_CODE
                            '

                SET @CSKUJIONS=@CSKUJIONS+' AND SKU_NAMES.ARTICLE_NO =B.ARTICLE_NO'
				SET @CSKUCOLUMNS=@CSKUCOLUMNS+',SKU_NAMES.ARTICLE_NO'
             END
                      
             
             IF @SHOW_PRODUCT=1
             BEGIN
                SET @COLNAME=@COLNAME + 'SKU.[PRODUCT_CODE],'
                SET @SHOWCOL=@SHOWCOL +'B.PRODUCT_CODE,'     

				SET @CSKUJIONS=@CSKUJIONS+' AND SKU_NAMES.PRODUCT_CODE =B.PRODUCT_CODE'
				SET @CSKUCOLUMNS=@CSKUCOLUMNS+',SKU_NAMES.PRODUCT_CODE'
             END             
              
			IF @SHOW_SUB_SECTION=1
            BEGIN
              SET @COLNAME=@COLNAME+'SECTIOND.[SUB_SECTION_CODE],SECTIOND.[SUB_SECTION_NAME], ' 
              SET @SHOWCOL=@SHOWCOL+ 'B.SUB_SECTION_CODE,B.SUB_SECTION_NAME,'
               SET @JOINSTR=@JOINSTR+ ' JOIN SECTIOND (NOLOCK) ON article.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE'

			    SET @CSKUJIONS=@CSKUJIONS+' AND SKU_NAMES.SUB_SECTION_NAME =B.SUB_SECTION_NAME'
				SET @CSKUCOLUMNS=@CSKUCOLUMNS+',SKU_NAMES.SUB_SECTION_NAME'
            END


            IF @SHOW_SECTION=1
            BEGIN
              SET @COLNAME=@COLNAME+'SECTIONM.[SECTION_CODE],SECTIONM.[SECTION_NAME], '
              SET @SHOWCOL=@SHOWCOL+ 'B.SECTION_CODE,B.SECTION_NAME,'
              SET @JOINSTR=@JOINSTR+' JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE'  

			   SET @CSKUJIONS=@CSKUJIONS+' AND SKU_NAMES.SECTION_NAME =B.SECTION_NAME'
				SET @CSKUCOLUMNS=@CSKUCOLUMNS+',SKU_NAMES.SECTION_NAME'
            END
             
           
		
              
            IF @SHOW_PARA1=1
            BEGIN
            
              SET @COLNAME=@COLNAME+'PARA1.[PARA1_CODE],PARA1.[PARA1_NAME], ' 
              SET @SHOWCOL=@SHOWCOL+ 'B.PARA1_CODE,B.PARA1_NAME,'
              SET @JOINSTR=@JOINSTR+ '  JOIN PARA1 (NOLOCK) ON AB.PARA1_CODE = PARA1.PARA1_CODE' 
               
                 SET @CSKUJIONS=@CSKUJIONS+' AND SKU_NAMES.PARA1_NAME =B.PARA1_NAME'
				SET @CSKUCOLUMNS=@CSKUCOLUMNS+',SKU_NAMES.PARA1_NAME'
            END
             
            IF @SHOW_PARA2=1
            BEGIN
              SET @COLNAME=@COLNAME+'PARA2.[PARA2_CODE],PARA2.[PARA2_NAME], ' 
              SET @SHOWCOL=@SHOWCOL+ 'B.PARA2_CODE,B.PARA2_NAME,'
               SET @JOINSTR=@JOINSTR+ '  JOIN PARA2 (NOLOCK) ON AB.PARA2_CODE = PARA2.PARA2_CODE'
               
                SET @CSKUJIONS=@CSKUJIONS+' AND SKU_NAMES.PARA2_NAME =B.PARA2_NAME'
				SET @CSKUCOLUMNS=@CSKUCOLUMNS+',SKU_NAMES.PARA2_NAME'
            END
              
            IF @SHOW_PARA3=1
            BEGIN
              SET @COLNAME=@COLNAME+'PARA3.[PARA3_CODE],PARA3.[PARA3_NAME], ' 
              SET @SHOWCOL=@SHOWCOL+ 'B.PARA3_CODE,B.PARA3_NAME,'
               SET @JOINSTR=@JOINSTR+ '  JOIN PARA3 (NOLOCK) ON AB.PARA3_CODE = PARA3.PARA3_CODE'
               
                
                SET @CSKUJIONS=@CSKUJIONS+' AND SKU_NAMES.PARA3_NAME =B.PARA3_NAME'
				SET @CSKUCOLUMNS=@CSKUCOLUMNS+',SKU_NAMES.PARA3_NAME'
            END
             
            IF @SHOW_PARA4=1
            BEGIN
              SET @COLNAME=@COLNAME+'PARA4.[PARA4_CODE],PARA4.[PARA4_NAME], ' 
              SET @SHOWCOL=@SHOWCOL+ 'B.PARA4_CODE,B.PARA4_NAME,'
               SET @JOINSTR=@JOINSTR+ ' JOIN PARA4 (NOLOCK) ON AB.PARA4_CODE = PARA4.PARA4_CODE'
             

			  SET @CSKUJIONS=@CSKUJIONS+' AND SKU_NAMES.PARA4_NAME =B.PARA4_NAME'
				SET @CSKUCOLUMNS=@CSKUCOLUMNS+',SKU_NAMES.PARA4_NAME'
            END
               
            IF @SHOW_PARA5=1
            BEGIN
              SET @COLNAME=@COLNAME+'PARA5.[PARA5_CODE],PARA5.[PARA5_NAME], ' 
              SET @SHOWCOL=@SHOWCOL+ 'B.PARA5_CODE,B.PARA5_NAME,'
               SET @JOINSTR=@JOINSTR+ ' JOIN PARA5 (NOLOCK) ON AB.PARA5_CODE = PARA5.PARA5_CODE'

			    SET @CSKUJIONS=@CSKUJIONS+' AND SKU_NAMES.PARA5_NAME =B.PARA5_NAME'
				SET @CSKUCOLUMNS=@CSKUCOLUMNS+',SKU_NAMES.PARA5_NAME'
            END
             
            IF @SHOW_PARA6=1
            BEGIN
              SET @COLNAME=@COLNAME+'PARA6.[PARA6_CODE],PARA6.[PARA6_NAME], ' 
              SET @SHOWCOL=@SHOWCOL+ 'B.PARA6_CODE,B.PARA6_NAME,'
               SET @JOINSTR=@JOINSTR+ ' JOIN PARA6 (NOLOCK) ON AB.PARA6_CODE = PARA6.PARA6_CODE'
               
			    SET @CSKUJIONS=@CSKUJIONS+' AND SKU_NAMES.PARA6_NAME =B.PARA6_NAME'
				SET @CSKUCOLUMNS=@CSKUCOLUMNS+',SKU_NAMES.PARA6_NAME'
            END
               
              
              SET @COLNAME=LEFT(@COLNAME,LEN(@COLNAME)-1)
              SET @SHOWCOL=LEFT(@SHOWCOL,LEN(@SHOWCOL)-1)
              SET @CORDERCOL=LEFT(@CORDERCOL,LEN(@CORDERCOL)-1)
              Declare @cSLSJOIN Varchar(MAx)
			  Set @cSLSJOIN= replace(@CSKUJIONS,'sku_names.','sls.' )
      
    

   SET @CCMD=N' 
	   SELECT B.DEPT_ID AS DEPT_ID '+@CSKUCOLUMNS+',SUM(QUANTITY_IN_STOCK) AS CBS
	   into #tmpcbs
	   FROM SKU_NAMES (NOLOCK)
	   JOIN PMT01106 B (NOLOCK) ON SKU_NAMES.PRODUCT_CODE=B.PRODUCT_CODE	   
	   WHERE B.BIN_ID<>''999''
	   GROUP BY B.DEPT_ID  '+@CSKUCOLUMNS+'
	   
	   SELECT B.LOCATION_CODE AS DEPT_ID '+@CSKUCOLUMNS+',SUM(a.QUANTITY) AS NSQ
	   into #TMPSLS
	   FROM SKU_NAMES (NOLOCK)
	   JOIN Cmd01106 a (NOLOCK) ON SKU_NAMES.PRODUCT_CODE=a.PRODUCT_CODE
	   join cmm01106 b (nolock) on a.cm_id= b.cm_id
	   where b.cancelled=0 and b.cm_dt between '''+@cFrom +''' and  '''+@cTo +'''  	 
	   GROUP BY B.LOCATION_CODE '+@CSKUCOLUMNS+'
	
   SELECT '+@SHOWCOL+',SUM(ISNULL(CBS , 0)) AS CBS,
        B.MRP_FROM,B.MRP_TO,B.dept_id,B.dept_name,B.STOCK_LEVEL_QTY,
         (SUM(ISNULL(CBS , 0))- STOCK_LEVEL_QTY) AS DIFF,
          SUM(ISNULL(NSQ , 0)) AS NSQ,b.STOCK_LEVEL_PERCENTAGE,b.item_remarks,
		   AT1.attr1_key_name,AT2.attr2_key_name,AT3.attr3_key_name,AT4.attr4_key_name,AT5.attr5_key_name,AT6.attr6_key_name, AT7.attr7_key_name,AT8.attr8_key_name,
		   AT9.attr9_key_name,AT10.attr10_key_name,AT11.attr11_key_name,AT12.attr12_key_name, AT13.attr13_key_name,AT14.attr14_key_name,AT15.attr15_key_name,AT16.attr16_key_name,
		   AT17.attr17_key_name,AT18.attr18_key_name, AT19.attr19_key_name,AT20.attr20_key_name,AT21.attr21_key_name,AT22.attr22_key_name,AT23.attr23_key_name,AT24.attr24_key_name, AT25.attr25_key_name
     FROM 
           (
				SELECT '+@COLNAME+'
					  ,MRP_FROM,MRP_TO,loc.dept_id,loc.dept_name
					   ,STOCK_LEVEL_QTY,AB.STOCK_LEVEL_PERCENTAGE,item_remarks
				 from LOC_STOCK_LEVEL AB
				 JOIN loc_stock_level_mst a (NOLOCK) on a.memo_id=ab.memo_id
				 LEFT JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=a.target_dept_id
				 '+@JOINSTR+'
				WHERE '+@CFILTER+'
				GROUP BY '+@COLNAME+',STOCK_LEVEL_QTY,MRP_FROM,MRP_TO,loc.dept_id,loc.dept_name,ab.STOCK_LEVEL_PERCENTAGE,item_remarks

	 ) B  
	 left join #tmpcbs SKU_NAMES ON SKU_NAMES.DEPT_ID=B.DEPT_ID '+@CSKUJIONS+' 
	 left join #TMPSLS SLS ON B.DEPT_ID=SLS.DEPT_ID '+@cSLSJOIN+' '
	 
	SET @CCMD1=N' LEFT OUTER JOIN ARTICLE_FIX_ATTR ATTR  (NOLOCK) ON b.ARTICLE_CODE = ATTR.ARTICLE_CODE       
	 LEFT OUTER JOIN ATTR1_MST AT1 (NOLOCK) ON AT1.ATTR1_KEY_CODE=ATTR.ATTR1_KEY_CODE      
	 LEFT OUTER JOIN ATTR2_MST AT2 (NOLOCK) ON AT2.ATTR2_KEY_CODE=ATTR.ATTR2_KEY_CODE      
	 LEFT OUTER JOIN ATTR3_MST AT3 (NOLOCK) ON AT3.ATTR3_KEY_CODE=ATTR.ATTR3_KEY_CODE      
	 LEFT OUTER JOIN ATTR4_MST AT4 (NOLOCK) ON AT4.ATTR4_KEY_CODE=ATTR.ATTR4_KEY_CODE      
	 LEFT OUTER JOIN ATTR5_MST AT5 (NOLOCK) ON AT5.ATTR5_KEY_CODE=ATTR.ATTR5_KEY_CODE      
	 LEFT OUTER JOIN ATTR6_MST AT6 (NOLOCK) ON AT6.ATTR6_KEY_CODE=ATTR.ATTR6_KEY_CODE      
	 LEFT OUTER JOIN ATTR7_MST AT7 (NOLOCK) ON AT7.ATTR7_KEY_CODE=ATTR.ATTR7_KEY_CODE      
	 LEFT OUTER JOIN ATTR8_MST AT8 (NOLOCK) ON AT8.ATTR8_KEY_CODE=ATTR.ATTR8_KEY_CODE      
	 LEFT OUTER JOIN ATTR9_MST AT9 (NOLOCK) ON AT9.ATTR9_KEY_CODE=ATTR.ATTR9_KEY_CODE      
	 LEFT OUTER JOIN ATTR10_MST AT10 (NOLOCK) ON AT10.ATTR10_KEY_CODE=ATTR.ATTR10_KEY_CODE      
	 LEFT OUTER JOIN ATTR11_MST AT11 (NOLOCK) ON AT11.ATTR11_KEY_CODE=ATTR.ATTR11_KEY_CODE      
	 LEFT OUTER JOIN ATTR12_MST AT12 (NOLOCK) ON AT12.ATTR12_KEY_CODE=ATTR.ATTR12_KEY_CODE      
	 LEFT OUTER JOIN ATTR13_MST AT13 (NOLOCK) ON AT13.ATTR13_KEY_CODE=ATTR.ATTR13_KEY_CODE      
	 LEFT OUTER JOIN ATTR14_MST AT14 (NOLOCK) ON AT14.ATTR14_KEY_CODE=ATTR.ATTR14_KEY_CODE      
	 LEFT OUTER JOIN ATTR15_MST AT15 (NOLOCK) ON AT15.ATTR15_KEY_CODE=ATTR.ATTR15_KEY_CODE      
	 LEFT OUTER JOIN ATTR16_MST AT16 (NOLOCK) ON AT16.ATTR16_KEY_CODE=ATTR.ATTR16_KEY_CODE      
	 LEFT OUTER JOIN ATTR17_MST AT17 (NOLOCK) ON AT17.ATTR17_KEY_CODE=ATTR.ATTR17_KEY_CODE      
	 LEFT OUTER JOIN ATTR18_MST AT18 (NOLOCK) ON AT18.ATTR18_KEY_CODE=ATTR.ATTR18_KEY_CODE      
	 LEFT OUTER JOIN ATTR19_MST AT19 (NOLOCK) ON AT19.ATTR19_KEY_CODE=ATTR.ATTR19_KEY_CODE      
	 LEFT OUTER JOIN ATTR20_MST AT20 (NOLOCK) ON AT20.ATTR20_KEY_CODE=ATTR.ATTR20_KEY_CODE      
	 LEFT OUTER JOIN ATTR21_MST AT21 (NOLOCK) ON AT21.ATTR21_KEY_CODE=ATTR.ATTR21_KEY_CODE      
	 LEFT OUTER JOIN ATTR22_MST AT22 (NOLOCK) ON AT22.ATTR22_KEY_CODE=ATTR.ATTR22_KEY_CODE      
	 LEFT OUTER JOIN ATTR23_MST AT23 (NOLOCK) ON AT23.ATTR23_KEY_CODE=ATTR.ATTR23_KEY_CODE      
	 LEFT OUTER JOIN ATTR24_MST AT24 (NOLOCK) ON AT24.ATTR24_KEY_CODE=ATTR.ATTR24_KEY_CODE      
	 LEFT OUTER JOIN ATTR25_MST AT25(NOLOCK) ON AT25.ATTR25_KEY_CODE=ATTR.ATTR25_KEY_CODE    
	 GROUP BY '+@SHOWCOL+',B.STOCK_LEVEL_QTY,B.MRP_FROM,B.MRP_TO,B.dept_id,B.dept_name,b.STOCK_LEVEL_PERCENTAGE,b.item_remarks,
	 AT1.attr1_key_name,AT2.attr2_key_name,AT3.attr3_key_name,AT4.attr4_key_name,AT5.attr5_key_name,AT6.attr6_key_name,    
     AT7.attr7_key_name,AT8.attr8_key_name,AT9.attr9_key_name,AT10.attr10_key_name,AT11.attr11_key_name,AT12.attr12_key_name,    
	 AT13.attr13_key_name,AT14.attr14_key_name,AT15.attr15_key_name,AT16.attr16_key_name,AT17.attr17_key_name,AT18.attr18_key_name,    
	 AT19.attr19_key_name,AT20.attr20_key_name,AT21.attr21_key_name,AT22.attr22_key_name,AT23.attr23_key_name,AT24.attr24_key_name,    
	 AT25.attr25_key_name
	 ORDER BY '+@CORDERCOL+''
	 
	 PRINT @CCMD
	 print @CCMD1
	 set @CCMD=@CCMD+@CCMD1
	 EXEC SP_EXECUTESQL @CCMD          
     
         
                   
                          

END