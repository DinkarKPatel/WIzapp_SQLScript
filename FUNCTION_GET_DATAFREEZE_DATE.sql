CREATE FUNCTION DBO.GET_DATAFREEZE_DATE(@USER VARCHAR(100),@XN_TYPE VARCHAR(MAX),@CURR_DT DATE)
RETURNS @DT TABLE (FREEZED_DATE DATE, ALLOW_VIEW BIT)
AS
BEGIN
--DECLARE @USER VARCHAR(100),@XN_TYPE VARCHAR(MAX),@CURR_DT DATE
DECLARE @RETURN BIT=0--UN FREEZED
--DECLARE @DT TABLE (FREEZED_DATE DATE, ALLOW_VIEW BIT)

DECLARE @FREEZE_DT DATE='1900-01-01',@ROLE_DT DATE='1900-01-01',@DAYS INT=0
DECLARE @TODAY DATE=CONVERT(DATE,GETDATE())

SELECT TOP 1 @FREEZE_DT=ISNULL(FIXEDDATE,'1900-01-01') FROM FIXEDFREEZE (NOLOCK) WHERE XN_TYPE=@XN_TYPE AND ISENABLED=1

SELECT TOP 1 @ROLE_DT=ISNULL(DATEADD(DD, -1*(ISNULL(D.FREEZEDAYS,0)+1),@TODAY),'1900-01-01'),@DAYS=ISNULL(D.FREEZEDAYS,0)+1,@RETURN=ISNULL(D.AllowRead,0)
FROM ROLLINGFREEZE D (NOLOCK) 
JOIN USERS U (NOLOCK) ON U.ROLE_ID=D.ROLE_ID
WHERE USER_CODE=@USER AND D.XN_TYPE=@XN_TYPE AND ISNULL(D.ROLE_ID,'')<>''
AND ISNULL(D.AllowRead,0)<>0

if @RETURN=0
	SET @FREEZE_DT='1900-01-01'
ELSE IF @ROLE_DT>@FREEZE_DT
   SET @FREEZE_DT=@ROLE_DT



	INSERT INTO @DT(FREEZED_DATE , ALLOW_VIEW)
	SELECT @FREEZE_DT,@RETURN--(CASE @RETURN WHEN 0 THEN 1 ELSE 0 END)

	RETURN 
END 
