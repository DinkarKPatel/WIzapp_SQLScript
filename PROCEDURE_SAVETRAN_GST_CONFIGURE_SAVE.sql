CREATE PROC SAVETRAN_GST_CONFIGURE_SAVE
(
  @NSPID INT       
)
--WITH ENCRYPTION
AS
BEGIN
   SET NOCOUNT ON
   --SET NOCOUNT OFF
   DECLARE --MAIN TABLE TO SAVE/UPDATE
           @CMASTERTABLENAME VARCHAR(100),
           @CDETAILSTABLENAME VARCHAR(100),
           @CDETAILSTABLENAME1 VARCHAR(100),
           @CDETAILSTABLENAME2 VARCHAR(100),
           @CDETAILSTABLENAME3 VARCHAR(100),
           @CDETAILSTABLENAME4 VARCHAR(100),
           
           --SOURCE TABLES TO SAVE/UPDATE THE MAIN TABLES
           @CSOURCEMASTERTABLENAME VARCHAR(100),
           @CSOURCEDETAILSTABLENAME VARCHAR(100),
           @CSOURCEDETAILSTABLENAME1 VARCHAR(100),
           @CSOURCEDETAILSTABLENAME2 VARCHAR(100),
           @CSOURCEDETAILSTABLENAME3 VARCHAR(100),
           @CSOURCEDETAILSTABLENAME4 VARCHAR(100),
           
           --OTHER VARIABLE TO PROCESS THE DATA
		   @CTEMPDBNAME VARCHAR(100),		
		   @NSTEP VARCHAR(10),
		   @BENABLETEMPDB BIT,
		   @CERRORMSG VARCHAR(500),
		   @CKEYFIELD VARCHAR(22),
		   @CMEMONOVAL VARCHAR(22),	
	       @CCMD NVARCHAR(MAX),
	       @NLOOPOUTPUT BIT,
	       @CHODEPT_ID VARCHAR(4)
	      
   SELECT TOP 1 @CHODEPT_ID=VALUE  FROM CONFIG WHERE CONFIG_OPTION ='HO_LOCATION_ID'
	      
   DECLARE @OUTPUT TABLE(ERRMSG VARCHAR(2000),CAT_ID VARCHAR(22))
   SET @NSTEP = 0		-- SETTTING UP ENVIRONMENT		
	SET @CTEMPDBNAME = ''			  
   PRINT @CTEMPDBNAME	  
   
   --MAIN TABLE NAME 
   SET @CMASTERTABLENAME ='GST_XN_FORMAT'	
   SET @CDETAILSTABLENAME ='GST_XN_DETAIL'		
   SET @CDETAILSTABLENAME1 ='GST_TNC'
   SET @CDETAILSTABLENAME2 ='GST_QUOTATION_MST'
   SET @CDETAILSTABLENAME3 ='GST_SLS_CUSTOMER_CONFIG'
   SET @CDETAILSTABLENAME4 ='GST_COMPANY_CONFIG'
       
   --SOURCE TABLE NAME
   SET @CSOURCEMASTERTABLENAME=@CTEMPDBNAME+'TEMP_GST_XN_FORMAT_'+LTRIM(RTRIM(STR(@NSPID)))
   SET @CSOURCEDETAILSTABLENAME=@CTEMPDBNAME+'TEMP_GST_XN_DETAIL_'+LTRIM(RTRIM(STR(@NSPID)))
   SET @CSOURCEDETAILSTABLENAME1=@CTEMPDBNAME+'TEMP_GST_TNC_'+LTRIM(RTRIM(STR(@NSPID)))
   SET @CSOURCEDETAILSTABLENAME2=@CTEMPDBNAME+'TEMP_GST_QUOTATION_MST_'+LTRIM(RTRIM(STR(@NSPID)))
   SET @CSOURCEDETAILSTABLENAME3=@CTEMPDBNAME+'TEMP_GST_SLS_CUSTOMER_CONFIG_'+LTRIM(RTRIM(STR(@NSPID)))
   SET @CSOURCEDETAILSTABLENAME4=@CTEMPDBNAME+'TEMP_GST_COMPANY_CONFIG_'+LTRIM(RTRIM(STR(@NSPID)))
   SET @CKEYFIELD='XN_TYPE'
   
   BEGIN TRY
   BEGIN TRANSACTION
   SET @NSTEP = 60	-- UPDATING NEW ID INTO TEMP TABLES
	   
   SET @NSTEP = 80
   --GST_XN_DETAIL
  
  
  
   SET @NSTEP = 81
   EXEC UPDATEMASTERXN @CSOURCEDB	  = @CTEMPDBNAME
					  ,@CSOURCETABLE  = @CSOURCEDETAILSTABLENAME
					  ,@CDESTDB		  = ''
					  ,@CDESTTABLE	  = @CDETAILSTABLENAME
					  ,@CKEYFIELD1	  = @CKEYFIELD
					  ,@CKEYFIELD2	  = 'COLUMNNAME'
					  ,@BALWAYSUPDATE = 1
					  
   SET @NSTEP = 91		
   EXEC UPDATEMASTERXN @CSOURCEDB	  = @CTEMPDBNAME
					  ,@CSOURCETABLE  = @CSOURCEDETAILSTABLENAME1
					  ,@CDESTDB		  = ''
					  ,@CDESTTABLE	  = @CDETAILSTABLENAME1
					  ,@CKEYFIELD1	  = @CKEYFIELD
					  ,@CKEYFIELD2	  = ''
					  ,@BALWAYSUPDATE = 1   
					  
   SET @NSTEP = 101
   EXEC UPDATEMASTERXN @CSOURCEDB	  = @CTEMPDBNAME
					  ,@CSOURCETABLE  = @CSOURCEDETAILSTABLENAME2
					  ,@CDESTDB		  = ''
					  ,@CDESTTABLE	  = @CDETAILSTABLENAME2
					  ,@CKEYFIELD1	  = @CKEYFIELD
					  ,@CKEYFIELD2	  = ''
					  ,@BALWAYSUPDATE = 1   
   SET @NSTEP = 121   				  
   SET @CCMD ='IF EXISTS(SELECT * FROM '+CASE @CTEMPDBNAME WHEN '' THEN '' ELSE REPLACE(@CTEMPDBNAME,'.DBO.','.') END+'INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME='''+@CSOURCEDETAILSTABLENAME3+''')
                  EXEC UPDATEMASTERXN @CSOURCEDB = '''+@CTEMPDBNAME+''''
                       +',@CSOURCETABLE  = '''+@CSOURCEDETAILSTABLENAME3+''''
					   +',@CDESTDB		  = '''''
					   +',@CDESTTABLE	  = '''+@CDETAILSTABLENAME3+''''
					   +',@CKEYFIELD1	  = '''+@CKEYFIELD+''''
					   +',@CKEYFIELD2	  = '' '''
					   +',@BALWAYSUPDATE = 1
			   '		     
   --PRINT @CCMD
   EXEC SP_EXECUTESQL @CCMD
   
   SET @NSTEP = 131		
   EXEC UPDATEMASTERXN @CSOURCEDB	  = @CTEMPDBNAME
					  ,@CSOURCETABLE  = @CSOURCEDETAILSTABLENAME4
					  ,@CDESTDB		  = ''
					  ,@CDESTTABLE	  = @CDETAILSTABLENAME4
					  ,@CKEYFIELD1	  = @CKEYFIELD
					  ,@CKEYFIELD2	  = ''
					  ,@BALWAYSUPDATE = 1   
					  
   END TRY
   
   BEGIN CATCH
	  SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
	  GOTO END_PROC
   END CATCH
   
END_PROC:
   IF @@TRANCOUNT>0
	  BEGIN
		IF ISNULL(@CERRORMSG,'')=''
		   COMMIT TRANSACTION
		ELSE
			ROLLBACK 	
	  END 

   IF ISNULL(@CERRORMSG,'')=''
	  BEGIN
		 SET @CCMD = N'IF OBJECT_ID('''+@CSOURCEMASTERTABLENAME  +''',''U'') IS NOT NULL
						  DROP TABLE '+@CSOURCEMASTERTABLENAME+'
									
					   IF OBJECT_ID('''+@CSOURCEDETAILSTABLENAME +''',''U'') IS NOT NULL
						  DROP TABLE '+@CSOURCEDETAILSTABLENAME+'
											
					   IF OBJECT_ID('''+@CSOURCEDETAILSTABLENAME1+''',''U'') IS NOT NULL
						  DROP TABLE '+@CSOURCEDETAILSTABLENAME1+'

					   IF OBJECT_ID('''+@CSOURCEDETAILSTABLENAME2+''',''U'') IS NOT NULL
						  DROP TABLE '+@CSOURCEDETAILSTABLENAME2+'

					   IF OBJECT_ID('''+@CSOURCEDETAILSTABLENAME3+''',''U'') IS NOT NULL
						  DROP TABLE '+@CSOURCEDETAILSTABLENAME3+'

					   IF OBJECT_ID('''+@CSOURCEDETAILSTABLENAME4+''',''U'') IS NOT NULL
						  DROP TABLE '+@CSOURCEDETAILSTABLENAME4+'
						  
					  '
		 PRINT @CCMD
		 EXEC SP_EXECUTESQL @CCMD
      END		
		  
   SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
   SET NOCOUNT OFF
END
--END OF PROCEDURE SAVETRAN_GST_CONFIGURE_SAVE
