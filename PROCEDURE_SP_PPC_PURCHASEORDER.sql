CREATE PROCEDURE SP_PPC_PURCHASEORDER        
(        
 @CQUERYID  NUMERIC(2),        
 @CWHERE   VARCHAR(100)='',        
 @CFINYEAR  VARCHAR(5)='',        
 @CDEPTID  VARCHAR(2)='',        
 @NNAVMODE  NUMERIC(2)=1,        
 @CWHERECLAUSE   VARCHAR(500)=''        
)       
----WITH ENCRYPTION      
       
AS        
BEGIN        
DECLARE @CCMD NVARCHAR(MAX),@cHEAD_CODE VARCHAR(MAX)        
SET @CCMD=''        
    IF @CQUERYID=1        
  GOTO LBLPOLU        
 ELSE IF @CQUERYID=2        
  GOTO LBLMST        
 ELSE IF @CQUERYID=3        
  GOTO LBLDET        
 ELSE IF @CQUERYID=4        
  GOTO LBLPARA1        
 ELSE IF @CQUERYID=5        
  GOTO LBLPARA2        
 ELSE IF @CQUERYID=6        
  GOTO LBLPARA3         
 ELSE IF @CQUERYID=10        
  GOTO LBLSUPPLIERS        
 ELSE IF @CQUERYID=11        
  GOTO LBLARTICLELIST        
 ELSE IF @CQUERYID=12        
  GOTO LBLARTICLEINFO        
 ELSE IF @CQUERYID=13        
  GOTO LBLFORMS        
 ELSE IF @CQUERYID=14        
  GOTO LBLARTICLESKUINFO        
 ELSE IF @CQUERYID=15        
  GOTO LBLARTPARA2LIST        
 ELSE IF @CQUERYID=16        
  GOTO LBLARTPARA1LIST        
 ELSE IF @CQUERYID=17        
  GOTO LBLQBF        
 ELSE IF @CQUERYID=18        
  GOTO LBLLOCLIST        
 ELSE IF @CQUERYID=19          
  GOTO LBL19          
 ELSE IF @CQUERYID=20          
  GOTO LBL20       
        
 ELSE         
         
  GOTO LAST        
          
LBLPOLU:        
 EXECUTE SP_NAVIGATE 'PPC_POM01106',@NNAVMODE,@CWHERE,@CFINYEAR,'PO_NO','PO_DT','PO_ID',@CWHERECLAUSE        
  -- @NMODE :  1 - TOP RECORD        
  --    2 - NEXT RECORD (@CREFMEMOID AND @CREFMEMODT IS MANDATORY)        
  --    3 - PREVIOUS RECORD (@CREFMEMOID AND @CREFMEMODT IS MANDATORY)        
  --    4 - LAST RECORD        
 GOTO LAST        
         
LBLMST:        
        
 SELECT A.ORDER_TYPE, BILL.BILL_NO, CONVERT(VARCHAR,PO_DT,105) AS PO_DT1, 
   ISNULL(U1.USERNAME,'') AS CREATED_BY,
   ISNULL(U2.USERNAME,'') AS APPROVED_BY,
   A.*, 0.00 AS TOTAL_QTY,        
   B.AC_NAME, C.DEPT_NAME,C.DEPT_ID , B.ADDRESS0,          
   B.ADDRESS1, B.ADDRESS2, B.AREA_NAME, B.CITY, B.PINCODE, B.STATE, B.SST_NO,          
   B.SST_DT, B.TIN_NO, B.TIN_DT,D.USERNAME,E.USERNAME AS EDT_USERNAME ,        
   (C.ADDRESS1 +' '+ C.ADDRESS2) AS STORE_ADDRESS  ,PM.TERM_NAME,PM.MEMO_ID  --ADD BY JAI RAM KUMAR 
   FROM PPC_POM01106 A           
   JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE           
   JOIN USERS D ON A.USER_CODE = D.USER_CODE           
   JOIN USERS E ON A.EDT_USER_CODE = E.USER_CODE  
   LEFT JOIN USERS U1 ON A.CREATED_BY = U1.USER_CODE  
   LEFT JOIN USERS U2 ON A.APPROVED_BY = U2.USER_CODE  
   LEFT JOIN DBO.PPC_TERM_CONDITION_MST PM ON A.TERMS_MEMO_ID = PM.MEMO_ID   --ADD BY JAI RAM KUMAR      
   JOIN LOCATION C ON A.DEPT_ID = C.DEPT_ID     
   LEFT JOIN
	(
	 SELECT D.BILL_NO ,A.PO_ID   FROM PPC_POD01106 A
	 JOIN PPC_BO_ART_BOM B ON BO_BOM_ROW_ID =B.ROW_ID 
	 JOIN PPC_BUYER_ORDER_DET  C ON C.ROW_ID  =B.REF_ROW_ID
	 JOIN PPC_BUYER_ORDER_MST D ON C.ORDER_ID =D.ORDER_ID 
	 GROUP BY D.BILL_NO ,A.PO_ID 
	) BILL ON BILL.PO_ID =A .PO_ID         
   WHERE A.PO_ID = @CWHERE                  
          
    GOTO LAST        
            
LBLDET:        
 
 IF OBJECT_ID('TEMPDB..#TMPPO','U') IS NOT NULL
    DROP TABLE #TMPPO       
 SELECT   REPLACE (CONVERT(VARCHAR, FM_DT, 106),' ','/')  AS FM_DT1,
 REPLACE (CONVERT(VARCHAR, DELIVERY_DT, 106),' ','/')  AS DELIVERY_DT1,A.*,  CAST(0 AS NUMERIC(14,0)) AS SERIAL_NO,B.DT_CREATED,        
   B.ARTICLE_NO, B.ARTICLE_NAME, B.CODING_SCHEME,  B.PARA1_SET, B.PARA2_SET,I.UOM_CODE, I.UOM_NAME, I.UOM_TYPE,        
   C.PARA1_NAME,D.PARA2_NAME,E.PARA3_NAME,       
   '' AS JRD_ROW_ID, '' AS JID_ROW_ID, '' AS JOD_ROW_ID ,        
   M.SUB_SECTION_NAME,N.SECTION_NAME,B.FIX_MRP,      
   ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],            
   '' AS [SKU_DT_CREATED],'' AS [IMAGE_1]  ,
   ISNULL(CM.CURRENCY_NAME,'') AS CURRENCY_NAME
   
 INTO #TMPPO   
 FROM PPC_POD01106 A           
 JOIN PPC_POM01106 R ON R.PO_ID= A.PO_ID           
 LEFT OUTER JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE        
 LEFT OUTER JOIN PARA1 C ON A.PARA1_CODE = C.PARA1_CODE          
 LEFT OUTER JOIN PARA2 D ON A.PARA2_CODE = D.PARA2_CODE           
 LEFT OUTER JOIN PARA3 E ON A.PARA3_CODE = E.PARA3_CODE             
 LEFT OUTER JOIN UOM I ON B.UOM_CODE = I.UOM_CODE           
 LEFT OUTER JOIN SECTIOND M ON B.SUB_SECTION_CODE = M.SUB_SECTION_CODE         
 LEFT OUTER JOIN SECTIONM N ON M.SECTION_CODE = N.SECTION_CODE     
 LEFT OUTER JOIN PPC_CURRENCY_MST CM ON CM.CURRENCY_CODE=A.CURRENCY_CODE   
 ----LEFT JOIN PPC_BO_ART_BOM BOM (NOLOCK) ON BOM.ROW_ID = A.BO_BOM_ROW_ID   
 ----LEFT JOIN
 ---- (  
 ----   SELECT DISTINCT  A.ROW_ID ,B.BILL_NO ,B.ORDER_NO AS MEMO_NO,B.REF_NO,A.ITEM_REMARKS AS WSL_REMARKS  
 ----   FROM PPC_BUYER_ORDER_DET A  
 ----   JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID =B.ORDER_ID  
 ----   WHERE B.CANCELLED =0  
 ---- ) BO ON BO.ROW_ID =BOM.REF_ROW_ID   
 --LEFT OUTER JOIN PRD_SKU ON SKU.PRODUCT_CODE=A.PRODUCT_CODE          
 WHERE A.PO_ID = @CWHERE        
 ORDER BY  SRNO        
 
 SELECT * FROM #TMPPO
 ORDER BY SRNO
 
 
 SELECT UOM_NAME, SUM(QUANTITY)  AS QUANTITY  
 FROM #TMPPO  
 GROUP BY UOM_NAME
 ORDER BY UOM_NAME 
 
 GOTO LAST        
            
LBLPARA1:        
 SELECT A.PARA1_CODE, A.PARA1_NAME FROM PARA1 A         
 WHERE PARA1_NAME <> '' AND A.INACTIVE = 0 ORDER BY A.PARA1_NAME          
            
    GOTO LAST        
        
LBLPARA2:        
 SELECT A.PARA2_CODE, A.PARA2_NAME, A.PARA2_ORDER FROM PARA2 A         
    WHERE A.PARA2_NAME <> '' AND A.INACTIVE = 0 ORDER BY A.PARA2_ORDER        
            
    GOTO LAST        
            
LBLPARA3:        
          
 SELECT A.PARA3_CODE, A.PARA3_NAME FROM PARA3 A         
    WHERE A.PARA3_NAME <> '' AND A.INACTIVE = 0 ORDER BY A.PARA3_NAME        
            
    GOTO LAST        
        
      
LBLSUPPLIERS:        
          
 --SET @CCMD = N'SELECT  A.AC_CODE, A.AC_NAME, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,              
 --   ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE, A.CITY, A.ADDRESS0 + '' '' +         
 --   A.ADDRESS1 + '' '' + A.ADDRESS2 + '' '' + A.AREA_NAME + '' '' + A.CITY + '' '' +               
 --   A.STATE AS SUPP_ADDRESS, AC_NAME AS REPCOLNAME               
 --   FROM LMV01106 A               
 --   WHERE ( CHARINDEX ( HEAD_CODE, DBO.FN_ACT_TRAVTREE (''' + @CWHERE + ''') ) > 0          
 --   OR ALLOW_CREDITOR_DEBTOR = 1  OR CHARINDEX ( HEAD_CODE, DBO.FN_ACT_TRAVTREE (''0000000018'') ) > 0 )               
 --   AND INACTIVE = 0 AND A.AC_NAME <> ''''         
 --   ORDER BY A.AC_NAME '        
       
  SET @cHEAD_CODE = DBO.FN_ACT_TRAVTREE (@CWHERE)----ADD VARIABLE BY GAURI ON 17/4/2019	
  
  SET @CCMD = N'SELECT  A.AC_CODE, A.AC_NAME, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,               
    ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE, A.CITY, A.ADDRESS0 + '' '' +         
    A.ADDRESS1 + '' '' + A.ADDRESS2 + '' '' + A.AREA_NAME + '' '' + A.CITY + '' '' +               
    A.STATE AS SUPP_ADDRESS, AC_NAME AS REPCOLNAME               
    FROM LMV01106 A               
    WHERE  HEAD_CODE IN( '+@cHEAD_CODE+' )		   ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019       
    AND INACTIVE = 0 AND A.AC_NAME <> ''''   ORDER BY A.AC_NAME '        
       
            
    EXEC SP_EXECUTESQL @CCMD        
                
    GOTO LAST        
            
LBLARTICLELIST:        
        
  SET @CWHERECLAUSE=''      
        
 SET @CCMD = N' SELECT DISTINCT A.ARTICLE_CODE, A.ARTICLE_NAME, A.ARTICLE_NO,        
  B.SUB_SECTION_NAME, C.SECTION_NAME '      
  IF(@CWHERECLAUSE <>'')        
   SET @CCMD= @CCMD + N',WOD.ARTICLE_CODE AS COMPONENT_CODE,ARTCOM.ARTICLE_NO AS COMPONENT,WOSD.PARA1_CODE AS COM_PARA1_CODE,WOSD.PARA2_CODE AS COM_PARA2_CODE       
   ,A.ARTICLE_CODE+''$''+WOD.ARTICLE_CODE+''$''+WOSD.PARA1_CODE+''$''+WOSD.PARA2_CODE AS UNIQUE_COL '      
SET @CCMD= @CCMD + N'  FROM ARTICLE A             
  JOIN SECTIOND B ON A.SUB_SECTION_CODE = B.SUB_SECTION_CODE            
  JOIN SECTIONM C ON B.SECTION_CODE = C.SECTION_CODE '           
 PRINT @CCMD        
 EXEC SP_EXECUTESQL @CCMD         
       
                
    GOTO LAST        
            
LBLARTICLEINFO:        
 SELECT A.ARTICLE_CODE, A.ARTICLE_DESC, A.ARTICLE_NAME, A.ARTICLE_NO, A.CODING_SCHEME,        
 A.PURCHASE_PRICE, A.MRP, A.WHOLESALE_PRICE, A.CREATED_ON, A.PARA1_SET, A.PARA2_SET, B.UOM_CODE,         
 B.UOM_NAME, B.UOM_TYPE, A.MP_PERCENTAGE ,A.FIX_MRP,      
  ISNULL(A.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(PARA3.DT_CREATED,'') AS [PARA3_DT_CREATED],            
 '' AS [SKU_DT_CREATED]        
 FROM ARTICLE A         
 JOIN UOM B ON A.UOM_CODE = B.UOM_CODE        
 LEFT JOIN PARA3 ON PARA3.PARA3_CODE=A.PARA3_CODE        
 WHERE A.ARTICLE_CODE=@CWHERE        
         
    GOTO LAST        
        
LBLFORMS:        
        
 --SELECT FORM_ID, FORM_NAME, TAX_PERCENTAGE FROM FORM         
 --WHERE FORM_NAME <> '' AND INACTIVE = 0  ORDER BY FORM_NAME        
       
 SELECT FORM_ID, FORM_NAME, TAX_PERCENTAGE FROM FORM         
 WHERE FORM_NAME <> '' AND INACTIVE = 0   --AND PURCHASE_AC_CODE <> '0000000000'      
 ORDER BY FORM_NAME        
         
 GOTO LAST        
        
LBLARTICLESKUINFO:        
        
 SELECT TOP 1 A.PARA1_CODE, A.PARA2_CODE, A.PARA3_CODE, A.PARA4_CODE, A.PARA5_CODE,         
    A.PARA6_CODE, P1.PARA1_NAME, P2.PARA2_NAME, P3.PARA3_NAME, P4.PARA4_NAME,         
    P5.PARA5_NAME, P6.PARA6_NAME, ART.DT_CREATED AS [ART_DT_CREATED],         
    P3.DT_CREATED AS [PARA3_DT_CREATED],ISNULL(A.DT_CREATED,'') AS [SKU_DT_CREATED],        
    A.MRP AS FIX_MRP        
   FROM PRD_SKU A         
    JOIN ARTICLE (NOLOCK) ART ON ART.ARTICLE_CODE= A.ARTICLE_CODE         
    JOIN PARA1 (NOLOCK) P1 ON A.PARA1_CODE = P1.PARA1_CODE         
    JOIN PARA2 (NOLOCK) P2 ON A.PARA2_CODE = P2.PARA2_CODE         
    JOIN PARA3 (NOLOCK) P3 ON A.PARA3_CODE = P3.PARA3_CODE         
    JOIN PARA4 (NOLOCK) P4 ON A.PARA4_CODE = P4.PARA4_CODE         
    JOIN PARA5 (NOLOCK) P5 ON A.PARA5_CODE = P5.PARA5_CODE         
    JOIN PARA6 (NOLOCK) P6 ON A.PARA6_CODE = P6.PARA6_CODE         
    WHERE A.ARTICLE_CODE = @CWHERE        
            
    GOTO LAST        
           
LBLARTPARA2LIST:        
 SELECT A.ARTICLE_CODE, A.PARA2_CODE, B.PARA2_NAME FROM ART_DET A         
    JOIN PARA2 B ON A.PARA2_CODE = B.PARA2_CODE        
    WHERE A.ARTICLE_CODE = @CWHERE        
    ORDER BY B.PARA2_ORDER        
            
 GOTO LAST        
        
LBLARTPARA1LIST:        
 SELECT A.ARTICLE_CODE, A.PARA1_CODE, B.PARA1_NAME FROM ART_PARA1 A         
    JOIN PARA1 B ON A.PARA1_CODE = B.PARA1_CODE        
    WHERE A.ARTICLE_CODE = @CWHERE        
    ORDER BY B.PARA1_NAME        
            
 GOTO LAST        
        
        
LBLQBF:        
        
 SET @CCMD=N'SELECT DISTINCT PO_ID AS XN_ID,MST_PO_NO AS XN_NO ,MST_XN_DT AS XN_DT, PO_ID ,MST_PO_NO AS PO_NO         
    FROM VW_PRD_PO_QBF  '+@CWHERE        
 EXEC SP_EXECUTESQL @CCMD        
            
 GOTO LAST        
        
LBLLOCLIST:        
 SELECT * FROM LOCATION WHERE INACTIVE=0 AND LOC_TYPE = 1 AND DEPT_ID<>@CWHERE          
    GOTO LAST           
            
LBL19:           
   SELECT  TOP 1 ISNULL(B.MRR_ID,'') AS MRR_ID,A.ROW_ID,B.PO_ROW_ID FROM PPC_POD01106 A        
   JOIN PPC_PID01106 B ON B.PO_ROW_ID=A.ROW_ID        
   WHERE A.PO_ID=@CWHERE        
   GOTO LAST               
         
         
         
   LBL20:      
 SET @CCMD= N'SELECT DISTINCT A.PO_NO,A.PO_DT,B.PRODUCT_CODE,       
    F.SECTION_NAME,E.SUB_SECTION_NAME,D.ARTICLE_NO,D.ARTICLE_NAME,      
    P1.PARA1_NAME,P2.PARA2_NAME,P3.PARA3_NAME,      
    P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME,D.CODING_SCHEME,      
    B.PURCHASE_PRICE,B.MRP,B.QUANTITY FROM PPC_POM01106 A      
    JOIN PPC_POD01106 B ON B.PO_ID=A.PO_ID       
    LEFT OUTER JOIN PODPMT C ON C.PRODUCT_CODE=B.PRODUCT_CODE       
    JOIN ARTICLE D ON D.ARTICLE_CODE=B.ARTICLE_CODE       
    JOIN SECTIOND E ON E.SUB_SECTION_CODE=D.SUB_SECTION_CODE       
    JOIN SECTIONM F ON F.SECTION_CODE=E.SECTION_CODE       
    LEFT OUTER JOIN PARA1 P1 ON P1.PARA1_CODE=B.PARA1_CODE       
    LEFT OUTER JOIN PARA2 P2 ON P2.PARA2_CODE=B.PARA2_CODE       
    LEFT OUTER JOIN PARA3 P3 ON P3.PARA3_CODE=B.PARA3_CODE       
    LEFT OUTER JOIN PARA4 P4 ON P4.PARA4_CODE=B.PARA4_CODE       
    LEFT OUTER JOIN PARA5 P5 ON P5.PARA5_CODE=B.PARA5_CODE       
    LEFT OUTER JOIN PARA6 P6 ON P6.PARA6_CODE=B.PARA6_CODE       
    WHERE B.PO_ID = ''' + @CWHERE + ''''        
 PRINT @CCMD      
 EXEC SP_EXECUTESQL @CCMD      
 GOTO LAST       
       
LAST:        
      
        
END
