CREATE PROCEDURE SP_PRT_PASTE        
(          
  @CPRODUCTCODE NVARCHAR(50),          
  @MEMOTYPE NUMERIC(1),          
  @NMODE INT=1  ,          
  @CDEPTID VARCHAR(4)='',  
  @CBINID VARCHAR(3),  
  @CUSERCODE VARCHAR(10) --//FOR BIN AUTHENTICATION//  
)    
--WITH ENCRYPTION          
AS   
BEGIN       
          
 DECLARE @CQUERY NVARCHAR(MAX),@CQUERY1 NVARCHAR(MAX),@CQUERY2 NVARCHAR(MAX),@CMBO_COUNTER VARCHAR(1)  
  
 SELECT @CMBO_COUNTER=ISNULL(MBO_COUNTER,0) FROM BIN WHERE BIN_ID=@CBINID   
    
 SET @CQUERY=N'IF OBJECT_ID(''CPRODUCTS_'+LTRIM(RTRIM(@@SPID))+''',''U'') IS NOT NULL   
     DROP TABLE CPRODUCTS_'+LTRIM(RTRIM(@@SPID))+'   
          
        SELECT DISTINCT PRODUCT_CODE INTO CPRODUCTS_'+LTRIM(RTRIM(@@SPID))+' FROM #TEMP_PCODE_'+@CPRODUCTCODE+'   
        IF OBJECT_ID(''CPRODUCTS_1_'+LTRIM(RTRIM(@@SPID))+''',''U'') IS NOT NULL   
     DROP TABLE CPRODUCTS_1_'+LTRIM(RTRIM(@@SPID))+'   
      SELECT DISTINCT A.PRODUCT_CODE,B.MRR_ID,C.INV_DT  
      INTO CPRODUCTS_1_'+LTRIM(RTRIM(@@SPID))+' FROM CPRODUCTS_'+LTRIM(RTRIM(@@SPID))+' A   
      JOIN PID01106 B ON A.PRODUCT_CODE=B.PRODUCT_CODE  
      JOIN PIM01106 C ON B.MRR_ID=C.MRR_ID   
      WHERE (('+LTRIM(RTRIM(STR(@NMODE)))+'=1 AND C.INV_MODE IN (0,1)) OR  C.INV_MODE='+LTRIM(RTRIM(STR(@NMODE)))+')        
      AND c.location_code='''+@CDEPTID+'''    
      ORDER BY PRODUCT_CODE,INV_DT'    
 PRINT @CQUERY  
 EXEC SP_EXECUTESQL @CQUERY  
              
 SET @CQUERY=N';WITH LASTPURS AS  
 (  
  SELECT ROW_NUMBER() OVER(PARTITION BY PRODUCT_CODE ORDER BY INV_DT DESC) AS SN  
     ,PRODUCT_CODE,MRR_ID,INV_DT  
  FROM CPRODUCTS_1_'+LTRIM(RTRIM(@@SPID))+'   
 )  
 DELETE LASTPURS WHERE SN>1'  
 PRINT @CQUERY  
 EXEC SP_EXECUTESQL @CQUERY     
         
  SET @CQUERY = N' SELECT ISNULL(X.AC_CODE, A.AC_CODE) AS [AC_CODE], F.UOM_TYPE, H.SECTION_NAME, G.SUB_SECTION_NAME  
  ,A.PRODUCT_CODE,            
  CONVERT(VARCHAR, A.INV_DT, 105) AS INV_DT, A.INV_NO,ISNULL(X.AC_NAME,LM.AC_NAME) AS [AC_NAME],              
  ISNULL(X.GROSS_PURCHASE_PRICE,(CASE WHEN '+LTRIM(RTRIM(STR(@NMODE)))+'=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1           
  THEN  A.MRP ELSE A.WS_PRICE END)) AS GROSS_PURCHASE_PRICE,ISNULL(X.MRP, A.MRP) AS MRP,ISNULL(X.WHOLESALE_PRICE, A.WS_PRICE) AS WS_PRICE,         
  B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC, C.PARA1_NAME, D.PARA2_NAME,                 
  E.PARA3_NAME, P4.PARA4_NAME, P5.PARA5_NAME , P6.PARA6_NAME, F.UOM_CODE, F.UOM_NAME,  ISNULL(X.FORM_ID, I.FORM_ID) AS FORM_ID,             
  ISNULL(X.FORM_NAME,I.FORM_NAME) AS FORM_NAME, ISNULL(X.TAX_PERCENTAGE, I.TAX_PERCENTAGE) AS TAX_PERCENTAGE, ISNULL(PMT.QUANTITY_IN_STOCK,0) AS [QUANTITY_IN_STOCK],            
  ISNULL(B.DT_CREATED,'''') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'''') AS [PARA3_DT_CREATED],ISNULL(A.DT_CREATED,'''') AS [SKU_DT_CREATED],          
  X.MRR_NO ,A.BARCODE_CODING_SCHEME AS CODING_SCHEME,B.DISCON,          
  ISNULL(X.INACTIVE, LM.INACTIVE) AS [INACTIVE] ,ISNULL(X.ON_HOLD, LMP.ON_HOLD) AS [ON_HOLD],          
  ISNULL(X.DISCOUNT_PERCENTAGE,0) AS  [DISCOUNT_PERCENTAGE],     
  ISNULL(X.DISCOUNT_AMOUNT,0) AS  [DISCOUNT_AMOUNT],     
  (CASE WHEN X.DISCOUNT_PERCENTAGE IS NULL AND '+LTRIM(RTRIM(STR(@NMODE)))+'=2 THEN LOC.LOC_DISCOUNT_PERCENTAGE ELSE 0 END) AS  [DN_DISCOUNT_PERCENTAGE],     
  (CASE WHEN A.ER_FLAG=0 THEN 1 ELSE A.ER_FLAG END ) AS ER_FLAG,ISNULL(X.INV_NO,A.CHALLAN_NO) AS CHALLAN_NO,ISNULL(X.BILL_NO,A.INV_NO) AS BILL_NO          
  ,ISNULL(X.INV_DT,A.INV_DT) AS BILL_DT ,ISNULL(AOH.EXCISE_DUTY_AMOUNT,0) AS EXCISE_DUTY_AMOUNT,          
  ISNULL(AOH.FREIGHT,0) AS FREIGHT, ISNULL(AOH.OTHER_CHARGES,0) AS OTHER_CHARGES,          
  ISNULL(X.PUR_DISCOUNT_PERCENTAGE,0) AS [PUR_DISCOUNT_PERCENTAGE],       
  ISNULL(X.PUR_DISCOUNT_AMOUNT,0) AS [PUR_DISCOUNT_AMOUNT] ,      
  CONVERT(NUMERIC(14,2), (CASE WHEN ISNULL(X.INV_RATE, A.PURCHASE_PRICE)=0 THEN ISNULL(X.PURCHASE_PRICE,(CASE WHEN '+LTRIM(RTRIM(STR(@NMODE)))+'=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1           
  THEN  A.MRP ELSE A.WS_PRICE END)) ELSE ISNULL(X.INV_RATE, A.PURCHASE_PRICE) END  )) AS INV_RATE      
  ,ISNULL(X.PURCHASE_PRICE,(CASE WHEN '+LTRIM(RTRIM(STR(@NMODE)))+'=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1           
  THEN  A.MRP ELSE A.WS_PRICE END)) AS [PURCHASE_PRICE] ,ISNULL(X.QTY,TEMP.QTY) AS QUANTITY,        
  1 AS BILL_LEVEL_TAX_METHOD ,    
  ISNULL( X.TAX_METHOD_NAME,''EXCLUSIVE'') AS TAX_METHOD_NAME        
  ,BL.BIN_ID,BI.BIN_NAME,B.STOCK_NA,B.ALIAS AS ARTICLE_ALIAS  
  ,(CASE WHEN '+@CMBO_COUNTER+'=0 THEN '''' ELSE   
   (CASE WHEN BL.BIN_ID='''+@CBINID+''' THEN '''' ELSE ''BARCODE NOT IN STOCK'' END)  
  END) AS ERRMSG  
  FROM SKU A (NOLOCK)'      
  SET @CQUERY1=N' LEFT JOIN SKU_OH AOH (NOLOCK) ON A.PRODUCT_CODE=AOH.PRODUCT_CODE          
  JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE                  
  JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE                  
  JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE                 
  JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE                  
  JOIN PARA4 P4 (NOLOCK) ON A.PARA4_CODE = P4.PARA4_CODE                  
  JOIN PARA5 P5 (NOLOCK) ON A.PARA5_CODE = P5.PARA5_CODE                  
  JOIN PARA6 P6 (NOLOCK) ON A.PARA6_CODE = P6.PARA6_CODE          
  JOIN UOM F (NOLOCK) ON B.UOM_CODE = F.UOM_CODE                 
  JOIN SECTIOND G (NOLOCK) ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE                  
  JOIN SECTIONM H (NOLOCK) ON G.SECTION_CODE = H.SECTION_CODE                 
  JOIN FORM I (NOLOCK) ON A.FORM_ID = I.FORM_ID     
  LEFT OUTER JOIN PMT01106 PMT (NOLOCK) ON PMT.PRODUCT_CODE=A.PRODUCT_CODE                                 
  LEFT OUTER JOIN           
  (          
   SELECT MAX(A.MRR_NO) AS MRR_NO,B.PRODUCT_CODE,A.INV_DT          
   ,MAX(B.GROSS_PURCHASE_PRICE) AS GROSS_PURCHASE_PRICE,MAX(B.PURCHASE_PRICE) AS PURCHASE_PRICE,MAX(B.MRP) AS MRP  
   ,MAX(B.WHOLESALE_PRICE) AS WHOLESALE_PRICE,MAX(B.DISCOUNT_PERCENTAGE) AS [PUR_DISCOUNT_PERCENTAGE],  
   MAX(CASE WHEN B.DISCOUNT_AMOUNT =0 THEN B.DISCOUNT_AMOUNT ELSE CAST(B.DISCOUNT_AMOUNT/B.INVOICE_QUANTITY AS NUMERIC(14,2)) END) AS [PUR_DISCOUNT_AMOUNT],          
   MAX(A.DISCOUNT_PERCENTAGE) AS [DISCOUNT_PERCENTAGE],MAX(A.AC_CODE) AS AC_CODE,MAX(LM1.AC_NAME) AS AC_NAME,LM1.INACTIVE AS INACTIVE  
   ,(LMP1.ON_HOLD) AS ON_HOLD,MAX(FRM.FORM_ID) AS FORM_ID,  
   MAX(FRM.TAX_PERCENTAGE) AS TAX_PERCENTAGE,MAX(FRM.FORM_NAME) AS FORM_NAME,MAX(A.MEMO_TYPE) AS MEMO_TYPE  
   ,MAX(A.BILL_NO) AS BILL_NO,MAX(A.INV_NO) AS INV_NO,MAX(A.FREIGHT) AS FREIGHT,MAX(A.EXCISE_DUTY_AMOUNT) AS EXCISE_DUTY_AMOUNT  
   ,MAX(A.BILL_LEVEL_TAX_METHOD) AS BILL_LEVEL_TAX_METHOD,MAX(CASE WHEN A.DISCOUNT_PERCENTAGE=0 THEN B.PURCHASE_PRICE ELSE (B.PURCHASE_PRICE-(B.PURCHASE_PRICE *A.DISCOUNT_PERCENTAGE/100)) END) AS INV_RATE ,    
   MAX(CAST((B.PURCHASE_PRICE *A.DISCOUNT_PERCENTAGE/100) AS NUMERIC(14,2))) AS [DISCOUNT_AMOUNT], MAX(TEMP.QTY) AS QTY,   
   MAX(CASE WHEN A.BILL_LEVEL_TAX_METHOD = 1 THEN ''EXCLUSIVE'' ELSE ''INCLUSIVE'' END) AS TAX_METHOD_NAME             
   FROM PIM01106 A (NOLOCK)          
   JOIN PID01106 B (NOLOCK) ON B.MRR_ID=A.MRR_ID          
   JOIN CPRODUCTS_1_'+LTRIM(RTRIM(@@SPID))+' CP ON B.PRODUCT_CODE=CP.PRODUCT_CODE AND B.MRR_ID=CP.MRR_ID  
   JOIN LM01106 LM1 (NOLOCK) ON LM1.AC_CODE=A.AC_CODE            
   LEFT OUTER JOIN LMP01106 LMP1 (NOLOCK) ON LMP1.AC_CODE=LM1.AC_CODE          
   JOIN FORM FRM (NOLOCK) ON FRM.FORM_ID=B.FORM_ID       
   JOIN #TEMP_PCODE_'+@CPRODUCTCODE+' TEMP (NOLOCK) ON TEMP.PRODUCT_CODE=B.PRODUCT_CODE              
   GROUP BY B.PRODUCT_CODE,LM1.INACTIVE,LMP1.ON_HOLD,A.INV_DT    
  )X ON X.PRODUCT_CODE=A.PRODUCT_CODE     
 JOIN LM01106 LM (NOLOCK) ON A.AC_CODE = LM.AC_CODE          
 LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LM.AC_CODE=LMP.AC_CODE  
 JOIN #TEMP_PCODE_' +@CPRODUCTCODE +' TEMP (NOLOCK)  ON TEMP.PRODUCT_CODE=A.PRODUCT_CODE               
 JOIN BIN_LOC BL (NOLOCK) ON BL.DEPT_ID ='''+@CDEPTID   +'''    
 JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=BL.DEPT_ID    
 JOIN BIN BI (NOLOCK) ON BI.BIN_ID=BL.BIN_ID   
JOIN BINUSERS BU (NOLOCK) ON BI.BIN_ID=BU.BIN_ID AND BU.USER_CODE=''' + @CUSERCODE + '''  
           
 WHERE PMT.BIN_ID=BL.BIN_ID AND A.ER_FLAG=(CASE WHEN '+LTRIM(RTRIM(STR(@MEMOTYPE)))+'=1 OR A.BARCODE_CODING_SCHEME=1 THEN A.ER_FLAG ELSE '+LTRIM(RTRIM(STR(@MEMOTYPE)))+' END)  
  AND PMT.QUANTITY_IN_STOCK>0'                     
   
PRINT @CQUERY    
PRINT @CQUERY1     
    
SET   @CQUERY=@CQUERY+@CQUERY1   
    
EXECUTE SP_EXECUTESQL @CQUERY        
         
END                                                                          
----****  END OF PROCEDURE SP_PRT_PASTE  