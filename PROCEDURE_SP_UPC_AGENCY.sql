
create   PROCEDURE SP_UPC_AGENCY    
(    
 @CORDER_ID VARCHAR(100)='',    
 @CPARA1_CODE VARCHAR(100)='',    
 @JOB_CODE CHAR(10)='',  
 @CWO_ID VARCHAR(100)='',  
 @CPARA2_CODE VARCHAR(10)=''  ,
 @CARTICLE_CODE varchar(15)=''
)    
AS    
BEGIN    
--EXECUTE SP_prd_UPC_AGENCY '0001119000000000000007','000000001','0000002','0001119000000000000006','0000000  ',''
 --EXECUTE SP_UPC_AGENCY '0001119000000000000007','000000001','0000002','0001119000000000000006','0000000  ','000000004'   
     --EXECUTE SP_UPC_AGENCY '0001119000000000000007','000000005','0000002','0001119000000000000009','0000000  ','000000001'
      IF OBJECT_ID ('TEMPDB..#TMPPRODUCT','U') IS NOT NULL
	   DROP TABLE #TMPPRODUCT
	 

    SELECT ISNULL(BO.AC_CODE,A.AC_CODE ) AS AC_CODE,
           ISNULL(BM.ORDER_NO ,'') AS ORDER_NO,
           ISNULL(BM.ORDER_DT ,'') AS ORDER_DT,
           A.MEMO_NO ,A.MEMO_DT ,B.ARTICLE_CODE ,
           B.PARA1_CODE ,B.PARA2_CODE,
          C.PRODUCT_CODE ,UPC.QUANTITY_IN_STOCK
    INTO #TMPPRODUCT
    FROM ORD_PLAN_MST A (NOLOCK)
    JOIN ORD_PLAN_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
    JOIN ORD_PLAN_BARCODE_DET C (NOLOCK) ON B.ROW_ID=C.REFROW_ID
    JOIN JOBWORK_PMT UPC ON UPC.PRODUCT_CODE =C.PRODUCT_CODE 
    LEFT JOIN BUYER_ORDER_DET BD (NOLOCK) ON BD.ROW_ID=WOD_ROW_ID
    LEFT JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID=BD.ORDER_ID
    LEFT OUTER JOIN BUYER_ORDER_MST BO ON BO.ORDER_ID= ISNULL(UPC.ORDER_ID ,BM.ORDER_ID )     
    WHERE A.CANCELLED=0 AND ISNULL(BM.CANCELLED,0)=0 AND ISNULL(UPC.QUANTITY_IN_STOCK ,0)=0
    AND ISNULL(ISNULL(UPC.ORDER_ID ,BM.ORDER_ID ),'')=@CORDER_ID
    AND(@CARTICLE_CODE='' OR  B.ARTICLE_CODE =@CARTICLE_CODE)
    AND B.PARA1_CODE =@CPARA1_CODE
    AND B.PARA2_CODE =@CPARA2_CODE
    AND A.MEMO_ID  =@CWO_ID
   
    
    DELETE A FROM #TMPPRODUCT A
    JOIN TRANSFER_TO_TRADING_DET B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
    JOIN TRANSFER_TO_TRADING_MST C ON B.MEMO_ID =C.MEMO_ID 
    WHERE C.CANCELLED =0
    
    IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL
		   DROP TABLE #TMPISSUE

		 SELECT AG.agency_code , AG.AGENCY_NAME,  A.PRODUCT_CODE,B.issue_id   MEMO_ID ,
		 a.JOB_CODE ,B.issue_no , issue_dt  AS issue_dt,
		 A.quantity AS ISSUE_QTY ,b.issue_time ,b.issue_id 
		 INTO #TMPISSUE
		 FROM jobwork_issue_det   A
		 JOIN jobwork_issue_MST  B ON A.issue_id  =B.issue_id
		 JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE=b.AGENCY_CODE 
		 JOIN #TMPPRODUCT TMP ON A.PRODUCT_CODE =TMP.PRODUCT_CODE 
		 WHERE B.CANCELLED=0
		 
		  
		 
		 ;WITH CTE AS
		 (
		 SELECT AGENCY_NAME,PRODUCT_CODE,MEMO_ID,JOB_CODE,
				SR=ROW_NUMBER () OVER (PARTITION BY PRODUCT_CODE ORDER BY ISSUE_DT desc,ISSUE_TIME DESC ,ISSUE_ID DESC)
		 FROM #TMPISSUE
		 
		 )
		 DELETE  FROM CTE WHERE SR>1
		 
		 
		
		 
		SELECT B.AGENCY_CODE ,AGENCY_NAME ,ISSUE_NO ,ISSUE_DT ,PRODUCT_CODE,
		ISSUE_QTY 
		FROM #TMPISSUE B
		WHERE  B.job_code =@JOB_CODE
	
     
         
END