CREATE PROCEDURE SP3S_GET_ARTICLE_FKEYDATA
@CSOURCEDB VARCHAR(200),
@CSOURCETABLE VARCHAR(200),
@CSOURCEKEYFIELD VARCHAR(200),
@CXNTYPE VARCHAR(10),
@CTABLESUFFIX VARCHAR(40),
@CLOCID VARCHAR(5),
@CERRORMSG VARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	BEGIN TRY
		DECLARE @CCMD NVARCHAR(MAX),@CTEMPTABLE VARCHAR(1000),@CTEMPTABLE1 VARCHAR(1000),@CTEMPTABLE2 VARCHAR(1000),
				@CTEMPTABLE3 VARCHAR(1000),@CKEYFIELDVAL VARCHAR(40),@CDESTDB VARCHAR(200),@CFILTERCONDITION VARCHAR(MAX),
				@NSTEP INT
		
		SET @NSTEP = 10
		SET @CDESTDB='WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.'

		IF @CSOURCETABLE<>'#TMPMISSINGARTDATA'
		BEGIN			
			IF OBJECT_ID('TEMPDB..#TMPMISSINGARTDATA','U') IS NOT NULL
				DROP TABLE #TMPMISSINGARTDATA
			
			SELECT ARTICLE_CODE INTO #TMPMISSINGARTDATA FROM ARTICLE WHERE 1=2
		END

		IF OBJECT_ID('TEMPDB..#TMPMISSINGUOMDATA','U') IS NOT NULL
			DROP TABLE #TMPMISSINGUOMDATA				
		
		SELECT UOM_CODE INTO #TMPMISSINGUOMDATA FROM UOM WHERE 1=2
	
		SET @NSTEP = 20
		IF OBJECT_ID('TEMPDB..#TMPMISSINGSDDATA','U') IS NOT NULL
			DROP TABLE #TMPMISSINGSDDATA
		
		SELECT SUB_SECTION_CODE INTO #TMPMISSINGSDDATA FROM SECTIOND WHERE 1=2

		IF OBJECT_ID('TEMPDB..#TMPMISSINGSMDATA','U') IS NOT NULL
			DROP TABLE #TMPMISSINGSMDATA
		
		SELECT SECTION_CODE INTO #TMPMISSINGSMDATA FROM SECTIONM WHERE 1=2
							
		SET @NSTEP = 30
		SET @CTEMPTABLE=(CASE WHEN LEFT(@CSOURCETABLE,1)='#' THEN @CSOURCETABLE ELSE @CSOURCEDB+'TMP_'+@CXNTYPE+'_'+@CSOURCETABLE+'_'+@CTABLESUFFIX END)
		SET @CTEMPTABLE1=@CSOURCEDB+'TMP_'+@CXNTYPE+'_SECTIONM_'+@CTABLESUFFIX
		SET @CTEMPTABLE2=@CSOURCEDB+'TMP_'+@CXNTYPE+'_SECTIOND_'+@CTABLESUFFIX
		SET @CTEMPTABLE3=@CSOURCEDB+'TMP_'+@CXNTYPE+'_ARTICLE_'+@CTABLESUFFIX

		IF @CSOURCETABLE<>'#TMPMISSINGARTDATA'
		BEGIN		
			SET @NSTEP = 40	
			IF OBJECT_ID(@CTEMPTABLE3,'U') IS NOT NULL
				SET @CCMD=N'SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
							LEFT OUTER JOIN '+@CTEMPTABLE3+'  B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.ARTICLE C ON C.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
							WHERE B.ARTICLE_CODE IS NULL AND C.ARTICLE_CODE IS NULL AND A.'+@CSOURCEKEYFIELD+' IS NOT NULL'
			ELSE
				SET @CCMD=N'SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.ARTICLE B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
							WHERE B.ARTICLE_CODE IS NULL AND A.'+@CSOURCEKEYFIELD+' IS NOT NULL'

				
			INSERT #TMPMISSINGARTDATA
			EXEC SP_EXECUTESQL @CCMD
		END

		SET @NSTEP = 45	
		IF OBJECT_ID(@CTEMPTABLE3,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT  B.UOM_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE3+'  B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.UOM C ON C.UOM_CODE=B.UOM_CODE
						WHERE C.UOM_CODE IS NULL
						UNION
						SELECT DISTINCT B.UOM_CODE FROM '+@CTEMPTABLE+'  A
						JOIN ARTICLE B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.UOM C ON C.UOM_CODE=B.UOM_CODE
						WHERE C.UOM_CODE IS NULL'
		ELSE
			SET @CCMD=N'SELECT DISTINCT B.UOM_CODE FROM '+@CTEMPTABLE+'  A
						JOIN ARTICLE B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.UOM C ON C.UOM_CODE=B.UOM_CODE
						WHERE C.UOM_CODE IS NULL'

			
		INSERT #TMPMISSINGUOMDATA
		EXEC SP_EXECUTESQL @CCMD
					
		SET @NSTEP = 50
		IF OBJECT_ID(@CTEMPTABLE2,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT B.SUB_SECTION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE3+'  B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN '+@CTEMPTABLE2+'  C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SECTIOND D ON D.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						WHERE C.SUB_SECTION_CODE IS NULL AND D.SUB_SECTION_CODE IS NULL
						UNION
						SELECT DISTINCT B.SUB_SECTION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN ARTICLE B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SECTIOND C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						LEFT OUTER JOIN '+@CTEMPTABLE2+'  D ON D.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						WHERE C.SUB_SECTION_CODE IS NULL AND D.SUB_SECTION_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE3,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT B.SUB_SECTION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE3+'  B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SECTIOND C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						WHERE C.SUB_SECTION_CODE IS NULL
						UNION
						SELECT DISTINCT B.SUB_SECTION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN ARTICLE B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SECTIOND C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						WHERE C.SUB_SECTION_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE3,'U') IS NULL
			SET @CCMD=N'SELECT DISTINCT B.SUB_SECTION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN ARTICLE B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SECTIOND C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						WHERE C.SUB_SECTION_CODE IS NULL'
		
		PRINT @CCMD
		INSERT #TMPMISSINGSDDATA
		EXEC SP_EXECUTESQL @CCMD
		
		SET @CCMD=''
		SET @NSTEP = 60
		IF OBJECT_ID(@CTEMPTABLE1,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT C.SECTION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE3+'  B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN '+@CTEMPTABLE2+'  C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						LEFT OUTER JOIN '+@CTEMPTABLE1+'  D ON D.SECTION_CODE=C.SECTION_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SECTIONM E ON E.SECTION_CODE=C.SECTION_CODE
						WHERE D.SECTION_CODE IS NULL AND E.SECTION_CODE IS NULL
						UNION
						SELECT DISTINCT C.SECTION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN ARTICLE B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN SECTIOND C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						LEFT OUTER JOIN '+@CTEMPTABLE1+'  D ON D.SECTION_CODE=C.SECTION_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SECTIONM E ON E.SECTION_CODE=C.SECTION_CODE
						WHERE D.SECTION_CODE IS NULL AND E.SECTION_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE3,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT C.SECTION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN '+@CTEMPTABLE3+'  B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN '+@CTEMPTABLE2+'  C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SECTIONM D ON D.SECTION_CODE=C.SECTION_CODE
						WHERE D.SECTION_CODE IS NULL
						UNION
						SELECT DISTINCT C.SECTION_CODE FROM '+@CTEMPTABLE+'  A
						JOIN ARTICLE B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
						JOIN SECTIOND C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SECTIONM D ON D.SECTION_CODE=C.SECTION_CODE
						WHERE D.SECTION_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE3,'U') IS  NULL
		SET @CCMD=N'SELECT DISTINCT C.SECTION_CODE FROM '+@CTEMPTABLE+'  A
					JOIN ARTICLE B ON B.ARTICLE_CODE=A.'+@CSOURCEKEYFIELD+'
					JOIN SECTIOND C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
					LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.SECTIONM D ON D.SECTION_CODE=C.SECTION_CODE
					WHERE D.SECTION_CODE IS NULL'
		
		PRINT @CCMD
		
		INSERT #TMPMISSINGSMDATA
		EXEC SP_EXECUTESQL @CCMD

		IF EXISTS (SELECT TOP 1 UOM_CODE FROM #TMPMISSINGUOMDATA)
		BEGIN
			SET @NSTEP = 65
			SET @CFILTERCONDITION= 'B.UOM_CODE IN (SELECT UOM_CODE FROM #TMPMISSINGUOMDATA)'
			
			EXEC UPDATEMASTERXN_MIRROR
			@CSOURCEDB='',
			@CSOURCETABLE='UOM',
			@CDESTDB=@CDESTDB,
			@CDESTTABLE='UOM',
			@CKEYFIELD1='UOM_CODE',
			@LINSERTONLY=0,
			@CFILTERCONDITION=@CFILTERCONDITION,
			
			
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1
		END
		
		
		IF EXISTS (SELECT TOP 1 SECTION_CODE FROM #TMPMISSINGSMDATA)
		BEGIN
			SET @NSTEP = 70
			SET @CFILTERCONDITION= 'B.SECTION_CODE IN (SELECT SECTION_CODE FROM #TMPMISSINGSMDATA)'
			
			EXEC UPDATEMASTERXN_MIRROR
			@CSOURCEDB='',
			@CSOURCETABLE='SECTIONM',
			@CDESTDB=@CDESTDB,
			@CDESTTABLE='SECTIONM',
			@CKEYFIELD1='SECTION_CODE',
			@LINSERTONLY=0,
			@CFILTERCONDITION=@CFILTERCONDITION,
			
			
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1
		END

		IF EXISTS (SELECT TOP 1 SUB_SECTION_CODE FROM #TMPMISSINGSDDATA)
		BEGIN
			SET @NSTEP = 80
			SET @CFILTERCONDITION= 'B.SUB_SECTION_CODE IN (SELECT SUB_SECTION_CODE FROM #TMPMISSINGSDDATA)'
			
			EXEC UPDATEMASTERXN_MIRROR
			@CSOURCEDB='',
			@CSOURCETABLE='SECTIOND',
			@CDESTDB=@CDESTDB,
			@CDESTTABLE='SECTIOND',
			@CKEYFIELD1='SUB_SECTION_CODE',
			@LINSERTONLY=0,
			@CFILTERCONDITION=@CFILTERCONDITION,
			
			
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1
		END

		IF EXISTS (SELECT TOP 1 ARTICLE_CODE FROM #TMPMISSINGARTDATA)
		BEGIN
			SET @NSTEP = 90
			SET @CFILTERCONDITION= 'B.ARTICLE_CODE IN (SELECT ARTICLE_CODE FROM #TMPMISSINGARTDATA)'
			
			EXEC UPDATEMASTERXN_MIRROR
			@CSOURCEDB='',
			@CSOURCETABLE='ARTICLE',
			@CDESTDB=@CDESTDB,
			@CDESTTABLE='ARTICLE',
			@CKEYFIELD1='ARTICLE_CODE',
			@LINSERTONLY=0,
			@CFILTERCONDITION=@CFILTERCONDITION,
			
			
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1
		END
		
		GOTO END_PROC									
	END TRY
	
	BEGIN CATCH
		SELECT @CERRORMSG='PROCEDURE SP3S_GET_ARTICLE_FKEYDATA : '+ISNULL(ERROR_PROCEDURE(),'NULL P')+'STEP :'+STR(ISNULL(@NSTEP,0))+ ' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		GOTO END_PROC
	END CATCH
	
END_PROC:
		
END
----'END OF PROCEDURE SP3S_GET_ARTICLE_FKEYDATA'
