CREATE PROCEDURE SP_SEND_MIRROR_DOCMRP_DATA_OPT
(
 @CTARGETLOCID VARCHAR(5),
 @CERRMSG VARCHAR(MAX) OUTPUT 
)    
AS    
 BEGIN    
   DECLARE @dMaxFromDt DATETIME,@cStep VARCHAR(4)
        
    BEGIN TRY    
        
     SET @CSTEP=10    
     
     SET @CERRMSG=''    
     PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)    
          
     SET @CSTEP=20    
          
	 SELECT @dMaxFromDt=MAX(FROM_DT)  FROM DBO.LOCSKUSP (NOLOCK)
     WHERE DEPT_ID = @CTARGETLOCID
    
	SET @CSTEP=40    
	SELECT 	@CTARGETLOCID AS XN_ID,'DOCMRP_locskusp_UPLOAD' AS TARGET_TABLENAME,* FROM LOCSKUSP (NOLOCK) 
	WHERE dept_id=@CTARGETLOCID AND from_dt=@dMaxFromDt

	SELECT 	@CTARGETLOCID AS XN_ID,'DOCMRP_locskusp_current_UPLOAD' AS TARGET_TABLENAME,a.* 
	FROM LOCSKUSP_CURRENT a (NOLOCK) 
	JOIN locskusp b (NOLOCK) ON a.PRODUCT_CODE=b.product_code AND a.DEPT_ID=b.dept_id
	WHERE a.dept_id=@CTARGETLOCID AND from_dt=@dMaxFromDt
				    
	GOTO END_PROC
	
	   
 END TRY    
     
 BEGIN CATCH    
     SET @CERRMSG='P: SP_SEND_MIRROR_DOCMRP_DATA_OPT, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
     GOTO END_PROC    
 END CATCH     
        
END_PROC:
        
END