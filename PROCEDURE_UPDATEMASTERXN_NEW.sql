
--**** START OF PROCEDURE UPDATEMASTERXN
CREATE PROCEDURE UPDATEMASTERXN_NEW 
			@CSOURCEDB VARCHAR(100),
			@CSOURCETABLE VARCHAR(100),
			@CDESTDB VARCHAR(100),
			@CDESTTABLE VARCHAR(100),
			@CKEYFIELD1 VARCHAR(40)='',
			@CKEYFIELD2 VARCHAR(40)='',
			@CKEYFIELD3 VARCHAR(40)='',
			@LINSERTONLY BIT = 0,
			@CFILTERCONDITION VARCHAR(500)='',
			@LUPDATEXNS BIT=0,
			@CXNTYPE VARCHAR(20)='',
			@LUPDATEONLY BIT = 0,
			@BALWAYSUPDATE BIT=0
--WITH ENCRYPTION			
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @CWC VARCHAR(100),
			@CINSERTSTR NVARCHAR(MAX),
			@CINSERTSTRVALUE NVARCHAR(MAX),
			@CWHERECLAUSE NVARCHAR(MAX),
			@CCMD NVARCHAR(MAX),@CCURLOCID VARCHAR(5)/*Rohit 06-11-2024*/,
			@LDONOTREPLNULLS BIT,@CSOURCETABLESTR VARCHAR(100),@CDESTTABLESTR VARCHAR(100)
	
	SELECT @CCURLOCID=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'
	
	SET @CDESTTABLESTR=(CASE WHEN LEFT(@CDESTTABLE,1)<>'[' THEN '[' ELSE '' END)+
				  @CDESTTABLE+(CASE WHEN RIGHT(@CDESTTABLE,1)<>']' THEN ']' ELSE '' END)

	SET @CSOURCETABLESTR=(CASE WHEN LEFT(@CSOURCETABLE,1)<>'[' THEN '[' ELSE '' END)+
				  @CSOURCETABLE+(CASE WHEN RIGHT(@CSOURCETABLE,1)<>']' THEN ']' ELSE '' END)

	SET @CWC = ''
	IF @CKEYFIELD1 <> ''
		SET @CWC = 'A.' + @CKEYFIELD1 + ' = B.' + @CKEYFIELD1
	IF @CKEYFIELD2 <> ''
		SET @CWC = @CWC + ( CASE WHEN @CWC<>'' THEN ' AND ' ELSE '' END ) + 'A.' + @CKEYFIELD2 + ' = B.' + @CKEYFIELD2
	IF @CKEYFIELD3 <> ''
		SET @CWC = @CWC + ( CASE WHEN @CWC<>'' THEN ' AND ' ELSE '' END ) + 'A.' + @CKEYFIELD3 + ' = B.' + @CKEYFIELD3
	IF @CWC <> ''
		SET @CWC = ' ON ' + @CWC 

	IF OBJECT_ID('TEMPDB..#TCONSTRAINTSCOL','U') IS NOT NULL
		DROP TABLE #TCONSTRAINTSCOL
PRINT '1 : '+@CSOURCETABLE
	SELECT E.NAME AS COLNAME INTO #TCONSTRAINTSCOL FROM SYSREFERENCES A (NOLOCK)
	JOIN SYSOBJECTS B (NOLOCK) ON A.CONSTID = B.ID 
	JOIN SYSOBJECTS C (NOLOCK) ON A.FKEYID = C.ID 
	JOIN SYSOBJECTS D (NOLOCK) ON A.RKEYID = D.ID 
	JOIN SYSCOLUMNS E (NOLOCK) ON A.FKEY1 = E.COLID AND A.FKEYID = E.ID 
	JOIN SYSCOLUMNS F (NOLOCK) ON A.RKEY1 = F.COLID AND A.RKEYID = F.ID
	WHERE C.NAME=@CDESTTABLE
	UNION ALL		
	SELECT F.NAME AS COLNAME FROM SYSCONSTRAINTS A (NOLOCK)
	JOIN SYSOBJECTS B (NOLOCK) ON A.CONSTID = B.ID 
	JOIN SYSOBJECTS C (NOLOCK) ON A.ID = C.ID  
	JOIN SYSINDEXES D (NOLOCK) ON D.ID=A.ID AND D.NAME=B.NAME
	JOIN SYSINDEXKEYS E (NOLOCK) ON E.ID=A.ID AND E.INDID=D.INDID 
	JOIN SYSCOLUMNS F (NOLOCK) ON F.ID=A.ID AND F.COLID=E.COLID  
	WHERE C.NAME=@CDESTTABLE AND B.XTYPE NOT IN ('D','F','C')

	IF OBJECT_ID('TEMPDB..#TTARGETCOL','U') IS NOT NULL
		DROP TABLE #TTARGETCOL

PRINT '2 : '+@CSOURCETABLE
	SELECT A.NAME AS COLNAME, B.NAME AS COLTYPE,A.NAME AS SOURCECOLNAME,A.ISNULLABLE,A.LENGTH AS SOURCE_COLWIDTH,
		   A.LENGTH AS TARGET_COLWIDTH INTO #TTARGETCOL
	FROM SYSCOLUMNS A (NOLOCK) 
	JOIN SYSTYPES B (NOLOCK) ON A.XTYPE = B.XTYPE
    JOIN SYSOBJECTS C (NOLOCK) ON C.ID = A.ID 
    WHERE 1=2
	
	
	SET @CCMD = 'SELECT A.NAME AS COLNAME, B1.NAME AS COLTYPE,'''',C.ISNULLABLE,A.LENGTH AS  COLWIDTH,C.LENGTH AS COLWIDTH 
				 FROM ' + @CSOURCEDB + 'SYSCOLUMNS A (NOLOCK) 
				 JOIN ' + @CSOURCEDB + 'SYSTYPES B (NOLOCK) ON A.XTYPE = B.XTYPE  AND B.NAME<>''SYSNAME''
				 JOIN ' + @CDESTDB + 'SYSCOLUMNS C (NOLOCK) ON A.NAME = C.NAME
				 JOIN ' + @CDESTDB + 'SYSTYPES B1 (NOLOCK) ON C.XTYPE = B1.XTYPE  AND B1.NAME<>''SYSNAME''
				 JOIN ' + @CDESTDB + 'SYSOBJECTS D (NOLOCK) ON D.ID = C.ID 
				 LEFT OUTER JOIN SYS.IDENTITY_COLUMNS E (NOLOCK) ON E.OBJECT_ID=D.ID AND E.NAME=C.NAME				 
				 WHERE A.ID = ( SELECT ID FROM ' + @CSOURCEDB + 'SYSOBJECTS (NOLOCK) 
								WHERE NAME = ''' + @CSOURCETABLE + '''
								AND XTYPE = ''U'') 
				 AND   D.NAME = ''' + @CDESTTABLE + ''' 
				 AND   A.NAME <> ''TS'' AND E.OBJECT_ID IS NULL'
	INSERT #TTARGETCOL
	EXEC SP_EXECUTESQL @CCMD		

--	PRINT '3'
PRINT '3 : '+@CSOURCETABLE
	IF @LINSERTONLY = 0 AND @LUPDATEXNS=0
	BEGIN

		EXEC SP_UPDATECOLUMNLIST_NEW @CSOURCETABLE, @CKEYFIELD1, @CKEYFIELD2, @CKEYFIELD3, 1,@CINSERTSTR OUTPUT 

		SET @CWHERECLAUSE=(CASE WHEN @BALWAYSUPDATE<>1 THEN ' WHERE CONVERT(DATETIME,A.LAST_UPDATE)<>CONVERT(DATETIME,B.LAST_UPDATE) ' ELSE '' END)

		SET @CCMD = N'UPDATE A SET ' + @CINSERTSTR +
					 ' FROM ' + @CSOURCEDB + @CSOURCETABLESTR + ' B' + 
					 ' JOIN ' + @CDESTDB + @CDESTTABLESTR + ' A ' + @CWC + @CWHERECLAUSE + 
					 (CASE WHEN @CFILTERCONDITION<>'' THEN (CASE WHEN @CWHERECLAUSE='' THEN ' WHERE ' ELSE ' AND ' END)
					  ELSE '' END)+@CFILTERCONDITION
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
	END
	
	IF @LUPDATEONLY = 1
		RETURN

	---- BUILDING INSERT COMMAND
	---- PRINT 'INSERTING RECORDS INTO ' + @CDESTDB + @CDESTTABLE
	--SET @CWC = ''
	--IF @CKEYFIELD2 <> ''
	--	SET @CWC = @CKEYFIELD2 + ' = B.' + @CKEYFIELD2
	--IF @CKEYFIELD3 <> ''
	--	SET @CWC = @CWC + ( CASE WHEN @CWC<>'' THEN ' AND ' ELSE '' END ) + @CKEYFIELD3 + ' = B.' + @CKEYFIELD3
	--IF @CWC <> ''
	--	SET @CWC = ' WHERE ' + @CWC 
	

	DELETE FROM #TTARGETCOL
PRINT '4 : '+@CSOURCETABLE
    SET @CCMD='SELECT A.NAME AS COLNAME, B.NAME AS COLTYPE,E.NAME AS SOURCECOLNAME,A.ISNULLABLE,
			  ISNULL(E.LENGTH,A.LENGTH) AS SOURCE_COLWIDTH,A.LENGTH AS TARGET_COLWIDTH
			   FROM '+ @CDESTDB + 'SYSCOLUMNS A (NOLOCK) 
			   JOIN '+ @CDESTDB + 'SYSTYPES B (NOLOCK) ON A.XTYPE = B.XTYPE AND B.NAME<>''SYSNAME''
			   JOIN '+ @CDESTDB + 'SYSOBJECTS C (NOLOCK) ON C.ID = A.ID 
			   JOIN '+ @CSOURCEDB+'SYSOBJECTS D (NOLOCK) ON D.NAME = '''+@CSOURCETABLE+'''
			   LEFT OUTER JOIN '+@CSOURCEDB+'SYSCOLUMNS E (NOLOCK) ON E.ID = D.ID AND E.NAME=A.NAME
				LEFT OUTER JOIN SYS.IDENTITY_COLUMNS F (NOLOCK) ON F.OBJECT_ID=A.ID AND F.NAME=A.NAME			   
			   WHERE A.ID = ( SELECT ID FROM '+@CDESTDB+'SYSOBJECTS (NOLOCK) 
							WHERE NAME = '''+@CDESTTABLE+'''
							AND XTYPE = ''U'') 
			 AND   C.NAME = '''+@CDESTTABLE+''' 
			 AND   A.NAME <> ''TS'' AND F.OBJECT_ID IS NULL'
	
	INSERT #TTARGETCOL
	EXEC SP_EXECUTESQL @CCMD		
	
	SET @LDONOTREPLNULLS=(CASE WHEN @CKEYFIELD1='' THEN 1 ELSE 0 END)
	
	-- PRINT 'GENERATE INSERT STATEMENT'	
	EXEC SP_INSERTCOLUMNLIST_NEW @CSOURCETABLE,@LDONOTREPLNULLS, @CINSERTSTR OUTPUT, @CINSERTSTRVALUE OUTPUT, 'B'
	
	--SET @CCMD = N' INSERT ' + @CDESTDB + @CDESTTABLE + ' ( ' + @CINSERTSTR + ' ) ' +
	--			 ' SELECT ' + @CINSERTSTRVALUE + 
	--			 ' FROM ' + @CSOURCEDB + @CSOURCETABLE + ' B ' + 
	--			  + ( CASE WHEN @LUPDATEXNS=0 AND @CKEYFIELD1<>'' THEN 
	--				' WHERE ' + @CKEYFIELD1 + ' NOT IN ( 
	--					SELECT DISTINCT ' + @CKEYFIELD1 + ' FROM ' + @CDESTDB + @CDESTTABLE + @CWC + ' ) ' + 
	--			        @CFILTERCONDITION 
	--						   ELSE 
	--						  (	CASE WHEN @CFILTERCONDITION<>'' THEN ' WHERE '+@CFILTERCONDITION ELSE '' END ) END )
PRINT '5 : '+@CSOURCETABLE
	
	SET @CCMD = N' INSERT ' + @CDESTDB + @CDESTTABLESTR+
				  ' ( ' + @CINSERTSTR + ' ) ' +
				 ' SELECT ' + @CINSERTSTRVALUE + 
				 ' FROM ' + @CSOURCEDB + @CSOURCETABLESTR+ ' B ' + 

				 ( CASE WHEN @LUPDATEXNS=0 AND @CKEYFIELD1<>'' THEN 
					' LEFT OUTER JOIN ' + @CDESTDB + @CDESTTABLESTR + ' A ' + @CWC +
					' WHERE A.' + @CKEYFIELD1 + ' IS NULL ' 
				   ELSE '' END )

	IF (@CFILTERCONDITION<>'')
	BEGIN
		SET @CCMD = @CCMD + 
					( CASE WHEN @LUPDATEXNS=0 AND @CKEYFIELD1<>'' THEN ' AND ' ELSE ' WHERE ' END ) + 
					@CFILTERCONDITION
	END
PRINT '6 : '+@CSOURCETABLE
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
END
--*************************************** END OF PROCEDURE UPDATEMASTERXN_NEW
