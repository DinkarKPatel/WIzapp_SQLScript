CREATE PROCEDURE SP3S_UPDATEPOSTACT_CONFIG
--WITH ENCRYPTION 
AS 
BEGIN
/*
	FORM_MODE IN FORM :		
	1 - THE FORM IS OF PURCHASE TYPE.
	2 - THE FORM IS OF SALE TYPE.
	3 - THE FORM IS OF BOTH TYPE.
	4 - THE FORM IS AUTOGENERATED FORM FOR DISTINCT TAX PERCENTAGES IN LOCSST.
	
	VALUETYPE COLUMN IN POSTACT_CONFIG
	1 - VALUE IS OF FORM TYPE OR OTHER ACCOUNT TYPE
	2 - VALUE IS OF PAYMENT MODE TYPE
	3 - VALUE IS OF LOCAL TAXSTRUCTURE FORM TYPE.
*/
DECLARE @CSTEP VARCHAR(10)
		 ,@CCMD NVARCHAR(MAX)
		  ,@NKEYSVALUE1 NUMERIC(18)
		   ,@NKEYSVALUE2 NUMERIC(18)
		    ,@NKEYSVALUE NUMERIC(18)
			 ,@CDEPTID VARCHAR(5)
			  ,@CERRMSG VARCHAR(500)

BEGIN TRY
SET @CSTEP=10
SELECT TOP 1 @CDEPTID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'			 

SET @CSTEP=20
---GETTING THE LIST OF DISTINCT TAX PERCENTAGES FROM LOCSST
IF OBJECT_ID('TEMPDB..#TAXES','U') IS NOT NULL
	DROP TABLE #TAXES

SET @CSTEP=30
SELECT 
	DISTINCT A.TAX_PERCENTAGE 
	 ,CONVERT(VARCHAR(7),'') AS FORM_ID
INTO #TAXES
FROM LOCSST A
 LEFT JOIN FORM B ON A.TAX_PERCENTAGE=B.TAX_PERCENTAGE AND B.FORM_MODE=4
  WHERE B.TAX_PERCENTAGE IS NULL

SET @CSTEP=40
--PROCEED FOR FORM CREATION
IF EXISTS(SELECT TOP 1 'U' FROM #TAXES)
BEGIN
	SET @CSTEP=630
	----GETTING MAX FORM ID FROM KEYS TABLE
	SELECT @NKEYSVALUE=0,@NKEYSVALUE1=0,@NKEYSVALUE2=0
	
	SET @CSTEP=640
	--GETTING THE LAST KEY VALUE FROM KEYS TABLE FOR UOM
	SELECT @NKEYSVALUE1=ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(LASTKEYVAL,3,7))),0) 
	FROM KEYS WHERE TABLENAME='FORM' AND COLUMNNAME='FORM_ID'      
	AND PATINDEX('%[A-Z]%',SUBSTRING(LASTKEYVAL,3,7))=0
	AND PREFIX=@CDEPTID
	
	SET @CSTEP=650
	--GET THE MAX VALUE FROM THE MASTER TABLE
	SELECT @NKEYSVALUE2=ISNULL(MAX(CONVERT(NUMERIC,SUBSTRING(FORM_ID,3,7))),0) 
	FROM FORM
	WHERE PATINDEX('%[A-Z]%',SUBSTRING(FORM_ID,3,7))=0
	AND LEFT(FORM_ID,2)=@CDEPTID
	
	SET @CSTEP=660
	--WHICH EVER VALUE IS GREATER PROCEED FOR KEYS GENERATION ONWARDS...
	IF @NKEYSVALUE1>@NKEYSVALUE2
	BEGIN
		SET @NKEYSVALUE=@NKEYSVALUE1
	END
	ELSE
	BEGIN
		SET @NKEYSVALUE=@NKEYSVALUE2
	END
	
	SET @CSTEP=670
	UPDATE #TAXES SET FORM_ID=@CDEPTID+REPLICATE(0,5-LEN(@NKEYSVALUE))+LTRIM(RTRIM(STR(@NKEYSVALUE)))
						,@NKEYSVALUE=@NKEYSVALUE+1
	
	SET @CSTEP=680
	IF EXISTS(SELECT TOP 1 'U' FROM #TAXES WHERE ISNULL(FORM_ID,'')='')
	BEGIN
		SET @CERRMSG='ERROR GENERATING CODES FOR FORM MASTER.'
		GOTO ENDPROC
	END
	
	SET @CSTEP=690
	INSERT FORM	( POST_TAX_SEPARATELY, PUR_RETURN_AC_CODE, SALE_RETURN_AC_CODE, PHYSICAL_FORM
				, SERIES, EXCISE_ACCESSIBLE_PERCENTAGE, EXCISE_DUTY_PERCENTAGE, EXCISE_EDU_CESS_PERCENTAGE
				, EXCISE_HEDU_CESS_PERCENTAGE, EXCISE_EDU_CESS_AC_CODE, EXCISE_HEDU_CESS_AC_CODE
				, EXCISE_DUTY_AC_CODE, INACTIVE, FORM_ID, FORM_NAME, PURCHASE_AC_CODE, SALE_AC_CODE
				, TAX_AC_CODE, TAX_PERCENTAGE, LAST_UPDATE, PICK_SERIES, FORM_TYPE, TDS_CODE, FORM_MODE )  
    SELECT 	0 AS POST_TAX_SEPARATELY,'0000000000' AS PUR_RETURN_AC_CODE,'0000000000' AS  SALE_RETURN_AC_CODE
		   ,0 AS PHYSICAL_FORM,'' AS SERIES,0 AS EXCISE_ACCESSIBLE_PERCENTAGE,0 AS EXCISE_DUTY_PERCENTAGE
		   ,0 AS EXCISE_EDU_CESS_PERCENTAGE,0 AS EXCISE_HEDU_CESS_PERCENTAGE,'0000000000' AS EXCISE_EDU_CESS_AC_CODE
		   ,'0000000000' AS EXCISE_HEDU_CESS_AC_CODE,'0000000000' AS EXCISE_DUTY_AC_CODE,1 AS INACTIVE, FORM_ID
		   ,'AUTO LOCAL SALES(TAX '+RTRIM(LTRIM(STR(TAX_PERCENTAGE,7,3)))+'%)' AS FORM_NAME
		   ,'0000000000' AS  PURCHASE_AC_CODE,'0000000000' AS  SALE_AC_CODE,'0000000000' AS  TAX_AC_CODE
		   , TAX_PERCENTAGE,GETDATE() AS LAST_UPDATE,0 AS PICK_SERIES,0 AS FORM_TYPE,'' AS TDS_CODE
		   ,4 AS FORM_MODE 
	FROM #TAXES
	
	SET @CSTEP=700
	--INSERT/UPDATE THE KEYS TABLE
	IF NOT EXISTS(SELECT TOP 1 'U' FROM KEYS WHERE TABLENAME='FORM' AND COLUMNNAME='FORM_ID' AND PREFIX=@CDEPTID)
	BEGIN
		SET @CSTEP=1230
		INSERT KEYS	( TABLENAME, LASTKEYVAL, COLUMNNAME, PREFIX, FINYEAR )  
		SELECT 'FORM' AS TABLENAME
			  ,@CDEPTID+REPLICATE(0,5-LEN(@NKEYSVALUE))+LTRIM(RTRIM(STR(@NKEYSVALUE))) AS LASTKEYVAL
			  ,'FORM_ID' AS COLUMNNAME,@CDEPTID AS PREFIX,'' AS FINYEAR 
	END
	ELSE
	BEGIN
		SET @CSTEP=710
		UPDATE KEYS SET LASTKEYVAL=@CDEPTID+REPLICATE(0,5-LEN(@NKEYSVALUE))+LTRIM(RTRIM(STR(@NKEYSVALUE)))
		WHERE TABLENAME='FORM' AND COLUMNNAME='FORM_ID' AND PREFIX=@CDEPTID
	END
END
--END OF AUTO FORM CREATION PROCESS.

--DELETING ENTRIES FOR DELETED FORMS
DELETE POSTACT_CONFIG WHERE VALUETYPE=1 AND FORM_ID NOT IN 
(SELECT FORM_ID FROM FORM)

--NOW ADDING ALL THE FORMS IN POSTACT_CONFIG WHOSE ENTRY IS PENDING

--CREATING FORMS ENTRY FOR PUR PURCHASE_AC_CODE
	INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE,ROWORDER )  
	SELECT 	'PUR' AS XN_TYPE,A.FORM_ID,'PURCHASE_AC_CODE' AS POSTING_PARA_NAME,
	'PURCHASE A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
	'0000000029' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),1,1
	FROM FORM A
	LEFT JOIN POSTACT_CONFIG B 
	 ON A.FORM_ID=B.FORM_ID 
	  AND B.VALUETYPE=1 
	   AND B.XN_TYPE='PUR' 
		AND B.POSTING_PARA_NAME='PURCHASE_AC_CODE'
		 WHERE A.FORM_MODE IN (1,3) AND B.FORM_ID IS NULL

--CREATING FORMS ENTRY FOR PUR DEBITNOTE_AC_CODE
	INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE,ROWORDER  )  
	SELECT 	'PUR' AS XN_TYPE,A.FORM_ID,'DEBITNOTE_AC_CODE' AS POSTING_PARA_NAME,
	'DEBITNOTE A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
	'0000000029' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),1,2
	FROM FORM A
	LEFT JOIN POSTACT_CONFIG B 
	 ON A.FORM_ID=B.FORM_ID 
	  AND B.VALUETYPE=1 
	   AND B.XN_TYPE='PUR' 
		AND B.POSTING_PARA_NAME='DEBITNOTE_AC_CODE'
		 WHERE A.FORM_MODE IN (1,3) AND B.FORM_ID IS NULL

--CREATING FORMS ENTRY FOR PUR TAX_AC_CODE
	INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE,ROWORDER  )  
	SELECT 	'PUR' AS XN_TYPE,A.FORM_ID,'TAX_AC_CODE' AS POSTING_PARA_NAME,
	'TAX A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
	'0000000019' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),1,3
	FROM FORM A
	LEFT JOIN POSTACT_CONFIG B 
	 ON A.FORM_ID=B.FORM_ID 
	  AND B.VALUETYPE=1 
	   AND B.XN_TYPE='PUR' 
		AND B.POSTING_PARA_NAME='TAX_AC_CODE'
		 WHERE A.FORM_MODE IN (1,3) AND A.TAX_PERCENTAGE>0 AND B.FORM_ID IS NULL

--CREATING FORMS ENTRY FOR WSL WHOLESALE_AC_CODE
	INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE,ROWORDER  )  
	SELECT 	'WSL' AS XN_TYPE,A.FORM_ID,'WHOLESALE_AC_CODE' AS POSTING_PARA_NAME,
	'WHOLESALE A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
	'0000000030' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),1,1
	FROM FORM A
	LEFT JOIN POSTACT_CONFIG B 
	 ON A.FORM_ID=B.FORM_ID 
	  AND B.VALUETYPE=1 
	   AND B.XN_TYPE='WSL' 
		AND B.POSTING_PARA_NAME='WHOLESALE_AC_CODE'
		 WHERE A.FORM_MODE IN (2,3) AND B.FORM_ID IS NULL
		 
--CREATING FORMS ENTRY FOR WSL SALE_RETURN_AC_CODE
	INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE,ROWORDER  )  
	SELECT 	'WSL' AS XN_TYPE,A.FORM_ID,'WHOLESALE_RETURN_AC_CODE' AS POSTING_PARA_NAME,
	'SALE RETURN A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
	'0000000030' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),1,2
	FROM FORM A
	LEFT JOIN POSTACT_CONFIG B 
	 ON A.FORM_ID=B.FORM_ID 
	  AND B.VALUETYPE=1 
	   AND B.XN_TYPE='WSL' 
		AND B.POSTING_PARA_NAME='SALE_RETURN_AC_CODE'
		 WHERE A.FORM_MODE IN (2,3) AND B.FORM_ID IS NULL	
		 
--CREATING FORMS ENTRY FOR WSL TAX_AC_CODE
--	INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
--		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE )  
--	SELECT 	'WSL' AS XN_TYPE,A.FORM_ID,'TAX_AC_CODE' AS POSTING_PARA_NAME,
--	'TAX A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
--	'0000000019' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),1
--	FROM FORM A
--	LEFT JOIN POSTACT_CONFIG B 
--	 ON A.FORM_ID=B.FORM_ID 
--	  AND B.VALUETYPE=1 
--	   AND B.XN_TYPE='WSL' 
--		AND B.POSTING_PARA_NAME='TAX_AC_CODE'
--		 WHERE A.FORM_MODE IN (2,3) AND B.FORM_ID IS NULL			 	 

----CREATING FORMS ENTRY FOR CHO TAX_AC_CODE
--	INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
--		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE )  
--	SELECT 	'CHO' AS XN_TYPE,A.FORM_ID,'TAX_AC_CODE' AS POSTING_PARA_NAME,
--	'TAX A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
--	'0000000019' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),1
--	FROM FORM A
--	LEFT JOIN POSTACT_CONFIG B 
--	 ON A.FORM_ID=B.FORM_ID 
--	  AND B.VALUETYPE=1 
--	   AND B.XN_TYPE='CHO' 
--		AND B.POSTING_PARA_NAME='TAX_AC_CODE'
--		 WHERE B.FORM_ID IS NULL

----CREATING FORMS ENTRY FOR CHO PUR_AC_CODE
--	INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
--		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE )  
--	SELECT 	'CHO' AS XN_TYPE,A.FORM_ID,'PUR_AC_CODE' AS POSTING_PARA_NAME,
--	'PURCHASE A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
--	'0000000029' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),1
--	FROM FORM A
--	LEFT JOIN POSTACT_CONFIG B 
--	 ON A.FORM_ID=B.FORM_ID 
--	  AND B.VALUETYPE=1 
--	   AND B.XN_TYPE='CHO' 
--		AND B.POSTING_PARA_NAME='PUR_AC_CODE'
--		 WHERE A.FORM_MODE IN (1,3) AND B.FORM_ID IS NULL

----CREATING FORMS ENTRY FOR CHO EXCISE_AC_CODE
--	INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
--		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE )  
--	SELECT 	'CHO' AS XN_TYPE,A.FORM_ID,'EXCISE_AC_CODE' AS POSTING_PARA_NAME,
--	'EXCISEDUTY A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
--	'0000000019' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),1
--	FROM FORM A
--	LEFT JOIN POSTACT_CONFIG B 
--	 ON A.FORM_ID=B.FORM_ID 
--	  AND B.VALUETYPE=1 
--	   AND B.XN_TYPE='CHO' 
--		AND B.POSTING_PARA_NAME='EXCISE_AC_CODE'
--		 WHERE B.FORM_ID IS NULL
		 
----CREATING FORMS ENTRY FOR CHO SALE_AC_CODE
--	INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
--		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE )  
--	SELECT 	'CHO' AS XN_TYPE,A.FORM_ID,'SALE_AC_CODE' AS POSTING_PARA_NAME,
--	'SALE A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
--	'0000000030' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),1
--	FROM FORM A
--	LEFT JOIN POSTACT_CONFIG B 
--	 ON A.FORM_ID=B.FORM_ID 
--	  AND B.VALUETYPE=1 
--	   AND B.XN_TYPE='CHO' 
--		AND B.POSTING_PARA_NAME='SALE_AC_CODE'
--		 WHERE A.FORM_MODE IN (2,3) AND B.FORM_ID IS NULL		 

---CREATING AUTO GENERATED FORM ENTRY IN POSTACT_CONFIG
INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE,ROWORDER  )  
	SELECT 	'WSL' AS XN_TYPE,A.FORM_ID,'TAX_AC_CODE' AS POSTING_PARA_NAME,
	'TAX A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
	'0000000019' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),3,3
	FROM FORM A
	LEFT JOIN POSTACT_CONFIG B 
	 ON A.FORM_ID=B.FORM_ID 
	  AND B.VALUETYPE=3 
	   AND B.XN_TYPE='WSL' 
		AND B.POSTING_PARA_NAME='TAX_AC_CODE'
		 WHERE A.FORM_MODE=4 AND A.TAX_PERCENTAGE>0 AND B.FORM_ID IS NULL		 

---CREATING AUTO GENERATED FORM ENTRY IN POSTACT_CONFIG
INSERT POSTACT_CONFIG	( XN_TYPE, FORM_ID, POSTING_PARA_NAME, POSTING_PARA_DESC,
		POSTING_PARA_TYPE, POSTING_PARA_VAL,FILTER_HEAD_CODE,ROW_ID,VALUETYPE,ROWORDER )  
	SELECT 	'WSL' AS XN_TYPE,A.FORM_ID,'WHOLESALE_AC_CODE' AS POSTING_PARA_NAME,
	'WHOLESALE A/C' AS POSTING_PARA_DESC,1 AS POSTING_PARA_TYPE,'' AS POSTING_PARA_VAL,
	'0000000030' AS FILTER_HEAD_CODE,CONVERT(VARCHAR(40),NEWID()),3,1
	FROM FORM A
	LEFT JOIN POSTACT_CONFIG B 
	 ON A.FORM_ID=B.FORM_ID 
	  AND B.VALUETYPE=3 
	   AND B.XN_TYPE='WSL' 
		AND B.POSTING_PARA_NAME='WHOLESALE_AC_CODE'
		 WHERE A.FORM_MODE=4 AND B.FORM_ID IS NULL		

END TRY
BEGIN CATCH
		SET @CERRMSG='P:SP3S_UPDATEPOSTACT_CONFIG AT STEP '+@CSTEP+', ERROR : '+ERROR_MESSAGE()
END CATCH

ENDPROC:
	SELECT ISNULL(@CERRMSG,'') AS ERRMSG

END
--END OF PROCEDURE - SP3S_UPDATEPOSTACT_CONFIG
