CREATE PROCEDURE SP3S_GET_ACTIVE_SCHEMESETS
@cLocId VARCHAR(5),
@dXnDt DATETIME
AS
BEGIN

	;WITH SCHEME
	AS
	(
		SELECT DISTINCT SCHEME_set_name,a.memo_no 
		FROM scheme_Setup_mst a (NOLOCK)
		left JOIN scheme_Setup_loc g (NOLOCK) ON a.memo_no=g.memo_no
		LEFT OUTER JOIN SCHEME_SETUP_HAPPYHOURS HH (NOLOCK) ON HH.MEMO_NO=g.MEMO_NO
		WHERE (a.loc_applicable_mode=1 OR G.DEPT_ID=@cLocId)
		AND @DXNDT BETWEEN a.APPLICABLE_FROM_DT AND a.APPLICABLE_TO_DT
		AND a.INACTIVE=0
		AND (HH.MEMO_NO IS NULL OR HAPPY_HOURS_RESTRICTION_APPLICABLE=0 OR  CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,GETDATE()))))+':'+
		LTRIM(RTRIM(STR(DATEPART(MI,GETDATE()))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,GETDATE())))))
		BETWEEN 
		CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,FROM_TIME))))+':'+
		LTRIM(RTRIM(STR(DATEPART(MI,FROM_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,FROM_TIME)))))
		AND
		CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,TO_TIME))))+':'+
		LTRIM(RTRIM(STR(DATEPART(MI,TO_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,TO_TIME))))))
	)
	SELECT '---Select---' as SCHEME_set_name,'' AS  memo_no
	UNION
	SELECT  SCHEME_set_name,  memo_no
	FROM SCHEME
	ORDER BY memo_no,SCHEME_set_name
END
