
create PROCEDURE SP_JOBWORKPENDING_REPORT 
(
@CFROMDATE		DATETIME,
@CTODATE		DATETIME,
@BTILL_DAYS     INT=0,
@BSORTBY        BIT=0,
@CDEPT_ID       VARCHAR(100)='',
@CAGENCY		VARCHAR(100)='',
@JOB            VARCHAR(100)='',
@NMODE          INT=2,
@ZMODE          INT =1 --1 FOR ALL 0 FOR PENDING
) 
----WITH ENCRYPTION
AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 
	DECLARE @CCMD NVARCHAR(MAX),@SORTCONDITION VARCHAR(200)
	DECLARE  @TMPOPS TABLE(AGENCY_CODE VARCHAR(100) ,ISSUE_DT DATETIME  ,JOB_CODE VARCHAR(100),DEPT_ID VARCHAR(2),
		              ISSUE_ID VARCHAR(100),[QUANTITY] NUMERIC(18,3),REC_QUANTITY NUMERIC(18,3),
		              OPS_PENDING NUMERIC(18,3), AGEINGDAYS INT,PRODUCT_CODE VARCHAR(100),REMARKS VARCHAR(MAX), RECEIPT_NO VARCHAR(100), RECEIPT_DT DATETIME) 

	    
	IF @BSORTBY=0    
	SET @SORTCONDITION='ORDER BY ISNULL(A.AGENCY_NAME,B.AGENCY_NAME),ISNULL(A.JOB_NAME,B.JOB_NAME)'    
    ELSE
    SET @SORTCONDITION='ORDER BY ISNULL(A.JOB_NAME,B.JOB_NAME),ISNULL(A.AGENCY_NAME,B.AGENCY_NAME)'
    

    IF LTRIM(RTRIM(ISNULL(@CDEPT_ID,'')))=''
		SET @CDEPT_ID=NULL
	
	IF LTRIM(RTRIM(ISNULL(@CAGENCY,'')))=''
		SET @CAGENCY=NULL
	
	IF LTRIM(RTRIM(ISNULL(@JOB,'')))=''
		SET @JOB=NULL	

IF @NMODE=1
 GOTO LBLSUMMARY
ELSE
GOTO LBLDETAILS

LBLSUMMARY:
	IF @BTILL_DAYS=0
       BEGIN
			INSERT INTO @TMPOPS(AGENCY_CODE ,ISSUE_DT ,JOB_CODE ,DEPT_ID,ISSUE_ID ,[QUANTITY] ,REC_QUANTITY ,OPS_PENDING , AGEINGDAYS) 
			SELECT AGENCY_CODE ,ISSUE_DT ,A.JOB_CODE,b.location_Code  AS DEPT_ID,
				   A.ISSUE_ID, QUANTITY=SUM(A.QUANTITY )-SUM(ISNULL(OPS_REC1,0)),REC_QUANTITY=SUM(ISNULL(OPS_REC2,0)),
				   OPS_PENDING=(SUM(A.QUANTITY )-SUM(ISNULL(OPS_REC1,0)))- SUM(ISNULL(OPS_REC2,0)),
				   AGEINGDAYS=CASE WHEN (SUM(A.QUANTITY )-SUM(ISNULL(OPS_REC1,0)))- SUM(ISNULL(OPS_REC2,0))=0 THEN 0 ELSE
							  DATEDIFF (DAY ,ISSUE_DT,@CFROMDATE ) END
			FROM JOBWORK_ISSUE_DET A
			JOIN JOBWORK_ISSUE_MST B ON A.ISSUE_ID =B.ISSUE_ID 
			LEFT JOIN
			(
			 SELECT A.REF_ROW_ID, B.RECEIPT_DT,
			 SUM(CASE WHEN B.RECEIPT_DT< @CFROMDATE THEN (A.QUANTITY+ISNULL(a.SHRINK_QTY,0) ) ELSE 0 END) AS OPS_REC1,
			 SUM(CASE WHEN B.RECEIPT_DT BETWEEN @CFROMDATE AND @CTODATE  THEN (A.QUANTITY+ISNULL(a.SHRINK_QTY,0) ) ELSE 0 END) AS OPS_REC2
			 FROM JOBWORK_RECEIPT_DET A
			 JOIN JOBWORK_RECEIPT_MST B ON A.RECEIPT_ID =B.RECEIPT_ID 
			 WHERE B.CANCELLED =0 
			 --AND B.WIP=0 	 --AND B.RECEIPT_DT < @CTODATE 
			 GROUP BY A.REF_ROW_ID, B.RECEIPT_NO, B.RECEIPT_DT
			 ) REC ON REC.REF_ROW_ID =A.ROW_ID 
			WHERE B.CANCELLED=0 AND B.WIP=0     --AND B.ISSUE_DT = @CFROMDATE
			AND ( (B.ISSUE_DT = @CFROMDATE) OR (REC.RECEIPT_DT =  @CFROMDATE) )
	        AND b.location_Code = ISNULL(@CDEPT_ID,b.location_Code )
	        AND AGENCY_CODE = ISNULL(@CAGENCY,AGENCY_CODE)
	        AND A.JOB_CODE = ISNULL(@JOB,A.JOB_CODE)
			GROUP BY AGENCY_CODE ,PRODUCT_CODE,ISSUE_DT ,A.JOB_CODE ,b.location_Code  ,A.ISSUE_ID
			ORDER BY ISSUE_ID 
     END	
    
	 DELETE FROM @TMPOPS WHERE ISNULL(OPS_PENDING,0)=0

   IF OBJECT_ID ('TEMPDB..#TMPOPSPENDING','U') IS NOT NULL
	     DROP TABLE #TMPOPSPENDING 	      
	     
		SELECT A.DEPT_ID, A.AGENCY_CODE ,C.AGENCY_NAME,A.JOB_CODE,B.JOB_NAME, 
		       SUM(QUANTITY) AS OPS_ISSUED,
		       SUM(REC_QUANTITY) OPS_RECEIVED,
		       SUM(OPS_PENDING) AS OPS_PENDING,
		       UPTO_30=SUM(CASE WHEN  AGEINGDAYS BETWEEN 1 AND 30 THEN OPS_PENDING  ELSE 0 END),
		       UP_31_60=SUM(CASE WHEN  AGEINGDAYS BETWEEN 31 AND 60 THEN OPS_PENDING ELSE 0 END),
		       UP_61_90=SUM(CASE WHEN  AGEINGDAYS BETWEEN 61 AND 90 THEN OPS_PENDING ELSE 0 END),
		       ABOVE_91=SUM(CASE WHEN  AGEINGDAYS >90 THEN OPS_PENDING ELSE 0 END)
		INTO #TMPOPSPENDING
		FROM @TMPOPS A
		JOIN JOBS  B ON A.JOB_CODE =B.JOB_CODE 
		JOIN PRD_AGENCY_MST C (NOLOCK) ON C.AGENCY_CODE=A.AGENCY_CODE	
		GROUP BY A.DEPT_ID, A.AGENCY_CODE ,C.AGENCY_NAME,A.JOB_CODE,B.JOB_NAME
		
	 IF OBJECT_ID ('TEMPDB..#TMPCURRENTPERIOD','U') IS NOT NULL
	     DROP TABLE #TMPCURRENTPERIOD 	
		
		SELECT ISNULL(C.AGENCY_CODE,'' ) AS AGENCY_CODE,
		       C.AGENCY_NAME,
		       ISNULL(A.PRODUCT_CODE,'') AS  PRODUCT_CODE
		      ,B.ISSUE_DT ,
		       ISNULL(A.JOB_CODE,'') AS JOB_CODE,
		       ISNULL(b.location_Code ,'') AS DEPT_ID
		       ,B.ISSUE_NO,A.ISSUE_ID ,SUM(A.QUANTITY) AS [QUANTITY],
		       SUM(ISNULL(REC.QUANTITY,0)) AS REC_QUANTITY
		      ,PERIOD_PENDING=SUM(A.QUANTITY)-SUM(ISNULL(REC.QUANTITY,0)) 
		      ,AGEINGDAYS=CASE WHEN SUM(A.QUANTITY)-SUM(ISNULL(REC.QUANTITY,0)) =0 THEN 0
              ELSE DATEDIFF (DAY ,ISSUE_DT,@CTODATE ) END
		      ,A.REMARKS
		INTO #TMPCURRENTPERIOD 
	    FROM JOBWORK_ISSUE_DET A (NOLOCK)
	    JOIN JOBWORK_ISSUE_MST  B (NOLOCK) ON B.ISSUE_ID=A.ISSUE_ID
	    LEFT JOIN
	    (
	      SELECT A.REF_ROW_ID,SUM(A.QUANTITY+ISNULL(a.SHRINK_QTY,0) ) AS QUANTITY 
	      FROM JOBWORK_RECEIPT_DET A
	      JOIN JOBWORK_RECEIPT_MST B ON A.RECEIPT_ID =B.RECEIPT_ID 
	      WHERE B.CANCELLED =0 
	      --AND B.WIP=0 	
	      AND B.RECEIPT_DT BETWEEN CASE WHEN @BTILL_DAYS=1 THEN '1900-01-01' ELSE  @CFROMDATE END AND @CTODATE
	      GROUP BY A.REF_ROW_ID
	    ) REC ON REC.REF_ROW_ID =A.ROW_ID 
	    JOIN PRD_AGENCY_MST C (NOLOCK) ON C.AGENCY_CODE=ISNULL(B.AGENCY_CODE,'' )	
	    WHERE B.CANCELLED=0 AND B.WIP=0 AND B.ISSUE_DT BETWEEN CASE WHEN @BTILL_DAYS=1 THEN '1900-01-01' ELSE  @CFROMDATE END AND @CTODATE
	    AND b.location_Code  = ISNULL(@CDEPT_ID,b.location_Code )
	    AND C.AGENCY_CODE = ISNULL(@CAGENCY,C.AGENCY_CODE)
	    AND A.JOB_CODE = ISNULL(@JOB,A.JOB_CODE) 
		GROUP BY ISNULL(C.AGENCY_CODE,'' ),
		       C.AGENCY_NAME,
		       ISNULL(A.PRODUCT_CODE,''),B.ISSUE_DT ,
		       ISNULL(A.JOB_CODE,''),
		       ISNULL(b.location_Code ,''), 
		       A.ISSUE_ID ,B.ISSUE_NO,A.REMARKS
		
	
		IF OBJECT_ID ('TEMPDB..#TMPPERIODPENDING','U') IS NOT NULL
	     DROP TABLE #TMPPERIODPENDING 	      
		
		SELECT A.DEPT_ID, A.AGENCY_CODE ,A.AGENCY_NAME,A.JOB_CODE,B.JOB_NAME, 
		       SUM(QUANTITY) AS ISSUED,
		       SUM(REC_QUANTITY) RECEIVED,
		       SUM(PERIOD_PENDING) AS CURRENT_PERIOD_PENDING,
		       UPTO_30=SUM(CASE WHEN  AGEINGDAYS BETWEEN 1 AND 30 THEN PERIOD_PENDING  ELSE 0 END),
		       UP_31_60=SUM(CASE WHEN  AGEINGDAYS BETWEEN 31 AND 60 THEN PERIOD_PENDING ELSE 0 END),
		       UP_61_90=SUM(CASE WHEN  AGEINGDAYS BETWEEN 61 AND 90 THEN PERIOD_PENDING ELSE 0 END),
		       ABOVE_91=SUM(CASE WHEN  AGEINGDAYS >90 THEN PERIOD_PENDING ELSE 0 END)
		INTO #TMPPERIODPENDING 
		FROM #TMPCURRENTPERIOD A
		JOIN JOBS  B ON A.JOB_CODE =B.JOB_CODE 
		GROUP BY A.DEPT_ID, A.AGENCY_CODE ,A.AGENCY_NAME,A.JOB_CODE,B.JOB_NAME
	    
	    SELECT A.DEPT_ID,B.DEPT_NAME,AGENCY_CODE,AGENCY_NAME,JOB_CODE ,JOB_NAME,
	    SUM(ISNULL(OPS_ISSUED,0)) AS OPS_JWI,
	    SUM(ISNULL(OPS_RECEIVED,0)) AS OPS_JWR,
	    SUM(ISNULL(OPS_PENDING,0)) AS OPS_PENDING, 
	    SUM(ISNULL(ISSUED,0)) AS PERJWI,
	    SUM(ISNULL(RECEIVED,0)) AS PERJWR,
	    SUM(ISNULL(CURRENT_PERIOD_PENDING,0)) AS PERPENDING, 
	    SUM(ISNULL(OPS_ISSUED,0))+SUM(ISNULL(ISSUED,0)) AS TOTAL_ISSUED,
	    SUM(ISNULL(OPS_RECEIVED,0))+SUM(ISNULL(RECEIVED,0)) AS TOTAL_RECEIPT,
	    SUM(ISNULL(OPS_PENDING,0))+ SUM(ISNULL(CURRENT_PERIOD_PENDING,0)) AS TOTAL_PENDING,
	    SUM(ISNULL (UPTO_30,0)) AS UPTO_30,
	    SUM(ISNULL (UP_31_60,0)) AS UP_31_60,
	    SUM(ISNULL (ABOVE_91,0)) AS ABOVE_91
	    FROM 
	    (
	    SELECT DEPT_ID,AGENCY_CODE,AGENCY_NAME,JOB_CODE ,JOB_NAME ,OPS_ISSUED ,OPS_RECEIVED ,OPS_PENDING,
	           0 AS ISSUED,0 AS RECEIVED , 0 AS CURRENT_PERIOD_PENDING, 
	           UPTO_30,UP_31_60,ABOVE_91
	    FROM #TMPOPSPENDING
	    UNION ALL
        SELECT DEPT_ID,AGENCY_CODE,AGENCY_NAME,JOB_CODE ,JOB_NAME ,0 AS OPS_ISSUED ,0 AS OPS_RECEIVED ,0 AS OPS_PENDING,
               ISSUED,RECEIVED ,CURRENT_PERIOD_PENDING, 
	           UPTO_30,UP_31_60,ABOVE_91 
	    FROM #TMPPERIODPENDING
        ) A
        JOIN LOCATION (NOLOCK) B ON A.DEPT_ID=B.DEPT_ID 
       -- WHERE (@ZMODE=1 OR 
        GROUP BY A.DEPT_ID,B.DEPT_NAME,AGENCY_CODE,AGENCY_NAME,JOB_CODE ,JOB_NAME
        HAVING (@ZMODE=1 OR SUM(ISNULL(OPS_PENDING,0))+ SUM(ISNULL(CURRENT_PERIOD_PENDING,0))>=1)
        
       SELECT  SR=2, '' AS DEPT_ID,'' AS DEPT_NAME,'' AS JOB_CODE,'' AS JOB_NAME,'' AS AGENCY_CODE ,'' AS AGENCY_NAME,
		       '' AS ISSUE_NO,
		       ''  AS ISSUE_DT,
		       0 AS JWI,
		       '' AS RECEIPT_NO,
		       ''   AS RECEIPT_DT,
		       0 AS JWR,
		       PENDING_ISSUED=0,
		       PENDING_RECEIVED=0,
		       PENDING=0,
		       AGEINGDAYS=0,
		       '' AS PRODUCT_CODE,
		       '' AS REMARKS
			   ,'' AS ISSUE_ID
			   ,0 AS SRNO
		 WHERE 1=2	   
GOTO END_PROC

LBLDETAILS:    

       --SET @BTILL_DAYS=1
       DELETE FROM @TMPOPS
       IF @BTILL_DAYS=0
       BEGIN
			INSERT INTO @TMPOPS(AGENCY_CODE ,ISSUE_DT ,JOB_CODE ,DEPT_ID ,ISSUE_ID ,[QUANTITY] ,REC_QUANTITY ,OPS_PENDING , AGEINGDAYS,PRODUCT_CODE ,REMARKS , RECEIPT_NO, RECEIPT_DT) 
			SELECT AGENCY_CODE , ISSUE_DT ,A.JOB_CODE,b.location_Code  AS DEPT_ID,
				   A.ISSUE_ID,
				   QUANTITY=SUM(A.QUANTITY )-SUM(ISNULL(OPS_REC1,0)),
				   REC_QUANTITY=SUM(ISNULL(OPS_REC2,0)),
				   OPS_PENDING=(SUM(A.QUANTITY )-SUM(ISNULL(OPS_REC1,0)))- SUM(ISNULL(OPS_REC2,0)),
				   AGEINGDAYS=CASE WHEN (SUM(A.QUANTITY )-SUM(ISNULL(OPS_REC1,0)))- SUM(ISNULL(OPS_REC2,0))=0 THEN 0 ELSE
							  DATEDIFF (DAY ,ISSUE_DT,@CFROMDATE ) END,
				  '' AS PRODUCT_CODE,
				  '' AS REMARKS,
				  (CASE WHEN REC.RECEIPT_DT BETWEEN @CFROMDATE AND @CTODATE  THEN  REC.RECEIPT_NO ELSE '' END) AS RECEIPT_NO, 
				  (CASE WHEN REC.RECEIPT_DT BETWEEN @CFROMDATE AND @CTODATE  THEN  REC.RECEIPT_DT ELSE '' END) AS RECEIPT_DT 
			FROM JOBWORK_ISSUE_DET A 
			JOIN JOBWORK_ISSUE_MST B ON A.ISSUE_ID =B.ISSUE_ID 
			LEFT JOIN
			(
			 SELECT A.REF_ROW_ID,
			 SUM(CASE WHEN B.RECEIPT_DT< @CFROMDATE THEN (A.QUANTITY+ISNULL(a.SHRINK_QTY,0) ) ELSE 0 END) AS OPS_REC1,
			 SUM(CASE WHEN B.RECEIPT_DT BETWEEN @CFROMDATE AND @CTODATE  THEN (A.QUANTITY+ISNULL(a.SHRINK_QTY,0) ) ELSE 0 END) AS OPS_REC2,
			 ISNULL(B.RECEIPT_NO,'') AS RECEIPT_NO ,ISNULL(B.RECEIPT_DT,'') AS RECEIPT_DT
			 FROM JOBWORK_RECEIPT_DET A
			 JOIN JOBWORK_RECEIPT_MST B ON A.RECEIPT_ID =B.RECEIPT_ID 
			 WHERE B.CANCELLED =0 AND  B.RECEIPT_DT< @CTODATE  
			 GROUP BY A.REF_ROW_ID ,B.RECEIPT_NO  ,B.RECEIPT_DT
			 ) REC ON REC.REF_ROW_ID =A.ROW_ID 
			WHERE B.CANCELLED=0 
			--AND B.WIP=0  
			 AND B.ISSUE_DT < @CFROMDATE  
	         AND b.location_Code  = ISNULL(@CDEPT_ID,b.location_Code )
	         AND AGENCY_CODE = ISNULL(@CAGENCY,AGENCY_CODE)
	         AND A.JOB_CODE = ISNULL(@JOB,A.JOB_CODE)
			GROUP BY AGENCY_CODE ,PRODUCT_CODE,ISSUE_DT ,A.JOB_CODE,b.location_Code ,A.ISSUE_ID , REC.RECEIPT_NO  ,REC.RECEIPT_DT
			ORDER BY ISSUE_ID 
       END	
   
      IF OBJECT_ID ('TEMPDB..#TMPOPSPENDING_DET','U') IS NOT NULL
	     DROP TABLE #TMPOPSPENDING_DET 	      
		
		SELECT A.DEPT_ID, A.AGENCY_CODE ,C.AGENCY_NAME,A.JOB_CODE,B.JOB_NAME, 
		       SUM(QUANTITY) AS OPS_ISSUED,
		       SUM(REC_QUANTITY) OPS_RECEIVED,
		       SUM(OPS_PENDING) AS OPS_PENDING,
		       A.PRODUCT_CODE,
		       A.REMARKS,
		       UPTO_30=SUM(CASE WHEN  AGEINGDAYS BETWEEN 1 AND 30 THEN OPS_PENDING  ELSE 0 END),
		       UP_31_60=SUM(CASE WHEN  AGEINGDAYS BETWEEN 31 AND 60 THEN OPS_PENDING ELSE 0 END),
		       UP_61_90=SUM(CASE WHEN  AGEINGDAYS BETWEEN 61 AND 90 THEN OPS_PENDING ELSE 0 END),
		       ABOVE_91=SUM(CASE WHEN  AGEINGDAYS >90 THEN OPS_PENDING ELSE 0 END), 
			   A.RECEIPT_NO, 
			   A.RECEIPT_DT,
			   A.ISSUE_DT
		INTO #TMPOPSPENDING_DET
		FROM @TMPOPS A
		JOIN JOBS  B ON A.JOB_CODE =B.JOB_CODE 
		JOIN PRD_AGENCY_MST C (NOLOCK) ON C.AGENCY_CODE=A.AGENCY_CODE	
		GROUP BY A.DEPT_ID, A.AGENCY_CODE ,C.AGENCY_NAME ,A.JOB_CODE ,B.JOB_NAME ,A.PRODUCT_CODE,
		       A.REMARKS, A.RECEIPT_NO, A.RECEIPT_DT ,A.ISSUE_DT
        
        
      
        
         DELETE FROM #TMPOPSPENDING_DET WHERE ISNULL(OPS_PENDING,0)=0
        
         IF OBJECT_ID ('TEMPDB..#TMPCURRENTPERIOD_DET','U') IS NOT NULL
	     DROP TABLE #TMPCURRENTPERIOD_DET 	
		
		SELECT CASE WHEN ROW_NUMBER() OVER (PARTITION BY ISNULL(A.ISSUE_ID,''),ISNULL(A.PRODUCT_CODE,''),a.row_id ORDER BY ISNULL(A.ISSUE_ID,''),ISNULL(A.PRODUCT_CODE,''),a.row_id ) > 1 THEN 1 ELSE 0 END  AS ROWCNT,
		       ISNULL(C.AGENCY_CODE,'' ) AS AGENCY_CODE,
		       C.AGENCY_NAME,
		       ISNULL(A.PRODUCT_CODE,'') AS  PRODUCT_CODE,
		       B.ISSUE_DT ,
		       ISNULL(A.JOB_CODE,'') AS JOB_CODE,
		       ISNULL(b.location_Code ,'') AS DEPT_ID,
		       B.ISSUE_NO,
		       A.ISSUE_ID ,
		       A.REMARKS,
		       ROW_NUMBER() OVER (PARTITION BY ISNULL(A.ISSUE_ID,''), ISNULL(A.PRODUCT_CODE,''),A.REMARKS,a.row_id ORDER BY ISNULL(A.ISSUE_ID,''),ISNULL(A.PRODUCT_CODE,''),A.REMARKS,a.row_id) AS SRNO,
		       CASE WHEN ROW_NUMBER() OVER (PARTITION BY ISNULL(A.ISSUE_ID,''),ISNULL(A.PRODUCT_CODE,''),A.REMARKS,a.row_id ORDER BY ISNULL(A.ISSUE_ID,''),ISNULL(A.PRODUCT_CODE,''),A.REMARKS,a.row_id)=1
		       THEN SUM(A.QUANTITY) ELSE 0 END AS [QUANTITY],
		       SUM(A.QUANTITY) AS ISSUE_QTY,
		       ISNULL(REC.RECEIPT_NO,'') AS RECEIPT_NO, 
			   ISNULL(REC.RECEIPT_DT,'') AS RECEIPT_DT,
		       SUM(ISNULL(REC.QUANTITY,0)) AS REC_QUANTITY,
		       PERIOD_PENDING=CAST(0 AS NUMERIC(18,2)), 
		       AGEINGDAYS=CAST( 0 AS INT),  
		       a.row_id
		INTO #TMPCURRENTPERIOD_DET  
	    FROM JOBWORK_ISSUE_DET A (NOLOCK)
	    JOIN JOBWORK_ISSUE_MST  B (NOLOCK) ON B.ISSUE_ID=A.ISSUE_ID
	    LEFT JOIN
	    (
	      SELECT B.RECEIPT_NO ,B.RECEIPT_DT ,
	      A.REF_ROW_ID,SUM(A.QUANTITY+ISNULL(a.SHRINK_QTY,0) ) AS QUANTITY 
	      FROM JOBWORK_RECEIPT_DET A
	      JOIN JOBWORK_RECEIPT_MST B ON A.RECEIPT_ID =B.RECEIPT_ID 
	      WHERE B.CANCELLED =0 
	      --AND B.WIP=0  
		  --AND B.RECEIPT_DT BETWEEN CASE WHEN @BTILL_DAYS=1 THEN '1900-01-01' ELSE  @CFROMDATE END AND @CTODATE
	      GROUP BY A.REF_ROW_ID, B.RECEIPT_NO ,B.RECEIPT_DT
	    ) REC ON REC.REF_ROW_ID =A.ROW_ID 
	    JOIN PRD_AGENCY_MST C (NOLOCK) ON C.AGENCY_CODE=ISNULL(B.AGENCY_CODE,'' )	
	    WHERE B.CANCELLED=0 AND B.WIP=0 
		 AND ( 
		     (B.ISSUE_DT BETWEEN CASE WHEN 0=1 THEN '1900-01-01' ELSE  @CFROMDATE END AND @CTODATE)
		     OR (REC.RECEIPT_DT  BETWEEN CASE WHEN 0=1 THEN '1900-01-01' ELSE  @CFROMDATE END AND @CTODATE )
			 )
		 --AND B.ISSUE_DT BETWEEN CASE WHEN @BTILL_DAYS=1 THEN '1900-01-01' ELSE  @CFROMDATE END AND @CTODATE
	      AND b.location_Code  = ISNULL(@CDEPT_ID,b.location_Code )
	      AND C.AGENCY_CODE = ISNULL(@CAGENCY,C.AGENCY_CODE)
	      AND A.JOB_CODE = ISNULL(@JOB,A.JOB_CODE) 
		GROUP BY ISNULL(C.AGENCY_CODE,'' ),
		       C.AGENCY_NAME,
		       ISNULL(A.PRODUCT_CODE,''),B.ISSUE_DT ,
		       ISNULL(A.JOB_CODE,''),
		       ISNULL(b.location_Code ,''), 
		       A.ISSUE_ID ,B.ISSUE_NO,A.REMARKS,
		       ISNULL(REC.RECEIPT_NO,''),ISNULL(REC.RECEIPT_DT,''),
		       a.row_id
		  

        UPDATE  A SET A.ROWCNT=1   
		FROM #TMPCURRENTPERIOD_DET A WHERE A.ISSUE_ID IN
		( 
		SELECT A.ISSUE_ID FROM #TMPCURRENTPERIOD_DET A WHERE A.ROWCNT = 1
		)

		UPDATE  A SET PERIOD_PENDING=A.ISSUE_QTY-ISNULL(B.REC_QUANTITY,0)    
		--,AGEINGDAYS=DATEDIFF (DAY ,ISSUE_DT,@CTODATE )
		FROM #TMPCURRENTPERIOD_DET A
		JOIN
		(		
		SELECT t1.row_id , T1.REMARKS , T1.SRNO, T1.ISSUE_ID, T1.ISSUE_QTY,T1.PRODUCT_CODE, SUM(ISNULL(T2.REC_QUANTITY,0)) AS REC_QUANTITY
		FROM #TMPCURRENTPERIOD_DET T1
		INNER JOIN #TMPCURRENTPERIOD_DET T2 ON T1.ISSUE_ID=T2.ISSUE_ID AND T1.PRODUCT_CODE=T2.PRODUCT_CODE AND T1.REMARKS=T2.REMARKS AND   t1.row_id =t2.row_id and   T1.SRNO >= T2.SRNO
		GROUP BY t1.row_id ,T1.REMARKS ,T1.SRNO, T1.ISSUE_ID, T1.ISSUE_QTY,T1.PRODUCT_CODE
		) B ON A.ISSUE_ID =B.ISSUE_ID  AND A.PRODUCT_CODE=B.PRODUCT_CODE AND A.REMARKS=B.REMARKS  AND A.SRNO=B.SRNO
	    and a.row_id =b.row_id 
		
		
 --select * from #TMPCURRENTPERIOD_DET a
	--	  where  a.issue_id='HO01119HOI-000071'
 --         and PRODUCT_CODE ='B0076257'
 --         return

	  UPDATE A  SET AGEINGDAYS=DATEDIFF (DAY ,ISSUE_DT,@CTODATE )
	  FROM #TMPCURRENTPERIOD_DET A
	  JOIN
	  (
	  SELECT A.ISSUE_ID  ,A.PRODUCT_CODE,A.REMARKS
	  FROM #TMPCURRENTPERIOD_DET A
	  JOIN
	  (
	  SELECT ISSUE_ID,PRODUCT_CODE,REMARKS,MAX(SRNO) AS SR
	  FROM #TMPCURRENTPERIOD_DET 
	  GROUP BY ISSUE_ID,PRODUCT_CODE ,REMARKS
	  ) B ON A.ISSUE_ID =B.ISSUE_ID AND A.PRODUCT_CODE =B.PRODUCT_CODE AND A.REMARKS =B.REMARKS  AND A.SRNO=B.SR 
	  WHERE PERIOD_PENDING>0
	  ) UPD ON A.ISSUE_ID =UPD.ISSUE_ID AND A.PRODUCT_CODE =UPD.PRODUCT_CODE AND A.REMARKS =UPD.REMARKS
	 


		 
		 
	IF OBJECT_ID ('TEMPDB..#TMPPENDING','U') IS NOT NULL
	   DROP TABLE #TMPPENDING

	  SELECT ISSUE_ID,REMARKS, MAX(SRNO) AS SRNO,MIN(PERIOD_PENDING) AS PERIOD_PENDING
	  INTO #TMPPENDING
	  FROM #TMPCURRENTPERIOD_DET
	  GROUP BY ISSUE_ID,REMARKS



    IF @ZMODE=0
    BEGIN
	DELETE A FROM #TMPCURRENTPERIOD_DET A
	JOIN 
	(
	  SELECT ISSUE_ID,REMARKS, SRNO
	  FROM #TMPPENDING
	  WHERE PERIOD_PENDING=0
	) B ON A.ISSUE_ID=B.ISSUE_ID  AND A.REMARKS=B.REMARKS AND A.SRNO<=B.SRNO
	
   END

	 IF OBJECT_ID ('TEMPDB..#TMPCURRENTPERIOD_FINAL','U') IS NOT NULL
	     DROP TABLE #TMPCURRENTPERIOD_FINAL 	

	 SELECT   0 AS ROWCNT, SR=1, A.DEPT_ID,L.DEPT_NAME,A.JOB_CODE,JOB_NAME,A.AGENCY_CODE ,C.AGENCY_NAME,
		       ISSUE_NO=CAST('PENDING' AS VARCHAR(100)),
		       CONVERT(VARCHAR,A.ISSUE_DT,105) AS ISSUE_DT,
		       SUM(OPS_ISSUED ) AS JWI,
		       ISNULL(CAST(A.RECEIPT_NO AS VARCHAR(100)),'') AS RECEIPT_NO, 
		       CASE WHEN CONVERT(VARCHAR,A.RECEIPT_DT,105)='01-01-1900' THEN '' ELSE CONVERT(VARCHAR,A.RECEIPT_DT,105) END AS RECEIPT_DT,
		       SUM(OPS_RECEIVED  ) AS JWR,
		       PENDING_ISSUED=CAST(0 AS NUMERIC(18,3)),
		       PENDING_RECEIVED=CAST(0 AS NUMERIC(18,3)),
		       PENDING=SUM(OPS_PENDING ),
			   TOTAL_PENDING=SUM(OPS_PENDING ), 
		       AGEINGDAYS=0,
		       ''  AS PRODUCT_CODE
		       ,'' AS REMARKS
			   ,'' AS ISSUE_ID
			   ,0  AS SRNO
			   ,A.ISSUE_DT AS ISSUE_DT1
		INTO #TMPCURRENTPERIOD_FINAL
		FROM #TMPOPSPENDING_DET A
		JOIN LOCATION L (NOLOCK) ON L.DEPT_ID =A.DEPT_ID
		JOIN PRD_AGENCY_MST C (NOLOCK) ON C.AGENCY_CODE=A.AGENCY_CODE
        WHERE A.ISSUE_DT BETWEEN CASE WHEN @BTILL_DAYS=1 THEN '1900-01-01' ELSE  @CFROMDATE END AND @CTODATE

		GROUP BY A.DEPT_ID,L.DEPT_NAME,A.JOB_CODE,JOB_NAME, A.AGENCY_CODE ,C.AGENCY_NAME ,A.RECEIPT_NO ,A.RECEIPT_DT ,A.ISSUE_DT 
		
		UNION ALL

       SELECT  A.ROWCNT, SR=2, A.DEPT_ID,B.DEPT_NAME,A.JOB_CODE,JOB_NAME,A.AGENCY_CODE ,A.AGENCY_NAME,
		       A.ISSUE_NO,
		       CONVERT (VARCHAR,A.ISSUE_DT,105) AS ISSUE_DT,
		       A.[QUANTITY] AS JWI,
		       A.RECEIPT_NO,
		       CASE WHEN CONVERT(VARCHAR,A.RECEIPT_DT,105)='01-01-1900' THEN '' ELSE CONVERT(VARCHAR,A.RECEIPT_DT,105) END  AS RECEIPT_DT,
		       A.REC_QUANTITY AS JWR,
		       PENDING_ISSUED=CAST(A.[QUANTITY] AS NUMERIC(18,3)),
		       PENDING_RECEIVED=CAST(ISNULL(A.REC_QUANTITY,0) AS NUMERIC(18,3)),
		       PENDING=CAST(ISNULL(A.PERIOD_PENDING,0) AS NUMERIC(18,3)),
			   CASE WHEN DET.SRNO=A.SRNO  THEN CAST(ISNULL(A.PERIOD_PENDING,0) AS NUMERIC(18,3)) ELSE ISNULL(A.[QUANTITY],0)-ISNULL(A.REC_QUANTITY,0)  END AS TOTAL_PENDING,
		       AGEINGDAYS=A.AGEINGDAYS,
		       A.PRODUCT_CODE,
		       A.REMARKS,
			   A.ISSUE_ID,
			   A.SRNO
			   ,A.ISSUE_DT AS ISSUE_DT1
  FROM #TMPCURRENTPERIOD_DET A
  LEFT OUTER JOIN
  (
   SELECT ISSUE_ID,REMARKS,SRNO
	  FROM #TMPPENDING
  ) DET ON A.ISSUE_ID=DET.ISSUE_ID  AND A.REMARKS=DET.REMARKS 
  JOIN LOCATION (NOLOCK) B ON A.DEPT_ID=B.DEPT_ID
  JOIN JOBS  (NOLOCK) C ON A.JOB_CODE=C.JOB_CODE  
  --WHERE (@ZMODE=1 OR CAST(ISNULL(PERIOD_PENDING,0) AS NUMERIC(18,3))>=1)
  ORDER BY ISSUE_ID ,SRNO

  UPDATE A SET TOTAL_PENDING =0 FROM  #TMPCURRENTPERIOD_FINAL A
  JOIN
  (
  SELECT ISSUE_ID,MAX(SRNO) AS SRNO  FROM #TMPCURRENTPERIOD_FINAL
  GROUP BY ISSUE_ID
  ) B ON A.ISSUE_ID =B.ISSUE_ID AND A.SRNO<>B.SRNO 
 

  SELECT '' AS DEPT_ID,'' AS DEPT_NAME,'' AS AGENCY_CODE,'' AS AGENCY_NAME,'' AS JOB_CODE ,'' AS JOB_NAME,
	    0 AS OPS_JWI,
	    0 AS  OPS_JWR,
	    0 AS  OPS_PENDING, 
	    0 AS  PERJWI,
	    0 AS  PERJWR,
	    0 AS  PERPENDING, 
	    0 AS TOTAL_ISSUED,
	    0 AS TOTAL_RECEIPT,
	    0 AS TOTAL_PENDING,
	    0 AS UPTO_30,
	    0 AS UP_31_60,
	    0 AS ABOVE_91
   WHERE 1=2
  SELECT * 
  FROM #TMPCURRENTPERIOD_FINAL A ORDER BY  ISSUE_DT1
 -- WHERE AGEINGDAYS>0 
 -- ORDER BY 
  
  GOTO END_PROC
 END_PROC:
  
END
--******************************************** END OF PROCEDURE SP_JOBWORKPENDING_REPORT

