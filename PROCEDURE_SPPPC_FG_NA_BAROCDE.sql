CREATE PROCEDURE SPPPC_FG_NA_BAROCDE
(
 @NQUERYID INT=0,
 @CBILL_NO VARCHAR(50)='',
 @CARTICLE_CODE VARCHAR(10)='',
 @CMEMO_ID VARCHAR(50)='',
 @CAGENCY_CODE VARCHAR (10)=''
)
AS
BEGIN

       IF @NQUERYID IN(1,2)
	   BEGIN
		   IF OBJECT_ID('TEMPDB..#NADETAIL','U') IS NOT NULL
				DROP TABLE #NADETAIL
				      
			  SELECT DISTINCT DET.BILL_NO,SKU.ARTICLE_CODE,ART.ARTICLE_NO 
			  INTO #NADETAIL
			  FROM PPC_FGBCG_MST A
			  JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
			  JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
			  JOIN
			 (
				SELECT  B.AC_CODE,A.ARTICLE_CODE ,
				ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
				JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
				WHERE B.CANCELLED=0
				GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			  ) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
			  JOIN ARTICLE ART ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE
			  LEFT OUTER JOIN
			  (
			   SELECT PRODUCT_CODE 
			   FROM PPC_FG_BARCODE_NA_DET A
			   JOIN PPC_FG_BARCODE_NA_MST B ON A.MEMO_ID=B.MEMO_ID
			   WHERE B.CANCELLED=0
			  ) NA ON NA.PRODUCT_CODE=SKU.PRODUCT_CODE
			  WHERE SKU.PARA2_CODE='0000000  '
			  AND NA.PRODUCT_CODE IS NULL
			  AND A.CANCELLED=0
								 	   
		END
		
 IF @NQUERYID=1
    GOTO LBLBILL_NO
 ELSE IF @NQUERYID=2
    GOTO LBLARTICLE
 ELSE IF @NQUERYID=3
    GOTO LBLMST
 ELSE IF @NQUERYID=4
    GOTO LBLDET
 ELSE IF @NQUERYID=5
    GOTO LBLPARA2DET 
 ELSE IF @NQUERYID=6
    GOTO LBLBARCODEPRINT   
 ELSE IF @NQUERYID=7
    GOTO LBLBARCODEPRINT_CROSSTAB  
 ELSE IF @NQUERYID=8 
    GOTO LBLMSTQTY
  ELSE IF @NQUERYID=9 
    GOTO LBLMSTAGENCY
 
 ELSE
 GOTO END_PROC
   
  
    LBLBILL_NO:
      
      SELECT BILL_NO FROM #NADETAIL 
      GROUP BY BILL_NO
      ORDER BY BILL_NO
        
    GOTO END_PROC
    
    LBLARTICLE:
      
      SELECT DISTINCT ARTICLE_NO ,ARTICLE_CODE 
      FROM #NADETAIL
      WHERE (@CBILL_NO='' OR BILL_NO =@CBILL_NO)
      ORDER BY ARTICLE_NO
    
    GOTO END_PROC
    
    LBLMST:
       
       SELECT A.MEMO_ID,A.MEMO_NO,MEMO_DT=CONVERT(VARCHAR(10),A.MEMO_DT,105),LAST_UPDATE=CONVERT(VARCHAR(10),A.LAST_UPDATE,105),
              A.BILL_NO,A.FIN_YEAR,A.CANCELLED,A.MEMO_DT AS DT,
              ISNULL(LM.AC_CODE,'') AS AC_CODE ,ISNULL(LM.AC_NAME ,'') AS AC_NAME
       FROM  PPC_FG_BARCODE_NA_MST A
       LEFT OUTER JOIN LM01106 LM (NOLOCK) ON A.AC_CODE =LM.AC_CODE 
       WHERE (@CBILL_NO ='' OR A.BILL_NO =@CBILL_NO )
       AND (@CMEMO_ID ='' OR A.MEMO_ID =@CMEMO_ID )
       AND (@CAGENCY_CODE='' OR LM.AC_CODE =@CAGENCY_CODE)
       ORDER BY A.MEMO_DT DESC,A.MEMO_ID DESC
       --WHERE A.MEMO_ID=@CMEMO_ID 
       
       
       
    GOTO END_PROC
    
    LBLDET:
       
       
        IF OBJECT_ID('TEMPDB..#TMPPRODUCT','U') IS NOT NULL
				DROP TABLE #TMPPRODUCT
				      
			SELECT FGMST.AC_CODE,LM.AC_NAME,DET.BILL_NO,
				B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,
				B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				B.PARA1_CODE,P1.PARA1_NAME,
				B.PARA2_CODE,P2.PARA2_NAME,
				B.PARA3_CODE,P3.PARA3_NAME ,
				B.PRODUCT_CODE,
				1 AS QUANTITY,
				DET.ROW_ID AS BO_ROW_ID,
				MST.AC_CODE AS AGENCY_CODE
				INTO #TMPPRODUCT
			FROM PPC_AGENCY_ISSUE_FG_FIRST_DET A
			JOIN PPC_FG_SKU B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
			JOIN PPC_FGBCG_DET C ON B.PPC_FGBCG_DET_ROW_ID=C.ROW_ID 
			JOIN PPC_FGBCG_MST FGMST ON FGMST .MEMO_ID =C.MEMO_ID 
			JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST MST ON MST.MEMO_ID =A.MEMO_ID 
		    JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_CODE 
			JOIN PARA1 P1 ON P1.PARA1_CODE =B.PARA1_CODE 
			JOIN PARA2 P2 ON P2.PARA2_CODE =B.PARA2_CODE 
			JOIN PARA3 P3 ON P3.PARA3_CODE =B.PARA3_CODE 
			JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =B.SIZEGROUP_CODE 
			JOIN LM01106 LM ON LM.AC_CODE =FGMST.AC_CODE 
			JOIN
			(
				SELECT  B.AC_CODE,A.ARTICLE_CODE ,
				ROW_ID,B.BILL_NO 
				FROM PPC_BUYER_ORDER_DET A
				JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
				WHERE B.CANCELLED=0
				GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			) DET ON DET.ROW_ID=C.BO_DET_ROW_ID 
			LEFT OUTER JOIN
			(
				 SELECT PRODUCT_CODE 
				 FROM PPC_FG_BARCODE_NA_DET A
				 JOIN PPC_FG_BARCODE_NA_MST B ON A.MEMO_ID=B.MEMO_ID
				 WHERE B.CANCELLED=0
			 ) NA ON NA.PRODUCT_CODE=B.PRODUCT_CODE
			WHERE FGMST.CANCELLED=0 AND MST.CANCELLED =0
			AND B.PARA2_CODE='0000000  '
			AND NA.PRODUCT_CODE IS NULL
			AND (@CARTICLE_CODE ='' OR DET.ARTICLE_CODE =@CARTICLE_CODE )
			--AND B.PARA2_CODE='0000000  '
		    AND (@CAGENCY_CODE='' OR MST.AC_CODE =@CAGENCY_CODE)
		    AND (@CBILL_NO ='' OR DET.BILL_NO =@CBILL_NO )
			
			--FROM PPC_FGBCG_MST A
			--JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
			--JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
			--JOIN
			--(
			--  SELECT  B.AC_CODE,A.ARTICLE_CODE ,
			--	ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
			--	JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
			--	WHERE B.CANCELLED=0
			--  GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			--) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
			--JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
			--JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
			--JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE 
			--JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
			--JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
			--JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
			--LEFT OUTER JOIN
			--(
			--	SELECT PRODUCT_CODE,A.QUANTITY
			--	FROM PPC_FG_BARCODE_NA_DET  A
			--	JOIN PPC_FG_BARCODE_NA_MST B ON A.MEMO_ID =B.MEMO_ID 
			--	WHERE B.CANCELLED=0
			--) NA ON NA.PRODUCT_CODE =SKU.PRODUCT_CODE
			--WHERE NA.PRODUCT_CODE IS NULL
			--AND (@CBILL_NO ='' OR DET.BILL_NO =@CBILL_NO )
			--AND (@CARTICLE_CODE ='' OR DET.ARTICLE_CODE =@CARTICLE_CODE )
			--AND SKU.PARA2_CODE='0000000  '
		
		
	
        SELECT CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
        ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
        A.AC_CODE,
        A.AC_NAME,
        A.BILL_NO,
        A.ARTICLE_CODE,
        A.ARTICLE_NO,
		A.PARA1_CODE,
		A.PARA1_NAME,
		A.SIZEGROUP_CODE,
		A.SIZEGROUP_NAME,
		A.PARA3_CODE,
		A.PARA3_NAME,
		PARA2_CODE,
		PARA2_NAME,
		BO_ROW_ID,
		SUM(A.QUANTITY) AS QUANTITY
		FROM #TMPPRODUCT A 
		GROUP BY  A.AC_CODE,A.AC_NAME,A.BILL_NO,
		A.PARA1_CODE,A.PARA1_NAME,A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,
		A.PARA3_CODE,A.PARA3_NAME, A.ARTICLE_CODE,
        A.ARTICLE_NO,PARA2_CODE,
		PARA2_NAME,BO_ROW_ID
		
    GOTO END_PROC
   
   LBLPARA2DET:
        
          IF OBJECT_ID('TEMPDB..#TMPPARA2','U') IS NOT NULL
				DROP TABLE #TMPPARA2
				
			
			
			SELECT LM.AC_CODE,LM.AC_NAME,DET.BILL_NO,
				B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,
				SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				SKU.PARA1_CODE,P1.PARA1_NAME,
				SP.PARA2_CODE,P2.PARA2_NAME,
				SKU.PARA3_CODE,P3.PARA3_NAME ,
				SKU.PRODUCT_CODE,
				1 AS QUANTITY,
				DET.ROW_ID AS BO_ROW_ID
				INTO #TMPPARA2
			FROM PPC_FGBCG_MST A
			JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
			JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
			JOIN
			(
			  SELECT  B.AC_CODE,A.ARTICLE_CODE ,
				ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
				JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
				WHERE B.CANCELLED=0
			  GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
			JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
			JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
			JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
			JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
			JOIN PPC_SIZEGROUP_PARA2 SP ON SP.SIZEGROUP_CODE =SG.SIZEGROUP_CODE
			JOIN PARA2 P2 ON P2.PARA2_CODE =SP.PARA2_CODE 
			JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
			LEFT OUTER JOIN
			(
				SELECT PRODUCT_CODE,A.QUANTITY
				FROM PPC_FG_BARCODE_NA_DET  A
				JOIN PPC_FG_BARCODE_NA_MST B ON A.MEMO_ID =B.MEMO_ID 
				WHERE B.CANCELLED=0
			) NA ON NA.PRODUCT_CODE =SKU.PRODUCT_CODE
			WHERE NA.PRODUCT_CODE IS NULL
			AND (@CBILL_NO ='' OR DET.BILL_NO =@CBILL_NO )
			AND (@CARTICLE_CODE ='' OR DET.ARTICLE_CODE =@CARTICLE_CODE )
			AND SKU.PARA2_CODE ='0000000  '
			AND SP.PARA2_CODE <>'0000000  '
				      
			--SELECT FGMST.AC_CODE,LM.AC_NAME,DET.BILL_NO,
			--	B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,
			--	B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
			--	B.PARA1_CODE,P1.PARA1_NAME,
			--	P2.PARA2_CODE,P2.PARA2_NAME,
			--	B.PARA3_CODE,P3.PARA3_NAME ,
			--	B.PRODUCT_CODE,
			--	1 AS QUANTITY,
			--	DET.ROW_ID AS BO_ROW_ID
			--	INTO #TMPPARA2
			--FROM PPC_AGENCY_ISSUE_FG_FIRST_DET A
			--JOIN PPC_FG_SKU B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
			--JOIN PPC_FGBCG_DET C ON B.PPC_FGBCG_DET_ROW_ID=C.ROW_ID 
			--JOIN PPC_FGBCG_MST FGMST ON FGMST .MEMO_ID =C.MEMO_ID 
			--JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST MST ON MST.MEMO_ID =A.MEMO_ID 
		 --   JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_CODE 
			--JOIN PARA1 P1 ON P1.PARA1_CODE =B.PARA1_CODE 
			--JOIN PARA2 P2 ON P2.PARA2_CODE =B.PARA2_CODE 
			--JOIN PARA3 P3 ON P3.PARA3_CODE =B.PARA3_CODE 
			--JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =B.SIZEGROUP_CODE 
			--JOIN LM01106 LM ON LM.AC_CODE =FGMST.AC_CODE 
			--JOIN
			--(
			--	SELECT  B.AC_CODE,A.ARTICLE_CODE ,
			--	ROW_ID,B.BILL_NO 
			--	FROM PPC_BUYER_ORDER_DET A
			--	JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
			--	WHERE B.CANCELLED=0
			--	GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			--) DET ON DET.ROW_ID=C.BO_DET_ROW_ID 
			--LEFT OUTER JOIN
			--(
			--	 SELECT PRODUCT_CODE 
			--	 FROM PPC_FG_BARCODE_NA_DET A
			--	 JOIN PPC_FG_BARCODE_NA_MST B ON A.MEMO_ID=B.MEMO_ID
			--	 WHERE B.CANCELLED=0
			-- ) NA ON NA.PRODUCT_CODE=B.PRODUCT_CODE
			--WHERE FGMST.CANCELLED=0 AND MST.CANCELLED =0
			--AND B.PARA2_CODE<>'0000000  '
			--AND NA.PRODUCT_CODE IS NULL
			--AND (@CARTICLE_CODE ='' OR DET.ARTICLE_CODE =@CARTICLE_CODE )
			----AND B.PARA2_CODE='0000000  '
		 --   AND (@CAGENCY_CODE='' OR MST.AC_CODE =@CAGENCY_CODE)
		 --   AND (@CBILL_NO ='' OR DET.BILL_NO =@CBILL_NO )
			
			--FROM PPC_FGBCG_MST A
			--JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
			--JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
			--JOIN
			--(
			--  SELECT  B.AC_CODE,A.ARTICLE_CODE ,
			--	ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
			--	JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
			--	WHERE B.CANCELLED=0
			--  GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			--) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
			--JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
			--JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
			--JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
			--JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
			--JOIN PPC_SIZEGROUP_PARA2 SP ON SP.SIZEGROUP_CODE =SG.SIZEGROUP_CODE
			--JOIN PARA2 P2 ON P2.PARA2_CODE =SP.PARA2_CODE 
			--JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
			--LEFT OUTER JOIN
			--(
			--	SELECT PRODUCT_CODE,A.QUANTITY
			--	FROM PPC_FG_BARCODE_NA_DET  A
			--	JOIN PPC_FG_BARCODE_NA_MST B ON A.MEMO_ID =B.MEMO_ID 
			--	WHERE B.CANCELLED=0
			--) NA ON NA.PRODUCT_CODE =SKU.PRODUCT_CODE
			--WHERE NA.PRODUCT_CODE IS NULL
			--AND (@CBILL_NO ='' OR DET.BILL_NO =@CBILL_NO )
			--AND (@CARTICLE_CODE ='' OR DET.ARTICLE_CODE =@CARTICLE_CODE )
			--AND SKU.PARA2_CODE ='0000000  '
			--AND SP.PARA2_CODE <>'0000000  '
		
      
        SELECT CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
        ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
        A.AC_CODE,
        A.AC_NAME,
        A.BILL_NO,
        A.ARTICLE_CODE,
        A.ARTICLE_NO,
		A.PARA1_CODE,
		A.PARA1_NAME,
		A.SIZEGROUP_CODE,
		A.SIZEGROUP_NAME,
		A.PARA3_CODE,
		A.PARA3_NAME,
        PARA2_CODE,PARA2_NAME,
        CAST(0 AS NUMERIC(10,0)) AS QUANTITY,
        BO_ROW_ID
        FROM #TMPPARA2 A
        GROUP BY PARA2_CODE,PARA2_NAME,A.AC_CODE,
        A.AC_NAME,A.BILL_NO, A.ARTICLE_CODE,
        A.ARTICLE_NO,A.PARA1_CODE,A.PARA1_NAME,
		A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,A.PARA3_CODE,
		A.PARA3_NAME,PARA2_CODE,PARA2_NAME,BO_ROW_ID

   
   GOTO END_PROC
   
   
   LBLBARCODEPRINT:
        
        SELECT CAST(1 AS BIT) AS CHK, PR.MEMO_ID,PR.MEMO_NO,PR.MEMO_DT,
               A.AC_CODE,LM.AC_NAME ,
               DET.BILL_NO,
               DET.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,
               B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
               B.PARA1_CODE,P1.PARA1_NAME AS COLOR,
               B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,
               SKU.PARA2_CODE,P2.PARA2_NAME SIZE,
               PR.PRODUCT_CODE,
               PR.QUANTITY
		    FROM PPC_FGBCG_MST A
			JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
			JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
			JOIN
			(
			  SELECT  B.AC_CODE,A.ARTICLE_CODE ,
				ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
				JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
				WHERE B.CANCELLED=0
			  GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
			JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
			JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
			JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
			JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
			JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
			JOIN
			(
				SELECT A.PARA2_CODE,
				B.MEMO_ID,B.MEMO_NO,B.MEMO_DT, PRODUCT_CODE,QUANTITY AS QUANTITY
				FROM PPC_FG_BARCODE_NA_DET  A
				JOIN PPC_FG_BARCODE_NA_MST B ON A.MEMO_ID =B.MEMO_ID 
				WHERE  A.MEMO_ID=@CMEMO_ID
			) PR ON PR.PRODUCT_CODE =SKU.PRODUCT_CODE	
		    JOIN PARA2 P2 ON P2.PARA2_CODE =PR.PARA2_CODE 
    
    GOTO END_PROC
    
    LBLBARCODEPRINT_CROSSTAB:
        

        IF OBJECT_ID ('TEMPDB..#TMPALLOTEDPRINT','P') IS NOT NULL
           DROP TABLE #TMPALLOTEDPRINT
           
	
				      
			SELECT PR.MEMO_ID,PR.ROW_ID,A.AC_CODE,LM.AC_NAME,DET.BILL_NO,
				B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,
				SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,
				SKU.PARA1_CODE,P1.PARA1_NAME,
				P2.PARA2_CODE,P2.PARA2_NAME,
				SKU.PARA3_CODE,P3.PARA3_NAME ,
				SKU.PRODUCT_CODE,
				ISNULL(PR.QUANTITY,0) AS QUANTITY,
				B.ROW_ID AS BO_ROW_ID
				INTO #TMPALLOTEDPRINT
			FROM PPC_FGBCG_MST A
			JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
			JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
			JOIN
			(
			  SELECT  B.AC_CODE,A.ARTICLE_CODE ,
				ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A
				JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
				WHERE B.CANCELLED=0
			  GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			) DET ON DET.ROW_ID=B.BO_DET_ROW_ID 
			JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
			JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE 
			JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE 
			JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE 
			JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
			LEFT  JOIN
			(
				SELECT A.PARA2_CODE, A.MEMO_ID,A.ROW_ID, PRODUCT_CODE,A.QUANTITY
				FROM PPC_FG_BARCODE_NA_DET  A
				JOIN PPC_FG_BARCODE_NA_MST B ON A.MEMO_ID =B.MEMO_ID 
				WHERE B.CANCELLED=0
				AND A.MEMO_ID=@CMEMO_ID
			) PR ON PR.PRODUCT_CODE =SKU.PRODUCT_CODE
			JOIN PARA2 P2 ON P2.PARA2_CODE =PR.PARA2_CODE 
			

			
			SELECT 
				A.AC_CODE,
				A.AC_NAME,
				A.BILL_NO,
				A.ARTICLE_CODE,
				A.ARTICLE_NO,
				A.PARA1_CODE,
				A.PARA1_NAME,
				A.SIZEGROUP_CODE,
				A.SIZEGROUP_NAME,
				A.PARA3_CODE,
				A.PARA3_NAME,
                CAST(SUM(ISNULL(QUANTITY,0)) AS NUMERIC(10,0)) AS QUANTITY,
                BO_ROW_ID
				FROM #TMPALLOTEDPRINT A 
				GROUP BY A.AC_CODE,A.AC_NAME,A.BILL_NO,
				A.PARA1_CODE,A.PARA1_NAME,A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,
				A.PARA3_CODE,A.PARA3_NAME, A.ARTICLE_CODE,
				A.ARTICLE_NO,BO_ROW_ID
				
				
				
		SELECT CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,
        ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),
        A.AC_CODE,A.AC_NAME,A.BILL_NO,A.ARTICLE_CODE,
		A.ARTICLE_NO,A.PARA1_CODE,
		A.PARA1_NAME,A.SIZEGROUP_CODE,
		A.SIZEGROUP_NAME,A.PARA3_CODE,A.PARA3_NAME,
        PARA2_CODE,PARA2_NAME,
        CAST(SUM(ISNULL(QUANTITY,0)) AS NUMERIC(10,0)) AS QUANTITY,
        BO_ROW_ID
        FROM #TMPALLOTEDPRINT A
        --WHERE (@CARTICLE_CODE ='' OR ARTICLE_CODE=@CARTICLE_CODE)
        --AND (@CPARA1_CODE ='' OR PARA1_CODE=@CPARA1_CODE)
        --AND (@CSIZEGROUP_CODE ='' OR SIZEGROUP_CODE=@CSIZEGROUP_CODE)
        GROUP BY PARA2_CODE,PARA2_NAME,A.AC_CODE,A.AC_NAME,A.BILL_NO,A.ARTICLE_CODE,
		A.ARTICLE_NO,A.PARA1_CODE,
		A.PARA1_NAME,A.SIZEGROUP_CODE,
		A.SIZEGROUP_NAME,A.PARA3_CODE,A.PARA3_NAME,BO_ROW_ID
    
     GOTO END_PROC
     
     LBLMSTQTY:
       
       SELECT A.MEMO_ID,A.MEMO_NO,MEMO_DT=CONVERT(VARCHAR(10),A.MEMO_DT,105),LAST_UPDATE=CONVERT(VARCHAR(10),A.LAST_UPDATE,105),
              A.BILL_NO,A.FIN_YEAR,A.CANCELLED,SUM(ID.QUANTITY) AS TOTAL_QTY
       FROM  PPC_FG_BARCODE_NA_MST A
       JOIN PPC_FG_BARCODE_NA_DET B ON A.MEMO_ID=A.MEMO_ID
       JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET ID ON ID.PRODUCT_CODE=B.PRODUCT_CODE
       WHERE (@CBILL_NO ='' OR A.BILL_NO =@CBILL_NO )
       AND (@CMEMO_ID ='' OR A.MEMO_ID =@CMEMO_ID )
       GROUP BY  A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.LAST_UPDATE, A.BILL_NO,A.FIN_YEAR,A.CANCELLED
       --WHERE A.MEMO_ID=@CMEMO_ID 
       
    GOTO END_PROC
    
    LBLMSTAGENCY:
    
      
			SELECT DISTINCT  MST.AC_CODE AS AGENCY_CODE,
			       LM.AC_NAME AS AGENCY_NAME
			FROM PPC_AGENCY_ISSUE_FG_FIRST_DET A
			JOIN PPC_FG_SKU B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
			JOIN PPC_FGBCG_DET C ON B.PPC_FGBCG_DET_ROW_ID=C.ROW_ID 
			JOIN PPC_FGBCG_MST FGMST ON FGMST .MEMO_ID =C.MEMO_ID 
			JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST MST ON MST.MEMO_ID =A.MEMO_ID 
			JOIN LM01106 LM ON LM.AC_CODE =MST.AC_CODE 
			JOIN
			(
				SELECT  B.AC_CODE,A.ARTICLE_CODE ,
				ROW_ID,B.BILL_NO 
				FROM PPC_BUYER_ORDER_DET A
				JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
				WHERE B.CANCELLED=0
				GROUP BY B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO
			) DET ON DET.ROW_ID=C.BO_DET_ROW_ID 
			WHERE FGMST.CANCELLED=0 AND MST.CANCELLED =0
			AND B.PARA2_CODE='0000000  '
            AND (@CBILL_NO ='' OR DET.BILL_NO =@CBILL_NO )
			
    
    
    GOTO END_PROC
    
 END_PROC:


END
