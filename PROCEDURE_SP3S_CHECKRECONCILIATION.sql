CREATE PROCEDURE SP3S_CHECKRECONCILIATION
(
	@CXNTYPE	VARCHAR(50),
	@CXN_ID		VARCHAR(50)
)
AS
BEGIN
	IF(@CXNTYPE='PUR')
	BEGIN
		SELECT TOP 1 A.RECON_ID
		FROM XNRECONM A
		JOIN XNRECONP B ON B.RECON_ID=A.RECON_ID
		JOIN XNRECONMEMO T1 ON T1.RECON_ID=A.RECON_ID
		JOIN
		(
			SELECT T1.MRR_ID,SUM(T2.QUANTITY) AS CHALLAN_QUANTITY
			FROM PIM01106 T1 
			JOIN PID01106 T2 ON T1.MRR_ID = T2.MRR_ID 
			WHERE T2.PRODUCT_CODE<>'' AND  T1.MRR_ID=@CXN_ID
			GROUP BY T1.MRR_ID
			
			UNION
			SELECT T1.MRR_ID,SUM(T2.QUANTITY) AS CHALLAN_QUANTITY
			FROM PIM01106 T1 
			JOIN PID01106 T2 ON T1.MRR_ID = T2.MRR_ID 
			WHERE T2.PRODUCT_CODE<>'' AND  T1.INV_ID=@CXN_ID
			GROUP BY T1.MRR_ID
						
		) M ON T1.XN_ID = M.MRR_ID  
		WHERE A.XN_TYPE='PUR'
		AND ISNULL(A.reconciled,0)=1
	END
	ELSE IF(@CXNTYPE='WSR')
	BEGIN
		SELECT TOP 1 A.RECON_ID
		FROM XNRECONM A
		JOIN XNRECONP B ON B.RECON_ID=A.RECON_ID
		JOIN XNRECONMEMO T1 ON T1.RECON_ID=A.RECON_ID
		JOIN
		(
			SELECT T1.CN_ID,SUM(T2.QUANTITY) AS CHALLAN_QUANTITY
			FROM CNM01106 T1 
			JOIN CND01106 T2 ON T1.CN_ID = T2.CN_ID 
			WHERE T2.PRODUCT_CODE<>'' AND  T1.CN_ID=@CXN_ID
			GROUP BY T1.CN_ID
			
			UNION
			SELECT T1.CN_ID,SUM(T2.QUANTITY) AS CHALLAN_QUANTITY
			FROM CNM01106 T1 
			JOIN CND01106 T2 ON T1.CN_ID = T2.CN_ID 
			WHERE T2.PRODUCT_CODE<>'' AND  T1.RM_ID=@CXN_ID
			GROUP BY T1.CN_ID
						
		) M ON T1.XN_ID = M.CN_ID  
		WHERE A.XN_TYPE='WSR'
		AND ISNULL(A.reconciled,0)=1
	END
	
	
	ELSE IF(@CXNTYPE='DCO')
	BEGIN
		SELECT TOP 1 A.RECON_ID
		FROM XNRECONM A
		JOIN XNRECONP B ON B.RECON_ID=A.RECON_ID
		JOIN XNRECONMEMO T1 ON T1.RECON_ID=A.RECON_ID
		JOIN
		(
			SELECT T1.MEMO_ID,SUM(T2.QUANTITY) AS CHALLAN_QUANTITY
			FROM FLOOR_ST_MST T1 
			JOIN FLOOR_ST_DET T2 ON T1.MEMO_ID  = T2.MEMO_ID 
			WHERE T2.PRODUCT_CODE<>'' AND  T1.MEMO_ID=@CXN_ID
			GROUP BY T1.MEMO_ID
		) M ON T1.XN_ID = M.MEMO_ID  
		WHERE A.XN_TYPE='DCO' AND M.MEMO_ID = @CXN_ID
		AND ISNULL(A.reconciled,0)=1
	END
	
	
END
