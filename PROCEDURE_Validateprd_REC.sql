CREATE PROCEDURE VALIDATEPRD_REC      
 @CXNID VARCHAR(50),       
 @NUPDATEMODE INT,    
 @CUSERCODE CHAR(7),    
 @CERRORMSG VARCHAR(200) OUTPUT      
-- -- WITH ENCRYPTION    
       
AS      
BEGIN      
--RETURN    
     
 DECLARE @CMEMO_ID VARCHAR(100),@NREC_QTY NUMERIC(12,2),@NREQ_QTY NUMERIC(12,2),  
         @CCOMPONENT VARCHAR(100),@RM VARCHAR(100),@ORDER_ID VARCHAR(100)    
      
        
 SELECT TOP 1 @ORDER_ID=B.ORDER_ID, @CCOMPONENT=AR.ARTICLE_NO , @RM=AR1 .ARTICLE_NO , @CMEMO_ID = A.MEMO_ID,@NREQ_QTY= (A.REC_QTY*B.AVG_QTY) ,    
 @NREC_QTY=B.QUANTITY  
 FROM PRD_AGENCY_ROW_MATERIAL_RECEIPT_DET A    
 JOIN    
 (    
     
   SELECT A.REF_MATERIAL_ROW_ID ,A.ORDER_ID,A.COMPONENT_CODE, A.ARTICLE_CODE , A.AVG_QTY, A.MEMO_ID, A.COM_PARA1_CODE ,A.COM_PARA2_CODE,    
         SUM (A.QUANTITY) AS QUANTITY    
   FROM   
    (  
  SELECT A.REF_MATERIAL_ROW_ID ,  B.REF_PRD_WORKORDER_MEMOID AS ORDER_ID, COMPONENT_CODE,C.ARTICLE_CODE , B.AVG_QTY, A.MEMO_ID, C.COM_PARA1_CODE ,C.COM_PARA2_CODE,    
         SUM (A.QUANTITY) AS QUANTITY    
  FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A    
  JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B ON A.REF_ROW_ID=B.ROW_ID     
  JOIN PRD_SKU C ON A.XN_PRODUCT_UID=C.PRODUCT_UID    
  WHERE A.MEMO_ID=@CXNID    
  GROUP BY  A.REF_MATERIAL_ROW_ID ,B.REF_PRD_WORKORDER_MEMOID ,COMPONENT_CODE,C.ARTICLE_CODE , B.AVG_QTY, A.MEMO_ID, C.COM_PARA1_CODE ,C.COM_PARA2_CODE  
  UNION ALL    
  SELECT A.REF_MATERIAL_ROW_ID ,B.REF_PRD_WORKORDER_MEMOID AS ORDER_ID,COMPONENT_CODE, C.ARTICLE_CODE , B.AVG_QTY, A.MEMO_ID, C.COM_PARA1_CODE ,C.COM_PARA2_CODE,    
         SUM (A.QUANTITY) AS QUANTITY    
  FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A    
  JOIN PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING B ON A.REF_ROW_ID=B.ROW_ID     
  JOIN PRD_SKU C ON A.XN_PRODUCT_UID=C.PRODUCT_UID    
  WHERE A.MEMO_ID=@CXNID   
  GROUP BY A.REF_MATERIAL_ROW_ID ,B.REF_PRD_WORKORDER_MEMOID,COMPONENT_CODE, C.ARTICLE_CODE , B.AVG_QTY, A.MEMO_ID, C.COM_PARA1_CODE ,C.COM_PARA2_CODE   
   ) A   
   GROUP BY A.REF_MATERIAL_ROW_ID , A.ORDER_ID,A.COMPONENT_CODE,A.ARTICLE_CODE , A.AVG_QTY, A.MEMO_ID, A.COM_PARA1_CODE ,A.COM_PARA2_CODE  
 ) B ON A.MEMO_ID=B.MEMO_ID  AND A.ROW_ID =B.REF_MATERIAL_ROW_ID  
 AND A.PARA1_CODE=B.COM_PARA1_CODE    
 AND A.PARA2_CODE=B.COM_PARA2_CODE  
 JOIN ARTICLE AR ON AR.ARTICLE_CODE =B.COMPONENT_CODE     
 JOIN ARTICLE AR1 ON AR1.ARTICLE_CODE =B.ARTICLE_CODE   
    WHERE   
    B.QUANTITY>(A.REC_QTY*B.AVG_QTY)  AND  
     A.MEMO_ID=@CXNID    
       
     
      
    IF ISNULL(@NREC_QTY,0)>ISNULL(@NREQ_QTY ,0)    
   BEGIN    
        SET @CERRORMSG='ORDER- '+RIGHT(@ORDER_ID,10)+' ,COMPONENT- '+@CCOMPONENT+' ,RM- '+@RM+', REC QTY MUST BE LESS THEN OR EQUAL TO REQ QTY.....PLEASE CHECK MEMO_ID- '     
   RETURN      
   END    
       
     
END_PROC:      
END 
--*************************************** END OF PROCEDURE VALIDATEPRD_REC
