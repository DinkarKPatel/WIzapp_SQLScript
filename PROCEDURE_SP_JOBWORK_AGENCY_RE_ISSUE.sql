CREATE PROCEDURE SP_JOBWORK_AGENCY_RE_ISSUE
(
 @NQUERTID INT,
 @DFM_DT DATETIME,
 @DTODT DATETIME,
 @CAGENCY_CODE VARCHAR(100)='',
 @CMEMO_ID VARCHAR(100)='',
 @CWHERE VARCHAR(MAX)=''
)
AS
BEGIN
     DECLARE @CCMD NVARCHAR(MAX)
IF @NQUERTID=1
GOTO LBLMASTER
ELSE 
IF @NQUERTID=2
GOTO LBLDETAILS
ELSE
IF @NQUERTID=3
GOTO LBLSUBDETAILS
ELSE
IF @NQUERTID=4
GOTO LBLAPPLU


LBLMASTER:
 
	 SELECT A.*,B.AGENCY_NAME AS AGENCY_NAME 
	 FROM PRD_JOBWORK_RE_ISSUE_MST A
	 JOIN PRD_AGENCY_MST B ON A.AGENCY_CODE=B.AGENCY_CODE
	 WHERE A.ISSUE_ID=@CMEMO_ID
 
GOTO END_PROC

LBLDETAILS:
    
    IF OBJECT_ID('TEMPDB..#TMPRE_ISSUE','U') IS NOT NULL
       DROP TABLE #TMPRE_ISSUE
       
	SELECT A.RECEIPT_NO,A.RECEIPT_DT,A.RECEIPT_ID,B.PRODUCT_UID,B.QUANTITY,ISNULL(C.QUANTITY ,0) AS RE_ISSUE_QTY
	INTO #TMPRE_ISSUE
	FROM PRD_JOBWORK_RECEIPT_MST A
	JOIN PRD_JOBWORK_RECEIPT_DET B ON A.RECEIPT_ID=B.RECEIPT_ID
	LEFT OUTER JOIN
	(
	 SELECT REF_REC_ID,PRODUCT_UID,SUM(QUANTITY) AS  QUANTITY
	 FROM PRD_JOBWORK_RE_ISSUE_MST A
	 JOIN PRD_JOBWORK_RE_ISSUE_DET B ON A.ISSUE_ID=B.ISSUE_ID
	 WHERE A.CANCELLED=0 
	 GROUP BY REF_REC_ID,PRODUCT_UID
	) C ON A.RECEIPT_ID=C.REF_REC_ID AND B.PRODUCT_UID=C.PRODUCT_UID
	WHERE A.CANCELLED=0 AND A.AGENCY_CODE=@CAGENCY_CODE 
	AND A.RECEIPT_DT BETWEEN @DFM_DT AND @DTODT
    AND B.QUANTITY-ISNULL(C.QUANTITY ,0)>0
    
    
    SELECT CAST(0  AS INT) AS CHK, A.RECEIPT_NO,A.RECEIPT_DT,A.RECEIPT_ID
    FROM #TMPRE_ISSUE A
    GROUP BY  A.RECEIPT_NO,A.RECEIPT_DT,A.RECEIPT_ID
    ORDER BY A.RECEIPT_NO,A.RECEIPT_DT,A.RECEIPT_ID
    
    
    
GOTO END_PROC

LBLSUBDETAILS:
     
     IF @CMEMO_ID=''
     BEGIN
	 SELECT CAST(0 AS BIT) AS CHK,
			C.PRODUCT_UID AS PRODUCT_UID,
			C.QUANTITY AS REC_QTY,
			ISNULL(R.QUANTITY,0) AS RE_ISSUED_QTY,
			C.QUANTITY-ISNULL(R.QUANTITY,0) AS QUANTITY,
			ROW_ID=CAST('LATER'+CAST(NEWID() AS VARCHAR(100)) AS VARCHAR(40)),
			GETDATE()  AS LAST_UPDATE,
			CAST('LATER' AS VARCHAR(100)) AS ISSUE_ID,
			SKU.PRODUCT_CODE,
			C.RECEIPT_ID AS REF_REC_ID,
			C.RECEIPT_ID AS RECEIPT_ID,
			D.JOB_CODE AS JOB_CODE,
			JOBS.JOB_NAME
	 FROM PRD_JOBWORK_RECEIPT_DET C 
	 JOIN PRD_JOBWORK_ISSUE_DET D ON C.REF_ROW_ID=D.ROW_ID 
	 JOIN PRD_JOBWORK_ISSUE_MST E ON E.ISSUE_ID=D.ISSUE_ID
	 JOIN PRD_JOBWORK_RECEIPT_MST F ON C.RECEIPT_ID=F.RECEIPT_ID 
	 LEFT OUTER JOIN
	 (
	  SELECT REF_REC_ID,PRODUCT_UID,SUM(QUANTITY) AS  QUANTITY
	  FROM PRD_JOBWORK_RE_ISSUE_MST A
	  JOIN PRD_JOBWORK_RE_ISSUE_DET B ON A.ISSUE_ID=B.ISSUE_ID
	  WHERE A.CANCELLED=0
	  GROUP BY REF_REC_ID,PRODUCT_UID
	 ) R ON C.RECEIPT_ID=R.REF_REC_ID AND C.PRODUCT_UID=R.PRODUCT_UID
	 JOIN PRD_SKU SKU ON SKU.PRODUCT_UID=C.PRODUCT_UID
	 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SKU.ARTICLE_CODE
	 LEFT OUTER JOIN JOBS ON JOBS.JOB_CODE=D.JOB_CODE
	 WHERE E.CANCELLED=0 AND F.CANCELLED=0
	 AND C.QUANTITY-ISNULL(R.QUANTITY,0)>0
	  AND F.AGENCY_CODE=@CAGENCY_CODE 
	  AND F.CANCELLED=0 AND E.CANCELLED=0
	  AND F.RECEIPT_DT BETWEEN @DFM_DT AND @DTODT
	END
	ELSE
	BEGIN
	

	  SELECT CAST(0 AS BIT) AS CHK,
			B.PRODUCT_UID AS PRODUCT_UID,
			B.QUANTITY AS REC_QTY,
			B.QUANTITY AS RE_ISSUED_QTY,
			B.QUANTITY AS QUANTITY,
			ROW_ID,
			A.LAST_UPDATE,
			A.ISSUE_ID,
			B.PRODUCT_CODE,
			B.REF_REC_ID AS REF_REC_ID,
			B.REF_REC_ID AS RECEIPT_ID,
			B.JOB_CODE AS JOB_CODE,
			JOBS.JOB_NAME
	  FROM PRD_JOBWORK_RE_ISSUE_MST A
	  JOIN PRD_JOBWORK_RE_ISSUE_DET B ON A.ISSUE_ID=B.ISSUE_ID
	  LEFT OUTER JOIN JOBS ON JOBS.JOB_CODE=B.JOB_CODE
	  WHERE  A.ISSUE_ID=@CMEMO_ID
	
	END
GOTO END_PROC

LBLAPPLU:                        
	SET @CCMD=N'SELECT ISSUE_ID AS MEMO_ID,ISSUE_NO AS MEMO_NO FROM PRD_JOBWORK_RE_ISSUE_MST '+(CASE WHEN ISNULL(@CWHERE,'')='' THEN ''                  
	 ELSE ' WHERE '+@CWHERE END)                 
	 SET @CCMD=@CCMD+' ORDER BY PRD_JOBWORK_RE_ISSUE_MST.ISSUE_DT'                     
	                  
	PRINT @CCMD                  
	EXEC SP_EXECUTESQL @CCMD                   
GOTO END_PROC  
END_PROC:

END
