CREATE PROCEDURE SP_GENNEWMASTER
@CSOURCETEMPTABLE VARCHAR(200),
@CTARGETTABLENAME VARCHAR(200),
@CKEYFIELDCODE VARCHAR(100),
@CKEYFIELDNAME VARCHAR(100),
@NKEYFIELDCODEWIDTH VARCHAR(100),
@CKEYFIELDNAME2 VARCHAR(100)=''
--WITH ENCRYPTION
AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 
	IF OBJECT_ID('TEMPDB..#TSWAPCODE','U') IS NOT NULL
		DROP TABLE #TSWAPCODE
	
	SELECT CONVERT(VARCHAR(20),DEPT_NAME) AS OLD_CODE,CONVERT(VARCHAR(1000),DEPT_NAME) AS NAME,
		   CONVERT(VARCHAR(20),DEPT_NAME) AS NEW_CODE,CONVERT(VARCHAR(1000),DEPT_NAME) AS NAME2,
		   CONVERT(VARCHAR(30),DEPT_NAME) AS NEW_TEST_CODE	
	INTO #TSWAPCODE FROM LOCATION (NOLOCK) WHERE 1=2
		
	DECLARE @CCMD NVARCHAR(MAX),@CCURDEPTID VARCHAR(5),@CNEWKEYVAL VARCHAR(20),@CNAME VARCHAR(100),
			@CNAME2 VARCHAR(100),@NCOL1WIDTH INT,@NCOL2WIDTH INT,@NUPDATEVALUE INT,@BLOOP BIT 
	
	SELECT TOP 1 @CCURDEPTID=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'
	
	SET @CCMD=N'SELECT '+@CKEYFIELDCODE+',LTRIM(RTRIM('+@CKEYFIELDNAME+')),'''','+
				(CASE WHEN @CKEYFIELDNAME2<>'' THEN @CKEYFIELDNAME2 ELSE '''''' END)+' FROM ['+@CSOURCETEMPTABLE+
				'] WHERE '+@CKEYFIELDNAME+'<>'''''+(CASE WHEN @CKEYFIELDNAME2<>'' THEN ' OR '+@CKEYFIELDNAME2+'<>''''' ELSE '' END)
	PRINT @CCMD  
	
	INSERT INTO #TSWAPCODE (OLD_CODE,NAME,NEW_CODE,NAME2)  
	EXEC SP_EXECUTESQL @CCMD 
	
	SELECT @NCOL1WIDTH=A.LENGTH FROM SYSCOLUMNS A (NOLOCK) JOIN SYSOBJECTS B (NOLOCK) ON A.ID=B.ID
	WHERE B.NAME=@CTARGETTABLENAME AND A.NAME=@CKEYFIELDNAME

	SELECT @NCOL2WIDTH=A.LENGTH FROM SYSCOLUMNS A (NOLOCK) JOIN SYSOBJECTS B (NOLOCK) ON A.ID=B.ID
	WHERE B.NAME=@CTARGETTABLENAME AND A.NAME=@CKEYFIELDNAME2
	
	SET @CCMD=N'UPDATE A SET A.NEW_CODE=B.'+@CKEYFIELDCODE+' FROM #TSWAPCODE A
				JOIN ['+@CTARGETTABLENAME+'] B ON LTRIM(RTRIM(B.'+@CKEYFIELDNAME+'))=LTRIM(RTRIM(LEFT(A.NAME,'+
				LTRIM(RTRIM(STR(@NCOL1WIDTH)))+')))'+
				(CASE WHEN @CKEYFIELDNAME2<>'' THEN ' AND LTRIM(RTRIM(B.'+@CKEYFIELDNAME2+'))=LTRIM(RTRIM(LEFT(A.NAME2,'+
				LTRIM(RTRIM(STR(@NCOL1WIDTH)))+')))'  ELSE ''END)
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD 
	IF CURSOR_STATUS('GLOBAL','NEWMASTERCUR') IN (0,1)  
	BEGIN  
	   CLOSE NEWMASTERCUR  
	   DEALLOCATE NEWMASTERCUR  
	END  

 
	SET	@CNEWKEYVAL =''
	
	IF EXISTS (SELECT TOP 1 NEW_CODE FROM #TSWAPCODE WHERE NEW_CODE='')
	BEGIN
		EXEC GETNEXTKEY  
				@CTABLENAME	=	@CTARGETTABLENAME,
				@CCOLNAME	=	@CKEYFIELDCODE,
				@NWIDTH		=	@NKEYFIELDCODEWIDTH,
				@CPREFIX	=	@CCURDEPTID,
				@NLZEROS	=	1,
				@CFINYEAR	=	'',
				@NROWCOUNT	=	1,
				@CNEWKEYVAL	=	@CNEWKEYVAL OUTPUT
			
	   SELECT @BLOOP=0,@NUPDATEVALUE=SUBSTRING(@CNEWKEYVAL,3,LEN(@CNEWKEYVAL))
	   
	   WHILE @BLOOP=0
	   BEGIN  
		   PRINT 'UPDATING NEW CODES FOR :'+@CTARGETTABLENAME
	         
		   UPDATE #TSWAPCODE SET NEW_TEST_CODE = @CCURDEPTID+REPLICATE('0',@NKEYFIELDCODEWIDTH-2-LEN(LTRIM(STR(@NUPDATEVALUE))))+LTRIM(STR(@NUPDATEVALUE)),    
			 @NUPDATEVALUE = @NUPDATEVALUE + 1 WHERE NEW_CODE=''
			  
		   SET @CCMD=N'IF NOT EXISTS (SELECT TOP 1 B.'+@CKEYFIELDCODE+' FROM #TSWAPCODE A JOIN ['+@CTARGETTABLENAME+'] B 
									  ON LTRIM(RTRIM(A.NEW_TEST_CODE))=LTRIM(RTRIM(B.'+@CKEYFIELDCODE+')))
									  
							SET @BLOOPOUT=1
					   ELSE
							SET @BLOOPOUT=0'
 		   EXEC SP_EXECUTESQL @CCMD,N'@BLOOPOUT BIT OUTPUT',@BLOOPOUT=@BLOOP OUTPUT						
	   END
   END
   	
   UPDATE #TSWAPCODE SET NEW_CODE=NEW_TEST_CODE WHERE NEW_CODE=''	
   
   UPDATE A SET NEW_CODE=B.NEW_CODE FROM #TSWAPCODE A JOIN #TSWAPCODE B ON LTRIM(RTRIM(A.NAME))=LTRIM(RTRIM(B.NAME))
   AND LTRIM(RTRIM(A.NAME2))=LTRIM(RTRIM(B.NAME2))			
--      
--	DECLARE NEWMASTERCUR CURSOR
--	FOR
--	SELECT DISTINCT NAME,NAME2 FROM #TSWAPCODE WHERE ISNULL(NEW_CODE,'')=''
--
--	OPEN NEWMASTERCUR
--	FETCH NEXT FROM NEWMASTERCUR INTO  @CNAME,@CNAME2
--	WHILE @@FETCH_STATUS=0
--	BEGIN
--	
--		SET	@CNEWKEYVAL =''
--		
--		EXEC GETNEXTKEY  
--				@CTABLENAME	=	@CTARGETTABLENAME,
--				@CCOLNAME	=	@CKEYFIELDCODE,
--				@NWIDTH		=	@NKEYFIELDCODEWIDTH,
--				@CPREFIX	=	@CCURDEPTID,
--				@NLZEROS	=	1,
--				@CFINYEAR	=	'',
--				@NROWCOUNT	=	1,
--				@CNEWKEYVAL	=	@CNEWKEYVAL OUTPUT
--				
--		UPDATE #TSWAPCODE SET NEW_CODE=@CNEWKEYVAL WHERE NAME=@CNAME AND NAME2=@CNAME2
--		
--		FETCH NEXT FROM NEWMASTERCUR INTO @CNAME,@CNAME2
--	END
--	CLOSE NEWMASTERCUR
--	DEALLOCATE NEWMASTERCUR
--	
	SET @CCMD=N'ALTER TABLE ['+@CSOURCETEMPTABLE+'] ADD OLD_'+@CKEYFIELDCODE+' VARCHAR(20)'
	EXEC SP_EXECUTESQL @CCMD

	SET @CCMD=N'UPDATE ['+@CSOURCETEMPTABLE+'] SET OLD_'+@CKEYFIELDCODE+'='+@CKEYFIELDCODE
	EXEC SP_EXECUTESQL @CCMD
	
	SET @CCMD=N'UPDATE A SET '+@CKEYFIELDCODE+'=B.NEW_CODE,'+@CKEYFIELDNAME+'=LTRIM(RTRIM('+@CKEYFIELDNAME+'))
			    FROM ['+@CSOURCETEMPTABLE+'] A
				JOIN #TSWAPCODE B ON LTRIM(RTRIM(B.NAME))=LTRIM(RTRIM(A.'+@CKEYFIELDNAME+'))'+
				(CASE WHEN @CKEYFIELDNAME2<>'' THEN ' AND LTRIM(RTRIM(B.NAME2))=LTRIM(RTRIM(A.'+@CKEYFIELDNAME2+'))'
					  ELSE ''END)

	PRINT @CCMD			
	EXEC SP_EXECUTESQL @CCMD
	
END
