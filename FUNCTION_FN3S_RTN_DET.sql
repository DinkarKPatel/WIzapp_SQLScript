CREATE FUNCTION FN3S_RTN_DET(@CXN_ID VARCHAR(22),@CXN_TYPE VARCHAR(5))
RETURNS VARCHAR(MAX)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CSSD VARCHAR(MAX)

IF @CXN_TYPE='SLS'
BEGIN
	SELECT @CSSD=ISNULL(@CSSD+', ','')+A.SSD
	FROM
	(
		SELECT DISTINCT SUB_SECTION_NAME+' ['+SECTION_NAME+']' AS SSD
		FROM CMM01106 CMM(NOLOCK)
		JOIN CMD01106 CMD(NOLOCK) ON CMM.CM_ID=CMD.CM_ID
		JOIN SKU(NOLOCK) ON CMD.PRODUCT_CODE=SKU.PRODUCT_CODE
		JOIN ARTICLE ART(NOLOCK) ON SKU.ARTICLE_CODE=ART.ARTICLE_CODE
		JOIN SECTIOND SD(NOLOCK) ON ART.SUB_SECTION_CODE=SD.SUB_SECTION_CODE
		JOIN SECTIONM SM(NOLOCK) ON SD.SECTION_CODE=SM.SECTION_CODE	
		WHERE CMM.CM_ID=@CXN_ID
	)A
END
ELSE IF @CXN_TYPE='ORD'
BEGIN
	SELECT @CSSD=ISNULL(@CSSD+', ','')+A.SSD
	FROM
	(
		SELECT DISTINCT SUB_SECTION_NAME+' ['+SECTION_NAME+']' AS SSD
		FROM WSL_ORDER_MST CMM(NOLOCK)
		JOIN WSL_ORDER_DET CMD(NOLOCK) ON CMM.ORDER_ID=CMD.ORDER_ID
		JOIN ARTICLE ART(NOLOCK) ON CMD.ARTICLE_CODE=ART.ARTICLE_CODE
		JOIN SECTIOND SD(NOLOCK) ON ART.SUB_SECTION_CODE=SD.SUB_SECTION_CODE
		JOIN SECTIONM SM(NOLOCK) ON SD.SECTION_CODE=SM.SECTION_CODE	
		WHERE CMM.ORDER_ID=@CXN_ID
	)A
END
RETURN @CSSD
END
