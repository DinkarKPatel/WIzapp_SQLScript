create   Procedure SP3S_INSERTIMAGE_FROM_IRR
(
@CIRRMEMOID VARCHAR(100)='',
@CERRMSG VARCHAR(1000) output,
@BSETOLDBARCODEIMAGE BIT =0,
@cxntype varchar(10)='IRR',
@CTEMPDETAILTABLENAME varchar(100)=''
)
as
begin

	DECLARE @BSECTION BIT,@BSUB_SECTION BIT,@BARTICLE BIT,@BPARA1 BIT ,@BPARA2 BIT ,
			@BPARA3 BIT ,@BPARA4 BIT ,@BPARA5 BIT, @BPARA6 BIT ,@BPRODUCT BIT,
			@dtsql nvarchar(max),@DBNAME VARCHAR(100),@COLDCOLNAME VARCHAR(MAX),@CNEWCOLNAME VARCHAR(MAX)

	BEGIN TRY
    
		
	SET @DBNAME=DB_NAME ()+'_Image.dbo.'

	SELECT @BSECTION =SECTION ,@BSUB_SECTION =SUB_SECTION ,@BARTICLE =ARTICLE ,@BPARA1 =PARA1 ,@BPARA2 =PARA2 ,
		   @BPARA3 =PARA3 ,@BPARA4=PARA4 ,@BPARA5 =PARA5,@BPARA6 =PARA6 ,@bPRODUCT=Product
	FROM IMAGE_INFO_CONFIG

    IF (@BSETOLDBARCODEIMAGE=1 OR @CXNTYPE='PUR')
       GOTO LBL_OLDBARCODEIMAGE

	  if isnull(@bPRODUCT,0)=0
	  GOTO END_PROC


	IF ISNULL(@BPRODUCT,0)=1
	BEGIN

	      SET @dtsql=' INSERT '+@DBNAME+'IMAGE_INFO	( ARTICLE_CODE, DEPT_ID, IMG_ID, last_update, PARA1_CODE, PARA2_CODE, PARA3_CODE, PARA4_CODE, PARA5_CODE, PARA6_CODE, PROD_IMAGE, 
		                PROD_IMAGE1, PROD_IMAGE2, PROD_IMAGE3, PROD_IMAGE4, PRODUCT_CODE, SECTION_CODE, SUB_SECTION_CODE, UPLOADED_TO_HO )  

		  SELECT  A.ARTICLE_CODE,A. DEPT_ID,newid() IMG_ID, A.last_update,A. PARA1_CODE, A.PARA2_CODE, A.PARA3_CODE, A.PARA4_CODE, A.PARA5_CODE, A.PARA6_CODE,A. PROD_IMAGE, A.PROD_IMAGE1, 
              A.PROD_IMAGE2, A.PROD_IMAGE3, A.PROD_IMAGE4, B.NEW_PRODUCT_CODE PRODUCT_CODE, A.SECTION_CODE, A.SUB_SECTION_CODE, A.UPLOADED_TO_HO 
		  FROM '+@DBNAME+'IMAGE_INFO A 
		  JOIN IRD01106 B ON A.PRODUCT_CODE=B.PRODUCT_CODE 
		  LEFT JOIN '+@DBNAME+'IMAGE_INFO C ON B.NEW_PRODUCT_CODE=C.PRODUCT_CODE
		  WHERE C.PRODUCT_CODE IS NULL and b.irm_memo_id='''+@CIRRMEMOID+''' '
		  	  print @dtsql
		  EXEC SP_EXECUTESQL @dtsql
	

	END
	
	 GOTO END_PROC
	 
	LBL_OLDBARCODEIMAGE:
	  
	 IF @BSETOLDBARCODEIMAGE=1
	 BEGIN    
	 
        declare @cExpr varchar(1000),@cExprIrr varchar(1000),@DTSQLOLDJOIN varchar(1000),@DTSQLNEWJOIN varchar(1000)
        
		SET @cExprIrr=' 1=1 '
		set @DTSQLNEWJOIN='1=1'
		set @DTSQLOLDJOIN='1=1'



		IF ISNULL(@BARTICLE,0)=1
		BEGIN
			SELECT @CEXPR=ISNULL(@CEXPR,'')+ ' AND IRD.ARTICLE_CODE =IMG.ARTICLE_CODE'
			
			IF @CXNTYPE ='IRR'
			begin
				SELECT @CEXPRIRR=ISNULL(@CEXPRIRR,'')+ ' OR  (IRD.ARTICLE_CODE <>IRD.OLD_ARTICLE_CODE)  '
				SELECT @DTSQLNEWJOIN=ISNULL(@DTSQLNEWJOIN,'')+ ' AND IMG.ARTICLE_CODE =IMG1.ARTICLE_CODE '
				SELECT @DTSQLOLDJOIN=ISNULL(@DTSQLOLDJOIN,'')+ ' AND IRD.OLD_ARTICLE_CODE =IMG.ARTICLE_CODE'
			end
		END
		
		IF ISNULL(@bPARA1,0)=1
		BEGIN
			SELECT @cExpr=ISNULL(@cExpr,'')+ ' AND IRD.PARA1_CODE  =IMG.PARA1_CODE'
			
			IF @CXNTYPE ='IRR'
			begin
				SELECT @cExprIrr=ISNULL(@cExprIrr,'')+ ' OR (IRD.PARA1_CODE <>IRD.OLD_PARA1_CODE)  '
				SELECT @DTSQLNEWJOIN=ISNULL(@DTSQLNEWJOIN,'')+ ' AND IMG.PARA1_CODE =IMG1.PARA1_CODE '
				SELECT @DTSQLOLDJOIN=ISNULL(@DTSQLOLDJOIN,'')+ ' AND IRD.OLD_PARA1_CODE =IMG.PARA1_CODE'
			end
		END
		
		
		IF ISNULL(@bPARA2,0)=1
		BEGIN
			SELECT @cExpr=ISNULL(@cExpr,'')+ ' AND IRD.PARA2_CODE =IMG.PARA2_CODE'
			
			IF @CXNTYPE ='IRR'
			begin
				SELECT @cExprIrr=ISNULL(@cExprIrr,'')+ ' OR (IRD.PARA2_CODE <>IRD.OLD_PARA2_CODE) '
				SELECT @DTSQLNEWJOIN=ISNULL(@DTSQLNEWJOIN,'')+ ' AND IMG.PARA2_CODE =IMG1.PARA2_CODE '
				SELECT @DTSQLOLDJOIN=ISNULL(@DTSQLOLDJOIN,'')+ ' AND IRD.OLD_PARA2_CODE =IMG.PARA2_CODE'
			end
		END
		
		IF ISNULL(@bPARA3,0)=1
		BEGIN
			SELECT @cExpr=ISNULL(@cExpr,'')+ ' AND IRD.PARA3_CODE  =IMG.PARA3_CODE'
			
			IF @CXNTYPE ='IRR'
			begin
				SELECT @cExprIrr=ISNULL(@cExprIrr,'')+ ' OR (IRD.PARA3_CODE <>IRD.OLD_PARA3_CODE)  '
				SELECT @DTSQLNEWJOIN=ISNULL(@DTSQLNEWJOIN,'')+ ' AND IMG.PARA3_CODE =IMG1.PARA3_CODE '
				SELECT @DTSQLOLDJOIN=ISNULL(@DTSQLOLDJOIN,'')+ ' AND IRD.OLD_PARA3_CODE =IMG.PARA3_CODE'
			end
		END
		
		
		IF ISNULL(@bPARA4,0)=1
		BEGIN
			SELECT @cExpr=ISNULL(@cExpr,'')+ ' AND IRD.PARA4_CODE = IMG.PARA4_CODE'
			
			IF @CXNTYPE ='IRR'
			begin
				SELECT @cExprIrr=ISNULL(@cExprIrr,'')+ ' OR (IRD.PARA4_CODE <>IRD.OLD_PARA4_CODE)  '
				SELECT @DTSQLNEWJOIN=ISNULL(@DTSQLNEWJOIN,'')+ ' AND IMG.PARA4_CODE =IMG1.PARA4_CODE '
				SELECT @DTSQLOLDJOIN=ISNULL(@DTSQLOLDJOIN,'')+ ' AND IRD.OLD_PARA4_CODE =IMG.PARA4_CODE'
			end
		END
		
		
		IF ISNULL(@bPARA5,0)=1
		BEGIN
			SELECT @cExpr=ISNULL(@cExpr,'')+ ' AND IRD.PARA5_CODE  =IMG.PARA5_CODE'
			
			IF @CXNTYPE ='IRR'
			begin
				SELECT @cExprIrr=ISNULL(@cExprIrr,'')+ ' OR (IRD.PARA5_CODE <>IRD.OLD_PARA5_CODE)  '
				SELECT @DTSQLNEWJOIN=ISNULL(@DTSQLNEWJOIN,'')+ ' AND IMG.PARA5_CODE =IMG1.PARA5_CODE '
				SELECT @DTSQLOLDJOIN=ISNULL(@DTSQLOLDJOIN,'')+ ' AND IRD.OLD_PARA5_CODE =IMG.PARA5_CODE'
			end
		END
		
		
		IF ISNULL(@bPARA6,0)=1
		BEGIN
			SELECT @cExpr=ISNULL(@cExpr,'')+ ' AND IRD.PARA6_CODE =IMG.PARA6_CODE'
			
			IF @CXNTYPE ='IRR'
			begin
				SELECT @cExprIrr=ISNULL(@cExprIrr,'')+ ' OR (IRD.PARA6_CODE <>IRD.OLD_PARA6_CODE)  '
				SELECT @DTSQLNEWJOIN=ISNULL(@DTSQLNEWJOIN,'')+ ' AND IMG.PARA6_CODE =IMG1.PARA6_CODE '
				SELECT @DTSQLOLDJOIN=ISNULL(@DTSQLOLDJOIN,'')+ ' AND IRD.OLD_PARA6_CODE =IMG.PARA6_CODE'
			end
		END
	
	
		IF @CXNTYPE ='PUR' and @bPRODUCT=0
		BEGIN
		   
		     
		      SET @DTSQL=' 
		      ;WITH CTE_PUR AS
		       (
		        SELECT B.PRODUCT_CODE,B.ARTICLE_CODE,B.PARA1_CODE ,B.PARA2_CODE,B.PARA3_CODE,b.para4_code ,b.para5_code,b.para6_code
		        FROM '+@CTEMPDETAILTABLENAME+' a (NOLOCK)
		        JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
		        WHERE A.sp_id='''+@CIRRMEMOID+''' and a.product_code <>''''
		        )      
		     
		      UPDATE SN SET barcode_img_id=img.img_id FROM SKU_NAMES sn  WITH (ROWLOCK) 
              JOIN cte_pur IRD (NOLOCK) ON IRD.product_code=sn.product_code 
              JOIN '+@DBNAME+'image_info img ON 1=1 '+@CEXPR +
              ' WHERE IMG.IMG_ID<>SN.BARCODE_IMG_ID '
              
             PRINT @DTSQL
		     EXEC SP_EXECUTESQL @DTSQL
		     
		     GOTO END_PROC
		 
		END
		
		
		IF ISNULL(@CEXPR,'')<>'' 
		BEGIN
		        SET @DTSQL=' IF EXISTS (SELECT TOP 1 ''U''  FROM '+@DBNAME+'IMAGE_INFO IMG 
		         JOIN IRD01106 IRD (NOLOCK) ON  '+@DTSQLOLDJOIN +
		       ' LEFT JOIN '+@DBNAME+'IMAGE_INFO IMG1 ON '+@DTSQLNEWJOIN +
		       ' WHERE IRD.IRM_MEMO_ID='''+@CIRRMEMOID+''' 
		         AND IMG1.IMG_ID IS NULL  )
		         begin
		         
		        INSERT '+@DBNAME+'IMAGE_INFO	( ARTICLE_CODE, DEPT_ID, IMG_ID, last_update, PARA1_CODE, PARA2_CODE, PARA3_CODE, PARA4_CODE, PARA5_CODE, PARA6_CODE, PROD_IMAGE, 
		                PROD_IMAGE1, PROD_IMAGE2, PROD_IMAGE3, PROD_IMAGE4, PRODUCT_CODE, SECTION_CODE, SUB_SECTION_CODE, UPLOADED_TO_HO )  
		                
		         SELECT IMG. ARTICLE_CODE, IMG.DEPT_ID, newid() IMG_ID, getdate() last_update, IMG.PARA1_CODE, IMG.PARA2_CODE, IMG.PARA3_CODE, IMG.PARA4_CODE, IMG.PARA5_CODE, 
		         IMG.PARA6_CODE, IMG.PROD_IMAGE, IMG.PROD_IMAGE1, IMG.PROD_IMAGE2, IMG.PROD_IMAGE3, IMG.PROD_IMAGE4, IMG.PRODUCT_CODE, IMG.SECTION_CODE, IMG.SUB_SECTION_CODE, IMG.UPLOADED_TO_HO  
		         FROM '+@DBNAME+'IMAGE_INFO IMG 
		         JOIN IRD01106 IRD (NOLOCK) ON  '+@DTSQLOLDJOIN +
		       ' LEFT JOIN '+@DBNAME+'IMAGE_INFO IMG1 ON '+@DTSQLNEWJOIN +
		       ' WHERE IRD.IRM_MEMO_ID='''+@CIRRMEMOID+''' 
		         AND IMG1.IMG_ID IS NULL
		        
		        END 
		        '
		  		PRINT @DTSQL
				EXEC SP_EXECUTESQL @DTSQL
				
				
			  SET @DTSQL=' Update a set barcode_img_id ='''' FROM sku_names a (NOLOCK)
			  JOIN IRD01106 IRD (NOLOCK) ON A.product_Code =IRD.product_code 
			  WHERE IRD.irm_memo_id ='''+@CIRRMEMOID+''' and IRD.new_product_code ='''' 
			  and  ( '+@CEXPRIRR + ' ) '
			  
			 PRINT @DTSQL
		     EXEC SP_EXECUTESQL @DTSQL
		     
		    
		     SET @DTSQL=' UPDATE IMG SET LAST_UPDATE=IMG.LAST_UPDATE   FROM '+@DBNAME+'IMAGE_INFO IMG 
		     JOIN IRD01106 IRD (NOLOCK) ON 1=1 '+@CEXPR +
		     '  WHERE IRD.IRM_MEMO_ID='''+@CIRRMEMOID+''' 
		     AND ( '+@CEXPRIRR + ' )'
		  	 PRINT @DTSQL
		     EXEC SP_EXECUTESQL @DTSQL
		     
		     GOTO END_PROC
		       
		END
		
		
		
       
END
	

	END TRY
	BEGIN CATCH
	   SET @CERRMSG=' #SQL Error '+ LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
	END CATCH

END_PROC:

end