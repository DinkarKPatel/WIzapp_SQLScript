CREATE PROCEDURE SP3S_GET_ACT_OPENING --(LocId 3 digit change by Sanjay:05-11-2024)
( 
	@CACCODE VARCHAR(20)='', 
	@CDEPTID VARCHAR(4)='', 
	@DOPENINGDT DATETIME, 
	@CFINYEAR VARCHAR(10)='',
	@cSourceTempTable VARCHAR(100)='',
	@dClosingDt DATETIME='',
	@nRetModePara NUMERIC(1,0)=0,
	@cSPID	VARCHAR(50)='',
	@bLocIdSelected BIT=0
)
AS 
BEGIN
	DECLARE @NOPENING NUMERIC(14,2), @cCmd NVARCHAR(MAX),@cFilter VARCHAR(MAX),
			@CSTOCKINHANDTREE VARCHAR(2000),@nRetMode NUMERIC(1,0),
			@CDONOTPICKOBHEADS VARCHAR(2000),@cUpdStr VARCHAR(1000),
			@CHEADCODE VARCHAR(10),@nLoop NUMERIC(1,0),@nLoopCNT NUMERIC(1,0),
			@CMINFINYEAR VARCHAR(10),@CPICKPROFILTLOSSHEADS VARCHAR(4),@CDONOT_CONSIDER_MEMO_VOUCHERS_ACCBOOKS VARCHAR(4),
			@CCONSIDER_MEMO_REVERSAL_VOUCHERS_ACCBOOKS VARCHAR(4)			

	SELECT TOP 1 @CDONOT_CONSIDER_MEMO_VOUCHERS_ACCBOOKS=VALUE FROM  CONFIG WHERE CONFIG_OPTION='DONOT_CONSIDER_MEMO_VOUCHERS_ACCBOOKS'
	SELECT TOP 1 @CCONSIDER_MEMO_REVERSAL_VOUCHERS_ACCBOOKS=VALUE FROM  CONFIG WHERE CONFIG_OPTION='CONSIDER_MEMO_REVERSAL_VOUCHERS_ACCBOOKS'

	SELECT @CDONOT_CONSIDER_MEMO_VOUCHERS_ACCBOOKS=ISNULL(@CDONOT_CONSIDER_MEMO_VOUCHERS_ACCBOOKS,''),
		   @CCONSIDER_MEMO_REVERSAL_VOUCHERS_ACCBOOKS=ISNULL(@CCONSIDER_MEMO_REVERSAL_VOUCHERS_ACCBOOKS,'')
		   	
	SET @NOPENING = 0

	SELECT ac_code,CONVERT(NUMERIC(14,2),0) OPENING,CONVERT(NUMERIC(14,2),0) CLOSING
	INTO #tmpLm FROM lm01106 (NOLOCK) WHERE ac_code=@CACCODE

	IF @cSourceTempTable<>''
	BEGIN
		SET @cCmd=N'SELECT distinct ac_code FROM '+@cSourceTempTable
		PRINT @cCmd

		INSERT #tmpLm (ac_code)
		EXEC SP_EXECUTESQL @cCmd
	END
	-- TEMP TABLE TO STORED THE LIST OF LOCATIONS CURRENTLY SELECTED
	-- JOIN THIS TABLE IN EACH QUERY TO GET THE RESULT FOR SINGLE, MULTIPLE OR ALL LOCATIONS
	CREATE TABLE #LOCLISTC ( DEPT_ID VARCHAR(4) )
	
	IF ISNULL(@cSPID,'')=''
		SET @cSPID=CONVERT(VARCHAR(50),@@SPID)

	IF @CDEPTID <> ''
		INSERT #LOCLISTC VALUES ( @CDEPTID )
	ELSE
	BEGIN
		IF EXISTS ( SELECT TOP 1 DEPT_ID FROM ACT_FILTER_LOC WHERE SP_ID =@cSPID  AND dept_id<>'' )--@@SPID
			INSERT #LOCLISTC
			SELECT DEPT_ID FROM ACT_FILTER_LOC WHERE SP_ID = @cSPID--@@SPID
		ELSE
			INSERT #LOCLISTC
			SELECT DEPT_ID FROM LOCATION WHERE DEPT_ID=MAJOR_DEPT_ID AND loc_type=1 --OR Account_posting_at_ho=1)
	END


	--if @@spid=373
	--	select 'check loclistc', * from #LOCLISTC

	--*** SPECIAL CONSIDERATION FOR "STOCK IN HAND" HEADS
	--*** IN CASE OF "STOCK IN HAND" HEADS, RETURN OB ONLY FROM LOCOB TABLE
	--*** AND DO NOT PROCESS THROUGH VM AND VD
	SELECT @CDONOTPICKOBHEADS = DBO.FN_ACT_TRAVTREE('0000000010')

	SELECT TOP 1 @CPICKPROFILTLOSSHEADS=VALUE FROM CONFIG WHERE CONFIG_OPTION='PICK_PROFITLOSS_HEADS'
	IF ISNULL(@CPICKPROFILTLOSSHEADS,'')<>'1'
		SELECT @CDONOTPICKOBHEADS = @CDONOTPICKOBHEADS + ', '+DBO.FN_ACT_TRAVTREE('0000000009')

	SELECT head_code INTO #tempDNObHd FROM hd01106 WHERE CHARINDEX(head_code,@CDONOTPICKOBHEADS)>0    
	SET @nLoopCnt=(CASE WHEN @nRetModePara=3 THEN 2 ELSE 1 END)

	SET @nRetMode=(CASE WHEN @nRetModePara=0 THEN 1 ELSE @nRetModePara END)
	--SELECT * from #tempDNObHd
	SET @nLoop=1

	SELECT CONVERT(VARCHAR(4),'') DEPT_ID,ac_code,opening,closing INTO #tmpFinalBal FROM #tmpLm WHERE 1=2

	IF @bLocIdSelected=1
		INSERT INTO #tmpFinalBal (DEPT_ID,ac_code)
		SELECT b.dept_id,a.ac_code FROM #tmplm a,#LOCLISTC b
	ELSE
		INSERT INTO #tmpFinalBal (DEPT_ID,ac_code)
		SELECT '' dept_id,ac_code FROM #tmpLm
	
	DECLARE @cLocIdExpr VARCHAR(200),@cLocIdGrpExpr VARCHAR(200),@cLocIdJoin varchar(200)

	SElect @cLocIdExpr=(CASE WHEN @bLocIdSelected=1 THEN ' cost_center_dept_id as dept_id,' ELSE ''''' AS DEPT_ID,'   END),
	@cLocIdGrpExpr=(CASE WHEN @bLocIdSelected=1 THEN ' cost_center_dept_id,' ELSE ''   END),
	@cLocIdJoin=(CASE WHEN @bLocIdSelected=1 THEN ' AND b.dept_id=a.dept_id ' ELSE ''   END)

	WHILE @nLoop<=@nLoopCnt
	BEGIN
		SET @CFINYEAR=(CASE WHEN @nLoop=1  AND @nRetMode IN(1,3) THEN '01'+dbo.FN_GETFINYEAR(@DOPENINGDT)
							ELSE  '01'+dbo.FN_GETFINYEAR(@dClosingDt) END)

		SET @cFilter=(CASE WHEN @nLoop=1 AND @nRetMode IN(1,3) THEN  ' voucher_dt<'''+CONVERT(VARCHAR,@DOPENINGDT,110)
												ELSE  ' voucher_dt<='''+CONVERT(VARCHAR,@DClosingDT,110) END)+'''
					 AND (dnpickob.head_code IS NULL OR fin_year='''+@CFINYEAR+''')'
--SET @cFilter=' 1=1 '			
	--SELECT * FROM #LOCLISTC ORDER BY DEPT_ID
	-- ADDING FROM TRANSACTIONS

		SET @cCmd=N'UPDATE a SET '+(CASE WHEN @nLoop=1 AND @nRetMode IN(1,3) THEN ' opening ' ELSE ' closing ' END)+
		'= b.balance
		FROM #tmpFinalBal  a JOIN 
		(SELECT '+@cLocIdExpr+'a.ac_code,SUM(A.DEBIT_AMOUNT-A.CREDIT_AMOUNT) balance
		FROM  VD01106 A (NOLOCK)
		JOIN VM01106 B (NOLOCK) ON B.VM_ID = A.VM_ID
		JOIN #LOCLISTC LOCLIST ON A.COST_CENTER_DEPT_ID = LOCLIST.DEPT_ID
		JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=A.AC_CODE
		JOIN VCHTYPE D (NOLOCK) ON D.VOUCHER_CODE=B.VOUCHER_CODE
		JOIN #tmpLm ON #tmpLm.ac_code=a.ac_code
		LEFT OUTER JOIN acc_memo_reversal amr1 (NOLOCK) ON amr1.memo_vm_id=b.vm_id
		LEFT OUTER JOIN acc_memo_reversal amr2 (NOLOCK) ON amr2.reversal_vm_id=b.vm_id			
		LEFT JOIN #tempDNObHd dnpickob on dnpickob.head_code=lm.head_code
		WHERE '+@cFilter+' AND  B.CANCELLED = 0-- AND ISNULL(B.OP_ENTRY,0)=0 AND ISNULL(B.MEMO,0)=0
		AND (d.VOUCHER_CODE NOT IN (''MEMO000001'',''MEMO000002'') OR '''+@cDONOT_CONSIDER_MEMO_VOUCHERS_ACCBOOKS+'''<>''1'')
		AND ((amr1.memo_vm_id IS NULL AND amr2.memo_vm_id IS NULL) OR 
				('''+@cCONSIDER_MEMO_REVERSAL_VOUCHERS_ACCBOOKS+'''=''1'' AND '''+@cDONOT_CONSIDER_MEMO_VOUCHERS_ACCBOOKS+'''<>''1''))
		GROUP BY '+@cLocIdGrpExpr+'a.ac_code) b ON b.ac_code=a.ac_code'+@cLocIdJoin
		
		PRINT ISNULL(@cCmd,'Null cmd')	
		EXEC SP_EXECUTESQL @cCmd

		SET @nLoop=@nLoop+1

	END	

	IF @nRetModePara>0
	BEGIN
		SET @cUpdStr=(CASE WHEN @nRetModePara IN(1) THEN ' opening=ISNULL(b.opening,0) ' 
						WHEN @nRetModePara IN(2) THEN ' closing=ISNULL(b.closing,0) ' 
						ELSE ' opening=ISNULL(b.opening,0),closing=ISNULL(b.closing,0) ' END)
		SET @cCmd=N'UPDATE a SET '+@cUpdStr+' FROM '+@cSourceTempTable+' a
					JOIN  #tmpFinalBal b ON a.ac_code=b.ac_code'+REPLACE(@cLocIdJoin,'A.DEPT_ID','A.LOCATION_ID')
		PRINT @cCmd
		EXEC SP_EXECUTESQL @cCmd
	END
END_PROC:
	IF @nRetModePara=0
		SELECT  AC_CODE,OPENING FROM  #tmpLm
	
		
END