CREATE PROCEDURE SP3S_WIP_HISTORY
(
	@CWIP_UID VARCHAR(50)
)
--WITH ENCRYPTION
AS
BEGIN
/*
EXEC SP3S_WIP_HISTORY '0126AE6B6D-A9C7-4964-95F5-BD14F61D8692'
EXEC SP3S_WIP_HISTORY '01E722A2B0-1799-4F2F-9073-04163F63129F'
*/
DECLARE @BEXISTS BIT,@CLINK_UID VARCHAR(50),@NCOUNTER NUMERIC(5)

SELECT WIP_UID INTO #LINK_UIDS FROM WIP_PMT WHERE 1=2

INSERT #LINK_UIDS(WIP_UID)
SELECT @CWIP_UID

IF OBJECT_ID('TEMPDB..#XN_DET','U') IS NOT NULL
	DROP TABLE #XN_DET

CREATE TABLE #XN_DET(XN_TYPE VARCHAR(3),XN_NO VARCHAR(15),XN_DT DATETIME
					,PRODUCT_CODE VARCHAR(50),QUANTITY NUMERIC(10,2),UNIT_RATE NUMERIC(14,2)
					,AGENCY_CODE VARCHAR(7),JOB_CODE VARCHAR(7),JOB_RATE NUMERIC(14,2)
					,WIP_UID VARCHAR(50),XN_ORDER NUMERIC(5))

IF EXISTS(SELECT TOP 1 'X' FROM WIP_PMT WP(NOLOCK) 
						   JOIN JOBWORK_RECEIPT_DET JRD(NOLOCK) ON WP.XN_ROW_ID=JRD.ROW_ID
						   WHERE WP.WIP_UID=@CWIP_UID)
BEGIN
	SET @BEXISTS=1
	SET @NCOUNTER=0
END

WHILE @BEXISTS=1
BEGIN
	
	INSERT #XN_DET(XN_TYPE,XN_NO,XN_DT,PRODUCT_CODE,QUANTITY,UNIT_RATE,AGENCY_CODE
				  ,JOB_CODE,JOB_RATE,WIP_UID,XN_ORDER)
	SELECT 'JWI' AS XN_TYPE,JIM.ISSUE_NO,JIM.ISSUE_DT,JID.PRODUCT_CODE,JID.QUANTITY
		   ,JID.PREV_JOB_RATE,JIM.AGENCY_CODE,JID.JOB_CODE,JID.JOB_RATE,JID.WIP_UID
		   ,@NCOUNTER
	FROM JOBWORK_ISSUE_MST JIM(NOLOCK)
	JOIN JOBWORK_ISSUE_DET JID(NOLOCK) ON JIM.ISSUE_ID=JID.ISSUE_ID
	JOIN JOBWORK_RECEIPT_DET JRD(NOLOCK) ON JRD.REF_ROW_ID=JID.ROW_ID
	JOIN WIP_PMT WP(NOLOCK) ON JRD.ROW_ID=WP.XN_ROW_ID
	WHERE JIM.WIP=1 AND JIM.CANCELLED=0 AND WP.WIP_UID=@CWIP_UID
	UNION ALL
	SELECT 'JWR' AS XN_TYPE,JRM.RECEIPT_NO,JRM.RECEIPT_DT,JRD.PRODUCT_CODE,JRD.QUANTITY
		  ,JRD.PREV_JOB_RATE,JRM.AGENCY_CODE,JRD.JOB_CODE,JRD.JOB_RATE,JRD.WIP_UID
		  ,@NCOUNTER+1
	FROM JOBWORK_RECEIPT_MST JRM(NOLOCK)
	JOIN JOBWORK_RECEIPT_DET JRD(NOLOCK) ON JRM.RECEIPT_ID=JRD.RECEIPT_ID
	JOIN WIP_PMT WP(NOLOCK) ON JRD.ROW_ID=WP.XN_ROW_ID
	WHERE JRM.WIP=1 AND JRM.CANCELLED=0 AND WP.WIP_UID=@CWIP_UID
	
	SET @NCOUNTER=@NCOUNTER+2
	
	SELECT TOP 1 @CLINK_UID=JRD.WIP_UID 
	FROM WIP_PMT WP(NOLOCK) 
	JOIN JOBWORK_RECEIPT_DET JRD(NOLOCK) ON WP.XN_ROW_ID=JRD.ROW_ID
	WHERE WP.WIP_UID=@CWIP_UID
	
	SET @CWIP_UID=@CLINK_UID
	
	IF NOT EXISTS(SELECT TOP 1 'X' FROM WIP_PMT WP(NOLOCK) 
						   JOIN JOBWORK_RECEIPT_DET JRD(NOLOCK) ON WP.XN_ROW_ID=JRD.ROW_ID
						   WHERE WP.WIP_UID=@CWIP_UID)
	SET @BEXISTS=0	
END						   

END_PROC:
	--SELECT * FROM #XN_DET
	SELECT A.XN_TYPE,A.XN_NO,A.XN_DT,A.PRODUCT_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME
		  ,A.QUANTITY
		  ,(CASE WHEN A.XN_TYPE='JWI' THEN A.QUANTITY ELSE 0 END) AS OUT_QUANTITY
		  ,(CASE WHEN A.XN_TYPE='JWR' THEN A.QUANTITY ELSE 0 END) AS IN_QUANTITY
		  ,A.UNIT_RATE
		  ,ISNULL(PAM.AGENCY_NAME,'') AS AGENCY_NAME,ISNULL(B.JOB_NAME,'') AS JOB_NAME,A.JOB_RATE
	FROM #XN_DET A
	LEFT JOIN JOBS B(NOLOCK) ON A.JOB_CODE=B.JOB_CODE
	LEFT JOIN PRD_AGENCY_MST PAM(NOLOCK) ON A.AGENCY_CODE=PAM.AGENCY_CODE 
	JOIN SKU S(NOLOCK) ON S.PRODUCT_CODE=A.PRODUCT_CODE
	JOIN ARTICLE ART(NOLOCK) ON S.ARTICLE_CODE=ART.ARTICLE_CODE
	ORDER BY XN_DT DESC,XN_ORDER ASC 
END
--END OF PROCEDURE SP3S_WIP_HISTORY
