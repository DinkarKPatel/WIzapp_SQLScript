CREATE  FUNCTION FN_BILL_NO
(
     @DFROM_DT DATETIME
	,@DTO_DT DATETIME
	,@CANCELLED NUMERIC(1)=2 -- 0 FOR UN-CANCELLED 1 FOR CANCELLED 2 FOR ALL
	,@CUST_CODE VARCHAR(20)=''
	,@STATUS NUMERIC(1)=2
)
RETURNS @TBLBILLNO TABLE (MEMO_ID VARCHAR(max),BILL_NO VARCHAR(max),BILL_DATE VARCHAR(max))	
WITH ENCRYPTION
AS
BEGIN
        DECLARE @TBL TABLE (MEMO_ID VARCHAR(max),BILL_NO VARCHAR(max),BILL_DATE VARCHAR(max))
        
        INSERT INTO @TBL
        SELECT DISTINCT  A.MEMO_ID,BILL_NO,CONVERT(VARCHAR,BILL_DATE,105) AS BILL_DATE
        FROM HOLD_BACK_DELIVER_MST A (NOLOCK)
		JOIN HOLD_BACK_DELIVER_DET b (NOLOCK) ON a.memo_id =b.memo_id 
		JOIN 
		   (
		    SELECT CMM.CM_NO AS BILL_NO,CMD.ROW_ID,CMM.CM_DT AS BILL_DATE  FROM CMM01106 CMM (NOLOCK)
		    JOIN cmd01106 CMD (NOLOCK) ON CMM.cm_id=CMD.cm_id 
		    WHERE CMM.CANCELLED =0
		    
		   ) CMD ON CMD.ROW_ID=B.ref_cmd_row_id 
		LEFT JOIN SLS_DELIVERY_DET SLSDET (NOLOCK) ON B.ROW_ID=SLSDET.REF_HBD_ROW_ID
		LEFT JOIN SLS_DELIVERY_MST SLSMST (NOLOCK) ON SLSMST.MEMO_ID=SLSDET.MEMO_ID
		JOIN CUSTDYM D ON D.customer_code=A.customer_code   
		WHERE A.MEMO_DT BETWEEN @DFROM_DT and @DTO_DT
		AND (@CANCELLED=2 OR A.cancelled =@CANCELLED)
		AND (@CUST_CODE='' OR D.CUSTOMER_CODE=@CUST_CODE)
		
		
		INSERT INTO @TBLBILLNO(MEMO_ID )
		SELECT DISTINCT MEMO_ID FROM @TBL

		DECLARE @MEMO_ID  VARCHAR(100)
		DECLARE @BILL_NO  VARCHAR(100)
		DECLARE @BILLDATE VARCHAR(100)
		
		DECLARE @ENTERDBILLNO VARCHAR(100)
		DECLARE @ENTERDBILLDATE VARCHAR(100)
		
		SET @ENTERDBILLNO=''
		DECLARE CURSORITEM CURSOR 
		FOR
		SELECT MEMO_ID, BILL_NO,BILL_DATE
		FROM @TBL T
		ORDER BY MEMO_ID,BILL_NO
		OPEN CURSORITEM
		FETCH NEXT FROM CURSORITEM INTO @MEMO_ID,@BILL_NO,@BILLDATE
		WHILE @@FETCH_STATUS=0
		BEGIN
 
          SET @ENTERDBILLNO =(SELECT BILL_NO FROM @TBLBILLNO WHERE MEMO_ID=@MEMO_ID )
          SET @ENTERDBILLDATE=(SELECT BILL_DATE FROM @TBLBILLNO WHERE MEMO_ID=@MEMO_ID )
          
          IF ISNULL(@ENTERDBILLNO,'')=''
          BEGIN
              UPDATE @TBLBILLNO  SET BILL_NO=@BILL_NO,BILL_DATE =@BILLDATE   WHERE MEMO_ID=@MEMO_ID 
              
          END
          ELSE
          BEGIN
              UPDATE @TBLBILLNO  SET BILL_NO=@ENTERDBILLNO +','+@BILL_NO,BILL_DATE=@ENTERDBILLDATE +','+@BILLDATE  WHERE MEMO_ID=@MEMO_ID 
              
          END
          	

			FETCH NEXT FROM CURSORITEM INTO @MEMO_ID,@BILL_NO,@BILLDATE
		END 
		CLOSE CURSORITEM
		DEALLOCATE CURSORITEM
	RETURN 
END