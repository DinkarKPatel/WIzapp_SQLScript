
create PROCEDURE SP3S_BUILD_PO_VS_PI
(
  @CSP_ID VARCHAR(50),
  @CERRMSG  VARCHAR(1000) OUTPUT
)
AS
BEGIN

      
	   SET @CERRMSG=''

		SELECT A.AC_CODE AS AC_CODE,
				A.MRR_ID, B.ROW_ID,  B.PO_ROW_ID ,B.ARTICLE_CODE ,
			   PARA1_CODE ,PARA2_CODE,B.QUANTITY , 
			   B.PARA3_CODE ,B.PARA4_CODE ,B.PARA5_CODE ,B.PARA6_CODE,
			   B.PO_ID ,
			   LEFT(b.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',b.PRODUCT_CODE)-1,-1),LEN(b.PRODUCT_CODE ))) AS PRODUCT_CODE
		INTO #TMPPI_build
		FROM PUR_PIm01106_UPLOAD A
		JOIN PUR_PID01106_UPLOAD B ON A.sp_id =B.sp_id 
		WHERE A.CANCELLED =0 AND B.PO_ROW_ID =''
		AND A.INV_MODE=1
		AND A.SP_ID=@CSP_ID


	   SELECT  AC_CODE into #tmpAc_code_build from #TMPPI_build  UNION
	   SELECT MAJOR_AC_CODE  FROM LM01106 WHERE AC_CODE in(select AC_CODE  from #TMPPI_build)



		

		SELECT b.ac_code  as ac_code,
			   A.PO_ID, A.ROW_ID ,A.ARTICLE_CODE ,PARA1_CODE ,A.PARA2_CODE,
			   A.QUANTITY+ ROUND(A.QUANTITY *A.TOLERANCE_PERCENTAGE /100,0)  as  QUANTITY,
			   A.PI_QTY ,
			   (A.QUANTITY+ ROUND(A.QUANTITY *A.TOLERANCE_PERCENTAGE /100,0))-ISNULL(PI_QTY,0) AS PENDING_QTY
		,A.PARA3_CODE ,A.PARA4_CODE ,A.PARA5_CODE ,A.PARA6_CODE,A.product_code 
		INTO #TMPPO_build
		FROM POD01106 A (nolock) 
		JOIN POM01106 B (nolock) ON A.PO_ID =B.PO_ID 
		join #tmpAc_code_build tmp on tmp.AC_CODE =b.ac_code
		JOIN
		(
		  SELECT PO_ID FROM PIM_POID_UPLOAD where sp_id=@CSP_ID
		  GROUP BY PO_ID
		) C ON A.PO_ID =C.PO_ID 
		WHERE (A.QUANTITY+ ROUND(A.QUANTITY *A.TOLERANCE_PERCENTAGE /100,0))-ISNULL(PI_QTY,0)>0
		AND B.CANCELLED=0

		DECLARE @CROW_ID VARCHAR(100),@UPD_PI_QTY NUMERIC(10,3)



		if exists (select top 1 'u' from #TMPPO_build where product_code <>'')
		begin
		     

			DELETE A FROM #TMPPO_build A
			LEFT JOIN #TMPPI_build B ON A.product_code  =B.PRODUCT_CODE  
			--and a.ac_code=b.ac_code 
			WHERE B.PRODUCT_CODE IS NULL


			WHILE EXISTS (SELECT TOP 1 'U' FROM #TMPPO_build)
			BEGIN

					SET @CROW_ID=''
					SELECT TOP 1 @CROW_ID=ROW_ID FROM #TMPPO_build ORDER BY PO_ID 



					IF OBJECT_ID('TEMPDB..#TMPPOPIBC_build','U') IS NOT NULL
					   DROP TABLE #TMPPOPIBC_build
					;WITH CTE AS
					(
					SELECT a.po_id, A.ROW_ID,A.PI_QTY  ,A.PENDING_QTY ,B.ROW_ID AS PI_ROW_ID,B.QUANTITY ,
					SR =ROW_NUMBER() OVER (PARTITION BY A.ROW_ID ORDER BY CASE WHEN A.PENDING_QTY =B.QUANTITY THEN 0 ELSE 1 END ,MRR_ID )
					FROM #TMPPO_build  A
					JOIN #TMPPI_build B ON A.product_code =B.PRODUCT_CODE 
					--and  a.ac_code=b.ac_code  
					WHERE A.ROW_ID=@CROW_ID
					)

					SELECT * INTO #TMPPOPIBC_build FROM CTE 



					IF OBJECT_ID('TEMPDB..#TMPUPDQTYBC_build','U') IS NOT NULL
					   DROP TABLE #TMPUPDQTYBC_build

					SELECT a.po_id, A.ROW_ID ,A.PI_QTY ,A.PENDING_QTY,A.PI_ROW_ID  ,A.SR,A.QUANTITY  ,SUM(B.QUANTITY) AS UPD_PI_QTY
					INTO #TMPUPDQTYBC_build
					FROM #TMPPOPIBC_build A
					JOIN #TMPPOPIBC_build B ON B.SR<=A.SR 
					GROUP BY a.po_id,A.ROW_ID ,A.PI_QTY ,A.PENDING_QTY ,A.SR,A.QUANTITY ,A.PI_ROW_ID
					HAVING A.PENDING_QTY>=SUM(B.QUANTITY)


					SET @UPD_PI_QTY=0
					SELECT @UPD_PI_QTY=MAX(UPD_PI_QTY) FROM #TMPUPDQTYBC_build

				

					IF ISNULL(@UPD_PI_QTY,0)>0
					UPDATE POD01106 SET PI_QTY =ISNULL(PI_QTY,0) +@UPD_PI_QTY WHERE ROW_ID=@CROW_ID

		

					UPDATE A SET PO_ROW_ID =B.ROW_ID,po_id=b.po_id  FROM PUR_pid01106_UPLOAD  A
					JOIN #TMPUPDQTYBC_build B ON A.ROW_ID =B.PI_ROW_ID
					where a.sp_id=@CSP_ID

			

					DELETE A FROM #TMPPI_build A
					JOIN #TMPUPDQTYBC_build B ON A.ROW_ID =B.PI_ROW_ID 

					DELETE FROM #TMPPO_build WHERE ROW_ID =@CROW_ID

					PRINT @CROW_ID
              END
		end
		else
		begin

	
			DELETE A FROM #TMPPO_build A
			LEFT JOIN #TMPPI_build B ON A.ARTICLE_CODE =B.ARTICLE_CODE AND A.PARA1_CODE =B.PARA1_CODE AND A.PARA2_CODE =B.PARA2_CODE 
			AND A.PARA3_CODE =B.PARA3_CODE AND A.PARA4_CODE =B.PARA4_CODE AND A.PARA5_CODE =B.PARA5_CODE 
			AND A.PARA6_CODE =B.PARA6_CODE 
			--and a.ac_code=b.ac_code 
			WHERE B.ARTICLE_CODE IS NULL


	
	
		
			WHILE EXISTS (SELECT TOP 1 'U' FROM #TMPPO_build)
			BEGIN

					SET @CROW_ID=''
					SELECT TOP 1 @CROW_ID=ROW_ID FROM #TMPPO_build ORDER BY PO_ID 



					IF OBJECT_ID('TEMPDB..#TMPPOPI_build','U') IS NOT NULL
					   DROP TABLE #TMPPOPI_build
					;WITH CTE AS
					(
					SELECT a.po_id, A.ROW_ID,A.PI_QTY  ,A.PENDING_QTY ,B.ROW_ID AS PI_ROW_ID,B.QUANTITY ,
					SR =ROW_NUMBER() OVER (PARTITION BY A.ROW_ID ORDER BY CASE WHEN A.PENDING_QTY =B.QUANTITY THEN 0 ELSE 1 END ,MRR_ID )
					FROM #TMPPO_build  A
					JOIN #TMPPI_build B ON A.ARTICLE_CODE =B.ARTICLE_CODE AND A.PARA1_CODE =B.PARA1_CODE AND A.PARA2_CODE =B.PARA2_CODE 
					AND A.PARA3_CODE =B.PARA3_CODE AND A.PARA4_CODE =B.PARA4_CODE AND A.PARA5_CODE =B.PARA5_CODE 
					AND A.PARA6_CODE =B.PARA6_CODE  AND A.PENDING_QTY >=B.QUANTITY 
					WHERE A.ROW_ID=@CROW_ID
					)

					SELECT * INTO #TMPPOPI_build FROM CTE 



					IF OBJECT_ID('TEMPDB..#TMPUPDQTY_build','U') IS NOT NULL
					   DROP TABLE #TMPUPDQTY_build

					SELECT a.po_id, A.ROW_ID ,A.PI_QTY ,A.PENDING_QTY,A.PI_ROW_ID  ,A.SR,A.QUANTITY  ,SUM(B.QUANTITY) AS UPD_PI_QTY
					INTO #TMPUPDQTY_build
					FROM #TMPPOPI_build A
					JOIN #TMPPOPI_build B ON B.SR<=A.SR 
					GROUP BY a.po_id, A.ROW_ID ,A.PI_QTY ,A.PENDING_QTY ,A.SR,A.QUANTITY ,A.PI_ROW_ID
					HAVING A.PENDING_QTY>=SUM(B.QUANTITY)

					SET @UPD_PI_QTY=0
					SELECT @UPD_PI_QTY=MAX(UPD_PI_QTY) FROM #TMPUPDQTY_build

				

					IF ISNULL(@UPD_PI_QTY,0)>0
					UPDATE POD01106 SET PI_QTY =ISNULL(PI_QTY,0) +@UPD_PI_QTY WHERE ROW_ID=@CROW_ID

		

					UPDATE A SET PO_ROW_ID =B.ROW_ID,po_id=b.po_id  FROM PUR_pid01106_UPLOAD  A
					JOIN #TMPUPDQTY_build B ON A.ROW_ID =B.PI_ROW_ID
					where a.sp_id=@CSP_ID

			

					DELETE A FROM #TMPPI_build A
					JOIN #TMPUPDQTY_build B ON A.ROW_ID =B.PI_ROW_ID 

					DELETE FROM #TMPPO_build WHERE ROW_ID =@CROW_ID

					PRINT @CROW_ID

			

		END 

	END
		
		
 


	  IF EXISTS (SELECT TOP 1 'U' FROM PUR_PID01106_UPLOAD  (nolock) WHERE sp_id=@CSP_ID AND ISNULL(PO_ROW_ID  ,'')='')
	  BEGIN
	       set @CERRMSG='Pending Purchase order not found Please check'

		     SELECT  LEFT(a.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',a.PRODUCT_CODE)-1,-1),LEN(a.PRODUCT_CODE )))  as product_code, 
			 art.article_no ,para1_name ,para2_name ,para3_name ,para4_name ,para5_name ,para6_name ,a.quantity ,'Po Qty Not Found for this Item' as ERRMSG
			  FROM PUR_PID01106_UPLOAD A (NOLOCK)
			  JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE
			  JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =A.PARA1_CODE
			  JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =A.PARA2_CODE
			  JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE =A.PARA3_CODE
			  JOIN PARA4 P4 (NOLOCK) ON P4.PARA4_CODE =A.PARA4_CODE
			  JOIN PARA5 P5 (NOLOCK) ON P5.PARA5_CODE =A.PARA5_CODE
			  JOIN PARA6 P6 (NOLOCK) ON P6.PARA6_CODE =A.PARA6_CODE
			  where  ISNULL(PO_ROW_ID  ,'')='' AND SP_ID=@CSP_ID


		   goto END_PROC

	  END
  

  END_PROC:
 
 END



