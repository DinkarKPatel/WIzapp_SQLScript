

IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_CMD01106_WTDAVGDISC' AND VALUE=1)
BEGIN
	PRINT 'UPDATING WEIGHTED AVG DISCOUNT INFORMATION IN RETAIL SALES'
	
	DECLARE @CCMID VARCHAR(50)
	
	IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_CMD01106_WTDAVGDISC')
		INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
			   VALUES ('UPDATE_CMD01106_WTDAVGDISC',1,'',GETDATE())	
	ELSE
		UPDATE CONFIG SET VALUE=1 WHERE CONFIG_OPTION='UPDATE_CMD01106_WTDAVGDISC'
		

	IF CURSOR_STATUS('GLOBAL','CALCMDWTDDISCCUR') IN (0,1)
	BEGIN
		CLOSE CALCMDWTDDISCCUR
		DEALLOCATE CALCMDWTDDISCCUR
	END
	
	DECLARE CALCMDWTDDISCCUR CURSOR FOR SELECT CM_ID FROM CMM01106 WHERE CM_ID IN 
	(SELECT CM_ID FROM CMD01106 A	
	 JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID 
	 WHERE B.SCHEME_ID<>'' AND A.DISCOUNT_PERCENTAGE=100)
	
	OPEN CALCMDWTDDISCCUR
	FETCH NEXT FROM CALCMDWTDDISCCUR INTO @CCMID
	WHILE @@FETCH_STATUS=0
	BEGIN
		EXEC SP_UPDATE_SLSWTDAVGDISC @CCMID
		 	
		FETCH NEXT FROM CALCMDWTDDISCCUR INTO @CCMID
	END
	
	CLOSE CALCMDWTDDISCCUR
	DEALLOCATE CALCMDWTDDISCCUR 
END
