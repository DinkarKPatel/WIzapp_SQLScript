CREATE PROCEDURE UPDATERFNET_PRD
		@CXNTYPE VARCHAR(10),
		@CXNID VARCHAR(40) = '',
		@NSPID INT = 0

		--*** PARAMETERS :
		--*** @CXNTYPE	- TRANSACTION TYPE (MODULE SPECIFIC)
		--*** @CXNID	- TRANSACTION ID ( MEMO ID OF MASTER TABLE )
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CCMD NVARCHAR(4000), 
			@CMEMOID VARCHAR(40), 
			@NSUBTOTAL NUMERIC(14,2),
			@NSUMRFNET NUMERIC(14,2),
			@NSUMRFNETWT NUMERIC(14,2),
			@NTAX NUMERIC(14,2),
			@NINCLTAX NUMERIC(10,2),
			@CROWID VARCHAR(40)

	
	--*** UPDATION OF RFNET FOR PUR
	IF @CXNTYPE IN ('PUR')		-- PURCHASE INVOICE
	BEGIN
		IF @CXNID <> ''
			DECLARE ABC CURSOR FOR SELECT MRR_ID, (TOTAL_AMOUNT) FROM PRD_PIM01106 WHERE MRR_ID = @CXNID 
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR SELECT MRR_ID, (TOTAL_AMOUNT) FROM PRD_PIM01106
				WHERE MRR_ID IN ( SELECT XN_ID FROM XNNOS WHERE XN_TYPE = 'PUR' AND SP_ID = @NSPID )
			ELSE
				DECLARE ABC CURSOR FOR SELECT DISTINCT A.MRR_ID, (B.TOTAL_AMOUNT) FROM PRD_PID01106 A
				JOIN PRD_PIM01106 B ON A.MRR_ID=B.MRR_ID WHERE A.PURCHASE_PRICE<>0 AND ( A.RFNET IS NULL OR A.RFNET = 0 OR A.RFNET_WOTAX IS NULL OR A.RFNET_WOTAX=0) 
		END

		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		WHILE @@FETCH_STATUS = 0
		BEGIN
			PRINT 'UPDATING RFNET FOR MRR ID : '+@CMEMOID
			
			SELECT TOP 1 @CROWID = ROW_ID FROM PRD_PID01106 WHERE MRR_ID = @CMEMOID

			UPDATE PRD_PID01106 SET RFNET =
			DBO.FN_GETRFNETVALUE( A.PURCHASE_PRICE, A.INVOICE_QUANTITY, B.SUBTOTAL,
			( D.TAX_AMOUNT +B.FREIGHT + B.OTHER_CHARGES + B.ROUND_OFF - B.DISCOUNT_AMOUNT))
			FROM PRD_PID01106 A
			JOIN PRD_PIM01106 B ON A.MRR_ID = B.MRR_ID
			JOIN PRD_SKU C ON C.PRODUCT_UID=A.PRODUCT_UID
			JOIN (SELECT SUM(TAX_AMOUNT) AS TAX_AMOUNT FROM PRD_PID01106 WHERE MRR_ID = @CMEMOID) D ON 1=1			
			WHERE B.MRR_ID = @CMEMOID

			SELECT @NSUMRFNET = SUM(RFNET), @NSUMRFNETWT = SUM(RFNET_WOTAX)
			FROM PRD_PID01106 A WHERE A.MRR_ID = @CMEMOID
			

			SELECT @NTAX=(CASE WHEN POST_TAX_SEPARATELY=0 THEN 0 ELSE A.TAX_AMOUNT END)
			FROM PRD_PIM01106  A JOIN FORM B ON B.FORM_ID=A.FORM_ID	
			WHERE MRR_ID = @CMEMOID		
			
			IF @NSUMRFNET <> @NSUBTOTAL
				UPDATE PRD_PID01106 SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE MRR_ID = @CMEMOID AND ROW_ID = @CROWID

			--IF @NSUMRFNETWT <> ( @NSUBTOTAL - @NTAX )
			--BEGIN
			--	UPDATE PID01106 SET RFNET_WOTAX = RFNET_WOTAX + ( @NSUBTOTAL - @NTAX - @NSUMRFNETWT ) 
			--	WHERE MRR_ID = @CMEMOID AND ROW_ID = @CROWID
			--END

			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		END
		CLOSE ABC
		DEALLOCATE ABC
	END				-- END OF PUR
		
	ELSE
	--*** UPDATION OF RFNET FOR PURCHASE RETURN
	IF @CXNTYPE IN ('PRT')	
	BEGIN
		IF @CXNID <> ''
			DECLARE ABC CURSOR FOR SELECT RM_ID, (TOTAL_AMOUNT) FROM PRD_RMM01106 WHERE RM_ID = @CXNID 
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR SELECT RM_ID, (TOTAL_AMOUNT) FROM PRD_RMM01106
				WHERE RM_ID IN ( SELECT XN_ID FROM XNNOS WHERE XN_TYPE = 'PRT' AND SP_ID = @NSPID )
			ELSE
				DECLARE ABC CURSOR 
				FOR 
				SELECT DISTINCT A.RM_ID, (B.TOTAL_AMOUNT) 
				FROM PRD_RMD01106 A
				JOIN PRD_RMM01106 B ON A.RM_ID=B.RM_ID 
				WHERE A.PURCHASE_PRICE<>0 
				AND ( A.RFNET IS NULL OR A.RFNET = 0 )--OR A.RFNET_WOTAX IS NULL OR A.RFNET_WOTAX=0) 
		END

		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SELECT TOP 1 @CROWID = ROW_ID FROM PRD_RMD01106 WHERE RM_ID = @CMEMOID
			
			SELECT @NTAX=SUM(ITEM_TAX_AMOUNT) FROM PRD_RMD01106 WHERE RM_ID=@CMEMOID

			UPDATE PRD_RMD01106 SET RFNET =
			DBO.FN_GETRFNETVALUE( A.PURCHASE_PRICE, A.QUANTITY, B.SUBTOTAL,
			( ISNULL(@NTAX,0) + B.FREIGHT + B.OTHER_CHARGES + B.ROUND_OFF - B.DISCOUNT_AMOUNT ))
			--,
			--RFNET_WOTAX = DBO.FN_GETRFNETVALUE( A.PURCHASE_PRICE, A.QUANTITY, B.SUBTOTAL,
			--( B.FREIGHT + B.OTHER_CHARGES + B.ROUND_OFF - B.DISCOUNT_AMOUNT ))  
			FROM PRD_RMD01106 A
			JOIN PRD_RMM01106 B ON A.RM_ID = B.RM_ID
			JOIN PRD_SKU C ON C.PRODUCT_UID=A.PRODUCT_UID
			JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE
			JOIN UOM D ON D.UOM_CODE=ART.UOM_CODE
			WHERE B.RM_ID = @CMEMOID

			SELECT @NSUMRFNET = SUM(RFNET) FROM PRD_RMD01106 WHERE RM_ID = @CMEMOID
				--, @NSUMRFNETWT = SUM(RFNET_WOTAX)
			IF @NSUMRFNET <> @NSUBTOTAL
				UPDATE PRD_RMD01106 SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE RM_ID = @CMEMOID AND ROW_ID = @CROWID

			--IF @NSUMRFNETWT <> ( @NSUBTOTAL - @NTAX )
			--	UPDATE RMD01106 SET RFNET_WOTAX = RFNET_WOTAX + ( @NSUBTOTAL - @NTAX - @NSUMRFNETWT ) 
			--	WHERE RM_ID = @CMEMOID AND ROW_ID = @CROWID


			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		END
		CLOSE ABC
		DEALLOCATE ABC  -- END OF PURCHASE RETURN
	END					

	
	ELSE
	--*** UPDATION OF RFNET FOR WHOLESALE INVOICE
	--*** UPDATION OF RFNET FOR WHOLESALE INVOICE
	IF @CXNTYPE IN ('WSL')	
	BEGIN
		PRINT 'UPDRFNET-1'
		IF @CXNID <> ''
			DECLARE ABC CURSOR FOR SELECT A.INV_ID, NET_AMOUNT 
			FROM PRD_INM01106 A WHERE A.INV_ID = @CXNID 
			
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR SELECT A.INV_ID, NET_AMOUNT  FROM PRD_INM01106 A
				WHERE A.INV_ID IN ( SELECT XN_ID FROM XNNOS WHERE XN_TYPE = 'WSI' AND SP_ID = @NSPID ) 
			ELSE
				DECLARE ABC CURSOR FOR SELECT DISTINCT A.INV_ID,NET_AMOUNT
				FROM PRD_INM01106 A
				WHERE INV_ID IN (SELECT INV_ID FROM PRD_IND01106 A WHERE A.RATE<>0 AND ( A.RFNET IS NULL 
								 OR A.RFNET = 0 OR A.RFNET_WOTAX IS NULL OR A.RFNET_WOTAX=0))
		END
		
		PRINT 'UPDRFNET-2'
		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		WHILE @@FETCH_STATUS = 0
		BEGIN
			PRINT 'UPDRFNET-3'
			SELECT TOP 1 @CROWID = ROW_ID FROM PRD_IND01106 WHERE INV_ID = @CMEMOID

			PRINT 'UPDRFNET-4'
			
			SELECT @NTAX=0,@NINCLTAX=0
			
			SELECT @NTAX=SUM(ITEM_TAX_AMOUNT) FROM PRD_IND01106 A (NOLOCK) 
			JOIN PRD_INM01106 B (NOLOCK) ON A.INV_ID=B.INV_ID WHERE B.INV_ID=@CMEMOID 
			AND BILL_LEVEL_TAX_METHOD=1

			SELECT @NINCLTAX=SUM(ITEM_TAX_AMOUNT) FROM PRD_IND01106 A (NOLOCK) 
			JOIN PRD_INM01106 B (NOLOCK) ON A.INV_ID=B.INV_ID WHERE B.INV_ID=@CMEMOID 
			AND BILL_LEVEL_TAX_METHOD=2
						
			
			UPDATE PRD_IND01106 SET RFNET =
				DBO.FN_GETRFNETVALUE( A.RATE, A.QUANTITY, B.SUBTOTAL, ( ISNULL(@NTAX,0) + B.FREIGHT + B.OTHER_CHARGES + B.ROUND_OFF - B.DISCOUNT_AMOUNT )),
				RFNET_WOTAX =
				DBO.FN_GETRFNETVALUE( A.RATE, A.QUANTITY, B.SUBTOTAL-ISNULL(@NINCLTAX,0) , (B.FREIGHT + B.OTHER_CHARGES + B.ROUND_OFF - B.DISCOUNT_AMOUNT ))				
			FROM PRD_IND01106 A
			JOIN PRD_INM01106 B ON A.INV_ID = B.INV_ID
			WHERE B.INV_ID = @CMEMOID
			
			PRINT 'UPDRFNET-5'
			
			--SELECT SUM(RFNET),  SUM(RFNET_WOTAX) FROM IND01106 WHERE INV_ID = @CMEMOID
			SELECT @NSUMRFNET = SUM(RFNET), @NSUMRFNETWT = SUM(RFNET_WOTAX) FROM PRD_IND01106 WHERE INV_ID = @CMEMOID
				
			IF @NSUMRFNET <> @NSUBTOTAL
			BEGIN
				PRINT 'UPDRFNET-6'
				UPDATE PRD_IND01106 SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE INV_ID = @CMEMOID AND ROW_ID = @CROWID
			END
			IF @NSUMRFNETWT <> ( @NSUBTOTAL - @NTAX )
			BEGIN
				PRINT 'UPDRFNET-7'
				UPDATE PRD_IND01106 SET RFNET_WOTAX = RFNET_WOTAX + ( @NSUBTOTAL - @NTAX - @NSUMRFNETWT ) 
				WHERE INV_ID = @CMEMOID AND ROW_ID = @CROWID
			END
			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		END
		CLOSE ABC
		DEALLOCATE ABC
	END					-- END OF WHOLESALE INVOICE

	ELSE
	--*** UPDATION OF RFNET FOR WHOLESALE RETURN (CREDIT NOTE)
	IF @CXNTYPE IN ('WSR')
	BEGIN
		IF @CXNID <> ''
			DECLARE ABC CURSOR FOR SELECT CN_ID, TOTAL_AMOUNT FROM PRD_CNM01106 WHERE CN_ID = @CXNID 
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR SELECT CN_ID, TOTAL_AMOUNT FROM CNM01106
				WHERE CN_ID IN ( SELECT XN_ID FROM XNNOS WHERE XN_TYPE = 'WSR' AND SP_ID = @NSPID )
			ELSE
				DECLARE ABC CURSOR FOR SELECT DISTINCT A.CN_ID, B.TOTAL_AMOUNT FROM PRD_CND01106 A
				JOIN PRD_CNM01106 B ON A.CN_ID=B.CN_ID WHERE A.RATE<>0 AND ( A.RFNET IS NULL OR A.RFNET = 0 OR A.RFNET_WOTAX IS NULL OR A.RFNET_WOTAX=0) 
		END
		
		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SELECT TOP 1 @CROWID = ROW_ID FROM PRD_CND01106 WHERE CN_ID = @CMEMOID
			
			
			SELECT @NTAX=0,@NINCLTAX=0
			
			SELECT @NTAX=SUM(ITEM_TAX_AMOUNT) FROM PRD_CND01106 A (NOLOCK) 
			JOIN PRD_CNM01106 B (NOLOCK) ON A.CN_ID=B.CN_ID WHERE B.CN_ID=@CMEMOID 
			AND BILL_LEVEL_TAX_METHOD=1

			SELECT @NINCLTAX=SUM(ITEM_TAX_AMOUNT) FROM PRD_CND01106 A (NOLOCK) 
			JOIN PRD_CNM01106 B (NOLOCK) ON A.CN_ID=B.CN_ID WHERE B.CN_ID=@CMEMOID 
			AND BILL_LEVEL_TAX_METHOD=2
			
			UPDATE PRD_CND01106 SET RFNET =
			DBO.FN_GETRFNETVALUE( A.NET_RATE, A.QUANTITY, B.SUBTOTAL, ( ISNULL(@NTAX,0) + B.FREIGHT + B.OTHER_CHARGES + B.ROUND_OFF - B.DISCOUNT_AMOUNT )) ,
			RFNET_WOTAX = DBO.FN_GETRFNETVALUE( A.NET_RATE, A.QUANTITY, B.SUBTOTAL-ISNULL(@NINCLTAX,0), ( B.FREIGHT + B.OTHER_CHARGES + B.ROUND_OFF - B.DISCOUNT_AMOUNT )) 
			FROM PRD_CND01106 A
			JOIN PRD_CNM01106 B ON A.CN_ID = B.CN_ID
			JOIN PRD_SKU C ON C.PRODUCT_UID=A.PRODUCT_UID
			WHERE B.CN_ID = @CMEMOID
		
			SELECT @NSUMRFNET = SUM(RFNET), @NSUMRFNETWT = SUM(RFNET_WOTAX) FROM PRD_CND01106 WHERE CN_ID = @CMEMOID

			IF @NSUMRFNET <> @NSUBTOTAL
				UPDATE PRD_CND01106 SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE CN_ID = @CMEMOID AND ROW_ID = @CROWID

			IF @NSUMRFNETWT <> ( @NSUBTOTAL - @NTAX )
				UPDATE PRD_CND01106 SET RFNET_WOTAX = RFNET_WOTAX + ( @NSUBTOTAL - @NTAX - @NSUMRFNETWT ) 
				WHERE CN_ID = @CMEMOID AND ROW_ID = @CROWID

			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		END
		CLOSE ABC
		DEALLOCATE ABC
	END					-- END OF WHOLESALE RETURN (CREDIT NOTE)
	
END
