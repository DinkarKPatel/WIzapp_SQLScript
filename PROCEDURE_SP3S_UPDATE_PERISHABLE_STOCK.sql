CREATE PROCEDURE SP3S_UPDATE_PERISHABLE_STOCK
(
 @NSPID INT
)   
AS
BEGIN
         
          DECLARE @DTSQL NVARCHAR(MAX),@NBATCH_PURCHASE_PRICE VARCHAR(10),
          @NBATCH_MRP VARCHAR(10),@NBATCH_WSP VARCHAR(10),
          @CPURCHASE_PRICE VARCHAR(100),
          @CMRP VARCHAR(100),@CWSP VARCHAR(100),@CGROUPCOLUMN VARCHAR(100)
          
          SET @CGROUPCOLUMN=''
          
          SELECT TOP 1 @NBATCH_WSP=VALUE FROM CONFIG WHERE CONFIG_OPTION ='CONSIDER_FOR_AUTO_BATCH_WSP'
          SELECT TOP 1 @NBATCH_PURCHASE_PRICE=VALUE FROM CONFIG WHERE CONFIG_OPTION  ='CONSIDER_FOR_AUTO_BATCH_pp'
          
          --IF ISNULL(@NBATCH_MRP,'')='1'
          --BEGIN
            
          --END  
          --ELSE
          --   SET @CMRP=' 0 AS MRP'
          
        
          
          
		  PRINT 'FILTER PERISHABLE BARCODE '
		 
		  IF OBJECT_ID('TEMPDB..#TMPPERISHABLE_STOCK','U') IS NOT NULL
			 DROP TABLE #TMPPERISHABLE_STOCK
			 
		 SELECT A.ROW_ID,B.PRODUCT_CODE AS ORG_PRODUCT_CODE,
		 A.PRODUCT_CODE AS PRODUCT_CODE,
		 B.DEPT_ID,B.BIN_ID ,
		 B.QUANTITY_IN_STOCK AS QUANTITY_IN_STOCK,
		 isnull(SKU.BATCH_NO,'') as BATCH_NO,isnull(SKU.EXPIRY_DT,'') as EXPIRY_DT,
		 SKU.MRP,SKU.ws_price ,
		 ISNULL(A.PERISHABLE,0) AS PERISHABLE,
		 CAST(0 AS BIT ) AS SHOW_BATCH_COLUMNS 
		 INTO #TMPPERISHABLE_STOCK
		 FROM #TMPFIXCODE A
		 JOIN PMT01106 B (NOLOCK) ON A.PRODUCT_CODE =CASE WHEN CHARINDEX('@',B.PRODUCT_CODE)=0 THEN B.PRODUCT_CODE 
		                             ELSE SUBSTRING (B.PRODUCT_CODE,1, CHARINDEX('@',B.PRODUCT_CODE)-1) END
		                             and A.DEPT_ID=B.DEPT_ID 
		 JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =B.PRODUCT_CODE 
		 join bin (nolock) on bin.bin_id =b.bin_id 
		 WHERE QUANTITY_IN_STOCK >0  AND ISNULL(BIN.stk_available_trn,0)=1   
		 --AND CHARINDEX('@',B.PRODUCT_CODE)<>0
		 
	    

	
	  PRINT 'HOLD PERISHABLE BARCODE '
	    
	  
	  --  SELECT *   INTO TMPPERISHABLE_STOCK FROM   #TMPPERISHABLE_STOCK
	  
	  SET @DTSQL=N' UPDATE  #TMPPERISHABLE_STOCK 
	  SET SHOW_BATCH_COLUMNS=1 ,
	  PRODUCT_CODE=ORG_PRODUCT_CODE 
	  WHERE PRODUCT_CODE IN
	  (
	   SELECT PRODUCT_CODE  FROM
	   (
	   SELECT PRODUCT_CODE ,EXPIRY_DT ,BATCH_NO,MRP ,ws_price
	   FROM #TMPPERISHABLE_STOCK
	   GROUP BY PRODUCT_CODE ,EXPIRY_DT ,BATCH_NO ,MRP,ws_price
	   ) A
	   GROUP BY PRODUCT_CODE
	   HAVING COUNT(*)>1
	   )'
	   PRINT @DTSQL
	   EXEC SP_EXECUTESQL @DTSQL



	   IF OBJECT_ID ('TEMPDB..#TMPFINAL_STOCK','U') IS NOT NULL
            DROP TABLE #TMPFINAL_STOCK
	 
	   SELECT A.ROW_ID, 
	          A.PRODUCT_CODE AS PRODUCT_CODE,
	          A.DEPT_ID,A.BIN_ID ,A.MRP,A.ws_price,
		      SUM(A.QUANTITY_IN_STOCK)  AS QUANTITY_IN_STOCK,
		      A.BATCH_NO,A.EXPIRY_DT,
		      ISNULL(A.PERISHABLE,0) AS PERISHABLE,
		     A. SHOW_BATCH_COLUMNS 
	
	   INTO #TMPFINAL_STOCK
	   FROM #TMPPERISHABLE_STOCK A
	  -- WHERE (A.SHOW_BATCH_COLUMNS =1 OR A.PERISHABLE =1)
	   GROUP BY A.ROW_ID, A.PRODUCT_CODE,
	   A.DEPT_ID,A.BIN_ID ,A.MRP,A.BATCH_NO,A.EXPIRY_DT,ISNULL(A.PERISHABLE,0) ,A. SHOW_BATCH_COLUMNS ,A.ws_price
	  
	  
	  
	
		 IF OBJECT_ID ('TEMPDB..#TMPWSL_ITEM','U') IS NOT NULL
            DROP TABLE #TMPWSL_ITEM

         SELECT A.*,
         B.PRODUCT_CODE AS NEW_PRODUCT_CODE,
         B.BIN_ID AS NEW_BIN_ID,
         B.MRP AS NEW_MRP,
		 B.QUANTITY_IN_STOCK AS NEW_QUANTITY_IN_STOCK,
		 B.BATCH_NO AS NEW_BATCH_NO,B.EXPIRY_DT AS NEW_EXPIRY_DT,
		 B.PERISHABLE,
		 B.SHOW_BATCH_COLUMNS AS NEW_SHOW_BATCH_COLUMNS,
		 a.PURCHASE_PRICE as NEW_PURCHASE_PRICE ,B.ws_price as new_ws_price
         INTO #TMPWSL_ITEM
		 FROM WSL_ITEM_DETAILS A 
		 JOIN #TMPFINAL_STOCK B ON A.ROW_ID =B.ROW_ID 
		 join sku s (nolock) on s.PRODUCT_CODE=b.PRODUCT_CODE
		 WHERE  SP_ID=@NSPID  

	
	
		 PRINT 'AFTER PROCESS INSERT BARCODE '
		 
		 IF EXISTS(SELECT TOP 1 'U' FROM #TMPWSL_ITEM)
         BEGIN

			 DELETE A FROM WSL_ITEM_DETAILS A
			 JOIN #TMPWSL_ITEM B ON A.ROW_ID =B.ROW_ID 
			 WHERE A.SP_ID =@NSPID
			
			
		
			 INSERT WSL_ITEM_DETAILS	( GROSS_RATE, MARGIN_PERCENTAGE, MARGIN_AMOUNT, AMOUNT, MANUAL_RATE, MANUAL_NET_RATE, MANUAL_DISCOUNT, PS_ID, AUTO_SRNO, ROW_ID, SP_ID, ITEM_CATEGORY, BRAND, HSN_CODE, GST_PERCENTAGE, IGST_AMOUNT, CGST_AMOUNT, SGST_AMOUNT, XN_VALUE_WITHOUT_GST, XN_VALUE_WITH_GST, ORDER_NO, ONLINE_BILL_REF_NO, ITEM_ROUND_OFF, PRODUCT_CODE, ARTICLE_CODE, ARTICLE_NO, ARTICLE_NAME, PARA1_CODE, PARA1_NAME, PARA2_CODE, PARA2_NAME, PARA3_CODE, PARA3_NAME, UOM_NAME, DEPT_ID, CODING_SCHEME, INACTIVE, QUANTITY_IN_STOCK, PURCHASE_PRICE, SCHEME_ID, SECTION_NAME, SECTION_CODE, SUB_SECTION_CODE, SUB_SECTION_NAME, PARA4_CODE, PARA5_CODE, PARA6_CODE, PARA4_NAME, PARA5_NAME, PARA6_NAME, UOM_CODE, UOM_TYPE, ART_DT_CREATED, PARA3_DT_CREATED, SKU_DT_CREATED, STOCK_NA, EAN, ITEM_FORM_ID, FORM_NAME, PRODUCT_NAME, ER_FLAG, FIX_MRP, INV_DT, RECEIPT_DT, ARTICLE_ALIAS, BIN_ID, BIN_NAME, WIP_UID, LANDED_COST, ONLINE_BAR_CODE, VENDOR_EAN_NO, ERRMSG, RATE, DISCOUNT_PERCENTAGE, DISCOUNT_AMOUNT, OCTROI_PERCENTAGE, OCTROI_AMOUNT, NET_RATE, ITEM_TAX_AMOUNT, TAX_STATUS, ITEM_TAX_PERCENTAGE, INV_TAX_STATUS, TAX_METHOD, FORM_TAX_PERCENTAGE, ITEM_EXCISE_MRP, ITEM_EXCISE_ACCESSIBLE_PERCENTAGE, ITEM_EXCISE_ACCESSIBLE_AMOUNT, ITEM_EXCISE_DUTY_PERCENTAGE, ITEM_EXCISE_DUTY_AMOUNT, ITEM_EXCISE_EDU_CESS_PERCENTAGE, ITEM_EXCISE_EDU_CESS_AMOUNT, ITEM_EXCISE_HEDU_CESS_PERCENTAGE, ITEM_EXCISE_HEDU_CESS_AMOUNT, INVOICE_QUANTITY, SCHEME_QUANTITY, QUANTITY, OLD_QUANTITY, ITEM_EXCISE_MRPVAL, BASEAMOUNT_FOR_TAX, EXCISABLE, MRP, WS_PRICE, GIVE_CREDIT_VAT, CREDIT_VAT_PERCENTAGE, PARTY_RATE_BASE_PRICE, PARTY_RATE_CAL_MODE, PARTY_RATE_GIVE_CREDIT_VAT, VATPAIDONMRP, PARTY_FINAL_MARGIN, MANUAL_RATE_CHANGED, CREDIT_VAT_AMOUNT, CHARGE_TAX_PCT, CREDIT_CENTRAL_TAX_PCT, CREDIT_PURCHASE_TAX_PCT, BOX_NO, BOX_DT, BOX_ID,BATCH_NO,EXPIRY_DT,SHOW_BATCH_COLUMNS,DONOT_UPDATE_MRP )  
			  SELECT 	  GROSS_RATE, MARGIN_PERCENTAGE, MARGIN_AMOUNT, AMOUNT, MANUAL_RATE, MANUAL_NET_RATE, 
			  MANUAL_DISCOUNT, PS_ID, AUTO_SRNO, ROW_ID, SP_ID, ITEM_CATEGORY, BRAND, HSN_CODE, GST_PERCENTAGE, 
			  IGST_AMOUNT, CGST_AMOUNT, SGST_AMOUNT, XN_VALUE_WITHOUT_GST, XN_VALUE_WITH_GST, ORDER_NO, 
			  ONLINE_BILL_REF_NO, ITEM_ROUND_OFF, A.NEW_PRODUCT_CODE AS PRODUCT_CODE, ARTICLE_CODE, ARTICLE_NO, ARTICLE_NAME, PARA1_CODE, PARA1_NAME, 
			  PARA2_CODE, PARA2_NAME, PARA3_CODE, PARA3_NAME, UOM_NAME, DEPT_ID, CODING_SCHEME, 
			  INACTIVE,A.NEW_QUANTITY_IN_STOCK AS QUANTITY_IN_STOCK,A.NEW_PURCHASE_PRICE, SCHEME_ID, SECTION_NAME, SECTION_CODE, SUB_SECTION_CODE, 
			  SUB_SECTION_NAME, PARA4_CODE, PARA5_CODE, PARA6_CODE, PARA4_NAME, PARA5_NAME, PARA6_NAME, UOM_CODE, UOM_TYPE, 
			  ART_DT_CREATED, PARA3_DT_CREATED, SKU_DT_CREATED, STOCK_NA, EAN, ITEM_FORM_ID, FORM_NAME, PRODUCT_NAME, ER_FLAG,
			  FIX_MRP, INV_DT, RECEIPT_DT, ARTICLE_ALIAS,A.NEW_BIN_ID  AS  BIN_ID, BIN_NAME, WIP_UID, LANDED_COST, ONLINE_BAR_CODE, VENDOR_EAN_NO,
			  ERRMSG, RATE, DISCOUNT_PERCENTAGE, DISCOUNT_AMOUNT, OCTROI_PERCENTAGE, OCTROI_AMOUNT, NET_RATE, ITEM_TAX_AMOUNT, 
			  TAX_STATUS, ITEM_TAX_PERCENTAGE, INV_TAX_STATUS, TAX_METHOD, FORM_TAX_PERCENTAGE, ITEM_EXCISE_MRP, 
			  ITEM_EXCISE_ACCESSIBLE_PERCENTAGE, ITEM_EXCISE_ACCESSIBLE_AMOUNT, ITEM_EXCISE_DUTY_PERCENTAGE, 
			  ITEM_EXCISE_DUTY_AMOUNT, ITEM_EXCISE_EDU_CESS_PERCENTAGE, ITEM_EXCISE_EDU_CESS_AMOUNT, 
			  ITEM_EXCISE_HEDU_CESS_PERCENTAGE, ITEM_EXCISE_HEDU_CESS_AMOUNT, 
			  A.INVOICE_QUANTITY  AS INVOICE_QUANTITY, 
			  A.SCHEME_QUANTITY, 
			  A.QUANTITY   AS  QUANTITY,
			  OLD_QUANTITY, 
			  ITEM_EXCISE_MRPVAL, BASEAMOUNT_FOR_TAX, EXCISABLE,A.NEW_MRP AS  MRP,A.NEW_WS_PRICE AS WS_PRICE, GIVE_CREDIT_VAT, CREDIT_VAT_PERCENTAGE, 
			  PARTY_RATE_BASE_PRICE, PARTY_RATE_CAL_MODE, PARTY_RATE_GIVE_CREDIT_VAT, VATPAIDONMRP, PARTY_FINAL_MARGIN, 
			  MANUAL_RATE_CHANGED, CREDIT_VAT_AMOUNT, CHARGE_TAX_PCT, CREDIT_CENTRAL_TAX_PCT, CREDIT_PURCHASE_TAX_PCT, 
			  BOX_NO, BOX_DT, BOX_ID ,NEW_BATCH_NO AS BATCH_NO,NEW_EXPIRY_DT AS EXPIRY_DT,NEW_SHOW_BATCH_COLUMNS,
			  1 AS DONOT_UPDATE_MRP
			  FROM #TMPWSL_ITEM A
			 
        END
        
--        SELECT A.NEW_MRP AS  MRP FROM #TMPWSL_ITEM A
--SELECT PRODUCT_CODE,MRP,QUANTITY_IN_STOCK, * FROM WSL_ITEM_DETAILS WHERE SP_ID= @NSPID
			

END


