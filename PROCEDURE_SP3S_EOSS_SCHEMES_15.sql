CREATE PROCEDURE SP3S_EOSS_SCHEMES_15
(
	@CSCHEMEDETROWID VARCHAR(50),
	@CSLSTITLE VARCHAR(500),
	@CROUNDITEMLEVEL VARCHAR(5),
	@CJOINSTRBUY VARCHAR(MAX),
	@CJOINSTRGET VARCHAR(MAX),
	@CPICKSLRDISCMODE VARCHAR(5),
	@NSPID VARCHAR(40),
	@CERRMSG VARCHAR(MAX) OUTPUT
)
AS 
BEGIN
	PRINT 'ENTER SP3S_EOSS_SCHEMES_15 FOR SCHEME NAME:'+@CSLSTITLE
	
	DECLARE @NORGBUYAMT NUMERIC(10,2),@NBUYAMT NUMERIC(10,2),@NGETAMT NUMERIC(10,2),@NREQGETAMT NUMERIC(10,2),
			@CPRODUCTCODE VARCHAR(50),@NMRP NUMERIC(20,4),@NQTY NUMERIC(10,2),@NBUYMODE NUMERIC(1,0),@NGETMODE NUMERIC(1,0),
			@CCMDROWID VARCHAR(50),@NLOOPCNT NUMERIC(10,2),@NMODE INT,@BQUALIFIED BIT,
			@CROWID VARCHAR(100),@NSTEP NUMERIC(10,2),@NAMT NUMERIC(10,2),@NADDNLBUYMODE NUMERIC(1,0),
			@CMRPORDER VARCHAR(10),@NREQBUYAMT NUMERIC(10,2),@BRETRY2NDCASE BIT,@BAPPLYSCHEMESRNOWISE BIT,
			@CCMD NVARCHAR(MAX),@CBUYFILTER VARCHAR(MAX),@CGETFILTER VARCHAR(MAX),
			@CADDFILTER VARCHAR(MAX),@CORGADDFILTER VARCHAR(MAX),@NDISCMODE INT,@BLOOP BIT,
			@NBUYFILTERMODE INT,@BPROCESSSLRENTRY BIT,@NGETFILTERMODE INT,@NTRIAL INT,@NAPPLYMODE NUMERIC(1,0),
			@NDISCAMT NUMERIC(10,2),@BDONOTAPPLYSCHEMEONDISCITEMS BIT,@BBUYQUALIFIED BIT,@NMINMRP NUMERIC(10,2),@NCURQTY NUMERIC(10,2),
			@NADDBUYFILTERMODE NUMERIC(1,0),@NADDGETFILTERMODE NUMERIC(1,0),@CADDBUYFILTER VARCHAR(MAX),@BAPPLYADDBUYFILTERRESTRICTION BIT,
			@NADDBUYBASEVALUE NUMERIC(10,0),@NREQBUYQTY NUMERIC(10,0),@NREQGETQTY NUMERIC(4,0),@NREQBUY2QTY NUMERIC(10,0),@NREQBUY2AMT NUMERIC(10,0),
			@NBUYQTY NUMERIC(10,0),@NGETQTY NUMERIC(10,0),@NADDNLGETMODE NUMERIC(1,0),@NADDNLGETQTY NUMERIC(10,0),
			@NADDNLGETAMT NUMERIC(10,2),@BADDNLQUALIFIED BIT,@BAPPLYADDNDISCOUNT BIT,@CADDGETFILTER VARCHAR(1000),@BFABRICPC BIT,
			@NDISCPCT NUMERIC(6,2),@NNETRATE NUMERIC(10,2),@DTSQLJOIN VARCHAR(MAX),@CJOINSTR VARCHAR(MAX),@BHIGHERMRPFOUNDINGETITEM BIT,
			@NREQAMT NUMERIC(10,2),@NADDNLDISCMETHOD NUMERIC(1,0),@BGETCHECKED BIT,@NSCHEMELOOP NUMERIC(5,0),@CSLSBCDISCPCT VARCHAR(200),
			@NSRNO NUMERIC(5,0),@NMAXSRNO NUMERIC(5,0),@CMINMRPPC VARCHAR(100),@CHIGHERMRPPC VARCHAR(100),@BBUYCHECKED BIT,
			@BDONOTDISTRIBUTEWTDDISCOUNT BIT
			
	
	SELECT @BPROCESSSLRENTRY=0,@NSCHEMELOOP=1
START_PROC:
	
	--SELECT 'BEFORE APPLYING SCHEME9:',* FROM #TMPCMD
				
	SELECT @NORGBUYAMT=0,@CPRODUCTCODE='',@NBUYAMT=0,@NGETAMT=0,@NMRP=0,@NQTY=0,
		   @CCMDROWID='',@NLOOPCNT=0,@NREQGETAMT=0,@NREQGETQTY=0,@NMODE=0,@BQUALIFIED=0,@CROWID='',@BBUYQUALIFIED=0,
		   @NSTEP=0,@NAMT=0,@CMRPORDER='',@NREQBUYAMT=0,@BRETRY2NDCASE=0,@CCMD='',@NMINMRP=0,@NMAXSRNO=0,
		   @NDISCMODE=0,@CBUYFILTER='',@CGETFILTER='',@CADDFILTER='',@NBUYFILTERMODE=0,@BBUYCHECKED=0,
		   @CADDFILTER='',@CORGADDFILTER='',@NGETFILTERMODE=0,@NREQBUY2QTY=0,@NREQBUY2AMT=0,@BGETCHECKED=0,@NADDNLBUYMODE=0
			
	
	SELECT	@BDONOTAPPLYSCHEMEONDISCITEMS=ISNULL(DONOT_APPLY_SCHEME_ON_DISCOUNTED_ITEMS,0),
	@BAPPLYSCHEMESRNOWISE=ISNULL(APPLY_SCHEME_SRNO_WISE,0),@BDONOTDISTRIBUTEWTDDISCOUNT=ISNULL(DONOT_DISTRIBUTE_WEIGHTED_AVG_DISC,0)
	FROM SCHEME_SETUP_DET
	WHERE ROW_ID=@CSCHEMEDETROWID
	
	--IF @@SPID=137
	--	SELECT 'CHECK #TMPCMD B4 ENTERING SCHEME',@CSLSTITLE AS CSLSTITLE,* FROM #TMPCMD
	
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMD A LEFT JOIN SCHEME_SETUP_DET B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
				    WHERE (@BDONOTAPPLYSCHEMEONDISCITEMS=1 AND (ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 
					AND A.SCHEME_SETUP_DET_ROW_ID='')) OR 
				   (@BDONOTAPPLYSCHEMEONDISCITEMS=0 AND ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 
				   ))
		GOTO END_PROC
		

	IF @BPROCESSSLRENTRY=1
		SET @CORGADDFILTER='A.QUANTITY<0'
	ELSE
		SET @CORGADDFILTER='A.QUANTITY>0'
			
	IF CURSOR_STATUS('GLOBAL','SCHEMECUR') IN (0,1)
	BEGIN
		CLOSE SCHEMECUR
		DEALLOCATE SCHEMECUR
	END

BEGIN TRY        
		
	SET @NSTEP=10

	DECLARE @CENABLEOPTIMIZEDSCHEMES VARCHAR(2)
	SELECT TOP 1 @CENABLEOPTIMIZEDSCHEMES=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_OPTIMIZED_EOSS_SCHEMES'		
	
	SET @CENABLEOPTIMIZEDSCHEMES=ISNULL(@CENABLEOPTIMIZEDSCHEMES,'')

	PRINT 'CHECK SCHEME SP3S_EOSS_SCHEMES_15'	
	SELECT @CMRPORDER='',@BQUALIFIED=0,@BRETRY2NDCASE=0,@BBUYQUALIFIED=0
		
	IF OBJECT_ID('TEMPDB..#TEMPCMDPREV','U') IS NOT NULL
		DROP TABLE #TEMPCMDPREV

	IF OBJECT_ID('TEMPDB..#TMPCMDSCHEMES','U') IS NOT NULL
		DROP TABLE #TMPCMDSCHEMES
	
	SELECT @NBUYMODE=BUY_MODE,@NADDNLBUYMODE=ISNULL(ADDNL_BUY_MODE,0),@NGETMODE=GET_MODE,@NADDNLGETAMT=ADDITIONAL_DISCOUNT_BASE_AMOUNT,
		   @NDISCMODE=DISC_METHOD,@NDISCPCT=DISCOUNT_PERCENTAGE,@NDISCAMT=DISCOUNT_AMOUNT,@NNETRATE=NET_PRICE,
		   @NADDNLGETQTY=ISNULL(ADDNL_GET_QTY,0),@BAPPLYADDNDISCOUNT=ISNULL(APPLYADDITIONALDISCOUNT,0),
		   @CBUYFILTER=(CASE WHEN FILTER_MODE IN (0,1) AND @CENABLEOPTIMIZEDSCHEMES<>'1' THEN  BUY_FILTER_CRITERIA ELSE '1=1' END),
		   @CGETFILTER=(CASE WHEN GET_FILTER_MODE IN (0,1) AND @CENABLEOPTIMIZEDSCHEMES<>'1' THEN  GET_FILTER_CRITERIA ELSE '1=1' END),
		   @CADDBUYFILTER=ISNULL(ADDITIONAL_BUY_FILTER_CRITERIA,''),@NADDBUYBASEVALUE=ISNULL(ADDNL_BUY_BASIS_VALUE,0),
		   @NBUYFILTERMODE=FILTER_MODE,@NGETFILTERMODE=GET_FILTER_MODE,
		   @NADDBUYFILTERMODE=ISNULL(ADDNL_BUY_FILTER_MODE,0),@NADDGETFILTERMODE=ISNULL(ADDNL_GET_FILTER_MODE,0),
		   @BAPPLYADDBUYFILTERRESTRICTION=ISNULL(APPLYADDBUYFILTERRESTRICTION,0) ,@NADDNLGETMODE=ADDNL_GET_MODE,
		   @CADDGETFILTER=ISNULL(ADDITIONAL_GET_FILTER_CRITERIA,''),@NBUYQTY=ISNULL(BUY_BASIS_VALUE,0),
		   @NGETQTY=ISNULL(GET_QUANTITY,0),@NADDNLDISCMETHOD=ADDITIONAL_DISC_METHOD
	FROM SCHEME_SETUP_DET
	WHERE ROW_ID=@CSCHEMEDETROWID


	---- NEED TO VALIDATE THE PROPER SCHEME TABLES DATA LYING IN CASE OF PARA COMBINATION SETUP
	---- THIS ISSUE IS COMING FREQUENTLY AT DONEAR POS (DATE : 03-02-2023 -- SANJAY)
	IF @NBUYFILTERMODE=3 OR @NGETFILTERMODE=3
	BEGIN
		EXEC SP3S_VALIDATE_EOSSDATA
		@CSCHDETROWID=@CSCHEMEDETROWID,
		@CERRORMSG=@CERRMSG OUTPUT

		IF ISNULL(@CERRMSG,'')<>''
			GOTO END_PROC
	END

	IF @CGETFILTER=''
		SET @CGETFILTER=@CBUYFILTER

	SET @NSTEP=12
	
	SET @CADDFILTER=' 1=1 '
					
	SET @NSTEP=15
	SELECT PRODUCT_CODE,MRP,QUANTITY,CMD_ROW_ID AS ROW_ID,CONVERT(INT,0) AS MODE,
	CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT,QUANTITY AS SCHEME_APPLIED_QTY,CONVERT(BIT,0) AS ADDNLDISCAPPLICABLE,
	QUANTITY AS GET_QUANTITY,NET AS SCHEME_APPLIED_AMOUNT,CMD_ROW_ID AS NEW_ROW_ID,DISCOUNT_PERCENTAGE,
	IDENTITY(INT,1,1) AS SR_NO,CONVERT(BIT,0) FABRIC_PC
	INTO #TMPCMDSCHEMES FROM #TMPCMD
	WHERE 1=2 

	SET @NSTEP=35
	
	SET @CSLSBCDISCPCT=',0 AS DISCOUNT_PERCENTAGE'

	IF @NBUYFILTERMODE=1
		SELECT @CJOINSTR= @CJOINSTRBUY
	ELSE	
	IF @NBUYFILTERMODE=2	
		SELECT @CJOINSTR=' JOIN SCHEME_SETUP_SLSBC SLSBC ON LEFT(SLSBC.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',SLSBC.PRODUCT_CODE)-1,-1),LEN(SLSBC.PRODUCT_CODE ))) =
							LEFT(ITV.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',ITV.PRODUCT_CODE)-1,-1),LEN(ITV.PRODUCT_CODE )))  
							  JOIN SCHEME_SETUP_DET SLSDET ON SLSDET.ROW_ID=SLSBC.SCHEME_SETUP_DET_ROW_ID'
	ELSE
	IF @NBUYFILTERMODE=3
		SET @CJOINSTR=@CJOINSTRBUY

	SET @CADDFILTER=@CORGADDFILTER	


	
	SET @NSTEP=40
	IF @NBUYFILTERMODE =2
		SELECT @CADDFILTER=@CORGADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''' AND SLSBC.SOURCE_TYPE=1'
	ELSE		   
	IF @NBUYFILTERMODE IN (3,6)
		SELECT @CADDFILTER=@CORGADDFILTER+' AND SC.SCHEME_SETUP_DET_ROW_ID='''+@CSCHEMEDETROWID+''' AND SC.SOURCE_TYPE=1'			
	

	IF @BDONOTAPPLYSCHEMEONDISCITEMS=1
		SELECT @CADDFILTER=@CADDFILTER+' AND A.SCHEME_SETUP_DET_ROW_ID='''''	
	
--IF @NSCHEMELOOP=2 AND @@SPID=256
	--	SELECT 'CHECK #TMPCMD',* FROM #TMPCMD	
		
		--*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END)
	SET @CCMD=N' SELECT A.PRODUCT_CODE,((A.MRP*ABS(A.QUANTITY))-A.SCHEME_APPLIED_AMOUNT)/ABS(A.QUANTITY) AS MRP,ABS(A.QUANTITY),
				 A.CMD_ROW_ID AS ROW_ID,1 AS MODE,
				 0 AS DISCOUNT_AMOUNT,0,0 AS ADDNLDISCAPPLICABLE,0 AS GET_QUANTITY,0 AS SCHEME_APPLIED_AMOUNT,'''' AS NEW_ROW_ID'+@CSLSBCDISCPCT+'
				  FROM #TMPCMD A
				 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTR+'
				 LEFT JOIN SLS_CMD01106_UPLOAD CMDU ON A.CMD_ROW_ID=CMDU.ROW_ID AND CMDU.SP_ID='''+@NSPID+'''
				 LEFT JOIN SLS_CMD01106_UPLOAD CMDU_2 ON A.REF_CMD_ROW_ID=CMDU_2.ROW_ID AND CMDU_2.SP_ID='''+@NSPID+'''
				 WHERE '+(CASE WHEN @NBUYMODE=1 THEN 'ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 '
				 ELSE '((A.MRP*ABS(A.QUANTITY))-A.SCHEME_APPLIED_AMOUNT)>0 ' END)+

-----			 CHANGED THIS BECAUSE IF ITEMS IS PREVIOUSLY HAVING OTHER BUY N QTY GET N QTY SCHEME APPLIED (DATE : 16-03-20)
-----			 AND THIS SCHEME IS BASED UPON BUY N AMOUNT GET N QTY FREE , THEN IT GETS FAILED  	
-----			 ELSE 'ABS((A.MRP*A.QUANTITY)-A.SCHEME_APPLIED_AMOUNT)>0 AND ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 ' END)+'
				 ' AND '+@CBUYFILTER+' AND '+ @CADDFILTER+ ' ORDER BY ISNULL(CMDU.SR_NO,CMDU_2.SR_NO) '
	
	PRINT 'CHECK BUY FILTER OF :'+@CSLSTITLE
	PRINT @CCMD				 
	INSERT #TMPCMDSCHEMES (PRODUCT_CODE,MRP,QUANTITY,ROW_ID,MODE,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,ADDNLDISCAPPLICABLE,
	GET_QUANTITY,SCHEME_APPLIED_AMOUNT,NEW_ROW_ID,DISCOUNT_PERCENTAGE)
	EXEC SP_EXECUTESQL @CCMD
	
	
	--IF @@SPID=64
	--BEGIN
	--	SELECT 'CHECK TMMPCMD BEFORE INITIALIZING SCHEME',@CSLSTITLE,PRODUCT_CODE,QUANTITY,SCHEME_APPLIED_QTY,MRP,SCHEME_APPLIED_AMOUNT,
	--	SCHEME_SETUP_DET_ROW_ID,* FROM #TMPCMD

	--		SELECT 'CHECK #TMPCMDSCHEMES AFTER INSERTING BUY FILTER',@BAPPLYSCHEMESRNOWISE APPLYSCHEMESRNOWISE,@CSLSTITLE SLSTITLE, @NMINMRP MINMRP,@CMINMRPPC MINMRPPC, SR_NO,@NDISCMODE AS NDISCMODE,@NGETMODE AS NGETMODE,@NREQGETQTY AS NREQGETQTY,
	--		@NGETQTY AS GETQTY,PRODUCT_CODE,SCHEME_APPLIED_QTY, (MRP-SCHEME_APPLIED_AMOUNT) AS MRP,
	--		(QUANTITY-SCHEME_APPLIED_QTY) NETQTY,ROW_ID,MODE,@NMAXSRNO MAXSRNO FROM
	--		#TMPCMDSCHEMES
	--END
	SET @NSTEP=45

	
	IF @NGETFILTERMODE=1
		SELECT @CJOINSTR= @CJOINSTRGET
	ELSE	
	IF @NGETFILTERMODE=2
		SELECT @CJOINSTR=' JOIN SCHEME_SETUP_SLSBC_GET SLSBC ON LEFT(SLSBC.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',SLSBC.PRODUCT_CODE)-1,-1),LEN(SLSBC.PRODUCT_CODE ))) 
							=LEFT(ITV.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',ITV.PRODUCT_CODE)-1,-1),LEN(ITV.PRODUCT_CODE ))) 
						   JOIN SCHEME_SETUP_DET SLSDET ON SLSDET.ROW_ID=SLSBC.SCHEME_SETUP_DET_ROW_ID',
			   @CSLSBCDISCPCT=',SLSBC.DISCOUNT_FIGURE'							  						   
	ELSE
	IF @NGETFILTERMODE=3
		SELECT @CJOINSTR=@CJOINSTRGET,@CSLSBCDISCPCT=',SC.DISCOUNT_FIGURE'


	SET @CADDFILTER=@CORGADDFILTER	
	IF @NGETFILTERMODE =2
		SELECT @CADDFILTER=@CORGADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''' AND SLSBC.SOURCE_TYPE=1'
	ELSE		   
	IF @NGETFILTERMODE=3
		SELECT @CADDFILTER=@CORGADDFILTER+' AND SC.SCHEME_SETUP_DET_ROW_ID='''+@CSCHEMEDETROWID+''' AND SC.SOURCE_TYPE=2'		
	
	
	SET @NSTEP=51		
	IF @BDONOTAPPLYSCHEMEONDISCITEMS=1
		SELECT @CADDFILTER=@CADDFILTER+' AND A.SCHEME_SETUP_DET_ROW_ID='''''
	
	SET @CCMD=N' SELECT A.PRODUCT_CODE,((A.MRP*ABS(A.QUANTITY))-A.SCHEME_APPLIED_AMOUNT)/ABS(A.QUANTITY) AS MRP,ABS(A.QUANTITY),
				 A.CMD_ROW_ID AS ROW_ID,2 AS MODE,
				 0 AS DISCOUNT_AMOUNT,0,0 AS ADDNLDISCAPPLICABLE,0 AS GET_QUANTITY,0 AS SCHEME_APPLIED_AMOUNT,
				 '''' AS NEW_ROW_ID'+@CSLSBCDISCPCT+' FROM #TMPCMD A
				 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTR+'
				 LEFT JOIN SLS_CMD01106_UPLOAD CMDU ON A.CMD_ROW_ID=CMDU.ROW_ID AND CMDU.SP_ID='''+@NSPID+'''
				 LEFT JOIN SLS_CMD01106_UPLOAD CMDU_2 ON A.REF_CMD_ROW_ID=CMDU_2.ROW_ID AND CMDU_2.SP_ID='''+@NSPID+'''
				 WHERE '+ 
				 (CASE WHEN @NGETMODE=1 THEN 'ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0  AND A.SCHEME_SETUP_DET_ROW_ID='''''
				 ELSE '((A.MRP*ABS(A.QUANTITY))-A.SCHEME_APPLIED_AMOUNT)>0 ' END)+' AND '+@CGETFILTER+' AND '+@CADDFILTER+
				 '  ORDER BY ISNULL(CMDU.SR_NO,CMDU_2.SR_NO) '
	
	PRINT 'CHECK GET FILTER OF :'+@CSLSTITLE
	PRINT @CCMD			 
	INSERT #TMPCMDSCHEMES (PRODUCT_CODE,MRP,QUANTITY,ROW_ID,MODE,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,ADDNLDISCAPPLICABLE,
	GET_QUANTITY,SCHEME_APPLIED_AMOUNT,NEW_ROW_ID,DISCOUNT_PERCENTAGE)
	EXEC SP_EXECUTESQL @CCMD
	

	--IF @@SPID=64
	--		SELECT 'CHECK #TMPCMDSCHEMES AFTER INSERTING GET FILTER',@BAPPLYADDBUYFILTERRESTRICTION BAPPLYADDBUYFILTERRESTRICTION,@BAPPLYSCHEMESRNOWISE APPLYSCHEMESRNOWISE,@CSLSTITLE SLSTITLE, @NMINMRP MINMRP,@CMINMRPPC MINMRPPC, SR_NO,@NDISCMODE AS NDISCMODE,
	--		@NGETMODE AS NGETMODE,@NREQGETQTY AS NREQGETQTY,
	--		@NGETQTY AS GETQTY,PRODUCT_CODE,SCHEME_APPLIED_QTY, (MRP-SCHEME_APPLIED_AMOUNT) AS MRP,
	--		(QUANTITY-SCHEME_APPLIED_QTY) NETQTY,ROW_ID,MODE,@NMAXSRNO MAXSRNO FROM
	--		#TMPCMDSCHEMES
	
	SET @NSTEP=53
	SET @CSLSBCDISCPCT=',0 AS DISCOUNT_PERCENTAGE'
	
	IF @BAPPLYADDBUYFILTERRESTRICTION=1
	BEGIN
		SET @NSTEP=55
		IF @NADDBUYFILTERMODE=1
			SELECT @CJOINSTR= @CJOINSTRBUY
		ELSE	
		IF @NADDBUYFILTERMODE=2
			SELECT @CJOINSTR=' JOIN SCHEME_SETUP_SLSBC SLSBC ON LEFT(SLSBC.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',SLSBC.PRODUCT_CODE)-1,-1),LEN(SLSBC.PRODUCT_CODE ))) =
								LEFT(ITV.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',ITV.PRODUCT_CODE)-1,-1),LEN(ITV.PRODUCT_CODE ))) 
								  JOIN SCHEME_SETUP_DET SLSDET ON SLSDET.ROW_ID=SLSBC.SCHEME_SETUP_DET_ROW_ID'								   	
		ELSE
		IF @NADDBUYFILTERMODE=3
			SELECT @CJOINSTR=' JOIN #TEMP_SCHEME_SETUP_ALLMASTERS SC ON 1=1 '

		SET @CADDFILTER=@CORGADDFILTER	
			
		IF @NADDBUYFILTERMODE =2
			SELECT @CADDFILTER=@CORGADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''' AND SLSBC.SOURCE_TYPE=2'
		ELSE		   
		IF @NADDBUYFILTERMODE=3
			SELECT @CADDFILTER=@CORGADDFILTER+' AND SC.SOURCE_TYPE=2'		

		IF @BDONOTAPPLYSCHEMEONDISCITEMS=1
			SELECT @CADDFILTER=@CADDFILTER+' AND A.SCHEME_SETUP_DET_ROW_ID='''''
	
		SET @NSTEP=60
		SET @CCMD=N' SELECT A.PRODUCT_CODE,((A.MRP*A.QUANTITY)-ISNULL(A.SCHEME_APPLIED_AMOUNT,0))/A.QUANTITY AS MRP,ABS(A.QUANTITY)*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END),
					 A.CMD_ROW_ID AS ROW_ID,3 AS MODE,
					 0 AS DISCOUNT_AMOUNT,0,0 AS ADDNLDISCAPPLICABLE,0 AS GET_QUANTITY,
					 0 AS SCHEME_APPLIED_AMOUNT,'''' AS NEW_ROW_ID'+@CSLSBCDISCPCT+' FROM #TMPCMD A
					 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTR+'
					 LEFT JOIN SLS_CMD01106_UPLOAD CMDU ON A.CMD_ROW_ID=CMDU.ROW_ID AND CMDU.SP_ID='''+@NSPID+'''
					 LEFT JOIN SLS_CMD01106_UPLOAD CMDU_2 ON A.REF_CMD_ROW_ID=CMDU_2.ROW_ID AND CMDU_2.SP_ID='''+@NSPID+'''
					 WHERE '+(CASE WHEN @NADDNLBUYMODE=1 THEN 'ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0  AND A.SCHEME_SETUP_DET_ROW_ID='''''
				 ELSE 'ABS((A.MRP*A.QUANTITY)-A.SCHEME_APPLIED_AMOUNT)>0' END)+' AND '+@CADDBUYFILTER+' AND '+@CADDFILTER+
				  ' ORDER BY ISNULL(CMDU.SR_NO,CMDU_2.SR_NO) '

		
		PRINT 'CHECK ADDNL BUY FILTER OF BNGN15'
		PRINT @CCMD				 
		
		INSERT #TMPCMDSCHEMES (PRODUCT_CODE,MRP,QUANTITY,ROW_ID,MODE,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,ADDNLDISCAPPLICABLE,
		GET_QUANTITY,SCHEME_APPLIED_AMOUNT,NEW_ROW_ID,DISCOUNT_PERCENTAGE)
		EXEC SP_EXECUTESQL @CCMD
	END
	
	IF @BAPPLYADDNDISCOUNT=1
	BEGIN
		SET @NSTEP=65
		IF @NADDGETFILTERMODE=1
			SELECT @CJOINSTR= ''
		ELSE	
		IF @NADDGETFILTERMODE=2
			SELECT @CJOINSTR=' JOIN SCHEME_SETUP_SLSBC_GET SLSBC ON LEFT(SLSBC.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',SLSBC.PRODUCT_CODE)-1,-1),LEN(SLSBC.PRODUCT_CODE ))) =
								LEFT(ITV.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',ITV.PRODUCT_CODE)-1,-1),LEN(ITV.PRODUCT_CODE ))) 
							   JOIN SCHEME_SETUP_DET SLSDET ON SLSDET.ROW_ID=SLSBC.SCHEME_SETUP_DET_ROW_ID'								   	
		ELSE
		IF @NADDGETFILTERMODE=3
			SELECT @CJOINSTR=' JOIN #TEMP_SCHEME_SETUP_ALLMASTERS SC ON '

		IF @NADDNLGETMODE=1
			SET @CORGADDFILTER=@CORGADDFILTER+' AND A.SCHEME_SETUP_DET_ROW_ID='''' AND (A.QUANTITY-A.SCHEME_APPLIED_QTY)>0'


		SET @CADDFILTER=@CORGADDFILTER	
					
		IF @NADDGETFILTERMODE =2
			SELECT @CADDFILTER=@CORGADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''' AND SLSBC.SOURCE_TYPE=2'
		ELSE		   
		IF @NADDGETFILTERMODE=3
			SELECT @CADDFILTER=@CORGADDFILTER+' AND SC.SOURCE_TYPE=4'		
	
		IF @BDONOTAPPLYSCHEMEONDISCITEMS=1
			SELECT @CADDFILTER=@CADDFILTER+' AND A.SCHEME_SETUP_DET_ROW_ID='''''
		
		SET @NSTEP=70
		SET @CCMD=N' SELECT A.PRODUCT_CODE,((A.MRP*A.QUANTITY)-ISNULL(A.SCHEME_APPLIED_AMOUNT,0))/A.QUANTITY AS MRP,ABS(A.QUANTITY)*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END),
					 A.CMD_ROW_ID AS ROW_ID,4 AS MODE,
					 0 AS DISCOUNT_AMOUNT,0,0 AS ADDNLDISCAPPLICABLE,0 AS GET_QUANTITY,
					 0 AS SCHEME_APPLIED_AMOUNT,'''' AS NEW_ROW_ID'+@CSLSBCDISCPCT+
					 ' FROM #TMPCMD A
					 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE  '+@CJOINSTR+'
					 LEFT JOIN SLS_CMD01106_UPLOAD CMDU ON A.CMD_ROW_ID=CMDU.ROW_ID AND CMDU.SP_ID='''+@NSPID+'''
					 LEFT JOIN SLS_CMD01106_UPLOAD CMDU_2 ON A.REF_CMD_ROW_ID=CMDU_2.ROW_ID AND CMDU_2.SP_ID='''+@NSPID+'''
					 WHERE '+@CADDGETFILTER+' AND '+@CADDFILTER+
					 ' ORDER BY ISNULL(CMDU.SR_NO,CMDU_2.SR_NO) '
		
		PRINT 'CHECK ADDNL FILTER OF BNGN'
		PRINT @CCMD				 
		INSERT #TMPCMDSCHEMES (PRODUCT_CODE,MRP,QUANTITY,ROW_ID,MODE,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,ADDNLDISCAPPLICABLE,
							   GET_QUANTITY,SCHEME_APPLIED_AMOUNT,NEW_ROW_ID,DISCOUNT_PERCENTAGE)
		EXEC SP_EXECUTESQL @CCMD
	END
	
	SET @NSTEP=75
	
	UPDATE #TMPCMDSCHEMES SET NEW_ROW_ID=ROW_ID
			
	SELECT * INTO #TEMPCMDPREV FROM #TMPCMDSCHEMES
	
	SET @NTRIAL=0 
	
	SELECT @NBUYAMT=BUY_BASIS_VALUE,@NGETAMT=DISCOUNT_AMOUNT,@NAPPLYMODE=VALUE_BASED_SCHEME_MODE
	FROM SCHEME_SETUP_DET
	WHERE ROW_ID=@CSCHEMEDETROWID
	
	
	SET @NSTEP=80
	SET @NTRIAL=@NTRIAL+1
					
	IF @BRETRY2NDCASE=0
		SET @CMRPORDER=''
	
LBLCHKBUY:

	--IF @@SPID=145 AND @NTRIAL=2 AND @BPROCESSSLRENTRY=0
	--	SELECT @BGETCHECKED GETCHECKED, @BQUALIFIED AS BGETQUALIFIED

	SET @NSTEP=80.4
	SELECT @NREQGETAMT=0,@NREQBUYAMT=0,@NREQGETQTY=0,@NREQBUYQTY=0,@NREQBUY2QTY=0,@NREQBUY2AMT=0,@BQUALIFIED=0,@BBUYQUALIFIED=0,
	@NMINMRP=0,@NMAXSRNO=0

	IF NOT (@NTRIAL=2 AND @BGETCHECKED=1)
	BEGIN

		DELETE FROM #TMPCMDSCHEMES
	
		INSERT #TMPCMDSCHEMES (PRODUCT_CODE,MRP,QUANTITY,ROW_ID,MODE,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,GET_QUANTITY,SCHEME_APPLIED_AMOUNT,NEW_ROW_ID,DISCOUNT_PERCENTAGE)
		SELECT PRODUCT_CODE,MRP,QUANTITY,ROW_ID,MODE,0 AS DISCOUNT_AMOUNT,0 AS SCHEME_APPLIED_QTY,0 AS GET_QUANTITY,0 AS SCHEME_APPLIED_AMOUNT,NEW_ROW_ID,DISCOUNT_PERCENTAGE
		FROM #TEMPCMDPREV ORDER BY SR_NO
	END
	
	
	PRINT 'UPDATE FABRIC_PC FOR ALL SCHEMES BARCODES'
	SET @NSTEP=82
	UPDATE A SET  FABRIC_PC=(CASE WHEN BARCODE_CODING_SCHEME=2 AND DISCON=2 THEN 1 ELSE 0 END)
	FROM #TMPCMDSCHEMES A
	JOIN SKU B (NOLOCK) ON B.PRODUCT_CODE=A.PRODUCT_CODE
	JOIN ARTICLE C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE

	-- I WILL HAVE TO RETAIN THIS STEP FOR SOME PARTICULAR SCENARIO WHICH IS CURRENTLY NOT COMING
	-- BUT CONFLICTING WITH OTHER SCENARIO	
	-- AGAIN UNCOMMENTED THIS CODE ON 06-03-2020 AS PROBLEM CAME AT SUVIDHA IN BUY N GET N AMOUNT SCENARION
	-- IN WHICH THERE WERE COMMON ITEMS IN BUY AND GET BUT SCHEME WAS BEING APPLIED IF WE TAKE OUT GET ITEMS FIRST , THEN BUY ITEMS
	IF @NTRIAL=2 AND @BGETCHECKED=0 
		GOTO LBLCHKGET
	
	SET @NSTEP=85


	PRINT 'TRIAL#'+STR(@NTRIAL)	
	
	IF @BAPPLYADDBUYFILTERRESTRICTION=1 AND @NSCHEMELOOP=1 
	BEGIN
		PRINT 'ENTER EOSS_SCHEME_9 : 1'
		DECLARE SCHEMECUR CURSOR FOR SELECT PRODUCT_CODE,MRP/QUANTITY,QUANTITY,NEW_ROW_ID,MODE
		FROM #TMPCMDSCHEMES WHERE MODE=3 AND ((@NADDNLBUYMODE=1 AND (QUANTITY-SCHEME_APPLIED_QTY)>0) OR
		(@NADDNLBUYMODE=2 AND ((MRP*QUANTITY)-SCHEME_APPLIED_AMOUNT)>0))
				
		OPEN SCHEMECUR
		FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID,@NMODE
		WHILE @@FETCH_STATUS=0
		BEGIN
			PRINT 'ENTER EOSS_SCHEME_9 : 2'
			SET @NSTEP=90

			SET @NLOOPCNT=1
			WHILE @NLOOPCNT<=ABS(@NQTY)
			BEGIN
				PRINT 'ENTER EOSS_SCHEME_9 : 3'
				IF @NADDNLBUYMODE=1
					SET @NREQBUY2QTY=@NREQBUY2QTY+1
				ELSE
					SET @NREQBUY2AMT=@NREQBUY2AMT+@NMRP
			    
				PRINT '2:'+ STR(@NREQGETAMT)+STR(@NGETAMT)


				


				IF (@NREQBUY2QTY>=@NADDBUYBASEVALUE AND @NADDNLBUYMODE=1) OR
				   (@NREQBUY2AMT>=@NADDBUYBASEVALUE AND @NADDNLBUYMODE=2)
				BEGIN
					SET @BQUALIFIED=1				
					BREAK
				END
			    
				SET @NSTEP=95
				IF @BQUALIFIED=1
					BREAK
					
				SET @NLOOPCNT=@NLOOPCNT+1
			END										
			
			IF @BQUALIFIED=1
				BREAK
			
			FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID,@NMODE
		END
		CLOSE SCHEMECUR
		DEALLOCATE SCHEMECUR

		--IF @@SPID=170
		--	SELECT @NREQBUY2AMT AS NREQBUY2AMT,@NADDBUYBASEVALUE AS NADDBUYBASEVALUE 		

		IF @BQUALIFIED=0
			GOTO EXIT_PROC
	END
		
	SET @BQUALIFIED=0
	
	SET @NSTEP=100

	--IF @@SPID=97
	--	SELECT 'CHECK ITEMS PENDING BEFORE BUY',@NTRIAL AS TRIAL,@BBUYQUALIFIED AS BBUYQUALIFIED,@CSLSTITLE AS SLSTITLE, @NBUYAMT AS NBUYAMT,@NBUYMODE AS NBUYMODE,
	--	@NREQBUYAMT AS NREQBUYAMT,@NREQBUYQTY AS NREQBUYQTY,@NBUYQTY AS NBUYQTY,* FROM #TMPCMDSCHEMES

	DECLARE @BFLAG BIT
	IF OBJECT_ID('TEMPDB..#TMPCMDSCHEMESBUY','U') IS NOT NULL
		DROP TABLE #TMPCMDSCHEMESBUY

	SELECT * INTO #TMPCMDSCHEMESBUY FROM #TMPCMDSCHEMES WHERE MODE IN (1,3) AND QUANTITY>0
	
	
	--IF @@SPID=102
	--	SELECT 'CHECK TMPCMDSCHEMESBUY',*  FROM #TMPCMDSCHEMESBUY 		
	--IF @@SPID=145 AND @NTRIAL=2
	--	SELECT 'CHECK ITEMS PENDING BEFORE BUY',@NMINMRP MINMRP, @NTRIAL AS TRIAL,@BBUYQUALIFIED AS BBUYQUALIFIED,@NBUYAMT AS NBUYAMT,@NBUYMODE AS NBUYMODE,
	--	@NREQBUYAMT AS NREQBUYAMT,@NREQGETQTY AS NREQGETQTY,@NGETQTY AS NGETQTY,* FROM #TMPCMDSCHEMES

		
	SET @BFLAG=1
	
	WHILE @BFLAG=1
	BEGIN
		SET @NSTEP=130

		SET @CPRODUCTCODE=''
		
		IF @BAPPLYSCHEMESRNOWISE=1
		BEGIN
			SET @NSTEP=130.4
			SELECT TOP 1 @CPRODUCTCODE=PRODUCT_CODE ,@NMRP=((MRP*QUANTITY)-SCHEME_APPLIED_AMOUNT),@NQTY=QUANTITY-SCHEME_APPLIED_QTY,
				@CCMDROWID=ROW_ID,@NSRNO=SR_NO,@BFABRICPC=FABRIC_PC FROM #TMPCMDSCHEMESBUY WHERE MODE=1 AND (QUANTITY-SCHEME_APPLIED_QTY)>0 
				ORDER BY SR_NO
		END
		ELSE
		BEGIN
			SET @NSTEP=130.7
			
			IF (@NBUYMODE=1 OR @NGETMODE=1) AND @NTRIAL=1
				SELECT TOP 1 @CPRODUCTCODE=PRODUCT_CODE ,@NMRP=((MRP*QUANTITY)-SCHEME_APPLIED_AMOUNT),@NQTY=QUANTITY-SCHEME_APPLIED_QTY,
				@CCMDROWID=ROW_ID,@NSRNO=SR_NO,@BFABRICPC=FABRIC_PC FROM #TMPCMDSCHEMESBUY WHERE MODE=1 AND (QUANTITY-SCHEME_APPLIED_QTY)>0 
				ORDER BY MODE DESC,MRP DESC
			ELSE
				SELECT TOP 1 @CPRODUCTCODE=PRODUCT_CODE ,@NMRP=((MRP*QUANTITY)-SCHEME_APPLIED_AMOUNT),
				@NQTY=QUANTITY-SCHEME_APPLIED_QTY,@BFABRICPC=FABRIC_PC,
				@CCMDROWID=ROW_ID FROM #TMPCMDSCHEMESBUY WHERE MODE=1 AND  ((MRP*QUANTITY)-SCHEME_APPLIED_AMOUNT)>0 
				ORDER BY MODE DESC,MRP
		END

		IF ISNULL(@CPRODUCTCODE,'')=''
			BREAK
		
		SET @NSTEP=131.2
		IF @NMRP<@NMINMRP OR @NMINMRP=0
			SELECT @NMINMRP=@NMRP,@CMINMRPPC=@CPRODUCTCODE

		IF @NSRNO>@NMAXSRNO
			SET @NMAXSRNO=@NSRNO

		SET @NLOOPCNT=(CASE WHEN @BFABRICPC=1 THEN ABS(@NQTY) ELSE 1 END)
		WHILE @NLOOPCNT<=ABS(@NQTY)
		BEGIN
			SET @NSTEP=133
			SET @NCURQTY=1
			IF @NBUYMODE=2
			BEGIN
				SET @NREQAMT=(CASE WHEN (@NREQBUYAMT+@NMRP)>@NBUYAMT THEN (@NBUYAMT-@NREQBUYAMT) ELSE @NMRP END)												
				SET @NREQBUYAMT=@NREQBUYAMT+@NREQAMT									
			END	
		    ELSE
			BEGIN
				SET @NCURQTY=(CASE WHEN @BFABRICPC=1 THEN (CASE WHEN @NREQBUYQTY+ABS(@NQTY)<=@NBUYQTY THEN ABS(@NQTY) 
							  ELSE @NBUYQTY-@NREQBUYQTY END)  ELSE 1 END)
				SET @NREQBUYQTY=@NREQBUYQTY+@NCURQTY
			END
			
			--IF @@SPID=102
			--	SELECT @NLOOPCNT AS NLOOPCNT,@NQTY AS NQTY,@NREQAMT AS NREQAMT,@NBUYAMT AS NBUYAMT,@NBUYMODE AS NBUYMODE
					
		    SET @NSTEP=135
			UPDATE #TMPCMDSCHEMES SET 
			SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+@NCURQTY,
			SCHEME_APPLIED_AMOUNT=SCHEME_APPLIED_AMOUNT+(CASE WHEN @NBUYMODE=2 THEN @NREQAMT ELSE (CASE WHEN @BDONOTDISTRIBUTEWTDDISCOUNT=1 THEN @NMRP ELSE 0 END) END)
			WHERE ROW_ID=@CCMDROWID
		    
		    PRINT 'VALIDATE BUY AMT 2 FOR TITLE:'+@CSLSTITLE+':'+STR(@NREQBUYAMT)+':'+STR(@NBUYAMT)
			IF (@NREQBUYAMT>=@NBUYAMT AND @NBUYMODE=2) OR (@NREQBUYQTY>=@NBUYQTY AND @NBUYMODE=1)
			BEGIN
				SET @BQUALIFIED=1				
				BREAK
			END
		    
			SET @NLOOPCNT=@NLOOPCNT+1
		END										
		
		IF @BQUALIFIED=1
			BREAK
		
		DELETE FROM #TMPCMDSCHEMESBUY WHERE ROW_ID=@CCMDROWID
	END
	
	SET @BBUYQUALIFIED=@BQUALIFIED
	

		--IF @@SPID=190
		--	SELECT 'CHECK #TMPCMDSCHEMES BEFORE GETTING GET DISC',QUANTITY,@NBUYQTY BUYQTY,@NREQBUYQTY AS NREQBUYQTY,@NBUYMODE BUYMODE, @CSLSTITLE SLSTITLE,@NTRIAL TRIAL, @BBUYQUALIFIED BUYQUALIFIED,@BAPPLYSCHEMESRNOWISE APPLYSCHEMESRNOWISE,
		--	@NMINMRP MINMRP,@CMINMRPPC MINMRPPC, SR_NO,@NDISCMODE AS NDISCMODE,@NGETMODE AS NGETMODE,
		--	@NGETQTY AS GETQTY,PRODUCT_CODE,SCHEME_APPLIED_QTY,SCHEME_APPLIED_AMOUNT,  (MRP-SCHEME_APPLIED_AMOUNT) AS MRP,
		--	(QUANTITY-SCHEME_APPLIED_QTY) NETQTY,ROW_ID,MODE,@NMAXSRNO MAXSRNO FROM
		--	#TMPCMDSCHEMES 
	
	--IF @@SPID=145 AND @NTRIAL=2
	--	SELECT 'CHECK GET ITEMS PENDING AFTER BUY',@NMINMRP MINMRP, @NTRIAL AS TRIAL,@BBUYQUALIFIED AS BBUYQUALIFIED,
	--	@NBUYAMT AS NBUYAMT,@NBUYMODE AS NBUYMODE,
	--	@NREQBUYAMT AS NREQBUYAMT,@NREQGETQTY AS NREQGETQTY,@NGETQTY AS NGETQTY,* FROM #TMPCMDSCHEMES
		
	IF @BQUALIFIED=0
		GOTO EXIT_PROC
	
	IF @NTRIAL=2 AND @BGETCHECKED=1
		GOTO LBLFINAL

	--IF @@SPID=73 AND @CSLSTITLE='BUY 2 GET 1 FREEE'
	--BEGIN
	--	SELECT 'CHECK #TMPCMDSCHMEMES AFTER BUY',@NSCHEMELOOP AS NSCHEMELOOP,@NTRIAL AS NTRIAL, @BQUALIFIED AS BQUALIFIED,@NGETMODE AS NGETMODE,@NREQGETQTY AS NREQGETQTY,@NGETQTY AS GETQTY, 'GET QUALIFIED',* FROM #TMPCMDSCHEMES
	--	SELECT PARA4_NAME, 'CHECK #TMPCMD AFTER BUY',A.* FROM #TMPCMD A JOIN SKU_NAMES B ON A.PRODUCT_CODE=B.PRODUCT_CODE
	--END
	
LBLCHKGET:
			
	SET @BQUALIFIED=0


	
	IF @BAPPLYSCHEMESRNOWISE=1
		DECLARE SCHEMECUR CURSOR FOR SELECT PRODUCT_CODE,FABRIC_PC,((MRP*QUANTITY)-SCHEME_APPLIED_AMOUNT) AS MRP,(ABS(QUANTITY)-SCHEME_APPLIED_QTY),ROW_ID,MODE FROM
		#TMPCMDSCHEMES WHERE MODE=2 AND (ABS(QUANTITY)-SCHEME_APPLIED_QTY)>0 AND SCHEME_APPLIED_AMOUNT=0  
		AND SR_NO>@NMAXSRNO
		ORDER BY SR_NO
	ELSE
	IF @NGETMODE=1 
		DECLARE SCHEMECUR CURSOR FOR SELECT PRODUCT_CODE,FABRIC_PC,((MRP*QUANTITY)-SCHEME_APPLIED_AMOUNT) AS MRP,(ABS(QUANTITY)-SCHEME_APPLIED_QTY),ROW_ID,MODE FROM
		#TMPCMDSCHEMES WHERE MODE=2 AND (QUANTITY-SCHEME_APPLIED_QTY)>0 AND SCHEME_APPLIED_AMOUNT=0  
		ORDER BY MRP DESC
	ELSE
		DECLARE SCHEMECUR CURSOR FOR SELECT PRODUCT_CODE,FABRIC_PC,((MRP*QUANTITY)-SCHEME_APPLIED_AMOUNT) AS MRP,ABS(QUANTITY),ROW_ID,MODE FROM
		#TMPCMDSCHEMES WHERE MODE=2 AND ((MRP*QUANTITY)-SCHEME_APPLIED_AMOUNT)>0  ORDER BY MRP
				
	OPEN SCHEMECUR
	FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@BFABRICPC,@NMRP,@NQTY,@CCMDROWID,@NMODE
	WHILE @@FETCH_STATUS=0
	BEGIN
			
		SET @NSTEP=105
		IF @NMRP>@NMINMRP
			SELECT @BHIGHERMRPFOUNDINGETITEM=1,@CHIGHERMRPPC=@CPRODUCTCODE

		SET @NLOOPCNT=(CASE WHEN @BFABRICPC=1 THEN @NQTY ELSE 1 END)
		WHILE @NLOOPCNT<=ABS(@NQTY)
		BEGIN
			SET @NCURQTY=1
			IF @NGETMODE=2
			BEGIN
				SET @NDISCAMT=(CASE WHEN (@NREQGETAMT+@NMRP)>@NGETAMT THEN (@NGETAMT-@NREQGETAMT) ELSE @NMRP END)									
			    
				SET @NREQGETAMT=@NREQGETAMT+@NDISCAMT
				SET @NSTEP=110
				UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=DISCOUNT_AMOUNT+@NDISCAMT
				WHERE ROW_ID=@CCMDROWID AND MODE=2
			END
		    ELSE
			BEGIN
				SET @NCURQTY=(CASE WHEN @BFABRICPC=1 THEN (CASE WHEN @NREQGETQTY+@NQTY<=@NGETQTY THEN @NQTY 
							  ELSE @NGETQTY END)  ELSE 1 END)
				SET @NREQGETQTY=@NREQGETQTY+@NCURQTY
			END
			
			SET @NSTEP=89
			UPDATE #TMPCMDSCHEMES SET GET_QUANTITY=GET_QUANTITY+@NCURQTY
			WHERE ROW_ID=@CCMDROWID AND MODE=2	

			UPDATE #TMPCMDSCHEMES SET SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+ @NCURQTY,
			SCHEME_APPLIED_AMOUNT=SCHEME_APPLIED_AMOUNT+(CASE WHEN @NGETMODE=2 OR @NBUYMODE=2 THEN @NDISCAMT ELSE 0 END)
			WHERE ROW_ID=@CCMDROWID 
					    
		  PRINT 'SP3S_EOSS_SCHEMES_15 ,2:'+ STR(@NREQGETAMT)+STR(@NGETAMT)+'MRP:'+STR(@NMRP)
		    
		    SET @NSTEP=120
		   
		   IF @NGETMODE=2 OR (@NREQGETQTY>=@NGETQTY AND @NGETMODE=1)
			 SET @BQUALIFIED=1
				
			IF (@NREQGETAMT>=@NGETAMT AND @NGETMODE=2) OR (@NREQGETQTY>=@NGETQTY AND @NGETMODE=1)
				BREAK
		
			SET @NLOOPCNT=@NLOOPCNT+1
	
		END										
		
		IF (@NREQGETAMT>=@NGETAMT AND @NGETMODE=2) OR (@NREQGETQTY>=@NGETQTY AND @NGETMODE=1)
			BREAK
		
		FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@BFABRICPC,@NMRP,@NQTY,@CCMDROWID,@NMODE
	END
	CLOSE SCHEMECUR
	DEALLOCATE SCHEMECUR

	--IF @@SPID=67
	--	SELECT 'CHECK #TMPCMDSCHEMES AFTER CHECKING GET DISC',QUANTITY, @NTRIAL TRIAL, @BQUALIFIED GETQUALIFIED,@BBUYQUALIFIED BUYQUALIFIED, @BAPPLYSCHEMESRNOWISE APPLYSCHEMESRNOWISE,@CSLSTITLE SLSTITLE, 
	--	@NMINMRP MINMRP,@CMINMRPPC MINMRPPC, SR_NO,@NDISCMODE AS NDISCMODE,@NGETMODE AS NGETMODE,@NREQGETQTY AS NREQGETQTY,
	--	 GET_QUANTITY,PRODUCT_CODE,SCHEME_APPLIED_QTY,SCHEME_APPLIED_AMOUNT, (MRP-SCHEME_APPLIED_AMOUNT) AS MRP,
	--	(QUANTITY-SCHEME_APPLIED_QTY) NETQTY,ROW_ID,MODE FROM
	--	#TMPCMDSCHEMES WHERE MODE=2 


	
	SET @NSTEP=125
	
	IF @NTRIAL=2
		SET @BGETCHECKED=1	
	
LBLFINAL:

	IF @BQUALIFIED=1 AND @BHIGHERMRPFOUNDINGETITEM=1 AND @BAPPLYSCHEMESRNOWISE=1
	BEGIN
		SET @CERRMSG='GET ITEM CODE :'+@CHIGHERMRPPC+' IS HAVING MRP :'+LTRIM(RTRIM(STR(@NMRP)))+
		' MORE THAN MIN MRP:'+LTRIM(RTRIM(STR(@NMINMRP)))+' OF BUY SET ITEM:'+@CMINMRPPC
		GOTO END_PROC	
	END

	IF @NTRIAL=1 AND @BQUALIFIED=0 AND @BAPPLYSCHEMESRNOWISE=0
	BEGIN

		SET @NTRIAL=@NTRIAL+1
		GOTO LBLCHKBUY
	END	
	ELSE
	IF @NTRIAL=2 AND @BQUALIFIED=1 AND @BBUYQUALIFIED=0 AND @BBUYCHECKED=0
	BEGIN
		SET @BBUYCHECKED=1
		GOTO LBLCHKBUY
	END	
	ELSE		
	IF @BQUALIFIED=0
		GOTO EXIT_PROC	
	
	--IF @@SPID=64
	--SELECT @NTRIAL, @BQUALIFIED,@CSLSTITLE,'FINAL QUALIFIED STATUS',* FROM #TMPCMDSCHEMES
	
	SET @NSTEP=140
	SELECT @NREQGETQTY=0,@NREQGETAMT=0,@BADDNLQUALIFIED=0
	
	--IF @@SPID=102
	--SELECT 'CHECK PENDING ADDNL', PRODUCT_CODE,MRP,QUANTITY,ROW_ID,MODE,SCHEME_APPLIED_QTY,SCHEME_APPLIED_AMOUNT FROM
	--#TMPCMDSCHEMES WHERE MODE=4
	
	DECLARE SCHEMECUR CURSOR FOR SELECT PRODUCT_CODE,((MRP*QUANTITY)-SCHEME_APPLIED_AMOUNT),(QUANTITY-SCHEME_APPLIED_QTY),ROW_ID,MODE FROM
	#TMPCMDSCHEMES WHERE MODE=4 AND 
	((@NADDNLGETMODE=1 AND (QUANTITY-SCHEME_APPLIED_QTY)>0 AND SCHEME_APPLIED_AMOUNT=0 AND QUANTITY>0) OR @NADDNLGETMODE=2)  ORDER BY MRP DESC
			
	OPEN SCHEMECUR
	FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID,@NMODE
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @NSTEP=145
		SET @NLOOPCNT=1
		WHILE @NLOOPCNT<=ABS(@NQTY)
		BEGIN
			IF @NADDNLGETMODE=1
				SET @NREQGETQTY=@NREQGETQTY+1
			ELSE
				SET @NREQGETAMT=@NREQGETAMT+@NMRP
					
		    SET @NSTEP=150
			UPDATE #TMPCMDSCHEMES SET QUANTITY=QUANTITY-1,
			SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+1,ADDNLDISCAPPLICABLE=1
			WHERE ROW_ID=@CCMDROWID 
		    
		    PRINT '2:'+ STR(@NREQGETAMT)+STR(@NGETAMT)
			SET @BADDNLQUALIFIED=1				
			
			IF (@NREQGETAMT>=@NADDNLGETAMT AND @NADDNLGETMODE=2 AND @NADDNLDISCMETHOD>1) OR 
			   (@NREQGETQTY>=@NADDNLGETQTY AND @NADDNLGETMODE=1)
				BREAK
									    
			SET @NLOOPCNT=@NLOOPCNT+1
		END										
		
		IF (@NREQGETAMT>=@NADDNLGETAMT AND @NADDNLGETMODE=2 AND @NADDNLDISCMETHOD>1) OR 
			   (@NREQGETQTY>=@NADDNLGETQTY AND @NADDNLGETMODE=1)
			BREAK
		
		FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID,@NMODE
	END
	CLOSE SCHEMECUR
	DEALLOCATE SCHEMECUR	

		
	--SELECT @NADDNLGETMODE,@NREQGETQTY AS NREQGETQTY,@NADDNLGETQTY AS NADDNLGETQTY, @BADDNLQUALIFIED AS BADDNLQUALIFIED ,'ADDNL GET QUALIFIED',* FROM #TMPCMDSCHEMES
	--IF @@SPID=86
		
		
END TRY

BEGIN CATCH
  PRINT 'CATCH IN SP3S_EOSS_SCHEMES_15:'+ERROR_MESSAGE()       
  SET @CERRMSG='P:SP3S_EOSS_SCHEMES_15, STEP:'+LTRIM(RTRIM(STR(@NSTEP,10,2)))+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
END CATCH

EXIT_PROC:

	--IF @@SPID=109 AND @BQUALIFIED=1
	--	SELECT 'CHECK #TMPCMDSCHEMES AFTER QUALIFYING' , @CSLSTITLE AS SLSTITLE,A.MRP,QUANTITY,SCHEME_APPLIED_AMOUNT,
	--	DISCOUNT_AMOUNT,@BAPPLYADDBUYFILTERRESTRICTION AS BAPPLYADDBUYFILTERRESTRICTION, 
	--	@BQUALIFIED AS BQUALIFIED,GET_QUANTITY, 
	--	@NADDNLDISCMETHOD AS NADDNLDISCMETHOD,@NADDNLGETMODE AS NADDNLGETMODE,@BADDNLQUALIFIED AS ADDNLQUALIFIED,
	--	A.* FROM #TMPCMDSCHEMES A
	----	JOIN SKU_NAMES B ON A.PRODUCT_CODE=B.PRODUCT_CODE
		
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
		IF @BQUALIFIED=0
		BEGIN
			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=0

		END	
		ELSE
		BEGIN
			
			SET @NSTEP=89
			
			DECLARE @CBNGNROWID VARCHAR(50)
			SET @CBNGNROWID=NEWID()
			
			IF @NGETFILTERMODE NOT IN (2,3)
				UPDATE #TMPCMDSCHEMES SET DISCOUNT_PERCENTAGE=@NDISCPCT

			--IF @@SPID=67
			--BEGIN
			--	SELECT  'CHECK FINAL DISCOUNT TMPCMDSCHEMES',@NGETFILTERMODE AS NGETFILTERMODE,@NDISCMODE AS NDISCMODE,@NDISCPCT AS NDISCPCT,* FROM #TMPCMDSCHEMES

			--	SELECT 'CHECK  #TMPCMD B4 UPDATING FINAL DISCOUNT',* FROM #TMPCMD
			--END

			IF @NGETMODE=1 OR @NDISCMODE=1
			BEGIN
				UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=(CASE WHEN @NDISCMODE=1 THEN  
					(CASE WHEN @CROUNDITEMLEVEL='1' THEN ROUND(MRP*DISCOUNT_PERCENTAGE/100,0) ELSE MRP*DISCOUNT_PERCENTAGE/100 END)
					WHEN @NDISCMODE=2 THEN (CASE WHEN (MRP/QUANTITY)-@NNETRATE>0 THEN (MRP/QUANTITY)-@NNETRATE ELSE MRP END)
					ELSE (CASE WHEN MRP-@NDISCAMT>0 THEN @NDISCAMT ELSE MRP END) END)*GET_QUANTITY
				WHERE GET_QUANTITY<>0

				UPDATE #TMPCMDSCHEMES SET SCHEME_APPLIED_AMOUNT=DISCOUNT_AMOUNT WHERE GET_QUANTITY<>0 AND @BDONOTDISTRIBUTEWTDDISCOUNT=1
			END
			
			SET @CBNGNROWID=NEWID()
			
			PRINT 'UPDATE FINAL DISCONT OF BNGN15-1'
			UPDATE #TMPCMD SET DISCOUNT_AMOUNT=#TMPCMD.DISCOUNT_AMOUNT+ABS(B.DISCOUNT_AMOUNT)*
			(CASE WHEN @BPROCESSSLRENTRY=1 THEN -1 ELSE 1 END) 
			FROM 
			(SELECT ROW_ID,SUM(DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT FROM  #TMPCMDSCHEMES B
			 WHERE (B.SCHEME_APPLIED_QTY<>0 OR B.SCHEME_APPLIED_AMOUNT<>0) AND B.MODE=2
			 GROUP BY ROW_ID
			) B WHERE  B.ROW_ID=#TMPCMD.CMD_ROW_ID 
			

			UPDATE #TMPCMD SET 
			SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSLSTITLE,
			SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
			BNGN_DISCOUNT=BNGN_DISCOUNT+B.DISCOUNT_AMOUNT,
			BNGN_ROW_ID=@CBNGNROWID
			FROM 
			(SELECT ROW_ID,SUM(DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT FROM  #TMPCMDSCHEMES B
			 WHERE (B.SCHEME_APPLIED_QTY<>0 OR B.SCHEME_APPLIED_AMOUNT<>0)
			 GROUP BY ROW_ID
			) B WHERE B.ROW_ID=#TMPCMD.CMD_ROW_ID 

							
			PRINT 'UPDATE FINAL DISCONT OF BNGN15-2'
			UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ABS(ROUND((DISCOUNT_AMOUNT/(MRP*QUANTITY))*100,3)),
			NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT

			--IF @@SPID=67
			--	SELECT 'CHECK FINAL DISC APPLIED',PRODUCT_CODE,DISCOUNT_AMOUNT, * FROM #TMPCMD
			
		END		
		
		IF @BADDNLQUALIFIED=1
		BEGIN
			
			PRINT 'NOW APPLY ADDNL DISCOUNT OF SCH15-1'
			UPDATE A SET DISCOUNT_AMOUNT=A.DISCOUNT_AMOUNT+(A.NET*C.ADDITIONAL_DISCOUNT/100)
			FROM #TMPCMD A JOIN 
			(SELECT DISTINCT ROW_ID FROM  #TMPCMDSCHEMES WHERE ADDNLDISCAPPLICABLE=1) B ON LTRIM(RTRIM(B.ROW_ID))=LTRIM(RTRIM(A.CMD_ROW_ID ))
			JOIN SCHEME_SETUP_DET C ON C.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID
			WHERE C.ADDITIONAL_DISC_METHOD=1
			
			PRINT 'NOW APPLY ADDNL DISCOUNT OF SCH15-2'
			UPDATE A SET DISCOUNT_AMOUNT=A.DISCOUNT_AMOUNT+(CASE WHEN C.ADDITIONAL_DISCOUNT>A.NET 
			THEN A.NET ELSE C.ADDITIONAL_DISCOUNT END)
			FROM #TMPCMD A JOIN 
			(SELECT DISTINCT ROW_ID FROM  #TMPCMDSCHEMES WHERE ADDNLDISCAPPLICABLE=1) B ON LTRIM(RTRIM(B.ROW_ID))=LTRIM(RTRIM(A.CMD_ROW_ID ))
			JOIN SCHEME_SETUP_DET C ON C.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID
			WHERE C.ADDITIONAL_DISC_METHOD=2
			
			PRINT 'NOW APPLY ADDNL DISCOUNT OF SCH15-3'
			UPDATE A SET DISCOUNT_AMOUNT=A.DISCOUNT_AMOUNT+(CASE WHEN C.ADDITIONAL_DISCOUNT>(A.NET/A.QUANTITY) 
			THEN (A.NET/A.QUANTITY) ELSE ((A.NET/A.QUANTITY)-C.ADDITIONAL_DISCOUNT) END)
			FROM #TMPCMD A 
			JOIN (SELECT DISTINCT ROW_ID FROM  #TMPCMDSCHEMES WHERE ADDNLDISCAPPLICABLE=1) B ON LTRIM(RTRIM(B.ROW_ID))=LTRIM(RTRIM(A.CMD_ROW_ID ))
			JOIN SCHEME_SETUP_DET C ON C.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID
			WHERE C.ADDITIONAL_DISC_METHOD=3
						
			UPDATE A SET DISCOUNT_PERCENTAGE=(A.DISCOUNT_AMOUNT/(A.MRP*A.QUANTITY))*100 
			FROM #TMPCMD A 
			JOIN (SELECT DISTINCT ROW_ID FROM  #TMPCMDSCHEMES WHERE ADDNLDISCAPPLICABLE=1) B ON LTRIM(RTRIM(B.ROW_ID))=LTRIM(RTRIM(A.CMD_ROW_ID ))
			JOIN SCHEME_SETUP_DET C ON C.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID
		END
		
		IF @BQUALIFIED=1
		BEGIN
			PRINT 'UPDATE FINAL DISCONT OF BNGN15-3'
			UPDATE #TMPCMD SET 
			SCHEME_APPLIED_AMOUNT=#TMPCMD.SCHEME_APPLIED_AMOUNT+B.SCHEME_APPLIED_AMOUNT,
			SCHEME_APPLIED_QTY=#TMPCMD.SCHEME_APPLIED_QTY+B.SCHEME_APPLIED_QTY,
			BNGN_QTY=BNGN_QTY+B.SCHEME_APPLIED_QTY
			FROM #TMPCMDSCHEMES B WHERE B.ROW_ID=#TMPCMD.CMD_ROW_ID
			AND (B.SCHEME_APPLIED_QTY<>0 OR B.SCHEME_APPLIED_AMOUNT<>0)
		END
		
		PRINT 'UPDATE FINAL DISCONT OF BNGN15-3'	
		UPDATE A SET  NET=(A.MRP*A.QUANTITY)-A.DISCOUNT_AMOUNT
		FROM #TMPCMD A JOIN #TMPCMDSCHEMES B ON LTRIM(RTRIM(B.ROW_ID))=LTRIM(RTRIM(A.CMD_ROW_ID ))


	--IF @@SPID=61 AND @BQUALIFIED=1
	--	SELECT @CSLSTITLE AS SLSTITLE, ARTICLE_NO,PARA4_NAME,@BAPPLYADDBUYFILTERRESTRICTION AS BAPPLYADDBUYFILTERRESTRICTION, 
	--	@BQUALIFIED AS BQUALIFIED, 
	--	'CHECK #TMPCMDSCHEMES',@NADDNLDISCMETHOD AS NADDNLDISCMETHOD,@NADDNLGETMODE AS NADDNLGETMODE,@BADDNLQUALIFIED AS ADDNLQUALIFIED,
	--	A.* FROM #TMPCMD A
	--	JOIN SKU_NAMES B ON A.PRODUCT_CODE=B.PRODUCT_CODE
		
		IF @BQUALIFIED=1
		BEGIN
			SET @NSCHEMELOOP=@NSCHEMELOOP+1
			GOTO START_PROC
		END	
		ELSE	
		IF @BPROCESSSLRENTRY=0 AND @CPICKSLRDISCMODE<>'3'
		BEGIN
			SET @BPROCESSSLRENTRY=1
			GOTO START_PROC
		END	
		ELSE
			GOTO END_PROC

	END	

END_PROC:
	
	PRINT 'LAST STEP OF EOSS_SCHEME15:'+LTRIM(RTRIM(STR(@NSTEP)))
	--IF @@SPID=97
	--	SELECT 'CHECK FINAL BNGN DISC',PRODUCT_CODE,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT, * FROM #TMPCMD

	PRINT 'FINISH SP3S_EOSS_SCHEMES_15'
END
