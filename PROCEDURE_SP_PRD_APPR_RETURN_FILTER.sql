
--EXEC SP_APPR_RETURN_FILTER 3
--EXEC SP_APPR_RETURN_FILTER 1,2,'2014-04-01','2015-03-31','','','',2
CREATE PROC SP_PRD_APPR_RETURN_FILTER
(
	 @NMODE NUMERIC(1) /*@NMODE: 3 FOR CUSTOMER LOV AND 1 FOR APPROVAL DATA*/
	,@NPARTY_TYPE NUMERIC(1)=0 /*@NPARTY_TYPE:0 FOR ALL,1 FOR LEDGER AND 2 FOR CUSTOMER*/ 
	--,@NAPPROVAL_STATUS NUMERIC(1)=0 /*@NAPPROVAL_STATUS:0 FOR ALL, 1 FOR APPROVED AND 2 FOR PARTIALLY AND 3 FOR PENDING*/
	,@DFROM_DT DATETIME=''
	,@DTO_DT DATETIME=''
	,@CCUSTOMER_CODE VARCHAR(12)='' /*@CCUSTOMER_CODE: '' FOR NO FILTER, ELSE APPLY FILTER ON CUSTOMERS*/
	,@CAC_CODE VARCHAR(10)='' /*@CAC_CODE: '' FOR NO FILTER, ELSE APPLY FILTER ON LEDGERS*/
	,@CEMP_CODE VARCHAR(7)='' /*@CEMP_CODE: '' FOR NO FILTER, ELSE APPLY FILTER ON EMPLOYEES*/
	,@NCANCELLED NUMERIC(1)=0 /*@NCANCELLED: 2 FOR ALL, 1 FOR CANCELLED AND 0 FOR UNCANCELLED*/
	,@NXN_ITEM_TYPE numeric(1,0)=0/*@NCANCELLED: 0 FOR ALL, 1 FOR inventory AND 2 FOR consumable*/
)
AS
BEGIN

IF @NMODE=3
BEGIN
	SELECT TOP 50
	USER_CUSTOMER_CODE,CUSTOMER_CODE,CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME AS CUSTOMER_NAME
	FROM CUSTDYM 
	WHERE INACTIVE=0 AND CUSTOMER_CODE<>'000000000000' AND
	(USER_CUSTOMER_CODE LIKE '%'+@CCUSTOMER_CODE+'%' OR CUSTOMER_FNAME LIKE '%'+@CCUSTOMER_CODE+'%' OR CUSTOMER_LNAME LIKE '%'+@CCUSTOMER_CODE+'%')
END
ELSE
BEGIN
    
    SELECT (ISNULL(CUST.CUSTOMER_TITLE,'')+' ' +ISNULL(CUST.CUSTOMER_FNAME,'')+' '+ISNULL(CUST.CUSTOMER_LNAME,'')) AS CUSTOMER_NAME,  
			ISNULL(CUST.USER_CUSTOMER_CODE,'') AS CUSTOMER_ID,   
			ISNULL(T3.AC_NAME,'') AS SUPPLIER_NAME,   
			CASE WHEN T1.MODE=1  THEN 'RETAIL SALE' WHEN T1.MODE=2 THEN 'WHOLE SALE' ELSE '' END AS MEMO_MODE,    
			T1.MEMO_DT AS MEMO_DT, T1.MEMO_NO AS MEMO_NO,         
			T1.MEMO_ID AS MEMO_ID,    
			(CASE WHEN T1.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END) AS CANCELLED  ,    
			T1.FIN_YEAR ,
			CONVERT(NUMERIC(18,2),CASE WHEN T1.CANCELLED=0 THEN QUANTITY ELSE 0 END) AS QUANTITY ,
			CONVERT(NUMERIC(18,2),CASE WHEN T1.CANCELLED=0 THEN NET_AMOUNT ELSE 0 END) AS NET_AMOUNT

	FROM PRD_APPROVAL_RETURN_MST T1 
	JOIN
	(
	 SELECT M.MEMO_ID,SUM(QUANTITY)  AS QUANTITY ,SUM(ISNULL(QUANTITY,0)*ISNULL(MRP,0)) AS NET_AMOUNT 
	 FROM PRD_APPROVAL_RETURN_DET D
	 JOIN PRD_APPROVAL_RETURN_MST M ON D.MEMO_ID =M.MEMO_ID 
	 LEFT JOIN
	 (
	 SELECT B.ROW_ID,MRP    
	 FROM PRD_APM01106 A
	 JOIN PRD_APD01106 B ON A.MEMO_ID =B.MEMO_ID 
	 WHERE A.CANCELLED =0
	 ) APD ON APD.ROW_ID =D.APD_ROW_ID 
	 WHERE  M.MEMO_DT BETWEEN @DFROM_DT AND @DTO_DT
	AND  (ISNULL(@NPARTY_TYPE,0)=0 OR (@NPARTY_TYPE=1 AND ISNULL(M.AC_CODE,'0000000000')<>'0000000000')
		  OR (@NPARTY_TYPE=2 AND ISNULL(M.CUSTOMER_CODE,'000000000000')<>'000000000000'))
    AND (ISNULL(@CCUSTOMER_CODE,'')='' OR M.CUSTOMER_CODE=@CCUSTOMER_CODE)
	AND (ISNULL(@CAC_CODE,'')='' OR M.AC_CODE=@CAC_CODE)
	AND (ISNULL(@NCANCELLED,2)=2 OR M.CANCELLED=@NCANCELLED)
	GROUP BY M.MEMO_ID
	) T2 ON T1.MEMO_ID =T2.MEMO_ID      
	LEFT OUTER JOIN CUSTDYM CUST ON CUST.CUSTOMER_CODE = T1.CUSTOMER_CODE    
	LEFT OUTER JOIN LMV01106 T3 ON T3.AC_CODE = T1.AC_CODE
	WHERE  T1.MEMO_DT BETWEEN @DFROM_DT AND @DTO_DT
	AND  (ISNULL(@NPARTY_TYPE,0)=0 OR (@NPARTY_TYPE=1 AND ISNULL(T1.AC_CODE,'0000000000')<>'0000000000')
		  OR (@NPARTY_TYPE=2 AND ISNULL(T1.CUSTOMER_CODE,'000000000000')<>'000000000000'))
    AND (ISNULL(@CCUSTOMER_CODE,'')='' OR T1.CUSTOMER_CODE=@CCUSTOMER_CODE)
	AND (ISNULL(@CAC_CODE,'')='' OR T1.AC_CODE=@CAC_CODE)
	AND (ISNULL(@NCANCELLED,2)=2 OR T1.CANCELLED=@NCANCELLED)
	and (@NXN_ITEM_TYPE =0 or case when isnull(t1.XN_ITEM_TYPE,0) in(0,1)  then 1 else t1.XN_ITEM_TYPE end =@NXN_ITEM_TYPE )
	ORDER BY T1.MEMO_ID

END

END


