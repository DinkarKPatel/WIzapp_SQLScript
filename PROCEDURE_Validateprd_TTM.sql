CREATE PROCEDURE VALIDATEPRD_TTM    
 @CXNID VARCHAR(50),     
 @NUPDATEMODE INT,  
 @CUSERCODE CHAR(7),  
 @CERRORMSG VARCHAR(200) OUTPUT    
--  --WITH ENCRYPTION  
     
AS    
BEGIN    
    
  DECLARE @CWORKORDERMEMO_ID VARCHAR(100), @ITEM_LEVEL_CODE_PRICE NUMERIC(12,2),@NBILL_LEVEL_COST_PRICE NUMERIC(12,2),  
          @BILLLEVEL_PURCHASE_PRICE NUMERIC(12,2),@NSUBTOTAL NUMERIC(12,2),@NAMOUNT NUMERIC(12,2)  
    
--ITEM LEVEL COST PRICE & BILL LEVEL COST PRICE  
 --SELECT TOP 1  @CWORKORDERMEMO_ID=A.REF_PRD_WORKORDER_MEMOID,  
 --@NBILL_LEVEL_COST_PRICE=A.COST_PRICE,@ITEM_LEVEL_CODE_PRICE=B.PURCHASE_PRICE  
 --FROM PRD_TRANSFER_MAIN_DET  A  
 --JOIN  
 --(  
     
 --SELECT A.REF_PRD_WORKORDER_MEMOID,B.COM_PARA1_CODE AS PARA1_CODE,B.COM_PARA2_CODE AS PARA2_CODE ,  
 --SUM(A.PURCHASE_PRICE ) AS PURCHASE_PRICE  
 --FROM PRD_TRANSFER_MAIN_SUB_DET A   
 --JOIN PRD_SKU B ON A.PRODUCT_UID=B.PRODUCT_UID  
 --WHERE MEMO_ID=@CXNID  
 --GROUP BY A.REF_PRD_WORKORDER_MEMOID,B.COM_PARA1_CODE,B.COM_PARA2_CODE  
  
 --) B ON A.REF_PRD_WORKORDER_MEMOID=B.REF_PRD_WORKORDER_MEMOID  
 --AND A.PARA1_CODE=B.PARA1_CODE  
 --AND A.PARA2_CODE=B.PARA2_CODE  
 --WHERE MEMO_ID=@CXNID  
 --AND A.COST_PRICE<>B.PURCHASE_PRICE  
 --GROUP BY A.REF_PRD_WORKORDER_MEMOID,A.PARA1_CODE,A.PARA2_CODE ,A.COST_PRICE,B.PURCHASE_PRICE  
  
  
 -- IF ISNULL(@NBILL_LEVEL_COST_PRICE,0)<>ISNULL(@ITEM_LEVEL_CODE_PRICE,0)  
 -- BEGIN    
 -- SET @CERRORMSG='DIFFERENCE IN '+@CWORKORDERMEMO_ID+' ITEM LEVEL COST PRICE & BILL LEVEL COST PRICE....PLEASE CHECK'    
 -- RETURN    
 -- END    
   
   
  IF EXISTS ( SELECT TOP 1 'U' FROM PRD_TRANSFER_MAIN_DET A  WHERE MEMO_ID=@CXNID AND (PURCHASE_PRICE*QTY)<> AMOUNT)  
  BEGIN  
        SET @CERRORMSG='DIFFERENCE IN ITEM LEVEL AMOUNT....PLEASE CHECK'    
  RETURN    
  END    
     
 SELECT TOP 1  @NSUBTOTAL=A.SUBTOTAL,@NAMOUNT=B.AMOUNT FROM PRD_TRANSFER_MAIN_MST A  
 JOIN  
 (  
  SELECT A.MEMO_ID,SUM(AMOUNT) AS AMOUNT   
  FROM PRD_TRANSFER_MAIN_DET A  
  GROUP BY A.MEMO_ID  
 ) B ON A.MEMO_ID=B.MEMO_ID  
 WHERE A.SUBTOTAL<>B.AMOUNT  
 AND A.MEMO_ID =@CXNID
   
   
   
   IF ABS(ISNULL(@NSUBTOTAL,0)-ISNULL(@NAMOUNT,0))>.50  
   BEGIN  
        SET @CERRORMSG='DIFFERENCE IN ITEM LEVEL SUBTOTAL & BILL LEVEL SUB TOTAL....PLEASE CHECK'    
  RETURN    
   END  
   
IF EXISTS ( SELECT TOP 1 'U' FROM PRD_TRANSFER_MAIN_DET A  WHERE MEMO_ID=@CXNID AND WS_PRICE=0)  
  BEGIN  
        SET @CERRORMSG='WS_PRICE CAN NOT BE ZERO....PLEASE CHECK'    
  RETURN    
  END    
   
  IF EXISTS ( SELECT TOP 1 'U' FROM PRD_TRANSFER_MAIN_DET A  WHERE MEMO_ID=@CXNID AND MRP=0)  
  BEGIN  
        SET @CERRORMSG='MRP CAN NO BE ZORO....PLEASE CHECK'    
  RETURN    
  END   
  IF EXISTS ( SELECT TOP 1 'U' FROM PRD_TRANSFER_MAIN_DET A  WHERE MEMO_ID=@CXNID AND RIGHT(QTY,3)>0)  
  BEGIN  
  
        SET @CERRORMSG='ISSUE QTY MUST BE WITOUT DECIMAL PLACES....PLEASE CHECK'    
  RETURN    
  END   
    
        
    
END_PROC:    
END    
--*************************************** END OF PROCEDURE VALIDATEXN_TTM
