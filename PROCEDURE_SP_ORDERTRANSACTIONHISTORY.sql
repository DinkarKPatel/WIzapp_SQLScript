CREATE PROCEDURE SP_ORDERTRANSACTIONHISTORY        
(        
  @ORDER_ID VARCHAR(100)=''
)      

--WITH ENCRYPTION
AS        
BEGIN  
SET NOCOUNT ON      
   
	SELECT SR=1,'ORD' AS XN_TYPE, A.MEMO_NO ,A.REF_NO,
		   BC.ARTICLE_NO AS COMPONENT,CC.PARA1_NAME AS [COM COLOR],DC.PARA2_NAME AS [COM SIZE],S.PRODUCT_CODE,  
		   B.ARTICLE_NO,
		   B.ARTICLE_NAME,
		   CAST(0 AS NUMERIC(10,2)) AS IN_QTY,
		   CAST(0 AS NUMERIC(12,3)) AS OUT_QTY,
		   E.UOM_NAME ,
		   S.PURCHASE_PRICE AS RATE,
		   0 AS STOCK_VALUE,
		   CAST('' AS VARCHAR(100)) AS DEPARTMENT_NAME,
		   CAST('' AS VARCHAR(100)) AS JOB_NAME,
		   CAST('' AS VARCHAR(100)) AS AGENCY_NAME
	FROM PRD_WO_MST A
	JOIN PRD_SKU S ON S.WORK_ORDER_ID= A.MEMO_ID  
	--JOIN PRD_PMT PMT ON PMT.PRODUCT_UID= S.PRODUCT_UID 
	JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE= B.ARTICLE_CODE  
	JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE  
	JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE 
	LEFT OUTER JOIN ARTICLE BC (NOLOCK) ON S.COMPONENT_CODE= BC.ARTICLE_CODE  
	LEFT OUTER JOIN PARA1 CC (NOLOCK) ON S.COM_PARA1_CODE = CC.PARA1_CODE  
	LEFT OUTER JOIN PARA2 DC (NOLOCK) ON S.COM_PARA2_CODE = DC.PARA2_CODE 
	JOIN UOM E ON B.UOM_CODE= E.UOM_CODE  
	WHERE MEMO_ID=@ORDER_ID
	AND S.PRODUCT_CODE <>'' 
	AND A.CANCELLED =0
	 --AND (WIP > 0 OR QUANTITY_IN_STOCK > 0) 
    UNION ALL
    
   SELECT SR=2, 'WIP' AS XN_TYPE, M.MEMO_NO ,RIGHT(D.REF_WO_ID,10) AS REF_NO,
          ARTCOM.ARTICLE_NO AS COMPONENT,COMP1.PARA1_NAME AS COM_PARA1_NAME,
          COMP2.PARA2_NAME AS COM_PARA2_NAME,S.PRODUCT_CODE, 
           A.ARTICLE_NO, 
		   A.ARTICLE_NAME,
		   D.QUANTITY AS IN_QTY,
		   CAST(0 AS NUMERIC(12,3)) AS OUT_QTY,
		   UOM.UOM_NAME AS UNIT,
		   S.PURCHASE_PRICE AS RATE,
		   CAST(ISNULL(D.QUANTITY ,0)*S.PURCHASE_PRICE AS NUMERIC(12,2)) AS STOCK_VALUE,
		   DEPT.DEPARTMENT_NAME  AS DEPARTMENT_NAME,
		   CAST('' AS VARCHAR(100)) AS JOB_NAME,
		   CAST('' AS VARCHAR(100)) AS AGENCY_NAME
  FROM PRD_STK_TRANSFER_DET (NOLOCK) D        
  JOIN PRD_STK_TRANSFER_MST (NOLOCK) M ON D.MEMO_ID = M.MEMO_ID         
  JOIN PRD_SKU (NOLOCK) S ON D.PRODUCT_UID = S.PRODUCT_UID    
  JOIN PRD_PMT (NOLOCK) P ON D.PRODUCT_UID = P.PRODUCT_UID AND M.SOURCE_DEPARTMENT_ID = P.DEPARTMENT_ID         
  JOIN ARTICLE (NOLOCK) A ON S.ARTICLE_CODE = A.ARTICLE_CODE     
  JOIN SECTIOND SD ON SD.SUB_SECTION_CODE = A.SUB_SECTION_CODE        
  JOIN SECTIONM SM ON SM.SECTION_CODE = SD.SECTION_CODE        
  JOIN PARA1 P1 ON S.PARA1_CODE = P1.PARA1_CODE         
  JOIN PARA2 P2 ON S.PARA2_CODE = P2.PARA2_CODE         
  JOIN UOM ON UOM.UOM_CODE = A.UOM_CODE   
  JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID=M.TARGET_DEPARTMENT_ID
  LEFT OUTER JOIN PARA1 COMP1 ON COMP1.PARA1_CODE = D.COM_PARA1_CODE         
  LEFT OUTER JOIN PARA2 COMP2 ON COMP2.PARA2_CODE = D.COM_PARA2_CODE        
  LEFT OUTER JOIN ARTICLE ARTCOM  ON ARTCOM.ARTICLE_CODE = D.COMPONENT_CODE        
  WHERE D.REF_WO_ID  = @ORDER_ID AND M.CANCELLED =0
  UNION ALL
  SELECT SR=3, 'ISS' AS XN_TYPE ,IM.MEMO_NO,IM.REF_NO
         , ARTCOM.ARTICLE_NO AS COMP_NAME,
         PARA1.PARA1_NAME,PARA2.PARA2_NAME,
         SKU.PRODUCT_CODE,B.ARTICLE_NO ,B.ARTICLE_NAME ,
         0 AS IN_QTY,ISNULL(D.QUANTITY ,0) AS ISSUED_QTY,
         C.UOM_NAME AS UNIT,
         SKU.PURCHASE_PRICE ,CAST(ISNULL(D.QUANTITY ,0)*SKU.PURCHASE_PRICE AS NUMERIC(12,2)) AS STOCK_VALUE,
         DEPT.DEPARTMENT_NAME,
         JOBS.JOB_NAME ,
         AG.AGENCY_NAME            
  FROM PRD_AGENCY_ISSUE_MATERIAL_DET D            
  JOIN PRD_SKU SKU ON SKU.PRODUCT_UID=D.PRODUCT_UID            
  JOIN ARTICLE B ON SKU.ARTICLE_CODE  = B.ARTICLE_CODE                 
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST IM ON IM.MEMO_ID=D.MEMO_ID              
  JOIN UOM C ON B.UOM_CODE = C.UOM_CODE             
  JOIN PARA1 ON PARA1.PARA1_CODE = SKU.PARA1_CODE                
  JOIN PARA2 ON PARA2.PARA2_CODE = SKU.PARA2_CODE                 
  JOIN PRD_PMT P ON P.PRODUCT_UID = D.PRODUCT_UID AND P.DEPARTMENT_ID = IM.DEPARTMENT_ID            
  JOIN ARTICLE ARTCOM ON D.REF_COMPONENT_ARTICLE_CODE = ARTCOM.ARTICLE_CODE                 
  LEFT OUTER JOIN             
  (            
   SELECT A.ARTICLE_CODE,K.PARA1_CODE,K.PARA2_CODE,K.QUANTITY AS TOTAL_QTY, S.ISSUED_QTY ,S.PRODUCT_UID            
   FROM PRD_WO_DET A             
   JOIN PRD_WO_SUB_DET K ON A.ROW_ID = K.REF_ROW_ID                  
   LEFT OUTER JOIN                 
   (            
    SELECT D.PRODUCT_UID,D.ARTICLE_CODE,SK.PARA1_CODE,SK.PARA2_CODE,SUM(D.QUANTITY) AS ISSUED_QTY,                
    D.REF_COMPONENT_ARTICLE_CODE AS RCA                 
    FROM PRD_AGENCY_ISSUE_MATERIAL_DET D             
    JOIN PRD_AGENCY_ISSUE_MATERIAL_MST M ON M.MEMO_ID = D.MEMO_ID                 
    JOIN PRD_SKU SK ON SK.PRODUCT_UID=D.PRODUCT_UID            
    WHERE D.REF_PRD_WORKORDER_MEMOID = @ORDER_ID AND M.DEPARTMENT_ID = 'DEF0001'                 
    AND M.CANCELLED = 0                
     GROUP BY  D.ARTICLE_CODE,D.REF_COMPONENT_ARTICLE_CODE,D.PRODUCT_UID,SK.PARA1_CODE,SK.PARA2_CODE            
   ) S ON S.ARTICLE_CODE= A.ARTICLE_CODE AND S.PARA1_CODE = K.PARA1_CODE AND  S.PARA2_CODE = K.PARA2_CODE                 
   AND S.RCA = A.ARTICLE_CODE WHERE A.MEMO_ID =@ORDER_ID            
  ) O ON O.PRODUCT_UID = SKU.PRODUCT_UID AND O.ARTICLE_CODE = D.REF_COMPONENT_ARTICLE_CODE  
  JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =IM.DEPARTMENT_ID   
  JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE =D.JOB_CODE    
  JOIN PRD_AGENCY_MST (NOLOCK) AG ON AG.AGENCY_CODE =IM.REF_AGENCY_CODE           
  WHERE D.REF_PRD_WORKORDER_MEMOID  =@ORDER_ID 
  UNION ALL
 SELECT SR=4, 'REC' AS XN_TYPE ,T4.MEMO_NO,T4.REF_NO
         ,T3.ARTICLE_NO AS COMP_NAME,
         PARA1.PARA1_NAME,PARA2.PARA2_NAME,
         SKU.PRODUCT_CODE,T3.ARTICLE_NO ,T3.ARTICLE_NAME ,
         0 AS IN_QTY,(ISNULL(T4.[QUANTITY],0)) AS REC_QTY,
         UOM.UOM_NAME,
         SKU.PURCHASE_PRICE ,CAST(ISNULL(T4.QUANTITY ,0)*SKU.PURCHASE_PRICE AS NUMERIC(12,2)) AS STOCK_VALUE,
         DEPT.DEPARTMENT_NAME,
         JOBS.JOB_NAME ,
         AG.AGENCY_NAME  
  FROM PRD_AGENCY_ISSUE_MATERIAL_DET (NOLOCK) T1                 
  JOIN ARTICLE (NOLOCK) T2 ON T1.ARTICLE_CODE = T2.ARTICLE_CODE                
  JOIN UOM (NOLOCK) ON T2.UOM_CODE = UOM.UOM_CODE                
  JOIN PRD_SKU (NOLOCK) SKU ON SKU.PRODUCT_UID=T1.PRODUCT_UID             
  JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE                 
  JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE                 
  JOIN ARTICLE (NOLOCK) T3 ON T1.REF_COMPONENT_ARTICLE_CODE = T3.ARTICLE_CODE               
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST T5 ON T5.MEMO_ID=T1.MEMO_ID  
  JOIN           
  (           
   SELECT M.MEMO_NO,M.MEMO_DT,M.REF_NO , DT.XN_PRODUCT_UID,DT.MEMO_ID, DT.REF_ROW_ID,
    SUM(ISNULL(DT.QUANTITY,0)) AS QUANTITY           
   ,ISNULL(DT.[RATE],0) AS RATE            
   ,ISNULL(DT.[AMOUNT],0) AS AMOUNT,ISNULL(DT.[DISCOUNT_PER],0) AS DISCOUNT_PER          
   ,ISNULL(DT.[DISCOUNT_AMOUNT],0) AS DISCOUNT_AMOUNT,ISNULL(DT.[NET_AMOUNT],0) AS NET_AMOUNT, DT.CHALLAN_NO 
   ,DT.MANUAL_AMOUNT
   ,DT.MANUAL_RATE         
   FROM PRD_AGENCY_MATERIAL_RECEIPT_DET (NOLOCK) DT  
   JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST (NOLOCK) M ON DT.MEMO_ID =M.MEMO_ID         
   LEFT OUTER JOIN PRD_AGENCY_ISSUE_MATERIAL_DET (NOLOCK) T11 ON DT.REF_ROW_ID=T11.ROW_ID             
   GROUP BY M.MEMO_NO,M.MEMO_DT,M.REF_NO ,DT.XN_PRODUCT_UID,DT.REF_ROW_ID,DT.MEMO_ID ,DT.RATE, DT.AMOUNT , DT.DISCOUNT_PER,DT.DISCOUNT_AMOUNT,DT.NET_AMOUNT, DT.CHALLAN_NO
    ,DT.MANUAL_AMOUNT,DT.MANUAL_RATE 
  ) T4 ON T4.REF_ROW_ID=T1.ROW_ID    
  JOIN PRD_DEPARTMENT_MST (NOLOCK) DEPT ON DEPT.DEPARTMENT_ID =T5.DEPARTMENT_ID   
  JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE =T1.JOB_CODE    
  JOIN PRD_AGENCY_MST (NOLOCK) AG ON AG.AGENCY_CODE =T5.REF_AGENCY_CODE        
  WHERE T1.REF_PRD_WORKORDER_MEMOID=@ORDER_ID
  --AND P.DEPARTMENT_ID='DEF0000' --AND D.TYPE = 1                
  ORDER BY SR , COMPONENT,ARTICLE_NAME DESC,PRODUCT_CODE 
     
END      
--********************************************** END OF PROCEDURE SP_ORDERTRANSACTIONHISTORY
