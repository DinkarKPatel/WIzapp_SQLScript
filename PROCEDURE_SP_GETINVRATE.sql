create PROCEDURE SP_GETINVRATE        
(        
 @CPRODUCTCODE VARCHAR(50),                    
 @CACCODE CHAR(10),                    
 @CDEPTID CHAR(4)='',                  
 @CFORMID CHAR(7)='0000000',                  
 @NITEMLEVELDISCOUNT NUMERIC (8,4),                  
 @NQUANTITY NUMERIC (10,2),                  
 @NBILLLEVELDISCOUNT NUMERIC (10,4),  
 @NSPID INT=0,  
 @NXFERTYPE INT=0                  
)                      
AS                        
BEGIN            
    --(dinkar) Replace  left(memoid,2) to Location_code         
    DECLARE @NRATETYPE  NUMERIC(2,0),         
    @NMRP   NUMERIC(10,2),              
    @NGROSSRATE  NUMERIC(10,4),              
    @NRATE   NUMERIC(12,4),              
    @NRATE1   NUMERIC(10,4),                
    @NRATE2   NUMERIC(10,4),              
    @NRATE3   NUMERIC(10,4),               
    @NTAXAMOUNT  NUMERIC(12,4),               
    @CTAXSTATUS  VARCHAR(10),              
    @NTAXPERCENTAGE NUMERIC(6,4),              
    @CINVTAXSTATUS VARCHAR(10),               
    @NINVTAXMETHOD NUMERIC(1,0),               
    @LOUTSTATIONPARTY BIT,          
    @CSTATECODE  VARCHAR(7),          
    @CCURRENTSTATECODE VARCHAR(7),        
    @NLOCTYPE  INT,       
    @NLOCFRTYPE  INT,        
    @CCHALLANID  VARCHAR(40),          
    @NCHALLANDISCPER NUMERIC(6,2),               
    @NCHALLANTAXPER NUMERIC(6,2),        
    @CBRAND   VARCHAR(25),        
    @CSUBSECTION VARCHAR(50),        
    @CLOC_DISC  NUMERIC(10,2) ,        
    @NTAXPER  NUMERIC(6,2),              
    @NDISCPER  NUMERIC(6,2),           
    @NDISCAMT  NUMERIC(10,4),              
    @NOCTROIPER  NUMERIC(6,2),              
    @NOCTROI  NUMERIC(10,4),        
    @NWSPDISCOUNTPER NUMERIC(10,2),        
    @NPARTYDISCOUNTPER NUMERIC(10,2),        
    @NFORMTAXPER  NUMERIC(10,2),        
    @CITEMCATEGORY VARCHAR(40),        
    @CHOLOCID  CHAR(4),          
    @CCURLOCID  CHAR(4),@NITEMDISCPCT NUMERIC(7,3),@NBILLDISCPCT NUMERIC(7,3),        
    @LPURLOC  BIT,@NGROSSMRP NUMERIC(10,2),@NGROSSMRPVAL NUMERIC(10,2),        
    @NCURRENTTAXPCT  NUMERIC(6,2),@CDNDTAXINEXCISEMRP VARCHAR(2),@NEXCISEACCPCT NUMERIC(6,2),  
    @NEXCISEACCAMT NUMERIC(10,2),@NEXCISEDUTYPCT NUMERIC(6,2),@NEXCISEDUTYAMT NUMERIC(12,4),  
    @NEXCISEEDUCESSPCT NUMERIC(6,2),@NEXCISEEDUCESSAMT NUMERIC(10,2),@NEXCISEHEDUCESSPCT NUMERIC(6,2),  
    @NEXCISEHEDUCESSAMT NUMERIC(10,2),@CCONSIDERNETEXCISEMRPVAL VARCHAR(2),@NEXCISEMRP NUMERIC(10,2),  
    @NBASEAMOUNTFORTAX NUMERIC(10,2),@CENABLEEXCISEDUTY VARCHAR(2),@CEXCISEDUTYPCT VARCHAR(10),@CEXCISEACCPCT VARCHAR(10),  
    @BEXCISABLEITEM BIT,@CMINEXCISABLEMRP VARCHAR(10),@NMINEXCISABLEMRP NUMERIC(10,2)  
         
         
	  DECLARE @CRETINVRATE TABLE        
	  (        
	   PRODUCT_CODE VARCHAR(50),RATE NUMERIC(10,2), DISCOUNT_PERCENTAGE NUMERIC(6,2), DISCOUNT_AMOUNT NUMERIC(12,4),                
	   OCTROI_PERCENTAGE NUMERIC(6,2), OCTROI_AMOUNT NUMERIC(10,2), NET_RATE NUMERIC(12,4), RATE1 NUMERIC(10,4),                
	   RATE2 NUMERIC(10,4), RATE3 NUMERIC(10,4), TAX_AMOUNT NUMERIC(12,4), TAX_STATUS VARCHAR(10),              
	   TAX_PERCENTAGE NUMERIC(6,2), INV_TAX_STATUS VARCHAR(10), TAX_METHOD NUMERIC(1,0),        
	   CURRENT_TAX_PERCENTAGE NUMERIC(6,2),ITEM_EXCISE_MRP NUMERIC(10,2),ITEM_EXCISE_ACCESSIBLE_PERCENTAGE NUMERIC(6,2),  
	   ITEM_EXCISE_ACCESSIBLE_AMOUNT NUMERIC(10,2),ITEM_EXCISE_DUTY_PERCENTAGE NUMERIC(6,2),ITEM_EXCISE_DUTY_AMOUNT NUMERIC(12,4),  
	   ITEM_EXCISE_EDU_CESS_PERCENTAGE NUMERIC(6,2),ITEM_EXCISE_EDU_CESS_AMOUNT NUMERIC(10,2),  
	   ITEM_EXCISE_HEDU_CESS_PERCENTAGE NUMERIC(6,2),ITEM_EXCISE_HEDU_CESS_AMOUNT NUMERIC(10,2),QUANTITY NUMERIC(10,2),ITEM_EXCISE_MRPVAL NUMERIC(10,2),
	   BASEAMOUNT_FOR_TAX NUMERIC(10,2),EXCISABLE BIT,MRP NUMERIC(10,2),WS_PRICE NUMERIC(10,2)  
	  )                    
	                      
	  SET @NTAXPER = 0                
	  SET @NDISCPER = 0              
	  SET @NOCTROIPER = 0        
	  SET @NOCTROI = 0        
	  SET @NCURRENTTAXPCT=0        
	         
	  -- CURRENT STATE CODE        
	  SELECT @CCURRENTSTATECODE = STATE_CODE,@CCURLOCID = DEPT_ID,@LPURLOC=PUR_LOC        
	  FROM LOC_VIEW WHERE DEPT_ID = (SELECT DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID  )        
	          
	  SELECT TOP 1 @CHOLOCID= [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'         
	          
	 --  IF @CCURLOCID<>@CHOLOCID AND @LPURLOC=0        
	 --  SET @CDEPTID=@CCURLOCID        
	  IF ISNULL(@CDEPTID,'')=''        
	   SET @CDEPTID=@CCURLOCID        

		IF @CPRODUCTCODE<>''
		BEGIN
			DELETE FROM SKU_GETINVRATE WHERE SP_ID=@@SPID
			
			INSERT SKU_GETINVRATE (PRODUCT_CODE,SP_ID,QUANTITY)
			SELECT @CPRODUCTCODE,@@SPID,@NQUANTITY
			
			SET @NSPID=@@SPID
		END	

		INSERT @CRETINVRATE (PRODUCT_CODE,QUANTITY,EXCISABLE,MRP,WS_PRICE,RATE)
		SELECT A.PRODUCT_CODE,QUANTITY,D.EXCISABLE,B.MRP,B.WS_PRICE,B.WS_PRICE	
		FROM SKU_GETINVRATE A (NOLOCK)
		JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
		JOIN ARTICLE C ON C.ARTICLE_CODE=B.ARTICLE_CODE
		JOIN SECTIOND D ON D.SUB_SECTION_CODE=C.SUB_SECTION_CODE
		WHERE SP_ID=@NSPID 
		
	         
	  -- PARTY STATE CODE        
	  SELECT @CSTATECODE = STATE_CODE,        
	   @NLOCTYPE = LOC_TYPE,        
	   @NLOCFRTYPE = FR_TYPE        
	  FROM LOC_VIEW WHERE DEPT_ID = @CDEPTID        
	  
	      
	  SELECT  @LOUTSTATIONPARTY = OUTSTATION_PARTY FROM LMP01106 WHERE AC_CODE=@CACCODE        
	    
	  SELECT @NTAXPERCENTAGE = TAX_PERCENTAGE FROM FORM WHERE FORM_ID = @CFORMID    
	   
	  SELECT TOP 1 @CENABLEEXCISEDUTY=VALUE FROM CONFIG WHERE  CONFIG_OPTION='ENABLE_EXCISE_DUTY'  
	    
	  PRINT 'CAL EXCISE-0'  
	  
	  UPDATE @CRETINVRATE SET TAX_PERCENTAGE=@NTAXPERCENTAGE    

	  UPDATE @CRETINVRATE SET ITEM_EXCISE_ACCESSIBLE_AMOUNT=0,ITEM_EXCISE_DUTY_PERCENTAGE=0,ITEM_EXCISE_DUTY_AMOUNT=0,ITEM_EXCISE_EDU_CESS_PERCENTAGE=0,
	  ITEM_EXCISE_EDU_CESS_AMOUNT=0,ITEM_EXCISE_HEDU_CESS_PERCENTAGE=0,ITEM_EXCISE_HEDU_CESS_AMOUNT=0,
	  ITEM_EXCISE_MRP=0
	      
	  IF ISNULL(@CENABLEEXCISEDUTY,'')='1'
	  BEGIN  
	    
		  PRINT 'CAL EXCISE-1'  
		  
		  SELECT @NEXCISEEDUCESSPCT=0,@NEXCISEHEDUCESSPCT=0    
		  SELECT TOP 1 @CMINEXCISABLEMRP=VALUE FROM CONFIG WHERE CONFIG_OPTION='MINIMUM_MRP_FOR_EXCISE'  
		  SELECT TOP 1  @CEXCISEACCPCT=VALUE FROM CONFIG WHERE  CONFIG_OPTION='EXCISE_ACCESSIBLE_PERCENTAGE'   
		  SELECT TOP 1  @CEXCISEDUTYPCT=VALUE FROM CONFIG WHERE CONFIG_OPTION='EXCISE_DUTY_PERCENTAGE'  
		     
		  IF ISNULL(@CMINEXCISABLEMRP,'') IN ('','0')  
			SET @NMINEXCISABLEMRP=1000  
		  ELSE  
			SET @NMINEXCISABLEMRP=@CMINEXCISABLEMRP  
		         
		  IF ISNULL(@CEXCISEACCPCT,'') IN ('','0')  
			SET @NEXCISEACCPCT=60  
		  ELSE  
			SET @NEXCISEACCPCT=@CEXCISEACCPCT  
		  
		  IF ISNULL(@CEXCISEDUTYPCT,'') IN ('','0')  
			SET @NEXCISEDUTYPCT=2  
		  ELSE  
			SET @NEXCISEDUTYPCT=@CEXCISEDUTYPCT  
		     
		  PRINT 'CAL EXCISE-3'    
		  SELECT TOP 1 @CDNDTAXINEXCISEMRP=VALUE FROM CONFIG WHERE CONFIG_OPTION='DND_TAX_IN_EXCISEMRP'  
		    
		  SELECT TOP 1 @CCONSIDERNETEXCISEMRPVAL=VALUE FROM CONFIG WHERE CONFIG_OPTION='NETEXCISEMRP_EXCISE_CALC'  
		    
		  SET @CDNDTAXINEXCISEMRP='1'  
		  
		  SELECT @CDNDTAXINEXCISEMRP=ISNULL(@CDNDTAXINEXCISEMRP,''),@CCONSIDERNETEXCISEMRPVAL=ISNULL(@CCONSIDERNETEXCISEMRPVAL,'')  
		    
		  UPDATE @CRETINVRATE SET ITEM_EXCISE_MRP=MRP-(CASE WHEN @CDNDTAXINEXCISEMRP='1' THEN 0 ELSE MRP*@NTAXPERCENTAGE/(100+@NTAXPERCENTAGE) END)   
		  WHERE EXCISABLE=1 AND MRP>=@NMINEXCISABLEMRP
		    
		  UPDATE @CRETINVRATE SET ITEM_EXCISE_MRPVAL= (ITEM_EXCISE_MRP*QUANTITY) 
		  
		  UPDATE @CRETINVRATE SET ITEM_EXCISE_ACCESSIBLE_PERCENTAGE=@NEXCISEACCPCT,ITEM_EXCISE_ACCESSIBLE_AMOUNT=ITEM_EXCISE_MRPVAL*@NEXCISEACCPCT/100     
		    
		  UPDATE @CRETINVRATE SET ITEM_EXCISE_DUTY_PERCENTAGE=@NEXCISEDUTYPCT,ITEM_EXCISE_DUTY_AMOUNT=ITEM_EXCISE_ACCESSIBLE_AMOUNT*@NEXCISEDUTYPCT/100  
		    
		  UPDATE @CRETINVRATE SET  ITEM_EXCISE_EDU_CESS_PERCENTAGE=@NEXCISEEDUCESSPCT,
		  ITEM_EXCISE_EDU_CESS_AMOUNT=ITEM_EXCISE_DUTY_AMOUNT*@NEXCISEEDUCESSPCT/100,
		  ITEM_EXCISE_HEDU_CESS_PERCENTAGE=@NEXCISEHEDUCESSPCT,
		  ITEM_EXCISE_HEDU_CESS_AMOUNT=ITEM_EXCISE_DUTY_AMOUNT*@NEXCISEHEDUCESSPCT/100
		  WHERE EXCISABLE=1 AND MRP>=@NMINEXCISABLEMRP	
	  END 
	       
LBLNEXT:         
	  SELECT @NBILLDISCPCT= @NBILLLEVELDISCOUNT  
	  
	  UPDATE @CRETINVRATE SET DISCOUNT_PERCENTAGE=0,DISCOUNT_AMOUNT=0
	   
	  UPDATE @CRETINVRATE SET  BASEAMOUNT_FOR_TAX = RATE - (RATE*DISCOUNT_PERCENTAGE/100)   
	  
	  UPDATE @CRETINVRATE SET  BASEAMOUNT_FOR_TAX = BASEAMOUNT_FOR_TAX - (BASEAMOUNT_FOR_TAX*@NBILLDISCPCT/100)  
	    
	  UPDATE @CRETINVRATE SET  BASEAMOUNT_FOR_TAX = (BASEAMOUNT_FOR_TAX*QUANTITY)+ ITEM_EXCISE_DUTY_AMOUNT+ITEM_EXCISE_EDU_CESS_AMOUNT+ITEM_EXCISE_HEDU_CESS_AMOUNT
	    
	  UPDATE @CRETINVRATE SET  TAX_AMOUNT = (BASEAMOUNT_FOR_TAX*TAX_PERCENTAGE/100)  
	  
	  UPDATE @CRETINVRATE SET NET_RATE=(RATE-(DISCOUNT_AMOUNT/QUANTITY)+(TAX_AMOUNT/QUANTITY))
	  
	  UPDATE @CRETINVRATE SET TAX_METHOD=1,INV_TAX_STATUS = 'T'+(CASE WHEN TAX_PERCENTAGE=0 THEN 'F' ELSE LTRIM(STR(TAX_PERCENTAGE,6,2)) END)
	         
	  SELECT PRODUCT_CODE,RATE,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT ,OCTROI_PERCENTAGE ,	OCTROI_AMOUNT ,	NET_RATE ,	
       RATE1 ,RATE2,	RATE3 ,	TAX_AMOUNT ,TAX_STATUS ,TAX_PERCENTAGE ,INV_TAX_STATUS ,TAX_METHOD ,
       CURRENT_TAX_PERCENTAGE ,	ITEM_EXCISE_MRP,ITEM_EXCISE_ACCESSIBLE_PERCENTAGE ,	ITEM_EXCISE_ACCESSIBLE_AMOUNT ,	
       ITEM_EXCISE_DUTY_PERCENTAGE ,ITEM_EXCISE_DUTY_AMOUNT,ITEM_EXCISE_EDU_CESS_PERCENTAGE ,ITEM_EXCISE_EDU_CESS_AMOUNT ,	
       ITEM_EXCISE_HEDU_CESS_PERCENTAGE ,	ITEM_EXCISE_HEDU_CESS_AMOUNT FROM @CRETINVRATE        
	  
	  RETURN                
END
