CREATE PROCEDURE SP3S_PRINT_UDRF 
(
	@CXN_TYPE VARCHAR(10)='WSL'
   ,@CMEMO_ID VARCHAR(40)
   ,@CREPORT_ID VARCHAR(15)
)
--WITH ENCRYPTION
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
/*
EXEC SP3S_PRINT_UDRF 'WSL','000111600M1-00048','WSL0000001'
EXEC SP3S_PRINT_UDRF 'WSL','SAMPLE','WSL0000001'
*/
IF @CXN_TYPE='WSL'
	GOTO LBL_WSLPRINT
ELSE
	GOTO END_PROC

LBL_WSLPRINT:

IF  @CMEMO_ID='SAMPLE' --AND @CREPORT_ID='WSL0000001'
BEGIN
     
	--RETURN THE SAMPLE DATA
	IF OBJECT_ID('TEMPDB..#TMPMST','U') IS NOT NULL
	   DROP TABLE #TMPMST
	   	
	SELECT 'ABC COMPANY' AS COMPANY_NAME
		  ,'B-51,SECTOR 65,NOIDA(U.P),INDIA' AS COMPANY_ADDRESS
		  ,'011-20412563' AS [PHONE_FAX]
		  ,'ATMPG05687' AS PAN_NO
		  ,'85632544412' AS TIN_NO
		  ,'NO52365255' AS TAN_NO
		  ,(SELECT TOP 1 LOGO_PATH FROM COMPANY WHERE ISNULL(LOGO_PATH,'')<>'' ) AS LOGO_PATH
		  ,'WWW.ABCCOMPANY.COM' AS WEB_ADDRESS
		  ,'SUPPORT@ABCCOMPANY.COM' AS EMAIL_ID	
	INTO #TMPMST
	
	
	DECLARE @COLUMN_NAME VARCHAR(50),@COLUMN_EXPRESSION VARCHAR(50),@ISENABLED BIT,
	        @DTSQL NVARCHAR(MAX),@SR AS INT,@CNAME VARCHAR(100),@COLUMN_EXPRESSION_NEW VARCHAR(50)
	SET @SR=0
	DECLARE CUR_ADDRESS CURSOR
	FOR
	SELECT COLUMN_NAME,COLUMN_EXPRESSION,COLUMN_EXPRESSION_NEW,ISENABLED FROM UDRF_EXP_COMP 
	WHERE REPORT_ID=@CREPORT_ID 
	ORDER BY ISENABLED DESC ,COLUMN_ORDER 
	OPEN CUR_ADDRESS
	FETCH NEXT FROM CUR_ADDRESS INTO @COLUMN_NAME,@COLUMN_EXPRESSION,@COLUMN_EXPRESSION_NEW,@ISENABLED
	WHILE @@FETCH_STATUS =0
	BEGIN
	   SET @SR=@SR+1
	   SET @CNAME='COLUMN_'+CAST(@SR AS VARCHAR(100))
	   
	  SET @DTSQL=N'ALTER TABLE #TMPMST ADD '+@CNAME+' VARCHAR(100)'
	  PRINT @DTSQL
	  EXEC SP_EXECUTESQL @DTSQL 
	  
	  IF @ISENABLED=1
	  BEGIN
		  IF @COLUMN_NAME='PHONES_FAX'
	         SET @DTSQL=N'UPDATE #TMPMST SET '+@CNAME+'=''PHONE            :  011-20412563''' 
	       ELSE IF @COLUMN_NAME='PAN_NO'
	         SET @DTSQL=N'UPDATE #TMPMST SET '+@CNAME+'=''PAN_NO          :  ATMPG05687'''
	       ELSE IF @COLUMN_NAME='WEB_ADDRESS'
	         SET @DTSQL=N'UPDATE #TMPMST SET '+@CNAME+'=''WEB_ADDRESS :  WWW.ABCCOMPANY.COM'''
	       ELSE IF @COLUMN_NAME='EMAIL_ID'
	         SET @DTSQL=N'UPDATE #TMPMST SET '+@CNAME+'=''EMAIL_ID         :  SUPPORT@ABCCOMPANY.COM'''
	       ELSE IF @COLUMN_NAME='TIN_NO'
	         SET @DTSQL=N'UPDATE #TMPMST SET '+@CNAME+'=''TIN_NO           :  85632544412'''  
	       ELSE IF @COLUMN_NAME='TAN_NO'
	         SET @DTSQL=N'UPDATE #TMPMST SET '+@CNAME+'=''TAN_NO          :  NO52365255'''  
	       
	  END
	  ELSE
	  BEGIN
		SET @DTSQL=N'UPDATE #TMPMST SET '+@CNAME+'='''''
	  END
	  
	  PRINT @DTSQL
	  EXEC SP_EXECUTESQL @DTSQL

	FETCH NEXT FROM CUR_ADDRESS INTO @COLUMN_NAME,@COLUMN_EXPRESSION,@COLUMN_EXPRESSION_NEW,@ISENABLED
	END
	CLOSE CUR_ADDRESS
	DEALLOCATE CUR_ADDRESS
	
	
	SELECT * FROM #TMPMST
	
	
	SELECT 'ABC DESIGNERS' AS CUSTOMER_NAME
		   ,'419-A ,KATRA CHOBAN, SOUTH EX.-II,NEW DELHI,NEW  DELHI' AS [ADDRESS]
		   ,'RAM / HARI / MOHAN ' AS CONTACT_PERSON
		   ,'SAMPLE' AS INV_NO
		   ,CONVERT(VARCHAR,GETDATE(),105) AS INV_DT
		   ,'30' AS CREDIT_TERMS 
		   ,160900.00 AS SUBTOTAL
		   ,10.00 AS DISCOUNT_PERCENTAGE
		   ,16090.00 AS DISCOUNT_AMOUNT
		   ,595.50 AS TAX_AMOUNT
		   ,500.00 AS FREIGHT
		   ,1000.00 AS INSURANCE
		   ,6675.72 AS NET_AMOUNT
		   ,2.00 AS OCTROI_PERCENTAGE
		   ,95.72 AS OCTROI_AMOUNT
		   ,50.00 AS OTHER_CHARGES
		   ,0.13 AS ROUND_OFF			
		   ,'SAMPLE INVOICE FORMAT.' AS REMARKS
		   ,'SUPPORT@SOFTINFO.COM' AS EMAIL_ADDRESS
		   ,'28532544412' AS TIN_NO	
		   ,BILTY_NO='01101/01'
		   ,BILTY_DT='2015-06-01'
		   ,TRANSPORTER_NAME='ABHAY PRAKASH CO.'  
	
	      EXEC SP_UDRF_SAMPLE_PRINT @CREPORT_ID
	
END
ELSE
BEGIN
     
	--RETURN ACTUAL DATA FROM TRANSACTIONS
	IF OBJECT_ID('TEMPDB..#TMPMST1','U') IS NOT NULL
	   DROP TABLE #TMPMST1
	   
	SELECT COMPANY_NAME
		  ,ADDRESS1+' '+ADDRESS2+' '+CITY AS COMPANY_ADDRESS
		  ,PHONES_FAX AS [PHONE_FAX]
		  ,PAN_NO
		  ,TIN_NO
		  ,TAN_NO
		  ,LOGO_PATH
		  ,WEB_ADDRESS
		  ,EMAIL_ID	
		  INTO #TMPMST1
	FROM COMPANY 
	WHERE COMPANY_CODE='01'
	
	
	DECLARE @COLUMN_NAME1 VARCHAR(50),@COLUMN_EXPRESSION1 VARCHAR(50),@ISENABLED1 BIT,@DTSQL1 NVARCHAR(MAX),@SR1 AS INT,@CNAME1 VARCHAR(100)
	SET @SR1=0
	DECLARE CUR_ADDRESS1 CURSOR
	FOR
	SELECT COLUMN_NAME,COLUMN_EXPRESSION,ISENABLED FROM UDRF_EXP_COMP 
	WHERE REPORT_ID=@CREPORT_ID 
	ORDER BY ISENABLED DESC ,COLUMN_ORDER 
	OPEN CUR_ADDRESS1
	FETCH NEXT FROM CUR_ADDRESS1 INTO @COLUMN_NAME1,@COLUMN_EXPRESSION1,@ISENABLED1
	WHILE @@FETCH_STATUS =0
	BEGIN
	   SET @SR1=@SR1+1
	   SET @CNAME1='COLUMN_'+CAST(@SR1 AS VARCHAR(100))
	   
	  SET @DTSQL1=N'ALTER TABLE #TMPMST1 ADD '+@CNAME1+' VARCHAR(100)'
	  PRINT @DTSQL1
	  EXEC SP_EXECUTESQL @DTSQL1 
	  
	  IF @ISENABLED1=1
	  BEGIN
	         
	      SET @DTSQL1=N'UPDATE #TMPMST1 SET '+@CNAME1+'= CASE 
	                 WHEN '''+@COLUMN_NAME1+'''=''PHONES_FAX'' THEN ''PHONE''+ SPACE(12)
	                 WHEN '''+@COLUMN_NAME1+'''=''PAN_NO'' THEN ''PAN_NO''+ SPACE(10)
	                 WHEN '''+@COLUMN_NAME1+'''=''WEB_ADDRESS'' THEN ''WEB_ADDRESS''+ SPACE(1)
	                 WHEN '''+@COLUMN_NAME1+'''=''EMAIL_ID'' THEN ''EMAIL_ID''+ SPACE(9)
	                 WHEN '''+@COLUMN_NAME1+'''=''TIN_NO'' THEN ''TIN_NO''+ SPACE(11)
	                 WHEN '''+@COLUMN_NAME1+'''=''TAN_NO'' THEN ''TAN_NO''+ SPACE(10)
	                 ELSE '''' END + '':  ''+ REPLACE((SELECT TOP 1  '+RTRIM(LTRIM(@COLUMN_NAME1))+' FROM COMPANY WHERE COMPANY_CODE<>''00''),'' '','''')'
	      PRINT @DTSQL1
	      EXEC SP_EXECUTESQL @DTSQL1
	       
	  END
	  ELSE
	  BEGIN
		SET @DTSQL1=N'UPDATE #TMPMST1 SET '+@CNAME1+'='''''
	  END
	  
	  PRINT @DTSQL1
	  EXEC SP_EXECUTESQL @DTSQL1

	FETCH NEXT FROM CUR_ADDRESS1 INTO @COLUMN_NAME1,@COLUMN_EXPRESSION1,@ISENABLED1
	END
	CLOSE CUR_ADDRESS1
	DEALLOCATE CUR_ADDRESS1
	
	SELECT * FROM #TMPMST1

	SELECT C.AC_NAME AS CUSTOMER_NAME
		   ,C.ADDRESS0+' '+C.ADDRESS1+' '+C.ADDRESS2+' '+C.AREA_NAME+' '+C.CITY+' '
		    +C.STATE AS [ADDRESS]
		   ,E.EMP_NAME
			+(CASE WHEN ISNULL(E.EMP_NAME,'')<>'' 
				 THEN (CASE WHEN ISNULL(E1.EMP_NAME,'')<>'' THEN ' / '+E1.EMP_NAME ELSE '' END)
			  ELSE ISNULL(E1.EMP_NAME,'') END)	 
			+(CASE WHEN ISNULL(E.EMP_NAME,'')+ISNULL(E1.EMP_NAME,'')<>''
				 THEN (CASE WHEN ISNULL(E2.EMP_NAME,'')<>'' THEN ' / '+E2.EMP_NAME ELSE '' END)
			  ELSE ISNULL(E2.EMP_NAME,'') END) AS CONTACT_PERSON
		   ,A.INV_NO
		   ,CONVERT(VARCHAR,A.INV_DT,105) AS INV_DT
		   ,C.CREDIT_DAYS AS CREDIT_TERMS 
		   ,A.SUBTOTAL
		   ,A.DISCOUNT_PERCENTAGE
		   ,A.DISCOUNT_AMOUNT
		   ,SUM(D.ITEM_TAX_AMOUNT) AS TAX_AMOUNT
		   ,A.FREIGHT
		   ,A.INSURANCE
		   ,A.NET_AMOUNT
		   ,A.OCTROI_PERCENTAGE
		   ,A.OCTROI_AMOUNT
		   ,A.OTHER_CHARGES
		   ,A.ROUND_OFF
		   ,A.REMARKS
		   ,C.E_MAIL AS EMAIL_ADDRESS
		   ,C.TIN_NO
		   ,ISNULL(ANGM.BILTY_NO,'') AS BILTY_NO
		   ,ISNULL(CONVERT(VARCHAR,ANGM.BILTY_DT,105),'') AS BILTY_DT
		   ,ISNULL(ANGM.ANGADIA_NAME,'') AS TRANSPORTER_NAME
   FROM INM01106 A 
   JOIN LMV01106 C ON A.AC_CODE=C.AC_CODE
   JOIN IND01106 D ON A.INV_ID =D.INV_ID
   JOIN EMPLOYEE E ON E.EMP_CODE =D.EMP_CODE 
   JOIN EMPLOYEE E1 ON E1.EMP_CODE =D.EMP_CODE1 
   JOIN EMPLOYEE E2 ON E2.EMP_CODE =D.EMP_CODE2 
   JOIN COMPANY CMP ON CMP.COMPANY_CODE='01' 
   LEFT JOIN
   (     
		SELECT b.REF_MEMO_ID , A.BILTY_NO,A. RECEIPT_DT AS BILTY_DT ,D.ANGADIA_NAME  
		FROM PARCEL_MST A
		JOIN PARCEL_DET B ON A.PARCEL_MEMO_ID =B.PARCEL_MEMO_ID 
		JOIN ANGM D ON A.ANGADIA_CODE =D.ANGADIA_CODE 
		WHERE A.XN_TYPE ='WSL'
   ) ANGM ON A.INV_ID=ANGM.REF_MEMO_ID 
   WHERE A.INV_ID=@CMEMO_ID
   GROUP BY A.INV_NO,A.INV_DT,A.INV_ID,A.AC_CODE,C.AC_NAME
		   ,A.SUBTOTAL,A.DISCOUNT_PERCENTAGE
		   ,A.DISCOUNT_AMOUNT,A.FREIGHT,A.INSURANCE,A.NET_AMOUNT,A.OCTROI_PERCENTAGE,A.OCTROI_AMOUNT
		   ,A.OTHER_CHARGES,A.ROUND_OFF,C.ADDRESS0+' '+C.ADDRESS1+' '+C.ADDRESS2+' '+C.AREA_NAME+ ' ' +C.CITY +' '+C.STATE 
		   ,A.NET_AMOUNT,E.EMP_NAME,E1.EMP_NAME,E2.EMP_NAME,C.CREDIT_DAYS ,A.REMARKS
		   ,C.E_MAIL,C.TIN_NO ,ANGM.BILTY_NO
		   ,ANGM.BILTY_DT
		   ,ANGM.ANGADIA_NAME
          
   DECLARE @CSEPARATOR VARCHAR(2),@CDESC VARCHAR(MAX),@CCMD NVARCHAR(MAX)
   
   SELECT @CDESC=ISNULL(@CDESC+'+'' '+SEPARATOR+' ''+','')
		+(CASE WHEN ISNULL(VAL_LEN,0)=0 THEN '' ELSE 'LEFT(' END)+COLUMN_NAME
		+(CASE WHEN ISNULL(VAL_LEN,0)=0 THEN '' ELSE ','+LTRIM(RTRIM(STR(VAL_LEN)))+')' END)
   FROM UDRF_EXP WHERE REPORT_ID=@CREPORT_ID AND REPORT_VALUE='DESCRIPTION'
   AND ISENABLED=1
   
   SET @CDESC=REPLACE(@CDESC,'PRODUCT_CODE','SKU.PRODUCT_CODE')
   
   SET @CDESC=ISNULL(@CDESC,'')

   SET @CCMD=N'SELECT '+(CASE WHEN @CDESC='' THEN '' ELSE @CDESC+' AS DESCRIPTION,' END)
			  +'CONVERT(NUMERIC(18,2),SUM(IND.QUANTITY)) AS QUANTITY 
			   ,UOM.UOM_NAME,IND.RATE,IND.MRP,CONVERT(NUMERIC(18,2),SUM(QUANTITY*NET_RATE)) AS AMOUNT
			   ,CONVERT(NUMERIC(18,2),IND.DISCOUNT_PERCENTAGE) AS DISCOUNT_PERCENTAGE 
		       ,CONVERT(NUMERIC(18,2),SUM(IND.DISCOUNT_AMOUNT)) AS DISCOUNT_AMOUNT 
		       ,CONVERT(NUMERIC(18,2),IND.ITEM_TAX_PERCENTAGE) AS  ITEM_TAX_PERCENTAGE
		       ,CONVERT(NUMERIC(18,2),SUM(IND.ITEM_TAX_AMOUNT)) AS ITEM_TAX_AMOUNT
  FROM IND01106 IND(NOLOCK)
  JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =IND.PRODUCT_CODE 
  JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
  JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE 
  JOIN SECTIOND (NOLOCK) ON ART.SUB_SECTION_CODE=SECTIOND.SUB_SECTION_CODE
  JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE=SECTIONM.SECTION_CODE
  JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE 
  JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE 
  JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE =SKU.PARA3_CODE 
  JOIN PARA4 P4 (NOLOCK) ON P4.PARA4_CODE =SKU.PARA4_CODE 
  JOIN PARA5 P5 (NOLOCK) ON P5.PARA5_CODE =SKU.PARA5_CODE 
  JOIN PARA6 P6 (NOLOCK) ON P6.PARA6_CODE =SKU.PARA6_CODE
  LEFT OUTER JOIN ARTICLE_FIX_ATTR ATTR  (NOLOCK) ON ART.ARTICLE_CODE = ATTR.ARTICLE_CODE 
LEFT OUTER JOIN ATTR1_MST AT1 (NOLOCK) ON AT1.ATTR1_KEY_CODE=ATTR.ATTR1_KEY_CODE
LEFT OUTER JOIN ATTR2_MST AT2 (NOLOCK) ON AT2.ATTR2_KEY_CODE=ATTR.ATTR2_KEY_CODE
LEFT OUTER JOIN ATTR3_MST AT3 (NOLOCK) ON AT3.ATTR3_KEY_CODE=ATTR.ATTR3_KEY_CODE
LEFT OUTER JOIN ATTR4_MST AT4 (NOLOCK) ON AT4.ATTR4_KEY_CODE=ATTR.ATTR4_KEY_CODE
LEFT OUTER JOIN ATTR5_MST AT5 (NOLOCK) ON AT5.ATTR5_KEY_CODE=ATTR.ATTR5_KEY_CODE
LEFT OUTER JOIN ATTR6_MST AT6 (NOLOCK) ON AT6.ATTR6_KEY_CODE=ATTR.ATTR6_KEY_CODE
LEFT OUTER JOIN ATTR7_MST AT7 (NOLOCK) ON AT7.ATTR7_KEY_CODE=ATTR.ATTR7_KEY_CODE
LEFT OUTER JOIN ATTR8_MST AT8 (NOLOCK) ON AT8.ATTR8_KEY_CODE=ATTR.ATTR8_KEY_CODE
LEFT OUTER JOIN ATTR9_MST AT9 (NOLOCK) ON AT9.ATTR9_KEY_CODE=ATTR.ATTR9_KEY_CODE
LEFT OUTER JOIN ATTR10_MST AT10 (NOLOCK) ON AT10.ATTR10_KEY_CODE=ATTR.ATTR10_KEY_CODE
LEFT OUTER JOIN ATTR11_MST AT11 (NOLOCK) ON AT11.ATTR11_KEY_CODE=ATTR.ATTR11_KEY_CODE
LEFT OUTER JOIN ATTR12_MST AT12 (NOLOCK) ON AT12.ATTR12_KEY_CODE=ATTR.ATTR12_KEY_CODE
LEFT OUTER JOIN ATTR13_MST AT13 (NOLOCK) ON AT13.ATTR13_KEY_CODE=ATTR.ATTR13_KEY_CODE
LEFT OUTER JOIN ATTR14_MST AT14 (NOLOCK) ON AT14.ATTR14_KEY_CODE=ATTR.ATTR14_KEY_CODE
LEFT OUTER JOIN ATTR15_MST AT15 (NOLOCK) ON AT15.ATTR15_KEY_CODE=ATTR.ATTR15_KEY_CODE
LEFT OUTER JOIN ATTR16_MST AT16 (NOLOCK) ON AT16.ATTR16_KEY_CODE=ATTR.ATTR16_KEY_CODE
LEFT OUTER JOIN ATTR17_MST AT17 (NOLOCK) ON AT17.ATTR17_KEY_CODE=ATTR.ATTR17_KEY_CODE
LEFT OUTER JOIN ATTR18_MST AT18 (NOLOCK) ON AT18.ATTR18_KEY_CODE=ATTR.ATTR18_KEY_CODE
LEFT OUTER JOIN ATTR19_MST AT19 (NOLOCK) ON AT19.ATTR19_KEY_CODE=ATTR.ATTR19_KEY_CODE
LEFT OUTER JOIN ATTR20_MST AT20 (NOLOCK) ON AT20.ATTR20_KEY_CODE=ATTR.ATTR20_KEY_CODE
LEFT OUTER JOIN ATTR21_MST AT21 (NOLOCK) ON AT21.ATTR21_KEY_CODE=ATTR.ATTR21_KEY_CODE
LEFT OUTER JOIN ATTR22_MST AT22 (NOLOCK) ON AT22.ATTR22_KEY_CODE=ATTR.ATTR22_KEY_CODE
LEFT OUTER JOIN ATTR23_MST AT23 (NOLOCK) ON AT23.ATTR23_KEY_CODE=ATTR.ATTR23_KEY_CODE
LEFT OUTER JOIN ATTR24_MST AT24 (NOLOCK) ON AT24.ATTR24_KEY_CODE=ATTR.ATTR24_KEY_CODE
LEFT OUTER JOIN ATTR25_MST AT25(NOLOCK) ON AT25.ATTR25_KEY_CODE=ATTR.ATTR25_KEY_CODE
  WHERE IND.INV_ID='''+@CMEMO_ID+'''
  GROUP BY '+(CASE WHEN @CDESC='' THEN '' ELSE @CDESC+' ,' END)+'UOM.UOM_NAME
			,IND.RATE,IND.MRP,IND.DISCOUNT_PERCENTAGE,IND.ITEM_TAX_PERCENTAGE'
  PRINT @CCMD
  EXEC SP_EXECUTESQL @CCMD	
  
  --SELECT SHOW_COMPANY_DETAILS,COMPANY_NAME,COMPANY_ADDRESS,COMPANY_LOGO,MSG,TNC 
  --FROM UDRF_MST WHERE REPORT_ID=@CREPORT_ID
  
  --SELECT DISPLAY,HEADER_ORG FROM UDRF_DET WHERE REPORT_ID=@CREPORT_ID
  
END
GOTO END_PROC

END_PROC:	
END	
--END OF PROCEDURE - SP3S_PRINT_UDRF
