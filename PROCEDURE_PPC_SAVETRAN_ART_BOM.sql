CREATE PROCEDURE PPC_SAVETRAN_ART_BOM
(
	 @NSPID			INT=0,
	 @CARTICLE_CODE VARCHAR(100)='',
	 @CSIZEGROUP_CODE VARCHAR(100)
)
----WITH ENCRYPTION
AS
BEGIN
DECLARE @CERRMSG VARCHAR(500),@CSTEP VARCHAR(10)
	   ,@CCMD NVARCHAR(MAX),@CNEWARTICLE_CODE VARCHAR(10)

DECLARE @TOUTPUT TABLE(ARTICLE_CODE VARCHAR(50),ERRMSG VARCHAR(500))

---LIST OF TABLES TO SAVE
DECLARE @TBOM_ARTILCE VARCHAR(100)
--,@TSKU VARCHAR(100)


SET @TBOM_ARTILCE='ART_PPC_ART_BOM_UPLOAD'
--SET @TSKU=@CTABLE_PREFIX+'SKU'+@CTABLE_SUFFIX

BEGIN TRY
BEGIN TRANSACTION
		   SET @CSTEP=10
		  
			--VALIDATION OF VALID ARTICLE
			SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TBOM_ARTILCE+' A LEFT JOIN ARTICLE B ON A.ARTICLE_CODE=B.ARTICLE_CODE
								  WHERE B.ARTICLE_CODE IS NULL AND A.SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''')
					        SET @CERRMSG=''INVALID ARTICLE.'' '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT	
			
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC	
				
		
			SET @CSTEP=80
			--VALIDATION ON PARA1_CODE OF BOM
			SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TBOM_ARTILCE+' A LEFT JOIN ARTICLE B ON A.BOM_ARTICLE_CODE=B.ARTICLE_CODE
								  WHERE B.ARTICLE_CODE IS NULL AND A.SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''')
					        SET @CERRMSG=''INVALID BOM. '' '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT	
			
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC		
					
			SET @CSTEP=240
			SET @CNEWARTICLE_CODE=@CARTICLE_CODE
			---GET THE SIZEGROUP_CODE OF MODIFIED SIZEGROUP
			--SET @CCMD=N'SELECT @CNEWARTICLE_CODE=ARTICLE_CODE FROM '+@TBOM_ARTILCE +' WHERE  SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
			--PRINT @CCMD
			--EXEC SP_EXECUTESQL @CCMD,N'@CNEWARTICLE_CODE VARCHAR(10) OUTPUT',@CNEWARTICLE_CODE OUTPUT
			
			SET @CCMD = N'UPDATE ' + @TBOM_ARTILCE + ' SET ROW_ID =  CONVERT(VARCHAR(40), NEWID())
					  WHERE LEFT(ROW_ID,5) = ''LATER'' AND SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''' '
		    EXEC SP_EXECUTESQL @CCMD
			
			SET @CSTEP=250
			--DELETE THE EXISTING RECORD FOR THIS SIZEGROUP IN PPC_SIZEGROUP_PARA2
			
			
			--DELETE A FROM  PPC_ART_BOM A WHERE A.ARTICLE_CODE=@CARTICLE_CODE
				
			DELETE A FROM  PPC_ART_BOM A
			WHERE A.ARTICLE_CODE=@CNEWARTICLE_CODE AND A.BOM_SIZEGROUP_CODE=@CSIZEGROUP_CODE
			
	
	DECLARE @FILTER VARCHAR(MAX)
	SET @FILTER=' B.SP_ID= '''+LTRIM(RTRIM(STR(@NSPID)))+''' '	
	
	--SP_INSERTSTR PPC_SIZEGROUP_PARA2
    EXEC UPDATEMASTERXN 
			 @CSOURCEDB=''
			,@CSOURCETABLE=@TBOM_ARTILCE
			,@CDESTDB=''
			,@CDESTTABLE='PPC_ART_BOM'
			,@CKEYFIELD1='ARTICLE_CODE'
			,@CKEYFIELD2='BOM_SIZEGROUP_CODE'
			,@CKEYFIELD3=''
			,@LINSERTONLY=0
			,@CFILTERCONDITION=@FILTER
			,@LUPDATEXNS=0
			,@CXNTYPE=''
			,@LUPDATEONLY=0
			,@CUSERID=''
			,@BALWAYSUPDATE=0

		
END TRY
BEGIN CATCH 
	SET @CERRMSG='SAVETRAN_SIZEGROUP: STEP - '+ISNULL(@CSTEP,'')+', MESSAGE - '+ERROR_MESSAGE() 
END CATCH

END_PROC:

IF @@TRANCOUNT>0  
 BEGIN  
  IF ISNULL(@CERRMSG,'')='' 
   COMMIT TRANSACTION  
  ELSE  
   ROLLBACK  
 END  

--DROP TEMP TABLES
IF ISNULL(@CERRMSG,'')=''
BEGIN
    DELETE FROM ART_PPC_ART_BOM_UPLOAD WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID)))
END

INSERT @TOUTPUT(ARTICLE_CODE,ERRMSG)
SELECT @CNEWARTICLE_CODE,ISNULL(@CERRMSG,'')

SELECT * FROM @TOUTPUT

END
--END OF PROCEDURE - SAVETRAN_SIZEGROUP
