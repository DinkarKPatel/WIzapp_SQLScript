CREATE PROCEDURE SP_BUYERSORDER_WSL_29
@CMEMOID VARCHAR(40),  
@CWHERE VARCHAR(500),  
@CFINYEAR VARCHAR(10),  
@NNAVMODE NUMERIC(2,0),
@CARTICLECODE CHAR(9)='',  
@CPARA2CODE CHAR(7)='',
@DTWHERE DATETIME ='',
@cLocId VARCHAR(5)=''
--WITH ENCRYPTION
 
AS    
BEGIN 
SELECT 0 AS CHK_SMS,A.ORDER_NO,A.ORDER_ID,CONVERT(VARCHAR(15),A.ORDER_DT,105) AS ORDER_DT,A.REF_NO
	,CONVERT(VARCHAR(15),A.TRAIL_DT,105) AS TRIAL_DT
	,(CASE WHEN A.AC_CODE='0000000000' 
	THEN (C.CUSTOMER_FNAME + ' ' + ISNULL(C.CUSTOMER_LNAME,'')) ELSE B.AC_NAME END) AS CUSTOMER_NAME
	,CONVERT(VARCHAR(15),A.DELIVERY_DT,105) AS DELIVERY_DT 
	FROM BUYER_ORDER_MST A 
	JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE 
	JOIN SKU_BO SBO ON SBO.ORDER_ID = A.ORDER_ID
	JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE 
	LEFT OUTER JOIN
	(
		 SELECT TOP 1 ORDER_ID FROM SKU_BO A 
		 JOIN CMD01106 B ON A.PRODUCT_CODE= B.PRODUCT_CODE 
		 JOIN CMM01106 C ON B.CM_ID = C.CM_ID WHERE C.CANCELLED = 0
	)DET ON A.ORDER_ID = DET.ORDER_ID
	WHERE A.CANCELLED = 0 
	AND A.APPROVED=1
	AND DET.ORDER_ID IS NULL 
	AND CONVERT(VARCHAR(15),DELIVERY_DT,101) <= @DTWHERE
END