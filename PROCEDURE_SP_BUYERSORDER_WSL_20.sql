CREATE PROCEDURE SP_BUYERSORDER_WSL_20
@CMEMOID VARCHAR(40),  
@CWHERE VARCHAR(500),  
@CFINYEAR VARCHAR(10),  
@NNAVMODE NUMERIC(2,0),
@CARTICLECODE CHAR(9)='',  
@CPARA2CODE CHAR(7)='',
@DTWHERE DATETIME ='',
@cLocId VARCHAR(5)=''
--WITH ENCRYPTION
 
AS    
BEGIN 
    
	DECLARE @BO_XTAB_PRINT VARCHAR(50)
	SELECT @BO_XTAB_PRINT=value  FROM config WHERE  config_option ='BO_XTAB_PRINT'

	IF ISNULL(@BO_XTAB_PRINT,'')='1'
	BEGIN
	    EXEC SP_BUYERSORDER_WSL_20_XTAB @CMEMOID,@CWHERE
		RETURN
	END


    DECLARE @DBNAME VARCHAR(100),@DTDQL NVARCHAR(MAX)
    SET @DBNAME=DB_NAME ()+'_IMAGE.dbo.'
    IF OBJECT_ID ('TEMPDB..#TMPIMG','U') IS NOT NULL
       DROP TABLE #TMPIMG
       
       SELECT A.ROW_ID ,A.ARTICLE_CODE,
       CAST(null AS VARBINARY(MAX)) AS PROD_IMAGE,
       CAST(null AS VARBINARY(MAX)) AS PROD_IMAGE1,
       CAST(null AS VARBINARY(MAX)) AS PROD_IMAGE2,
       CAST(null AS VARBINARY(MAX)) AS PROD_IMAGE3
       INTO #TMPIMG
       FROM BUYER_ORDER_DET A
       WHERE A.ORDER_ID =@CWHERE
      
      SET @DTDQL=N' UPDATE A SET  PROD_IMAGE=I.PROD_IMAGE ,
      PROD_IMAGE1=I.PROD_IMAGE1,
      PROD_IMAGE2=I.PROD_IMAGE2 ,
      PROD_IMAGE3=I.PROD_IMAGE3 
      FROM #TMPIMG A
      JOIN '+@DBNAME+' IMAGE_INFO I ON I.ARTICLE_CODE=A.ARTICLE_CODE '
      print @DTDQL
      EXEC SP_EXECUTESQL @DTDQL


SELECT  T1.ORDER_DT,T1.ORDER_NO,T2.AC_NAME,T1.TOTAL_AMOUNT, 
     T1.OTHER_CHARGES AS OTHER_CHARGES,T1.DISCOUNT_AMOUNT AS MST_DISCOUNT_AMOUNT,      
     T1.SUBTOTAL AS AMOUNT_WO_TAX,PARA1.PARA1_NAME,PARA2.PARA2_NAME,PARA2.PARA2_ORDER,PARA3.PARA3_NAME, 
     PARA4.PARA4_NAME,PARA5.PARA5_NAME,PARA6.PARA6_NAME, 
     T3.*,T1.PAYMENT_DETAILS,SECTIOND.SUB_SECTION_NAME,SECTIONM.SECTION_NAME,ARTICLE.ARTICLE_NO,  
     T3.QUANTITY AS QTY  ,COM.COMPANY_CODE ,COM.LOGO_PATH,
	 COM.COMPANY_NAME  AS COMPANY_NAME ,
     L.ADDRESS1 AS COM_ADDRESS1,
     L.ADDRESS2 AS COM_ADDRESS2,
     LCT.CITY AS COM_CITY,
     L.PHONE PHONES_FAX
     ,T1.TRAIL_DT,T1.DELIVERY_DT  ,T2.ADDRESS0,T2.ADDRESS1,T2.ADDRESS2,T2.AREA_NAME,T2.CITY,T2.STATE,T2.PINCODE,
	 ARTICLE.DT_CREATED, EMP.EMP_NAME ,T1.REF_NO,ARTICLE.MRP,ARTICLE.WHOLESALE_PRICE,ARTICLE.PURCHASE_PRICE,
	 ARTICLE.ALIAS AS ARTICLE_ALIAS,ARTICLE.ARTICLE_NAME,T2.TIN_NO,T1.REMARKS AS MST_REMARKS,
	 SNO=ROW_NUMBER() OVER (ORDER BY T1.ORDER_DT) ,
	 (T3.QUANTITY*T3.WS_PRICE) AS AMOUNT,T3.GROSS_QUANTITY,
	 i.PROD_IMAGE ,
	 i.PROD_IMAGE1,
	 i.PROD_IMAGE2,
	 PROD_IMAGE3,
	 T1.CHECKED_BY,
	 T1.SENT_BY,
	 T1.booked_by ,
	 L.dept_name  AS WBO_FOR_DEPT_NAME,
	 T1.shipping_Address,
	 T1.shipping_address2,
	 T1.shipping_address3,
	 T1.shipping_area_code,
	 T1.shipping_area_name,
	 T1.shipping_city_name,
	 T1.shipping_pin,
	 T1.shipping_state_name,
     AN.Angadia_name AS TRANSPORTER_NAME,
     T1.pay_type,
     EMP1.emp_name AS SALE_PERSON,
     EMP.emp_name AS ALLOCATED_TO,
	 L.loc_gst_no,T2.Ac_gst_no  AS PARTY_GST_NO
     FROM BUYER_ORDER_MST T1      
     JOIN LMV01106 T2 ON T1.AC_CODE = T2.AC_CODE   
     JOIN BUYER_ORDER_DET T3 ON T3.ORDER_ID = T1.ORDER_ID      
     JOIN ARTICLE ON ARTICLE.ARTICLE_CODE = T3.ARTICLE_CODE      
     JOIN SECTIOND ON SECTIOND.SUB_SECTION_CODE= ARTICLE.SUB_SECTION_CODE      
     JOIN SECTIONM ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE      
     JOIN PARA1 ON PARA1.PARA1_CODE = T3.PARA1_CODE      
     JOIN PARA2 ON PARA2.PARA2_CODE = T3.PARA2_CODE      
     JOIN PARA3 ON PARA3.PARA3_CODE = ARTICLE.PARA3_CODE   
     JOIN PARA4 ON PARA4.PARA4_CODE = ARTICLE.PARA4_CODE   
     JOIN PARA5 ON PARA5.PARA5_CODE = ARTICLE.PARA5_CODE   
     JOIN PARA6 ON PARA6.PARA6_CODE = ARTICLE.PARA6_CODE   
     LEFT OUTER JOIN COMPANY COM ON 1=1 AND COM.COMPANY_CODE='01'   
	 LEFT OUTER JOIN EMPLOYEE EMP ON T1.EMP_CODE = EMP.EMP_CODE   
	 LEFT OUTER JOIN EMPLOYEE EMP1 ON T1.SALE_EMP_CODE = EMP1.EMP_CODE 
	 JOIN location L ON CASE WHEN T1.WBO_FOR_DEPT_ID<>'' THEN T1.WBO_FOR_DEPT_ID ELSE T1.DEPT_ID END =L.dept_id
	 LEFT JOIN AREA LAR(NOLOCK) ON LAR.AREA_CODE=L.AREA_CODE
	 LEFT JOIN CITY LCT (NOLOCK) ON LCT.CITY_CODE=LAR.CITY_CODE

	 LEFT OUTER JOIN ANGM AN ON T1.angadia_code=AN.Angadia_code
	 left join #TMPIMG i on i.row_id =t3.row_id      
     WHERE T1.ORDER_ID=@CWHERE
END