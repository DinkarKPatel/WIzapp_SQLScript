CREATE PROCEDURE SP3S_PENDING_CHALLAN
(
@CXN_TYPE VARCHAR(10)='',
@DEPT_ID VARCHAR(10)=''
)
AS
BEGIN
     
  DECLARE @CCUTOFFDATE VARCHAR(100),@CHOLOCID VARCHAR(10),@CLOCID VARCHAR(10),@CCUTOFFDATE2 VARCHAR(100)    
      
  SELECT TOP 1 @CCUTOFFDATE=VALUE FROM CONFIG WHERE CONFIG_OPTION='GIT_CUT_OFF_DATE'    
  
  SELECT TOP 1 @CHOLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'   

  SET @CCUTOFFDATE=ISNULL(@CCUTOFFDATE,'')
  
  SET @CCUTOFFDATE2=''  
  
  SET @CCUTOFFDATE2 = CONVERT(VARCHAR,GETDATE()-365,120)
  
  IF ISNULL(@CCUTOFFDATE,'')<>'' 
	  BEGIN
		IF ISNULL(@CCUTOFFDATE,'')> ISNULL(@CCUTOFFDATE2,'')
			SET @CCUTOFFDATE=ISNULL(@CCUTOFFDATE2,'')
	  END
  ELSE
	  SET @CCUTOFFDATE=ISNULL(@CCUTOFFDATE2,'')

 
           
   IF OBJECT_ID ('TEMPDB..#TMPGIT_HO','U') IS NOT NULL  
   DROP TABLE #TMPGIT_HO  
       
   IF OBJECT_ID('TEMPDB..#TMPCHGIT','U') IS NOT NULL    
   DROP TABLE #TMPCHGIT    
   
   SELECT FIN_YEAR=CAST('' AS VARCHAR(10)), XN_TYPE=CAST('' AS  VARCHAR(50)),MEMO_ID=CAST('' AS  VARCHAR(50))
   INTO #TMPCHGIT WHERE 1=2
   
   IF (@CXN_TYPE='' OR @CXN_TYPE='WSL')
   BEGIN
       INSERT  INTO #TMPCHGIT    
	   SELECT A.FIN_YEAR,'GROUP INVOCE' AS XN_TYPE,A.INV_ID AS MEMO_ID  FROM INM01106 A (NOLOCK)   
	   JOIN LOCATION L (NOLOCK) ON A.location_Code=L.DEPT_ID   
	   LEFT OUTER JOIN PIM01106 B (NOLOCK) ON A.INV_ID=B.INV_ID    
	   WHERE A.INV_DT>=(CASE WHEN @CCUTOFFDATE<>'' THEN @CCUTOFFDATE ELSE A.INV_DT END)     
	   AND ISNULL(B.RECEIPT_DT,'')='' 
	   AND A.CANCELLED=0  AND A.INV_MODE=2 AND ISNULL(L.SIS_LOC,0)=0  AND L.INACTIVE =0
	   AND A.PARTY_DEPT_ID=@DEPT_ID
   END
  
   IF (@CXN_TYPE='' OR @CXN_TYPE='PRT')
   BEGIN
	   INSERT  INTO #TMPCHGIT  
	   SELECT A.FIN_YEAR, 'GROUP DEBIT NOTE' AS XN_TYPE,A.RM_ID AS MEMO_ID FROM RMM01106 A (NOLOCK)  
	   JOIN LOCATION L (NOLOCK) ON A.location_Code=L.DEPT_ID      
	   LEFT OUTER JOIN CNM01106 B (NOLOCK) ON A.RM_ID=B.RM_ID    
	   WHERE  A.RM_DT>=(CASE WHEN @CCUTOFFDATE<>'' THEN @CCUTOFFDATE ELSE A.RM_DT END)    
	   AND ISNULL(B.RECEIPT_DT,'')=''
	   AND A.CANCELLED=0  AND A.MODE =2 AND ISNULL(L.SIS_LOC,0)=0  AND L.INACTIVE =0
	   AND A.PARTY_DEPT_ID =@DEPT_ID
   END
       
   CREATE INDEX IND_TMPPENDINGGIT ON #TMPCHGIT (XN_TYPE,MEMO_ID)    
        
   SELECT A.FIN_YEAR, XN_TYPE,TRAN_TYPE='DOCWSL', C.DEPT_ID AS [TARGET_DEPT_ID],   
     C1.DEPT_ID AS [SOURCE_DEPT_ID],        
     A.INV_NO AS MEMO_NO, 
     A.INV_DT AS MEMO_DT,
     B.MEMO_ID,   
     A.NET_AMOUNT AS NET_AMOUNT,  
     CAST(IND.QTY AS NUMERIC(18,2)) AS TOTAL_QTY      
      ,DATEDIFF(DD,A.INV_DT,GETDATE ()) AS AGEING     
   INTO #TMPGIT_HO    
   FROM #TMPCHGIT B      
   JOIN     
   (    
    SELECT INV_ID ,SUM(QUANTITY) AS [QTY]     
    FROM IND01106  A JOIN #TMPCHGIT B ON A.INV_ID=B.MEMO_ID    
    WHERE XN_TYPE='GROUP INVOCE'  GROUP BY INV_ID    
   )IND ON IND.INV_ID=B.MEMO_ID    
   JOIN INM01106 A ON A.INV_ID=B.MEMO_ID    
   JOIN LOCATION C ON C.DEPT_ID=A.PARTY_DEPT_ID    
   JOIN LOCATION C1 ON C1.DEPT_ID=A.location_Code
   WHERE XN_TYPE='GROUP INVOCE'   
   UNION    
   SELECT A.FIN_YEAR,  XN_TYPE,TRAN_TYPE='DOCPRT',   C.DEPT_ID AS [TARGET_DEPT_ID],  
     C1.DEPT_ID AS [SOURCE_DEPT_ID],      
     A.RM_NO AS SOURCE_CHALLAN_NO, 
     A.RM_DT AS MEMO_DT,  
     B.MEMO_ID,   
     A.TOTAL_AMOUNT AS CAL_GIT_VALUE,  
     CAST(RMD.QTY AS NUMERIC(18,2)) AS CAL_GIT_QTY      
       ,DATEDIFF(DD,A.RM_DT,GETDATE ()) AS DUEDAYS      
   FROM #TMPCHGIT B      
   JOIN     
   (    
    SELECT RM_ID ,SUM(QUANTITY) AS [QTY]     
    FROM RMD01106  A JOIN #TMPCHGIT B ON A.RM_ID=B.MEMO_ID    
    WHERE XN_TYPE='GROUP DEBIT NOTE'  GROUP BY RM_ID    
   )RMD ON RMD.RM_ID=B.MEMO_ID    
   JOIN RMM01106 A ON A.RM_ID=B.MEMO_ID    
   JOIN LOCATION C ON C.DEPT_ID=A.PARTY_DEPT_ID    
   JOIN LOCATION C1 ON C1.DEPT_ID=A.location_Code  
   WHERE XN_TYPE='GROUP DEBIT NOTE'   
     
  
     
   SELECT   *,CAST( 0 AS BIT) AS CHK FROM #TMPGIT_HO  
   ORDER BY AGEING DESC  
    
   

END
