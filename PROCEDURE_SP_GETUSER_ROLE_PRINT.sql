CREATE PROCEDURE SP_GETUSER_ROLE_PRINT
 @NVIEWSTATUS INT=1
AS
    DECLARE @CCMD NVARCHAR(MAX),@CROLLID CHAR(7),@CROLLNAME VARCHAR(100),@CCOLUMN_NAME VARCHAR(255),@NSTEP INT,
			@CDELCMD NVARCHAR(MAX),@NCNT INT
BEGIN
   BEGIN
       
		IF OBJECT_ID('TEMPDB..#USERPER_NEW','U') IS NOT NULL
			DROP TABLE #USERPER_NEW
		
		IF OBJECT_ID('TEMPDB..#TOTALUSER_NEW','U') IS NOT NULL
			DROP TABLE #TOTALUSER_NEW
	    
		IF OBJECT_ID('TEMPDB..#TMPUSER_ROLL_DET_NEW','U') IS NOT NULL
			DROP TABLE #TMPUSER_ROLL_DET_NEW	
			
			IF OBJECT_ID('TEMPDB..#USERPERFINAL_NEW','U') IS NOT NULL
			DROP TABLE #USERPERFINAL_NEW
	
	
		SELECT DISTINCT  FORM_NAME,FORM_OPTION,DISPLAY_FORM_NAME,DISPLAY_NAME,GROUP_NAME INTO #TMPUSER_ROLL_DET_NEW
		FROM MODULES WHERE USER_CODE='0000000' AND DISPLAY_FORM_NAME<>''
		
		SELECT ROLE_ID,ROLE_NAME INTO #TOTALUSER_NEW FROM  	USER_ROLE_MST WHERE ISNULL(ROLE_NAME,'')<>''
	
		CREATE TABLE #USERPER_NEW(FORM_NAME VARCHAR(500),FORM_OPTION VARCHAR(40),DISPLAY_FORM_NAME VARCHAR(1000),
		DISPLAY_NAME VARCHAR(100),GROUP_NAME VARCHAR(500)) 
		
		INSERT INTO #USERPER_NEW(FORM_NAME,FORM_OPTION,DISPLAY_FORM_NAME,DISPLAY_NAME,GROUP_NAME )
		SELECT FORM_NAME,FORM_OPTION,DISPLAY_FORM_NAME,DISPLAY_NAME,GROUP_NAME
		FROM #TMPUSER_ROLL_DET_NEW
		 
		
		SET @NCNT=1
		
		
		SET @CDELCMD=N'DELETE FROM #USERPER_NEW WHERE '
		SET @NSTEP = 40	
		WHILE EXISTS (SELECT TOP 1 'U' FROM #TOTALUSER_NEW)
		BEGIN
				SELECT TOP 1 @CROLLID= ROLE_ID,@CROLLNAME=ROLE_NAME FROM #TOTALUSER_NEW
				SET @CCOLUMN_NAME = @CROLLNAME+'_VALUE'
				SET @CCMD=N'ALTER TABLE #USERPER_NEW
							ADD ['+@CCOLUMN_NAME+'] VARCHAR(3)'
				
				PRINT @CCMD	
				EXEC SP_EXECUTESQL 	@CCMD

				SET @NSTEP = 50					
				SET @CCMD=N'UPDATE A SET A.['+@CCOLUMN_NAME+']= CASE WHEN ISNULL(B.VALUE,0)=0 THEN ''NO'' ELSE ''YES'' END FROM #USERPER_NEW A
							LEFT OUTER JOIN USER_ROLE_DET B 
							ON A.FORM_NAME=B.FORM_NAME AND A.FORM_OPTION=B.FORM_OPTION AND B.ROLE_ID='''+@CROLLID+''''

				
				PRINT 	@CCMD
				EXEC SP_EXECUTESQL 	@CCMD		
				
				
				
				SET @NSTEP = 60	
				IF @NVIEWSTATUS IN (2,3)
				BEGIN
					SET @CDELCMD=@CDELCMD+(CASE WHEN @NCNT=1 THEN '' ELSE ' AND ' END)
					
					IF @NVIEWSTATUS=2
						SET @CDELCMD=@CDELCMD+N'['+@CCOLUMN_NAME+']=0'
					ELSE
						SET @CDELCMD=@CDELCMD+N'['+@CCOLUMN_NAME+']=1'	
				END	
				
				
				SET @NCNT=@NCNT+1
				SET @NSTEP = 70			
				DELETE #TOTALUSER_NEW WHERE ROLE_ID= @CROLLID
		END
		IF @NVIEWSTATUS IN (2,3)
		BEGIN
			PRINT @CDELCMD
			EXEC SP_EXECUTESQL @CDELCMD
		END	
		
		
		IF OBJECT_ID('TEMPDB..#TMPNEWCOL','U') IS NOT NULL
		   DROP TABLE #TMPNEWCOL
		   
		SELECT ROW_NUMBER () OVER(ORDER BY ROLE_NAME) AS SR, ROLE_NAME=ROLE_NAME +'_VALUE'  
		INTO #TMPNEWCOL
		FROM  	USER_ROLE_MST WHERE ISNULL(ROLE_NAME,'')<>''
		
		
		SET @NSTEP = 80	
		SELECT *,SR=ROW_NUMBER () OVER (PARTITION BY DISPLAY_FORM_NAME ORDER BY DISPLAY_FORM_NAME)
		INTO #USERPERFINAL_NEW
		FROM #USERPER_NEW ORDER BY DISPLAY_FORM_NAME,DISPLAY_NAME
		
		SET @NSTEP = 90
		UPDATE #USERPERFINAL_NEW SET DISPLAY_FORM_NAME='' WHERE SR>1
		
		ALTER TABLE #USERPERFINAL_NEW DROP COLUMN SR
		
		SELECT GROUP_NAME_NEW=CASE WHEN ROW_NUMBER() OVER(PARTITION BY GROUP_NAME ORDER BY GROUP_NAME)=1 THEN GROUP_NAME ELSE '' END,
		* FROM  #USERPERFINAL_NEW  A
		
		 SELECT USR_SR.SR AS SR,
			   CASE WHEN ROW_NUMBER() OVER (PARTITION BY U.USER_CODE ORDER BY USERNAME ,ROLE_NAME, DEPT_NAME )=1 THEN ISNULL(USERNAME,'') ELSE '' END AS USR_USERNAME, 
			   CASE WHEN ROW_NUMBER() OVER (PARTITION BY U.USER_CODE ORDER BY USERNAME ,ROLE_NAME, DEPT_NAME )=1 THEN ISNULL(M.ROLE_NAME,'')  ELSE '' END AS USR_ROLE_NAME,
			   ISNULL(L.DEPT_ID,'') AS  DEPT_ID,ISNULL(DEPT_NAME,'') AS   DEPT_NAME   FROM 
		USER_ROLE_DET D
		JOIN USER_ROLE_MST M ON D.ROLE_ID =M.ROLE_ID 
		LEFT JOIN USERS U ON D.ROLE_ID =U.ROLE_ID 
		JOIN
		(
			SELECT U.USER_CODE,ROW_NUMBER() OVER (ORDER BY USERNAME) AS SR
			FROM USER_ROLE_DET D
			JOIN USER_ROLE_MST M ON D.ROLE_ID =M.ROLE_ID 
			LEFT JOIN USERS U ON D.ROLE_ID =U.ROLE_ID 
			WHERE USER_CODE IS NOT NULL
			GROUP BY U.USER_CODE,USERNAME
		) USR_SR ON USR_SR .USER_CODE =U.USER_CODE
		LEFT JOIN LOCUSERS LU ON LU.USER_CODE =U.USER_CODE 
		LEFT JOIN LOCATION L ON L.DEPT_ID =LU.DEPT_ID 
		WHERE U.USERNAME <>''
		GROUP BY D.ROLE_ID,ROLE_NAME ,USERNAME,DEPT_NAME,U.USER_CODE,L.DEPT_ID,USR_SR.SR
		ORDER BY USERNAME ,ROLE_NAME, DEPT_NAME
		
						
	END
END
