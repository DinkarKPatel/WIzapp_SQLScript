
/*PROMO MESSAGE SCHEME IN WHCIH MESSAGES WILL BE SENT TO CUSTOMER BASED UPON SELECTED ITEMS PURCHASE
  WITHOUT APPLYING ANY DISCOUNTS ON RELATED ITEMS
*/	
CREATE PROCEDURE SP3S_EOSS_SCHEMES_13
(
	@CSCHEMEDETROWID VARCHAR(50),
	@CSLSTITLE VARCHAR(500),
	@CROUNDITEMLEVEL VARCHAR(5),
	@CJOINSTRBUY VARCHAR(MAX),
	@CJOINSTRGET VARCHAR(MAX),
	@CPICKSLRDISCMODE VARCHAR(5),
	@CERRMSG VARCHAR(MAX) OUTPUT
)
AS 
BEGIN

	DECLARE @NBUYQTY NUMERIC(10,2),@NGETAMT NUMERIC(10,2),@NGETQTY NUMERIC(10,2),
			@NREQGETQTY NUMERIC(10,2),@CPRODUCTCODE VARCHAR(50),@NMRP NUMERIC(10,2),@NQTY NUMERIC(10,2),
			@CCMDROWID VARCHAR(50),@NLOOPCNT INT,@NMODE INT,@BQUALIFIED BIT,
			@CROWID VARCHAR(100),@NSTEP INT,@NAMT NUMERIC(10,2),
			@CMRPORDER VARCHAR(10),@NREQBUYAMT NUMERIC(10,2),@BRETRY2NDCASE BIT,
			@CCMD NVARCHAR(MAX),@NDISCMODE INT,@NDISCPCT NUMERIC(7,3),@NDISCAMT NUMERIC(10,2),
			@NNETRATE NUMERIC(10,2),@CBUYFILTER VARCHAR(MAX),@CGETFILTER VARCHAR(MAX),
			@CADDFILTER VARCHAR(MAX),@CORGADDFILTER VARCHAR(MAX),@NFILTERMODE INT,
			@BPROCESSSLRENTRY BIT,@NGETFILTERMODE INT,@CAPPLYSCHEMEONHIGHERPRICE VARCHAR(2),
			@BAPPLYSCHEMEONDISCITEMS BIT
	
	SET @BPROCESSSLRENTRY=0
				
START_PROC:
	SELECT @NBUYQTY=0,@CPRODUCTCODE='',@NGETAMT=0,@NMRP=0,@NQTY=0,@NGETQTY=0,
		   @CCMDROWID='',@NLOOPCNT=0,@NREQGETQTY=0,
		   @NMODE=0,@BQUALIFIED=0,@CROWID='',@NSTEP=0,@NAMT=0,@CMRPORDER='',
		   @NREQBUYAMT=0,@BRETRY2NDCASE=0,@CCMD='',@NDISCMODE=0,@CBUYFILTER='',
		   @CGETFILTER='',@CADDFILTER='',@NFILTERMODE=0,@NDISCPCT=0,@NDISCAMT=0,
		   @NNETRATE=0,@NGETFILTERMODE=0,@CORGADDFILTER=''
			

	--IF @CSLSTITLE='BUY 1 GET 1'
	--	SELECT 'START CHECK SCHEMES_3 FOR BUY 1 GET 1',(CASE WHEN @BPROCESSSLRENTRY=1 THEN 'SLR' ELSE 'SLS' END) AS XN_TYPE,* FROM #TMPCMD
	
	SELECT @BAPPLYSCHEMEONDISCITEMS=ISNULL(APPLY_SCHEME_ON_DISCOUNTED_ITEMS,0) FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
	
	SET @CORGADDFILTER='A.QUANTITY<>0'
	
	IF CURSOR_STATUS('GLOBAL','SCHEMECUR') IN (0,1)
	BEGIN
		CLOSE SCHEMECUR
		DEALLOCATE SCHEMECUR
	END

BEGIN TRY        
	
	PRINT 'CHECK SCHEME SP3S_EOSS_SCHEMES_13' 	
	SET @NSTEP=10
		
	SELECT @CMRPORDER='',@BQUALIFIED=0,@BRETRY2NDCASE=0

	IF OBJECT_ID('TEMPDB..#TMPCMDSCHEMES','U') IS NOT NULL
		DROP TABLE #TMPCMDSCHEMES
	
	SET @NSTEP=12
	SELECT PRODUCT_CODE,MRP,QUANTITY,CMD_ROW_ID AS ROW_ID,CONVERT(INT,0) AS MODE,
	CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT,QUANTITY AS GET_QUANTITY,
	QUANTITY AS SCHEME_APPLIED_QTY INTO #TMPCMDSCHEMES FROM #TMPCMD WHERE 1=2 

	SELECT @CBUYFILTER=(CASE WHEN FILTER_MODE IN (0,1) THEN  BUY_FILTER_CRITERIA ELSE '1=1' END),
		   @CGETFILTER=(CASE WHEN GET_FILTER_MODE IN (0,1) THEN  GET_FILTER_CRITERIA ELSE '1=1' END),
		   @NDISCMODE=DISC_METHOD,@NDISCPCT=DISCOUNT_PERCENTAGE,@NDISCAMT=DISCOUNT_AMOUNT,@NNETRATE=NET_PRICE,
		   @NFILTERMODE=FILTER_MODE,@NGETFILTERMODE=GET_FILTER_MODE
	FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
		
	SET @NSTEP=14
	
	IF @NFILTERMODE NOT IN (0,1)
		SELECT @CADDFILTER=@CORGADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''''
	ELSE
		SELECT @CADDFILTER=@CORGADDFILTER+' AND 1=1'
				
   	SET @CCMD=N' SELECT A.PRODUCT_CODE,A.MRP,'+(CASE WHEN @BAPPLYSCHEMEONDISCITEMS=1 THEN 'ABS(A.QUANTITY) ' ELSE 
   				 '(ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY) ' END)+'*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END),
   				 A.CMD_ROW_ID AS ROW_ID,1 AS MODE,
				 0 AS DISCOUNT_AMOUNT,0 AS GET_QUANTITY,0 AS SCHEME_APPLIED_QTY FROM #TMPCMD A 
				 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTRBUY+' WHERE '+@CBUYFILTER+' AND '+ @CADDFILTER

	PRINT @CCMD
				 
	INSERT #TMPCMDSCHEMES
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=20
		
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMDSCHEMES WHERE MODE=1)
		GOTO END_PROC	
	
	GOTO EXIT_PROC
END TRY
	
BEGIN CATCH
	  PRINT 'CATCH START'       
	  SET @CERRMSG='P:SP3S_EOSS_SCHEMES_13, STEP:'+LTRIM(RTRIM(STR(@NSTEP)))+', MESSAGE:'+ERROR_MESSAGE()        
	  GOTO END_PROC
END CATCH
	
EXIT_PROC:
		
	IF ISNULL(@CERRMSG,'')=''
		UPDATE #TMPCMD SET 
		SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSLSTITLE,
		SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID
		FROM #TMPCMDSCHEMES B WHERE B.ROW_ID=#TMPCMD.CMD_ROW_ID
	
END_PROC:

	
END
----- END OF PROCEDURE SP3S_EOSS_SCHEMES_13
