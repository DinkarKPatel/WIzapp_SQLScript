CREATE PROC VALIDATEXN_JWR_BEFORE_EDIT 
@CMEMOID VARCHAR(30),
@BCANCELXN BIT,
@CERRORMSG VARCHAR(200) OUTPUT,
@CEXPRERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
	
	DECLARE @CTEXT VARCHAR(10),@CPRODUCTCODE VARCHAR(50)
	
	SELECT @CPRODUCTCODE=''
	
	SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)


	IF EXISTS (SELECT TOP 1 'U' FROM  JOBWORK_RECEIPT_MST WHERE RECEIPT_ID =@CMEMOID AND RECEIVE_MODE  <>1 and WIP=1)
	BEGIN
	IF EXISTS (SELECT TOP 1 A.ISSUE_ID 
			   FROM JOBWORK_ISSUE_MST A (NOLOCK)
			   JOIN JOBWORK_ISSUE_DET B (NOLOCK) ON A.ISSUE_ID=B.ISSUE_ID 
			   JOIN WIP_PMT C (NOLOCK) ON C.WIP_UID=B.WIP_UID
			   JOIN JOBWORK_RECEIPT_DET D (NOLOCK) ON C.XN_ROW_ID=D.ROW_ID
			   JOIN JOBWORK_RECEIPT_MST E (NOLOCK) ON E.RECEIPT_ID=D.RECEIPT_ID
			   WHERE E.RECEIPT_ID=@CMEMOID AND A.CANCELLED=0 AND E.CANCELLED=0 AND C.JOB_CODE=D.JOB_CODE )
	BEGIN	
		SET @CERRORMSG='ONE OR MORE REFERENCES OF THIS MEMO IS FOUND INTO JOB WORK ISSUE.........CAN NOT '+@CTEXT
		RETURN
	END
	
	IF EXISTS (SELECT TOP 1 A.MEMO_ID 
			   FROM SNC_MST A (NOLOCK)
			   JOIN SNC_CONSUMABLE_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID 
			   JOIN WIP_PMT C (NOLOCK) ON C.WIP_UID=B.WIP_UID
			   JOIN JOBWORK_RECEIPT_DET D (NOLOCK) ON C.XN_ROW_ID=D.ROW_ID
			   JOIN JOBWORK_RECEIPT_MST E (NOLOCK) ON E.RECEIPT_ID=D.RECEIPT_ID
			   WHERE E.RECEIPT_ID=@CMEMOID AND A.CANCELLED=0 AND E.CANCELLED=0 AND C.JOB_CODE=D.JOB_CODE )
	BEGIN	
		SET @CERRORMSG='ONE OR MORE REFERENCES OF THIS MEMO IS FOUND INTO SPLIT AND COMBINE.........CAN NOT '+@CTEXT
		RETURN
	END

	END

	IF EXISTS (SELECT TOP 1 'U' FROM  JOBWORK_RECEIPT_MST WHERE RECEIPT_ID =@CMEMOID AND RECEIVE_MODE  =1 )
	BEGIN
	      
		 If exists ( SELECT TOP 1 'U' 
		  FROM JOBWORK_RECEIPT_DET A (nolock)
		  join TRANSFER_TO_TRADING_DET b (nolock) on a.product_code  =b.product_code
		  join TRANSFER_TO_TRADING_MST c (nolock) on b.MEMO_ID =c.MEMO_ID 
		  WHERE a.RECEIPT_ID =@CMEMOID and c.CANCELLED =0)
		  BEGIN
		       SET @CERRORMSG='ONE OR MORE REFERENCES OF THIS MEMO IS FOUND INTO TRANSFER TO TRADING.........CAN NOT '+@CTEXT
	           RETURN

		  END

	end

		
END
