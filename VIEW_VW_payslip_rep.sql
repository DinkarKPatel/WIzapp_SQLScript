CREATE VIEW VW_PAYSLIP_REP
--WITH ENCRYPTION
AS
SELECT 
PSM.*,
EM.REF_ID,
EM.EMP_FNAME + ' ' + EM.EMP_LNAME AS EMPNAME,
EM.PAN_NO,
EM.DATE_OF_JOINING,
EM.MODE_OF_PAYMENT,
EM.MOBILE1,
EM.PF_ENABLED,
EM.ESI_ENABLED,
EM.BASIC_SALARY AS ORGBASIC,
EM.EMP_STATUS,
EM.DEPT_ID, 
EM.CO_ALIAS,
DEPT.DEPARTMENT_NAME,
DEPT.DEPARTMENT_ID,
DESIG.DESIG_ID,
DESIG.DESIG_NAME,
LOC.DEPT_NAME, 
0 AS PF_EMPLOYER_ALL, 
0 AS ESI_EMPLOYER_ALL, 
EM.PF_NO, 
EM.ESI_NO,EM.BANK_ACC_NO,
(PSM.NET_SALARY - (PSM.EMPLOYER_ESI_AMOUNT + PSM.EMPLOYER_PF_AMOUNT)) AS INHAND_SALARY,
PSD.PF_AMOUNT AS EMPLOYEE_PF_AMOUNT,
PSD.ESI_AMOUNT AS EMPLOYEE_ESI_AMOUNT
FROM EMP_PAYSLIP_MST PSM
JOIN EMP_MST EM ON PSM.EMP_ID=EM.EMP_ID
JOIN EMP_DEPARTMENT DEPT  ON EM.DEPARTMENT_ID=DEPT.DEPARTMENT_ID
JOIN EMP_DESIG DESIG ON EM.DESIG_ID=DESIG.DESIG_ID
JOIN LOCATION LOC ON EM.DEPT_ID=LOC.DEPT_ID 
JOIN (SELECT A.PAYSLIP_ID, SUM(CASE WHEN A.PAY_ID='PAY0001' THEN AMOUNT ELSE 0 END) AS PF_AMOUNT,
	  SUM(CASE WHEN A.PAY_ID='PAY0002' THEN AMOUNT ELSE 0 END) AS ESI_AMOUNT FROM  	
	  EMP_PAYSLIP_DET A JOIN EMP_PAYSLIP_MST B ON A.PAYSLIP_ID=B.PAYSLIP_ID
	  GROUP BY A.PAYSLIP_ID) PSD ON PSD.PAYSLIP_ID=PSM.PAYSLIP_ID
