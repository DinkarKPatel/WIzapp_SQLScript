CREATE PROCEDURE SP_MERGE_MIRROR_SCF_DATA
(
	@CMEMOID VARCHAR(50),
    @CLOCID VARCHAR(2),
    @CSOURCEDB VARCHAR(200),
    @CMERGEDB VARCHAR(200),
    @BMSTINSERTONLY BIT,
    @CERRMSG VARCHAR(MAX) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @DTSQL NVARCHAR(MAX),@CTMP_TABLENAME VARCHAR(200),
			@CJOINSTR VARCHAR(MAX),@CERRORMSG VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100),
			@CTABLENAME VARCHAR(200),@CERRMSGOUT VARCHAR(MAX),@CSTEP VARCHAR(20),@CKEYFIELD VARCHAR(100)
			,@CKEYFIELD1 VARCHAR(100),@CTABLE_SUFFIX VARCHAR(50),@CTABLESSTR VARCHAR(500)
	
	BEGIN TRY

		SET @CSTEP = 10
			
		SET @CERRORMSG=''
	   
	   SET @CTABLESUFFIX=REPLACE(@CMEMOID,'-','_')	
		
	    	    
 	   BEGIN TRANSACTION
 	   
/*STATE,CITY,AREA,HD01106,LM01106,LMP01106,UOM,SECTIONM,SECTIOND,,ARTICLE,PARA1,PARA2,PARA3,PARA4,PARA5,PARA6
,ATTRM,ATTR_KEY,ART_ATTR,SKU,SKU_OH,SKU_BO,FORM,SCM01106,SCF01106,SCM01106_AUDIT,SCF01106_AUDIT,SCF_IMPORT_LOG*/

		DECLARE @CMEMOIDSEARCH VARCHAR(100)
		SELECT TOP 1 @CMEMOIDSEARCH=A.MEMO_ID FROM scm01106 A (NOLOCK) WHERE A.MEMO_ID=@CMEMOID
		
		IF ISNULL(@CMEMOIDSEARCH,'')<>''
		BEGIN
			SET @CSTEP=20
			EXEC SP3SBUILDSCM
				@CXNID=@CMEMOID
				,@NUPDATEMODE=3
				,@CERRMSG=@CERRMSG OUTPUT  

			IF ISNULL(@CERRMSG,'')<>''
				GOTO Exit_PROC			
	    END
		
	   SET @CSTEP = 30
	   SET @CTABLE_SUFFIX=REPLACE(@CMEMOID,'-','_')
	
	   SET @CSTEP = 160
	   SET @CTABLENAME='UOM'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='UOM_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=170
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 							
							  
	   SET @CSTEP = 162
	   SET @CTABLENAME='SECTIONM'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='SECTION_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=164
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 											
							  
	   SET @CSTEP = 166
	   SET @CTABLENAME='SECTIOND'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='SUB_SECTION_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=168
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 																		  		  
		
	   SET @CSTEP = 180
	   SET @CTABLENAME='ARTICLE'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='ARTICLE_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=190
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 						
		
	   SET @CSTEP = 200
	   SET @CTABLENAME='PARA1'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA1_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=210
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 					
	
	   SET @CSTEP = 220
	   SET @CTABLENAME='PARA2'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA2_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=230
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 				
	
	   SET @CSTEP = 240
	   SET @CTABLENAME='PARA3'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA3_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=350
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 			
	
	   SET @CSTEP = 260
	   SET @CTABLENAME='PARA4'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA4_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=270
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 			

	   SET @CSTEP = 280
	   SET @CTABLENAME='PARA5'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA5_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=290
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 			

	   SET @CSTEP = 300
	   SET @CTABLENAME='PARA6'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA6_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=310
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 			

	   SET @CSTEP = 380
	   SET @CTABLENAME='SKU'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PRODUCT_CODE'
	   SET @CSTEP=390
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	
	   
	   SET @CSTEP = 400
	   SET @CTABLENAME='SKU_OH'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PRODUCT_CODE'
	   SET @CSTEP=410
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	   
	   SET @CSTEP = 460
	   SET @CTABLENAME='SCM01106'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='MEMO_ID'
	   
	   SET @CSTEP=470
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	   

	   SET @CSTEP = 480
	   SET @DTSQL='DELETE FROM '+@CMERGEDB+'SCC01106 WITH (ROWLOCK) WHERE MEMO_ID='''+@CMEMOID+''''
	   EXEC SP_EXECUTESQL @DTSQL
	   
	   SET @CSTEP = 490
	   SET @CTABLENAME='SCC01106'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='MEMO_ID'

	   SET @CSTEP=495

	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	   
	   SET @CSTEP = 500
	   SET @DTSQL='DELETE FROM '+@CMERGEDB+'SCF01106 WITH (ROWLOCK) WHERE MEMO_ID='''+@CMEMOID+''''
	   EXEC SP_EXECUTESQL @DTSQL
	   
	   SET @CSTEP = 510
	   SET @CTABLENAME='SCF01106'
	   SET @CTMP_TABLENAME='TMP_SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='MEMO_ID'
	   
	   SET @CSTEP=520
	   
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 

		SET @CSTEP=530 
		
		SET @CTMP_TABLENAME=@CSOURCEDB+'TMP_SCF_pmt01106_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		EXEC SP3S_MERGE_LOCPMT  
		@cTempTable=@CTMP_TABLENAME	   

	END TRY
	BEGIN CATCH
		SET @CERRMSG='P:SP_MERGE_MIRROR_SCF_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH

EXIT_PROC:
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
	EXEC SP3SBUILDSCM
			@CXNID=@CMEMOID
			,@NUPDATEMODE=2
			,@CERRMSG=@CERRMSG OUTPUT  
	END

	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
	END
	ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK
	
	SET @CTABLESSTR='SCM01106,SCF01106,SCC01106,UOM,ARTICLE,SECTIOND,SECTIONM,PARA1,PARA2,PARA3,PARA4,PARA5,PARA6,SKU,SKU_OH,PMT01106,XNSTABLELIST'

    EXEC SP3S_DROPTEMPTABLES_MIRRORDATA
    @CXNTYPE='SCF',
    @CTABLESUFFIX=@CTABLESUFFIX,
    @CTABLESSTR=@CTABLESSTR

END	
---END OF PROCEDURE - SP_MERGE_MIRROR_SCF_DATA
