create PROC VALIDATEXN_WPL_BEFORE_EDIT 
@CMEMOID VARCHAR(30),
@BCANCELXN BIT,
@CERRORMSG VARCHAR(200) OUTPUT,
@CEXPRERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CTEXT VARCHAR(10),@CPRODUCTCODE VARCHAR(50)
	
	SELECT @CPRODUCTCODE=''
	
	SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)
	
	IF EXISTS (SELECT TOP 1 A.MEMO_ID 
			   FROM PLM01106 A 
			   WHERE A.MEMO_ID=@CMEMOID AND A.CANCELLED=1)
	BEGIN	
		SET @CERRORMSG='MEMO IS ALREADY CANCELLED.........CAN NOT '+@CTEXT
		RETURN
	END


	IF EXISTS (SELECT TOP 1 A.MEMO_ID 
			   FROM PLM01106 A 
			   WHERE A.MEMO_ID=@CMEMOID AND A.Short_close =1)
	BEGIN	
		SET @CERRORMSG='MEMO IS ALREADY SHORT CLOSE.........CAN NOT '+@CTEXT
		RETURN
	END
	
	IF EXISTS ( select top 1   xntype from SalesOrderProcessing (nolock)
	WHERE XNTYPE IN('PLPACKSLIP','PLINVOICE' ) and refmemoid=@CMEMOID and Qty >0) and @BCANCELXN=1
	begin
	     
		  SET @CERRORMSG= +'ONE OR MORE REFERENCES OF THIS MEMO IS FOUND IN PACKSLIP.........CAN NOT '+@CTEXT
	      RETURN

	end

	
		
END
