create PROCEDURE SP_MERGE_MIRROR_DOCGV_DATA        
(        
	 @CMEMOID VARCHAR(50),        
	 @CERRMSG VARCHAR(MAX) OUTPUT        
)        
AS        
BEGIN 




  SET NOCOUNT ON        
  DECLARE @DTSQL NVARCHAR(MAX),@CSOURCEDB VARCHAR(200),@CTMP_TABLENAME VARCHAR(200)       
   ,@CJOINSTR VARCHAR(MAX),@CERRORMSG VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100)        
   ,@CTABLENAME VARCHAR(200),@CERRMSGOUT VARCHAR(MAX),@CSTEP VARCHAR(20),@CKEYFIELD VARCHAR(100)        
   ,@CKEYFIELD1 VARCHAR(100),@CMERGEDB VARCHAR(50),@CTABLE_SUFFIX VARCHAR(50)        
   ,@INV_MODE INT,@CFINYEAR VARCHAR(10)
   ,@TEMP_TABLE1 VARCHAR(20),@CCMD NVARCHAR(MAX),@CCURDEPTID CHAR(2),@CHODEPTID CHAR(2)
   ,@BSOURCEPURLOC BIT,@BTARGETPURLOC BIT,@BGENERATEAUTOSERIES BIT,@CSOURCELOCID CHAR(2), @BHOLOC BIT,@BSKU_OH BIT
   ,@NTARGETLOCTYPE INT,@BMSTINSERTONLY BIT,@CMEMONOPREFIX VARCHAR(100),@CPARTYDEPTID VARCHAR(5)
   ,@BCHALLANRECEIVEDPREV BIT,@CCMDOUTPUT VARCHAR(MAX),@BNEGSTOCKFOUND BIT
   
 
 BEGIN TRY        
  
  SET @cStep=10

  SET @CERRORMSG=''        
  BEGIN TRANSACTION        
	
/*INM,IND,PAYMODE_XN_DET,PAYMODE_MST,PAYMODE_GRP_MST*/        
    
    SET @CTABLE_SUFFIX='upload'
	
	select @CSOURCEDB ='',@cMergedb=''                                           
										    
    SET @CSTEP=30
	SET @CTABLENAME='SKU_GV_MST'
	SET @CTMP_TABLENAME='DOCGV_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='GV_SRNO'
	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0,@BALWAYSUPDATE=1         
         
    SET @CSTEP=40
	SET @CTABLENAME='GV_MST_INFO'
	SET @CTMP_TABLENAME='DOCGV_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='GV_SRNO'
	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0,@BALWAYSUPDATE=1         
     	  	             
    
   
    SET @CSTEP = 50       
   
	UPDATE DOCGV_GV_STKXFER_MST_UPLOAD SET  USER_CODE='0000000'

    SET @CTABLENAME='GV_STKXFER_MST'        
    SET @CTMP_TABLENAME='DOCGV_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
    			

	SET @CSTEP = 60       
    SET @CCMD=N'UPDATE A SET RECEIPT_DT=B.RECEIPT_DT FROM '+@CTMP_TABLENAME+' A  WITH (ROWLOCK) 
				JOIN GV_STKXFER_MST B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID'
	EXEC SP_EXECUTESQL @CCMD
	     
	SET @CKEYFIELD='MEMO_ID'        
    SET @CSTEP= 70   
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@LUPDATEONLY=0,@BALWAYSUPDATE=1 


   IF EXISTS (SELECT TOP 1 MEMO_ID FROM GV_STKXFER_MST WHERE MEMO_ID=@CMEMOID AND RECEIPT_DT<>'')
   BEGIN
		SET @BCHALLANRECEIVEDPREV=1
		
		EXEC UPDATEPMT_GV   
		   @CXNTYPE   = 'GVCHI'    
		 , @CXNID   = @CMEMOID  
		 , @NREVERTFLAG = 1
		 , @CCMD    = @CCMDOUTPUT OUTPUT  
   END
      
   DELETE FROM GV_STKXFER_DET WITH (ROWLOCK) WHERE MEMO_ID = @cMemoId
  
    SET @CSTEP = 80      
    SET @CTABLENAME='GV_STKXFER_DET'        
    SET @CTMP_TABLENAME='DOCGV_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
    SET @CKEYFIELD='MEMO_ID'        
    SET @CSTEP= 90
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=1,@LUPDATEONLY=0,@BALWAYSUPDATE=0 
	
	SET @CSTEP= 100
	SET @CCMD=N' INSERT PMT_GV_MST	( GV_SRNO, QUANTITY_IN_STOCK )  
				 SELECT A.GV_SRNO,0 AS QUANTITY_IN_STOCK FROM docgv_sku_gv_mst_upload A
				 LEFT OUTER JOIN PMT_GV_MST B ON A.GV_SRNO=B.GV_SRNO
				 WHERE B.GV_SRNO IS NULL'
	EXEC SP_EXECUTESQL @CCMD


	
    IF @BCHALLANRECEIVEDPREV=1
    BEGIN
		SET @CSTEP = 110
		
		EXEC UPDATEPMT_GV   
		   @CXNTYPE   = 'GVCHI'    
		 , @CXNID   = @CMEMOID  
		 , @NREVERTFLAG = 0
		 , @CCMD    = @CCMDOUTPUT OUTPUT  
		
		IF @CCMDOUTPUT<>''
			SET @BNEGSTOCKFOUND=1
				 
	END


	
	SET @CSTEP = 120      
    SET @CTABLENAME='GV_GEN_MST'        
    SET @CTMP_TABLENAME='DOCGV_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
    SET @CKEYFIELD='MEMO_ID'        
    SET @CSTEP= 125
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=1,@LUPDATEONLY=0,@BALWAYSUPDATE=0 

    SET @CSTEP = 130      
    SET @CTABLENAME='GV_GEN_DET'        
    SET @CTMP_TABLENAME='DOCGV_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
    SET @CKEYFIELD='row_id'        
    SET @CSTEP= 135
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=1,@LUPDATEONLY=0,@BALWAYSUPDATE=0 
	
   
   
   
 END TRY        
 BEGIN CATCH
  PRINT 'CATCH START'       
  SET @CERRMSG='P:SP_MERGE_MIRROR_DOCGV_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
 END CATCH        
        
EXIT_PROC:        
	
	PRINT 'LAST STEP:'+@CSTEP
	
	IF @@TRANCOUNT>0 
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			COMMIT TRANSACTION
		ELSE
			ROLLBACK
	END
	
	TRUNCATE TABLE DOCGV_GV_STKXFER_MST_UPLOAD
	TRUNCATE TABLE DOCGV_GV_STKXFER_DET_UPLOAD
	TRUNCATE TABLE DOCGV_GV_MST_INFO_UPLOAD
	TRUNCATE TABLE DOCGV_SKU_GV_MST_UPLOAD
	truncate table DOCGV_GV_GEN_det_UPLOAD
	truncate table DOCGV_GV_GEN_MST_UPLOAD
	 
END 
------ END OF CREATING PROCEDURE - SP_MERGE_MIRROR_DOCGV_DATA