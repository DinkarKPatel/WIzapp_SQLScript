CREATE PROCEDURE SP3S_Get_Tcs_baseAmount
(
 @CsourceGstNo varchar(20)='',
 @CtargetGstNo varchar(20)='',
 @cfinyear varchar(5)='',
 @DINVDT datetime='',
 @bCalledFromVchEntry BIT=0,
 @cac_code varchar(10)='',
 @CINV_ID VARCHAR(50)=''--IN CASE OF EDIT MODE pass inv_id 
)
AS
BEGIN
    

	DECLARE @CPARTYPANNOFILTER VARCHAR(1000),@DTSQL nvarchar(max),
	        @CPARTYRETURNFILTER VARCHAR(1000)

	
	IF @bCalledFromVchEntry=0
	begin

	    
		IF isnull(@CTARGETGSTNO,'')<>''
		   SET @CPARTYPANNOFILTER=' AND CASE WHEN A.INV_MODE=1 THEN SUBSTRING (LM.AC_GST_NO,3,10)  ELSE SUBSTRING (tl.LOC_GST_NO,3,10) END ='''+SUBSTRING (@CTARGETGSTNO,3,10)+''' '
		ELSE 
		   SET @CPARTYPANNOFILTER=' AND CASE WHEN A.INV_MODE=1 THEN LM.AC_CODE ELSE TL.DEPT_AC_CODE END ='''+@CAC_CODE+''' '

		IF isnull(@CTARGETGSTNO,'')<>''
		   SET @CPARTYRETURNFILTER=' AND CASE WHEN A.MODE=1 THEN SUBSTRING (LM.AC_GST_NO,3,10)  ELSE SUBSTRING (sl.LOC_GST_NO,3,10) END ='''+SUBSTRING (@CTARGETGSTNO,3,10)+''' '
		ELSE 
		   SET @CPARTYRETURNFILTER=' AND CASE WHEN A.MODE=1 THEN LM.AC_CODE ELSE sl.DEPT_AC_CODE END ='''+@CAC_CODE+''' '





		SET @DTSQL=N' select sum(TCS_BASEAMOUNT) as TCS_BASEAMOUNT
		from
		(
		SELECT SUM(A.NET_AMOUNT -ISNULL(A.TCS_AMOUNT,0) ) AS TCS_BASEAMOUNT
		FROM INM01106 A (NOLOCK) 
		JOIN LOCATION L (NOLOCK)  ON L.DEPT_ID =A.location_code
		LEFT JOIN LOCATION TL (NOLOCK)  ON TL.DEPT_ID =A.PARTY_DEPT_ID 
		LEFT JOIN LMP01106 LM (NOLOCK) ON A.AC_CODE =LM.AC_CODE 
		WHERE A.CANCELLED =0 
		AND A.FIN_YEAR ='''+@CFINYEAR+'''
		AND A.INV_DT<= '''+CONVERT(VARCHAR(10),@DINVDT,121)+'''
		AND SUBSTRING (L.LOC_GST_NO,3,10)='''+SUBSTRING (@CSOURCEGSTNO,3,10)+'''
		AND ISNULL(A.XN_ITEM_TYPE,0)<>4
		and a.inv_id<>'''+@CINV_ID+'''
		'+@CPARTYPANNOFILTER +' 
		union all
		SELECT -1* (SUM(A.Total_amount)) AS TCS_BASEAMOUNT
		FROM cnm01106 A (NOLOCK) 
		Left outer join rmm01106 rmm (nolock) on A.rm_id= rmm.rm_id
		JOIN LOCATION L (NOLOCK)  ON L.DEPT_ID =A.location_code
		LEFT JOIN LOCATION SL (NOLOCK)  ON SL.DEPT_ID =rmm.location_code
		LEFT JOIN LMP01106 LM (NOLOCK) ON A.AC_CODE =LM.AC_CODE 
		WHERE A.CANCELLED =0 
		AND A.FIN_YEAR ='''+@CFINYEAR+'''
		AND A.Receipt_dt<= '''+CONVERT(VARCHAR(10),@DINVDT,121)+'''
		AND SUBSTRING (L.LOC_GST_NO,3,10)='''+SUBSTRING (@CSOURCEGSTNO,3,10)+'''
		AND ISNULL(A.XN_ITEM_TYPE,0)<>4
		'+@CPARTYRETURNFILTER +' 
		) a
		'
		
		-- as Per Discuss with Ved ji Client(SHUBHAM SAREES) Tcs Base Amount will be less credit note amount




	end
	ELSE
	begin

	    IF isnull(@CTARGETGSTNO,'')<>''
		   SET @CPARTYPANNOFILTER=' AND SUBSTRING (LM.AC_GST_NO,3,10) ='''+SUBSTRING (@CTARGETGSTNO,3,10)+''' '
		ELSE 
		   SET @CPARTYPANNOFILTER=' AND LM.AC_code ='''+@CAC_CODE+''''


	   SET @DTSQL=N'SELECT SUM(A.credit_AMOUNT) AS TCS_BASEAMOUNT
		FROM vd01106 A (NOLOCK) 
		JOIN LOCATION L (NOLOCK)  ON L.DEPT_ID =a.cost_center_dept_id
		JOIN LMP01106 LM (NOLOCK) ON A.AC_CODE =LM.AC_CODE 
		JOIN vm01106 b (NOLOCK) ON b.vm_id=a.vm_id
		WHERE b.CANCELLED =0
		AND b.FIN_YEAR ='''+@CFINYEAR+'''
		and b.voucher_dt<='''+CONVERT(VARCHAR(10),@DINVDT,121)+'''
		AND voucher_code=''0000000003'' 
		'+@CPARTYPANNOFILTER
	end

	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
END