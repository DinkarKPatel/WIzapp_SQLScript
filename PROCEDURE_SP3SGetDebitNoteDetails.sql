create PROCEDURE SP3SGETDEBITNOTEDETAILS  
(    
    @CACCODE      VARCHAR(10)=''    
   ,@CPRODUCTCODE VARCHAR(50)    
   ,@NPURCHASEDAYS NUMERIC(5)=0    
   ,@NMEMOTYPE    NUMERIC(1)=1    
   ,@NINVMODE INT=1    
   ,@CTARGET_DEPT_ID VARCHAR(5)=''  
   ,@NTAXPICKINGMODE INT=1  
   ,@DINVDT DATETIME=''  
   ,@NQUANTITY NUMERIC(10,2)=1  
   ,@NITEMTYPE NUMERIC(1,0)=1
   ,@CDEPT_ID VARCHAR(5)=''
   ,@nBillChallanMode NUMERIC(1,0)=0	      
)    
AS     
BEGIN    
  DECLARE @DLASTPURCHASEDATE DATETIME,@CPURCHASEDAYS VARCHAR(5),@DFROMDATE DATETIME,@CSTEP VARCHAR(10),    
  @CSEARCHPRODUCTCODE VARCHAR(100),@CCURLOCID VARCHAR(5),@CSTATECODE CHAR(7),@CLOCSSTMEMOID VARCHAR(40),  
  @CTMPTABLE VARCHAR(40),@CERRORMSG VARCHAR(MAX),@BVATFOUND BIT,@CFORMID CHAR(7),@BLOCALDEBITNOTE BIT,  
  @NBILLLEVELTAXMETHOD INT,@CMRRID VARCHAR(40),@NSPID INT,@CCONFIGMODE INT ,@CPARTYRATE BIT ,@CCURDEPTID VARCHAR(5),
  @CCURDEPTACCODE VARCHAR(10)
    
  SET @NSPID=@@spid

  DELETE FROM PRT_ITEM_DETAILS WHERE SP_ID=RTRIM(LTRIM(STR(@NSPID)))


  INSERT INTO PRT_ITEM_DETAILS(PRODUCT_CODE,QUANTITY,SP_ID,row_id  )
  SELECT @CPRODUCTCODE AS PRODUCT_CODE,@NQUANTITY AS QUANTITY,
         RTRIM(LTRIM(STR(@NSPID))) AS SP_ID,newid() AS row_id

   if @NTAXPICKINGMODE not in(1,2)
      set @NTAXPICKINGMODE=1
	
   SELECT '' AS ERRMSG

          EXEC SP3S_GETPRT_DATA 
                @CACCODE=@CACCODE
               ,@XN_ITEM_TYPE=@NITEMTYPE                   
               ,@ninv_mode =@NINVMODE
               ,@nBillChallanMode =@nBillChallanMode
               ,@nBilllevelTaxMethodPara =@NTAXPICKINGMODE
               ,@CSP_ID=@NSPID
               ,@BESTIMATEMODE =0
               ,@DRM_DT=@DINVDT
               ,@CDEPTID=@CDEPT_ID
               ,@CUSERCODE='0000000'
               ,@CTARGET_DEPT_ID=@CTARGET_DEPT_ID
               ,@MEMO_TYPE=@NITEMTYPE



END    
--END OF PROCEDURE - SP3SGETDEBITNOTEDETAILS
