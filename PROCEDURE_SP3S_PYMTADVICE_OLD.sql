CREATE PROCEDURE SP3S_PYMTADVICE_OLD  
@CVMID VARCHAR(50)  
AS  
BEGIN 
	---DECLARE LOCAL VARIABLE BY GAURI ON 17/4/2019
	DECLARE @cHEAD_CODE VARCHAR(MAX) 
	

RETURN 
	
	SET @cHEAD_CODE = DBO.FN_ACT_TRAVTREE('0000000010') ----ADD VARIABLE BY GAURI ON 17/4/2019
	
 SELECT  A.*, B.AC_CODE,C.AC_NAME,A.REF_NO AS VDN_ID,(CASE WHEN LEFT(A.REF_NO,4)='PUR_' THEN PIM.BILL_NO    
 WHEN LEFT(A.REF_NO,4)='PBM_' THEN PBM.BILL_NO ELSE  A.REF_NO END) AS  BILL_NO,A.X_TYPE AS NBILL_TYPE,  
 0 AS ADJ_BILL_AMOUNT,0 AS AMOUNT_ADJUSTABLE,A.X_TYPE AS BILL_TYPE,CAST('' AS DATETIME) AS DUE_DATE,  
 CAST(V.VOUCHER_DT AS DATETIME) AS REF_DATE_VCH,
 V.VOUCHER_DT AS REF_DATE,
 0 AS DISCOUNT_PERCENTAGE,0 AS DISC_AMT,  
 (CASE WHEN A.X_TYPE='DR' THEN 1 ELSE -1 END)*A.AMOUNT AS FEEDED_AMOUNT,  
 A.AMOUNT AS NET_AMOUNT,0 AS ON_ACCOUNT,'' AS VDN_TEMP,V.DEPT_ID,  
 (CASE WHEN SUBSTRING(A.REF_NO,1,3)='PBM' THEN P1.TOTAL_AMOUNT   
 WHEN SUBSTRING(A.REF_NO,1,3)='PUR' THEN P2.TOTAL_AMOUNT ELSE A.AMOUNT END) AS BILL_AMOUNT, CAST('' AS VARCHAR(50)) AS UNIQUE_ID,1 AS SRNO  
 FROM BILL_BY_BILL_REF A (NOLOCK)   
 JOIN VD01106 B  (NOLOCK) ON A.VD_ID = B.VD_ID   
 JOIN VM01106 V  (NOLOCK) ON B.VM_ID = V.VM_ID   
 JOIN LMV01106 C  (NOLOCK) ON C.AC_CODE=B.AC_CODE  
 LEFT OUTER JOIN PIM01106 PIM (NOLOCK) ON PIM.MRR_ID=LTRIM(RTRIM(SUBSTRING(A.REF_NO,5,LEN(A.REF_NO))))  
 LEFT OUTER JOIN PBM01106 PBM (NOLOCK) ON PBM.MEMO_ID=LTRIM(RTRIM(SUBSTRING(A.REF_NO,5,LEN(A.REF_NO))))  
 LEFT OUTER JOIN PBM01106  P1 ON SUBSTRING(A.REF_NO,5,50) = P1.MEMO_ID   
 LEFT OUTER  JOIN PIM01106 P2 ON SUBSTRING(A.REF_NO,5,50) = P2.MRR_ID    
 LEFT OUTER JOIN
 (
     SELECT A.REF_NO,B.AC_CODE ,PIM.INV_DT,PBM.BILL_DT,V.VOUCHER_DT
	 FROM BILL_BY_BILL_REF A (NOLOCK)   
	 JOIN VD01106 B  (NOLOCK) ON A.VD_ID = B.VD_ID   
	 JOIN VM01106 V  (NOLOCK) ON B.VM_ID = V.VM_ID   
	 JOIN LMV01106 C  (NOLOCK) ON C.AC_CODE=B.AC_CODE  
	 LEFT OUTER JOIN PIM01106 PIM (NOLOCK) ON PIM.MRR_ID=LTRIM(RTRIM(SUBSTRING(A.REF_NO,5,LEN(A.REF_NO))))  
	 LEFT OUTER JOIN PBM01106 PBM (NOLOCK) ON PBM.MEMO_ID=LTRIM(RTRIM(SUBSTRING(A.REF_NO,5,LEN(A.REF_NO))))  
	 LEFT OUTER JOIN PBM01106  P1 ON SUBSTRING(A.REF_NO,5,50) = P1.MEMO_ID   
	 LEFT OUTER  JOIN PIM01106 P2 ON SUBSTRING(A.REF_NO,5,50) = P2.MRR_ID   
	 WHERE V.CANCELLED =0
 
 ) NEW ON NEW.AC_CODE =B.AC_CODE AND NEW.REF_NO =A.REF_NO 
 WHERE V.VM_ID=@CVMID AND ISNULL(C.BILL_BY_BILL,0)=1  
   
 UNION ALL  
 SELECT  D.*,B.AC_CODE,B.AC_NAME,'' AS VDN_ID,'CASH DISCOUNT' AS  BILL_NO,'' AS NBILL_TYPE,  
 0 AS ADJ_BILL_AMOUNT,0 AS AMOUNT_ADJUSTABLE,'' AS BILL_TYPE,CAST('' AS DATETIME) AS DUE_DATE,  
 CAST(VOUCHER_DT AS DATETIME) AS REF_DATE_VCH,'' AS REF_DATE,0 AS DISCOUNT_PERCENTAGE,0 AS DISC_AMT,  
 A.CREDIT_AMOUNT*-1 AS FEEDED_AMOUNT,A.CREDIT_AMOUNT AS NET_AMOUNT,0 AS ON_ACCOUNT,'' AS VDN_TEMP,A.COST_CENTER_DEPT_ID AS DEPT_ID,  
 A.CREDIT_AMOUNT AS BILL_AMOUNT,CAST('' AS VARCHAR(50)) AS UNIQUE_ID,2 AS SRNO   
 FROM VD01106 A JOIN LM01106 B ON A.AC_CODE=B.AC_CODE  
 JOIN VM01106 C ON C.VM_ID=A.VM_ID  
 LEFT OUTER JOIN BILL_BY_BILL_REF D ON 1=2  
 WHERE C.VM_ID=@CVMID AND CHARINDEX(B.HEAD_CODE,@cHEAD_CODE)>0  ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019
 ORDER BY REF_DATE
END
