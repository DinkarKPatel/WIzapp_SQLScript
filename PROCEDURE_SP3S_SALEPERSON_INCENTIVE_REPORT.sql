CREATE PROCEDURE SP3S_SALEPERSON_INCENTIVE_REPORT  
(  
@CDEPT_ID CHAR(2)='',  
@FROMDT VARCHAR(10),  
@TODT VARCHAR(10)  ,
@iMode int =0  --0 for NRV 1 For Taxable
  
)  
AS  
BEGIN  
   
   
  
        DECLARE @CCMD NVARCHAR(MAX),@CTARGET_MONTH VARCHAR(5),@TARGET_ACH_PER NUMERIC(10,2)  
        DECLARE @TABLE TABLE(LOCATION VARCHAR(100),TARGET INT,SALE INT,TARGET_ACH_PER INT,EMP_CODE VARCHAR(10),EMP_NAME VARCHAR(100),  
        SALEWITH1 NUMERIC(10,2),SALEWITH2 NUMERIC(10,2),SALEWITH3 NUMERIC(10,2),  
        INCWITH1 NUMERIC(10,2),INCWITH2 NUMERIC(10,2),INCWITH3 NUMERIC(10,2),SALEAMOUNT NUMERIC(10,2),  
        INCAMT NUMERIC(10,2),INCPAYBLE NUMERIC(10,2),PAYBLE_AMOUNT NUMERIC(10,2) )  
          
        IF OBJECT_ID('TEMPDB..#TMP','U') IS NOT NULL  
        DROP TABLE  #TMP  
          
        IF OBJECT_ID('TEMPDB..#TMPNEW','U') IS NOT NULL  
        DROP TABLE  #TMPNEW  
  
       SET @CCMD=N'SELECT DEPT_NAME AS LOCATION,SUM(AMOUNT) AS SALE,  
                  ''0000000'' AS EMP_CODE,
                  '''' AS EMP_NAME,  
                   ''0'' AS SALEWITH1,  
                   ''0'' AS SALEWITH2 ,''0'' AS SALEWITH3,  
                   ''0'' AS INCWITH1,''0'' AS INCWITH2,''0'' AS INCWITH3,  
                   ''0'' AS SALEAMOUNT,''0'' AS INCAMT,''0'' AS INCPAYBLE,''0'' AS PAYBLE_AMOUNT  
  
        FROM LOCATION A   
        JOIN CMM01106 CMM ON CMM.LOCATION_CODE=A.DEPT_ID  
        JOIN PAYMODE_XN_DET  PAY ON PAY.MEMO_ID=CMM.CM_ID  
  WHERE CMM.CANCELLED=0  
  AND('''+@CDEPT_ID+''' ='''' or  A.DEPT_ID='''+@CDEPT_ID+''' )  
  AND CM_DT BETWEEN '''+ @FROMDT +''' AND '''+ @TODT +''' GROUP BY DEPT_NAME'  
  PRINT @CCMD  
  INSERT INTO @TABLE(LOCATION,SALE,EMP_CODE,EMP_NAME,SALEWITH1,SALEWITH2,SALEWITH3,  
  INCWITH1,INCWITH2,INCWITH3,SALEAMOUNT,INCAMT,INCPAYBLE,PAYBLE_AMOUNT)  
  EXEC SP_EXECUTESQL @CCMD  
    



  SELECT DISTINCT EMP INTO #TMP  
  FROM   
  (  
  SELECT EMP_CODE AS EMP FROM  CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID   
  WHERE (@CDEPT_ID ='' or LEFT(CMM.CM_ID,2)=@CDEPT_ID) AND CM_DT BETWEEN @FROMDT AND @TODT  
  AND EMP_CODE <> '0000000'  
  
  UNION ALL  
  
  SELECT EMP_CODE1 AS EMP FROM  CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID   
  WHERE (@CDEPT_ID ='' or LEFT(CMM.CM_ID,2)=@CDEPT_ID)  AND CM_DT BETWEEN @FROMDT AND @TODT  
       AND EMP_CODE1 <> '0000000'  
  UNION ALL  
  
  
  SELECT EMP_CODE2 AS EMP FROM  CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID   
  WHERE (@CDEPT_ID ='' or LEFT(CMM.CM_ID,2)=@CDEPT_ID) AND CM_DT BETWEEN @FROMDT AND @TODT  
  AND EMP_CODE2 <> '0000000'  
  )A  
    
   IF OBJECT_ID('TEMPDB..#TMPEMPSALE','U') IS NOT NULL  
   DROP TABLE #TMPEMPSALE  
    
  CREATE TABLE #TMPEMPSALE  
  (  
  EMP_CODE VARCHAR(7),  
  SALEWITH1 NUMERIC(10,2),  
  SALEWITH2 NUMERIC(10,2),  
  SALEWITH3  NUMERIC(10,2),  
  INCWITH1  NUMERIC(10,2),  
  INCWITH2  NUMERIC(10,2),  
  INCWITH3  NUMERIC(10,2) ,  
  SALEAMOUNT NUMERIC(10,2),  
  PAYBLE_AMOUNT NUMERIC(10,2)  
  )  
    
  INSERT INTO #TMPEMPSALE (EMP_CODE)  
        SELECT * FROM #TMP  
    
    
      
  SET NOCOUNT ON  
  DECLARE @BLOOP BIT,@NCNT INT,@CEMP VARCHAR(7),@CEMP1SALE NUMERIC(10,2),  
  @CEMP2SALE NUMERIC(10,2),@CEMP3SALE NUMERIC(10,2),  
  @CEMP1INC NUMERIC(10,2),  
  @CEMP2INC NUMERIC(10,2),@CEMP3INC NUMERIC(10,2),@CSALEAMT NUMERIC(10,2),@CINCPAYBLE NUMERIC(10,2),  
  @CINCAMT NUMERIC(10,2)  
  SET @BLOOP=0  
  SET @NCNT=1  
  
  WHILE @BLOOP=0  
  BEGIN  
     
   SET @CEMP=''  
   SET @CEMP1SALE=0  
   SET @CEMP2SALE=0  
   SET @CEMP3SALE=0  
   SET @CEMP1INC=0   
   SET @CEMP2INC=0  
   SET @CEMP3INC=0   
   SET @CSALEAMT=0  
   SET @CINCAMT=0  
   SET @CINCPAYBLE=0  
   SET @NCNT=@NCNT+1  
   SELECT TOP 1 @CEMP=EMP FROM #TMP  
     
   IF ISNULL(@CEMP,'')=''  
    BREAK 
	
	--as per ved ji commission amount calculate from taxable value
    -- AS DISCUSS WITH vED JI AND pANKAJ JI NET_CMM_DISCOUNT_AMOUNT --10022022       
    SELECT @CEMP1SALE=ISNULL(SUM(CASE WHEN @IMODE=0 THEN NET-ISNULL(CMM_DISCOUNT_AMOUNT,0) ELSE XN_VALUE_WITHOUT_GST END ),0) FROM CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID  
    WHERE (@CDEPT_ID ='' or LEFT(CMM.CM_ID,2)=@CDEPT_ID) AND CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE=@CEMP   
      
    SELECT @CEMP2SALE=ISNULL(SUM(CASE WHEN @IMODE=0 THEN NET-ISNULL(CMM_DISCOUNT_AMOUNT,0) ELSE XN_VALUE_WITHOUT_GST END ),0) FROM CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID  
    WHERE (@CDEPT_ID ='' or LEFT(CMM.CM_ID,2)=@CDEPT_ID)  AND CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE1=@CEMP  
      
    SELECT @CEMP3SALE=ISNULL(SUM(CASE WHEN @IMODE=0 THEN NET-ISNULL(CMM_DISCOUNT_AMOUNT,0) ELSE XN_VALUE_WITHOUT_GST END ),0)  FROM CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID  
    WHERE (@CDEPT_ID ='' or LEFT(CMM.CM_ID,2)=@CDEPT_ID)  AND CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE2=@CEMP  
      
      
    SELECT @CEMP1INC=ISNULL(D.COM_PER_1,0),@CEMP2INC=ISNULL(D.COM_PER_2,0),@CEMP3INC=ISNULL(D.COM_PER_3,0)  
     FROM EMPLOYEE E JOIN EMPCATEGORY D ON D.CATEGORY_CODE=E.CATEGORY_CODE  
    WHERE  E.EMP_CODE=@CEMP   
      
      
    SET @CSALEAMT=SUM(@CEMP1SALE+@CEMP2SALE+@CEMP3SALE)  
    SET @CINCAMT=ROUND(SUM(((@CEMP1SALE * @CEMP1INC)/100)+((@CEMP2SALE * @CEMP2INC)/100)+((@CEMP3SALE * @CEMP3INC)/100)),0)  
                
      
    UPDATE #TMPEMPSALE SET SALEWITH1=@CEMP1SALE,SALEWITH2=@CEMP2SALE,SALEWITH3=@CEMP3SALE  
            ,INCWITH1=@CEMP1INC,INCWITH2=@CEMP2INC,INCWITH3=@CEMP3INC,SALEAMOUNT=@CSALEAMT,  
           PAYBLE_AMOUNT=@CINCAMT  
           WHERE EMP_CODE=@CEMP  
  
     
     
   DELETE FROM #TMP WHERE EMP=@CEMP  
  END  
    
    
  SELECT A.LOCATION,A.SALE,EC.CATEGORY_NAME ,ISNULL(EG.EMP_GRP_NAME,'') AS EMP_GRP_NAME,A.EMP_NAME,A.SALEWITH1,A.SALEWITH2,A.SALEWITH3,A.INCWITH1,A.INCWITH2,  
  A.INCWITH3,A.SALEAMOUNT,A.PAYBLE_AMOUNT  
  FROM @TABLE  A
  JOIN EMPLOYEE B ON A.EMP_CODE=B.EMP_CODE   
  JOIN EMPCATEGORY EC ON EC.CATEGORY_CODE =B.CATEGORY_CODE 
  LEFT OUTER JOIN EMP_GRP_LINK EGL ON EGL.EMP_CODE=B.EMP_CODE 
  LEFT OUTER JOIN EMPLOYEE_GRP EG ON EG.EMP_GRP_CODE =EGL.EMP_GRP_CODE  
  UNION ALL  
  SELECT '' AS LOCATION,'' AS SALE,EC.CATEGORY_NAME ,ISNULL(EG.EMP_GRP_NAME,'') AS EMP_GRP_NAME,
  EMP_NAME,SALEWITH1,SALEWITH2,SALEWITH3,  
  INCWITH1,INCWITH2,INCWITH3,SALEAMOUNT,PAYBLE_AMOUNT  
  FROM  #TMPEMPSALE A 
  JOIN EMPLOYEE B ON A.EMP_CODE=B.EMP_CODE   
  JOIN EMPCATEGORY EC ON EC.CATEGORY_CODE =B.CATEGORY_CODE 
  LEFT OUTER JOIN EMP_GRP_LINK EGL ON EGL.EMP_CODE=B.EMP_CODE 
  LEFT OUTER JOIN EMPLOYEE_GRP EG ON EG.EMP_GRP_CODE =EGL.EMP_GRP_CODE  
END
/*
CREATE PROCEDURE SP3S_SALEPERSON_INCENTIVE_REPORT  
(  
	@CDEPT_ID CHAR(2)='',  
	@FROMDT VARCHAR(10),  
	@TODT VARCHAR(10)  
)  
AS  
BEGIN  
    DECLARE @CCMD NVARCHAR(MAX),@CTARGET_MONTH VARCHAR(5),@TARGET_ACH_PER NUMERIC(10,2)  
    
    DECLARE @TABLE TABLE(LOCATION VARCHAR(100),TARGET INT,SALE INT,TARGET_ACH_PER INT,EMP_CODE VARCHAR(10),EMP_NAME VARCHAR(100),  
						 SALEWITH1 NUMERIC(10,2),SALEWITH2 NUMERIC(10,2),SALEWITH3 NUMERIC(10,2),  
						 INCWITH1 NUMERIC(10,2),INCWITH2 NUMERIC(10,2),INCWITH3 NUMERIC(10,2),SALEAMOUNT NUMERIC(10,2),  
						 INCAMT NUMERIC(10,2),INCPAYBLE NUMERIC(10,2),PAYBLE_AMOUNT NUMERIC(10,2))  
          
    IF OBJECT_ID('TEMPDB..#TMP','U') IS NOT NULL  
       DROP TABLE #TMP  
          
    IF OBJECT_ID('TEMPDB..#TMPNEW','U') IS NOT NULL  
       DROP TABLE #TMPNEW  
  
    SET @CCMD=N'SELECT DEPT_NAME AS LOCATION,SUM(AMOUNT) AS SALE,  
                  ''0000000'' AS EMP_CODE,
                  '''' AS EMP_NAME,  
                  ''0'' AS SALEWITH1,  
                  ''0'' AS SALEWITH2,
                  ''0'' AS SALEWITH3,  
                  ''0'' AS INCWITH1,
                  ''0'' AS INCWITH2,
                  ''0'' AS INCWITH3,  
                  ''0'' AS SALEAMOUNT,
                  ''0'' AS INCAMT,
                  ''0'' AS INCPAYBLE,
                  ''0'' AS PAYBLE_AMOUNT  
        FROM LOCATION A (NOLOCK)  
        JOIN CMM01106 CMM (NOLOCK) ON LEFT(CMM.CM_ID,2)=A.DEPT_ID  
        JOIN PAYMODE_XN_DET PAY (NOLOCK) ON PAY.MEMO_ID=CMM.CM_ID  
		WHERE CMM.CANCELLED=0 
		AND CM_DT BETWEEN '''+ @FROMDT +''' AND '''+ @TODT +'''' 
		+CASE @CDEPT_ID WHEN '' THEN '' ELSE ' AND A.DEPT_ID='''+@CDEPT_ID+'''' END 
		+'GROUP BY DEPT_NAME'  
	PRINT @CCMD  
	
	INSERT INTO @TABLE(LOCATION,SALE,EMP_CODE,EMP_NAME,SALEWITH1,SALEWITH2,SALEWITH3,  
	INCWITH1,INCWITH2,INCWITH3,SALEAMOUNT,INCAMT,INCPAYBLE,PAYBLE_AMOUNT)  
	EXEC SP_EXECUTESQL @CCMD  
    
	SELECT DISTINCT EMP,LOC INTO #TMP  
    FROM   
    (  
      SELECT EMP_CODE AS EMP,LEFT(CMM.CM_ID,2) LOC 
      FROM CMM01106 CMM (NOLOCK) JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID=CMD.CM_ID   
      WHERE CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE <> '0000000'  
  
      UNION ALL  
  
	  SELECT EMP_CODE1 AS EMP,LEFT(CMM.CM_ID,2) LOC 
	  FROM CMM01106 CMM (NOLOCK) JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID=CMD.CM_ID   
	  WHERE CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE1 <> '0000000'  
	  
	  UNION ALL  
  
	  SELECT EMP_CODE2 AS EMP,LEFT(CMM.CM_ID,2) LOC 
	  FROM CMM01106 CMM (NOLOCK) JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID=CMD.CM_ID   
	  WHERE CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE2 <> '0000000'  
   )A  
   
   IF @CDEPT_ID!='' DELETE #TMP WHERE LOC<>@CDEPT_ID
   ALTER TABLE #TMP DROP COLUMN LOC
    
   IF OBJECT_ID('TEMPDB..#TMPEMPSALE','U') IS NOT NULL  
      DROP TABLE #TMPEMPSALE  
    
   CREATE TABLE #TMPEMPSALE  
   (  
    EMP_CODE VARCHAR(7),  
    SALEWITH1 NUMERIC(10,2),  
    SALEWITH2 NUMERIC(10,2),  
    SALEWITH3 NUMERIC(10,2),  
    INCWITH1 NUMERIC(10,2),  
    INCWITH2 NUMERIC(10,2),  
    INCWITH3 NUMERIC(10,2) ,  
    SALEAMOUNT NUMERIC(10,2),  
    PAYBLE_AMOUNT NUMERIC(10,2)  
   )  
    
  INSERT INTO #TMPEMPSALE(EMP_CODE) SELECT * FROM #TMP  
    
  SET NOCOUNT ON  
  DECLARE @BLOOP BIT,@NCNT INT,@CEMP VARCHAR(7),@CEMP1SALE NUMERIC(10,2),  
  @CEMP2SALE NUMERIC(10,2),@CEMP3SALE NUMERIC(10,2),  
  @CEMP1INC NUMERIC(10,2),  
  @CEMP2INC NUMERIC(10,2),@CEMP3INC NUMERIC(10,2),@CSALEAMT NUMERIC(10,2),@CINCPAYBLE NUMERIC(10,2),  
  @CINCAMT NUMERIC(10,2)  
  SET @BLOOP=0  
  SET @NCNT=1  
  
  WHILE @BLOOP=0  
    BEGIN  
      SELECT @CEMP='',@CEMP1SALE=0,@CEMP2SALE=0,@CEMP3SALE=0,@CEMP1INC=0,@CEMP2INC=0,@CEMP3INC=0,@CSALEAMT=0,@CINCAMT=0,@CINCPAYBLE=0  
      SET @NCNT=@NCNT+1  
      SELECT TOP 1 @CEMP=EMP FROM #TMP  
     
      IF ISNULL(@CEMP,'')=''  
         BREAK  
         
	  IF @CDEPT_ID!=''           
		 SELECT @CEMP1SALE=ISNULL(SUM(NET),0) 
         FROM CMM01106 CMM (NOLOCK) JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID=CMD.CM_ID  
         WHERE LEFT(CMM.CM_ID,2)=@CDEPT_ID AND CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE=@CEMP   
	  ELSE
	  	 SELECT @CEMP1SALE=ISNULL(SUM(NET),0) 
         FROM CMM01106 CMM (NOLOCK) JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID=CMD.CM_ID  
         WHERE CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE=@CEMP   
	      
      IF @CDEPT_ID!=''
         SELECT @CEMP2SALE=ISNULL(SUM(NET),0) 
         FROM CMM01106 CMM (NOLOCK) JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID=CMD.CM_ID  
         WHERE LEFT(CMM.CM_ID,2)=@CDEPT_ID  AND CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE1=@CEMP  
      ELSE
         SELECT @CEMP2SALE=ISNULL(SUM(NET),0) 
         FROM CMM01106 CMM (NOLOCK) JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID=CMD.CM_ID  
         WHERE CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE1=@CEMP  
      
      IF @CDEPT_ID!=''
         SELECT @CEMP3SALE=ISNULL(SUM(NET),0)
         FROM CMM01106 CMM (NOLOCK) JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID=CMD.CM_ID  
	     WHERE LEFT(CMM.CM_ID,2)=@CDEPT_ID  AND CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE2=@CEMP  
	  ELSE
         SELECT @CEMP3SALE=ISNULL(SUM(NET),0)
         FROM CMM01106 CMM (NOLOCK) JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID=CMD.CM_ID  
         WHERE CM_DT BETWEEN @FROMDT AND @TODT AND EMP_CODE2=@CEMP  
	  	  
      SELECT @CEMP1INC=ISNULL(D.COM_PER_1,0),@CEMP2INC=ISNULL(D.COM_PER_2,0),@CEMP3INC=ISNULL(D.COM_PER_3,0)  
      FROM EMPLOYEE E (NOLOCK) JOIN EMPCATEGORY D (NOLOCK) ON D.CATEGORY_CODE=E.CATEGORY_CODE  
      WHERE E.EMP_CODE=@CEMP   
      
      SET @CSALEAMT=SUM(@CEMP1SALE+@CEMP2SALE+@CEMP3SALE)  
      SET @CINCAMT=ROUND(SUM(((@CEMP1SALE * @CEMP1INC)/100)+((@CEMP2SALE * @CEMP2INC)/100)+((@CEMP3SALE * @CEMP3INC)/100)),0)  
                
      UPDATE #TMPEMPSALE SET SALEWITH1=@CEMP1SALE,SALEWITH2=@CEMP2SALE,SALEWITH3=@CEMP3SALE  
						,INCWITH1=@CEMP1INC,INCWITH2=@CEMP2INC,INCWITH3=@CEMP3INC,SALEAMOUNT=@CSALEAMT
						,PAYBLE_AMOUNT=@CINCAMT  
      WHERE EMP_CODE=@CEMP  
  
      DELETE FROM #TMP WHERE EMP=@CEMP  
  END  
    
    
  SELECT A.LOCATION,A.SALE,EC.CATEGORY_NAME ,ISNULL(EG.EMP_GRP_NAME,'') AS EMP_GRP_NAME,A.EMP_NAME,A.SALEWITH1,A.SALEWITH2,A.SALEWITH3,A.INCWITH1,A.INCWITH2,  
  A.INCWITH3,A.SALEAMOUNT,A.PAYBLE_AMOUNT  
  FROM @TABLE  A
  JOIN EMPLOYEE B (NOLOCK) ON A.EMP_CODE=B.EMP_CODE   
  JOIN EMPCATEGORY EC (NOLOCK) ON EC.CATEGORY_CODE =B.CATEGORY_CODE 
  LEFT OUTER JOIN EMP_GRP_LINK EGL (NOLOCK) ON EGL.EMP_CODE=B.EMP_CODE 
  LEFT OUTER JOIN EMPLOYEE_GRP EG (NOLOCK) ON EG.EMP_GRP_CODE =EGL.EMP_GRP_CODE  
  UNION ALL  
  SELECT '' AS LOCATION,'' AS SALE,EC.CATEGORY_NAME ,ISNULL(EG.EMP_GRP_NAME,'') AS EMP_GRP_NAME,
  EMP_NAME,SALEWITH1,SALEWITH2,SALEWITH3,  
  INCWITH1,INCWITH2,INCWITH3,SALEAMOUNT,PAYBLE_AMOUNT  
  FROM #TMPEMPSALE A 
  JOIN EMPLOYEE B (NOLOCK) ON A.EMP_CODE=B.EMP_CODE   
  JOIN EMPCATEGORY EC (NOLOCK) ON EC.CATEGORY_CODE =B.CATEGORY_CODE 
  LEFT OUTER JOIN EMP_GRP_LINK EGL (NOLOCK) ON EGL.EMP_CODE=B.EMP_CODE 
  LEFT OUTER JOIN EMPLOYEE_GRP EG (NOLOCK) ON EG.EMP_GRP_CODE =EGL.EMP_GRP_CODE  
END
*/
