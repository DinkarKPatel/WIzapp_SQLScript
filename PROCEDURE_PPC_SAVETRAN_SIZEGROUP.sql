CREATE PROCEDURE PPC_SAVETRAN_SIZEGROUP
(
	 @NSPID			INT=0,
	 @CNEWSIZEGROUP_CODE VARCHAR(10)=''
)
----WITH ENCRYPTION
AS
BEGIN
DECLARE @CERRMSG VARCHAR(500),@CSTEP VARCHAR(10)
	   ,@CCMD NVARCHAR(MAX)

DECLARE @TOUTPUT TABLE(SIZEGROUP_CODE VARCHAR(50),ERRMSG VARCHAR(500))

---LIST OF TABLES TO SAVE
DECLARE @TSIZEGROUP_PARA2 VARCHAR(100)
--,@TSKU VARCHAR(100)


SET @TSIZEGROUP_PARA2='SIZE_PPC_SIZEGROUP_PARA2_UPLOAD'
--SET @TSKU=@CTABLE_PREFIX+'SKU'+@CTABLE_SUFFIX


   
BEGIN TRY
BEGIN TRANSACTION
		   SET @CSTEP=10
		  
			--VALIDATION OF VALID SIZE
			SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TSIZEGROUP_PARA2+' A LEFT JOIN PARA2 B ON A.PARA2_CODE=B.PARA2_CODE
								  WHERE B.PARA2_CODE IS NULL AND A.SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''')
					        SET @CERRMSG=''INVALID SIZE ASSIGNED TO THE SIZE GROUP.'' '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT	
			
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC	
				
			/*VALIDATIONS ON ART_PARA1
				**PARA1_CODE SHOULD EXISTS IN COLOR MASTER	
			*/
			SET @CSTEP=80
			--VALIDATION ON PARA1_CODE OF ART_PARA1
			SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TSIZEGROUP_PARA2+' A LEFT JOIN PPC_SIZEGROUP B ON A.SIZEGROUP_CODE=B.SIZEGROUP_CODE
								  WHERE B.SIZEGROUP_CODE IS NULL AND A.SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''')
					        SET @CERRMSG=''INVALID SIZE GROUP. '' '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT	
			
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC		
					
			SET @CSTEP=240
			-----GET THE SIZEGROUP_CODE OF MODIFIED SIZEGROUP
			--SET @CCMD=N'SELECT @CNEWSIZEGROUP_CODE=SIZEGROUP_CODE FROM '+@TSIZEGROUP_PARA2 +' WHERE  SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
			--PRINT @CCMD
			--EXEC SP_EXECUTESQL @CCMD,N'@CNEWSIZEGROUP_CODE VARCHAR(10) OUTPUT',@CNEWSIZEGROUP_CODE OUTPUT
			
			--SET @CSTEP=250
			----DELETE THE EXISTING RECORD FOR THIS SIZEGROUP IN PPC_SIZEGROUP_PARA2
			
	LBLBDELETE:	
		
	DELETE FROM  PPC_SIZEGROUP_PARA2 WHERE SIZEGROUP_CODE=@CNEWSIZEGROUP_CODE
	
	DECLARE @FILTER VARCHAR(MAX)
	SET @FILTER=' B.SP_ID= '''+LTRIM(RTRIM(STR(@NSPID)))+''' '	
	
	--SP_INSERTSTR PPC_SIZEGROUP_PARA2
    INSERT PPC_SIZEGROUP_PARA2	( SIZEGROUP_CODE, PARA2_CODE,SR_NO )  
    SELECT 	  SIZEGROUP_CODE, PARA2_CODE,SR_NO FROM 
    SIZE_PPC_SIZEGROUP_PARA2_UPLOAD WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID)))



		
END TRY
BEGIN CATCH 
	SET @CERRMSG='SAVETRAN_SIZEGROUP: STEP - '+ISNULL(@CSTEP,'')+', MESSAGE - '+ERROR_MESSAGE() 
END CATCH

END_PROC:

IF @@TRANCOUNT>0  
 BEGIN  
  IF ISNULL(@CERRMSG,'')='' 
   COMMIT TRANSACTION  
  ELSE  
   ROLLBACK  
 END  

--DROP TEMP TABLES
IF ISNULL(@CERRMSG,'')=''
BEGIN
    DELETE FROM SIZE_PPC_SIZEGROUP_PARA2_UPLOAD WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID)))
END

INSERT @TOUTPUT(SIZEGROUP_CODE,ERRMSG)
SELECT @CNEWSIZEGROUP_CODE,ISNULL(@CERRMSG,'')

SELECT * FROM @TOUTPUT

END
--END OF PROCEDURE - SAVETRAN_SIZEGROUP
