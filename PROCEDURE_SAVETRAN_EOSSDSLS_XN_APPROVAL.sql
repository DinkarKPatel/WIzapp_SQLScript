-- PROCEDURE TO SAVE A TRANSACTION APPROVAL MEMO 
create PROCEDURE SAVETRAN_EOSSDSLS_XN_APPROVAL
(
	@NUPDATEMODE		NUMERIC(1,0),
	@NSPID				INT,
	@CMEMONOPREFIX		VARCHAR(50),
	@CFINYEAR			VARCHAR(10),
	@CMACHINENAME		VARCHAR(100)='',
	@CWINDOWUSERNAME	VARCHAR(100)='',
	@CWIZAPPUSERCODE	VARCHAR(10)='0000000',
	@CMEMOID			VARCHAR(40)='',
	@CLOCID				VARCHAR(4)=''
)
--WITH ENCRYPTION
AS
BEGIN
	-- @NUPDATEMODE:	1- NEW MEMO ADDED, 
	--					2- EXISTING MEMO EDITED, 
	
	DECLARE @CTEMPDBNAME			VARCHAR(100),
			@CMASTERTABLENAME		VARCHAR(100),
			@CTEMPMASTERTABLENAME	VARCHAR(1000),
			@CTEMPMASTERTABLE		VARCHAR(1000),
			@CERRORMSG				VARCHAR(500),
			@CLOCATIONID			VARCHAR(4),
			@CHODEPTID				VARCHAR(4),
			@CCMD					NVARCHAR(4000),
			@CCMDOUTPUT				NVARCHAR(4000),
			@NSAVETRANLOOP			BIT,
			@NSTEP					INT,
			@BNEGSTOCKFOUND			BIT,
			@CVALUSERARC			CHAR(2),
			@ARCTYPE                INT,
			@ARCT                   INT,
			@CMEMODT                DATETIME	,@NLEVELNO NUMERIC(2,0),@BINVALIDENTRYFOUND BIT
			,@CXNTYPE VARCHAR(20)
			,@CREFXNTYPE VARCHAR(20)
			,@ICURRENTLEVEL INT
			,@IMAXLEVEL INT

	DECLARE @OUTPUT TABLE ( ERRMSG VARCHAR(2000), MEMO_ID VARCHAR(100))

	SET @NSTEP = 0		-- SETTTING UP ENVIRONMENT
    SET @CXNTYPE='SLSEDT'
	-- TEMPORARY DATABASE Discarded now onwards as per Meeting on 30-10-2020 mentioned in Client issues List
	SET @CTEMPDBNAME = ''
		
	SET @CMASTERTABLENAME	= 'EOSSDSLS_XN_APPROVAL'

	SET @CTEMPMASTERTABLENAME	= 'TEMP_EOSSDSLS_XN_APPROVAL_'+LTRIM(RTRIM(STR(@NSPID)))

	SET @CTEMPMASTERTABLE	= @CTEMPDBNAME + @CTEMPMASTERTABLENAME
	
	SET @CERRORMSG			= ''
	
	SET @CLOCATIONID=@CLOCID
		
	SELECT @CHODEPTID		= [VALUE] FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		

	SET @NSTEP = 10		-- GETTING DEPTID INFO FROM TEMP TABLE
	BEGIN TRY
		
		BEGIN TRANSACTION			

		IF ISNULL(@CLOCATIONID,'')=''
		 BEGIN
			SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' LOCATION ID CAN NOT BE BLANK  '  
			GOTO END_PROC    
		 END
		
		SELECT @IMAXLEVEL=ISNULL(MAX(LEVEL_NO),0)
		FROM XN_APPROVAL_CHECKLIST_LEVELS
		WHERE XN_TYPE='SLSEDT' AND INACTIVE=0
		
		
		SET @CCMD=N'DELETE FROM A FROM EOSSDISABLEDSLS A
		JOIN '+@CTEMPMASTERTABLE+' B ON A.CM_ID=B.CM_ID' 
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
		
		SET @CCMD=N'SELECT CM_ID,APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
										C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
										THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
					FROM '+@CTEMPMASTERTABLE+' C'
		PRINT @CCMD
				
		INSERT EOSSDISABLEDSLS(CM_ID,APPROVEDLEVELNO)
		EXEC SP_EXECUTESQL @CCMD
						
	
		-- START UPDATING XN TABLES	
		IF @NUPDATEMODE = 1 -- ADDMODE	
		BEGIN	
			
			SET @NSTEP = 113	
			SET @CCMD = 'UPDATE A SET A.LEVEL_NO=(CASE WHEN ISNULL(A.LEVEL_NO,0)=0 THEN B.LEVEL_NO ELSE A.LEVEL_NO END),
						 ROW_ID=NEWID() FROM ' +
						 @CTEMPMASTERTABLE + ' A 
						 JOIN XN_APPROVAL_CHECKLIST_LEVEL_USERS B ON A.USER_CODE=B.USER_CODE
						 JOIN XN_APPROVAL_CHECKLIST_LEVELS C ON C.LEVEL_NO=B.LEVEL_NO AND C.XN_TYPE=''SLSEDT'''

			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
		END					-- END OF ADDMODE
		
		SET @NSTEP = 140
		EXEC UPDATEMASTERXN 
			  @CSOURCEDB	= @CTEMPDBNAME
			, @CSOURCETABLE = @CTEMPMASTERTABLENAME
			, @CDESTDB		= ''
			, @CDESTTABLE	= @CMASTERTABLENAME
			, @CKEYFIELD1	= 'ROW_ID'
			, @BALWAYSUPDATE = 1
			, @LINSERTONLY=1
			
		-- VALIDATING ENTRIES 
		

		IF @CCMDOUTPUT <> ''
		BEGIN
			SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' DATA VALIDATION FAILED : ' + @CCMDOUTPUT + '...'
			GOTO END_PROC
		END
		
	END TRY
	BEGIN CATCH
		SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		
		
		GOTO END_PROC
	END CATCH
	
END_PROC:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')='' AND ISNULL(@BINVALIDENTRYFOUND,0)=0
		BEGIN
			COMMIT TRANSACTION
		END	
		ELSE
			ROLLBACK
	END
	
	IF ISNULL(@BINVALIDENTRYFOUND,0)=0
	BEGIN
		INSERT @OUTPUT ( ERRMSG, MEMO_ID)
		SELECT  ISNULL(@CERRORMSG,''),CASE WHEN ISNULL(@CERRORMSG,'')='' THEN 'SUCESS' ELSE 'FAIL' END

		SELECT * FROM @OUTPUT	
	END	

	SET @CCMD=N'IF OBJECT_ID('''+@CTEMPMASTERTABLE+''',''U'') IS NOT NULL  
						DROP TABLE '+@CTEMPMASTERTABLE+''
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
	
END
------------------------------------------------------ END OF PROCEDURE SAVETRAN_EOSSDSLS_XN_APPROVAL
