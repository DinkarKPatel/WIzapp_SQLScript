CREATE PROCEDURE VALIDATEXN_WSL_PRD
 @CXNID VARCHAR(50),	
 @NUPDATEMODE INT,			 
 @CERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
	PRINT 'VALIDATE WSL-1'
	DECLARE @CPRODUCTCODE VARCHAR(50),@CCMD NVARCHAR(MAX),@NSUMINDNET NUMERIC(14,2),@NSUBTOTAL NUMERIC(14,2),
			@NCALCTOTALAMOUNT NUMERIC(14,2),@NINMTOTALAMOUNT NUMERIC(14,2),@NCALCDISCOUNTAMT NUMERIC(10,2),
			@NDISCOUNTAMT NUMERIC(10,2),@NCALCTAXAMT NUMERIC(14,2),@NTAXAMT NUMERIC(14,2),
			@CPARA1 VARCHAR(50),@CPARA2 VARCHAR(50)
		
	SELECT TOP 1 @CPRODUCTCODE=C.ARTICLE_NO,@CPARA1=D.PARA1_NAME,@CPARA2=E.PARA2_NAME
	FROM PRD_IND01106 A
	JOIN PRD_SKU B ON A.PRODUCT_UID = B.PRODUCT_UID 
	JOIN ARTICLE C ON B.ARTICLE_CODE = C.ARTICLE_CODE 
	JOIN PARA1 D ON B.PARA1_CODE = D.PARA1_CODE 
	JOIN PARA2 E ON B.PARA2_CODE = E.PARA2_CODE 
	WHERE INV_ID=@CXNID  AND RATE=0
			   
	IF ISNULL(@CPRODUCTCODE,'')<>''
	BEGIN
		SET @CERRORMSG = 'INVALID RATE FOR ARTICLE NO : '+@CPRODUCTCODE  +',COLOR : '+@CPARA1  +',SIZE : '+@CPARA2  +' ..... CANNOT SAVE '
		RETURN
	END
					
	SELECT @NSUMINDNET=SUM((A.RATE-(A.DISCOUNT_AMOUNT/A.QUANTITY))*A.QUANTITY) FROM PRD_IND01106 A
	JOIN PRD_SKU B ON A.PRODUCT_UID=B.PRODUCT_UID
	JOIN ARTICLE C ON C.ARTICLE_CODE=B.ARTICLE_CODE
	WHERE INV_ID=@CXNID

	PRINT 'VALIDATE WSL-2'
	
	-- CHECKING DISCOUNT AMOUNT AT ITEM LEVEL
	SELECT TOP 1 @CPRODUCTCODE=C.ARTICLE_NO,@CPARA1=D.PARA1_NAME,@CPARA2=E.PARA2_NAME,
	          @NCALCDISCOUNTAMT=ROUND((QUANTITY*RATE)*A.DISCOUNT_PERCENTAGE/100,0),
	         @NDISCOUNTAMT=A.DISCOUNT_AMOUNT
	FROM PRD_IND01106 A 
	JOIN PRD_SKU B ON A.PRODUCT_UID = B.PRODUCT_UID 
	JOIN ARTICLE C ON B.ARTICLE_CODE = C.ARTICLE_CODE
	JOIN PARA1 D ON B.PARA1_CODE = D.PARA1_CODE 
	JOIN PARA2 E ON B.PARA2_CODE = E.PARA2_CODE  
	WHERE INV_ID=@CXNID
	
		
	IF 	ABS(@NDISCOUNTAMT-ISNULL(@NCALCDISCOUNTAMT,0))>1
	BEGIN
		SET @CERRORMSG='MISMATCH BETWEEN ITEM LEVEL EXPECTED DISCOUNT AMOUNT ('+LTRIM(RTRIM(STR(
						ISNULL(@NCALCDISCOUNTAMT,0),10,2)))+') &
						UPDATED DISCOUNT AMOUNT ('+LTRIM(RTRIM(STR(ISNULL(@NDISCOUNTAMT,0),10,2)))+') 
						FOR ARTICLE NO : '+@CPRODUCTCODE  +',COLOR : '+@CPARA1  +',SIZE : '+@CPARA2  +' ..... CANNOT SAVE '

		RETURN
	END

	SELECT @NSUBTOTAL =SUBTOTAL FROM PRD_INM01106 WHERE INV_ID=@CXNID

	IF ABS(ISNULL(@NSUMINDNET,0)-ISNULL(@NSUBTOTAL,0))>1
	BEGIN
		UPDATE PRD_INM01106 SET SUBTOTAL=ISNULL(@NSUMINDNET,0) WHERE INV_ID=@CXNID
		--SET @CERRORMSG = 'MISMATCH BETWEEN ITEM LEVEL TOTAL AMOUNT & BILL LEVEL SUBTOTAL.....' -- CANNOT SAVE '
		--RETURN
	END
	
	PRINT 'VALIDATE WSL-3'
	-- CHECKING DISCOUNT AMOUNT AT BILL LEVEL
		
	SELECT @NCALCDISCOUNTAMT = ROUND(SUBTOTAL*DISCOUNT_PERCENTAGE/100,0) FROM PRD_INM01106 WHERE INV_ID=@CXNID
	
	SELECT @NDISCOUNTAMT = DISCOUNT_AMOUNT FROM  PRD_INM01106  WHERE INV_ID=@CXNID
		
	IF 	ABS(@NDISCOUNTAMT-ISNULL(@NCALCDISCOUNTAMT,0))>1
	BEGIN
		SET @CERRORMSG='MISMATCH BETWEEN BILL LEVEL EXPECTED DISCOUNT AMOUNT ('+LTRIM(RTRIM(STR(
						ISNULL(@NCALCDISCOUNTAMT,0),10,2)))+') &
						UPDATED DISCOUNT AMOUNT ('+LTRIM(RTRIM(STR(ISNULL(@NDISCOUNTAMT,0),10,2)))+')..... CANNOT SAVE '

		RETURN
	END
	
	DECLARE @BEXCISEINVOICE BIT,@NACCESSIBLEVALPCT NUMERIC(6,2),@NACCESSIBLEPCTFORM NUMERIC(6,2),@NTOTACCESSIBLEVALUPD NUMERIC(10,2),
	@NTOTACCESSIBLEVALCALC NUMERIC(10,2),@NEXCISEMRPVAL NUMERIC(10,2),@NEXCISEDUTYPCTUPD NUMERIC(6,2),
	@NEXCISEDUTYPCTFORM NUMERIC(6,2),@NCALEXCISEDUTY NUMERIC(10,2),@NUPDEXCISEDUTY NUMERIC(10,2),
	@NEXCISEEDUCESSPCTUPD NUMERIC(6,2),@NEXCISEEDUCESSPCTFORM NUMERIC(6,2),@NCALEDUCESS NUMERIC(10,2),@NUPDEDUCESS NUMERIC(10,2),
	@NEXCISEHEDUCESSPCTUPD NUMERIC(6,2),@NEXCISEHEDUCESSPCTFORM NUMERIC(6,2),@NCALHEDUCESS NUMERIC(10,2),@NUPDHEDUCESS NUMERIC(10,2),
	@NCALCTAXVAL NUMERIC(10,2),@NUPDTAXVAL NUMERIC(10,2)
	
	SELECT @BEXCISEINVOICE=EXCISE_INVOICE FROM PRD_INM01106 WHERE INV_ID=@CXNID 
	
	
	--- DO VALIDATIONS FOR EXCISE DUTY CALCULATION
	IF @BEXCISEINVOICE=1
	BEGIN
		
		PRINT 'VALIDATE WSL-3'
			
		SELECT @NACCESSIBLEVALPCT = A.EXCISE_ACCESSIBLE_PERCENTAGE
		FROM PRD_INM01106 A  WHERE A.INV_ID=@CXNID
		
		SELECT TOP 1 @NACCESSIBLEPCTFORM = EXCISE_ACCESSIBLE_PERCENTAGE
		FROM PRD_IND01106 A JOIN FORM B ON A.ITEM_FORM_ID=B.FORM_ID
		 WHERE A.INV_ID=@CXNID			 
		
		IF ISNULL(@NACCESSIBLEVALPCT,0)<>ISNULL(@NACCESSIBLEPCTFORM,0)
		BEGIN
			SET @CERRORMSG='BILL LEVEL ACCESSIBLE PERCENTAGE '+STR(@NACCESSIBLEVALPCT,6,2)+' IS NOT SAME AS
					   THAT STORED IN FORM MASTER : '+STR(@NACCESSIBLEPCTFORM,6,2)+' ....... PLEASE CHECK'
			RETURN
		END
		
		SELECT @NEXCISEMRPVAL=SUM(QUANTITY*MRP) FROM PRD_IND01106 WHERE INV_ID=@CXNID
		
		SELECT @NTOTACCESSIBLEVALUPD = EXCISE_ACCESSIBLE_AMOUNT FROM PRD_INM01106 WHERE INV_ID=@CXNID

		SELECT @NTOTACCESSIBLEVALCALC = (@NEXCISEMRPVAL*@NACCESSIBLEVALPCT/100)
		
		IF ABS(@NTOTACCESSIBLEVALUPD-ISNULL(@NTOTACCESSIBLEVALCALC,0))>.1
		BEGIN
			SET @CERRORMSG='MISMATCH BETWEEN CALCULATED ACCESSIBLE VALUE ('+LTRIM(RTRIM(STR(ISNULL(@NTOTACCESSIBLEVALCALC,0),10,2)))+
					  ') & UPDATED ACCESSIBLE VALUE ('+LTRIM(RTRIM(STR(ISNULL(@NTOTACCESSIBLEVALUPD,0),10,2)))+')..... CANNOT SAVE '
			RETURN
		END
		
		SELECT @NEXCISEDUTYPCTUPD = A.EXCISE_DUTY_PERCENTAGE FROM PRD_INM01106 A 
		WHERE A.INV_ID=@CXNID
		
		SELECT TOP 1 @NEXCISEDUTYPCTFORM = B.EXCISE_DUTY_PERCENTAGE FROM PRD_IND01106 A 
		JOIN FORM B ON A.ITEM_FORM_ID=B.FORM_ID WHERE A.INV_ID=@CXNID
		
		IF ISNULL(@NEXCISEDUTYPCTUPD,0)<>ISNULL(@NEXCISEDUTYPCTFORM,0)
		BEGIN
			SET @CERRORMSG='BILL LEVEL EXCISE DUTY PERCENTAGE '+LTRIM(RTRIM(STR(@NEXCISEDUTYPCTUPD,6,2)))+
					  ' IS NOT SAME AS THAT STORED IN FORM MASTER : '+LTRIM(RTRIM(STR(@NEXCISEDUTYPCTFORM,6,2)))+' ....... PLEASE CHECK'
			RETURN
		END
		
		SELECT @NCALEXCISEDUTY = @NTOTACCESSIBLEVALUPD*@NEXCISEDUTYPCTUPD/100 
		
		SELECT @NUPDEXCISEDUTY = EXCISE_DUTY_AMOUNT FROM PRD_INM01106 WHERE INV_ID=@CXNID
		
		IF ABS(@NUPDEXCISEDUTY-ISNULL(@NCALEXCISEDUTY,0))>.1
		BEGIN
			SET @CERRORMSG='MISMATCH BETWEEN CALCULATED EXCISE DUTY AMOUNT ('+LTRIM(RTRIM(STR(ISNULL(@NCALEXCISEDUTY,0),10,2)))+
					  ') & UPDATED EXCISE DUTY AMOUNT ('+LTRIM(RTRIM(STR(ISNULL(@NUPDEXCISEDUTY,0),10,2)))+')..... CANNOT SAVE '

			RETURN
		END
		
		SELECT @NEXCISEEDUCESSPCTUPD = A.EXCISE_EDU_CESS_PERCENTAGE FROM PRD_INM01106 A 
		WHERE A.INV_ID=@CXNID
		
		SELECT TOP 1 @NEXCISEEDUCESSPCTFORM = B.EXCISE_EDU_CESS_PERCENTAGE FROM PRD_IND01106 A 
		JOIN FORM B ON A.ITEM_FORM_ID=B.FORM_ID WHERE A.INV_ID=@CXNID
		
		IF ISNULL(@NEXCISEEDUCESSPCTUPD,0)<>ISNULL(@NEXCISEEDUCESSPCTFORM,0)
		BEGIN
			SET @CERRORMSG='BILL LEVEL EDUCATION CESS PERCENTAGE '+LTRIM(RTRIM(STR(@NEXCISEEDUCESSPCTUPD,6,2)))+
					  ' IS NOT SAME AS  THAT STORED IN FORM MASTER : '+LTRIM(RTRIM(STR(@NEXCISEEDUCESSPCTFORM,6,2)))+' ....... PLEASE CHECK'
			RETURN
		END
		
		SELECT @NCALEDUCESS = @NUPDEXCISEDUTY*@NEXCISEEDUCESSPCTUPD/100 
		
		SELECT @NUPDEDUCESS = EXCISE_EDU_CESS_AMOUNT FROM PRD_INM01106 WHERE INV_ID=@CXNID
		
		IF ABS(@NUPDEDUCESS-ISNULL(@NCALEDUCESS,0))>.01
		BEGIN
			SET @CERRORMSG='MISMATCH BETWEEN CALCULATED EDUCATION CESS AMOUNT ('+LTRIM(RTRIM(STR(ISNULL(@NCALEDUCESS,0),10,2)))+
					  ') & UPDATED EDUCATION CESS AMOUNT ('+LTRIM(RTRIM(STR(ISNULL(@NUPDEDUCESS,0),10,2)))+')..... CANNOT SAVE '

			RETURN
		END
		
		SELECT @NEXCISEHEDUCESSPCTUPD = A.EXCISE_HEDU_CESS_PERCENTAGE FROM PRD_INM01106 A WHERE A.INV_ID=@CXNID

		SELECT TOP 1 @NEXCISEHEDUCESSPCTFORM = B.EXCISE_HEDU_CESS_PERCENTAGE FROM PRD_IND01106 A 
		JOIN FORM B ON A.ITEM_FORM_ID=B.FORM_ID WHERE A.INV_ID=@CXNID
				
		IF ISNULL(@NEXCISEHEDUCESSPCTUPD,0)<>ISNULL(@NEXCISEHEDUCESSPCTFORM,0)
		BEGIN
			SET @CERRORMSG='BILL LEVEL HIGHER EDUCATION CESS PERCENTAGE '+LTRIM(RTRIM(STR(@NEXCISEHEDUCESSPCTUPD,6,2)))+
					  ' IS NOT SAME AS THAT STORED IN FORM MASTER : '+LTRIM(RTRIM(STR(@NEXCISEHEDUCESSPCTFORM,6,2)))+' ....... PLEASE CHECK'
			RETURN
		END
		
		SELECT @NCALHEDUCESS = @NUPDEXCISEDUTY*@NEXCISEHEDUCESSPCTUPD/100 
		
		SELECT @NUPDHEDUCESS = EXCISE_HEDU_CESS_AMOUNT FROM INM01106 WHERE INV_ID=@CXNID
		
		IF ABS(@NUPDHEDUCESS-ISNULL(@NCALHEDUCESS,0))>.01
		BEGIN
			SET @CERRORMSG='MISMATCH BETWEEN CALCULATED HIGHER EDUCATION CESS AMOUNT ('+LTRIM(RTRIM(STR(ISNULL(@NCALHEDUCESS,0),10,2)))+
				  	  ') & UPDATED HIGHER EDUCATION CESS AMOUNT ('+LTRIM(RTRIM(STR(ISNULL(@NUPDHEDUCESS,0),10,2)))+')..... CANNOT SAVE '

			RETURN
		END
		
	END	



	DECLARE @NTAXFLAG NUMERIC(1,0)
	
	SELECT @NTAXFLAG=BILL_LEVEL_TAX_METHOD FROM PRD_INM01106 WHERE INV_ID=@CXNID
	
	IF EXISTS (SELECT TOP 1 INV_ID FROM PRD_INM01106 WHERE INV_ID=@CXNID AND SUBTOTAL<>0)
	BEGIN
		PRINT 'VALIDATE TAX OF INVOICE ID :'+@CXNID
		
		
	
		SELECT TOP 1 @CPRODUCTCODE=C.ARTICLE_NO,@CPARA1=D.PARA1_NAME,@CPARA2=E.PARA2_NAME,
		            @NUPDTAXVAL=A.ITEM_TAX_AMOUNT,
		           @NCALCTAXVAL=(((A.NET_RATE*A.QUANTITY)-(A.NET_RATE*A.QUANTITY*B.DISCOUNT_PERCENTAGE/100)+
			   (((B.EXCISE_DUTY_AMOUNT+B.EXCISE_EDU_CESS_AMOUNT+B.EXCISE_HEDU_CESS_AMOUNT+B.OCTROI_AMOUNT)/B.SUBTOTAL)*
			   (A.NET_RATE*A.QUANTITY)))*A.ITEM_TAX_PERCENTAGE/
				(CASE WHEN @NTAXFLAG=1 THEN 100 ELSE 100+A.ITEM_TAX_PERCENTAGE END))
		FROM PRD_IND01106 A 
		JOIN PRD_INM01106 B ON A.INV_ID=B.INV_ID
		JOIN PRD_SKU P ON A.PRODUCT_UID = P.PRODUCT_UID 
		JOIN ARTICLE C ON P.ARTICLE_CODE = C.ARTICLE_CODE
	    JOIN PARA1 D ON P.PARA1_CODE = D.PARA1_CODE 
	    JOIN PARA2 E ON P.PARA2_CODE = E.PARA2_CODE  
		WHERE A.INV_ID=@CXNID AND (ABS(CONVERT(NUMERIC(10,2),(((A.NET_RATE*A.QUANTITY)-(A.NET_RATE*A.QUANTITY*B.DISCOUNT_PERCENTAGE/100)+
			   (((B.EXCISE_DUTY_AMOUNT+B.EXCISE_EDU_CESS_AMOUNT+B.EXCISE_HEDU_CESS_AMOUNT+B.OCTROI_AMOUNT)/B.SUBTOTAL)*
			   (A.NET_RATE*A.QUANTITY)))*A.ITEM_TAX_PERCENTAGE/
				(CASE WHEN @NTAXFLAG=1 THEN 100 ELSE 100+A.ITEM_TAX_PERCENTAGE END))))-A.ITEM_TAX_AMOUNT)>.1
		

		IF ISNULL(@CPRODUCTCODE,'')<>''
		BEGIN
			SET @CERRORMSG='MISMATCH BETWEEN EXPECTED TAX AMOUNT ('+LTRIM(RTRIM(STR(@NCALCTAXVAL,10,2)))+') &
							EXISTING TAX AMOUNT ('+LTRIM(RTRIM(STR(@NUPDTAXVAL,10,2)))+') 
							FOR ARTICLE NO : '+@CPRODUCTCODE  +',COLOR : '+@CPARA1  +',SIZE : '+@CPARA2  +' ..... CANNOT SAVE '

			RETURN
		END
	
	END	
	
	SELECT @NTAXAMT=SUM(ITEM_TAX_AMOUNT) FROM PRD_IND01106 WHERE INV_ID=@CXNID
	
	SELECT @NCALCTOTALAMOUNT = SUBTOTAL +INSURANCE+FREIGHT-DISCOUNT_AMOUNT + OTHER_CHARGES+ROUND_OFF+
							   (CASE WHEN @NTAXFLAG=1 THEN ISNULL(@NTAXAMT,0) ELSE 0 END)+OCTROI_AMOUNT+EXCISE_DUTY_AMOUNT+EXCISE_EDU_CESS_AMOUNT+
							   EXCISE_HEDU_CESS_AMOUNT
	FROM PRD_INM01106 WHERE INV_ID=@CXNID	

	SELECT @NINMTOTALAMOUNT=NET_AMOUNT FROM PRD_INM01106 WHERE INV_ID=@CXNID
	
	IF ABS(ISNULL(@NINMTOTALAMOUNT,0)-ISNULL(@NCALCTOTALAMOUNT,0))>1
	BEGIN
		SET @CERRORMSG = ' MISMATCH BETWEEN CALCULATED NET AMOUNT '+LTRIM(RTRIM(STR(ISNULL(@NCALCTOTALAMOUNT,0),14,4)))+
					' & BILL LEVEL NET AMOUNT '+LTRIM(RTRIM(STR(ISNULL(@NINMTOTALAMOUNT,0),14,4))) -- +'..... CANNOT SAVE '
		RETURN
	END

	
	RETURN
END 
------- 'END OF CREATING PROCEDURE VALIDATEXN_WSL'
