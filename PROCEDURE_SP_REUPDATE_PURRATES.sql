CREATE PROCEDURE SP_REUPDATE_PURRATES--(LocId 3 digit change by Sanjay:01-11-2024)
@CMRRIDPARA VARCHAR(40)=''
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @NSTEP INT,@CERRORMSG VARCHAR(MAX),@CMRRID VARCHAR(40),@NTAX NUMERIC(14,2),
	@CCURLOCID VARCHAR(4),@CHOLOCID VARCHAR(4)
	
	SELECT TOP 1 @CCURLOCID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'LOCATION_ID'	       
				
    SELECT TOP 1 @CHOLOCID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'
    
	IF CURSOR_STATUS('GLOBAL','PURCUR') IN (0,1)
	BEGIN	
		CLOSE PURCUR
		DEALLOCATE PURCUR
	END
		
	BEGIN TRY
	
	SET @NSTEP=10
	
	DECLARE @TRETMSG TABLE  (ERRMSG VARCHAR(MAX))
	
	DECLARE @TPIDTABLE TABLE (ROW_ID VARCHAR(50),TAX_BASIS1 NUMERIC(10,2),TAX_BASIS2 NUMERIC(10,2),TAX_AMOUNT NUMERIC(10,2))

	BEGIN TRANSACTION	
		
	DECLARE PURCUR CURSOR FOR SELECT A.MRR_ID FROM PIM01106 A
	WHERE ((A.MRR_ID=@CMRRIDPARA AND @CMRRIDPARA<>'')
	OR (@CMRRIDPARA='' AND A.location_Code=@CCURLOCID))
	AND A.INV_MODE=1
	
	OPEN PURCUR
	
	FETCH NEXT FROM PURCUR INTO @CMRRID
	WHILE @@FETCH_STATUS=0
	BEGIN
		DELETE FROM @TPIDTABLE
		
		PRINT 'UPDATING RATES OF MRR ID  :'+@CMRRID
		
		SET @NSTEP=15
		PRINT STR(@NSTEP)
		UPDATE PID01106 SET DISCOUNT_PERCENTAGE=0,DISCOUNT_AMOUNT=0
		WHERE MRR_ID=@CMRRID AND INVOICE_QUANTITY=0
				
		SET @NSTEP=20
		PRINT STR(@NSTEP)
		UPDATE PID01106 SET TAX_PERCENTAGE=B.TAX_PERCENTAGE,DISCOUNT_AMOUNT=INVOICE_QUANTITY*GROSS_PURCHASE_PRICE*DISCOUNT_PERCENTAGE/100,
		PURCHASE_PRICE=GROSS_PURCHASE_PRICE-(GROSS_PURCHASE_PRICE*DISCOUNT_PERCENTAGE/100) 
		FROM FORM B 
		WHERE B.FORM_ID=PID01106.FORM_ID 
		AND PID01106.MRR_ID= @CMRRID

		SET @NSTEP = 30	
		PRINT STR(@NSTEP)	
		-- UPDATING TOTALS IN PIM TABLE
		UPDATE A SET SUBTOTAL = ISNULL( B.SUBTOTAL ,0 )
		FROM PIM01106 A LEFT OUTER JOIN
		( 	
			SELECT	MRR_ID, SUM(INVOICE_QUANTITY*PURCHASE_PRICE) AS SUBTOTAL
			FROM PID01106 
			WHERE MRR_ID = @CMRRID
			GROUP BY MRR_ID  
		) B ON  A.MRR_ID = B.MRR_ID  
		WHERE A.MRR_ID = @CMRRID

		SET @NSTEP = 40
		PRINT STR(@NSTEP)
		UPDATE PIM01106 SET DISCOUNT_AMOUNT = ROUND(SUBTOTAL*DISCOUNT_PERCENTAGE/100,2)
		WHERE MRR_ID= @CMRRID
							
		SET @NSTEP = 50		
		
		PRINT STR(@NSTEP)
		INSERT @TPIDTABLE (ROW_ID)	SELECT ROW_ID FROM PID01106 WHERE MRR_ID=@CMRRID
		 
		SET @NSTEP=60
		DECLARE	@NEXCISE_PER NUMERIC(14,3),@NTAXABLEPPVALUE NUMERIC(14,2)

		SELECT @NTAXABLEPPVALUE=SUM(PURCHASE_PRICE * INVOICE_QUANTITY) FROM PID01106 
		WHERE MRR_ID= @CMRRID AND TAX_PERCENTAGE>0

		SELECT	@NEXCISE_PER=(CASE WHEN ISNULL(EXCISE_DUTY_AMOUNT,0)=0 THEN 0 ELSE CONVERT(NUMERIC(14,3),
		((EXCISE_DUTY_AMOUNT/@NTAXABLEPPVALUE)*100)) END) FROM PIM01106 WHERE MRR_ID= @CMRRID
		
		SET @NEXCISE_PER=ISNULL(@NEXCISE_PER,0)
		
		SET @NSTEP=70
		
		PRINT STR(@NSTEP)
		UPDATE A SET TAX_BASIS1=((INVOICE_QUANTITY * PURCHASE_PRICE)-(INVOICE_QUANTITY *
		PURCHASE_PRICE*C.DISCOUNT_PERCENTAGE/100))
		FROM @TPIDTABLE A
		JOIN PID01106 B ON A.ROW_ID=B.ROW_ID
		JOIN PIM01106 C ON C.MRR_ID=B.MRR_ID 
		
		SET @NSTEP=80
		PRINT STR(@NSTEP)
		UPDATE @TPIDTABLE SET TAX_BASIS2=TAX_BASIS1+(TAX_BASIS1*@NEXCISE_PER/100)
		
		SET @NSTEP=90
		PRINT STR(@NSTEP)
		UPDATE A SET TAX_AMOUNT=TAX_BASIS2*(CASE WHEN BILL_LEVEL_TAX_METHOD=2 THEN (B.TAX_PERCENTAGE/
		(100 + B.TAX_PERCENTAGE)) ELSE (B.TAX_PERCENTAGE/100) END)
		FROM @TPIDTABLE A JOIN PID01106 B ON A.ROW_ID=B.ROW_ID
		JOIN PIM01106 C ON C.MRR_ID=B.MRR_ID
		
		SET @NSTEP=100
		
		PRINT STR(@NSTEP)
		UPDATE PID01106 SET TAX_AMOUNT=B.TAX_AMOUNT FROM @TPIDTABLE B 
		WHERE B.ROW_ID=PID01106.ROW_ID			
		
		
		IF NOT EXISTS (SELECT TOP 1 PRODUCT_CODE FROM PID01106 WHERE MRR_ID= @CMRRID)
		BEGIN
			SET @NSTEP = 105
			PRINT STR(@NSTEP)
			UPDATE PIM01106 SET OTHER_CHARGES=0,EXCISE_DUTY_AMOUNT=0,FREIGHT=0
			WHERE MRR_ID= @CMRRID
		END

		SET @NSTEP=110
		SELECT @NTAX=ROUND(SUM(TAX_AMOUNT),2) FROM PID01106 WHERE MRR_ID=@CMRRID

		SET @NSTEP = 120	
		PRINT STR(@NSTEP)	
		UPDATE PIM01106 SET ROUND_OFF=ROUND((SUBTOTAL + (CASE WHEN BILL_LEVEL_TAX_METHOD = 2 THEN 0 ELSE ISNULL(@NTAX,0) END) +  OTHER_CHARGES + 
					 EXCISE_DUTY_AMOUNT+FREIGHT ) - DISCOUNT_AMOUNT,0)-(SUBTOTAL+ (CASE WHEN BILL_LEVEL_TAX_METHOD = 2 THEN 0 ELSE ISNULL(@NTAX,0) END) +OTHER_CHARGES+
					 FREIGHT+EXCISE_DUTY_AMOUNT-DISCOUNT_AMOUNT)
		WHERE MRR_ID=@CMRRID


		SET @NSTEP=130
		PRINT STR(@NSTEP)
		UPDATE PIM01106 SET TAX_AMOUNT=CASE WHEN BILL_LEVEL_TAX_METHOD = 2 THEN 0 ELSE ISNULL(@NTAX,0) END,
		TOTAL_AMOUNT=(SUBTOTAL +CASE WHEN BILL_LEVEL_TAX_METHOD = 2 THEN 0 ELSE ISNULL(@NTAX,0) END +  OTHER_CHARGES + 
					 FREIGHT+EXCISE_DUTY_AMOUNT+ROUND_OFF) - DISCOUNT_AMOUNT
		WHERE MRR_ID=@CMRRID

		-- UPDATING VARIOUS MASTER PARAMETERS IN SKU AND SKU_OH
		-- UPDATING VARIOUS COSTING RELATED PARAMETERS IN SKU AND SKU_OH 

		SET @NSTEP=135
		PRINT STR(@NSTEP)
		
		
		EXEC SAVETRAN_PUR_UPDSKU
		@NsPiD=@CMRRID,
		@NMODE=1,
		@BCANCELBILL=0,
		@nUpdateMode=2,
		@CERRORMSG=@CERRORMSG OUTPUT  
		
		
		IF @CERRORMSG<>''	
			GOTO END_PROC
			
		FETCH NEXT FROM PURCUR INTO @CMRRID
	END
	
	GOTO END_PROC
	
	END TRY
	
	BEGIN CATCH
		SELECT @CERRORMSG='PROCEDURE SP_REUDATE_PURRATES : STEP: '+STR(@NSTEP)+' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
	END CATCH	
	

END_PROC:	
	INSERT @TRETMSG
	SELECT @CERRORMSG AS ERRMSG
			
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''	
			ROLLBACK		
		ELSE
			COMMIT TRANSACTION	
	END	
	
	SELECT * FROM @TRETMSG
END
