	

IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_SLS_GST_ROFF' AND VALUE=1)
BEGIN
	PRINT 'UPDATING GST ROUND OFF '
	
	UPDATE A SET XN_VALUE_WITHOUT_GST=(NET-CMM_DISCOUNT_AMOUNT-(CASE WHEN TAX_METHOD=1 THEN
	ISNULL(TAX_AMOUNT,0) ELSE 0 END)) FROM  CMD01106 A (NOLOCK)
	JOIN CMM01106 B (NOLOCK) ON A.CM_ID=B.CM_ID WHERE CM_DT>='2017-07-01' AND 
	(ISNULL(XN_VALUE_WITHOUT_GST,0)=0 OR (ISNULL(CGST_AMOUNT,0)+ISNULL(SGST_AMOUNT,0)+ISNULL(IGST_AMOUNT,0))=0)
	
	IF OBJECT_ID('TEMPDB..#TMPDIFF','U') IS NOT NULL 
		DROP TABLE #TMPDIFF
		
	SELECT CM_DT,A.CM_ID,NET_AMOUNT,ATD_CHARGES,ROUND_OFF,B.NET_AMOUNT_GST,
	(NET_AMOUNT-(ISNULL(OTHER_CHARGES_TAXABLE_VALUE,0)+ROUND_OFF+NET_AMOUNT_GST+ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)
	+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0))) AS GST_ROUND_OFF INTO #TMPDIFF FROM CMM01106 A
	JOIN (SELECT A.CM_ID,SUM(XN_VALUE_WITHOUT_GST+IGST_AMOUNT+CGST_AMOUNT+SGST_AMOUNT+
			TAX_AMOUNT
		   ) AS NET_AMOUNT_GST
			FROM CMD01106 A (NOLOCK) JOIN CMM01106 B (NOLOCK) ON A.CM_ID=B.CM_ID
			WHERE CM_DT>='2017-07-01' AND CANCELLED=0 

			GROUP BY A.CM_ID) B ON A.CM_ID=B.CM_ID
	WHERE ABS((NET_AMOUNT-(ISNULL(OTHER_CHARGES_TAXABLE_VALUE,0)+ROUND_OFF+NET_AMOUNT_GST+ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)
	+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)))) BETWEEN 0 AND 0.05

	UPDATE A SET GST_ROUND_OFF=B.GST_ROUND_OFF FROM CMM01106 A
	JOIN #TMPDIFF B ON A.CM_ID=B.CM_ID
	WHERE ISNULL(A.GST_ROUND_OFF,0)<>B.GST_ROUND_OFF


	IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE  CONFIG_OPTION='UPDATE_SLS_GST_ROFF')
		INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
			   VALUES ('UPDATE_SLS_GST_ROFF',1,'',GETDATE())	
	ELSE
		UPDATE CONFIG SET VALUE='1' WHERE CONFIG_OPTION='UPDATE_SLS_GST_ROFF'
	
END		
