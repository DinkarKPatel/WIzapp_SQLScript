CREATE PROCEDURE SP_GETBUYER_DISCOUNT  
@CORDER_ID NVARCHAR(50),  
@CPRODUCT_CODE NVARCHAR(100)  
AS  
BEGIN  
	--SELECT C.PRODUCT_CODE, B.OTHER_CHARGES, 
	--       ISNULL(ISNULL(A.DISCOUNT_PERCENTAGE,F.DISCOUNT_PERCENTAGE), B.DISCOUNT_PERCENTAGE) AS DISCOUNT_PERCENTAGE ,
	--      (CASE WHEN ISNULL(A.DISCOUNT_PERCENTAGE,F.DISCOUNT_PERCENTAGE)>0 THEN ISNULL(A.DISCOUNT_PERCENTAGE,F.DISCOUNT_PERCENTAGE) ELSE
 --       CONVERT(NUMERIC(14,3),(ISNULL(A.GROSS_WSP,F.GROSS_WSP)-((ISNULL(A.GROSS_WSP,F.GROSS_WSP) -((ISNULL(A.GROSS_WSP,F.GROSS_WSP) * ISNULL(A.DISCOUNT_PERCENTAGE,F.DISCOUNT_PERCENTAGE))/100) )-  
 --    (((ISNULL(A.GROSS_WSP,F.GROSS_WSP) -((ISNULL(A.GROSS_WSP,F.GROSS_WSP) * ISNULL(A.DISCOUNT_PERCENTAGE,F.DISCOUNT_PERCENTAGE))/100)) *B.DISCOUNT_PERCENTAGE)/100)))/ISNULL(A.GROSS_WSP,F.GROSS_WSP) *100) END) AS [GROSS_DISCOUNT_PERCENTAGE]
	--FROM SKU_BO C 
	--LEFT OUTER JOIN WSL_ORDER_DET A (NOLOCK)  ON A.PRODUCT_CODE=C.PRODUCT_CODE
	--LEFT OUTER JOIN PID01106 D (NOLOCK)  ON C.PRODUCT_CODE=D.PRODUCT_CODE
	--LEFT OUTER JOIN POD01106 E (NOLOCK)  ON E.ROW_ID=D.PO_ROW_ID
	--LEFT OUTER JOIN WSL_ORDER_DET F (NOLOCK)  ON F.ROW_ID= E.WOD_ROW_ID
	--JOIN WSL_ORDER_MST B (NOLOCK) ON B.ORDER_ID=C.ORDER_ID  
	--WHERE C.PRODUCT_CODE=@CPRODUCT_CODE AND B. ORDER_ID = @CORDER_ID
		
	SELECT TOP 1  A.PRODUCT_CODE
			, B.OTHER_CHARGES
			, B.DISCOUNT_PERCENTAGE AS DISCOUNT_PERCENTAGE 
			, A.DISCOUNT_PERCENTAGE  AS [GROSS_DISCOUNT_PERCENTAGE]
			--,0 AS DISCOUNT_PERCENTAGE 
			--,(CASE WHEN A.GROSS_WSP=0 THEN 0 ELSE CONVERT(NUMERIC(7,2),(((A.DISCOUNT_AMOUNT/A.QUANTITY)+((A.WS_PRICE*B.DISCOUNT_PERCENTAGE)/100))/GROSS_WSP)*100)
			--  END) AS [GROSS_DISCOUNT_PERCENTAGE]
	FROM WSL_ORDER_DET A (NOLOCK)  
	JOIN WSL_ORDER_MST B (NOLOCK) ON B.ORDER_ID=A.ORDER_ID  
	WHERE (A.PRODUCT_CODE=@CPRODUCT_CODE OR A.REF_PRODUCT_CODE=@CPRODUCT_CODE)  AND B.ORDER_ID= @CORDER_ID	
END
