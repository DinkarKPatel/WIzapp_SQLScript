create PROCEDURE SPsis_SYNCH_UPLOADDATA_cls_OPT
   @nSpId VARCHAR(50),
   @CDEPTID VARCHAR(5)/*Rohit 01-11-2024*/,
   @CERRMSG VARCHAR(MAX) OUTPUT

AS

BEGIN
	DECLARE @CSTEP VARCHAR(100),@Cdbname VARCHAR(40),@CFILTERCONDITION VARCHAR(300),@BAddmode bit
	PRINT 'START INSERT SIS_CLOSING_STOCK '+@nSpId
BEGIN TRY
	
	
	SET @CSTEP=10
LBLSTART:
    
    BEGIN TRANSACTION

    SELECT @Cdbname='',@BAddmode=1,@CERRMSG=''
    
    SELECT TOP 1 @Cdbname = dbname FROM MST_SIS_CLOSING_STOCK_UPLOAD  (NOLOCK)	WHERE sp_id=@nSpId
    
	
    IF ISNULL(@Cdbname,'')=''
		GOTO EXIT_PROC

		 Delete a from SIS_CLOSING_STOCK a (nolock) where DBNAME =@Cdbname
	    
		 INSERT SIS_CLOSING_STOCK	( CLOSING_DT, DBNAME, XN_QTY, XN_TYPE ) 
		 SELECT 	  CLOSING_DT, DBNAME, XN_QTY, XN_TYPE 
		 FROM MST_SIS_CLOSING_STOCK_UPLOAD WHERE sp_id=@nSpId


	
END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP3S_SYNCH_UPLOADDATA_cls_OPT, MEMO ID :'+@Cdbname+' STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO EXIT_PROC
END CATCH

EXIT_PROC:

	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')='' 
			commit
		ELSE
			ROLLBACK
    END
	
	DELETE FROM  MST_SIS_CLOSING_STOCK_UPLOAD WHERE SP_ID=@NSPID

	
END	
---END OF PROCEDURE - SP_SYNCH_UPLOADDATA_GRPPUR_OPT



