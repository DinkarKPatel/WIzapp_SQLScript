create PROCEDURE SP_GETTAXDETAILS --'2009-03-31','01-SU-PU-MY-0112','750','0100001'    
(    
 @MEMODT    DATETIME,    
 @PRODUCT_CODE  VARCHAR(50),    
 @NNETVAL   NUMERIC(14,2),    
 @STATECODE   VARCHAR(20),    
 @NMRPVAL   NUMERIC(14,2)=0,    
 @CUSERCODE   CHAR(7)='0000000',    
 @CXNTYPE   VARCHAR(10)='',    
 @NITEMDISCPCT  NUMERIC(6,2)=0,
 @NQUANTITY NUMERIC(10,3)=1,
 @cLocid varchar(4)=''
)    
--WITH ENCRYPTION
AS    
BEGIN   
 --(dinkar) Replace  left(memoid,2) to Location_code 
 DECLARE @FIRSTDT    DATETIME,    
   @SECONDDT    DATETIME,    
   @MEMOID     VARCHAR(40),    
   @SUB_SECTION_CODE  VARCHAR(40),    
   @CFROMDT    VARCHAR(10),    
   @CTODT     VARCHAR(10),    
   @BAPPLYEXCLTAX   BIT, @NEXCLTAXTODISC INT,   
   @CDENYEXCLTAX VARCHAR(10) ,
   @CLOCATIONID VARCHAR(10)   
    
 DECLARE @OUTPUTC TABLE ( TAX_PERCENTAGE NUMERIC(7,3), TAX_AC_CODE VARCHAR(20),TAX_AC_NAME VARCHAR(100),    
        SALE_AC_CODE VARCHAR(20),SALE_AC_NAME VARCHAR(100), TAX_METHOD INT,EXCISABLE BIT,    
        TAX_AMOUNT NUMERIC(10,2))    
    
 
		SET @CLOCATIONId=@cLocId
     
 SET @BAPPLYEXCLTAX = 0    
 
 SELECT TOP 1 @BAPPLYEXCLTAX=ISNULL(EXCLUSIVE_VAT,0),@NEXCLTAXTODISC=ISNULL(EXCLUSIVE_VAT_TO_DISC,0) 
 FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CLOCATIONID
 
 
 IF @BAPPLYEXCLTAX=1 AND ABS(@NMRPVAL-@NNETVAL)>1    
 BEGIN    
	  PRINT 'SLSTAX_51'    
	  IF @CXNTYPE='SLS' AND @BAPPLYEXCLTAX=1    
	  BEGIN    
		   IF @CUSERCODE<>'0000000'    
		   BEGIN    
				SELECT TOP 1 @CDENYEXCLTAX=VALUE FROM USER_ROLE_DET A
				JOIN USERS B ON A.ROLE_ID=B.ROLE_ID
				WHERE USER_CODE=@CUSERCODE AND FORM_OPTION='DONOT_CALC_EXCLTAX_DISCITEMS'    
			        
				IF ISNULL(@CDENYEXCLTAX,'')='1'    
				 SET @BAPPLYEXCLTAX=0    
		   END    
		       
		   IF ISNULL(@NEXCLTAXTODISC,0)>0
		   BEGIN    
				IF @NITEMDISCPCT<@NEXCLTAXTODISC
					SET @BAPPLYEXCLTAX=0    
		   END    
	  END    
 END    
 ELSE
	SET @BAPPLYEXCLTAX=0
 
        
 SELECT @SUB_SECTION_CODE = B.SUB_SECTION_CODE     
 FROM SKU A    
 JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE    
 WHERE A.PRODUCT_CODE = @PRODUCT_CODE    
     
 IF ISNULL(@SUB_SECTION_CODE,'') = ''    
  GOTO ENDPROC    
     
 SELECT TOP 1 @MEMOID = A.MEMO_ID     
 FROM LOCSST_MST A    
 JOIN LOCSST B ON B.MEMO_ID=A.MEMO_ID    
 WHERE A.FROM_DT<=@MEMODT AND B.SUB_SECTION_CODE=@SUB_SECTION_CODE AND A.STATE_CODE=@STATECODE    
 ORDER BY A.FROM_DT DESC    
    
 IF ISNULL(@MEMOID,'') = ''    
  GOTO ENDPROC    
    
 -- GETTING TAX INFO FROM LOCSSTADD, IF VARIANCE FOUND.    
 INSERT @OUTPUTC ( TAX_PERCENTAGE, TAX_AC_CODE, TAX_AC_NAME, SALE_AC_CODE,     
       SALE_AC_NAME, TAX_METHOD,EXCISABLE )    
 SELECT A.TAX_PERCENTAGE, A.TAX_AC_CODE, LM.AC_NAME AS TAX_AC_NAME,     
   A.SALE_AC_CODE, LM_SLS.AC_CODE AS SALE_AC_NAME,(CASE WHEN @BAPPLYEXCLTAX=1 THEN 2 ELSE B.TAX_METHOD END),    
   0 AS EXCISABLE    
 FROM LOCSSTADD A    
 JOIN LOCSST B ON B.ROW_ID=A.LOCSST_ROW_ID    
 JOIN LMV01106 LM ON LM.AC_CODE=A.TAX_AC_CODE    
 JOIN LMV01106 LM_SLS ON LM_SLS.AC_CODE=A.SALE_AC_CODE    
 WHERE B.MEMO_ID = @MEMOID     
 AND B.SUB_SECTION_CODE = @SUB_SECTION_CODE     
 AND (ABS(@NNETVAL/@NQUANTITY) BETWEEN MIN_MRP AND MAX_MRP)    
    
 IF(@@ROWCOUNT=0)    
 BEGIN    
  INSERT @OUTPUTC ( TAX_PERCENTAGE, TAX_AC_CODE, TAX_AC_NAME, SALE_AC_CODE,     
        SALE_AC_NAME, TAX_METHOD,EXCISABLE)    
  SELECT  A.TAX_PERCENTAGE, A.TAX_AC_CODE, LM.AC_NAME AS TAX_AC_NAME, A.SALE_AC_CODE,     
    LM_SLS.AC_CODE AS SALE_AC_NAME,(CASE WHEN @BAPPLYEXCLTAX=1 THEN 2 ELSE A.TAX_METHOD END),0 AS EXCISABLE    
  FROM LOCSST A    
  JOIN LOCSST_MST MST ON MST.MEMO_ID=A.MEMO_ID      
  JOIN SECTIOND B ON A.SUB_SECTION_CODE= B.SUB_SECTION_CODE    
  JOIN SECTIONM C ON B.SECTION_CODE= C.SECTION_CODE    
  JOIN STATE D ON MST.STATE_CODE = D.STATE_CODE      
  JOIN LMV01106 LM ON LM.AC_CODE=A.TAX_AC_CODE    
  JOIN LMV01106 LM_SLS ON LM_SLS.AC_CODE=A.SALE_AC_CODE    
  WHERE MST.MEMO_ID= @MEMOID AND B.SUB_SECTION_CODE=@SUB_SECTION_CODE    
  ORDER BY C.SECTION_NAME,B.SUB_SECTION_NAME    
 END    
     
ENDPROC:    
 
 UPDATE @OUTPUTC SET TAX_AMOUNT=ROUND((CASE WHEN @NNETVAL<0 THEN -1 ELSE 1 END)*
 (CASE WHEN TAX_METHOD=1 THEN ABS(@NNETVAL - ((@NNETVAL * 100) / (100+TAX_PERCENTAGE)))    
           ELSE ABS(@NNETVAL*TAX_PERCENTAGE/100) END),2)      
           
 SELECT * FROM @OUTPUTC    
END    
--********************************* END OF PROCEDURE SP_GETTAXDETAILS
