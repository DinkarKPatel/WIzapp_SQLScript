CREATE PROCEDURE SP_MERGE_MIRROR_MSTART
(
	@NMODE INT
)
----WITH ENCRYPTION
AS


SET NOCOUNT ON
BEGIN

DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
	   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
	   ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	   ,@CERRMSG VARCHAR(1000),@CTABLESSTR VARCHAR(MAX),@CMRRIDSEARCH VARCHAR(100),@CERRORUPDPMT VARCHAR(MAX)
	    ,@EDITPUR BIT,@CMERGEDB VARCHAR(50),@CSOURCEDB VARCHAR(50)
BEGIN TRY

	IF @NMODE=1
		GOTO EXIT_PROC
		
BEGIN TRANSACTION 

	
    SELECT @CMERGEDB='',@CSOURCEDB=''
    
    SET @CSTEP=10
    DELETE FROM ART_ATTR
     DELETE FROM ART_PARA1
      DELETE FROM ART_DET
    
    SET @CSTEP=20
	SET @CTABLENAME='PARA1'
	SET @CTMP_TABLENAME='MSTART_PARA1_UPLOAD'
	SET @CKEYFIELD='PARA1_CODE'

	SET @CSTEP=25
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA1_NAME',@CCOLKEYNAME=@CKEYFIELD
      

	SET @CSTEP=30

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1
							  
    SET @CSTEP=40
	SET @CTABLENAME='PARA2'
	SET @CTMP_TABLENAME='MSTART_PARA2_UPLOAD'
	SET @CKEYFIELD='PARA2_CODE'

		SET @CSTEP=45
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA2_NAME',@CCOLKEYNAME=@CKEYFIELD


	SET @CSTEP=50
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1
							  
	SET @CSTEP=60
	SET @CTABLENAME='PARA3'
	SET @CTMP_TABLENAME='MSTART_PARA3_UPLOAD'
	SET @CKEYFIELD='PARA3_CODE'

		SET @CSTEP=65
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA3_NAME',@CCOLKEYNAME=@CKEYFIELD  


	SET @CSTEP=70
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1
							  
	 SET @CSTEP=80
	SET @CTABLENAME='PARA4'
	SET @CTMP_TABLENAME='MSTART_PARA4_UPLOAD'
	SET @CKEYFIELD='PARA4_CODE'

		SET @CSTEP=75
	
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA4_NAME',@CCOLKEYNAME=@CKEYFIELD

	SET @CSTEP=90
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1
							  
	SET @CSTEP=100
	SET @CTABLENAME='PARA5'
	SET @CTMP_TABLENAME='MSTART_PARA5_UPLOAD'
	SET @CKEYFIELD='PARA5_CODE'

		SET @CSTEP=105
	 
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA5_NAME',@CCOLKEYNAME=@CKEYFIELD


	SET @CSTEP=110
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1
							  
    SET @CSTEP=120
	SET @CTABLENAME='PARA6'
	SET @CTMP_TABLENAME='MSTART_PARA6_UPLOAD'
	SET @CKEYFIELD='PARA6_CODE'

	SET @CSTEP=125
	
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='PARA6_NAME',@CCOLKEYNAME=@CKEYFIELD


	SET @CSTEP=130
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1
							  				  
    
    
    SET @CSTEP=140
	SET @CTABLENAME='SECTIONM'
	SET @CTMP_TABLENAME='MSTART_SECTIONM_UPLOAD'
	SET @CKEYFIELD='SECTION_CODE'

	SET @CSTEP=145
	 
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='SECTION_NAME',@CCOLKEYNAME=@CKEYFIELD


	SET @CSTEP=150
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
							  
							  
	SET @CSTEP=160
	SET @CTABLENAME='SECTIOND'
	SET @CTMP_TABLENAME='MSTART_SECTIOND_UPLOAD'
	SET @CKEYFIELD='SUB_SECTION_CODE'

	SET @CSTEP=165
	
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='SUB_SECTION_NAME',@CCOLKEYNAME=@CKEYFIELD

	SET @CSTEP=170
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
    SET @CSTEP=180
	SET @CTABLENAME='UOM'
	SET @CTMP_TABLENAME='MSTART_UOM_UPLOAD'
	SET @CKEYFIELD='UOM_CODE'
	SET @CSTEP=190
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 							  							  

	
	SET @CSTEP=200
	SET @CTABLENAME='ARTICLE'
	SET @CTMP_TABLENAME='MSTART_ARTICLE_UPLOAD'
	SET @CKEYFIELD='ARTICLE_CODE'

	SET @CSTEP=205
	 
    EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='ARTICLE_NO',@CCOLKEYNAME=@CKEYFIELD


	SET @CSTEP=210
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
    UPDATE  MSTART_SKU_UPLOAD SET FORM_ID='0000000' WHERE FORM_ID NOT IN (SELECT FORM_ID FROM FORM)
     UPDATE MSTART_SKU_UPLOAD SET AC_CODE='0000000000' WHERE AC_CODE NOT IN (SELECT AC_CODE FROM LM01106)
							  
    SET @CSTEP=220
	SET @CTABLENAME='SKU'
	SET @CTMP_TABLENAME='MSTART_SKU_UPLOAD'
	SET @CKEYFIELD='PRODUCT_CODE'
	SET @CSTEP=230
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 							  
    SET @CSTEP=240
	SET @CTABLENAME='ATTRM'
	SET @CTMP_TABLENAME='MSTART_ATTRM_UPLOAD'
	SET @CKEYFIELD='ATTRIBUTE_CODE'
	SET @CSTEP=250
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 

	SET @CSTEP=260
	SET @CTABLENAME='ATTR_KEY'
	SET @CTMP_TABLENAME='MSTART_ATTR_KEY_UPLOAD'
	SET @CKEYFIELD='KEY_CODE'
	SET @CSTEP=270
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	
	
	
	SET @CSTEP=280
	SET @CTABLENAME='ART_ATTR'
	SET @CTMP_TABLENAME='MSTART_ART_ATTR_UPLOAD'
	SET @CKEYFIELD='KEY_CODE'
	SET @CSTEP=290
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
    SET @CSTEP=300
	SET @CTABLENAME='ART_PARA1'
	SET @CTMP_TABLENAME='MSTART_ART_PARA1_UPLOAD'
	SET @CKEYFIELD='ARTICLE_CODE'
	SET @CSTEP=310
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
    SET @CSTEP=320
	SET @CTABLENAME='ART_DET'
	SET @CTMP_TABLENAME='MSTART_ART_DET_UPLOAD'
	SET @CKEYFIELD='ARTICLE_CODE'
	SET @CSTEP=330
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 							  							  
    
	
END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP_MERGE_MIRROR_MSTART, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
END CATCH

EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
	END
	ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK

   IF ISNULL(@CERRMSG,'')=''
   BEGIN
   		
   DELETE FROM MSTART_ARTICLE_UPLOAD 
   DELETE FROM MSTART_ART_ATTR_UPLOAD 
   DELETE FROM MSTART_ATTR_KEY_UPLOAD 
   DELETE FROM MSTART_ATTRM_UPLOAD 
   DELETE FROM MSTART_SECTIOND_UPLOAD
   DELETE FROM MSTART_SECTIONM_UPLOAD 
   DELETE FROM MSTART_UOM_UPLOAD 
   DELETE FROM MSTART_SKU_UPLOAD 
   DELETE FROM MSTART_PARA1_UPLOAD 
   DELETE FROM MSTART_PARA2_UPLOAD 
   DELETE FROM MSTART_PARA3_UPLOAD 
   DELETE FROM MSTART_PARA4_UPLOAD 
   DELETE FROM MSTART_PARA5_UPLOAD 
   DELETE FROM MSTART_PARA6_UPLOAD 
   DELETE FROM MSTART_ART_PARA1_UPLOAD 
   DELETE FROM MSTART_ART_DET_UPLOAD 

   END	
   
   SELECT 'MSTART' AS MEMO_ID,ISNULL(@CERRMSG,'') AS ERRMSG   	  		
   
END	
---END OF PROCEDURE - SP_MERGE_MIRROR_MSTART
