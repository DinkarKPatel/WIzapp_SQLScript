CREATE PROCEDURE  SP_RPSMST_QBF   
@CWHERE					VARCHAR(50),
@CTARGETTABLENAME		VARCHAR(MAX),
@BFROMSLS				BIT


AS
BEGIN
	DECLARE @CCMD	NVARCHAR(MAX)
	    
	SET @CCMD=N'IF OBJECT_ID('''+@CTARGETTABLENAME+N''',''U'') IS NOT NULL DROP TABLE '+@CTARGETTABLENAME+N' 
		SELECT MST.CM_ID AS CM_ID,MST.CM_NO AS MST_CM_NO,MST.CANCELLED AS MST_CANCELLED,MST.CM_DT AS MST_CM_DT,    
	  MST.FIN_YEAR AS MST_FIN_YEAR, MST.SUBTOTAL AS MST_SUBTOTAL, MST.NET_AMOUNT AS MST_NET_AMOUNT , MST.REMARKS AS MST_REMARKS,
	  E.USERNAME AS MST_USERNAME, B.QUANTITY AS QUANTITY, B.DISCOUNT_PERCENTAGE ,B.DISCOUNT_AMOUNT , EMP1.EMP_NAME AS MST_EMP_NAME, EMP2.EMP_NAME AS EMP_NAME2, EMP2.EMP_NAME AS EMP_NAME3,    
	  EMP1.EMP_NAME AS EMP_NAME, EMP1.EMP_ALIAS,''T''+(CASE WHEN B.TAX_PERCENTAGE=0 THEN ''F'' WHEN ROUND(B.TAX_PERCENTAGE,0)=B.TAX_PERCENTAGE THEN LTRIM(RTRIM(STR(B.TAX_PERCENTAGE)))
	  ELSE LTRIM(RTRIM(STR(B.TAX_PERCENTAGE,6,2))) END) AS TAX_STATUS, B.TAX_PERCENTAGE , B.TAX_AMOUNT ,B.NET,B.MRP,MST.CM_TIME AS MST_CM_TIME,
	 LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE ))) AS PRODUCT_CODE, 
	 A.ARTICLE_CODE, ARTICLE_NO, ARTICLE_NAME, 
	 C.PARA1_NAME, D.PARA2_NAME,  F.PARA3_NAME, UOM_NAME,SM.SECTION_NAME, SD.SUB_SECTION_NAME,    
	 PARA4_NAME,PARA5_NAME,PARA6_NAME,ISNULL(UOM_TYPE,0) AS [UOM_TYPE],B.TAX_METHOD,CUST.USER_CUSTOMER_CODE,
     CUST.CUSTOMER_FNAME,CUST.CUSTOMER_LNAME,CUST.ADDRESS0,CUST.ADDRESS1,CUST.ADDRESS2
	   INTO '+  @CTARGETTABLENAME + '
	 FROM RPS_MST MST    
	 JOIN RPS_DET B ON B.CM_ID=MST.CM_ID    
	 JOIN SKU A ON A.PRODUCT_CODE=B.PRODUCT_CODE
	 JOIN ARTICLE ART ON ART.ARTICLE_CODE = A.ARTICLE_CODE      
	 JOIN SECTIOND SD ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	 JOIN SECTIONM SM ON SD.SECTION_CODE = SM.SECTION_CODE    
	 JOIN PARA1 C ON A.PARA1_CODE = C.PARA1_CODE      
	 JOIN PARA2 D ON A.PARA2_CODE = D.PARA2_CODE      
	 JOIN PARA3 F ON A.PARA3_CODE = F.PARA3_CODE      
	 JOIN PARA4 G ON A.PARA4_CODE = G.PARA4_CODE      
	 JOIN PARA5 H ON A.PARA5_CODE = H.PARA5_CODE      
	 JOIN PARA6 I ON A.PARA6_CODE = I.PARA6_CODE      
	 JOIN UOM  ON ART.UOM_CODE = UOM.UOM_CODE  
	JOIN USERS E ON E.USER_CODE = MST.USER_CODE 
	LEFT OUTER JOIN  CUSTDYM CUST ON CUST.CUSTOMER_CODE=MST.CUSTOMER_CODE
	JOIN EMPLOYEE EMP1 ON EMP1.EMP_CODE= B.EMP_CODE
	JOIN EMPLOYEE EMP2 ON EMP2.EMP_CODE= B.EMP_CODE1  
	JOIN EMPLOYEE EMP3 ON EMP3.EMP_CODE= B.EMP_CODE2'+
	(CASE WHEN @BFROMSLS=1 THEN '  WHERE MST.REF_CM_ID='''+@CWHERE+'''' ELSE ' WHERE MST.CM_ID='''+@CWHERE+'''' END)
	PRINT @CCMD

	EXEC SP_EXECUTESQL @CCMD
END
