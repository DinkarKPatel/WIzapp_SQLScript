CREATE PROCEDURE SP_STOCKREPORT_TRADING          --(LocId 3 digit change by Sanjay:30-10-2024)
(          
  @CPRODUCTCODE VARCHAR(100),          
  @CDEPTID VARCHAR(4) = '',      
  @FROMDATE DATETIME = '',      
  @TODATE DATETIME = '',      
  @IMODE INT =1      
)          
AS          
BEGIN          
          
 DECLARE @CCURLOCID VARCHAR(4),          
   @CHOLOCID VARCHAR(4) ,@CCMD NVARCHAR(MAX)         
          
 SELECT TOP 1 @CCURLOCID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'LOCATION_ID'          
 SELECT TOP 1 @CHOLOCID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'          
          
 DECLARE @OUTPUTC TABLE ( DEPT_ID VARCHAR(4), XN_TYPE VARCHAR(30), XN_DT DATETIME,           
        XN_ID VARCHAR(40), XN_NO VARCHAR(40), PRODUCT_CODE VARCHAR(50),       
        ARTICLE_NO VARCHAR(100), PARA3_NAME VARCHAR(500),              
        XN_PARTY_NAME VARCHAR(100), XN_QTY NUMERIC(10,3),XN_EMP_NAME VARCHAR(100), XN_MODE NUMERIC(1,0 ),      
        WS_PRICE NUMERIC(18,2),XN_PRICE NUMERIC(18,2),MP_PERCENTAGE NUMERIC(10,2),BIN_ID VARCHAR(10),BIN_NAME VARCHAR(100))          


IF LTRIM(RTRIM(ISNULL(@CPRODUCTCODE,'')))=''
	SET @CPRODUCTCODE=NULL

 IF @FROMDATE = '' OR  @TODATE = ''
       GOTO ENDPROC

PRINT 'STEP 1'          
           
 --PRODUCTION -        
SET @CCMD=N' SELECT B.DEPT_ID,              
   ''PRD'' AS XN_TYPE,          
   B.MEMO_DT AS XN_DT,          
   B.MEMO_ID AS XN_ID,          
   B.MEMO_NO  AS XN_NO,          
   A.PRODUCT_CODE,         
   ARTICLE.ARTICLE_NO,       
   PARA3.PARA3_NAME ,      
   L.DEPT_NAME AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,          
   ''PRODUCTION'' AS XN_EMP_NAME ,          
   -1 AS XN_MODE ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
   CONVERT(NUMERIC(10,2) ,SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0)) AS XN_PRICE ,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE      
 ,'''' AS BIN_ID,'''' AS BIN_NAME                   
 FROM PRD_STK_TRANSFER_DTM_DET A (NOLOCK)          
 JOIN PRD_STK_TRANSFER_DTM_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
 JOIN LOCATION L (NOLOCK) ON B.DEPT_ID  = L.DEPT_ID      
 JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE       
 JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE       
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE  
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE          
 WHERE B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0'+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +  
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
  WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
  ELSE 'A.PRODUCT_CODE' END)  END)       
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
  
PRINT 'STEP 2'                 
 -- DCO        
SET @CCMD=N'SELECT b.location_code,              
    ''DCO'' AS XN_TYPE,          
    B.MEMO_DT AS XN_DT,          
    B.MEMO_ID AS XN_ID,          
    B.MEMO_NO  AS XN_NO,          
    A.PRODUCT_CODE,       
    ARTICLE.ARTICLE_NO,       
    PARA3.PARA3_NAME ,         
    L.DEPT_NAME AS XN_PARTY_NAME,               A.QUANTITY AS XN_QTY,          
    '''' AS XN_EMP_NAME ,          
    -1 AS XN_MODE ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
    CONVERT(NUMERIC(10,2) ,SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0)) AS XN_PRICE ,      
    CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE     
    ,B1.BIN_ID,B1.BIN_NAME               
  FROM FLOOR_ST_DET A (NOLOCK)          
  JOIN FLOOR_ST_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
  JOIN LOCATION L (NOLOCK) ON A.SOURCE_BIN_ID  = L.DEPT_ID          
  JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE       
  JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE       
  JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
  JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=B.BIN_ID       
  LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE     
  WHERE B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0'+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE 'AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)   
       
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
 PRINT 'STEP 3'               
----DCI         
SET @CCMD =N'SELECT b.location_code,              
   ''DCI'' AS XN_TYPE,          
   B.MEMO_DT AS XN_DT,          
   B.MEMO_ID AS XN_ID,          
   B.MEMO_NO  AS XN_NO,          
   A.PRODUCT_CODE,       
   ARTICLE.ARTICLE_NO,       
   PARA3.PARA3_NAME ,           
   L.DEPT_NAME AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,          
   '''' AS XN_EMP_NAME ,          
   -1 AS XN_MODE ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
   CONVERT(NUMERIC(10,2) ,SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0)) AS XN_PRICE ,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE     
   ,B1.BIN_ID,B1.BIN_NAME                  
 FROM FLOOR_ST_DET A (NOLOCK)          
 JOIN FLOOR_ST_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
 JOIN LOCATION L (NOLOCK) ON B.TARGET_BIN_ID = L.DEPT_ID          
 JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE       
 JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE       
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=B.TARGET_BIN_ID    
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE        
 WHERE B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0'+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE 'AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
              
 PRINT 'STEP 4'                
 -- PURCHASE INVOICE          
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT B.DEPT_ID,          
   (CASE WHEN INV_MODE=1 THEN ''PUR'' ELSE ''CHI'' END)AS XN_TYPE,           
   B.RECEIPT_DT AS XN_DT,          
   B.MRR_ID AS XN_ID,           
   B.MRR_NO AS XN_NO,           
   A.PRODUCT_CODE,      
   F.ARTICLE_NO,      
   PARA3.PARA3_NAME,           
   LM.AC_NAME AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,          
   '''' AS XN_EMP_NAME ,          
   1 AS XN_MODE   ,        
   CONVERT(NUMERIC(10,2),ISNULL(A.WHOLESALE_PRICE,0)) AS WS_PRICE,        
   SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE         
   ,A.MP_PERCENTAGE      
   ,B1.BIN_ID,B1.BIN_NAME      
 FROM PID01106 A (NOLOCK)          
 JOIN PIM01106 B (NOLOCK) ON A.MRR_ID = B.MRR_ID          
 JOIN SKU   (NOLOCK) ON SKU.PRODUCT_CODE= A.PRODUCT_CODE
 JOIN ARTICLE  F (NOLOCK) ON A.ARTICLE_CODE = F.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON A.PARA3_CODE=PARA3.PARA3_CODE           
 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=B.AC_CODE          
 JOIN (SELECT TOP 1 VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION=''HO_LOCATION_ID'') CNF1 ON 1=1        
 JOIN (SELECT TOP 1 VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION=''LOCATION_ID'') CNF2 ON 1=1      
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=B.BIN_ID 
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE            
 WHERE B.CANCELLED = 0 AND F.STOCK_NA=0  AND B.RECEIPT_DT<>''''        
  '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'F.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END) END)+  
 ' AND (b.location_code='''+@CCURLOCID+''' OR '''+@CHOLOCID+'''<>'''+@CCURLOCID+''')'        
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
  
  PRINT 'STEP 5'               
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT B.PARTY_DEPT_ID AS DEPT_ID,        
  ''CHI'' AS XN_TYPE,         
  C.RECEIPT_DT AS XN_DT,        
  C.MRR_ID AS XN_ID,        
  RIGHT(C.MRR_ID,10) AS XN_NO,         
  A.PRODUCT_CODE,        
  ARTICLE.ARTICLE_NO,      
  PARA3.PARA3_NAME,        
  LM.AC_NAME AS XN_PARTY_NAME,         
  A.QUANTITY AS XN_QTY,        
  '''' AS XN_EMP_NAME,        
  1 AS XN_MODE,        
  CONVERT(NUMERIC(10,2),ISNULL(SKU.WS_PRICE,0)) AS WS_PRICE,        
  SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,        
  CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE       
  ,B1.BIN_ID,B1.BIN_NAME      
 FROM IND01106 A (NOLOCK)        
 JOIN INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID        
 JOIN PIM01106 C (NOLOCK) ON C.INV_ID = B.INV_ID        
 JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID        
 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=D.DEPT_AC_CODE        
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE        
 JOIN (SELECT TOP 1 VALUE FROM CONFIG(NOLOCK) WHERE CONFIG_OPTION=''HO_LOCATION_ID'') CNF ON 1=1        
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=B.TARGET_BIN_ID 
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE        
 WHERE B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0 AND c.location_code<>CNF.VALUE  AND C.RECEIPT_DT<>''''        
 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END) END)  
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD      
   
  PRINT 'STEP 6'                
        
-- PURCHASE RETURN          
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT b.location_code AS DEPT_ID,          
   (CASE WHEN MODE=2 THEN ''CHO'' ELSE ''PRT'' END) AS XN_TYPE,           
   B.RM_DT AS XN_DT,          
   B.RM_ID AS XN_ID,          
   B.RM_NO AS XN_NO,          
   A.PRODUCT_CODE,       
   ARTICLE.ARTICLE_NO,     PARA3.PARA3_NAME,          
   LM.AC_NAME AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,          
   '''' AS XN_EMP_NAME ,          
   -1 AS XN_MODE  ,        
   CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,         
   SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,        
   CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE        
   ,B1.BIN_ID,B1.BIN_NAME    
 FROM RMD01106 A (NOLOCK)          
 JOIN RMM01106 B (NOLOCK) ON A.RM_ID = B.RM_ID          
 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=B.AC_CODE      
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE      
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=B.BIN_ID          
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE     
 WHERE B.CANCELLED = 0  AND B.DN_TYPE =1 AND ARTICLE.STOCK_NA=0       
 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
   
 PRINT 'STEP 7'                  
        
-- RETAIL SALE         
 --INSERT @OUTPUTC          
SET @CCMD=N'SELECT b.location_code AS DEPT_ID,          
    (CASE WHEN A.QUANTITY > 0 THEN ''SLS'' ELSE ''SLR'' END) AS XN_TYPE,           
     B.CM_DT AS XN_DT,          
     B.CM_ID AS XN_ID,           
    B.CM_NO AS XN_NO,          
     A.PRODUCT_CODE,      
    ARTICLE.ARTICLE_NO,      
    PARA3.PARA3_NAME,          
     LTRIM(RTRIM(ISNULL(C.CUSTOMER_TITLE,'''')+'' ''+ISNULL(C.CUSTOMER_FNAME,'''')+'' ''+ISNULL(C.CUSTOMER_LNAME,''''))) AS XN_PARTY_NAME,           
     ABS(A.QUANTITY) AS XN_QTY,          
     E.EMP_NAME AS XN_EMP_NAME ,          
    ( CASE WHEN A.QUANTITY > 0 THEN -1 ELSE 1 END) AS XN_MODE,        
     CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
  SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,A.DISCOUNT_PERCENTAGE AS MP_PERCENTAGE     
  ,B1.BIN_ID,B1.BIN_NAME              
 FROM CMD01106 A (NOLOCK)          
 JOIN CMM01106 B (NOLOCK) ON A.CM_ID = B.CM_ID          
 JOIN CUSTDYM C (NOLOCK) ON C.CUSTOMER_CODE=B.CUSTOMER_CODE          
 JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE=A.EMP_CODE      
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=A.BIN_ID
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE                       
 WHERE B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
  
PRINT 'STEP 7.1'   
SET @CCMD = N'SELECT b.location_code AS DEPT_ID,          
    (CASE WHEN A.QUANTITY > 0 THEN ''SLS'' ELSE ''SLR'' END) AS XN_TYPE,           
     B.CM_DT AS XN_DT,          
     B.CM_ID AS XN_ID,           
     B.CM_NO AS XN_NO,          
     A.PRODUCT_CODE,      
    ARTICLE.ARTICLE_NO,      
    PARA3.PARA3_NAME,          
    ''''  AS XN_PARTY_NAME,  
     ABS(A.QUANTITY) AS XN_QTY,          
     E.EMP_NAME AS XN_EMP_NAME ,          
    ( CASE WHEN A.QUANTITY > 0 THEN -1 ELSE 1 END) AS XN_MODE,        
     CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
  SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,A.DISCOUNT_PERCENTAGE AS MP_PERCENTAGE     
  ,B1.BIN_ID,B1.BIN_NAME              
 FROM RPS_DET A (NOLOCK)          
 JOIN RPS_MST B (NOLOCK) ON A.CM_ID = B.CM_ID           
 JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE=A.EMP_CODE      
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=A.BIN_ID   
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE                         
 WHERE B.CANCELLED = 0 
 AND ISNULL(B.REF_CM_ID,'''')='''' AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)
 PRINT @CCMD  
 INSERT @OUTPUTC    
 EXEC SP_EXECUTESQL @CCMD   
      
PRINT 'STEP 8'                     
         
 -- APPROVAL ISSUE        
 --INSERT @OUTPUTC          
SET @CCMD=N'SELECT b.location_code AS DEPT_ID,          
   ''APP'' AS XN_TYPE,           
   B.MEMO_DT AS XN_DT,          
   B.MEMO_ID AS XN_ID,           
   B.MEMO_NO AS XN_NO,          
   A.PRODUCT_CODE,       
    ARTICLE.ARTICLE_NO,      
    PARA3.PARA3_NAME,          
   (CASE WHEN B.MEMO_TYPE=1 THEN LTRIM(RTRIM(ISNULL(C.CUSTOMER_TITLE,'''')+'' ''+ISNULL(C.CUSTOMER_FNAME,'''')+'' ''+        
   ISNULL(C.CUSTOMER_LNAME,''''))) ELSE D.AC_NAME END) AS XN_PARTY_NAME,           
   ABS(A.QUANTITY) AS XN_QTY,          
   E.EMP_NAME AS XN_EMP_NAME ,          
   -1 AS XN_MODE   ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
   SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE                  
   ,B1.BIN_ID,B1.BIN_NAME     
 FROM APD01106 A (NOLOCK)          
 JOIN APM01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID          
 JOIN CUSTDYM C (NOLOCK) ON C.CUSTOMER_CODE=B.CUSTOMER_CODE          
 JOIN LM01106 D (NOLOCK) ON D.AC_CODE=B.AC_CODE         
 JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE=A.EMP_CODE       
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE        
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=A.BIN_ID  
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE                  
 WHERE B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END) END)  
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD   
            
  PRINT 'STEP 9'               
-- APPROVAL RETURN          
 --INSERT @OUTPUTC        
SET @CCMD=N'SELECT mst.location_code AS DEPT_ID,        
   ''APR'' AS XN_TYPE,        
   MST.MEMO_DT AS XN_DT,        
   MST.MEMO_ID AS XN_ID,         
   MST.MEMO_NO AS XN_NO,        
   B.PRODUCT_CODE,       
    ARTICLE.ARTICLE_NO,      
    PARA3.PARA3_NAME,       
   (CASE WHEN MST.MODE=1 THEN LTRIM(RTRIM(ISNULL(D.CUSTOMER_TITLE,'''')+'' ''+ISNULL(D.CUSTOMER_FNAME,'''')+'' ''+      
   ISNULL(D.CUSTOMER_LNAME,''''))) ELSE E.AC_NAME END) AS XN_PARTY_NAME,         
   ABS(A.QUANTITY) AS XN_QTY,        
   F.EMP_NAME AS XN_EMP_NAME,        
   1 AS XN_MODE ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,      
   SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE                  
   ,B1.BIN_ID,B1.BIN_NAME     
 FROM APPROVAL_RETURN_DET A (NOLOCK)        
 JOIN APPROVAL_RETURN_MST MST (NOLOCK)ON  MST.MEMO_ID = A.MEMO_ID      
 JOIN APD01106 B (NOLOCK)ON A.APD_ROW_ID = B.ROW_ID        
 JOIN CUSTDYM D (NOLOCK) ON D.CUSTOMER_CODE=MST.CUSTOMER_CODE        
 JOIN LM01106 E (NOLOCK) ON E.AC_CODE=MST.AC_CODE        
 JOIN EMPLOYEE F (NOLOCK) ON F.EMP_CODE=B.EMP_CODE       
 JOIN SKU (NOLOCK) ON B.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE     
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=A.BIN_ID 
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE                         
 WHERE MST.CANCELLED = 0  AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND        
 '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'B.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD   
            
 PRINT 'STEP 10'              
       
-- CANCELLATION AND STOCK ADJUSTMENT          
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT b.location_code AS DEPT_ID,          
   (CASE WHEN B.CNC_TYPE=1 THEN ''CNC'' ELSE ''UNC'' END) AS XN_TYPE,           
   B.CNC_MEMO_DT AS XN_DT,          
   B.CNC_MEMO_ID AS XN_ID,          
   B.CNC_MEMO_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,           
   '''' AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,          
   '''' AS XN_EMP_NAME ,          
   (CASE WHEN B.CNC_TYPE =1 THEN -1 ELSE 1 END) AS XN_MODE   ,        
   CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
   SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,        
   CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE     
   ,B1.BIN_ID,B1.BIN_NAME                 
 FROM ICD01106 A (NOLOCK)          
 JOIN ICM01106 B (NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID       
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=A.BIN_ID   
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE                      
WHERE B.CANCELLED = 0 AND B.STOCK_ADJ_NOTE = 0 AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
    
 PRINT 'STEP 11'                
 --WHOLESALE INVOICE          
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT B.DEPT_ID,          
   (CASE WHEN B.INV_MODE=1 THEN ''WSL'' ELSE ''CHO'' END) AS XN_TYPE,          
   B.INV_DT AS XN_DT,          
   B.INV_ID AS XN_ID,          
   B.INV_NO AS XN_NO,          
   A.PRODUCT_CODE,       
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,            
   C.AC_NAME AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,          
   E.EMP_NAME AS XN_EMP_NAME ,          
   -1 AS XN_MODE ,        
   CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE ,        
   SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,        
   CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE     
   ,B1.BIN_ID,B1.BIN_NAME                               
 FROM IND01106 A (NOLOCK)          
 JOIN INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID          
 JOIN LMV01106 C (NOLOCK) ON B.AC_CODE = C.AC_CODE          
 LEFT OUTER JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE = B.EMP_CODE       
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=A.BIN_ID 
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE                            
 WHERE B.CANCELLED = 0 AND B.ENTRY_MODE IN (0,1) AND ARTICLE.STOCK_NA=0      
 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END) END)  
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD       
  
PRINT 'STEP 12'                 
 --WHOLESALE PACKSLIP          
 --INSERT @OUTPUTC          
SET @CCMD=N'SELECT A.DEPT_ID,          
   (CASE WHEN B.PS_MODE=1 THEN ''WSL'' ELSE ''CHO'' END) AS XN_TYPE,          
    B.PS_DT AS XN_DT,            
   B.PS_ID AS XN_ID,            
   B.PS_NO AS XN_NO,            
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,              
   C.AC_NAME AS XN_PARTY_NAME,             
   A.QUANTITY AS XN_QTY,            
   '''' AS XN_EMP_NAME ,            
   -1 AS XN_MODE ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,          
   SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE     
   ,B1.BIN_ID,B1.BIN_NAME                                      
 FROM WPS_DET A (NOLOCK)            
 JOIN WPS_MST B (NOLOCK) ON A.PS_ID = B.PS_ID          
 JOIN LM01106 C (NOLOCK) ON B.AC_CODE = C.AC_CODE      
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=A.BIN_ID         
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE             
 WHERE B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
  
PRINT 'STEP 12.1'  
--DEBIT NOTE PACKSLIP          
        
SET @CCMD=N'SELECT A.DEPT_ID,          
   (CASE WHEN B.PS_MODE IN (''0'',''1'') THEN ''PRT'' ELSE ''CHO'' END) AS XN_TYPE,          
   B.PS_DT AS XN_DT,            
   B.PS_ID AS XN_ID,            
   B.PS_NO AS XN_NO,            
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,              
   C.AC_NAME AS XN_PARTY_NAME,             
   A.QUANTITY AS XN_QTY,            
   '''' AS XN_EMP_NAME ,            
   -1 AS XN_MODE ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,          
   CONVERT(NUMERIC(10,2) ,SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0)) AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE     
   ,B1.BIN_ID,B1.BIN_NAME                                      
 FROM DNPS_DET A (NOLOCK)            
 JOIN DNPS_MST B (NOLOCK) ON A.PS_ID = B.PS_ID          
 JOIN LM01106 C (NOLOCK) ON B.AC_CODE = C.AC_CODE      
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=A.BIN_ID            
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE          
 WHERE B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END) END)  
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
           
 PRINT 'STEP 13'                
 --WHOLESALE CREDIT NOTE          
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT b.location_code AS DEPT_ID,          
  (CASE WHEN MODE=2 THEN ''CHI'' ELSE ''WSR'' END) AS XN_TYPE,          
  (CASE WHEN MODE=2 THEN B.RECEIPT_DT ELSE B.CN_DT END) AS XN_DT,          
   B.CN_ID AS XN_ID,          
   B.CN_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,             
   C.AC_NAME AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,          
   '''' AS XN_EMP_NAME ,          
   1 AS XN_MODE   ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
   SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE    
   ,B1.BIN_ID,B1.BIN_NAME                                   
 FROM CND01106 A (NOLOCK)          
 JOIN CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID          
 JOIN LM01106 C (NOLOCK) ON B.AC_CODE = C.AC_CODE       
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=A.BIN_ID             
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE          
 WHERE B.CANCELLED = 0 AND (B.MODE<>2 OR B.RECEIPT_DT<>'''') AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END) END)+  
' AND (b.location_code='''+@CCURLOCID+''' OR '''+@CHOLOCID+'''<>'''+@CCURLOCID+''')'       
   
 PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
          
       
  PRINT 'STEP 14'               
 -- RATE REVISION - PFI          
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT c.location_code AS DEPT_ID,          
   ''PFI'' AS XN_TYPE,           
   C.IRM_MEMO_DT AS XN_DT,           
   C.IRM_MEMO_ID AS XN_ID,           
   C.IRM_MEMO_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,           
   '''' AS XN_PARTY_NAME,           
   B.QUANTITY AS XN_QTY,'''' AS XN_EMP_NAME,        
   1 AS XN_MODE        ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
   SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE    
   ,B1.BIN_ID,B1.BIN_NAME                         
 FROM SKU A (NOLOCK)          
 JOIN ARTICLE E (NOLOCK) ON E.ARTICLE_CODE = A.ARTICLE_CODE          
 JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE = B.NEW_PRODUCT_CODE          
 JOIN IRM01106 C (NOLOCK) ON B.IRM_MEMO_ID = C.IRM_MEMO_ID       
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=B.BIN_ID            
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE          
 WHERE B.NEW_PRODUCT_CODE <> '''' AND ARTICLE.STOCK_NA=0          
 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
           
  PRINT 'STEP 15'               
 -- SPLIT/COMBINE - PFI          
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT b.location_code AS DEPT_ID,          
   ''PFI'' AS XN_TYPE,           
   B.MEMO_DT AS XN_DT,           
   B.MEMO_ID AS XN_ID,           
   B.MEMO_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,          
   '''' AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,'''' AS XN_EMP_NAME,        
   1 AS XN_MODE          
    ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
    SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE    
    ,'''' AS BIN_ID,'''' AS BIN_NAME            
 FROM SCF01106 A  (NOLOCK)         
 JOIN SCM01106 B (NOLOCK) ON B.MEMO_ID = A.MEMO_ID      
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE             
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE          
 WHERE B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
         
  PRINT 'STEP 16'               
 -- RATE REVISION - CIP          
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT c.location_code AS DEPT_ID,           
   ''CIP'' AS XN_TYPE,           
   C.IRM_MEMO_DT AS XN_DT,           
   C.IRM_MEMO_ID AS XN_ID,           
   C.IRM_MEMO_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,             
   '''' AS XN_PARTY_NAME,           
   B.QUANTITY AS XN_QTY,'''' AS XN_EMP_NAME,        
   -1 AS XN_MODE  ,CONVERT(NUMERIC(10,2) ,ISNULL(A.WS_PRICE,0)) AS WS_PRICE ,        
   SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE     
   ,B1.BIN_ID,B1.BIN_NAME                       
 FROM SKU A  (NOLOCK)         
 JOIN ARTICLE E (NOLOCK) ON E.ARTICLE_CODE = A.ARTICLE_CODE          
 JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE = B.PRODUCT_CODE       
 JOIN IRM01106 C (NOLOCK) ON B.IRM_MEMO_ID = C.IRM_MEMO_ID      
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE      
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=B.BIN_ID          
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE          
 WHERE B.NEW_PRODUCT_CODE<>'''' AND ARTICLE.STOCK_NA=0         
 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
   (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
            
  PRINT 'STEP 17'               
 -- SPLIT/COMBINE - CIP        
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT A.DEPT_ID,          
   ''CIP'' AS XN_TYPE,           
   B.MEMO_DT AS XN_DT,           
   B.MEMO_ID AS XN_ID,           
   B.MEMO_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,          
   '''' AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,'''' AS XN_EMP_NAME,        
   1 AS XN_MODE          
    ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
   CONVERT(NUMERIC(10,2) ,SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0))  AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE    
   ,'''' AS BIN_ID,'''' BIN_NAME    
 FROM SCC01106 A (NOLOCK)          
 JOIN SCM01106 B (NOLOCK) ON B.MEMO_ID = A.MEMO_ID      
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE           
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE          
 WHERE B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END) END)  
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
      
PRINT 'STEP 18'               
--JWI         
--INSERT @OUTPUTC           
SET @CCMD=N'SELECT A.DEPT_ID,              
   ''JWI'' AS XN_TYPE,          
   B.ISSUE_DT AS XN_DT,          
   B.ISSUE_ID AS XN_ID,          
   B.ISSUE_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,           
   C.AC_NAME AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,          
   '''' AS XN_EMP_NAME ,          
   -1 AS XN_MODE ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
  SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE ,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE       
  ,'''' AS BIN_ID,'''' AS BIN_NAME           
 FROM JOBWORK_ISSUE_DET A (NOLOCK)          
 JOIN JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID        
 LEFT OUTER JOIN PRD_AGENCY_MST AGC (NOLOCK) ON B.AGENCY_CODE = AGC.AGENCY_CODE        
 LEFT OUTER JOIN LMV01106 C (NOLOCK) ON AGC.AC_CODE = C.AC_CODE       
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE           
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE           
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE          
 WHERE B.WIP=0 AND B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
	   WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
       ELSE 'A.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
      
PRINT 'STEP 19'              
 --JWR        
--INSERT @OUTPUTC           
SET @CCMD=N'SELECT B.DEPT_ID,              
   ''JWR'' AS XN_TYPE,          
   B.RECEIPT_DT AS XN_DT,          
   B.RECEIPT_ID AS XN_ID,         
   B.RECEIPT_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   PARA3.PARA3_NAME,          
   C.AC_NAME AS XN_PARTY_NAME,           
   A.QUANTITY AS XN_QTY,          
   '''' AS XN_EMP_NAME ,          
   1 AS XN_MODE ,CONVERT(NUMERIC(10,2) ,0) AS WS_PRICE,        
  SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE ,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE     
  ,'''' AS BIN_ID,'''' AS BIN_NAME                  
 FROM JOBWORK_RECEIPT_DET A (NOLOCK)          
 JOIN JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID        
 LEFT OUTER JOIN PRD_AGENCY_MST AGC (NOLOCK) ON B.AGENCY_CODE = AGC.AGENCY_CODE        
 LEFT OUTER JOIN LMV01106 C (NOLOCK) ON AGC.AC_CODE = C.AC_CODE          
 JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE           
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE  
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE                   
 WHERE B.WIP=0 AND B.CANCELLED = 0 AND ARTICLE.STOCK_NA=0'+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END)   END)
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD    
  
PRINT 'STEP 20'           
       
 --BOC      
 --INSERT @OUTPUTC         
SET @CCMD=N'SELECT D.DEPT_ID,              
''BOC'' AS XN_TYPE,          
D.ORDER_DT AS XN_DT,          
D.ORDER_ID AS XN_ID,         
D.ORDER_NO AS XN_NO,          
E.PRODUCT_CODE,      
 ARTICLE.ARTICLE_NO,      
 PARA3.PARA3_NAME,          
LM.AC_NAME AS XN_PARTY_NAME,           
(E.CONS_QTY_PER_PICE*P.QUANTITY) AS XN_QTY,          
'''' AS XN_EMP_NAME ,          
-1 AS XN_MODE         
,SKU.WS_PRICE AS WS_PRICE        
,SKU.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE         
,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE                   
,'''' AS BIN_ID,'''' AS BIN_NAME    
FROM WSL_ORDER_BOM E(NOLOCK)         
LEFT OUTER JOIN WSL_ORDER_DET C (NOLOCK) ON E.REF_ROW_ID=C.ROW_ID        
LEFT OUTER JOIN WSL_ORDER_MST D (NOLOCK) ON C.ORDER_ID=D.ORDER_ID        
JOIN POD01106 P ON C.ROW_ID = P.WOD_ROW_ID         
JOIN POM01106 PM ON P.PO_ID = PM.PO_ID          
LEFT OUTER JOIN SKU ON E.PRODUCT_CODE=SKU.PRODUCT_CODE        
LEFT OUTER JOIN LMV01106 LM (NOLOCK) ON D.AC_CODE = LM.AC_CODE        
JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE  
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON SKU.PRODUCT_CODE=OH.PRODUCT_CODE                   
 WHERE  PM.CANCELLED=0  AND ARTICLE.STOCK_NA=0 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE '     
 AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'ARTICLE.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'E.PRODUCT_CODE' END)  END) 
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
  
PRINT 'STEP 21'               
 -- RATE REVISION - CIP          
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT c.location_code AS DEPT_ID,           
   ''SCF'' AS XN_TYPE,           
   C.RECEIPT_DT AS XN_DT,           
   C.MEMO_ID AS XN_ID,           
   C.MEMO_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   E.ARTICLE_NO,      
   PARA3.PARA3_NAME,             
   LM.AC_NAME AS XN_PARTY_NAME,           
   (CASE WHEN E.CODING_SCHEME=3 THEN B2.TOTAL_QTY ELSE B.QUANTITY END) AS XN_QTY,'''' AS XN_EMP_NAME,        
   1 AS XN_MODE  ,CONVERT(NUMERIC(10,2) ,ISNULL(A.WS_PRICE,0)) AS WS_PRICE ,        
   A.PURCHASE_PRICE-ISNULL(OH.DISCOUNT_AMOUNT,0) AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE     
   ,B1.BIN_ID,B1.BIN_NAME                       
 FROM SKU A  (NOLOCK)         
 JOIN ARTICLE E (NOLOCK) ON E.ARTICLE_CODE = A.ARTICLE_CODE   
 JOIN PARA3 (NOLOCK) ON A.PARA3_CODE=PARA3.PARA3_CODE      
 JOIN  
 (  
 SELECT REFROW_ID AS [ROW_ID],PRODUCT_CODE,COUNT(*) AS [TOTAL_QTY]  
 FROM SNC_BARCODE_DET (NOLOCK)  
 GROUP BY REFROW_ID,PRODUCT_CODE  
 )B2 ON A.PRODUCT_CODE = B2.PRODUCT_CODE  
 JOIN SNC_DET B (NOLOCK) ON B.ROW_ID = B2.ROW_ID       
 JOIN SNC_MST C (NOLOCK) ON B.MEMO_ID = C.MEMO_ID     
 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=C.AC_CODE     
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=C.BIN_ID 
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON A.PRODUCT_CODE=OH.PRODUCT_CODE                   
 WHERE C.CANCELLED=0 AND C.WIP=0 AND B2.PRODUCT_CODE<>'''' AND E.STOCK_NA=0         
 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'E.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END) END)   
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
            
  PRINT 'STEP 22'               
 -- SPLIT/COMBINE - CIP        
 --INSERT @OUTPUTC          
 SET @CCMD=N'SELECT c.location_code AS DEPT_ID,           
   ''SCC'' AS XN_TYPE,           
   C.RECEIPT_DT AS XN_DT,           
   C.MEMO_ID AS XN_ID,           
   C.MEMO_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   E.ARTICLE_NO,      
   PARA3.PARA3_NAME,             
   LM.AC_NAME AS XN_PARTY_NAME,           
   B.QUANTITY AS XN_QTY,'''' AS XN_EMP_NAME,        
   -1 AS XN_MODE  ,CONVERT(NUMERIC(10,2) ,ISNULL(A.WS_PRICE,0)) AS WS_PRICE ,        
   B.PURCHASE_PRICE AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE     
   ,B1.BIN_ID,B1.BIN_NAME                       
 FROM SKU A  (NOLOCK)         
 JOIN ARTICLE E (NOLOCK) ON E.ARTICLE_CODE = A.ARTICLE_CODE   
 JOIN PARA3 (NOLOCK) ON A.PARA3_CODE=PARA3.PARA3_CODE      
 JOIN SNC_CONSUMABLE_DET B (NOLOCK) ON B.PRODUCT_CODE = A.PRODUCT_CODE       
 JOIN SNC_MST C (NOLOCK) ON B.MEMO_ID = C.MEMO_ID      
 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=C.AC_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=C.BIN_ID      
 LEFT OUTER JOIN SKU_OH OH (NOLOCK) ON A.PRODUCT_CODE=OH.PRODUCT_CODE              
 WHERE C.CANCELLED=0 AND B.WIP=0 AND B.PRODUCT_CODE<>'''' AND E.STOCK_NA=0         
 '+(CASE WHEN ISNULL(@CPRODUCTCODE,'')='' THEN '' ELSE ' AND '''+@CPRODUCTCODE +'''=' +   
 (CASE WHEN @IMODE=2 THEN 'E.ARTICLE_NO'  
    WHEN @IMODE=3 THEN 'PARA3.PARA3_NAME'  
    ELSE 'A.PRODUCT_CODE' END) END)  
  
PRINT @CCMD  
INSERT @OUTPUTC    
EXEC SP_EXECUTESQL @CCMD  
  
DELETE FROM @OUTPUTC WHERE ISNULL(XN_QTY,0) =0          
       
PRINT 'STEP 25'           

ENDPROC:
        
IF (@IMODE=1)
SELECT A.PRODUCT_CODE,D.ARTICLE_NO,D.ARTICLE_NAME
	,CONVERT(NUMERIC(18,2)
	,(H.PURCHASE_PRICE  
	 +(CASE WHEN FRM.POST_TAX_SEPARATELY=1 THEN 0 ELSE ISNULL(K.TAX_AMOUNT,0) END)  
     - ISNULL(K.DISCOUNT_AMOUNT,0)   
     + ISNULL(K.VALUE_ADD,0)     
     + ISNULL(K.EXCISE_DUTY_AMOUNT,0))) AS [PURCHASE_PRICE]
	,CONVERT(NUMERIC(14,3),SUM(CASE WHEN A.XN_DT<=@FROMDATE   THEN A.XN_MODE * A.XN_QTY ELSE 0 END)) [OPS]
	,CONVERT(NUMERIC(14,3),SUM(A.XN_MODE * A.XN_QTY )) AS [CBS]
	,CONVERT(NUMERIC(14,2),SUM(CASE WHEN A.XN_DT<=@FROMDATE THEN (A.XN_MODE * A.XN_QTY) 
		*ISNULL((H.PURCHASE_PRICE  
	 +(CASE WHEN FRM.POST_TAX_SEPARATELY=1  THEN 0 ELSE ISNULL(K.TAX_AMOUNT,0) END)  
     - ISNULL(K.DISCOUNT_AMOUNT,0)   
     + ISNULL(K.VALUE_ADD,0)     
     + ISNULL(K.EXCISE_DUTY_AMOUNT,0)),0) ELSE 0 END)) AS [OPS_VALUE]
	,CONVERT(NUMERIC(14,2),SUM((A.XN_MODE * A.XN_QTY)*ISNULL((H.PURCHASE_PRICE  
	 +(CASE WHEN FRM.POST_TAX_SEPARATELY=1  THEN 0 ELSE ISNULL(K.TAX_AMOUNT,0) END)  
     - ISNULL(K.DISCOUNT_AMOUNT,0)   
     + ISNULL(K.VALUE_ADD,0)     
     + ISNULL(K.EXCISE_DUTY_AMOUNT,0)),0))) AS [CBS_VALUE]
	FROM @OUTPUTC A     
    LEFT OUTER JOIN SKU H  (NOLOCK) ON A.PRODUCT_CODE = H.PRODUCT_CODE           
	LEFT OUTER JOIN ARTICLE D (NOLOCK) ON H.ARTICLE_CODE = D.ARTICLE_CODE          
	LEFT OUTER JOIN LOCATION G (NOLOCK) ON A.DEPT_ID = G.DEPT_ID           
    LEFT OUTER JOIN PARA3 J  (NOLOCK) ON H.PARA3_CODE = J.PARA3_CODE          
	LEFT OUTER JOIN SKU_OH K  (NOLOCK) ON H.PRODUCT_CODE = K.PRODUCT_CODE           
	LEFT OUTER JOIN LM01106 L (NOLOCK) ON H.AC_CODE = L.AC_CODE  
	LEFT JOIN FORM FRM (NOLOCK) ON H.FORM_ID=FRM.FORM_ID
	WHERE A.DEPT_ID IN       
 (SELECT DEPT_ID FROM LOCATION       
  WHERE (DEPT_ID=(CASE WHEN @CDEPTID ='' THEN DEPT_ID ELSE @CDEPTID END)       
  OR MAJOR_DEPT_ID=(CASE WHEN @CDEPTID ='' THEN MAJOR_DEPT_ID ELSE @CDEPTID END) ))      
 AND LTRIM(RTRIM(ISNULL(A.PRODUCT_CODE,'')))<> ''       
 AND (XN_DT  <= @TODATE )  
 GROUP BY  A.PRODUCT_CODE,D.ARTICLE_NO,D.ARTICLE_NAME 
 ,CONVERT(NUMERIC(18,2)
	,(H.PURCHASE_PRICE  
	 +(CASE WHEN FRM.POST_TAX_SEPARATELY=1  THEN 0 ELSE ISNULL(K.TAX_AMOUNT,0) END)  
     - ISNULL(K.DISCOUNT_AMOUNT,0)   
     + ISNULL(K.VALUE_ADD,0)     
     + ISNULL(K.EXCISE_DUTY_AMOUNT,0)))
 HAVING CONVERT(NUMERIC(14,3),SUM(CASE WHEN A.XN_DT<=@FROMDATE THEN A.XN_MODE * A.XN_QTY ELSE 0 END)) <>0 
 OR CONVERT(NUMERIC(14,3),SUM(A.XN_MODE * A.XN_QTY)) <>0
 ORDER BY A.PRODUCT_CODE
	
  SELECT A.PRODUCT_CODE
		,G.DEPT_NAME,L.AC_NAME,L.ALIAS,          
  SUM(A.XN_MODE * A.XN_QTY) AS XN_QTY,'OPS' AS XN_TYPE
  ,'OPS' AS XN_NO,@FROMDATE AS XN_DT, 0 AS XN_DP
  ,0 AS XN_DA, 0 AS XN_NET, A.DEPT_ID,''AS XN_PARTY_NAME,'' AS XN_EMP_NAME 
  ,0 AS MRP,      
  1 AS XN_MODE ,0 AS WS_PRICE,0 AS XN_PRICE,0 AS MP_PERCENTAGE,      
  CONVERT(NUMERIC(6,2),0) AS DISCOUNT_PERCENTAGE,A.BIN_ID,A.BIN_NAME,L.ALIAS AS [LM_ALIAS],D.ARTICLE_NO,D.ARTICLE_NAME 
 FROM @OUTPUTC A           
 LEFT OUTER JOIN SKU H  (NOLOCK) ON A.PRODUCT_CODE = H.PRODUCT_CODE           
 LEFT OUTER JOIN ARTICLE D (NOLOCK) ON H.ARTICLE_CODE = D.ARTICLE_CODE          
 LEFT OUTER JOIN LOCATION G (NOLOCK) ON A.DEPT_ID = G.DEPT_ID           
 LEFT OUTER JOIN PARA3 J  (NOLOCK) ON H.PARA3_CODE = J.PARA3_CODE          
 --LEFT OUTER JOIN SKU K  (NOLOCK) ON H.PRODUCT_CODE = K.PRODUCT_CODE           
 LEFT OUTER JOIN LM01106 L (NOLOCK) ON H.AC_CODE = L.AC_CODE 
 -- A.XN_TYPE NOT LIKE '%WIP%' AND        
 WHERE A.DEPT_ID IN       
 (SELECT DEPT_ID FROM LOCATION       
  WHERE (DEPT_ID=(CASE WHEN @CDEPTID ='' THEN DEPT_ID ELSE @CDEPTID END)       
  OR MAJOR_DEPT_ID=(CASE WHEN @CDEPTID ='' THEN MAJOR_DEPT_ID ELSE @CDEPTID END) ))      
 AND LTRIM(RTRIM(ISNULL(A.PRODUCT_CODE,'')))<> ''       
 AND (XN_DT <= @FROMDATE)      
 GROUP BY 
 A.PRODUCT_CODE,G.DEPT_NAME, L.AC_NAME, L.ALIAS,A.DEPT_ID
 ,A.BIN_ID,A.BIN_NAME,L.ALIAS,D.ARTICLE_NO,D.ARTICLE_NAME 
 
 UNION ALL
 
 SELECT A.PRODUCT_CODE,           
  G.DEPT_NAME, L.AC_NAME, L.ALIAS,          
  SUM(A.XN_QTY) AS XN_QTY, A.XN_TYPE, A.XN_NO, A.XN_DT, 0 AS XN_DP,          
  0 AS XN_DA, 0 AS XN_NET, A.DEPT_ID, A.XN_PARTY_NAME, A.XN_EMP_NAME ,          
  H.MRP,      
  A.XN_MODE ,A.WS_PRICE,ISNULL(A.XN_PRICE,0) AS XN_PRICE,A.MP_PERCENTAGE,      
  (CASE WHEN A.XN_TYPE IN ('SLS','SLR') THEN A.MP_PERCENTAGE ELSE CONVERT(NUMERIC(6,2),0) END) AS DISCOUNT_PERCENTAGE          
  ,A.BIN_ID,A.BIN_NAME,L.ALIAS AS [LM_ALIAS]  ,D.ARTICLE_NO,D.ARTICLE_NAME 
 FROM @OUTPUTC A           
 LEFT OUTER JOIN SKU H  (NOLOCK) ON A.PRODUCT_CODE = H.PRODUCT_CODE           
 LEFT OUTER JOIN ARTICLE D (NOLOCK) ON H.ARTICLE_CODE = D.ARTICLE_CODE          
 LEFT OUTER JOIN LOCATION G (NOLOCK) ON A.DEPT_ID = G.DEPT_ID           
 LEFT OUTER JOIN PARA3 J  (NOLOCK) ON H.PARA3_CODE = J.PARA3_CODE          
 --LEFT OUTER JOIN SKU K  (NOLOCK) ON H.PRODUCT_CODE = K.PRODUCT_CODE           
 LEFT OUTER JOIN LM01106 L (NOLOCK) ON H.AC_CODE = L.AC_CODE 
 -- A.XN_TYPE NOT LIKE '%WIP%' AND        
 WHERE A.DEPT_ID IN       
 (SELECT DEPT_ID FROM LOCATION       
  WHERE (DEPT_ID=(CASE WHEN @CDEPTID ='' THEN DEPT_ID ELSE @CDEPTID END)       
  OR MAJOR_DEPT_ID=(CASE WHEN @CDEPTID ='' THEN MAJOR_DEPT_ID ELSE @CDEPTID END) ))      
 AND LTRIM(RTRIM(ISNULL(A.PRODUCT_CODE,'')))<> ''       
 AND (XN_DT>@FROMDATE AND XN_DT <= @TODATE)      
 GROUP BY  A.PRODUCT_CODE,  G.DEPT_NAME,A.XN_TYPE,A.XN_NO,A.XN_DT,          
   A.DEPT_ID,A.XN_PARTY_NAME,L.AC_NAME,L.ALIAS,       
   H.MRP, A.XN_EMP_NAME,A.XN_MODE      
   ,A.WS_PRICE  ,A.XN_PRICE,A.MP_PERCENTAGE ,A.BIN_ID,    A.BIN_NAME  ,D.ARTICLE_NO,D.ARTICLE_NAME   
 ORDER BY XN_DT         
       
 PRINT 'STEP 22'             
       
 IF (@IMODE=2)      
       
 SELECT D.ARTICLE_NO,          
  G.DEPT_NAME, L.AC_NAME, L.ALIAS,          
  SUM(A.XN_QTY) AS XN_QTY, A.XN_TYPE, A.XN_NO, A.XN_DT, 0 AS XN_DP,          
  0 AS XN_DA, 0 AS XN_NET, A.DEPT_ID, A.XN_PARTY_NAME, A.XN_EMP_NAME ,          
  H.MRP,      
  A.XN_MODE ,A.WS_PRICE,A.XN_PRICE,A.MP_PERCENTAGE,      
  (CASE WHEN A.XN_TYPE IN ('SLS','SLR') THEN A.MP_PERCENTAGE ELSE CONVERT(NUMERIC(6,2),0) END) AS DISCOUNT_PERCENTAGE          
  ,A.BIN_ID,A.BIN_NAME,L.ALIAS AS [LM_ALIAS]     
 FROM @OUTPUTC A           
 LEFT OUTER JOIN SKU H  (NOLOCK) ON A.PRODUCT_CODE = H.PRODUCT_CODE           
 LEFT OUTER JOIN ARTICLE D (NOLOCK) ON H.ARTICLE_CODE = D.ARTICLE_CODE         
 LEFT OUTER JOIN LOCATION G (NOLOCK) ON A.DEPT_ID = G.DEPT_ID          
 LEFT OUTER JOIN PARA3 J  (NOLOCK) ON H.PARA3_CODE = J.PARA3_CODE          
        
 --LEFT OUTER JOIN SKU K  (NOLOCK) ON H.PRODUCT_CODE = K.PRODUCT_CODE           
 LEFT OUTER JOIN LM01106 L (NOLOCK) ON H.AC_CODE = L.AC_CODE        
 WHERE A.DEPT_ID IN       
 (SELECT DEPT_ID FROM LOCATION       
  WHERE (DEPT_ID=(CASE WHEN @CDEPTID ='' THEN DEPT_ID ELSE @CDEPTID END)       
  OR MAJOR_DEPT_ID=(CASE WHEN @CDEPTID ='' THEN MAJOR_DEPT_ID ELSE @CDEPTID END) ))      
 AND LTRIM(RTRIM(ISNULL(A.PRODUCT_CODE,'')))<> ''       
 AND (XN_DT  BETWEEN @FROMDATE AND @TODATE )      
 GROUP BY  D.ARTICLE_NO,  G.DEPT_NAME,A.XN_TYPE,A.XN_NO,A.XN_DT,          
   A.DEPT_ID,A.XN_PARTY_NAME,L.AC_NAME,L.ALIAS,           
   H.MRP, A.XN_EMP_NAME,A.XN_MODE      
   ,A.WS_PRICE  ,A.XN_PRICE,A.MP_PERCENTAGE,A.BIN_ID,A.BIN_NAME         
 ORDER BY XN_DT          
       
       
 PRINT 'STEP 23'              
 IF (@IMODE=3)      
 SELECT J.PARA3_NAME,          
  G.DEPT_NAME, L.AC_NAME, L.ALIAS,          
  SUM(A.XN_QTY) AS XN_QTY, A.XN_TYPE, A.XN_NO, A.XN_DT, 0 AS XN_DP,          
  0 AS XN_DA, 0 AS XN_NET, A.DEPT_ID, A.XN_PARTY_NAME, A.XN_EMP_NAME ,          
  H.MRP,      
  A.XN_MODE ,A.WS_PRICE,A.XN_PRICE,A.MP_PERCENTAGE,      
  (CASE WHEN A.XN_TYPE IN ('SLS','SLR') THEN A.MP_PERCENTAGE ELSE CONVERT(NUMERIC(6,2),0) END) AS DISCOUNT_PERCENTAGE          
  ,A.BIN_ID,A.BIN_NAME ,L.ALIAS AS [LM_ALIAS]    
 FROM @OUTPUTC A           
 LEFT OUTER JOIN SKU H  (NOLOCK) ON A.PRODUCT_CODE = H.PRODUCT_CODE           
 LEFT OUTER JOIN ARTICLE D (NOLOCK) ON H.ARTICLE_CODE = D.ARTICLE_CODE      
 LEFT OUTER JOIN LOCATION G (NOLOCK) ON A.DEPT_ID = G.DEPT_ID          
 LEFT OUTER JOIN PARA3 J  (NOLOCK) ON H.PARA3_CODE = J.PARA3_CODE       
 --LEFT OUTER JOIN SKU K  (NOLOCK) ON H.PRODUCT_CODE = K.PRODUCT_CODE           
 LEFT OUTER JOIN LM01106 L (NOLOCK) ON H.AC_CODE = L.AC_CODE        
 WHERE A.DEPT_ID IN       
 (SELECT DEPT_ID FROM LOCATION       
  WHERE (DEPT_ID=(CASE WHEN @CDEPTID ='' THEN DEPT_ID ELSE @CDEPTID END)       
  OR MAJOR_DEPT_ID=(CASE WHEN @CDEPTID ='' THEN MAJOR_DEPT_ID ELSE @CDEPTID END) ))      
 AND LTRIM(RTRIM(ISNULL(A.PRODUCT_CODE,'')))<> ''       
 AND (XN_DT  BETWEEN @FROMDATE AND @TODATE)      
 GROUP BY  J.PARA3_NAME,  G.DEPT_NAME,A.XN_TYPE,A.XN_NO,A.XN_DT,          
   A.DEPT_ID,A.XN_PARTY_NAME,L.AC_NAME,L.ALIAS ,         
   H.MRP,A.XN_EMP_NAME,A.XN_MODE      
   ,A.WS_PRICE  ,A.XN_PRICE,A.MP_PERCENTAGE,A.BIN_ID,A.BIN_NAME         
 ORDER BY XN_DT         
         
END        
--********************************************** END OF PROCEDURE SP_STOCKREPORT_TRADING
