CREATE PROCEDURE SP_PRD_TRANSACTIONHISTORY  
( @CWHERE VARCHAR(20)='')
----WITH ENCRYPTION
  
AS  
BEGIN  
DECLARE @CWORKORDER VARCHAR(40)  
SELECT @CWORKORDER= REF_WO_ID FROM PRD_STK_TRANSFER_DTM_MST A -----PRODUCT_CODE,  
JOIN PRD_STK_TRANSFER_DTM_DET B ON A.MEMO_ID=B.MEMO_ID  
  WHERE B.PRODUCT_CODE=@CWHERE AND A.CANCELLED=0  
PRINT @CWORKORDER    
    

    
SELECT T.WORK_ORDER_NO,T.WORK_ORDER_ID,T.DEPARTMENT,T.XN_TYPE,T.XN_DT,T.XN_NO,T.XN_PARTY_CODE,T.ARTICLE_NO,SUM(T.XN_QTY) AS XN_QTY  
,PARA1.PARA1_NAME,PARA2.PARA2_NAME,LM.AC_NAME  
 FROM    
(    
 SELECT W.MEMO_NO AS WORK_ORDER_NO,G.REF_WO_ID AS WORK_ORDER_ID,D.DEPARTMENT_NAME AS DEPARTMENT,'PUR' AS XN_TYPE,   B.RECEIPT_DT AS XN_DT,  B.MRR_NO AS XN_NO,           
 A.PRODUCT_UID,AR.ARTICLE_NO,A.PARA1_CODE,A.PARA2_CODE,'LM'+B.AC_CODE AS XN_PARTY_CODE, A.QUANTITY AS XN_QTY,          
 A.MRP AS XN_MRP,A.PURCHASE_PRICE AS XN_PP--,  CONVERT(NUMERIC(10,2),0) AS XN_DA,A.TAX_AMOUNT             
  
 FROM PRD_PID01106 A (NOLOCK)          
 JOIN PRD_PIM01106 B (NOLOCK) ON A.MRR_ID = B.MRR_ID   
 JOIN PRD_DEPARTMENT_MST D ON D.DEPARTMENT_ID=B.DEPARTMENT_ID        
 JOIN PRD_PO_PUR E ON E.MRR_ID=B.MRR_ID  
 JOIN PRD_PO_WSL F ON E.PO_ID=F.PO_ID  
 JOIN PRD_PS_MST G ON G.PS_ID=F.INV_ID        
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=A.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE    
 JOIN PRD_WO_MST W ON  G.REF_WO_ID = W.MEMO_ID   
 WHERE  B.CANCELLED = 0 AND A.PRODUCT_UID<>''        

--TRANSFER TO MAIN FOR PRODUCTION BEGIN
 UNION ALL
 SELECT W.MEMO_NO AS WORK_ORDER_NO, SK.WORK_ORDER_ID, D.DEPARTMENT_NAME AS DEPARTMENT,
'CODE_CON' AS XN_TYPE, B.MEMO_DT AS XN_DT, B.MEMO_NO AS XN_NO, A.PRODUCT_UID, AR.ARTICLE_NO,
SK.PARA1_CODE, SK.PARA2_CODE, 'LM'+SK.AC_CODE AS XN_PARTY_CODE, A.QUANTITY AS XN_QTY,
SK.MRP AS XN_MRP,A.PURCHASE_PRICE AS XN_PP
FROM PRD_TRANSFER_MAIN_SUB_DET A (NOLOCK)          
JOIN PRD_TRANSFER_MAIN_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID   
JOIN PRD_DEPARTMENT_MST D ON D.DEPARTMENT_ID=B.SOURCE_DEPARTMENT_ID        
JOIN PRD_SKU SK ON SK.PRODUCT_UID=A.PRODUCT_UID        
JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE    
JOIN PRD_WO_MST W ON  SK.WORK_ORDER_ID = W.MEMO_ID
WHERE  B.CANCELLED = 0 AND A.PRODUCT_UID<>''   
--TRANSFER TO MAIN FOR PRODUCTION END
 
 UNION ALL
 SELECT '' AS WORK_ORDER_NO,'' AS WORK_ORDER_ID,D.DEPARTMENT_NAME AS DEPARTMENT,'OPS' AS XN_TYPE, A.XN_DT AS XN_DT,  
 '' AS XN_NO,           
 A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,'LM'+SK.AC_CODE AS XN_PARTY_CODE, A.QUANTITY_OB AS XN_QTY,          
 SK.MRP AS XN_MRP,SK.PURCHASE_PRICE AS XN_PP--,  CONVERT(NUMERIC(10,2),0) AS XN_DA,A.TAX_AMOUNT             
  
 FROM PRD_OPS01106 A (NOLOCK)           
 JOIN PRD_DEPARTMENT_MST D ON D.DEPARTMENT_ID=A.DEPARTMENT_ID              
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=A.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE    
 WHERE   A.PRODUCT_UID<>''            
 UNION ALL          
  
 SELECT W.MEMO_NO AS WORK_ORDER_NO,SK.WORK_ORDER_ID, D.DEPARTMENT_NAME AS DEPARTMENT,'PRT' AS XN_TYPE, B.RM_DT AS XN_DT, B.RM_NO AS XN_NO,          
 A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,'LM'+B.AC_CODE AS XN_PARTY_CODE,   A.QUANTITY AS XN_QTY,          
 A.RFNET AS XN_MRP,A.PURCHASE_PRICE AS XN_PP--,  CONVERT(NUMERIC(10,2),0) AS XN_DA--,A.ITEM_TAX_AMOUNT AS TAX_AMOUNT          
 FROM PRD_RMD01106 A (NOLOCK)          
 JOIN PRD_RMM01106 B (NOLOCK) ON A.RM_ID = B.RM_ID          
 JOIN PRD_DEPARTMENT_MST D ON D.DEPARTMENT_ID=B.DEPARTMENT_ID        
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=A.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE      
 JOIN PRD_WO_MST W ON  SK.WORK_ORDER_ID = W.MEMO_ID     
 WHERE B.CANCELLED = 0  AND A.PRODUCT_UID<>''        
            
 UNION ALL          
  
 SELECT W.MEMO_NO AS WORK_ORDER_NO,SK.WORK_ORDER_ID, D.DEPARTMENT_NAME AS DEPARTMENT,(CASE WHEN B.CNC_TYPE=1 THEN 'CNC' ELSE 'UNC' END) AS XN_TYPE,B.CNC_MEMO_DT AS XN_DT,  B.CNC_MEMO_NO AS XN_NO,          
 A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,CONVERT(VARCHAR(40),'') AS XN_PARTY_CODE,A.QUANTITY AS XN_QTY,          
 CAST(SK.MRP AS NUMERIC(10,2)) AS XN_MRP,CONVERT(NUMERIC(10,2),SK.PURCHASE_PRICE) AS XN_PP--, CONVERT(NUMERIC(10,2),0) AS XN_DA--,CONVERT(NUMERIC(10,2),0) AS TAX_AMOUNT          
 FROM PRD_ICD01106 A (NOLOCK)          
 JOIN PRD_ICM01106 B (NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID          
 JOIN PRD_DEPARTMENT_MST D ON D.DEPARTMENT_ID=B.DEPARTMENT_ID        
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=A.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE   
 JOIN PRD_WO_MST W ON  SK.WORK_ORDER_ID = W.MEMO_ID        
 WHERE B.CANCELLED = 0          
         
         
 UNION ALL          
 SELECT W.MEMO_NO AS WORK_ORDER_NO,SK.WORK_ORDER_ID, D.DEPARTMENT_NAME AS DEPARTMENT,'WSL' AS XN_TYPE,  B.PS_DT AS XN_DT,  B.PS_NO AS XN_NO,          
 A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,'LM'+B.AC_CODE AS XN_PARTY_CODE,   A.QUANTITY AS XN_QTY,          
 A.RATE AS XN_MRP,CAST(0 AS NUMERIC(10,2)) AS XN_PP --,  CONVERT(NUMERIC(10,2),0) AS XN_DA--,  A.TAX_AMOUNT AS TAX_AMOUNT          
 FROM PRD_PS_DET A (NOLOCK)          
 JOIN PRD_PS_MST B (NOLOCK) ON A.PS_ID = B.PS_ID          
 JOIN PRD_DEPARTMENT_MST D ON D.DEPARTMENT_ID=B.DEPARTMENT_ID        
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=A.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE    
 JOIN PRD_WO_MST W ON  SK.WORK_ORDER_ID = W.MEMO_ID       
 WHERE B.CANCELLED = 0          
         
 UNION ALL          
 SELECT W.MEMO_NO AS WORK_ORDER_NO,SK.WORK_ORDER_ID, D.DEPARTMENT_NAME AS DEPARTMENT,'WSR' AS XN_TYPE,  B.CN_DT AS XN_DT,  B.CN_NO AS XN_NO,          
 A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,'LM'+B.AC_CODE AS XN_PARTY_CODE,   A.QUANTITY AS XN_QTY,          
 A.RATE AS XN_MRP,CAST(0 AS NUMERIC(10,2)) AS XN_PP--,  CONVERT(NUMERIC(10,2),0) AS XN_DA--,  A.ITEM_TAX_AMOUNT AS TAX_AMOUNT          
 FROM PRD_CND01106 A (NOLOCK)          
 JOIN PRD_CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID          
 JOIN PRD_DEPARTMENT_MST D ON D.DEPARTMENT_ID=B.DEPARTMENT_ID        
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=A.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE    
 JOIN PRD_WO_MST W ON  SK.WORK_ORDER_ID = W.MEMO_ID       
 WHERE B.CANCELLED = 0          
         
  UNION ALL        
         
 SELECT W.MEMO_NO AS WORK_ORDER_NO,B.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID, AJ.AGENCY_NAME AS DEPARTMENT, 'AMR' AS XN_TYPE,D.MEMO_DT AS XN_DT,D.MEMO_NO AS XN_NO,        
 B.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,        
 AJ.AC_CODE AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,C.RATE AS XN_MRP,CAST(0 AS NUMERIC(10,2)) AS XN_PP--,  E.JOB_CODE        
    FROM PRD_AGENCY_MATERIAL_RECEIPT_DET C           
    JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST D ON D.MEMO_ID=C.MEMO_ID                    
 JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B ON B.ROW_ID=C.REF_ROW_ID                  
 JOIN PRD_AGENCY_ISSUE_MATERIAL_MST BM ON BM.MEMO_ID=B.MEMO_ID  
 JOIN ARTICLE ART ON ART.ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE            
 JOIN PRD_AGENCY_MST AJ ON AJ.AGENCY_CODE=D.AGENCY_CODE        
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=B.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE    
 JOIN PRD_WO_MST W ON  B.REF_PRD_WORKORDER_MEMOID = W.MEMO_ID       
 WHERE D.CANCELLED=0    
         
 UNION ALL         
         
 SELECT W.MEMO_NO AS WORK_ORDER_NO,C.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID, AJ.AGENCY_NAME AS DEPARTMENT, 'AMI' AS XN_TYPE,D.MEMO_DT AS XN_DT,D.MEMO_NO AS XN_NO,        
 C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,        
 AJ.AC_CODE AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,C.RATE AS XN_MRP ,CAST(0 AS NUMERIC(10,2)) AS XN_PP--,  E.JOB_CODE        
 FROM PRD_AGENCY_ISSUE_MATERIAL_DET  C           
 JOIN PRD_AGENCY_ISSUE_MATERIAL_MST D ON D.MEMO_ID=C.MEMO_ID                    
 JOIN PRD_AGENCY_MST AJ ON AJ.AGENCY_CODE=D.REF_AGENCY_CODE        
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=C.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE    
 JOIN PRD_WO_MST W ON  C.REF_PRD_WORKORDER_MEMOID = W.MEMO_ID       
 WHERE D.CANCELLED=0    
         
 UNION ALL         
         
 SELECT W.MEMO_NO AS WORK_ORDER_NO,C.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID, DP.DEPARTMENT_NAME AS DEPARTMENT, 'IMI' AS XN_TYPE,D.MEMO_DT AS XN_DT,D.MEMO_NO AS XN_NO,        
 C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,        
 '' AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,C.MRP AS XN_MRP,C.PURCHASE_PRICE AS XN_PP--,  E.JOB_CODE        
   FROM PRD_ISSUE_MATERIAL_DET  C           
   JOIN PRD_ISSUE_MATERIAL_MST D ON D.MEMO_ID=C.MEMO_ID                    
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=C.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
 JOIN PRD_DEPARTMENT_MST DP ON DP.DEPARTMENT_ID=D.SOURCE_DEPARTMENT_ID    
 JOIN PRD_WO_MST W ON  C.REF_PRD_WORKORDER_MEMOID = W.MEMO_ID       
 WHERE D.CANCELLED=0      
       
 UNION ALL         
         
 SELECT W.MEMO_NO AS WORK_ORDER_NO,B.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'IMR' AS XN_TYPE,D.MEMO_DT AS XN_DT,D.MEMO_NO AS XN_NO,        
 B.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,        
 '' AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,B.MRP AS XN_MRP,B.PURCHASE_PRICE AS XN_PP--,  E.JOB_CODE        
 FROM PRD_MATERIAL_RECEIPT_DET  C           
 JOIN PRD_MATERIAL_RECEIPT_MST D ON D.MEMO_ID=C.MEMO_ID                    
 JOIN PRD_ISSUE_MATERIAL_DET B ON B.ROW_ID=C.REF_ROW_ID                   
 JOIN PRD_ISSUE_MATERIAL_MST BM ON BM.MEMO_ID=B.MEMO_ID  
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=B.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
 JOIN PRD_DEPARTMENT_MST DP ON DP.DEPARTMENT_ID=D.DEPARTMENT_ID     
 JOIN PRD_WO_MST W ON  B.REF_PRD_WORKORDER_MEMOID = W.MEMO_ID      
 WHERE D.CANCELLED=0    
       
 UNION ALL        
         
 SELECT W.MEMO_NO AS WORK_ORDER_NO,B.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'OP' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
 C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,        
 '' AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,C.MRP AS XN_MRP,C.PURCHASE_PRICE AS XN_PP--,  E.JOB_CODE        
 FROM PRD_DEPARTMENT_RMCONSUMPTION_DET C--PRD_OP_MATERIAL_CON_DET C                  
 JOIN PRD_DEPARTMENT_OUTPUT_MST B ON B.MEMO_ID=C.MEMO_ID               
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=C.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
 JOIN PRD_DEPARTMENT_MST DP ON DP.DEPARTMENT_ID=B.DEPARTMENT_ID     
 JOIN PRD_WO_MST W ON  B.REF_PRD_WORKORDER_MEMOID = W.MEMO_ID      
   WHERE B.CANCELLED=0    
       
 UNION ALL        
       
 SELECT W.MEMO_NO AS WORK_ORDER_NO,B.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID, DP.DEPARTMENT_NAME AS DEPARTMENT, 'OPC' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
 C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,        
 '' AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,CONVERT(NUMERIC(10,2),0) AS XN_MRP,CONVERT(NUMERIC(10,2),0) AS XN_PP--,  E.JOB_CODE        
 FROM PRD_OP_MATERIAL_CON_RWM_DET C--PRD_OP_MATERIAL_CON_DET C                  
 JOIN PRD_OP_MATERIAL_CON_MST B ON B.MEMO_ID=C.MEMO_ID               
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=C.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
 JOIN PRD_DEPARTMENT_MST DP ON DP.DEPARTMENT_ID=B.SOURCE_DEPARTMENT_ID    
 JOIN PRD_WO_MST W ON  B.REF_PRD_WORKORDER_MEMOID = W.MEMO_ID       
   WHERE B.CANCELLED=0    
       
 UNION ALL        
         
 SELECT W.MEMO_NO AS WORK_ORDER_NO,B.WORK_ORDER_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'RMR' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
 C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,        
 '' AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,C.RATE AS XN_MRP,CONVERT(NUMERIC(10,0),0) AS XN_PP--,  E.JOB_CODE        
 FROM PRD_READY_RECEIVE_DET C                  
 JOIN PRD_READY_RECEIVE_MST B ON B.MEMO_ID=C.MEMO_ID               
  JOIN PRD_SKU SK ON SK.PRODUCT_UID=C.PRODUCT_UID        
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
 JOIN PRD_DEPARTMENT_MST DP ON DP.DEPARTMENT_ID=B.DEPARTMENT_ID    
 JOIN PRD_WO_MST W ON  B.WORK_ORDER_ID = W.MEMO_ID       
 WHERE B.CANCELLED=0    
        
)T  
JOIN PARA1 ON PARA1.PARA1_CODE=T.PARA1_CODE  
JOIN PARA2 ON PARA2.PARA2_CODE=T.PARA2_CODE  
LEFT OUTER JOIN LMV01106 LM ON LM.AC_CODE=T.XN_PARTY_CODE  
WHERE T.WORK_ORDER_ID=@CWORKORDER  
GROUP BY T.WORK_ORDER_NO,T.WORK_ORDER_ID,T.DEPARTMENT,T.XN_TYPE,T.XN_DT,T.XN_NO,T.XN_PARTY_CODE,T.ARTICLE_NO
,PARA1.PARA1_NAME,PARA2.PARA2_NAME,LM.AC_NAME  
ORDER BY XN_DT       
    
    
    
 SELECT A.MEMO_NO AS WORK_ORDER_NO, A.REF_NO,A.ARTICLE_SET_CODE,CONVERT(VARCHAR, A.MEMO_DT,105) AS MEMO_DT,CONVERT(VARCHAR,C.DELIVERY_DT,105) AS DELIVERY_DT ,D.AC_NAME        
 ,ADDRESS0+' '+ADDRESS1+' '+ADDRESS2+' '+AREA_NAME+' '+[STATE]+' '+PINCODE AS [ADDRESS]        
 ,E.ARTICLE_NO,E.ARTICLE_NAME,E.ARTICLE_DESC,SD.SUB_SECTION_NAME,SM.SECTION_NAME              
 FROM PRD_WO_MST A        
 JOIN PRD_WO_ORDERS B ON B.MEMO_ID=A.MEMO_ID        
 JOIN WSL_ORDER_MST C ON C.ORDER_ID=B.ORDER_ID        
 JOIN LMV01106 D ON D.AC_CODE=C.AC_CODE        
 JOIN ARTICLE E ON E.ARTICLE_CODE=A.ARTICLE_SET_CODE        
 JOIN SECTIOND SD ON SD.SUB_SECTION_CODE=E.SUB_SECTION_CODE        
 JOIN SECTIONM SM ON SM.SECTION_CODE=SD.SECTION_CODE        
WHERE A.MEMO_ID=@CWORKORDER    
   
   
   -- TTM
END
