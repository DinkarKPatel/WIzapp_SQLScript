CREATE PROCEDURE SP3S_SEND_MIRROR_KEYS_DATA
AS
BEGIN
     
     --SELECT * FROM SYS.TABLES WHERE NAME LIKE 'KEYS%'
        DECLARE @CCMD NVARCHAR(MAX),@CSTEP VARCHAR(100),@CFILTERCONDITION VARCHAR(200),@CLOCATIONID VARCHAR(5),
        @CTEMPTABLE VARCHAR(100),@CTABLENAME VARCHAR(100),@CQUERY VARCHAR(MAX),@CERRMSG VARCHAR(100)
       
        
		DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(40))
		SELECT TOP 1 @CLOCATIONID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'  
		
		BEGIN TRY
				
        SET @CSTEP=00
		DECLARE @CTEMPDBNAME1 VARCHAR(40),@CTEMPDBNAME VARCHAR(40)  
		SET @CTEMPDBNAME1 = DB_NAME() + '_TEMP'		
		SET @CSTEP=10
			
		IF DB_ID(@CTEMPDBNAME1) IS NOT NULL
		   SET @CTEMPDBNAME = DB_NAME() + '_TEMP.DBO.'
		ELSE
		BEGIN
			SET @CERRMSG='STEP- ' + LTRIM(STR(@CSTEP)) + ' ERROR TEMP DATABASE NOT EXISTS.'  
			    
			GOTO END_PROC
		END	
	

		SET @CSTEP=20
		INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES('KEYS_MIRROR_LOG')
		
	
		
		SET @CSTEP=30
		SET @CTABLENAME='KEYS_MIRROR_LOG'
	    SET @CTEMPTABLE=@CTEMPDBNAME+'[TMP_KEYS_'+@CTABLENAME+'_'+@CLOCATIONID+']'
		SET @CCMD=N'IF OBJECT_ID('''+@CTEMPTABLE+''',''U'') IS NOT NULL  
					DROP TABLE '+@CTEMPTABLE
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD	
		
		SET @CSTEP=40
		SET @CCMD=N'SELECT  KEYS_MIRROR_LOG.* INTO '+@CTEMPTABLE+' FROM KEYS_MIRROR_LOG WHERE  1=2 '
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
		
		
		
		SET @CSTEP=50
		SELECT @CQUERY=ISNULL(@CQUERY+' ','')+'SELECT '''+@CLOCATIONID+''' AS DEPT_ID,'+''''+NAME+''''+' AS KEYS_TABLENAME,
		COLUMNNAME,PREFIX,FINYEAR,TABLENAME,
        LASTKEYVAL FROM '+NAME +' UNION ALL' 
		FROM SYS.TABLES A
		WHERE A.NAME LIKE 'KEYS%' AND NAME <>'KEYS_MIRROR_LOG'
		
		SET @CSTEP=60
		SET @CQUERY=(SELECT SUBSTRING (@CQUERY,1,LEN(@CQUERY)-9))
		IF ISNULL(@CQUERY,'')<>''
		BEGIN
		   SET @CCMD=N'INSERT INTO '+@CTEMPTABLE+' (DEPT_ID,KEYS_TABLENAME,COLUMNNAME,PREFIX,FINYEAR,TABLENAME,LASTKEYVAL)
		             SELECT DEPT_ID,KEYS_TABLENAME,COLUMNNAME,PREFIX,FINYEAR,TABLENAME,LASTKEYVAL
		              FROM
		              (
		               '+@CQUERY+'
		              ) A'
		    PRINT @CCMD
		    EXEC SP_EXECUTESQL @CCMD
		END
		
				
		SET @CSTEP=100
		UPDATE @TXNSSENDINFO SET TMP_TABLENAME='TMP_KEYS_'+ORG_TABLENAME+'_'+@CLOCATIONID,
		XN_ID=@CLOCATIONID
				
	    GOTO END_PROC
	    
		
								
		GOTO END_PROC			
		END TRY
		BEGIN CATCH
				SET @CERRMSG='P: SP3S_SEND_MIRROR_KEYS_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
				GOTO END_PROC
		END CATCH
		
END_PROC:

	IF ISNULL(@CERRMSG,'')=''
			SELECT * FROM @TXNSSENDINFO		
	ELSE
	SELECT @CERRMSG AS ERRMSG

END
