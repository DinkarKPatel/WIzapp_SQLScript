CREATE PROCEDURE SP_FLOOR_STK_TRANSFER      
@NQUERYID  NUMERIC (2,0),      
@CMEMOID  VARCHAR(40),      
@CWHERE   VARCHAR(500),      
@CPRODUCTCODE VARCHAR(50),      
@CFINYEAR  VARCHAR(5),      
@NNAVMODE  NUMERIC(2,0)  
-- WITH ENCRYPTION
     
AS      
--(dinkar) Replace  left(memoid,2) to Location_code 
BEGIN      
DECLARE @CCMD NVARCHAR(MAX)      
      
IF       
@NQUERYID = 1      
GOTO LBLNAVIGATE      
      
ELSE IF       
@NQUERYID = 2      
GOTO LBLGETMASTERS      
      
ELSE IF       
@NQUERYID = 3      
GOTO LBLGETDETAILS      
ELSE IF       
@NQUERYID = 31      
GOTO  LBLGETDETAILS_EXCESS
ELSE IF       
@NQUERYID = 4      
GOTO LBLGETFLOOR      
      
ELSE IF      
@NQUERYID = 5      
GOTO LBLGETPRODUCTLIST      
  
ELSE IF      
@NQUERYID = 6      
GOTO LBLMSTLIST   

ELSE IF      
@NQUERYID = 7      
GOTO LBLBOXBIN  
      
    
      
LBLNAVIGATE:      
 EXECUTE SP_NAVIGATE 'FLOOR_ST_MST',@NNAVMODE,@CMEMOID,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERE      
GOTO LAST      
      
LBLGETMASTERS:      

  SELECT T1.*, '' AS  TARGET_FLOOR_NAME, T3.BIN_NAME AS SOURCE_FLOOR_NAME  ,0 AS SP_ID  
  ,CASE WHEN ISNULL(T1.INV_id,'')='' THEN '' ELSE PIM.inv_no  END AS INV_NO,PIM.INV_ID ,
  --CASE WHEN ISNULL(T1.PS_id,'')='' THEN '' ELSE SUBSTRING(RIGHT(T1.PS_id,LEN(T1.PS_ID)-LEN(challan_source_location_code)+5),CHARINDEX(LEFT(T1.PS_ID,LEN(challan_source_location_code)), RIGHT(T1.PS_id,LEN(T1.PS_ID)-LEN(challan_source_location_code)+5)),LEN(challan_source_location_code)+13)  END AS PS_NO,
  CASE WHEN ISNULL(T1.PS_id,'')='' THEN '' ELSE SUBSTRING(RIGHT(T1.PS_id,LEN(T1.PS_ID)-7),CHARINDEX(challan_source_location_code, RIGHT(T1.PS_id,LEN(T1.PS_ID)-7)),15)  END AS PS_NO,
  T4.username AS COMPLETED_BY_NAME,t5.username 
  FROM FLOOR_ST_MST T1(NOLOCK)        
  JOIN BIN T3(NOLOCK) ON T3.BIN_ID = T1.BIN_ID        
  LEFT OUTER JOIN USERS T4 ON T4.user_code= T1.COMPLETED_BY
  LEFT OUTER JOIN USERS T5 ON T5.user_code= T1.USER_CODE 
  LEFT JOIN PIM01106 PIM (NOLOCK) ON PIM.inv_id =T1.INV_ID AND ISNULL(PIM.inv_id,'')<>''
  WHERE  T1.MEMO_ID = @CMEMOID      
    
GOTO LAST      
      
LBLGETDETAILS:      

	
  SELECT D.*,A.ARTICLE_NO,A.ARTICLE_NAME,A.ARTICLE_DESC,SM.SECTION_NAME,SD.SUB_SECTION_NAME,      
  P.QUANTITY_IN_STOCK,M.BIN_ID AS DEPT_ID,UOM.UOM_NAME,UOM.UOM_TYPE     
  ,P1.PARA1_NAME ,P2.PARA2_NAME,P3.PARA3_NAME ,P4.PARA4_NAME,P5.PARA5_NAME ,P6.PARA6_NAME ,B1.BIN_NAME,
  A.ALIAS AS ARTICLE_ALIAS,A.DT_CREATED AS ART_DT_CREATED,P3.DT_CREATED AS PARA3_DT_CREATED, 
  S.DT_CREATED AS SKU_DT_CREATED, B2.BIN_NAME AS ITEM_TARGET_BIN_NAME,UOM.UOM_CODE,0 AS SP_ID,
  D.PRODUCT_CODE AS ORG_PRODUCT_CODE, 
 CAST(CASE WHEN CHARINDEX('@',D.PRODUCT_CODE)=0 THEN '' ELSE 
(SUBSTRING(D.PRODUCT_CODE,CHARINDEX('@',D.PRODUCT_CODE)+1,15)) END  AS VARCHAR(100)) AS BATCH_LOT_NO,
   S.BATCH_NO,S.EXPIRY_DT ,S.MRP,CAST(0 AS NUMERIC(14,2)) AS EXCESS_QUANTITY_FOR_888_BIN,S.barcode_coding_scheme as coding_scheme
  FROM FLOOR_ST_DET D(NOLOCK)      
  JOIN FLOOR_ST_MST M(NOLOCK) ON D.MEMO_ID = M.MEMO_ID       
  JOIN SKU S(NOLOCK) ON D.PRODUCT_CODE = S.PRODUCT_CODE       
  LEFT OUTER JOIN PMT01106 P(NOLOCK) ON D.PRODUCT_CODE = P.PRODUCT_CODE AND D.SOURCE_BIN_ID = P.BIN_ID   AND P.DEPT_ID= M.location_Code    
  JOIN ARTICLE A(NOLOCK) ON S.ARTICLE_CODE = A.ARTICLE_CODE      
  JOIN SECTIOND SD(NOLOCK) ON SD.SUB_SECTION_CODE = A.SUB_SECTION_CODE      
  JOIN SECTIONM SM (NOLOCK) ON SM.SECTION_CODE = SD.SECTION_CODE      
  JOIN PARA1 P1(NOLOCK) ON S.PARA1_CODE = P1.PARA1_CODE       
  JOIN PARA2 P2(NOLOCK) ON S.PARA2_CODE = P2.PARA2_CODE     
  JOIN PARA3 P3(NOLOCK) ON S.PARA3_CODE = P3.PARA3_CODE       
  JOIN PARA4 P4(NOLOCK) ON S.PARA4_CODE = P4.PARA4_CODE    
  JOIN PARA5 P5(NOLOCK) ON S.PARA5_CODE = P5.PARA5_CODE       
  JOIN PARA6 P6(NOLOCK) ON S.PARA6_CODE = P6.PARA6_CODE      
  JOIN UOM(NOLOCK) ON UOM.UOM_CODE = A.UOM_CODE   
  JOIN BIN B1(NOLOCK) ON B1.BIN_ID=D.SOURCE_BIN_ID    
  LEFT OUTER JOIN BIN B2(NOLOCK) ON B2.BIN_ID=D.ITEM_TARGET_BIN_ID  
  WHERE M.MEMO_ID = @CMEMOID   
   ORDER BY D.TS   
   
        
 GOTO LAST      
LBLGETDETAILS_EXCESS:     
 SELECT D.*,ISNULL(S.ARTICLE_NO,'NA') AS ARTICLE_NO,ISNULL(S.ARTICLE_NAME,'NA') AS ARTICLE_NAME,ISNULL(S.ARTICLE_NAME,'') AS ARTICLE_DESC,
 ISNULL(S.SECTION_NAME,'NA') AS SECTION_NAME,ISNULL(S.SUB_SECTION_NAME,'NA') AS SUB_SECTION_NAME,      
  CAST(999 AS NUMERIC(14,2)) AS QUANTITY_IN_STOCK,M.BIN_ID AS DEPT_ID,ISNULL(S.UOM,'') UOM_NAME,ISNULL(S.SN_UOM_TYPE ,1)    UOM_TYPE
  ,ISNULL(S.PARA1_NAME,'NA') AS PARA1_NAME  ,ISNULL(S.PARA2_NAME,'NA') AS PARA2_NAME,ISNULL(S.PARA3_NAME ,'NA') AS PARA3_NAME,ISNULL(S.PARA4_NAME,'NA') AS PARA4_NAME,
  ISNULL(S.PARA5_NAME ,'NA') AS PARA5_NAME,ISNULL(S.PARA6_NAME ,'NA') AS PARA6_NAME,B1.BIN_NAME,
  ISNULL(S.article_alias,'NA') AS ARTICLE_ALIAS,'' AS ART_DT_CREATED,'' AS PARA3_DT_CREATED, 
  '' AS SKU_DT_CREATED, B2.BIN_NAME AS ITEM_TARGET_BIN_NAME,'' UOM_CODE,0 AS SP_ID,
  D.PRODUCT_CODE AS ORG_PRODUCT_CODE, 
 CAST(CASE WHEN CHARINDEX('@',D.PRODUCT_CODE)=0 THEN '' ELSE 
(SUBSTRING(D.PRODUCT_CODE,CHARINDEX('@',D.PRODUCT_CODE)+1,15)) END  AS VARCHAR(100)) AS BATCH_LOT_NO,
   S.BATCH_NO,S.EXPIRY_DT ,S.MRP,D.QUANTITY AS EXCESS_QUANTITY_FOR_888_BIN,ISNULL(S.sn_barcode_coding_scheme,1) as coding_scheme
  FROM FLOOR_ST_DET_EXCESS D(NOLOCK)      
  JOIN FLOOR_ST_MST M(NOLOCK) ON D.MEMO_ID = M.MEMO_ID       
  JOIN BIN B1(NOLOCK) ON B1.BIN_ID=D.SOURCE_BIN_ID    
  JOIN BIN B2(NOLOCK) ON B2.BIN_ID=D.ITEM_TARGET_BIN_ID  
  LEFT OUTER JOIN sku_names S(NOLOCK) ON D.PRODUCT_CODE = S.PRODUCT_CODE       
  WHERE M.MEMO_ID = @CMEMOID 
  ORDER BY D.TS   
    GOTO LAST  
LBLGETFLOOR:      
  SELECT * FROM LOCATION       
  WHERE MAJOR_DEPT_ID = @CMEMOID AND DEPT_ID <> @CWHERE AND INACTIVE = 0      
  ORDER BY DEPT_NAME       
GOTO LAST      
      
LBLGETPRODUCTLIST:      
	SELECT * FROM SKU A(NOLOCK) 
	JOIN  PMT01106 P(NOLOCK) ON P.PRODUCT_CODE=A.PRODUCT_CODE
	JOIN BIN B(NOLOCK) ON B.BIN_ID=P.BIN_ID
	LEFT OUTER JOIN BINUSERS C(NOLOCK) ON C.BIN_ID=B.BIN_ID
	WHERE P.QUANTITY_IN_STOCK>0
	AND ISNULL(P.BIN_ID,'')<>@CWHERE
	AND @CMEMOID=(CASE WHEN @CMEMOID='0000000' THEN @CMEMOID ELSE C.USER_CODE END)
       
GOTO LAST      
      
LBLMSTLIST:      
 SET @CCMD = N'SELECT T1.*, T3.BIN_NAME AS TARGET_FLOOR_NAME, T4.BIN_NAME AS SOURCE_FLOOR_NAME      
  FROM FLOOR_ST_MST T1(NOLOCK)      
  JOIN BIN T3(NOLOCK) ON T3.BIN_ID = T1.TARGET_BIN_ID      
  JOIN BIN T4(NOLOCK) ON T4.BIN_ID = T1.BIN_ID   
  WHERE T1.TARGET_BIN_ID = '''+ @CMEMOID +'''      
  '+ @CWHERE +''  
 PRINT @CCMD      
 EXEC SP_EXECUTESQL @CCMD     
 
 
 GOTO LAST  
 
 LBLBOXBIN:
;WITH BOX_DET
AS
(
	SELECT BOX_NO,ITEM_TARGET_BIN_ID,BIN_NAME,QUANTITY
	FROM FLOOR_ST_DET  A  (NOLOCK)
	LEFT  OUTER JOIN BIN  B  (NOLOCK) ON A.ITEM_TARGET_BIN_ID= B.BIN_ID
	WHERE MEMO_ID = @CMEMOID
	UNION ALL
	SELECT BOX_NO,ITEM_TARGET_BIN_ID,BIN_NAME,QUANTITY
	FROM FLOOR_ST_DET_EXCESS  A  (NOLOCK)
	LEFT  OUTER JOIN BIN  B  (NOLOCK) ON A.ITEM_TARGET_BIN_ID= B.BIN_ID
	WHERE MEMO_ID = @CMEMOID
)
SELECT BOX_NO,ITEM_TARGET_BIN_ID,BIN_NAME,SUM(QUANTITY)  AS QTY 
FROM BOX_DET
GROUP BY BOX_NO,ITEM_TARGET_BIN_ID,BIN_NAME
       
GOTO LAST     
      
LAST:      
END
