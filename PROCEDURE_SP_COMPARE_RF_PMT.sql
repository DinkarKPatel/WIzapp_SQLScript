CREATE PROCEDURE SP_COMPARE_RF_PMT      
(      
	@CDEPTID CHAR(2) ,
	@CREPID VARCHAR(20)=''     
) 
--WITH ENCRYPTION
AS      
BEGIN  

RETURN
--EXEC SP_RFOPT

DECLARE @CCMD NVARCHAR(MAX)
DECLARE @CDB VARCHAR(100)
SET @CDB=DB_NAME()+'_RFOPT..RF_OPT'

IF OBJECT_ID('TEMPDB..#TMPPMT','U') IS NOT NULL
	DROP TABLE #TMPPMT


SELECT DISTINCT PRODUCT_CODE INTO #TMPPMT FROM PMT01106 WITH (NOLOCK,INDEX=IND_PMT_REPID)
WHERE REP_ID=@CREPID	

SET @CCMD = N' SELECT X.PRODUCT_CODE, X.DEPT_ID, X.QUANTITY_IN_STOCK, Y.RF_STOCK      
FROM PMT01106 X (NOLOCK)      
LEFT OUTER JOIN      
(      
SELECT A.PRODUCT_CODE, DEPT_ID,       

SUM( (CASE WHEN A.XN_TYPE=''OPS'' OR (A.XN_TYPE IN (''SCF'',''OPS'', ''PUR'', ''CHI'', ''SLR'',''UNC'',''APR'',    
''WSR'', ''PFI'', ''PFG'', ''BCG'',''MRP'',''DCI'',''PSB'',''JWR'') ) THEN 1     
WHEN A.XN_TYPE IN (''PRT'',''CHO'',''SLS'',''CNC'',''APP'',''WSL'',''CIP'', ''CRM'', ''DCO'',    
''MIP'',''CSB'',''JWI'',''DLM'',''SCC'') THEN -1 ELSE 0 END) * (XN_QTY))  AS RF_STOCK     
FROM  '+@CDB +'  A (NOLOCK)   
JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE  
JOIN ARTICLE C ON C.ARTICLE_CODE=B.ARTICLE_CODE     
JOIN #TMPPMT D ON D.PRODUCT_CODE=B.PRODUCT_CODE
WHERE C.STOCK_NA=0 AND DEPT_ID =  '''+@CDEPTID+'''     
GROUP BY A.PRODUCT_CODE, DEPT_ID      
) Y ON X.PRODUCT_CODE = Y.PRODUCT_CODE       
AND X.DEPT_ID = Y.DEPT_ID      
WHERE X.REP_ID='''+@CREPID+''' AND X.DEPT_ID='''+@CDEPTID+''' AND X.QUANTITY_IN_STOCK <> ISNULL(Y.RF_STOCK,0) '


PRINT   @CCMD

EXEC SP_EXECUTESQL @CCMD 

END
