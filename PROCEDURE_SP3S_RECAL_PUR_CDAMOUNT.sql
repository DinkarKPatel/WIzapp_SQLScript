CREATE PROCEDURE SP3S_RECAL_PUR_CDAMOUNT
@cMrrId VARCHAR(40)
AS
BEGIN
	DECLARE @NCASHDISCOUNTAMOUNT NUMERIC(10,2)
	
	IF EXISTS(SELECT TOP 1 'U' FROM PIM01106 
				 WHERE MRR_ID=@cMrrId AND SUBTOTAL<>0 
				   AND ISNULL(TERMS,'')<>'')
	BEGIN
			
			--GET THE TOTAL CASH DISCOUNT AMOUNT ON THE PURCHASE
			SELECT @NCASHDISCOUNTAMOUNT=DBO.FN3SREADLEDGERTERMS(PM.TERMS,4)/100.00*
		 				  (CASE WHEN SUBSTRING(terms,DBO.CHARINDEX_NTH('-',Terms,1,10)+1,1)='N'
		 				  THEN (PM.SUBTOTAL-PM.DISCOUNT_AMOUNT-SUM(CASE WHEN PM.BILL_LEVEL_TAX_METHOD=2 
		 				   THEN PD.TAX_AMOUNT +ISNULL(IGST_AMOUNT,0)+ISNULL(CGST_AMOUNT,0)+ISNULL(SGST_AMOUNT,0) ELSE 0 END)) ELSE PM.TOTAL_AMOUNT END)
			FROM PIM01106 PM
			JOIN PID01106 PD ON PM.MRR_ID=PD.MRR_ID
			WHERE PM.MRR_ID=@cMrrId
			GROUP BY SUBSTRING(terms,DBO.CHARINDEX_NTH('-',Terms,1,10)+1,1),PM.SUBTOTAL,PM.DISCOUNT_AMOUNT,PM.TERMS,PM.TOTAL_AMOUNT 
					 		
			SET @NCASHDISCOUNTAMOUNT=ISNULL(@NCASHDISCOUNTAMOUNT,0)
			
			
			UPDATE A
			 SET CASHDISCOUNTAMOUNT=(@NCASHDISCOUNTAMOUNT/B.SUBTOTAL)*A.PURCHASE_PRICE
			 FROM PID01106 A
			  JOIN PIM01106 B ON A.MRR_ID=B.MRR_ID
			   WHERE B.MRR_ID=@cMrrId
	END			   
	  
	UPDATE A SET TOTAL_CASHDISCOUNTAMOUNT=ISNULL(B.CASHDISCOUNTAMOUNT,0)
	  FROM PIM01106 A LEFT OUTER JOIN  
	  (    
		   SELECT MRR_ID, SUM(CASHDISCOUNTAMOUNT) AS CASHDISCOUNTAMOUNT
		   FROM PID01106   
		   WHERE MRR_ID = @cMrrId  
		   GROUP BY MRR_ID    
	  ) B ON  A.MRR_ID = B.MRR_ID    
	WHERE A.MRR_ID = @cMrrId  
END  
