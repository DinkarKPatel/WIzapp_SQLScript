CREATE PROCEDURE SAVETRAN_UPDATED_TEMPTABLES
(
 @XN_TYPE VARCHAR(10),
 @XN_ID VARCHAR(100),
 @XN_TEMP_TABLE VARCHAR(100),
 @XN_SP_ID INT=0,
 @XN_MAIN_TABLE VARCHAR(1000),
 @XN_TABLE_KEY VARCHAR(100)
)
AS
BEGIN
    DECLARE @VSQL VARCHAR(MAX)
	SET @VSQL='DELETE AUDIT_XN_ID WHERE XN_TYPE='''+@XN_TYPE+''';INSERT AUDIT_XN_ID SELECT TOP 1 '''+@XN_TYPE+''','''+@XN_ID+''''
	EXEC(@VSQL)
    
	SET @VSQL='IF OBJECT_ID(''['+@XN_MAIN_TABLE+'_NEW_'+@XN_ID+']'',''U'') IS NOT NULL'+CHAR(13)+'DROP TABLE ['+@XN_MAIN_TABLE+'_NEW_'+@XN_ID+']'
    EXEC(@VSQL)
    
	SET @VSQL=''
	SELECT @VSQL=COALESCE(@VSQL,'')+COLUMN_NAME+','
	FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME=@XN_MAIN_TABLE
	AND DATA_TYPE NOT LIKE 'TIMESTAMP'
	AND COLUMN_NAME NOT IN ('TS','ROW_SNO')
	
	SET @VSQL=LEFT(@VSQL,LEN(@VSQL)-1)
	
	SET @VSQL='SELECT '+@VSQL+' INTO ['+@XN_MAIN_TABLE+'_NEW_'+@XN_ID+'] FROM ['+@XN_TEMP_TABLE+']'
	+'WHERE '+@XN_TABLE_KEY+'='''+@XN_ID+''''
	+CASE WHEN @XN_TYPE IN ('SLS') THEN ' AND SP_ID='+CAST(@XN_SP_ID AS VARCHAR) ELSE '' END
	+'ORDER BY LAST_UPDATE DESC'
	EXEC(@VSQL)
END--SAVETRAN_UPDATED_TEMPTABLES
