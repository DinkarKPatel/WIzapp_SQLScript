create PROC VALIDATEXN_JOB_CARD_BEFORE_EDIT 
	@CMEMOID VARCHAR(30),
	@BCANCELXN BIT,
	@CERRORMSG VARCHAR(200) OUTPUT,
	@CEXPRERRORMSG VARCHAR(200) OUTPUT,
	@CUSERCODE CHAR(7)=''
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CTEXT VARCHAR(10),@CPRODUCTCODE VARCHAR(50),@cAllowtoeditUser varchar(10)
	
	SELECT @CPRODUCTCODE=''

	SELECT TOP 1 @cAllowtoeditUser =VALUE FROM USER_ROLE_DET A(NOLOCK)
	JOIN USERS B(NOLOCK) ON A.ROLE_ID=B.ROLE_ID
	WHERE USER_CODE=@CUSERCODE 
	AND FORM_NAME='frmjobcard' 
	AND FORM_OPTION='EDIT'	

	
	SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)

	if isnull(@cAllowtoeditUser,'')<>'1'
	begin

		IF EXISTS(SELECT A.MEMO_ID 
		FROM ORD_PLAN_MST A
		JOIN ORD_PLAN_DET A1 ON A1.MEMO_ID=A.MEMO_ID
		JOIN ORD_PLAN_BARCODE_DET A2 ON A2.REFROW_ID=A1.ROW_ID
		JOIN JOBWORK_ISSUE_DET C ON A2.PRODUCT_CODE=C.PRODUCT_CODE
		JOIN JOBWORK_ISSUE_MST B ON B.ISSUE_ID=C.ISSUE_ID
		WHERE B.CANCELLED=0 AND A.MEMO_ID=@CMEMOID
		GROUP BY A.MEMO_ID)
		BEGIN	
			SET @CERRORMSG='BARCODE ALREADY ISSUED TO JOB WORK.........CAN NOT '+@CTEXT
			RETURN
		END


			IF EXISTS(SELECT A.MEMO_ID 
			FROM ORD_PLAN_MST A
			WHERE A.CANCELLED=0 AND A.MEMO_ID=@CMEMOID
			AND A.APPROVEDLEVELNO=99 /*AND @BCANCELXN<>1*/)
			BEGIN	
				SET @CERRORMSG='THIS JOB CARD IS APPROVED.........CAN NOT '+@CTEXT
				RETURN
			END

end
	IF EXISTS(SELECT A.MEMO_ID 
	FROM ORD_PLAN_MST A
	WHERE A.CANCELLED=0 AND A.MEMO_ID=@CMEMOID
	AND A.SHORT_CLOSE=1 AND @BCANCELXN<>1)
	BEGIN	
		SET @CERRORMSG='THIS JOB CARD IS SHORT CLOSED.........CAN NOT '+@CTEXT
		RETURN
	END
END
