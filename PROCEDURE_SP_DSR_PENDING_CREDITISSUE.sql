create PROCEDURE SP_DSR_PENDING_CREDITISSUE
(	
	@DTODT DATETIME,
	@CCUSTOMERCODE VARCHAR(20)='',
	@NMODE INT = 1,
	@BSHOW BIT,
	@LOC_ID VARCHAR(10)='',
	@BCALLEDFROMAPI BIT=0,
	@NAGEING INT =0,
	@NSUMMARY INT=0 ,
	@BIN_ID VARCHAR(10)=''
)
--WITH ENCRYPTION
AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 
     DECLARE @CUTOFF_DATE DATETIME 
	  SElect @CUTOFF_DATE=ISNULL(value,'') from config where config_option='CUTOFF_DATE_FOR_PENDING_ADV_CN_CR'
	  
	  IF @CUTOFF_DATE IS NULL
	  SET @CUTOFF_DATE=''

	IF ISNULL(@DTODT,'') = ''
	BEGIN
		SELECT 'CAN NOT ACCEPT A BLANK DATE.' AS ERRMSG
		GOTO END_PROC
	END
	
	IF @BCALLEDFROMAPI =0
	BEGIN
		
		
		IF OBJECT_ID('TEMPDB..#TMP_WIZAPPCI','U') IS NOT NULL
	        DROP TABLE #TMP_WIZAPPCI
	        
	    IF OBJECT_ID('TEMPDB..#TMP_WIZAPPCI_FINAL','U') IS NOT NULL
	        DROP TABLE #TMP_WIZAPPCI_FINAL
			   
			SELECT B.CM_NO, B.CM_DT,B.NET_AMOUNT,
			A.MEMO_ID, SUM(A.AMOUNT) AS CREDIT_AMOUNT,B.CUSTOMER_CODE,b.location_Code as dept_id
			INTO #TMP_WIZAPPCI 
			FROM PAYMODE_XN_DET A (NOLOCK)
			JOIN CMM01106 B (NOLOCK) ON A.MEMO_ID=B.CM_ID
			JOIN CUSTDYM C ON B.CUSTOMER_CODE = C.CUSTOMER_CODE
			WHERE B.CANCELLED=0 AND XN_TYPE = 'SLS' 
			AND PAYMODE_CODE = '0000004' 
			AND A.AMOUNT > 0 
			AND ((@CUTOFF_DATE='' AND CM_DT<=@DTODT) OR (ISNULL(@CUTOFF_DATE,'')<>'' AND 
	         CM_DT BETWEEN @CUTOFF_DATE AND @DTODT))
			
			AND CANCELLED=0 
			AND (B.CUSTOMER_CODE = @CCUSTOMERCODE OR @CCUSTOMERCODE='')
			AND (@LOC_ID='' OR b.location_Code =@LOC_ID)
			GROUP BY A.MEMO_ID,B.CM_NO, B.CM_DT,B.NET_AMOUNT,B.CUSTOMER_CODE ,b.location_Code
			
			
			SELECT A.CM_NO ,A.CM_DT ,A.NET_AMOUNT,A.MEMO_ID ,A.CREDIT_AMOUNT, 
			ISNULL(RECEIPT_AMOUNT,0) AS RECEIPT_AMOUNT,
			ISNULL(REFUNDAMOUNT,0) AS REFUNDAMOUNT ,
			DATEDIFF(DD,A.CM_DT,@DTODT) AS AGEING,A.CUSTOMER_CODE ,a.dept_id 
			INTO #TMP_WIZAPPCI_FINAL
			FROM #TMP_WIZAPPCI A
			LEFT OUTER JOIN
			(
			 SELECT A.CM_ID, SUM(RECEIPT_AMOUNT) AS RECEIPT_AMOUNT
			 FROM CMM_CREDIT_RECEIPT A (NOLOCK)
			 JOIN ARC01106 B (NOLOCK)  ON A.ADV_REC_ID=B.ADV_REC_ID
			 WHERE  B.CANCELLED = 0
			 GROUP BY A.CM_ID
			) B ON A.MEMO_ID =B.CM_ID 
			LEFT OUTER JOIN
			(
			 SELECT A.ADJ_MEMO_ID,REFUNDAMOUNT = SUM(ABS(A.AMOUNT)) 
			 FROM PAYMODE_XN_DET A (NOLOCK)
			 JOIN CMM01106 B ON A.MEMO_ID = B.CM_ID
			 WHERE B.CM_ID <> ADJ_MEMO_ID  
			 AND B.CANCELLED = 0
			 GROUP BY A.ADJ_MEMO_ID
			) C ON A.MEMO_ID =C.ADJ_MEMO_ID 
			
	
		SELECT	 A.CM_NO, A.CM_DT,C.USER_CUSTOMER_CODE AS CUSTOMER_ID,C.CUSTOMER_FNAME + ' '+C.CUSTOMER_LNAME AS CUSTOMER_NAME,A.NET_AMOUNT,
				A.CREDIT_AMOUNT,
				ISNULL(RECEIPT_AMOUNT,0) + 
				ISNULL(REFUNDAMOUNT,0) AS RECEIVED_AMOUNT,  
				 A.CREDIT_AMOUNT - ( ISNULL(RECEIPT_AMOUNT,0) + 
				ISNULL(REFUNDAMOUNT,0))  AS PENDING_AMOUNT,
				DATEDIFF(DD,A.CM_DT,@DTODT) AS AGEING
		FROM #TMP_WIZAPPCI_FINAL A
		JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		WHERE  ((@CUTOFF_DATE='' AND A.CM_DT<=@DTODT) OR (ISNULL(@CUTOFF_DATE,'')<>'' AND 
	         A.CM_DT BETWEEN @CUTOFF_DATE AND @DTODT))
		AND @BSHOW = 1 
		AND (@LOC_ID='' OR a.dept_id =@LOC_ID)
		AND (A.CUSTOMER_CODE = @CCUSTOMERCODE OR @CCUSTOMERCODE='')
		AND ((@NMODE=1 AND A.CREDIT_AMOUNT - ( ISNULL(RECEIPT_AMOUNT,0) + 
				ISNULL(REFUNDAMOUNT,0))  > 0 ) OR
			(@NMODE=2 AND A.CREDIT_AMOUNT - ( ISNULL(RECEIPT_AMOUNT,0) + 
				ISNULL(REFUNDAMOUNT,0))= 0 ) OR @NMODE=3)
    END
    
  ELSE
    
    BEGIN
		IF OBJECT_ID('TEMPDB..#TMP_CREDITISSUE','U') IS NOT NULL
	   DROP TABLE #TMP_CREDITISSUE
			   
	SELECT B.CM_NO, B.CM_DT,B.NET_AMOUNT,
	A.MEMO_ID, SUM(A.AMOUNT) AS CREDIT_AMOUNT,B.CUSTOMER_CODE
	INTO #TMP_CREDITISSUE 
	FROM PAYMODE_XN_DET A (NOLOCK)
	JOIN CMM01106 B (NOLOCK) ON A.MEMO_ID=B.CM_ID
	JOIN CUSTDYM C ON B.CUSTOMER_CODE = C.CUSTOMER_CODE

	WHERE B.CANCELLED=0 AND XN_TYPE = 'SLS' 
	AND PAYMODE_CODE = '0000004' 
	AND A.AMOUNT > 0 
	AND ((@CUTOFF_DATE='' AND CM_DT<=@DTODT) OR (ISNULL(@CUTOFF_DATE,'')<>'' AND 
	         CM_DT BETWEEN @CUTOFF_DATE AND @DTODT))
	         AND CANCELLED=0 
	AND (B.CUSTOMER_CODE = @CCUSTOMERCODE OR @CCUSTOMERCODE='')
	AND (@LOC_ID='' OR b.location_Code =@LOC_ID)
	GROUP BY A.MEMO_ID,B.CM_NO, B.CM_DT,B.NET_AMOUNT,B.CUSTOMER_CODE 
	
	
	SELECT A.CM_NO ,A.CM_DT ,A.NET_AMOUNT,A.MEMO_ID ,A.CREDIT_AMOUNT AS AMOUNT, 
	ISNULL(RECEIPT_AMOUNT,0) AS RECEIPT_AMOUNT,
	ISNULL(REFUNDAMOUNT,0) AS REFUNDAMOUNT ,
	DATEDIFF(DD,A.CM_DT,@DTODT) AS AGEING,A.CUSTOMER_CODE 
	INTO #TMP_CREDITISSUE_FINAL
	FROM #TMP_CREDITISSUE A
	LEFT OUTER JOIN
	(
	 SELECT A.CM_ID, SUM(RECEIPT_AMOUNT) AS RECEIPT_AMOUNT
	 FROM CMM_CREDIT_RECEIPT A
	 JOIN ARC01106 B ON A.ADV_REC_ID=B.ADV_REC_ID
	 WHERE  B.CANCELLED = 0
	 GROUP BY A.CM_ID
	) B ON A.MEMO_ID =B.CM_ID 
	LEFT OUTER JOIN
	(
	 SELECT A.ADJ_MEMO_ID,REFUNDAMOUNT = SUM(ABS(A.AMOUNT)) 
	 FROM PAYMODE_XN_DET A (NOLOCK)
	 JOIN CMM01106 B ON A.MEMO_ID = B.CM_ID
	 WHERE B.CM_ID <> ADJ_MEMO_ID  
	 AND B.CANCELLED = 0
	 GROUP BY A.ADJ_MEMO_ID
	) C ON A.MEMO_ID =C.ADJ_MEMO_ID 
	WHERE 
	A.CREDIT_AMOUNT-(ISNULL(RECEIPT_AMOUNT,0)+ISNULL(REFUNDAMOUNT,0))<>0
		 
	IF @NSUMMARY=1
	BEGIN
	    SELECT 'CREDIT ISSUE' AS TYPE,COUNT(*) AS TOTAL_MEMOES,
	    ISNULL(SUM(ISNULL(AMOUNT,0))-(SUM(ISNULL(RECEIPT_AMOUNT,0))+SUM(ISNULL(REFUNDAMOUNT,0))),0) AS AMOUNT,
	    0 AS QUANTITY 
	    FROM #TMP_CREDITISSUE_FINAL
	END
	ELSE
	BEGIN --CHANGE SELECTED COLUMN NAME FROM AMOUNT TO CREDIT_AMOUNT AND RECEIPT_AMOUNT TO RECEIVED_AMOUNT ON 15-MAY-2017
	SELECT TOP  100 CM_NO  AS CM_NO,CM_DT ,NET_AMOUNT,MEMO_ID ,AMOUNT AS [CREDIT_AMOUNT],
	C.CUSTOMER_FNAME + ' '+C.CUSTOMER_LNAME AS CUSTOMER_NAME,C.USER_CUSTOMER_CODE AS CUSTOMER_ID,
	RECEIPT_AMOUNT AS [RECEIVED_AMOUNT] ,
	REFUNDAMOUNT ,
	AGEING,0 AS QUANTITY,
	AMOUNT - (ISNULL(RECEIPT_AMOUNT,0) +ISNULL(REFUNDAMOUNT,0))  AS PENDING_AMOUNT
	FROM #TMP_CREDITISSUE_FINAL A
	JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
	WHERE AGEING>=@NAGEING 
	ORDER BY AGEING DESC
	END
    END
   END_PROC:	 

END
--********************************* END OF PROCEDURE SP_DSR_PENDING_CREDITISSUE
