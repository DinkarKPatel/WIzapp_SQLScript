CREATE PROCEDURE DBKPI_GROUPED_HEADER(@SetupID varchar(100),@DT VARCHAR(10),@SortingID int=0)
AS
BEGIN
SET NOCOUNT ON
IF OBJECT_ID('tempdb..#HEADER') IS NOT NULL DROP TABLE #HEADER
CREATE TABLE #HEADER(MAIN_HEADER VARCHAR(100),HEADER VARCHAR(100),LY_MTD FLOAT,CY_MTD FLOAT,[VARIANCE_MTD] VARCHAR(100),LY_YTD FLOAT
,CY_YTD FLOAT,[VARIANCE_YTD] VARCHAR(100),CATEGORY_NAME VARCHAR(100),MAIN_HEADER_COUNT INT,SNO INT,LY_STD FLOAT,CY_STD FLOAT,[VARIANCE_STD] VARCHAR(100),TXT_COLOR VARCHAR(100))
INSERT #HEADER

EXEC DBKPI_GROUPED @SetupID,@DT,@SortingID

SELECT DISTINCT UPPER(@SetupID) SetupID,HEADER PARA_NAME,CATEGORY_NAME
,(SELECT COUNT(*) FROM #HEADER H2 WHERE H2.SNO=H1.SNO)PARA_COUNT
,PNO=1+(SELECT COUNT(*) FROM #HEADER H2 WHERE H2.SNO<H1.SNO)
,LAST_VAL=(SELECT COUNT(*) FROM #HEADER H2 WHERE H2.SNO<H1.SNO)+(SELECT COUNT(*) FROM #HEADER H2 WHERE H2.SNO=H1.SNO)
,SNO
FROM #HEADER H1 
--WHERE MAIN_HEADER IN ('NRV','GMROI','PROFIT AMOUNT') 
ORDER BY SNO
SET NOCOUNT OFF
END