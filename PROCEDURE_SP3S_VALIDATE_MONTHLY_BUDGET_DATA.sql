CREATE PROCEDURE SP3S_VALIDATE_MONTHLY_BUDGET_DATA
(
	@NSPID INT
)
AS
BEGIN
DECLARE @ERR BIT=0,@ERROR_MSG VARCHAR(1000)=''

SELECT TOP 1 @ERROR_MSG='Ledger '''+isnull(U.AC_NAME,'')+''' does not found' 
FROM MONTHLY_BUDGET_IMPORT_UPLOAD U (NOLOCK)
LEFT JOIN LM01106 J (NOLOCK) ON U.ac_name=J.AC_NAME
WHERE J.AC_CODE IS NULL AND U.SP_ID=@nSPID
IF ISNULL(@ERROR_MSG,'')<>''
   BEGIN
      SET @ERR=1
      GOTO END_PROC
   END

UPDATE U SET  AC_CODE=sm.AC_CODE
FROM MONTHLY_BUDGET_IMPORT_UPLOAD U (NOLOCK) 
JOIN LM01106 SM (NOLOCK)  ON U.AC_NAME=SM.AC_NAME
WHERE U.SP_ID=@nSPID --and isnull(sm.inactive,0)=0



SELECT TOP 1 @ERROR_MSG='Location '''+U.DEPT_ID+''' does not found'  
FROM MONTHLY_BUDGET_IMPORT_UPLOAD U (NOLOCK)
LEFT JOIN LOCATION L (NOLOCK) ON U.DEPT_id=L.DEPT_id
WHERE  L.DEPT_ID IS NULL AND U.SP_ID=@nSPID
IF ISNULL(@ERROR_MSG,'')<>''
BEGIN
    SET @ERR=1
    GOTO END_PROC
END

SELECT TOP 1 @ERROR_MSG='Location '''+U.DEPT_ID+''' is not set for Monthly Budgeting'  
FROM MONTHLY_BUDGET_IMPORT_UPLOAD U (NOLOCK)
JOIN LOCATION L (NOLOCK) ON U.DEPT_id=L.DEPT_id
WHERE  ISNULL(ALLOW_MONTHLY_BUDGET_PC,0)=0 AND U.SP_ID=@nSPID
IF ISNULL(@ERROR_MSG,'')<>''
BEGIN
    SET @ERR=1
    GOTO END_PROC
END


IF OBJECT_ID('TEMPDB..#TMPDUPLICATE','U') IS NOT NULL 
   DROP TABLE #TMPDUPLICATE

SELECT DEPT_ID ,AC_NAME 
INTO #TMPDUPLICATE 
FROM MONTHLY_BUDGET_IMPORT_UPLOAD A (NOLOCK) 
WHERE SP_ID=@nSPID
GROUP BY DEPT_ID ,AC_NAME  
HAVING COUNT(*)>1

IF EXISTS (SELECT TOP 1'U' FROM #TMPDUPLICATE)
BEGIN
   SET @ERR=1
   SET @ERROR_MSG='DUPLICATE RECORD FOUND'
END



END_PROC:  
IF @ERR=0
	SELECT BB.DEPT_ID,BB.FIN_YEAR,BB.MONTH1,BB.MONTH2,BB.MONTH3,BB.MONTH4,BB.MONTH5,BB.MONTH6,BB.MONTH7,BB.MONTH8,BB.MONTH9,BB.MONTH10,BB.MONTH11,BB.MONTH12,
	BB.AC_CODE,SP_ID,LM.AC_NAME,LOC.dept_alias,AREA_NAME,CITY,STATE,''ERRMSG 
	FROM MONTHLY_BUDGET_IMPORT_UPLOAD BB(NOLOCK) 
	JOIN  LOCATION LOC (NOLOCK) ON BB.DEPT_ID = LOC.DEPT_ID 
	JOIN lm01106 lm (NOLOCK) on BB.AC_CODE=lm.AC_CODE
	LEFT OUTER JOIN AREA B (NOLOCK) ON LOC.AREA_CODE= B.AREA_CODE
	LEFT OUTER JOIN CITY C (NOLOCK) ON B.CITY_CODE= C.CITY_CODE
	LEFT OUTER JOIN STATE D (NOLOCK) ON C.STATE_CODE= D.STATE_CODE	
	WHERE BB.SP_ID=@NSPID
ELSE
	BEGIN
	  IF @ERROR_MSG ='DUPLICATE RECORD FOUND'
	  BEGIN
		   SELECT @ERROR_MSG AS ERRMSG,A.DEPT_ID,A.AC_NAME
		   FROM MONTHLY_BUDGET_IMPORT_UPLOAD A (NOLOCK) 
		   JOIN #TMPDUPLICATE B ON A.DEPT_ID=B.DEPT_ID AND A.AC_NAME=B.AC_NAME
		   WHERE SP_ID=@nSPID
	  END
	  ELSE
	   SELECT @ERROR_MSG ERRMSG     

	END 
END
