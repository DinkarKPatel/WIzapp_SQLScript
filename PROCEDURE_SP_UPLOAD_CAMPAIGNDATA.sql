CREATE PROCEDURE SP_UPLOAD_CAMPAIGNDATA  --(LocId 3 digit change by Sanjay:30-10-2024)
(  
  @IMODE INT ,  
  @CWHERE VARCHAR(4000),  
  @BSENDINSTANTCOUPONREQ BIT  
)  
--WITH ENCRYPTION

AS  
BEGIN  
   
   
 DECLARE @CCMD NVARCHAR(4000),@CCUTOFFDATE VARCHAR(20),@CENABLECASHIER VARCHAR(4),@CADDWHERECLAUSE VARCHAR(100),  
   @CJOINSTR VARCHAR(200),@CCURLOCID VARCHAR(4),@CHOLOCID VARCHAR(4),@NLOCCOUNT INT,@CALLDATA VARCHAR(20)  
   
 SELECT @CJOINSTR='',@CADDWHERECLAUSE=''  
   
 SELECT TOP 1 @CCUTOFFDATE=VALUE FROM CONFIG WHERE CONFIG_OPTION='CAMPAIGN_CUTOFF_DATE'  
 SELECT TOP 1 @CENABLECASHIER=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_CASHIER_RECEIPTS'  
   
 SELECT TOP 1 @CHOLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'  
 SELECT TOP 1 @CCURLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'  
   
 SELECT TOP 1 @CALLDATA=ISNULL(VALUE,'') FROM CONFIG WHERE CONFIG_OPTION='UPLOAD_DATA_CAMPAIGN'  
   
   
 SELECT @NLOCCOUNT=COUNT(*) FROM LOCATION  
   
 IF ISNULL(@CCUTOFFDATE,'')=''  AND @IMODE in (1,2) 
  RETURN  
  
 IF @IMODE=1  
 GOTO LBLUPLOAD  
   
 ELSE  
 IF @IMODE=2  
 GOTO LBLMEMODET  
  
 ELSE  
 IF @IMODE=3  
 GOTO LBLLOCATION  
   
 ELSE  
 IF @IMODE=4  
 GOTO LBLSECTION  
   
 ELSE  
 IF @IMODE=5  
 GOTO LBLSUBSECTION  
   
 ELSE  
 IF @IMODE=6  
 GOTO LBLATTRM  
  
   ELSE  
 IF @IMODE=7  
 GOTO LBLMANDATORY  
   
 ELSE  
 IF @IMODE=8  
 GOTO LBLTITLE  
  
 ELSE  
 IF @IMODE=9  
 GOTO LBLCUSTOMER  
   
    ELSE  
 IF @IMODE=10  
 GOTO LBLCMID  
  
 ELSE  
 IF @IMODE=11  
 GOTO LBLCUSTOMERWEB  
  
 ELSE    
 IF @IMODE=12   
 GOTO LBLBILLCOUNT   
    
 ELSE  
 GOTO LAST  
  
   
  
LBLUPLOAD:  
  
    IF ISNULL(@CENABLECASHIER,'')<>'1'  
 BEGIN  
      
 SET @CCMD=N'SELECT  A.CM_ID,A.CM_NO,A.CM_DT,A.NET_AMOUNT,B.MOBILE AS MOBILE,B.CUSTOMER_FNAME ,  
  B.CUSTOMER_LNAME,B.EMAIL,B.CARD_NO,B.DT_CARD_ISSUE,B.DT_CARD_EXPIRY,F.CITY,G.STATE,  
  B.USER_CUSTOMER_CODE,  
  (CASE WHEN A.DISCOUNT_AMOUNT>0 OR H.NET < ISNULL(J.MIN_ENROLL_AMT,0)   
  THEN 0 ELSE B.PRIVILEGE_CUSTOMER END) AS PRIVILEGE_CUSTOMER,  
  B.CUSTOMER_CODE,B.DT_BIRTH,DT_ANNIVERSARY,B.CUSTOMER_TITLE,B.ADDRESS1 AS ADDRESS9   
  FROM CMM01106 A   
  JOIN CUSTDYM B (NOLOCK) ON B.CUSTOMER_CODE = A.CUSTOMER_CODE   
  LEFT OUTER JOIN CAMPAIGN_CMM D (NOLOCK) ON D.CM_ID=A.CM_ID  
  JOIN AREA E (NOLOCK) ON B.AREA_CODE=E.AREA_CODE  
  JOIN CITY F (NOLOCK) ON E.CITY_CODE=F.CITY_CODE  
  JOIN STATE G (NOLOCK) ON F.STATE_CODE=G.STATE_CODE  
  JOIN  
  (  
    SELECT CM_ID,SUM((QUANTITY*MRP-RFNET)) AS DISCOUNT_AMOUNT,SUM(RFNET) AS NET  
    FROM CMD01106 GROUP BY CM_ID  
  )H ON A.CM_ID= H.CM_ID    
  LEFT OUTER JOIN  WIZCLIP_CUSTDYM_PLAN I (NOLOCK) ON B.CUSTOMER_CODE= I.CUSTOMER_CODE   
        LEFT OUTER JOIN  WIZCLIP_PLAN_MST J (NOLOCK) ON I.PLAN_CODE = J.PLAN_CODE  
  WHERE  A.CM_DT>='''+@CCUTOFFDATE+'''' +(CASE WHEN @CALLDATA ='1' THEN '' ELSE  '   
  AND B.MOBILE <> '''' AND B.USER_CUSTOMER_CODE<>''''' END)+ '  
  AND A.CM_MODE=1 AND A.CANCELLED=0 AND D.CM_ID IS NULL  
  AND a.location_code='''+@CCURLOCID +''''  
   
 END  
   
 ELSE  
 --CASHIER RECEIPT  
 IF ISNULL(@CENABLECASHIER,'')='1'  
 BEGIN  
    
  SET @CCMD=N'SELECT  DSM.DS_ID AS CM_ID,DSM.DS_NO AS CM_NO,DSM.DS_DT AS CM_DT,  
  B.MOBILE,B.CUSTOMER_FNAME ,B.CUSTOMER_LNAME ,B.EMAIL,F.CITY,G.STATE,   
  B.CARD_NO,B.DT_CARD_ISSUE,B.DT_CARD_EXPIRY, SUM(A.NET_AMOUNT) AS NET_AMOUNT,  
  B.USER_CUSTOMER_CODE,  
  (CASE WHEN A.DISCOUNT_AMOUNT>0 OR H.NET < ISNULL(J.MIN_ENROLL_AMT,0)   
  THEN 0 ELSE B.PRIVILEGE_CUSTOMER END) AS PRIVILEGE_CUSTOMER,  
  B.CUSTOMER_CODE,B.DT_BIRTH,DT_ANNIVERSARY,B.CUSTOMER_TITLE,B.ADDRESS1 AS ADDRESS9   
  FROM DSM01106 DSM   
  JOIN DSD01106 DSD  ON DSM.DS_ID=DSD.DS_ID  
  JOIN CMM01106 A  ON DSD.CM_ID=A.CM_ID  
  JOIN CUSTDYM B (NOLOCK) ON B.CUSTOMER_CODE = A.CUSTOMER_CODE   
  LEFT OUTER JOIN CAMPAIGN_CMM D (NOLOCK) ON D.CM_ID=A.CM_ID   
  JOIN AREA E (NOLOCK) ON B.AREA_CODE=E.AREA_CODE  
  JOIN CITY F (NOLOCK) ON E.CITY_CODE=F.CITY_CODE  
  JOIN STATE G (NOLOCK) ON F.STATE_CODE=G.STATE_CODE      
  WHERE  A.CM_DT>='''+@CCUTOFFDATE+'''' +(CASE WHEN @CALLDATA ='1' THEN '' ELSE  
  ' AND B.MOBILE <> '''' AND B.USER_CUSTOMER_CODE<>''''' END)+ '  
  AND D.CM_ID IS NULL  
  AND DSD.CANCELLED=0 AND A.CANELLED=0 AND a.location_code='''+@CCURLOCID+'''    
  GROUP BY DSM.DS_ID ,DSM.DS_NO ,DSM.DS_DT , B.MOBILE,B.CUSTOMER_FNAME ,B.CUSTOMER_LNAME,B.EMAIL,  
  B.PRIVILEGE_CUSTOMER,B.CARD_NO,B.DT_CARD_ISSUE,B.DT_CARD_EXPIRY,F.CITY,G.STATE,B.USER_CUSTOMER_CODE'  
    
 END  
   
 PRINT @CCMD  
 EXEC SP_EXECUTESQL @CCMD  
       
 GOTO LAST  
  
  
LBLMEMODET:  
  
    IF ISNULL(@CENABLECASHIER,'')<>'1'  
 BEGIN  
  
  SET  @CCMD=N'SELECT  A.CM_ID,C.PRODUCT_CODE ,C.RFNET AS NET,C.QUANTITY,C.ROW_ID,  
               (C.QUANTITY*C.MRP-C.RFNET) AS DISCOUNT_AMOUNT  
  FROM CMM01106 A   
  JOIN CUSTDYM B (NOLOCK) ON B.CUSTOMER_CODE = A.CUSTOMER_CODE  
  JOIN CMD01106 C  ON C.CM_ID = A.CM_ID    
  LEFT OUTER JOIN CAMPAIGN_CMM D (NOLOCK) ON D.CM_ID=A.CM_ID  
  WHERE  A.CM_DT>='''+@CCUTOFFDATE+'''' +(CASE WHEN @CALLDATA ='1' THEN ''   
  ELSE  ' AND B.MOBILE <> '''' AND B.USER_CUSTOMER_CODE<>''''' END)+ '  
  AND  A.CM_MODE=1 AND A.CANCELLED=0  
  AND D.CM_ID IS NULL AND a.location_code='''+@CCURLOCID+''''  
   
 END  
   
 ELSE  
 IF ISNULL(@CENABLECASHIER,'')=1   
 BEGIN  
  SET  @CCMD=N'SELECT  DSM.DS_ID AS CM_ID,C.PRODUCT_CODE ,C.RFNET AS NET,C.QUANTITY,C.ROW_ID ,  
             (C.QUANTITY*C.MRP-C.RFNET) AS DISCOUNT_AMOUNT   
  FROM DSM01106 DSM   
  JOIN DSD01106 DSD  ON DSM.DS_ID=DSD.DS_ID   
  JOIN CMD01106 C   ON DSD.CM_ID = C.CM_ID  
  JOIN CMM01106 D   ON C.CM_ID = D.CM_ID    
  JOIN CUSTDYM E  (NOLOCK) ON D.CUSTOMER_CODE = E.CUSTOMER_CODE    
  LEFT OUTER JOIN CAMPAIGN_CMM F (NOLOCK)  ON F.CM_ID=D.CM_ID  
     WHERE  D.CM_DT>='''+@CCUTOFFDATE+''''   
     +(CASE WHEN @CALLDATA ='1' THEN '' ELSE  ' AND E.MOBILE <> '''' AND E.USER_CUSTOMER_CODE<>''''' END)+ '  
  AND  DSD.CANCELLED=0  AND D.CANCELLED=0     
  AND F.CM_ID IS NULL AND d.location_code='''+@CCURLOCID+''''  
 END  
   
 PRINT @CCMD  
 EXEC SP_EXECUTESQL @CCMD  
   
 GOTO LAST  
  
LBLLOCATION:  
   
    SELECT A.DEPT_ID AS ORG_DEPT_ID,A.DEPT_ID,A.DEPT_NAME,CITY,STATE,A.DEPT_ALIAS  ,Wizclip_dept_id,
	isnull(enable_epaper_billing,0) as  enable_epaper_billing
    FROM LOC_VIEW A (NOLOCK)   
   -- LEFT OUTER JOIN CAMPAIGN_LOCATION B (NOLOCK) ON A.DEPT_ID = B.DEPT_ID    
    WHERE INACTIVE =0 AND A.DEPT_ID= A.MAJOR_DEPT_ID --AND B.DEPT_ID  IS NULL  
   
 GOTO LAST  
    
LBLSECTION:  
    
    SELECT  A.SECTION_CODE,A.SECTION_NAME,A.LAST_UPDATE   
    FROM SECTIONM A (NOLOCK)   
    LEFT OUTER JOIN CAMPAIGN_SECTIONM B (NOLOCK) ON A.SECTION_CODE = B.SECTION_CODE    
    WHERE A.INACTIVE =0  AND (A.LAST_UPDATE> B.LAST_UPDATE) OR( B.SECTION_CODE  IS NULL)  
      
    GOTO LAST  
      
      
LBLSUBSECTION:  
    
    SELECT  A.SECTION_CODE,A.SUB_SECTION_CODE,A.SUB_SECTION_NAME,A.LAST_UPDATE   
    FROM SECTIOND A (NOLOCK)   
    LEFT OUTER JOIN CAMPAIGN_SECTIOND B (NOLOCK) ON A.SUB_SECTION_CODE = B.SUB_SECTION_CODE    
    WHERE A.INACTIVE =0  AND (A.LAST_UPDATE> B.LAST_UPDATE) OR( B.SUB_SECTION_CODE  IS NULL)  
  
    GOTO LAST  
      
      
LBLATTRM:  
    
    SELECT  A.ATTRIBUTE_CODE,A.ATTRIBUTE_NAME,A.LAST_UPDATE   
    FROM ATTRM A (NOLOCK)   
    LEFT OUTER JOIN CAMPAIGN_ATTRM B (NOLOCK) ON A.ATTRIBUTE_CODE = B.ATTRIBUTE_CODE    
    WHERE A.INACTIVE =0  AND (A.LAST_UPDATE> B.LAST_UPDATE) OR( B.ATTRIBUTE_CODE  IS NULL)  
  
    GOTO LAST  
      
LBLMANDATORY:  
  
 SELECT * FROM WIZCLIP_CUSTDYM_MANDATORY_COLS (NOLOCK)  
 WHERE LAST_UPDATE BETWEEN @CWHERE AND @CWHERE   
   
 GOTO LAST   
   
LBLTITLE:  
  
 SELECT *  FROM WIZCLIP_PLAN_MST (NOLOCK)  
 WHERE LAST_UPDATE BETWEEN @CWHERE AND @CWHERE   
   
 GOTO LAST      
  
  
LBLCUSTOMER:    
  
    SELECT  CUSTOMER_CODE,ISNULL(MOBILE ,'') AS MOBILE,LAST_UPDATE,PRIVILEGE_CUSTOMER  
    FROM CUSTDYM WHERE MOBILE <> '' AND INACTIVE=0  
      
    GOTO LAST  
  
LBLCMID:    
  
  SELECT CM_ID  FROM CMM01106  A (NOLOCK)      
  WHERE A.CM_ID= @CWHERE  
    
  GOTO LAST  
  
LBLCUSTOMERWEB:  
  
 SELECT CUSTOMER_CODE,CUSTOMER_TITLE,CUSTOMER_FNAME,CUSTOMER_LNAME,   
     ADDRESS1 AS ADDRESS9,USER_CUSTOMER_CODE AS MOBILE,EMAIL,  
     DT_BIRTH,DT_ANNIVERSARY,MOBILE AS SECONDARY_MOBILE,F.CITY,G.STATE,PIN  
 FROM CUSTDYM A (NOLOCK)  
 JOIN AREA E (NOLOCK) ON A.AREA_CODE=E.AREA_CODE  
 JOIN CITY F (NOLOCK) ON E.CITY_CODE=F.CITY_CODE  
 JOIN STATE G (NOLOCK) ON F.STATE_CODE=G.STATE_CODE  
 WHERE  USER_CUSTOMER_CODE<> ''  
    
    
 GOTO LAST  
  
  
LBLBILLCOUNT:  
   
   DECLARE @CGRPCODE VARCHAR(10)   
  
   SELECT TOP 1 @CGRPCODE=ISNULL(VALUE,'') FROM CONFIG WHERE CONFIG_OPTION='CAMPAIGN_GRP_CODE'        
     
   IF @CGRPCODE = 'B7'  
     
  BEGIN  
          
   SET @CCMD=N'SELECT  a.location_code AS DEPT_ID,A.CM_DT,COUNT(A.CM_NO) AS BILLSCNT,SUM(A.NET_AMOUNT) AS AMOUNT,    
     ISNULL(B.BILLSCNT,0) AS UPLOADEDBILLS,SUM(C.DISCOUNT_AMOUNT) AS DIS_AMT   
     FROM CMM01106 A (NOLOCK)    
     LEFT OUTER JOIN    
     (    
      SELECT DEPT_ID ,CM_DT,BILLSCNT     
      FROM CAMPAIGN_CMM_UPLOAD (NOLOCK)    
     ) B ON a.location_code= B.DEPT_ID AND B.CM_DT= A.CM_DT    
  
     JOIN    
     (    
      SELECT A.CM_ID,SUM(A.DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT   
      FROM CMD01106 A(NOLOCK)   
      JOIN CMM01106 B (NOLOCK) ON A.CM_ID= B.CM_ID  
      WHERE B.CM_MODE=1  AND CANCELLED =0    
      GROUP BY A.CM_ID    
     )C ON A.CM_ID= C.CM_ID     
  
     WHERE CM_MODE=1 AND CANCELLED =0    
     AND A.CUSTOMER_CODE =''000000000000'' AND A.NET_AMOUNT>=5000   
     AND A.DISCOUNT_AMOUNT =0 AND C.DISCOUNT_AMOUNT=0 AND A.CM_DT>='''+@CCUTOFFDATE+'''   
     GROUP  BY a.location_code ,A.CM_DT,B.BILLSCNT      
     HAVING ((COUNT(A.CM_NO)<> ISNULL(B.BILLSCNT,0)))    
     ORDER BY a.location_code ,A.CM_DT'    
      
  END   
   
  ELSE    
   
  BEGIN   
  
 SET @CCMD=N'SELECT  a.location_code AS DEPT_ID,A.CM_DT,COUNT(A.CM_NO) AS BILLSCNT,SUM(A.NET_AMOUNT) AS AMOUNT,    
      ISNULL(B.BILLSCNT,0) AS UPLOADEDBILLS    
    FROM CMM01106 A (NOLOCK)    
    LEFT OUTER JOIN    
    (    
   SELECT DEPT_ID ,CM_DT,BILLSCNT     
   FROM CAMPAIGN_CMM_UPLOAD (NOLOCK)    
    ) B ON a.location_code= B.DEPT_ID AND B.CM_DT= A.CM_DT        
       
   LEFT OUTER JOIN (SELECT TOP 1 CAST(ISNULL(A.VALUE,0) AS NUMERIC(10,2)) AS VALUE FROM CONFIG A WHERE CONFIG_OPTION=''MIN_POINTS_ENROLL_AMT'') J ON 1=1    
   LEFT OUTER JOIN (SELECT TOP 1 A.VALUE FROM CONFIG A WHERE CONFIG_OPTION=''POINTS_CAMPAIGN_APPLICABLE'') K ON 1=1    
   LEFT OUTER JOIN (SELECT TOP 1 CAST(ISNULL(A.VALUE,0) AS NUMERIC(10,2)) AS VALUE FROM CONFIG A WHERE CONFIG_OPTION=''MIN_OTHER_ENROLL_AMT'') L ON 1=1    
   LEFT OUTER JOIN (SELECT TOP 1 A.VALUE FROM CONFIG A WHERE CONFIG_OPTION=''OTHER_CAMPAIGN_APPLICABLE'') M ON 1=1    
   WHERE CM_MODE=1 AND CANCELLED =0    
   AND A.CUSTOMER_CODE =''000000000000'' AND A.CM_DT>='''+@CCUTOFFDATE+''' AND A.NET_AMOUNT>=     
   (CASE WHEN ISNULL(J.VALUE,0)=0 THEN ISNULL(L.VALUE,0) ELSE ISNULL(J.VALUE,0) END)    
   GROUP  BY a.location_code ,A.CM_DT,B.BILLSCNT,K.VALUE,J.VALUE    
   HAVING (COUNT(A.CM_NO)<> ISNULL(B.BILLSCNT,0))    
   ORDER BY a.location_code ,A.CM_DT '    
  
  END  
          
  PRINT @CCMD  
  EXEC SP_EXECUTESQL @CCMD   
       
  GOTO LAST    
     
LAST:  
  
END
