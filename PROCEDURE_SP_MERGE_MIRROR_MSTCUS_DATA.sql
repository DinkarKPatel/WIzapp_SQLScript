CREATE PROCEDURE SP_MERGE_MIRROR_MSTCUS_DATA
(
    @CSOURCEDB VARCHAR(200)
   ,@CMERGEDB VARCHAR(200)
   ,@CMEMOID VARCHAR(100)=''
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
       DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
              ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
	          ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	          ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100),@CXNTYPE VARCHAR(10)
	          ,@CCURDEPTID VARCHAR(10),@BPURLOC VARCHAR(10)
	         
      DECLARE @TXNSMERGEINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(40))
       
    BEGIN TRY
	BEGIN TRANSACTION
	
	SET @CSTEP=10	

	
	
	PRINT 'REGIONM'
	SET @CSTEP=20
	SET @CTABLENAME='REGIONM'
	SET @CTMP_TABLENAME='MSTCUS_REGIONM_MIRROR'
	SET @CKEYFIELD='REGION_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						      ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1
	
	PRINT 'STATE'
	SET @CSTEP=30
	SET @CTABLENAME='STATE'
	SET @CTMP_TABLENAME='MSTCUS_STATE_MIRROR'
	SET @CKEYFIELD='STATE_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						      ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1
	
	PRINT 'CITY'
	SET @CSTEP=40
	SET @CTABLENAME='CITY'
	SET @CTMP_TABLENAME='MSTCUS_CITY_MIRROR'
	SET @CKEYFIELD='CITY_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						      ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1
							  
	
	PRINT 'AREA'
	SET @CSTEP=50
	SET @CTABLENAME='AREA'
	SET @CTMP_TABLENAME='MSTCUS_AREA_MIRROR'
	SET @CKEYFIELD='AREA_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						      ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1						  
	
	PRINT 'CUSTDYM'
	SET @CSTEP=60
	SET @CTABLENAME='CUSTDYM'
	SET @CTMP_TABLENAME='MSTCUS_CUSTDYM_MIRROR'
	SET @CKEYFIELD='CUSTOMER_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						      ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1	
	
							  						  
	END TRY
	BEGIN CATCH
		SET @CERRMSG='P:SP_MERGE_MIRROR_MSTCUS_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH
	EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
	END
	ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK   

    IF ISNULL(@CERRMSG,'')='' 
	BEGIN   
	    
		DELETE FROM MSTCUS_REGIONM_MIRROR
		DELETE FROM MSTCUS_STATE_MIRROR
		DELETE FROM MSTCUS_CITY_MIRROR
		DELETE FROM MSTCUS_AREA_MIRROR
		DELETE FROM MSTCUS_CUSTDYM_MIRROR

	   
	END


END
--- 'END OF PROCEDURE SP_MERGE_MIRROR_MSTCUS_DATA'
