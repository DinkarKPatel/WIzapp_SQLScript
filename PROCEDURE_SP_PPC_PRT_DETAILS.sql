CREATE PROC SP_PPC_PRT_DETAILS       
(      
	@NMODE INT,            
	@CRM_ID VARCHAR(100)='' ,
	@CFIN_YEAR VARCHAR(5)=''
)     
AS BEGIN          
 
 IF @NMODE=1
    GOTO LBLRMM
 ELSE IF @NMODE=2
    GOTO LBL_RMDET
 ELSE IF @NMODE=3
    GOTO LBL_DETVIEW
 ELSE
 GOTO END_PROC   
 
 
     
----1.BIND PONUMBER            
LBLRMM:            
   SELECT RM_ID ,RM_NO FROM PPC_RMM01106    
   WHERE (@CFIN_YEAR='' OR FIN_YEAR=@CFIN_YEAR)       

GOTO END_PROC           
            
----2.BIND GRID            
LBL_RMDET:           
	
	SELECT RM_NO,REPLACE(CONVERT(VARCHAR(11),A.RM_DT,106),' ','-') AS RM_DT,LM.AC_CODE,AC_NAME ,
	      TOTAL_AMOUNT,SUBTOTAL,
           A.DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,OTHER_CHARGES,
           FREIGHT,CANCELLED,APPROVED,A.RM_ID,
           FIN_YEAR,REMARKS,PARTY_STATE_CODE,OTHER_CHARGES_GST_PERCENTAGE,
		   OTHER_CHARGES_HSN_CODE,
			OTHER_CHARGES_IGST_AMOUNT,
			OTHER_CHARGES_CGST_AMOUNT,
			OTHER_CHARGES_SGST_AMOUNT,
			FREIGHT_GST_PERCENTAGE,
			FREIGHT_HSN_CODE,
			FREIGHT_IGST_AMOUNT,
			FREIGHT_CGST_AMOUNT,
			FREIGHT_SGST_AMOUNT,
			TOTAL_QUANTITY,
			OH_TAX_METHOD,
			FREIGHT_TAXABLE_VALUE,
			OTHER_CHARGES_TAXABLE_VALUE,
			DO_NOT_CALC_GST_OH,
			LM.ADDRESS0 + ' ' + LM.ADDRESS1 + ' ' + LM.ADDRESS2 + ' ' + LM.AREA_NAME + ' ' + LM.CITY + ' ' +      
            LM.STATE + ' '  + LM.MOBILE + ' ' AS AC_ADDRESS ,
            A.ROUND_OFF ,
            GST_AMOUNT,
            IGST_AMOUNT,
            CGST_AMOUNT,
            SGST_AMOUNT
	FROM PPC_RMM01106 A
	JOIN 
	(  
	  SELECT  B.RM_ID,
	      SUM(ISNULL(B.IGST_AMOUNT ,0) +ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0)) AS GST_AMOUNT,
	      SUM(ISNULL(B.IGST_AMOUNT ,0)) AS IGST_AMOUNT,
	      SUM(ISNULL(B.CGST_AMOUNT ,0)) AS CGST_AMOUNT,
	      SUM(ISNULL(B.SGST_AMOUNT ,0)) AS SGST_AMOUNT,
	      SUM(ISNULL(B.XN_VALUE_WITHOUT_GST,0)) AS TAXABLE_VALUE
	  FROM PPC_RMD01106 B
	  GROUP BY B.RM_ID
	
	)B ON A.RM_ID=B.RM_ID
	JOIN LMV01106 LM ON LM.AC_CODE=A.AC_CODE
	WHERE (@CRM_ID='' OR A.RM_ID=@CRM_ID) 
	ORDER BY RM_ID DESC    
	          
GOTO END_PROC             
 
----3.SEARCH BY PO NUMBER OR STATUS            
LBL_DETVIEW:
   
	SELECT A.RM_NO,REPLACE(CONVERT(VARCHAR(11),A.RM_DT,106),' ','-') AS RM_DT,
	    LM.AC_NAME ,REPLACE(CONVERT(VARCHAR(11),B.BILL_DT,106),' ','-') AS INV_DT ,
	    B.HSN_CODE,B.GST_PERCENTAGE,B.IGST_AMOUNT,
		B.CGST_AMOUNT,B.SGST_AMOUNT,B.XN_VALUE_WITHOUT_GST,B.XN_VALUE_WITH_GST,B.PRODUCT_CODE,
		B.QUANTITY,B.PURCHASE_PRICE,B.AMOUNT,B.ROW_ID,A.RM_ID,B.SRNO,B.BILL_NO AS INV_NO,
		B.REMARKS,B.INVOICE_QUANTITY,B.SCHEME_QUANTITY,
		B.BILL_LEVEL_TAX_METHOD,B.RATE,B.TAX_ROUND_OFF,
		B.RMMDISCOUNTAMOUNT,B.PRODUCT_UID  ,
		ART.ARTICLE_CODE ,
		ART.ARTICLE_NO,
		ART.ARTICLE_NAME,
		SD.SUB_SECTION_NAME,
		SM.SECTION_NAME,
		P1.PARA1_CODE ,P1.PARA1_NAME ,	   
		P2.PARA2_CODE ,P2.PARA2_NAME ,
		P3.PARA3_CODE ,P3.PARA3_NAME ,
		UOM.UOM_NAME,
		B.DISCOUNT_PERCENTAGE,
		B.DISCOUNT_AMOUNT,
		B.GROSS_PURCHASE_PRICE,
		PUR_DISCOUNT_PERCENTAGE,
		PUR_DISCOUNT_AMOUNT,
		PUR_PURCHASE_PRICE,
		CAST(0 AS NUMERIC(10,2)) AS TAX_PERCENTAGE,
		CAST(0 AS NUMERIC(10,2)) AS TAX_AMOUNT,
		CAST('' AS VARCHAR(100)) AS IMAGE_1,
		ISNULL(B.CURRENCY_CODE ,'') AS CURRENCY_CODE,
		CAST('' AS VARCHAR(100)) AS CURRENCY_NAME,
		UOM.UOM_CODE,
		PMT.QUANTITY_IN_STOCK ,
		SKU.MRP,
		B.AMOUNT AS AMOUNT	
	FROM PPC_RMM01106 A
	JOIN PPC_RMD01106 B ON A.RM_ID=B.RM_ID
	JOIN PPC_SKU SKU ON B.PRODUCT_UID=SKU.PRODUCT_UID 
	JOIN PPC_PMT PMT ON B.PRODUCT_UID=PMT.PRODUCT_UID 
	JOIN ARTICLE ART ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
	JOIN SECTIOND SD ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE 
	JOIN SECTIONM SM ON SM.SECTION_CODE =SD.SECTION_CODE 
	JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
	JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE=P1.PARA1_CODE  
	JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE=P2.PARA2_CODE 
	JOIN PARA3 P3 (NOLOCK) ON SKU.PARA3_CODE=P3.PARA3_CODE
	JOIN UOM ON UOM.UOM_CODE =ART.UOM_CODE  
	WHERE (@CRM_ID='' OR A.RM_ID=@CRM_ID)     
GOTO END_PROC
 
END_PROC:       
            
END
