CREATE PROCEDURE SP_PRD_WIP_STATUS_REPORT
(
  @CMERCHANT_CODE VARCHAR(MAX)='',
  @CARTICLE_CODE VARCHAR(MAX)='',    
  @CAC_CODE VARCHAR(MAX)='',    
  @CAC_CODE_NOTIN VARCHAR(10)=''
)
AS
BEGIN

   	DECLARE @DTSQL NVARCHAR(MAX),@CCOLNAME VARCHAR(MAX),@CMERCHANT_FILTER VARCHAR(MAX),
	        @CART_STATUS varchar(20),@AAC_STATUS varchar(20)
   	
   	 IF @CMERCHANT_CODE=''  
     BEGIN  
		 SET @CMERCHANT_FILTER=''  
		 SET @CMERCHANT_CODE='IN('''')'  
     END  
     ELSE   
     BEGIN  
         SET @CMERCHANT_FILTER='LATER'  
     END  
 
         
	IF @CARTICLE_CODE=''    
	BEGIN    
	   SET @CART_STATUS=''    
	   SET @CARTICLE_CODE='IN('''')'    
	END    
	ELSE     
	BEGIN    
	   SET @CART_STATUS='LATER'    
	END    
    
	IF @CAC_CODE=''    
	BEGIN    
	   SET @AAC_STATUS=''    
	   SET @CAC_CODE='IN('''')'    
	END    
	ELSE     
	BEGIN    
	   SET @AAC_STATUS='LATER'    
	END    
    
    
     
	IF OBJECT_ID('TEMPDB..#TMPDETAILS','U') IS NOT NULL
	   DROP TABLE #TMPDETAILS

	;WITH CTE AS
	(
	SELECT BM.ORDER_ID AS F_ORDER_ID,
	       BM.ORDER_NO,BM.ORDER_DT,
		   OD.ARTICLE_CODE AS ARTICLE_SET_CODE,
		   OM.MEMO_NO AS WO_NO,
		   CONVERT(VARCHAR,OM.MEMO_DT,105) AS WO_DT,
		   RECEIPT_NO,
		   RECEIPT_DT,
		   D.JOB_CODE AS REC_JOB_CODE,
		   ISNULL(A.ITEM_MERCHANT_CODE,BD.ITEM_MERCHANT_CODE ) AS MERCHANT_CODE ,
		   ISNULL(BM.AC_CODE,OM.AC_CODE) AS AC_CODE,
		   OD.PARA1_CODE,
		   A.* ,SR=ROW_NUMBER () OVER (PARTITION BY A.PRODUCT_CODE ORDER BY D.RECEIPT_DT DESC,RECEIPT_ID  DESC)  ,
		   AM.AGENCY_NAME
	FROM JOBWORK_PMT  A (NOLOCK)
	JOIN ORD_PLAN_BARCODE_DET OBD (NOLOCK) ON OBD.PRODUCT_CODE =A.PRODUCT_CODE 
	JOIN ORD_PLAN_DET OD (NOLOCK) ON OBD.REFROW_ID =OD.ROW_ID 
	JOIN ORD_PLAN_MST OM (NOLOCK) ON OD.MEMO_ID =OM.MEMO_ID 
	LEFT JOIN
	(
	 SELECT  B.AGENCY_CODE ,A.JOB_CODE,A.PRODUCT_CODE,
			 B.RECEIPT_NO  AS RECEIPT_NO,B.RECEIPT_DT  AS RECEIPT_DT,
			 A.RECEIPT_ID 
	 FROM JOBWORK_RECEIPT_DET   A (NOLOCK)
	 JOIN JOBWORK_ISSUE_DET  ID (NOLOCK) ON A.REF_ROW_ID =ID.ROW_ID 
	 JOIN JOBWORK_ISSUE_MST  IM (NOLOCK) ON IM.ISSUE_ID  =ID.ISSUE_ID 
	 JOIN JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID  =B.RECEIPT_ID
	 WHERE B.CANCELLED=0 AND IM.CANCELLED=0
	 GROUP BY B.AGENCY_CODE ,A.JOB_CODE,A.PRODUCT_CODE,
			 B.receipt_no ,B.receipt_dt ,A.receipt_id 
	) D ON   A.JOB_CODE =D.JOB_CODE AND A.PRODUCT_CODE=D.PRODUCT_CODE
	LEFT JOIN PRD_AGENCY_MST  AM ON AM.AGENCY_CODE=D.AGENCY_CODE
	LEFT JOIN BUYER_ORDER_DET BD (NOLOCK) ON BD.row_id =OD.WOD_ROW_ID 
	LEFT JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID =ISNULL(A.ORDER_ID ,BD.order_id )
	WHERE OM.CANCELLED =0 AND ISNULL(BM.CANCELLED,0)=0

	)

	SELECT * INTO #TMPDETAILS FROM CTE WHERE SR=1 AND QUANTITY_IN_STOCK >0 AND ISNULL(REC_JOB_CODE,'')<>''
    
    
    
    
	IF OBJECT_ID ('TEMPDB..#TMPWIP','U') IS NOT NULL
	   DROP TABLE #TMPWIP

 SELECT    CAST('' AS VARCHAR(100)) AS  PARTY_NAME,
		   CAST('' AS VARCHAR(100)) AS ORDER_NO ,
		   CONVERT(VARCHAR(10),'') AS ORDER_DT,
		   A.WO_NO,
		   A.WO_DT,
		   CAST('' AS VARCHAR(100))  AS ARTICLE_NO ,
		   CAST('' AS VARCHAR(100)) AS MERCHANT,
		   A.AGENCY_NAME ,
		   A.PRODUCT_CODE ,
		   A.RECEIPT_NO ,
		   A.RECEIPT_DT ,
		   A.QUANTITY_IN_STOCK,
		   CAST('' AS VARCHAR(100)) AS JOB_NAME ,
		   CAST('' AS VARCHAR(100)) AS PARA1_NAME 
	INTO #TMPWIP
	FROM #TMPDETAILS A
	WHERE 1=2

 SET @DTSQL =N'SELECT LM.AC_NAME AS PARTY_NAME,
		   A.ORDER_NO ,CONVERT(VARCHAR,A.ORDER_DT ,105) AS ORDER_DT,
		   A.WO_NO,
		   A.WO_DT,
		   ART.ARTICLE_NO AS ARTICLE_NO ,
		   EMP.EMP_NAME AS MERCHANT,
		   A.AGENCY_NAME ,
		   A.PRODUCT_CODE ,
		   A.RECEIPT_NO ,
		   A.RECEIPT_DT ,
		   A.QUANTITY_IN_STOCK,
		   JOBS.JOB_NAME ,
		   P1.PARA1_NAME
	FROM #TMPDETAILS A
	JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
	JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =A.ARTICLE_SET_CODE 
	LEFT JOIN EMPLOYEE EMP (NOLOCK) ON EMP.EMP_CODE =A.MERCHANT_CODE 
	JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE =A.JOB_CODE 
	JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=A.PARA1_CODE
	WHERE ('''+@CMERCHANT_FILTER+'''='''' OR ITEM_MERCHANT_CODE  '+@CMERCHANT_CODE+' ) 
	and ('''+@CART_STATUS+'''='''' OR ART.ARTICLE_CODE  '+@CARTICLE_CODE+' ) 
	and ('''+@AAC_STATUS+'''='''' OR LM.AC_CODE  '+@CAC_CODE+' ) 
	AND ('''+RTRIM(LTRIM(@CAC_CODE_NOTIN))+'''='''' OR LM.AC_CODE<>'''+@CAC_CODE_NOTIN+''')

	 '
	PRINT @DTSQL
	INSERT INTO #TMPWIP( PARTY_NAME,ORDER_NO ,ORDER_DT,WO_NO,WO_DT, ARTICLE_NO ,MERCHANT,AGENCY_NAME ,
		   PRODUCT_CODE ,RECEIPT_NO ,RECEIPT_DT ,QUANTITY_IN_STOCK,JOB_NAME,PARA1_NAME )
	EXEC SP_EXECUTESQL @DTSQL

	SELECT @CCOLNAME=ISNULL(@CCOLNAME+',','')+QUOTENAME(JOB_NAME) FROM #TMPWIP
	GROUP BY JOB_NAME
	ORDER BY JOB_NAME DESC


	SET @DTSQL=N'SELECT PARTY_NAME,ORDER_NO ,ORDER_DT,
		 WO_NO,WO_DT,ARTICLE_NO AS ARTICLE_NO ,
		 MERCHANT,AGENCY_NAME ,PRODUCT_CODE ,
		 PARA1_NAME AS FG_COLOR,
		 RECEIPT_NO,RECEIPT_DT AS R1 ,CONVERT(VARCHAR,RECEIPT_DT,105) AS RECEIPT_DT ,'+@CCOLNAME+'
	FROM #TMPWIP A 
	PIVOT (SUM(QUANTITY_IN_STOCK) FOR  JOB_NAME IN('+@CCOLNAME+')) AS P1
	ORDER BY R1  '
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL


--	IF OBJECT_ID('TEMPDB..#TMPDETAILS','U') IS NOT NULL
--	   DROP TABLE #TMPDETAILS

--	;WITH CTE AS
--	(
--	SELECT ISNULL(A.ORDER_ID,ORD.ORDER_ID) AS F_ORDER_ID,
--		   WO .ARTICLE_SET_CODE,
--		   WO.MEMO_NO AS WO_NO,
--		   CONVERT(VARCHAR,WO.MEMO_DT,105) AS WO_DT,
--		   RECEIPT_NO,
--		   --CONVERT(VARCHAR,RECEIPT_DT,105) AS RECEIPT_DT,
--		   RECEIPT_DT,
--		   A.* ,SR=ROW_NUMBER () OVER (PARTITION BY A.PRODUCT_CODE ORDER BY D.LAST_UPDATE DESC)  ,
--		   AM.AGENCY_NAME
--	FROM PRD_UPCPMT A
--	LEFT JOIN
--	(
--	 SELECT  B.AGENCY_CODE ,JOB_CODE,C.PRODUCT_CODE,B.LAST_UPDATE,
--			 B.MEMO_NO AS RECEIPT_NO,B.MEMO_DT AS RECEIPT_DT
--	 FROM PRD_AGENCY_MATERIAL_RECEIPT_DET  A
--	 JOIN PRD_AGENCY_ISSUE_MATERIAL_DET ID ON A.REF_ROW_ID =ID.ROW_ID 
--	 JOIN PRD_AGENCY_ISSUE_MATERIAL_MST IM ON IM.MEMO_ID =ID.MEMO_ID 
--	 JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST  B ON A.MEMO_ID =B.MEMO_ID
--	 JOIN PRD_AGENCY_MATERIAL_RECEIPT_UPC  C ON A.MEMO_ID =C.MEMO_ID 
--	 WHERE B.CANCELLED=0
--	 GROUP BY B.AGENCY_CODE ,JOB_CODE,C.PRODUCT_CODE,B.LAST_UPDATE,B.MEMO_NO ,B.MEMO_DT 
--	) D ON   A.JOB_CODE =D.JOB_CODE AND A.PRODUCT_CODE=D.PRODUCT_CODE
--	LEFT JOIN PRD_AGENCY_MST  AM ON AM.AGENCY_CODE=D.AGENCY_CODE
--	JOIN PRD_WO_ORDERS ORD ON ORD.MEMO_ID=A.WO_ID
--	JOIN PRD_WO_MST WO ON WO .MEMO_ID =ORD .MEMO_ID 
--	WHERE ISNULL(WO.MARK_AS_COMPLETED,0)<>2

--	)

--	SELECT * INTO #TMPDETAILS FROM CTE WHERE SR=1 AND QUANTITY_IN_STOCK >0 AND ISNULL(JOB_CODE,'')<>''


--	IF OBJECT_ID ('TEMPDB..#TMPWIP','U') IS NOT NULL
--	   DROP TABLE #TMPWIP

-- SELECT   CAST('' AS VARCHAR(100)) AS  PARTY_NAME,
--		   CAST('' AS VARCHAR(100)) AS ORDER_NO ,
--		   CONVERT(VARCHAR(10),'') AS ORDER_DT,
--		   A.WO_NO,
--		   A.WO_DT,
--		   CAST('' AS VARCHAR(100))  AS ARTICLE_NO ,
--		   CAST('' AS VARCHAR(100)) AS MERCHANT,
--		   A.AGENCY_NAME ,
--		   A.PRODUCT_CODE ,
--		   A.RECEIPT_NO ,
--		   A.RECEIPT_DT ,
--		   A.QUANTITY_IN_STOCK,
--		   CAST('' AS VARCHAR(100)) AS JOB_NAME 
--	INTO #TMPWIP
--	FROM #TMPDETAILS A
--	WHERE 1=2

-- SET @DTSQL =N'SELECT LM.AC_NAME AS PARTY_NAME,
--		   BM.ORDER_NO ,CONVERT(VARCHAR,BM.ORDER_DT ,105) AS ORDER_DT,
--		   A.WO_NO,
--		   A.WO_DT,
--		   ART.ARTICLE_NO AS ARTICLE_NO ,
--		   EMP.EMP_NAME AS MERCHANT,
--		   A.AGENCY_NAME ,
--		   A.PRODUCT_CODE ,
--		   A.RECEIPT_NO ,
--		   A.RECEIPT_DT ,
--		   A.QUANTITY_IN_STOCK,
--		   JOBS.JOB_NAME 
--	FROM #TMPDETAILS A
--	JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID =A.F_ORDER_ID 
--	JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =BM.AC_CODE 
--	JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =A.ARTICLE_SET_CODE 
--	JOIN
--	(
--	 SELECT ORDER_ID ,ITEM_MERCHANT_CODE
--	 FROM BUYER_ORDER_DET  
--	 WHERE ('''+@CMERCHANT_FILTER+'''='''' OR ITEM_MERCHANT_CODE  '+@CMERCHANT_CODE+' ) 
--	 GROUP BY ORDER_ID ,ITEM_MERCHANT_CODE

--	) DET ON A.F_ORDER_ID =DET.ORDER_ID 
--	JOIN EMPLOYEE EMP (NOLOCK) ON EMP.EMP_CODE =DET.ITEM_MERCHANT_CODE 
--		JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE =A.JOB_CODE '
--	PRINT @DTSQL
--	INSERT INTO #TMPWIP( PARTY_NAME,ORDER_NO ,ORDER_DT,WO_NO,WO_DT, ARTICLE_NO ,MERCHANT,AGENCY_NAME ,
--		   PRODUCT_CODE ,RECEIPT_NO ,RECEIPT_DT ,QUANTITY_IN_STOCK,JOB_NAME)
--	EXEC SP_EXECUTESQL @DTSQL

----SELECT * FROM #TMPWIP
----ORDER BY RECEIPT_DT
----RETURN

--	SELECT @CCOLNAME=ISNULL(@CCOLNAME+',','')+QUOTENAME(JOB_NAME) FROM #TMPWIP
--	GROUP BY JOB_NAME
--	ORDER BY JOB_NAME DESC

--	SET @DTSQL=N'SELECT PARTY_NAME,ORDER_NO ,ORDER_DT,
--		 WO_NO,WO_DT,ARTICLE_NO AS ARTICLE_NO ,
--		 MERCHANT,AGENCY_NAME ,PRODUCT_CODE ,
--		 PARA1_NAME AS FG_COLOR,
--		 RECEIPT_NO,RECEIPT_DT AS R1 ,CONVERT(VARCHAR,RECEIPT_DT,105) AS RECEIPT_DT ,'+@CCOLNAME+'
--	FROM #TMPWIP A 
--	JOIN 
--	( SELECT PRODUCT_CODE AS P_CODE,PARA1_CODE AS C_CODE
--	  FROM  PRD_UPCPMT PMT 
--	) PMT ON PMT.P_CODE=A.PRODUCT_CODE
--	JOIN PARA1 P1 ON P1.PARA1_CODE=PMT.C_CODE
--	PIVOT (SUM(QUANTITY_IN_STOCK) FOR  JOB_NAME IN('+@CCOLNAME+')) AS P1
--	ORDER BY R1  '
--	PRINT @DTSQL
--	EXEC SP_EXECUTESQL @DTSQL

END
