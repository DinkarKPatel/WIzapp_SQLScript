CREATE PROCEDURE SP3S_GETSOR_EMAILDATA
@dFromDt DATETIME,
@dToDt DATETIME
AS
BEGIN

	DECLARE @IMAXLEVEL NUMERIC(3,0)

	SELECT @IMAXLEVEL=MAX(LEVEL_NO) 
	FROM XN_APPROVAL_CHECKLIST_LEVELS 
	WHERE XN_TYPE='EOSSSOR' AND INACTIVE=0
		
	IF EXISTS(SELECT TOP 1 'U' FROM XN_APPROVAL_CHECKLIST_LEVELS  WHERE XN_TYPE='EOSSSOR' AND INACTIVE=0 AND ISNULL(AC_POSTING,0)<>0)
	BEGIN
		SELECT @IMAXLEVEL=LEVEL_NO
		FROM XN_APPROVAL_CHECKLIST_LEVELS 
		WHERE XN_TYPE='EOSSSOR' AND INACTIVE=0 AND ISNULL(AC_POSTING,0)<>0
	END
						
	SET @IMAXLEVEL=ISNULL(@IMAXLEVEL,0)

	select ac_name,convert(bit,0) chk,memo_id,memo_no,memo_dt,PERIOD_FROM,PERIOD_TO,payment_advice_amount,email_sent_on,c.E_MAIL
	from eosssorm  a (NOLOCK)
	JOIN lm01106 b (NOLOCK) ON a.ac_code=b.ac_code 
	JOIN lmp01106 c (NOLOCK) ON a.ac_code=c.ac_code 
	WHERE memo_dt between @dFromDt AND @dToDt AND cancelled=0
	AND a.approvedlevelno>=@IMAXLEVEL AND a.AgnstSupplier=1

END