create PROCEDURE SAVETRAN_SCHEME_SETUP
(
	  @NUPDATEMODE  NUMERIC(1,0),   --@NUPDATEMODE: 1 - ADD, 2- EDIT, 3-DELETE, 4-INACTIVE, 5-DROP TEMPORARY TABLES
	  @NSCHEMEUPDATEMODE NUMERIC(1,0)=1,--@NSCHEMEUPDATEMODE = 1 SCHEME SET 2-SCHEME ONLY USE AB_HO
	  @NSPID    VARCHAR(50),      
	  @CMEMONO_VAL  VARCHAR(40)='',
	  @CDETROW_ID	 VARCHAR(50)='',
	  @NCOPYSCHEMEMODE INT=0
)
AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@CSTEP VARCHAR(10),@CKEYFIELD VARCHAR(50),@CMEMONO VARCHAR(50),
			@CERRORMSG VARCHAR(1000),@NSAVETRANLOOP BIT,@CKEYFIELDVAL VARCHAR(50),@NMEMONOLEN INT,@CMEMONOVAL VARCHAR(20),@CLOCATIONID VARCHAR(10),
			@CDET_ROW_ID VARCHAR(50),@CPROMID VARCHAR(1000),@NBUYFILTERMODE INT,@NGETFILTERMODE INT,
			@BHAPPYHOURSACTIVE BIT,@CMEMONOPARA VARCHAR(100),@NSCHEMEMODE INT,@CTEMPMASTERTABLE VARCHAR(200),
			@cMrpRoundingRs VARCHAR(10),@cMrpRoundingMode VARCHAR(2),@cMrpRoundingLevel VARCHAR(2),
			@cFilterCondition VARCHAR(500)
	
	SET @CMEMONOPARA=@CMEMONO_VAL
			
	DECLARE @CHAPPYHOURSTABLE VARCHAR(1000),@CTEMHAPPYHOURSTABLENAME VARCHAR(1000),
	@CTEMPHAPPYHOURSTABLE VARCHAR(1000),@CTEMPDETAILTABLE VARCHAR(500)

	DECLARE @CSCH0002TABLE VARCHAR(1000),@CSCH0007TABLE VARCHAR(1000),@CSCH0012TABLE VARCHAR(1000),@CTEMPSCH0002TABLENAME VARCHAR(1000),
	@CTEMPSCH0007TABLENAME VARCHAR(1000),@CTEMPSCH0012TABLENAME VARCHAR(1000),@CTEMPSCH0014TABLENAME VARCHAR(1000),
	@CTEMPSCH0002TABLE VARCHAR(1000),@CTEMPSCH0007TABLE VARCHAR(1000),@CTEMPSCH0014TABLE VARCHAR(1000),@CTEMPSCH0012TABLE VARCHAR(1000),
    @CSCH0006TABLE VARCHAR(1000),@CTEMPSCH0006TABLENAME VARCHAR(1000),@CTEMPSCH0006TABLE VARCHAR(1000),
    @CSCHBMPLAMOUNTTABLE VARCHAR(1000),@CTEMPSCHBMPLAMOUNTTABLENAME VARCHAR(1000),
	@CSCHSLSBCGETTABLE VARCHAR(1000),@CSCHSLSARTGETTABLE VARCHAR(1000),@CSCHSLSPARAGETTABLE VARCHAR(1000),
	@CTEMPSCHSLSBCGETTABLENAME VARCHAR(1000),@CTEMPSCHSLSARTGETTABLENAME VARCHAR(1000), @CTEMPSCHSLSPARAGETTABLENAME VARCHAR(1000),
	@CTEMPSCHSLSBCGETTABLE VARCHAR(1000),@CTEMPSCHSLSPARAGETTABLE VARCHAR(1000),@CTEMPSCHSLSARTGETTABLE VARCHAR(1000),@CCOPYSCHEME VARCHAR(2),
	@CSCHSLSALLMSTTABLE VARCHAR(200),@CTEMPSCHSLSALLMSTTABLENAME VARCHAR(500),@CTEMPSCHSLSALLMSTTABLE VARCHAR(500),
	@CSCHSLSALLMSTCONFIGTABLE VARCHAR(200),@CTEMPSCHSLSALLMSTCONFIGTABLENAME VARCHAR(500),@CTEMPSCHSLSALLMSTCONFIGTABLE VARCHAR(500),
	@CSCHOPTPARASTABLE  VARCHAR(200),@CTEMPSCHOPTPARASTABLENAME VARCHAR(500),@CTEMPSCHOPTPARASTABLE VARCHAR(500),
	@CENABLEOPTIMIZEDSCHEMES VARCHAR(2),@NOPTPARACNT INT,@CSCHBMPLQTYTABLE VARCHAR(500),@CTEMPSCHBMPLQTYTABLENAME VARCHAR(500),
	@CTEMPSCHBMPLQTYTABLE VARCHAR(500)
	
			
BEGIN TRY
		BEGIN TRANSACTION

		SET @CSTEP = 10
		
		IF @NUPDATEMODE=5
			GOTO END_PROC
	
		IF @NUPDATEMODE=3
			GOTO LBLDELETESCHEME			
			
		SET @CSTEP = 15     
		
		-- TEMPORARY DATABASE Discarded now onwards as per Meeting on 30-10-2020 mentioned in Client issues List

			
		SET @CSTEP = 25       
		
		SET @NMEMONOLEN = 7 
		
	
		SELECT TOP 1 @CLOCATIONID  = value FROM config (NOLOCK) WHERE config_option='ho_location_id'


		IF ISNULL(@CLOCATIONID,'')=''
		 BEGIN
			SET @CERRORMSG =' LOCATION ID CAN NOT BE BLANK  '  
			GOTO END_PROC    
		 END


		   		
		SET @CSTEP = 28
		

		
	    SET @CKEYFIELD = 'MEMO_NO' 

		SELECT TOP 1 @CENABLEOPTIMIZEDSCHEMES=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_OPTIMIZED_EOSS_SCHEMES'	

	    IF(@NUPDATEMODE=4)
	    BEGIN
			SET @CSTEP = 32 
			IF ISNULL(@CMEMONOPARA,'') = ''  
			BEGIN  
				SET @CERRORMSG='P:SAVETRAN_SCHEME_SETUP, STEP: '+@CSTEP+', MESSAGE: MEMO_NO CANNOT BE BLANK FOR INACTIVE MODE....'  
				GOTO END_PROC      
			END 
			
			SET @CSTEP = 35				
		    UPDATE scheme_setup_mst WITH (ROWLOCK) SET  INACTIVE = 1 WHERE MEMO_NO=@CMEMONOPARA
			GOTO END_PROC
		END

LBLDELETESCHEME:
		
		IF @NUPDATEMODE=3 
		BEGIN
			SET @CSTEP = 38
			IF ISNULL(@CMEMONOPARA,'') = ''  
			BEGIN  
				SET @CERRORMSG='P:SAVETRAN_SCHEME_SETUP, STEP: '+@CSTEP+', MESSAGE: MEMO_NO CANNOT BE BLANK FOR DELETE MODE....'  
				GOTO END_PROC      
			END
			
			SET @CSTEP = 40
					    
			DELETE A FROM SCHEME_SETUP_SLSBC A WITH (ROWLOCK)  
			JOIN SCHEME_SETUP_DET  B (NOLOCK) ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
			WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			DELETE A FROM SCHEME_SETUP_SLSBC_GET A WITH (ROWLOCK) 
			JOIN SCHEME_SETUP_DET  B (NOLOCK) ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			SET @CSTEP = 42
			DELETE A FROM SCHEME_SETUP_SLSART A WITH (ROWLOCK) 
			JOIN SCHEME_SETUP_DET  B (NOLOCK) ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			DELETE A FROM SCHEME_SETUP_SLSART_GET A  WITH (ROWLOCK) 
			JOIN SCHEME_SETUP_DET  B (NOLOCK) ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			SET @CSTEP = 44
			DELETE A FROM SCHEME_SETUP_SLSPARA A WITH (ROWLOCK) JOIN SCHEME_SETUP_DET  B  (NOLOCK)
			ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			DELETE A FROM SCHEME_SETUP_SLSPARA_GET A  WITH (ROWLOCK)  JOIN SCHEME_SETUP_DET  B (NOLOCK) 
			ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			SET @CSTEP = 46
			DELETE A FROM SCHEME_SETUP_SCH0002_1 A WITH (ROWLOCK)  JOIN SCHEME_SETUP_DET B (NOLOCK) 
			ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			DELETE A FROM SCHEME_SETUP_SCH0006_1 A WITH (ROWLOCK)  JOIN SCHEME_SETUP_DET B (NOLOCK) 
			ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			SET @CSTEP = 48
			DELETE A FROM SCHEME_SETUP_SCH0007_1 A WITH (ROWLOCK)  JOIN SCHEME_SETUP_DET B (NOLOCK) 
			ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')

			SET @CSTEP = 50
			DELETE A FROM SCHEME_SETUP_SCH0014_1 A WITH (ROWLOCK)  JOIN SCHEME_SETUP_DET B (NOLOCK) 
			ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			SET @CSTEP = 53
			DELETE A FROM SCHEME_SETUP_SCH0012 A WITH (ROWLOCK)  JOIN SCHEME_SETUP_DET B (NOLOCK) 
			ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')

			SET @CSTEP = 56
			DELETE A FROM SCHEME_SETUP_SCHB001_1 A WITH (ROWLOCK)  JOIN SCHEME_SETUP_DET B (NOLOCK) 
			ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')

			SET @CSTEP = 59
			DELETE A FROM SCHEME_SETUP_SCHB002_1 A WITH (ROWLOCK)  JOIN SCHEME_SETUP_DET B (NOLOCK) 
			ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
						
			DELETE A FROM SCHEME_SETUP_SLSEAN A WITH (ROWLOCK)   JOIN SCHEME_SETUP_DET  B (NOLOCK) 
			ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			DELETE A FROM SCHEME_SETUP_SLSEAN_GET A WITH (ROWLOCK)   JOIN SCHEME_SETUP_DET  B (NOLOCK) 
			ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')

			SET @CSTEP = 50
			DELETE A FROM SCHEME_SETUP_ALLMASTERS_CONFIG A WITH (ROWLOCK)   JOIN SCHEME_SETUP_DET  B (NOLOCK) 
			ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')

			DELETE A FROM SCHEME_SETUP_ALLMASTERS A WITH (ROWLOCK)   JOIN SCHEME_SETUP_DET  B (NOLOCK) 
			ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')

			DELETE A FROM scheme_setup_weekdays_details A WITH (ROWLOCK)   JOIN SCHEME_SETUP_DET  B (NOLOCK) 
			ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')

			DELETE A FROM SCHEME_SETUP_OPTIMIZED_PARA A WITH (ROWLOCK)   JOIN SCHEME_SETUP_DET  B (NOLOCK) 
			ON  A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID WHERE B.MEMO_NO = @CMEMONOPARA AND (B.ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
						
			
			DELETE FROM SCHEME_SETUP_DET WITH (ROWLOCK)  WHERE MEMO_NO = @CMEMONOPARA  AND (ROW_ID=@CDETROW_ID OR @CDETROW_ID='')
			
			
			IF @NSCHEMEUPDATEMODE = 1
			BEGIN
				SET @CSTEP = 52
				DELETE FROM SCHEME_SETUP_LOC WITH (ROWLOCK)  WHERE MEMO_NO = @CMEMONOPARA
				DELETE FROM SCHEME_SETUP_HAPPYHOURS WITH (ROWLOCK)  WHERE MEMO_NO = @CMEMONOPARA
				DELETE FROM SCHEME_SETUP_MST WITH (ROWLOCK)  WHERE MEMO_NO = @CMEMONOPARA				
			END

			SET @CMEMONOVAL=@CMEMONOPARA
			
			GOTO END_PROC
		END
		
		SET @CSTEP = 55
		UPDATE SCHNEW_SCHEME_SETUP_SLSBC_upload WITH (ROWLOCK) SET item_dept_id='' WHERE sp_id=@nSpId AND item_dept_id IS NULL
		UPDATE SCHNEW_SCHEME_SETUP_SLSBC_get_upload WITH (ROWLOCK) SET item_dept_id='' WHERE sp_id=@nSpId AND item_dept_id IS NULL

		----- Start of Commenting Copy scheme mode for Tempshall do it later on
		IF @NCOPYSCHEMEMODE>0
		BEGIN
			print 'Call temp scheme copy'
			SET @CSTEP = 60

			EXEC SP3S_CREATE_TEMP_SCHEMECOPY
			@nSpId=@nSpId,
			@CLOCATIONID=@CLOCATIONID,
			@NCOPYSCHEMEMODE=@NCOPYSCHEMEMODE,
			@cErrormsg=@cErrormsg OUTPUT

			IF ISNULL(@cErrormsg,'')=''
			BEGIN
				SET @nSpId=@nSpid+'Copy'
				SET @NSCHEMEUPDATEMODE=1

				--if @@spid=100
				--	select 'check copied schemes para',* from SCHNEW_SCHEME_SETUP_allmasters_UPLOAD where sp_id=@nSpId
			END
			ELSE
				GOTO END_PROC	
		END
		ELSE
		IF @NCOPYSCHEMEMODE=0
		BEGIN
			SET @CSTEP = 96	
			UPDATE schnew_scheme_Setup_det_upload with (rowlock) SET OLD_ROW_ID=ROW_ID WHERE sp_id=@nSpid
		END
		
LBLADDSCHEME:
		
		SET @CSTEP = 100
		SELECT TOP 1 @BHAPPYHOURSACTIVE=HAPPY_HOURS_RESTRICTION_APPLICABLE,@CMEMONOVAL=MEMO_NO 
		FROM SCHNEW_SCHEME_SETUP_mst_UPLOAD (NOLOCK) WHERE SP_ID=@NsPID
			    
	    IF @NUPDATEMODE=1 OR @NSCHEMEUPDATEMODE=2
	    BEGIN
			SET @CSTEP = 105
			
			SELECT @CPROMID=PROMOTIONAL_SCHEME_ID,@NBUYFILTERMODE=FILTER_MODE,@NGETFILTERMODE=GET_FILTER_MODE,
			@NSCHEMEMODE=SCHEME_MODE FROM  SCHNEW_SCHEME_SETUP_det_UPLOAD (NOLOCK) WHERE SP_ID=@NsPID
		END

			
		IF @NUPDATEMODE = 1 
		BEGIN
			IF  @NSCHEMEUPDATEMODE = 1
			BEGIN	
				SET @CMEMONOVAL=''
				
				SET @CSTEP = 112  --GENERATING NEW KEY      
				SELECT TOP 1 @CKEYFIELDVAL = ISNULL(memo_no,'LATER') FROM  
				SCHNEW_SCHEME_SETUP_mst_UPLOAD (NOLOCK) WHERE SP_ID=@NsPID AND memo_no='LATER'
			      
				SET @CSTEP = 115 
				IF LTRIM(RTRIM(ISNULL(@CKEYFIELDVAL,'LATER'))) = 'LATER'      
				BEGIN      
				   SET @CSTEP = 120 
				   -- GENERATING NEW MEMO NO        
				   SET @NSAVETRANLOOP=0      
				   WHILE @NSAVETRANLOOP=0      
				   BEGIN 
				        
						 
						 SET @CSTEP=130     
						 EXEC GETNEXTKEY 'scheme_setup_mst', @CKEYFIELD, @NMEMONOLEN, @CLOCATIONID, 1,      
							  '',0, @CMEMONOVAL OUTPUT       
					     
						 SET @CSTEP=140  
						 IF ISNULL(@CMEMONOVAL,'')='' 
						 BEGIN  
								SET @CERRORMSG = 'P:SAVETRAN_SCHEME_SETUP, STEP: '+@CSTEP+', MESSAGE: ERROR GENERATING MEMO_NO.'      
								GOTO END_PROC  
						 END  
					     
						 SET @CSTEP=150     
						 IF EXISTS ( SELECT memo_no FROM SCHEME_SETUP_MST (NOLOCK)
								   WHERE memo_no=@CMEMONOVAL)      
							SET @NSAVETRANLOOP=0      
						ELSE      
							SET @NSAVETRANLOOP=1
						 
					END 
				END

				SET @CSTEP=160
				--UPDATE TEMP MASTER TABLE
				UPDATE SCHNEW_SCHEME_SETUP_mst_UPLOAD WITH (ROWLOCK) 
				SET memo_no = @CMEMONOVAL WHERE SP_ID=@NsPID
  
			   
				SET @CSTEP=170
				--UPDATE TEMP LOC TABLE
				UPDATE SCHNEW_SCHEME_SETUP_loc_UPLOAD WITH (ROWLOCK) 
				SET memo_no = @CMEMONOVAL WHERE SP_ID=@NsPID

			END
						
			
			IF @BHAPPYHOURSACTIVE=1 OR @NCOPYSCHEMEMODE>0
			BEGIN
				SET @CSTEP=172
				--UPDATE TEMP HAPPYHOURS
				UPDATE SCHNEW_SCHEME_SETUP_HAPPYHOURS_upload WITH (ROWLOCK) 
				SET memo_no = @CMEMONOVAL,ROW_ID = NEWID() WHERE SP_ID=@NsPID

		    END
        
        END ----- IF @NUPDATEMODE = 1
		
		---SELECT @NBUYFILTERMODE,@NCOPYSCHEMEMODE
		---- DELETE DUPLICATE ENTRIES OF BARCODE IN THE INCOMING DATA
		IF @NBUYFILTERMODE>1 OR @NCOPYSCHEMEMODE>0
		BEGIN
			
			SET @CSTEP=174
			UPDATE SCHNEW_SCHEME_SETUP_SLSBC_upload WITH (ROWLOCK) 
			SET SOURCE_TYPE=1 WHERE  SP_ID=@NsPID and ISNULL(SOURCE_TYPE,0)=0		

			SET @CSTEP=175
			SELECT product_code,ISNULL(item_dept_id,'') item_dept_id into #sch_slsbc_dup from 
			SCHNEW_SCHEME_SETUP_SLSBC_upload (NOLOCK) WHERE SP_ID=@nSpId
			group by product_code,ISNULL(item_dept_id,'') having count(product_code)>1

			SET @CSTEP=175.5
			IF EXISTS (select top 1 * from #sch_slsbc_dup)
				DELETE A FROM SCHNEW_SCHEME_SETUP_SLSBC_upload A with (rowLOCK)
				JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD C (NOLOCK) ON C.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID AND c.sp_id=a.sp_id
				JOIN #sch_slsbc_dup d on d.product_code=a.product_code AND a.item_dept_id=isnull(a.item_dept_id,'')
				WHERE C.sp_id = @nSpId AND A.ROW_ID<>
				(SELECT TOP 1 D.ROW_ID FROM SCHNEW_SCHEME_SETUP_SLSBC_upload D (NOLOCK)
				JOIN SCHNEW_SCHEME_SETUP_det_upload E (NOLOCK) ON E.ROW_ID=D.SCHEME_SETUP_DET_ROW_ID AND d.sp_id=e.sp_id
				JOIN #sch_slsbc_dup f on f.product_code=d.product_code AND f.item_dept_id=d.item_dept_id
				WHERE E.sp_id = @nSpId AND LEFT(D.ROW_ID,5)='LATER'
				AND D.PRODUCT_CODE=A.PRODUCT_CODE AND d.source_type=a.source_type )
			
			SET @CSTEP=177
			SELECT article_code into #sch_slsart_dup from 
			SCHNEW_SCHEME_SETUP_SLSArt_upload (NOLOCK) WHERE SP_ID=@nSpId
			group by article_code having count(article_code)>1

			SET @CSTEP=178
			IF EXISTS (select top 1 * from #sch_slsart_dup)
				DELETE A FROM SCHNEW_SCHEME_SETUP_SLSART_upload A WITH  (ROWLOCK)
				JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD C (NOLOCK) ON C.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID AND c.sp_id=a.sp_id
				JOIN #sch_slsart_dup f on f.article_code=a.article_code
				WHERE C.sp_id = @nSpId AND A.ROW_ID<>
				(SELECT TOP 1 D.ROW_ID FROM SCHNEW_SCHEME_SETUP_SLSART_upload D (NOLOCK)
				JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD E ON E.ROW_ID=D.SCHEME_SETUP_DET_ROW_ID AND e.sp_id=d.sp_id
				JOIN #sch_slsart_dup f on f.article_code=d.article_code
				WHERE E.sp_id = @nSpId AND LEFT(D.ROW_ID,5)='LATER'
				AND D.ARTICLE_CODE=A.ARTICLE_CODE )
			
									
		END

		IF @NGETFILTERMODE>1 OR @NCOPYSCHEMEMODE>0
		BEGIN
			SET @CSTEP=182

			SELECT PRODUCT_CODE,ISNULL(item_dept_id,'') item_dept_id into #sch_slsget_bc_dup from 
			SCHNEW_SCHEME_SETUP_SLSBC_get_upload (NOLOCK) WHERE SP_ID=@nSpId
			group by PRODUCT_CODE,ISNULL(item_dept_id,'') having count(PRODUCT_CODE)>1

			SET @CSTEP=183
			IF EXISTS (select top 1 * from #sch_slsget_bc_dup)
				DELETE A FROM SCHNEW_SCHEME_SETUP_SLSBC_get_upload A with (rowLOCK)
				JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD C (NOLOCK) ON C.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID AND c.sp_id=a.sp_id
				JOIN #sch_slsget_bc_dup d on d.product_code=a.product_code AND d.item_dept_id=isnull(a.item_dept_id,'')
				WHERE C.sp_id = @nSpId AND A.ROW_ID<>
				(SELECT TOP 1 D.ROW_ID FROM SCHNEW_SCHEME_SETUP_SLSBC_get_upload D (NOLOCK)
				JOIN SCHNEW_SCHEME_SETUP_det_upload E (NOLOCK) ON E.ROW_ID=D.SCHEME_SETUP_DET_ROW_ID AND d.sp_id=e.sp_id
				JOIN #sch_slsget_bc_dup f on f.product_code=d.product_code
				WHERE E.sp_id = @nSpId AND LEFT(D.ROW_ID,5)='LATER'
				AND D.PRODUCT_CODE=A.PRODUCT_CODE AND d.source_type=a.source_type )
			
			SET @CSTEP=184
			SELECT article_code into #sch_slsart_get_dup from 
			SCHNEW_SCHEME_SETUP_SLSART_get_upload (NOLOCK) WHERE SP_ID=@nSpId
			group by article_code having count(article_code)>1
						
			SET @CSTEP=185
			IF EXISTS (select top 1 * from #sch_slsart_get_dup)
				DELETE A FROM SCHNEW_SCHEME_SETUP_SLSART_get_upload A WITH  (ROWLOCK)
				JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD C (NOLOCK) ON C.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID AND c.sp_id=a.sp_id
				JOIN #sch_slsart_get_dup f on f.article_code=a.article_code
				WHERE C.sp_id = @nSpId AND A.ROW_ID<>
				(SELECT TOP 1 D.ROW_ID FROM SCHNEW_SCHEME_SETUP_SLSART_get_upload D (NOLOCK)
				JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD E ON E.ROW_ID=D.SCHEME_SETUP_DET_ROW_ID AND e.sp_id=d.sp_id
				JOIN #sch_slsart_get_dup f on f.article_code=d.article_code
				WHERE E.sp_id = @nSpId AND LEFT(D.ROW_ID,5)='LATER'
				AND D.ARTICLE_CODE=A.ARTICLE_CODE )
			
									
		END	
		
		IF @NUPDATEMODE = 1
		BEGIN
			SET @CSTEP=190
			--UPDATE TEMP DETAIL TABLE 
			UPDATE SCHNEW_SCHEME_SETUP_DET_UPLOAD with (rowlock) SET memo_no = @CMEMONOVAL,
			ROW_ID = NEWID() WHERE sp_id=@nSpid

		END
		        
	    IF ISNULL(@CPROMID,'') NOT IN ('SCHB001','SCHB002')
	    BEGIN
		      
		   IF @NBUYFILTERMODE=2 OR @NCOPYSCHEMEMODE>0
		   BEGIN	
			   SET @CSTEP=210
						
			  UPDATE A SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
				SCHNEW_SCHEME_SETUP_slsbc_UPLOAD A with (rowlock)
				JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
				WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'
		   END

		   IF @NGETFILTERMODE=2 OR @NCOPYSCHEMEMODE>0
		   BEGIN			   
			   SET @CSTEP=215

			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_slsbc_get_UPLOAD A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'
		   END

		   IF @NBUYFILTERMODE=3 OR @NCOPYSCHEMEMODE>0
		   BEGIN			   			   
			   SET @CSTEP=220

			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_slsart_UPLOAD A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID  AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'
		   END
		   
		   	
		   IF @NGETFILTERMODE=3 OR @NCOPYSCHEMEMODE>0
		   BEGIN			   
			   SET @CSTEP=224


			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_slsart_get_UPLOAD A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'
		   END


		   IF @NBUYFILTERMODE=5 OR @NCOPYSCHEMEMODE>0
		   BEGIN	

	 		   SET @CSTEP=236
			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_slsean_UPLOAD A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'

		   END

		   IF @NGETFILTERMODE=5 OR @NCOPYSCHEMEMODE>0
		   BEGIN	

	 		  SET @CSTEP=240
			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_slsean_get_UPLOAD A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'
		   END

		   IF @NBUYFILTERMODE=6 OR @NCOPYSCHEMEMODE>0 OR (@CPROMID='SCH0015' AND @NBUYFILTERMODE=3)
		   BEGIN			   			   
			   SET @CSTEP=250

			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_allmasters_UPLOAD A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'

			  SET @CSTEP=255
			  UPDATE A with (rowlock) SET SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_allmasters_config_UPLOAD A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid 
				
		   END
		   		   	
		   IF ISNULL(@CPROMID,'')IN('SCH0002','SCH0011') OR @NCOPYSCHEMEMODE>0
		   BEGIN

	   		  SET @CSTEP=260
			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_SCH0002_1_upload A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'
		   END
		   			   
		   IF ISNULL(@CPROMID,'')='SCH0007' OR @NCOPYSCHEMEMODE>0
		   BEGIN
		   
			  SET @CSTEP=270
			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_SCH0007_1_upload A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'
			   
		   END

		   IF ISNULL(@CPROMID,'')='SCH0012' OR @NCOPYSCHEMEMODE>0
		   BEGIN
		   
			  SET @CSTEP=275
			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_SCH0012_upload A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'

		   END

		   IF ISNULL(@CPROMID,'')='SCH0014' OR @NCOPYSCHEMEMODE>0
		   BEGIN
		   
			  SET @CSTEP=277
			  UPDATE A with (rowlock) SET SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_SCH0014_1_upload A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid 

		   END
		   		   		   
		   IF ISNULL(@CPROMID,'')='SCH0006' OR @NCOPYSCHEMEMODE>0		     
		   BEGIN
   		   	  
			  SET @CSTEP=280
			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_SCH0006_1_upload A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'

		   END
		   
	   END
	   ELSE
	   BEGIN
		   IF ISNULL(@CPROMID,'')='SCHB001'
		   BEGIN
   			   SET @CSTEP = 300
			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_SCHB001_1_upload A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'

		   END
		   ELSE
		   IF ISNULL(@CPROMID,'')='SCHB002'
		   BEGIN
   			   SET @CSTEP = 302
			  UPDATE A with (rowlock) SET ROW_ID = NEWID(),SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
			  SCHNEW_SCHEME_SETUP_SCHB002_1_upload A
			  JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
			  WHERE a.sp_id=@nSpid AND LEFT(A.ROW_ID,5) = 'LATER'
		   END		   
	   END

	   IF @NSCHEMEMODE=1 AND @NCOPYSCHEMEMODE=0
	   BEGIN	
	       SET @CSTEP=304
		   UPDATE B WITH (ROWLOCK) SET LAST_UPDATE=GETDATE() FROM SCHEME_SETUP_SLSBC A (NOLOCK)
			JOIN SCHEME_SETUP_DET B  ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID
			JOIN SCHNEW_SCHEME_SETUP_SLSBC_upload C (NOLOCK)  ON C.PRODUCT_CODE=A.PRODUCT_CODE AND ISNULL(a.item_dept_id,'')=c.item_dept_id
			JOIN SCHNEW_SCHEME_SETUP_DET_upload D (NOLOCK)  ON D.ROW_ID=C.SCHEME_SETUP_DET_ROW_ID AND c.sp_id=d.sp_id
		   WHERE c.sp_id=@nSpid AND B.SCHEME_MODE=1 AND D.MEMO_NO=B.MEMO_NO

		   SET @CSTEP=305
		   DELETE A FROM SCHEME_SETUP_SLSBC A WITH (ROWLOCK)
			JOIN SCHEME_SETUP_DET B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID
			JOIN SCHNEW_SCHEME_SETUP_SLSBC_upload C (NOLOCK)  ON C.PRODUCT_CODE=A.PRODUCT_CODE AND ISNULL(a.item_dept_id,'')=c.item_dept_id
			JOIN SCHNEW_SCHEME_SETUP_DET_upload D(NOLOCK)  ON D.ROW_ID=C.SCHEME_SETUP_DET_ROW_ID AND d.sp_id=c.sp_id
			WHERE c.sp_id=@nSpid and B.SCHEME_MODE=1 AND D.MEMO_NO=B.MEMO_NO
	   END		     

	   
	   IF @NUPDATEMODE = 2
	   BEGIN
			IF @NSCHEMEUPDATEMODE = 1 
			BEGIN
					SET @CSTEP=310
					IF ISNULL(@CMEMONOVAL,'') = '' OR LEFT(@CMEMONOVAL,5) = 'LATER' 
					BEGIN 
						SET @CERRORMSG='P:SAVETRAN_SCHEME_SETUP, STEP: '+@CSTEP+', MESSAGE: MEMO_NO CANNOT BE BLANK.'
						GOTO END_PROC
					END
					
					SET @CSTEP=320
					DELETE FROM SCHEME_SETUP_LOC WITH (ROWLOCK) WHERE memo_no =@CMEMONOVAL
					

					IF @BHAPPYHOURSACTIVE=1
					BEGIN
						SET @CSTEP=330
						UPDATE SCHNEW_SCHEME_SETUP_HAPPYHOURS_upload  WITH (ROWLOCK) SET ROW_ID = NEWID() 
						WHERE sp_id=@nSpId AND LEFT(ROW_ID,5) = 'LATER'
					END	
					
					UPDATE SCHEME_SETUP_MST  WITH (ROWLOCK) SET LAST_UPDATE=GETDATE() WHERE MEMO_NO = @CMEMONOVAL
					
			END ----- IF @NSCHEMEUPDATEMODE =1
		    ELSE 
		    IF @NSCHEMEUPDATEMODE =2
		    BEGIN
			    
				IF @NCOPYSCHEMEMODE=0
				BEGIN	

					SET @CSTEP=350
					DELETE A FROM SCHEME_SETUP_SLSBC A WITH (ROWLOCK) 
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK)
					ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 
					
					SET @CSTEP=360
					DELETE A FROM SCHEME_SETUP_SLSBC_GET A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 

					SET @CSTEP=370
					DELETE A FROM SCHEME_SETUP_SLSART A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 

					SET @CSTEP=380
					DELETE A FROM SCHEME_SETUP_SLSART_get A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 

					SET @CSTEP=410
					DELETE A FROM SCHEME_SETUP_SCH0002_1 A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 

					SET @CSTEP=420
					DELETE A FROM SCHEME_SETUP_SCH0006_1 A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 

					DELETE A FROM SCHEME_SETUP_SCH0002_1 A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 

					SET @CSTEP=425
					DELETE A FROM SCHEME_SETUP_SCH0007_1 A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 

					SET @CSTEP=427
					DELETE A FROM SCHEME_SETUP_SCH0012 A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 

					SET @CSTEP=428
					DELETE A FROM SCHEME_SETUP_SCH0014_1 A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 
										
					SET @CSTEP=430
					DELETE A FROM SCHEME_SETUP_SCHB001_1 A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 

					SET @CSTEP=432
					DELETE A FROM SCHEME_SETUP_SCHB002_1 A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 
					
					SET @CSTEP=435
					DELETE A FROM SCHEME_SETUP_ALLMASTERS A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 

					SET @CSTEP=440
					DELETE A FROM SCHEME_SETUP_ALLMASTERS_CONFIG A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 
					
					SET @CSTEP=442
					DELETE A FROM scheme_setup_weekdays_details A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID 
					WHERE b.sp_id=@nSpId 
					
					SET @CSTEP=450
					IF @BHAPPYHOURSACTIVE=1
					BEGIN
						DELETE A FROM SCHEME_SETUP_HAPPYHOURS A WITH (ROWLOCK)  
						JOIN SCHNEW_SCHEME_SETUP_HAPPYHOURS_upload B (NOLOCK) 
						ON A.row_id = B.ROW_ID 
						WHERE b.sp_id=@nSpId

					END
					
					SET @CSTEP=460
					DELETE A FROM SCHEME_SETUP_DET A WITH (ROWLOCK)  
					JOIN SCHNEW_SCHEME_SETUP_DET_upload B (NOLOCK) ON A.row_id = B.ROW_ID 
					WHERE b.sp_id=@nSpId

				END ----- IF @NCOPYSCHEMEMODE=0
				
				

				
			END ----- IF @NSCHEMEUPDATEMODE =2
		END ----- IF @NUPDATEMODE = 2


		SET @cFilterCondition=' B.SP_ID='''+@nSpId+''''

		--if @@spid=735
		--begin
		--	select @cFilterCondition filtercondition
			
		--	select 'check slsbc', * from schnew_scheme_setup_slsbc_upload where sp_id=@nSpId

		--end	
	    IF @NSCHEMEUPDATEMODE =1
		BEGIN
		   
		   SET @CSTEP = 490
		   	
	       EXEC UPDATEMASTERXN_OPT
			@CSOURCEDB = '',
			@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_MST_UPLOAD',
			@CDESTDB = '',
			@CDESTTABLE = 'SCHEME_SETUP_MST',
			@CKEYFIELD1 = 'memo_no',
			@CKEYFIELD2 = '',
			@CKEYFIELD3 = '',
			@LINSERTONLY= 0,
			@CFILTERCONDITION = @cFilterCondition,
			@CXNTYPE = '',
			@LUPDATEONLY = 0,
			@BALWAYSUPDATE = 1
		   
		   SET @CSTEP = 500
		    	
		   EXEC UPDATEMASTERXN_OPT 
			@CSOURCEDB = '',
			@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_loc_UPLOAD',
			@CDESTDB = '',
			@CDESTTABLE = 'SCHEME_SETUP_loc',
			@CKEYFIELD1 = 'memo_no',
			@CKEYFIELD2 = 'DEPT_ID',
			@CKEYFIELD3 = '',
			@LINSERTONLY= 1,
			@CFILTERCONDITION = @cFilterCondition,
		--	@LUPDATEXNS = 0,
			@CXNTYPE = '',
			@LUPDATEONLY = 0,
		--	@CUSERID = '',
			@BALWAYSUPDATE = 0 

			IF @BHAPPYHOURSACTIVE=1 OR @NCOPYSCHEMEMODE>0
			BEGIN
				SET @CSTEP=505
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_HAPPYHOURS_upload',
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_HAPPYHOURS',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					--@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
					--@CUSERID = '',
					@BALWAYSUPDATE = 1	
			END			
			
		END
		
		SET @CSTEP = 510	
		UPDATE SCHEME_SETUP_MST SET LAST_UPDATE=GETDATE() WHERE MEMO_NO = @CMEMONOVAL


		SET @CSTEP=512
		UPDATE SCHNEW_SCHEME_SETUP_DET_upload WITH (ROWLOCK)  
		SET LAST_UPDATE=GETDATE() where sp_id=@nSpId
					
		SET @CSTEP=515
		EXEC UPDATEMASTERXN_OPT
			@CSOURCEDB = '',
			@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_DET_upload' ,
			@CDESTDB = '',
			@CDESTTABLE = 'SCHEME_SETUP_det',
			@CKEYFIELD1 = 'memo_no',
			@CKEYFIELD2 = 'ROW_ID',
			@CKEYFIELD3 = '',
			@LINSERTONLY= 0,
			@CFILTERCONDITION = @cFilterCondition,
			--@LUPDATEXNS = 0,
			@CXNTYPE = '',
			@LUPDATEONLY = 0,
			--@CUSERID = '',
			@BALWAYSUPDATE = 1
		
		SET @CSTEP=515.5
		UPDATE A with (rowlock) SET SCHEME_SETUP_DET_ROW_ID=B.ROW_ID FROM
		SCHNEW_scheme_setup_weekdays_details_upload A
		JOIN SCHNEW_SCHEME_SETUP_DET_UPLOAD B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.OLD_ROW_ID AND a.sp_id=b.sp_id
		WHERE a.sp_id=@nSpid 

		--if @@spid=224
		--begin
		--	select 'check scheme',* from schnew_scheme_Setup_det_upload where sp_id=@nSpId
		--		select 'check scheme weeks',* from SCHNEW_scheme_setup_weekdays_details_upload where sp_id=@nSpId
		--end

		DECLARE @bWeekDaywiseApplicable BIT
		SELECT TOP 1 @bWeekDaywiseApplicable=ISNULL(weekday_wise_applicable,0) FROM schnew_scheme_Setup_det_upload (NOLOCK)
		WHERE sp_id=@nSpId

		IF @bWeekDaywiseApplicable=1
		BEGIN
			SET @CSTEP=515.7
			EXEC UPDATEMASTERXN_OPT
				@CSOURCEDB = '',
				@CSOURCETABLE = 'SCHNEW_scheme_setup_weekdays_details_upload' ,
				@CDESTDB = '',
				@CDESTTABLE = 'scheme_setup_weekdays_details',
				@CKEYFIELD1 = 'scheme_setup_det_row_id',
				@CKEYFIELD2 = '',
				@CKEYFIELD3 = '',
				@LINSERTONLY= 0,
				@CFILTERCONDITION = @cFilterCondition,
				--@LUPDATEXNS = 0,
				@CXNTYPE = '',
				@LUPDATEONLY = 0,
				--@CUSERID = '',
				@BALWAYSUPDATE = 1
		END		

		IF  ISNULL(@CPROMID,'')='SCHB001' OR @NCOPYSCHEMEMODE>0   
		BEGIN
			SET @CSTEP=518	
			EXEC UPDATEMASTERXN_OPT 
				@CSOURCEDB = '',
				@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SCHB001_1_upload',
				@CDESTDB = '',
				@CDESTTABLE = 'SCHEME_SETUP_SCHB001_1',
				@CKEYFIELD1 = 'ROW_ID',
				@CKEYFIELD2 = '',
				@CKEYFIELD3 = '',
				@LINSERTONLY= 0,
				@CFILTERCONDITION = @cFilterCondition,
				@CXNTYPE = '',
				@LUPDATEONLY = 0,
				@BALWAYSUPDATE = 1
		END

		IF  ISNULL(@CPROMID,'')='SCHB002' OR @NCOPYSCHEMEMODE>0   
		BEGIN
			SET @CSTEP=520
			EXEC UPDATEMASTERXN_OPT 
				@CSOURCEDB = '',
				@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SCHB002_1_upload',
				@CDESTDB = '',
				@CDESTTABLE = 'SCHEME_SETUP_SCHB002_1',
				@CKEYFIELD1 = 'ROW_ID',
				@CKEYFIELD2 = '',
				@CKEYFIELD3 = '',
				@LINSERTONLY= 0,
				@CFILTERCONDITION = @cFilterCondition,
				@CXNTYPE = '',
				@LUPDATEONLY = 0,
				@BALWAYSUPDATE = 1
		END
				
		IF  ISNULL(@CPROMID,'') NOT IN ('SCHB001','SCHB002') OR @NCOPYSCHEMEMODE>0   
	    BEGIN
			IF @NBUYFILTERMODE=2 OR @NCOPYSCHEMEMODE>0
			BEGIN
				SET @cStep=523
			    UPDATE SCHNEW_SCHEME_SETUP_SLSBC_upload with (rowlock)
				SET SOURCE_TYPE=1 WHERE SP_ID=@NsPID and ISNULL(SOURCE_TYPE,0)=0
				
				SET @cStep=525
				UPDATE a WITH (ROWLOCK) SET discount_amount=(c.mrp*a.discount_percentage/100),
				net_price=round(c.mrp-(c.mrp*a.discount_percentage/100),0) 
				FROM SCHNEW_SCHEME_SETUP_SLSBC_upload a
				JOIN sku c (NOLOCK) ON a.product_code=c.product_code
				WHERE SP_ID=@NsPID and  a.discount_mode=1 

				SELECT @cMrpRoundingLevel=value FROM config (NOLOCK) WHERE config_option='mrp_rounding_level'--(nearest highest) 
				SELECT @cMrpRoundingMode=value FROM config (NOLOCK) WHERE config_option='mrp_rounding_mode'--(endat rounded)
				SELECT @cMrpRoundingRs=value FROM config (NOLOCK) WHERE config_option='mrp_rounding_rs'--(in RS)
				
				SET @cStep=527
				UPDATE a WITH (ROWLOCK)  SET discount_amount=(c.mrp-a.net_price),
				discount_percentage=ROUND(((c.mrp-a.net_price)/c.mrp)*100,2)
				FROM SCHNEW_SCHEME_SETUP_SLSBC_upload a
				JOIN sku c (NOLOCK) ON a.product_code=c.product_code
				WHERE SP_ID=@NsPID and  a.discount_mode=2
				AND c.mrp>a.net_price

				SET @cStep=530
				UPDATE a WITH (ROWLOCK) SET net_price=(c.mrp-a.discount_amount),
				discount_percentage=ROUND(((c.mrp-a.discount_amount)/c.mrp)*100,2)
				FROM SCHNEW_SCHEME_SETUP_SLSBC_upload a
				JOIN sku c (NOLOCK) ON a.product_code=c.product_code
				WHERE  SP_ID=@NsPID and a.discount_mode=3

				IF ISNULL(@cMrpRoundingRs,'') NOT IN ('','0') AND ISNULL(@cMrpRoundingLevel,'')='1' and ISNULL(@cMrpRoundingMode,'')='2'
				BEGIN
					SET @cStep=535
					SET @cCmd=N'UPDATE a WITH (ROWLOCK)  SET net_price=a.net_price-(a.net_price%'+@cMrpRoundingRs+')+'+
					@cMrpRoundingRs+' FROM SCHNEW_SCHEME_SETUP_SLSBC_upload a
					JOIN  SCHNEW_SCHEME_SETUP_DET_upload b (NOLOCK) ON a.scheme_Setup_det_row_id=b.row_id AND a.sp_id=b.sp_id
					WHERE a.sp_id='''+@nSpId+''' AND a.discount_mode IN (1,3) and ( a.discount_mode<>1 or  a.DISCOUNT_PERCENTAGE<>0  ) '
					PRINT @CCMD
					EXEC SP_EXECUTESQL @CCMD							

					SET @cStep=537
					SET @cCmd=N'UPDATE a WITH (ROWLOCK)  SET net_price=a.net_price+'+@cMrpRoundingRs+' 
					FROM SCHNEW_SCHEME_SETUP_SLSBC_upload a
					JOIN  SCHNEW_SCHEME_SETUP_DET_upload b (NOLOCK) ON a.scheme_Setup_det_row_id=b.row_id
					WHERE  a.sp_id='''+@nSpId+''' and a.discount_mode IN (1,3) and ( a.discount_mode<>1 or  a.DISCOUNT_PERCENTAGE<>0  )  and right(ltrim(rtrim(str(a.net_price))),1)<>'''+@cMrpRoundingRs+''''
					PRINT @CCMD
					EXEC SP_EXECUTESQL @CCMD			
					
					--as Discuss with sanjiv sir for Client Geeta vastra discount amount and percentage recalculated in case of mrproundig rs add in net Price(20240531)
					
					SET @cStep=538
					
					
						SET @cCmd=N'UPDATE a WITH (ROWLOCK)  SET DISCOUNT_AMOUNT=(SKU.MRP-a.NET_PRICE),
										DISCOUNT_PERCENTAGE=ROUND((SKU.MRP-a.NET_PRICE)*100/SKU.MRP ,2),
										DISCOUNT_FIGURE =ROUND((SKU.MRP-a.NET_PRICE)*100/SKU.MRP ,2)
						FROM SCHNEW_SCHEME_SETUP_SLSBC_upload a
						JOIN  SCHNEW_SCHEME_SETUP_DET_upload b (NOLOCK) ON a.scheme_Setup_det_row_id=b.row_id
						join sku (nolock) on a.product_code=sku.product_code
						WHERE  a.sp_id='''+@nSpId+''' and a.discount_mode IN (1,3) and ( a.discount_mode<>1 or  a.DISCOUNT_PERCENTAGE<>0  ) 
						and isnull(b.applyNetsprounding,0)=1 '
						PRINT @CCMD
						EXEC SP_EXECUTESQL @CCMD	
					
				
									
				END
				
				
				
				
				SET @CSTEP=540
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SLSBC_upload' ,
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SLSBC',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
				--	@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
					--@CUSERID = '',
					@BALWAYSUPDATE = 1
			END
			
			IF @NGETFILTERMODE=2 OR @NCOPYSCHEMEMODE>0
			BEGIN
				SET @CSTEP=550
				
				UPDATE SCHNEW_SCHEME_SETUP_SLSBC_get_upload with (rowlock) SET SOURCE_TYPE=1 
				WHERE sp_id=@nSpid AND ISNULL(SOURCE_TYPE,0)=0



				
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SLSBC_get_upload' ,
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SLSBC_get',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
					@BALWAYSUPDATE = 1	
			END	
			
			IF @NBUYFILTERMODE=3 OR @NCOPYSCHEMEMODE>0
			BEGIN
				SET @CSTEP=560
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SLSart_upload' ,
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SLSart',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					--@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
				--	@CUSERID = '',
					@BALWAYSUPDATE = 1
			END

			IF @NGETFILTERMODE=3 OR @NCOPYSCHEMEMODE>0
			BEGIN
				SET @CSTEP=570
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SLSart_get_upload',
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SLSart_get',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					--@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
					--@CUSERID = '',
					@BALWAYSUPDATE = 1	
			END

			IF @NBUYFILTERMODE=5 OR @NCOPYSCHEMEMODE>0
			BEGIN
				SET @CSTEP=560
				EXEC UPDATEMASTERXN
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SLSEAN_upload' ,
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SLSEAN',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
					@CUSERID = '',
					@BALWAYSUPDATE = 1
			END

			IF @NGETFILTERMODE=5 OR @NCOPYSCHEMEMODE>0
			BEGIN
				SET @CSTEP=570
				EXEC UPDATEMASTERXN 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SLSEAN_get_upload' ,
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SLSEAN',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
					@CUSERID = '',
					@BALWAYSUPDATE = 1
			END

			IF @NBUYFILTERMODE=6 OR @NgetFILTERMODE=6 OR @NCOPYSCHEMEMODE>0  OR (@CPROMID='SCH0015' AND @NBUYFILTERMODE=3) 
			BEGIN
			    Update SCHNEW_SCHEME_SETUP_ALLMASTERS_upload set PARA1_CODE ='0000000' where ISNULL(PARA1_CODE,'')=''  and  sp_id=@nSpid 
				SET @CSTEP=580
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_ALLMASTERS_upload' ,
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_ALLMASTERS',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
				--	@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
				--	@CUSERID = '',
					@BALWAYSUPDATE = 1
					
				SET @CSTEP=590
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_ALLMASTERS_CONFIG_upload' ,
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_ALLMASTERS_CONFIG',
					@CKEYFIELD1 = 'SCHEME_SETUP_DET_ROW_ID',
					@CKEYFIELD2 = 'SCHEME_SETUP_COLUMN_NAME',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					--@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
				--	@CUSERID = '',
					@BALWAYSUPDATE = 1					
			END
						
						--CHECK
						--SELECT @CPROMID,@NCOPYSCHEMEMODE
			IF  ISNULL(@CPROMID,'')IN('SCH0002','SCH0011') OR @NCOPYSCHEMEMODE>0   
			BEGIN
				SET @CSTEP=610
				
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SCH0002_1_upload',
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SCH0002_1',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					--@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
				--	@CUSERID = '',
					@BALWAYSUPDATE = 1	
			END			

			IF  ISNULL(@CPROMID,'')='SCH0007' OR @NCOPYSCHEMEMODE>0   
			BEGIN
				SET @CSTEP=620
				
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SCH0007_1_upload',
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SCH0007_1',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					--@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
					--@CUSERID = '',
					@BALWAYSUPDATE = 1	
			END										

			IF  ISNULL(@CPROMID,'')='SCH0014' OR @NCOPYSCHEMEMODE>0   
			BEGIN
				SET @CSTEP=622
				
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SCH0014_1_upload',
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SCH0014_1',
					@CKEYFIELD1 = 'SCHEME_SETUP_DET_ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					--@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
				--	@CUSERID = '',
					@BALWAYSUPDATE = 1	
			END										
			
			IF  ISNULL(@CPROMID,'')='SCH0012' OR @NCOPYSCHEMEMODE>0   
			BEGIN
				SET @CSTEP=625
				
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SCH0012_upload',
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SCH0012',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					--@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
					--@CUSERID = '',
					@BALWAYSUPDATE = 1	
			END										
			
			IF  ISNULL(@CPROMID,'')='SCH0006' OR @NCOPYSCHEMEMODE>0   
			BEGIN
				
				SET @CSTEP=630
				
				EXEC UPDATEMASTERXN_OPT 
					@CSOURCEDB = '',
					@CSOURCETABLE = 'SCHNEW_SCHEME_SETUP_SCH0006_1_upload',
					@CDESTDB = '',
					@CDESTTABLE = 'SCHEME_SETUP_SCH0006_1',
					@CKEYFIELD1 = 'ROW_ID',
					@CKEYFIELD2 = '',
					@CKEYFIELD3 = '',
					@LINSERTONLY= 0,
					@CFILTERCONDITION = @cFilterCondition,
					--@LUPDATEXNS = 0,
					@CXNTYPE = '',
					@LUPDATEONLY = 0,
					--@CUSERID = '',
					@BALWAYSUPDATE = 1	
			END
					
		END
		
		DECLARE @cSchNewRowId  VARCHAR(50)
		SET @cSchNewRowId=''

		SET @CSTEP=640
		IF @NSCHEMEUPDATEMODE=2
			SELECT TOP 1 @cSchNewRowId=row_id FROM SCHNEW_SCHEME_SETUP_DET_UPLOAD (NOLOCK)
			WHERE sp_id=@NSPID
		
		UPDATE SCHEME_SETUP_DET WITH (ROWLOCK) SET GET_FILTER_CRITERIA=REPLACE(GET_FILTER_CRITERIA,'MRP','ITV.MRP')
		WHERE ((row_id=@cSchNewRowId AND @cSchNewRowId<>'') OR (@cSchNewRowId='' AND MEMO_NO = @CMEMONOVAL)) AND GET_FILTER_CRITERIA NOT LIKE '%ITV.MRP%' AND GET_FILTER_CRITERIA LIKE '%MRP%'
			
		UPDATE SCHEME_SETUP_DET WITH (ROWLOCK) SET BUY_FILTER_CRITERIA=REPLACE(BUY_FILTER_CRITERIA,'MRP','ITV.MRP')
		WHERE ((row_id=@cSchNewRowId AND @cSchNewRowId<>'') OR (@cSchNewRowId='' AND MEMO_NO = @CMEMONOVAL)) AND BUY_FILTER_CRITERIA NOT LIKE '%ITV.MRP%' AND BUY_FILTER_CRITERIA LIKE '%MRP%'
		
		SET @CSTEP=645
		UPDATE SCHEME_SETUP_DET WITH (ROWLOCK) SET additional_GET_FILTER_CRITERIA=REPLACE(additional_GET_FILTER_CRITERIA,'MRP','ITV.MRP')
		WHERE ((row_id=@cSchNewRowId AND @cSchNewRowId<>'') OR (@cSchNewRowId='' AND MEMO_NO = @CMEMONOVAL)) AND additional_GET_FILTER_CRITERIA NOT LIKE '%ITV.MRP%' AND additional_GET_FILTER_CRITERIA LIKE '%MRP%'
			
		UPDATE SCHEME_SETUP_DET WITH (ROWLOCK) SET additional_BUY_FILTER_CRITERIA=REPLACE(additional_BUY_FILTER_CRITERIA,'MRP','ITV.MRP')
		WHERE ((row_id=@cSchNewRowId AND @cSchNewRowId<>'') OR (@cSchNewRowId='' AND MEMO_NO = @CMEMONOVAL)) AND additional_BUY_FILTER_CRITERIA NOT LIKE '%ITV.MRP%' AND additional_BUY_FILTER_CRITERIA LIKE '%MRP%'
				
		SET @CSTEP=650
		UPDATE SCHEME_SETUP_DET WITH (ROWLOCK) SET GET_FILTER_CRITERIA=REPLACE(GET_FILTER_CRITERIA,'A.PRODUCT_CODE','ITV.PRODUCT_CODE')
		WHERE ((row_id=@cSchNewRowId AND @cSchNewRowId<>'') OR (@cSchNewRowId='' AND MEMO_NO = @CMEMONOVAL))  AND GET_FILTER_CRITERIA NOT LIKE '%ITV.PRODUCT_CODE%' AND GET_FILTER_CRITERIA LIKE '%A.PRODUCT_CODE%'

		UPDATE SCHEME_SETUP_DET WITH (ROWLOCK) SET BUY_FILTER_CRITERIA=REPLACE(BUY_FILTER_CRITERIA,'A.PRODUCT_CODE','ITV.PRODUCT_CODE')
		WHERE ((row_id=@cSchNewRowId AND @cSchNewRowId<>'') OR (@cSchNewRowId='' AND MEMO_NO = @CMEMONOVAL))  AND  BUY_FILTER_CRITERIA NOT LIKE '%ITV.PRODUCT_CODE%' AND BUY_FILTER_CRITERIA LIKE '%A.PRODUCT_CODE%'			
									
		SET @CSTEP=655
		UPDATE SCHEME_SETUP_DET WITH (ROWLOCK) SET additional_GET_FILTER_CRITERIA=REPLACE(additional_GET_FILTER_CRITERIA,'A.PRODUCT_CODE','ITV.PRODUCT_CODE')
		WHERE ((row_id=@cSchNewRowId AND @cSchNewRowId<>'') OR (@cSchNewRowId='' AND MEMO_NO = @CMEMONOVAL))  AND additional_GET_FILTER_CRITERIA NOT LIKE '%ITV.PRODUCT_CODE%' AND additional_GET_FILTER_CRITERIA LIKE '%A.PRODUCT_CODE%'

		UPDATE SCHEME_SETUP_DET WITH (ROWLOCK) SET additional_buy_filter_criteria=REPLACE(additional_buy_filter_criteria,'A.PRODUCT_CODE','ITV.PRODUCT_CODE')
		WHERE ((row_id=@cSchNewRowId AND @cSchNewRowId<>'') OR (@cSchNewRowId='' AND MEMO_NO = @CMEMONOVAL))  AND  additional_buy_filter_criteria NOT LIKE '%ITV.PRODUCT_CODE%' AND additional_buy_filter_criteria LIKE '%A.PRODUCT_CODE%'			
		
	END TRY
	
	BEGIN CATCH
		SET @CERRORMSG = 'P:SAVETRAN_SCHEME_SETUP , STEP: '+@CSTEP+', MESSAGE: '+ ERROR_MESSAGE()      
		GOTO END_PROC
	END CATCH	
	
END_PROC:
	DECLARE @cSchemeRowId VARCHAR(50)=''
	
	IF (@NSCHEMEUPDATEMODE=2 OR @NUPDATEMODE=1) AND @nCopySchemeMode=0
	BEGIN
		SELECT TOP 1 @cSchemeRowId=row_id FROM SCHNEW_SCHEME_SETUP_det_upload (NOLOCK)
		WHERE sp_id=@nSpid
	END	

	--if @@spid=154
	--	select 'check memo', * from  scheme_Setup_det where memo_no=@CMEMONOVAL

		--select * from scheme_setup_weekdays_details
	
	--if @@spid=100
	--	select 'check final scheme para saved', b.scheme_name,c.scheme_set_name, a.* from SCHEME_SETUP_ALLMASTERS a join scheme_Setup_det b on a.SCHEME_SETUP_DET_ROW_ID=b.row_id
	--join scheme_Setup_mst c on c.memo_no=b.memo_no
	--where b.memo_no=@CMEMONOVAL

	IF @@TRANCOUNT>0 
	BEGIN
		IF ISNULL(@CERRORMSG,'') = ''
			commit
		ELSE
			ROLLBACK
	END	

	print 'Last step:'+@cStep

	EXEC SP3S_DELETEUPLOAD_SCH @nSpId

	SELECT ISNULL(@CMEMONOVAL,'') AS MEMO_NO,ISNULL(@CERRORMSG,'') AS ERRMSG,@cSchemeRowId AS row_id	 
END
---*********END OF THE PROCEDURE SAVETRAN_SCHEME_SETUP******--



