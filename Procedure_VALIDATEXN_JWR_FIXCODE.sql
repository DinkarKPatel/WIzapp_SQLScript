CREATE PROCEDURE  VALIDATEXN_JWR_FIXCODE
 @CXNID VARCHAR(50),	
 @NUPDATEMODE INT,	
 @NSPID INT=0,
 @CERRORMSG VARCHAR(200) OUTPUT
 
AS
BEGIN
    
    
    SET @CERRORMSG=''
    
    IF OBJECT_ID ('TEMPDB..#TMPRECMISMATCH','U') IS NOT NULL
       DROP TABLE #TMPRECMISMATCH
    
    
    SELECT A.REF_ROW_ID ,A.FG_QTY ,B.JWRQTY  
    INTO #TMPRECMISMATCH
    FROM
    (
		SELECT A.REF_ROW_ID  ,SUM(A.QUANTITY) AS FG_QTY  
		FROM JWR_JOBWORK_RECEIVE_FG_DET_UPLOAD A
		WHERE SP_ID =LTRIM(RTRIM(STR(@NSPID)))
		GROUP BY A.REF_ROW_ID
	) A
    LEFT JOIN
    (
     SELECT  REF_ROW_ID ,SUM(QUANTITY) AS JWRQTY
     FROM JOBWORK_RECEIPT_DET  (NOLOCK)
     WHERE RECEIPT_ID =@CXNID
     GROUP BY REF_ROW_ID
    ) B ON A.REF_ROW_ID =B.REF_ROW_ID 
    WHERE ISNULL(A.FG_QTY,0) <>ISNULL(B.JWRQTY,0)
	
	IF EXISTS (SELECT TOP 1 'U' FROM #TMPRECMISMATCH)
	BEGIN
	     
	     SET @CERRORMSG='MISMATCH BETWEEN NEW BARCODE GENERATION FROM FIX CODE IN JWR'
	     RETURN
	END
    
      IF OBJECT_ID ('TEMPDB..#TMPJCMISMATCH','U') IS NOT NULL
       DROP TABLE #TMPJCMISMATCH
     
        
    SELECT A.FIX_PRODUCT_CODE ,A.QUANTITY ,A.ROW_ID ,REC.JOBCARD_QTY
    INTO #TMPJCMISMATCH
    FROM (
    SELECT A.FIX_PRODUCT_CODE ,SUM(A.QUANTITY) AS QUANTITY ,A.ROW_ID 
    FROM JWR_JOBWORK_RECEIVE_FG_DET_UPLOAD A
    WHERE A.SP_ID=LTRIM(RTRIM(STR(@NSPID))) 
    GROUP BY A.FIX_PRODUCT_CODE,A.ROW_ID
    ) A
    LEFT JOIN
    (
     SELECT B.REFROW_ID ,COUNT(*) AS JOBCARD_QTY 
     FROM JOBWORK_RECEIPT_DET A (NOLOCK)
     JOIN ORD_PLAN_BARCODE_DET B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
     JOIN ORD_PLAN_DET C (NOLOCK) ON C.ROW_ID =B.REFROW_ID 
     JOIN ORD_PLAN_MST MST (NOLOCK) ON MST.MEMO_ID =C.MEMO_ID 
     WHERE RECEIPT_ID =@CXNID AND MST.CANCELLED =0 
     GROUP BY B.REFROW_ID
    ) REC ON A.ROW_ID=REC.REFROW_ID 
    WHERE A.QUANTITY<>ISNULL(REC.JOBCARD_QTY,0)
    
    
  
    IF EXISTS (SELECT TOP 1 'U' FROM #TMPJCMISMATCH)
	BEGIN
	     
	     SET @CERRORMSG='MISMATCH BETWEEN NEW GENERATED JOBCARD QTY'
	     RETURN
	END
	  IF OBJECT_ID ('TEMPDB..#TMPJOBSMISMATCH','U') IS NOT NULL
       DROP TABLE #TMPJOBSMISMATCH
       
       
   
	
	SELECT A.PRODUCT_CODE ,B.QUANTITY_IN_STOCK
	INTO #TMPJOBSMISMATCH 
	FROM JOBWORK_RECEIPT_DET A (NOLOCK)
	JOIN jobwork_receipt_mst C (NOLOCK) ON C.receipt_id=A.receipt_id/*Rohit 06-11-2024*/
	LEFT JOIN JOBWORK_PMT B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE AND A.BIN_ID =B.BIN_ID AND C.Location_code/*LEFT(A.RECEIPT_ID,2)*//*Rohit 06-11-2024*/=B.DEPT_ID 
	WHERE (ISNULL(B.QUANTITY_IN_STOCK,0)<>1)--A.JOB_CODE <>B.JOB_CODE OR 
    AND A.RECEIPT_ID =@CXNID
    
    IF EXISTS (SELECT TOP 1 'U' FROM #TMPJOBSMISMATCH)
	BEGIN
	     
	     SET @CERRORMSG='QUANTITY IN STCK MISMATCH pLEASE CHECK'
	     RETURN
	END

END_PROC:

END
