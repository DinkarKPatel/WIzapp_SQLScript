CREATE PROCEDURE SP3S_PPC_PENDING_PO_REPORT
(
 @FROM DATE='',
 @TILL DATE='',
 @BILL_NO VARCHAR(100)='',
 @SUPPLIER VARCHAR(100)=''
)
AS 
BEGIN
     SET NOCOUNT ON
     DECLARE @CSQL NVARCHAR(MAX),@AAC_STATUS VARCHAR(MAX),@CORDER_STATUS VARCHAR(MAX)
     
     IF @SUPPLIER=''    
	  BEGIN    
		   SET @AAC_STATUS=''    
		   SET @SUPPLIER='IN('''')'    
	  END    
	  ELSE     
	  BEGIN    
		   SET @AAC_STATUS='LATER'    
	   END    
		    
     IF @BILL_NO=''    
	  BEGIN    
		   SET @CORDER_STATUS=''    
		   SET @BILL_NO='IN('''')'    
	  END    
	  ELSE     
	  BEGIN    
		   SET @CORDER_STATUS='LATER'    
	   END   
     
  SET @CSQL='SELECT M.PO_NO ,BOM.BILL_NO AS WSL_ORDER_NO ,REPLACE(CONVERT(VARCHAR,M.PO_DT,106),'' '',''/'') PO_DATE, 
			        REPLACE(CONVERT(VARCHAR,D.DELIVERY_DT,106),'' '',''/'') DELIVERY_DT ,DATEDIFF(DD,GETDATE(),
			        D.DELIVERY_DT) AS OVER_DAYS,
			        REPLACE(REPLACE(ISNULL(M.APPROVED,0),0,''NO''),1,''YES'') AS APPROVED ,
			        A.ARTICLE_NO AS ARTICLE_NO ,A.COLOR_NAME AS COLOUR,
			        ISNULL(D.QUANTITY,0) AS PO_QTY ,U.UOM_NAME AS STOCK_UOM ,ISNULL(R.QUANTITY,0) AS RECEIVE_QTY ,
			        ISNULL(D.QUANTITY,0)-ISNULL(R.QUANTITY,0) AS PENDING_QTY,LM.AC_NAME
			FROM PPC_POM01106 M (NOLOCK) 
			JOIN PPC_POD01106 D (NOLOCK) ON M.PO_ID=D.PO_ID
			JOIN LM01106 LM(NOLOCK) ON LM.AC_CODE=M.AC_CODE
			LEFT JOIN 
			(
			  SELECT PO_ROW_ID,SUM(R.QUANTITY) AS QUANTITY
			  FROM PPC_PID01106 PID (NOLOCK) 
			  JOIN PPC_PID01106_BARCODE R(NOLOCK) ON R.PID_ROW_ID=PID.ROW_ID
			  JOIN PPC_PIM01106 PIM (NOLOCK) ON PIM.MRR_ID=PID.MRR_ID
			  WHERE PIM.CANCELLED=0
			  GROUP BY PO_ROW_ID
			) R ON D.ROW_ID=R.PO_ROW_ID
			JOIN ARTICLE A (NOLOCK) ON A.ARTICLE_CODE=D.ARTICLE_CODE
			JOIN UOM U (NOLOCK) ON U.UOM_CODE=A.UOM_CODE
			LEFT JOIN
			(
			 SELECT C.ROW_ID ,A.BILL_NO
			 FROM PPC_BUYER_ORDER_MST A
			 JOIN PPC_BUYER_ORDER_DET B ON A.ORDER_ID=B.ORDER_ID
			 JOIN PPC_BO_ART_BOM C ON B.ROW_ID=C.REF_ROW_ID 
			 GROUP BY C.ROW_ID ,A.BILL_NO
			) BOM ON BOM.ROW_ID=D.BO_BOM_ROW_ID
			WHERE M.CANCELLED=0 
			AND  ('''+RTRIM(LTRIM(@AAC_STATUS))+'''='''' OR M.AC_CODE '+@SUPPLIER+')  
			AND  ('''+RTRIM(LTRIM(@CORDER_STATUS))+'''='''' OR BOM.BILL_NO '+@BILL_NO+')
			AND ISNULL(D.QUANTITY,0)-ISNULL(R.QUANTITY,0)>0
			ORDER BY PO_DT,PO_NO'
PRINT @CSQL
EXEC SP_EXECUTESQL @CSQL


SET NOCOUNT OFF
END
