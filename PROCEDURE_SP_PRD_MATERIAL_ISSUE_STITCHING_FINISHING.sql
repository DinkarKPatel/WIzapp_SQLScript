CREATE PROCEDURE SP_PRD_MATERIAL_ISSUE_STITCHING_FINISHING  
(  
 @ISSUE_ID VARCHAR(100)=''  
)  
AS  
BEGIN  
      
        
    IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL  
       DROP TABLE #TMPISSUE  
      
    SELECT D.AGENCY_NAME AS ISSUED_TO ,C.MEMO_NO AS ISSUE_NO,C.MEMO_DT AS ISSUE_DT,  
           E.JOB_NAME,  
           B.REF_PRD_WORKORDER_MEMOID AS WO_ID,  
           MST.MEMO_NO AS WO_NO,  
           AR.ARTICLE_NO AS DESIGN_NO,   
           AR.ARTICLE_NAME AS DESIGN_NAME,  
           P1.PARA1_CODE ,  
           P1.PARA1_NAME AS DESIGN_COLOR,  
           CONVERT(NUMERIC(5,0),ISNULL(UPC.QUANTITY,SUM(A.ISSUE_QTY))) AS QTY_PCS,  
           B.ITEM_REMARKS,  
           COM.COMPANY_NAME,  
           COM.LOGO_PATH,  
           COM.ADDRESS1,  
           COM.ADDRESS2,  
           COM.CITY,  
           COM.PHONES_FAX,  
           C.MEMO_ID AS ISSUE_ID,  
           C.REMARKS  ,
           LMV.ADDRESS1 AS BUYER_ADDRESS1,
           LMV.ADDRESS2 AS BUYER_ADDRESS2,
           LMV.CITY  AS BUYER_CITY,
           LMV.PHONES_FAX  AS BUYER_FAX,
           LMV.AC_GST_NO  AS BUYER_GST,
           ISNULL(UPC.PRODUCT_CODE,'') AS PRODUCT_CODE,
           U.USERNAME AS EMP_NAME
    INTO #TMPISSUE  
    FROM PRD_AGENCY_ISSUE_ROW_MATERIAL_DET A (NOLOCK)  
    JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID AND A.ROW_ID=B.REF_MATERIAL_ROW_ID  
    JOIN PRD_AGENCY_ISSUE_MATERIAL_MST C (NOLOCK) ON A.MEMO_ID=C.MEMO_ID 
    LEFT JOIN PRD_AGENCY_ISSUE_MATERIAL_UPC UPC (NOLOCK) ON UPC.MEMO_ID =A.MEMO_ID AND UPC.REF_ROW_ID =A.ROW_ID 
    JOIN PRD_AGENCY_MST D (NOLOCK) ON C.REF_AGENCY_CODE=D.AGENCY_CODE  
    JOIN JOBS E (NOLOCK) ON E.JOB_CODE=B.JOB_CODE  
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=A.ARTICLE_CODE  
    JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=A.PARA1_CODE  
    JOIN PRD_WO_MST MST (NOLOCK) ON MST.MEMO_ID=B.REF_PRD_WORKORDER_MEMOID   
    JOIN USERS U (NOLOCK) ON U.USER_CODE =MST.USER_CODE 
    JOIN COMPANY COM (NOLOCK) ON COM.COMPANY_CODE='01'  
    JOIN LMV01106 LMV ON LMV.AC_CODE =D.AC_CODE 
    WHERE A.MEMO_ID=@ISSUE_ID  
    GROUP BY D.AGENCY_NAME ,C.MEMO_NO ,C.MEMO_DT ,  
           E.JOB_NAME,  
           B.REF_PRD_WORKORDER_MEMOID ,  
           AR.ARTICLE_NO ,   
           AR.ARTICLE_NAME ,  
           P1.PARA1_NAME ,  
           --A.ISSUE_QTY ,  
           B.ITEM_REMARKS,  
           COM.COMPANY_NAME,  
           COM.LOGO_PATH,  
           COM.ADDRESS1,  
           COM.ADDRESS2,  
           COM.CITY,  
           COM.PHONES_FAX,  
           C.MEMO_ID,C.REMARKS,MST.MEMO_NO,P1.PARA1_CODE  ,
           LMV.ADDRESS1 ,LMV.ADDRESS2 , LMV.CITY,LMV.AC_GST_NO ,LMV.PHONES_FAX ,
           ISNULL(UPC.PRODUCT_CODE,''),U.USERNAME,UPC.QUANTITY
  
  
  
SELECT A.*   
FROM #TMPISSUE A  
ORDER BY WO_NO  
  
  
SELECT  A.ISSUED_TO,A.ISSUE_NO,A.ISSUE_DT,  
     SUM(A.QTY_PCS) AS FG_QTY_PCS,  
     ISNULL(B.QUANTITY,0) AS SAMPLE  
FROM  
(  
SELECT  A.ISSUED_TO,A.ISSUE_NO,A.ISSUE_DT,A.WO_ID,A.PARA1_CODE,  A.ISSUE_ID,QTY_PCS   
FROM #TMPISSUE A  
GROUP BY A.ISSUED_TO,A.ISSUE_NO,A.ISSUE_DT,A.WO_ID,A.PARA1_CODE,  A.ISSUE_ID,QTY_PCS  
) A  
LEFT JOIN  
 (  
  SELECT B.REF_ISSUE_ID,SUM(A.QUANTITY) AS QUANTITY   
  FROM PRD_AGENCY_ISSUE_MATERIAL_DET_SAMPLE A  
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST_SAMPLE B ON A.MEMO_ID=B.MEMO_ID  
  WHERE B.CANCELLED=0  
  GROUP BY B.REF_ISSUE_ID  
) B ON A.ISSUE_ID=B.REF_ISSUE_ID  
GROUP BY A.ISSUED_TO,A.ISSUE_NO,A.ISSUE_DT,B.QUANTITY  
  
END
