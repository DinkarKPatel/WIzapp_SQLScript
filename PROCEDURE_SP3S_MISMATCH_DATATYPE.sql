CREATE PROCEDURE SP3S_MISMATCH_DATATYPE
(
 @CTABLE_TYPE VARCHAR(100)='_UPLOAD'
)
AS
BEGIN


	IF OBJECT_ID ('TEMPDB..#TMPUPLOADTABLE','U') IS NOT NULL
	   DROP TABLE #TMPUPLOADTABLE
	   
	SELECT A.*,B.TABLE_NAME  AS UPLOADTABLE_NAME
	INTO #TMPUPLOADTABLE
	FROM INFORMATION_SCHEMA .COLUMNS A
	JOIN 
	( SELECT TABLE_NAME 
	  FROM INFORMATION_SCHEMA .COLUMNS A
	  WHERE RIGHT (A.TABLE_NAME,6)  IN('MIRROR','UPLOAD')
	  AND A.TABLE_NAME NOT LIKE '%PPC%'
	  GROUP BY TABLE_NAME
	)B ON A.TABLE_NAME+@CTABLE_TYPE=RIGHT(B.TABLE_NAME,LEN(A.TABLE_NAME+@CTABLE_TYPE))
	WHERE RIGHT(REPLACE(B.TABLE_NAME,RIGHT(B.TABLE_NAME,LEN(A.TABLE_NAME+@CTABLE_TYPE)),''),1)='_'
	AND CHARINDEX('_',B.TABLE_NAME)=LEN(REPLACE(B.TABLE_NAME,RIGHT(B.TABLE_NAME,LEN(A.TABLE_NAME+@CTABLE_TYPE)),''))
	AND A.TABLE_NAME   NOT LIKE 'TMP%'
	AND  A.TABLE_NAME NOT LIKE 'TEMP%'
	AND RIGHT (A.TABLE_NAME,6) NOT IN('MIRROR','UPLOAD')
	AND A.TABLE_NAME NOT LIKE '%PPC%'
	AND NOT (a.table_name IN ('rps_det','rps_mst') and a.COLUMN_NAME='cm_id')


IF OBJECT_ID ('TEMPDB..#TMPDATATYPEISMATCH','U') IS NOT NULL
   DROP TABLE #TMPDATATYPEISMATCH
   
SELECT DISTINCT A.TABLE_NAME ,A.COLUMN_NAME,A.DATA_TYPE ,A.CHARACTER_MAXIMUM_LENGTH ,A.NUMERIC_PRECISION ,A.NUMERIC_SCALE ,
A.UPLOADTABLE_NAME ,B.COLUMN_NAME AS UPLOAD_COLNAME,A.DATA_TYPE AS UPLOAD_DATATYPE ,A.CHARACTER_MAXIMUM_LENGTH  AS UPLOAD_CHARACTER_MAXIMUM_LENGTH,
A.NUMERIC_PRECISION AS UPLOAD_NUMERIC_PRECISION ,B.NUMERIC_SCALE AS UPLOAD_NUMERIC_SCALE 
INTO #TMPDATATYPEISMATCH
FROM #TMPUPLOADTABLE A
LEFT JOIN  INFORMATION_SCHEMA .COLUMNS B ON A.UPLOADTABLE_NAME =B.TABLE_NAME AND A.COLUMN_NAME =B.COLUMN_NAME AND A.DATA_TYPE =B.DATA_TYPE 
AND ISNULL(A.CHARACTER_MAXIMUM_LENGTH,0)=ISNULL(B.CHARACTER_MAXIMUM_LENGTH,0)
AND ISNULL(A.NUMERIC_PRECISION,0)= ISNULL(B.NUMERIC_PRECISION,0)
AND ISNULL(A.NUMERIC_SCALE ,0)=ISNULL(B.NUMERIC_SCALE ,0) 
WHERE A.COLUMN_NAME NOT IN('TS','sp_id') 
AND (B.TABLE_NAME IS NULL OR b.IS_NULLABLE<>'YES')

DECLARE @CTABLENAME VARCHAR(100),@CUPLOAD_TABLE_NAME VARCHAR(100),
        @CCOLUMNNAME VARCHAR(200),@CDATATYPE VARCHAR(100),
        @CHARACTER_MAXIMUM_LENGTH VARCHAR(100),
        @NNUMERIC_PRECISION VARCHAR(100),
        @NNUMERIC_SCALE VARCHAR(100),
        @DTSQL NVARCHAR(MAX)
        
WHILE EXISTS (SELECT TOP 1 'U' FROM #TMPDATATYPEISMATCH)
BEGIN
      
    
    SELECT TOP 1 @CTABLENAME=TABLE_NAME ,
                 @CUPLOAD_TABLE_NAME=UPLOADTABLE_NAME,
                 @CCOLUMNNAME=COLUMN_NAME,
                 @CDATATYPE=DATA_TYPE,
                 @CHARACTER_MAXIMUM_LENGTH=CHARACTER_MAXIMUM_LENGTH,
                 @NNUMERIC_PRECISION=NUMERIC_PRECISION,
                 @NNUMERIC_SCALE=NUMERIC_SCALE
                 
    FROM #TMPDATATYPEISMATCH
    
    IF RIGHT (@CUPLOAD_TABLE_NAME,6) IN('MIRROR','UPLOAD')
    BEGIN
    IF  EXISTS (SELECT TOP 1 'U' FROM INFORMATION_SCHEMA .COLUMNS WHERE TABLE_NAME =@CUPLOAD_TABLE_NAME AND COLUMN_NAME=@CCOLUMNNAME)
    BEGIN
       
       IF ISNULL(@NNUMERIC_SCALE,'')<>''
       SET @NNUMERIC_SCALE=','+@NNUMERIC_SCALE
       
        IF ISNULL(@CHARACTER_MAXIMUM_LENGTH,'')= '-1'
       SET @CHARACTER_MAXIMUM_LENGTH='MAX'
       
       
       IF @CDATATYPE IN('BIT','DATETIME','INT')
       BEGIN
         SET @DTSQL=' ALTER TABLE '+@CUPLOAD_TABLE_NAME+' ALTER COLUMN  '+@CCOLUMNNAME+ ' '+@CDATATYPE
       END
       ELSE IF @CDATATYPE IN('VARCHAR','CHAR','varbinary','NVARCHAR','NCHAR')
       BEGIN
           SET @DTSQL=' ALTER TABLE '+@CUPLOAD_TABLE_NAME+' ALTER COLUMN  '+@CCOLUMNNAME+ ' '+@CDATATYPE +' ('+@CHARACTER_MAXIMUM_LENGTH+')'
          
       END
       ELSE IF @CDATATYPE IN('NUMERIC')
       BEGIN
           SET @DTSQL=' ALTER TABLE '+@CUPLOAD_TABLE_NAME+' ALTER COLUMN  '+@CCOLUMNNAME+ ' '+@CDATATYPE +' ('+@NNUMERIC_PRECISION+@NNUMERIC_SCALE+')'
          
       END
	   
      PRINT @DTSQL
      EXEC SP_EXECUTESQL @DTSQL
    END 
    
    END
    DELETE FROM #TMPDATATYPEISMATCH WHERE UPLOADTABLE_NAME=@CUPLOAD_TABLE_NAME AND COLUMN_NAME=@CCOLUMNNAME

END 
    
    IF @CTABLE_TYPE='_MIRROR'
    GOTO END_PROC
    
    EXEC SP3S_MISMATCH_DATATYPE '_MIRROR'

END_PROC:


END