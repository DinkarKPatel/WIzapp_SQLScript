CREATE PROCEDURE SP_DROPTEMPTABLES_XNS
@CXNTYPE VARCHAR(20),
@NSPID VARCHAR(40),
@CTABLESUFFIX VARCHAR(100)='',
@CTABLEPREFIX VARCHAR(100)='',
@BENABLETEMPDATABASE BIT=0
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CTABLENAME VARCHAR(100),@CCMD NVARCHAR(MAX),@CDBNAME VARCHAR(200),@LENABLETEMPDATABASE BIT
	,@KEY_ID VARCHAR(100),@XN_TYPE VARCHAR(100)
	SELECT @LENABLETEMPDATABASE = CAST([VALUE] AS BIT) FROM CONFIG WHERE CONFIG_OPTION = 'ENABLE_TEMP_DATABASE'
	
	IF (@LENABLETEMPDATABASE = 1 OR @BENABLETEMPDATABASE=1) AND @CXNTYPE<>'XNSACT'
		SET @CDBNAME=DB_NAME()+'_TEMP'
	ELSE 
		SET @CDBNAME=DB_NAME()
	
	SET @CDBNAME=@CDBNAME+'.DBO.'
	
	IF @CTABLESUFFIX=''
		SET @CTABLESUFFIX=LTRIM(RTRIM((@NSPID)))
			
	IF @CTABLEPREFIX=''	
		SET @CTABLEPREFIX='TEMP' 
	
	IF @CXNTYPE='MSTCUS'
		SET @CTABLEPREFIX='TMP_MSTCUS'	
	
	-- DELETING FROM TEMP TABLES
	DECLARE DELETECUR CURSOR FOR 
	SELECT TABLENAME
	FROM XNSINFO (NOLOCK) WHERE XN_TYPE=@CXNTYPE
	OPEN DELETECUR

	FETCH NEXT FROM DELETECUR INTO @CTABLENAME

	WHILE @@FETCH_STATUS = 0
	BEGIN	
		IF @CXNTYPE='DOCCHO'
			SET @CTABLENAME=(CASE WHEN @CTABLENAME='INM01106' THEN 'PIM01106' WHEN @CTABLENAME='IND01106' 
								  THEN 'PID01106' ELSE @CTABLENAME END)
		ELSE
		IF @CXNTYPE='DOCPRT'
			SET @CTABLENAME=(CASE WHEN @CTABLENAME='RMM01106' THEN 'CNM01106' WHEN @CTABLENAME='RMD01106' 
								  THEN 'CND01106' ELSE @CTABLENAME END)
		
		SET @CCMD=N'IF EXISTS (SELECT NAME FROM '+@CDBNAME+'SYSOBJECTS (NOLOCK) WHERE NAME=''' +@CTABLEPREFIX + '_' + @CTABLENAME + '_' + @CTABLESUFFIX+''')
						DROP TABLE '+@CDBNAME+'['+@CTABLEPREFIX + '_' + @CTABLENAME + '_' + @CTABLESUFFIX+']'
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

		FETCH NEXT FROM DELETECUR INTO @CTABLENAME
	END
	CLOSE DELETECUR
	DEALLOCATE DELETECUR
	
END
