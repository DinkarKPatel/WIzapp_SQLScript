create PROCEDURE SAVETRAN_XN_APPROVAL_CHECKLIST_LEVELS
(
	 @CSPID			VARCHAR(50)
)
--WITH ENCRYPTION
AS
BEGIN
DECLARE @CERRMSG VARCHAR(500),@CSTEP VARCHAR(10)
	   ,@CCMD NVARCHAR(MAX),@CNEWLEVEL_CODE VARCHAR(10),@BREFEXISTS BIT
	   ,@LEVEL_DESC VARCHAR(100),@XN_TYPE VARCHAR(10)

DECLARE @TOUTPUT TABLE(LEVEL_CODE VARCHAR(50),ERRMSG VARCHAR(500))

---LIST OF TABLES TO SAVE
DECLARE @TXN_APPROVAL_CHECKLIST_LEVELS VARCHAR(100)



SET @TXN_APPROVAL_CHECKLIST_LEVELS='MSTLOC_XN_APPROVAL_CHECKLIST_LEVELS_UPLOAD'

BEGIN TRY
BEGIN TRANSACTION
		    SET @CSTEP=10
		    SET @CCMD =N'DELETE A FROM XN_APPROVAL_CHECKLIST_LEVELS A
		    JOIN '+@TXN_APPROVAL_CHECKLIST_LEVELS+' B ON A.LEVEL_CODE=B.LEVEL_CODE AND A.XN_TYPE=B.XN_TYPE 
		    WHERE B.[DELETE1]=1 
			AND B.SP_ID='''+@CSPID+''' '
		    PRINT @CCMD
		    EXEC SP_EXECUTESQL @CCMD
				

		    SET @CSTEP=20
            SET @CCMD = N'DELETE A FROM '+@TXN_APPROVAL_CHECKLIST_LEVELS+' A  WHERE A.[DELETE1]=1 AND A.SP_ID='''+@CSPID+''' '
		    PRINT @CCMD
		    EXEC SP_EXECUTESQL @CCMD
		    
			--VALIDATION FOR BLANK CHECKLIST_DESC
			SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TXN_APPROVAL_CHECKLIST_LEVELS+' WHERE ISNULL(LEVEL_DESC,'''')='''' AND SP_ID='''+@CSPID+''')
					        SET @CERRMSG=''LEVEL_DESC  CANNOT BE BLANK.'''
			PRINT @CCMD					        
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT
			
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC

			
			SET @CSTEP=70
			 SET @CCMD =N'DELETE A FROM XN_APPROVAL_CHECKLIST_LEVELS A
		    JOIN '+@TXN_APPROVAL_CHECKLIST_LEVELS+' B ON A.LEVEL_NO=B.LEVEL_NO AND A.XN_TYPE=B.XN_TYPE WHERE LEFT(B.LEVEL_CODE,5)=''LATER''
			and B.SP_ID='''+@CSPID+''' '
		    PRINT @CCMD
		    EXEC SP_EXECUTESQL @CCMD
			--VALIDATION FOR UNIQUE LEVEL_NO
			--SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TXN_APPROVAL_CHECKLIST_LEVELS+' A JOIN XN_APPROVAL_CHECKLIST_LEVELS B ON A.LEVEL_NO=B.LEVEL_NO
			--					  WHERE  A.XN_TYPE=B.XN_TYPE)
			--		        SET @CERRMSG=''LEVEL_NO ALREADY EXISTS.'''
			--PRINT @CCMD
			--EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC
				
	    SET @CSTEP=80
	    IF OBJECT_ID ('TEMPDB..#TMPXN_APPROVAL_CHECKLIST_LEVELS','U') IS NOT NULL
	        DROP TABLE #TMPXN_APPROVAL_CHECKLIST_LEVELS
	        
	        SELECT * INTO #TMPXN_APPROVAL_CHECKLIST_LEVELS FROM MSTLOC_XN_APPROVAL_CHECKLIST_LEVELS_UPLOAD WHERE 1>2
	       
	       	SET @CCMD=N'SELECT * FROM '+@TXN_APPROVAL_CHECKLIST_LEVELS+' A WHERE LEFT(LEVEL_CODE,5)=''LATER'' AND SP_ID='''+@CSPID+''''
			PRINT @CCMD
			INSERT INTO #TMPXN_APPROVAL_CHECKLIST_LEVELS
			EXEC SP_EXECUTESQL @CCMD
	       
	       
	       
	    WHILE(SELECT TOP 1 'U' FROM #TMPXN_APPROVAL_CHECKLIST_LEVELS) = 'U'
		BEGIN
		
		   SELECT TOP 1 @LEVEL_DESC=LEVEL_DESC FROM #TMPXN_APPROVAL_CHECKLIST_LEVELS
		  
		   
			SET @CSTEP=100
			LBL_GENARTKEY:
			EXEC GETNEXTKEY @CTABLENAME='XN_APPROVAL_CHECKLIST_LEVELS'
							,@CCOLNAME='LEVEL_CODE'
							,@NWIDTH='10'
							,@CPREFIX=''
							,@NLZEROS=1
							,@CFINYEAR=''
							,@NROWCOUNT=0
							,@CNEWKEYVAL=@CNEWLEVEL_CODE OUTPUT	
			
			
			
			IF ISNULL(@CNEWLEVEL_CODE,'')=''	
			BEGIN	
				SET @CERRMSG='ERROR GENERATING DEPARTMENT CODE.'
				GOTO END_PROC
			END	
			
			SET @CSTEP=110				
			IF EXISTS(SELECT TOP 1 'U' FROM XN_APPROVAL_CHECKLIST_LEVELS WHERE LEVEL_CODE=@CNEWLEVEL_CODE)
				GOTO LBL_GENARTKEY
			
			---UPDATE THE CHECKLIST_CODE IN ALL TEMP TABLES
			SET @CSTEP=120
			---UPDATING CHECKLIST_CODE IN SECTIONM
			SET @CCMD=N'UPDATE '+@TXN_APPROVAL_CHECKLIST_LEVELS+' SET LEVEL_CODE='''+@CNEWLEVEL_CODE+''' WHERE LEFT(LEVEL_CODE,5)=''LATER'' AND LEVEL_DESC = '''+@LEVEL_DESC+''' AND SP_ID='''+@CSPID+''' '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD 
			
						
		    SET @CCMD = N'DELETE FROM #TMPXN_APPROVAL_CHECKLIST_LEVELS WHERE LEVEL_DESC = '''+@LEVEL_DESC+''''
		    PRINT @CCMD
		    EXEC SP_EXECUTESQL @CCMD
		END	
				
	  DECLARE @CWHERECLAUSE VARCHAR(1000)
       SET @CWHERECLAUSE = ' SP_ID='''+LTRIM(RTRIM((@CSPID)))+''''
	--DELETE FROM XN_APPROVAL_CHECKLIST_LEVELS WHERE XN_TYPE =@XN_TYPE
	


	--UPDATING XN_APPROVAL_CHECKLIST_LEVELS MASTER
	EXEC UPDATEMASTERXN 
			 @CSOURCEDB=''
			,@CSOURCETABLE=@TXN_APPROVAL_CHECKLIST_LEVELS
			,@CDESTDB=''
			,@CDESTTABLE='XN_APPROVAL_CHECKLIST_LEVELS'
			,@CKEYFIELD1='LEVEL_CODE'
			,@CKEYFIELD2=''
			,@CKEYFIELD3=''
			,@LINSERTONLY=0
			,@CFILTERCONDITION=@CWHERECLAUSE
			,@LUPDATEXNS=0
			,@CXNTYPE=''
			,@LUPDATEONLY=0
			,@CUSERID=''
			,@BALWAYSUPDATE=1
	
END TRY
BEGIN CATCH 
	SET @CERRMSG='SAVETRAN_XN_APPROVAL_CHECKLIST_LEVELS: STEP - '+ISNULL(@CSTEP,'')+', MESSAGE - '+ERROR_MESSAGE() 
END CATCH

END_PROC:

IF @@TRANCOUNT>0  
 BEGIN  
  IF ISNULL(@CERRMSG,'')='' 
   COMMIT TRANSACTION  
  ELSE  
   ROLLBACK  
 END  
IF ISNULL(@CERRMSG,'')=''
	BEGIN
	SET @CSTEP=150
	SET @CCMD=N'SELECT LEVEL_CODE,'''' AS ERRMSG FROM '+@TXN_APPROVAL_CHECKLIST_LEVELS+' WHERE SP_ID='''+@CSPID+''''
	PRINT @CCMD		
	INSERT @TOUTPUT(LEVEL_CODE ,ERRMSG)			        
	EXEC SP_EXECUTESQL @CCMD
END
ELSE
BEGIN
INSERT @TOUTPUT(LEVEL_CODE ,ERRMSG)		
SELECT '',@CERRMSG 

IF (SELECT COUNT(*) FROM @TOUTPUT)=0
BEGIN
INSERT @TOUTPUT(LEVEL_CODE  ,ERRMSG)	
SELECT 'SUCESS',@CERRMSG
END

END



DELETE A FROM MSTLOC_XN_APPROVAL_CHECKLIST_LEVELS_UPLOAD A (NOLOCK) WHERE SP_ID=@CSPID



SELECT * FROM @TOUTPUT

END
--END OF PROCEDURE - SAVETRAN_XN_APPROVAL_CHECKLIST_LEVELS
