CREATE PROCEDURE SP_MALL_SALEDATA

AS
BEGIN
    DECLARE @CMALL_DATABASE_NAME VARCHAR(100),@CMEMOID VARCHAR(100),@LASTUPDATE DATETIME
    DECLARE @TABLENAME VARCHAR(100),@DTSQL NVARCHAR(MAX)
    SET @TABLENAME='SALE_DATA'
    
    SELECT TOP 1 @CMALL_DATABASE_NAME=VALUE  FROM CONFIG WHERE CONFIG_OPTION ='MALL_MGNET_DATABASE'
    SET @TABLENAME=@CMALL_DATABASE_NAME+@TABLENAME
    
    IF ISNULL(@CMALL_DATABASE_NAME,'')<>''
    BEGIN
        SET @DTSQL=N'IF OBJECT_ID ('''+@TABLENAME+''',''U'') IS NULL
           BEGIN
           SELECT POS_TILL_NO=CAST('''' AS  VARCHAR(100)), SHIFT_NO=CAST('''' AS  VARCHAR(100)),
                  RECEIPT_NO =CAST('''' AS  VARCHAR(10)), RECEIPT_DATETIME=CAST(NULL AS  DATETIME),
	              CUSTOMER_NAME=CAST('''' AS  VARCHAR(100)),CUSTOMER_GENDER=CAST('''' AS  VARCHAR(5)),
	              TRANSACTION_STATUS=CAST('''' AS  VARCHAR(10)),
	              ITEM_CODE=CAST('''' AS  VARCHAR(100)),ITEM_NAME=CAST('''' AS  VARCHAR(100)),
	              ITEM_QUANTITY=CAST(NULL AS  NUMERIC(18,3)), 
	              ITEM_PRICE=CAST(NULL AS  NUMERIC(18,2)),ITEM_CATEGORY=CAST('''' AS  VARCHAR(100)), 
	              DISCOUNT_AMOUNT=CAST(NULL AS  NUMERIC(18,2)),
	              TAX_NAME =CAST(NULL AS  NUMERIC(18,2)),
	              TAX_AMOUNT=CAST(NULL AS  NUMERIC(18,3)),TAX_TYPE=CAST('''' AS  VARCHAR(20)),
	              PAYMENT_NAME=CAST('''' AS  VARCHAR(100)),
	              EXCHANGE_RATE=CAST(NULL AS  NUMERIC(18,2)),  PAYMENT_AMOUNT=CAST(NULL AS  NUMERIC(18,2))
	              INTO '+@TABLENAME+'     
	              WHERE 1=2         
	       	
       
          END'
       PRINT @DTSQL
       EXEC SP_EXECUTESQL @DTSQL
        
        SET @DTSQL =N'SELECT TOP 1  @CMEMOID=A.CM_ID ,@LASTUPDATE=A.LAST_UPDATE 
                  FROM CMM01106 A (NOLOCK)
                  LEFT JOIN MALLDATA_LOG B ON A.CM_ID =B.XN_ID AND A.LAST_UPDATE =B.LAST_UPDATE 
                  WHERE A.CM_DT >=''2015-04-01'' AND B.XN_ID IS NULL 
                  AND ABS(DATEDIFF(S,A.LAST_UPDATE,GETDATE()))>600
                  ORDER BY A.LAST_UPDATE DESC'
        PRINT @DTSQL
       EXEC SP_EXECUTESQL @DTSQL,N'@CMEMOID VARCHAR(100) OUTPUT,@LASTUPDATE DATETIME OUTPUT',@CMEMOID OUTPUT ,@LASTUPDATE OUTPUT 
        
        IF ISNULL(@CMEMOID,'')<>''
        BEGIN
        DECLARE @PAYMODE_GRP_CODE VARCHAR(100)
    
        SELECT TOP 1 @PAYMODE_GRP_CODE=B.PAYMODE_GRP_CODE FROM PAYMODE_XN_DET A (NOLOCK)
        JOIN PAYMODE_MST B (NOLOCK) ON A.PAYMODE_CODE=B.PAYMODE_CODE  
        JOIN PAYMODE_GRP_MST C  (NOLOCK) ON B.PAYMODE_GRP_CODE=C.PAYMODE_GRP_CODE
        WHERE A.XN_TYPE='SLS' AND A.MEMO_ID =@CMEMOID AND B.PAYMODE_GRP_CODE='0000001' 
		
		IF ISNULL(@PAYMODE_GRP_CODE,'')=''
			SELECT TOP 1 @PAYMODE_GRP_CODE=B.PAYMODE_GRP_CODE FROM PAYMODE_XN_DET A (NOLOCK)
			JOIN PAYMODE_MST B (NOLOCK) ON A.PAYMODE_CODE=B.PAYMODE_CODE  
			JOIN PAYMODE_GRP_MST C  (NOLOCK) ON B.PAYMODE_GRP_CODE=C.PAYMODE_GRP_CODE
			WHERE A.XN_TYPE='SLS' AND A.MEMO_ID =@CMEMOID AND B.PAYMODE_GRP_CODE='0000002' 
       IF ISNULL(@PAYMODE_GRP_CODE,'')=''
       SET @PAYMODE_GRP_CODE='' 			
    DECLARE @RECEIPT_NO VARCHAR(10)
    SELECT TOP 1 @RECEIPT_NO=CM_NO FROM CMM01106 WHERE CM_ID =@CMEMOID
    
    SET @DTSQL=N'DELETE FROM '+@TABLENAME+' WHERE RECEIPT_NO='''+@RECEIPT_NO+''''
    PRINT @DTSQL
    EXEC SP_EXECUTESQL @DTSQL
    
	SET @DTSQL=N'INSERT INTO '+@TABLENAME+'
		 SELECT '''' AS POS_TILL_NO, '''' AS SHIFT_NO, A.CM_NO AS RECEIPT_NO, A.CM_DT AS RECEIPT_DATETIME,
				D.CUSTOMER_FNAME+'' ''+D.CUSTOMER_LNAME AS CUSTOMER_NAME, '''' AS CUSTOMER_GENDER,
				(CASE WHEN B.QUANTITY>0 THEN ''SALE'' ELSE ''RETURN'' END) AS TRANSACTION_STATUS,
				B.PRODUCT_CODE AS ITEM_CODE, SM.SECTION_NAME AS ITEM_NAME, B.QUANTITY AS ITEM_QUANTITY, 
				B.MRP AS ITEM_PRICE, SD.SUB_SECTION_NAME AS ITEM_CATEGORY, ((B.MRP*B.QUANTITY)-B.RFNET) AS DISCOUNT_AMOUNT,
				B.TAX_PERCENTAGE AS TAX_NAME, B.TAX_AMOUNT AS TAX_AMOUNT,(CASE WHEN TAX_METHOD=2 THEN ''EXCLUSIVE''
				ELSE ''INCLUSIVE'' END) AS TAX_TYPE,
				
				(CASE WHEN '''+RTRIM(LTRIM(@PAYMODE_GRP_CODE))+'''=''0000002'' THEN ''CREDIT/DEBIT CARDS'' 
				      WHEN '''+RTRIM(LTRIM(@PAYMODE_GRP_CODE))+'''=''0000001'' THEN ''CASH''
				ELSE ''OTHER'' END) AS PAYMENT_NAME,
				B.MRP AS EXCHANGE_RATE, A.NET_AMOUNT AS PAYMENT_AMOUNT	
		FROM CMM01106 A (NOLOCK)
		JOIN CMD01106 B (NOLOCK) ON A.CM_ID=B.CM_ID
		JOIN SKU C (NOLOCK) ON B.PRODUCT_CODE=C.PRODUCT_CODE
		JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=C.ARTICLE_CODE
		JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE=ART.SUB_SECTION_CODE
		JOIN SECTIONM SM (NOLOCK) ON SM.SECTION_CODE=SD.SECTION_CODE
		JOIN CUSTDYM D  (NOLOCK) ON A.CUSTOMER_CODE=D.CUSTOMER_CODE
        WHERE A.CM_ID='''+@CMEMOID+''''
    PRINT @DTSQL
    EXEC SP_EXECUTESQL @DTSQL
    
    DELETE FROM MALLDATA_LOG WHERE XN_ID=@CMEMOID
    INSERT INTO MALLDATA_LOG
    SELECT @CMEMOID,@LASTUPDATE 
    END       
    END
    SELECT ISNULL(@CMEMOID,'') AS MEMOID,'' AS ERRMSG

END
--END OF PROCEDURE SP_MALL_SALEDATA
