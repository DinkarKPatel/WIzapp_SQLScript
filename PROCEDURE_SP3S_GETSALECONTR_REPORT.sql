CREATE PROCEDURE SP3S_GETSALECONTR_REPORT
@CDEPTID VARCHAR(5),
@CSETUPCODE CHAR(5)
AS
BEGIN
	DECLARE @NROWSCNT NUMERIC(5,0)
	
	IF OBJECT_ID('TEMPDB..#TMPSALECONTR','U') IS NOT NULL
		DROP TABLE #TMPSALECONTR
		
	SELECT TOP 10 DEPT_ID,PARA_VAL,SOLD_QTY,SOLD_AMOUNT,QTY_CONTR_PCT,AMOUNT_CONTR_PCT
	INTO #TMPSALECONTR FROM DB_SALE_CONTR_SUMMARY WHERE SETUP_CODE=@CSETUPCODE AND DEPT_ID=@CDEPTID ORDER BY SOLD_AMOUNT DESC
	
	SET @NROWSCNT=@@ROWCOUNT

	IF EXISTS (SELECT TOP 1 A.PARA_VAL FROM DB_SALE_CONTR_SUMMARY A
			   LEFT OUTER JOIN #TMPSALECONTR B ON A.PARA_VAL=B.PARA_VAL
			   WHERE A.SETUP_CODE=@CSETUPCODE AND A.DEPT_ID=@CDEPTID AND B.DEPT_ID IS NULL)
		SELECT * FROM 
		(	   
		SELECT 1 AS SR_NO,* FROM #TMPSALECONTR
		UNION
		SELECT 2 AS SR_NO,'' AS DEPT_ID,'OTHERS' AS PARA_VAL,SUM(A.SOLD_QTY) AS SOLD_QTY,SUM(A.SOLD_AMOUNT) AS SOLD_AMOUNT,SUM(A.QTY_CONTR_PCT) AS QTY_CONTR_PCT,SUM(A.AMOUNT_CONTR_PCT) AS AMOUNT_CONTR_PCT 
		FROM DB_SALE_CONTR_SUMMARY A
		LEFT OUTER JOIN #TMPSALECONTR B ON A.PARA_VAL=B.PARA_VAL
		WHERE A.SETUP_CODE=@CSETUPCODE AND A.DEPT_ID=@CDEPTID AND B.DEPT_ID IS NULL
		) A
		ORDER BY SR_NO,PARA_VAL
	ELSE
		SELECT * FROM #TMPSALECONTR ORDER BY PARA_VAL
END
