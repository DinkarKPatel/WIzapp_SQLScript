CREATE PROCEDURE SP3S_EOSS_APPLY_SLSDISCTAX --(LocId 3 digit change by Sanjay:05-11-2024)
(
	@CPRODUCTCODEPARA  VARCHAR(50),
	@DXNDT	DATETIME,
	@BSALESSETUPINEFFECT BIT=0,
	@BESTEXMPTSALES BIT=0,
	@NCMMDISCAMT NUMERIC(10,2)=0.00,
	@NDISCPICKINGMODE INT=0,
	@CUSERCODE CHAR(7)='',
	@BAGSTPACKSLIP BIT=0,
	@CCUSTOMERCODE VARCHAR(12)='',
	@CDTCODE CHAR(7)='',
	@BCALLEDFROMSAVETRAN BIT=0,
	@NSPID VARCHAR(40)='0',
	@BCARDDISCOUNT BIT=0,
	@BCALLEDFROMMBOSLS BIT =0,
	@CLOCATIONID VARCHAR(5)='',
	@BDEBUGMODE BIT=0,
	@BCALLEDFROMPACKSLIP BIT=0,
	@BMRPEXCHANGEBILL BIT=0,
	@BCALLEDFROMONLINEAPI BIT=0,
	@BCALLEDFROMTESTEOSS BIT=0,
	@bDonotPickCardDisc bit=0
)
AS 
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@CPRODUCTCODE VARCHAR(100),@LRETVAL	BIT,@NMRP NUMERIC(10,2),
			@NQTY NUMERIC(10,2),@NNET NUMERIC(10,2),@BAPPLYEXCLTAX BIT,@BAPPLYEXCLTAXPARA BIT,
			@CAPPLYEXCLTAXONDISCITEMS VARCHAR(5),@CFROMDT VARCHAR(15),@CTODT VARCHAR(15),@NTAXMETHOD INT,
			@CLOCSSTMEMOID VARCHAR(40),@CAPPLYNEWEOSS VARCHAR(5),@BGETBCDISC BIT,@BMANUALCMMDISC BIT,
			@CROUNDITEMLEVEL VARCHAR(4),@BMANUALBILL BIT,@CERRORMSG VARCHAR(MAX),@BSALESSETUPDISABLED BIT,
			@CSTEP VARCHAR(4),@BAPPLYWIZCLIPDISCOUNTASFLAT BIT,@NADDNLDISCMODE INT,
			@NTOTECOUPONDISCOUNT NUMERIC(10,2),@NECOUPONDISCPCT NUMERIC(7,3),@CAPPLY_CUSTOMER_DISCOUNT VARCHAR(4),
  			@CAPPLY_DISCOUNT_LEVEL VARCHAR(4),@NCUSTDISCOUNT_EOSS NUMERIC(6,2),@NCUSTDISCOUNT_NORMAL NUMERIC(6,2),
  			@BWIZCLIPCUSTOMER BIT,@CWIZCLIPENABLED VARCHAR(4),@CPOSSCHEMEECOUPONID VARCHAR(20),
  			@BPICKCARDDISCFORSOLDITEMS BIT,@cHoLocId VARCHAR(4),@cApplyEossonFixMrp VARCHAR(4),
			@bDonotCheckStock BIT,@bSisLoc BIT

BEGIN TRY
	
	SET @CSTEP=10 
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
	SET @CERRORMSG=''
	
	
	--SET @BDEBUGMODE=1
	
	IF @CLOCATIONID=''
		SELECT TOP 1 @CLOCATIONID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
	

	SELECT TOP  1 @bSisLoc=ISNULL(sis_loc,0) FROM  location (NOLOCK) WHERE dept_id=@CLOCATIONID

	IF @NSPID IN ('','0')
		SET @NSPID=@@SPID
				
	SELECT TOP 1 @cHoLocId=value FROM config (NOLOCK) WHERE config_option='ho_location_id'

			
	SET @CPRODUCTCODE=@CPRODUCTCODEPARA
		
	SELECT C.ROW_ID,SUB_SECTION_CODE,C.TAX_PERCENTAGE,A.TAX_AC_CODE,C.TAX_METHOD,C.NET,
	C.MRP,C.QUANTITY,B.USER_CODE,C.TAX_AMOUNT,C.PRODUCT_CODE,C.CMM_DISCOUNT_AMOUNT,
	CONVERT(VARCHAR(40),'') AS PACK_SLIP_ID,C.DISCOUNT_PERCENTAGE,CONVERT(BIT,0) AS APPLY_EXCLUSIVE_TAX,
	CONVERT(NUMERIC(10,2),0) AS EXCLUSIVE_VAT_TO_DISC,C.DISCOUNT_AMOUNT  AS CMD_DISCOUNT_AMOUNT,
	CONVERT(VARCHAR(40),'') AS FORM_ID,CONVERT(BIT,0) AS MANUAL_TAX_METHOD
	INTO #TMPCMDTAX 
	FROM LOCSST A JOIN CMM01106 B (NOLOCK) ON 1=2
	JOIN CMD01106 C ON 1=2

	SET @CSTEP=20
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	DECLARE @TDENYEXCLTAX TABLE (USER_CODE CHAR(7))		 		

	PRINT 'SLSDISC-2'
	
	SELECT A.PRODUCT_CODE,CONVERT(CHAR(7),'') AS SUB_SECTION_CODE,A.QUANTITY,A.DISCOUNT_AMOUNT,A.QUANTITY AS SCHEME_APPLIED_QTY,
	A.DISCOUNT_AMOUNT AS SCHEME_APPLIED_AMOUNT,A.SLSDET_ROW_ID AS SCHEME_SETUP_DET_ROW_ID,A.SLSDET_ROW_ID AS SCHEME_ID,
	A.DISCOUNT_PERCENTAGE,A.MRP,A.NET,A.ROW_ID AS CMD_ROW_ID,A.PACK_SLIP_ID,CONVERT(CHAR(7),'') AS USER_CODE,
	A.DISCOUNT_PERCENTAGE AS BILL_LEVEL_DISCOUNT_PERCENTAGE,B.SCHEME_NAME AS SLS_TITLE,A.QUANTITY AS BNGN_QTY,
	A.DISCOUNT_AMOUNT AS BNGN_DISCOUNT,A.DISCOUNT_PERCENTAGE AS WEIGHTED_AVG_DISC_PCT,A.DISCOUNT_AMOUNT AS WEIGHTED_AVG_DISC_AMT,
	A.ITEM_ROUND_OFF,B.APPLY_EXCLUSIVE_TAX,B.EXCLUSIVE_VAT_TO_DISC,CONVERT(BIT,0) AS CARD_DISCOUNT,
	A.DISCOUNT_AMOUNT AS BILL_LEVEL_DISCOUNT_AMOUNT, CONVERT(CHAR(7),'') AS FORM_ID,A.ROW_ID AS PACK_SLIP_ROW_ID,
	MANUAL_TAX_METHOD,A.CARD_DISCOUNT_PERCENTAGE,A.BASIC_DISCOUNT_PERCENTAGE,A.CARD_DISCOUNT_AMOUNT,A.BASIC_DISCOUNT_AMOUNT,
	B.ROW_ID AS BNGN_ROW_ID,@nSpId as sp_id,CONVERT(BIT,0) AS cut_size,a.row_id as ref_cmd_row_id,scheme_discount,
	CONVERT(BIT,0) fix_mrp_item,a.mrp as cmd_mrp
	INTO #TMPCMD FROM CMD01106 A (NOLOCK) JOIN SCHEME_SETUP_DET B (NOLOCK) ON B.ROW_ID=A.SLSDET_ROW_ID WHERE 1=2
	
	SET @cStep=30
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	
	SET @BGETBCDISC=0
		
	IF @BCALLEDFROMSAVETRAN=1
		SELECT @BMANUALBILL=ISNULL(MANUAL_BILL,0),@BMANUALCMMDISC=(CASE WHEN (ISNULL(DP_CHANGED,0)=1 OR ISNULL(manual_discount,0)=1 OR
		ISNULL(DISCOUNT_CHANGED,0)=1 OR ISNULL(b.dt_code,'') NOT IN ('','0000000')) and isnull(loyalty_otp_code,'')='' and isnull(ecoupon_id,'')=''
		THEN 1 ELSE 0 END) FROM SLS_CMM01106_UPLOAD a (NOLOCK)
		LEFT JOIN dtm b (NOLOCK) ON a.dt_code=b.dt_code WHERE SP_ID=@NSPID
	ELSE
		SELECT @BMANUALBILL=0,@BMANUALCMMDISC=0
	
	IF @BMANUALBILL=1 OR @BMRPEXCHANGEBILL=1
		SET @BSALESSETUPINEFFECT=0						
	

	IF @bSisLoc=1
		SET @BSALESSETUPINEFFECT=1

	SELECT TOP 1 @cApplyEossonFixMrp=value FROM config (NOLOCK) WHERE config_option='APPLY_FIX_MRP_EOSS_AND_BILLPRINT'

	SET @cApplyEossonFixMrp=ISNULL(@cApplyEossonFixMrp,'')

	IF @CPRODUCTCODE<>''
	BEGIN
		SET @CSTEP=40
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

		DECLARE @cRowId varchar(40)
		set @cRowId=newid()
		INSERT #tmpCmd (PRODUCT_CODE,SUB_SECTION_CODE,QUANTITY,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,
		SCHEME_APPLIED_AMOUNT,SCHEME_SETUP_DET_ROW_ID,SCHEME_ID,DISCOUNT_PERCENTAGE,MRP,NET,
		CMD_ROW_ID,PACK_SLIP_ID,USER_CODE,BILL_LEVEL_DISCOUNT_PERCENTAGE,SLS_TITLE,BNGN_QTY,
		BNGN_DISCOUNT,WEIGHTED_AVG_DISC_PCT,WEIGHTED_AVG_DISC_AMT,ITEM_ROUND_OFF,APPLY_EXCLUSIVE_TAX,
		EXCLUSIVE_VAT_TO_DISC,CARD_DISCOUNT,BILL_LEVEL_DISCOUNT_AMOUNT,FORM_ID,PACK_SLIP_ROW_ID,
		MANUAL_TAX_METHOD,CARD_DISCOUNT_PERCENTAGE,BASIC_DISCOUNT_PERCENTAGE,CARD_DISCOUNT_AMOUNT,
		BASIC_DISCOUNT_AMOUNT,BNGN_ROW_ID,sp_id,cut_size,ref_cmd_row_id,fix_mrp_item,cmd_mrp)
			SELECT PRODUCT_CODE,B.SUB_SECTION_CODE,1 AS QUANTITY,0 AS DISCOUNT_AMOUNT,0 AS SCHEME_APPLIED_QTY,
			0 AS SCHEME_APPLIED_AMOUNT,'''' AS SCHEME_SETUP_DET_ROW_ID,'''' AS SCHEME_ID,
			0 AS DISCOUNT_PERCENTAGE,(CASE WHEN ISNULL(FIX_MRP_Applicable,0)=1 AND @cApplyEossonFixMrp='1' AND ISNULL(a.FIX_MRP,0)<>0
			THEN a.FIX_MRP ELSE  A.MRP END),
			(CASE WHEN ISNULL(FIX_MRP_Applicable,0)=1 AND @cApplyEossonFixMrp='1' AND ISNULL(a.FIX_MRP,0)<>0
			THEN a.FIX_MRP  ELSE  A.MRP END) AS NET,@cRowId AS CMD_ROW_ID,'' AS PACK_SLIP_ID,'' AS USER_CODE,
			0 AS BILL_LEVEL_DISCOUNT_PERCENTAGE ,'' AS SLS_TITLE,0 AS BNGN_QTY,0 AS BNGN_DISCOUNT,
			0 AS WEIGHTED_AVG_DISC_PCT,0 AS WEIGHTED_AVG_DISC_AMT,0 AS ITEM_ROUND_OFF,0 AS APPLY_EXCLUSIVE_TAX,0 AS EXCLUSIVE_VAT_TO_DISC,@BCARDDISCOUNT AS CARD_DISCOUNT,
			0 AS BILL_LEVEL_DISCOUNT_AMOUNT,'0000000'  AS FORM_ID,'' AS PACK_SLIP_ROW_ID,0 AS MANUAL_TAX_METHOD,
			0 AS CARD_DISCOUNT_PERCENTAGE,0 AS BASIC_DISCOUNT_PERCENTAGE,
			0 AS CARD_DISCOUNT_AMOUNT,0 AS BASIC_DISCOUNT_AMOUNT,'' AS BNGN_ROW_ID,@nSpId as sp_id,0 as cut_size,'' as ref_cmd_row_id,
			(CASE WHEN ISNULL(FIX_MRP_Applicable,0)=1 AND @cApplyEossonFixMrp='1' 
			AND ISNULL(a.FIX_MRP,0)<>0 AND ISNULL(a.fix_mrp,0)<>a.mrp 
			      THEN 1 ELSE 0 END) fix_mrp_item,a.mrp cmd_mrp
			FROM SKU A WITH (NOLOCK)
			JOIN ARTICLE B WITH (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE
			WHERE A.PRODUCT_CODE=@CPRODUCTCODE
		
		SET @BGETBCDISC=1
		
		IF @NDISCPICKINGMODE<>1
			GOTO LBLPICKLASTDISC				
	END				
    ELSE
    BEGIN
		SET @CSTEP=45
		IF @BCALLEDFROMSAVETRAN=1
		BEGIN
			PRINT 'INSERT #TMPCMD'+@NSPID
			SET @CSTEP=45.5
			EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

			DECLARE @cManualSchemeSetMemono VARCHAR(50)
			SET @cManualSchemeSetMemono=''
			SELECT TOP 1 @cManualSchemeSetMemono=ISNULL(manual_scheme_setup_memo_no,'')
			FROM sls_cmm01106_upload (NOLOCK) WHERE sp_id=@nSpId

			SET @CSTEP=45.8
			EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

			IF ISNULL(@cManualSchemeSetMemono,'')<>'' OR @bSisLoc=1
				UPDATE SLS_cmd01106_UPLOAD WITH (ROWLOCK) SET manual_discount=0,Manual_DP=0
				WHERE sp_id=@nSpId

			SET @CSTEP=46.5
			EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE


			INSERT #tmpCmd (PRODUCT_CODE,cmd_mrp,SUB_SECTION_CODE,QUANTITY,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,
				SCHEME_APPLIED_AMOUNT,SCHEME_SETUP_DET_ROW_ID,SCHEME_ID,DISCOUNT_PERCENTAGE,MRP,NET,
				CMD_ROW_ID,PACK_SLIP_ID,USER_CODE,BILL_LEVEL_DISCOUNT_PERCENTAGE,SLS_TITLE,BNGN_QTY,
				BNGN_DISCOUNT,WEIGHTED_AVG_DISC_PCT,WEIGHTED_AVG_DISC_AMT,ITEM_ROUND_OFF,APPLY_EXCLUSIVE_TAX,
				EXCLUSIVE_VAT_TO_DISC,CARD_DISCOUNT,BILL_LEVEL_DISCOUNT_AMOUNT,FORM_ID,PACK_SLIP_ROW_ID,
				MANUAL_TAX_METHOD,CARD_DISCOUNT_PERCENTAGE,BASIC_DISCOUNT_PERCENTAGE,CARD_DISCOUNT_AMOUNT,
				BASIC_DISCOUNT_AMOUNT,BNGN_ROW_ID,sp_id,cut_size,ref_cmd_row_id,fix_mrp_item)
			SELECT A.PRODUCT_CODE,(CASE WHEN @bSisLoc=1 THEN b.mrp ELSE ISNULL(a.mrp,0) END) AS cmd_mrp,C.SUB_SECTION_CODE,QUANTITY,
				(CASE WHEN @BSALESSETUPINEFFECT=1 THEN 0 ELSE ISNULL(A.DISCOUNT_AMOUNT,0) END) AS DISCOUNT_AMOUNT,
				0 AS SCHEME_APPLIED_QTY,0 AS SCHEME_APPLIED_AMOUNT,
				(CASE WHEN @BSALESSETUPINEFFECT=0  
				 AND isnull(loc.server_loc,0)=0 AND loc.dept_id<>@cHoLocId  THEN ISNULL(A.SLSDET_ROW_ID,'') ELSE '' END) SCHEME_SETUP_DET_ROW_ID,'' AS SCHEME_ID,
				(CASE WHEN @BSALESSETUPINEFFECT=1 THEN 0 ELSE A.DISCOUNT_PERCENTAGE END) AS DISCOUNT_PERCENTAGE,
				(CASE WHEN @bSisLoc=1 THEN b.mrp WHEN ISNULL(FIX_MRP_Applicable,0)=1 AND @cApplyEossonFixMrp='1' AND ISNULL(b.fix_mrp,0)<>0 AND a.QUANTITY>0
				THEN b.FIX_MRP ELSE  A.MRP END),
				(CASE WHEN @BSALESSETUPINEFFECT=1 THEN (CASE WHEN ISNULL(FIX_MRP_Applicable,0)=1 AND @cApplyEossonFixMrp='1' 
				AND ISNULL(b.FIX_MRP,0)<>0 AND a.QUANTITY>0	THEN b.FIX_MRP ELSE  A.MRP END)*a.QUANTITY ELSE A.NET END) as net,
				A.ROW_ID,(CASE WHEN @BAGSTPACKSLIP=1 THEN A.PACK_SLIP_ID ELSE '' END) AS PACK_SLIP_ID,
				(CASE WHEN @BAGSTPACKSLIP=1 THEN ISNULL(D.USER_CODE,@CUSERCODE) ELSE '' END) AS USER_CODE,
				(CASE WHEN ISNULL(CMM.DP_CHANGED,0)=1 OR ISNULL(CMM.DISCOUNT_CHANGED,0)=1 OR 
				(isnull(dtm.dt_code,'') NOT IN ('','0000000') AND ISNULL(dtm.dt_mode,0) IN  (0,1))
				 THEN CMM.DISCOUNT_PERCENTAGE ELSE 0 END) AS BILL_LEVEL_DISCOUNT_PERCENTAGE,
				'' AS SLS_TITLE,0 AS BNGN_QTY,0 AS BNGN_DISCOUNT,
				0 AS WEIGHTED_AVG_DISC_PCT,
				0 AS WEIGHTED_AVG_DISC_AMT,
				0 AS ITEM_ROUND_OFF,0 AS APPLY_EXCLUSIVE_TAX,0 AS EXCLUSIVE_VAT_TO_DISC,
				0 AS CARD_DISCOUNT,(CASE WHEN ISNULL(CMM.DP_CHANGED,0)=1 OR ISNULL(CMM.DISCOUNT_CHANGED,0)=1 OR
				ISNULL(dtm.dt_code,'') NOT IN ('','0000000') THEN CMM.DISCOUNT_AMOUNT ELSE 0 END) AS BILL_LEVEL_DISCOUNT_AMOUNT,
				ISNULL(A.FORM_ID,'0000000') AS FORM_ID,
				ISNULL(A.PACK_SLIP_ROW_ID,''),MANUAL_TAX_METHOD,0 AS CARD_DISCOUNT_PERCENTAGE,
				(CASE WHEN @BSALESSETUPINEFFECT=1 THEN 0 ELSE A.BASIC_DISCOUNT_PERCENTAGE END) AS BASIC_DISCOUNT_PERCENTAGE,
				0 AS CARD_DISCOUNT_AMOUNT,(CASE WHEN @BSALESSETUPINEFFECT=1 THEN 0 ELSE A.BASIC_DISCOUNT_AMOUNT END) 
				AS BASIC_DISCOUNT_AMOUNT,'' AS BNGN_ROW_ID,	A.sp_id,0 as cut_size,'' as ref_cmd_row_id,
				(CASE WHEN ISNULL(FIX_MRP_Applicable,0)=1 AND @cApplyEossonFixMrp='1' AND ISNULL(a.FIX_MRP,0)<>0 
				AND ISNULL(a.fix_mrp,0)<>a.mrp AND a.QUANTITY>0  THEN 1 ELSE 0 END) fix_mrp_item
				FROM SLS_CMD01106_UPLOAD A (NOLOCK)
				JOIN SLS_CMM01106_UPLOAD CMM (NOLOCK) ON CMM.CM_ID=A.CM_ID AND A.SP_ID=CMM.SP_ID
				JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
				JOIN ARTICLE C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE
				JOIN LOCATION LOC ON LOC.DEPT_ID=@CLOCATIONID
				LEFT OUTER JOIN RPS_MST D (NOLOCK) ON D.CM_ID=A.PACK_SLIP_ID
				LEFT JOIN dtm (NOLOCK) ON dtm.dt_code=cmm.dt_code
				WHERE A.SP_ID=@NSPID AND ((ISNULL(A.MANUAL_DISCOUNT,0)=0 AND ISNULL(A.MANUAL_DP,0)=0) OR ISNULL(loc.SIS_LOC,0)=1 OR cmm.ecoupon_id<>'')
				
			SET @CSTEP=48.9
			EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

				PRINT 'INSERTed #TMPCMD'+@NSPID
		END			
		ELSE
		BEGIN
			SET @CSTEP=55
			EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

			DECLARE @cXntype VARCHAR(20)
			SET @cXntype=(CASE WHEN @BCALLEDFROMSAVETRAN=1 THEN 'SLS' WHEN @BCALLEDFROMPACKSLIP=1 THEN 'RPS' ELSE 'TEOSS' END)

			--IF @cXnType='TEOSS'
			--	SET @bDonotCheckStock=1
			
			
			EXEC SP3S_FETCH_BATCHWISEBC
			@cXnType=@cXntype,
			@nSpid=@nSpid,
			@cLocationId=@CLOCATIONID,
			@bDonotCheckStock=@bDonotCheckStock,
			@CERRORMSG=@CERRORMSG OUTPUT,
			@CUSERCODE=@CUSERCODE

			IF ISNULL(@cErrormsg,'')<>''
				GOTO END_PROC
			

			SET @CSTEP=58.6
			EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

			SET @CCMD=N'INSERT #tmpCmd (PRODUCT_CODE,SUB_SECTION_CODE,QUANTITY,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,
						SCHEME_APPLIED_AMOUNT,SCHEME_SETUP_DET_ROW_ID,SCHEME_ID,DISCOUNT_PERCENTAGE,MRP,NET,
						CMD_ROW_ID,PACK_SLIP_ID,USER_CODE,BILL_LEVEL_DISCOUNT_PERCENTAGE,SLS_TITLE,BNGN_QTY,
						BNGN_DISCOUNT,WEIGHTED_AVG_DISC_PCT,WEIGHTED_AVG_DISC_AMT,ITEM_ROUND_OFF,APPLY_EXCLUSIVE_TAX,
						EXCLUSIVE_VAT_TO_DISC,CARD_DISCOUNT,BILL_LEVEL_DISCOUNT_AMOUNT,FORM_ID,PACK_SLIP_ROW_ID,
						MANUAL_TAX_METHOD,CARD_DISCOUNT_PERCENTAGE,BASIC_DISCOUNT_PERCENTAGE,CARD_DISCOUNT_AMOUNT,
						BASIC_DISCOUNT_AMOUNT,BNGN_ROW_ID,sp_id,cut_size,ref_cmd_row_id,fix_mrp_item,cmd_mrp)
						 SELECT A.PRODUCT_CODE,C.SUB_SECTION_CODE,QUANTITY,'+
						(CASE WHEN @BSALESSETUPINEFFECT=1 THEN '(CASE WHEN quantity<0 THEN a.discount_amount ELSE 0  END)' ELSE ' ISNULL(A.DISCOUNT_AMOUNT,0)' END)+' AS DISCOUNT_AMOUNT,0 AS SCHEME_APPLIED_QTY,
						0 AS SCHEME_APPLIED_AMOUNT,''''  AS SCHEME_SETUP_DET_ROW_ID,'''' AS SCHEME_ID,'+
						(CASE WHEN @BSALESSETUPINEFFECT=1 THEN '(CASE WHEN quantity<0 THEN a.DISCOUNT_PERCENTAGE ELSE 0  END)' ELSE ' A.DISCOUNT_PERCENTAGE ' END)+'
						AS DISCOUNT_PERCENTAGE,(CASE WHEN ISNULL(FIX_MRP_Applicable,0)=1 AND '''+@cApplyEossonFixMrp+'''=''1'' AND ISNULL(b.FIX_MRP,0)<>0
						and A.QUANTITY>0 THEN b.FIX_MRP ELSE  A.MRP END),A.NET,A.ROW_ID'+(CASE WHEN @BAGSTPACKSLIP=1 THEN ',A.PACK_SLIP_ID' ELSE ',''''' END)+' AS PACK_SLIP_ID'+
						(CASE WHEN @BAGSTPACKSLIP=1 THEN ','''+@CUSERCODE+'''' ELSE ',''''' END)+' AS USER_CODE,
						0 AS BILL_LEVEL_DISCOUNT_PERCENTAGE,'''' AS SLS_TITLE,0 AS BNGN_QTY,0 AS BNGN_DISCOUNT,0 AS WEIGHTED_AVG_DISC_PCT,
						0 AS WEIGHTED_AVG_DISC_AMT,0 AS ITEM_ROUND_OFF,0 AS APPLY_EXCLUSIVE_TAX,0 AS EXCLUSIVE_VAT_TO_DISC,
						0 AS CARD_DISCOUNT,0 AS BILL_LEVEL_DISCOUNT_AMOUNT,'+
						'''0000000'','''' AS PACK_SLIP_ROW_ID,0 AS MANUAL_TAX_METHOD,
						0 AS CARD_DISCOUNT_PERCENTAGE,'+(CASE WHEN @BSALESSETUPINEFFECT=1 THEN  '(CASE WHEN QUANTITY<0 THEN 
						ISNULL(A.BASIC_DISCOUNT_PERCENTAGE,0) ELSE 0  END)' ELSE 'ISNULL(A.BASIC_DISCOUNT_PERCENTAGE,0)' END)+' AS BASIC_DISCOUNT_PERCENTAGE,
						0 AS CARD_DISCOUNT_AMOUNT,'+(CASE WHEN @BSALESSETUPINEFFECT=1 THEN  '(CASE WHEN QUANTITY<0 THEN 
						ISNULL(A.BASIC_DISCOUNT_AMOUNT,0) ELSE 0  END)' ELSE 'ISNULL(BASIC_DISCOUNT_AMOUNT,0)' END)+' AS  BASIC_DISCOUNT_AMOUNT,'''' AS BNGN_ROW_ID,
						'''+@nSpId+''' as sp_id,0 as cut_size,'''' as ref_cmd_row_id,
						(CASE WHEN ISNULL(FIX_MRP_Applicable,0)=1 AND '''+@cApplyEossonFixMrp+'''=''1'' 
						AND ISNULL(b.FIX_MRP,0)<>0  AND ISNULL(b.fix_mrp,0)<>b.mrp AND a.quantity>0 THEN 1 ELSE 0 END) fix_mrp_item,
						b.mrp cmd_mrp
						FROM EossRPS_UPLOAD A (NOLOCK)
						JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
						JOIN ARTICLE C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE'+
						(CASE WHEN @BCALLEDFROMPACKSLIP=1 THEN ' WHERE ISNULL(A.MANUAL_DISCOUNT,0)=0' ELSE ' WHERE 1=1 ' END)+
						'  AND sp_id='''+@nSpId+''''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
		END	

		SET @CSTEP=62
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
		IF @BSALESSETUPINEFFECT=1
		BEGIN
			print 'normalize for eoss called'
			EXEC SP3S_NORMALIZE_for_eoss @nSpId
		END
    END		
	
	--IF @BCALLEDFROMPACKSLIP=1 AND @NSPID=188
	--	SELECT @BCALLEDFROMSAVETRAN,'BEFORE START',* FROM #TMPCMD
		
	SET @CSTEP=70
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
	SET @BAPPLYWIZCLIPDISCOUNTASFLAT=0

	SET @CPOSSCHEMEECOUPONID=''
			
	IF @BCALLEDFROMSAVETRAN=1
	BEGIN
		SET @CSTEP=80
		SELECT TOP 1 @NADDNLDISCMODE=ISNULL(ADDITIONAL_DISC_MODE,0) FROM SLS_COUPON_REDEMPTION_INFO_UPLOAD A WITH (NOLOCK)
		WHERE A.SP_ID=@NSPID AND ISNULL(ADDITIONAL_DISC_MODE,0)=2 
		
		IF @NADDNLDISCMODE=2
			SET @BAPPLYWIZCLIPDISCOUNTASFLAT=1
	
		SELECT TOP 1 @CPOSSCHEMEECOUPONID=A.ECOUPON_ID FROM SLS_cmm01106_uPLOAD A WITH (NOLOCK)
		WHERE A.SP_ID=@NSPID AND SUBSTRING(A.ECOUPON_ID,3,1)='$'
		
		SET @CPOSSCHEMEECOUPONID=ISNULL(@CPOSSCHEMEECOUPONID,'')
			
	END
	SET @cStep=82
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
	--SELECT 'BEFORE APPLYING EOSS',* FROM #TMPCMD	

	SELECT PRODUCT_CODE,CONVERT(NUMERIC(7,3),0) AS BASIC_DISCOUNT_PERCENTAGE,
	CMD_ROW_ID AS ROW_ID INTO #TMPSLSOLDDISC FROM #TMPCMD
	WHERE 1=2
	UNION
	SELECT DISTINCT A.PRODUCT_CODE,B.DISCOUNT_PERCENTAGE AS BASIC_DISCOUNT_PERCENTAGE,
	CMD_ROW_ID AS ROW_ID FROM #TMPCMD A
	JOIN RPS_DET B ON A.PRODUCT_CODE=B.PRODUCT_CODE AND A.PACK_SLIP_ROW_ID=B.ROW_ID
	WHERE 1=2

				
	IF @BAPPLYWIZCLIPDISCOUNTASFLAT=0 AND @BMRPEXCHANGEBILL=0
	BEGIN
		SET @CSTEP=90
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
		 
		PRINT 'EOSSGETDISC-1'
		
		IF @BCALLEDFROMPACKSLIP=0
			INSERT #TMPSLSOLDDISC (PRODUCT_CODE,BASIC_DISCOUNT_PERCENTAGE,ROW_ID)
			SELECT DISTINCT A.PRODUCT_CODE,B.DISCOUNT_PERCENTAGE AS BASIC_DISCOUNT_PERCENTAGE,
			CMD_ROW_ID AS ROW_ID 
			FROM #TMPCMD A
			JOIN RPS_DET B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE AND A.PACK_SLIP_ROW_ID=B.ROW_ID
			WHERE B.DISCOUNT_PERCENTAGE<>0 AND ISNULL(B.SLSDET_ROW_ID,'')='' AND ISNULL(B.MANUAL_DISCOUNT,0)=1
		 
		SET @CSTEP=95
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

		SELECT @bSisLoc=ISNULL(sis_loc,0) FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CLOCATIONID
		SET @BWIZCLIPCUSTOMER=0
			
		IF ISNULL(@CCUSTOMERCODE,'') NOT IN ('','000000000000') 
		BEGIN
			
			SELECT TOP 1  @BWIZCLIPCUSTOMER=isnull(wizclip,0) FROM location (nolock) WHERE dept_id=@CLOCATIONID
			
		END
		
		SET @CSTEP=98
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
	
		
		SELECT CMD_ROW_ID  ,LEFT(PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',PRODUCT_CODE)-1,-1),LEN(PRODUCT_CODE ))) PRODUCT_CODE  
		INTO #TMPCMDBASEBC
		FROM #TMPCMD WHERE CHARINDEX('@',PRODUCT_CODE )<>0
		       	
		--SELECT 'BEFORE EOSS',@CENABLEOPTIMIZEDSCHEMES AS 'OPTMIZED SCHEME',* FROM #TMPCMD
		--CHANGES FOR BATCH CODING
		       	       
		
		SET @CSTEP=102
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	--select 'before calling eoss', product_code,manual_discount,manual_dp, discount_percentage, discount_amount,basic_discount_amount,basic_discount_percentage, 
	--scheme_name, * from SLS_cmd01106_UPLOAD where sp_id='58ade032a9-e805-4348-bdb3-c9eb45c7859c'

	IF EXISTS (SELECT TOP 1 product_code FROM #tmpcmd)
			EXEC SP3S_EOSS_GETDISCOUNTS 
			@BSALESSETUPINEFFECT=@BSALESSETUPINEFFECT,
			@DXNDT=@DXNDT,
			@CUSERCODE=@CUSERCODE,
			@CCUSTOMERCODE=@CCUSTOMERCODE,
			@BGETBCDISC=@BGETBCDISC,
			@BMANUALBILL=@BMANUALBILL,
			@CLOCATIONID=@CLOCATIONID,
			@BMANUALCMMDISC=@BMANUALCMMDISC,
			@BWIZCLIPCUSTOMER=@BWIZCLIPCUSTOMER,		
			@BCALLEDFROMCASHMEMO=@BCALLEDFROMSAVETRAN,
			@NSPID=@NSPID,
			@BCALLEDFROMPACKSLIP=@BCALLEDFROMPACKSLIP,
			@CPOSSCHEMEECOUPONID=@CPOSSCHEMEECOUPONID,	
			@CERRORMSG=@CERRORMSG OUTPUT


		IF ISNULL(@CERRORMSG,'')<>'' OR @BGETBCDISC=1
			GOTO LBLLAST		

		
		--if @@spid=83
		--begin
		--	SELECT 'check tmpcmd AFTER EOSS',* FROM #TMPCMD			
		--	select 'check cmd after eoss', product_code, manual_discount,manual_dp,slsdet_row_id,basic_discount_percentage,card_discount_percentage, * from  SLS_cmd01106_UPLOAD where sp_id='5951c8cf3a-86f9-4950-bad3-77419e94ca39'
		--end

	END
	ELSE
	BEGIN
		SET @CSTEP=120
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	PRINT 'DO NOT APPLY SALES DISCOUNTS'
		SELECT @NTOTECOUPONDISCOUNT=SUM(CASE WHEN COUPON_DISC_PCT<>0 THEN ROUND(B.SUBTOTAL*COUPON_DISC_PCT/100,0) 
		ELSE COUPON_DISC_AMOUNT END) 
		FROM SLS_COUPON_REDEMPTION_INFO_UPLOAD A WITH (NOLOCK)
		JOIN SLS_CMM01106_UPLOAD B WITH (NOLOCK) ON A.SP_ID=B.SP_ID
	    WHERE A.SP_ID=@NSPID AND (COUPON_DISC_AMOUNT<>0 OR COUPON_DISC_PCT<>0) AND ISNULL(GV_DISCOUNT,0)<>1
	
		SELECT @NECOUPONDISCPCT=@NTOTECOUPONDISCOUNT/(CASE WHEN SUBTOTAL<>0 THEN SUBTOTAL ELSE ABS(SUBTOTAL_R) END)
		FROM SLS_CMM01106_UPLOAD WITH (NOLOCK) WHERE SP_ID=@NSPID AND (SUBTOTAL<>0 OR SUBTOTAL_R<>0)
		
		SET @CSTEP=130
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	SET @NECOUPONDISCPCT=ISNULL(@NECOUPONDISCPCT,0)
		
		UPDATE #TMPCMD SET BASIC_DISCOUNT_PERCENTAGE=0,BASIC_DISCOUNT_AMOUNT=0
				
		UPDATE A SET APPLY_EXCLUSIVE_TAX=(CASE WHEN ISNULL(B.EXCLUSIVE_VAT_TO_DISC,0)<=@NECOUPONDISCPCT
		THEN 1 ELSE 0 END),EXCLUSIVE_VAT_TO_DISC=B.EXCLUSIVE_VAT_TO_DISC
		FROM #TMPCMD A JOIN LOCATION B WITH (NOLOCK) ON 1=1
		WHERE B.DEPT_ID=@CLOCATIONID
		
	END
	
LBLTAXCALC:
	
	SET @CSTEP=140
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	DECLARE @CPickRoundITEMLEVELFromLoc VARCHAR(4)
	SELECT TOP 1 @CPickRoundITEMLEVELFromLoc = VALUE  FROM CONFIG WHERE  CONFIG_OPTION='Pick_SLS_ROUND_OFF_fromloc'
	
	if isnull(@CPickRoundITEMLEVELFromLoc,'')<>'1'
		SELECT TOP 1 @CROUNDITEMLEVEL = VALUE  FROM CONFIG WHERE  CONFIG_OPTION='SLS_ROUND_ITEM_NET'
	ELSE
		SELECT TOP 1 @CROUNDITEMLEVEL = sls_round_item_level  FROM location (NOLOCK) WHERE dept_id=@cLocationId

	SET @CROUNDITEMLEVEL=ISNULL(@CROUNDITEMLEVEL,'')
	
	DECLARE @CSCHEMESETDETROWID VARCHAR(40) 
	
	UPDATE A SET APPLY_EXCLUSIVE_TAX=(CASE WHEN ISNULL(C.APPLY_EXCLUSIVE_TAX_ON_ALL_TITLES,0)=1
	THEN ISNULL(C.APPLY_EXCLUSIVE_TAX_ON_ALL_TITLES,0) ELSE ISNULL(B.APPLY_EXCLUSIVE_TAX,0) END),
	EXCLUSIVE_VAT_TO_DISC=(CASE WHEN ISNULL(C.APPLY_EXCLUSIVE_TAX_ON_ALL_TITLES,0)=1 
	THEN ISNULL(C.EXCLUSIVE_VAT_TO_DISC_ON_ALL_TITLES,0) ELSE ISNULL(B.EXCLUSIVE_VAT_TO_DISC,0) END)
	FROM #TMPCMD A 
	JOIN SCHEME_SETUP_DET B WITH (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	JOIN SCHEME_SETUP_MST C WITH (NOLOCK) ON C.MEMO_NO=B.MEMO_NO
		
	SELECT TOP 1 @CSCHEMESETDETROWID=SCHEME_SETUP_DET_ROW_ID FROM #TMPCMD
	
	PRINT 'SCHEME ROW ID:'+@CSCHEMESETDETROWID
	
	IF @BCALLEDFROMSAVETRAN=1 OR @BCALLEDFROMPACKSLIP=1
	BEGIN
		SET @CSTEP=152
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
		
		IF @BCALLEDFROMSAVETRAN=1 AND @bSisLoc=0
		BEGIN
			SET @CCMD=N'INSERT #tmpCmd (PRODUCT_CODE,SUB_SECTION_CODE,QUANTITY,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,
						SCHEME_APPLIED_AMOUNT,SCHEME_SETUP_DET_ROW_ID,SCHEME_ID,DISCOUNT_PERCENTAGE,MRP,NET,
						CMD_ROW_ID,PACK_SLIP_ID,USER_CODE,BILL_LEVEL_DISCOUNT_PERCENTAGE,SLS_TITLE,BNGN_QTY,
						BNGN_DISCOUNT,WEIGHTED_AVG_DISC_PCT,WEIGHTED_AVG_DISC_AMT,ITEM_ROUND_OFF,APPLY_EXCLUSIVE_TAX,
						EXCLUSIVE_VAT_TO_DISC,CARD_DISCOUNT,BILL_LEVEL_DISCOUNT_AMOUNT,FORM_ID,PACK_SLIP_ROW_ID,
						MANUAL_TAX_METHOD,CARD_DISCOUNT_PERCENTAGE,BASIC_DISCOUNT_PERCENTAGE,CARD_DISCOUNT_AMOUNT,
						BASIC_DISCOUNT_AMOUNT,BNGN_ROW_ID,sp_id,cut_size,ref_cmd_row_id,fix_mrp_item,cmd_mrp)
						SELECT A.PRODUCT_CODE,C.SUB_SECTION_CODE,QUANTITY,A.DISCOUNT_AMOUNT,
						0 AS SCHEME_APPLIED_QTY,0 AS SCHEME_APPLIED_AMOUNT,'''' AS SCHEME_SETUP_DET_ROW_ID,'''' AS SCHEME_ID,
						A.DISCOUNT_PERCENTAGE ,(CASE WHEN ISNULL(FIX_MRP_Applicable,0)=1 AND '''+@cApplyEossonFixMrp+'''=''1'' AND ISNULL(b.FIX_MRP,0)<>0
						AND a.quantity>0	
						 THEN b.FIX_MRP ELSE  a.MRP END),A.NET,A.ROW_ID'+(CASE WHEN @BAGSTPACKSLIP=1 THEN ',A.PACK_SLIP_ID' ELSE ',''''' END)+
						' AS PACK_SLIP_ID'+(CASE WHEN @BAGSTPACKSLIP=1 THEN ',ISNULL(D.USER_CODE,'''+@CUSERCODE+''')' ELSE ',''''' END)+' AS USER_CODE,
						0 AS BILL_LEVEL_DISCOUNT_PERCENTAGE,'''' AS SLS_TITLE,0 AS BNGN_QTY,0 AS BNGN_DISCOUNT,0 AS WEIGHTED_AVG_DISC_PCT,
						0 AS WEIGHTED_AVG_DISC_AMT,0 AS ITEM_ROUND_OFF,0 AS APPLY_EXCLUSIVE_TAX,0 AS EXCLUSIVE_VAT_TO_DISC,
						0 AS CARD_DISCOUNT,0 AS BILL_LEVEL_DISCOUNT_AMOUNT,ISNULL(A.FORM_ID,''0000000''),A.PACK_SLIP_ROW_ID,MANUAL_TAX_METHOD,
						0  AS CARD_DISCOUNT_PERCENTAGE,A.BASIC_DISCOUNT_PERCENTAGE,0 AS CARD_DISCOUNT_AMOUNT,A.BASIC_DISCOUNT_AMOUNT,'''' AS BNGN_ROW_ID,
						'''+@nSpId+''' as sp_id,0 as cut_size,'''' as ref_cmd_row_id,
						(CASE WHEN ISNULL(FIX_MRP_Applicable,0)=1 AND '''+@cApplyEossonFixMrp+'''=''1'' 
						AND ISNULL(b.FIX_MRP,0)<>0  AND ISNULL(b.fix_mrp,0)<>b.mrp AND a.quantity>0 THEN 1 ELSE 0 END) fix_mrp_item,a.mrp cmd_mrp
						FROM SLS_CMD01106_UPLOAD A WITH (NOLOCK)
						JOIN SKU B WITH (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
						JOIN ARTICLE C WITH (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE'+
						(CASE WHEN @BAGSTPACKSLIP=1 THEN ' LEFT OUTER JOIN RPS_MST D WITH (NOLOCK) ON D.CM_ID=A.PACK_SLIP_ID' ELSE '' END)+
						' WHERE SP_ID='''+LTRIM(RTRIM(@NSPID))+''' AND (ISNULL(A.MANUAL_DISCOUNT,0)=1 OR ISNULL(A.MANUAL_DP,0)=1) '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD			
		END
		
LBLCUSTOMERDISC:
		
		SET @CSTEP=160
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

		UPDATE A SET BASIC_DISCOUNT_PERCENTAGE=ISNULL(B.BASIC_DISCOUNT_PERCENTAGE,0)
		FROM #TMPCMD A 
		JOIN #TMPSLSOLDDISC B ON A.CMD_ROW_ID=B.ROW_ID
		LEFT OUTER JOIN SCHEME_SETUP_DET C WITH (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=C.ROW_ID
		WHERE ISNULL(A.SCHEME_SETUP_DET_ROW_ID,'')='' AND ISNULL(B.BASIC_DISCOUNT_PERCENTAGE,0)<>0

		
		SET @BPICKCARDDISCFORSOLDITEMS=0
		IF @BMRPEXCHANGEBILL=0
			SET @BPICKCARDDISCFORSOLDITEMS=1
		
		IF @bDonotPickCardDisc=0
		BEGIN
			SET @CSTEP=170
			EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

			EXEC SP_GETCARD_DISCOUNT_PERCETAGE
			@CCUSTOMERCODE=@CCUSTOMERCODE,
			@DREFMEMODT=@DXNDT,
			@CPARACODE=@CPRODUCTCODEPARA,
			@BCALLEDFROMSALESETUPPROC=1,
			@BPICKCARDDISCFORSOLDITEMS=@BPICKCARDDISCFORSOLDITEMS,
			@BCALLEDFROMCASHMEMO=@BCALLEDFROMSAVETRAN,
			@NSPID=@NSPID,
			@CERRORMSG=@CERRORMSG OUTPUT
			
			IF ISNULL(@CERRORMSG,'')<>''
				GOTO END_PROC
		END	
 	END

LBLFINAL:	
	SET @CSTEP=180
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE


	UPDATE #TMPCMD SET BASIC_DISCOUNT_PERCENTAGE=100,BASIC_DISCOUNT_AMOUNT=MRP*QUANTITY
	WHERE BASIC_DISCOUNT_PERCENTAGE>100

	UPDATE #TMPCMD SET mrp=cmd_mrp WHERE fix_mrp_item=1 

	UPDATE #TMPCMD SET basic_discount_amount=
	(CASE WHEN basic_discount_percentage<>0 THEN ROUND(cmd_mrp-(net/QUANTITY),0) ELSE 0 END)*
	(CASE WHEN quantity<0 THEN -1 ELSE 1 END)
	WHERE fix_mrp_item=1 AND (basic_discount_percentage<>0 AND isnull(WEIGHTED_AVG_DISC_PCT,0)=0)

	UPDATE #TMPCMD SET  BASIC_DISCOUNT_PERCENTAGE=ROUND((basic_discount_amount/(cmd_mrp*QUANTITY)*100),2)
	WHERE fix_mrp_item=1 AND (basic_discount_percentage<>0 AND isnull(WEIGHTED_AVG_DISC_PCT,0)=0)

	---- APPLY ADDITIONAL WIZCLIP DISCOUNT ON SCHEME DISCOUNT IF IT IS APPLICABLE FOR WIZCLIP CUSTOMER ONLY    
    IF @BWIZCLIPCUSTOMER=1
    BEGIN
		SET @cStep=182
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

		UPDATE A SET BASIC_DISCOUNT_PERCENTAGE=(100-(((MRP-(MRP*ISNULL(BASIC_DISCOUNT_PERCENTAGE,0)/100))-
			((MRP-(MRP*ISNULL(BASIC_DISCOUNT_PERCENTAGE,0)/100))*ISNULL(B.ADDITIONAL_DISCOUNT_WIZCLIP_CUSTOMER,0)/100))/MRP)*100) 
		FROM #TMPCMD A 
		JOIN SCHEME_SETUP_DET B WITH (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
		LEFT OUTER JOIN (SELECT MANUAL_DP,MANUAL_DISCOUNT,ROW_ID FROM SLS_CMD01106_UPLOAD WITH (NOLOCK) WHERE SP_ID=@NSPID) C ON A.CMD_ROW_ID=C.ROW_ID		
		WHERE BASIC_DISCOUNT_PERCENTAGE<100 AND ISNULL(B.ADDITIONAL_DISCOUNT_WIZCLIP_CUSTOMER,0)<>0
		AND ISNULL(B.APPLY_ADDITIONAL_DISCOUNT_WIZCLIP_CUSTOMER,0)=1 AND ISNULL(C.MANUAL_DISCOUNT,0)=0
		AND ISNULL(C.MANUAL_DP,0)=0	AND ( VALIDATESCHEME_WIZCLIP_MODE=1 OR @CPOSSCHEMEECOUPONID<>'' )			
		AND mrp<>0

		UPDATE A SET WEIGHTED_AVG_DISC_PCT=BASIC_DISCOUNT_PERCENTAGE,WEIGHTED_AVG_DISC_AMT=A.MRP*A.QUANTITY*A.BASIC_DISCOUNT_PERCENTAGE/100
		FROM #TMPCMD A 
		JOIN SCHEME_SETUP_DET B WITH (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
		WHERE ISNULL(B.ADDITIONAL_DISCOUNT_WIZCLIP_CUSTOMER,0)<>0
		AND ISNULL(B.APPLY_ADDITIONAL_DISCOUNT_WIZCLIP_CUSTOMER,0)=1 AND WEIGHTED_AVG_DISC_PCT<>0
		AND ( VALIDATESCHEME_WIZCLIP_MODE=1 OR @CPOSSCHEMEECOUPONID<>'' )			
	END
	
	SET @cStep=185
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
	
		    
	UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=(100-(((MRP-(MRP*ISNULL(BASIC_DISCOUNT_PERCENTAGE,0)/100))-((MRP-(MRP*ISNULL(BASIC_DISCOUNT_PERCENTAGE,0)/100))
		*ISNULL(CARD_DISCOUNT_PERCENTAGE,0)/100))/MRP)*100) 
	WHERE mrp<>0

	PRINT 'UPDATE FINAL ITEM DISCOUNT'
	--SELECT 'BEFORE UPDATING FINAL DISC',* FROM #TMPCMD 
	
	UPDATE A SET BASIC_DISCOUNT_AMOUNT=A.MRP*A.QUANTITY*A.BASIC_DISCOUNT_PERCENTAGE/100 FROM #TMPCMD A
	LEFT OUTER JOIN (SELECT MANUAL_DP,MANUAL_DISCOUNT,ROW_ID FROM SLS_CMD01106_UPLOAD WITH (NOLOCK) WHERE SP_ID=@NSPID) B ON A.CMD_ROW_ID=B.ROW_ID
	LEFT OUTER JOIN SCHEME_SETUP_DET C WITH (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=C.ROW_ID
	WHERE (ISNULL(A.SCHEME_SETUP_DET_ROW_ID,'')='' OR C.ADDITIONAL_DISCOUNT_WIZCLIP_CUSTOMER<>0)
	AND ISNULL(B.MANUAL_DISCOUNT,0)=0 AND ISNULL(B.MANUAL_DP,0)=0

	SET @cStep=190
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	UPDATE #TMPCMD SET CARD_DISCOUNT_AMOUNT=(MRP-(ISNULL(BASIC_DISCOUNT_AMOUNT,0)/QUANTITY))*ISNULL(CARD_DISCOUNT_PERCENTAGE,0)*QUANTITY/100
	
	UPDATE #TMPCMD SET CARD_DISCOUNT_AMOUNT=MRP*QUANTITY WHERE CARD_DISCOUNT_PERCENTAGE BETWEEN 100 AND 100.5
	
	UPDATE #TMPCMD SET DISCOUNT_AMOUNT=ISNULL(BASIC_DISCOUNT_AMOUNT,0)+ISNULL(CARD_DISCOUNT_AMOUNT,0)
		
	UPDATE #TMPCMD SET NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT  WHERE 
	(ISNULL(SCHEME_SETUP_DET_ROW_ID,'')='' OR ISNULL(CARD_DISCOUNT_PERCENTAGE,0)<>0 OR DISCOUNT_PERCENTAGE>100
	 OR fix_mrp_item=1)
	
	UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=100 WHERE DISCOUNT_PERCENTAGE BETWEEN 100 AND 100.5
	
	UPDATE #TMPCMD SET BASIC_DISCOUNT_PERCENTAGE=100 WHERE BASIC_DISCOUNT_PERCENTAGE BETWEEN 100 AND 100.5
	
	UPDATE #TMPCMD SET CARD_DISCOUNT_PERCENTAGE=100 WHERE CARD_DISCOUNT_PERCENTAGE BETWEEN 100 AND 100.5
	
	UPDATE #TMPCMD SET CARD_DISCOUNT_PERCENTAGE=0 WHERE CARD_DISCOUNT_AMOUNT=0
	
	
	--SELECT 'AFTER FINAL DISC',* FROM #TMPCMD 
	UPDATE #TMPCMD SET ITEM_ROUND_OFF=0	

	IF @CROUNDITEMLEVEL='1'
		UPDATE #TMPCMD SET BASIC_DISCOUNT_AMOUNT=ROUND(BASIC_DISCOUNT_AMOUNT,0),
		DISCOUNT_AMOUNT=ROUND(isnull(BASIC_DISCOUNT_AMOUNT,0),0)+ISNULL(CARD_DISCOUNT_AMOUNT,0)
		WHERE SP_ID=@NSPID 

	UPDATE #TMPCMD SET NET=((MRP*QUANTITY)-DISCOUNT_AMOUNT)
		
		
	SET @CSTEP=200
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
	 	 
	
	 DECLARE @CSTATECODE VARCHAR(10)
	 
	 SELECT @CSTATECODE=A.STATE_CODE
	 FROM STATE A WITH (NOLOCK)
	 JOIN CITY B WITH (NOLOCK) ON B.STATE_CODE=A.STATE_CODE
	 JOIN AREA C WITH (NOLOCK) ON C.CITY_CODE=B.CITY_CODE
	 JOIN LOCATION D WITH (NOLOCK) ON D.AREA_CODE=C.AREA_CODE
	 WHERE D.DEPT_ID=(SELECT TOP 1 DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID ) 
	
	 SET @CSTATECODE=ISNULL(@CSTATECODE,'0000000')
	 
	 SET @CSTEP=210
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

   	 SELECT TOP 1 @CLOCSSTMEMOID = MEMO_ID FROM LOCSST_MST WITH (NOLOCK) 
   	 WHERE FROM_DT<=@DXNDT AND STATE_CODE=@CSTATECODE ORDER BY FROM_DT DESC


	DECLARE @BGSTBILL BIT,@CGSTCUTOFFDATE VARCHAR(20)
	SET @BGSTBILL=0
	
	SELECT TOP 1  @CGSTCUTOFFDATE=VALUE FROM CONFIG WHERE CONFIG_OPTION='GST_CUT_OFF_DATE'
	IF ISNULL(@CGSTCUTOFFDATE,'')<>''
	BEGIN
		IF @DXNDT>=CONVERT(DATE,@CGSTCUTOFFDATE)
			SET @BGSTBILL=1

	END

	SET @cStep=220
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	IF @BGSTBILL=0 AND ISNULL (@CGSTCUTOFFDATE,'')<>''
	BEGIN	
		 IF ISNULL(@CLOCSSTMEMOID,'') = ''  AND NOT EXISTS (SELECT TOP 1 PRODUCT_CODE FROM #TMPCMD WHERE ISNULL(FORM_ID,'0000000') NOT IN ('','0000000'))
		 BEGIN
			SET @CERRORMSG='NO TAX STRUCTURE DEFINED FOR THE CURRENT LOCATION'			
			GOTO LBLLAST
		 END
	END
 
	 SET @CSTEP=230
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	 INSERT #TMPCMDTAX (ROW_ID,SUB_SECTION_CODE,TAX_PERCENTAGE,TAX_AC_CODE,TAX_METHOD,NET,
	 MRP,QUANTITY,USER_CODE,TAX_AMOUNT,PRODUCT_CODE,CMM_DISCOUNT_AMOUNT,PACK_SLIP_ID,DISCOUNT_PERCENTAGE,
	 APPLY_EXCLUSIVE_TAX,EXCLUSIVE_VAT_TO_DISC,CMD_DISCOUNT_AMOUNT,FORM_ID,MANUAL_TAX_METHOD)
	 
	 SELECT CMD_ROW_ID,SUB_SECTION_CODE,0 AS TAX_PERCETAGE,'' AS TAX_AC_CODE,0 AS TAX_METHOD,
	 A.NET,A.MRP*A.QUANTITY AS MRP,A.QUANTITY AS QTY,ISNULL(B.USER_CODE,@CUSERCODE) AS USER_CODE,
	 0 AS TAX_AMOUNT,A.PRODUCT_CODE,0 AS CMM_DISCOUNT_AMOUNT,A.PACK_SLIP_ID,A.DISCOUNT_PERCENTAGE,
	 ISNULL(A.APPLY_EXCLUSIVE_TAX,0),ISNULL(A.EXCLUSIVE_VAT_TO_DISC,0) AS EXCLUSIVE_VAT_TO_DISC,
	 ((A.MRP*A.QUANTITY)-A.NET+A.ITEM_ROUND_OFF) AS DISCOUNT_AMOUNT,A.FORM_ID,A.MANUAL_TAX_METHOD
	 FROM #TMPCMD A  
	 LEFT OUTER JOIN RPS_MST B WITH (NOLOCK) ON B.CM_ID=A.PACK_SLIP_ID
	
	IF @BCALLEDFROMSAVETRAN=1
		UPDATE A SET TAX_METHOD=(CASE WHEN @BMRPEXCHANGEBILL=1 THEN 1 ELSE ISNULL(B.TAX_METHOD,0) END) FROM #TMPCMDTAX A 
		JOIN SLS_CMD01106_UPLOAD B WITH (NOLOCK) ON A.ROW_ID=B.ROW_ID
		WHERE B.SP_ID=@NSPID AND (ISNULL(B.MANUAL_TAX_METHOD,0)=1 OR B.QUANTITY<0)
		
	PRINT 'TAXCALC-6'	 	
	
	SET @CSTEP=240
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	
	DECLARE @TRETMSG TABLE  (ERRMSG VARCHAR(MAX))
	
	IF @BSALESSETUPINEFFECT=1
		SET @NCMMDISCAMT=0
			
	IF @BCALLEDFROMSAVETRAN=1
	BEGIN
		SET @CSTEP=250
		EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
		
		SELECT TOP 1 @BSALESSETUPDISABLED=ISNULL(CTRLS_USED,0),
		@NCMMDISCAMT=DISCOUNT_AMOUNT FROM SLS_CMM01106_UPLOAD WITH (NOLOCK) WHERE SP_ID=@NSPID

		DECLARE @CECOUPONID VARCHAR(40)
		
		SELECT TOP 1 @BSALESSETUPDISABLED=ISNULL(CTRLS_USED,0),@CECOUPONID=ECOUPON_ID,
		@NCMMDISCAMT=DISCOUNT_AMOUNT FROM SLS_CMM01106_UPLOAD WITH (NOLOCK) WHERE SP_ID=@NSPID
				
		IF ISNULL(@BMANUALCMMDISC,0)=0 AND @BSALESSETUPINEFFECT=1 AND ISNULL(@CECOUPONID,'')=''
		BEGIN
			SET @NCMMDISCAMT=0
			
			--IF @@SPID=269
			--	SELECT 'CHECK #TMPCMD',* FROM #TMPCMD
			
			SELECT TOP 1 @NCMMDISCAMT=BILL_LEVEL_DISCOUNT_AMOUNT FROM #TMPCMD
		END								
		
		IF ISNULL(@BSALESSETUPDISABLED,0)=1
			UPDATE #TMPCMDTAX SET TAX_METHOD=(CASE WHEN @BMRPEXCHANGEBILL=1 THEN 1 ELSE isnull(B.TAX_METHOD,0) END)
			FROM SLS_CMD01106_UPLOAD B WITH (NOLOCK) WHERE B.ROW_ID=#TMPCMDTAX.ROW_ID 
			AND B.SP_ID=@NSPID
		
	END
	
	SET @CSTEP=260
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	SET @BSALESSETUPDISABLED=ISNULL(@BSALESSETUPDISABLED,0)
	

	UPDATE #TMPCMDTAX SET CMM_DISCOUNT_AMOUNT=0
	
	SET @cStep=270
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
	PRINT 'RECAL WITH #TMPCMDTAX AT STEP#'+@CSTEP
	EXEC SP_RECAL_CMMDISC_CMD @NSPID,'',@NCMMDISCAMT
	
--	SELECT 'BEFORE APPLY SP_GETCMTAX',TAX_METHOD,* FROM #TMPCMDTAX
	PRINT 'CALL SP_GETCMTAX FROM APPLY SLSDISC TAX'
	
	SET @CSTEP=280
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	--SELECT 'AFTER APPLY SP_GETCMTAX',TAX_METHOD,* FROM #TMPCMDTAX	
	IF EXISTS (SELECT TOP 1 * FROM @TRETMSG WHERE ISNULL(ERRMSG,'')<>'')
		SELECT TOP 1 @CERRORMSG=ERRMSG FROM @TRETMSG WHERE ISNULL(ERRMSG,'')<>''	
	
	IF ISNULL(@CERRORMSG,'')<>''
		GOTO END_PROC
	
	IF @BCALLEDFROMSAVETRAN=1
	BEGIN	
		
		IF ((@BGSTBILL=1 AND @BCALLEDFROMPACKSLIP=0) OR (ISNULL(@CGSTCUTOFFDATE,'')='')) 
		BEGIN
			PRINT 'ENTER GST CALC-1'


			DECLARE @CALCULATE_GST_FOR_SLR VARCHAR(5)
			SELECT @CALCULATE_GST_FOR_SLR=VALUE  FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='CALCULATE_GST_FOR_SLR' 
				
			SET @cStep=290
			EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

			UPDATE A SET TAX_PERCENTAGE=0,TAX_AMOUNT=0 FROM #TMPCMDTAX A
			JOIN SLS_CMD01106_UPLOAD B WITH (NOLOCK) ON A.ROW_ID=B.ROW_ID 
			JOIN SLS_CMM01106_UPLOAD CMM WITH (NOLOCK) ON B.SP_ID =CMM.SP_ID 
			WHERE B.SP_ID=@NSPID 
			AND (B.QUANTITY>0 OR B.REF_SLS_MEMO_DT>'2017-06-30' OR ISNULL(@CALCULATE_GST_FOR_SLR,'')='1')
				
		END	
	END
			
	GOTO LBLLAST
	
END TRY

BEGIN CATCH
	
	SET @CERRORMSG='PROCEDURE SP3S_EOSS_APPLY_SLSDISCTAX STEP#'+@CSTEP+':'+ERROR_MESSAGE()
	PRINT 'ENTER CATCH BLOCK OF SP3S_EOSS_APPLY_SLSDISCTAX'+@CERRORMSG
	GOTO LBLLAST
END CATCH
	
LBLLAST:

		SET @cStep=300
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	PRINT 'COME TO LAST SP3S_EOSS_APPLY_SLSDISCTAX'
	
	IF ISNULL(@CERRORMSG,'')<>''
		GOTO END_PROC


	--SELECT 'CHECK SLSTAX',APPLY_EXCLUSIVE_TAX, * FROM #TMPCMD
	--if @@SPID=82
	--	SELECT 'CHECK SLSTAX',*  FROM #TMPslsdisctaxopt
		--IF NOT EXISTS(SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='#TMPSLSDISCTAXOPT' AND COLUMN_NAME='cess_amount')
		--	ALTER TABLE #TMPSLSDISCTAXOPT ADD cess_amount NUMERIC(14,2)
	

	IF @BCALLEDFROMSAVETRAN=1 OR ISNULL(@BCALLEDFROMMBOSLS,0)=1
		 INSERT #TMPSLSDISCTAXOPT
		( PRODUCT_CODE, SUB_SECTION_CODE, MRPVAL, DISCOUNT_PERCENTAGE, DISCOUNT_AMOUNT, NET, CMD_ROW_ID, USER_CODE, 
		  SLS_TITLE, ERRMSG, SCHEME_ID, ROW_ID, TAX_PERCENTAGE, TAX_AMOUNT,  TAX_AC_CODE, SALE_AC_CODE, 
		  BILL_LEVEL_DISCOUNT_PERCENTAGE, CMM_DISCOUNT_AMOUNT, WEIGHTED_AVG_DISC_PCT, WEIGHTED_AVG_DISC_AMT, 
		  ITEM_ROUND_OFF, BILL_LEVEL_DISCOUNT_AMOUNT, BASIC_DISCOUNT_PERCENTAGE, CARD_DISCOUNT_PERCENTAGE, 
		  BASIC_DISCOUNT_AMOUNT, CARD_DISCOUNT_AMOUNT,scheme_discount)  		 
 		 SELECT DISTINCT A.PRODUCT_CODE,A.SUB_SECTION_CODE,A.MRP*A.QUANTITY AS MRPVAL ,A.DISCOUNT_PERCENTAGE,
 		 ((A.MRP*A.QUANTITY)-A.NET+A.ITEM_ROUND_OFF) AS DISCOUNT_AMOUNT,
		 A.NET,CMD_ROW_ID,A.USER_CODE,ISNULL(C.SCHEME_NAME,a.sls_title) AS SLS_TITLE,ISNULL(@CERRORMSG,'') AS ERRMSG,
		 '' AS SCHEME_ID,SCHEME_SETUP_DET_ROW_ID AS ROW_ID,ISNULL(B.TAX_PERCENTAGE,0) AS TAX_PERCENTAGE,
		 ISNULL(B.TAX_AMOUNT,0) AS TAX_AMOUNT,
		 ISNULL(B.TAX_AC_CODE,'0000000000') AS TAX_AC_CODE,'0000000000' AS SALE_AC_CODE,
		 A.BILL_LEVEL_DISCOUNT_PERCENTAGE,ISNULL(B.CMM_DISCOUNT_AMOUNT,0) AS CMM_DISCOUNT_AMOUNT,
		 A.WEIGHTED_AVG_DISC_PCT,A.WEIGHTED_AVG_DISC_AMT,A.ITEM_ROUND_OFF,A.BILL_LEVEL_DISCOUNT_AMOUNT,
		 A.BASIC_DISCOUNT_PERCENTAGE,A.CARD_DISCOUNT_PERCENTAGE,A.BASIC_DISCOUNT_AMOUNT,A.CARD_DISCOUNT_AMOUNT,a.scheme_discount
		 FROM #TMPCMD A
		 LEFT OUTER JOIN #TMPCMDTAX B ON A.CMD_ROW_ID=B.ROW_ID
		 LEFT OUTER JOIN SCHEME_SETUP_DET C WITH (NOLOCK) ON C.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID
		 LEFT OUTER JOIN GST_TAXINFO_CALC D WITH (NOLOCK) ON D.PRODUCT_CODE=A.PRODUCT_CODE AND D.ROW_ID=A.CMD_ROW_ID AND D.SP_ID=@NSPID
	ELSE			 	
 		 SELECT DISTINCT A.PRODUCT_CODE,A.SUB_SECTION_CODE,A.MRP*A.QUANTITY AS MRPVAL ,A.DISCOUNT_PERCENTAGE,
 		 ((A.MRP*A.QUANTITY)-A.NET+A.ITEM_ROUND_OFF) AS DISCOUNT_AMOUNT,
		 A.NET,CMD_ROW_ID,A.USER_CODE,ISNULL(C.SCHEME_NAME,'') AS SLS_TITLE,ISNULL(@CERRORMSG,'') AS ERRMSG,
		 '' AS SCHEME_ID,SCHEME_SETUP_DET_ROW_ID AS ROW_ID,ISNULL(B.TAX_PERCENTAGE,0) AS TAX_PERCENTAGE,
		 ISNULL(B.TAX_AMOUNT,0) AS TAX_AMOUNT,ISNULL(B.TAX_METHOD,1) AS TAX_METHOD,
		 ISNULL(B.TAX_AC_CODE,'0000000000') AS TAX_AC_CODE,'0000000000' AS SALE_AC_CODE,
		 A.BILL_LEVEL_DISCOUNT_PERCENTAGE,ISNULL(B.CMM_DISCOUNT_AMOUNT,0) AS CMM_DISCOUNT_AMOUNT,
		 A.WEIGHTED_AVG_DISC_PCT,A.WEIGHTED_AVG_DISC_AMT,A.ITEM_ROUND_OFF,A.BILL_LEVEL_DISCOUNT_AMOUNT,
		 A.BASIC_DISCOUNT_PERCENTAGE,A.CARD_DISCOUNT_PERCENTAGE,A.BASIC_DISCOUNT_AMOUNT,A.CARD_DISCOUNT_AMOUNT,0 AS CESS_AMOUNT
		 FROM #TMPCMD A
		 LEFT OUTER JOIN #TMPCMDTAX B ON A.CMD_ROW_ID=B.ROW_ID
		 LEFT OUTER JOIN SCHEME_SETUP_DET C WITH (NOLOCK) ON C.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID
		
	GOTO END_PROC	

	

LBLPICKLASTDISC:
	
	SET @CSTEP=320
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE

	PRINT 'COME TO PICKLASTDISC'
	
	DECLARE @CDISCSLRMODE VARCHAR(4)
	
	SELECT TOP 1 @CDISCSLRMODE=ISNULL(DISCOUNT_PICKMODE_SLR,1) from location WHERE dept_id=@CLOCATIONID
	
	 --- This is done regarding asking for new option of applying Sale return discount with 2 options only now (1. Tolerance based 2.Max Discount)
	 --- Previous options have beed discarded now as per Tickit#0523-00163 (Date : 16-05-2023)
	 --- We have to manipulate the new option value as already reference of these value lies in multiple scheme procedures
	 IF ISNULL(@CDISCSLRMODE,0) IN (0,1) -- (1.Tolerance based(Default) 2.Max discount)
		SET @CDISCSLRMODE= 3
	 ELSE
		SET @CDISCSLRMODE = 1

	IF ISNULL(@CDISCSLRMODE,'')='3' AND @BMRPEXCHANGEBILL=0
		EXEC SP_WL_PICKLASTDISCOUNT	@CPRODUCTCODE,'',0,@BCALLEDFROMPACKSLIP	
	ELSE	
		SELECT 0 AS DISCOUNT_PERCENTAGE	
END_PROC:	
	


	PRINT 'ERROR IN EOSS_APPLYSLSDISC:'+@CERRORMSG
	--SELECT * FROM #TMPCMD
	SET @cStep=330
	EXEC SP_CHKXNSAVELOG 'SCH_TMP',@cStep,0,@NSPID,@BDEBUGMODE
		
	--SELECT @CERRORMSG AS ERROR_IN_EOSS,@BCALLEDFROMSAVETRAN
	IF @BCALLEDFROMSAVETRAN=1
	BEGIN
		INSERT #TEOSSERROR
		SELECT @CERRORMSG
		
	END	
	ELSE
		IF ISNULL(@CERRORMSG,'')<>''	
			SELECT @CERRORMSG AS ERRMSG
END
--*************************************** END OF PROCEDURE SP3S_EOSS_APPLY_SLSDISCTAX
