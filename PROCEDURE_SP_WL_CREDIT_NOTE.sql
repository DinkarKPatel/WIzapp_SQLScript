create PROCEDURE SP_WL_CREDIT_NOTE          --(LocId 3 digit change by Sanjay:30-10-2024)
          
 @NQUERYID NUMERIC (3,0) ,          
 @CMEMOID VARCHAR(40) = '',--party rate pick sp_id pass in memo_id          
 @CWHERE  VARCHAR(500) = '',          
 @NNAVMODE NUMERIC(1,0) = 0,          
 @CFINYEAR VARCHAR(5)='',          
 @CWHERE1 VARCHAR(500) = '',
 @CLOCID VARCHAR(500) = '',
 @DMEMODT DATETIME='' ,
 @NFINDOLDYEAR INT =0 
          
--  WITH ENCRYPTION        
AS          
BEGIN          
          
DECLARE @CCMD NVARCHAR(4000),@CONFIG_VALUE INT ,@cCutOffdate VARCHAR(100)          
select top 1 @cCutOffdate=value FROM config WHERE config_option='NEW_DATA_ARCHIVING_DATE'

DECLARE @CDO_NOT_ENFORCE_BILL_SELECTION_WSR VARCHAR(5)
 SELECT @CDO_NOT_ENFORCE_BILL_SELECTION_WSR=value FROM CONFIG WHERE CONFIG_OPTION='DO_NOT_ENFORCE_BILL_SELECTION_WSR'


IF ISNULL(@NNAVMODE,0)=0
SET @NNAVMODE=1

IF @NQUERYID IN(11,12) AND ISNULL(@cCutOffdate,'')<>'' and isnull(@NFINDOLDYEAR,0)=0 and isnull(@CWHERE1,'')<>''
BEGIN
    EXEC SP_WL_CREDIT_NOTE_PREVYEAR @NQUERYID,@CMEMOID,@CWHERE,@NNAVMODE,@CFINYEAR,@CWHERE1,@CLOCID,@DMEMODT
	GOTO LAST 
END
          
IF @NQUERYID = 1          
GOTO LBLNAVIGATE          
          
ELSE IF @NQUERYID = 2          
GOTO LBLGETMASTER          
          
ELSE IF @NQUERYID = 3          
GOTO LBLGETDETAIL          
          
ELSE IF @NQUERYID = 4          
GOTO LBLFORMS          
          
ELSE IF @NQUERYID = 5          
GOTO LBLCUSTOMER          
          
ELSE IF @NQUERYID = 6          
GOTO LBLSTOCKDETAILS          
          
ELSE IF @NQUERYID = 7          
GOTO LBLREPORTS          
ELSE IF @NQUERYID = 8          
GOTO LBLPRODUCTCODELIST          
ELSE IF @NQUERYID = 9           
GOTO LBLIMPRTLOG           
ELSE IF @NQUERYID = 10          
GOTO LBLGETBILL          
          
ELSE IF @NQUERYID = 11          
GOTO LBLGETBILLMASTER          
          
ELSE IF @NQUERYID = 12          
GOTO LBLGETBILLDET          
          
ELSE IF @NQUERYID = 13          
GOTO LBLGETBILLDETPASTE        
ELSE    IF @NQUERYID = 14   
	GOTO PYMTDETAILS
ELSE          
          
GOTO LAST     

PYMTDETAILS:
EXEC SP_PYMTDETAILS 1,'WSR',@CMEMOID  
GOTO LAST 
LBLNAVIGATE:          
          
 EXECUTE SP_NAVIGATE 'CNM01106',@NNAVMODE,@CMEMOID,@CFINYEAR,'CN_NO','CN_DT','CN_ID',@CWHERE          
          
GOTO LAST          
          
LBLGETMASTER:          
          
 SELECT CAST((CASE WHEN T1.XN_ITEM_TYPE  IN (1,4) THEN ISNULL(LOC.Enable_EInvoice,0) ELSE 0 END) AS BIT) AS Enable_EInvoice,ISNULL(LOC.loc_gst_no,'') AS loc_gst_no, (CASE WHEN T1.mode=2 THEN ISNULL(T5.loc_gst_no,'') ELSE ISNULL(T4.Ac_gst_no,'') END) AS [PARTY_GST_NO],
 T1.*,T2.USERNAME,         
 T4.AC_NAME,T4.ADDRESS0+' '+T4.ADDRESS1+' ' +T4.ADDRESS2+' '           
 +T4.AREA_NAME+' ' +T4.CITY+' ' +T4.[STATE]+' '+T4.PINCODE AS PARTY_ADDRESS,          
 ISNULL(T5.DEPT_NAME,'') AS PARTY_DEPT_NAME , ISNULL(T7.AC_NAME,'') AS BROKER_AC_NAME,         
 --CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT_EXCLUSIVE, 
 (TOTAL_GST_AMOUNT +FREIGHT_IGST_AMOUNT+FREIGHT_CGST_AMOUNT+
 FREIGHT_SGST_AMOUNT+OTHER_CHARGES_CGST_AMOUNT +
 OTHER_CHARGES_IGST_AMOUNT+OTHER_CHARGES_IGST_AMOUNT) AS TAX_AMOUNT_EXCLUSIVE,
 CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT_INCLUSIVE           
 ,B1.BIN_ID,B1.BIN_NAME,ISNULL(B2.BIN_NAME,'')AS SOURCE_BIN_NAME, 
 ISNULL(T4.PURCHASE_AGAINST_TERMS,0) AS [PURCHASE_AGAINST_TERMS],
 T.TERMS_NAME ,ST.GST_STATE_NAME AS PARTY_STATE_NAME,CAST('' AS VARCHAR(40)) AS SP_ID
 ,T4.Ac_gst_no AS [GST_NO],TD1.TDS_Name AS BROKER_TDS_NAME, T4.Ac_gst_no AS [PARTY_GST_NO]
  ,ISNULL(T1.FREIGHT_CGST_AMOUNT,0)+ISNULL(T1.FREIGHT_SGST_AMOUNT,0) +ISNULL(T1.FREIGHT_IGST_AMOUNT,0) AS  FREIGHT_GST_AMT,
     ISNULL(T1.FREIGHT,0)+CASE WHEN ISNULL(T1.OH_TAX_METHOD,0)=1 THEN
     ISNULL(T1.FREIGHT_CGST_AMOUNT,0)+ISNULL(T1.FREIGHT_SGST_AMOUNT,0) +ISNULL(T1.FREIGHT_IGST_AMOUNT,0) 
      ELSE 0 END AS FREIGHT_TOTAL,
	  ISNULL(T1.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(T1.OTHER_CHARGES_SGST_AMOUNT,0) +ISNULL(T1.OTHER_CHARGES_IGST_AMOUNT,0) AS  OTHER_CHARGES_GST_AMT,
     ISNULL(T1.OTHER_CHARGES,0)+CASE WHEN ISNULL(T1.OH_TAX_METHOD,0)=1 THEN
     ISNULL(T1.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(T1.OTHER_CHARGES_SGST_AMOUNT,0) +ISNULL(T1.OTHER_CHARGES_IGST_AMOUNT,0)
     ELSE 0 END AS OTHER_CHARGES_TOTAL,(CASE WHEN ISNULL(T1.shipping_same_as_billing_Add,0) <> 1 THEN ISNULL(SHIP.AC_NAME,'') ELSE '' END) AS SHIPPING_AC_NAME  
	 ,ISNULL(T4.lm_REMARKS,'') AS LEDGER_REMARKS
 FROM CNM01106 T1  (NOLOCK)   
 JOIN LOCATION LOC  (NOLOCK) ON LOC.dept_id=t1.location_Code   
 LEFT OUTER JOIN USERS T2 (NOLOCK)  ON T1.USER_CODE = T2.USER_CODE             
 JOIN LMV01106 T4 (NOLOCK) ON T4.AC_CODE = T1.AC_CODE          
 LEFT OUTER JOIN LOCATION T5 (NOLOCK) ON T5.DEPT_ID = T1.PARTY_DEPT_ID   
 LEFT OUTER JOIN LMV01106 T7 (NOLOCK) ON T7.AC_CODE = T1.BROKER_AC_CODE    
 LEFT OUTER JOIN LMV01106 SHIP (NOLOCK) ON SHIP.AC_CODE = T1.SHIPPING_AC_CODE    
 LEFT OUTER JOIN BIN B1(NOLOCK)  ON B1.BIN_ID=ISNULL(T1.BIN_ID,'000')
 LEFT OUTER JOIN BIN B2 (NOLOCK) ON B2.BIN_ID=T1.SOURCE_BIN_ID  
 LEFT OUTER JOIN LEDGER_TERMS T ON T.TERMS_CODE=T1.TERMS_CODE  
 LEFT OUTER JOIN GST_STATE_MST ST ON T1.PARTY_STATE_CODE=ST.GST_STATE_CODE
 LEFT OUTER JOIN TDS_SECTION TD1(NOLOCK) ON T1.BROKER_TDS_CODE= TD1.TDS_CODE
 WHERE T1.CN_ID = @CMEMOID          
           
GOTO LAST          
          
LBLGETDETAIL:          
           
   SELECT T1.*,0 AS S_NO,          
   T1.PRODUCT_CODE, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, S.PARA1_CODE,            
   C.PARA1_NAME, S.PARA2_CODE, D.PARA2_NAME, S.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,               
   T1.DEPT_ID, S.BARCODE_CODING_SCHEME AS CODING_SCHEME,  B.INACTIVE, 0 AS QUANTITY_IN_STOCK,            
   S.PURCHASE_PRICE,  S.MRP,S.WS_PRICE,  '' AS SCHEME_ID, SM.SECTION_NAME, SD.SUB_SECTION_NAME,            
   S.PARA4_CODE,S.PARA5_CODE,S.PARA6_CODE, INM.INV_DT AS REF_INV_DT,INM.INV_NO AS REF_INV_NO,           
   PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],            
   B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],S.DT_CREATED AS [SKU_DT_CREATED],            
   B.STOCK_NA, (T1.INVOICE_QUANTITY* T1.RATE)-T1.DISCOUNT_AMOUNT AS AMOUNT,         
   S.FIX_MRP,(CASE WHEN S.BARCODE_CODING_SCHEME=1 THEN S.PRODUCT_NAME ELSE B.ARTICLE_NAME END) AS [PRODUCT_NAME],FRM.FORM_NAME ,          
   CAST(0 AS INT) AS STK, EMP.EMP_NAME, EMP1.EMP_NAME AS EMP_NAME1,            
   EMP2.EMP_NAME AS EMP_NAME2,        
   (CASE WHEN  T1.BILL_LEVEL_TAX_METHOD = 2 THEN 'INCLUSIVE' ELSE 'EXCLUSIVE' END) AS TAX_METHOD_NAME         
   ,B1.BIN_ID,B1.BIN_NAME,B.ALIAS AS ARTICLE_ALIAS,B.ARTICLE_NAME,S.ONLINE_PRODUCT_CODE AS ONLINE_BAR_CODE,
   CP.PS_NO,CP.PS_DT,CAST('' AS VARCHAR(40)) AS SP_ID
 FROM CND01106 T1  (NOLOCK)        
 JOIN SKU S (NOLOCK) ON T1.PRODUCT_CODE = S.PRODUCT_CODE             
 JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE              
 JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE            
 JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE            
 JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE              
 JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE              
 JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE              
 JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE              
 JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE              
 JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE              
 JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE             
 LEFT JOIN FORM  FRM (NOLOCK) ON T1.ITEM_FORM_ID = FRM.FORM_ID         
 LEFT OUTER JOIN INM01106 INM (NOLOCK) ON INM.INV_ID= T1.REF_INV_ID        
 LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON T1.EMP_CODE= EMP.EMP_CODE                
 LEFT OUTER  JOIN EMPLOYEE EMP1 (NOLOCK) ON T1.EMP_CODE1= EMP1.EMP_CODE                
 LEFT OUTER  JOIN EMPLOYEE EMP2 (NOLOCK) ON T1.EMP_CODE2= EMP2.EMP_CODE  
 LEFT OUTER JOIN BIN B1 ON B1.BIN_ID=ISNULL(T1.BIN_ID,'000') 
 LEFT OUTER JOIN CNPS_MST CP ON T1.PS_ID= CP.PS_ID           
 WHERE T1.CN_ID = @CMEMOID        
 ORDER BY AUTO_SRNO DESC         
          
GOTO LAST          
          
LBLFORMS:          
          
 SELECT * FROM FORM (NOLOCK) WHERE FORM_ID <> '0000000' AND INACTIVE=0          
          
GOTO LAST          
          
LBLCUSTOMER:          
          
 DECLARE @CHEADCODESTR VARCHAR(max)  

 SELECT @CHEADCODESTR = DBO.FN_ACT_TRAVTREE('0000000018')
	SELECT LMV.AC_CODE, LMV.AC_NAME, LMV.ADDRESS0,LMV.ADDRESS1,LMV.ADDRESS2 AREA_NAME , LMV.CITY, LMV.[STATE],LMV.PINCODE ,
	ISNULL(LMV.DISCOUNT_PERCENTAGE,0) AS DISCOUNT_PERCENTAGE,LMV.INV_RATE_TYPE,LMV.FORM_ID, 
	ISNULL(LMV.DEFAULT_RATE_TYPE,1) AS DEFAULT_RATE_TYPE,LMV.BROKER_AC_CODE,LMV.RESTRICT_PUR_ENTRY,
	ISNULL(LMV.WSL_RATE_CALC_METHOD,1)AS WSL_RATE_CALC_METHOD
	,ISNULL(B.MBO_COUNTER,0) AS MBO_COUNTER
	,ISNULL(B.BIN_ID,'') AS BIN_ID
	,ISNULL(B.BIN_NAME,'') AS BIN_NAME
	,ISNULL(B.BIN_ALIAS,'') AS BIN_ALIAS,LMV.CREDIT_DAYS,LMV.STATE_CODE
	,ISNULL(LMV.Ac_gst_no,'') AS [GST_NO] ,ISNULL(LMV.ON_HOLD,0) AS ON_HOLD  
	,LMV.registered_gst_dealer,LMV.ac_gst_state_code
	,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE_1,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE_1
,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE_2,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE_2
,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE
,ISNULL(LMV.lm_REMARKS,'') AS LEDGER_REMARKS
	FROM LMV01106  LMV (NOLOCK)
	LEFT JOIN BIN B (NOLOCK) ON LMV.AC_CODE=B.MBO_LEDGER_AC_CODE
	LEFT OUTER JOIN PARTY_RATE_MST RATE_MST (NOLOCK) ON RATE_MST.MEMO_ID=LMV.PARTY_RATE_MEMO_ID
	WHERE (CHARINDEX(LMV.HEAD_CODE,@CHEADCODESTR)>0
	OR LMV.ALLOW_CREDITOR_DEBTOR=1) AND LMV.AC_CODE <>'0000000000' AND ISNULL(LMV.AC_NAME,'')<>''
	AND LMV.INACTIVE=0
	ORDER BY LMV.AC_NAME 
		
		    
          
            
GOTO LAST          
          
LBLSTOCKDETAILS:          
          
           
 SET @CCMD = N' SELECT TOP 1 T1.PRODUCT_CODE,T1.QUANTITY,T1.DEPT_ID,          
 B.ARTICLE_NO,T1.PRODUCT_CODE, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, S.PARA1_CODE,            
   C.PARA1_NAME, S.PARA2_CODE, D.PARA2_NAME, S.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,               
   T1.DEPT_ID, S.BARCODE_CODING_SCHEME AS CODING_SCHEME,  B.INACTIVE, ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,            
   S.PURCHASE_PRICE,  S.MRP,S.WS_PRICE,  '''' AS SCHEME_ID, SM.SECTION_NAME, SD.SUB_SECTION_NAME,            
   S.PARA4_CODE,S.PARA5_CODE,S.PARA6_CODE,            
   PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],            
   B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],S.DT_CREATED AS [SKU_DT_CREATED],            
   B.STOCK_NA,ISNULL(B1.QUANTITY,0) AS RET_QTY,          
 T1.RATE,T1.DISCOUNT_PERCENTAGE,T1.DISCOUNT_AMOUNT,S.FIX_MRP,S.PRODUCT_NAME,          
 F1.FORM_ID ,F1.TAX_PERCENTAGE,F1.FORM_NAME,B.ALIAS AS ARTICLE_ALIAS,B.ARTICLE_NAME           
 FROM IND01106 T1 (NOLOCK)         
 JOIN INM01106 T2 (NOLOCK) ON T1.INV_ID = T2.INV_ID          
 LEFT OUTER JOIN PMT01106 P (NOLOCK) ON T1.PRODUCT_CODE = P.PRODUCT_CODE AND P.DEPT_ID=T1.DEPT_ID            
  JOIN SKU S (NOLOCK) ON P.PRODUCT_CODE = S.PRODUCT_CODE             
  JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE              
  JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE            
  JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE            
  JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE              
  JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE              
  JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE              
  JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE              
  JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE              
  JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE              
  JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE            
  JOIN FORM F1 (NOLOCK) ON F1.FORM_ID=T1.ITEM_FORM_ID            
 LEFT OUTER JOIN           
 (          
   SELECT SUM(T4.QUANTITY) AS QUANTITY,T4.PRODUCT_CODE          
   FROM CND01106 T4  (NOLOCK)         
   JOIN CNM01106 T5 (NOLOCK) ON T4.CN_ID = T5.CN_ID          
   JOIN SKU T6 (NOLOCK) ON T4.PRODUCT_CODE = T6.PRODUCT_CODE           
   WHERE T5.AC_CODE = '''+@CWHERE+''' AND T4.PRODUCT_CODE = '''+@CMEMOID+'''          
   AND T5.CANCELLED = 0 GROUP BY T4.QUANTITY,T4.PRODUCT_CODE          
 )B1 ON T1.PRODUCT_CODE = B1.PRODUCT_CODE          
 WHERE T1.PRODUCT_CODE = '''+@CMEMOID+'''          
 AND T2.CANCELLED = 0'          
 PRINT @CCMD          
 EXECUTE SP_EXECUTESQL @CCMD   
          
GOTO LAST          
          
LBLREPORTS:          
          
 SELECT * FROM VW_WL_WSRINV_REP (NOLOCK) WHERE CN_ID = @CMEMOID          
          
GOTO LAST          
LBLPRODUCTCODELIST:          
          
            
  SELECT DISTINCT T3.ARTICLE_NO,T1.PRODUCT_CODE,T4.SUB_SECTION_NAME,T5.SECTION_NAME,T3.ARTICLE_CODE,
  T3.ALIAS AS ARTICLE_ALIAS            
  FROM IND01106 IND (NOLOCK)            
  JOIN INM01106 INM (NOLOCK) ON INM.INV_ID=IND.INV_ID            
  JOIN SKU T1 (NOLOCK)ON T1.PRODUCT_CODE=IND.PRODUCT_CODE                        
  JOIN ARTICLE T3 (NOLOCK) ON T1.ARTICLE_CODE = T3.ARTICLE_CODE            
  JOIN SECTIOND T4 (NOLOCK) ON T3.SUB_SECTION_CODE = T4.SUB_SECTION_CODE            
  JOIN SECTIONM T5 (NOLOCK) ON T5.SECTION_CODE = T4.SECTION_CODE            
  WHERE T1.PRODUCT_CODE <> '' AND INM.CANCELLED=0 AND INM.INV_MODE=1                   
  AND INM.DEPT_ID= @CWHERE          
  ORDER BY T1.PRODUCT_CODE            
           
 GOTO LAST          
          
LBLIMPRTLOG:          
   SELECT RM_ID,CN_ID,RECEIPT_DT FROM CNM01106 (NOLOCK)          
   WHERE RM_ID=@CWHERE          
             
             
   GOTO LAST          
          
LBLGETBILL:    
        
  SELECT A.INV_ID,COUNT(B.INV_NO) AS ITEMCOUNT            
  FROM IND01106 A (NOLOCK)            
  JOIN INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID             
  WHERE A.PRODUCT_CODE =@CWHERE1 AND B.INV_MODE=1 AND b.location_Code=@CLOCID 
  AND (B.AC_CODE = @CWHERE OR @CWHERE='')           
  GROUP BY  A.INV_ID            
GOTO LAST            
                 
                 
LBLGETBILLMASTER:            
     
    if object_id ('tempdb..#tmpmaster','u') is not null
	   drop table #tmpmaster
  
      SELECT DISTINCT CAST('' AS NVARCHAR(10)) AS SRNO, CAST(0 AS BIT) AS BILLCHECK,               
                      A.INV_ID,A.INV_NO,A.INV_DT,A.NET_AMOUNT , C.AC_NAME ,A.AC_CODE   
	  into #tmpmaster
      FROM INM01106 A (NOLOCK)            
      JOIN IND01106 B (NOLOCK) ON A.INV_ID=B.INV_ID              
      JOIN LMV01106 C (NOLOCK) ON A.AC_CODE = C.AC_CODE             
      WHERE A.CANCELLED = 0 AND B.QUANTITY > 0  
	  AND  (B.PRODUCT_CODE=@CWHERE1  OR B.PRODUCT_CODE LIKE @CWHERE1+'@%') 
      --AND B.PRODUCT_CODE=@CWHERE1  
	  AND A.INV_MODE=@NNAVMODE 
      --AND (A.AC_CODE = @CWHERE OR @CWHERE='')       --Appling This Filter on Application    
      ORDER BY A.INV_DT desc,A.INV_NO DESC  

	 
	 IF ISNULL(@CDO_NOT_ENFORCE_BILL_SELECTION_WSR,'')<>'1'
	 BEGIN
           
		    SELECT * FROM #TMPMASTER A
		    ORDER BY A.INV_DT desc,A.INV_NO --DESC 
	end
	else
	begin
	        SELECT TOP 1 * FROM #TMPMASTER A
		    ORDER BY (case when a.ac_code =@CWHERE then 0 else 1 End),
		    A.INV_DT DESC,A.INV_NO --DESC 

	end



      GOTO LAST            

                   
LBLGETBILLDET:            
	
	 DECLARE @CRATEPICKINGMODE VARCHAR(4),@BPARTYRATEFOUND BIT
	 
	 SET @BPARTYRATEFOUND=0
	 SELECT TOP 1 @CRATEPICKINGMODE=VALUE FROM CONFIG WHERE CONFIG_OPTION='RATE_PICKING_MODE'
	 
	 SET @CRATEPICKINGMODE=ISNULL(@CRATEPICKINGMODE,'1')
	 
	 IF OBJECT_ID('TEMPDB..#TMPSOLDDETAILS','U') IS NOT NULL
		DROP TABLE #TMPSOLDDETAILS
		
	 SELECT @CONFIG_VALUE= ISNULL(VALUE,0) FROM CONFIG WHERE CONFIG_OPTION ='DO_NOT_PICK_BILL_DISCOUNT'  
	 
	 SELECT IND.*,SKU.* INTO #TMPSOLDDETAILS  FROM              
	 (SELECT @CWHERE1 AS PC, PM.INV_ID,PM.INV_DT,PM.AC_CODE,PD.MRP, 
	 CONVERT(VARCHAR, PM.INV_DT, 105) AS INV_DATE, PM.INV_NO,L.AC_NAME AS DEBTOR,                     
	 PD.ITEM_TAX_AMOUNT, PD.ITEM_FORM_ID,                   
	 PD.ITEM_TAX_PERCENTAGE, --PMT.QUANTITY_IN_STOCK,                  
	 PD.RATE AS GROSS_RATE ,
	 EMP.EMP_NAME, EMP1.EMP_NAME AS EMP_NAME1,              
	 EMP2.EMP_NAME AS EMP_NAME2,PD.EMP_CODE,PD.EMP_CODE1,            
	 PD.EMP_CODE2,              
	 '' AS CITY,              
	 PD.DISCOUNT_PERCENTAGE AS IND_DISCOUNT_PERCENTAGE,    
	 CAST(PD.DISCOUNT_AMOUNT/(CASE WHEN PD.INVOICE_QUANTITY=0 THEN 1 ELSE PD.INVOICE_QUANTITY END) AS NUMERIC(14,2)) AS IND_DISCOUNT_AMOUNT,           
	 CAST( 0  AS BIT) AS BILLCHECK,
	 PD.QUANTITY as wsl_QUANTITY ,          
	 I.FORM_NAME,CAST(1 AS INT) AS STK ,          
	 PD.INVOICE_QUANTITY as wsl_INVOICE_QUANTITY ,          
	 PD.SCHEME_QUANTITY as wsl_SCHEME_QUANTITY ,   
	 
	 CAST(1 AS NUMERIC	(10,3)) AS INVOICE_QUANTITY,--AS PER ANIL SIR CHANGES DURRING WRONG PICK INVOICE QUANTITY
	 PM.BILL_LEVEL_TAX_METHOD ,        
	 PD.NET_RATE AS IND_RATE,     
	 (CASE WHEN  PM.DISCOUNT_PERCENTAGE=0 OR ISNULL(@CONFIG_VALUE,0)=1 THEN PD.NET_RATE ELSE (PD.NET_RATE-(PD.NET_RATE*PM.DISCOUNT_PERCENTAGE/100)) END) 
	  AS INV_NET_RATE,   
	 
        
	-- (CASE WHEN ISNULL(@CONFIG_VALUE,0)=1 THEN 0 ELSE CAST((PD.NET_RATE*PM.DISCOUNT_PERCENTAGE/100) AS NUMERIC(14,2)) END ) AS INM_DISCOUNT_AMOUNT,      
	 
	 -- comment 0n 11/01/23 As Per Req   client need inm discount
	 
	 --CASE WHEN (PD.RATE*PD.QUANTITY)>0 THEN   ((PD.DISCOUNT_AMOUNT +PD.INMDISCOUNTAMOUNT)*100)/(PD.RATE*PD.QUANTITY) ELSE 0 END as INM_DISCOUNT_PERCENTAGE  ,
     --(PD.DISCOUNT_AMOUNT +PD.INMDISCOUNTAMOUNT) AS INM_DISCOUNT_AMOUNT,
	  --Added
	  	 (CASE WHEN ISNULL(@CONFIG_VALUE,0)=1 THEN 0 ELSE PM.DISCOUNT_PERCENTAGE END) AS INM_DISCOUNT_PERCENTAGE,  
		 	 (CASE WHEN ISNULL(@CONFIG_VALUE,0)=1 THEN 0 ELSE (PD.INMDISCOUNTAMOUNT)/PD.INVOICE_QUANTITY  END) AS INM_DISCOUNT_AMOUNT,  

	 (CASE WHEN PM.BILL_LEVEL_TAX_METHOD = 1 THEN 'EXCLUSIVE' ELSE 'INCLUSIVE' END) AS TAX_METHOD_NAME ,PD.ROW_ID ,
	 PD.ORDER_NO,PD.ONLINE_BILL_REF_NO ,isnull(PD.BIN_ID,'000') as BIN_ID,bin.bin_name,
	 --party rate coumn use this column
	 ISNULL (PD.RATE,0) AS RATE ,
	 PD.DISCOUNT_PERCENTAGE DISCOUNT_PERCENTAGE ,
	 CAST(0 as numeric(14,2)) DISCOUNT_AMOUNT ,
	 CAST(0 as numeric(14,2)) NET_RATE 	 
	 FROM IND01106 PD (NOLOCK)               
	 JOIN INM01106 PM (NOLOCK) ON PD.INV_ID = PM.INV_ID               
	   	 
	 LEFT JOIN FORM I (NOLOCK) ON PD.ITEM_FORM_ID = I.FORM_ID     
	 JOIN LM01106 L (NOLOCK) ON PM.AC_CODE = L.AC_CODE                      
	 LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK)ON PD.EMP_CODE= EMP.EMP_CODE                  
	 LEFT OUTER JOIN EMPLOYEE EMP1 (NOLOCK) ON PD.EMP_CODE1= EMP1.EMP_CODE                  
	 LEFT OUTER JOIN EMPLOYEE EMP2 (NOLOCK) ON PD.EMP_CODE2= EMP2.EMP_CODE   
	 left join bin (nolock) on isnull(PD.BIN_ID,'000') =bin.bin_id 
	 WHERE PM.CANCELLED = 0 AND PM.INV_MODE=@NNAVMODE 
	 AND PD.QUANTITY > 0                    
	 AND  (PD.PRODUCT_CODE=@CWHERE1  OR PD.PRODUCT_CODE LIKE @CWHERE1+'@%') 
	 AND (PM.AC_CODE = @CWHERE OR @CWHERE='')          
	 ) IND
	 RIGHT OUTER JOIN 
	 (SELECT distinct  B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC,H.SECTION_NAME,G.SUB_SECTION_NAME,
	  @CWHERE1 AS PRODUCT_CODE, C.PARA1_NAME, D.PARA2_NAME,  E.PARA3_NAME, P4.PARA4_NAME, P5.PARA5_NAME , P6.PARA6_NAME,               
	  F.UOM_CODE, F.UOM_NAME,ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],             
	  ISNULL(J.DT_CREATED,'') AS [SKU_DT_CREATED],B.ALIAS AS ARTICLE_ALIAS,J.BARCODE_CODING_SCHEME AS CODING_SCHEME,B.DISCON,LM.AC_NAME
	  FROM SKU J 
	  JOIN ARTICLE B (NOLOCK) ON J.ARTICLE_CODE = B.ARTICLE_CODE                        
	  JOIN PARA1 C (NOLOCK) ON J.PARA1_CODE = C.PARA1_CODE                        
	  JOIN PARA2 D (NOLOCK) ON J.PARA2_CODE = D.PARA2_CODE                       
	  JOIN PARA3 E (NOLOCK) ON J.PARA3_CODE = E.PARA3_CODE                        
	  JOIN PARA4 P4 (NOLOCK) ON J.PARA4_CODE = P4.PARA4_CODE                        
	  JOIN PARA5 P5 (NOLOCK) ON J.PARA5_CODE = P5.PARA5_CODE                        
	  JOIN PARA6 P6 (NOLOCK) ON J.PARA6_CODE = P6.PARA6_CODE                         
	  JOIN UOM F (NOLOCK) ON B.UOM_CODE = F.UOM_CODE                       
	  JOIN SECTIOND G (NOLOCK) ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE                        
	  JOIN SECTIONM H (NOLOCK) ON G.SECTION_CODE = H.SECTION_CODE
	  LEFT JOIN LM01106 LM (NOLOCK) ON J.AC_CODE = LM.AC_CODE                       
	  WHERE 
	  (J.PRODUCT_CODE=@CWHERE1  OR J.PRODUCT_CODE LIKE @CWHERE1+'@%')
	 ) SKU ON IND.PC = SKU.PRODUCT_CODE
	               
	 ORDER BY IND.INV_DT DESC,INV_ID  DESC     
	 
	 UPDATE  #TMPSOLDDETAILS SET DISCOUNT_AMOUNT =(IND_DISCOUNT_AMOUNT+ISNULL(INM_DISCOUNT_AMOUNT,0)) ,NET_RATE =INV_NET_RATE
	 UPDATE  #TMPSOLDDETAILS SET DISCOUNT_PERCENTAGE  =(DISCOUNT_AMOUNT*100)/RATE  where INM_DISCOUNT_PERCENTAGE <>0
	       
	 -- AS DISCUSS WITH SANJIV SIR 22112024 TICK CONFIG PARTY RATE FORCELY PARTY RATE PICK 
	 --AND CONFIG TICK LAST LAST SALE IF LAST SALE NOT AVAILABLE THE PICK PARTY RATE
	 
	 IF (((NOT EXISTS (SELECT TOP 1 PRODUCT_CODE FROM #TMPSOLDDETAILS WHERE INV_ID IS NOT NULL) ) AND @CWHERE<>'' AND @CWHERE1<>'') OR  (@CRATEPICKINGMODE='2'))
	 BEGIN
		
		DECLARE @NSPID INT,@CCURLOCID VARCHAR(4),@CERRORMSG VARCHAR(MAX)
		
		SET  @NSPID=@CMEMOID
				
		DECLARE @TERRMSG TABLE (ERRMSG VARCHAR(MAX))
			
		
		IF  EXISTS (SELECT TOP 1 PARTY_RATE_MEMO_ID FROM WSL_INV_SETTINGS WHERE SP_ID=@NSPID AND ISNULL(PARTY_RATE_MEMO_ID,'')<>'')
		BEGIN
			
	
			SET @BPARTYRATEFOUND=1		
			DELETE FROM WSL_ITEM_DETAILS WHERE SP_ID=@NSPID
			
			INSERT WSL_ITEM_DETAILS	(PRODUCT_CODE,SP_ID,INVOICE_QUANTITY,QUANTITY,INV_DT )
			SELECT @CWHERE1,@NSPID,1,1,@DMEMODT as INV_DT
			
			EXEC SP3S_GETWSL_DATA
			@NSPID=@NSPID,
			@NMODE=1 ,
			@NUPDATEMODE=1,
			@CXNTYPE='WSR'
			
			
			PRINT 'UPDATE RATES FINALLY'
						
			--SELECT DISCOUNT_PERCENTAGE FROM WSL_ITEM_DETAILS WHERE SP_ID=@NSPID
			
				
			UPDATE 	#TMPSOLDDETAILS SET  Rate =B.RATE,DISCOUNT_AMOUNT=B.DISCOUNT_AMOUNT,
			DISCOUNT_PERCENTAGE=B.DISCOUNT_PERCENTAGE,NET_RATE=B.NET_RATE
			FROM WSL_ITEM_DETAILS B WHERE B.PRODUCT_CODE=#TMPSOLDDETAILS.PRODUCT_CODE AND B.SP_ID=@NSPID
			
			
			--UPDATE 	#TMPSOLDDETAILS SET  GROSS_RATE=B.RATE,IND_RATE=B.RATE,IND_DISCOUNT_AMOUNT=B.DISCOUNT_AMOUNT,
			--IND_DISCOUNT_PERCENTAGE=B.DISCOUNT_PERCENTAGE,INV_NET_RATE=B.NET_RATE
			--FROM WSL_ITEM_DETAILS B WHERE B.PRODUCT_CODE=#TMPSOLDDETAILS.PRODUCT_CODE AND B.SP_ID=@NSPID
			
			--SELECT GROSS_RATE,INV_NET_RATE,IND_RATE,IND_DISCOUNT_AMOUNT,IND_DISCOUNT_PERCENTAGE,INV_NET_RATE
			--FROM  #TMPSOLDDETAILS
		END
	 END
	 
	IF  (@CRATEPICKINGMODE<>'2' AND NOT EXISTS (SELECT TOP 1 PRODUCT_CODE FROM #TMPSOLDDETAILS WHERE ISNULL(INV_ID,'')<>'' ))
	    OR (@CRATEPICKINGMODE='2' AND @BPARTYRATEFOUND=0 AND NOT EXISTS (SELECT TOP 1 PRODUCT_CODE FROM #TMPSOLDDETAILS WHERE ISNULL(INV_ID,'')<>'' ))
	BEGIN    
		PRINT 'REUPDATE GROSS RATE'
			UPDATE 	#TMPSOLDDETAILS SET GROSS_RATE=(CASE WHEN  B.WS_PRICE=0 THEN B.MRP ELSE B.WS_PRICE END),
			IND_RATE=(CASE WHEN  B.WS_PRICE=0 THEN B.MRP ELSE B.WS_PRICE END),
			INV_NET_RATE=(CASE WHEN  B.WS_PRICE=0 THEN B.MRP ELSE B.WS_PRICE END)
			FROM SKU B WHERE B.PRODUCT_CODE=#TMPSOLDDETAILS.PRODUCT_CODE
	END
	



	IF ISNULL(@CDO_NOT_ENFORCE_BILL_SELECTION_WSR,'')<>'1'
	BEGIN

		SELECT   * FROM #TMPSOLDDETAILS  
		order by INV_DT desc ,INV_ID desc    
	END
	ELSE
	BEGIN

	    SELECT   TOP 1 * FROM #TMPSOLDDETAILS  
		order by INV_DT desc ,INV_ID desc   
	END
	 
	 GOTO LAST         
       
     
 LBLGETBILLDETPASTE:            
 
 SELECT @CONFIG_VALUE= ISNULL(VALUE,0) FROM CONFIG WHERE CONFIG_OPTION ='DO_NOT_PICK_BILL_DISCOUNT'
              
 SELECT TOP 1 PM.INV_ID,PM.INV_DT,PM.AC_CODE, F.UOM_TYPE, H.SECTION_NAME, G.SUB_SECTION_NAME, PD.PRODUCT_CODE,                  
 CONVERT(VARCHAR, PM.INV_DT, 105) AS INV_DATE, PM.INV_NO,LM.AC_NAME,L.AC_NAME AS DEBTOR,                    
 PD.MRP, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC,               
 C.PARA1_NAME, D.PARA2_NAME,  E.PARA3_NAME, P4.PARA4_NAME, P5.PARA5_NAME , P6.PARA6_NAME,               
 F.UOM_CODE, F.UOM_NAME, PD.ITEM_TAX_AMOUNT, PD.ITEM_FORM_ID,                   
 I.FORM_NAME,  PD.ITEM_TAX_PERCENTAGE,PD.RATE AS GROSS_RATE , ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],            
 ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],             
 ISNULL(J.DT_CREATED,'') AS [SKU_DT_CREATED],            
 EMP.EMP_NAME, EMP1.EMP_NAME AS EMP_NAME1,              
 EMP2.EMP_NAME AS EMP_NAME2,PD.EMP_CODE,PD.EMP_CODE1,            
 PD.EMP_CODE2, 
    
 (CASE WHEN  PM.DISCOUNT_PERCENTAGE=0 OR ISNULL(@CONFIG_VALUE,0)=1  THEN PD.NET_RATE ELSE (PD.NET_RATE-(PD.NET_RATE*PM.DISCOUNT_PERCENTAGE/100)) END) AS INV_NET_RATE,              

 PM.INV_NO ,J.BARCODE_CODING_SCHEME AS CODING_SCHEME,B.DISCON,'' AS CITY,              
 PD.DISCOUNT_PERCENTAGE AS IND_DISCOUNT_PERCENTAGE,    
 CAST(PD.DISCOUNT_AMOUNT/PD.INVOICE_QUANTITY AS NUMERIC(14,2)) AS IND_DISCOUNT_AMOUNT,       
 CAST( 0  AS BIT) AS BILLCHECK,PD.QUANTITY ,          
 I.FORM_NAME,CAST(1 AS INT) AS STK ,          
 PD.INVOICE_QUANTITY ,          
 PD.SCHEME_QUANTITY ,          
 PM.BILL_LEVEL_TAX_METHOD ,        
 PD.NET_RATE AS IND_RATE ,
  
 (CASE WHEN ISNULL(@CONFIG_VALUE,0)=1 THEN 0 ELSE PM.DISCOUNT_PERCENTAGE END) AS INM_DISCOUNT_PERCENTAGE,          
 (CASE WHEN ISNULL(@CONFIG_VALUE,0)=1 THEN 0 ELSE CAST((PD.NET_RATE*PM.DISCOUNT_PERCENTAGE/100) AS NUMERIC(14,2)) END ) AS INM_DISCOUNT_AMOUNT,      
  
 (CASE WHEN PM.BILL_LEVEL_TAX_METHOD = 1 THEN 'EXCLUSIVE' ELSE 'INCLUSIVE' END) AS TAX_METHOD_NAME,  
 B.ALIAS AS ARTICLE_ALIAS,B.ARTICLE_NAME,PD.ROW_ID                   
 FROM IND01106 PD (NOLOCK)               
 JOIN INM01106 PM (NOLOCK) ON PD.INV_ID = PM.INV_ID               
 JOIN SKU J (NOLOCK) ON PD.PRODUCT_CODE = J.PRODUCT_CODE                   
 JOIN ARTICLE B (NOLOCK) ON J.ARTICLE_CODE = B.ARTICLE_CODE                        
 JOIN PARA1 C (NOLOCK) ON J.PARA1_CODE = C.PARA1_CODE                        
 JOIN PARA2 D (NOLOCK) ON J.PARA2_CODE = D.PARA2_CODE                       
 JOIN PARA3 E (NOLOCK) ON J.PARA3_CODE = E.PARA3_CODE                        
 JOIN PARA4 P4 (NOLOCK) ON J.PARA4_CODE = P4.PARA4_CODE                        
 JOIN PARA5 P5 (NOLOCK) ON J.PARA5_CODE = P5.PARA5_CODE                        
 JOIN PARA6 P6 (NOLOCK) ON J.PARA6_CODE = P6.PARA6_CODE                         
 JOIN UOM F (NOLOCK) ON B.UOM_CODE = F.UOM_CODE                       
 JOIN SECTIOND G (NOLOCK) ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE                        
 JOIN SECTIONM H (NOLOCK) ON G.SECTION_CODE = H.SECTION_CODE                       
 JOIN FORM I (NOLOCK) ON PD.ITEM_FORM_ID = I.FORM_ID   
 JOIN LM01106 L (NOLOCK) ON PM.AC_CODE = L.AC_CODE                        
 LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK)ON PD.EMP_CODE= EMP.EMP_CODE                  
 LEFT OUTER JOIN EMPLOYEE EMP1 (NOLOCK) ON PD.EMP_CODE1= EMP1.EMP_CODE                  
 LEFT OUTER JOIN EMPLOYEE EMP2 (NOLOCK) ON PD.EMP_CODE2= EMP2.EMP_CODE             
 LEFT JOIN LM01106 LM (NOLOCK) ON J.AC_CODE = LM.AC_CODE                    
 WHERE PM.CANCELLED = 0 AND PM.INV_MODE=@NNAVMODE AND pm.location_Code=@CLOCID AND PD.QUANTITY > 0                    
 AND  PD.PRODUCT_CODE=@CWHERE1 AND (PM.AC_CODE = @CWHERE OR @CWHERE='')          
 ORDER BY PM.INV_DT DESC           
 GOTO LAST                
                   
LAST:            
END
