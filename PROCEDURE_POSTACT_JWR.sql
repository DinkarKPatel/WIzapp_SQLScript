create PROCEDURE POSTACT_JWR 
(
	@DTTO DATETIME,
	@CDEPTID CHAR(4)=''
)
AS
BEGIN
    DECLARE @CSTEP VARCHAR(10),@BPOSTDISCOUNTSEPARATELY BIT,@CDISCACCODE VARCHAR(10),@BPOSTFREIGHTSEPARATELY	BIT
			,@CFREIGHTACCODE VARCHAR(10),@BPOSTOCTROISEPARATELY BIT,@CJOBWORKACCODE VARCHAR(10),
			@BPOSTINSURANCESEPARATELY BIT,@CTDSACCODE VARCHAR(10),
			@BPOSTOTHERCHARGESSEPARATELY BIT,@COTHERCHARGESACCODE VARCHAR(10),@BPOSTROUNDOFFSEPARATELY BIT,@CROUNDOFFACCODE VARCHAR(10),@NCTR NUMERIC(10,0),
			@NSUBTOTAL NUMERIC(14,2),@NTAXAMOUNT NUMERIC(14,2), @CPURACCODE VARCHAR(50),@CTAXACCODE VARCHAR(100),
			@LPOSTTAXSEPARATELY NUMERIC(14,2),@CMEMOID VARCHAR(50),@LOUTSTATIONPARTY BIT,@TMPDR NUMERIC(14,2),
			@TMPCR NUMERIC(14,2),@CCURSTATECODE	VARCHAR(10),@CVMID	VARCHAR(40),@CLOCATIONID CHAR(2),
			@CLASTBILLNO VARCHAR(40),@DTMPVENDORBILLDT DATETIME,@CRMLIST VARCHAR(300),@NTMPCREDITDAYS NUMERIC(10),
			@NTMPCRDISCOUNTPERCENTAGE NUMERIC(14,2),@DLASTINVDT	DATETIME,@CVOUCHERCODE VARCHAR(10),
			@COLDBILLTYPE VARCHAR(10),@CLASTACCODE VARCHAR(10),@CLASTPARTYNAME VARCHAR(100),@NTOTQUANTITY NUMERIC(14,2),
			@NTOTNETAMOUNT NUMERIC(14,2),@CDEPTNAME VARCHAR(100),@CVOUCHERNO VARCHAR(10)
	SET @CSTEP=10
	DECLARE @CPARTYACCODE VARCHAR(10),@CPARTYSTATECODE VARCHAR(10),@NNETAMOUNT NUMERIC(14,2),
			@NDISCAMOUNT NUMERIC(14,2),@NFREIGHT NUMERIC(14,2),	@NOTHER NUMERIC(14,2),@NROUNDOFF NUMERIC(14,2),
			@NDRTOTAL NUMERIC(14,2),@NCRTOTAL NUMERIC(14,2),@CCUTOFFDATE VARCHAR(20),@CXNTYPE VARCHAR(10)
			,@CAC_CODE VARCHAR(20),@CVDID VARCHAR(40)
    
    SET @CFREIGHTACCODE=''
    SET @CROUNDOFFACCODE=''
    SET @CSTEP=20
    --THIS TABLE VARIABLE STORE ERROR OF OF MEMO ID
    DECLARE @ERRORS TABLE
	(
		XN_ID	VARCHAR(40),XN_TYPE VARCHAR(30),XN_NO VARCHAR(40),
		XN_DT DATETIME,XN_AMT NUMERIC(14,2),XN_AC VARCHAR(100),
		ERR_DESC VARCHAR(500)
	)   
    
    SET @CSTEP=30
    DECLARE @VCHC TABLE 
	(
		AC_CODE CHAR(10),NARRATION VARCHAR(200),XN_NO VARCHAR(30),
		XN_DT DATETIME,DEPT_ID CHAR(4),AMOUNT NUMERIC(14,4),XN_ID VARCHAR(22),
		REF_BILL_NO VARCHAR(50),REF_BILL_DATE DATETIME,	ENTRY_ID INT
		,CRDAYS NUMERIC(5)
	)
	
	SET @CSTEP=40
	DECLARE @VDC TABLE 
	(
		VD_ID VARCHAR(50),				VM_ID VARCHAR(40),				AC_CODE CHAR(10), 
		NARRATION VARCHAR(200),			DEBIT_AMOUNT NUMERIC(14,4),		CREDIT_AMOUNT NUMERIC(14,4),
		X_TYPE CHAR(2), 				VS_AC_CODE CHAR(10),	 		REF_BILL_NO VARCHAR(40), 
		CREDIT_DAYS NUMERIC(10),		CR_DISCOUNT_PERCENTAGE NUMERIC(14,2),		
		VAT_ENTRY BIT,REF_BILL_DATE DATETIME, AC_NAME VARCHAR(100)
	)
	
	SET @CSTEP=50
	DECLARE @VMC TABLE
	(
		VM_ID VARCHAR(400), 			VOUCHER_NO VARCHAR(400), 		VOUCHER_DT DATETIME, 
		VOUCHER_CODE CHAR(100), 		DEPT_ID CHAR(20),				BILL_TYPE VARCHAR(300),
		BILL_NO VARCHAR(200), 			BILL_ID VARCHAR(220), 			BILL_DT DATETIME, 
		BILL_AC_CODE VARCHAR(100),		DRTOTAL NUMERIC(20,2),			CRTOTAL NUMERIC(20,2), 
		CASH_VOUCHER BIT, 				SALE_VOUCHER BIT, 				QUANTITY NUMERIC(20,2), 
		ANGADIA_CODE CHAR(70), 			LR_NO VARCHAR(500), 			LR_DT DATETIME,
		PARTY_NAME VARCHAR(1000),		NET_AMOUNT NUMERIC(20,2), 		BILL_STATUS VARCHAR(1000),
		RM_LIST VARCHAR(3000), 		CANCELLED BIT,					DEPT_NAME VARCHAR(100),
		VOUCHER_TYPE VARCHAR(100)	
	)
	
	SET @CSTEP=60
	DECLARE @VLINK TABLE
	(
		VM_ID VARCHAR(100),MEMO_ID VARCHAR(100),XN_TYPE VARCHAR(20),LAST_UPDATE DATETIME
	)
	
	DECLARE @TBILL_BY_BILL_REF TABLE(VD_ID VARCHAR(40),REF_NO VARCHAR(40),AMOUNT NUMERIC(18,4),LAST_UPDATE DATETIME
								,X_TYPE VARCHAR(20),CR_DAYS NUMERIC(5),REF_TYPE VARCHAR(10))
	
	SELECT TOP 1 @CCUTOFFDATE=CUTOFFDATE
	FROM JWRCONFIGMST
	
	SET @CCUTOFFDATE=ISNULL(@CCUTOFFDATE,'')
	
	SET @CSTEP=70
	SET @CVOUCHERCODE = '0000000006'
    BEGIN TRY
			
			SET @CSTEP=80
			IF OBJECT_ID('TEMPDB..#POSTS','U') IS NOT NULL
				DROP TABLE #POSTS 
			
			SET @CSTEP=90
			--THIS TABLE STORE ALL PENDING MEMO_ID 
			CREATE TABLE #POSTS (MEMO_ID VARCHAR(30),MODE VARCHAR(10))
			
			SET @CSTEP=100
			--GETTING LIST OF JOBWORK RECEIVE INVOICES THAT QUALIFY FOR VOUCHER POSTING
			INSERT INTO #POSTS (MEMO_ID,MODE)
	        SELECT A.RECEIPT_ID,'JWR' AS MODE 
	        FROM JOBWORK_RECEIPT_MST A
	        JOIN LOCATION SL ON SL.DEPT_ID =a.location_Code 
	        LEFT OUTER JOIN 
	        (
				SELECT B.MEMO_ID,B.LAST_UPDATE
				FROM POSTACT_VOUCHER_LINK B 
				JOIN VM01106 C ON C.VM_ID = B.VM_ID 
				WHERE C.CANCELLED=0 AND B.XN_TYPE = 'JWR' 
	        )VM  ON A.RECEIPT_ID = VM.MEMO_ID  
	        WHERE  
	         -- POSTING ONLY COMPANY OWN OR POSTING MARK IN FRANCHIES
            (ISNULL(SL.LOC_TYPE,0)=1 OR ISNULL(SL.ACCOUNT_POSTING_AT_HO,0)=1) AND 
	        /*JOBWORK RECEIVE IS NOT CANCELLED.*/
	        A.CANCELLED=0	 
	        /*JOBWORK RECEIVE RECEIPT_DT IS LESS THAN THE SPECIFIED DATE.*/
	        AND A.RECEIPT_DT <= @DTTO
	        /*IF CUTOFF DATE IS SPECIFIED, CONSIDER JOBWORK RECEIVE AFTER THE CUTOFF DATE*/
	        AND (ISNULL(@CCUTOFFDATE,'')='' OR A.RECEIPT_DT>@CCUTOFFDATE)
	        /*IF ACCOUNTS_DEPT_ID IS FILLED UP APPLY FILTER TO LOCATION.*/
	        AND (ISNULL(@CDEPTID,'')='' OR a.location_Code =@CDEPTID)
	        /*JOBWORK RECEIVE IS NOT POSTED OR CORRESPONDING VOUCHER IS NOT CANCELLED*/
	        AND (VM.MEMO_ID IS NULL OR VM.LAST_UPDATE <> A.LAST_UPDATE) 
	        
			SET @CSTEP=230
			SELECT @CJOBWORKACCODE = ISNULL(JWRAC,'')
			FROM JWRCONFIGMST
		   
			SET @CSTEP=240
			SET @CJOBWORKACCODE=ISNULL(@CJOBWORKACCODE,'')
			
			SET @CSTEP=250
			IF @CJOBWORKACCODE = '' OR @CJOBWORKACCODE = '0000000000'
			BEGIN
				INSERT @ERRORS (XN_TYPE, ERR_DESC ) 
				VALUES ( 'JWR', 'JOBWORK A/C NOT CONFIGURED.PLEASE CONFIGURE.')
				
				GOTO ENDPROC
			END
			
			SET @CSTEP=260
			SELECT @CTDSACCODE = ISNULL(TDSAC,'')
			FROM JWRCONFIGMST
		   
			SET @CSTEP=270
			SET @CTDSACCODE=ISNULL(@CTDSACCODE,'')
			
			SET @CSTEP = 290
			--IF ROUND OFF IS CONSIDERED AS PART OF STOCK THEN CLUB IT IN JOBWORK RECEIVE A/C OTHERWISE POST SEPARATELY
			SELECT @BPOSTROUNDOFFSEPARATELY = ISNULL(POSTROFFSPRTLY, 0)
			FROM JWRCONFIGMST

			SET @CSTEP = 300
			SET @BPOSTROUNDOFFSEPARATELY=ISNULL(@BPOSTROUNDOFFSEPARATELY,0)
			
			SET @CSTEP = 310
			SELECT @CROUNDOFFACCODE = ISNULL(ROFFAC,'')
			FROM JWRCONFIGMST
			
			SET @CSTEP = 320
			SET @CROUNDOFFACCODE=ISNULL(@CROUNDOFFACCODE,'')
		
			SET @CSTEP = 330
			CREATE INDEX IX_TEMP_WSLTABLE_RM_ID ON #POSTS(MEMO_ID)
		
			SET @CSTEP=340
			---GETTING LIST OF ALL ERROR FROM JOBWORK RECEIVE AND CONVERT MRN TO BILL
			INSERT INTO @ERRORS(XN_ID,XN_NO ,XN_TYPE,ERR_DESC)
			--GETTING ERROR LIST FROM JOBWORK RECEIVE BILLS
			SELECT DISTINCT JRM.RECEIPT_ID,JRM.CHALLAN_NO  AS INV_NO,'JWR' AS XN_TYPE
				  ,(CASE 
						WHEN ( JRM.TDS<>0 AND  (ISNULL(@CTDSACCODE,'') = '' OR ISNULL(@CTDSACCODE,'') = '0000000000' ))
								THEN 'TDS A/C NOT SPECIFIED'
						 WHEN (JRM.ROUND_OFF<>0 AND @BPOSTROUNDOFFSEPARATELY=1 AND (@CROUNDOFFACCODE = '' OR @CROUNDOFFACCODE = '0000000000'))
								THEN 'ROUND OFF A/C NOT SPECIFIED'		
						 WHEN (JRM.NET_AMOUNT=0) 								
								THEN 'ZERO VALUE JOBWORK RECEIPT'
						 ELSE 'UNIDENTIFIED ERROR' END) AS ERR_DESC		
			FROM JOBWORK_RECEIPT_MST JRM
			JOIN #POSTS TPT ON JRM.RECEIPT_ID=TPT.MEMO_ID AND TPT.MODE='JWR'
			WHERE 
			--GENERATE ERROR IF TDS AMOUNT EXISTS BUT TDS ACCOUNT IS NOT SPECIFIED.
			( JRM.TDS<>0 AND  (ISNULL(@CTDSACCODE,'') = '' OR ISNULL(@CTDSACCODE,'') = '0000000000' ))
			--GENERATE ERROR IF ROUNDOFF SHOULD BE SEPARATELY POSTED AND ROUNDOFF ACCOUNT IS NOT SPECIFIED.
			OR (JRM.ROUND_OFF<>0 AND @BPOSTROUNDOFFSEPARATELY=1 AND (@CROUNDOFFACCODE = '' OR @CROUNDOFFACCODE = '0000000000'))
			--GENERATE ERROR IF JOBWORK RECEIVE IS NOT CANCELLED AND IT HAS TOTAL AMOUNT=0
			OR JRM.NET_AMOUNT=0 
	       
	        SET @CSTEP = 350
	        --DELETE RECEIPT_ID FROM TEPM TABLE WHICH HAVE SOME ERROR
	        DELETE A 
	        FROM #POSTS A 
	        JOIN @ERRORS B ON A.MEMO_ID = B.XN_ID AND A.MODE=B.XN_TYPE
	        
	        --SELECT COUNT(*) FROM #POSTS
	        SET @CSTEP = 360
	        IF OBJECT_ID('TEMPDB..#V_PROCESS','U') IS NOT NULL
				DROP TABLE #V_PROCESS
			
			SET @CSTEP = 370
		 	SELECT    JRM.RECEIPT_NO
					, JRM.RECEIPT_ID
					, JRM.RECEIPT_DT
					, LM.AC_CODE
					, JRM.REMARKS
					, JRM.NET_AMOUNT 
					, JRM.SUBTOTAL 
					, JRM.TDS 
					, JRM.ROUND_OFF 
					, JRM.DEPT_ID 
					, JRM.FIN_YEAR
					, LM.AC_NAME 
					, JRD.QUANTITY
					,'JWR' AS XN_TYPE
			INTO #V_PROCESS
			FROM JOBWORK_RECEIPT_MST JRM 
			JOIN 
			(
				SELECT RECEIPT_ID,SUM(QUANTITY) AS QUANTITY
				FROM JOBWORK_RECEIPT_DET
				GROUP BY RECEIPT_ID
			)JRD ON JRM.RECEIPT_ID=JRD.RECEIPT_ID
			JOIN #POSTS PT ON PT.MEMO_ID = JRM.RECEIPT_ID AND PT.MODE='JWR'
			JOIN JWRCONFIGDET PAM ON JRM.AGENCY_CODE= PAM.AGENCYCODE
			JOIN LM01106 LM ON PAM.AGENCYAC=LM.AC_CODE
			WHERE JRM.NET_AMOUNT<>0 		
		
		CREATE INDEX IX_V_PROCESS_RM_ID ON #V_PROCESS(RECEIPT_ID,XN_TYPE)
		
		SELECT @CMEMOID='',@CXNTYPE='',@CAC_CODE='',@NCTR=1
		SET @CSTEP = 380
		WHILE EXISTS(SELECT TOP 1 'U' FROM #V_PROCESS)
		BEGIN
			SET @CSTEP = 390
			SELECT TOP 1 @CMEMOID=RECEIPT_ID,@CXNTYPE=XN_TYPE,@CAC_CODE=AC_CODE FROM #V_PROCESS
			
			SET @CSTEP = 400
			--PARTY ACCOUNT SHOULD BE CREDITED WITH THE NET AMOUNT
			INSERT @VCHC ( AC_CODE, AMOUNT )
			SELECT TOP 1 AC_CODE,-NET_AMOUNT
			FROM #V_PROCESS
			WHERE RECEIPT_ID=@CMEMOID AND NET_AMOUNT<>0
			
			SET @CSTEP = 410
			--JOBWORK ACCOUNT SHOULD BE DEBITED WITH SUBTOTAL
			INSERT @VCHC ( AC_CODE, AMOUNT )
			SELECT TOP 1 @CJOBWORKACCODE,SUBTOTAL
			FROM #V_PROCESS
			WHERE RECEIPT_ID=@CMEMOID AND SUBTOTAL<>0
			
			SET @CSTEP = 420
			--TDS ACCOUNT SHOULD BE DEBITED WITH TAX AMOUNT
			INSERT @VCHC ( AC_CODE, AMOUNT )
			SELECT TOP 1 @CJOBWORKACCODE,TDS
			FROM #V_PROCESS
			WHERE RECEIPT_ID=@CMEMOID AND TDS<>0
			
			SET @CSTEP = 470
			--ROUNDOFF AMOUNT SHOULD BE DEBITED
			INSERT @VCHC ( AC_CODE, AMOUNT )
			SELECT TOP 1 (CASE WHEN @BPOSTROUNDOFFSEPARATELY=1 THEN @CROUNDOFFACCODE ELSE @CJOBWORKACCODE END)
						,ROUND_OFF
			FROM #V_PROCESS
			WHERE RECEIPT_ID=@CMEMOID AND TDS<>0
			
			SET @CSTEP = 500
			SET @CVMID = ''
			SELECT @CVMID = A.VM_ID 
			 FROM POSTACT_VOUCHER_LINK A 
			  JOIN VM01106 B ON A.VM_ID=B.VM_ID
			   WHERE B.CANCELLED=0 AND A.MEMO_ID = @CMEMOID AND A.XN_TYPE=@CXNTYPE
			
			SET @CSTEP = 510
			IF ISNULL(@CVMID,'') = ''
			BEGIN
			    SET @CVMID = 'LATER-'+RTRIM(LTRIM(CONVERT(VARCHAR,@NCTR)))
				SET @NCTR = @NCTR+1
			END
			
			SET @CSTEP = 520
			INSERT INTO @VLINK(VM_ID ,MEMO_ID,XN_TYPE,LAST_UPDATE )
			SELECT @CVMID,@CMEMOID,@CXNTYPE,LAST_UPDATE FROM JOBWORK_RECEIPT_MST WHERE RECEIPT_ID = @CMEMOID
			
			SET @CSTEP = 530
			INSERT @VDC (VM_ID, VD_ID, AC_CODE, NARRATION, DEBIT_AMOUNT, CREDIT_AMOUNT, X_TYPE, 
						  CREDIT_DAYS, CR_DISCOUNT_PERCENTAGE,AC_NAME)
			SELECT @CVMID
				, 'LATER-'+CONVERT(VARCHAR,ROW_NUMBER() OVER(ORDER BY A.AC_CODE)) AS VD_ID
				, A.AC_CODE
				,'BILL# ' + A.XN_NO AS NARRATION
				,(CASE WHEN SUM(AMOUNT)>0 THEN SUM(AMOUNT) ELSE 0 END) AS DEBIT_AMOUNT
				,(CASE WHEN SUM(AMOUNT)<0 THEN ABS(SUM(AMOUNT)) ELSE 0 END) AS CREDIT_AMOUNT
				,(CASE WHEN SUM(AMOUNT) > 0 THEN 'DR' ELSE 'CR' END) AS X_TYPE
				,A.CRDAYS
				,0
				,B.AC_NAME
	        FROM @VCHC A
	        JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE
	        WHERE XN_ID = @CMEMOID
	        GROUP BY A.AC_CODE,A.XN_NO,B.AC_NAME,A.CRDAYS
	        ORDER BY X_TYPE,ABS(SUM(AMOUNT)) DESC
			
	        SET @CSTEP = 540
	        SELECT @NDRTOTAL =SUM(DEBIT_AMOUNT),@NCRTOTAL=SUM(CREDIT_AMOUNT) FROM @VDC
		    WHERE VM_ID = @CVMID
		    
		    SET @CSTEP = 550    
	        SET @CVOUCHERNO = '' 
	        SELECT TOP 1 @CVOUCHERNO = VOUCHER_NO FROM VM01106 WHERE VM_ID = @CVMID
	        IF ISNULL(@CVOUCHERNO,'') = ''
				SET @CVOUCHERNO = @CVMID
	        
	        SET @CSTEP = 560
	        INSERT @VMC	( VM_ID,VOUCHER_NO,VOUCHER_DT, VOUCHER_CODE, DEPT_ID, 
							  BILL_TYPE, BILL_NO, BILL_ID, BILL_DT, BILL_AC_CODE, 
							  PARTY_NAME, QUANTITY, NET_AMOUNT, RM_LIST, CANCELLED,DRTOTAL,CRTOTAL
							  ,VOUCHER_TYPE,DEPT_NAME,BILL_STATUS )
			SELECT @CVMID,@CVOUCHERNO,A.RECEIPT_DT,@CVOUCHERCODE,A.DEPT_ID,'JWR',A.RECEIPT_NO,A.RECEIPT_ID,A.RECEIPT_DT
				  ,A.AC_CODE,B.AC_NAME,A.QUANTITY,A.NET_AMOUNT,A.RECEIPT_NO,0,@NDRTOTAL,@NCRTOTAL
				  ,'JOBWORK RECEIVE',C.DEPT_NAME,'NEW'  	
			FROM #V_PROCESS A
			JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
			JOIN LOCATION C ON a.location_Code =C.DEPT_ID
			WHERE A.RECEIPT_ID=@CMEMOID
			GROUP BY A.RECEIPT_DT,A.DEPT_ID,A.INV_NO,A.RECEIPT_ID,A.RECEIPT_DT
				  ,A.AC_CODE,B.AC_NAME,A.TOTAL_AMOUNT,A.INV_NO,C.DEPT_NAME
			
			SET @CSTEP = 570
			DELETE @VCHC
		    DELETE FROM #V_PROCESS WHERE RECEIPT_ID = @CMEMOID AND XN_TYPE=@CXNTYPE
		END			 			

ENDPROC:    
    SET @CSTEP = 580
    SELECT * FROM @VMC ORDER BY VM_ID
    SELECT * FROM @VDC ORDER BY VM_ID
    SELECT * FROM @ERRORS
    SELECT * FROM @VLINK ORDER BY VM_ID
    
    END TRY
	BEGIN CATCH
			SELECT 'STEP:- '+@CSTEP+' '+ERROR_MESSAGE()AS  ERRMSG
	END CATCH
	        
END
--END OF PROCEDURE - POSTACT_JWR
