CREATE PROCEDURE SP3S_EXPORT_HSN_DATA  
AS  
BEGIN  
SET NOCOUNT ON  
DECLARE @COL_LIST VARCHAR(MAX)  
SELECT @COL_LIST=COALESCE(@COL_LIST,'')  
+CASE UPPER(COLUMN_NAME) WHEN 'HSN_TYPE' THEN  'CASE M.HSN_TYPE WHEN 1 THEN ''HSN'' WHEN ''2'' THEN ''SAC'' END'  
WHEN 'TAXABLE_ITEM' THEN  'CASE ISNULL(M.TAXABLE_ITEM,0) WHEN 0 THEN ''FALSE'' WHEN ''2'' THEN ''TRUE'' END'   
ELSE 'M.'+UPPER(COLUMN_NAME) END+' AS M_'+UPPER(COLUMN_NAME)+', '  
FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='HSN_MST'  
SELECT @COL_LIST=COALESCE(@COL_LIST,'')+'D.'+UPPER(COLUMN_NAME)+' AS D_'+UPPER(COLUMN_NAME)+', '  
FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='HSN_DET' AND (COLUMN_NAME NOT LIKE 'ROW%' AND COLUMN_NAME NOT LIKE 'WEF')  
AND COLUMN_NAME NOT IN (SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='HSN_MST' )  
SET @COL_LIST=LTRIM(RTRIM(@COL_LIST))  
SET @COL_LIST=CASE RIGHT(@COL_LIST,1) WHEN ',' THEN LEFT(@COL_LIST,LEN(@COL_LIST)-1) ELSE @COL_LIST END  
SET @COL_LIST=';WITH CTE AS (SELECT '+@COL_LIST+',R=ROW_NUMBER() OVER(PARTITION BY M.HSN_CODE ORDER BY D.WEF DESC)'+CHAR(13)+'FROM HSN_MST M (NOLOCK) JOIN HSN_DET D (NOLOCK) ON M.HSN_CODE=D.HSN_CODE WHERE M.HSN_CODE<>''0000000000'')
SELECT * FROM CTE WHERE R=1'  
PRINT @COL_LIST
IF LEN(@COL_LIST)>0  
   EXEC(@COL_LIST)  
SET NOCOUNT OFF     
END
