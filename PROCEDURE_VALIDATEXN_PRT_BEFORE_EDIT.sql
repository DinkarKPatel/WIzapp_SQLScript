CREATE PROC VALIDATEXN_PRT_BEFORE_EDIT 
@CMEMOID VARCHAR(30),
@BCANCELXN BIT,
@CERRORMSG VARCHAR(200) OUTPUT,
@CEXPRERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	

	
	DECLARE @CTEXT VARCHAR(10),@CPRODUCTCODE VARCHAR(50),@CVALUE  VARCHAR(10),@CDONOTSENDCHALLANWODISPATCHDETAILS VARCHAR(2),
	@NMODE INT,@CANGADIADETAIL VARCHAR(500)
	
	
	SELECT @CPRODUCTCODE=''
	
	SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)

	IF EXISTS (SELECT TOP  1 'U' from rmm01106 rmm (NOLOCK) WHERE RM_ID=@CMEMOID AND ISNULL(EINV_IRN_NO,'')<>'' ) AND @BCANCELXN<>1
	BEGIN
		SET @CERRORMSG='E-INVOICE GENERATED.........CAN NOT '+@CTEXT
		RETURN	
	END
		
		
    SELECT @CVALUE = VALUE  FROM CONFIG  WHERE CONFIG_OPTION ='NEW_ACCOUNT_SYSTEM'
		
	IF EXISTS (SELECT TOP 1 RM_ID FROM RMM01106 A JOIN VM01106 B ON A.RM_ID=B.BILL_ID
				   WHERE A.RM_ID=@CMEMOID AND B.BILL_TYPE='PRT' AND  B.CANCELLED=0 
				   AND ISNULL(@CVALUE,'') <> '1' )
	BEGIN	
		SET @CERRORMSG='THIS DEBIT NOTE HAS BEEN POSTED INTO ACCOUNTS.........CAN NOT '+@CTEXT
		RETURN
	END
	

	IF EXISTS (SELECT TOP 1 a.Memo_ID FROM eosssorm A (NOLOCK) JOIN SOR_FDNFCN_LINK b (NOLOCK) 
			   ON a.MEMO_ID=b.sorMemoId WHERE b.refFdnMemoId= @CMEMOID)
	BEGIN	
		SET @CERRORMSG='This Debit Note has been generated From SOR module.........CAN NOT '+@CTEXT
		RETURN
	END
	
	IF EXISTS (SELECT TOP 1 a.Memo_ID FROM eossdnm A (NOLOCK) JOIN rmm01106 b (NOLOCK) 
			   ON 'FDN'+b.rm_id=a.ref_fdn_memoid WHERE b.rm_ID= @CMEMOID) AND @BCANCELXN=0
	BEGIN	
		SET @CERRORMSG='This Debit Note has been generated From EOSS Debit note module.........CAN NOT '+@CTEXT
		RETURN
	END
	
    DECLARE @CPARTY_DEPT_ID VARCHAR(5)/**//*Rohit 07-11-2024*/
	DECLARE @CDEPT_ID VARCHAR(5)/**//*Rohit 07-11-2024*/
	SELECT TOP 1 @NMODE=MODE,@CPARTY_DEPT_ID=party_dept_id,@CDEPT_ID=location_Code  FROM RMM01106 (NOLOCK) WHERE RM_ID=@CMEMOID
	
	IF @NMODE=2 
	BEGIN
		IF  EXISTS (SELECT TOP 1 'U' FROM PARCEL_MST A JOIN parcel_det B ON A.parcel_memo_id=B.parcel_memo_id
		           JOIN rmm01106 rmm (NOLOCK) ON rmm.rm_id =B.REF_MEMO_ID 
                WHERE REF_MEMO_ID=@CMEMOID AND A.XN_TYPE='PRT' AND a.cancelled=0)
		BEGIN

		IF(  EXISTS (SELECT TOP  1 'U' FROM LOCATION (nolock) WHERE DEPT_ID =@CDEPT_ID/*LEFT(@CMEMOID,2)*//*Rohit 07-11-2024*/ and server_loc =0)
			  or  EXISTS (SELECT TOP  1 'U' FROM LOCATION (nolock) WHERE DEPT_ID =@cparty_dept_id and server_loc =0) )
			begin
				SET @CERRORMSG='THIS GROUP DEBIT NOTE HAS BEEN SENT TO TARGET LOCATION.........CAN NOT '+@CTEXT
				RETURN	
			end
					
		END
	END
	
	
		
END