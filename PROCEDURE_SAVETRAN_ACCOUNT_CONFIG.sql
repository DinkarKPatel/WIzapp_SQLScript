CREATE PROC SAVETRAN_ACCOUNT_CONFIG
(
  @NSPID INT,
  @NMODE INT=2
)
--WITH ENCRYPTION
AS
BEGIN
   SET NOCOUNT ON
   DECLARE @CCMD NVARCHAR(MAX),@ON VARCHAR(1000),@COL VARCHAR(1000)
   ,@CMASTERTABLENAME VARCHAR(100),@CSOURCEMASTERTABLENAME VARCHAR(100)
   ,@CTRANSACTIONTABLENAME1 VARCHAR(100),@CSOURCETRANSACTIONTABLENAME1 VARCHAR(100)
   ,@CTRANSACTIONTABLENAME2 VARCHAR(100),@CSOURCETRANSACTIONTABLENAME2 VARCHAR(100)
   ,@NSTEP INT=0,@CERRORMSG VARCHAR(MAX)='',@UPDATE VARCHAR(MAX)=''
   

   BEGIN TRY
     BEGIN TRANSACTION
     SET @NSTEP=10
     SELECT @CMASTERTABLENAME='GST_ACCOUNTS_CONFIG_MST',@CSOURCEMASTERTABLENAME='TEMP_GST_ACCOUNTS_CONFIG_MST_'+CAST(@NSPID AS VARCHAR)

	 SELECT @COL	  =COALESCE(@COL,'')+'T.['+UPPER(COLUMN_NAME)+']'+', '
	 	   ,@UPDATE=COALESCE(@UPDATE,'')+'T.['+UPPER(COLUMN_NAME)+']'+'=S.['+UPPER(COLUMN_NAME)+'],'
	 FROM INFORMATION_SCHEMA.COLUMNS T
	 WHERE T.TABLE_NAME=@CMASTERTABLENAME AND T.DATA_TYPE NOT LIKE 'TIMESTAMP'
	 SET @COL=LTRIM(RTRIM(@COL))
	 IF RIGHT(@COL,1)=','
		 SET @COL=LEFT(@COL,LEN(@COL)-1)
     SET @UPDATE=LTRIM(RTRIM(@UPDATE))		
     IF RIGHT(@UPDATE,1)=','
        SET @UPDATE=LEFT(@UPDATE,LEN(@UPDATE)-1)
     --PRINT @COL
     --PRINT @UPDATE       
     SET @CCMD='MERGE '+UPPER(@CMASTERTABLENAME)+' T'  
	 SET @CCMD+=CHAR(13)+'USING (SELECT * FROM '+UPPER(@CSOURCEMASTERTABLENAME)+') S '  
	 SET @CCMD+=CHAR(13)+'ON T.[XN_TYPE]=S.[XN_TYPE]'
	 SET @CCMD+=CHAR(13)+'WHEN MATCHED THEN UPDATE SET '+@UPDATE
	 SET @CCMD+=CHAR(13)+'WHEN NOT MATCHED BY TARGET THEN INSERT('+REPLACE(@COL,'T.','')+') VALUES ('+REPLACE(@COL,'T.','S.')+');'   
	 PRINT @CCMD+CHAR(13)  
	 EXEC (@CCMD)  
	
	
	 
   END TRY
   
   BEGIN CATCH
	 SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
	 GOTO END_PROC
   END CATCH
   
END_PROC:
   IF @@TRANCOUNT>0
	  BEGIN
		IF ISNULL(@CERRORMSG,'')=''
		   COMMIT TRANSACTION
		ELSE
		   ROLLBACK 	
	  END 

   IF ISNULL(@CERRORMSG,'')='' AND 1=1
	  BEGIN
		 SET @CCMD = N'DROP TABLE '+@CSOURCEMASTERTABLENAME+';DROP TABLE '+@CSOURCETRANSACTIONTABLENAME1+';DROP TABLE '+@CSOURCETRANSACTIONTABLENAME2
		 --PRINT @CCMD
		 EXEC SP_EXECUTESQL @CCMD
      END		
		  
   SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
   SET NOCOUNT OFF
END
--END OF PROCEDURE SAVETRAN_ACCOUNT_CONFIG
