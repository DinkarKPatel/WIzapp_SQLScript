create PROCEDURE SP_CUSTOMDVAT23
(
	@DFROMDT DATETIME,
	@DTODT DATETIME,
	@CCURRENTSTATE VARCHAR(10) = '',
	@NMODE INT=1
)
--WITH ENCRYPTION
AS
BEGIN
/*
	THIS PROCEDURE RETURNS DETAILS OF LOCAL SALES,SALE RETURN,WHOLESALE AND WHOLESALE RETURN.
*/
	---POST_TAX_SEPARATELY - 0 : INTERSTATE PURCHASE
	---POST_TAX_SEPARATELY - 1 : LOCAL PURCHASE
	DECLARE @CDEPTID VARCHAR(2), @CHODEPTID VARCHAR(2)  
	SELECT TOP 1 @CDEPTID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'LOCATION_ID'

	SELECT TOP 1 @CHODEPTID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'

	IF ISNULL(@CCURRENTSTATE,'')=''
		SELECT @CCURRENTSTATE = STATE_CODE FROM LOC_VIEW WHERE DEPT_ID = @CDEPTID

	DECLARE @LOCLIST TABLE ( DEPT_ID VARCHAR(2))

	IF @CDEPTID = @CHODEPTID 
		INSERT @LOCLIST
		SELECT DEPT_ID FROM LOC_VIEW
		WHERE STATE_CODE = @CCURRENTSTATE
		AND   LOC_TYPE = 1
		AND   PUR_LOC = 1
	ELSE
		INSERT @LOCLIST
		SELECT @CDEPTID AS DEPT_ID
	
		IF @NMODE=1
		SELECT	
				 (CASE WHEN PID.QUANTITY<0 THEN 'SALE RETURN' ELSE 'RETAIL SALE' END) AS XN_TYPE	
				, A.CM_DT AS BILL_DT
				, A.CM_NO AS BILL_NO
				, (CASE WHEN A.CUSTOMER_CODE='000000000000' THEN B.AC_NAME ELSE CUS.CUSTOMER_FNAME+' '+CUS.CUSTOMER_LNAME END) AS CUSTOMER
				, (CASE WHEN A.CUSTOMER_CODE='000000000000' THEN COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME) 
				  ELSE COALESCE(CUS.ADDRESS1,CUS.ADDRESS2,ar.AREA_NAME,ct.CITY,st.STATE,e.REGION_NAME) END) AS CUSTOMER_ADDRESS
				, B.TIN_NO  AS TIN
				, SUM( PID.RFNET-PID.TAX_AMOUNT ) AS SALE_AMT
				,(PID.TAX_PERCENTAGE) AS TAX_PERCENTAGE
				,SUM(PID.TAX_AMOUNT) AS TAX_AMOUNT
				,SUM(PID.RFNET) AS TOTAL_AMOUNT
				,'' AS FORM_NAME		
				,SUM(PID.QUANTITY) AS QUANTITY
		FROM CMM01106 A  
		JOIN CMD01106 PID ON A.CM_ID=PID.CM_ID
		JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE  
		JOIN custdym CUS (nolock) ON A.CUSTOMER_CODE = CUS.CUSTOMER_CODE
		JOIN AREA ar (nolock) ON Ar.AREA_CODE = cus.AREA_CODE   
		JOIN CITY Ct (nolock) ON ar.CITY_CODE = Ct.CITY_CODE   
		JOIN STATE st (nolock) ON st.STATE_CODE = ct.STATE_CODE
		JOIN REGIONM E ON st.REGION_CODE = E.REGION_CODE
		JOIN @LOCLIST LOC ON LEFT(A.CM_ID,2) = LOC.DEPT_ID
		WHERE A.CM_DT BETWEEN @DFROMDT AND @DTODT 
		AND A.CM_MODE=1 AND A.CANCELLED=0  AND  ROUND(A.SUBTOTAL,0) <>0  
		GROUP  BY	(CASE WHEN PID.QUANTITY<0 THEN 'SALE RETURN' ELSE 'RETAIL SALE' END)
					,  A.CM_DT 
					, A.CM_NO
					, (CASE WHEN A.CUSTOMER_CODE='000000000000' THEN B.AC_NAME ELSE CUS.CUSTOMER_FNAME+' '+CUS.CUSTOMER_LNAME END)
					, (CASE WHEN A.CUSTOMER_CODE='000000000000' THEN COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME) 
						ELSE COALESCE(CUS.ADDRESS1,CUS.ADDRESS2,ar.AREA_name,ct.CITY,st.STATE,e.REGION_NAME) END)
					, B.TIN_NO  
					,(PID.TAX_PERCENTAGE)
					
		UNION ALL
		
		SELECT	'WHOLESALE' AS XN_TYPE	
				, A.INV_DT AS BILL_DT
				, A.INV_NO AS BILL_NO
				, B.AC_NAME AS CUSTOMER
				, COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME) AS CUSTOMER_ADDRESS
				, B.TIN_NO  AS TIN
				, SUM(PID.RFNET-PID.ITEM_TAX_AMOUNT) AS SALE_AMT
				,(PID.ITEM_TAX_PERCENTAGE) AS TAX_PERCENTAGE
				,SUM(PID.ITEM_TAX_AMOUNT) AS TAX_AMOUNT
				,SUM(PID.RFNET) AS TOTAL_AMOUNT
				,F.FORM_NAME		
				,SUM(PID.QUANTITY) AS QUANTITY
		FROM INM01106 A  
		JOIN IND01106 PID ON A.INV_ID=PID.INV_ID
		JOIN FORM F ON PID.ITEM_FORM_ID=F.FORM_ID
		JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE  
		JOIN @LOCLIST LOC ON LEFT(A.INV_ID,2) = LOC.DEPT_ID
		WHERE A.INV_DT BETWEEN @DFROMDT AND @DTODT 
		AND A.INV_MODE<> 2  
		AND A.CANCELLED=0  
		AND  ROUND(A.SUBTOTAL,0) <>0  AND F.POST_TAX_SEPARATELY=1
		GROUP  BY	  A.INV_DT 
					, A.INV_NO
					, B.AC_NAME
					, COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME)
					,B.TIN_NO  
					,(PID.ITEM_TAX_PERCENTAGE) 
					,F.FORM_NAME						
 	
	ELSE
	
		SELECT	'WHOLESALE RETURN' AS XN_TYPE
				, A.CN_DT AS INV_DT
				, A.CN_NO AS SR_NO
				, B.AC_NAME AS SELLER
				,COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME) AS SELLER_ADDRESS
				, ( B.TIN_NO ) AS TIN
				,SUM(C.RFNET-C.ITEM_TAX_AMOUNT) AS SALE_AMT
				, C.ITEM_TAX_PERCENTAGE AS TAX_PERCENTAGE		
				,SUM(C.ITEM_TAX_AMOUNT ) AS TAX_AMOUNT
				,SUM(C.RFNET) AS TOTAL_AMOUNT
				,F.FORM_NAME	
		FROM CNM01106 A  
		JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE  
		JOIN CND01106 C ON A.CN_ID = C.CN_ID  
		JOIN FORM F ON C.ITEM_FORM_ID=F.FORM_ID
		JOIN @LOCLIST LOC ON LEFT(A.CN_ID,2) = LOC.DEPT_ID
		WHERE A.CN_DT BETWEEN @DFROMDT AND @DTODT AND
		ROUND(A.SUBTOTAL,2) <>0 
		AND A.CANCELLED=0 AND A.MEMO_TYPE=1 AND F.POST_TAX_SEPARATELY=1
 		GROUP BY  A.CN_DT 
				, A.CN_NO 
				, B.AC_NAME
				,COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME)
				,( B.TIN_NO )
				, C.ITEM_TAX_PERCENTAGE
				,F.FORM_NAME
	 	
END
