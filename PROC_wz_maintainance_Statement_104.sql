


IF NOT EXISTS(SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_APPROVAL_LEVEL' AND VALUE='1')
BEGIN
	--UPDATING LEVEL NO IN PURCHASE
	UPDATE A SET APPROVEDLEVELNO=B.LEVEL_NO
	FROM PIM01106 A
	JOIN 
	(
		SELECT B.REF_XN_ID,MAX(A.LEVEL_NO) AS LEVEL_NO
		FROM XN_APPROVAL_DONE_MST A 
		JOIN XN_APPROVAL_DONE_DET B ON A.MEMO_ID=B.MEMO_ID
		WHERE A.XN_TYPE='PUR' AND B.REFXNTYPE='PUR'
		GROUP BY B.REF_XN_ID
	)B ON A.MRR_ID=B.REF_XN_ID
	
	UPDATE PIM01106 SET APPROVEDLEVELNO=99
	WHERE APPROVEDLEVELNO=
			(SELECT MAX(LEVEL_NO)
			 FROM XN_APPROVAL_CHECKLIST_LEVELS
			  WHERE XN_TYPE='PUR' AND INACTIVE=0)
	
	--UPDATING LEVEL NO IN DEBITNOTE
	UPDATE A SET APPROVEDLEVELNO=B.LEVEL_NO
	FROM RMM01106 A
	JOIN 
	(
		SELECT B.REF_XN_ID,MAX(A.LEVEL_NO) AS LEVEL_NO
		FROM XN_APPROVAL_DONE_MST A 
		JOIN XN_APPROVAL_DONE_DET B ON A.MEMO_ID=B.MEMO_ID
		WHERE A.XN_TYPE='PRT' 
		GROUP BY B.REF_XN_ID
	)B ON A.RM_ID=B.REF_XN_ID
	
	UPDATE RMM01106 SET APPROVEDLEVELNO=99
	WHERE APPROVEDLEVELNO=
			(SELECT MAX(LEVEL_NO)
			 FROM XN_APPROVAL_CHECKLIST_LEVELS
			  WHERE XN_TYPE='PRT' AND INACTIVE=0)
	
	--UPDATING LEVEL NO IN VOUCHERS
	UPDATE A SET APPROVEDLEVELNO=B.LEVEL_NO
	FROM VM01106 A
	JOIN 
	(
		SELECT B.REF_XN_ID,MAX(A.LEVEL_NO) AS LEVEL_NO
		FROM XN_APPROVAL_DONE_MST A 
		JOIN XN_APPROVAL_DONE_DET B ON A.MEMO_ID=B.MEMO_ID
		WHERE A.XN_TYPE='VCH' 
		GROUP BY B.REF_XN_ID
	)B ON A.VM_ID=B.REF_XN_ID
	
	UPDATE VM01106 SET APPROVEDLEVELNO=99
	WHERE APPROVEDLEVELNO=
			(SELECT MAX(LEVEL_NO)
			 FROM XN_APPROVAL_CHECKLIST_LEVELS
			  WHERE XN_TYPE='VCH' AND INACTIVE=0)
	
	--UPDATING LEVEL NO IN VOUCHERS
	UPDATE A SET APPROVEDLEVELNO=B.LEVEL_NO
	FROM TILL_SHIFT_MST A
	JOIN 
	(
		SELECT B.REF_XN_ID,MAX(A.LEVEL_NO) AS LEVEL_NO
		FROM XN_APPROVAL_DONE_MST A 
		JOIN XN_APPROVAL_DONE_DET B ON A.MEMO_ID=B.MEMO_ID
		WHERE A.XN_TYPE='SFT' 
		GROUP BY B.REF_XN_ID
	)B ON A.SHIFT_ID=B.REF_XN_ID
	
	UPDATE TILL_SHIFT_MST SET APPROVEDLEVELNO=99
	WHERE APPROVEDLEVELNO=
			(SELECT MAX(LEVEL_NO)
			 FROM XN_APPROVAL_CHECKLIST_LEVELS
			  WHERE XN_TYPE='SFT' AND INACTIVE=0)
	
	IF NOT EXISTS(SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_APPROVAL_LEVEL')
	   INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
	   VALUES ('UPDATE_APPROVAL_LEVEL','1','',GETDATE())	
	ELSE	
		UPDATE CONFIG SET VALUE='1' WHERE CONFIG_OPTION='UPDATE_APPROVAL_LEVEL'	
END	
