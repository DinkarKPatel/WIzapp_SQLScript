CREATE PROCEDURE SP3S_SYNCH_UPLOADDATA_CUS_OPT
(
    @CSPID VARCHAR(50)
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
AS
BEGIN
	
	set @cerrmsg=''


	DECLARE @CCMD NVARCHAR(MAX),@CSTEP VARCHAR(10),@CTABLE_SUFFIX VARCHAR(100),
	@CTABLENAME VARCHAR(100),@CTMP_TABLENAME VARCHAR(100),@CKEYFIELD VARCHAR(100),@CREF_CUSTOMER_CODE VARCHAR(100),
	@CTABLESSTR VARCHAR(MAX), @CLOCID VARCHAR(5),@CSOURCEDB VARCHAR(100),@CMERGEDB VARCHAR(100),@BMSTINSERTONLY BIT
	,@CKEYFIELD1 VARCHAR(100)
	

	BEGIN TRY 
			
			DECLARE @CFILTERCONDITION VARCHAR(100)
			SET @CFILTERCONDITION=' B.SP_ID='''+@cSpId+''''

			SET @CSOURCEDB=''
			SET @CERRMSG=''
			set @CMERGEDB=''
		
			 SET @CTABLE_SUFFIX='UPLOAD'

			SET @CSTEP = 20 
			SET @CTABLENAME='REGIONM'  
			SET @CTMP_TABLENAME='CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
			SET @CKEYFIELD='REGION_CODE'  
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=0 
				 ,@CFILTERCONDITION=@CFILTERCONDITION


			SET @CSTEP = 30 
			SET @CTABLENAME='STATE'  
			SET @CTMP_TABLENAME='CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
			SET @CKEYFIELD='STATE_CODE'  
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=0 
				 ,@CFILTERCONDITION=@CFILTERCONDITION
		   
			SET @CSTEP = 60
			SET @CTABLENAME='CITY'  
			SET @CTMP_TABLENAME='CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
			SET @CKEYFIELD='CITY_CODE'  
			SET @CSTEP=80 
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=0 
				 ,@CFILTERCONDITION=@CFILTERCONDITION
		    
			SET @CSTEP = 100
			SET @CTABLENAME='AREA'  
			SET @CTMP_TABLENAME='CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
			SET @CKEYFIELD='AREA_CODE'  
			SET @CSTEP= 120 
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=0 ,@CFILTERCONDITION=@CFILTERCONDITION

			
		    
			SET @CSTEP = 140
			SET @CTABLENAME='CUSTDYM'  
			SET @CTMP_TABLENAME='[CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
			SET @CKEYFIELD='CUSTOMER_CODE'  
			SET @CSTEP= 150
			
				SET @CCMD = N'UPDATE '+@CSOURCEDB+@CTMP_TABLENAME+' SET REF_CUSTOMER_CODE = ''000000000000'' 
				where sp_id='''+@cSpId+''' ' 
				PRINT @CCMD
				EXEC SP_EXECUTESQL @CCMD

				
			SET @CSTEP= 155
			
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION=@CFILTERCONDITION             
		 
		

		
			SET @CSTEP = 170
			SET @CTABLENAME='ATTRM'  
			SET @CTMP_TABLENAME='[CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
			SET @CKEYFIELD='attribute_code'  
				
			SET @CSTEP= 180
			
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION=@CFILTERCONDITION    

			SET @CSTEP = 190
			SET @CTABLENAME='ATTR_KEY'  
			SET @CTMP_TABLENAME='[CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
			SET @CKEYFIELD='key_code'  
				
			SET @CSTEP= 200
			
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION=@CFILTERCONDITION    
        
			SET @CSTEP = 210
			SET @CTABLENAME='CUST_ATTR'  
			SET @CTMP_TABLENAME='[CUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
			SET @CKEYFIELD='customer_code' 
			SET @CKEYFIELD1='attribute_code'
				
			SET @CSTEP= 220
			
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''  
				 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION=@CFILTERCONDITION 
		  GOTO END_PROC
        
	END TRY
    
	BEGIN CATCH
	 SET @CERRMSG='P:SP_MERGE_MIRROR_CUS_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
	 GOTO EXIT_PROC
	END CATCH

EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0  
		COMMIT  
	ELSE
	IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0  
		ROLLBACK  
		  

      DELETE a FROM CUS_custdym_UPLOAD a with  (rowlock) WHERE SP_ID  =@cSpId 
	  DELETE a FROM CUS_AREA_UPLOAD a with  (rowlock) WHERE SP_ID  =@cSpId 
	  DELETE a FROM CUS_CITY_UPLOAD a with  (rowlock) WHERE SP_ID  =@cSpId 
	  DELETE a FROM CUS_STATE_UPLOAD a with  (rowlock) WHERE SP_ID  =@cSpId 
	  DELETE a FROM CUS_REGIONM_UPLOAD a with  (rowlock) WHERE SP_ID  =@cSpId 

END_PROC:
		
END
