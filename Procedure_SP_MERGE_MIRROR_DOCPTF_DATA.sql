CREATE PROCEDURE SP_MERGE_MIRROR_DOCPTF_DATA
(
	@CMEMOID VARCHAR(50)
   ,@CLOCID VARCHAR(3)
   ,@CSOURCEDB VARCHAR(200)
   ,@CMERGEDB VARCHAR(200)
   ,@BMSTINSERTONLY BIT
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS


SET NOCOUNT ON
BEGIN

DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
	   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),
	   @CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1),@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),
	   @BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	   ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(MAX),@CMRRIDSEARCH VARCHAR(100),@CERRORUPDPMT VARCHAR(MAX)
BEGIN TRY
SET @CSTEP=20
	SET @CTABLE_SUFFIX='upload'
	
	SET @CSOURCEDB=''
	BEGIN TRANSACTION 

	SET @CSTEP=30
	
	SELECT TOP 1 @CMRRIDSEARCH=MRR_ID FROM PIM01106 (NOLOCK) WHERE MRR_ID=@CMEMOID
	



	---  End of Maintainance steps for incoming data
			
	SET @CSTEP=230
	SET @CTABLENAME='SECTIONM'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='SECTION_CODE'
	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 	
	SET @CSTEP=240
	SET @CTABLENAME='SECTIOND'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='SUB_SECTION_CODE'
	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	SET @CSTEP=250
	SET @CTABLENAME='PARA1'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='PARA1_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	SET @CSTEP=260
	SET @CTABLENAME='PARA2'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='PARA2_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	SET @CSTEP=270
	SET @CTABLENAME='PARA3'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='PARA3_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  						
	SET @CSTEP=280
	SET @CTABLENAME='PARA4'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='PARA4_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 	
	SET @CSTEP=290
	SET @CTABLENAME='PARA5'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='PARA5_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
	SET @CSTEP=300
	SET @CTABLENAME='PARA6'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='PARA6_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 	

	SET @CSTEP=305
	SET @CTABLENAME='UOM'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='UOM_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 	
							  
	SET @CSTEP=310
	SET @CTABLENAME='ARTICLE'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='ARTICLE_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 	
							  
         
	SET @CSTEP=340
	SET @CTABLENAME='SKU'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='PRODUCT_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 	

	

	SET @CSTEP=350
	SET @CTABLENAME='DEBITNOTE_PROFORMA_MST'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='MRR_ID'
	
	
	

	SET @CSTEP=360	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	
	SET @CSTEP=370
	SET @CTABLENAME='DEBITNOTE_PROFORMA_DET'
	SET @CTMP_TABLENAME='DOCDNPF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='row_id'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  

	
	SET @CSTEP=400
	
END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP_MERGE_MIRROR_DOCDNPF_OPT_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
END CATCH

EXIT_PROC:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')=''
			COMMIT
		ELSE 
			ROLLBACK
	END

	truncate table DOCDNPF_DEBITNOTE_PROFORMA_MST_UPLOAD 
	truncate table DOCDNPF_DEBITNOTE_PROFORMA_DET_UPLOAD 
	truncate table DOCDNPF_SECTIONM_UPLOAD
	truncate table DOCDNPF_SECTIOND_UPLOAD
	truncate table DOCDNPF_ARTICLE_UPLOAD
	truncate table DOCDNPF_PARA1_UPLOAD
	truncate table DOCDNPF_PARA2_UPLOAD
	truncate table DOCDNPF_PARA3_UPLOAD
	truncate table DOCDNPF_PARA4_UPLOAD
	truncate table DOCDNPF_PARA5_UPLOAD
	truncate table DOCDNPF_PARA6_UPLOAD
	truncate table DOCDNPF_sku_UPLOAD
	truncate table DOCDNPF_UOM_UPLOAD 

	truncate table DOCDNPF_ATTR1_MST_UPLOAD 
	truncate table DOCDNPF_ATTR2_MST_UPLOAD 
	truncate table DOCDNPF_ATTR3_MST_UPLOAD 
	truncate table DOCDNPF_ATTR4_MST_UPLOAD 
	truncate table DOCDNPF_ATTR5_MST_UPLOAD 
	truncate table DOCDNPF_ATTR6_MST_UPLOAD 
	truncate table DOCDNPF_ATTR7_MST_UPLOAD 
	truncate table DOCDNPF_ATTR8_MST_UPLOAD 
	truncate table DOCDNPF_ATTR9_MST_UPLOAD 
	truncate table DOCDNPF_ATTR10_MST_UPLOAD 

    truncate table DOCDNPF_ATTR10_MST_UPLOAD 
	truncate table DOCDNPF_ATTR11_MST_UPLOAD 
	truncate table DOCDNPF_ATTR12_MST_UPLOAD 
	truncate table DOCDNPF_ATTR13_MST_UPLOAD 
	truncate table DOCDNPF_ATTR14_MST_UPLOAD 
	truncate table DOCDNPF_ATTR15_MST_UPLOAD 
	truncate table DOCDNPF_ATTR16_MST_UPLOAD 
	truncate table DOCDNPF_ATTR17_MST_UPLOAD 
	truncate table DOCDNPF_ATTR18_MST_UPLOAD 
	truncate table DOCDNPF_ATTR19_MST_UPLOAD 
	truncate table DOCDNPF_ATTR20_MST_UPLOAD 
	truncate table DOCDNPF_ATTR21_MST_UPLOAD 
	truncate table DOCDNPF_ATTR22_MST_UPLOAD 
	truncate table DOCDNPF_ATTR23_MST_UPLOAD 
	truncate table DOCDNPF_ATTR24_MST_UPLOAD 
	truncate table DOCDNPF_ATTR25_MST_UPLOAD 


END	
---END OF PROCEDURE - SP_MERGE_MIRROR_DOCDNPF_DATA

 
