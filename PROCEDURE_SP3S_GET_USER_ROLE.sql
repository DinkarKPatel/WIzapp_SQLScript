CREATE PROCEDURE SP3S_GET_USER_ROLE
(
	@NMODE INT,
	@NSPID VARCHAR(50)='',
	@NVIEWSTATUS INT=1,
	@CLOCID VARCHAR(5)=''
)	
AS
BEGIN
 
	DECLARE @CCMD NVARCHAR(MAX),@CROLLID CHAR(7),@CROLLNAME VARCHAR(100),@CCOLUMN_NAME VARCHAR(255),@NSTEP INT,
			@CDELCMD NVARCHAR(MAX),@NCNT INT,@CTEMPDBNAME VARCHAR(100)

BEGIN TRY
	
	SET @NSTEP = 10	
	SET @CTEMPDBNAME = ''
	
	IF @NMODE = 1
	BEGIN
		IF OBJECT_ID('TEMPDB..#USERPER','U') IS NOT NULL
			DROP TABLE #USERPER
		
		IF OBJECT_ID('TEMPDB..#TOTALUSER','U') IS NOT NULL
			DROP TABLE #TOTALUSER
	    
		IF OBJECT_ID('TEMPDB..#TMPUSER_ROLL_DET','U') IS NOT NULL
			DROP TABLE #TMPUSER_ROLL_DET	
			
			IF OBJECT_ID('TEMPDB..#USERPERFINAL','U') IS NOT NULL
			DROP TABLE #USERPERFINAL
	
		SET @NSTEP = 20			
		SELECT DISTINCT  FORM_NAME,FORM_OPTION,DISPLAY_FORM_NAME,DISPLAY_NAME,GROUP_NAME INTO #TMPUSER_ROLL_DET
		FROM MODULES WHERE USER_CODE='0000000' AND DISPLAY_FORM_NAME<>''
		
		SELECT ROLE_ID,ROLE_NAME INTO #TOTALUSER FROM  	USER_ROLE_MST WHERE ISNULL(ROLE_NAME,'')<>''

		SET @NSTEP = 30			
		CREATE TABLE #USERPER(FORM_NAME VARCHAR(500),FORM_OPTION VARCHAR(40),DISPLAY_FORM_NAME VARCHAR(1000),
		DISPLAY_NAME VARCHAR(100),ROW_ID VARCHAR(100),DISPLAY_FORM_NAME_ORG VARCHAR(1000),GROUP_NAME VARCHAR(500)) 
		
		INSERT INTO #USERPER(FORM_NAME,FORM_OPTION,DISPLAY_FORM_NAME,DISPLAY_NAME,ROW_ID,DISPLAY_FORM_NAME_ORG,GROUP_NAME )
		SELECT DISTINCT FORM_NAME,FORM_OPTION,DISPLAY_FORM_NAME,DISPLAY_NAME,NEWID(),DISPLAY_FORM_NAME,
		GROUP_NAME FROM #TMPUSER_ROLL_DET
		
		SET @NCNT=1
		
		SET @CDELCMD=N'DELETE FROM #USERPER WHERE '
		SET @NSTEP = 40	
		WHILE EXISTS (SELECT TOP 1 'U' FROM #TOTALUSER)
		BEGIN
				SELECT TOP 1 @CROLLID= ROLE_ID,@CROLLNAME=ROLE_NAME FROM #TOTALUSER
				SET @CCOLUMN_NAME = @CROLLNAME+'_VALUE'
				
				SET @CCMD=N'ALTER TABLE #USERPER 
							ADD ['+@CCOLUMN_NAME+'] BIT'
				
				PRINT @CCMD	
				EXEC SP_EXECUTESQL 	@CCMD

				SET @NSTEP = 50					
				SET @CCMD=N'UPDATE A SET A.['+@CCOLUMN_NAME+']= ISNULL(B.VALUE,0) FROM #USERPER A
							LEFT OUTER JOIN USER_ROLE_DET B 
							ON A.FORM_NAME=B.FORM_NAME AND A.FORM_OPTION=B.FORM_OPTION AND B.ROLE_ID='''+@CROLLID+''''

				
				PRINT 	@CCMD
				EXEC SP_EXECUTESQL 	@CCMD		
				
				
				
				SET @NSTEP = 60	
				IF @NVIEWSTATUS IN (2,3)
				BEGIN
					SET @CDELCMD=@CDELCMD+(CASE WHEN @NCNT=1 THEN '' ELSE ' AND ' END)
					
					IF @NVIEWSTATUS=2
						SET @CDELCMD=@CDELCMD+N'['+@CCOLUMN_NAME+']=0'
					ELSE
						SET @CDELCMD=@CDELCMD+N'['+@CCOLUMN_NAME+']=1'	
				END	
				
				SET @NCNT=@NCNT+1
				SET @NSTEP = 70			
				DELETE #TOTALUSER WHERE ROLE_ID= @CROLLID
		END
		
		IF @NVIEWSTATUS IN (2,3)
		BEGIN
			PRINT @CDELCMD
			EXEC SP_EXECUTESQL @CDELCMD
		END	
		
		SET @NSTEP = 80	
		SELECT *,SR=ROW_NUMBER () OVER (PARTITION BY DISPLAY_FORM_NAME ORDER BY DISPLAY_FORM_NAME)
		INTO #USERPERFINAL
		FROM #USERPER ORDER BY DISPLAY_FORM_NAME,DISPLAY_NAME
		
		SET @NSTEP = 90
		UPDATE #USERPERFINAL SET DISPLAY_FORM_NAME='' WHERE SR>1
		ALTER TABLE #USERPERFINAL DROP COLUMN SR
		
		SELECT * FROM  #USERPERFINAL  A
		
						
	END
	ELSE
	IF @NMODE =2
	BEGIN
		BEGIN TRAN
		DECLARE @CTEMPTABLE VARCHAR(50),@BTEMPTABLE_FLAG BIT,@CERRMSG VARCHAR(MAX)
	
	   IF @CLOCID=''
		SELECT TOP 1 @CLOCID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
		
		SET @NSTEP = 100
		SET @CTEMPTABLE=@CTEMPDBNAME+'MSTUSRROLE_USER_ROLE_DET_UPLOAD'
		SET @CCMD = N'IF OBJECT_ID('''+@CTEMPTABLE+''',''U'') IS NULL
							SET @BTEMPTABLE_FLAG = 1
					   ELSE 
							SET @BTEMPTABLE_FLAG = 0'
		PRINT @CCMD 
		EXEC SP_EXECUTESQL @CCMD,N'@BTEMPTABLE_FLAG BIT OUTPUT',@BTEMPTABLE_FLAG  OUTPUT
		
		SET @NSTEP = 110
		IF @BTEMPTABLE_FLAG=1
		BEGIN
			SET @CERRMSG = 'TEMP TABLE NOT FOUND.'
			GOTO END_PROC
		END	
		
		
		--UPDATE IF RECORD EXISTS IN TABLE USER_ROLL_DET
		SET @NSTEP = 130
		SET @CCMD = N'UPDATE A SET A.VALUE = B.VALUE,LAST_UPDATE=GETDATE() FROM USER_ROLE_DET A 
						JOIN '+@CTEMPTABLE+' B
						ON A.ROLE_ID=B.ROLE_ID AND A.FORM_NAME = B.FORM_NAME AND A.FORM_OPTION = B.FORM_OPTION WHERE B.SP_ID='''+@NSPID +''''
		PRINT @CCMD
		EXEC SP_EXECUTESQL 	@CCMD	
		--INSERT NEW RECORD IN TABLE USER_ROLL_DET
		SET @NSTEP = 140
		SET @CCMD = N'INSERT INTO USER_ROLE_DET(ROLE_ID,FORM_NAME,FORM_OPTION,VALUE,ROW_ID,LAST_UPDATE,
					GROUP_NAME,S_NO,DISPLAY_FORM_NAME,DISPLAY_NAME)
					SELECT A.ROLE_ID,A.FORM_NAME,A.FORM_OPTION,A.VALUE,NEWID() AS ROW_ID,GETDATE(),
					B.GROUP_NAME,B.S_NO,B.DISPLAY_FORM_NAME,B.DISPLAY_NAME FROM 
				 (
					  SELECT A.ROLE_ID,A.FORM_NAME,A.FORM_OPTION,A.VALUE,A.GROUP_NAME
					  FROM '+@CTEMPTABLE+'
					  A LEFT OUTER JOIN USER_ROLE_DET B 
					  ON A.ROLE_ID=B.ROLE_ID AND A.FORM_NAME=B.FORM_NAME AND A.FORM_OPTION=B.FORM_OPTION				  
					  WHERE B.ROLE_ID IS NULL AND B.FORM_NAME IS NULL AND B.FORM_OPTION IS NULL AND A.SP_ID= '''+@NSPID+'''
				  ) A
				  JOIN MODULES B ON A.FORM_NAME = B.FORM_NAME AND A.FORM_OPTION=B.FORM_OPTION AND A.GROUP_NAME=B.GROUP_NAME 
				  WHERE B.USER_CODE= ''0000000'''
		PRINT @CCMD
		EXEC SP_EXECUTESQL 	@CCMD				  		
	END
	
	ELSE
	IF @NMODE =3
	BEGIN
		SET @NSTEP = 145
		SELECT USR_SR.SR AS SR,
			   CASE WHEN ROW_NUMBER() OVER (PARTITION BY U.USER_CODE ORDER BY USERNAME ,ROLE_NAME, DEPT_NAME )=1 THEN ISNULL(USERNAME,'') ELSE '' END AS USR_USERNAME, 
			   CASE WHEN ROW_NUMBER() OVER (PARTITION BY U.USER_CODE ORDER BY USERNAME ,ROLE_NAME, DEPT_NAME )=1 THEN ISNULL(M.ROLE_NAME,'')  ELSE '' END AS USR_ROLE_NAME,
			   ISNULL(L.DEPT_ID,'') AS  DEPT_ID,ISNULL(DEPT_NAME,'') AS   DEPT_NAME   FROM 
		USER_ROLE_DET D
		JOIN USER_ROLE_MST M ON D.ROLE_ID =M.ROLE_ID 
		LEFT JOIN USERS U ON D.ROLE_ID =U.ROLE_ID 
		JOIN
		(
			SELECT U.USER_CODE,ROW_NUMBER() OVER (ORDER BY USERNAME) AS SR
			FROM USER_ROLE_DET D
			JOIN USER_ROLE_MST M ON D.ROLE_ID =M.ROLE_ID 
			LEFT JOIN USERS U ON D.ROLE_ID =U.ROLE_ID 
			WHERE USER_CODE IS NOT NULL
			GROUP BY U.USER_CODE,USERNAME
		) USR_SR ON USR_SR .USER_CODE =U.USER_CODE
		LEFT JOIN LOCUSERS LU ON LU.USER_CODE =U.USER_CODE 
		LEFT JOIN LOCATION L ON L.DEPT_ID =LU.DEPT_ID 
		WHERE U.USERNAME <>''
		GROUP BY D.ROLE_ID,ROLE_NAME ,USERNAME,DEPT_NAME,U.USER_CODE,L.DEPT_ID,USR_SR.SR
		ORDER BY USERNAME ,ROLE_NAME, DEPT_NAME
			  		
	END
	ELSE
	IF @NMODE = 4
	BEGIN
		SET @NSTEP = 150
		IF OBJECT_ID('TEMPDB..#USERPER_NEW','U') IS NOT NULL
			DROP TABLE #USERPER_NEW
		
		IF OBJECT_ID('TEMPDB..#TOTALUSER_NEW','U') IS NOT NULL
			DROP TABLE #TOTALUSER_NEW
	    
		IF OBJECT_ID('TEMPDB..#TMPUSER_ROLL_DET_NEW','U') IS NOT NULL
			DROP TABLE #TMPUSER_ROLL_DET_NEW	
			
			IF OBJECT_ID('TEMPDB..#USERPERFINAL_NEW','U') IS NOT NULL
			DROP TABLE #USERPERFINAL_NEW
	
		SET @NSTEP = 160
		SELECT DISTINCT  FORM_NAME,FORM_OPTION,DISPLAY_FORM_NAME,DISPLAY_NAME,GROUP_NAME INTO #TMPUSER_ROLL_DET_NEW
		FROM MODULES WHERE USER_CODE='0000000' AND DISPLAY_FORM_NAME<>''
		
		SELECT ROLE_ID,ROLE_NAME INTO #TOTALUSER_NEW FROM  	USER_ROLE_MST WHERE ISNULL(ROLE_NAME,'')<>''

		SET @NSTEP = 170			
		CREATE TABLE #USERPER_NEW(FORM_NAME VARCHAR(500),FORM_OPTION VARCHAR(40),DISPLAY_FORM_NAME VARCHAR(1000),
		DISPLAY_NAME VARCHAR(100),ROW_ID VARCHAR(100),DISPLAY_FORM_NAME_ORG VARCHAR(1000),GROUP_NAME VARCHAR(500)) 
		
		INSERT INTO #USERPER_NEW(FORM_NAME,FORM_OPTION,DISPLAY_FORM_NAME,DISPLAY_NAME,ROW_ID,DISPLAY_FORM_NAME_ORG,GROUP_NAME )
		SELECT FORM_NAME,FORM_OPTION,DISPLAY_FORM_NAME,DISPLAY_NAME,NEWID(),DISPLAY_FORM_NAME,GROUP_NAME
		FROM #TMPUSER_ROLL_DET_NEW
		 
		
		SET @NCNT=1
		
		SET @CDELCMD=N'DELETE FROM #USERPER_NEW WHERE '
		SET @NSTEP = 180	
		WHILE EXISTS (SELECT TOP 1 'U' FROM #TOTALUSER_NEW)
		BEGIN
				SELECT TOP 1 @CROLLID= ROLE_ID,@CROLLNAME=ROLE_NAME FROM #TOTALUSER_NEW
				SET @CCOLUMN_NAME = @CROLLNAME+'_VALUE'
				
				SET @CCMD=N'ALTER TABLE #USERPER_NEW
							ADD ['+@CCOLUMN_NAME+'] BIT'
				
				PRINT @CCMD	
				EXEC SP_EXECUTESQL 	@CCMD

				SET @NSTEP = 190					
				SET @CCMD=N'UPDATE A SET A.['+@CCOLUMN_NAME+']= ISNULL(B.VALUE,0) FROM #USERPER_NEW A
							LEFT OUTER JOIN USER_ROLE_DET B 
							ON A.FORM_NAME=B.FORM_NAME AND A.FORM_OPTION=B.FORM_OPTION AND B.ROLE_ID='''+@CROLLID+''''

				
				PRINT 	@CCMD
				EXEC SP_EXECUTESQL 	@CCMD		
				
				
				
				SET @NSTEP = 200	
				IF @NVIEWSTATUS IN (2,3)
				BEGIN
					SET @CDELCMD=@CDELCMD+(CASE WHEN @NCNT=1 THEN '' ELSE ' AND ' END)
					
					IF @NVIEWSTATUS=2
						SET @CDELCMD=@CDELCMD+N'['+@CCOLUMN_NAME+']=0'
					ELSE
						SET @CDELCMD=@CDELCMD+N'['+@CCOLUMN_NAME+']=1'	
				END	
				
				SET @NCNT=@NCNT+1
				SET @NSTEP = 210			
				DELETE #TOTALUSER_NEW WHERE ROLE_ID= @CROLLID
		END
		
		IF @NVIEWSTATUS IN (2,3)
		BEGIN
			PRINT @CDELCMD
			EXEC SP_EXECUTESQL @CDELCMD
		END	
		
		SET @NSTEP = 220	
		SELECT *,SR=ROW_NUMBER () OVER (PARTITION BY DISPLAY_FORM_NAME ORDER BY DISPLAY_FORM_NAME)
		INTO #USERPERFINAL_NEW
		FROM #USERPER_NEW ORDER BY DISPLAY_FORM_NAME,DISPLAY_NAME
		
		SET @NSTEP = 230
		UPDATE #USERPERFINAL_NEW SET DISPLAY_FORM_NAME='' WHERE SR>1
		ALTER TABLE #USERPERFINAL_NEW DROP COLUMN SR
		
		SELECT TOP 10 GROUP_NAME_NEW=CASE WHEN ROW_NUMBER() OVER(PARTITION BY GROUP_NAME ORDER BY GROUP_NAME)=1 THEN GROUP_NAME ELSE '' END,
		* FROM  #USERPERFINAL_NEW  A
		
						
	END
	GOTO END_PROC
	
END TRY

BEGIN CATCH
	SET @CERRMSG = 'PROCEDURE SP3S_GET_USER_ROLE: STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()  
	GOTO END_PROC
END CATCH	  

END_PROC:

	IF  @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')='' 	
		BEGIN	
			COMMIT TRANSACTION
			SET @CCMD = N'DELETE FROM MSTUSRROLE_USER_ROLE_DET_UPLOAD WHERE SP_ID= '''+@NSPID +''''
			PRINT @CCMD
			EXEC SP_EXECUTESQL 	@CCMD		
		END	
		ELSE
			ROLLBACK
	END

	SELECT ISNULL(@CERRMSG,'') AS ERRMSG			
			
END