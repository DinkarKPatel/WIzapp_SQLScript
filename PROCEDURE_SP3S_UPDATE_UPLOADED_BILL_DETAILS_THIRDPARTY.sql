CREATE  PROCEDURE SP3S_UPDATE_UPLOADED_BILL_DETAILS_THIRDPARTY
(
	@cCMID VARCHAR(50),
	@cERRMSG	VARCHAR(100),
	@bEditMode	NUMERIC(1)=0
)
AS
BEGIN
	DECLARE @bEnableThirdPartyWizClip VARCHAR(5),@cLoyaltyVendor VARCHAR(5)
	SELECT @bEnableThirdPartyWizClip = VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_THIRD_PARTY_LOYALTY'
	SELECT @cLoyaltyVendor = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOYALTY_VENDOR'

	IF (ISNULL(@bEnableThirdPartyWizClip,'0')='1' AND ISNULL(@cLoyaltyVendor,'0')='5')
	BEGIN
		IF EXISTS (SELECT CM_ID FROM thirdparty_loyalty_bill_upload WHERE CM_ID=@cCMID)
		BEGIN
			IF @bEditMode=2
				UPDATE thirdparty_loyalty_bill_upload SET UPLOADED=0,ERR_MSG=NULL,UPLOADED_TIME =NULL  WHERE CM_ID=@cCMID
			ELSE
				UPDATE thirdparty_loyalty_bill_upload SET UPLOADED=(CASE WHEN ISNULL(@cERRMSG,'')='' THEN 1 ELSE 0 END),ERR_MSG=@cERRMSG,UPLOADED_TIME =(CASE WHEN ISNULL(@cERRMSG,'')='' THEN GETDATE() ELSE NULL END)  WHERE CM_ID=@cCMID
		END
		ELSE
		BEGIN
			INSERT thirdparty_loyalty_bill_upload	( CM_ID, ERR_MSG, UPLOADED, UPLOADED_TIME )  
			SELECT 	@cCMID AS CM_ID, NULL ERR_MSG,NULL UPLOADED, NULL UPLOADED_TIME 
		END
	END
END