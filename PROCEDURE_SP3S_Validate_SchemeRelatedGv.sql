CREATE PROCEDURE SP3S_VALIDATE_SCHEMERELATEDGV
@NSPID VARCHAR(40),
@CERRORMSG VARCHAR(MAX) OUTPUT
AS
BEGIN
	DECLARE @NGVAMT NUMERIC(10,0),@BSCHEMERELATEDGV BIT,@BGVRELATEDTITLE BIT,@NSCHEMEAMT NUMERIC(10,2)
	
	SELECT TOP 1 @BSCHEMERELATEDGV=ISNULL(VALIDATE_WITH_EOSS,0) FROM SKU_GV_MST A (NOLOCK) 
	JOIN SLS_PAYMODE_XN_DET_UPLOAD B (NOLOCK) ON A.GV_SRNO=B.ADJ_MEMO_ID
	WHERE B.SP_ID=@NSPID AND ISNULL(VALIDATE_WITH_EOSS,0)=1  AND PAYMODE_CODE='GVC0001'
	
	SELECT TOP 1 @BGVRELATEDTITLE=ISNULL(GV_RELATED_TITLE,0) FROM SCHEME_SETUP_DET A (NOLOCK)
	JOIN SLS_CMD01106_UPLOAD B (NOLOCK) ON A.ROW_ID=B.SLSDET_ROW_ID 
	WHERE B.SP_ID=@NSPID AND ISNULL(GV_RELATED_TITLE,0)=1 
	
	IF ISNULL(@BSCHEMERELATEDGV,0)=0 AND ISNULL(@BGVRELATEDTITLE,0)=0
		RETURN
	
	IF ISNULL(@BSCHEMERELATEDGV,0)=1
		SELECT @NGVAMT=SUM(DENOMINATION)  FROM SKU_GV_MST A (NOLOCK) 
		JOIN SLS_PAYMODE_XN_DET_UPLOAD B (NOLOCK) ON A.GV_SRNO=B.ADJ_MEMO_ID
		WHERE B.SP_ID=@NSPID AND ISNULL(VALIDATE_WITH_EOSS,0)=1  AND PAYMODE_CODE='GVC0001'
	
	IF ISNULL(@BGVRELATEDTITLE,0)=1
		SELECT @NSCHEMEAMT=SUM(BASIC_DISCOUNT_AMOUNT) FROM  SCHEME_SETUP_DET A (NOLOCK)
		JOIN SLS_CMD01106_UPLOAD B (NOLOCK) ON A.ROW_ID=B.SLSDET_ROW_ID 
		WHERE B.SP_ID=@NSPID AND ISNULL(GV_RELATED_TITLE,0)=1 	
	
	SELECT @NGVAMT=ISNULL(@NGVAMT,0),@NSCHEMEAMT=ISNULL(@NSCHEMEAMT,0)
		

	IF ISNULL(@NGVAMT,0)>0 AND ISNULL(@NSCHEMEAMT,0)=0
		SET @CERRORMSG='NO VALID SCHEME APPLIED AGAINST THE REDEEMED GV'						    
	
	--SELECT @NGVAMT AS NGVAMT,@NSCHEMEAMT AS NSCHEMEAMT,@CERRORMSG AS CERRORMSG
END
