--EXEC SP_JOBISSUE_BOM_PRINT @cWhere = 'LC01120LCI-007388'
create PROCEDURE SP_JOBISSUE_BOM_PRINT
(
	@CWHERE	NVARCHAR(100)
)
AS
BEGIN
	SET NOCOUNT ON 
	DECLARE @ADD VARCHAR(MAX)='',@TIME VARCHAR(100)
	SET @TIME='START= '+CONVERT(VARCHAR,GETDATE(),114)
	--RAISERROR(@TIME,0,1) WITH NOWAIT

	SELECT TOP 1 @ADD = ISNULL(LMV.ADDRESS0,'')
	+ISNULL(' '+LMV.ADDRESS1,'')
	+ISNULL(' '+LMV.ADDRESS2,'') 
	+ISNULL(' '+LMV.AREA_NAME,'')
	+ISNULL(' '+LMV.CITY,'')
	+ISNULL(' '+LMV.PINCODE,'')
	+ISNULL(' '+LMV.[STATE],'')
	+ISNULL(' ('+LMV.[COUNTRY_NAME]+')','')
	FROM JOBWORK_ISSUE_MST A WITH (NOLOCK)
	JOIN PRD_AGENCY_MST AG WITH (NOLOCK) ON AG.AGENCY_CODE=A.AGENCY_CODE
	JOIN LMV01106 LMV WITH (NOLOCK) ON LMV.AC_CODE=AG.AC_CODE
	WHERE A.ISSUE_ID=LTRIM(RTRIM(@CWHERE))
	--PRINT @ADD	
	SET @TIME='1= '+CONVERT(VARCHAR,GETDATE(),114)
	
	
	
	SELECT E.MEMO_ID  ,F.ARTICLE_CODE,
	       F.AVG_QUANTITY +ISNULL(F. ADD_AVG_QUANTITY,0) AS AVG_QUANTITY,
	       SUM(A.QUANTITY*(F.AVG_QUANTITY +ISNULL(F. ADD_AVG_QUANTITY,0))) AS BOM,
	       UOM .UOM_NAME ,
	       SUM(CONVERT(NUMERIC(14,4), CASE WHEN ISNULL(UC.CONVERSION_VALUE,0) =0 THEN (A.QUANTITY*(F.AVG_QUANTITY +ISNULL(F. ADD_AVG_QUANTITY,0)))
	       ELSE (A.QUANTITY*(F.AVG_QUANTITY +ISNULL(F. ADD_AVG_QUANTITY,0)))/ISNULL(UC.CONVERSION_VALUE,0) END  )) AS REQ_QTY,
	       BU.CONVERSION_UOM_NAME AS BOM_UOM_NAME,
	       SUM(A.QUANTITY) AS DET,
	       SUM(A.QUANTITY) AS JWI,
	       ART.ARTICLE_NO ,
	       A.ISSUE_ID ,
	       ART.ARTICLE_NAME ,
	       SD.SUB_SECTION_NAME ,
	       SM.SECTION_NAME ,
	       @ADD AGENCY_ADDRESS,
	      ISNULL(REF.REF_NO,'') AS BUYER_REF_NO, ORD.MEMO_NO AS ORDER_NO,
		   ORD.MEMO_DT  AS ORDER_DT
	FROM JOBWORK_ISSUE_DET A (NOLOCK)
	JOIN JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID =B.ISSUE_ID 
	JOIN ORD_PLAN_BARCODE_DET C (NOLOCK) ON A.PRODUCT_CODE =C.PRODUCT_CODE 
	JOIN ORD_PLAN_DET D (NOLOCK) ON C.REFROW_ID =D.ROW_ID 
	JOIN ORD_PLAN_MST E (NOLOCK) ON E.MEMO_ID =D.MEMO_ID 
	JOIN ORD_PLAN_BOM_DET F (NOLOCK) ON D.ROW_ID =F.REF_ROW_ID AND A.JOB_CODE =F.JOB_CODE 
	JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =F.ARTICLE_CODE
	JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE 
	JOIN SECTIONM SM (NOLOCK) ON SM.SECTION_CODE =SD.SECTION_CODE  
	JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE 
	LEFT OUTER JOIN UOM_CONVERSION UC (NOLOCK) ON UC.UOM_CODE=UOM.UOM_CODE
    LEFT OUTER JOIN BOM_UOM BU (NOLOCK) ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE 
    LEFT JOIN VW_BUYER_REF_NO REF WITH (NOLOCK) ON REF.PRODUCT_CODE=A.PRODUCT_CODE 
	join(
	
		SELECT D.MEMO_ID ,D.MEMO_NO ,d.MEMO_DT  ,A.PRODUCT_CODE 
		FROM JOBWORK_ISSUE_DET A
		JOIN ORD_PLAN_BARCODE_DET B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
		JOIN ORD_PLAN_DET C ON B.REFROW_ID =C.ROW_ID 
		JOIN ORD_PLAN_MST D ON C.MEMO_ID =D.MEMO_ID 
		WHERE D.CANCELLED =0 
		AND A.ISSUE_ID= @CWHERE

	) ord on ord.product_code =a.product_code
	WHERE (A.ISSUE_ID=@CWHERE OR @CWHERE ='') 
	GROUP BY  E.MEMO_ID  ,F.ARTICLE_CODE,
	F.AVG_QUANTITY +ISNULL(F. ADD_AVG_QUANTITY,0),UOM .UOM_NAME,BU.CONVERSION_UOM_NAME,
    ART.ARTICLE_NO ,A.ISSUE_ID ,ART.ARTICLE_NAME ,SD.SUB_SECTION_NAME ,SM.SECTION_NAME ,
	ISNULL(REF.REF_NO,'') , ORD.MEMO_NO ,ORD.MEMO_DT 
	
  
  
	     
  ;WITH CTE AS
  (
   SELECT A.ISSUE_ID , A.PRODUCT_CODE ,A.QUANTITY,A.HSN_CODE ,A.GST_PERCENTAGE ,
   A.XN_VALUE_WITHOUT_GST ,A.XN_VALUE_WITH_GST ,
   a.igst_amount ,a.cgst_amount ,a.sgst_amount  
   FROM JOBWORK_ISSUE_DET A (NOLOCK)
   JOIN JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID =B.ISSUE_ID 
   WHERE B.CANCELLED =0
   AND A.ISSUE_ID=@CWHERE
   UNION ALL
   SELECT JOBWORK_ISSUE_ID , A.PRODUCT_CODE ,A.QUANTITY,A.HSN_CODE ,
   A.GST_PERCENTAGE ,A.XN_VALUE_WITHOUT_GST ,A.XN_VALUE_WITH_GST  ,
   a.igst_amount ,a.cgst_amount ,a.sgst_amount 
   FROM BOM_ISSUE_DET A  (NOLOCK)
   JOIN BOM_ISSUE_MST B (NOLOCK)  ON A.ISSUE_ID=B.ISSUE_ID 
   WHERE B.CANCELLED=0 AND B.JOBWORK_ISSUE_ID=@CWHERE
  )
  
  SELECT  C.ARTICLE_NO,a.HSN_CODE ,A.GST_PERCENTAGE ,
          SUM(ISNULL(A.XN_VALUE_WITHOUT_GST,0)) AS XN_VALUE_WITHOUT_GST,
          SUM(ISNULL(A.XN_VALUE_WITH_GST,0)) AS XN_VALUE_WITH_GST,
          SUM(ISNULL(A.igst_amount,0)) AS igst_amount,
          SUM(ISNULL(A.cgst_amount,0)) AS cgst_amount,
          SUM(ISNULL(A.sgst_amount,0)) AS sgst_amount
  FROM CTE A 
  JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
  JOIN ARTICLE C (NOLOCK) ON B.ARTICLE_CODE=C.ARTICLE_CODE 
  GROUP BY C.ARTICLE_NO,a.HSN_CODE ,A.GST_PERCENTAGE
  
   
END



-----arun 30-07-2019