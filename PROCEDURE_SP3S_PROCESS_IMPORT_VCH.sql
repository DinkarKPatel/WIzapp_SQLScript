CREATE  PROCEDURE SP3S_PROCESS_IMPORT_VCH    
@cTempTableName  VARCHAR(MAX),    
@cDEPT_ID   VARCHAR(5)    
    
AS    
BEGIN    
DECLARE @cCMD nVARCHAR(MAX) 
--EXEC SP_EXECUTESQL @cCMD 
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME=REPLACE(REPLACE(@cTempTableName,'[',''),']','') AND COLUMN_NAME='PAYMENT_AMOUNT' AND DATA_TYPE='numeric')
SET @cCMD=N'update '+@cTempTableName+' SET PAYMENT_AMOUNT=0 WHERE ISNULL(PAYMENT_AMOUNT,0)=0'
else
SET @cCMD=N'update '+@cTempTableName+' SET PAYMENT_AMOUNT=''0'' WHERE (ISNULL(PAYMENT_AMOUNT,''0'')=''0'' OR ISNULL(PAYMENT_AMOUNT,'''')='''') '
    
PRINT @ccmd     
EXEC SP_EXECUTESQL @cCMD    

IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME=REPLACE(REPLACE(@cTempTableName,'[',''),']','') AND COLUMN_NAME='RECEIPT_AMOUNT' AND DATA_TYPE='numeric')
SET @cCMD=N'update '+@cTempTableName+' SET RECEIPT_AMOUNT=0 WHERE ISNULL(RECEIPT_AMOUNT,0)=0'
else
   
SET @cCMD=N'update '+@cTempTableName+' SET RECEIPT_AMOUNT=''0'' WHERE (ISNULL(RECEIPT_AMOUNT,''0'')=''0'' OR ISNULL(RECEIPT_AMOUNT,'''')='''') OR ISNUMERIC(RECEIPT_AMOUNT)=0'    
    
PRINT @ccmd     
EXEC SP_EXECUTESQL @cCMD    

--SET @cCMD=N'update '+@cTempTableName+' SET ref_no=NEWID()'
--PRINT @ccmd     
--EXEC SP_EXECUTESQL @cCMD    
    
    
SET @cCMD=N'update a SET a.ac_code=(CASE WHEN b.ac_code is null then ''0000000000'' else b.ac_code end),    
a.ac_name=(CASE WHEN b.ac_code is null then '''' else b.ac_name end),    
a.cost_center_dept_id=(CASE WHEN ISNULL(a.COSTCENTER,'''')='''' then '''+@cDEPT_ID+''' else ISNULL(a.COSTCENTER,'''') end),    
a.voucher_dt=a.voucherdate
,a.DEBIT_AMOUNT=CONVERT(NUMERIC(14,2),ISNULL(a.PAYMENT_AMOUNT,0))    
,a.CREDIT_AMOUNT=CONVERT(NUMERIC(14,2),ISNULL(a.RECEIPT_AMOUNT,0))    
,a.VOUCHERTYPE=(CASE WHEN CONVERT(NUMERIC(14,2),ISNULL(a.PAYMENT_AMOUNT,0))>0 THEN ''PAYMENT'' WHEN CONVERT(NUMERIC(14,2),ISNULL(a.RECEIPT_AMOUNT,0))>0 THEN ''RECEIPT'' ELSE '''' END)    
,a.VOUCHER_TYPE=(CASE WHEN CONVERT(NUMERIC(14,2),ISNULL(a.PAYMENT_AMOUNT,0))>0 THEN ''PAYMENT'' WHEN CONVERT(NUMERIC(14,2),ISNULL(a.RECEIPT_AMOUNT,0))>0 THEN ''RECEIPT'' ELSE '''' END)    
,a.VOUCHER_CODE=(CASE WHEN CONVERT(NUMERIC(14,2),ISNULL(a.PAYMENT_AMOUNT,0))>0 THEN ''0000000002'' WHEN CONVERT(NUMERIC(14,2),ISNULL(a.RECEIPT_AMOUNT,0))>0 THEN ''0000000003'' ELSE '''' END)    
,a.X_type=(CASE WHEN CONVERT(NUMERIC(14,2),ISNULL(a.PAYMENT_AMOUNT,0))>0 THEN ''Dr'' ELSE ''Cr'' END)  
,A.bill_by_bill=B.BILL_BY_BILL,a.cr_days=ISNULL(b.CREDIT_DAYS,0),a.ref_no=CONVERT(VARCHAR(30),CAST(NEWID() AS VARCHAR(50)))--CONVERT(VARCHAR,GETDATE(),113)
FROM '+@cTempTableName+' a     
JOIN lmv01106 b ON REPLACE(b.ac_name,'' '','''')=REPLACE(a.accountname  ,'' '','''')  
LEFT OUTER JOIN location c ON c.dept_id=a.COSTCENTER'    
PRINT @ccmd     
EXEC SP_EXECUTESQL @cCMD    
    
    
--SET @cCMD=N'SELECT *,'''' AS err_msg,NEWID() AS VM_ID FROM '+@cTempTableName--+ ' WHERE ISNULL(DEBIT_AMOUNT,0)+ISNULL(CREDIT_AMOUNT,0)<>0'    
--PRINT @ccmd     
--EXEC SP_EXECUTESQL @cCMD    
END  
/*This is for forex related changes
CREATE PROCEDURE SP3S_PROCESS_IMPORT_VCH    
@cTempTableName  VARCHAR(MAX),    
@cDEPT_ID   VARCHAR(5)    
    
AS    
BEGIN    
DECLARE @cCMD nVARCHAR(MAX) 
EXEC SP_EXECUTESQL @cCMD SET @cCMD=N'update '+@cTempTableName+' SET PAYMENT_AMOUNT=''0'' WHERE (ISNULL(PAYMENT_AMOUNT,''0'')=''0'' OR ISNULL(PAYMENT_AMOUNT,'''')='''') OR ISNUMERIC(  PAYMENT_AMOUNT)=0 '
    
PRINT @ccmd     
EXEC SP_EXECUTESQL @cCMD    
    
SET @cCMD=N'update '+@cTempTableName+' SET RECEIPT_AMOUNT=''0'' WHERE (ISNULL(RECEIPT_AMOUNT,''0'')=''0'' OR ISNULL(RECEIPT_AMOUNT,'''')='''') OR ISNUMERIC(RECEIPT_AMOUNT)=0'    
    
PRINT @ccmd     
EXEC SP_EXECUTESQL @cCMD    

--SET @cCMD=N'update '+@cTempTableName+' SET ref_no=NEWID()'
--PRINT @ccmd     
--EXEC SP_EXECUTESQL @cCMD    
    
    
SET @cCMD=N'update a SET a.ac_code=(CASE WHEN b.ac_code is null then ''0000000000'' else b.ac_code end),    
a.ac_name=(CASE WHEN b.ac_code is null then '''' else b.ac_name end),    
a.cost_center_dept_id=(CASE WHEN ISNULL(a.COSTCENTER,'''')='''' then '''+@cDEPT_ID+''' else ISNULL(a.COSTCENTER,'''') end),    
a.voucher_dt=a.voucherdate
,a.DEBIT_AMOUNT=CONVERT(NUMERIC(14,2),ISNULL(a.PAYMENT_AMOUNT,0))    
,a.CREDIT_AMOUNT=CONVERT(NUMERIC(14,2),ISNULL(a.RECEIPT_AMOUNT,0))    
,a.VOUCHERTYPE=(CASE WHEN CONVERT(NUMERIC(14,2),ISNULL(a.PAYMENT_AMOUNT,0))>0 THEN ''PAYMENT'' WHEN CONVERT(NUMERIC(14,2),ISNULL(a.RECEIPT_AMOUNT,0))>0 THEN ''RECEIPT'' ELSE '''' END)    
,a.VOUCHER_TYPE=(CASE WHEN CONVERT(NUMERIC(14,2),ISNULL(a.PAYMENT_AMOUNT,0))>0 THEN ''PAYMENT'' WHEN CONVERT(NUMERIC(14,2),ISNULL(a.RECEIPT_AMOUNT,0))>0 THEN ''RECEIPT'' ELSE '''' END)    
,a.VOUCHER_CODE=(CASE WHEN CONVERT(NUMERIC(14,2),ISNULL(a.PAYMENT_AMOUNT,0))>0 THEN ''0000000002'' WHEN CONVERT(NUMERIC(14,2),ISNULL(a.RECEIPT_AMOUNT,0))>0 THEN ''0000000003'' ELSE '''' END)    
,a.X_type=(CASE WHEN CONVERT(NUMERIC(14,2),ISNULL(a.PAYMENT_AMOUNT,0))>0 THEN ''Dr'' ELSE ''Cr'' END)  
,A.bill_by_bill=B.BILL_BY_BILL,a.cr_days=ISNULL(b.CREDIT_DAYS,0),a.ref_no=CONVERT(VARCHAR(30),CAST(NEWID() AS VARCHAR(50)))--CONVERT(VARCHAR,GETDATE(),113)
FROM '+@cTempTableName+' a     
JOIN lmv01106 b ON REPLACE(b.ac_name,'' '','''')=REPLACE(a.accountname  ,'' '','''')  
LEFT OUTER JOIN location c ON c.dept_id=a.COSTCENTER'    
PRINT @ccmd     
EXEC SP_EXECUTESQL @cCMD    
    
    
--SET @cCMD=N'SELECT *,'''' AS err_msg,NEWID() AS VM_ID FROM '+@cTempTableName--+ ' WHERE ISNULL(DEBIT_AMOUNT,0)+ISNULL(CREDIT_AMOUNT,0)<>0'    
--PRINT @ccmd     
--EXEC SP_EXECUTESQL @cCMD    
END  
*/