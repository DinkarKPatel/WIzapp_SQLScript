CREATE PROCEDURE SP_PROCESS_IMPORT_PRODUCT_CODE    
@CTEMPTABLENAME NVARCHAR(100)    
--WITH ENCRYPTION

AS    
BEGIN    
DECLARE @CCMD NVARCHAR(MAX),@CCMD1 NVARCHAR(MAX) ,   @CCMD2 NVARCHAR(MAX)
    
IF OBJECT_ID(@CTEMPTABLENAME,'U') IS NULL    
BEGIN  
 SELECT 'TEMPORARY TABLE NOT EXISTS'  AS [ERR_MSG]    
 GOTO ATLAST    
END     
ELSE
BEGIN
	SET @CCMD=N'CREATE INDEX IX_TMP_IMPORT_PRODUCT_CODE ON '+@CTEMPTABLENAME+'(PRODUCT_CODE)'
	--EXEC SP_EXECUTESQL @CCMD
END
SET @CCMD2=N'IF OBJECT_ID('''+@CTEMPTABLENAME+'_1'',''U'') IS NOT NULL
	DROP TABLE '+@CTEMPTABLENAME+'_1'
EXEC SP_EXECUTESQL @CCMD2

SET @CCMD2=N' SELECT A.PRODUCT_CODE,LEFT(B.ARTICLE_CODE,2) AS DEPT_ID 
                INTO '+@CTEMPTABLENAME+'_1
				FROM SKU  A
				JOIN ARTICLE B ON A.ARTICLE_CODE= B.ARTICLE_CODE 
				JOIN '+@CTEMPTABLENAME+' D ON D.PRODUCT_CODE=A.PRODUCT_CODE	'

EXEC SP_EXECUTESQL @CCMD2
     
SET @CCMD=N'SELECT DISTINCT K.SECTION_NAME, J.SUB_SECTION_NAME, I.*, C.PARA1_NAME,        
   D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,B.ARTICLE_NO,         
   B.ARTICLE_NAME, B.CODING_SCHEME, A.*,TEMP.QUANTITY, TEMP.QUANTITY AS INVOICE_QUANTITY,        
   ISNULL(B.DT_CREATED,'''') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'''') AS [PARA3_DT_CREATED],      
   ISNULL(A.DT_CREATED,'''') AS [SKU_DT_CREATED],B.GEN_EAN_CODES,         
   '''' AS OTHER_XN_PRODUCT_CODE,D.PARA2_ORDER, B.SIZE_RATE_DIFF ,B.SIZE_CENTER_POINT,     
   TEMP.QUANTITY AS [ORG_QUANTITY],CAST(0 AS NUMERIC(10,2)) AS [STK_QUANTITY],B.STOCK_NA,    
   FORM.FORM_NAME,B.FIX_MRP,  A.PRODUCT_NAME,B.FIX_PRICE_ARTICLE,CONVERT(NUMERIC(2),0) AS  MODE,    
   B.ALIAS AS ARTICLE_ALIAS,LM.AC_NAME,B.DISCOUNT_PERCENTAGE,B.DISCOUNT_AMOUNT ,J.ALIAS AS SUB_SECTION_ALIAS      
   FROM SKU A (NOLOCK)       
   JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE         
   JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE        
   JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE        
   JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE        
   JOIN PARA4 F (NOLOCK) ON A.PARA4_CODE = F.PARA4_CODE        
   JOIN PARA5 G (NOLOCK) ON A.PARA5_CODE = G.PARA5_CODE        
   JOIN PARA6 H (NOLOCK) ON A.PARA6_CODE = H.PARA6_CODE        
   JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE        
   JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE        
   JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE     
   LEFT OUTER JOIN FORM (NOLOCK) ON FORM.FORM_ID=A.FORM_ID 
   JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
   JOIN (SELECT PRODUCT_CODE,SUM(QUANTITY) AS QUANTITY FROM  '+ ISNULL(@CTEMPTABLENAME,'') +' GROUP BY PRODUCT_CODE) TEMP ON TEMP.PRODUCT_CODE=A.PRODUCT_CODE ' 
      
     
     
     
SET @CCMD1=N'SELECT  A.PRODUCT_CODE,''BARCODE NOT EXISTS!'' AS [MSG]    
    FROM  '+ ISNULL(@CTEMPTABLENAME,'') +'  A (NOLOCK)       
    LEFT OUTER JOIN SKU TEMP ON TEMP.PRODUCT_CODE=A.PRODUCT_CODE      
    WHERE TEMP.PRODUCT_CODE IS NULL '    

 SELECT (CASE WHEN ISNULL(@CTEMPTABLENAME,'') ='' THEN 'TEMPORARY TABLE NOT EXISTS' ELSE '' END ) AS [ERR_MSG]    
     
 EXEC SP_EXECUTESQL @CCMD    
     
 EXEC SP_EXECUTESQL @CCMD1    
  
 IF OBJECT_ID(@CTEMPTABLENAME,'U') IS NOT NULL    
 BEGIN  
 SET @CCMD=N'DROP TABLE '+ @CTEMPTABLENAME   
 EXEC SP_EXECUTESQL @CCMD   
 END  
  ATLAST:  
END
