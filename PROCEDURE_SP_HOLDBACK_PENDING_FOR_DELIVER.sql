CREATE PROCEDURE SP_HOLDBACK_PENDING_FOR_DELIVER -- (3 digit changes done by Sanjay : 25-11-2024 after some error left by assigned developer
                                                 -- where customer_code was used instead of location_code)
(
	@CFM_DT DATETIME='' ,
	@CTO_DT DATETIME='',
	@CCUST_CODE VARCHAR(100)='',
	@CMEMO_ID VARCHAR(100)='',
	@CDEPT_ID varCHAR(4)='',
	@cuser_code varchar(7)='',
	--@CMEMO_NO VARCHAR(10)='',
	@BALLOW_TO_BYPASS_JWI_JWR BIT =0
)
AS
BEGIN     
 --(dinkar) Replace  left(memoid,2) to Location_code      


	  DECLARE @CHODEPT_ID VARCHAR(4),@CSTOCK_DEPT_ID VARCHAR(4)
	  SELECT @CHODEPT_ID=VALUE  FROM config(NOLOCK)  WHERE CONFIG_OPTION ='HO_LOCATION_ID'
	 
	 
	 SET @CSTOCK_DEPT_ID=@CDEPT_ID
	  IF @CHODEPT_ID=@CDEPT_ID
	  SET @CDEPT_ID=''

      --DECLARE @CDONOT_ALLOW_TO_DELIVER_WITHOUT_ISSUE VARCHAR(10)
	  SET @BALLOW_TO_BYPASS_JWI_JWR=ISNULL(@BALLOW_TO_BYPASS_JWI_JWR,0)
	  /*
	   @Rohit : 09-02-2021 : 02-0943 
	   Sir Statement : We need to discard / drop the facility of isuue back to customer without job work issue and receipt. 
	   It will always be through proper channel

        SELECT TOP 1 @CDONOT_ALLOW_TO_DELIVER_WITHOUT_ISSUE =VALUE FROM USER_ROLE_DET A
		JOIN USERS B ON A.ROLE_ID=B.ROLE_ID
		WHERE B.USER_CODE=@CUSER_CODE
		AND FORM_OPTION='DONOT_ALLOW_TO_DELIVER_WITHOUT_ISSUE' 
		SET @CDONOT_ALLOW_TO_DELIVER_WITHOUT_ISSUE=ISNULL(@CDONOT_ALLOW_TO_DELIVER_WITHOUT_ISSUE,'')
	 */
		

		--  IF OBJECT_ID('tempdb..#tmpMemos','u') IS NOT NULL
		--	DROP TABLE #tmpMemos
	   

	   
		--SELECT  a.memo_id, a.memo_no
		--INTO #tmpMemos
		--FROM HOLD_BACK_DELIVER_MST A WITH (NOLOCK)
		--JOIN ITEM_STATUS B (NOLOCK) ON B.HBD_MEMO_ID=A.memo_id
		--JOIN PMT01106 PMT (NOLOCK) ON PMT.PRODUCT_CODE=B.PRODUCT_CODE AND A.BIN_ID =PMT.BIN_ID AND PMT.DEPT_ID=@CSTOCK_DEPT_ID
		--WHERE (@CCUST_CODE='' OR A.CUSTOMER_CODE=@CCUST_CODE)
		--AND A.CANCELLED=0
		--and pmt.quantity_in_stock>0
		--AND(@CDEPT_ID='' OR LEFT(A.MEMO_ID,2)=@CDEPT_ID)
		--AND a.memo_dt>='2019-04-01'	
		--AND ISNULL(B.DELIVER_MEMO_ID,'')=''
		--group by  a.memo_id, a.memo_no

	   
       IF OBJECT_ID('TEMPDB..#NOTDELIEVED','U') IS NOT NULL
	        DROP TABLE #NOTDELIEVED


		SELECT  A.MEMO_ID,A.MEMO_NO AS HBD_MEMO_NO,B.HBD_ROW_ID AS ROW_ID,A1.REF_CMD_ROW_ID,a.MEMO_NO,B.DELIVERED ,A.REMARKS,A1.JOB_CODE ,A.LAST_UPDATE,
		B.DELIVERY_DT,A.REMARKS AS BILL_REMARKS,B.ITEM_REMARKS,B.PRODUCT_CODE,B.HOLD_QTY QUANTITY,A.MEMO_DT,A.CUSTOMER_CODE,MODE,
		B.ITEM_REMARKS DESCRIPTION,(CASE WHEN MODE=2 THEN 'REPAIR ITEMS' ELSE 'SOLD ITEMS' END) AS HOLD_TYPE,
		A.BIN_ID,B.JOB_RATE,a.location_code
		INTO #RECEIVED
		FROM HOLD_BACK_DELIVER_MST A WITH (NOLOCK)
		JOIN HOLD_BACK_DELIVER_DET A1 WITH (NOLOCK) ON A1.memo_id=A.memo_id
		JOIN ITEM_STATUS B  (NOLOCK) ON B.HBD_MEMO_ID=A.memo_id
		WHERE 1=2

		IF ISNULL(@BALLOW_TO_BYPASS_JWI_JWR,0)=1 
		BEGIN
		INSERT INTO #RECEIVED(location_code, MEMO_ID,HBD_MEMO_NO,ROW_ID,REF_CMD_ROW_ID,MEMO_NO,DELIVERED ,REMARKS,JOB_CODE ,LAST_UPDATE,
		DELIVERY_DT,BILL_REMARKS,ITEM_REMARKS,PRODUCT_CODE,QUANTITY,MEMO_DT,CUSTOMER_CODE,MODE,DESCRIPTION,HOLD_TYPE,BIN_ID,JOB_RATE)
			SELECT a.location_code, A.MEMO_ID,A.MEMO_NO AS HBD_MEMO_NO,A1.ROW_ID AS ROW_ID,A1.REF_CMD_ROW_ID,a.MEMO_NO,A1.DELIVERED ,A.REMARKS,A1.JOB_CODE ,A.LAST_UPDATE,
			A1.DELIVERY_DT,A.REMARKS AS BILL_REMARKS,A1.remarks as ITEM_REMARKS,A1.PRODUCT_CODE,A1.QUANTITY QUANTITY,A.MEMO_DT,A.CUSTOMER_CODE,MODE,
			A1.REMARKS DESCRIPTION,(CASE WHEN MODE=2 THEN 'REPAIR ITEMS' ELSE 'SOLD ITEMS' END) AS HOLD_TYPE,
			A.BIN_ID,A1.JOB_RATE

			--INTO #RECEIVED
			FROM HOLD_BACK_DELIVER_MST A WITH (NOLOCK)
			JOIN HOLD_BACK_DELIVER_DET A1 WITH (NOLOCK) ON A1.memo_id=A.memo_id
			--left outer JOIN ITEM_STATUS B (NOLOCK) ON B.HBD_MEMO_ID=A.memo_id
			join pmt01106 pmt (nolock) on pmt.product_code=A1.PRODUCT_CODE and a.bin_id =pmt.bin_id  AND PMT.DEPT_ID=@CSTOCK_DEPT_ID
			WHERE (@CCUST_CODE='' OR A.CUSTOMER_CODE=@CCUST_CODE)
			AND A.CANCELLED=0
			AND (@CDEPT_ID='' OR  a.location_code =@CDEPT_ID )
			AND a.memo_dt>='2019-04-01'	
			--and pmt.quantity_in_stock>0 and pmt.BIN_ID ='999'
				AND 
				(ISNULL(@BALLOW_TO_BYPASS_JWI_JWR,0)=1 AND pmt.quantity_in_stock>0)
		END
		
	ELSE

		BEGIN
		--HOLD BACK THAT HAS NOT BEEN DELIEVERED
				INSERT INTO #RECEIVED(location_code, MEMO_ID,HBD_MEMO_NO,ROW_ID,REF_CMD_ROW_ID,MEMO_NO,DELIVERED ,REMARKS,JOB_CODE ,LAST_UPDATE,
		DELIVERY_DT,BILL_REMARKS,ITEM_REMARKS,PRODUCT_CODE,QUANTITY,MEMO_DT,CUSTOMER_CODE,MODE,DESCRIPTION,HOLD_TYPE,BIN_ID,JOB_RATE)

		SELECT a.location_code, A.MEMO_ID,A.MEMO_NO AS HBD_MEMO_NO,B.HBD_ROW_ID AS ROW_ID,REF_CMD_ROW_ID,a.MEMO_NO,DELIVERED ,A.REMARKS,JOB_CODE ,A.LAST_UPDATE,
		DELIVERY_DT,A.REMARKS AS BILL_REMARKS,B.ITEM_REMARKS,B.PRODUCT_CODE,B.HOLD_QTY QUANTITY,A.MEMO_DT,A.CUSTOMER_CODE,MODE,
		B.ITEM_REMARKS DESCRIPTION,(CASE WHEN MODE=2 THEN 'REPAIR ITEMS' ELSE 'SOLD ITEMS' END) AS HOLD_TYPE,
		A.BIN_ID,B.JOB_RATE
		--INTO #NOTDELIEVED
		--INTO #RECEIVED1
		FROM HOLD_BACK_DELIVER_MST A WITH (NOLOCK)
		left outer JOIN ITEM_STATUS B (NOLOCK) ON B.HBD_MEMO_ID=A.memo_id
		join pmt01106 pmt (nolock) on pmt.product_code=b.PRODUCT_CODE and a.bin_id =pmt.bin_id  AND PMT.DEPT_ID=@CSTOCK_DEPT_ID
		WHERE B.delivered=0 
		AND (@CCUST_CODE='' OR A.CUSTOMER_CODE=@CCUST_CODE)
		AND A.CANCELLED=0
		AND (@CDEPT_ID='' OR  a.location_code =@CDEPT_ID )
		AND a.memo_dt>='2019-04-01'	
		--and pmt.quantity_in_stock>0 and pmt.BIN_ID ='999'
		AND (ISNULL(B.DELIVER_MEMO_ID,'')=''
		AND (
			(ISNULL(B.receipt_id,'')<>'' and ISNULL(B.issue_id,'')<>'')
			OR 
			(ISNULL(@BALLOW_TO_BYPASS_JWI_JWR,0)=1 AND pmt.quantity_in_stock>0)
		))
		END

		--AND (ISNULL(@CDONOT_ALLOW_TO_DELIVER_WITHOUT_ISSUE,'')<>'1' OR B.issue_id<>'')
	    --AND (ISNULL(@CDONOT_ALLOW_TO_DELIVER_WITHOUT_ISSUE,'')<>'1' OR ISNULL(B.receipt_id,'')<>'' and B.issue_id<>''))
		
		if @@spid=54
		SELECT 'check received', * FROM #RECEIVED

		CREATE NONCLUSTERED INDEX [IX_TEMP_RECEIVED]
		ON [dbo].[#RECEIVED] ([MODE])
		INCLUDE ([REF_CMD_ROW_ID],[HOLD_TYPE])
		

      IF OBJECT_ID('TEMPDB..#TMPPENDINGFORDELIVER','U') IS NOT NULL
          DROP TABLE #TMPPENDINGFORDELIVER
    
	
	           
		 select  CMM.CM_NO,CONVERT(VARCHAR,CMM.CM_DT,105) AS CM_DT,CMM.CM_ID,
		    QUANTITY=SUM(CMD.QUANTITY)
		   ,CMM.SUBTOTAL,CMM.DISCOUNT_PERCENTAGE,CMM.DISCOUNT_AMOUNT,CMM.NET_AMOUNT
		   ,REC.CUSTOMER_CODE,CUSTOMER_NAME=C.CUSTOMER_TITLE +' '+C.CUSTOMER_FNAME + ' '+C.CUSTOMER_LNAME
		   ,USER_CUSTOMER_CODE 
		   ,CANCELLED
		   ,CMM.USER_CODE
		   ,CMM.FIN_YEAR,CMM.ROUND_OFF,CMM.MEMO_TYPE,CMM.REMARKS
		   ,CMM.PARTY_TYPE,CMM.AC_CODE,AC_NAME ,bin1.BIN_ID,bin1.BIN_NAME,HOLD_TYPE,CMM.CM_NO AS SOURCE_MEMO_NO,CMM.CM_ID AS SOURCE_MEMO_ID
		   ,REC.HBD_MEMO_NO, REC.MEMO_ID AS HBD_MEMO_ID
          FROM CMM01106 CMM (NOLOCK)
          JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID=CMD.CM_ID 
          JOIN #RECEIVED REC  ON CMD.ROW_ID =REC .REF_CMD_ROW_ID 
		  JOIN BIN bin1 (NOLOCK) ON BIN1.BIN_ID =isnull(REC.BIN_ID,'000')
          JOIN CUSTDYM C (NOLOCK) ON C.CUSTOMER_CODE=REC.CUSTOMER_CODE 
		  JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =CMM.AC_CODE 
          WHERE  (@CMEMO_ID<>'' OR CMM.CM_DT BETWEEN @CFM_DT AND @CTO_DT )
		  AND (@CCUST_CODE='' OR REC.CUSTOMER_CODE=@CCUST_CODE)
		  AND (@CDEPT_ID='' OR cmm.location_Code =@CDEPT_ID)
		  AND (@CMEMO_ID='' OR CMM.CM_ID LIKE @CMEMO_ID)
		  AND CMM.CANCELLED=0  
		  AND ISNULL(MODE,0)<>2
          GROUP BY CMM.CM_NO,CMM.CM_DT,CMM.CM_ID
		   ,CMM.SUBTOTAL,CMM.DISCOUNT_PERCENTAGE,CMM.DISCOUNT_AMOUNT,CMM.NET_AMOUNT
		   ,REC.CUSTOMER_CODE,C.CUSTOMER_TITLE +' '+C.CUSTOMER_FNAME + ' '+C.CUSTOMER_LNAME
		   ,USER_CUSTOMER_CODE 
		   ,CMM.CANCELLED
		   ,CMM.USER_CODE
		   ,CMM.FIN_YEAR,CMM.ROUND_OFF,CMM.MEMO_TYPE,CMM.REMARKS
		   ,CMM.PARTY_TYPE,CMM.AC_CODE,AC_NAME ,bin1.BIN_ID,bin1.BIN_NAME,HOLD_TYPE 
		   ,REC.HBD_MEMO_NO, REC.MEMO_ID
			
		 UNION
		 select rec.HBD_MEMO_NO AS CM_NO,CONVERT(VARCHAR,MEMO_DT,105) AS CM_DT,rec.memo_id AS CM_ID,
		    QUANTITY=SUM(REC.QUANTITY)
		   ,0 AS SUBTOTAL,0 AS DISCOUNT_PERCENTAGE,0 AS DISCOUNT_AMOUNT,0 AS NET_AMOUNT
		 ,CUST.CUSTOMER_CODE,CUSTOMER_NAME=CUST.CUSTOMER_TITLE +' '+CUST.CUSTOMER_FNAME + ' '+CUST.CUSTOMER_LNAME
		   ,USER_CUSTOMER_CODE 
		   ,0 AS CANCELLED
		   ,'0000000'  AS USER_CODE
		   ,'' AS FIN_YEAR,0 AS ROUND_OFF,1 AS MEMO_TYPE,'' AS REMARKS
		   ,0 AS PARTY_TYPE,'' AS AC_CODE,' 'AS AC_NAME ,'000' AS  BIN_ID,'' AS BIN_NAME,HOLD_TYPE,
		   REC.MEMO_NO AS SOURCE_MEMO_NO,REC.MEMO_ID AS SOURCE_MEMO_ID  ,REC.HBD_MEMO_NO, REC.MEMO_ID AS HBD_MEMO_ID
          FROM #RECEIVED REC
          JOIN CUSTDYM CUST (NOLOCK) ON CUST.CUSTOMER_CODE=REC.CUSTOMER_CODE 
          WHERE  (@CMEMO_ID<>'' OR REC.MEMO_DT BETWEEN @CFM_DT AND @CTO_DT )
		  AND (@CCUST_CODE='' OR REC.CUSTOMER_CODE=@CCUST_CODE)
		  AND (@CDEPT_ID='' OR rec.location_code=@CDEPT_ID)
		  AND (@CMEMO_ID='' OR REC.MEMO_ID LIKE @CMEMO_ID)
		  AND ISNULL(MODE,0)=2
          GROUP BY REC.MEMO_NO,REC.MEMO_DT,REC.MEMO_ID,HOLD_TYPE
		   ,CUST.CUSTOMER_CODE,CUST.CUSTOMER_TITLE +' '+CUST.CUSTOMER_FNAME + ' '+CUST.CUSTOMER_LNAME
		   ,USER_CUSTOMER_CODE,REC.HBD_MEMO_NO, REC.MEMO_ID
	
		   
		select CMD.CM_ID,CMM.CM_NO,REC.PRODUCT_CODE,CMD.QUANTITY,CMD.MRP,CMD.NET
		  ,CMD.DISCOUNT_PERCENTAGE,CMD.DISCOUNT_AMOUNT,CMD.ROW_ID
		  ,REC.MEMO_NO AS HBD_MEMO_NO,REC.ROW_ID AS REF_HBD_ROW_ID 
		  ,SECTION_NAME,SUB_SECTION_NAME ,ARTICLE_NO,ARTICLE_NAME  
		  ,PARA1_NAME ,PARA2_NAME ,PARA3_NAME ,PARA4_NAME ,PARA5_NAME ,PARA6_NAME,'' as UOM_NAME,1 as UOM_TYPE
		  ,ISNULL(CMD.HOLD_FOR_ALTER,0) AS CHKDELEVER  
		  ,CMD.TAX_PERCENTAGE,CMD.TAX_AMOUNT,CMD.EMP_CODE
		  ,CMD.DEPT_ID,CMD.TAX_TYPE,CMD.TAX_METHOD,CMD.EMP_CODE1
		  ,CMD.EMP_CODE2
		  ,CMD.ITEM_DESC
		  ,CMD.WEIGHTED_AVG_DISC_PCT
		  ,CMD.WEIGHTED_AVG_DISC_AMT
		  ,CMD.MANUAL_DISCOUNT
		  ,CMD.FIX_MRP
		  ,CMD.SR_NO
		  ,CMD.PACK_SLIP_ID
		  ,CMD.XN_TYPE
		  ,CMD.REPEAT_PUR_ORDER
		  ,CMD.BIN_ID 
		  ,CMD.REF_ORDER_ID
		  ,CMD.FOC_QUANTITY
		  ,CMD.CMM_DISCOUNT_AMOUNT
		  ,CMD.NRM_ID 
		  ,EMP.EMP_NAME,EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2
		  ,REC.BILL_REMARKS ,REC .ITEM_REMARKS,CMM.CM_ID AS SOURCE_MEMO_ID 
		  ,REC.HBD_MEMO_NO, REC.MEMO_ID AS HBD_MEMO_ID ,REC.JOB_RATE
		  FROM CMD01106 CMD (NOLOCK)
		  JOIN CMM01106 CMM (NOLOCK) ON CMD.CM_ID =CMM.CM_ID 
          JOIN #RECEIVED REC  ON CMD.ROW_ID =REC .REF_CMD_ROW_ID 
		  JOIN BIN (NOLOCK) ON BIN.BIN_ID =CMM.BIN_ID
		  JOIN BINUSERS BU (NOLOCK) ON BU.BIN_ID=BIN.BIN_ID
          LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK)ON CMD.EMP_CODE = EMP.EMP_CODE 
		  LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON CMD.EMP_CODE1 = EMP1.EMP_CODE     
		  LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON CMD.EMP_CODE2 = EMP2.EMP_CODE  
         LEFT OUTER JOIN SKU_names (NOLOCK) SKU ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
          WHERE (@CMEMO_ID<>'' OR  CMM.CM_DT BETWEEN @CFM_DT AND @CTO_DT)
		  AND (@CCUST_CODE='' OR REC.CUSTOMER_CODE=@CCUST_CODE)
		  AND (@CDEPT_ID='' OR cmm.location_Code =@CDEPT_ID)
		  AND (@CMEMO_ID='' OR CMM.CM_ID LIKE @CMEMO_ID)
		  AND CMM.CANCELLED=0 
		  AND BU.user_code=@cuser_code
		  --AND (CMM.SUBTOTAL+ISNULL(CMM.SUBTOTAL_R,0))>0 
		  AND ISNULL(MODE,0)<>2
		  
		UNION
		select rec.memo_id AS CM_ID,rec.HBD_MEMO_NO AS CM_NO,REC.PRODUCT_CODE,REC.QUANTITY,0 AS MRP,0 AS NET
		  ,0 AS DISCOUNT_PERCENTAGE,0 AS DISCOUNT_AMOUNT,'' AS ROW_ID
		  ,REC.MEMO_NO AS HBD_MEMO_NO,REC.ROW_ID AS REF_HBD_ROW_ID 
		  ,SECTION_NAME,SUB_SECTION_NAME ,ARTICLE_NO,ARTICLE_NAME  
		  ,'' AS PARA1_NAME ,'' AS PARA2_NAME ,'' AS PARA3_NAME ,'' AS PARA4_NAME ,'' AS PARA5_NAME ,
		  '' AS PARA6_NAME,'' as UOM_NAME,1 as UOM_TYPE
		  ,0 AS CHKDELEVER  
		  ,0 AS TAX_PERCENTAGE,0 AS TAX_AMOUNT,'' AS EMP_CODE
		  ,'' AS DEPT_ID,0 AS TAX_TYPE,0 AS TAX_METHOD,'' AS EMP_CODE1
		  ,'' AS EMP_CODE2
		  ,REC.DESCRIPTION  AS ITEM_DESC
		  ,0 AS WEIGHTED_AVG_DISC_PCT
		  ,0 AS WEIGHTED_AVG_DISC_AMT
		  ,0 AS MANUAL_DISCOUNT
		  ,0 AS FIX_MRP
		  ,0 AS SR_NO
		  ,'' AS PACK_SLIP_ID
		  ,'' AS XN_TYPE
		  ,0 AS REPEAT_PUR_ORDER
		  ,''  AS BIN_ID 
		  ,''  AS REF_ORDER_ID
		  ,0  AS FOC_QUANTITY
		  ,0  AS CMM_DISCOUNT_AMOUNT
		  ,'' AS NRM_ID 
		  ,'' AS EMP_NAME,'' AS EMP_NAME1 ,'' AS EMP_NAME2
		  ,REC.BILL_REMARKS ,REC .ITEM_REMARKS ,REC.MEMO_ID AS SOURCE_MEMO_ID 
		  ,REC.HBD_MEMO_NO, REC.MEMO_ID AS HBD_MEMO_ID,REC.JOB_RATE
		  FROM #RECEIVED REC 
          JOIN SKU SKU (NOLOCK) ON SKU.PRODUCT_CODE =REC.PRODUCT_CODE 
		 LEFT OUTER JOIN sku_names sn (nolock) on sn.product_Code=sku.product_code
          WHERE (@CMEMO_ID<>'' OR  MEMO_DT BETWEEN @CFM_DT AND @CTO_DT)
		  AND (@CCUST_CODE='' OR REC.CUSTOMER_CODE=@CCUST_CODE)
		  AND (@CDEPT_ID='' OR  rec.location_code =@CDEPT_ID)
		  AND (@CMEMO_ID='' OR REC.memo_id LIKE @CMEMO_ID)
		  AND MODE=2 	
END
--END OF PROCEDURE - SP_HOLDBACK_PENDING_FOR_DELIVER
/*
exec SP_HOLDBACK_PENDING_FOR_DELIVER
	@CFM_DT='2019-04-01' ,
	@CTO_DT='2019-11-30',
	@CCUST_CODE='',
	@CDEPT_ID='01'


select * from HOLD_BACK_DELIVER_det
select count(*) from sls_delivery_det	
*/



