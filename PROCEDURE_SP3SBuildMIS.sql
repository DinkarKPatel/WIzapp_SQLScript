create PROCEDURE SP3SBUILDMIS
(
	 @CXNID			VARCHAR(50)
	,@NUPDATEMODE	NUMERIC(2)
    ,@CINSJOINSTR   VARCHAR(1000)=''
	,@CWHERECLAUSE	VARCHAR(1000)=''
	,@cRfTableName  varchar(500)=''	
	,@CERRMSG		VARCHAR(MAX) OUTPUT
)
AS
BEGIN
/*
XNTYPE FILTER IS REQUIRED DURING DELETION FROM RFOPT TABLE BECAUSE IN SOME CASES LIKE TRO FROM PIM01106
,THE INSERTED XN_ID IS THAT OF WHOLESALE INVOICE.
*/
	DECLARE @CCMD NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTER VARCHAR(1000),@CDELSTR VARCHAR(1000),@CDELJOINSTR VARCHAR(500)
BEGIN TRY

	DECLARE @BBUILDRFOPT BIT
	
	EXEC SP3S_CHKRFOPT_BUILD @BBUILDRFOPT OUTPUT
	
	IF @BBUILDRFOPT=0
		RETURN
	
	IF @cRfTableName=''	
		EXEC SP3S_RFDBTABLE 'MIS',@cXnID,@cRFTABLENAME OUTPUT 

	SET @CFILTER=(CASE WHEN @NUPDATEMODE IN (0,4) THEN '1=1' ELSE 'B.ISSUE_ID='''+@CXNID+'''' END)+@CWHERECLAUSE				   	
    IF @nUpdateMode<>1
	BEGIN
		IF @NUPDATEMODE IN (3)
		BEGIN
	
	    
			SET @CCMD=N'UPDATE A SET MIS_QTY=A.MIS_QTY-B.MIS_QTY,
			                         MIR_QTY=A.MIR_QTY-B.MIR_QTY
					  FROM '+@cRFTABLEName+' A
					  JOIN 
					  (
					  SELECT LEFT(B.ISSUE_ID,2) AS DEPT_ID
					   ,B.ISSUE_DT AS XN_DT
					   ,A.PRODUCT_CODE
					   ,SUM(CASE WHEN ISNULL(B.ISSUE_TYPE,0)=0 THEN A.STOCK_QTY ELSE 0 END) AS MIS_QTY
					   ,SUM(CASE WHEN ISNULL(B.ISSUE_TYPE,0)=0 THEN 0 ELSE A.STOCK_QTY END) AS MIR_QTY
					   ,A.BIN_ID  AS [BIN_ID]      
					 FROM BOM_ISSUE_DET A (NOLOCK)  
					 JOIN BOM_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID  
					 JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE  
					 WHERE B.CANCELLED=0  AND B.ISSUE_ID='''+@CXNID+'''
					 GROUP BY LEFT(B.ISSUE_ID,2) ,B.ISSUE_DT ,A.PRODUCT_CODE,A.BIN_ID
					 ) B on A.PROduct_code=b.product_code AND a.xn_dt=b.xn_dt AND a.dept_id=b.dept_id AND a.bin_id=b.bin_id'
			PRINT @CCMD 
			EXEC SP_EXECUTESQL @CCMD
		END	
	END
	IF @NUPDATEMODE<>3
	BEGIN
		SET @CSTEP = 20
	    
	    
			SET @CCMD=N'UPDATE A SET MIS_QTY=A.MIS_QTY+B.MIS_QTY,
			                         MIR_QTY=A.MIR_QTY+B.MIR_QTY
					  FROM '+@cRFTABLEName+' A
					  JOIN 
					  (
					  SELECT LEFT(B.ISSUE_ID,2) AS DEPT_ID
					   ,B.ISSUE_DT AS XN_DT
					   ,A.PRODUCT_CODE
					   ,SUM(CASE WHEN ISNULL(B.ISSUE_TYPE,0)=0 THEN A.STOCK_QTY ELSE 0 END) AS MIS_QTY
					   ,SUM(CASE WHEN ISNULL(B.ISSUE_TYPE,0)=0 THEN 0 ELSE A.STOCK_QTY END) AS MIR_QTY
					   ,A.BIN_ID  AS [BIN_ID]      
					 FROM BOM_ISSUE_DET A (NOLOCK)  
					 JOIN BOM_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID  
					 JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE  
					 WHERE B.CANCELLED=0  AND B.ISSUE_ID='''+@CXNID+'''
					 GROUP BY LEFT(B.ISSUE_ID,2) ,B.ISSUE_DT ,A.PRODUCT_CODE,A.BIN_ID
					 ) B on A.PROduct_code=b.product_code AND a.xn_dt=b.xn_dt AND a.dept_id=b.dept_id AND a.bin_id=b.bin_id'
			PRINT @CCMD 
			EXEC SP_EXECUTESQL @CCMD
			
			
		SET @CCMD=N'INSERT '+@cRFTABLEName+'(DEPT_ID,XN_DT,PRODUCT_CODE,MIS_QTY,MIR_QTY,BIN_ID)
		          SELECT XN.DEPT_ID,XN.XN_DT,XN.PRODUCT_CODE,XN.MIS_QTY,XN.MIR_QTY,XN.BIN_ID FROM
		          (
				  SELECT LEFT(B.ISSUE_ID,2) AS DEPT_ID
				   ,B.ISSUE_DT AS XN_DT
				   ,A.PRODUCT_CODE
				   ,SUM(CASE WHEN ISNULL(B.ISSUE_TYPE,0)=0 THEN A.STOCK_QTY ELSE 0 END) AS MIS_QTY
				   ,SUM(CASE WHEN ISNULL(B.ISSUE_TYPE,0)=0 THEN 0 ELSE A.STOCK_QTY END) AS MIR_QTY
				   ,A.BIN_ID  AS [BIN_ID]      
				 FROM BOM_ISSUE_DET A (NOLOCK)  
				 JOIN BOM_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID  
				 JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE  
				 WHERE B.CANCELLED=0  AND B.ISSUE_ID='''+@CXNID+'''
				 GROUP BY LEFT(B.ISSUE_ID,2),B.ISSUE_DT,A.PRODUCT_CODE,A.BIN_ID
				 ) XN
				 LEFT OUTER JOIN '+@cRFTABLEName+' b ON xn.dept_id=b.dept_id AND xn.xn_dt=b.xn_dt 
			     AND xn.product_code=b.product_code AND xn.bin_id=b.bin_id
			     WHERE b.product_code IS NULL 
			        '
		PRINT @CCMD 
		EXEC SP_EXECUTESQL @CCMD	
	END
	
END TRY
BEGIN CATCH
	SET @CERRMSG='SP3SBUILDMIS: STEP :'+@CSTEP+',ERROR :'+ERROR_MESSAGE()
END CATCH	

ENDPROC:

END
--END OF PROCEDURE - SP3SBUILDMIS
