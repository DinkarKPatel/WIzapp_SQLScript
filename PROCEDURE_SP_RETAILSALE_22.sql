CREATE PROCEDURE SP_RETAILSALE_22--(LocId 3 digit change only increased the parameter width by Sanjay:30-10-2024)
(  
	 @CQUERYID			NUMERIC(2),  
	 @CWHERE			VARCHAR(MAX)='',  
	 @CFINYEAR			VARCHAR(5)='',  
	 @CDEPTID			VARCHAR(4)='',  
	 @NNAVMODE			NUMERIC(2)=1,  
	 @CWIZAPPUSERCODE	VARCHAR(10)='',  
	 @CREFMEMOID		VARCHAR(40)='',  
	 @CREFMEMODT		DATETIME='',  
	 @BINCLUDEESTIMATE	BIT=1,  
	 @CFROMDT			DATETIME='',  
	 @CTODT				VARCHAR(50)='',
	 @bCardDiscount		INT=0,
	 @cCustCode			VARCHAR(15)=''
) 
AS  
BEGIN  

	--DECLARE @CWHERE			VARCHAR(MAX)='3877', @cCustCode VARCHAR(MAX)='',@bCardDiscount		INT=0
	DECLARE @CCMD NVARCHAR(MAX)=''
	DECLARE @dtable TABLE (DBNAME VARCHAR(100),CHECKED BIT)
	DECLARE @dtable_20 TABLE (CM_ID VARCHAR(100),ITEMCOUNT INT,SRNO INT,barcode_coding_scheme INT,ErrMsg VARCHAR(100),location_code VARCHAR(10))
	DECLARE @dtable_21 TABLE (barcode_coding_scheme INT)
	DECLARE @dbNAME VARCHAR(100),@BALLOWNEGSTOCK BIT,@LocLength VARCHAR(2)
SET @LocLength=CAST ((CASE WHEN LEN(@cdeptid)=0 THEN 2 ELSE LEN(@cDEPTID) END) as VARCHAR(2))

	SELECT @BALLOWNEGSTOCK =CAST(VALUE AS BIT) FROM USER_ROLE_DET A (NOLOCK)--ADDED
		JOIN USERS B (NOLOCK)--ADDED
		ON A.ROLE_ID=B.ROLE_ID 
		WHERE USER_CODE=@CWIZAPPUSERCODE 
		AND FORM_NAME='FRMSALE' 
		AND FORM_OPTION='ALLOW_NEG_STOCK'	

		SET @BALLOWNEGSTOCK=ISNULL(@BALLOWNEGSTOCK,0)

	INSERT INTO @dtable(DBNAME,CHECKED)
	SELECT DB_NAME() AS NAME,CAST(0 AS INT) AS CHECKED 
	INSERT INTO @dtable(DBNAME,CHECKED)
	SELECT NAME, CAST(0 AS INT) AS CHECKED 
	FROM SYS.DATABASES 
	WHERE (NAME LIKE DB_NAME()+'[_]011[0-9][0-9]')
	ORDER BY CAST(RIGHT(NAME,3) AS INT) DESC
	--SELECT * FROM @dtable
	WHILE EXISTS (SELECT TOP 1 DBNAME FROM @dtable WHERE CHECKED=0)
	BEGIN
	SELECT TOP 1 @dbNAME= DBNAME FROM @dtable WHERE CHECKED=0

	DECLARE @cBarCodeSeparator VARCHAR(5)
	SELECT TOP 1 @cBarCodeSeparator = value from config (NOLOCK) WHERE config_option='barcode_separator'

	IF ISNULL(@cBarCodeSeparator,'')<>''
	BEGIN
		IF CHARINDEX(@cBarCodeSeparator,@CWHERE)>0
			SET @CWHERE=SUBSTRING(@CWHERE,1,CHARINDEX(@cBarCodeSeparator,@CWHERE)-1)
	END
	
	DECLARE @CPRODUCT_CODEFILTER VARCHAR(1000)
	IF CHARINDEX('@',@CWHERE )>0
	SET @CPRODUCT_CODEFILTER=' AND M.PRODUCT_CODE='''+@CWHERE+''''
	ELSE 
	SET @CPRODUCT_CODEFILTER=' AND CASE WHEN CHARINDEX(''@'',M.PRODUCT_CODE)=0 THEN M.PRODUCT_CODE 
		                             ELSE SUBSTRING (M.PRODUCT_CODE,1, CHARINDEX(''@'',M.PRODUCT_CODE)-1) END ='''+@CWHERE+''' '
	


	SET @cCMD=N'
	USE '+@dbNAME+';
	SELECT DISTINCT barcode_coding_scheme
		FROM SKU M (NOLOCK) 
		WHERE PRODUCT_CODE<>'''' '+@CPRODUCT_CODEFILTER 
	
	 PRINT @cCMD
	 INSERT INTO @dtable_21(barcode_coding_scheme )
	 EXEC SP_EXECUTESQL @cCMD

	SET @cCMD=N'
	USE '+@dbNAME+';
	SELECT TOP 10 CM_ID,ITEMCOUNT,SRNO,barcode_coding_scheme,location_code
	FROM 
	(
		SELECT N.CM_ID ,COUNT(*) AS ITEMCOUNT,ROW_NUMBER() OVER (ORDER BY N.CM_ID) AS SRNO,sku.barcode_coding_scheme,LEFT(N.CM_ID,'+@LocLength+') location_code
		FROM CMM01106 N (NOLOCK)   
		JOIN CMD01106 M (NOLOCK) ON M.CM_ID = N.CM_ID
		JOIN CUSTDYM C (NOLOCK) ON N.CUSTOMER_CODE=C.CUSTOMER_CODE
		JOIN SKU (NOLOCK) ON SKU.product_code=M.product_code   
		WHERE N.CANCELLED = 0 AND ISNULL(M.REF_SLS_MEMO_ID,'''')='''' 
		AND M.QUANTITY > 0 '+@CPRODUCT_CODEFILTER +'
	
		 AND (C.USER_CUSTOMER_CODE='''+@cCustCode +''' OR ''''='''+@cCustCode+''')
		GROUP BY N.CM_ID,LEFT(N.CM_ID,'+@LocLength+')  ,sku.barcode_coding_scheme   
	)X 
	WHERE X.SRNO>'+CAST(@bCardDiscount AS NVARCHAR(100))
	 PRINT @cCMD
	 INSERT INTO @dtable_20(CM_ID ,ITEMCOUNT ,SRNO,barcode_coding_scheme,location_code )
	 EXEC SP_EXECUTESQL @cCMD
	IF @@ROWCOUNT=1
		UPDATE @dtable SET CHECKED=1 
	ELSE
		UPDATE @dtable SET CHECKED=1 WHERE DBNAME=@dbNAME

	END
	if EXISTS(SELECT barcode_coding_scheme FROM @dtable_21 WHERE barcode_coding_scheme=3)
	BEGIN
		if @BALLOWNEGSTOCK = 1
		BEGIN
			IF (SELECT SUM(QUANTITY_IN_STOCK) FROM PMT01106 (NOLOCK) WHERE PRODUCT_CODE=@CWHERE)>0
			BEGIN
				IF (SELECT COUNT(*) FROM @dtable_20)=0
				BEGIN
					INSERT INTO @dtable_20(ErrMsg)
					SELECT 'Item is in Stock!' as ErrMsg
				END
				BEGIN
					UPDATE @dtable_20 SET ErrMsg='Item is in Stock!' 
				END
			END
		END
		SELECT TOP 1 * FROM @dtable_20 ORDER BY CASE WHEN @CDEPTID=location_code THEN 0 ELSE 1 END
	END
	ELSE
	BEGIN
		SELECT * FROM @dtable_20  ORDER BY CASE WHEN @CDEPTID=location_code THEN 0 ELSE 1 END
	END
 --    IF @CTODT=''
	--	 SET @CTODT=CONVERT(VARCHAR(10),GETDATE (),121)
     
	--DECLARE @CCMD NVARCHAR(MAX),@CFLATDISC VARCHAR(10)  
	--SET @CCMD=''  

	--SELECT TOP 10 *
	--FROM 
	--(
	--	SELECT N.CM_ID ,COUNT(*) AS ITEMCOUNT,ROW_NUMBER() OVER (ORDER BY N.CM_ID) AS SRNO
	--	FROM CMM01106 N (NOLOCK)   
	--	JOIN CMD01106 M (NOLOCK) ON M.CM_ID = N.CM_ID
	--	JOIN CUSTDYM C (NOLOCK) ON N.CUSTOMER_CODE=C.CUSTOMER_CODE
	--	JOIN SKU (NOLOCK) ON SKU.product_code=M.product_code   
	--	WHERE N.CANCELLED = 0 AND ISNULL(M.REF_SLS_MEMO_ID,'')='' 
	--	AND M.QUANTITY > 0 
	--	AND (m.PRODUCT_CODE=@CWHERE or m.PRODUCT_CODE like @CWHERE+'@%') 
	--	AND (C.USER_CUSTOMER_CODE=@cCustCode OR ''=@cCustCode)
	--	--AND N.CM_DT>=@CFROMDT --(@CFROMDT-(SELECT ISNULL(LIMIT_DAY_FOR_GR,0) FROM users(NOLOCK) WHERE USER_CODE=@CWIZAPPUSERCODE))
	--	GROUP BY N.CM_ID     
	--)X 
	--WHERE X.SRNO>@bCardDiscount
end




