CREATE PROCEDURE USP_GET_TRANSPORTER_WISE_VALUE
(
@NMODE INT,
@CANGADIA_CODE CHAR(7),
@CMEMOID VARCHAR(22)=''
)
AS
BEGIN
 
       DECLARE @CCMD NVARCHAR(MAX),@CERRMSG NVARCHAR(MAX)
       
       IF ISNULL(@CANGADIA_CODE,'')=''
       BEGIN
        
            SET @CERRMSG='TRANSPORTER_CODE SHOULD NOT BE EMPTY'
            GOTO END_PROC
         
       END
       
       IF ISNULL(@NMODE,'')=2 AND ISNULL(@CMEMOID,'')=''
       BEGIN
        
            SET @CERRMSG='MEMO_ID SHOULD NOT BE EMPTY'
            GOTO END_PROC
         
       END
       
       
       DECLARE @CUT_OFF_DATE DATE
       SET @CUT_OFF_DATE=ISNULL((SELECT VALUE FROM CONFIG WHERE CONFIG_OPTION='GATE_PASS_CUT_OFF_DATE'),'1900-01-01')
       
       
       IF ISNULL(@NMODE,0)=1
       GOTO LBLMODE1
       IF ISNULL(@NMODE,0)=2
       GOTO LBLMODE2
       

       
       
LBLMODE1:       
       
       SET @CCMD=N'SELECT CHK, INV_NO,AC_NAME,INV_ID,INV_DT,
				QUANTITY,[WEIGHT],CANCELLED,FIN_YEAR,USER_CODE,LAST_UPDATE,EDT_USER_CODE,
				REMARKS_MST,REMARKS_DET,HANDOVER_USER_CODE,HANDOVER_LAST_UPDATE,
				ISNULL(ANGADIA_ADD1,'''')+'' ''+ISNULL(ANGADIA_ADD2,'''')+'' ''+ISNULL(AREA_NAME,'''')+'' ''+ISNULL(CITY,'''') AS [ADDRESS]
				,DELIVERED_BY,WAY_BILL,WAY_BILL_STR
				FROM (SELECT DISTINCT CAST(0 AS BIT) AS CHK, INV_NO,L.AC_NAME,D.INV_ID,INV_DT,
                CAST(SUM(E.QUANTITY) AS NUMERIC(10,2))AS QUANTITY,
				B.QTY AS WEIGHT, 0 AS TOTAL_BOXES,0 AS CANCELLED,
				'''' AS FIN_YEAR,'''' AS USER_CODE,''''  AS LAST_UPDATE,''0000000'' AS EDT_USER_CODE,
				''''  AS REMARKS_MST,''''  AS REMARKS_DET,''0000000'' AS HANDOVER_USER_CODE,'''' AS HANDOVER_LAST_UPDATE
				,AGM.ANGADIA_ADD1,AGM.ANGADIA_ADD2,AR.AREA_NAME,CT.CITY
				,'''' AS [DELIVERED_BY],D.WAY_BILL,(CASE WHEN ISNULL(D.WAY_BILL,0)=1 THEN ''YES'' ELSE ''NO'' END) AS WAY_BILL_STR
				FROM PARCEL_MST A(NOLOCK) JOIN 
				PARCEL_DET B(NOLOCK) ON A.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID
				JOIN INM01106 D(NOLOCK) ON C.REF_MEMO_ID=D.INV_ID
				JOIN IND01106 E(NOLOCK) ON E.INV_ID=D.INV_ID
				JOIN LM01106 L(NOLOCK) ON L.AC_CODE=D.AC_CODE
				LEFT JOIN TBL_GP_ISSUE_LOG LOG (NOLOCK) ON LOG.INV_ID=D.INV_ID 
				JOIN DBO.ANGM AGM WITH(NOLOCK) ON A.ANGADIA_CODE=AGM.ANGADIA_CODE
				JOIN DBO.AREA AR WITH(NOLOCK) ON AGM.AREA_CODE=AR.AREA_CODE
				JOIN DBO.CITY CT WITH(NOLOCK) ON AR.CITY_CODE=CT.CITY_CODE
				WHERE A.ANGADIA_CODE='''+ @CANGADIA_CODE  +''' AND A.XN_TYPE=''WSL''
				AND D.CANCELLED=0 AND LOG.INV_ID IS NULL
				AND CAST(D.INV_DT AS DATE)>='''+CONVERT(VARCHAR,@CUT_OFF_DATE,101)+'''
				GROUP BY INV_NO,D.INV_ID,C.TOTAL_BOXES,B.QTY,INV_DT,L.AC_NAME
				,AGM.ANGADIA_ADD1,AGM.ANGADIA_ADD2,AR.AREA_NAME,
				CT.CITY,D.WAY_BILL,(CASE WHEN ISNULL(D.WAY_BILL,0)=1 THEN ''YES'' ELSE ''NO'' END) 
				)T ORDER BY INV_NO ASC'
    PRINT @CCMD
    EXEC SP_EXECUTESQL @CCMD
    GOTO END_PROC				

LBLMODE2:       
       SET @CCMD=N'SELECT CHK,INV_NO,AC_NAME,INV_ID,INV_DT,QUANTITY,[WEIGHT],TOTAL_BOXES,REMARKS_DET,REMARKS_MST
						,CANCELLED,FIN_YEAR
						,USER_CODE,LAST_UPDATE,EDT_USER_CODE
						,ISNULL(ANGADIA_ADD1,'''')+'' ''+ISNULL(ANGADIA_ADD2,'''')+'' ''+ISNULL(AREA_NAME,'''')+'' ''+ISNULL(CITY,'''') AS [ADDRESS]
						,DELIVERED_BY,WAY_BILL,WAY_BILL_STR
						 FROM (SELECT DISTINCT CAST(0 AS BIT) AS CHK, INV_NO,L.AC_NAME,D.INV_ID,INV_DT,
						CAST(SUM(E.QUANTITY) AS NUMERIC(10,2))AS QUANTITY,
						ISNULL(B.QTY,0) AS WEIGHT, 0 AS TOTAL_BOXES ,
						''''  AS REMARKS_DET,''''  AS REMARKS_MST,0 AS CANCELLED,
						'''' AS FIN_YEAR,'''' AS USER_CODE,''''  AS LAST_UPDATE,'''' AS EDT_USER_CODE
						,'''' AS ANGADIA_ADD1,'''' AS  ANGADIA_ADD2,'''' AS AREA_NAME,'''' AS CITY
						,'''' AS DELIVERED_BY,D.WAY_BILL,(CASE WHEN ISNULL(D.WAY_BILL,0)=1 THEN ''YES'' ELSE ''NO'' END) AS WAY_BILL_STR
						FROM PARCEL_MST A(NOLOCK) JOIN 
						PARCEL_DET B(NOLOCK) ON A.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID
						JOIN INM01106 D(NOLOCK) ON C.REF_MEMO_ID=D.INV_ID
						JOIN IND01106 E(NOLOCK) ON E.INV_ID=D.INV_ID
						JOIN LM01106 L(NOLOCK) ON L.AC_CODE=D.AC_CODE
						LEFT JOIN TBL_GP_ISSUE_LOG LOG (NOLOCK) ON LOG.INV_ID=D.INV_ID 
						WHERE ANGADIA_CODE='''+ @CANGADIA_CODE  +''' AND A.XN_TYPE=''WSL''
						AND D.CANCELLED=0 AND LOG.INV_ID IS NULL
						AND CAST(D.INV_DT AS DATE)>='''+CONVERT(VARCHAR,@CUT_OFF_DATE,101)+'''
						GROUP BY INV_NO,D.INV_ID,C.TOTAL_BOXES,B.QTY,INV_DT,L.AC_NAME,
						D.WAY_BILL,(CASE WHEN ISNULL(D.WAY_BILL,0)=1 THEN ''YES'' ELSE ''NO'' END) 
						
				
              UNION ALL


                SELECT DISTINCT CAST(1 AS BIT) AS CHK, INV_NO,L.AC_NAME,D.INV_ID,INV_DT,
					CAST(SUM(E.QUANTITY) AS NUMERIC(10,2))AS QUANTITY,
					ISNULL(B.QTY,0) AS WEIGHT,0 AS TOTAL_BOXES ,
					M.REMARKS AS REMARKS_DET,N.REMARKS AS REMARKS_MST,
					0 AS CANCELLED,
					N.FIN_YEAR,N.USER_CODE,N.LAST_UPDATE,N.EDT_USER_CODE
					,AGM.ANGADIA_ADD1,AGM.ANGADIA_ADD2,AR.AREA_NAME,CT.CITY
					,N.DELIVERED_BY,D.WAY_BILL,(CASE WHEN ISNULL(D.WAY_BILL,0)=1 THEN ''YES'' ELSE ''NO'' END) AS WAY_BILL_STR
					FROM PARCEL_MST A(NOLOCK) JOIN 
					PARCEL_DET B(NOLOCK) ON A.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID
					JOIN INM01106 D(NOLOCK) ON C.REF_MEMO_ID=D.INV_ID
					JOIN IND01106 E(NOLOCK) ON E.INV_ID=D.INV_ID
					JOIN LM01106 L(NOLOCK) ON L.AC_CODE=D.AC_CODE
					JOIN TBL_GP_ISSUE_DET M (NOLOCK) ON M.INV_ID=D.INV_ID
					JOIN TBL_GP_ISSUE_MST N (NOLOCK) ON M.MEMO_ID=N.MEMO_ID
					JOIN DBO.ANGM AGM WITH(NOLOCK) ON N.TRANSPORTER_CODE=AGM.ANGADIA_CODE
					JOIN DBO.AREA AR WITH(NOLOCK) ON AGM.AREA_CODE=AR.AREA_CODE
					JOIN DBO.CITY CT WITH(NOLOCK) ON AR.CITY_CODE=CT.CITY_CODE
					WHERE A.XN_TYPE=''WSL'' AND  
					M.MEMO_ID='''+@CMEMOID+'''
					AND D.CANCELLED=0 
					AND CAST(D.INV_DT AS DATE)>='''+CONVERT(VARCHAR,@CUT_OFF_DATE,101)+'''
					GROUP BY INV_NO,D.INV_ID,C.TOTAL_BOXES,B.QTY,INV_DT,L.AC_NAME,M.REMARKS,N.REMARKS,
					N.FIN_YEAR,N.USER_CODE,N.LAST_UPDATE,N.EDT_USER_CODE,AGM.ANGADIA_ADD1
					,AGM.ANGADIA_ADD2,AR.AREA_NAME,CT.CITY,N.DELIVERED_BY,
					D.WAY_BILL,(CASE WHEN ISNULL(D.WAY_BILL,0)=1 THEN ''YES'' ELSE ''NO'' END) 
					) T ORDER BY INV_NO ASC
					'
    PRINT @CCMD
    EXEC SP_EXECUTESQL @CCMD
    GOTO END_PROC	
    
END_PROC: 
         SELECT ISNULL(@CERRMSG,'') AS ERRMSG
     
END

-- USP_GET_TRANSPORTER_WISE_VALUE 1,'HO00015','HO0111700000GP00000027'
--USP_GET_TRANSPORTER_WISE_VALUE 2,'HO00015','HO0111700000GP00000027'
