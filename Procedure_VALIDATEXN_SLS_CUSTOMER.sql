CREATE PROCEDURE  VALIDATEXN_SLS_CUSTOMER
 @CMEMOID VARCHAR(50)='' ,
 @CERRORMSG varchar(1000)  output
 AS
 BEGIN
      
	  DECLARE @CSTEP VARCHAR(20)
	  BEGIN TRY

	  
	  SET @CSTEP='10'

	 IF EXISTS(SELECT TOP 1 CM_ID FROM CMM01106 (NOLOCK) WHERE CM_ID=@CMEMOID AND CANCELLED=0 AND ISNULL(EINV_IRN_NO,'')<>'') 		  
		BEGIN
			SET @CERRORMSG='EINVOICE HAS BEEN GENERATED OF THIS MEMO YOU CAN NOT CHANGE CUSTOMER'
			RETURN
		END

	  SET @CSTEP='20'

	  IF EXISTS ( SELECT TOP 1 'U' FROM PAYMODE_XN_DET A (NOLOCK) WHERE  A.XN_TYPE='SLS' AND MEMO_ID =@CMEMOID AND ISNULL(ADJ_MEMO_ID,'')<>'')
	  BEGIN
		   SET @CERRORMSG='YOU CAN NOT CHANGE CUSTOMER OF CREDIT ADJUSTMENT BILL '
		   RETURN
	  END


	   SET @CSTEP='30'

	  IF EXISTS(SELECT A.CM_ID FROM CMM_CREDIT_RECEIPT A  (NOLOCK)
				JOIN ARC01106 B (NOLOCK) ON B.ADV_REC_ID=A.ADV_REC_ID
				WHERE B.CANCELLED=0 AND A.CM_ID=@CMEMOID)
		BEGIN
			SET @CERRORMSG='PAYMENT HAS BEEN TAKEN AGAINST THIS BILL IN CUSTOMER RECEIPT/PAYMENT YOU CAN NOT CHANGE CUSTOMER'
			RETURN	
		END

	
	 SET @CSTEP='40'

	  IF NOT  EXISTS (SELECT TOP 1 'U' FROM PAYMODE_XN_DET (NOLOCK) WHERE XN_TYPE ='SLS' AND MEMO_ID=@CMEMOID AND PAYMODE_CODE IN('0000004','0000001','0000002','CMR0001') ) 
	   GOTO END_PROC

	   SET @CSTEP='50'
	  
	  IF EXISTS(SELECT TOP 1 A.MEMO_ID FROM PAYMODE_XN_DET A (NOLOCK) JOIN CMM01106  B (NOLOCK) ON A.MEMO_ID=B.CM_ID 
			  WHERE A.ADJ_MEMO_ID=@CMEMOID AND B.CANCELLED=0 AND A.XN_TYPE='SLS')				  
		BEGIN
			SET @CERRORMSG='THIS CREDIT NOTE HAS BEEN SETTLED IN CUSTOMER BILL YOU CAN NOT CHANGE CUSTOMER'
			RETURN
		END


	 SET @CSTEP='60'
	 IF EXISTS(SELECT TOP 1 A.MEMO_ID FROM PAYMODE_XN_DET A (NOLOCK) JOIN ARC01106 B (NOLOCK) ON A.MEMO_ID=B.ADV_REC_ID
			  WHERE A.ADJ_MEMO_ID=@CMEMOID AND B.CANCELLED=0 AND A.XN_TYPE='ARC' AND A.PAYMODE_CODE='0000001')				  
		BEGIN
			SET @CERRORMSG='THIS CREDIT NOTE HAS BEEN SETTLED IN CUSTOMER PAYMENT YOU CAN NOT CHANGE CUSTOMER'
			RETURN
		END


	
	
	
	  
	END TRY
	
	BEGIN CATCH
		SET @CERRORMSG='ERROR IN PROCEDURE VALIDATEXN_SLS_CUSTOMER STEP#'+@CSTEP+' '+ERROR_MESSAGE()
		GOTO END_PROC 
	END CATCH

END_PROC:
	SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
 END

