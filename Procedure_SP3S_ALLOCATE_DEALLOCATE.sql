CREATE PROC [DBO].[SP3S_ALLOCATE_DEALLOCATE] --(LocId 3 digit change by Sanjay:04-11-2024)         
(          
  @IMODE INT ,          
  @CWHERE VARCHAR(MAX)='',      
  @CAGENCYCODE CHAR(7)='',      
  @FINYEAR VARCHAR(10)=''  ,    
  @DEPTID VARCHAR(10)='',         
  @iMemo_type INT=1         
)      
----WITH ENCRYPTION
AS          
          
BEGIN          
     
	 
	 
declare @SHOW_PRODUCT_CODE_IN_PRD varchar(10)
select @SHOW_PRODUCT_CODE_IN_PRD=value  from config where config_option='SHOW_PRODUCT_CODE_IN_PRD'
     
		IF @IMODE =1         GOTO LBLLOOKUP          
		ELSE IF @IMODE =2    GOTO LBLMST          
		ELSE IF @IMODE =3	 GOTO LBLDET   
    	ELSE				 GOTO LAST        
       
 DECLARE @CCMD NVARCHAR(MAX) 
 
    

LBLLOOKUP:        
    
  SELECT MEMO_ID 
  FROM BOMDQRQMST (NOLOCK)    
  WHERE FIN_YEAR=@FINYEAR AND location_code=@CWHERE   
  AND MEMO_TYPE=@iMemo_type
    
 GOTO LAST           
          
LBLMST:     


	--IF OBJECT_ID ('TEMPDB..#TMPBUYER','U') IS NOT NULL
	--	DROP TABLE #TMPBUYER

 --   SELECT G.MEMO_ID , BM.AC_CODE ,BM.ORDER_NO ,BM.ORDER_DT 
	--INTO #TMPBUYER
	--FROM  PPC_FG_BARCODE_NA_DET G (NOLOCK)      
	--JOIN ORD_PLAN_BARCODE_DET BARCODE_DET (NOLOCK) ON BARCODE_DET.PRODUCT_CODE =G.PRODUCT_CODE 
 --   JOIN ORD_PLAN_DET DET  (NOLOCK) ON DET.ROW_ID  =BARCODE_DET.REFROW_ID 
	--JOIN BUYER_ORDER_DET BD (NOLOCK) ON BD.ROW_ID= DET.WOD_ROW_ID 
	--JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID =BD.ORDER_ID
	--WHERE G.MEMO_ID = @CWHERE  
	--GROUP BY G.MEMO_ID ,BM.AC_CODE ,BM.ORDER_NO ,BM.ORDER_DT 


	--SELECT LM.AC_NAME BUYER_NAME ,BO.ORDER_NO,CONVERT(VARCHAR(10),BO.ORDER_DT,105) As ORDER_DT,BO.ORDER_DT AS ORD_DT,
	--AM.AGENCY_NAME , A.*,U.USERNAME AS [USER_NAME] 
	--FROM PPC_FG_BARCODE_NA_MST A (NOLOCK)    
	--JOIN PRD_AGENCY_MST AM (NOLOCK) ON AM.AGENCY_CODE =A.AGENCY_CODE 
	--JOIN #TMPBUYER BO ON A.MEMO_ID =BO.MEMO_ID 
	--JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =BO.AC_CODE 
	--LEFT OUTER JOIN USERS U (NOLOCK) ON U.USER_CODE = A.USER_CODE     
	--WHERE A.MEMO_ID = @CWHERE         
	
	  SELECT * 
  FROM BOMDQRQMST (NOLOCK)    
  WHERE MEMO_ID=@CWHERE       AND MEMO_TYPE=@iMemo_type

       
 GOTO LAST           
           
LBLDET: 

    SELECT  CAST(0 AS BIT) AS CHKBILL,sm.section_name,sd.sub_section_name ,e.uom_name ,
	        A.MEMO_NO,G.MEMO_ID,SKU.ARTICLE_CODE,SKU.PARA1_CODE,
			ART.ARTICLE_NO,ART.ARTICLE_NAME ,P1.PARA1_NAME ,
			g.PRODUCT_CODE,
			'' AS BIN_ID, 0 AS SR_NO,
			CAST(SKU.ARTICLE_CODE +SKU.PARA1_CODE +P2.PARA2_SET AS VARCHAR(100)) AS ROW_ID, 
			GETDATE() LAST_UPDATE,
			G.QUANTITY AS QUANTITY,P2.PARA2_SET,P2.PARA2_SET as para2_name,'0000000' as para2_code
			--,ISNULL(G.Print_label,0) AS Print_label
			,BM.order_no,BM.order_dt,LM.AC_NAME
	FROM BOMDQRQMST A (NOLOCK)             
	JOIN BOMDQRQDET G (NOLOCK)  ON A.MEMO_ID = G.MEMO_ID      
	JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID=G.REF_ORDER_ID
	JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=BM.ac_code
	JOIN SKU ON SKU.PRODUCT_CODE=G.PRODUCT_CODE
    JOIN ARTICLE ART ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE          
	JOIN SECTIOND SD ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
	JOIN SECTIONM SM ON SD.SECTION_CODE = SM.SECTION_CODE        
	JOIN PARA1 P1 ON SKU.PARA1_CODE = P1.PARA1_CODE          
	JOIN PARA2 P2 ON SKU.PARA2_CODE = P2.PARA2_CODE      
	--JOIN PARA3 P3 ON SKU.PARA3_CODE = P3.PARA3_CODE  
	JOIN UOM E ON ART.UOM_CODE = E.UOM_CODE 
	WHERE A.MEMO_ID = @CWHERE        AND A.MEMO_TYPE=@iMemo_type
	--GROUP BY a.memo_id,sm.section_name,sd.sub_section_name ,e.uom_name ,A.MEMO_NO,G.MEMO_ID,SKU.ARTICLE_CODE,SKU.PARA1_CODE,
	--ART.ARTICLE_NO,ART.ARTICLE_NAME ,P1.PARA1_NAME,P2.PARA2_SET,BM.order_no,BM.order_dt,LM.AC_NAME--,ISNULL(G.Print_label,0)


goto LAST
		
	


	GOTO LAST  
LAST:          
              
END
