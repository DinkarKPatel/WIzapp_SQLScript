CREATE PROCEDURE SP_RPT_PURE_CASE_QTY
(
  @DTFROM DATETIME,
  @DTTO DATETIME
)
AS
BEGIN
DECLARE @CCMD NVARCHAR(MAX)
 IF OBJECT_ID('TEMPDB..#TABLECM_ID','U') IS NOT NULL
	DROP TABLE #TABLECM_ID
 
  CREATE TABLE #TABLECM_ID(MRP NUMERIC(10,3),CAL_TOTAL_SALE_QTY NUMERIC(18,3))
  
	SET @CCMD=N'SELECT  MRP,SUM(QUANTITY) AS CAL_TOTAL_SALE_QTY
	FROM CMM01106 A1 (NOLOCK)     
	JOIN CMD01106 B (NOLOCK) ON B.CM_ID=A1.CM_ID  
	JOIN   
	(    
	 SELECT A.MEMO_ID,B.PAYMODE_GRP_CODE,SUM(A.AMOUNT) AS [AMOUNT]     
	 FROM PAYMODE_XN_DET A (NOLOCK)     
	 JOIN PAYMODE_MST B (NOLOCK) ON  B.PAYMODE_CODE=A.PAYMODE_CODE     
	 JOIN PAYMODE_GRP_MST C (NOLOCK) ON C.PAYMODE_GRP_CODE=B.PAYMODE_GRP_CODE     
	 WHERE C.PAYMODE_GRP_CODE=''0000001'' AND A.XN_TYPE=''SLS''     
	 GROUP BY A.MEMO_ID,B.PAYMODE_GRP_CODE    
	)X ON X.MEMO_ID=A1.CM_ID  
	WHERE (B.OLD_MRP=B.MRP OR ISNULL(A1.PATCHUP_RUN,0)=0) AND A1.NET_AMOUNT=X.AMOUNT     
	AND (A1.MEMO_TYPE = ''0'' OR A1.MEMO_TYPE = ''1'')    
	AND (A1.CM_DT BETWEEN '''+CONVERT(VARCHAR(11),@DTFROM,120)+''' AND '''+CONVERT(VARCHAR(11),@DTTO,120)+''')    
	AND A1.CANCELLED=0 
	AND ISNULL(A1.SUBTOTAL_R,0)=0 
	GROUP BY MRP '
    PRINT @CCMD
	INSERT INTO #TABLECM_ID  (MRP,CAL_TOTAL_SALE_QTY)  
	EXEC SP_EXECUTESQL @CCMD
	
	SELECT * FROM #TABLECM_ID
	ORDER BY CAL_TOTAL_SALE_QTY DESC
	
END
