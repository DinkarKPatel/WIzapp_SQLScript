create PROCEDURE SP_CASHXN  
(  
	 @CDEPTID VARCHAR(4),  
	 @DFROMDTPARA DATETIME,  
	 @DTODTPARA DATETIME,  
	 @BESTIMATEENABLED BIT = 1,  
	 @BSKIPSLSENTRIES BIT=0,  
	 @BCALLEDFROMPTCASH BIT=0,
	 @CUSERCODE  VARCHAR(15)='',
	 @CBINID	VARCHAR(10)=''
)  
AS  
BEGIN  
  --(dinkar) Replace  left(memoid,2) to Location_code 
 DECLARE @DEFFECTIVEDATE DATETIME,  
   @NLOCOPENING NUMERIC(14,2),  
   @CCURRENTLOC VARCHAR(2),  
   @CHOLOC VARCHAR(2),  
   @CCONSIDERALLCASHXN VARCHAR(1),  
   @DFROMDT DATETIME,@DTODT DATETIME,
   @cHEAD_CODE VARCHAR(MAX)  
     
 SELECT TOP 1 @CCURRENTLOC =DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID   
 SELECT TOP 1 @CHOLOC = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'  
  
 IF @CDEPTID=''
	SET @CDEPTID=@CCURRENTLOC
 
 DECLARE @CMAJORDEPTID VARCHAR(5)  
 SELECT @CMAJORDEPTID=MAJOR_DEPT_ID FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CDEPTID  
  
 SET @CMAJORDEPTID=ISNULL(@CMAJORDEPTID,'')  
  
 SELECT TOP 1 @CCONSIDERALLCASHXN=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='CONSIDER_ALL_CASH_RECEIPTS'
   
 SELECT @DFROMDT=@DFROMDTPARA,@DTODT=@DTODTPARA  

 --IF @DFROMDTPARA = ''
 --SET @DFROMDT=@DTODTPARA  
   
 SET @CCONSIDERALLCASHXN=ISNULL(@CCONSIDERALLCASHXN,'')  
   
 IF @BCALLEDFROMPTCASH=0  
  SET @CCONSIDERALLCASHXN='1'  
    
 ----IF @CCURRENTLOC = @CHOLOC    -- IF HEAD OFFICE  
 SELECT @DEFFECTIVEDATE = DATEADD(DAY ,-1, OPENING_CASH_DATE  )
 FROM LOC_REQ  
 WHERE DEPT_ID = @CDEPTID   
   
 IF @DEFFECTIVEDATE IS NULL  
  SET @DEFFECTIVEDATE = CAST('' AS DATETIME)  
  
 --DECLARE @CRESULT TABLE ( XN_DT DATETIME, XN_NO VARCHAR(40), XN_ID VARCHAR(40),  
 --       XN_TYPE VARCHAR(10), DEBIT_AMOUNT NUMERIC(14,2), CREDIT_AMOUNT NUMERIC(14,2),  
 --       AC_NAME VARCHAR(1000), NARRATION VARCHAR(MAX),  
 --       OP_BAL NUMERIC(14,2), CL_BAL NUMERIC(14,2) )  
 
 CREATE TABLE #CRESULT ( XN_DT DATETIME, XN_NO VARCHAR(40), XN_ID VARCHAR(40),  
        XN_TYPE VARCHAR(10), DEBIT_AMOUNT NUMERIC(14,2), CREDIT_AMOUNT NUMERIC(14,2),  
        AC_NAME VARCHAR(1000), NARRATION VARCHAR(MAX),  
        OP_BAL NUMERIC(14,2), CL_BAL NUMERIC(14,2) )  
 
 IF @DTODT < @DEFFECTIVEDATE  
	GOTO LAST_REC  
   
 IF @DFROMDT < @DEFFECTIVEDATE  
  SET @DFROMDT=@DEFFECTIVEDATE  

 ----IF @CCURRENTLOC = @CHOLOC    -- IF HEAD OFFICE  
 INSERT #CRESULT ( XN_DT, XN_NO, XN_ID, XN_TYPE, DEBIT_AMOUNT, CREDIT_AMOUNT, AC_NAME, NARRATION )  
 SELECT @DEFFECTIVEDATE AS XN_DT,  
   SPACE(40) AS XN_NO, SPACE(40) AS XN_ID, 'OPS' AS XN_TYPE,  
   (CASE WHEN OPENING_CASH_BALANCE>0 THEN OPENING_CASH_BALANCE ELSE 0 END ) AS DEBIT_AMOUNT,  
   (CASE WHEN OPENING_CASH_BALANCE<0 THEN ABS(OPENING_CASH_BALANCE) ELSE 0 END ) AS CREDIT_AMOUNT,  
   SPACE(254) AS AC_NAME,  
   SPACE(254) AS NARRATION  
 FROM LOC_REQ (NOLOCK)
 WHERE DEPT_ID = (CASE WHEN @CDEPTID  ='' THEN DEPT_ID ELSE @CDEPTID END)
 AND @DEFFECTIVEDATE BETWEEN @DFROMDT AND @DTODT  
   
 
 
 SET  @cHEAD_CODE = DBO.FN_ACT_TRAVTREE('0000000014') ----ADD VARIABLE BY GAURI ON 17/4/2019
 
 INSERT #CRESULT ( XN_DT, XN_NO, XN_ID, XN_TYPE, DEBIT_AMOUNT, CREDIT_AMOUNT, AC_NAME, NARRATION )  
 SELECT CM_DT AS XN_DT, SPACE(40) AS XN_NO, SPACE(40) AS XN_ID,  
   ( CASE WHEN SUM(D.CASH_AMOUNT)<0 THEN 'SLR' ELSE 'SLS' END ) AS XN_TYPE,  
   ( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN SUM(D.CASH_AMOUNT) ELSE 0 END) AS DEBIT_AMOUNT,  
   ( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN 0 ELSE ABS(SUM(D.CASH_AMOUNT)) END) AS CREDIT_AMOUNT,  
   'CASH SALE' AS AC_NAME,  
   SPACE(254) AS NARRATION  
 FROM CMM01106 A   (NOLOCK)
 JOIN CUSTDYM C  (NOLOCK) ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
 LEFT OUTER JOIN VW_BILL_PAYMODE D  (NOLOCK) ON A.CM_ID = D.MEMO_ID AND D.XN_TYPE = 'SLS'  
 WHERE --A.CM_MODE = 1 AND   --CHANGE  
 A.CANCELLED = 0  
 AND   A.CM_DT >@DEFFECTIVEDATE AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
 AND   A.CM_DT BETWEEN @DFROMDT AND @DTODT  
 --AND   A.CM_DT BETWEEN '2011-11-26' AND '2011-11-26'  
 AND   ((A.location_Code = @CMAJORDEPTID OR @CMAJORDEPTID='') AND (ISNULL(A.BIN_ID,'') = @CBINID OR @CBINID=''))  
 AND   ISNULL(D.CASH_AMOUNT,0) <> 0  
 AND (@BSKIPSLSENTRIES=0 OR @DFROMDT='') AND @CCONSIDERALLCASHXN='1' 
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END) 
 GROUP BY A.CM_DT  
  
 UNION ALL   
 SELECT ADV_REC_DT AS XN_DT, ADV_REC_NO AS XN_NO, ADV_REC_ID AS XN_ID,  
   ( CASE WHEN ARC_TYPE=1 THEN 'REC' ELSE 'PAY' END ) AS XN_TYPE,  
   ( CASE WHEN ARC_TYPE=1 THEN D.CASH_AMOUNT ELSE 0 END) AS DEBIT_AMOUNT,  
   ( CASE WHEN ARC_TYPE=1 THEN 0 ELSE D.CASH_AMOUNT END) AS CREDIT_AMOUNT,  
   C.CUSTOMER_TITLE + ' ' + C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS AC_NAME,  
   A.REMARKS AS NARRATION  
 FROM ARC01106 A   (NOLOCK)
 JOIN CUSTDYM C  (NOLOCK) ON A.CUSTOMER_CODE = C.CUSTOMER_CODE  
 LEFT OUTER JOIN VW_BILL_PAYMODE D  (NOLOCK) ON A.ADV_REC_ID = D.MEMO_ID AND D.XN_TYPE = 'ARC'  
 WHERE A.CANCELLED = 0  
 AND   D.CASH_AMOUNT <> 0  
 AND   ((A.location_Code  = @CMAJORDEPTID OR @CMAJORDEPTID='') AND (ISNULL(A.BIN_ID,'') = @CBINID OR @CBINID=''))  
 AND   A.ADV_REC_DT > @DEFFECTIVEDATE -- ISNULL((SELECT [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'OPENING_CASH_DATE'),'')  
 AND   A.ADV_REC_DT BETWEEN @DFROMDT AND @DTODT AND @CCONSIDERALLCASHXN='1'  
  AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)
 UNION ALL  
 SELECT B.PEM_MEMO_DT AS XN_DT, B.PEM_MEMO_NO AS XN_NO, B.PEM_MEMO_ID AS XN_ID,  
   ( CASE WHEN A.XN_TYPE='CR' THEN 'PCR' ELSE 'PCP' END ) AS XN_TYPE,  
   ( CASE WHEN A.XN_TYPE='CR' THEN A.XN_AMOUNT ELSE 0 END) AS DEBIT_AMOUNT,  
   ( CASE WHEN A.XN_TYPE='DR' THEN A.XN_AMOUNT ELSE 0 END) AS CREDIT_AMOUNT,  
   C.AC_NAME,  
   A.NARRATION  
 FROM PED01106 A   (NOLOCK)
 JOIN PEM01106 B  (NOLOCK) ON A.PEM_MEMO_ID = B.PEM_MEMO_ID  
 JOIN LM01106 C  (NOLOCK) ON A.AC_CODE = C.AC_CODE  
 WHERE B.CANCELLED = 0  
 AND (B.location_Code  = @CMAJORDEPTID OR @CMAJORDEPTID='')  
 AND B.PEM_MEMO_DT > @DEFFECTIVEDATE -- ISNULL((SELECT [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'OPENING_CASH_DATE'),'')  
 AND B.PEM_MEMO_DT BETWEEN @DFROMDT AND @DTODT  
 AND B.USER_CODE=(CASE WHEN @CUSERCODE='' THEN B.USER_CODE ELSE @CUSERCODE END)
 UNION ALL  
 SELECT INV_DT AS XN_DT, SPACE(40) AS XN_NO, SPACE(40) AS XN_ID,  
   'WSL' AS XN_TYPE,  
   SUM(B.AMOUNT) AS DEBIT_AMOUNT,  
   0 AS CREDIT_AMOUNT,  
   'WHOLESALE ON CASH' AS AC_NAME,  
   SPACE(254) AS NARRATION  
 FROM INM01106 A   (NOLOCK)
 JOIN PAYMODE_XN_DET B  (NOLOCK) ON A.INV_ID=B.MEMO_ID  AND B.XN_TYPE='WSL'
 JOIN PAYMODE_MST C  (NOLOCK) ON C.PAYMODE_CODE=B.PAYMODE_CODE  
 WHERE (A.location_Code  = @CMAJORDEPTID OR @CMAJORDEPTID='') AND CANCELLED = 0  
 AND C.PAYMODE_GRP_CODE='0000001'  
 AND (@BSKIPSLSENTRIES=0 OR @DFROMDT='') AND @CCONSIDERALLCASHXN='1'   
 AND INV_DT > @DEFFECTIVEDATE -- ISNULL((SELECT [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'OPENING_CASH_DATE'),'')  
 AND INV_DT BETWEEN @DFROMDT AND @DTODT  
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)
 GROUP BY INV_DT  
	
 UNION ALL   
 SELECT CN_DT AS XN_DT, SPACE(40) AS XN_NO, SPACE(40) AS XN_ID,  
   'WSR' AS XN_TYPE,  
   0 AS DEBIT_AMOUNT,  
   SUM(TOTAL_AMOUNT) AS CREDIT_AMOUNT,  
   'WHOLESALE RETURN ON CASH' AS AC_NAME,  
   SPACE(254) AS NARRATION  
 FROM CNM01106 A  (NOLOCK) 
 JOIN LM01106 B  (NOLOCK) ON A.AC_CODE = B.AC_CODE  
 WHERE (A.location_Code  = @CMAJORDEPTID OR @CMAJORDEPTID='') AND CHARINDEX(B.HEAD_CODE,@cHEAD_CODE)> 0 ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019 
 AND CANCELLED = 0  
 AND CN_DT > @DEFFECTIVEDATE -- ISNULL((SELECT [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'OPENING_CASH_DATE'),'')  
 AND CN_DT BETWEEN @DFROMDT AND @DTODT  
 AND (@BSKIPSLSENTRIES=0 OR @DFROMDT='') AND @CCONSIDERALLCASHXN='1'
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)  
 GROUP BY CN_DT  
   
 UNION ALL  
 SELECT RECEIPT_DT AS XN_DT,MEMO_NO AS XN_NO,MEMO_ID,  
   'PCI' AS XN_TYPE,  
   AMOUNT AS DEBIT_AMOUNT,  
   0 AS CREDIT_AMOUNT,  
   'PETTY CASH INWARDS' AS AC_NAME,  
   REMARKS AS NARRATION  
 FROM PCI_MST   (NOLOCK)     
 WHERE RECEIPT_DT <= @DTODT AND RECEIPT_DT > @DEFFECTIVEDATE  
 AND location_Code =(CASE WHEN ISNULL(@CDEPTID ,'')='' THEN location_Code ELSE @CDEPTID END)  
 AND USER_CODE=(CASE WHEN @CUSERCODE='' THEN USER_CODE ELSE @CUSERCODE END)  
 AND CANCELLED=0
 UNION ALL  
 
 SELECT MEMO_DT AS XN_DT,MEMO_NO AS XN_NO,MEMO_ID,  
   'PCO' AS XN_TYPE,  
   0 AS DEBIT_AMOUNT,  
   AMOUNT AS CREDIT_AMOUNT,  
   'PETTY CASH OUTWARDS' AS AC_NAME,  
   REMARKS AS NARRATION  
 FROM PCO_MST        (NOLOCK)
 WHERE   CANCELLED=0 AND MEMO_DT  <= @DTODT AND MEMO_DT > @DEFFECTIVEDATE  
 AND location_Code =(CASE WHEN ISNULL(@CDEPTID ,'')='' THEN location_Code  ELSE @CDEPTID END)  
 AND USER_CODE=(CASE WHEN @CUSERCODE='' THEN USER_CODE ELSE @CUSERCODE END)  
  
LAST_REC:  
  
 IF @DFROMDTPARA = '' -- QUERY FOR OPENING BALANCE  
 BEGIN  
  SELECT SUM(DEBIT_AMOUNT - CREDIT_AMOUNT) AS OP_BAL FROM #CRESULT  
 END   
 ELSE  
  SELECT * FROM #CRESULT ORDER BY XN_DT, XN_TYPE, XN_NO  
    
END  
--******************************************* END OF PROCEDURE SP_CASHXN
