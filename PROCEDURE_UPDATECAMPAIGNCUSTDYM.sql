CREATE pROCEDURE UPDATECAMPAIGNCUSTDYM
@NDOWNLOADTYPE INT,
@CERRORMSG VARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
		
	DECLARE @CSTATE VARCHAR(100),@CCITY VARCHAR(100),@CCITYCODE VARCHAR(100),@CAREACODE VARCHAR(50),
	@CAREA VARCHAR(100),@CDATABASE VARCHAR(50),@CCMD NVARCHAR(MAX),@CTEMPTABLE VARCHAR(100),
	@NSTEP INT
	
	SELECT @CDATABASE='',@CERRORMSG=''
	
	BEGIN TRY
	
		SET @NSTEP=10
		DECLARE @NSPID INT
		
		SET @NSPID = @@SPID
		
		SET @NSTEP=20
		
		
		SET @CTEMPTABLE='TMP_CAMPAIGN_'+LTRIM(RTRIM(STR(@NSPID)))
		
		IF @NDOWNLOADTYPE=2
			GOTO LBLUPDATESTATUS
			
		SET @CCMD=N'SELECT  @CSTATEOUT= ISNULL(STATE,'''') FROM '+@CTEMPTABLE
		EXEC SP_EXECUTESQL @CCMD,N'@CSTATEOUT VARCHAR(50) OUTPUT',@CSTATEOUT=@CSTATE OUTPUT
		
		SET @NSTEP=30
		
		SET @CCMD=N'SELECT  @CCITYOUT= ISNULL(CITY,'''') FROM '+@CTEMPTABLE
		EXEC SP_EXECUTESQL @CCMD,N'@CCITYOUT VARCHAR(50) OUTPUT',@CCITYOUT=@CCITY OUTPUT
		
		SET @NSTEP=40
		SET @CCMD=N'SELECT  @CCITYCODEOUT= ISNULL(CITY_CODE,''0000000'') FROM '+@CTEMPTABLE
		EXEC SP_EXECUTESQL @CCMD,N'@CCITYCODEOUT CHAR(7) OUTPUT',@CCITYCODEOUT=@CCITYCODE OUTPUT
		
		SET @NSTEP=50
		
		SET @CCMD=N' UPDATE '+@CTEMPTABLE+' SET COMPANY_CODE=''01'',REF_CUSTOMER_CODE=''000000000000'''
		EXEC SP_EXECUTESQL @CCMD
		
		SET @CCMD=N'UPDATE A SET REGION_CODE=ISNULL(B.REGION_CODE,''0000000'') FROM '+@CTEMPTABLE+' A
					JOIN STATE B ON A.STATE_CODE=B.STATE_CODE' 
		EXEC SP_EXECUTESQL @CCMD
		
		IF ISNULL(@CSTATE,'') <>''
		BEGIN
			SET @NSTEP=55
			EXEC UPDATEMASTERXN   @CDATABASE , @CTEMPTABLE ,@CDATABASE ,'REGIONM' , 'REGION_CODE',
								  '','',0,'',0,'',0,'',1  		
			SET @NSTEP=60					  
			
			EXEC UPDATEMASTERXN   @CDATABASE , @CTEMPTABLE ,@CDATABASE ,'STATE' , 'STATE_CODE',
								  '','',0,'',0,'',0,'',1  
		END
		
		IF ISNULL(@CCITY,'') <>''
		BEGIN
			SET @NSTEP=70					  
			EXEC UPDATEMASTERXN   @CDATABASE , @CTEMPTABLE ,@CDATABASE ,'CITY' ,  'CITY_CODE',
							  '','',0,'',0,'',0,'',1  
			
			SET @NSTEP=80
			
			SET @CCMD=N'UPDATE '+@CTEMPTABLE+' SET AREA_CODE= CITY_CODE,AREA_NAME= CITY'
			EXEC SP_EXECUTESQL @CCMD
			
			SET @NSTEP=82
			
			EXEC UPDATEMASTERXN   @CDATABASE , @CTEMPTABLE ,@CDATABASE ,'AREA' ,  'AREA_CODE',
							  '','',0,'',0,'',0,'',1 
		END
		ELSE
		BEGIN
			SET @NSTEP=85
			
			SET @CCMD=N'UPDATE '+@CTEMPTABLE+' SET AREA_CODE=''0000000'',AREA_NAME='''''
			EXEC SP_EXECUTESQL @CCMD
		END
		
		declare @cJoinstr varchar(500)
		
		SET @NSTEP=88
		
		set @cCmd=N'IF EXISTS (SELECT TOP 1 A.CUSTOMER_CODE FROM '+@CTEMPTABLE+' A JOIN CUSTDYM B ON A.MOBILE=B.MOBILE)
						SET @CjoINSTR=''CUSTDYM a ON A.MOBILE=B.MOBILE ''
					ELSE
					IF EXISTS (SELECT TOP 1 A.CUSTOMER_CODE FROM '+@CTEMPTABLE+' A JOIN CUSTDYM B ON A.customer_code=B.customer_code)
						SET @CjoINSTR=''CUSTDYM a ON A.customer_code=B.customer_code ''		
					ELSE
					IF EXISTS (SELECT TOP 1 A.CUSTOMER_CODE FROM '+@CTEMPTABLE+' A JOIN CUSTDYM B ON A.user_customer_code=B.user_customer_code)
						SET @CjoINSTR=''CUSTDYM a ON A.user_customer_code=B.user_customer_code ''
					ELSE
					IF EXISTS (SELECT TOP 1 A.CUSTOMER_CODE FROM '+@CTEMPTABLE+' A JOIN CUSTDYM B ON A.mobile=B.customer_code)
						SET @CjoINSTR=''CUSTDYM a ON b.mobile=a.customer_code ''				
					ELSE
					IF EXISTS (SELECT TOP 1 A.CUSTOMER_CODE FROM '+@CTEMPTABLE+' A JOIN CUSTDYM B ON A.mobile=B.user_customer_code)
						SET @CjoINSTR=''CUSTDYM a ON b.mobile=a.user_customer_code '''
		exec sp_executesql @cCmd,N'@cJoinstr varchar(500) output',@cJOinstr output
		
		set @NSTEP=90				
		SET @CCMD=N'UPDATE b set customer_code=a.customer_code from '+@CTEMPTABLE+' b join '+@cJOInstr
		print isnull(@cCmd,'null updatecuststr')
		exec sp_executesql @cCmd				
		
		set @NSTEP=94																
		--- DO NOT OVERWRITE BLANK COLUMN INFORMATION FOR THE FILLED UP DATA COLUMNS
		SET @CCMD=N'UPDATE b SET CUSTOMER_TITLE= (CASE WHEN b.CUSTOMER_TITLE='''' THEN a.CUSTOMER_TITLE ELSE B.CUSTOMER_TITLE END), 
					CUSTOMER_FNAME= (CASE WHEN b.CUSTOMER_FNAME='''' THEN a.CUSTOMER_FNAME ELSE b.CUSTOMER_FNAME END ), 
					CUSTOMER_LNAME= (CASE WHEN b.CUSTOMER_LNAME='''' THEN a.CUSTOMER_LNAME ELSE b.CUSTOMER_LNAME END ), 
					ADDRESS9= (CASE WHEN b.ADDRESS9='''' THEN a.ADDRESS1 ELSE b.ADDRESS9 END ), 
					ADDRESS1= (CASE WHEN ISNULL(b.ADDRESS1,'''')='''' THEN a.ADDRESS1 ELSE b.ADDRESS1 END ), 
					USER_CUSTOMER_CODE=(CASE WHEN b.USER_CUSTOMER_CODE='''' THEN a.USER_CUSTOMER_CODE
											 ELSE b.USER_CUSTOMER_CODE END ), 
					MOBILE=(CASE WHEN b.MOBILE='''' THEN a.MOBILE ELSE b.MOBILE END ), 
					EMAIL=(CASE WHEN b.EMAIL='''' THEN a.EMAIL ELSE b.EMAIL END ), 
					DT_BIRTH=(CASE WHEN b.DT_BIRTH='''' THEN a.DT_BIRTH ELSE b.DT_BIRTH END ), 
					DT_ANNIVERSARY=(CASE WHEN b.DT_ANNIVERSARY='''' THEN a.DT_ANNIVERSARY ELSE b.DT_ANNIVERSARY END ), 
					PIN =(CASE WHEN b.PIN='''' THEN a.PIN ELSE b.PIN END )
					FROM '+@CTEMPTABLE+' b JOIN '+@cJOinstr
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
		
		declare @cKeyFieldJoin varchar(200)
		
		set @cKeyFieldJoin=REPLACE(@cJoinstr,'custdym a','')
		

		SET @NSTEP=100
		EXEC UPDATEMASTERXN 
		@CSOURCEDB=@CDATABASE,
		@CSOURCETABLE=@CTEMPTABLE,
		@CDESTDB=@CDATABASE,
		@CDESTTABLE='custdym',
		@CKEYFIELD1='CUSTOMER_CODE',
		@CKEYFIELD2='',
		@CKEYFIELD3='',
		@LINSERTONLY=0,
		@CFILTERCONDITION='',
		@LUPDATEXNS=0,
		@CXNTYPE='',
		@LUPDATEONLY=0,
		@CUSERID='',
		@BALWAYSUPDATE=1,
		@cKeyFieldJoin=@cKeyFieldJoin
		
		SET @NSTEP=105
		
		SET @CCMD=N'UPDATE a SET ADDRESS1=a.ADDRESS9,ADDRESS9='''' 
					FROM '+@CTEMPTABLE+' b JOIN '+@cJOinstr+'
					where ISNULL(a.ADDRESS9,'''')<>'''''
		EXEC SP_EXECUTESQL @CCMD
					
		--CUS_GST_STATE_CODE					
		SET @NSTEP=107
		
		SET @CCMD=N'UPDATE a SET CUS_GST_STATE_CODE=(SELECT GST_STATE_CODE FROM LOCATION WHERE DEPT_ID =(SELECT VALUE FROM CONFIG WHERE CONFIG_OPTION=''LOCATION_ID'')) 
					FROM '+@CTEMPTABLE+' b JOIN '+@cJOinstr+'
					where ISNULL(a.CUS_GST_STATE_CODE,'''')='''''
		EXEC SP_EXECUTESQL @CCMD
											  
		SET @NSTEP=110
		
		LBLUPDATESTATUS:
		
		EXEC UPDATEMASTERXN   @CDATABASE , @CTEMPTABLE ,@CDATABASE ,'WIZCLIP_CUSTDYM_POINTS' ,'CUSTOMER_CODE',
							  '','',0,'',0,'',0,'',1
		
	END TRY
	
	BEGIN CATCH 
	
		SET @CERRORMSG='PROCEDURE : UPDATECAMPAIGNCUSTDYM STEP  '+ISNULL(LTRIM(RTRIM(STR(@NSTEP))),'0')+ERROR_MESSAGE()
	
	END CATCH
	
END
