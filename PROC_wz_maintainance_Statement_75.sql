


IF NOT EXISTS(SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='INSERT_PAYMODEXNDET_AGST_CMR01106_1' AND VALUE='1')
BEGIN
	DECLARE @CCURDEPTID CHAR(2)
		
	PRINT 'TRANSFERRING CMR01106 ENTRIES TO PAYMODE XN DET TABLE' 
	
	SELECT TOP 1 @CCURDEPTID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	
	DELETE A FROM PAYMODE_XN_DET A JOIN CMR01106 B ON A.MEMO_ID=B.CM_ID WHERE XN_TYPE='SLS'
	AND PAYMODE_CODE='CMR0001' AND ISNULL(A.ADJ_MEMO_ID,'')=''
	
	INSERT PAYMODE_XN_DET	( MEMO_ID, XN_TYPE, PAYMODE_CODE, ROW_ID, AMOUNT, LAST_UPDATE, REF_NO, ADJ_MEMO_ID,
	CURRENCY_CONVERSION_RATE, REMARKS )  
	SELECT A.CM_ID AS MEMO_ID,'SLS' AS XN_TYPE,'CMR0001' AS PAYMODE_CODE,@CCURDEPTID+CONVERT(VARCHAR(38),NEWID()) AS ROW_ID,
	ABS(CREDIT_REFUND_AMOUNT)*-1 AS AMOUNT,GETDATE() AS LAST_UPDATE,C.CM_NO AS REF_NO,A.REF_CM_ID AS ADJ_MEMO_ID,
	0 AS CURRENCY_CONVERSION_RATE,'' AS  REMARKS FROM CMR01106 A
	JOIN CMM01106 C ON C.CM_ID=A.REF_CM_ID
	LEFT OUTER JOIN PAYMODE_XN_DET B ON A.CM_ID=B.MEMO_ID AND B.XN_TYPE='SLS'  AND B.PAYMODE_CODE='CMR0001'
	WHERE B.MEMO_ID IS NULL

	IF NOT EXISTS(SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='INSERT_PAYMODEXNDET_AGST_CMR01106_1')
       INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
	   VALUES ('INSERT_PAYMODEXNDET_AGST_CMR01106_1','1','',GETDATE())	
	ELSE	
		UPDATE CONFIG SET VALUE='1' WHERE CONFIG_OPTION='INSERT_PAYMODEXNDET_AGST_CMR01106_1'	
END
