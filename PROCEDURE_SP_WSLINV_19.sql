CREATE procEDURE SP_WSLINV_19--(LocId 3 digit change only increased the parameter width by Sanjay:04-11-2024)
	@CMEMOID	VARCHAR(40) = '',
	@CWHERE1	VARCHAR(500) = '',
	@NNAVMODE	NUMERIC(1,0) = 0,
	@CWHERE2	NVARCHAR(MAX)='',
	@DMEMODT DATETIME='',
	@CLOCID		VARCHAR(4)=''
----WITH ENCRYPTION
AS
BEGIN
IF (@NNAVMODE = 1)
	BEGIN
		
		SELECT  DISTINCT CONVERT(BIT,0) AS CHK,F.AC_NAME,B.MEMO_ID AS PICK_LIST_ID,A.MEMO_DT AS PICK_LIST_DT,A.MEMO_NO AS PICK_LIST_NO 
		FROM PLD01106 B
		JOIN PLM01106  A ON A.MEMO_ID =  B.MEMO_ID
		LEFT OUTER JOIN 
		(
			SELECT A.ROW_ID AS PICKLIST_ROW_ID,SUM(B.QUANTITY) AS QTY 
			FROM PLD01106 A 
			JOIN IND01106 B  ON A.ROW_ID=B.PICK_LIST_ROW_ID 
			--AND A.ARTICLE_CODE=B.PICKLIST_ARTICLE_CODE
			--AND A.PARA1_CODE=B.PICKLIST_PARA1_CODE AND A.PARA2_CODE=B.PICKLIST_PARA2_CODE
			JOIN INM01106 C ON C.INV_ID = B.INV_ID
			WHERE AC_CODE = @CWHERE1 AND CANCELLED = 0 
			GROUP BY A.ROW_ID
		)C ON C.PICKLIST_ROW_ID = B.ROW_ID
		JOIN BUYER_ORDER_DET E1  ON E1.ROW_ID = B.ORD_ROW_ID
		JOIN BUYER_ORDER_MST E  ON E.ORDER_ID = E1.ORDER_ID
		JOIN LM01106 F ON F.AC_CODE = E.AC_CODE
		WHERE  E.MEMO_TYPE=2 AND  A.CANCELLED = 0 AND (B.QUANTITY-ISNULL(C.QTY,0))>0 AND E.AC_CODE = @CWHERE1 
	END
	ELSE
	BEGIN
		SELECT DISTINCT CONVERT (BIT,(CASE WHEN C.PICK_LIST_ID IS NULL THEN 0 ELSE 1 END)) AS CHK
		,F.AC_NAME,A.PICK_LIST_ID,A.PICK_LIST_DT,A.PICK_LIST_NO 
		FROM WSL_PICKLIST_DET B 
		JOIN WSL_PICKLIST_MST  A ON A.PICK_LIST_ID =  B.PICK_LIST_ID
		LEFT OUTER JOIN 
		(
			SELECT DISTINCT IND.PICK_LIST_ID
			FROM IND01106 IND
			JOIN INM01106 INM ON IND.INV_ID=INM.INV_ID
			WHERE INM.CANCELLED=0 AND INM.INV_ID=@CMEMOID
			 /*
			 SELECT A.ROW_ID AS PICKLIST_ROW_ID,SUM(B.QUANTITY) AS QTY 
			 FROM WSL_PICKLIST_DET A 
			 JOIN IND01106 B ON A.PICK_LIST_ID=B.PICK_LIST_ID AND A.ARTICLE_CODE=B.PICKLIST_ARTICLE_CODE
			 AND A.PARA1_CODE=B.PICKLIST_PARA1_CODE AND A.PARA2_CODE=B.PICKLIST_PARA2_CODE 
			 JOIN INM01106 C ON C.INV_ID = B.INV_ID
			 WHERE CANCELLED = 0 AND C.INV_ID = @CMEMOID  GROUP BY A.ROW_ID
			 */
		)C ON C.PICK_LIST_ID = B.PICK_LIST_ID
		LEFT OUTER JOIN 
		(
			SELECT A.ROW_ID AS PICKLIST_ROW_ID,SUM(B.QUANTITY) AS QTY 
			FROM WSL_PICKLIST_DET A 
			JOIN IND01106 B  ON A.PICK_LIST_ID=B.PICK_LIST_ID AND A.ARTICLE_CODE=B.PICKLIST_ARTICLE_CODE
			AND A.PARA1_CODE=B.PICKLIST_PARA1_CODE AND A.PARA2_CODE=B.PICKLIST_PARA2_CODE
			JOIN INM01106 C ON C.INV_ID = B.INV_ID
			WHERE AC_CODE = @CWHERE1 AND CANCELLED = 0 AND C.INV_ID<>@CMEMOID
			GROUP BY A.ROW_ID
		)C1 ON C1.PICKLIST_ROW_ID = B.ROW_ID
		JOIN BUYER_ORDER_MST E ON E.ORDER_ID = B.ORDER_ID 
		JOIN LM01106 F ON F.AC_CODE = A.AC_CODE
		WHERE A.AC_CODE = @CWHERE1 AND  A.CANCELLED = 0 
		AND B.PICK_LIST_QTY+B.ADD_QTY > ISNULL(C1.QTY,0)
	END
END