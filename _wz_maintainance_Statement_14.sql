

--**** UPDATING DEPT ID COLUMN IN CUSTOMER MASTER AT LOCATIONS WITH CURRENT LOCATION ID
IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE 
			   CONFIG_OPTION='UPDATE_DUP_PURIMPLOG' AND VALUE=1)
BEGIN
	PRINT 'UPDATING DUPLICATE ENTRY IN PUR_IMPORT_LOG TABLE'
	DECLARE @CCURLOCID CHAR(2),@CHOLOCID CHAR(2),@CDAYCLOSEDATE VARCHAR(15),@CENDOFDAY VARCHAR(2)

	SELECT TOP 1 @CCURLOCID = VALUE FROM CONFIG WHERE CONFIG_OPTION = 'LOCATION_ID'
	SELECT TOP 1 @CHOLOCID = VALUE FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'
	
	IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_DUP_PURIMPLOG')
		INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
			   VALUES ('UPDATE_DUP_PURIMPLOG',1,'',GETDATE())	
	ELSE
		UPDATE CONFIG SET VALUE=1 WHERE CONFIG_OPTION='UPDATE_DUP_PURIMPLOG'
	
	IF OBJECT_ID('TEMPDB..#TMPDUPINV','U') IS NOT NULL
		DROP TABLE #TMPDUPINV

	SELECT INV_ID INTO #TMPDUPINV FROM PUR_IMPORT_LOG GROUP BY INV_ID HAVING COUNT(*)>1	
	
	UPDATE A SET CANCELLED=1 FROM PIM01106 A JOIN PUR_IMPORT_LOG B ON A.MRR_ID=B.MRR_ID
	JOIN #TMPDUPINV C ON C.INV_ID=B.INV_ID  WHERE A.TS<>
	(SELECT TOP 1 D.TS FROM PIM01106 D JOIN PUR_IMPORT_LOG E ON D.MRR_ID=E.MRR_ID
	 WHERE E.INV_ID=C.INV_ID ORDER BY D.LAST_UPDATE DESC)
	
	DELETE A FROM PUR_IMPORT_LOG A JOIN #TMPDUPINV B ON A.INV_ID=B.INV_ID
	JOIN PIM01106 C ON C.MRR_ID=A.MRR_ID
	WHERE C.CANCELLED=1
	
	IF OBJECT_ID('TEMPDB..#TMPDUPMRR','U') IS NOT NULL
		DROP TABLE #TMPDUPMRR
	
	SELECT MRR_ID INTO #TMPDUPMRR FROM PUR_IMPORT_LOG GROUP BY MRR_ID HAVING COUNT(*)>1	

	IF OBJECT_ID('TEMPDB..#TMPDUPDET','U') IS NOT NULL
		DROP TABLE #TMPDUPDET
	
	SELECT A.*,NEWID() AS ROW_ID INTO #TMPDUPDET FROM  PUR_IMPORT_LOG A JOIN #TMPDUPMRR B ON A.MRR_ID=B.MRR_ID
	
	DELETE A FROM PUR_IMPORT_LOG A JOIN #TMPDUPMRR B ON A.MRR_ID=B.MRR_ID
	
	INSERT PUR_IMPORT_LOG (MRR_ID,INV_ID,RECEIPT_DT)
	SELECT MRR_ID,INV_ID,RECEIPT_DT FROM #TMPDUPDET A 
	WHERE A.ROW_ID=(SELECT TOP 1 ROW_ID FROM  #TMPDUPDET WHERE MRR_ID=A.MRR_ID)
	
	DELETE A FROM PUR_IMPORT_LOG A LEFT OUTER JOIN PIM01106 B ON A.MRR_ID=B.MRR_ID
	WHERE B.MRR_ID IS NULL	
END
