CREATE VIEW  VW_ATTREGISTER  
--WITH ENCRYPTION
AS    

            -- WEEKOFF  NLOGSTATUS = 1;
            -- ABSENT   NLOGSTATUS = 2;
            -- LEAVE    NLOGSTATUS = 3;
            -- BIRTHDAY NLOGSTATUS = 4;
            -- ELSE     NLOGSTATUS = 0;

SELECT A.ATTENDANCE_DT, A.EMP_ID, A.TIME_IN, A.TIME_OUT, E.SHIFT_NAME, A.SHIFT_TIME_IN, A.SHIFT_TIME_OUT,     
A.HALFDAY_CUTOFF, E.LATE_CUTOFF, E.EARLY_CUTOFF,    
B.DEPT_ID, D.DEPT_NAME, A.SHIFT_ID,    
B.DEPARTMENT_ID, C.DEPARTMENT_NAME, 
B.REF_ID + ' ' + B.EMP_FNAME + ' ' + B.EMP_LNAME AS EMPNAME,    
--B.EMP_FNAME + ' ' + B.EMP_LNAME AS EMPNAME,    
A.LOG_ABSENT_STATUS,    

-- WEEKLY OFF    

--(CASE WHEN A.LOG_ABSENT_STATUS=1 OR WEEKLY_OFF1= DATENAME(DW,A.ATTENDANCE_DT)  THEN 'W'
--WHEN A.LOG_ABSENT_STATUS=4 THEN 'B' WHEN A.LOG_ABSENT_STATUS=3 THEN 'LV' ELSE '' END) +   

--(CASE WHEN ((A.TIME_IN='' AND A.TIME_OUT='' AND A.LOG_ABSENT_STATUS NOT IN (1,4,2)AND B.WEEKLY_OFF1= DATENAME(DW,A.ATTENDANCE_DT)))   THEN 'LV' ELSE    
--(CASE WHEN ((A.TIME_IN = '') OR (A.TIME_OUT = '')) THEN (CASE WHEN A.LOG_ABSENT_STATUS=2 THEN 'A'  WHEN A.LOG_ABSENT_STATUS=0 THEN 'LV' WHEN A.LOG_ABSENT_STATUS=0 AND B.WEEKLY_OFF1= DATENAME(DW,A.ATTENDANCE_DT) THEN 'LV' ELSE '' END)    
--WHEN A.LOG_ABSENT_STATUS<>1 AND ((A.TIME_IN > A.HALFDAY_CUTOFF) OR (A.TIME_OUT < A.HALFDAY_CUTOFF)) THEN (CASE WHEN A.LOG_ABSENT_STATUS<>1 THEN 'LV' ELSE '' END)    
--WHEN ((A.TIME_IN > E.LATE_CUTOFF) AND (A.TIME_IN <= A.HALFDAY_CUTOFF)) AND    
--((A.TIME_OUT < E.EARLY_CUTOFF) AND (A.TIME_OUT >= A.HALFDAY_CUTOFF)) THEN 'LV'    
--WHEN (A.TIME_IN <= A.SHIFT_TIME_IN) AND (A.TIME_OUT >= A.SHIFT_TIME_OUT) THEN 'P'    
--ELSE     
---- INCOMING STATUS    
--(CASE WHEN  (A.TIME_IN <= A.SHIFT_TIME_IN) THEN 'O'    
--WHEN  (A.TIME_IN > A.SHIFT_TIME_IN) AND (A.TIME_IN <= E.LATE_CUTOFF) THEN 'L'    
--WHEN  (A.TIME_IN > E.LATE_CUTOFF) AND (A.TIME_IN <= A.HALFDAY_CUTOFF) THEN 'H'    
--WHEN  (A.TIME_IN > A.HALFDAY_CUTOFF) THEN 'LV'    
--END) +    

---- OUTGOING STATUS    
--(CASE WHEN  (A.TIME_OUT >= A.SHIFT_TIME_OUT) THEN 'O'    
--WHEN  (A.TIME_OUT < A.SHIFT_TIME_OUT) AND (A.TIME_OUT >= E.EARLY_CUTOFF) THEN 'E'    
--WHEN  (A.TIME_OUT < E.EARLY_CUTOFF) AND (A.TIME_OUT >= A.HALFDAY_CUTOFF) THEN 'H'    
--WHEN  (A.TIME_OUT < A.HALFDAY_CUTOFF) THEN 'LV'    
--END)     
--END)     
--END) AS ATTSTATUS, 
 DBO.FN_GETEMP_ATDSTATUS(B.EMP_ID,ATTENDANCE_DT,LOG_ABSENT_STATUS,E.SHIFT_TIME_IN,
                         E.SHIFT_TIME_OUT,A.TIME_IN,A.TIME_OUT,E.EARLY_CUTOFF,
                         E.LATE_CUTOFF,E.HALFDAY_CUTOFF,
                         B.WEEKLY_OFF1) AS ATTSTATUS,
    

B.WEEKLY_OFF1,     
B.WEEKLY_OFF2,     

CONVERT(VARCHAR(2), A.ATTENDANCE_DT,105) AS ATTDT,     
DATENAME(DW, A.ATTENDANCE_DT) AS ATTDAY, B.REF_ID,    

B.EMP_STATUS,     

DATENAME(MONTH,A.ATTENDANCE_DT) + ' - ' + CAST(YEAR(A.ATTENDANCE_DT) AS VARCHAR(4)) AS ATTMONTH,         

(CASE WHEN TIME_IN<>'' AND TIME_IN < DATEADD(MI, -30, A.SHIFT_TIME_IN) THEN     
DATEDIFF(MI, TIME_IN, DATEADD(MI, -30, A.SHIFT_TIME_IN))     
ELSE 0 END) +    
(CASE WHEN TIME_OUT<>'' AND TIME_OUT > DATEADD(MI, 30, A.SHIFT_TIME_OUT) THEN     
DATEDIFF(MI, DATEADD(MI, 30, A.SHIFT_TIME_OUT), TIME_OUT)     
ELSE 0 END) AS EXTRA_TIME,    
(CASE WHEN MONTH(A.ATTENDANCE_DT)=4 THEN 1    
WHEN MONTH(A.ATTENDANCE_DT)=5 THEN 2    
WHEN MONTH(A.ATTENDANCE_DT)=6 THEN 3    
WHEN MONTH(A.ATTENDANCE_DT)=7 THEN 4    
WHEN MONTH(A.ATTENDANCE_DT)=8 THEN 5    
WHEN MONTH(A.ATTENDANCE_DT)=9 THEN 6    
WHEN MONTH(A.ATTENDANCE_DT)=10 THEN 7    
WHEN MONTH(A.ATTENDANCE_DT)=11 THEN 8    
WHEN MONTH(A.ATTENDANCE_DT)=12 THEN 9    
WHEN MONTH(A.ATTENDANCE_DT)=1 THEN 10    
WHEN MONTH(A.ATTENDANCE_DT)=2 THEN 11    
WHEN MONTH(A.ATTENDANCE_DT)=3 THEN 12   END) AS MONTH_NO,    
MONTH(ATTENDANCE_DT) AS AC_MONTH_NO,    
YEAR(ATTENDANCE_DT) AS YEAR, B.CO_ALIAS    

FROM VW_EMP_ATTENANCE_COMPLIED A      
JOIN EMP_MST B ON A.EMP_ID=B.EMP_ID    
JOIN EMP_DEPARTMENT C ON B.DEPARTMENT_ID=C.DEPARTMENT_ID    
JOIN LOCATION D ON B.DEPT_ID=D.DEPT_ID    
JOIN EMP_SHIFTS E ON A.SHIFT_ID = E.SHIFT_ID    
WHERE A.ATTENDANCE_DT >= B.DATE_OF_JOINING
