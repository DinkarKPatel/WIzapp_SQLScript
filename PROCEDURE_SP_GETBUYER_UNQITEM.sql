CREATE PROCEDURE SP_GETBUYER_UNQITEM 
@CITEMCODE	VARCHAR(100)=''
--WITH ENCRYPTION
AS
BEGIN
	 DECLARE @CCUSTCODE	VARCHAR(100)

	 IF (SELECT COUNT(PRODUCT_CODE) FROM CMD01106 A (NOLOCK) JOIN CMM01106 B (NOLOCK) ON B.CM_ID=A.CM_ID WHERE PRODUCT_CODE=@CITEMCODE AND CANCELLED=0 AND QUANTITY<0)=0
	 BEGIN
		
	   SELECT DISTINCT B.CUSTOMER_CODE,A.ORDER_ID  ,'' AS AC_CODE ,  
	   ISNULL(B.SALE_EMP_CODE,'0000000') AS EMP_CODE,ISNULL(D.EMP_NAME,'') AS EMP_NAME  
	   ,B.ORDER_NO,B.ORDER_DT  ,A.PRODUCT_CODE
	   FROM WSL_ORDER_DET A (NOLOCK)    
	   JOIN WSL_ORDER_MST B  (NOLOCK) ON B.ORDER_ID=A.ORDER_ID    
	   JOIN CUSTDYM C  (NOLOCK) ON C.CUSTOMER_CODE=B.CUSTOMER_CODE   
	   LEFT OUTER JOIN EMPLOYEE D (NOLOCK) ON B.SALE_EMP_CODE= D.EMP_CODE   
	   WHERE C.CUSTOMER_CODE<>'000000000000' AND ISNULL(A.CANCELLED,0)=0 AND ISNULL(B.CANCELLED,0)=0  
	   AND A.PRODUCT_CODE=@CITEMCODE   
	   AND ISNULL(A.REF_PRODUCT_CODE,'')=''  
	   UNION  
	   SELECT DISTINCT B.CUSTOMER_CODE,A.ORDER_ID  ,'' AS AC_CODE ,  
	   ISNULL(B.SALE_EMP_CODE,'0000000') AS EMP_CODE,ISNULL(D.EMP_NAME,'') AS EMP_NAME  
	   ,B.ORDER_NO,B.ORDER_DT  ,A.REF_PRODUCT_CODE PRODUCT_CODE
	   FROM WSL_ORDER_DET A (NOLOCK)    
	   JOIN WSL_ORDER_MST B  (NOLOCK) ON B.ORDER_ID=A.ORDER_ID    
	   JOIN CUSTDYM C  (NOLOCK) ON C.CUSTOMER_CODE=B.CUSTOMER_CODE   
	   LEFT OUTER JOIN EMPLOYEE D (NOLOCK) ON B.SALE_EMP_CODE= D.EMP_CODE   
	   WHERE C.CUSTOMER_CODE<>'000000000000' AND ISNULL(A.CANCELLED,0)=0 AND ISNULL(B.CANCELLED,0)=0   
	   AND A.REF_PRODUCT_CODE=@CITEMCODE  
	   
			
	 END
	 ELSE
	 BEGIN
		 SELECT DISTINCT B.CUSTOMER_CODE,A.ORDER_ID  ,'' AS AC_CODE ,
		 ISNULL(B.SALE_EMP_CODE,'0000000') AS EMP_CODE,ISNULL(D.EMP_NAME,'') AS EMP_NAME
		 ,B.ORDER_NO,B.ORDER_DT,A.PRODUCT_CODE
		 FROM WSL_ORDER_DET A (NOLOCK)  
		 JOIN WSL_ORDER_MST B  (NOLOCK) ON B.ORDER_ID=A.ORDER_ID  
		 JOIN CUSTDYM C  (NOLOCK) ON C.CUSTOMER_CODE=B.CUSTOMER_CODE 
		 LEFT OUTER JOIN EMPLOYEE D (NOLOCK) ON B.SALE_EMP_CODE= D.EMP_CODE
		 WHERE 1=2
	 END		 
END
