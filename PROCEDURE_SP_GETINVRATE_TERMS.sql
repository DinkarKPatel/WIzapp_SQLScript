create PROCEDURE SP_GETINVRATE_TERMS                  
 @CPRODUCTCODE VARCHAR(50),              
 @CACCODE CHAR(10),              
 @CDEPTID CHAR(4)='',            
 @CFORMID CHAR(7)='0000000',            
 @NITEMLEVELDISCOUNT NUMERIC(7,3)=0,            
 @NQUANTITY NUMERIC (10,2),            
 @NBILLLEVELDISCOUNT NUMERIC (6,2)=0,  
 @NNEWRATE NUMERIC(10,2)=0,
 @CTERMS_CODE VARCHAR(20),
 @NINVTYPE INT=0,
 @DXNDT DATETIME='',
 @CXNTYPE VARCHAR(10)=''
                
AS                  
BEGIN    
       --(dinkar) Replace  left(memoid,2) to Location_code        
	DECLARE @NRATETYPE NUMERIC(2,0),@NGROSSRATE NUMERIC(12,4),@NRATE NUMERIC(12,4), @CCURLOCID CHAR(2),@CPARTYSTATECODE CHAR(7),@CCURLOCSTATECODE CHAR(7),@CLOCSSTMEMOID VARCHAR(40),
			@BCREDITPURCHASETAX BIT,@BCREDITOUTPUTVAT BIT,@NCREDITLOCALVAT NUMERIC(10,3),@NCREDITPURCHASEVAT NUMERIC(7,3),@NLOCALVATPCT NUMERIC(7,3),
			@NCREDITPURCHASETAX NUMERIC(10,3),@CSUBSECTIOCODE VARCHAR(10),@NCHARGETAXPCT NUMERIC(7,3),@NCREDITCENTRALPCT NUMERIC(7,3)
	  
	DECLARE @CRETINVRATE TABLE (RATE NUMERIC(10,2),DISCOUNT_PERCENTAGE NUMERIC(7,3),DISCOUNT_AMOUNT NUMERIC(10,2),              
			 NET_RATE NUMERIC(10,2),TAX_AMOUNT NUMERIC(10,2),TAX_METHOD NUMERIC(1),TAX_PERCENTAGE NUMERIC(6,2))  
	               
	              
	DECLARE @NFORMTAXPCT NUMERIC(7,3),  @NTAXAMT NUMERIC(12,4),@NDISCPER NUMERIC(7,3),  @NDISCAMT NUMERIC(12,4),@NTERMSDISCPER NUMERIC(7,3)  

	SELECT @NTERMSDISCPER = ISNULL(GROSS_MARGIN,0),@BCREDITPURCHASETAX=REIMUBURSE_PURCHASE_TAX,@BCREDITOUTPUTVAT=REIMUBURSE_OUTPUT_VAT 
	FROM LEDGER_TERMS WHERE TERMS_CODE  = @CTERMS_CODE                     
	
	SELECT @BCREDITPURCHASETAX=ISNULL(@BCREDITPURCHASETAX,0),@BCREDITOUTPUTVAT=ISNULL(@BCREDITOUTPUTVAT,0),@NCREDITLOCALVAT=0
	
	SELECT @CPARTYSTATECODE=STATE_CODE FROM LOC_VIEW WHERE DEPT_ID=@CDEPTID
	
	IF @CXNTYPE='WSR'	
	BEGIN
		SELECT @CCURLOCSTATECODE=STATE_CODE FROM LOC_VIEW WHERE DEPT_ID=@CDEPTID
		SET @NINVTYPE=(CASE WHEN @CCURLOCSTATECODE=@CPARTYSTATECODE THEN 2 ELSE 1 END)
	END

	IF @NNEWRATE=0  
		SELECT @NGROSSRATE = MRP FROM SKU WHERE PRODUCT_CODE = @CPRODUCTCODE  
	ELSE    
		SET @NGROSSRATE = @NNEWRATE  
	  	
	IF @BCREDITOUTPUTVAT=1
	BEGIN
		SELECT TOP 1 @CLOCSSTMEMOID = LTRIM(RTRIM(A.MEMO_ID)) FROM LOCSST_MST A
		JOIN LOCSST B ON A.MEMO_ID=B.MEMO_ID WHERE STATE_CODE=@CPARTYSTATECODE AND
		FROM_DT<=@DXNDT  ORDER BY FROM_DT DESC
		
		SELECT @CSUBSECTIOCODE=SUB_SECTION_CODE FROM SKU A 
		JOIN ARTICLE B ON A.ARTICLE_CODE=B.ARTICLE_CODE
		WHERE PRODUCT_CODE=@CPRODUCTCODE
		
		SELECT TOP 1 @NLOCALVATPCT=ISNULL(X.ADD_TAX_PERCENTAGE,X.TAX_PERCENTAGE) FROM SKU B
		JOIN ARTICLE C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
		JOIN
		(
		   SELECT B.SUB_SECTION_CODE,B.TAX_PERCENTAGE, C.MIN_MRP,C.MAX_MRP,
		   C.TAX_PERCENTAGE AS ADD_TAX_PERCENTAGE 
		   FROM LOCSST B (NOLOCK)    
		   LEFT OUTER JOIN LOCSSTADD C (NOLOCK) ON C.LOCSST_ROW_ID =B.ROW_ID   
		   WHERE  B.MEMO_ID =@CLOCSSTMEMOID AND SUB_SECTION_CODE=@CSUBSECTIOCODE
		)X ON X.SUB_SECTION_CODE=C.SUB_SECTION_CODE 
		WHERE B.PRODUCT_CODE=@CPRODUCTCODE AND  ((X.MIN_MRP IS NOT NULL AND  ABS(B.MRP) BETWEEN X.MIN_MRP AND X.MAX_MRP) OR X.MIN_MRP IS NULL)
		
		SET @NLOCALVATPCT=ISNULL(@NLOCALVATPCT,0)
		
		IF @NINVTYPE=1
			SET @NCREDITLOCALVAT=100*@NLOCALVATPCT/(100+@NLOCALVATPCT)
		ELSE
			SET @NCREDITLOCALVAT=@NTERMSDISCPER*@NLOCALVATPCT/100
	END
  
	IF @NINVTYPE=1
		SELECT @NCHARGETAXPCT = ISNULL(TAX_PERCENTAGE,0) FROM FORM WHERE FORM_ID = @CFORMID                     
	ELSE
	BEGIN
		SELECT TOP 1 @CLOCSSTMEMOID = LTRIM(RTRIM(A.MEMO_ID)) FROM LOCSST_MST A
		JOIN LOCSST B ON A.MEMO_ID=B.MEMO_ID WHERE STATE_CODE=@CPARTYSTATECODE AND
		FROM_DT<=@DXNDT  ORDER BY FROM_DT DESC
		
		SELECT @CSUBSECTIOCODE=SUB_SECTION_CODE FROM SKU A 
		JOIN ARTICLE B ON A.ARTICLE_CODE=B.ARTICLE_CODE
		WHERE PRODUCT_CODE=@CPRODUCTCODE
		
		SELECT TOP 1 @NCHARGETAXPCT=ISNULL(X.ADD_TAX_PERCENTAGE,X.TAX_PERCENTAGE) FROM SKU B
		JOIN ARTICLE C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
		JOIN
		(
		   SELECT B.SUB_SECTION_CODE,B.TAX_PERCENTAGE, C.MIN_MRP,C.MAX_MRP,
		   C.TAX_PERCENTAGE AS ADD_TAX_PERCENTAGE 
		   FROM LOCSST B (NOLOCK)    
		   LEFT OUTER JOIN LOCSSTADD C (NOLOCK) ON C.LOCSST_ROW_ID =B.ROW_ID   
		   WHERE  B.MEMO_ID =@CLOCSSTMEMOID AND SUB_SECTION_CODE=@CSUBSECTIOCODE
		)X ON X.SUB_SECTION_CODE=C.SUB_SECTION_CODE 
		WHERE B.PRODUCT_CODE=@CPRODUCTCODE AND  ((X.MIN_MRP IS NOT NULL AND  ABS(B.MRP) BETWEEN X.MIN_MRP AND X.MAX_MRP) OR X.MIN_MRP IS NULL)
		
		SET @NCHARGETAXPCT=ISNULL(@NCHARGETAXPCT,0)
		
	END		
	
	IF @BCREDITPURCHASETAX=1 
	BEGIN
		SET @NCREDITCENTRALPCT=(CASE WHEN @NINVTYPE=2 THEN @NLOCALVATPCT ELSE  @NCHARGETAXPCT END)
		SELECT @NCREDITPURCHASETAX=((100-(100*(@NTERMSDISCPER+@NCREDITLOCALVAT)/100))*@NCREDITCENTRALPCT/(100+@NCREDITCENTRALPCT))
	END	
	ELSE
		SET @NCREDITPURCHASETAX=0
	
	--SELECT @NCREDITPURCHASETAX,@NCREDITLOCALVAT
	
	SET @NTERMSDISCPER=@NTERMSDISCPER+@NCREDITLOCALVAT+@NCREDITPURCHASETAX
			               
	SET @NTAXAMT  = 0              

	SET @NRATE = @NGROSSRATE              
	SET @NDISCPER = 0                  
	SET @NDISCAMT = 0                  
	
	SET @NTERMSDISCPER = ISNULL(@NTERMSDISCPER,0)  
	SELECT @NDISCPER = @NTERMSDISCPER 


	SET @NDISCAMT = ((@NRATE * @NQUANTITY) * @NDISCPER) / 100                      
	SET @NRATE = (@NRATE - (@NDISCAMT/(CASE WHEN @NQUANTITY=0 THEN 1 ELSE @NQUANTITY END)))  
	         
	--SET @NOCTROI = (@NRATE * ISNULL(@NOCTROIPER,0)/100)                  
	                
	SET @NRATE = @NRATE   
	                
	                  
	INSERT @CRETINVRATE ( RATE, DISCOUNT_PERCENTAGE, DISCOUNT_AMOUNT,NET_RATE, TAX_AMOUNT,TAX_PERCENTAGE)  
		   VALUES ( @NGROSSRATE, @NDISCPER, @NDISCAMT,  @NRATE,@NTAXAMT, @NCHARGETAXPCT)  
	  
	SELECT * FROM @CRETINVRATE  
	RETURN              
END
