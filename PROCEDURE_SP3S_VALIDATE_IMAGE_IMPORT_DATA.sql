CREATE PROCEDURE SP3S_VALIDATE_IMAGE_IMPORT_DATA
( 
	@cSPID VARCHAR(50),
	@bArticle BIT=0,
	@bPara1 BIT=0,
	@bPara2 BIT=0,
	@bPara3 BIT=0,
	@bPara4 BIT=0,
	@bPara5 BIT=0,
	@bPara6 BIT=0,
	@bProductCode BIT=0
)
AS
BEGIN
--DECLARE @cSPID VARCHAR(50),@bArticle BIT,@bPara1 BIT,@bPara2 BIT,@bPara3 BIT,@bPara4 BIT,@bPara5 BIT,@bPara6 BIT,@bProductCode BIT
--SELECT @cSPID='', @bArticle =1,@bPara1 =1,@bPara2 =1,@bPara3 =1,@bPara4 =1,@bPara5 =1,@bPara6 =1,@bProductCode =1
DECLARE @DTError TABLE(XN_VALUE VARCHAR(MAX),ERRMSG VARCHAR(MAX))
DECLARE @cErrMsg VARCHAR(MAX),@cCMD NVARCHAR(MAX)
BEGIN TRY
if ISNULL(@bArticle,0)=1
BEGIN
	INSERT INTO @DTError (XN_VALUE,ERRMSG)
	SELECT A.ARTICLE_NO,'Article No not found' as errmsg 
	from IMAGE_IMPORT_DATA A (NOLOCK)
	LEFT OUTER JOIN article B (NOLOCK) ON B.ARTICLE_NO=A.ARTICLE_NO
	WHERE A.SP_ID=@cSPID AND ISNULL(A.ARTICLE_NO,'')<>'' AND B.article_code IS NULL
END
IF ISNULL(@bPara1,0)=1
BEGIN
	INSERT INTO @DTError (XN_VALUE,ERRMSG)
	SELECT A.PARA1_NAME,'PARA1 not found' as errmsg 
	from IMAGE_IMPORT_DATA A (NOLOCK)
	LEFT OUTER JOIN para1 B (NOLOCK) ON B.PARA1_NAME=A.PARA1_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA1_NAME,'')<>'' AND B.para1_code IS NULL
END
IF ISNULL(@bPara2,0)=1
BEGIN
	INSERT INTO @DTError (XN_VALUE,ERRMSG)
	SELECT A.PARA2_NAME,'PARA1 not found' as errmsg 
	from IMAGE_IMPORT_DATA A (NOLOCK)
	LEFT OUTER JOIN para2 B (NOLOCK) ON B.PARA2_NAME=A.PARA2_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA2_NAME,'')<>'' AND B.para2_code IS NULL
END
IF ISNULL(@bPara3,0)=1
BEGIN
	INSERT INTO @DTError (XN_VALUE,ERRMSG)
	SELECT A.PARA3_NAME,'PARA3 not found' as errmsg 
	from IMAGE_IMPORT_DATA A (NOLOCK)
	LEFT OUTER JOIN para3 B (NOLOCK) ON B.PARA3_NAME=A.PARA3_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA3_NAME,'')<>'' AND B.para3_code IS NULL
END
IF ISNULL(@bPara4,0)=1
BEGIN
	INSERT INTO @DTError (XN_VALUE,ERRMSG)
	SELECT A.PARA4_NAME,'PARA4 not found' as errmsg 
	from IMAGE_IMPORT_DATA A (NOLOCK)
	LEFT OUTER JOIN para4 B (NOLOCK) ON B.PARA4_NAME=A.PARA4_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA4_NAME,'')<>'' AND B.para4_code IS NULL
END
IF ISNULL(@bPara5,0)=1
BEGIN
	INSERT INTO @DTError (XN_VALUE,ERRMSG)
	SELECT A.PARA5_NAME,'PARA5 not found' as errmsg 
	from IMAGE_IMPORT_DATA A (NOLOCK)
	LEFT OUTER JOIN para5 B (NOLOCK) ON B.PARA5_NAME=A.PARA5_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA5_NAME,'')<>'' AND B.para5_code IS NULL
END
IF ISNULL(@bPara6,0)=1
BEGIN
	INSERT INTO @DTError (XN_VALUE,ERRMSG)
	SELECT A.PARA6_NAME,'PARA6 not found' as errmsg 
	from IMAGE_IMPORT_DATA A (NOLOCK)
	LEFT OUTER JOIN para6 B (NOLOCK) ON B.PARA6_NAME=A.PARA6_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA6_NAME,'')<>'' AND B.para6_code IS NULL
END
IF ISNULL(@bProductCode,0)=1
BEGIN
	INSERT INTO @DTError (XN_VALUE,ERRMSG)
	SELECT A.PRODUCT_CODE,'Product Code not found' as errmsg 
	from IMAGE_IMPORT_DATA A (NOLOCK)
	LEFT OUTER JOIN SKU B (NOLOCK) ON B.product_code=A.PRODUCT_CODE
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PRODUCT_CODE,'')<>'' AND B.product_code IS NULL
END
IF EXISTS (SELECT TOP 1 ERRMSG FROM @DTError )
BEGIN
	SELECT * FROM @DTError
	RETURN
END

if ISNULL(@bArticle,0)=1
BEGIN
	UPDATE A SET A.ARTICLE_CODE=B.article_code
	from IMAGE_IMPORT_DATA A (NOLOCK)
	JOIN article B (NOLOCK) ON B.ARTICLE_NO=A.ARTICLE_NO
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.ARTICLE_NO,'')<>'' 
END
ELSE
BEGIN
	UPDATE A SET A.ARTICLE_CODE='00000000'
	from IMAGE_IMPORT_DATA A (NOLOCK)
END
IF ISNULL(@bPara1,0)=1
BEGIN
	UPDATE A SET A.PARA1_CODE=B.para1_code
	from IMAGE_IMPORT_DATA A (NOLOCK)
	JOIN para1 B (NOLOCK) ON B.PARA1_NAME=A.PARA1_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA1_NAME,'')<>'' 
END
ELSE
BEGIN
	UPDATE A SET A.PARA1_CODE='0000000'
	from IMAGE_IMPORT_DATA A (NOLOCK)
END
IF ISNULL(@bPara2,0)=1
BEGIN
	UPDATE A SET A.PARA2_CODE=B.para2_code	
	from IMAGE_IMPORT_DATA A (NOLOCK)
	JOIN para2 B (NOLOCK) ON B.PARA2_NAME=A.PARA2_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA2_NAME,'')<>'' 
END
ELSE
BEGIN
	UPDATE A SET A.PARA2_CODE='0000000'
	from IMAGE_IMPORT_DATA A (NOLOCK)
END

IF ISNULL(@bPara3,0)=1
BEGIN
	UPDATE A SET A.PARA3_CODE=B.para3_code
	from IMAGE_IMPORT_DATA A (NOLOCK)
	JOIN para3 B (NOLOCK) ON B.PARA3_NAME=A.PARA3_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA3_NAME,'')<>'' 
END
ELSE
BEGIN
	UPDATE A SET A.PARA3_CODE='0000000'
	from IMAGE_IMPORT_DATA A (NOLOCK)
END

IF ISNULL(@bPara4,0)=1
BEGIN
	UPDATE A SET A.PARA4_CODE=B.para4_code
	from IMAGE_IMPORT_DATA A (NOLOCK)
	JOIN para4 B (NOLOCK) ON B.PARA4_NAME=A.PARA4_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA4_NAME,'')<>'' 
END
ELSE
BEGIN
	UPDATE A SET A.PARA4_CODE='0000000'
	from IMAGE_IMPORT_DATA A (NOLOCK)
END

IF ISNULL(@bPara5,0)=1
BEGIN
	UPDATE A SET A.PARA5_CODE=B.para5_code
	from IMAGE_IMPORT_DATA A (NOLOCK)
	JOIN para5 B (NOLOCK) ON B.PARA5_NAME=A.PARA5_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA5_NAME,'')<>'' 
END
ELSE
BEGIN
	UPDATE A SET A.PARA5_CODE='0000000'
	from IMAGE_IMPORT_DATA A (NOLOCK)
END
IF ISNULL(@bPara6,0)=1
BEGIN
	UPDATE A SET A.PARA6_CODE=B.para6_code
	from IMAGE_IMPORT_DATA A (NOLOCK)
	JOIN para6 B (NOLOCK) ON B.PARA6_NAME=A.PARA6_NAME
	WHERE A.SP_ID=@cSPID AND  ISNULL(A.PARA6_NAME,'')<>'' 
END
ELSE
BEGIN
	UPDATE A SET A.PARA6_CODE='0000000'
	from IMAGE_IMPORT_DATA A (NOLOCK)
END


END TRY
BEGIN CATCH
	SET @cErrMsg=ERROR_MESSAGE();
END CATCH

IF ISNULL(@cErrMsg,'')=''
BEGIN
	SET @cCMD=N';WITH IMPORTDATA
	AS
	(
		SELECT *  FROM IMAGE_IMPORT_DATA WHERE SP_ID='+@cSPID +'
	) 
	SELECT A.*,B.prod_image,b.IMG_ID,'''' AS ErrMsg 
	FROM IMPORTDATA A
	LEFT OUTER JOIN '+DB_NAME()+'_IMAGE..IMAGE_INFO B (NOLOCK) ON a.article_code=b.article_code
	AND a.para1_code=b.para1_code AND a.para2_code=b.para2_code AND a.para3_code=b.para3_code 
	AND a.para4_code=b.para4_code AND a.para5_code=b.para5_code AND a.para6_code=b.para6_code 
	AND ISNULL(a.product_code,'''')=ISNULL(b.product_code,'''')
	ORDER BY A.SSPL_IMPORT_SRNO'

	PRINT @cCMD
	EXEC SP_EXECUTESQL @cCMD
	
END
ELSE
	SELECT ISNULL(@cErrMsg,'') AS ErrMsg

DELETE FROM IMAGE_IMPORT_DATA WHERE SP_ID=@cSPID
END