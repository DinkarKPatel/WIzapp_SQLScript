create PROCEDURE SP3S_JOBWORK_RECEIPT
(
	 @DFROM_DT DATETIME
	,@DTO_DT DATETIME
	,@AGENCY_CODE VARCHAR(100)=''
	,@CANCELLED NUMERIC(1)=2--0 FOR UN-CANCELLED 1 FOR CANCELLED 2 FOR ALL
	,@LOC VARCHAR(5)=''
	,@JOBCARD_ID varchar(100)
	,@nDateFilterMode NUMERIC(1,0)=1
	
)
----WITH ENCRYPTION
AS
BEGIN  
     IF OBJECT_ID('TEMPDB..#ABC123','U') IS NOT NULL
		DROP TABLE #ABC123
	IF OBJECT_ID('TEMPDB..#ABC456','U') IS NOT NULL
		DROP TABLE #ABC456

	SELECT A.RECEIPT_ID--,D.MEMO_ID ,D.MEMO_NO,D.MEMO_DT 
	INTO #ABC123
   FROM JOBWORK_RECEIPT_DET  A (NOLOCK)
   JOIN ORD_PLAN_BARCODE_DET B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE 
   JOIN ORD_PLAN_DET C (NOLOCK) ON B.REFROW_ID =C.ROW_ID 
   JOIN ORD_PLAN_MST D (NOLOCK) ON C.MEMO_ID =D.MEMO_ID 
   WHERE D.CANCELLED =0 AND( D.MEMO_ID=@JOBCARD_ID OR @JOBCARD_ID='')
   GROUP BY A.RECEIPT_ID--,D.MEMO_ID ,D.MEMO_NO,D.MEMO_DT 

	/*@Rohit : 24-02-2020 : Against Ticket No : 02-2146 [CTC Trading]
	  
		SELECT B.RECEIPT_ID,B.BIN_ID ,SUM(B.QUANTITY) AS RECEIVE_QUNATITY,SUM(B.QUANTITY * B.JOB_RATE) AS AMOUNT 
		INTO #ABC456
		FROM JOBWORK_RECEIPT_DET B (NOLOCK)
		JOIN JOBWORK_RECEIPT_MST A (NOLOCK) ON A.receipt_id=B.receipt_id
		WHERE ((@nDateFilterMode=1 AND A.RECEIPT_DT BETWEEN @DFROM_DT AND @DTO_DT) OR
		(@nDateFilterMode=2 AND A.challan_DT BETWEEN @DFROM_DT AND @DTO_DT))
		AND (@CANCELLED=2 OR A.CANCELLED=@CANCELLED) 
		AND (@AGENCY_CODE='' OR A.AGENCY_CODE=@AGENCY_CODE) 
		AND (@LOC='' OR left(A.receipt_id,2)=@LOC)  
		GROUP BY B.RECEIPT_ID,B.BIN_ID 

	  */
	  
	 SELECT B.RECEIPT_ID,SUM(B.QUANTITY) AS RECEIVE_QUNATITY,SUM(B.QUANTITY * B.JOB_RATE) AS AMOUNT 
	INTO #ABC456
	FROM JOBWORK_RECEIPT_DET B (NOLOCK)
   JOIN JOBWORK_RECEIPT_MST A (NOLOCK) ON A.receipt_id=B.receipt_id
   WHERE ((@nDateFilterMode=1 AND A.RECEIPT_DT BETWEEN @DFROM_DT AND @DTO_DT) OR
		(@nDateFilterMode=2 AND A.challan_DT BETWEEN @DFROM_DT AND @DTO_DT))
   AND (@CANCELLED=2 OR A.CANCELLED=@CANCELLED) 
   AND (@AGENCY_CODE='' OR A.AGENCY_CODE=@AGENCY_CODE) 
		AND (@LOC='' OR A.location_Code=@LOC)  
      GROUP BY B.RECEIPT_ID


if @JOBCARD_ID=''
begin
 SELECT A.RECEIPT_NO,
 RECEIPT_DT=CONVERT(VARCHAR,A.RECEIPT_DT,105),A.RECEIPT_ID AS MEMO_ID,
 CANCELLED=CASE WHEN A.CANCELLED=0 THEN '' ELSE 'CANCELLED' END,
 A.SUBTOTAL,A.TDS,A.OTHER_CHARGES,A.NET_AMOUNT,
 A.COMPANY_CODE,CONVERT(VARCHAR,A.LAST_UPDATE,105) AS LAST_UPDATE,
 A.SENT_TO_HO,A.FIN_YEAR,A.RECEIVED_BY,A.CHECKED_BY,A.REF_NO,
 A.ROUND_OFF,A.MODE,
 A.REMARKS AS REMARKS_MST,A.WIP,A.CHALLAN_NO,A.CHALLAN_DT
 
 ,U.USERNAME
 ,D.AGENCY_NAME
 ,'' AS BIN_NAME--BI.BIN_NAME

 ,C.AC_NAME
 ,G.DEPT_NAME
 ,EDT_USER_NAME=U1.USERNAME
 ,B.RECEIVE_QUNATITY,   
 B.AMOUNT ,A.tds AS TDS_AMOUNT
 FROM JOBWORK_RECEIPT_MST A (NOLOCK)                         
 JOIN #ABC456 B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID 
 LEFT JOIN LM01106 C (NOLOCK) ON C.AC_CODE =A.AC_CODE                       
 JOIN PRD_AGENCY_MST D (NOLOCK) ON A.AGENCY_CODE = D.AGENCY_CODE                           
 --JOIN BIN BI (NOLOCK) ON BI.BIN_ID = B.BIN_ID 
 JOIN LOCATION G (NOLOCK) ON G.DEPT_ID=A.DEPT_ID     
 LEFT JOIN USERS U (NOLOCK) ON U.USER_CODE=A.USER_CODE
 LEFT JOIN USERS U1 (NOLOCK) ON U1.USER_CODE=A.EDT_USER_CODE
 left join #ABC123 JC ON JC.receipt_id =A.receipt_id 

 end
 else
 begin
   

  SELECT A.RECEIPT_NO,
 RECEIPT_DT=CONVERT(VARCHAR,A.RECEIPT_DT,105),A.RECEIPT_ID AS MEMO_ID,
 CANCELLED=CASE WHEN A.CANCELLED=0 THEN '' ELSE 'CANCELLED' END,
 A.SUBTOTAL,A.TDS,A.OTHER_CHARGES,A.NET_AMOUNT,
 A.COMPANY_CODE,CONVERT(VARCHAR,A.LAST_UPDATE,105) AS LAST_UPDATE,
 A.SENT_TO_HO,A.FIN_YEAR,A.RECEIVED_BY,A.CHECKED_BY,A.REF_NO,
 A.ROUND_OFF,A.MODE,
 A.REMARKS AS REMARKS_MST,A.WIP,A.CHALLAN_NO,A.CHALLAN_DT
 
 ,U.USERNAME
 ,D.AGENCY_NAME
 ,'' AS BIN_NAME--BI.BIN_NAME

 ,C.AC_NAME
 ,G.DEPT_NAME
 ,EDT_USER_NAME=U1.USERNAME
 ,B.RECEIVE_QUNATITY,   
 B.AMOUNT ,A.tds AS TDS_AMOUNT
 FROM JOBWORK_RECEIPT_MST A (NOLOCK)                         
 JOIN #ABC456 B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID 
 LEFT JOIN LM01106 C (NOLOCK) ON C.AC_CODE =A.AC_CODE                       
 JOIN PRD_AGENCY_MST D (NOLOCK) ON A.AGENCY_CODE = D.AGENCY_CODE                           
 --JOIN BIN BI (NOLOCK) ON BI.BIN_ID = B.BIN_ID 
 JOIN LOCATION G (NOLOCK) ON G.DEPT_ID=A.DEPT_ID     
 LEFT JOIN USERS U (NOLOCK) ON U.USER_CODE=A.USER_CODE
 LEFT JOIN USERS U1 (NOLOCK) ON U1.USER_CODE=A.EDT_USER_CODE
 join #ABC123 JC ON JC.receipt_id =A.receipt_id 

 end
 --where ( @JOBCARD_ID='' or jc.receipt_id is not null)
END

