CREATE  PROCEDURE SP3S_GETPENDING_CONVERT_MRN
@NQUERYID NUMERIC(2,0),
@CACCODE CHAR(10)='',
@DLOGIN_DT DATETIME='',
@CDEPTID VARCHAR(5)='',
@CWHERECLAUSE VARCHAR(MAX)=''

AS
BEGIN

IF @NQUERYID=1
	GOTO LBLMST
ELSE
IF @NQUERYID=2
	GOTO LBLDET	
ELSE
IF @NQUERYID=3
	GOTO LBLADJUSTEDMRRS
	
LBLMST:	
	DECLARE @CUTOFDATE DATETIME
	SELECT @CUTOFDATE=ISNULL(VALUE,'') FROM CONFIG WHERE CONFIG_OPTION='PUR_CHALLAN_CUTOFDATE'	

	SET @CUTOFDATE=ISNULL(@CUTOFDATE,'')
				
    IF OBJECT_ID('TEMPDB..#TMPPURCHALLAN','U') IS NOT NULL 
        DROP TABLE #TMPPURCHALLAN
        
    SELECT  CAST(0 AS BIT) AS BILLCHECK, A.MRR_ID AS PS_ID,A.INV_NO AS PS_NO
			,A.RECEIPT_DT AS PS_DT,  SUM(B.INVOICE_QUANTITY) AS TOTAL_QTY,  
			CAST('' AS NVARCHAR(10)) AS SRNO ,A.REMARKS 
			,A.MRR_ID ,A.MRR_NO,A.RECEIPT_DT ,A.TOTAL_AMOUNT ,A.INV_NO 
			,'' AS FORM_NAME,'0000000' AS FORM_ID 
			,A.DISCOUNT_PERCENTAGE,A.DISCOUNT_AMOUNT				
			,CAST(0 AS NUMERIC(5,2)) AS TAX_PERCENTAGE 
			,C.AC_NAME,C.AC_CODE
			
			,ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,3),0) AS LEDGER_DISCOUNTPERCENTAGE	 
	        ,CONVERT(NUMERIC(18,2),0) AS LEDGER_DISCOUNTAMOUNT
	        ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_EXCISEDUTYAMOUNT
            ,0  AS LEDGER_TAXAMOUNT
	        ,SUM(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,5),0)=1 THEN B.TAX_AMOUNT
	  		ELSE 0 END)				AS LEDGER_POSTTAXDISCOUNTAMOUNT
	       ,(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,6),0)=0 THEN A.FREIGHT
					ELSE 0 END)		AS LEDGER_FREIGHT
	       ,(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,7),0)=0 THEN A.OTHER_CHARGES
					ELSE 0 END)		AS LEDGER_OTHERCHARGES
	       ,A.ROUND_OFF				AS LEDGER_ROUNDOFF
	       ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_NETAMOUNT
	       ,SUM(B.QUANTITY*B.MRP)    AS LEDGER_MRPVALUE
	       ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_PURCHASEVALUE
	       ,ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,1),0)    AS LEDGER_MARKDOWN,A.TERMS
	       ,A.OTHER_CHARGES,A.FREIGHT,A.REF_CONVERTED_MRNTOBILL_MRRID

			INTO #TMPPURCHALLAN
			FROM PIM01106 A (NOLOCK) 
			JOIN PID01106 B (NOLOCK) ON A.MRR_ID = B.MRR_ID 
			JOIN LM01106 C (NOLOCK) ON A.AC_CODE=C.AC_CODE
			LEFT OUTER JOIN PIM01106 D (NOLOCK) ON D.MRR_ID=A.REF_CONVERTED_MRNTOBILL_MRRID AND D.CANCELLED=0
			WHERE A.AC_CODE=@CACCODE AND A.CANCELLED = 0 AND A.INV_MODE=1
			AND (@CUTOFDATE='' OR A.RECEIPT_DT>@CUTOFDATE) 
			AND A.DEPT_ID = @CDEPTID AND A.BILL_CHALLAN_MODE = 1 AND B.PRODUCT_CODE <> '' AND A.PIM_MODE<>5
			AND (D.MRR_ID IS NULL OR D.MRR_ID=@CWHERECLAUSE)
			GROUP BY A.MRR_ID,A.INV_NO,A.INV_DT,A.REMARKS,A.MRR_NO,A.RECEIPT_DT,A.TOTAL_AMOUNT,A.DISCOUNT_PERCENTAGE,A.DISCOUNT_AMOUNT
			,C.AC_NAME,C.AC_CODE,A.TERMS,A.FREIGHT ,A.OTHER_CHARGES ,A.ROUND_OFF,A.REF_CONVERTED_MRNTOBILL_MRRID

			----Removed this condition for Ticket #08-0906 & we could make use of cut off date for this instead..
			--AND A.RECEIPT_DT>=CONVERT(VARCHAR(10),DATEADD(MONTH,-6,@DLOGIN_DT),121) --ONLY BEFORE SIX MONTH CONVER TO MRRN   
			
--select * from #TMPPURCHALLAN
	UPDATE #TMPPURCHALLAN
			SET LEDGER_PURCHASEVALUE=LEDGER_MRPVALUE-(LEDGER_MRPVALUE*LEDGER_MARKDOWN/100.00)
			  
	UPDATE #TMPPURCHALLAN
			SET LEDGER_DISCOUNTAMOUNT=(LEDGER_PURCHASEVALUE*LEDGER_DISCOUNTPERCENTAGE/100)


	UPDATE #TMPPURCHALLAN
			SET LEDGER_NETAMOUNT=LEDGER_PURCHASEVALUE-LEDGER_DISCOUNTAMOUNT+LEDGER_EXCISEDUTYAMOUNT
								 +LEDGER_TAXAMOUNT-LEDGER_POSTTAXDISCOUNTAMOUNT+LEDGER_FREIGHT
								 +LEDGER_OTHERCHARGES	

	UPDATE #TMPPURCHALLAN 
			SET  LEDGER_ROUNDOFF =ROUND(LEDGER_NETAMOUNT,0)-LEDGER_NETAMOUNT
				,LEDGER_NETAMOUNT=ROUND(LEDGER_NETAMOUNT,0)

	UPDATE #TMPPURCHALLAN  SET LEDGER_DISCOUNTAMOUNT =(LEDGER_PURCHASEVALUE*LEDGER_DISCOUNTPERCENTAGE )/100 
    
	UPDATE #TMPPURCHALLAN SET BILLCHECK=1 WHERE REF_CONVERTED_MRNTOBILL_MRRID=@CWHERECLAUSE AND @CWHERECLAUSE<>''
	  
	SELECT D.*,(TOTAL_AMOUNT - LEDGER_NETAMOUNT) AS DIFF_NETAMOUNT,'' AS REF_MRR_ID  
	FROM #TMPPURCHALLAN D 
	JOIN
	(
		SELECT  A.MRR_ID, SUM(B.INVOICE_QUANTITY) AS TOTAL_QTY  
		FROM PIM01106 A (NOLOCK) 
		JOIN PID01106 B (NOLOCK) ON A.MRR_ID = B.MRR_ID 
		JOIN #TMPPURCHALLAN C ON C.MRR_ID=A.MRR_ID
		GROUP BY A.MRR_ID
	)B ON D.PS_ID = B.MRR_ID AND D.TOTAL_QTY = B.TOTAL_QTY 
	ORDER BY D.AC_NAME
   --------------
	
	GOTO END_PROC   

LBLDET:   

	DECLARE @CCMD NVARCHAR(MAX)
	IF OBJECT_ID('#MRRLIST','U') IS NOT NULL
		DROP TABLE #MRRLIST
	
	SELECT MRR_ID INTO #MRRLIST FROM PIM01106 WHERE 1=2
	
	SET @CCMD=N' SELECT MRR_ID FROM PIM01106 WHERE MRR_ID IN ('+ @CWHERECLAUSE +')'
	
	INSERT #MRRLIST
	EXEC SP_EXECUTESQL @CCMD
		
	IF OBJECT_ID('TEMPDB..#TMP','U') IS NOT NULL
        DROP TABLE #TMP
        
    SELECT CAST(0 AS BIT) AS BILLCHECK  
     ,W1.*,W1.MRR_ID AS PSID ,W2.INV_NO AS PS_NO  ,W2.INV_NO
	 ,W2.INV_DT AS PS_DT ,W2.INV_DT,W2.RECEIPT_DT ,W2.INV_DT AS VANDOR_BILL_DT
	 ,A.ARTICLE_CODE AS SKU_ARTICLE_CODE 
	 ,B.ARTICLE_NO ,B.ARTICLE_NAME  
	 ,C.PARA1_NAME,D.PARA2_NAME ,F.PARA3_NAME,PARA4_NAME ,PARA5_NAME,PARA6_NAME  
	 ,E.UOM_NAME,E.UOM_TYPE,B.UOM_CODE
	 ,B.CODING_SCHEME,A.PURCHASE_PRICE AS SKU_PURCHASE_PRICE,ISNULL(A.FIX_MRP,0) AS SKU_FIX_MRP,A.MRP AS SKU_MRP,
	 A.WS_PRICE,A.WS_PRICE AS SKU_WHOLESALE_PRICE
	 ,SM.SECTION_NAME,SD.SUB_SECTION_NAME,B.STOCK_NA  
	 ,F1.FORM_NAME,F1.TAX_PERCENTAGE AS FORM_TAX_PERCENTAGE,A.PRODUCT_NAME 
	 ,ISNULL(E.UOM_TYPE,0) AS [UOM_UOM_TYPE]  
	 ,ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED]  
	 ,F.DT_CREATED AS [PARA3_DT_CREATED]  
	 ,A.DT_CREATED AS [SKU_DT_CREATED],B.ALIAS AS ARTICLE_ALIAS 
	 ,W1.PURCHASE_PRICE * W1.INVOICE_QUANTITY	AS AMOUNT 
	 ,CONVERT(NUMERIC(10,2),ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)) AS SKU_DISCOUNT_AMOUNT
	 ,((CONVERT(NUMERIC(10,2),ISNULL(SKU_OH.DISCOUNT_AMOUNT,0))* 100)/ (CASE WHEN ISNULL(W1.GROSS_PURCHASE_PRICE,0)=0 THEN 1 ELSE W1.GROSS_PURCHASE_PRICE END) ) AS SKU_DISCOUNT_PERCENTAGE
	 INTO #TMP
	 FROM PID01106  W1 (NOLOCK)   
	 JOIN PIM01106 W2 (NOLOCK) ON W1.MRR_ID= W2.MRR_ID 
	 JOIN SKU A       (NOLOCK) ON A.PRODUCT_CODE=W1.PRODUCT_CODE        
	 JOIN ARTICLE B   (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE            
	 JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE          
	 JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE          
	 JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE            
	 JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE            
	 JOIN PARA3 F (NOLOCK) ON A.PARA3_CODE = F.PARA3_CODE            
	 JOIN PARA4 G (NOLOCK) ON A.PARA4_CODE = G.PARA4_CODE            
	 JOIN PARA5 H (NOLOCK) ON A.PARA5_CODE = H.PARA5_CODE            
	 JOIN PARA6 I (NOLOCK) ON A.PARA6_CODE = I.PARA6_CODE   
	 LEFT OUTER JOIN UOM E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE       
	 JOIN FORM F1 (NOLOCK) ON W1.FORM_ID = F1.FORM_ID  
	 LEFT OUTER JOIN SKU_OH(NOLOCK) ON SKU_OH.PRODUCT_CODE=A.PRODUCT_CODE  
	 JOIN #MRRLIST L ON L.MRR_ID=W2.MRR_ID
     
     
     
     UPDATE #TMP SET DISCOUNT_AMOUNT=(SKU_DISCOUNT_AMOUNT*quantity), DISCOUNT_PERCENTAGE=SKU_DISCOUNT_PERCENTAGE,
     PURCHASE_PRICE=GROSS_PURCHASE_PRICE-SKU_DISCOUNT_AMOUNT,ref_mrr_id=mrr_id
     
     SELECT PSID as PS_Id, * FROM #TMP
    	
	GOTO END_PROC

LBLADJUSTEDMRRS:
	SELECT MRR_NO,MRR_DT,RECEIPT_DT,TOTAL_AMOUNT,INV_NO,MRR_ID FROM PIM01106 (NOLOCK)
	WHERE REF_CONVERTED_MRNTOBILL_MRRID=@CWHERECLAUSE
	
	
	GOTO END_PROC
END_PROC:
	
END


