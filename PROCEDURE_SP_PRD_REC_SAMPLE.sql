CREATE PROCEDURE  SP_PRD_REC_SAMPLE  
(  
 @NQUERYID INT,  
 @CAGENCY_CODE VARCHAR(10)='',  
 @CMEMO_ID VARCHAR (100)='' ,
 @CISSUE_MEMO_ID VARCHAR (100)='' ,
 @CWHERE VARCHAR(1000)=''
)  
AS  
BEGIN  
  
IF @NQUERYID=1  
   GOTO LBLMST  
ELSE IF @NQUERYID=2  
   GOTO LBLDET  
ELSE IF @NQUERYID=3  
 GOTO LBLLOOKUP
LBLMST:  
       
     DECLARE @CCMD NVARCHAR(MAX)
     SELECT BIN_ID,MEMO_ID,MEMO_NO,  
            MEMO_DT,A.AGENCY_CODE,LAST_UPDATE,  
            CANCELLED,  
            USER_CODE,  
            FIN_YEAR,  
            A.REMARKS,
            DEPARTMENT_ID ,
            B.AGENCY_NAME 
     FROM PRD_AGENCY_MATERIAL_RECEIPT_MST_SAMPLE A
     JOIN PRD_AGENCY_MST B ON A.AGENCY_CODE=B.AGENCY_CODE   
     WHERE MEMO_ID=@CMEMO_ID  
GOTO END_PROC  
  
LBLDET:  
       
 IF @CMEMO_ID IN('LATER','')
 BEGIN
	 SELECT E.MEMO_NO AS ISSUE_MEMO_NO,E.MEMO_DT AS ISSUE_MEMO_DT,  
		 CAST(0 AS BIT) AS CHK, CAST('LATER' AS VARCHAR(40)) AS MEMO_ID,   
		 A.ROW_ID AS ISSUE_ROW_ID,A.QUANTITY-ISNULL(C.QUANTITY,0) AS QUANTITY,  
		 CAST('LATER'+CAST(NEWID() AS VARCHAR(40)) AS VARCHAR(40)) AS ROW_ID,  
		 CAST('' AS  VARCHAR(1000)) AS REMARKS,PRODUCT_CODE,PRODUCT_UID,
		 CAST('' AS  VARCHAR(1000)) AS EMP_CODE  
	 FROM [PRD_AGENCY_ISSUE_MATERIAL_DET_SAMPLE] A  
	 JOIN [PRD_AGENCY_ISSUE_MATERIAL_MST_SAMPLE] B ON A.MEMO_ID=B.MEMO_ID  
	 JOIN PRD_AGENCY_ISSUE_MATERIAL_MST E ON E.MEMO_ID=B.REF_ISSUE_ID  
	 LEFT OUTER JOIN  
	 (  
		SELECT ISSUE_ROW_ID,SUM(A.QUANTITY) AS QUANTITY FROM PRD_AGENCY_MATERIAL_RECEIPT_DET_SAMPLE A  
		JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST_SAMPLE B ON A.MEMO_ID=B.MEMO_ID  
		WHERE B.CANCELLED=0  
		GROUP BY ISSUE_ROW_ID  
	 ) C ON A.ROW_ID=C.ISSUE_ROW_ID  
	 WHERE A.QUANTITY-ISNULL(C.QUANTITY,0)>0 AND E.CANCELLED=0  
	 AND  B.CANCELLED=0 AND E.REF_AGENCY_CODE=@CAGENCY_CODE  
	 AND (@CISSUE_MEMO_ID='' OR E.MEMO_ID=@CISSUE_MEMO_ID)
 END    
 ELSE
 BEGIN
 
      SELECT F.MEMO_NO AS ISSUE_MEMO_NO,F.MEMO_DT AS ISSUE_MEMO_DT,  
		 CAST(0 AS BIT) AS CHK,A. MEMO_ID,   
		 E.ROW_ID AS ISSUE_ROW_ID,A.QUANTITY AS QUANTITY,  
		 A. ROW_ID,  
		 A. REMARKS,E.PRODUCT_CODE,A.PRODUCT_UID,
		 A. EMP_CODE   
	  FROM 
	  PRD_AGENCY_MATERIAL_RECEIPT_DET_SAMPLE A  
	  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST_SAMPLE B ON A.MEMO_ID=B.MEMO_ID  
	  JOIN [PRD_AGENCY_ISSUE_MATERIAL_DET_SAMPLE] E ON E.ROW_ID=A.ISSUE_ROW_ID
	  JOIN [PRD_AGENCY_ISSUE_MATERIAL_MST_SAMPLE] F ON E.MEMO_ID =F.MEMO_ID
	  WHERE B.MEMO_ID=@CMEMO_ID
	  

 END
     
GOTO END_PROC  
LBLLOOKUP:                      
  SET @CCMD=N'SELECT * FROM PRD_AGENCY_MATERIAL_RECEIPT_MST_SAMPLE (NOLOCK) '+@CWHERE + ' ORDER BY MEMO_DT,MEMO_NO'           
  PRINT @CCMD        
  EXEC SP_EXECUTESQL @CCMD        
GOTO END_PROC  
         
          
  
  
END_PROC:  
END
