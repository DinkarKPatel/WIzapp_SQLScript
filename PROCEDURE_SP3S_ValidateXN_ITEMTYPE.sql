CREATE PROCEDURE SP3S_VALIDATEXN_ITEMTYPE
(
 @CTEMPMASTERTABLE VARCHAR(500),
 @CTEMPDETAILTABLE VARCHAR(500),
 @CWHERECLAUSE VARCHAR(1000)='',
 @CERRORMSG VARCHAR(MAX) OUTPUT
)
AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@NITEMTYPE NUMERIC(1,0),@CTEXT VARCHAR(100),@NOTHSECTIONTYPE NUMERIC(1,0),
	@COTHITEMTEXT VARCHAR(500),@NSECTIONTYPE NUMERIC(1,0),@CJOINSTR VARCHAR(300),@cChkItemType VARCHAR(50),
	@cStep VARCHAR(10),@nSpId VARCHAR(40)
		
	SET @CERRORMSG=''
	
	
	
	SET @NITEMTYPE=0
	
	SET @nSpId=@@spId

	IF @CTEMPMASTERTABLE='SLS_CMM01106_UPLOAD'
	BEGIN
		SET @cCmd=N'SELECT TOP 1 @NsPiD=SP_ID from '+@CTEMPMASTERTABLE+' (NOLOCK) where 1=1'+@cWhereClause
		EXEC SP_EXECUTESQL @cCmd,N'@nSpId varchar(40) output',@nSpId OUTPUT
	END

	SET @CSTEP='V-20.1'
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@NSPID,1	

	IF @CTEMPMASTERTABLE LIKE '%CNM01106%'
	BEGIN
		SET @CCMD=N'SELECT TOP 1 @NITEMTYPE=1 FROM '+@CTEMPMASTERTABLE+' WHERE CN_TYPE=2 AND MODE=1 '+@CWHERECLAUSE
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD,N'@NITEMTYPE NUMERIC(1,0) OUTPUT',@NITEMTYPE OUTPUT
		IF @NITEMTYPE=1
		   GOTO END_PROC
	END
	
	SET @CCMD=N'UPDATE '+@CTEMPMASTERTABLE+' SET XN_ITEM_TYPE=1 WHERE ISNULL(XN_ITEM_TYPE,0)=0 '+@CWHERECLAUSE
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD

	SET @CSTEP='V-20.3'
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@NSPID,1	

	SET @CCMD=N'SELECT TOP 1 @NITEMTYPE=XN_ITEM_TYPE FROM '+@CTEMPMASTERTABLE+' WHERE 1=1 '+@CWHERECLAUSE
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD,N'@NITEMTYPE NUMERIC(1,0) OUTPUT',@NITEMTYPE OUTPUT

	if @NITEMTYPE=5
	set @NITEMTYPE=1
	
		SET @CSTEP='V-20.5'
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@NSPID,1	

	--SELECT @NITEMTYPE AS NITEMTYPE
	IF @CTEMPMASTERTABLE='APR_APPROVAL_RETURN_MST_UPLOAD'
	BEGIN

		SELECT @CJOINSTR=' LEFT JOIN SKU_NAMES sn (NOLOCK) ON Sn.PRODUCT_CODE=A.APD_PRODUCT_CODE',
					@cChkItemType='ISNULL(sn.sku_item_type,1)'
	     	--SET @CJOINSTR=' JOIN SKU ON SKU.PRODUCT_CODE=A.APD_PRODUCT_CODE
							--JOIN ARTICLE B ON B.ARTICLE_CODE=SKU.ARTICLE_CODE'

	END
	ELSE
	BEGIN
	
		SET @CSTEP='V-20.7'
		EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@NSPID,1	

		IF @CTEMPMASTERTABLE not in('PUR_PIM01106_UPLOAD','PO_POM01106_upload','PQ_PURCHASE_QUOTATION_MASTER_upload')
			SELECT @CJOINSTR=' LEFT JOIN SKU_NAMES sn (NOLOCK) ON Sn.PRODUCT_CODE=A.PRODUCT_CODE',
					@cChkItemType='ISNULL(sn.sku_item_type,1)'
		ELSE
			SELECT @CJOINSTR=' JOIN ARTICLE B (NOLOCK) ON B.ARTICLE_CODE=A.ARTICLE_CODE
							JOIN SECTIOND C (NOLOCK) ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
							JOIN SECTIONM D (NOLOCK) ON D.SECTION_CODE=C.SECTION_CODE',
				   @cChkItemType='d.item_type'
	END
							
	SET @CSTEP='V-20.9'
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@NSPID,1	


							
	SET @CCMD=N'SELECT TOP 1 @NSECTIONTYPE='+@cChkItemType+' FROM '+@CTEMPDETAILTABLE+' A '+@CJOINSTR+'
	WHERE (('+@cChkItemType+'='+LTRIM(RTRIM(STR(@NITEMTYPE)))+') OR ('+@cChkItemType+'=0 AND '+LTRIM(RTRIM(STR(@NITEMTYPE)))+'=1))'+
	@CWHERECLAUSE 
	
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD,N'@NSECTIONTYPE NUMERIC(1,0) OUTPUT',@NSECTIONTYPE OUTPUT
	
	SET @CSTEP='V-20.11'
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@NSPID,1	

	
	SET @CTEXT = (CASE WHEN @NITEMTYPE=1 THEN 'INVENTORY' WHEN @NITEMTYPE=3 THEN 'ASSETS' WHEN @NITEMTYPE=2 THEN 'CONSUMABLES'  ELSE  'SERVICES' END)
		
	IF @NSECTIONTYPE IS NULL 
	BEGIN
		SET @CERRORMSG='NO VALID '+@CTEXT+' ITEM FOUND IN CURRENT MEMO'
		GOTO END_PROC
	END

	SET @CSTEP='V-20.13'
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@NSPID,1	

	SET @CCMD=N'SELECT TOP 1 @NOTHSECTIONTYPE='+@cChkItemType+' FROM '+@CTEMPDETAILTABLE+' A '+@CJOINSTR+'
	WHERE '+@cChkItemType+' NOT IN ('+LTRIM(RTRIM(STR(@NITEMTYPE)))+',2)'+@CWHERECLAUSE
	
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD,N'@NOTHSECTIONTYPE NUMERIC(1,0) OUTPUT',@NOTHSECTIONTYPE OUTPUT
	
	SET @CSTEP='V-20.15'
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@NSPID,1	

	SET @COTHITEMTEXT = (CASE WHEN @NOTHSECTIONTYPE=1 THEN 'INVENTORY' WHEN @NOTHSECTIONTYPE=3 THEN 'ASSETS' WHEN @NOTHSECTIONTYPE=2 THEN 'CONSUMABLES' ELSE 'SERVICES' END)
	
	IF @NOTHSECTIONTYPE<>@NITEMTYPE AND NOT (@NOTHSECTIONTYPE=0 AND @NITEMTYPE=1)  AND @NOTHSECTIONTYPE IS NOT NULL AND NOT (@NOTHSECTIONTYPE=2 AND @CTEMPMASTERTABLE<>'PUR_PIM01106_UPLOAD')
	BEGIN
		SET @CERRORMSG=@COTHITEMTEXT+' TYPE OF ITEMS CANNOT BE MIXED WITH '+@CTEXT+' IN CURRENT MEMO'
		GOTO END_PROC
	END

END_PROC:

END
