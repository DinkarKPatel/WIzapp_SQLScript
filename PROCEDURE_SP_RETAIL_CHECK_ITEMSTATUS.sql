CREATE PROCEDURE SP_RETAIL_CHECK_ITEMSTATUS
(
 @NQID INT,
 @PRODUCT_CODE VARCHAR(100)='',
 @CCUSTOMER_CODE VARCHAR(100)=''
)   
----WITH ENCRYPTION
AS
BEGIN
     IF ISNULL(@PRODUCT_CODE,'')=''
      SET @PRODUCT_CODE='RETURN BLANK ROW'
      
     IF @NQID=1
     BEGIN 
       
       SELECT PRODUCT_CODE='',ORDER_NO='',ORDER_ID='',ORDER_DT=CAST(NULL AS DATETIME),
               CUSTOMER_CODE,CUSTOMER_FNAME,CUSTOMER_LNAME,
               DELIVERY_DT=CAST(NULL AS DATETIME),
               SUPPLIER='',SALES_PERSON='',TRAIL_DT=CAST(NULL AS DATETIME)
              ,MOBILE,USER_CUSTOMER_CODE AS CUSTOMER_ID,REF_NO=''
       FROM CUSTDYM (NOLOCK) WHERE 
       CUSTOMER_CODE=@CCUSTOMER_CODE AND ISNULL(CUSTOMER_CODE,'')<>''
     
     END 
     ELSE
     BEGIN 
     SELECT A.PRODUCT_CODE,
     B.ORDER_NO,B.ORDER_ID,
     --CONVERT(VARCHAR,B.ORDER_DT,105) AS ORDER_DT,
     B.ORDER_DT AS ORDER_DT,
            B.CUSTOMER_CODE ,
            CUSTOMER_FNAME=ISNULL(C.CUSTOMER_FNAME,''),ISNULL(C.CUSTOMER_LNAME,'') AS CUSTOMER_LNAME,
          --  CASE WHEN B.DELIVERY_DT='1900-01-01' THEN '' ELSE 
          B.DELIVERY_DT  AS DELIVERY_DT,
            POM.SUPPLIER ,ISNULL(E.EMP_NAME,'') AS SALES_PERSON,
            B.TRAIL_DT,MOBILE,C.USER_CUSTOMER_CODE AS CUSTOMER_ID,B.REF_NO
     FROM WSL_ORDER_DET A (NOLOCK)
     JOIN WSL_ORDER_MST B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID 
     JOIN CUSTDYM C(NOLOCK) ON C.CUSTOMER_CODE =B.CUSTOMER_CODE 
     LEFT JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE =B.SALE_EMP_CODE
     LEFT JOIN
     (
       SELECT PRODUCT_CODE,POM.AC_CODE,LM.AC_NAME AS SUPPLIER 
       FROM POD01106 POD (NOLOCK) 
       JOIN POM01106 POM (NOLOCK) ON POD.PO_ID=POM.PO_ID
       JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =POM.AC_CODE 
       WHERE POM .CANCELLED =0
     ) POM ON POM.PRODUCT_CODE =A.PRODUCT_CODE
     WHERE A.CANCELLED =0 AND B.CANCELLED =0
     AND @PRODUCT_CODE=A.PRODUCT_CODE
    END  
      
END
