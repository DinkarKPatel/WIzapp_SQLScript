create PROCEDURE SP_MESSAGECENTER  
(        
 @CREPCODE VARCHAR(10),    
 @CDT VARCHAR(200)='',    
 @CWHERE VARCHAR(200)=''    
 )    
-- --WITH ENCRYPTION  
   
 --SMSAGENT", "SALE_DATA_SOURCE" CONFIG OPTION FOR CONSIDERING SALE FROM SLS -1 , WSL-2, BOTH -3  
AS     
BEGIN    
--(dinkar) Replace  left(memoid,2) to Location_code     
IF @CREPCODE='MSC02'      
GOTO MSC02    
ELSE IF @CREPCODE='MSC03'      
GOTO MSC03      
ELSE IF @CREPCODE='MSC04'      
GOTO MSC04  
ELSE IF @CREPCODE='MSC08'      
GOTO MSC08    
ELSE IF @CREPCODE='MSC09'      
GOTO MSC09    
ELSE IF @CREPCODE='MSC10'      
GOTO MSC10    
ELSE IF @CREPCODE='MSC11'      
GOTO MSC11   
ELSE IF @CREPCODE='MSC17'        
GOTO MSC17   
ELSE IF @CREPCODE='MSC55'        
GOTO MSC55   
ELSE IF @CREPCODE='MSC20'        
GOTO MSC20   
ELSE IF @CREPCODE='MSC25'        
GOTO MSC25                 
ELSE IF @CREPCODE='MSC26'        
GOTO MSC26   
ELSE IF @CREPCODE='MSC27'        
GOTO MSC27    
ELSE IF @CREPCODE='MSC28'        
GOTO MSC28   
ELSE IF @CREPCODE='MSC29'        
GOTO MSC29     
ELSE IF @CREPCODE='MSC30'        
GOTO MSC30   
ELSE IF @CREPCODE='MSC31'        
GOTO MSC31     
ELSE IF @CREPCODE='MSC32'        
GOTO MSC32              
ELSE IF @CREPCODE='MSC33'        
GOTO MSC33      
ELSE IF @CREPCODE='MSC34'        
GOTO MSC34    
ELSE IF @CREPCODE='MSC35'        
GOTO MSC35     
ELSE IF @CREPCODE IN ('MSC36'   ,'MSCFIX0036')     
GOTO MSC36    
ELSE IF @CREPCODE  IN ('MSC37'   ,'MSCFIX0037')   
GOTO MSC37    
ELSE IF @CREPCODE IN  ('MSC38'   ,'MSCFIX0038')       
GOTO MSC38    
ELSE IF @CREPCODE  IN ('MSC39'   ,'MSCFIX0039')   
GOTO MSC39  
ELSE IF @CREPCODE  IN ('MSC40'   ,'MSCFIX0040')   
GOTO MSC40   
ELSE IF @CREPCODE  IN ('MSC41'   ,'MSCFIX0041')           
GOTO MSC41   
  
  
MSC02:                     
   
   
          
  SELECT 'PRT' AS XN_TYPE, A.RM_ID AS UNQ_ID,     
  A.RM_NO, A.RM_DT AS RM_DATE, A.RM_ID, A.TOTAL_AMOUNT AS RM_AMOUNT,     
  C.QUANTITY,      
  B.AC_NAME AS NAME, B.E_MAIL AS EMAIL, B.MOBILE,  
  B.AREA_NAME ,B.CITY AS CITY_NAME ,B.STATE AS STATE_NAME  ,  
  PM.BILTY_NO  AS LR_NO, PM.RECEIPT_DT AS LR_DATE, L.ANGADIA_NAME AS TRANSPORTER  ,B.AC_NAME
  ,B.E_MAIL_CC AS EMAIL_CC
  FROM RMM01106 A (NOLOCK)      
  JOIN LMV01106 B (NOLOCK)  ON A.AC_CODE = B.AC_CODE     
  JOIN PARCEL_DET PB (NOLOCK) ON A.RM_ID = PB.REF_MEMO_ID  
  JOIN  PARCEL_MST PM (NOLOCK) ON PB.PARCEL_MEMO_ID = PM.PARCEL_MEMO_ID  
  JOIN LOCATION LOC ON a.location_Code = LOC.Dept_id  
  AND PM.XN_TYPE= 'PRT'    
  JOIN ANGM L ON PM.ANGADIA_CODE = L.ANGADIA_CODE   
  JOIN     
  (     
  SELECT RM_ID, SUM(QUANTITY) AS QUANTITY FROM RMD01106 (NOLOCK)  GROUP BY RM_ID     
  ) C ON A.RM_ID = C.RM_ID     
  
  LEFT OUTER JOIN  
  (     
    SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SMS_CUTOFF_DATE'  
  ) D ON 1=1  
    
   LEFT OUTER JOIN  
  (     
    SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION like '%DONOT_ENFORCE_EINV%'  
  ) E ON 1=1  
    
  WHERE ISNULL(A.SMS_SENT, 0) = 0 AND  A.RM_DT > ISNULL(D.VALUE,GETDATE())  
  and (ISNULL(A.ACH_NO,'') <> '' or ISNULL(LOC.Enable_EInvoice,0) = 0 or E.value =1)  
   
 GOTO LAST    
        
    
MSC03:     
      
select vm_id into #tmpVm from vm01106  c (NOLOCK)  
LEFT OUTER JOIN ANGM ANGM (NOLOCK)  ON C.ANGADIA_CODE = ANGM.ANGADIA_CODE   
LEFT OUTER JOIN  
(   
SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SMS_CUTOFF_DATE'  
) D ON 1=1  
WHERE C.VOUCHER_CODE = '0000000002'  AND ANGM.ANGADIA_CODE <> '0000000' AND   
C.CANCELLED = 0  AND ISNULL(C.sms_sent ,0)=0   
and c.VOUCHER_DT >= ISNULL(D.VALUE,GETDATE())   
  
SELECT DISTINCT 'ACT' AS XN_TYPE, VD.VD_ID AS UNQ_ID, X.NARRATION, X.CHQ_NO, X.CHQ_DT, CAST((VD.DEBIT_AMOUNT + VD.CREDIT_AMOUNT) AS NUMERIC(14,2)) AS CHQ_AMOUNT, X.BANK_NAME,     
VM.LR_NO AS LR_NO, VM.LR_DT AS LR_DATE, ISNULL(ANGM.ANGADIA_NAME,'') AS TRANSPORTER,     
LM.AC_NAME AS AC_NAME, ISNULL(LM.E_MAIL,'') AS EMAIL, ISNULL(LM.MOBILE,'') AS MOBILE,  
LM.AREA_NAME ,LM.CITY AS CITY_NAME ,LM.STATE AS STATE_NAME ,LM.AC_NAME AS NAME ,  
VM.EBILLS_TINYURL ,LM.WhatsApp_no ,VM.VOUCHER_NO AS XN_NO   ,LM.E_MAIL_CC AS EMAIL_CC
FROM     
VM01106 VM (NOLOCK)    
left join  
(     
 SELECT A.VM_ID, A.NARRATION,  DBO.FN_ACT_GETREVERSEVD(A.VD_ID) AS REVERSE_VD_ID,  
 ISNULL(B.CHQ_LEAF_NO,A.online_chq_ref_no) AS CHQ_NO, C.VOUCHER_DT AS CHQ_DT,(CASE WHEN E.AC_NAME IS NULL THEN 'Online' ELSE E.AC_NAME END) AS BANK_NAME,      
 CAST((A.DEBIT_AMOUNT + A.CREDIT_AMOUNT) AS NUMERIC(14,2)) AS CHQ_AMOUNT     
 FROM VD01106 A (NOLOCK)      
 join VM01106 C (NOLOCK)  ON A.VM_ID = C.VM_ID     
 JOIN #tmpVm vm (NOLOCK) ON vm.vm_id=c.vm_id  
 LEFT OUTER JOIN VD_CHQBOOK D (NOLOCK) ON D.VD_ID=a.vd_id  
 LEFT OUTER JOIN CHQBOOK_D B (NOLOCK)  ON D.CHQBOOK_ROW_ID = B.ROW_ID     
 LEFT JOIN LM01106 E (NOLOCK)  ON A.AC_CODE = E.AC_CODE  
 where isnull(B.chq_leaf_no,A.online_chq_ref_no)   <> ''  
) X   ON X.VM_ID = VM.VM_ID     
JOIN VD01106 VD (NOLOCK)  ON VM.VM_ID = VD.VM_ID   
JOIN LMV01106 LM (NOLOCK)  ON VD.AC_CODE = LM.AC_CODE     
JOIN ANGM ANGM (NOLOCK)  ON VM.ANGADIA_CODE = ANGM.ANGADIA_CODE     
JOIN #tmpVm tmpvm (NOLOCK) ON tmpvm.vm_id=vm.vm_id  
WHERE  (LM.MOBILE <>''  or LM.E_MAIL  <> '') and vd.debit_amount<>0  
  
  
GOTO LAST    
    
MSC04:     
  
   
   
    
 SELECT   'DSLS' AS XN_TYPE, LOC_ID ,  LOC_ID AS UNQ_ID ,   
 ISNULL(SUM(SALES_AMOUNT),0) AS SALES_AMOUNT,  
 ISNULL(SUM(CASH_AMOUNT),0) AS CASH_AMOUNT,  
 ISNULL(SUM(CC_AMOUNT),0) AS CC_AMOUNT,   
 ISNULL(SUM(CREDIT_AMOUNT),0) AS CREDIT_AMOUNT ,      
 ISNULL(SUM(SALES_QTY),0) AS SALES_QTY ,  @CDT AS TO_DT,  
 '' AS AREA_NAME ,'' AS CITY_NAME ,'' AS STATE_NAME ,L.DEPT_ALIAS AS LOC_ALIAS   
 FROM   
 (  
  SELECT a.location_Code  AS LOC_ID,    
  ISNULL(SUM(B.RFNET),0) AS SALES_AMOUNT,       
  ISNULL(SUM(QUANTITY),0) AS SALES_QTY ,  
  ISNULL(SUM(C.CASH_AMOUNT),0) AS CASH_AMOUNT ,  
  ISNULL(SUM(C.CC_AMOUNT),0) AS CC_AMOUNT ,  
  ISNULL(SUM(C.CREDIT_AMOUNT),0) AS CREDIT_AMOUNT      
  FROM CMM01106 A (NOLOCK)      
  LEFT OUTER JOIN   
  (  
   SELECT A.CM_ID,SUM(A.RFNET) AS RFNET,SUM(A.QUANTITY) AS QUANTITY   
   FROM CMD01106 A (NOLOCK)  
   JOIN CMM01106 B (NOLOCK) ON A.CM_ID= B.CM_ID  
   LEFT OUTER JOIN  SKU_BO (NOLOCK) C ON A.PRODUCT_CODE= C.PRODUCT_CODE  
   WHERE C.PRODUCT_CODE IS NULL AND B.CANCELLED=0   AND B.CM_DT = @CDT    
   GROUP BY A.CM_ID  
  ) B ON A.CM_ID =B.CM_ID   
    
  LEFT OUTER JOIN  VW_BILL_PAYMODE C (NOLOCK) ON A.CM_ID= C.MEMO_ID  AND C.XN_TYPE= 'SLS'    
  WHERE A.CANCELLED = 0 AND  CM_MODE=1 AND CM_DT = @CDT    
  GROUP BY a.location_Code   
  
  UNION ALL  
  
  SELECT  a.location_Code  AS LOC_ID ,    
  ISNULL(SUM(B.RFNET),0) AS SALES_AMOUNT,       
  ISNULL(SUM(QUANTITY),0) AS SALES_QTY,   
  0 AS CASH_AMOUNT ,  
  0 AS CC_AMOUNT ,  
  0 AS CREDIT_AMOUNT   
  FROM WSL_ORDER_MST A (NOLOCK)  
  
  JOIN     
  (   
   SELECT ORDER_ID ,SUM(QUANTITY) AS QUANTITY,SUM(RFNET) AS RFNET FROM  WSL_ORDER_DET (NOLOCK)    
   GROUP BY ORDER_ID    
  )B ON A.ORDER_ID= B.ORDER_ID  
  
  WHERE A.CANCELLED = 0 AND A.APPROVED=1 AND ORDER_DT  = @CDT     
  GROUP BY  a.location_Code 
  
  UNION ALL  
  
  SELECT  a.location_Code  AS LOC_ID ,    
  0 AS SALES_AMOUNT,       
  0 AS SALES_QTY,   
  ISNULL(SUM(C.CASH_AMOUNT),0) AS CASH_AMOUNT ,  
  ISNULL(SUM(C.CC_AMOUNT),0) AS CC_AMOUNT ,  
  ISNULL(SUM(C.CREDIT_AMOUNT),0) AS CREDIT_AMOUNT   
  FROM ARC01106 A (NOLOCK)  
  LEFT OUTER JOIN  VW_BILL_PAYMODE C (NOLOCK) ON A.ADV_REC_ID= C.MEMO_ID  AND C.XN_TYPE= 'ARC'   
  WHERE A.CANCELLED = 0 AND A.ADV_REC_DT = @CDT    
  GROUP BY a.location_Code    
 ) A   
 JOIN DAYENDLOG LOC ON A.LOC_ID = LOC.DEPT_ID  
 JOIN location L on A.LOC_ID = L.dept_id   
 WHERE CONVERT(VARCHAR(10),LOC.LAST_UPDATE,126)= @CDT   
 GROUP BY LOC_ID,L.DEPT_ALIAS  
  
    
  
GOTO LAST        
          
    
MSC08:           
  
 IF OBJECT_ID('TEMPDB..#TEMP','U') IS NOT NULL    
 DROP TABLE #TEMP                                   
  
  
 SELECT 'WSL' AS XN_TYPE, A.INV_ID AS UNQ_ID,      
 A.INV_NO, A.INV_DT, A.NET_AMOUNT AS INV_AMOUNT,     
 C.QUANTITY,     
 PM.BILTY_NO  AS LR_NO, PM.RECEIPT_DT AS LR_DATE, A.THROUGH AS TRANSPORTER,   
 B.AC_NAME AS NAME, B.E_MAIL AS EMAIL, B.MOBILE,  
 B.AREA_NAME ,B.CITY AS CITY_NAME ,B.STATE AS STATE_NAME  ,B.E_MAIL_CC AS EMAIL_CC
 INTO #TEMP  
 FROM INM01106 A   (NOLOCK)    
 JOIN LOCATION L ON a.location_Code = L.Dept_id  
 JOIN LMV01106 B  (NOLOCK) ON A.AC_CODE = B.AC_CODE   
 JOIN PARCEL_DET PB (NOLOCK) ON A.INV_ID = PB.REF_MEMO_ID  
 JOIN  PARCEL_MST PM (NOLOCK) ON PB.PARCEL_MEMO_ID = PM.PARCEL_MEMO_ID   AND PM.XN_TYPE= 'WSL'     
 JOIN      
 (     
 SELECT INV_ID, SUM(QUANTITY) AS QUANTITY FROM IND01106  (NOLOCK) GROUP BY INV_ID     
 ) C ON A.INV_ID = C.INV_ID     
 LEFT OUTER JOIN  
 (   
  SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SMS_CUTOFF_DATE'  
 ) D ON 1=1  
  
 WHERE  ISNULL(A.SMS_SENT,0) = 0   AND  A.INV_DT > ISNULL(D.VALUE,GETDATE())  
 and (ISNULL(A.ACH_NO,'') <> '' or ISNULL(L.Enable_EInvoice,0) = 0)  
  
  
 SELECT  XN_TYPE,UNQ_ID, INV_NO,  INV_DT, INV_AMOUNT,QUANTITY,     
 LR_NO, LR_DATE, TRANSPORTER, NAME,  EMAIL, MOBILE,  
 AREA_NAME, CITY_NAME,STATE_NAME     
 FROM #TEMP    
 UNION ALL    
 SELECT XN_TYPE,UNQ_ID, INV_NO,  INV_DT, INV_AMOUNT,QUANTITY,     
 LR_NO, LR_DATE, TRANSPORTER, B.CONTACT_NAME AS NAME,  B.EMAIL, B.MOBILE,  
 '' AS AREA_NAME,'' AS  CITY_NAME,'' AS STATE_NAME   
 FROM #TEMP A,RECEIPIANT_MST B WHERE B.REP_ID= 'MSCFIX0008'     
  
  
 GOTO LAST    
           
    
    
MSC09:    
 SELECT 'ANV' AS XN_TYPE, a.CUSTOMER_CODE,(a.CUSTOMER_FNAME) AS NAME ,    
 a.MOBILE,a.EMAIL,GETDATE() AS SENT_ON,'' AS GV_NO ,  
 b.AREA_NAME AS AREA_NAME,c.CITY AS CITY_NAME,d.STATE AS STATE_NAME   
 FROM custdym a (NOLOCK)     
 JOIN AREA B ON A.AREA_CODE = B.AREA_CODE     
 JOIN CITY C ON B.CITY_CODE = C.CITY_CODE     
 JOIN STATE D ON C.STATE_CODE = D.STATE_CODE   
 WHERE (MONTH(a.DT_ANNIVERSARY)= MONTH(GETDATE()) AND DAY(a.DT_ANNIVERSARY)= DAY(GETDATE()))    
 AND a.CUSTOMER_CODE <> '000000000000' AND a.MOBILE <> '' AND ISNULL(DT_ANNIVERSARY ,'') <> ''    
 ORDER BY a.CUSTOMER_CODE,a.MOBILE,a.EMAIL    
  
 GOTO LAST    
    
MSC10:                           
 SELECT 'BDAY' AS XN_TYPE, a.CUSTOMER_CODE,(a.CUSTOMER_FNAME) AS NAME ,    
 a.MOBILE,a.EMAIL,GETDATE() AS SENT_ON,'' AS GV_NO,  
 b.AREA_NAME AS AREA_NAME,c.CITY AS CITY_NAME,d.STATE AS STATE_NAME     
 FROM custdym a (NOLOCK)     
 JOIN AREA B ON A.AREA_CODE = B.AREA_CODE     
 JOIN CITY C ON B.CITY_CODE = C.CITY_CODE     
 JOIN STATE D ON C.STATE_CODE = D.STATE_CODE    
 WHERE (MONTH(a.DT_BIRTH)= MONTH(GETDATE()) AND DAY(a.DT_BIRTH)= DAY(GETDATE()))    
 AND a.CUSTOMER_CODE <> '000000000000' AND a.MOBILE <> '' AND ISNULL(DT_BIRTH,'') <> ''     
 ORDER BY a.CUSTOMER_CODE, a.MOBILE,a.EMAIL    
  
 GOTO LAST    
    
MSC11:                             
 SELECT 'CUST' AS XN_TYPE, '' AS NAME     
 GOTO LAST     
  
    
  
MSC55:     
  
   
  
  
   IF OBJECT_ID('TEMPDB..#TEMPCM','U') IS NOT NULL      
 DROP TABLE #TEMPCM     
  
  
 DECLARE @IMIN INT,@dServerDt DATETIME        
  
 SET @IMIN=0        
 SELECT @IMIN= N_MINUTES FROM REP_SCH WHERE REP_ID = 'MSCFIX0055' AND REP_TYPE= 'MSC'        
  
 SELECT @dServerDt=VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SERVER_DT'  
   
 SELECT 'SALE' AS XN_TYPE, A.CM_ID AS UNQ_ID, A.CUSTOMER_CODE , B.USER_CUSTOMER_CODE,        
 ( B.CUSTOMER_FNAME + ''+ B.CUSTOMER_LNAME) AS NAME,    
 (CASE WHEN B.MOBILE='' THEN  B.USER_CUSTOMER_CODE ELSE B.MOBILE END) AS MOBILE, B.EMAIL ,        
 GETDATE() AS SENT_ON,ar.AREA_NAME AS AREA_NAME,c.CITY AS CITY_NAME,d.STATE AS STATE_NAME,    
 A.CM_NO,A.CM_DT ,a.location_Code  AS LOC_ID,A.NET_AMOUNT AS AMOUNT,Z.CmmDiscount  AS DISCOUNT, 
 --A.DISCOUNT_AMOUNT  AS DISCOUNT,   
 ISNULL(X.CASH_RCVD,0.00) AS CASH_RCVD,  
 ISNULL(X.CN_ADJUSTED,0.00) AS CN_ADJUSTED,  
 ISNULL(X.ADVANCE_ADJUSTED,0.00) AS ADVANCE_ADJUSTED,  
 '' AS BANK_CHQ,  
 ISNULL(X.CREDIT_ISSUED,0.00) AS CREDIT_ISSUED,  
 ISNULL(X.CC_AMOUNT,0.00) AS CC_AMOUNT,  
 ISNULL(Y.ORDER_REF_NO,'') AS ORDER_REF_NO ,ISNULL(Y.ORDER_NO,'') AS ORDER_NO,A.EBILLS_TINYURL   
 INTO #TEMPCM  
 FROM CMM01106 A   (NOLOCK)     
 JOIN custdym B (NOLOCK) ON A.CUSTOMER_CODE = B.CUSTOMER_CODE    
 JOIN AREA ar ON Ar.AREA_CODE = B.AREA_CODE     
 JOIN CITY C ON c.CITY_CODE = ar.CITY_CODE     
 JOIN STATE D ON C.STATE_CODE = D.STATE_CODE   
 LEFT OUTER JOIN   
 (  
  SELECT memo_id cm_id,sum(case when a.paymode_code='0000001' THEN amount ELSE 0 END) CN_ADJUSTED,  
  sum(case when a.paymode_code='0000004' THEN amount ELSE 0 END) CREDIT_ISSUED,  
  sum(case when a.paymode_code='0000002' THEN amount ELSE 0 END) ADVANCE_ADJUSTED,  
  sum(case when paymode_grp_code='0000001' THEN amount ELSE 0 END) CASH_RCVD,  
  sum(case when paymode_grp_code='0000002' THEN amount ELSE 0 END) CC_AMOUNT  
  FROM paymode_xn_det a (NOLOCK)  
  JOIN cmm01106 b (NOLOCK) ON a.memo_id=b.cm_id  
  JOIN paymode_mst c (NOLOCK) ON c.paymode_code=a.paymode_code  
  WHERE cm_dt=@dServerDt AND xn_type='SLS'  
  group by memo_id  
 )  X  ON A.CM_ID= X.cm_id  
  
      LEFT OUTER JOIN   
   (  
  SELECT   D.CM_ID,B.CUSTOMER_CODE, B.REF_NO AS ORDER_REF_NO ,B.ORDER_NO,  
           SR=ROW_NUMBER () OVER (PARTITION BY C.CM_ID ORDER BY C.CM_ID)   
  FROM  WSL_ORDER_MST B (NOLOCK)    
  JOIN CMD01106 C (NOLOCK) ON B.ORDER_ID = C.REF_ORDER_ID   
  JOIN CMM01106 D (NOLOCK) ON C.CM_ID = D.CM_ID   
  WHERE D.CANCELLED=0 AND D.SMS_SENT =0 AND B.CANCELLED=0   
   ) Y  ON  A.CM_ID= Y.CM_ID AND SR=1  

  LEFT OUTER JOIN   
   (  
	  SELECT   D.CM_ID, SUM(C.discount_amount+C.cmm_discount_amount) AS CmmDiscount
	  FROM     CMD01106 C (NOLOCK) 
	  JOIN CMM01106 D (NOLOCK) ON C.CM_ID = D.CM_ID   
	  WHERE D.CANCELLED=0 AND D.SMS_SENT =0 AND D.CANCELLED=0  AND   D.CUSTOMER_CODE <> '000000000000'
	  Group by D.CM_ID
   ) Z  ON  A.CM_ID= Z.CM_ID  
     
     
 WHERE A.CUSTOMER_CODE <> '000000000000'  AND  A.CM_DT = @dServerDt  
 --AND ABS(DATEDIFF(MINUTE,A.CM_TIME, GETDATE()))>@IMIN        
 AND A.SMS_SENT = 0  AND (B.MOBILE<>'' OR B.EMAIL<>'' OR B.USER_CUSTOMER_CODE <> '')      
  
  
 SELECT  XN_TYPE, UNQ_ID,CUSTOMER_CODE, USER_CUSTOMER_CODE, NAME,  
 MOBILE, EMAIL,SENT_ON, AREA_NAME, CITY_NAME, STATE_NAME, CM_NO, CM_DT, LOC_ID, AMOUNT, DISCOUNT,  
 CASH_RCVD, CN_ADJUSTED, CREDIT_ISSUED, CC_AMOUNT, ADVANCE_ADJUSTED, BANK_CHQ, ORDER_REF_NO,ORDER_NO,EBILLS_TINYURL  
 FROM #TEMPCM      
 UNION ALL      
 SELECT  XN_TYPE, UNQ_ID,'' AS CUSTOMER_CODE, '' AS USER_CUSTOMER_CODE ,B.CONTACT_NAME AS NAME  
 ,B.MOBILE,B.EMAIL,SENT_ON, '' AS AREA_NAME, '' AS CITY_NAME,'' AS STATE_NAME,CM_NO, CM_DT,   
 LOC_ID, AMOUNT, DISCOUNT,  
 CASH_RCVD, CN_ADJUSTED, CREDIT_ISSUED, CC_AMOUNT, ADVANCE_ADJUSTED, BANK_CHQ, ORDER_REF_NO,ORDER_NO,EBILLS_TINYURL  
 FROM #TEMPCM A,RECEIPIANT_MST B WHERE B.REP_ID= 'MSCFIX0055'    
    
      
  
  
  
 GOTO LAST    
   
     
   
MSC17:  
   
  
  
DECLARE @CMODE VARCHAR(10)        
SET @CMODE=1        
SELECT @CMODE= VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION = 'SALE_DATA_SOURCE'      
SET @CMODE= ISNULL(@CMODE,'1')     
  
  
IF @CMODE ='1'  
BEGIN  
  
 SELECT 'SALE' AS XN_TYPE,@CDT AS CM_DT ,a.location_Code  AS LOC_ID, a.location_Code  AS DEPT_ID,  
 COUNT(A.CM_NO) AS BILL_COUNT,    
 CAST(ISNULL(SUM(B.RFNET),0) AS NUMERIC(10,0)) AS SALES_AMOUNT,             
 CAST(ISNULL(SUM(QUANTITY),0)AS NUMERIC(10,0)) AS SALES_QTY ,    
 CAST((CASE WHEN COUNT(A.CM_NO)>0 THEN SUM(B.RFNET)/COUNT(A.CM_NO) ELSE 0 END)AS NUMERIC(10,0)) AS AVG_SALE,  
 '' AS AREA_NAME ,'' AS  CITY_NAME,'' AS  STATE_NAME,   
 ISNULL(SUM(D.CASH_AMOUNT),0) AS CASH_AMOUNT ,  
 ISNULL(SUM(D.CC_AMOUNT),0) AS CC_AMOUNT ,  
 ISNULL(SUM(D.CREDIT_AMOUNT),0) AS CREDIT_AMOUNT ,L.DEPT_ALIAS AS LOC_ALIAS     
 FROM CMM01106 A (NOLOCK)      
 JOIN   
 (  
  SELECT CM_ID,SUM(RFNET) AS RFNET,SUM(QUANTITY) AS QUANTITY   
  FROM CMD01106 (NOLOCK) GROUP BY CM_ID  
 ) B ON A.CM_ID =B.CM_ID     
 --JOIN LOC_VIEW C (NOLOCK) ON LEFT(A.CM_id,2)= C.DEPT_ID    
 LEFT OUTER JOIN  VW_BILL_PAYMODE D (NOLOCK) ON A.CM_ID= D.MEMO_ID  AND D.XN_TYPE= 'SLS'    
 JOIN LOCATION L ON a.location_Code = L.dept_id   
 WHERE A.CANCELLED = 0 AND  CM_MODE=1 AND CM_DT = @CDT  
 GROUP BY a.location_Code ,L.DEPT_ALIAS  
  
END  
  
  
IF @CMODE ='2'  
BEGIN  
  
 SELECT 'SALE' AS XN_TYPE,@CDT AS CM_DT ,a.location_Code  AS LOC_ID,  
 COUNT(A.INV_NO) AS BILL_COUNT,    
 CAST(ISNULL(SUM(B.RFNET),0) AS NUMERIC(10,0)) AS SALES_AMOUNT,             
 CAST(ISNULL(SUM(QUANTITY),0)AS NUMERIC(10,0)) AS SALES_QTY ,    
 CAST((CASE WHEN COUNT(A.INV_NO)>0 THEN SUM(B.RFNET)/COUNT(A.INV_NO) ELSE 0 END)AS NUMERIC(10,0)) AS AVG_SALE,  
 '' AS AREA_NAME ,'' AS  CITY_NAME,'' AS  STATE_NAME ,  
 ISNULL(SUM(D.CASH_AMOUNT),0) AS CASH_AMOUNT ,  
 ISNULL(SUM(D.CC_AMOUNT),0) AS CC_AMOUNT ,  
 ISNULL(SUM(D.CREDIT_AMOUNT),0) AS CREDIT_AMOUNT ,L.DEPT_ALIAS AS LOC_ALIAS   
 FROM INM01106 A (NOLOCK)      
 JOIN   
 (  
 SELECT INV_ID,SUM(RFNET) AS RFNET,SUM(QUANTITY) AS QUANTITY   
 FROM IND01106 (NOLOCK) GROUP BY INV_ID  
 ) B ON A.INV_ID =B.INV_ID     
 LEFT OUTER JOIN  VW_BILL_PAYMODE D (NOLOCK) ON A.INV_ID= D.MEMO_ID  AND D.XN_TYPE= 'WSL'    
 JOIN LOCATION L ON a.location_Code = L.dept_id   
 WHERE A.CANCELLED = 0 AND  INV_MODE=1 AND INV_DT = @CDT  
    GROUP BY a.location_Code ,L.DEPT_ALIAS  
      
END  
  
  
IF @CMODE ='3'  
BEGIN  
  
SELECT 'SALE' AS XN_TYPE,@CDT AS CM_DT , LOC_ID,  
COUNT(A.BILL_COUNT) AS BILL_COUNT,    
CAST(ISNULL(SUM(A.SALES_AMOUNT),0) AS NUMERIC(10,0)) AS SALES_AMOUNT,             
CAST(ISNULL(SUM(A.SALES_QTY),0)AS NUMERIC(10,0)) AS SALES_QTY ,    
CAST((CASE WHEN COUNT(A.BILL_COUNT)>0 THEN SUM(A.SALES_AMOUNT)/COUNT(A.BILL_COUNT) ELSE 0 END)AS NUMERIC(10,0)) AS AVG_SALE,  
'' AS AREA_NAME ,'' AS  CITY_NAME,'' AS  STATE_NAME,  
ISNULL(SUM(A.CASH_AMOUNT),0) AS CASH_AMOUNT ,  
ISNULL(SUM(A.CC_AMOUNT),0) AS CC_AMOUNT ,  
ISNULL(SUM(A.CREDIT_AMOUNT),0) AS CREDIT_AMOUNT ,L.DEPT_ALIAS AS LOC_ALIAS       
FROM  
(  
 SELECT 'SALE' AS XN_TYPE,@CDT AS CM_DT ,a.location_Code  AS LOC_ID,  
 COUNT(A.CM_NO) AS BILL_COUNT,    
 CAST(ISNULL(SUM(B.RFNET),0) AS NUMERIC(10,0)) AS SALES_AMOUNT,             
 CAST(ISNULL(SUM(QUANTITY),0)AS NUMERIC(10,0)) AS SALES_QTY ,    
 CAST((CASE WHEN COUNT(A.CM_NO)>0 THEN SUM(B.RFNET)/COUNT(A.CM_NO) ELSE 0 END)AS NUMERIC(10,0)) AS AVG_SALE,  
 '' AS AREA_NAME ,'' AS  CITY_NAME,'' AS  STATE_NAME ,  
 ISNULL(SUM(D.CASH_AMOUNT),0) AS CASH_AMOUNT ,  
 ISNULL(SUM(D.CC_AMOUNT),0) AS CC_AMOUNT ,  
 ISNULL(SUM(D.CREDIT_AMOUNT),0) AS CREDIT_AMOUNT     
    
 FROM CMM01106 A (NOLOCK)      
 JOIN   
 (  
 SELECT CM_ID,SUM(RFNET) AS RFNET,SUM(QUANTITY) AS QUANTITY   
 FROM CMD01106 (NOLOCK) GROUP BY CM_ID  
 ) B ON A.CM_ID =B.CM_ID     
 JOIN LOC_VIEW C (NOLOCK) ON a.location_Code = C.DEPT_ID   
 LEFT OUTER JOIN  VW_BILL_PAYMODE D (NOLOCK) ON A.CM_ID= D.MEMO_ID  AND D.XN_TYPE= 'SLS'    
   
 WHERE A.CANCELLED = 0 AND  CM_MODE=1 AND CM_DT = @CDT  
 GROUP BY a.location_Code   
  
 UNION ALL  
  
 SELECT 'SALE' AS XN_TYPE,@CDT AS CM_DT ,a.location_Code  AS LOC_ID,  
 COUNT(A.INV_NO) AS BILL_COUNT,    
 CAST(ISNULL(SUM(B.RFNET),0) AS NUMERIC(10,0)) AS SALES_AMOUNT,             
 CAST(ISNULL(SUM(QUANTITY),0)AS NUMERIC(10,0)) AS SALES_QTY ,    
 CAST((CASE WHEN COUNT(A.INV_NO)>0 THEN SUM(B.RFNET)/COUNT(A.INV_NO) ELSE 0 END)AS NUMERIC(10,0)) AS AVG_SALE,  
 '' AS AREA_NAME ,'' AS  CITY_NAME,'' AS  STATE_NAME ,   
 ISNULL(SUM(D.CASH_AMOUNT),0) AS CASH_AMOUNT ,  
 ISNULL(SUM(D.CC_AMOUNT),0) AS CC_AMOUNT ,  
 ISNULL(SUM(D.CREDIT_AMOUNT),0) AS CREDIT_AMOUNT     
 FROM INM01106 A (NOLOCK)      
 JOIN   
 (  
 SELECT INV_ID,SUM(RFNET) AS RFNET,SUM(QUANTITY) AS QUANTITY   
 FROM IND01106 (NOLOCK) GROUP BY INV_ID  
 ) B ON A.INV_ID =B.INV_ID    
 LEFT OUTER JOIN  VW_BILL_PAYMODE D (NOLOCK) ON A.INV_ID= D.MEMO_ID  AND D.XN_TYPE= 'WSL'     
 WHERE A.CANCELLED = 0 AND  INV_MODE=1 AND INV_DT = @CDT  
 GROUP BY a.location_Code  
  
  
  
 UNION ALL  
  
 SELECT 'SALE' AS XN_TYPE,@CDT AS CM_DT ,a.location_Code  AS LOC_ID,  
 0 AS BILL_COUNT,    
 CAST(ISNULL(SUM(B.RFNET*-1),0) AS NUMERIC(10,0)) AS SALES_AMOUNT  ,             
 CAST(ISNULL(SUM(QUANTITY*-1),0)AS NUMERIC(10,0)) AS SALES_QTY  ,    
 0 AS AVG_SALE,  
 '' AS AREA_NAME ,'' AS  CITY_NAME,'' AS  STATE_NAME ,   
 ISNULL(SUM(D.CASH_AMOUNT),0) AS CASH_AMOUNT ,  
 ISNULL(SUM(D.CC_AMOUNT),0) AS CC_AMOUNT ,  
 ISNULL(SUM(D.CREDIT_AMOUNT),0) AS CREDIT_AMOUNT     
 FROM CNM01106 A (NOLOCK)      
 JOIN   
 (  
 SELECT cn_id,SUM(RFNET) AS RFNET,SUM(QUANTITY) AS QUANTITY   
 FROM cnd01106 (NOLOCK) GROUP BY cn_id  
 ) B ON A.cn_id =B.cn_id    
 LEFT OUTER JOIN  VW_BILL_PAYMODE D (NOLOCK) ON A.cn_id= D.MEMO_ID  AND D.XN_TYPE= 'WSR'     
 WHERE A.CANCELLED = 0 AND  mode=1 AND cn_dt = @CDT  
 GROUP BY a.location_Code   
  
  
  
) A   
JOIN LOCATION L ON A.LOC_ID= L.dept_id    
GROUP BY LOC_ID,L.DEPT_ALIAS  
  
END  
  
  
  
  
GOTO LAST   
   
   
   
    
MSC20:  
  
 IF OBJECT_ID('TEMPDB..#TEMPW','U') IS NOT NULL    
 DROP TABLE #TEMPW     
   
   
   
   
 DECLARE @CPATH VARCHAR(1000)        
 SET @CPATH=''        
 SELECT @CPATH= VALUE FROM CONFIG WHERE CONFIG_OPTION  = 'ORDER_LIST_VIRTUAL_PATH'        
                      
  
  
 SELECT 'WSLOD' AS XN_TYPE,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN CUSTOMER_TITLE + ' ' + B.CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME    
              ELSE C.AC_NAME END) AS CUSTOMER,ORDER_NO,ORDER_DT,DELIVERY_DT,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN B.MOBILE  ELSE C.MOBILE END) AS MOBILE ,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN B.EMAIL  ELSE C.E_MAIL END) AS EMAIL ,     
        A.ORDER_ID AS UNQ_ID , SUM(D.QTY) AS ORDER_QTY,SUM(AMOUNT) AS ORDER_AMOUNT ,  
        SUM(E.ADV_AMOUNT) AS ADV_AMOUNT,  
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN ar.AREA_NAME  ELSE C.AREA_NAME END) AS AREA_NAME ,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN ct.CITY  ELSE C.CITY END) AS CITY_NAME ,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN st.STATE  ELSE C.STATE END) AS STATE_NAME ,  
        ISNULL(T4.EMP_NAME,'') AS SALE_PERSON ,A.REF_NO ,  
        (CASE WHEN ISNULL(A.EDITED,0)=1 THEN 'EDITED' WHEN  ISNULL(A.EDITED,0)=2   
              THEN 'CANCELLED' ELSE '' END)  AS  EDITED ,ORDER_TIME  ,'' AS LINK        
 INTO #TEMPW          
 FROM WSL_ORDER_MST A (NOLOCK)     
 LEFT OUTER JOIN custdym B (NOLOCK) ON A.CUSTOMER_CODE = B.CUSTOMER_CODE   
 JOIN AREA ar ON Ar.AREA_CODE = B.AREA_CODE     
 JOIN CITY Ct ON ar.CITY_CODE = Ct.CITY_CODE     
 JOIN STATE st ON Ct.STATE_CODE = st.STATE_CODE   
  
 LEFT OUTER JOIN LMV01106  C  (NOLOCK) ON A.AC_CODE = C.AC_CODE    
 LEFT OUTER JOIN EMPLOYEE T4 (NOLOCK) ON A.SALE_EMP_CODE= T4.EMP_CODE    
 JOIN     
 (    
  SELECT ORDER_ID ,SUM(QUANTITY) AS QTY,SUM(RFNET) AS AMOUNT FROM  WSL_ORDER_DET (NOLOCK)    
  GROUP BY ORDER_ID    
 ) D ON A.ORDER_ID= D.ORDER_ID    
  
 LEFT OUTER JOIN   
 (  
  SELECT A.ORDER_ID ,SUM(ISNULL(NET_AMOUNT,0)) AS ADV_AMOUNT  
  FROM  WSL_ORDER_MST A (NOLOCK)  
  LEFT OUTER JOIN WSL_ORDER_ADV_RECEIPT ADV (NOLOCK) ON A.ORDER_ID= ADV.ORDER_ID   
  LEFT OUTER JOIN ARC01106 ARC (NOLOCK) ON ADV.ADV_REC_ID = ARC.ADV_REC_ID   
  WHERE A.APPROVED=1 AND A.SMS_SENT=0  
  GROUP BY A.ORDER_ID  
 ) E ON A.ORDER_ID = E.ORDER_ID   
  
  
 WHERE A.APPROVED=1  AND A.SMS_SENT=0  AND (B.MOBILE <>'' OR C.MOBILE <> '')    
 GROUP BY (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN CUSTOMER_TITLE + ' ' + B.CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME ELSE C.AC_NAME END) ,    
 (CASE WHEN A.CUSTOMER_CODE <> '000000000000'  THEN B.MOBILE  ELSE C.MOBILE END) ,    
 (CASE WHEN A.CUSTOMER_CODE <> '000000000000'  THEN B.EMAIL  ELSE C.E_MAIL END) ,                
 ORDER_NO,ORDER_DT,DELIVERY_DT,A.ORDER_ID,     
 (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN ar.area_name  ELSE C.AREA_NAME END) ,    
 (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN ct.CITY  ELSE C.CITY END)  ,    
 (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN st.STATE  ELSE C.STATE END),  
 ISNULL(T4.EMP_NAME,''),A.REF_NO,ISNULL(A.EDITED,0),ORDER_TIME  
   
 UNION ALL  
   
   
 SELECT 'BUYOD' AS XN_TYPE,    
         C.AC_NAME  AS CUSTOMER,ORDER_NO,ORDER_DT,DELIVERY_DT,    
         C.MOBILE  AS MOBILE ,  C.E_MAIL  AS EMAIL ,     
        A.ORDER_ID AS UNQ_ID , SUM(D.QTY) AS ORDER_QTY,SUM(AMOUNT) AS ORDER_AMOUNT ,  
        CAST(0 AS NUMERIC(10,2)) AS ADV_AMOUNT,  
        C.AREA_NAME  AS AREA_NAME ,  C.CITY AS CITY_NAME ,    
        C.STATE  AS STATE_NAME ,  
        ISNULL(T4.EMP_NAME,'') AS SALE_PERSON ,D.ARTICLE_NO AS REF_NO,  
        '' AS  EDITED, ORDER_TIME, @CPATH + A.ORDER_ID + '.PDF'  AS LINK           
   
 FROM BUYER_ORDER_MST A (NOLOCK)    
 LEFT OUTER JOIN LMV01106  C  (NOLOCK) ON A.AC_CODE = C.AC_CODE    
   
 JOIN     
 (    
  SELECT A.ORDER_ID ,A.ITEM_MERCHANT_CODE,ART.ARTICLE_NO ,SUM(A.QUANTITY) AS QTY,TOTAL_AMOUNT AS AMOUNT  
  FROM  BUYER_ORDER_DET  A (NOLOCK)    
  JOIN BUYER_ORDER_MST B (NOLOCK) ON A.ORDER_ID= B.ORDER_ID    
  JOIN ARTICLE  ART  (NOLOCK) ON A.ARTICLE_CODE = ART.ARTICLE_CODE    
  WHERE B.MEMO_TYPE=3  AND  B.SMS_SENT=0  AND B.APPROVED= 1 AND B.CANCELLED=0    
  GROUP BY A.ORDER_ID  ,A.ITEM_MERCHANT_CODE,ART.ARTICLE_NO,TOTAL_AMOUNT  
 ) D ON A.ORDER_ID= D.ORDER_ID   
    
    LEFT OUTER JOIN EMPLOYEE T4 (NOLOCK) ON D.ITEM_MERCHANT_CODE= T4.EMP_CODE    
 WHERE A.MEMO_TYPE=3  AND  A.APPROVED= 1 AND A.CANCELLED=0 AND  
 A.SMS_SENT=0  AND C.MOBILE <> ''    
 GROUP BY  C.AC_NAME , C.MOBILE , C.E_MAIL ,                
 ORDER_NO,ORDER_DT,DELIVERY_DT,A.ORDER_ID,    
 C.AREA_NAME  ,   C.CITY   ,   C.STATE ,  
 ISNULL(T4.EMP_NAME,''),ISNULL(A.EDITED,0),ORDER_TIME,D.ARTICLE_NO  
   
    
  
 SELECT 'C' AS SMS_TYPE, XN_TYPE,CUSTOMER AS NAME,ORDER_NO,CONVERT(VARCHAR,ORDER_DT,105) AS ORDER_DT,  
 CONVERT(VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT,MOBILE,EMAIL,UNQ_ID,  
 ORDER_QTY,ORDER_AMOUNT, AREA_NAME, CITY_NAME,STATE_NAME,SALE_PERSON  ,ADV_AMOUNT ,  
 (ORDER_AMOUNT-ADV_AMOUNT) AS BAL_AMOUNT,REF_NO,EDITED,   
 ( CONVERT(VARCHAR,ORDER_TIME ,105) + '' +RIGHT(CONVERT(VARCHAR(MAX),ORDER_TIME,100) ,7) )AS  ORDER_TIME,  
 LINK  
 FROM #TEMPW  WHERE EDITED=''    
 UNION ALL    
 SELECT '' AS SMS_TYPE, XN_TYPE,B.CONTACT_NAME AS NAME,ORDER_NO,CONVERT(VARCHAR,ORDER_DT,105) AS ORDER_DT,  
 CONVERT(VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT,B.MOBILE,B.EMAIL,UNQ_ID,  
 ORDER_QTY,ORDER_AMOUNT, '' AS AREA_NAME,'' AS  CITY_NAME,'' AS STATE_NAME ,SALE_PERSON,ADV_AMOUNT,  
 (ORDER_AMOUNT-ADV_AMOUNT) AS BAL_AMOUNT,REF_NO,EDITED,  
 (CONVERT(VARCHAR,ORDER_TIME ,105) + '' +RIGHT(CONVERT(VARCHAR(MAX),ORDER_TIME,100) ,7) )AS  ORDER_TIME,LINK  
 FROM #TEMPW A,RECEIPIANT_MST B  
 WHERE B.REP_ID= 'MSCFIX0020'  AND  ISNULL(B.MOBILE,'') <> ''      
  
  
   GOTO LAST   
     
 MSC25:    
     
 IF OBJECT_ID('TEMPDB..#TEMPARC','U') IS NOT NULL    
  DROP TABLE #TEMPARC                                 
  
  
  SELECT 'ARC' AS XN_TYPE,    
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
  THEN CUSTOMER_TITLE + ' ' + B.CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME    
  ELSE C.AC_NAME END) AS CUSTOMER,ADV_REC_NO AS MEMO_NO,ADV_REC_DT AS MEMO_DT,    
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
  THEN B.MOBILE  ELSE C.MOBILE END) AS MOBILE ,    
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
  THEN B.EMAIL  ELSE C.E_MAIL END) AS EMAIL ,     
  A.ADV_REC_ID AS UNQ_ID , SUM(A.NET_AMOUNT) AS AMOUNT ,  
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
  THEN ar.AREA_NAME  ELSE C.AREA_NAME END) AS AREA_NAME ,    
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
  THEN ct.CITY  ELSE C.CITY END) AS CITY_NAME ,    
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
  THEN st.STATE  ELSE C.STATE END) AS STATE_NAME ,E.ADV_REC_ID,CMM.CM_NO,CMM.CM_DT                   
  INTO #TEMPARC          
  FROM ARC01106  A (NOLOCK)     
  LEFT OUTER JOIN custdym B (NOLOCK) ON A.CUSTOMER_CODE = B.CUSTOMER_CODE    
  JOIN AREA ar ON Ar.AREA_CODE = B.AREA_CODE     
  JOIN CITY Ct ON ar.CITY_CODE = Ct.CITY_CODE     
  JOIN STATE st ON ct.STATE_CODE = st.STATE_CODE   
  
  LEFT OUTER JOIN LMV01106  C  (NOLOCK) ON A.AC_CODE = C.AC_CODE    
  LEFT OUTER JOIN   
  (  
   SELECT ARC.ADV_REC_ID FROM WSL_ORDER_ADV_RECEIPT ADV (NOLOCK)   
   LEFT OUTER JOIN ARC01106 ARC (NOLOCK) ON ADV.ADV_REC_ID = ARC.ADV_REC_ID    
   WHERE ARC.SMS_SENT=0  
  ) E ON A.ADV_REC_ID = E.ADV_REC_ID   
        LEFT OUTER JOIN CMM_CREDIT_RECEIPT CR (NOLOCK) ON A.ADV_REC_ID = CR.ADV_REC_ID     
        LEFT OUTER JOIN CMM01106 CMM  (NOLOCK) ON CR.CM_ID= CMM.CM_ID  
        LEFT OUTER JOIN  
  (   
   SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SERVER_DT'  
  ) D ON 1=1  
                 
          
          
  WHERE A.ADV_REC_DT = D.VALUE  
  AND A.CANCELLED =0 AND A.SMS_SENT=0  AND (B.MOBILE <>'' OR C.MOBILE <> '')  AND E. ADV_REC_ID IS NULL  
  GROUP BY (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN CUSTOMER_TITLE + ' ' + B.CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME ELSE C.AC_NAME END) ,    
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'  THEN B.MOBILE  ELSE C.MOBILE END) ,    
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'  THEN B.EMAIL  ELSE C.E_MAIL END) ,                
  A.ADV_REC_NO,A.ADV_REC_DT, A.ADV_REC_ID,   
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN ar.AREA_NAME  ELSE C.AREA_NAME END) ,    
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN ct.CITY  ELSE C.CITY END)  ,    
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN st.STATE  ELSE C.STATE END),  
  E.ADV_REC_ID,CMM.CM_NO,CMM.CM_DT     
  
  
  SELECT 'C' AS SMS_TYPE, XN_TYPE,CUSTOMER AS NAME, MEMO_NO,CONVERT(VARCHAR,MEMO_DT,105) AS MEMO_DT,  
  MOBILE,EMAIL,UNQ_ID,  
  AMOUNT, AREA_NAME, CITY_NAME,STATE_NAME , CM_NO,CONVERT(VARCHAR,CM_DT,105) AS CM_DT     
  FROM #TEMPARC    
  UNION ALL    
  SELECT '' AS SMS_TYPE, XN_TYPE,B.CONTACT_NAME AS NAME,MEMO_NO,CONVERT(VARCHAR,MEMO_DT,105) AS MEMO_DT,  
  B.MOBILE,B.EMAIL,UNQ_ID,  
  AMOUNT, '' AS AREA_NAME,'' AS  CITY_NAME,'' AS STATE_NAME , CM_NO,CONVERT(VARCHAR,CM_DT,105) AS CM_DT    
  FROM #TEMPARC A,RECEIPIANT_MST B WHERE B.REP_ID= 'MSCFIX0025'           
  
 GOTO LAST   
   
   
 MSC26:    
    
       
  
  IF OBJECT_ID('TEMPDB..#TEMPARCB','U') IS NOT NULL    
  DROP TABLE #TEMPARCB                                 
  
  
  SELECT 'ARC' AS XN_TYPE,      
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'       
  THEN CUSTOMER_TITLE + ' ' + B.CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME      
  ELSE C.AC_NAME END) AS CUSTOMER,ORDER_NO,ORDER_DT,DELIVERY_DT,      
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'       
  THEN B.MOBILE  ELSE C.MOBILE END) AS MOBILE ,      
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'       
  THEN B.EMAIL  ELSE C.E_MAIL END) AS EMAIL ,       
  E.ADV_REC_ID AS UNQ_ID , SUM(D.QTY) AS ORDER_QTY,SUM(AMOUNT) AS ORDER_AMOUNT ,    
  SUM(E.ADV_AMOUNT) AS ADV_AMOUNT,    
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'       
  THEN ar.AREA_NAME  ELSE C.AREA_NAME END) AS AREA_NAME ,      
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'       
  THEN ct.CITY  ELSE C.CITY END) AS CITY_NAME ,      
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'       
  THEN st.STATE  ELSE C.STATE END) AS STATE_NAME ,    
  A.REF_NO ,(CASE WHEN ISNULL(A.EDITED,0)=1 THEN 'EDITED' ELSE '' END)  AS  EDITED ,  
  E.ADV_REC_NO AS MEMO_NO,E.ADV_REC_DT AS MEMO_DT,ISNULL(SUM(F.PRE_ADV_AMOUNT),0) AS PRE_ADV                  
  INTO #TEMPARCB            
  FROM WSL_ORDER_MST A (NOLOCK)       
  LEFT OUTER JOIN custdym B (NOLOCK) ON A.CUSTOMER_CODE = B.CUSTOMER_CODE      
  LEFT JOIN AREA ar ON Ar.AREA_CODE = B.AREA_CODE     
  LEFT JOIN CITY Ct ON ar.CITY_CODE = Ct.CITY_CODE     
  LEFT JOIN STATE st ON Ct.STATE_CODE = st.STATE_CODE   
  LEFT OUTER JOIN LMV01106  C  (NOLOCK) ON A.AC_CODE = C.AC_CODE      
  JOIN       
  (      
   SELECT ORDER_ID ,SUM(QUANTITY) AS QTY,SUM(RFNET) AS AMOUNT FROM  WSL_ORDER_DET (NOLOCK)      
   GROUP BY ORDER_ID      
  ) D ON A.ORDER_ID= D.ORDER_ID      
  
  JOIN     
  (    
   SELECT A.ORDER_ID ,ARC.ADV_REC_NO,ARC.ADV_REC_ID,ARC.ADV_REC_DT,  
   SUM(ISNULL(NET_AMOUNT,0)) AS ADV_AMOUNT    
   FROM  WSL_ORDER_MST A (NOLOCK)    
   LEFT OUTER JOIN WSL_ORDER_ADV_RECEIPT ADV (NOLOCK) ON A.ORDER_ID= ADV.ORDER_ID     
   LEFT OUTER JOIN ARC01106 ARC (NOLOCK) ON ADV.ADV_REC_ID = ARC.ADV_REC_ID     
   WHERE A.CANCELLED =0 AND A.APPROVED=1 AND ARC.SMS_SENT=0    
   GROUP BY A.ORDER_ID,ARC.ADV_REC_NO,ARC.ADV_REC_ID,ARC.ADV_REC_DT  
  ) E ON A.ORDER_ID = E.ORDER_ID   
    
    
  LEFT OUTER JOIN       
  (      
     SELECT  A.ORDER_ID,SUM(ISNULL(NET_AMOUNT,0)) AS PRE_ADV_AMOUNT      
     FROM  WSL_ORDER_MST A (NOLOCK)      
     LEFT OUTER JOIN WSL_ORDER_ADV_RECEIPT ADV (NOLOCK) ON A.ORDER_ID= ADV.ORDER_ID       
     LEFT OUTER JOIN ARC01106 ARC (NOLOCK) ON ADV.ADV_REC_ID = ARC.ADV_REC_ID       
     WHERE A.CANCELLED =0 AND A.APPROVED=1 AND ARC.SMS_SENT=1     
     GROUP BY A.ORDER_ID  
  ) F ON A.ORDER_ID = F.ORDER_ID    
    
  LEFT OUTER JOIN  
  (   
   SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SERVER_DT'  
  ) G ON 1=1  
    
      
  WHERE (B.MOBILE <>'' OR C.MOBILE <> '')   AND  A.ORDER_DT = G.VALUE  
  GROUP BY (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN CUSTOMER_TITLE + ' ' + B.CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME ELSE C.AC_NAME END) ,      
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'  THEN B.MOBILE  ELSE C.MOBILE END) ,      
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000'  THEN B.EMAIL  ELSE C.E_MAIL END) ,                  
  ORDER_NO,ORDER_DT,DELIVERY_DT,A.ORDER_ID,       
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN ar.AREA_NAME  ELSE C.AREA_NAME END) ,      
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN ct.CITY  ELSE C.CITY END)  ,      
  (CASE WHEN A.CUSTOMER_CODE <> '000000000000' THEN st.STATE  ELSE C.STATE END),    
  A.REF_NO,ISNULL(A.EDITED,0),E.ADV_REC_NO,E.ADV_REC_ID,E.ADV_REC_DT   
  
  
  SELECT 'C' AS SMS_TYPE, XN_TYPE,CUSTOMER AS NAME,ORDER_NO,CONVERT(VARCHAR,ORDER_DT,105) AS ORDER_DT,    
  CONVERT(VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT,MOBILE,EMAIL,UNQ_ID,    
  ORDER_QTY,ORDER_AMOUNT, AREA_NAME, CITY_NAME,STATE_NAME,ADV_AMOUNT ,    
  (ORDER_AMOUNT-(ADV_AMOUNT+PRE_ADV)) AS BAL_AMOUNT,REF_NO,EDITED , MEMO_NO, CONVERT(VARCHAR,MEMO_DT,105) AS MEMO_DT   
  FROM #TEMPARCB      
  UNION ALL      
  SELECT '' AS SMS_TYPE, XN_TYPE,B.CONTACT_NAME AS NAME,ORDER_NO,CONVERT(VARCHAR,ORDER_DT,105) AS ORDER_DT,    
  CONVERT(VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT,B.MOBILE,B.EMAIL,UNQ_ID,    
  ORDER_QTY,ORDER_AMOUNT, '' AS AREA_NAME,'' AS  CITY_NAME,'' AS STATE_NAME ,ADV_AMOUNT,    
     (ORDER_AMOUNT-(ADV_AMOUNT+PRE_ADV)) AS BAL_AMOUNT,REF_NO,EDITED, MEMO_NO, CONVERT(VARCHAR,MEMO_DT,105) AS MEMO_DT     
  FROM #TEMPARCB A,RECEIPIANT_MST B WHERE B.REP_ID= 'MSCFIX0026'      
  
   
   GOTO LAST   
     
     
     
     
 MSC27:  
  
 IF OBJECT_ID('TEMPDB..#TEMPWT','U') IS NOT NULL    
 DROP TABLE #TEMPWT                                 
  
  
 SELECT 'WSLODT' AS XN_TYPE,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN CUSTOMER_TITLE + ' ' + B.CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME    
              ELSE C.AC_NAME END) AS CUSTOMER,ORDER_NO,ORDER_DT,DELIVERY_DT, TRAIL_DT,  
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN B.MOBILE  ELSE C.MOBILE END) AS MOBILE ,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN B.EMAIL  ELSE C.E_MAIL END) AS EMAIL ,     
        A.ORDER_ID AS UNQ_ID ,           
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN ar.AREA_NAME  ELSE C.AREA_NAME END) AS AREA_NAME ,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN ct.CITY  ELSE C.CITY END) AS CITY_NAME ,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN st.STATE  ELSE C.STATE END) AS STATE_NAME ,  
        ISNULL(T4.EMP_NAME,'') AS SALE_PERSON ,A.REF_NO                  
 INTO #TEMPWT          
 FROM WSL_ORDER_MST A (NOLOCK)   
 JOIN WSL_TRIAL_LIST  WT (NOLOCK) ON A.ORDER_ID = WT.ORDER_ID  
 LEFT OUTER JOIN custdym B (NOLOCK) ON A.CUSTOMER_CODE = B.CUSTOMER_CODE  
 LEFT JOIN AREA ar ON Ar.AREA_CODE = B.AREA_CODE     
    LEFT JOIN CITY Ct ON ct.CITY_CODE = ar.CITY_CODE     
    LEFT JOIN STATE st ON st.STATE_CODE = ct.STATE_CODE   
   
 LEFT OUTER JOIN LMV01106  C  (NOLOCK) ON A.AC_CODE = C.AC_CODE    
 LEFT OUTER JOIN EMPLOYEE T4 (NOLOCK) ON A.SALE_EMP_CODE= T4.EMP_CODE    
 WHERE A.APPROVED=1 AND CANCELLED =0 AND WT.SMS_SENT=0  AND WT.MODE=1 AND (B.MOBILE <>'' OR C.MOBILE <> '')    
   
  
 SELECT 'C' AS SMS_TYPE, XN_TYPE,CUSTOMER AS NAME,ORDER_NO,CONVERT(VARCHAR,ORDER_DT,105) AS ORDER_DT,  
 CONVERT(VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT,CONVERT(VARCHAR,TRAIL_DT,105) AS TRAIL_DT,  
 MOBILE,EMAIL,UNQ_ID, AREA_NAME, CITY_NAME,STATE_NAME,SALE_PERSON,REF_NO  
 FROM #TEMPWT    
 UNION ALL    
 SELECT '' AS SMS_TYPE, XN_TYPE,B.CONTACT_NAME AS NAME,ORDER_NO,CONVERT(VARCHAR,ORDER_DT,105) AS ORDER_DT,  
 CONVERT(VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT,CONVERT(VARCHAR,TRAIL_DT,105) AS TRAIL_DT,  
 B.MOBILE,B.EMAIL,UNQ_ID,'' AS AREA_NAME,'' AS  CITY_NAME,'' AS STATE_NAME ,SALE_PERSON,  
 REF_NO  
 FROM #TEMPWT A,RECEIPIANT_MST B WHERE B.REP_ID= 'MSCFIX0027'        
  
  
   GOTO LAST   
  
  
  
 MSC28:  
  
 IF OBJECT_ID('TEMPDB..#TEMPWD','U') IS NOT NULL    
 DROP TABLE #TEMPWD                                 
  
  
 SELECT 'WSLODD' AS XN_TYPE,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN CUSTOMER_TITLE + ' ' + B.CUSTOMER_FNAME + ' ' + CUSTOMER_LNAME    
              ELSE C.AC_NAME END) AS CUSTOMER,ORDER_NO,ORDER_DT,DELIVERY_DT, TRAIL_DT,  
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN B.MOBILE  ELSE C.MOBILE END) AS MOBILE ,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN B.EMAIL  ELSE C.E_MAIL END) AS EMAIL ,     
        A.ORDER_ID AS UNQ_ID ,           
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN ar.AREA_NAME  ELSE C.AREA_NAME END) AS AREA_NAME ,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN ct.CITY  ELSE C.CITY END) AS CITY_NAME ,    
        (CASE WHEN A.CUSTOMER_CODE <> '000000000000'     
              THEN st.STATE  ELSE C.STATE END) AS STATE_NAME ,  
        ISNULL(T4.EMP_NAME,'') AS SALE_PERSON ,A.REF_NO                  
 INTO #TEMPWD          
 FROM WSL_ORDER_MST A (NOLOCK)   
 JOIN WSL_TRIAL_LIST  WT (NOLOCK) ON A.ORDER_ID = WT.ORDER_ID  
 LEFT OUTER JOIN custdym B (NOLOCK) ON A.CUSTOMER_CODE = B.CUSTOMER_CODE    
 LEFT JOIN AREA ar ON Ar.AREA_CODE = B.AREA_CODE     
 LEFT JOIN CITY ct ON ct.CITY_CODE = ar.CITY_CODE     
 LEFT JOIN STATE st ON st.STATE_CODE = ct.STATE_CODE   
 LEFT OUTER JOIN LMV01106  C  (NOLOCK) ON A.AC_CODE = C.AC_CODE    
 LEFT OUTER JOIN EMPLOYEE T4 (NOLOCK) ON A.SALE_EMP_CODE= T4.EMP_CODE    
 WHERE A.APPROVED=1 AND CANCELLED =0 AND WT.SMS_SENT=0  AND WT.MODE=2 AND (B.MOBILE <>'' OR C.MOBILE <> '')    
   
  
 SELECT 'C' AS SMS_TYPE, XN_TYPE,CUSTOMER AS NAME,ORDER_NO,CONVERT(VARCHAR,ORDER_DT,105) AS ORDER_DT,  
 CONVERT(VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT,CONVERT(VARCHAR,TRAIL_DT,105) AS TRAIL_DT,  
 MOBILE,EMAIL,UNQ_ID, AREA_NAME, CITY_NAME,STATE_NAME,SALE_PERSON,REF_NO  
 FROM #TEMPWD    
 UNION ALL    
 SELECT '' AS SMS_TYPE, XN_TYPE,B.CONTACT_NAME AS NAME,ORDER_NO,CONVERT(VARCHAR,ORDER_DT,105) AS ORDER_DT,  
 CONVERT(VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT,CONVERT(VARCHAR,TRAIL_DT,105) AS TRAIL_DT,  
 B.MOBILE,B.EMAIL,UNQ_ID,'' AS AREA_NAME,'' AS  CITY_NAME,'' AS STATE_NAME ,SALE_PERSON,  
 REF_NO  
 FROM #TEMPWD A,RECEIPIANT_MST B WHERE B.REP_ID= 'MSCFIX0028'        
  
  
   GOTO LAST   
        
       
MSC29:    
  
 SELECT 'CARD' AS XN_TYPE, a.CUSTOMER_CODE,(a.CUSTOMER_FNAME) AS NAME ,    
 a.MOBILE,a.EMAIL,GETDATE() AS SENT_ON,'' AS GV_NO ,  
 CONVERT(VARCHAR,DT_CARD_ISSUE,105)  AS DT_CARD_ISSUE,CONVERT(VARCHAR,DT_CARD_EXPIRY,105) AS CARD_EXP_DT,   
 CARD_NO AS  CARD_NO,  
 b.AREA_NAME AS AREA_NAME,c.CITY AS CITY_NAME,d.STATE AS STATE_NAME   
 FROM custdym a (NOLOCK)  
 JOIN AREA B ON A.AREA_CODE = B.AREA_CODE     
 JOIN CITY C ON B.CITY_CODE = C.CITY_CODE     
 JOIN STATE D ON C.STATE_CODE = D.STATE_CODE   
 WHERE  ABS(DATEDIFF(DD,DT_CARD_EXPIRY,GETDATE()))=7 AND DT_CARD_EXPIRY > GETDATE()  
 AND a.CUSTOMER_CODE <> '000000000000' AND a.MOBILE <> ''   
 ORDER BY a.CUSTOMER_CODE,a.MOBILE,a.EMAIL   
  
 GOTO LAST    
   
   
   
   
    
MSC30:           
 IF OBJECT_ID('tempdb..#tmpPending1','U') IS NOT NULL  
  DROP TABLE #tmpPending1  
    
 SELECT receipt_id INTO #tmpPending1  
 FROM POST_SALES_JOBWORK_RECEIPT_MST A (NOLOCK)   
 WHERE ISNULL(a.SMS_SENT,0)=0 AND a.cancelled=0  
  
 IF OBJECT_ID('tempdb..#tmpPending2','U') IS NOT NULL  
  DROP TABLE #tmpPending2  
   
 SELECT distinct d.cm_id INTO #tmpPending2 FROM post_sales_jobwork_issue_det a (NOLOCK)  
 JOIN post_sales_jobwork_receipt_det b (NOLOCK) ON a.row_id=b.ref_row_id  
 JOIN hold_back_deliver_det c (NOLOCK) ON c.row_id=a.ref_hbd_row_id  
 JOIN cmd01106 d (NOLOCK) ON d.row_id=c.ref_cmd_row_id  
 JOIN #tmpPending1 e ON e.receipt_id=b.receipt_id   
   
 IF OBJECT_ID('tempdb..#tmpPendingFinal','U') IS NOT NULL  
  DROP TABLE #tmpPendingFinal  
    
 SELECT A.CM_ID INTO #tmpPendingFinal  
 FROM   
 (SELECT g.cm_id,SUM(A.quantity) as rec_qty  from POST_SALES_JOBWORK_RECEIPT_DET A (NOLOCK)   
  JOIN POST_SALES_JOBWORK_ISSUE_DET b ON b.row_id=a.ref_row_id  
  JOIN hold_back_deliver_det c (NOLOCK) ON c.row_id=b.ref_hbd_row_id  
  JOIN POST_SALES_JOBWORK_RECEIPT_mst d (NOLOCK) ON d.receipt_id=a.receipt_id   
  JOIN POST_SALES_JOBWORK_ISSUE_mst e (NOLOCK) ON e.issue_id=b.issue_id   
  JOIN hold_back_deliver_mst f (NOLOCK) ON f.memo_id=c.memo_id  
  JOIN cmd01106 g (NOLOCK) ON g.row_id=c.ref_cmd_row_id  
  JOIN  #tmpPending2 h ON h.cm_id=g.cm_id  
  WHERE d.cancelled=0 AND e.cancelled=0 AND f.cancelled=0  
  GROUP BY g.cm_id) a  
 JOIN   
 (SELECT b.cm_id,SUM(a.quantity) as issue_qty from hold_back_deliver_det a (NOLOCK)  
  JOIN cmd01106 b (NOLOCK) ON b.row_id=a.ref_cmd_row_id  
  JOIN #tmpPending2 c ON c.cm_id=b.cm_id  
  JOIN hold_back_deliver_mst d (NOLOCK) ON d.memo_id=a.memo_id  
  GROUP BY b.cm_id) b ON a.cm_id=b.cm_id  
 WHERE a.rec_qty=b.issue_qty  
   
 IF OBJECT_ID('TEMPDB..#TEMPPS','U') IS NOT NULL    
  DROP TABLE #TEMPPS                                   
  
  
 SELECT 'PSJWR' AS XN_TYPE, A.RECEIPT_ID AS UNQ_ID,      
 CMM.CM_NO  AS BILL_NO,  CONVERT(VARCHAR,CMM.CM_DT,105)  AS BILL_DT ,   
 C.QTY,JOBS.JOB_NAME  AS JOB_WORK,   
 B.CUSTOMER_FNAME  AS NAME, B.EMAIL AS EMAIL, B.MOBILE,  
 ar.AREA_NAME AS AREA_NAME ,ct.CITY AS CITY_NAME ,st.STATE AS STATE_NAME ,L.CONTACT_NO  
 INTO #TEMPPS  
 FROM POST_SALES_JOBWORK_RECEIPT_MST A   (NOLOCK)     
 JOIN      
 (     
 SELECT A.RECEIPT_ID, SUM(A.QUANTITY) AS QTY FROM POST_SALES_JOBWORK_RECEIPT_DET A (NOLOCK)   
 JOIN POST_SALES_JOBWORK_ISSUE_DET b (NOLOCK)  ON A.REF_ROW_ID =B.ROW_ID  
 JOIN HOLD_BACK_DELIVER_DET d (NOLOCK)  ON B.REF_HBD_ROW_ID=D.ROW_ID  
 JOIN CMD01106 E (NOLOCK)  ON E.ROW_ID=d.ref_cmd_row_id  
 JOIN POST_SALES_JOBWORK_RECEIPT_MST c (NOLOCK)  ON c.receipt_id=a.receipt_id  
 JOIN #tmpPendingFinal f ON f.cm_id=e.cm_id  
 where c.cancelled=0 GROUP BY a.RECEIPT_ID     
 ) C ON A.RECEIPT_ID = C.RECEIPT_ID     
 LEFT OUTER JOIN  
 (   
  SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SERVER_DT'  
 ) D ON 1=1  
 JOIN  
 (  
   SELECT A.RECEIPT_ID ,G.CM_NO,G.CM_DT,E.CUSTOMER_CODE  
   FROM POST_SALES_JOBWORK_RECEIPT_DET (NOLOCK) A  
   JOIN POST_SALES_JOBWORK_ISSUE_DET (NOLOCK) B ON A.REF_ROW_ID =B.ROW_ID  
   JOIN POST_SALES_JOBWORK_ISSUE_MST (NOLOCK) C ON B.ISSUE_ID =C.ISSUE_ID   
   JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON B.REF_HBD_ROW_ID=D.ROW_ID  
   JOIN HOLD_BACK_DELIVER_MST (NOLOCK) E ON E.MEMO_ID=D.MEMO_ID  
   LEFT OUTER JOIN CMD01106 F (NOLOCK) ON F.ROW_ID=D.REF_CMD_ROW_ID   
   LEFT OUTER JOIN CMM01106 (NOLOCK) G ON F.CM_ID =G.CM_ID   
   JOIN #tmpPendingFinal p (NOLOCK) ON p.cm_id=f.cm_id  
   WHERE C.CANCELLED=0  AND E.CANCELLED =0   
   GROUP BY A.RECEIPT_ID ,G.CM_NO,G.CM_DT,E.CUSTOMER_CODE  
 ) CMM ON A.RECEIPT_ID =CMM.RECEIPT_ID  
 JOIN custdym B  (NOLOCK) ON B.CUSTOMER_CODE = CMM.CUSTOMER_CODE   
 JOIN AREA ar ON ar.AREA_CODE = B.AREA_CODE     
 JOIN CITY ct ON ct.CITY_CODE = ar.CITY_CODE     
 JOIN STATE st ON st.STATE_CODE = ct.STATE_CODE   
 JOIN JOBS (NOLOCK) ON A.JOB_CODE =JOBS.JOB_CODE   
 JOIN LOCATION L on a.location_Code = L.dept_id   
    WHERE  A.RECEIPT_DT = D.VALUE  
 AND ISNULL(B.MOBILE,'')<>''  AND  ABS(DATEDIFF(DD,A.RECEIPT_DT,GETDATE()))  BETWEEN 0 AND 1  
    
  
  
 SELECT  XN_TYPE,UNQ_ID, BILL_NO,  BILL_DT, QTY, JOB_WORK,    
 NAME,  EMAIL, MOBILE,  
 AREA_NAME, CITY_NAME,STATE_NAME ,CONTACT_NO    
 FROM #TEMPPS    
  
  
 GOTO LAST    
   
   
   
     
MSC31:           
  
 IF OBJECT_ID('TEMPDB..#TEMPDL','U') IS NOT NULL    
 DROP TABLE #TEMP                                   
  
  
 SELECT 'PSDLV' AS XN_TYPE, A.MEMO_ID AS UNQ_ID,      
 C.CM_NO AS BILL_NO,     CONVERT(VARCHAR,C.CM_DT,105) AS BILL_DT ,   
 C.QTY,'' AS JOB_WORK,   
 B.CUSTOMER_FNAME  AS NAME, B.EMAIL AS EMAIL, B.MOBILE,  
 ar.AREA_NAME AS AREA_NAME ,ct.CITY AS CITY_NAME ,st.STATE AS STATE_NAME ,L.CONTACT_NO  
 INTO #TEMPDL  
 FROM SLS_DELIVERY_MST A   (NOLOCK)     
 JOIN custdym B  (NOLOCK) ON B.CUSTOMER_CODE = B.CUSTOMER_CODE   
 JOIN AREA ar ON Ar.AREA_CODE = B.AREA_CODE     
 JOIN CITY Ct ON ct.CITY_CODE = ar.CITY_CODE     
 JOIN STATE st ON st.STATE_CODE = ct.STATE_CODE   
 JOIN      
 (     
 SELECT CMM.CM_NO ,CMM.CM_DT , MEMO_ID, CMM.CUSTOMER_CODE,  
 SUM(CMM.QUANTITY) AS QTY   
 FROM SLS_DELIVERY_DET  (NOLOCK)  A  
    JOIN  
    (  
      SELECT A.ROW_ID,A.QUANTITY,CM_NO,CM_DT  ,D.CUSTOMER_CODE  
      FROM HOLD_BACK_DELIVER_DET (NOLOCK) A  
      JOIN HOLD_BACK_DELIVER_MST (NOLOCK) B ON A.MEMO_ID=B.MEMO_ID  
      JOIN CMD01106 (NOLOCK) C ON A.REF_CMD_ROW_ID=C.ROW_ID  
      JOIN CMM01106 (NOLOCK) D ON C.CM_ID =D.CM_ID   
      WHERE B.CANCELLED=0 AND D.CANCELLED=0  
     ) CMM ON CMM.ROW_ID=A.REF_HBD_ROW_ID   
 GROUP BY MEMO_ID,CMM.CM_NO ,CMM.CM_DT ,CMM.CUSTOMER_CODE    
 ) C ON A.MEMO_ID = C.MEMO_ID  AND B.CUSTOMER_CODE= C.CUSTOMER_CODE  
 LEFT OUTER JOIN  
 (   
  SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SERVER_DT'  
 ) D ON 1=1  
 JOIN LOCATION L on a.location_code = L.dept_id   
    WHERE  ISNULL(A.SMS_SENT,0) = 0   AND  A.MEMO_DT = D.VALUE  
    AND ISNULL(B.MOBILE,'')<>'' AND  ABS(DATEDIFF(DD,A.MEMO_DT,GETDATE()))  BETWEEN 0 AND 1  
  
 SELECT  XN_TYPE,UNQ_ID, BILL_NO,  BILL_DT, QTY, JOB_WORK,    
 NAME,  EMAIL, MOBILE,   
 AREA_NAME, CITY_NAME,STATE_NAME ,CONTACT_NO    
 FROM #TEMPDL    
  
 GOTO LAST   
   
   
   
   
 MSC32:  
    
 SELECT 'ACT' AS XN_TYPE, A.AC_CODE, A.AC_NAME,A.AC_NAME AS NAME, A.ADDRESS0, A.ADDRESS1, A.ADDRESS2, A.AREA_NAME,   
        A.PINCODE, A.CITY AS CITY_NAME, @CWHERE AS XN_DT,  
 STATE AS STATE_NAME, A.PAN_NO,  A.PHONES_R, A.PHONES_O, A.PHONES_FAX,A.E_MAIL AS EMAIL,  
 A.MOBILE, A.CST_NO, A.SST_NO, A.TIN_NO, A.HEAD_CODE, ISNULL(B.AC_NAME,'') AS BROKER_AC_NAME,   
 --DBO.FN_ACT_OPENING (A.AC_CODE , C.VALUE, @CDT, '', '01' ) --commented this as it will slow down our cloud (28-01-2021)  
 0 AS OPENING_BALANCE,    
 --DBO.FN_ACT_CLOSING ( A.AC_CODE, C.VALUE, @CWHERE, '', '01' )  --commented this as it will slow down our cloud (28-01-2021)  
 0 AS CLOSING_BALANCE    
 FROM LMV01106 A (NOLOCK)    
 LEFT OUTER JOIN LM01106 B (NOLOCK) ON ISNULL(A.BROKER_AC_CODE,'0000000000') = B.AC_CODE   
 LEFT OUTER JOIN (SELECT DEPT_ID AS VALUE FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID )  C ON 1=1  
 WHERE A.ENABLE_EMAIL=1  
   
 GOTO LAST   
   
   
 MSC33:  
      
      
     IF OBJECT_ID('TEMPDB..#TMPSUPBAL','') IS NOT NULL  
         DROP TABLE #TMPSUPBAL  
           
         SELECT @CDT=CONVERT(VARCHAR(10),GETDATE(),121)  
           
           
      SELECT  X.AC_CODE AS AC_CODE, VOUCHER_DT,RECON_DT , VM_ID, MRR_LIST,REF_NO,   
    VOUCHER_NO,X.VD_ID, X.VOUCHER_TYPE,X.VOUCHER_TYPE_ALIAS, X.QUANTITY,       
       ( CASE WHEN X.DEBIT_AMOUNT <> 0 THEN 'DR' ELSE 'CR' END ) AS X_TYPE,          
     X.VS_NARRATION, X.NARRATION,           
    0 AS OPENING, X.DEBIT_AMOUNT, X.CREDIT_AMOUNT, 0 AS CLOSING , X.DEPT_ID, X.HEAD_CODE  
  INTO #TMPSUPBAL           
  FROM  
  (          
   SELECT A.AC_CODE, B.VOUCHER_DT, A.RECON_DT ,B.VM_ID,B.MRR_LIST,    
      B.REF_NO,B.VOUCHER_NO, A.VD_ID, D.VOUCHER_TYPE, D.VOUCHER_TYPE_ALIAS,           
      B.QUANTITY,CONVERT(VARCHAR(200),'') AS VS_NARRATION,           
      A.DEBIT_AMOUNT , A.CREDIT_AMOUNT ,  
      A.COST_CENTER_DEPT_ID AS DEPT_ID,C.HEAD_CODE,A.NARRATION              
   FROM VD01106 A (NOLOCK)         
   JOIN VM01106 B (NOLOCK) ON A.VM_ID = B.VM_ID          
   JOIN LM01106 C (NOLOCK) ON C.AC_CODE=A.AC_CODE  
   JOIN VCHTYPE D (NOLOCK) ON B.VOUCHER_CODE = D.VOUCHER_CODE  
   WHERE B.VOUCHER_DT<=@CDT         
   AND B.CANCELLED = 0 AND ISNULL(B.OP_ENTRY,0)=0  AND ISNULL(B.MEMO,0)=0          
    
  ) X    
    
  SELECT 'SDB' AS XN_TYPE, A.AC_CODE, LMV.AC_NAME,LMV.AC_NAME AS NAME, LMV.ADDRESS0, LMV.ADDRESS1, LMV.ADDRESS2,   
         LMV.AREA_NAME,   
            LMV.PINCODE, LMV.CITY AS CITY_NAME, GETDATE() AS XN_DT,  
            STATE AS STATE_NAME, LMV.PAN_NO,  LMV.PHONES_R, LMV.PHONES_O, LMV.PHONES_FAX,LMV.E_MAIL AS EMAIL,  
            LMV.MOBILE, LMV.CST_NO, LMV.SST_NO, LMV.TIN_NO, A.HEAD_CODE, ISNULL(LMV.AC_NAME,'') AS BROKER_AC_NAME,   
               CAST(SUM(CASE WHEN A.X_TYPE='DR' THEN A.DEBIT_AMOUNT ELSE 0 END)  
           -SUM(CASE WHEN A.X_TYPE=' CR' THEN A.CREDIT_AMOUNT ELSE 0 END ) AS NUMERIC(18,2)) AS BALANCE  
  FROM #TMPSUPBAL A  
  JOIN LMV01106 LMV (NOLOCK) ON LMV.AC_CODE =A.AC_CODE    
  WHERE (LMV.HEAD_CODE='0000000018' OR ISNULL(ALLOW_CREDITOR_DEBTOR,0)=1)  
  GROUP BY A.AC_CODE, LMV.AC_NAME,LMV.AC_NAME , LMV.ADDRESS0, LMV.ADDRESS1, LMV.ADDRESS2,   
  LMV.AREA_NAME, LMV.PINCODE, LMV.CITY  ,  
     STATE , LMV.PAN_NO,  LMV.PHONES_R, LMV.PHONES_O, LMV.PHONES_FAX,LMV.E_MAIL ,  
     LMV.MOBILE, LMV.CST_NO, LMV.SST_NO, LMV.TIN_NO, A.HEAD_CODE, ISNULL(LMV.AC_NAME,'') ,   
  ISNULL(ADDRESS0,'')+' '+ISNULL(ADDRESS1,'') ,MOBILE,E_MAIL  
  HAVING SUM(CASE WHEN A.X_TYPE='DR' THEN A.DEBIT_AMOUNT ELSE 0 END)  
  -SUM(CASE WHEN A.X_TYPE=' CR' THEN A.CREDIT_AMOUNT ELSE 0 END )>1  
   
 GOTO LAST    
   
  
   
 MSC34:  
    
  SELECT 'POD' AS XN_TYPE, A.AC_CODE, A.AC_NAME,A.AC_NAME AS NAME, A.ADDRESS0, A.ADDRESS1,   
  A.ADDRESS2, A.AREA_NAME,  PO_ID AS UNQ_ID,  
  A.PINCODE, A.CITY AS CITY_NAME, B.PO_DT, STATE AS STATE_NAME, A.PAN_NO,  A.PHONES_R,   
  A.PHONES_O, A.PHONES_FAX,A.E_MAIL AS EMAIL,B.TOTAL_QUANTITY AS QUANTITY ,b.TOTAL_AMOUNT ,  
  A.MOBILE ,A.WhatsApp_no ,B.PO_NO   
  FROM POM01106 B (NOLOCK)    
  LEFT OUTER JOIN LMV01106  A (NOLOCK) ON A.ac_code  = B.AC_CODE    
  LEFT OUTER JOIN  
  (   
  SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SERVER_DT'  
  ) D ON 1=1  
   
  WHERE  ISNULL(B.SMS_SENT,0) = 0   AND  B.PO_DT = D.VALUE  
  AND ISNULL(A.MOBILE,'')<>''   
   
 GOTO LAST   
  
   
 MSC35:  
    
 SELECT 'WSR' AS XN_TYPE, A.AC_CODE, A.AC_NAME,A.AC_NAME AS NAME, A.ADDRESS0, A.ADDRESS1,   
  A.ADDRESS2, A.AREA_NAME, CN_ID AS UNQ_ID,  
  A.PINCODE, A.CITY AS CITY_NAME, B.CN_DT, STATE AS STATE_NAME, A.PAN_NO,  A.PHONES_R,   
  A.PHONES_O, A.PHONES_FAX,A.E_MAIL AS EMAIL,B.TOTAL_QUANTITY AS QUANTITY ,b.TOTAL_AMOUNT ,  
  A.MOBILE ,A.WhatsApp_no ,B.CN_NO    
  FROM CNM01106 B (NOLOCK)    
  LEFT OUTER JOIN LMV01106  A (NOLOCK) ON A.ac_code  = B.AC_CODE    
  LEFT OUTER JOIN  
  (   
  SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION = 'SERVER_DT'  
  ) D ON 1=1  
   
  WHERE  ISNULL(B.SMS_SENT,0) = 0   AND  B.CN_DT = D.VALUE  
  AND ISNULL(A.MOBILE,'')<>''   
   
 GOTO LAST   
  
  
   
MSC36:  
  
  
 ;WITH HBD_STATUS  
 AS  
 (  
  SELECT CAST(0 AS INT) AS HBD_STATUS,'' AS HBD_STATUS_NAME    
  UNION ALL  
  SELECT CAST(1 AS INT) AS HBD_STATUS,'Approve & Issue Advance Note' AS HBD_STATUS_NAME   
  UNION ALL  
  SELECT CAST(2 AS INT) AS HBD_STATUS,'Free Repair & Return' AS HBD_STATUS_NAME   
  UNION ALL  
  SELECT CAST(3 AS INT) AS HBD_STATUS,'Charged Repair & Return' AS HBD_STATUS_NAME   
  UNION ALL  
  SELECT CAST(4 AS INT) AS HBD_STATUS,'Disapprove & Return' AS HBD_STATUS_NAME   
    UNION ALL  
  SELECT CAST(5 AS INT) AS HBD_STATUS,'Challan Receive at Head Office' AS HBD_STATUS_NAME   
    UNION ALL  
  SELECT CAST(6 AS INT) AS HBD_STATUS,'Challan Receive at Location' AS HBD_STATUS_NAME   
 )  
  
  
   
 select top 1  'HBD' XN_TYPE, b.memo_id AS  UNQ_ID,ISNULL(cmm.CM_NO,'') AS  BILL_NO,cmm.CM_DT  BILL_DT, a.quantity  QTY,    
 cust.CUSTOMER_FNAME  AS NAME, cust.EMAIL AS EMAIL, cust.MOBILE,  
 ar.AREA_NAME AS AREA_NAME ,ct.CITY AS CITY_NAME ,st.STATE AS STATE_NAME ,L.CONTACT_NO,hbd.HBD_STATUS_NAME  ,
 L.DEPT_ALIAS ,L.PHONE ,A. JOB_RATE AMOUNT
 FROM hold_back_deliver_det   A (NOLOCK)     
 JOIN HOLD_BACK_DELIVER_MST B (NOLOCK) ON A.memo_id  = B.MEMO_ID   
  LEFT JOIN cmd01106 C (NOLOCK) ON A.ref_cmd_row_id  =C.ROW_ID 
 left join cmm01106 cmm (nolock) on c.cm_id =cmm.cm_id   
 JOIN HBD_STATUS HBD ON HBD.HBD_STATUS=a.HBD_STATUS  
 JOIN custdym cust  (NOLOCK) ON B.CUSTOMER_CODE = cust.CUSTOMER_CODE   
 JOIN AREA ar ON Ar.AREA_CODE = cust.AREA_CODE     
 JOIN CITY Ct ON ct.CITY_CODE = ar.CITY_CODE     
 JOIN STATE st ON st.STATE_CODE = ct.STATE_CODE   
 JOIN LOCATION L on b.location_Code = L.dept_id   
 WHERE   isnull(cust.mobile,'')<>''    
 and b.cancelled=0 and hbd.HBD_STATUS in(1)  
 AND A.row_id =@CWHERE 
  
GOTO LAST   
  
MSC37:  
  
   
  
select  top 1 'HBC' XN_TYPE, b.memo_ID UNQ_ID,ISNULL(CMM.CM_NO,'') AS  BILL_NO,CMM.CM_DT  BILL_DT, a.quantity  QTY,    
 cust.CUSTOMER_FNAME  AS NAME, cust.EMAIL AS EMAIL, cust.MOBILE,  
 ar.AREA_NAME AS AREA_NAME ,ct.CITY AS CITY_NAME ,st.STATE AS STATE_NAME ,
 L.CONTACT_NO,'Charged Repair & Return' as HBD_STATUS_NAME , L.DEPT_ALIAS ,L.PHONE ,A.JOB_RATE AMOUNT 
 FROM hold_back_deliver_det  A (NOLOCK)     
 JOIN HOLD_BACK_DELIVER_MST B (NOLOCK) ON A.memo_id = B.MEMO_ID    
 LEFT JOIN cmd01106 C (NOLOCK) ON A.ref_cmd_row_id  =C.ROW_ID 
 left join cmm01106 cmm (nolock) on c.cm_id =cmm.cm_id   
 JOIN custdym cust  (NOLOCK) ON B.CUSTOMER_CODE = cust.CUSTOMER_CODE   
 JOIN AREA ar ON Ar.AREA_CODE = cust.AREA_CODE     
 JOIN CITY Ct ON ct.CITY_CODE = ar.CITY_CODE     
 JOIN STATE st ON st.STATE_CODE = ct.STATE_CODE   
 JOIN LOCATION L on b.location_Code = L.dept_id   
 WHERE  isnull(cust.mobile,'')<>''    
 and b.cancelled=0  and A.HBD_STATUS in(3)   
 AND A.ROW_ID =@CWHERE
  
GOTO LAST   
  
  
  
MSC38:  
  
  
  
   
  
select top 1  'HBF' XN_TYPE, b.memo_id AS UNQ_ID,ISNULL(Cmm.CM_NO,'') AS  BILL_NO,Cmm.CM_DT  BILL_DT, a.quantity  QTY,    
 cust.CUSTOMER_FNAME  AS NAME, cust.EMAIL AS EMAIL, cust.MOBILE,  
 ar.AREA_NAME AS AREA_NAME ,ct.CITY AS CITY_NAME ,st.STATE AS STATE_NAME ,
 L.CONTACT_NO,'Free Repair & Return' AS HBD_STATUS_NAME  , L.DEPT_ALIAS ,L.PHONE ,A. JOB_RATE AMOUNT
 FROM HOLD_BACK_DELIVER_det  A (NOLOCK)     
 JOIN HOLD_BACK_DELIVER_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID   
 LEFT JOIN cmd01106 C (NOLOCK) ON A.ref_cmd_row_id  =C.ROW_ID 
 left join cmm01106 cmm (nolock) on c.cm_id =cmm.cm_id 
 JOIN custdym cust  (NOLOCK) ON B.CUSTOMER_CODE = cust.CUSTOMER_CODE   
 JOIN AREA ar ON Ar.AREA_CODE = cust.AREA_CODE     
 JOIN CITY Ct ON ct.CITY_CODE = ar.CITY_CODE     
 JOIN STATE st ON st.STATE_CODE = ct.STATE_CODE   
 JOIN LOCATION L on b.location_Code = L.dept_id   
 WHERE isnull(cust.mobile,'')<>''      
 and b.cancelled=0  and A.HBD_STATUS in(2)   
 AND A.ROW_ID =@CWHERE
  
GOTO LAST   
  
  
MSC39:   
  
  
   
  
select top 1 'HBR' XN_TYPE, b.memo_id AS  UNQ_ID,ISNULL(cmm.CM_NO,'') AS  BILL_NO,cmm.CM_DT  BILL_DT, a.quantity QTY,    
 cust.CUSTOMER_FNAME  AS NAME, cust.EMAIL AS EMAIL, cust.MOBILE,  
 ar.AREA_NAME AS AREA_NAME ,ct.CITY AS CITY_NAME ,st.STATE AS STATE_NAME ,
 L.CONTACT_NO,'Disapprove & Return' AS HBD_STATUS_NAME  , L.DEPT_ALIAS ,L.PHONE ,A.JOB_RATE AMOUNT
 FROM HOLD_BACK_DELIVER_DET  A (NOLOCK)     
 JOIN HOLD_BACK_DELIVER_MST B (NOLOCK) ON A.memo_id = B.MEMO_ID  
 LEFT JOIN cmd01106 C (NOLOCK) ON A.ref_cmd_row_id  =C.ROW_ID 
 left join cmm01106 cmm (nolock) on c.cm_id =cmm.cm_id   
 JOIN custdym cust  (NOLOCK) ON B.CUSTOMER_CODE = cust.CUSTOMER_CODE   
 JOIN AREA ar ON Ar.AREA_CODE = cust.AREA_CODE     
 JOIN CITY Ct ON ct.CITY_CODE = ar.CITY_CODE     
 JOIN STATE st ON st.STATE_CODE = ct.STATE_CODE   
 JOIN LOCATION L on b.location_Code = L.dept_id   
 WHERE   isnull(cust.mobile,'')<>''     
 and b.cancelled=0  and A.HBD_STATUS in(4)   
 AND  A.ROW_ID =@CWHERE
  
GOTO LAST   



MSC40:  
  
  
  
   
  
select top 1 'HRH' XN_TYPE, b.memo_id AS  UNQ_ID,ISNULL(Cmm.CM_NO,'') AS  BILL_NO,cmm.CM_DT  BILL_DT, a.quantity  QTY,    
 cust.CUSTOMER_FNAME  AS NAME, cust.EMAIL AS EMAIL, cust.MOBILE,  
 ar.AREA_NAME AS AREA_NAME ,ct.CITY AS CITY_NAME ,st.STATE AS STATE_NAME ,
 L.CONTACT_NO,'Challan Receive at Head Office' AS HBD_STATUS_NAME  , L.DEPT_ALIAS ,L.PHONE ,A.JOB_RATE AMOUNT
 FROM hold_back_deliver_det   A (NOLOCK)     
 JOIN HOLD_BACK_DELIVER_MST B (NOLOCK) ON A.memo_id  = B.MEMO_ID    
 LEFT JOIN cmd01106 C (NOLOCK) ON A.ref_cmd_row_id  =C.ROW_ID 
 left join cmm01106 cmm (nolock) on c.cm_id =cmm.cm_id 
 JOIN custdym cust  (NOLOCK) ON B.CUSTOMER_CODE = cust.CUSTOMER_CODE   
 JOIN AREA ar ON Ar.AREA_CODE = cust.AREA_CODE     
 JOIN CITY Ct ON ct.CITY_CODE = ar.CITY_CODE     
 JOIN STATE st ON st.STATE_CODE = ct.STATE_CODE   
 JOIN LOCATION L on b.location_Code = L.dept_id   
 WHERE   isnull(cust.mobile,'')<>''    
 and b.cancelled=0  AND  A.ROW_ID =@CWHERE
  
GOTO LAST   



MSC41:  

select top 1 'HRL' XN_TYPE, b.memo_id AS  UNQ_ID,ISNULL(cmm.CM_NO,'') AS  BILL_NO,cmm.CM_DT  BILL_DT, a.quantity QTY,    
 cust.CUSTOMER_FNAME  AS NAME, cust.EMAIL AS EMAIL, cust.MOBILE,  
 ar.AREA_NAME AS AREA_NAME ,ct.CITY AS CITY_NAME ,st.STATE AS STATE_NAME ,
 L.CONTACT_NO,'Challan Receive at Location' AS HBD_STATUS_NAME  , L.DEPT_ALIAS ,L.PHONE ,A.JOB_RATE AMOUNT
 FROM hold_back_deliver_det  A (NOLOCK)     
 JOIN HOLD_BACK_DELIVER_MST B (NOLOCK) ON A.memo_id = B.MEMO_ID  
 LEFT JOIN CMD01106 C (NOLOCK) ON A.REF_CMD_ROW_ID  =C.ROW_ID 
 LEFT JOIN CMM01106 CMM (NOLOCK) ON C.CM_ID =CMM.CM_ID 
 JOIN custdym cust  (NOLOCK) ON B.CUSTOMER_CODE = cust.CUSTOMER_CODE   
 JOIN AREA ar ON Ar.AREA_CODE = cust.AREA_CODE     
 JOIN CITY Ct ON ct.CITY_CODE = ar.CITY_CODE     
 JOIN STATE st ON st.STATE_CODE = ct.STATE_CODE   
 JOIN LOCATION L on b.location_Code = L.dept_id   
 WHERE  isnull(cust.mobile,'')<>''    
 and b.cancelled=0  AND  A.ROW_ID =@CWHERE    
  
GOTO LAST   
  
  

  
    
LAST:    
  
  
     
       
END    