
CREATE PROCEDURE SPPPC_BUYERORDER_PENDING_PO      
(      
 @CORDER_ID VARCHAR(MAX)='',  
 @CARTICLE_TYPE INT='5'    
)      
AS      
BEGIN    
  
   DECLARE @CORDERSTATUS VARCHAR(MAX),@DTSQL NVARCHAR(MAX)  
      
 IF @CORDER_ID=''    
 BEGIN    
    SET @CORDERSTATUS=''    
    SET @CORDER_ID='IN('''')'    
 END    
 ELSE     
 BEGIN    
    SET @CORDERSTATUS='LATER'    
 END       
   
   
       IF OBJECT_ID('TEMPDB..#TMPDQRQ','U') IS NOT NULL  
             DROP TABLE #TMPDQRQ  
            
          SELECT B.BO_BOM_ROW_ID ,SUM(QUANTITY) as DQRQ_QTY   
          INTO #TMPDQRQ  
          FROM PPC_DQ_DET  B  
    JOIN PPC_DQRQ_MST C ON C.MEMO_ID=B.MEMO_ID  
    WHERE C.CANCELLED=0  
    --WHERE C.MEMO_ID = @CXNID    
    group by B.BO_BOM_ROW_ID   
    UNION ALL  
    SELECT C.BO_BOM_ROW_ID ,(-1)*SUM(C.QUANTITY) as DQRQ_QTY   
          FROM PPC_DQ_DET  B  
          JOIN PPC_RQ_DET C ON B.ROW_ID=C.REF_ROW_ID  
    JOIN PPC_DQRQ_MST D ON D.MEMO_ID=B.MEMO_ID  
    WHERE D.CANCELLED=0  
    --WHERE C.MEMO_ID = @CXNID    
    group by C.BO_BOM_ROW_ID   
                             
   SET @DTSQL=N' SELECT --(C.QUANTITY-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))),AVG_QTY,      
             A.AC_CODE AS BUYER_CODE,B.AC_NAME AS BUYER,A.ORDER_NO+''/''+CONVERT(VARCHAR,ORDER_DT,105) AS BO_DETAILS,      
            D.BOM_ARTICLE_CODE AS ARTICLE_CODE,ART.ARTICLE_NO AS SKU,ART.ARTICLE_NAME,SD.SUB_SECTION_NAME,   
            CASE WHEN ISNULL(UC.Conversion_Value,0)=0 THEN  
           CAST(CAST(C.QUANTITY*AVG_QTY AS NUMERIC(12,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(10,3)) ELSE   
           CAST(CAST((C.QUANTITY*AVG_QTY)/UC.Conversion_Value AS NUMERIC(12,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(10,3))  
           END+ISNULL(DQRQ.DQRQ_QTY,0)  AS  REQ_QTY,    
            CAST(0 AS NUMERIC(12,3)) AS ADDITIONAL_QTY,   
           CASE WHEN ISNULL(UC.Conversion_Value,0)=0 THEN  
           CAST(CAST(C.QUANTITY*AVG_QTY AS NUMERIC(12,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(10,3)) ELSE   
           CAST(CAST((C.QUANTITY*AVG_QTY)/UC.Conversion_Value AS NUMERIC(12,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(10,3))  
           END+ISNULL(DQRQ.DQRQ_QTY,0)  AS TOTAL_REQ_QTY,     
            CAST(0 AS BIT) AS RAISE_PO,      
           CASE WHEN ISNULL(UC.Conversion_Value,0)=0 THEN  
           CAST(CAST(C.QUANTITY*AVG_QTY AS NUMERIC(12,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(10,3)) ELSE   
           CAST(CAST((C.QUANTITY*AVG_QTY)/UC.Conversion_Value AS NUMERIC(12,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(10,3))  
           END+ISNULL(DQRQ.DQRQ_QTY,0)  AS  PO_QTY,    
            CAST(0 AS NUMERIC(12,0)) AS  BALANCE,    
            CAST('''' AS VARCHAR(100)) AS AC_CODE,   
             CAST('''' AS VARCHAR(100)) AS SUPPLIER,      
            REPLACE(CONVERT(VARCHAR(12),GETDATE(),106),'' '',''/'') AS FM_DT,      
            REPLACE(CONVERT(VARCHAR(12),GETDATE(),106),'' '',''/'') AS DELIVERY_DT,      
            CAST('''' AS VARCHAR(1000 )) AS REMARKS ,      
            D.RATE,A.REF_NO,UOM.UOM_NAME,D.ROW_ID AS BO_BOM_ROW_ID,a.BILL_NO ,C.PARA3_CODE ,  
            BU.CONVERSION_UOM_NAME AS BOM_UOM_NAME,  
            CAST(CAST(C.QUANTITY*AVG_QTY AS NUMERIC(18,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(18,3)) AS BOM_QTY  ,  
            ISNULL(P1.PARA1_CODE,''0000000'') AS PARA1_CODE,ISNULL(P1.PARA1_NAME,'''') AS PARA1_NAME,  
            ISNULL(P2.PARA2_CODE,''0000000'') AS PARA2_CODE,  
            ISNULL(P2.PARA2_NAME,'''') AS PARA2_NAME,  
            ISNULL(P3.PARA3_NAME,'''') AS BUYER_STYLE_NO,  
            C.ITEM_REMARKS AS WSL_REMARKS,  
            ISNULL(ART.HSN_CODE,''0000000000'') AS HSN_CODE,  
            ISNULL(ART.TOLERANCE_PERCENTAGE,0) AS TOLERANCE_PERCENTAGE  
            ,ISNULL(SM.SECTION_NAME,'''')SECTION_NAME  
            ,C.QUANTITY AS BO_QTY  
     FROM PPC_BUYER_ORDER_MST A      
     JOIN PPC_BUYER_ORDER_DET C ON A.ORDER_ID=C.ORDER_ID      
     JOIN PPC_BO_ART_BOM D ON C.ROW_ID=D.REF_ROW_ID      
     JOIN LM01106 B ON A.AC_CODE=B.AC_CODE      
     JOIN ARTICLE ART ON ART.ARTICLE_CODE=D.BOM_ARTICLE_CODE    
     JOIN SECTIOND SD ON SD.sub_section_code=ART.sub_section_code  
     JOIN SECTIONM SM ON SM.section_code=SD.section_code  
     LEFT OUTER JOIN PARA1 P1 ON P1.PARA1_NAME=COLOR_NAME    
     LEFT OUTER JOIN PARA2 P2 ON P2.PARA2_NAME=SIZE  
     LEFT OUTER JOIN PARA3 P3 ON P3.PARA3_CODE=C.PARA3_CODE  
     JOIN UOM ON UOM.UOM_CODE=ART.UOM_CODE   
     LEFT JOIN PPC_UOM_CONVERSION UC ON UOM.UOM_CODE=UC.UOM_CODE   
     LEFT JOIN PPC_BOM_UOM BU ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE      
     LEFT  JOIN      
     (      
      SELECT BO_BOM_ROW_ID,SUM(B.QUANTITY) AS QUANTITY,SUM(ADDITIONAL_QTY) AS ADDITIONAL_QTY      
      FROM  PPC_POM01106 A      
      JOIN PPC_POD01106 B ON A.PO_ID=B.PO_ID      
      WHERE A.CANCELLED=0      
      GROUP BY BO_BOM_ROW_ID      
     ) PO ON PO.BO_BOM_ROW_ID=D.ROW_ID   
     LEFT OUTER JOIN  
     (  
      SELECT BO_BOM_ROW_ID,DQRQ_QTY   
      FROM #TMPDQRQ  
     ) DQRQ ON DQRQ.BO_BOM_ROW_ID=D.ROW_ID   
     WHERE A.CANCELLED=0      
     AND ('''+RTRIM(LTRIM(@CORDERSTATUS))+'''='''' OR A.BILL_NO '+@CORDER_ID+')     
     AND ('''+RTRIM(LTRIM(@CARTICLE_TYPE))+'''=''0'' OR ART.ARTICLE_TYPE='''+RTRIM(LTRIM(@CARTICLE_TYPE))+''')    
     and  CASE WHEN ISNULL(UC.Conversion_Value,0)=0 THEN  
           CAST(CAST(C.QUANTITY*AVG_QTY AS NUMERIC(12,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(10,3))  
           ELSE CAST(CAST((C.QUANTITY*AVG_QTY)/UC.Conversion_Value AS NUMERIC(12,3))-(ISNULL(PO.QUANTITY,0)-ISNULL(ADDITIONAL_QTY,0))  AS NUMERIC(10,3)) END+ISNULL(DQRQ.DQRQ_QTY,0) >0    
           ORDER BY ISNULL(SM.SECTION_NAME,''''),ART.ARTICLE_No'  
     print @DTSQL  
     exec sp_executesql @DTSQL  
            
          
     --PPC_BO_ART_JOBS_CONSUME      
      
END   

