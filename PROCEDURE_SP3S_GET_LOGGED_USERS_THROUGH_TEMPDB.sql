CREATE PROCEDURE SP3S_GET_LOGGED_USERS_THROUGH_TEMPDB
(
	@bShowResult BIT=1
)
AS
BEGIN
	--IF OBJECT_ID('tempdb..#SSPLLogin','U') IS NOT NULL
	--DROP TABLE #SSPLLogin

	IF OBJECT_ID('tempdb..#SSPLLogin','U') IS NULL
	BEGIN
		SELECT CAST('' AS VARCHAR(MAX)) AS WINDOW_USER_NAME,CAST('' AS VARCHAR(MAX)) AS COMPUTER_NAME,CAST('' AS VARCHAR(MAX)) AS LOGIN_NAME
		,CAST('' AS DATETIME) AS LOGIN_TIME,CAST('' AS VARCHAR(MAX)) AS SP_ID,CAST('' AS VARCHAR(MAX)) AS LOCATION_ID,CAST('' AS VARCHAR(MAX)) AS BIN_ID
		INTO #SSPLLogin
		WHERE 1=2
	END
	TRUNCATE TABLE #SSPLLogin
	DECLARE @cTableName VARCHAR(MAX),@cCMD NVARCHAR(MAX)
	DECLARE SSPL_LOGIN CURSOR 
	FOR
	select name 
	from tempdb.sys.tables(NOLOCK) where name like '%'+DB_NAME()+'_TMP_login%'

	OPEN SSPL_LOGIN


	FETCH NEXT FROM SSPL_LOGIN INTO @cTableName
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @cCMD=N'INSERT INTO #SSPLLogin(WINDOW_USER_NAME,COMPUTER_NAME,LOGIN_NAME,LOGIN_TIME,SP_ID,LOCATION_ID,BIN_ID)
					SELECT WINDOW_USER_NAME,COMPUTER_NAME,LOGIN_NAME,LAST_UPDATE,SP_ID,LOCATION_ID,BIN_ID FROM '+@cTableName
		EXEC SP_EXECUTESQL @CCMD
	FETCH NEXT FROM SSPL_LOGIN INTO @cTableName
	END 

	CLOSE SSPL_LOGIN
	DEALLOCATE SSPL_LOGIN

	IF @bShowResult=1
	BEGIN
		SELECT * FROM #SSPLLOgin ORDER BY LOGIN_TIME DESC
	END
END