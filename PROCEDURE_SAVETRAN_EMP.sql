create PROCEDURE SAVETRAN_EMP
(
	@NUPDATEMODE		NUMERIC(1,0),
	@NSPID				INT,
	@CMEMONOPREFIX		VARCHAR(50),
	@CFINYEAR			VARCHAR(10),
	@CMACHINENAME		VARCHAR(100)='',
	@CWINDOWUSERNAME	VARCHAR(100)='',
	@CWIZAPPUSERCODE	VARCHAR(10)='0000000',
	@CXNMEMOID			VARCHAR(40)='',
	@CLOCID				VARCHAR(4)='',
	@CEMP_ID			VARCHAR(30)=''
		
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CTEMPDBNAME			VARCHAR(100),
			@CMASTERTABLENAME		VARCHAR(100),
			@CTEMPMASTERTABLE		VARCHAR(100),
			@CERRORMSG				VARCHAR(500),
			@CKEYFIELDVAL1			VARCHAR(50),
			@CCMD					NVARCHAR(4000),
			@NSTEP					INT,
			
			@CHR_EMP_MST_CONTACT_DETAILS VARCHAR(100),
			@CHR_EMP_MST_PROFILE_DETAILS VARCHAR(100),
			@CHR_EMP_MST_SALARY_DETAILS VARCHAR(100),
			@CHR_EMP_SALARY_PROFILE VARCHAR(100),
			@CHR_EMP_DOCS_MST		VARCHAR(100),
			
			@CTEMPMASTERTABLENAME VARCHAR(100),
			@CHR_EMP_MST_CONTACT_DETAILSNAME VARCHAR(100),
			@CHR_EMP_MST_PROFILE_DETAILSNAME VARCHAR(100),
			@CHR_EMP_MST_SALARY_DETAILSNAME VARCHAR(100),
			@CHR_EMP_SALARY_PROFILENAME VARCHAR(100),
			@CHR_EMP_DOCS_MSTNAME VARCHAR(100),
			
			@CTEMPHR_EMP_MST_CONTACT_DETAILS VARCHAR(100),
			@CTEMPHR_EMP_MST_PROFILE_DETAILS VARCHAR(100),
			@CTEMPHR_EMP_MST_SALARY_DETAILS VARCHAR(100),
			@CTEMPHR_EMP_PAY	VARCHAR(100),
			@CTEMPHR_EMP_SALARY_PROFILE VARCHAR(100),
			@CTEMPHR_EMP_DOCS_MST VARCHAR(100),
			@NSAVETRANLOOP NUMERIC(3,0),
			@CKEYFILD1 VARCHAR(100),@CKEYFILD2 VARCHAR(100)
			

	DECLARE @OUTPUT TABLE (ERRMSG VARCHAR(2000), MEMO_ID VARCHAR(100))

	SET @NSTEP = 10		-- SETTTING UP ENVIRONMENT
	SET @CTEMPDBNAME = ''

	SET @NSTEP = 50
	SET @CMASTERTABLENAME	= 'HR_EMP_MST'
	SET @CHR_EMP_MST_CONTACT_DETAILS = 'HR_EMP_MST_CONTACT_DETAILS'
	SET @CHR_EMP_MST_PROFILE_DETAILS = 'HR_EMP_MST_PROFILE_DETAILS'
	SET @CHR_EMP_MST_SALARY_DETAILS  =  'HR_EMP_MST_SALARY_DETAILS'
	SET @CHR_EMP_SALARY_PROFILE = 'HR_EMP_SALARY_PROFILE'
	SET @CHR_EMP_DOCS_MST		= 'HR_EMP_DOCS_MST'
	
	SET @NSTEP = 60
	SET @CTEMPMASTERTABLENAME	= 'TEMP_HR_EMP_MST_'+LTRIM(RTRIM(STR(@NSPID)))
	SET @CHR_EMP_MST_CONTACT_DETAILSNAME = 'TEMP_HR_EMP_MST_CONTACT_DETAILS_'+LTRIM(RTRIM(STR(@NSPID)))
	SET @CHR_EMP_MST_PROFILE_DETAILSNAME = 'TEMP_HR_EMP_MST_PROFILE_DETAILS_'+LTRIM(RTRIM(STR(@NSPID)))
	SET @CHR_EMP_MST_SALARY_DETAILSNAME  =  'TEMP_HR_EMP_MST_SALARY_DETAILS_'+LTRIM(RTRIM(STR(@NSPID)))
	SET @CHR_EMP_SALARY_PROFILENAME = 'TEMP_HR_EMP_SALARY_PROFILE_'+LTRIM(RTRIM(STR(@NSPID)))
	SET @CHR_EMP_DOCS_MSTNAME		= 'TEMP_HR_EMP_DOCS_MST_'+LTRIM(RTRIM(STR(@NSPID)))
	
	SET @NSTEP = 70
	SET @CTEMPMASTERTABLE = @CTEMPDBNAME+@CTEMPMASTERTABLENAME
	SET @CTEMPHR_EMP_MST_CONTACT_DETAILS = @CTEMPDBNAME+@CHR_EMP_MST_CONTACT_DETAILSNAME
	SET @CTEMPHR_EMP_MST_PROFILE_DETAILS = @CTEMPDBNAME+@CHR_EMP_MST_PROFILE_DETAILSNAME
	SET @CTEMPHR_EMP_MST_SALARY_DETAILS  = @CTEMPDBNAME+@CHR_EMP_MST_SALARY_DETAILSNAME
	SET @CTEMPHR_EMP_SALARY_PROFILE		 = @CTEMPDBNAME+@CHR_EMP_SALARY_PROFILENAME
	SET @CTEMPHR_EMP_DOCS_MST			 = @CTEMPDBNAME+@CHR_EMP_DOCS_MSTNAME
	
	
	SET @CKEYFILD1 = 'EMP_ID'
	SET @CKEYFILD2 = 'WEF_DATE'
	
	BEGIN TRY
		IF (@NUPDATEMODE = 1)
		BEGIN
		    BEGIN TRAN
				-- GENERATING NEW EMPLOYE ID
				
				SET @NSTEP = 90
				SET @NSAVETRANLOOP=0
				WHILE @NSAVETRANLOOP=0
				BEGIN
				EXEC GETNEXTKEY	@CTABLENAME=@CMASTERTABLENAME,
								@CCOLNAME = @CKEYFILD1,
								@NWIDTH = 7,
								@CPREFIX = '',
								@NLZEROS = 1,
								@CFINYEAR ='',
								@NROWCOUNT='',
								@CNEWKEYVAL=@CEMP_ID OUTPUT
					
					SET @CCMD=N'IF EXISTS ( SELECT '+@CKEYFILD1+' FROM '+@CMASTERTABLENAME+' 
											WHERE '+@CKEYFILD1+'='''+@CEMP_ID+''')
									SET @NLOOPOUTPUT=0
								ELSE
									SET @NLOOPOUTPUT=1'
					PRINT @CCMD
					EXEC SP_EXECUTESQL @CCMD, N'@NLOOPOUTPUT BIT OUTPUT',@NLOOPOUTPUT=@NSAVETRANLOOP OUTPUT
				END

				SET @NSTEP = 120
				IF ISNULL (@CEMP_ID,'') = '' 
				BEGIN
					  SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR CREATING NEXT EMP ID....'	
					  GOTO END_PROC		
				END
				
				SET @NSTEP = 150
					SET @CCMD = N'UPDATE '+@CTEMPMASTERTABLE+' SET '+@CKEYFILD1+' = '''+@CEMP_ID+''' WHERE LEFT('+@CKEYFILD1+',5) = ''LATER'''
					PRINT @CCMD
					EXEC SP_EXECUTESQL @CCMD
				
			SET @CKEYFIELDVAL1 = @CEMP_ID		
				
		END
		IF (@NUPDATEMODE = 2)
		BEGIN
				SET @NSTEP = 250
				IF ISNULL(@CEMP_ID,'') = ''
				BEGIN
					SET @CERRORMSG = 'EMP_ID REQUIRED AT EDIT MODE.'
				END	
				SET @CKEYFIELDVAL1 = @CEMP_ID
				
		END
		
		SET @NSTEP = 270
			SET @CCMD = N'UPDATE '+@CTEMPHR_EMP_MST_CONTACT_DETAILS+' SET '+@CKEYFILD1+' = '''+@CEMP_ID+''' WHERE LEFT('+@CKEYFILD1+',5) = ''LATER'''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD	
			
		SET @NSTEP = 290
			SET @CCMD = N'UPDATE '+@CTEMPHR_EMP_MST_PROFILE_DETAILS+' SET '+@CKEYFILD1+' = '''+@CEMP_ID+''' WHERE LEFT('+@CKEYFILD1+',5) = ''LATER'''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
		
		SET @NSTEP = 310
			SET @CCMD = N'UPDATE '+@CTEMPHR_EMP_MST_SALARY_DETAILS+' SET '+@CKEYFILD1+' = '''+@CEMP_ID+''' WHERE LEFT('+@CKEYFILD1+',5) = ''LATER'''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
		
		SET @NSTEP = 330
			SET @CCMD = N'UPDATE '+@CHR_EMP_SALARY_PROFILE+' SET '+@CKEYFILD1+' = '''+@CEMP_ID+''' WHERE LEFT('+@CKEYFILD1+',5) = ''LATER'''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
		SET @NSTEP = 350
			SET @CCMD = N'UPDATE '+@CHR_EMP_DOCS_MST+' SET '+@CKEYFILD1+' = '''+@CEMP_ID+''' WHERE LEFT('+@CKEYFILD1+',5) = ''LATER'''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD	
				
		SET @NSTEP = 370
			SET @CCMD = N'UPDATE '+@CTEMPHR_EMP_DOCS_MST+' SET '+@CKEYFILD1+' = '''+@CEMP_ID+''' WHERE LEFT('+@CKEYFILD1+',5) = ''LATER'''	
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
		--INSERT UPDATE HR_EMP_MST
		SET @NSTEP = 470
		EXEC UPDATEMASTERXN 
			    @CSOURCEDB = @CTEMPDBNAME,
				@CSOURCETABLE = @CTEMPMASTERTABLENAME,
				@CDESTDB = '',
				@CDESTTABLE =@CMASTERTABLENAME,
				@CKEYFIELD1 = @CKEYFILD1,
				@CKEYFIELD2 = '',
				@CKEYFIELD3 = '',
				@LINSERTONLY = 0
		
		--INSERT UPDATE HR_EMP_MST_CONTACT_DETAILS
		SET @NSTEP = 490
		EXEC UPDATEMASTERXN 
			    @CSOURCEDB = @CTEMPDBNAME,
				@CSOURCETABLE = @CHR_EMP_MST_CONTACT_DETAILSNAME,
				@CDESTDB = '',
				@CDESTTABLE =@CHR_EMP_MST_CONTACT_DETAILS,
				@CKEYFIELD1 = @CKEYFILD1,
				@CKEYFIELD2 = @CKEYFILD2,
				@CKEYFIELD3 = '',
				@LINSERTONLY = 0,
				@BALWAYSUPDATE=1
			
		--INSERT UPDATE HR_EMP_MST_PROFILE_DETAILS
		SET @NSTEP = 510
		EXEC UPDATEMASTERXN 
			    @CSOURCEDB = @CTEMPDBNAME,
				@CSOURCETABLE = @CHR_EMP_MST_PROFILE_DETAILSNAME,
				@CDESTDB = '',
				@CDESTTABLE =@CHR_EMP_MST_PROFILE_DETAILS,
				@CKEYFIELD1 = @CKEYFILD1,
				@CKEYFIELD2 = @CKEYFILD2,
				@CKEYFIELD3 = '',
				@LINSERTONLY = 0,
				@BALWAYSUPDATE=1						
			
		--INSERT UPDATE HR_EMP_MST_SALARY_DETAILS
		SET @NSTEP = 530
		EXEC UPDATEMASTERXN 
			    @CSOURCEDB = @CTEMPDBNAME,
				@CSOURCETABLE = @CHR_EMP_MST_SALARY_DETAILSNAME,
				@CDESTDB = '',
				@CDESTTABLE =@CHR_EMP_MST_SALARY_DETAILS,
				@CKEYFIELD1 = @CKEYFILD1,
				@CKEYFIELD2 = @CKEYFILD2,
				@CKEYFIELD3 = '',
				@LINSERTONLY = 0,
				@BALWAYSUPDATE=1	
		
		--INSERT UPDATE HR_EMP_SALARY_PROFILE
		SET @NSTEP = 550
		EXEC UPDATEMASTERXN 
			    @CSOURCEDB = @CTEMPDBNAME,
				@CSOURCETABLE = @CHR_EMP_SALARY_PROFILENAME,
				@CDESTDB = '',
				@CDESTTABLE = @CHR_EMP_SALARY_PROFILE,
				@CKEYFIELD1 = @CKEYFILD1,
				@CKEYFIELD2 = @CKEYFILD2,
				@CKEYFIELD3 = 'PAY_ID',
				@LINSERTONLY = 0,
				@BALWAYSUPDATE=1	
	
		SET @NSTEP = 560
		EXEC UPDATEMASTERXN 
			    @CSOURCEDB = @CTEMPDBNAME,
				@CSOURCETABLE = @CHR_EMP_DOCS_MSTNAME,
				@CDESTDB = '',
				@CDESTTABLE = @CHR_EMP_DOCS_MST,
				@CKEYFIELD1 = @CKEYFILD1,
				@LINSERTONLY = 0,
				@BALWAYSUPDATE=1					
		
									
	END TRY
	BEGIN CATCH
		SET @CERRORMSG = 'P:- SAVETRAN_EMP STEP- ' + RTRIM(LTRIM(STR(@NSTEP))) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		GOTO END_PROC
	END CATCH
	
END_PROC:

	INSERT @OUTPUT ( ERRMSG, MEMO_ID)
		VALUES ( ISNULL(@CERRORMSG,''), ISNULL(@CKEYFIELDVAL1,'') )
		
	SELECT * FROM @OUTPUT
	
		---DROPPING TEMP TABLES
	IF ISNULL(@CERRORMSG,'') = ''
	BEGIN
		SET @CCMD = N'IF OBJECT_ID('''+@CTEMPMASTERTABLE+''',''U'') IS NOT NULL
						DROP TABLE '+@CTEMPMASTERTABLE+'
					IF OBJECT_ID('''+@CTEMPHR_EMP_MST_CONTACT_DETAILS+''',''U'') IS NOT NULL
						DROP TABLE '+@CTEMPHR_EMP_MST_CONTACT_DETAILS+'
					IF OBJECT_ID('''+@CTEMPHR_EMP_MST_PROFILE_DETAILS+''',''U'') IS NOT NULL
						DROP TABLE '+@CTEMPHR_EMP_MST_PROFILE_DETAILS+'
					IF OBJECT_ID('''+@CTEMPHR_EMP_MST_SALARY_DETAILS+''',''U'') IS NOT NULL
						DROP TABLE '+@CTEMPHR_EMP_MST_SALARY_DETAILS+'
					IF OBJECT_ID('''+@CTEMPHR_EMP_SALARY_PROFILE+''',''U'') IS NOT NULL
						DROP TABLE '+@CTEMPHR_EMP_SALARY_PROFILE+'
					IF OBJECT_ID('''+@CTEMPHR_EMP_DOCS_MST+''',''U'') IS NOT NULL
						DROP TABLE '+@CTEMPHR_EMP_DOCS_MST+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
    END	
	
	IF @@TRANCOUNT>0 AND ISNULL(@CERRORMSG,'') = ''
			COMMIT TRANSACTION
	ELSE	
			ROLLBACK
	
END						
------------------------------------------------------ END OF PROCEDURE SAVETRAN_EMP
