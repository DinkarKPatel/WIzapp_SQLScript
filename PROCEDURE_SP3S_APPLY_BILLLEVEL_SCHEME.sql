CREATE PROCEDURE SP3S_APPLY_BILLLEVEL_SCHEME
@nSpId VARCHAR(50),
@dXnDt DATETIME,
@CCURDEPTID VARCHAR(5),
@BWIZCLIPCUSTOMER bit,
@CMANUALSCHEMESETMEMONO VARCHAR(50),
@cErrormsg VARCHAR(MAX) OUTPUT
AS
BEGIN
	DECLARE @cCmd NVARCHAR(MAX),@cPromSchemeId VARCHAR(10),@CSCHEMEDETROWID VARCHAR(50),@CPROCNAME VARCHAR(200)

	SELECT TOP 1 @cPromSchemeId=a.promotional_scheme_id,@CSCHEMEDETROWID=a.row_id FROM SCHEME_SETUP_DET A (NOLOCK)
		LEFT OUTER JOIN PROMOTIONAL_SCHEMES_MST C (NOLOCK) ON C.PROMOTIONAL_SCHEME_ID=A.PROMOTIONAL_SCHEME_ID
		JOIN SCHEME_SETUP_MST D (NOLOCK) ON D.MEMO_NO=A.MEMO_NO
		LEFT OUTER JOIN SCHEME_SETUP_HAPPYHOURS HH (NOLOCK) ON HH.MEMO_NO=D.MEMO_NO
		LEFT OUTER JOIN SCHEME_SETUP_LOC G (NOLOCK) ON G.MEMO_NO=D.MEMO_NO
		LEFT OUTER JOIN SCHEME_SETUP_WEEKDAYS_DETAILS WD (NOLOCK) ON WD.SCHEME_SETUP_DET_ROW_ID=A.ROW_ID 
		AND WD.WEEKDAY_NAME=DATENAME(WEEKDAY,GETDATE())
		WHERE (A.SCHEME_MODE=2 OR A.FILTER_MODE<>2)  AND @DXNDT BETWEEN D.APPLICABLE_FROM_DT AND D.APPLICABLE_TO_DT
		AND A.SCHEME_MODE=2	AND (G.DEPT_ID=@CCURDEPTID OR G.MEMO_NO IS NULL)
		AND (ISNULL(A.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR @BWIZCLIPCUSTOMER=1)
		AND D.INACTIVE=0
		AND (HH.MEMO_NO IS NULL OR HAPPY_HOURS_RESTRICTION_APPLICABLE=0 OR CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,GETDATE()))))+':'+
		LTRIM(RTRIM(STR(DATEPART(MI,GETDATE()))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,GETDATE())))))
		BETWEEN 
		CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,FROM_TIME))))+':'+
		LTRIM(RTRIM(STR(DATEPART(MI,FROM_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,FROM_TIME)))))
		AND
		CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,TO_TIME))))+':'+
		LTRIM(RTRIM(STR(DATEPART(MI,TO_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,TO_TIME))))))
		AND (ISNULL(WEEKDAY_WISE_APPLICABLE,0)=0 OR WD.SELECTED=1)
		AND (D.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')
		AND ISNULL(C.BILL_LEVEL_SCHEME,0)=1
		ORDER BY D.MEMO_PROCESSING_ORDER,D.MEMO_NO DESC,PROCESSING_ORDER
	

	IF @cPromSchemeId IS NOT NULL
	BEGIN
		UPDATE A WITH (ROWLOCK) SET subtotal=b.subtotal FROM   
		sls_cmm01106_upload A JOIN (SELECT sp_id,sum(net) subtotal FROM  sls_cmd01106_upload (NOLOCK)
		WHERE sp_id=@nSPid GROUP by sp_id) b ON a.sp_id=b.sp_id
		WHERE a.sp_id=@nSpId

		IF @cPromSchemeId='SCHB002'
			EXEC SP3S_EOSS_SCHEMES_BILLMST_2
			@nSpId=@nSpId,
			@CSCHEMEDETROWID=@CSCHEMEDETROWID,
			@cErrormsg=@cErrormsg OUTPUT
		ELSE
			EXEC SP3S_EOSS_SCHEMES_BILLMST_1
			@nSpId=@nSpId,
			@CSCHEMEDETROWID=@CSCHEMEDETROWID,
			@cErrormsg=@cErrormsg OUTPUT

	--if @@spid=127
	--	select @cPromSchemeId,BILL_LEVEL_DISCOUNT_PERCENTAGE,BILL_LEVEL_DISCOUNT_amount from #tmpslsdisctaxopt 

	END
END
