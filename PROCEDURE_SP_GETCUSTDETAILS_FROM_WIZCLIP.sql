CREATE PROCEDURE SP_GETCUSTDETAILS_FROM_WIZCLIP
@CMOBILE VARCHAR(50),
@CCUSTOMERCODE CHAR(12),
@NDOWNLOADTYPE INT=1,
@DMEMODT DATETIME='',
@BRETVAL BIT OUTPUT,
@CERRMSG VARCHAR(1000) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
		
	BEGIN TRY
		
		DECLARE @BCUSTOMERVALID BIT,@DSTARTTIME DATETIME,@DLASTCHECKTIME DATETIME,@CFILTERCONDITION VARCHAR(200),
		@CAREATABLENAME VARCHAR(50),@CCMD NVARCHAR(MAX),@NSTEP INT,@CLOCATIONID CHAR(2),@CAREACODE CHAR(7),
		@CNEXTAREACODE CHAR(7),@CTEMPTABLE VARCHAR(100),@CERRORPROCNAME VARCHAR(100),@CLINENO VARCHAR(5),@CERRTEXT VARCHAR(MAX)
		
		
		BEGIN TRANSACTION

		SELECT @BRETVAL=1,@CERRMSG=''
		
		SET @NSTEP=10
		
			
		SET @NSTEP=80
		
		SET @CTEMPTABLE='TMP_CAMPAIGN_'+LTRIM(RTRIM(STR(@@SPID)))
								
		
		IF @NDOWNLOADTYPE=2
			GOTO LBLUPDATECUSTDYM
				
		SET @NSTEP=90
		
		SET @CCMD=N'UPDATE '+@CTEMPTABLE+' SET  DISTT_CODE=''0000000'',
					CITY_CODE=(CASE WHEN CITY_CODE IS NULL OR CITY='''' OR STATE_CODE IS NULL OR STATE=''''
									THEN ''0000000'' ELSE CITY_CODE END),
					STATE_CODE=(CASE WHEN STATE_CODE IS NULL OR STATE='''' THEN ''0000000'' ELSE STATE_CODE END)'
		EXEC SP_EXECUTESQL @CCMD
		
		SET @NSTEP=100
		
		SET @CCMD=N'UPDATE '+@CTEMPTABLE+' SET  STATE=(CASE WHEN STATE_CODE IS NULL OR STATE_CODE=''0000000'' THEN '''' ELSE STATE END),
												CITY=(CASE WHEN CITY_CODE IS NULL OR CITY_CODE=''0000000'' THEN '''' ELSE CITY END)'
		EXEC SP_EXECUTESQL @CCMD
		
		SET @NSTEP=110			
		
		SET @CCMD=N'UPDATE '+@CTEMPTABLE+' SET AREA_CODE=CITY_CODE, AREA_NAME=CITY'			
		EXEC SP_EXECUTESQL @CCMD
		
		
		LBLUPDATECUSTDYM:
		
		SET @NSTEP=115
					 
		EXEC UPDATECAMPAIGNCUSTDYM @NDOWNLOADTYPE,@CERRMSG OUTPUT			
		
		SET @NSTEP=117
		DECLARE @CUSerCustomerCode VARCHAR(50)

		DECLARE @tREtMsg TABLE (errmsg varchar(1000))

		SET @cCmd=N'SELECT TOP 1 @CCUSTOMERCODE=customer_code FROM '+@CTEMPTABLE
		EXEC SP_EXECUTESQL @cCmd,N'@CCUSTOMERCODE CHAR(12) OUTPUT',@CCUSTOMERCODE OUTPUT

		SET @NSTEP=119
		SELECT @Cmobile=mobile,@CUSerCustomerCode=user_customer_code FROM custdym (NOLOCK) 
		WHERE customer_code=@CCUSTOMERCODE

		SET @NSTEP=121
		INSERT @tREtMsg
		EXEC SP3S_CHECKNAMES_cust 
		@CCustCODE=@CCUSTOMERCODE,  
		@Cmobile=@Cmobile,  
		@CUSerCustomerCode=@CUSerCustomerCode

		SELECT TOP 1 @cErrmsg=errmsg from @tRetMsg

		IF ISNULL(@cErrmsg,'')<>''
			GOTO END_PROC

		SET @NSTEP=125			
		
		DELETE FROM CAMPAIGN_CUSTDYM WHERE ORG_MOBILE=@CMOBILE
		
		SET @NSTEP=130

		GOTO END_PROC

	END TRY
	
	BEGIN CATCH
		--IF @@TRANCOUNT>0
		--	ROLLBACK
					
		SELECT @CERRORPROCNAME=ISNULL(ERROR_PROCEDURE(),'NULL P'),@CLINENO=ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE'),
		@CERRTEXT=ISNULL(ERROR_MESSAGE(),'NULL MSG')
		

		SELECT @CERRMSG='STEP :'+ISNULL(LTRIM(RTRIM(STR(@NSTEP))),0)+' LINE NO. :'+@CLINENO+' MSG :'+@CERRTEXT
		
		
		DELETE FROM CAMPAIGN_CUSTDYM WHERE ORG_MOBILE=@CMOBILE
		
		GOTO END_PROC
	END CATCH

END_PROC:
	
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')=''
			COMMIT
		ELSE
			ROLLBACK
	END
		
END
------ 'END OF CREATING PROCEDURE--
