CREATE PROC VALIDATEXN_SLS_BEFORE_EDIT 
@CMEMOID VARCHAR(30),
@BCANCELXN BIT,
@nUpdateMode numeric(1,0),
@CERRORMSG VARCHAR(200) OUTPUT,
@CEXPRERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CTEXT VARCHAR(10)
	
	SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)
		
	IF EXISTS(SELECT TOP 1 CMM.CM_ID
			  FROM CMM01106 CMM 
			  JOIN DSD01106 DSD ON CMM.CM_ID=DSD.CM_ID
			  JOIN DSM01106 DSM ON DSD.DS_ID=DSM.DS_ID
			  WHERE CMM.CANCELLED=0 AND DSM.CANCELLED=0 AND CMM.CM_ID=@CMEMOID
			  )
	BEGIN
		SET @CERRORMSG='THIS CASH MEMO HAS ALREADY BEEN PAID....CANNOT '+@CTEXT
		RETURN
	END

	IF EXISTS(SELECT TOP 1 CM_ID FROM CMM01106 WHERE CM_ID=@CMEMOID AND CANCELLED=0 AND ISNULL(EINV_IRN_NO,'')<>'') AND @BCANCELXN<>1				  
	
	BEGIN
		SET @CERRORMSG='EINVOICE GENERATED.........CAN NOT '+@CTEXT
		RETURN
	END

	--IF SUBSTRING(@CMEMOID,5,1)='N'
	--BEGIN
		IF EXISTS(SELECT TOP 1 A.MEMO_ID FROM PAYMODE_XN_DET A JOIN CMM01106 B ON A.MEMO_ID=B.CM_ID
				  WHERE A.ADJ_MEMO_ID=@CMEMOID AND B.CANCELLED=0 AND A.XN_TYPE='SLS' AND A.PAYMODE_CODE='0000001')		
			  
		BEGIN
			SET @CERRORMSG='THIS CREDIT NOTE HAS BEEN SETTLED IN RETAIL SALES.........CAN NOT '+@CTEXT
			RETURN
		END
	
		IF EXISTS(SELECT TOP 1 A.MEMO_ID FROM PAYMODE_XN_DET A JOIN ARC01106 B ON A.MEMO_ID=B.ADV_REC_ID
				  WHERE A.ADJ_MEMO_ID=@CMEMOID AND B.CANCELLED=0 AND A.XN_TYPE='ARC' AND A.PAYMODE_CODE='0000001')				  
		BEGIN
			SET @CERRORMSG='THIS CREDIT NOTE HAS BEEN SETTLED IN CUSTOMER PAYMENT.........CAN NOT '+@CTEXT
			RETURN
		END
	--END
	IF EXISTS(SELECT A.CM_ID FROM CMM_CREDIT_RECEIPT A 
				JOIN ARC01106 B ON B.ADV_REC_ID=A.ADV_REC_ID
				WHERE B.CANCELLED=0 AND A.CM_ID=@CMEMOID)
	BEGIN
		SET @CERRORMSG='PAYMENT HAS BEEN TAKEN AGAINST THIS BILL IN CUSTOMER RECEIPT/PAYMENT.........CAN NOT '+@CTEXT
		RETURN	
	END
	/*Rohit 16-08-2023*/
	--IF EXISTS (SELECT A.CM_ID FROM CMM01106 A (NOLOCK) JOIN BIN B (NOLOCK) ON A.BIN_ID=B.BIN_ID WHERE CM_ID=@CMEMOID
	--		   AND B.MBO_COUNTER=1)
	--BEGIN
	--	SET @CERRORMSG='THIS BILL BELONGS TO MBO COUNTER.........CAN NOT '+@CTEXT
	--	RETURN
	--END

	IF @nUpdateMode<>5
	BEGIN
		IF EXISTS (SELECT TOP 1 A.memo_id FROM paymode_xn_det a
				   WHERE a.memo_id=@CMEMOID and xn_type='SLS' AND a.paymode_code='GVC0001')
		BEGIN
			SET @CERRORMSG='GV(s) adjusted information uploaded on Server...Cannot '+@CTEXT
			RETURN			
		END	
	END

	IF @nUpdateMode in(2,3)
	BEGIN
	DECLARE @cDeptID VARCHAR(5)/**//*Rohit 07-11-2024*/
	SELECT @cDeptID=location_Code FROM CMM01106 (NOLOCK) WHERE CM_ID=@cMemOId/**//*Rohit 07-11-2024*/
		DECLARE @bAutoCalAtdCharges BIT,@cJwIssueNo VARCHAR(10),@dJwIssueDt DATETIME,@cProductCode VARCHAR(50)
		SELECT TOP 1 @bAutoCalAtdCharges=ISNULL(AUTO_CALCULATION_OF_ALTERATION_CHARGES,0) FROM location
		WHERE dept_id=@cDeptID--LEFT(@cMemOId,2)/**//*Rohit 07-11-2024*/

		IF ISNULL(@bAutoCalAtdCharges,0)=1
		BEGIN
			SELECT TOP 1 @cJwIssueNo=issue_no,@dJwIssueDt=issue_dt,@cProductCode=d.PRODUCT_CODE 
			FROM post_sales_jobwork_issue_det a (NOLOCK)
					   JOIN post_sales_jobwork_issue_mst b (NOLOCK) ON a.issue_id=b.issue_id
					   JOIN hold_back_deliver_det c (NOLOCK) ON c.row_id=a.ref_hbd_row_id
					   JOIN cmd01106 d (NOLOCK) ON d.row_id=c.ref_cmd_row_id
					   WHERE d.cm_id=@CMEMOID AND b.cancelled=0

			IF ISNULL(@cJwIssueNo,'')<>''
			BEGIN
				SET @CERRORMSG='Item Code:'+@cProductCode+' has been in processing against Job work Issue#'+ @cJwIssueNo+'  Dated:'+
				CONVERT(VARCHAR,@dJwIssueDt,105)+'...Cannot Edit'


				RETURN	
			END
		END
	END
END
