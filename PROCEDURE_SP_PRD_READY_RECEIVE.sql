CREATE PROCEDURE SP_PRD_READY_RECEIVE        
 @NQUERYID NUMERIC (3,0) ,          
 @CMEMOID VARCHAR(40) = '',          
 @CWHERE  VARCHAR(500) = '',        
 @NNAVMODE NUMERIC(1,0) = 0,          
 @CFINYEAR VARCHAR(5)=''          
--WITH ENCRYPTION
          
AS       
BEGIN     
IF @NQUERYID = 1          
GOTO LBLGETMASTER            
            
ELSE IF @NQUERYID = 2          
GOTO LBLGETDETAIL            
          
ELSE IF @NQUERYID = 4            
GOTO LBLFORMS            
            
ELSE IF @NQUERYID = 5            
GOTO LBLCUSTOMER            
            
ELSE IF @NQUERYID = 6            
GOTO LBLSTOCKDETAILS            
            
ELSE IF @NQUERYID = 7            
GOTO LBLWODETAIL            
            
ELSE IF @NQUERYID = 8            
GOTO LBLWORKORDER            
            
ELSE IF @NQUERYID = 9            
GOTO LBLPRODUCTCODELIST            
          
ELSE IF @NQUERYID = 10              
GOTO LBLWPSMSTREP              
              
ELSE IF @NQUERYID = 11          
GOTO LBLWPSDETREP           
              
ELSE IF @NQUERYID = 12            
GOTO LBL12                 
            
ELSE            
GOTO LAST            
          
          
           
LBLGETMASTER:            
      SELECT T1.* ,LM.AC_CODE,LM.AC_NAME, WOM.MEMO_NO AS WO_NO,WOM.REF_NO,WOM.ARTICLE_SET_CODE ,ARTSET.ARTICLE_NO,    
LM.ADDRESS0,LM.ADDRESS1,LM.ADDRESS2,LM.AREA_NAME,LM.CITY,LM.STATE,LM.PINCODE AS [ADDRESS]    
FROM PRD_READY_RECEIVE_MST T1    
JOIN LMV01106 LM ON LM.AC_CODE=T1.AC_CODE    
JOIN PRD_WO_MST WOM ON WOM.MEMO_ID=T1.WORK_ORDER_ID    
JOIN ARTICLE ARTSET ON ARTSET.ARTICLE_CODE=WOM.ARTICLE_SET_CODE    
WHERE T1.MEMO_ID=@CMEMOID    
      
GOTO LAST            
            
LBLGETDETAIL:            
            
  SELECT T1.*,ROW_NUMBER() OVER (ORDER BY T1.TS) AS S_NO, WO.REF_NO  , ARTSET.ARTICLE_NO AS SET_NO,        
   B.ARTICLE_NO, B.ARTICLE_NAME, S.PARA1_CODE, S.PARA2_CODE, S.PARA3_CODE,           
 B.INACTIVE, ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,              
 S.MRP,S.WS_PRICE,  '' AS SCHEME_ID, SM.SECTION_NAME, SD.SUB_SECTION_NAME,              
 S.PARA4_CODE,S.PARA5_CODE,S.PARA6_CODE,           
 B.DT_CREATED AS [ART_DT_CREATED],S.DT_CREATED AS [SKU_DT_CREATED],              
 B.STOCK_NA,   T1.QUANTITY AS PREVQTY    
 ,B.UOM_CODE,ISNULL(T1.QUANTITY,0)*ISNULL(T1.RATE,0) AS AMOUNT,          
 P1.PARA1_NAME,P2.PARA2_NAME,P3.PARA3_NAME,P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME,U.UOM_NAME   
 ,AC.ARTICLE_NO AS COMPONENT,PC1.PARA1_NAME AS COM_PARA1_NAME,PC2.PARA2_NAME AS COM_PARA2_NAME         
 FROM PRD_READY_RECEIVE_DET T1          
 JOIN PRD_READY_RECEIVE_MST MST ON MST.MEMO_ID=T1.MEMO_ID   
 JOIN ARTICLE AC ON AC.ARTICLE_CODE=T1.COMPONENT_CODE 
   JOIN PARA1 PC1 ON PC1.PARA1_CODE=T1.COM_PARA1_CODE
JOIN PARA2 PC2 ON PC2.PARA2_CODE=T1.COM_PARA2_CODE
  
 JOIN PRD_WO_MST WO ON  WO.MEMO_ID=MST.WORK_ORDER_ID  
 JOIN ARTICLE ARTSET ON WO.ARTICLE_SET_CODE=ARTSET.ARTICLE_CODE  
 LEFT OUTER JOIN PRD_PMT P ON T1.PRODUCT_UID = P.PRODUCT_UID AND P.DEPARTMENT_ID=MST.DEPARTMENT_ID              
 JOIN PRD_SKU S ON S.PRODUCT_UID = T1.PRODUCT_UID               
 JOIN ARTICLE B ON S.ARTICLE_CODE = B.ARTICLE_CODE                
 JOIN SECTIOND SD ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE              
 JOIN SECTIONM SM ON SD.SECTION_CODE = SM.SECTION_CODE              
     
 JOIN PARA1 P1 ON P1.PARA1_CODE=S.PARA1_CODE            
 JOIN PARA2 P2 ON P2.PARA2_CODE=S.PARA2_CODE            
 JOIN PARA3 P3 ON P3.PARA3_CODE=S.PARA3_CODE            
 JOIN PARA4 P4 ON P4.PARA4_CODE=S.PARA4_CODE            
 JOIN PARA5 P5 ON P5.PARA5_CODE=S.PARA5_CODE            
 JOIN PARA6 P6 ON P6.PARA6_CODE=S.PARA6_CODE         
 LEFT OUTER JOIN UOM U ON B.UOM_CODE= U.UOM_CODE                  
 WHERE T1.MEMO_ID = @CMEMOID           
 GOTO LAST            
            
LBLFORMS:            
            
 IF(@CWHERE = '1')            
  SELECT * FROM FORM WHERE FORM_ID <> '0000000' AND EXCISE_ACCESSIBLE_PERCENTAGE > 0            
 ELSE            
  SELECT * FROM FORM WHERE FORM_ID <> '0000000' AND EXCISE_ACCESSIBLE_PERCENTAGE = 0            
            
            
GOTO LAST            
            
LBLCUSTOMER:            
            
 DECLARE @CHEADCODESTR VARCHAR(1000)  ,@CHEADCODESTR1  VARCHAR(1000)        
 SELECT @CHEADCODESTR = DBO.FN_ACT_TRAVTREE('0000000018')            
 SELECT @CHEADCODESTR1 = DBO.FN_ACT_TRAVTREE('0000000021')            
 SELECT AC_CODE, AC_NAME, ADDRESS0,ADDRESS1,ADDRESS2 AREA_NAME , CITY, [STATE], PINCODE ,            
 ISNULL(DISCOUNT_PERCENTAGE,0) AS DISCOUNT_PERCENTAGE            
 FROM LMV01106              
 WHERE (CHARINDEX(HEAD_CODE,@CHEADCODESTR)>0            
 OR ALLOW_CREDITOR_DEBTOR=1) AND AC_CODE <>'0000000000'     AND INACTIVE=0            
 ORDER BY AC_NAME              
              
GOTO LAST            
            
LBLSTOCKDETAILS:            
    SELECT T1.*,B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, S.PARA1_CODE,              
    C.PARA1_NAME, S.PARA2_CODE, D.PARA2_NAME, S.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,                 
    T1.DEPARTMENT_ID, B.CODING_SCHEME,  B.INACTIVE, T1.QUANTITY_IN_STOCK,              
    S.PURCHASE_PRICE,  S.MRP,S.WS_PRICE,  '' AS SCHEME_ID, SM.SECTION_NAME, SD.SUB_SECTION_NAME,              
    S.PARA4_CODE,S.PARA5_CODE,S.PARA6_CODE,              
    PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],              
    B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],S.DT_CREATED AS [SKU_DT_CREATED],              
    B.STOCK_NA        
  FROM PRD_PMT T1            
  JOIN PRD_SKU S ON T1.PRODUCT_UID = S.PRODUCT_UID               
  JOIN ARTICLE B ON S.ARTICLE_CODE = B.ARTICLE_CODE                
  JOIN SECTIOND SD ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE              
  JOIN SECTIONM SM ON SD.SECTION_CODE = SM.SECTION_CODE              
  JOIN PARA1 C ON S.PARA1_CODE = C.PARA1_CODE                
  JOIN PARA2 D ON S.PARA2_CODE = D.PARA2_CODE                
  JOIN PARA3 F ON S.PARA3_CODE = F.PARA3_CODE                
  JOIN PARA4 G ON S.PARA4_CODE = G.PARA4_CODE                
  JOIN PARA5 H ON S.PARA5_CODE = H.PARA5_CODE                
  JOIN PARA6 I ON S.PARA6_CODE = I.PARA6_CODE                
  JOIN UOM   E ON B.UOM_CODE = E.UOM_CODE               
  WHERE T1.QUANTITY_IN_STOCK > 0            
GOTO LAST      
      
    ---------------CHANGE        
LBLWODETAIL:            
DECLARE @CQUERY1 NVARCHAR(MAX)--, @CMEMOID VARCHAR(50),@CWHERE1 VARCHAR(50)          
            
SET @CQUERY1 = N' SELECT CAST(0 AS BIT) AS CHCK,A.ARTICLE_CODE AS [COMPONENT_CODE]            
, B.ARTICLE_NO AS [COMPONENT]
,C.PARA1_CODE AS COM_PARA1_CODE, C.PARA2_CODE AS COM_PARA2_CODE,
 PC1.PARA1_NAME AS COM_PARA1_NAME, PC2.PARA2_NAME AS COM_PARA2_NAME
             
,B1.ARTICLE_NO,B1.ARTICLE_NAME            
,P11.PARA1_NAME ,P21.PARA2_NAME             
,D.AVG_QTY             
, '''' AS PRODUCT_UID,E.ARTICLE_CODE AS ARTICLE_CODE,E.PARA1_CODE ,E.PARA2_CODE            
,P1.PARA1_NAME AS COM_COLOR,P2.PARA2_NAME AS COM_SIZE ,(C.QUANTITY * D.AVG_QTY) AS QUANTITY ,0 AS QUANTITY_IN_STOCK            
,CASE WHEN ISNULL(E.PURCHASE_PRICE,0)=0 THEN E.MRP ELSE E.PURCHASE_PRICE END AS RATE,  E.MRP ,E.WS_PRICE, E.TAX_AMOUNT AS ITEM_TAX_AMOUNT,            
 E.FORM_ID AS ITEM_FORM_ID,G.FORM_NAME,G.TAX_PERCENTAGE AS ITEM_TAX_PERCENTAGE,            
 CAST(0 AS NUMERIC) AS DISCOUNT_PERCENTAGE,CAST(0 AS NUMERIC) AS DISCOUNT_AMOUNT, D.ROW_ID +''-''+ C.ROW_ID AS ROW_ID            
, B.UOM_CODE,H.UOM_NAME, (ISNULL(C.QUANTITY,0) * ISNULL(D.AVG_QTY,0)*(CASE WHEN ISNULL(E.PURCHASE_PRICE,0)=0 THEN E.MRP ELSE E.PURCHASE_PRICE END)) AS AMOUNT,          
SM.SECTION_NAME,SD.SUB_SECTION_NAME            
FROM PRD_WO_DET A            
JOIN ARTICLE B ON A.ARTICLE_CODE=B.ARTICLE_CODE            
JOIN PRD_WO_SUB_DET C ON A.ROW_ID=C.REF_ROW_ID            
JOIN PRD_WO_ART_BOM D ON C.REF_ROW_ID=D.REF_ROW_ID            
JOIN PARA1 PC1 ON PC1.PARA1_CODE=C.PARA1_CODE
JOIN PARA2 PC2 ON PC2.PARA2_CODE=C.PARA2_CODE
         
JOIN ARTICLE B1 ON D.BOM_ARTICLE_CODE=B1.ARTICLE_CODE            
JOIN SKU E ON E.ARTICLE_CODE=D.BOM_ARTICLE_CODE AND D.PARA1_CODE=E.PARA1_CODE AND D.PARA2_CODE=E.PARA2_CODE      
'            
SET @CQUERY1 = @CQUERY1+ N' JOIN SECTIOND SD ON SD.SUB_SECTION_CODE=B1.SUB_SECTION_CODE            
JOIN SECTIONM SM ON SM.SECTION_CODE=SD.SECTION_CODE            
--JOIN PMT01106 F ON E.PRODUCT_CODE=F.PRODUCT_CODE    
'          
IF ISNULL(@NNAVMODE,0)=0          
 SET @CQUERY1 = @CQUERY1+ N' --AND QUANTITY_IN_STOCK >0      
 '          
SET @CQUERY1 = @CQUERY1+ N'  JOIN PARA1 P1 ON P1.PARA1_CODE=E.PARA1_CODE            
JOIN PARA2 P2 ON P2.PARA2_CODE=E.PARA2_CODE            
JOIN PARA1 P11 ON P11.PARA1_CODE=C.PARA1_CODE              
JOIN PARA2 P21 ON P21.PARA2_CODE=C.PARA2_CODE              
            
JOIN FORM G ON G.FORM_ID=E.FORM_ID              
JOIN UOM H ON H.UOM_CODE=B.UOM_CODE         
'            
SET @CQUERY1 = @CQUERY1+ N' WHERE A.MEMO_ID= '''+@CMEMOID+'''       
-- AND (E.WORK_ORDER_ID='''+@CMEMOID+''' )         
'        
IF ISNULL(@NNAVMODE,0)=0         
SET @CQUERY1 = @CQUERY1+ N'--AND DEPARTMENT_ID='''+@CWHERE+'''          
'               
         
 --SET @CQUERY1 = @CQUERY1+ N' WHERE A.MEMO_ID= '''+@CMEMOID+''' AND (E.WORK_ORDER_ID='''+@CMEMOID+''' OR E.WORK_ORDER_ID='''')         
 --AND DEPARTMENT_ID='''+@CWHERE+'''  '            
            
SET @CQUERY1 = @CQUERY1+ N' ORDER BY COMPONENT, COM_COLOR,COM_SIZE,ARTICLE_NO,PARA1_NAME'            
PRINT @CQUERY1            
EXEC SP_EXECUTESQL @CQUERY1                
          
           
SELECT DISTINCT CAST(0 AS BIT) AS CHCK,A.ARTICLE_CODE AS [COMPONENT_CODE]            
, B.ARTICLE_NO AS [COMPONENT]  ,C.PARA1_CODE AS COM_PARA1_CODE, C.PARA2_CODE AS COM_PARA2_CODE,
 PC1.PARA1_NAME AS COM_PARA1_NAME, PC2.PARA2_NAME AS COM_PARA2_NAME
           
,B1.ARTICLE_NO,B1.ARTICLE_NAME            
,P11.PARA1_NAME ,P21.PARA2_NAME             
,D.AVG_QTY             
, E.PRODUCT_CODE AS PRODUCT_UID,E.ARTICLE_CODE AS ARTICLE_CODE,E.PARA1_CODE ,E.PARA2_CODE            
,P1.PARA1_NAME AS COM_COLOR,P2.PARA2_NAME AS COM_SIZE ,(C.QUANTITY * D.AVG_QTY) AS QUANTITY ,0 AS QUANTITY_IN_STOCK            
,CASE WHEN ISNULL(E.PURCHASE_PRICE,0)=0 THEN E.MRP ELSE E.PURCHASE_PRICE END AS RATE,  E.MRP ,E.WS_PRICE, E.TAX_AMOUNT AS ITEM_TAX_AMOUNT,            
 E.FORM_ID AS ITEM_FORM_ID,G.FORM_NAME,G.TAX_PERCENTAGE AS ITEM_TAX_PERCENTAGE,            
 CAST(0 AS NUMERIC) AS DISCOUNT_PERCENTAGE,CAST(0 AS NUMERIC) AS DISCOUNT_AMOUNT, D.ROW_ID +'-'+ C.ROW_ID AS ROW_ID            
, B.UOM_CODE,H.UOM_NAME, (ISNULL(C.QUANTITY,0) * ISNULL(D.AVG_QTY,0)*(CASE WHEN ISNULL(E.PURCHASE_PRICE,0)=0 THEN E.MRP ELSE E.PURCHASE_PRICE END)) AS AMOUNT,          
SM.SECTION_NAME,SD.SUB_SECTION_NAME            
FROM PRD_WO_DET A          
JOIN ARTICLE B ON A.ARTICLE_CODE=B.ARTICLE_CODE          
JOIN PRD_WO_SUB_DET C ON A.ROW_ID=C.REF_ROW_ID          
JOIN PRD_WO_ART_BOM D ON C.REF_ROW_ID=D.REF_ROW_ID   
JOIN PARA1 PC1 ON PC1.PARA1_CODE=C.PARA1_CODE
JOIN PARA2 PC2 ON PC2.PARA2_CODE=C.PARA2_CODE
       
JOIN ARTICLE B1 ON D.BOM_ARTICLE_CODE=B1.ARTICLE_CODE          
JOIN SKU E ON E.ARTICLE_CODE=D.BOM_ARTICLE_CODE AND D.PARA1_CODE=E.PARA1_CODE AND D.PARA2_CODE=E.PARA2_CODE            
JOIN SECTIOND SD ON SD.SUB_SECTION_CODE=B1.SUB_SECTION_CODE          
JOIN SECTIONM SM ON SM.SECTION_CODE=SD.SECTION_CODE          
JOIN PMT01106 F ON E.PRODUCT_CODE=F.PRODUCT_CODE --AND QUANTITY_IN_STOCK >0          
JOIN PARA1 P1 ON P1.PARA1_CODE=E.PARA1_CODE          
JOIN PARA2 P2 ON P2.PARA2_CODE=E.PARA2_CODE          
JOIN PARA1 P11 ON P11.PARA1_CODE=C.PARA1_CODE            
JOIN PARA2 P21 ON P21.PARA2_CODE=C.PARA2_CODE            
          
JOIN FORM G ON G.FORM_ID=E.FORM_ID            
JOIN UOM H ON H.UOM_CODE=B.UOM_CODE           
WHERE 1=2            
               
GOTO LAST            
            
LBLWORKORDER:            
SELECT MEMO_ID,MEMO_NO,REF_NO,A.ARTICLE_NO FROM PRD_WO_MST T1    
 JOIN ARTICLE A ON A.ARTICLE_CODE=T1.ARTICLE_SET_CODE    
 WHERE T1.CANCELLED=0 AND T1.MARK_AS_COMPLETED=1           
    --SELECT MEMO_ID,MEMO_NO,REF_NO  ,       
    --FROM PRD_WO_MST A        
    --WHERE A.MARK_AS_COMPLETED=1 AND A.CANCELLED=0        
GOTO LAST            
            
LBLPRODUCTCODELIST:            
            
  SELECT T3.ARTICLE_NO,T3.ARTICLE_NAME,T1.PRODUCT_UID,T4.SUB_SECTION_NAME,T5.SECTION_NAME,T3.ARTICLE_CODE            
  FROM PRD_SKU T1             
  LEFT OUTER JOIN PRD_PMT T2 ON T1.PRODUCT_UID = T2.PRODUCT_UID        
  JOIN ARTICLE T3 ON T1.ARTICLE_CODE = T3.ARTICLE_CODE            
  JOIN SECTIOND T4 ON T3.SUB_SECTION_CODE = T4.SUB_SECTION_CODE            
  JOIN SECTIONM T5 ON T5.SECTION_CODE = T4.SECTION_CODE            
  WHERE T1.PRODUCT_UID <> '' AND T2.QUANTITY_IN_STOCK > 0            
  ORDER BY T3.ARTICLE_NO            
             
 GOTO LAST            
          
LBLWPSMSTREP:          
        
   GOTO LAST          
             
LBLWPSDETREP:          
        
   GOTO LAST          
             
LBL12:            
             
   SELECT TOP 1 B.INV_ID  FROM PRD_PS_MST A          
   JOIN PRD_IND01106 B ON B.PS_ID=A.PS_ID          
   WHERE A.PS_ID=@CWHERE          
             
             
   GOTO LAST            
           
  LAST:            
END
