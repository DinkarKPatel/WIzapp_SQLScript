create PROCEDURE SAVETRAN_MERGE_MIRROR_DOCWSL_DATA       --(LocId 3 digit change by Sanjay:05-11-2024) 
(        
	 @CMEMOID VARCHAR(50),        
	 @DRECEIPTDT DATETIME,        
	 @CMEMONOPREFIX VARCHAR(10),
	 @CWIZAPPUSERCODE CHAR(7),
	 @CLOCID VARCHAR(4)='',	
	 @cMrrId VARCHAR(50) OUTPUT,
	 @BNEGSTOCKFOUND BIT OUTPUT,
	 @CERRMSG VARCHAR(MAX) OUTPUT ,
	 @DLOGINDT DATETIME='' ,
	 @BCALLEDFORSISLOC BIT=0 ,
	 @NPARTY_AMOUNT_FORTCS NUMERIC(18,2)=0,
	 @CCHI_ENTRY_REF_NO varchar(100)='',
	 @NRETURNINVOICE int=0 --1 FOR WSL 2 FOR PRT

)      
AS        
BEGIN 
     
	 
	
	 /*
	  @BCALLEDFORSISLOC use transaction Open in parcel modules & Direct Git Recieve for sis Location
	 */

	SET NOCOUNT ON        
	DECLARE @DTSQL NVARCHAR(MAX),@CSOURCEDB VARCHAR(200),@CTMP_TABLENAME VARCHAR(200),        
   @CJOINSTR VARCHAR(MAX),@CERRORMSG VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100),        
   @CTABLENAME VARCHAR(200),@CERRMSGOUT VARCHAR(MAX),@CSTEP VARCHAR(20),@CKEYFIELD VARCHAR(100)        
   ,@CKEYFIELD1 VARCHAR(100),@CMERGEDB VARCHAR(50),@DPIMRECEIPTDT DATETIME
   ,@CFINYEAR VARCHAR(10),@MRR_NO VARCHAR(50),@INV_ID VARCHAR(50),@bAddmode BIT      
   ,@CCMD NVARCHAR(MAX), @CCURDEPTID VARCHAR(4),@CHODEPTID VARCHAR(4),
   @BSOURCEPURLOC BIT,@BTARGETPURLOC BIT,@BGENERATEAUTOSERIES BIT,@CSOURCELOCID varCHAR(4), @BHOLOC BIT,@BSKU_OH BIT,
   @NTARGETLOCTYPE INT,@BMSTINSERTONLY BIT,@CPARTYDEPTID VARCHAR(5),@BCANCELLED BIT,
   @BCHALLANRECEIVEDPREV BIT,@CTABLESSTR VARCHAR(MAX),@BGETCHALLANTHRUMIRROR BIT,@CSOURCETEMPTABLE VARCHAR(500),
   @CTMPINDTABLE VARCHAR(500),@NVERSIONNO INT,@CFILTERCONDITION1 VARCHAR(1000),@CFILTERCONDITION2 VARCHAR(1000),
   @CFILTERCONDITIONPARA VARCHAR(1000),@CCMDOUTPUT NVARCHAR(MAX),@CASKPREFIX VARCHAR(10),
   @DVERSIONLASTUPDATE DATETIME,@CLOCSSTMEMOID VARCHAR(40),@CSTATECODE CHAR(7),@CSTATENAME VARCHAR(200),
   @CERRPRODUCTCODE VARCHAR(50),@DINVDT DATETIME,@CGSTCUTOFFDATE VARCHAR(12),@BGSTBILL BIT,
   @CMRRIDSEARCH VARCHAR(50),@CMEMOPREFIXPROC VARCHAR(25),@CRECEIVEDMRRID VARCHAR(50) ,@CENABLEOPTIMIZEDSCHEMES
   BIT ,@NUPDATEMODENEW INT,@AC_CODE VARCHAR(10),@bServerLoc BIT,@cTempFilter VARCHAR(1000),@bDonotInsMasters BIT,
   @UPD_PURINFO BIT,@NXNITEMTYPE INT,@CRETRUNID varchar(50),@cLocationCode VARCHAR(4)
  
   
  
 
 BEGIN TRY        
  
  SET @CSTEP=2
  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1


  IF @CLOCID=''    	 
	  SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE  CONFIG_OPTION='LOCATION_ID'
  ELSE 
	  SET @CCURDEPTID=@CLOCID
  
  SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE  CONFIG_OPTION='HO_LOCATION_ID'
  
  SET @CSTEP=3
  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

  SET @CSOURCEDB=DB_NAME()+'.DBO.'        
  SET @CTABLESUFFIX=REPLACE(@CMEMOID,'-','_')        
  
  SET @CTMP_TABLENAME=@CSOURCEDB+'DOCWSL_INM01106_MIRROR'
	
  SELECT TOP 1 @NVERSIONNO=VERSION_NO,@DVERSIONLASTUPDATE=VERSION_LAST_UPDATE,@DINVDT=INV_DT ,@NXNITEMTYPE=XN_ITEM_TYPE,@cLocationCode=location_code
  FROM DOCWSL_INM01106_MIRROR B (NOLOCK)
  WHERE  INV_ID=@CMEMOID
  ORDER BY VERSION_NO DESC


  
  IF @NVERSIONNO IS NULL
  BEGIN
	   SET @CERRMSG = 'THE CHALLAN NO.:'+RIGHT(@CMEMOID,10)+' DATA IS NOT FOUND ..... '		
	   GOTO EXIT_PROC
  END

   SET @CSTEP=5
    EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

	DECLARE @cSourceAcCode CHAR(10)
	SELECT TOP 1 @cSourceAcCode=(CASE WHEN SUBSTRING(b.loc_gst_no,3,10)=SUBSTRING(c.loc_gst_no,3,10) 
					  THEN  b.dept_ac_code ELSE b.invoice_control_ac_code END),
	@CPARTYDEPTID=party_dept_id
	FROM DOCWSL_INM01106_MIRROR A (NOLOCK)
	JOIN Location b (NOLOCK) ON a.location_Code=b.dept_id
	JOIN Location c (NOLOCK) ON a.party_dept_id=c.dept_id
	WHERE a.inv_id=@cMemoId

	IF ISNULL(@cSourceAcCode,'') IN ('','0000000000')
	BEGIN
		SET @CERRORMSG='Source Location Control Account not defined ..... Please check'
		GOTO EXIT_PROC
	END

    
  IF ISNULL(@DVERSIONLASTUPDATE,'')=''
	  SET @DVERSIONLASTUPDATE=DATEADD(SS,-60,GETDATE())
  
  SET @cStep=5.2
  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

  SELECT @CFILTERCONDITION1=' A.INV_ID='''+@CMEMOID+'''',
		 @CFILTERCONDITION2=' B.DOCWSL_MEMO_ID='''+@CMEMOID+''''
     
  SET @bServerLoc=0
  
  IF EXISTS(SELECT TOP 1'U' FROM location (NOLOCK) WHERE DEPT_ID=@CPARTYDEPTID AND server_loc=1)
  OR EXISTS(SELECT TOP 1'U' FROM location (NOLOCK) WHERE DEPT_ID=@CCURDEPTID AND server_loc=1)
		SET @bServerLoc=1

  SET @CSTEP=5.6	
  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1
  
  SET @bDonotInsMasters=0
  	
  IF EXISTS(SELECT TOP 1'U' FROM location (NOLOCK) WHERE DEPT_ID=@CPARTYDEPTID AND server_loc=1)
  AND EXISTS(SELECT TOP 1'U' FROM location (NOLOCK) WHERE DEPT_ID=@CCURDEPTID AND server_loc=1)
		SET @bDonotInsMasters=1
  
  IF @bServerLoc=0
  BEGIN
  	  IF @CPARTYDEPTID<>@CCURDEPTID
	  BEGIN
		SET @CERRMSG = 'THE CHALLAN NO.:'+RIGHT(@CMEMOID,10)+' BELONGS TO LOCATION ID :'+@CPARTYDEPTID+' OTHER THAN CURRENT LOCATION ID:'+@CCURDEPTID		
		GOTO EXIT_PROC
	  END
  
  END
   ELSE 
      SET @CCURDEPTID=@CPARTYDEPTID
       
 
  SET @CSTEP=5.8	
  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1
  SELECT TOP 1 @CSOURCELOCID=DEPT_ID,@BSOURCEPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=@cLocationCode	

  SELECT TOP 1 @NTARGETLOCTYPE=LOC_TYPE,@UPD_PURINFO=ISNULL(UPD_PURINFO,0) FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID
  
  SET @BHOLOC=0
  IF @CCURDEPTID=@CHODEPTID
	  SET @BHOLOC=1
  
	  SET @CSTEP=5.95	
	  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

   SET @CSTEP=6.2	
   DECLARE @bDupEntryFound BIT
   SET @bDupEntryFound=0
   SELECT row_id INTO #tmpDup from DOCWSL_ind01106_mirror (NOLOCK) WHERE inv_id=@cMemoId 
	GROUP BY row_id HAVING count(*)>1
		
	IF EXISTS (SELECT TOP 1 * FROM #tmpDup)
	BEGIN
		SELECT @cErrormsg='Duplicate entries found in Challan .... Cannot Save'
		 
		SELECT A.PRODUCT_CODE,0 QUANTITY_IN_STOCK,@cErrormsg AS ERRMSG
		FROM  DOCWSL_ind01106_mirror a (NOLOCK) JOIN #tmpDup b ON a.row_id=b.row_id

		SET @bDupEntryFound =1
		GOTO EXIT_PROC
	END	   
  SET @CSTEP = 10
  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

  SET @CMERGEDB=DB_NAME()+'.DBO.'      
  SET @CERRORMSG=''        
  
 
  SET @BGSTBILL=0
  
  SELECT TOP 1  @CGSTCUTOFFDATE=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='GST_CUT_OFF_DATE'
  IF ISNULL(@CGSTCUTOFFDATE,'')<>''
  BEGIN
		IF @DINVDT>=CONVERT(DATE,@CGSTCUTOFFDATE)
			SET @BGSTBILL=1
  END
	  --CHANGE BY BAIJNATH SET HSN CODE TEN TIME ZERO WHEN IT IS BLANK  -- 
    
	SET @CSTEP=12	
    EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

	UPDATE DOCWSL_IND01106_MIRROR WITH (ROWLOCK)  SET HSN_CODE='0000000000'   WHERE INV_ID=@CMEMOID AND ISNULL(HSN_CODE,'')=''

	UPDATE DOCWSL_INM01106_MIRROR WITH (ROWLOCK)  SET PARTY_STATE_CODE='00' WHERE INV_ID=@CMEMOID AND ISNULL(PARTY_STATE_CODE,'')=''
	
	UPDATE DOCWSL_INM01106_MIRROR WITH (ROWLOCK)  SET FREIGHT_HSN_CODE='0000000000' WHERE INV_ID=@CMEMOID AND ISNULL(FREIGHT_HSN_CODE,'')=''
	UPDATE DOCWSL_INM01106_MIRROR WITH (ROWLOCK)  SET OTHER_CHARGES_HSN_CODE='0000000000' WHERE INV_ID=@CMEMOID AND ISNULL(OTHER_CHARGES_HSN_CODE,'')=''
	UPDATE DOCWSL_INM01106_MIRROR WITH (ROWLOCK)  SET PACKING_HSN_CODE='0000000000' WHERE INV_ID=@CMEMOID AND ISNULL(PACKING_HSN_CODE,'')=''
	UPDATE DOCWSL_INM01106_MIRROR WITH (ROWLOCK)  SET INSURANCE_HSN_CODE='0000000000' WHERE INV_ID=@CMEMOID AND ISNULL(INSURANCE_HSN_CODE,'')=''
	UPDATE DOCWSL_PARCEL_MST_MIRROR WITH (ROWLOCK)  SET USER_CODE ='0000000' WHERE DOCWSL_MEMO_ID=@CMEMOID

	IF @bDonotInsMasters=0
	BEGIN
		UPDATE DOCWSL_ARTICLE_MIRROR WITH (ROWLOCK)  SET HSN_CODE='0000000000' WHERE DOCWSL_MEMO_ID=@CMEMOID AND ISNULL(HSN_CODE,'')=''
		UPDATE DOCWSL_SKU_MIRROR WITH (ROWLOCK)  SET HSN_CODE='0000000000' WHERE DOCWSL_MEMO_ID=@CMEMOID AND ISNULL(HSN_CODE,'')=''
		UPDATE DOCWSL_SKU_MIRROR WITH (ROWLOCK)  SET AC_CODE='0000000000' WHERE DOCWSL_MEMO_ID=@CMEMOID AND ISNULL(AC_CODE,'')=''
	END  
  
  SET @CSTEP = 15
  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

  SELECT TOP 1 @CMRRIDSEARCH = MRR_ID,@CFINYEAR=fin_year FROM PIM01106 (NOLOCK) WHERE INV_ID =@CMEMOID AND CANCELLED=0      
  			
  SET @bAddmode=(CASE WHEN 	ISNULL(@CMRRIDSEARCH,'')<>'' THEN 0 ELSE 1 END)

  IF @BHOLOC=1 OR @BServerLoc=1
	SET @BMSTINSERTONLY = 1
  ELSE
	SET @BMSTINSERTONLY = 0
	
	IF ISNULL(@BCALLEDFORSISLOC,0)=0
     BEGIN TRAN


	IF ISNULL(@CMRRIDSEARCH,'')=''
	UPDATE DOCWSL_INM01106_MIRROR WITH (ROWLOCK)  SET USER_CODE=@CWIZAPPUSERCODE,EDT_USER_CODE='0000000' WHERE inv_id=@CMEMOID
	ELSE
	UPDATE DOCWSL_INM01106_MIRROR WITH (ROWLOCK)  SET  USER_CODE=@CWIZAPPUSERCODE,EDT_USER_CODE=@CWIZAPPUSERCODE WHERE inv_id=@CMEMOID
	

	IF @bDonotInsMasters=0
	BEGIN
		SET @CSTEP=25	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1     

		--EXEC SP3S_REMOVE_MIRROR_DULICATE_MSTERS @CMEMOID,@NVERSIONNO,'DOCWSL'
	
	     
		SET @CSTEP=30	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='REGIONM'        
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'        
		SET @CKEYFIELD='REGION_CODE'        
		SET @CSTEP=70        
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2 
		    
			 
		  SET @CSTEP=35	
  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1
		SET @CTABLENAME='STATE'        
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'        
		SET @CKEYFIELD='STATE_CODE'        
		SET @CSTEP=70        
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2                            
            
		  SET @CSTEP=45	
  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1
		SET @CTABLENAME='CITY'        
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'        
		SET @CKEYFIELD='CITY_CODE'        
		SET @CSTEP= 90        
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2               
            
		SET @CSTEP=50	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='AREA'        
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'        
		SET @CKEYFIELD='AREA_CODE'        
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2               

         
	    SET @CSTEP=55	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='HD01106'        
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'        
		SET @CKEYFIELD='HEAD_CODE'        

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2            
    
		SET @CSTEP=60
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		UPDATE DOCWSL_LM01106_MIRROR WITH (ROWLOCK) SET MAJOR_AC_CODE=AC_CODE WHERE docwsl_memo_id=@cMemoId AND ISNULL(MAJOR_AC_CODE,'') IN ('','0000000000')
        

		UPDATE A SET MAJOR_AC_CODE=a.AC_CODE
		FROM DOCWSL_LM01106_MIRROR A
		LEFT JOIN LM01106 B ON A.MAJOR_AC_CODE=B.AC_CODE
		WHERE a.docwsl_memo_id=@cMemoId and  B.AC_CODE IS NULL


		SET @CTABLENAME='LM01106'        
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'        
		SET @CKEYFIELD='AC_CODE' 
		
		
		DECLARE @CWHERE VARCHAR(200)
		SET @CWHERE=' AND A.DOCWSL_MEMO_ID='''+@CMEMOID+''' AND A.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO)))

		SET @CSTEP = 61  
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='AC_NAME',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2        

		SET @CSTEP=65	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='LMP01106'        
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'        
		SET @CKEYFIELD='AC_CODE'        
		PRINT @DTSQL        
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2         
     
		SET @CSTEP=70	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1
		UPDATE DOCWSL_SECTIONM_MIRROR WITH (ROWLOCK) SET ITEM_TYPE=1 WHERE DOCWSL_MEMO_ID=@CMEMOID AND ISNULL(ITEM_TYPE,0)=0
    
		SET @CSTEP=75	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1    

		SET @CTABLENAME='SECTIONM'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='SECTION_CODE'


		SET @CSTEP = 61  

		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='section_name',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE

		SET @CSTEP=280
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2        		
	
		SET @CSTEP=80	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='SECTIOND'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='SUB_SECTION_CODE'
	
		SET @CSTEP = 81
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='sub_section_name',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2            
		--REFERENCES AB_HO.DBO.LOCSST_MST (MEMO_ID)
	
		SET @CSTEP=85	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='SD_ATTR_AVATAR'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='SUB_SECTION_CODE'
		SET @CSTEP=340



		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2 
	
	
	
	
		SET @CSTEP=90	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1
		SET @CTABLENAME='PARA1'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PARA1_CODE'


		SET @CSTEP = 91  
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='para1_name',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE

		SET @CSTEP=390
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2        
              
		SET @CSTEP=95	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='PARA2'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PARA2_CODE'

		SET @CSTEP = 96 
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='para2_name',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		SET @CSTEP=410
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2        
       
		SET @CSTEP=100	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='PARA3'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PARA3_CODE'
		
				SET @CSTEP = 91  
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='para3_name',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE



		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2        
         
		SET @CSTEP=105	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='PARA4'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PARA4_CODE'

				SET @CSTEP = 91  
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='para4_name',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE



		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2        
         
		SET @CSTEP=110	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1
		SET @CTABLENAME='PARA5'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PARA5_CODE'
		
				SET @CSTEP = 91  

		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='para5_name',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2        
   
		SET @CSTEP=120	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='PARA6'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PARA6_CODE'

		SET @CSTEP = 91  

		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='para6_name',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2 
        
		
	
		SET @CSTEP=125	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		SET @CTABLENAME='PARA7'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PARA7_CODE'

		SET @CSTEP = 130  

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2 
        
		


		SET @CSTEP=170	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1

		IF EXISTS (SELECT TOP 1 'U' FROM DOCWSL_HSN_MST_MIRROR A (NOLOCK)
		LEFT JOIN HSN_MST B (NOLOCK) ON A.HSN_CODE =B.HSN_CODE WHERE B.HSN_CODE IS NULL AND A.DOCWSL_MEMO_ID =@CMEMOID AND A.VERSION_NO=LTRIM(RTRIM(STR(@NVERSIONNO))) )
		begin
		--hsn changes--
		  SET @CSTEP=172
		 SET @CTABLENAME='HSN_MST'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='HSN_CODE'
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
		  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
		  ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0        
		  ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2      
		  
		  
		SET @CSTEP=174
		SET @CTABLENAME='HSN_DET'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='HSN_CODE'
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
		  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='WEF',@CKEYFIELD3=''        
		  ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0        
		  ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2      

        end 
		--end of hsn




		SET @CTABLENAME='UOM'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='UOM_CODE'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2        
         
                 
    
		  SET @CSTEP=135	
		  EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,'',1
		SET @CTABLENAME='ARTICLE'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='ARTICLE_CODE'
	
			SET @CSTEP = 136  

		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CTMP_TABLENAME,@CTABLENAME=@CTABLENAME,@CCOLNAME='article_no',@CCOLKEYNAME=@CKEYFIELD,@CWHERE=@CWHERE

	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2   
			 
     --new Table merge para1 set  and para2 set(14082023)

	 	SET @CSTEP = 138

		

		DELETE A FROM ART_PARA1 A (NOLOCK)
		join DOCWSL_ART_PARA1_MIRROR b (nolock) on a.article_code =b.article_code 
	    where b.DOCWSL_MEMO_ID =@cMemoId

	 	SET @CTABLENAME='ART_PARA1'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='Article_code'
	

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='Para1_code',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2     
			 
     SET @CSTEP = 139

	 
		DELETE A FROM ART_det A (NOLOCK)
		join DOCWSL_ART_det_MIRROR b (nolock) on a.article_code =b.article_code 
	    where b.DOCWSL_MEMO_ID =@cMemoId


         SET @CTABLENAME='ART_DET'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='Article_code'
	

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='Para2_code',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2     


		---

		 DECLARE @NCOUNT INT,@BLOOP INT,@CCMD1 NVARCHAR(MAX)
		SET @NCOUNT=25
		SET @BLOOP=1
		WHILE (@BLOOP <=@NCOUNT )
		BEGIN
	      
			   DECLARE @CATTR_KEY_NAME VARCHAR(100)

			   
		  
				SET @CTABLENAME='ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST'

			   SET @CSTEP=140	
			   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

				SET @CTMP_TABLENAME='DOCWSL_ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST_MIRROR'
				SET @CKEYFIELD='ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_KEY_CODE'



				SET @CATTR_KEY_NAME ='ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_KEY_NAME'
					
			   SET @CSTEP=145	
			   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1		

				EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
				 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
				 ,@BALWAYSUPDATE=1
				 ,@CFILTERCONDITION=@CFILTERCONDITION2 
			
	       
			   SET @BLOOP=@BLOOP +1  			
		END
   
		SET @CSTEP=150	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

		SET @CTABLENAME='ARTICLE_FIX_ATTR'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='ARTICLE_CODE'
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='ARTICLE_CODE',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2        
        
		

		  --COMPANY OWN LOCATION UPDATE PP BASE OF TICK FLOW PURCHASE pRICE

		 DECLARE @CCURLOCID VARCHAR(2)
		 SELECT @CCURLOCID = VALUE FROM CONFIG (NOLOCK) WHERE  CONFIG_OPTION='LOCATION_ID'

		 SET @NTARGETLOCTYPE =ISNULL(@NTARGETLOCTYPE,0)
		 SET @UPD_PURINFO=ISNULL(@UPD_PURINFO,0)

		 IF ISNULL(@CCURLOCID,'')<>ISNULL(@CHODEPTID,'') AND @bServerLoc<>1
		 BEGIN

			 IF ( @NTARGETLOCTYPE=2 OR @UPD_PURINFO=0 )
			 BEGIN

				  UPDATE A SET 
				  BASIC_PURCHASE_PRICE =0,
				  PURCHASE_PRICE =0,
				  AC_CODE ='0000000000',
				  inv_no='',
				  inv_dt=''
				  FROM   DOCWSL_SKU_MIRROR  A  (NOLOCK)

				  UPDATE A SET 
				    DISCOUNT_AMOUNT=0,
					EXCISE_DUTY_AMOUNT=0,
					FREIGHT=0,
					OTHER_CHARGES=0,
					ROUND_OFF=0,
					TAX_AMOUNT=0,
					VALUE_ADD=0,
					DEPRECIATION=0,
					GST_CESS_AMOUNT=0
				  FROM   DOCWSL_SKU_OH_MIRROR  A  (NOLOCK)


			 END

		 END

                                         
		SET @CSTEP=160	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
		SET @CTABLENAME='SKU'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PRODUCT_CODE'
	
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
			 ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2        
    
    
  
     
    
		SET @CSTEP=170	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

		SET @CTABLENAME='SKU_OH'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PRODUCT_CODE'
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
		  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
		  ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
		  ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2   
		  
		  
		          

	
		IF @BHOLOC=0 AND @BServerLoc=0
		BEGIN
			SET @CSTEP=180	
			EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

			SET @CTABLENAME='SCHEME_SETUP_MST'
			SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
			SET @CKEYFIELD='MEMO_NO'
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			  ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
			  ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2             

			   SET @CSTEP=190	
			   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
			SET @CTABLENAME='SCHEME_SETUP_DET'
			SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
			SET @CKEYFIELD='ROW_ID'
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			  ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
			  ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2             

			   SET @CSTEP=200	
			   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
			SET @CTABLENAME='SCHEME_SETUP_SLSBC'
			SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
			SET @CKEYFIELD='PRODUCT_CODE'
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='SCHEME_SETUP_DET_ROW_ID',@CKEYFIELD3=''        
			  ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0        
			  ,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2             		  	
		END
	
	
	   SET @CSTEP=210	
	   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

			SET @CTABLENAME='ANGM'
			SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
			SET @CKEYFIELD='ANGADIA_CODE'
			SET @CSTEP=1002
		
		
			--CHANGES ON 12 JUL 2017		
			UPDATE S SET S.AREA_CODE=ISNULL(T.AREA_CODE,REPLICATE('0',7))
			FROM DOCWSL_ANGM_MIRROR S WITH (ROWLOCK)
			LEFT OUTER JOIN ANGM T WITH (NOLOCK)
			ON T.ANGADIA_CODE=S.ANGADIA_CODE
			WHERE S.DOCWSL_MEMO_ID=@CMEMOID
			--CHANGES ON 12 JUL 2017
		
		SET @CSTEP=220	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
	
 
			UPDATE S SET S.AC_CODE ='0000000000'
			FROM DOCWSL_ANGM_MIRROR S WITH (ROWLOCK)
			LEFT OUTER JOIN LM01106  T WITH (NOLOCK)
			ON T.AC_CODE =S.AC_CODE
			WHERE S.DOCWSL_MEMO_ID=@CMEMOID AND T.AC_CODE IS NULL

			   SET @CSTEP=230	
			   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
		

			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION2,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
		END

	   SET @CSTEP=240	
	   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

	   update DOCWSL_parcel_mst_mirror set bilty_no=parcel_memo_no where DOCWSL_MEMO_ID=@CMEMOID and
	   isnull(bilty_no,'')=''

	   SET @CSTEP=245	
		SET @CTABLENAME='PARCEL_MST'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PARCEL_MEMO_ID'
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
						  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION2,@LUPDATEONLY=0
						  ,@BALWAYSUPDATE=1
		
	   SET @CSTEP=250	
	   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

	  DECLARE @CMERGELOCID VARCHAR(2)
	  SELECT @CMERGELOCID = VALUE FROM CONFIG (NOLOCK) WHERE  CONFIG_OPTION='LOCATION_ID'

      if @CMERGELOCID <> @CHODEPTID
	   BEGIN

			SET @DTSQL = N'DELETE A FROM PARCEL_DET A (NOLOCK)
						   JOIN PARCEL_MST MST (NOLOCK) ON A.PARCEL_MEMO_ID=MST.PARCEL_MEMO_ID
						   LEFT JOIN DOCWSL_PARCEL_DET_MIRROR B ON A.ROW_ID=B.ROW_ID
						   WHERE A.REF_MEMO_ID = '''+@CMEMOID+''' AND MST.XN_TYPE=''WSL'' AND B.ROW_ID IS NULL'
			PRINT @DTSQL
			EXEC SP_EXECUTESQL @DTSQL

		END
		
				
	   SET @CSTEP=260	
	   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

		SET @CTABLENAME='PARCEL_DET'
		SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
		SET @CKEYFIELD='PARCEL_MEMO_ID'
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='ROW_ID',@CKEYFIELD3=''
						  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION2,@LUPDATEONLY=0
						  ,@BALWAYSUPDATE=1 
		  	             
	SET @CSTEP=270	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

    SET @CTABLENAME='INM01106'        
    SET @CTMP_TABLENAME='DOCWSL_'+@CTABLENAME+'_MIRROR'
     
	--CHANGES DONE ON 12 JUL 2017
	UPDATE DOCWSL_INM01106_MIRROR WITH (ROWLOCK)
	SET PARTY_STATE_CODE='00' 
	WHERE ISNULL(PARTY_STATE_CODE,'')='' 
	AND CAST(INV_DT AS DATE)<='2017-06-30' 
	AND INV_ID=@CMEMOID


    SET @CSTEP=280	
    EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

	--CHANGES DONE ON 12 JUL 2017



	
	
IF @DLOGINDT IN('','01-01-1900')
 SELECT @DLOGINDT=LAST_UPDATE FROM NEW_APP_LOGIN_INFO WHERE SPID=@@SPID
 ELSE
 SET @DLOGINDT=@DLOGINDT

 IF @DLOGINDT IN('','1900-01-01')
    begin
	    SET @CERRMSG = 'Login Date can not Be blank'
		GOTO EXIT_PROC
	end
 	  

 
	--SELECT ISNULL(INV_MODE,0),ISNULL(FIN_YEAR,''), INV_ID,PARTY_DEPT_ID  FROM  AB_HO_TEMP.DBO.TMP_DOCWSL_INM01106_020111502WSL00016      
    IF @bAddmode=1
		SELECT @CFINYEAR='01'+ DBO.FN_GETFINYEAR(CASE WHEN @DRECEIPTDT<>'' THEN  @DRECEIPTDT ELSE @dlogindt END )
    


	
    --SELECT 	@CCURDEPTID
    SET @BGENERATEAUTOSERIES = 0
    
    DECLARE @BPREFIXLOCGROUPTRANSFERSERIES BIT
	SET @BPREFIXLOCGROUPTRANSFERSERIES = 0
			
	IF ISNULL(@CMRRIDSEARCH,'')=''
	BEGIN      
		REGENRATE: 
		
	   SET @CSTEP=290	
	   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

		PRINT 'WHEN NO DATA FOUND IN GROUP PURCHASE'
		
		if isnull(@NXNITEMTYPE,0)<>5
		begin

			EXEC SAVETRAN_GETMEMOPREFIX
			@CXNTYPE='GRP_PUR',
			@CUSERCODE=@CWIZAPPUSERCODE,
			@CFINYEAR=@CFINYEAR,
			@CSOURCELOCID=@CCURDEPTID,
			@CTARGETLOCID='',
			@CMANUALPREFIX=@CMEMONOPREFIX,
			@CMEMOID=@CMEMOID,
			@CMEMOPREFIX=@CMEMOPREFIXPROC OUTPUT,
			@CERRORMSG=@CERRORMSG OUTPUT

		
			IF ISNULL(@CERRORMSG,'')<>''
				GOTO EXIT_PROC
		
		end
		ELSE
		SET @CMEMOPREFIXPROC=@CCURDEPTID++'R'+'-'
		
		DECLARE @NMEMONOLEN NUMERIC(10,0)
		SET @NMEMONOLEN=LEN(@CMEMOPREFIXPROC)+6
	   SET @CSTEP=300	
	   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

		EXEC GETNEXTKEY 'PIM01106', 'MRR_NO', @NMEMONOLEN, @CMEMOPREFIXPROC, 1,@CFINYEAR,0, @MRR_NO OUTPUT
	
	

		--SELECT  @MRR_NO AS MEMO_NO
		IF @MRR_NO IS NULL            
		BEGIN      
		    SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@CSTEP)) + ' ERROR CREATING NEXT MRR_NO....'           
			GOTO EXIT_PROC              
		END        
		
		IF EXISTS (SELECT TOP 1 * FROM PIM01106 WITH (NOLOCK) WHERE MRR_NO = @MRR_NO AND FIN_YEAR = @CFINYEAR)
			GOTO REGENRATE
		
		
		SET @CMRRID = @CCURDEPTID +RIGHT(@CFINYEAR,2)+ ISNULL(REPLICATE('0', (22-LEN(@CCURDEPTID + RIGHT(@CFINYEAR,2)))-LEN(LTRIM(RTRIM(@MRR_NO)))),'') + LTRIM(RTRIM(@MRR_NO))          
		
				
		IF @CMRRID IS NULL            
		BEGIN          
			SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@CSTEP)) + ' ERROR CREATING NEXT MRR_ID.'          
			GOTO EXIT_PROC          
		END 
		
		--- Have to do this test again because of special case came at one client HariOm on 16-04-2021
		--- where group challan is received for memo prefix 00 and already purchase  lying withh mrr_no='00-000001'
		--- and current mrr no. generated is 0000-000001 but mrr id gets generated same for both memos
		IF EXISTS (SELECT TOP 1 * FROM PIM01106 WITH (NOLOCK) WHERE MRR_id = @CMRRID)
			GOTO REGENRATE
    END
    ELSE
    BEGIN 
			   SET @CSTEP=320	
		 EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

		 SELECT TOP 1 @CMRRID= MRR_ID,@MRR_NO= MRR_NO FROM PIM01106 WITH (NOLOCK) WHERE INV_ID = @CMEMOID AND CANCELLED=0

		 SELECT TOP 1 @CRECEIVEDMRRID = MRR_ID FROM PIM01106 A WITH (NOLOCK) WHERE A.INV_ID = @CMEMOID AND RECEIPT_DT<>''
		 AND CANCELLED=0
   		 

		 IF ISNULL(@DRECEIPTDT,'')<>''
		  UPDATE PIM01106 WITH (ROWLOCK) SET RECEIPT_DT=@DRECEIPTDT,MRR_DT=@DRECEIPTDT,bill_dt =@DRECEIPTDT WHERE INV_ID = @CMEMOID --AND RECEIPT_DT=''
    END            		 

			   SET @CSTEP=330	
			   EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
	
      PRINT 'CHECK UPDATE'      
      PRINT  @MRR_NO      
      PRINT @CMRRID
      PRINT @MRR_NO
      PRINT @CSOURCEDB
      PRINT @CTMP_TABLENAME
     
	SET @CSTEP=340	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
	
	IF EXISTS (SELECT Top 1 'U' FROM DOCWSL_XNRECON_GITBIN_UPLOAD (nolock) WHERE INV_ID=@CMEMOID) and @NXNITEMTYPE in(0,1) --git Receive in git bin
	begin
	
	    IF EXISTS (SELECT TOP 1 'U' FROM  DOCWSL_INM01106_MIRROR A (NOLOCK) WHERE INV_ID=@CMEMOID AND TARGET_BIN_ID<>'888')
	    Update a set TARGET_BIN_ID ='888' from  DOCWSL_INM01106_MIRROR A (nolock) where INV_ID=@CMEMOID
	
	end
	
	DELETE a WITH (ROWLOCK) FROM pur_pid01106_upload a JOIN pur_pim01106_upload b WITH (NOLOCK) ON a.mrr_id=b.mrr_id WHERE b.inv_id=@cMemoId

	SET @CSTEP=350	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

	 DELETE FROM pur_pim01106_upload WITH (ROWLOCK) WHERE inv_id=@cMemoId

	SET @CSTEP=360	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1


	 SET @DTsQL=N'INSERT pur_pim01106_upload (inv_id,inv_Dt,mrr_id,mrr_no,BILL_CHALLAN_MODE,PUR_CAL_METHOD,RECEIPT_DT,MRR_DT,CR_DISCOUNT_PERCENTAGE,
				TOTAL_AMOUNT,pim_mode,PARTY_INV_AMOUNT,TAX_PERCENTAGE,TAX_AMOUNT,RECEIVED_BY,MRR_CREATION_DEPT_ID,BILL_NO,bill_dt,
				USER_CODE,EDT_USER_CODE,DEPT_ID,sp_id,ac_code,approvedlevelno,bill_level_tax_method,credit_days,discount_percentage,
				MEMO_TYPE,party_state_code,xn_item_type,cancelled,inv_mode,subtotal,freight,freight_cgst_amount,freight_gst_percentage,
				freight_hsn_code,freight_igst_amount,FREIGHT_TAXABLE_VALUE,fright_pay_mode,other_charges,other_charges_cgst_amount,
				other_charges_gst_percentage,other_charges_hsn_code,other_charges_igst_amount,other_charges_sgst_amount,OTHER_CHARGES_TAXABLE_VALUE
				,fin_year,TOTAL_QUANTITY,TOTAL_BOX_NO,INV_NO,DISCOUNT_AMOUNT,TOTAL_QUANTITY_STR,ROUND_OFF,TOTAL_GST_AMOUNT,REMARKS,
				tcs_amount,Total_gst_cess_amount,docwsl_parcel_memo_id,ParcelDetails,challan_source_location_code,location_code )
	 			SELECT '''+@cMemoId+''' as inv_id, a.inv_dt,'''+@CMRRID+''' AS MRR_ID,'''+@MRR_NO+''' AS MRR_NO,0 AS BILL_CHALLAN_MODE,0 AS PUR_CAL_METHOD,
				CONVERT(DATETIME,'''+CONVERT(VARCHAR,@DRECEIPTDT,110)+''') AS RECEIPT_DT,
				CONVERT(DATETIME,'''+CONVERT(VARCHAR,@DRECEIPTDT,110)+''') AS MRR_DT,0 AS CR_DISCOUNT_PERCENTAGE, NET_AMOUNT AS TOTAL_AMOUNT,
				1 AS PIM_MODE,0 AS PARTY_INV_AMOUNT,0 AS TAX_PERCENTAGE,0 AS TAX_AMOUNT,'''' AS RECEIVED_BY,
				 '''+@CCURDEPTID+''' AS MRR_CREATION_DEPT_ID,
				(CASE WHEN ISNULL(MANUAL_INV_NO,'''') ='''' THEN INV_NO ELSE MANUAL_INV_NO  END) AS BILL_NO,
				CONVERT(DATETIME,'''+CONVERT(VARCHAR,@DRECEIPTDT,110)+''') as bill_dt,
				a.USER_CODE as USER_CODE,a.EDT_USER_CODE as EDT_USER_CODE,a.party_dept_id as dept_id,@@spid as sp_id,
				(CASE WHEN SUBSTRING(b.loc_gst_no,3,10)=SUBSTRING(c.loc_gst_no,3,10) 
					  THEN  b.dept_ac_code
				      ELSE b.invoice_control_ac_code END) as ac_code,1 as approvedlevelno,bill_level_tax_method,0 as credit_days,discount_percentage,a.memo_type,party_state_code,
				xn_item_type,cancelled,inv_mode,subtotal,freight,freight_cgst_amount,freight_gst_percentage,
				freight_hsn_code,freight_igst_amount,FREIGHT_TAXABLE_VALUE,1 as fright_pay_mode,other_charges,other_charges_cgst_amount,
				other_charges_gst_percentage,other_charges_hsn_code,other_charges_igst_amount,other_charges_sgst_amount,OTHER_CHARGES_TAXABLE_VALUE,
				'''+@CFINYEAR+''',A.TOTAL_QUANTITY ,A.TOTAL_BOX_NO,A.INV_NO,A.DISCOUNT_AMOUNT,TOTAL_QUANTITY_STR,A.ROUND_OFF,A.TOTAL_GST_AMOUNT,a.REMARKS,
				a.tcs_amount,a.Total_gst_cess_amount,a.docwsl_parcel_memo_id,a.ParcelDetails,a.location_code,'''+@CCURDEPTID+''' AS location_code
				FROM DOCWSL_INM01106_MIRROR A WITH (NOLOCK)
				JOIN Location b WITH (NOLOCK) ON a.location_code=b.dept_id
				JOIN Location c WITH (NOLOCK) ON a.party_dept_id=c.dept_id
				WHERE '+@CFILTERCONDITION1
     PRINT @DTSQL
     EXEC SP_EXECUTESQL @DTSQL



           
	SET @CSTEP=370	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

     SET @CCMD=N'UPDATE TPIM SET RECEIPT_DT=(CASE WHEN ISNULL(B.RECEIPT_DT,'''')='''' AND TPIM.CANCELLED=1
				 THEN TPIM.INV_DT ELSE ISNULL(B.RECEIPT_DT,'''') END) ,
				 FIN_YEAR=B.FIN_YEAR
				 FROM pur_pim01106_upload TPIM WITH (ROWLOCK) 
				 JOIN PIM01106 B (NOLOCK) ON TPIM.MRR_ID=B.MRR_ID WHERE tpim.mrr_id='''+@cMrrId+''' AND B.RECEIPT_DT<>'''''
	 PRINT @CCMD
	 EXEC SP_EXECUTESQL @CCMD
	
	SET @CSTEP=380	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1



	SET @DTSQL=N'UPDATE A SET BIN_ID = c.TARGET_BIN_ID,
				 MEMO_TYPE=(CASE WHEN a.MEMO_TYPE=0 THEN 1 ELSE c.MEMO_TYPE END),
				 BROKER_AC_CODE=(CASE WHEN ISNULL(a.BROKER_AC_CODE,'''')='''' THEN ''0000000000'' 
									  ELSE c.BROKER_AC_CODE END),
				GOODS_TDS_AMOUNT=0,GOODS_TDS_BASEAMOUNT=0,GOODS_TDS_PERCENTAGE=0,
				CHI_ENTRY_REF_NO='''+@CCHI_ENTRY_REF_NO+'''
				FROM pur_pim01106_upload A WITH (ROWLOCK) 
				join docwsl_inm01106_mirror c WITH (NOLOCK) on c.inv_id=a.inv_id
				JOIN LOCATION B (NOLOCK) ON B.DEPT_ID=c.location_code
				WHERE mrr_id='''+@cMrrId+''''
   PRINT @DTSQL
   EXEC SP_EXECUTESQL @DTSQL
   

   
    IF  ISNULL(@CRECEIVEDMRRID,'')<>''
    SET @NUPDATEMODENEW=2
    
    IF  ISNULL(@CRECEIVEDMRRID,'')=''
    SET @NUPDATEMODENEW=1
   

	SET @cStep='385'
	EXEC SP3S_upd_qty_lastupdate
	@nUpdateMode=@NUPDATEMODENEW,
	@cXnType='pur',
	@cMemoId=@cMrrId,
	@nSpId=@@spid,
	@cMasterTable='PIM01106',
	@cMemoIdCol='mrr_id',
	@cXnDtCol='receipt_dt',
	@CERRORMSG=@CERRORMSG OUTPUT
	
	IF ISNULL(@cErrormsg,'')<>''
		GOTO EXIT_PROC	

		
	SET @CSTEP=390	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

   IF  ISNULL(@CRECEIVEDMRRID,'')<>''
   BEGIN
		 PRINT 'ROLLBACK STOCK AGST DOCWSL FIRST'
		 EXEC SP3S_UPDATEPMT_WSLCHI
			   @CXNID	   =  @cMemoId
			  , @NREVERTFLAG  = 1        
			  , @NALLOWNEGSTOCK = 0   
			  , @cErrmsg = @cErrmsg OUTPUT
			  , @CCMD    = @CCMDOUTPUT OUTPUT

		IF ISNULL(@cErrmsg,'')<>''	  
		BEGIN
		    GOTO EXIT_PROC
		END		 	  
   END

	SET @CSTEP=400	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
     	
   
    SET @CTABLENAME='PIM01106'        
    SET @CTMP_TABLENAME='pur_pim01106_upload'       
    SET @CKEYFIELD='MRR_ID'        
    
    SET @cTempFilter=' B.MRR_ID='''+@cMrrId+''''


	--if @@spid=846
	--	select @bAddmode,fin_year,mrr_no,mrr_id,* from  PUR_pim01106_UPLOAD (nolock) where inv_id=@CMEMOID

	PRINT @cTempFilter
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CMERGEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@bAddmode,@LUPDATEONLY=0,@BALWAYSUPDATE=1,@CFILTERCONDITION=@cTempFilter,@BUPDATEXNS=1
  --SELECT * FROM PIM01106    

  
	/*Rohit : 01-04-2023 : After DIscussion with sir on phone commenting this line
	 IF EXISTS (SELECT TOP 1 'U'   FROM PIM01106 A (NOLOCK) WHERE RECEIPT_DT<>''
	AND '01'+DBO.FN_GETFINYEAR(RECEIPT_DT )<>fin_year  AND MRR_ID =@cMrrId)
	BEGIN
		SET @CERRMSG = 'RECEIPT DATE DOES NOT BELONGS TO RECEIPT FIN Year Please check '
		GOTO EXIT_PROC 

	END
	*/
	 IF EXISTS (SELECT TOP 1 'U'   FROM pim01106 A (NOLOCK) WHERE RECEIPT_DT<>''
	AND CONVERT(DATE,receipt_dt) not between CONVERT(DATE,inv_dt)  and convert(date,getdate())
	AND mrr_id  =@cMrrId)
	BEGIN
		SET @CERRMSG = 'Receipt Date Must be between Invoice Date and ToDay date '
		GOTO EXIT_PROC 

	END

   

	SET @CSTEP=410	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
  
  

		SET @CTABLENAME='IND01106'        
		SET @CTMPINDTABLE='DOCWSL_'+@CTABLENAME+'_MIRROR'
    
		PRINT 'CREATING DETAIL CHALLAN INWARDS DATA'

		SET @DTSQL = N'insert pur_pid01106_upload (MRR_ID,SRNO,MP_PERCENTAGE,WSP_PERCENTAGE,
						FIX_MRP,USER_SRNO,MD_PERCENTAGE,WD_PERCENTAGE,
						MANUAL_MRP,MANUAL_WSP,MANUAL_GPP,MANUAL_WSPP,MANUAL_MPP,      
						MANUAL_DPP,PURCHASE_PRICE,WHOLESALE_PRICE,TAX_PERCENTAGE,TAX_AMOUNT,
						GROSS_PURCHASE_PRICE, PO_ROW_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PARA3_CODE,
						PARA4_CODE,PARA5_CODE,PARA6_CODE,fORM_ID,sp_id,quantity,invoice_quantity,scheme_quantity,row_id,bin_id,product_Code,
						hsn_code,gst_percentage, xn_value_without_gst,cgst_amount,igst_amount,sgst_amount,xn_value_with_gst,mrp,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,
						gst_cess_percentage,gst_cess_amount,PIMDiscountAmount,ps_id )
   
						SELECT '''+@CMRRID+''' AS MRR_ID,0 AS SRNO,0 AS MP_PERCENTAGE,0 AS WSP_PERCENTAGE,
						b.FIX_MRP AS FIX_MRP,0 AS USER_SRNO,0 AS MD_PERCENTAGE,0 AS WD_PERCENTAGE,
						0 AS MANUAL_MRP,0 AS MANUAL_WSP,0 AS MANUAL_GPP,0 AS MANUAL_WSPP,0 AS MANUAL_MPP,      
						0 AS MANUAL_DPP,
						A.NET_RATE AS PURCHASE_PRICE, 
						A.ws_price AS WHOLESALE_PRICE,--AS DISCUSS WITH SANJIV SIR/PANKAJ JI
						ITEM_TAX_PERCENTAGE AS TAX_PERCENTAGE,ITEM_TAX_AMOUNT AS TAX_AMOUNT,
						A.RATE AS GROSS_PURCHASE_PRICE,
						'''' AS PO_ROW_ID,
						B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,B.PARA3_CODE,B.PARA4_CODE,B.PARA5_CODE,B.PARA6_CODE,
						ITEM_FORM_ID AS FORM_ID,@@spid as sp_id,quantity,invoice_quantity,scheme_quantity,newid() as row_id,c.target_bin_id,a.product_code,
						a.hsn_code,a.gst_percentage,xn_value_without_gst,cgst_amount,igst_amount,sgst_amount,xn_value_with_gst,
						A.MRP,A.DISCOUNT_PERCENTAGE,A.DISCOUNT_AMOUNT,a.gst_cess_percentage,a.gst_cess_amount,a.INMDISCOUNTAMOUNT,a.ps_id
						FROM DOCWSL_IND01106_MIRROR A (NOLOCK) 
						JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE = B.PRODUCT_CODE
						JOIN docwsl_inm01106_mirror c (NOLOCK) ON c.inv_id=a.inv_id
						WHERE '+@CFILTERCONDITION1
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL
      
		SET @CSTEP=420	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1   
		PRINT 'DELETE OLDER CHALLAN DATA'+ISNULL(@CMRRID,'NULL CHALLAN')     
		DELETE  FROM PID01106 WITH (ROWLOCK)  WHERE MRR_ID = @CMRRID  
  
		SET @CSTEP=430	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
		SET @CTABLENAME='PID01106'        
		SET @CTMP_TABLENAME='pur_pid01106_upload'
		SET @CKEYFIELD='MRR_ID'        
		SET @CSTEP= 700        
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CMERGEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
				,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
				,@LINSERTONLY=0,@LUPDATEONLY=0        
				,@BALWAYSUPDATE=1,@CFILTERCONDITION=@cTempFilter
	
	 
        
	PRINT 'UPDATE STOCK AGST DOCWSL FIRST'

    EXEC SP3S_INSERT_PRODUCT_CODE_TO_DOWNLOAD_IMAGE @cXNTYPE='PUR',@cXNID=@CMEMOID

		
	SET @CSTEP=440	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
			
	SET @BCHALLANRECEIVEDPREV=1
	
	SET @CCMDOUTPUT=''
   
    SELECT @BCANCELLED=CANCELLED,@DPIMRECEIPTDT=RECEIPT_DT,@NXNITEMTYPE=XN_ITEM_TYPE FROM PIM01106 (NOLOCK) WHERE MRR_ID=@CMRRID
   	
    IF  ISNULL(@BCANCELLED,0)=0  AND ISNULL(@DPIMRECEIPTDT,'')<>''
    BEGIN
		EXEC SP3S_UPDATEPMT_WSLCHI
	    @CXNID  = @CMemoId
	  , @NREVERTFLAG  = 0        
	  , @NALLOWNEGSTOCK = 0      
	  , @cErrmsg = @cErrmsg OUTPUT
	  , @CCMD    = @CCMDOUTPUT OUTPUT

		IF ISNULL(@CCMDOUTPUT,'')<>'' OR ISNULL(@cErrmsg,'')<>''	  
		BEGIN
		  IF ISNULL(@CCMDOUTPUT,'')<>''
		  BEGIN
			  SET @BNEGSTOCKFOUND=1
	
			  EXEC SP_EXECUTESQL @CCMDOUTPUT
		  END

		  GOTO EXIT_PROC
		END		 	  	   
    END
   	 
    IF ISNULL(@CCMDOUTPUT,'')<>''	  
    BEGIN
	  SET @BNEGSTOCKFOUND=1
	
	  EXEC SP_EXECUTESQL @CCMDOUTPUT
	  GOTO EXIT_PROC
    END
  
  --@CCURLOCID READ FROM COFIG ONLY CHECK THIS IS HO OR NOT
 --   IF @NTARGETLOCTYPE=2 AND @bServerLoc=0 AND ISNULL(@CCURLOCID,'')<>ISNULL(@CHODEPTID,'')
 --   BEGIN
	--	SET @CSTEP=450	
	--	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

	--	EXEC SAVETRAN_PUR_UPDSKU
	--	@NsPiD=@CMRRID,
	--	@NMODE=1,
	--	@BCANCELBILL=0,
	--	@nUpdateMode=2,
	--	@CERRORMSG=@CERRMSG OUTPUT  

	--	IF ISNULL(@CERRMSG,'')<>''
	--		GOTO EXIT_PROC
	--END
    
	SET @CSTEP=460	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
	IF NOT EXISTS (SELECT TOP 1 MRR_ID FROM PID01106 (NOLOCK) WHERE MRR_ID= @CMRRID) 
	BEGIN
		SET @CSTEP = 730
		SET @CERRMSG = 'BLANK GROUP PURCHASE DETAILS CANNOT BE SAVED...PLEASE CHECK'
		GOTO EXIT_PROC 
	END    

	SET @CSTEP=470	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
    IF EXISTS (SELECT TOP 1 A.INV_ID FROM DOCWSL_IND01106_MIRROR A (NOLOCK) 
			   LEFT OUTER JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
			   WHERE A.inv_ID= @cMemoId AND B.PRODUCT_CODE IS NULL)
    BEGIN
		SET @CERRMSG = 'SOME BAR CODE DETAILS NOT UPDATED AGAINST THE GROUP CHALLAN...PLEASE CHECK'
		GOTO EXIT_PROC 
    END        
    
		SET @CSTEP=480	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
    SET @DTSQL = N'IF EXISTS (SELECT TOP 1 A.PRODUCT_CODE FROM DOCWSL_IND01106_MIRROR A (NOLOCK) 
							  LEFT OUTER JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE WHERE '+
							  @CFILTERCONDITION1+' AND B.PRODUCT_CODE IS NULL)
						SET @CERRMSG = ''SOME BAR CODE DETAILS NOT UPDATED AGAINST THE GROUP CHALLAN SOURCE DATA...PLEASE CHECK'''			  
	EXEC SP_EXECUTESQL @DTSQL,N'@CERRMSG VARCHAR(MAX) OUTPUT',@CERRMSG OUTPUT
	
	


	IF NOT (@BHOLOC=1 OR @bServerLoc=1)
	BEGIN
		SET @CSTEP=500	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
		SET @CTABLENAME='BOXM'        
		SET @CTMP_TABLENAME='DOCWSL_BOXM_MIRROR'       
		SET @CKEYFIELD='BOX_ID'        
    
    

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CMERGEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
			 ,@LINSERTONLY=0,@LUPDATEONLY=0,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2
  

		SET @CSTEP=510	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
  
		SET @CTABLENAME='BOXD'        
		SET @CTMP_TABLENAME='DOCWSL_BOXD_MIRROR'       
		SET @CKEYFIELD='BOX_ID'        
		SET @CSTEP= 780
    

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CMERGEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='ROW_ID',@CKEYFIELD3=''        
			 ,@LINSERTONLY=0,@LUPDATEONLY=0,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION2
  
    END

	IF EXISTS (SELECT TOP 1'U' FROM PIM01106 A (NOLOCK) WHERE A.INV_ID =@CMEMOID AND A.CANCELLED =0 AND A.MRR_ID <>@CMRRID)
	BEGIN
	    SET @CERRMSG = 'Challan has already Received ...PLEASE CHECK'
		GOTO EXIT_PROC 

	END

	 --changes tcs calculate on total amount
	  
	--  set @cstep=520
	 IF EXISTS (SELECT TOP 1 'U' FROM LOCATION WHERE DEPT_ID =@CCURDEPTID AND ISNULL(Enable_Tcs,0)=1)
	   and exists (select top 1 'u' from TCS_MST where Wef <=@DPIMRECEIPTDT and isnull(Tcs_Type,0)=1 ) and isnull(@nxnitemtype,0)=1
	  
	   BEGIN
	        
			
	       IF OBJECT_ID ('TEMPDB..#TMSTTABLE','U') IS NOT NULL
		  DROP TABLE #TMSTTABLE

			SELECT A.MRR_ID,A.RECEIPT_DT ,a.ac_code,a.challan_source_location_code as dept_id,
			      cast(0 as numeric(18,2)) GOODS_TDS_BASEAMOUNT,
				   cast(0 as numeric(10,3)) GOODS_TDS_PERCENTAGE,  
				   cast(0 as numeric(14,2)) GOODS_TDS_AMOUNT  ,
				   total_amount  
			INTO #TMSTTABLE
			FROM PIM01106 A (NOLOCK) WHERE MRR_ID=@CMRRID and receipt_dt <>''


			DECLARE @NTAXABLEVALUE numeric(12,2)
			      


			select @NTAXABLEVALUE=sum(xn_value_without_gst)  from PId01106 A (NOLOCK) WHERE MRR_ID=@CMRRID 


		  EXEC SP3S_TCSCAL_pur 
		  @CXNTYPE='PUR',
		  @CLOCID=@CCURDEPTID,
		  @NTAXABLEVALUE=@NTAXABLEVALUE,
		  @NPARTY_AMOUNT_FORTCS=@NPARTY_AMOUNT_FORTCS,
		  @CERRORMSG=@CERRORMSG OUTPUT
		  ,@ninvmode=2


		  IF ISNULL(@cErrormsg,'')<>''
		   GOTO EXIT_PROC

		


		   UPDATE A SET GOODS_TDS_BASEAMOUNT =ISNULL(B.GOODS_TDS_BASEAMOUNT,0),
		                GOODS_TDS_PERCENTAGE =ISNULL(B.GOODS_TDS_PERCENTAGE,0),
						GOODS_TDS_AMOUNT =ISNULL(B.GOODS_TDS_AMOUNT,0)
		   FROM PIM01106 A
		   JOIN  #TMSTTABLE B ON A.MRR_ID =B.MRR_ID 
		   WHERE A.MRR_ID =@CMRRID

		

	   END

	

	----update status in hold back delived det
	
	
	SET @CSTEP=540	
	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
	
	EXEC SP3S_UPD_SKUXFPNEW 'PUR',@CMRRID,0
	
	
	--Goods retrun at the time of Git Receive

	IF EXISTS (SELECT Top 1 'U' FROM DOCWSL_XNRECON_GITBIN_UPLOAD (nolock) WHERE INV_ID=@CMEMOID)
	begin
	        
	    SET @CSTEP=550	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
		SET @CTABLENAME='XNRECON_GITBIN'        
		SET @CTMP_TABLENAME='DOCWSL_XNRECON_GITBIN_UPLOAD'       
		SET @CKEYFIELD='inv_id'    
		set @CFILTERCONDITION1=' b.inv_id='''+@CMEMOID+'''  '
    
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CMERGEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
			 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='PS_ID',@CKEYFIELD3=''        
			 ,@LINSERTONLY=1,@BUPDATEXNS=1,@BALWAYSUPDATE=1,@CFILTERCONDITION=@CFILTERCONDITION1
  
	     SET @CSTEP=552
		IF EXISTS (SELECT Top 1 'U' FROM DOCWSL_XNRECON_GITBIN_UPLOAD (nolock) WHERE INV_ID=@CMEMOID and ISNULL(GIT_RECEIVED,0)=0)
		begin
		
		   declare @cps_id varchar(50)
		   select PS_ID into #tmpnewps  from DOCWSL_XNRECON_GITBIN_UPLOAD (nolock) WHERE INV_ID=@CMEMOID and ISNULL(GIT_RECEIVED,0)=0
		   GROUP BY PS_ID
		   
		   WHILE EXISTS (SELECT TOP 1 'U' FROM #TMPNEWPS)
		   begin
		   
		   SELECT TOP 1 @cps_id=PS_ID FROM #TMPNEWPS ORDER BY PS_ID 
			
			IF @NRETURNINVOICE=2
			BEGIN
			    
				PRINT 'GENERATE DEBITNOET'
				
				EXEC SP_Generate_GRPPrt
				     @CMEMOID=@CMEMOID,
                     @CLOCID=@CCURDEPTID,
                     @CRETRUNID=@CRETRUNID output,
                     @cErrormsg=@CERRORMSG output ,
                     @CPS_ID=@cps_id,
                     @cUser_code=@CWIZAPPUSERCODE
                     
                     IF ISNULL(@CERRORMSG,'')<>''
                        GOTO EXIT_PROC

			END
			Else IF @NRETURNINVOICE=1
			BEGIN
			     
			     PRINT 'GENERATE WSL INVOICE'
			     
			     	EXEC SP_Generate_GRPWSL
				     @CMEMOID=@CMEMOID,
                     @CLOCID=@CCURDEPTID,
                     @CRETRUNID=@CRETRUNID output,
                     @cErrormsg=@CERRORMSG output ,
                     @CPS_ID=@cps_id,
                     @cUser_code=@CWIZAPPUSERCODE
                     
                     IF ISNULL(@CERRORMSG,'')<>''
                        GOTO EXIT_PROC
			
			end
			
			if ISNULL(@CRETRUNID,'')=''
			begin
			    set @CERRORMSG='Error In Generating return Item'
			    GOTO EXIT_PROC
			end
		
		  DELETE  FROM #TMPNEWPS WHERE PS_ID=@CPS_ID
	 END
		
	end
		
	end

	--AS DISCUSS WITH SANJIV SIT SKU AS IT IS SYNCH IN HO TO LOCATION

	--IF ISNULL(@CCURLOCID,'')<>ISNULL(@CHODEPTID,'') AND @bServerLoc<>1
	--BEGIN
	--	SET @CSTEP=545	
	--	EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

	--	UPDATE A SET PURCHASE_PRICE =B.PURCHASE_PRICE,
	--				 MRP =B.MRP ,
	--				 WS_PRICE =B.MRP 
	--	FROM SKU A WITH (ROWLOCK)
	--	JOIN
	--	(

	--	SELECT LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE ))) AS PRODUCT_CODE ,
	--		   MRP ,PURCHASE_PRICE 
	--	FROM PID01106 A (NOLOCK)
	--	JOIN PIM01106 B (NOLOCK) ON A.MRR_ID =B.MRR_ID 
	--	WHERE CHARINDEX ('@',A.PRODUCT_CODE)<>0
	--	AND  A.MRR_ID=@CMRRID
	--	GROUP BY LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))  ,
	--	MRP ,PURCHASE_PRICE
	--	) B ON A.PRODUCT_CODE =B.PRODUCT_CODE 

	--end
	
	




   							
 END TRY        
 BEGIN CATCH
  PRINT 'CATCH START'       
  SET @CERRMSG='P:SAVETRAN_MERGE_MIRROR_DOCWSL_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
 END CATCH        
        
EXIT_PROC:   



 		SET @CSTEP=560	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

 SET @CTABLESSTR='FORM,STATE,CITY,AREA,HD01106,LM01106,LMP01106,SECTIONM,LOCSST_MST,SECTIOND,LOCSST,LOCSSTADD,PARA1,PARA2,PARA3,PARA4,PARA5,PARA6,ARTICLE,ATTRM,ART_ATTR,ATTR_KEY,SKU,SKU_OH,SKU_BO,SLSMST,SLSDET,SLSBC,INM01106,IND01106,XNSTABLELIST'
 
 IF ISNULL(@CERRORMSG,'')<>'' AND ISNULL(@CERRMSG,'')=''
	SET @CERRMSG=@CERRORMSG
	
 IF ISNULL(@CERRMSG,'')='' AND ISNULL(@CCMDOUTPUT,'')='' AND @DRECEIPTDT<>''
 BEGIN
 		SET @CSTEP=570	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

	DELETE FROM DOCWSL_FORM_MIRROR WITH (ROWLOCK) WHERE DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_STATE_MIRROR WITH (ROWLOCK) WHERE DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_CITY_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_AREA_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_HD01106_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_LM01106_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_LMP01106_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_LOCSST_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_LOCSST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_LOCSSTADD_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_SECTIONM_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_SECTIOND_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_PARA1_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_PARA2_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_PARA3_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_PARA4_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_PARA5_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_PARA6_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_PARA7_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ARTICLE_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_SKU_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_SKU_OH_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_SCHEME_SETUP_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_SCHEME_SETUP_DET_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_SCHEME_SETUP_SLSBC_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_PARCEL_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_PARCEL_DET_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ANGM_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID

	DELETE FROM DOCWSL_ARTICLE_FIX_ATTR_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR1_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR2_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR3_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR4_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR5_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR6_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR7_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR8_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR9_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR10_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR11_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR12_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR13_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR14_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR15_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR16_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR17_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR18_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR19_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR20_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR21_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR22_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR23_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR24_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_ATTR25_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_BOXM_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_BOXd_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
	DELETE FROM DOCWSL_HSN_MST_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
    DELETE FROM DOCWSL_HSN_DET_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID

	DELETE FROM DOCWSL_art_det_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID
    DELETE FROM DOCWSL_art_para1_mirror WITH (ROWLOCK) where DOCWSL_MEMO_ID=@CMEMOID

	DELETE FROM DOCWSL_IND01106_mirror WITH (ROWLOCK) where INV_ID=@CMEMOID
	DELETE FROM DOCWSL_INM01106_mirror WITH (ROWLOCK) where INV_ID=@CMEMOID

	
	
 END

		SET @CSTEP=580	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1

	
 IF @@trancount>0 and  ISNULL(@BCALLEDFORSISLOC,0)=0
 BEGIN
	IF ISNULL(@cErrmsg,'')=''
	begin
	     commit
		 DELETE A  FROM XNTYPE_CHECKSUM_MST A  WITH (ROWLOCK)  WHERE SP_ID=@CMEMOID
		 
	end
	ELSE
	begin
		ROLLBACK
		DELETE A  FROM XNTYPE_CHECKSUM_MST A  WITH (ROWLOCK)  WHERE SP_ID=@CMEMOID
	end
 END

		 IF ISNULL(@cErrmsg,'')=''
		 BEGIN
		      
		      UPDATE PIM01106 WITH (ROWLOCK) SET LAST_UPDATE=GETDATE(),HO_SYNCH_LAST_UPDATE =''
		      WHERE MRR_ID=@CMRRID
			
			 if @NXNITEMTYPE=5
			 begin
			     
				  DECLARE @NCANCELLED BIT,@RECEIVE_FROM_HO_No varchar(50)
				 select top 1 @NCANCELLED=CANCELLED ,@RECEIVE_FROM_HO_No=mrr_no
				 from PIM01106 (nolock) where MRR_ID=@CMRRID


                  IF @CHODEPTID=@CCURDEPTID
                  BEGIN
                  
					  UPDATE B SET RECEIVE_FROM_HO= CASE WHEN @NCANCELLED=1 THEN 0 ELSE 1 END,
								  RECEIVE_FROM_HO_DT=@DRECEIPTDT,
								  RECEIVE_FROM_HO_NO=@RECEIVE_FROM_HO_NO
					 FROM PID01106 A (NOLOCK)
					 JOIN HOLD_BACK_DELIVER_DET B WITH (ROWLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
					 WHERE A.MRR_ID =@CMRRID
					 
				 END
				
				 
			 end

		 END

        if ISNULL(@BMSTINSERTONLY,0)=0 and ISNULL(@cErrmsg,'')=''
		begin
		      EXEC SP3S_UPDATE_SKUNAMES @CMRRID,'PUR','PID01106','MRR_ID'
 		end
		SET @CSTEP=590	
		EXEC SP_CHKXNSAVELOG 'wSLCHI',@cStep,0,@cMemoId,@CTABLENAME,1
 
END 
------ END OF CREATING PROCEDURE - SAVETRAN_MERGE_MIRROR_DOCWSL_DATA

