CREATE PROCEDURE DBO.SP3S_ACKNOWLGEDMENT_ONLINE_CN
( 
 @nSpId VARCHAR(40)
 ,@cLOcationId VARCHAR(4)
,@ERRMSG VARCHAR(MAX) OUTPUT
)
AS
 BEGIN
  --DECLARE LOCAL VARIABLE
   DECLARE @ONLINE_REDEEMPTION_CONFIG INT,@RECORDCOUNT INT
           ,@NLOOP_START INT,@START_TIME VARCHAR(10)
   --SET VALUE INTO VARIABLE
   SELECT @ONLINE_REDEEMPTION_CONFIG = VALUE FROM DBO.CONFIG WITH(NOLOCK) WHERE CONFIG_OPTION = 'ONLINE_REDEEMPTION_CN'
   
   
   IF ISNULL(@ONLINE_REDEEMPTION_CONFIG,'') = '1'
      BEGIN
       INSERT INTO DBO.UPLOAD_ONLINE_CN_REDEEMPTION(CN_ID,DEPT_ID,CM_ID)
       SELECT ADJ_MEMO_ID,@cLocationId,MEMO_ID FROM SLS_paymode_xn_det_UPLOAD WITH(NOLOCK) 
       WHERE SP_ID=@nSpid  AND PAYMODE_CODE ='0000001'

       AND ISNULL(ADJ_MEMO_ID,'')<>''
       SET @RECORDCOUNT= @@ROWCOUNT
       IF ISNULL(@RECORDCOUNT,0) > 0
          BEGIN
            SET @NLOOP_START = 1
            SET @START_TIME =CONVERT(VARCHAR(10),GETDATE(),108)
            WHILE @NLOOP_START > 0
              BEGIN
               IF ((SELECT DATEDIFF(SECOND,@START_TIME,CONVERT(VARCHAR(10),GETDATE(),108))) >= 60)
                    BEGIN
                    SET @ERRMSG='CREDIT NOTE REDEEMPTION COULD NOT BE ACKNOWLGEDE AT HEAD OFFICE PLACE'
                     GOTO PROC_END;
                    END
               IF ((SELECT TOP 1 ISNULL(PROCESSED,0) FROM DBO.UPLOAD_ONLINE_CN_REDEEMPTION WITH(NOLOCK)) = 1)
                    BEGIN
                     SET @ERRMSG=''
                     GOTO PROC_END;
                    END
              END
          END
        ELSE
          BEGIN
            SET @ERRMSG =''
          END
      END
      
PROC_END:

END