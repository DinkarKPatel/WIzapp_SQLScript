CREATE PROCEDURE SP3S_GETCUSTOMER_CARD_DISCOUNT
(
@dXnDt VARCHAR(20)='2023-05-10',
@cCUSTOMER_CODE VARCHAR(20)='000000000000'
)
AS
BEGIN
--DECLARE @dXnDt VARCHAR(20)='2023-05-10'
--DECLARE @cCUSTOMER_CODE VARCHAR(20)='H10000000019'
DECLARE @CPARA VARCHAR(20),@CSTEP VARCHAR(5)
SET @CSTEP='10'
		PRINT 'ENTER CARD DISCOUNT'
		SELECT TOP 1 @CPARA = VALUE FROM CONFIG WHERE CONFIG_OPTION = 'PARA_NAME_FOR_BRAND'
		IF ISNULL(@CPARA,'')=''
			SELECT TOP 1 @CPARA = VALUE FROM CONFIG WHERE CONFIG_OPTION = 'PARA_NAME_FOR_DISCOUNT'
			
		IF OBJECT_ID('TEMPDB..#TMPPARA','U') IS NOT NULL
		   DROP TABLE #TMPPARA
		
		SET @CSTEP='20'   
		SELECT CONVERT(VARCHAR(50),'') AS PRODUCT_CODE, CAST('' AS VARCHAR(100)) AS PARA_CODE , CAST('' AS VARCHAR(100)) AS PARA_NAME 
		INTO #TMPPARA
		WHERE 1=2
		
		--SELECT 'CHECK #TMPCMD',* FROM #TMPCMD
		IF ISNULL(@CPARA,'') IN ('1','2','3','4','5','6')
			SET @CPARA = 'PARA' +  @CPARA
	    
;WITH A
AS
(
SELECT A.cutoff_disc_per, A.NORMAL_DISC_PER,EOSS_DISC_PER,a.MEMO_ID,ISNULL(b.max_purchase_amount_per_bill,a.max_purchase_amount_per_bill) as max_purchase_amount_per_bill
FROM BWD_MST A
LEFT OUTER JOIN loc_bwd_mst b on b.memo_id=a.memo_id AND b.dept_id='01' 
)
,B
AS
(
SELECT  B.DISC_PER AS EXCEPTIONAL_NORMAL_DISC_PER,B.EOSS_DISC_PER AS EXCEPTIONAL_EOSS_DISC_PER,A.MEMO_ID,B.PARA_CODE 
FROM BWD_MST A
JOIN BWD_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID 
WHERE (ISNULL(B.DISC_PER,0)+ISNULL(B.EOSS_DISC_PER,0))<>0 AND A.PARA_NAME= @CPARA
),
C
AS
(
	SELECT  * FROM custdym WHERE CUSTOMER_CODE=@cCUSTOMER_CODE AND DT_CARD_EXPIRY >@dXnDt
)
,PARA
AS
(
	--INSERT INTO #TMPPARA(PARA_CODE,PARA_NAME)
	SELECT PARA1_CODE PARA_CODE,PARA1_NAME PARA_NAME
	FROM PARA1 A
	JOIN B ON B.PARA_CODE=A.PARA1_CODE
	WHERE @CPARA='PARA1'
	UNION
	SELECT PARA2_CODE PARA_CODE,PARA2_NAME PARA_NAME
	FROM PARA2 A
	JOIN B ON B.PARA_CODE=A.PARA2_CODE
	WHERE @CPARA='PARA2'
	UNION
	SELECT PARA3_CODE PARA_CODE,PARA3_NAME PARA_NAME
	FROM PARA3 A
	JOIN B ON B.PARA_CODE=A.PARA3_CODE
	WHERE @CPARA='PARA3'
	UNION
	SELECT PARA4_CODE PARA_CODE,PARA4_NAME PARA_NAME
	FROM PARA4 A
	JOIN B ON B.PARA_CODE=A.PARA4_CODE
	WHERE @CPARA='PARA4'
	UNION
	SELECT PARA5_CODE PARA_CODE,PARA5_NAME PARA_NAME
	FROM PARA5 A
	JOIN B ON B.PARA_CODE=A.PARA5_CODE
	WHERE @CPARA='PARA5'
	UNION
	SELECT PARA6_CODE PARA_CODE,PARA6_NAME PARA_NAME
	FROM PARA6 A
	JOIN B ON B.PARA_CODE=A.PARA6_CODE
	WHERE @CPARA='PARA6'
)
SELECT C.CUSTOMER_CODE,A.*,B.*,PARA.PARA_NAME
FROM C
LEFT OUTER JOIN  A ON A.MEMO_ID=C.card_code
LEFT OUTER JOIN B ON B.MEMO_ID=A.MEMO_ID 
LEFT OUTER JOIN PARA ON PARA.PARA_CODE=B.PARA_CODE
--AND BWD.PARA_CODE=D.PARA_CODE
		   --WHERE C.CUSTOMER_CODE = '''+@CCUSTOMERCODE+''' 

END