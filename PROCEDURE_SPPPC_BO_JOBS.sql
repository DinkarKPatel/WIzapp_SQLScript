CREATE PROCEDURE SPPPC_BO_JOBS
(
 @CBILL_NO VARCHAR(100)='',
 @CJOB_CODE VARCHAR(10)='',
 @NQUERYID INT=1,
 @NSP_ID INT=0
)
AS
BEGIN

IF @NQUERYID=1
   GOTO LBLJOBS
ELSE IF @NQUERYID=2
   GOTO LBLBODETAILS
ELSE IF @NQUERYID=3
   GOTO LBLSIZEDET
ELSE 
GOTO END_PROC
 
 
 LBLJOBS:
 
    SELECT DISTINCT JOB_ORDER,JOB_NAME,C.JOB_CODE 
    FROM PPC_BUYER_ORDER_DET A
    JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
    JOIN PPC_BO_ART_JOBS C ON A.ROW_ID=C.REF_ROW_ID
    JOIN JOBS ON JOBS.JOB_CODE=C.JOB_CODE
    WHERE B.CANCELLED=0 
    AND B.BILL_NO=@CBILL_NO
    ORDER BY JOB_ORDER
 GOTO END_PROC   
 
 LBLBODETAILS:
 
    SELECT B.ORDER_NO,
           B.ORDER_DT, 
           A.PARA3_CODE ,
           P3.PARA3_NAME ,
           ART.ARTICLE_CODE,
           ART.ARTICLE_NO ,
           P1.PARA1_CODE,
           P1.PARA1_NAME,
           SG.SIZEGROUP_CODE,
           SG.SIZEGROUP_NAME,
           QUANTITY=CAST(0 AS NUMERIC(10,0)),
           UOM.UOM_NAME,
           UOM.UOM_CODE,
           P2.PARA2_CODE,
           P2.PARA2_NAME,
           PMT.PRODUCT_CODE,
           PMT.QUANTITY_IN_STOCK,
           A.ROW_ID AS BO_ROW_ID,
           CAST('LATER' AS VARCHAR(40)) AS ROW_ID
    FROM PPC_BUYER_ORDER_DET A
    JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
    JOIN PPC_BO_ART_JOBS C ON A.ROW_ID=C.REF_ROW_ID
    JOIN PARA3 P3 ON P3.PARA3_CODE=A.PARA3_CODE
    JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE
    JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
    JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE=A.SIZEGROUP_CODE
    JOIN UOM ON UOM.UOM_CODE=ART.UOM_CODE
    JOIN PPC_FGBCG_DET DET ON DET.BO_DET_ROW_ID=A.ROW_ID
    JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=DET.ROW_ID
    JOIN PARA2 P2 ON P2.PARA2_CODE=SKU.PARA2_CODE
    JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE
    WHERE B.CANCELLED=0  AND PMT.QUANTITY_IN_STOCK>0
    AND B.BILL_NO=@CBILL_NO
    AND C.JOB_CODE=@CJOB_CODE
   
 GOTO END_PROC 


LBLSIZEDET:

      
      	IF OBJECT_ID('TEMPDB..#TMPPARA2','U') IS NOT NULL
	      DROP TABLE #TMPPARA2
	      
      SELECT B.ORDER_ID,
           B.ORDER_NO,
           B.ORDER_DT, 
           A.PARA3_CODE ,
           P3.PARA3_NAME ,
           ART.ARTICLE_CODE,
           ART.ARTICLE_NO ,
           P1.PARA1_CODE,
           P1.PARA1_NAME,
           SG.SIZEGROUP_CODE,
           SG.SIZEGROUP_NAME,
           UOM.UOM_NAME,
           UOM.UOM_CODE,
           P2.PARA2_CODE,
           P2.PARA2_NAME,
           P2.PARA2_ORDER,
            CAST(SUM(PMT.QUANTITY_IN_STOCK) AS NUMERIC(10,0)) AS QUANTITY_IN_STOCK,
           JOBS.JOB_NAME
           --A.ROW_ID
    INTO #TMPPARA2
    FROM PPC_BUYER_ORDER_DET A
    JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
    JOIN PPC_BO_ART_JOBS C ON A.ROW_ID=C.REF_ROW_ID
    JOIN PARA3 P3 ON P3.PARA3_CODE=A.PARA3_CODE
    JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE
    JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
    JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE=A.SIZEGROUP_CODE
    JOIN UOM ON UOM.UOM_CODE=ART.UOM_CODE
    JOIN PPC_FGBCG_DET DET ON DET.BO_DET_ROW_ID=A.ROW_ID
    JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=DET.ROW_ID
    JOIN PARA2 P2 ON P2.PARA2_CODE=SKU.PARA2_CODE
    JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE
    JOIN JOBS ON JOBS.JOB_CODE=C.JOB_CODE
    JOIN PPC_BARCODE_UPLOAD TMP ON TMP.PRODUCT_CODE=PMT.PRODUCT_CODE
    WHERE B.CANCELLED=0  AND PMT.QUANTITY_IN_STOCK>0
    AND B.BILL_NO=@CBILL_NO 
    AND JOBS.JOB_CODE=@CJOB_CODE
    AND TMP.SP_ID=@NSP_ID
    GROUP BY B.ORDER_ID,
           B.ORDER_NO,
           B.ORDER_DT, 
           A.PARA3_CODE ,
           P3.PARA3_NAME ,
           ART.ARTICLE_CODE,
           ART.ARTICLE_NO ,
           P1.PARA1_CODE,
           P1.PARA1_NAME,
           SG.SIZEGROUP_CODE,
           SG.SIZEGROUP_NAME,
           UOM.UOM_NAME,
           UOM.UOM_CODE,
           P2.PARA2_CODE,
           P2.PARA2_NAME,
           P2.PARA2_ORDER,
           JOBS.JOB_NAME
     ORDER BY PARA2_ORDER
           --A.ROW_ID
           
  
      
      
    IF OBJECT_ID('TEMPDB..#TMPP2','U') IS NOT NULL
	    DROP TABLE #TMPP2
	    
    SELECT DISTINCT PARA2_NAME,PARA2_ORDER   INTO #TMPP2 FROM #TMPPARA2
    
    DECLARE @COLNAME VARCHAR(MAX),@DISPLAYCOLNAME VARCHAR(MAX),
	@DTSQL NVARCHAR(MAX)
		
	SET @DISPLAYCOLNAME=''
	SET @COLNAME=''
	
    SELECT @COLNAME=ISNULL(@COLNAME+',','')+QUOTENAME(PARA2_NAME)
	FROM #TMPP2 WHERE PARA2_NAME <>''
	ORDER BY PARA2_ORDER
	 
	SELECT @DISPLAYCOLNAME=ISNULL(@DISPLAYCOLNAME+',','')+'SUM('+QUOTENAME(PARA2_NAME)+') AS '+QUOTENAME(PARA2_NAME)
	FROM #TMPP2 WHERE PARA2_NAME <>''
	ORDER BY PARA2_ORDER    
	 --IF @COLNAME<>''
	 --SET @DISPLAYCOLNAME=' '+@COLNAME
	    
	 SET @COLNAME=SUBSTRING(@COLNAME,2,LEN(@COLNAME))
	 
	    
	   SET @DTSQL=N' SELECT ORDER_NO AS [BUYER ORDER NO],PARA3_NAME AS [BUYER STYLE NO] ,
	                ARTICLE_NO AS [REF NO/ARTICLE NO],
	                PARA1_NAME AS COLOR,
	                SIZEGROUP_NAME AS [SIZE GROUP],
	                UOM_NAME AS UOM '+@DISPLAYCOLNAME+'
				FROM #TMPPARA2 A
				PIVOT (SUM(QUANTITY_IN_STOCK) FOR PARA2_NAME IN ('+@COLNAME+')) AS PTABLE 
				GROUP BY ORDER_NO,PARA3_NAME,ARTICLE_NO,PARA1_NAME,SIZEGROUP_NAME,UOM_NAME'
				
	  PRINT @DTSQL	
	  EXEC SP_EXECUTESQL @DTSQL

GOTO END_PROC

 END_PROC:
END
