CREATE PROCEDURE SP_PURLIST_FILTER
(      
		@NINV_MODE NUMERIC(1),           /* @NINV_MODE:0 FOR ALL, 1 FOR GROUP AND 2 FOR PARTY INVOICE MODE */      
		@NBILL_CHALLAN_MODE NUMERIC(1),  /* @NBILL_CHALLAN_MODE: 2 FOR ALL,1 FOR CHALLAN AND 0 FOR INVOICE */      
		@NAC_STATUS NUMERIC(1),       /* @NAC_STATUS:0 FOR ALL,1 FOR PENDING, 2 FOR UPDATE*/      
		@NDT_FLAG NUMERIC(1),            /* @NDT_FLAG:0 FOR RECEIPT DATE AND 1 FOR INV DATE */      
		@DFROMDATE DATETIME,    /* @DFROMDATE:2013-04-20 FOR FROM RECEIPT_DATE DATE OR FROM INV DATE DATE */      
		@DTODATE DATETIME,     /* @DTODATE:2014-08-05 FOR TO RECEIPT_DATE OR TO INV DATE DATE*/      
		@CAC_CODE VARCHAR(100),    /* @CAC_CODE:PURCHASE FROM AC_CODE */       
		@CDEPT_ID VARCHAR(4),       /* @CDEPT_ID:PURCHASE FROM DEPT_ID */      
		@TAXFORM VARCHAR(70),   --'' FOR ALL ELSE FILTERED (ITEM_FORM_ID)      
		@BCANCELLED NUMERIC(1),     /* @BCANCELLED:0 FOR UNCANCELLED AND 1 FOR CANCELLED */      
		@PIM_MODE NUMERIC(1),    /* @PIM_MODE:1 FOR DIRECT AND 2 FOR AGAINST PO AND 0 FOR BOTH */      
		@BMEMOTYPE BIT=0,      
		@CAREA_CODE CHAR(7)='',      
		@CCITY_CODE VARCHAR(10)='',    
		@LOC VARCHAR(4)=''  ,    
		@NITEM_MODE NUMERIC(1)=1, /* :0 FOR ALL, 1 INV  2 Consumable 3 Assets 4 service FOR PARTY INVOICE MODE */      
		@NCHALLAN_CONVERTED NUMERIC(1)=0 ,/* :0 FOR ALL, 1 CHALLANS  2 CONVERTED TO BILL */      
		@NDOCATTACH NUMERIC(1)=0 /* : 1 ATTACH  0 NOT ATTACH */      
		,@oem_ac_code VARCHAR(10)='',
		@bListMode	BIT=0,
		@cSPID		VARCHAR(50)=''
)      

----WITH ENCRYPTION      
AS      
BEGIN      
	SET NOCOUNT ON      
	  
	  SELECT PIM.MRR_ID ,CONVERT(NUMERIC(14,2),0) AS LEDGER_NET_AMOUNT      
		INTO #FITLER_PIM      
		FROM PIM01106 PIM(NOLOCK) 
		WHERE 1=2


	IF ISNULL(@bListMode,0)=1
	BEGIN
		INSERT INTO #FITLER_PIM(MRR_ID,LEDGER_NET_AMOUNT)
		SELECT PIM.MRR_ID ,CONVERT(NUMERIC(14,2),0) AS LEDGER_NET_AMOUNT      
		FROM PIM01106 PIM(NOLOCK)  
		JOIN SERACH_BY_MEMO_NO B (NOLOCK) ON B.MEMO_ID=PIM.mrr_id
		WHERE B.XN_TYPE='PUR' AND B.SP_ID= @cSPID

		DELETE FROM SERACH_BY_MEMO_NO WHERE XN_TYPE='PUR' AND SP_ID= @cSPID

		SET @NAC_STATUS=0
	END
	ELSE
	BEGIN
       INSERT INTO #FITLER_PIM(MRR_ID,LEDGER_NET_AMOUNT)
	 SELECT PIM.MRR_ID ,CONVERT(NUMERIC(14,2),0) AS LEDGER_NET_AMOUNT      
	 --INTO #FITLER_PIM      
	 FROM PIM01106 PIM(NOLOCK)      
	 LEFT JOIN LMP01106 lmp(NOLOCK) ON lmp.ac_code=pim.ac_code
	 LEFT JOIN area (NOLOCK) ON area.area_code=lmp.area_code
	 LEFT JOIN city (NOLOCK) ON city.city_code=area.city_code
	 WHERE     
	 ((@NDT_FLAG = 2 AND PIM.RECEIPT_DT BETWEEN  @DFROMDATE AND @DTODATE)       
		 OR (@NDT_FLAG = 1 AND PIM.INV_DT BETWEEN  @DFROMDATE AND @DTODATE)
		 OR (@NDT_FLAG = 3 AND PIM.MRR_DT BETWEEN  @DFROMDATE AND @DTODATE)
		 OR (@NDT_FLAG = 4 AND PIM.BILL_DT BETWEEN  @DFROMDATE AND @DTODATE))      

	AND (ISNULL(@NINV_MODE, 0)= 0 OR (ISNULL(@NINV_MODE, 0)<>0 AND INV_MODE=@NINV_MODE))      
	AND ((@NBILL_CHALLAN_MODE=2 )  OR (pim.BILL_CHALLAN_MODE=@NBILL_CHALLAN_MODE))
	AND (ISNULL(@CAC_CODE,'')='' OR pim.AC_CODE=@CAC_CODE)      
	AND (ISNULL(@oem_ac_code,'')='' OR pim.SHIPPING_FROM_AC_CODE=@oem_ac_code)      
	AND (ISNULL(@CDEPT_ID,'')='' OR pim.DEPT_ID=@CDEPT_ID)         
	AND (ISNULL(@CAREA_CODE,'')='' OR LMP.AREA_CODE=@CAREA_CODE)            
	AND (ISNULL(@CCITY_CODE,'')='' OR city.CITY_CODE=@CCITY_CODE)            
	AND ((@BCANCELLED=2 AND (INV_MODE=1 OR pim.CANCELLED=0))OR pim.CANCELLED=@BCANCELLED)       
	AND (@PIM_MODE=0 OR (PIM_MODE=@PIM_MODE OR PIM_MODE=CASE WHEN @PIM_MODE=2 THEN 3 ELSE @PIM_MODE END))      
	AND (@BMEMOTYPE=0 OR pim.MEMO_TYPE =1)     
	AND (@LOC='' OR pim.dept_id=@LOC)    
	AND (@NITEM_MODE=0 OR (pim.XN_ITEM_TYPE =@NITEM_MODE))        
	AND (@NCHALLAN_CONVERTED=0 OR (@NCHALLAN_CONVERTED=2 and pim.bill_challan_mode=1  AND ISNULL(ref_converted_mrntobill_mrrid,'')='')     
	OR (@NCHALLAN_CONVERTED=1 AND ISNULL(ref_converted_mrntobill_mrrid,'')<>'') )   
	AND (@NDOCATTACH =2 or (isnull(pim.DocAttach,0)=@NDOCATTACH ))
  END
  	  SELECT MEMO_ID 
	  INTO #tmpPvl
	  FROM POSTACT_VOUCHER_LINK PVL(NOLOCK) 
	  JOIN VM01106 VM (NOLOCK) ON PVL.VM_ID =VM.VM_ID 
	  JOIN #FITLER_PIM pim ON pim.mrr_id=pvl.memo_id
	  WHERE  LEFT(PVL.XN_TYPE,3)  IN ('PUR','PURCHI') AND VM.CANCELLED=0


	 SELECT  B.MRR_ID,b.MRR_NO,CONVERT(VARCHAR, B.MRR_DT  ,106) AS MRR_DT , UPPER(D.AC_NAME) AS AC_NAME,  LMV.ALIAS   AS AC_ALIAS,  
	 ISNULL(CITY,'') AS CITY_NAME,      
	 b.INV_NO AS CHALLAN_NO,     
	  CONVERT(VARCHAR, B.INV_DT  ,106) AS   INV_DT        
	 ,b.BILL_NO    
	 ,(CASE WHEN ISNULL(b.RECEIPT_DT,'')='' AND b.INV_MODE=2 THEN '' ELSE   CONVERT(VARCHAR, B.RECEIPT_DT  ,106) END)AS RECEIPT_DT    
	 ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.TOTAL_AMOUNT END)) AS [TOTAL_AMOUNT]    
	 ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=0 AND ISNULL(b.FRIGHT_PAY_MODE,1)=1 THEN B.FREIGHT ELSE 0 END)) AS FREIGHT    
	 ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=0 AND ISNULL(b.FRIGHT_PAY_MODE,1)=2 THEN B.FREIGHT ELSE 0 END)) AS FREIGHT_TO_PAY    
	 ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.OTHER_CHARGES END)) AS OTHER_CHARGES    
	 ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.EXCISE_DUTY_AMOUNT END)) AS EXCISE_DUTY_AMOUNT    
	 ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.ROUND_OFF END)) AS ROUND_OFF    
	 ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.DISCOUNT_PERCENTAGE END)) AS DISCOUNT_PERCENTAGE    
	 ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.DISCOUNT_AMOUNT END)) AS DISCOUNT_AMOUNT    
	 ,CONVERT(NUMERIC(14,2),SUM(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.TAX_AMOUNT END)) AS TAX_AMOUNT    
	 ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.TOTAL_QUANTITY END)) AS QUANTITY    
	  ,(CASE WHEN B.CANCELLED=1 THEN '' ELSE B.TOTAL_QUANTITY_STR END) AS QUANTITY_STR    
	 ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.SUBTOTAL END)) AS [SUBTOTAL]    
	 ,(CASE WHEN B.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END) AS CANCELLED  
	 ,u.username as USERNAME ---ADDED BY CHANDAN 02-07-2019
	 ,u1.username as EDT_USERNAME  
	 ,(CASE WHEN B.XN_ITEM_TYPE  = 4 THEN 'SERVICES' WHEN B.XN_ITEM_TYPE =3 THEN 'ASSETS' WHEN B.XN_ITEM_TYPE =2 THEN 'CONSUMABLE'  ELSE  'INVENTORY' END) AS XN_ITEM_TYPE_NAME    
	 ,ISNULL(RMM.TOTAL_AMOUNT ,0) AS PRTAMOUNT    
	 ,b.pur_terms_name terms   
	  ,ISNULL(F.AC_NAME,'') AS BROKER_AC_NAME  
	 ,b.PUR_TERMS_REMARKS AS TERMS_REMARKS    
	 ,ISNULL(ft1.ledger_net_amount,0) AS LEDGER_NETAMOUNT    
	 ,B.TOTAL_AMOUNT-ISNULL(ft1.ledger_net_amount,0) AS DIFF_LEDGER_NETAMOUNT    
	 ,ISNULL((SLOC.DEPT_ID +'-'+ SLOC.DEPT_NAME),'') AS SOURCE_LOCATION    
	 ,ISNULL((DLOC.DEPT_ID +'-'+ DLOC.DEPT_NAME),'') AS TARGET_LOCATION  ,    
	 B.PARTY_INV_AMOUNT,    
	 (CASE WHEN ISNULL(B.EDIT_COUNT,0)>0 THEN 'EDITED (' + RTRIM(LTRIM(STR(B.EDIT_COUNT)))+ ')' ELSE '' END ) AS EDIT_COUNT    
	 ,B.REMARKS    
	   ,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.TOTAL_BOX_NO END)) AS TOTAL_BOX_NO    
		,CONVERT(NUMERIC(14,2),(CASE WHEN B.CANCELLED=1 THEN 0 ELSE B.TOTAL_CASHDISCOUNTAMOUNT END)) 
		AS TOTAL_CASHDISCOUNTAMOUNT    
		,Z.MRR_NO ref_converted_mrr_no  ,ELOC.DEPT_NAME AS FOR_LOCATION,B.Total_Gst_Amount,    
		(CASE   WHEN ISNULL(PVL.MEMO_ID,'')<> '' THEN 'POSTED' ELSE 'PENDING'  END)  AS AC_POSTED ,
		B.rcm_memo_no
		,B.BILL_DT,b.Total_Gst_Cess_Amount,b.tcs_amount,ISNULL(EMP.EMP_NAME,'') AS EMP_NAME
		,ISNULL(OEM.AC_NAME,'') AS OEM_AC_NAME,LMV.Ac_gst_no AS PARTY_GST_NO,B.checked_by,B.received_by
		,ISNULL(B.freight_igst_amount,0)+ISNULL(B.freight_cgst_amount,0)+ISNULL(B.freight_sgst_amount,0) AS FREIGHT_GST,
		ISNULL(B.other_charges_igst_amount,0)+ISNULL(B.other_charges_cgst_amount,0)+ISNULL(B.other_charges_sgst_amount,0) AS OTHER_CHARGES_GST,
		b.chi_entry_ref_no,CASE WHEN B.send_to_loc=1 THEN 'Yes' WHEN B.pur_for_dept_id<>B.MRR_CREATION_DEPT_ID THEN 'No' ELSE '' END AS INVOICE_SENT
		,B.FC_RATE,DIFF_NETAMOUNT  =B.Total_amount-ISNULL(B.party_inv_amount,0)
	FROM  PIM01106 B (NOLOCK)   
	LEFT JOIN pim01106 z (NOLOCK) ON z.mrr_id=B.ref_converted_mrntobill_mrrid    

	JOIN #FITLER_PIM FT1 (NOLOCK) ON B.MRR_ID=FT1.MRR_ID      
	JOIN LM01106 D(NOLOCK) ON B.AC_CODE= D.AC_CODE     
	JOIN LM01106 F(NOLOCK) ON B.BROKER_AC_CODE= F.AC_CODE     
	JOIN LMV01106 LMV(NOLOCK) ON LMV.AC_CODE= D.AC_CODE  
	left JOIN USERS U (NOLOCK) ON B.user_code=U.user_code       --ADDED BY CHANDAN ON 29-06-2019
     
    LEFT JOIN inm01106 (NOLOCK) ON inm01106.inv_id=b.inv_id
	LEFT JOIN LOCATION(NOLOCK)SLOC ON inm01106.location_Code=SLOC.DEPT_ID      
	LEFT JOIN LOCATION(NOLOCK)DLOC ON b.location_Code=DLOC.DEPT_ID   
	LEFT JOIN LOCATION(NOLOCK)ELOC ON B.Pur_For_Dept_id=ELOC.DEPT_ID  
	left join employee emp (nolock) on emp.emp_code =b.emp_code
     
	LEFT JOIN #tmpPvl PVL ON PVL.MEMO_ID=B.MRR_ID      
	LEFT OUTER JOIN RMM01106 RMM(NOLOCK) ON RMM.REFMEMOID=B.MRR_ID AND RMM.PRTSOURCE='PUR' AND RMM.CANCELLED=0
	LEFT OUTER JOIN users u1 ON B.EDT_USER_CODE=U1.user_code  
	LEFT OUTER JOIN LM01106 OEM (NOLOCK) ON B.SHIPPING_FROM_AC_CODE=OEM.AC_CODE 
	WHERE (  
		 (@NAC_STATUS=0)      
		  OR (@NAC_STATUS=1 AND  ISNULL(PVL.MEMO_ID,'')='')       
		  OR (@NAC_STATUS=2 AND (ISNULL(PVL.MEMO_ID,'')<>''))    
		 )       

	GROUP BY B.MRR_ID,b.MRR_NO,b.MRR_DT ,D.AC_CODE,D.AC_NAME,LMV.ALIAS,b.INV_NO,b.INV_DT,b.BILL_NO,F.AC_NAME,      
	 b.RECEIPT_DT,B.TOTAL_AMOUNT,b.FRIGHT_PAY_MODE,      
	 B.FREIGHT,B.OTHER_CHARGES,B.EXCISE_DUTY_AMOUNT,B.ROUND_OFF,B.DISCOUNT_PERCENTAGE,      
	 B.DISCOUNT_AMOUNT,B.SUBTOTAL,B.CANCELLED,CITY ,b.pur_terms_name,ISNULL(RMM.TOTAL_AMOUNT ,0)      
	 ,DLOC.DEPT_ID,DLOC.DEPT_NAME,SLOC.DEPT_ID,SLOC.DEPT_NAME ,B.TOTAL_QUANTITY,b.INV_MODE , B.PARTY_INV_AMOUNT,B.EDIT_COUNT    
	 ,B.REMARKS,B.TOTAL_BOX_NO,B.TOTAL_QUANTITY_STR,B.TOTAL_CASHDISCOUNTAMOUNT ,B.XN_ITEM_TYPE ,
	 Z.MRR_NO,U.username,U1.username   ,ELOC.DEPT_NAME ,B.Total_Gst_Amount,
	   (CASE   WHEN ISNULL(PVL.MEMO_ID,'')<> '' THEN 'POSTED' ELSE 'PENDING'  END), B.rcm_memo_no,ft1.ledger_net_amount
		 ,B.BILL_DT,b.Total_Gst_Cess_Amount,b.Tcs_Amount,ISNULL(EMP.EMP_NAME,''),ISNULL(OEM.AC_NAME,''),b.PUR_TERMS_REMARKS
		 ,LMV.Ac_gst_no,B.checked_by,B.received_by
		,ISNULL(B.freight_igst_amount,0)+ISNULL(B.freight_cgst_amount,0)+ISNULL(B.freight_sgst_amount,0),
		ISNULL(B.other_charges_igst_amount,0)+ISNULL(B.other_charges_cgst_amount,0)+ISNULL(B.other_charges_sgst_amount,0) ,
		b.chi_entry_ref_no, B.send_to_loc, B.pur_for_dept_id,B.MRR_CREATION_DEPT_ID,B.FC_RATE

	  DROP TABLE #FITLER_PIM      
	  DROP TABLE #tmpPvl
END 