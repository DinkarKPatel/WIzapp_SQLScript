create VIEW VW_CUSTOMERWALKIN  
AS  
SELECT M.CM_DT  
,L.DEPT_ID LOC_DEPT_ID,L.DEPT_NAME LOC_DEPT_NAME,L.PHONE LOC_PHONE,L.ADDRESS1 LOC_ADDRESS1,L.ADDRESS2 LOC_ADDRESS2  
,ISNULL(A.AREA_NAME,'') LOC_AREA,ISNULL(A.PINCODE,'') LOC_PINCODE,REPLACE(ISNULL(C.CITY,''),'(WC)','')CITY  
,REPLACE(ISNULL(S.[STATE],''),'(WC)','')LOC_STATE,ISNULL(R.REGION_NAME,'')LOC_REGION  
,ISNULL(CN.COUNTRY_NAME,'')LOC_COUNTRY  
,sum(ISNULL(W.cust_walkin,0)) WALKIN  
,EMP.EMP_NAME,EMP.EMP_ALIAS 
,CONV_RATIO=CAST( sum(ISNULL(W.cust_walkin,0))/CASE COUNT(DISTINCT D.CM_ID) WHEN 0 THEN 1 ELSE COUNT(DISTINCT D.CM_ID) END AS NUMERIC(10,2))
,COUNT(DISTINCT D.CM_ID)BILL_COUNT  
,SUM(D.QUANTITY)NET_QTY  
,SUM(D.QUANTITY*D.MRP)MRP_VALUE  
,SUM(D.CMM_DISCOUNT_AMOUNT+D.DISCOUNT_AMOUNT)DISCOUNT_AMOUNT  
,SUM(D.REALIZE_SALE)REALIZE_SALE  
,SUM(D.NET)NET_AMOUNT  
FROM CMM01106 M (NOLOCK)   
JOIN CMD01106 D (NOLOCK) ON M.CM_ID=D.CM_ID  
LEFT JOIN saleperson_wise_custwalkin W (NOLOCK) ON D.emp_code=W.emp_code AND CONVERT(DATE,W.LOG_DATE)=CONVERT(DATE,M.CM_DT)   
LEFT JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=D.DEPT_ID  
LEFT JOIN AREA A (NOLOCK) ON A.AREA_CODE=L.AREA_CODE  
LEFT JOIN CITY C (NOLOCK) ON C.CITY_CODE=A.CITY_CODE  
LEFT JOIN [STATE] S (NOLOCK) ON S.STATE_CODE=C.STATE_CODE  
LEFT JOIN REGIONM R (NOLOCK) ON R.REGION_CODE=S.REGION_CODE  
LEFT JOIN COUNTRY CN (NOLOCK) ON CN.COUNTRY_CODE=R.COUNTRY_CODE  
LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON EMP.EMP_CODE = D.EMP_CODE 
WHERE M.CANCELLED=0  
GROUP BY M.CM_DT  
,L.DEPT_ID ,L.DEPT_NAME ,L.PHONE ,L.ADDRESS1 ,L.ADDRESS2   
,ISNULL(A.AREA_NAME,'') ,ISNULL(A.PINCODE,'') ,ISNULL(C.CITY,''),ISNULL(S.STATE,''),ISNULL(R.REGION_NAME,'')  
,ISNULL(CN.COUNTRY_NAME,'')
,EMP.EMP_NAME,EMP.EMP_ALIAS 
