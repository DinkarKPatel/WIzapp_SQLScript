CREATE PROCEDURE SP_PRD_STOCK_REC_REPORT  
(  
 @DFM_DT DATETIME,  
 @DTO_DT DATETIME,  
 @CDEPARTMENT VARCHAR(10)='',  
 @CSECTION VARCHAR(10)='',  
 @CSUBSECTION VARCHAR(10)='',
 @NREC_QTY INT=0  
   
)  
AS  
BEGIN  

IF OBJECT_ID('TEMPDB..#TMPREC','U') IS NOT NULL
   DROP TABLE #TMPREC
   
SELECT A.DEPARTMENT, SECTIONM.SECTION_NAME, SECTIOND.SUB_SECTION_NAME,A.PRODUCT_CODE,PARA1.PARA1_NAME,PARA3.PARA3_NAME,PARA4.PARA4_NAME   
  ,CAST(SUM( (CASE WHEN A.XN_TYPE='OPS' OR (A.XN_TYPE IN ('OPS','APR', 'PUR','PRD_SCF','PFI', 'UNC', 'WSR','JWR','AMR', 'STK-IN', 'ISSUE-MAT-IN','JWR-FIN') AND XN_DT < @DFM_DT) THEN 1 WHEN A.XN_TYPE IN ('PRT','CIP','CNC','WSL','AMI','STK-OUT','APP','CODE-CON','JWI','JWR-CON','
   ISSUE-MAT-OUT') AND XN_DT < @DFM_DT  THEN -1 ELSE 0 END) * (XN_QTY)) AS NUMERIC(14,2)) AS OPS_QTY 
  ,CAST(SUM( (CASE WHEN (A.XN_TYPE IN ('OPS','APR', 'PUR','PRD_SCF','PFI', 'UNC', 'WSR','JWR','AMR', 'STK-IN', 'ISSUE-MAT-IN','JWR-FIN') AND XN_DT BETWEEN  @DFM_DT AND @DTO_DT )  THEN 1 ELSE 0 END) * (XN_QTY)) AS NUMERIC(14,2)) AS REC_QTY  
  ,CAST(SUM( (CASE WHEN A.XN_TYPE='OPS' OR (A.XN_TYPE IN ('OPS','APR', 'PUR','PRD_SCF','PFI', 'UNC', 'WSR','JWR','AMR', 'STK-IN', 'ISSUE-MAT-IN','JWR-FIN') AND XN_DT <= @DTO_DT) THEN 1 WHEN A.XN_TYPE IN ('PRT','CIP','CNC','WSL','AMI','STK-OUT','APP','CODE-CON','JWI','JWR-CON',
'ISSUE-MAT-OUT') AND XN_DT<=@DTO_DT  THEN -1 ELSE 0 END) * (XN_QTY)) AS NUMERIC(14,2)) AS CBSPRD  
 INTO #TMPREC
 FROM VW_STOCKSTATUS_REPORT A  (NOLOCK)   
 LEFT OUTER JOIN ARTICLE (NOLOCK) ON A.ARTICLE_CODE = ARTICLE.ARTICLE_CODE   
 LEFT OUTER JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE  
 LEFT OUTER JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE 
  LEFT OUTER JOIN PARA1 (NOLOCK) ON PARA1.PARA1_CODE=A.PARA1_CODE  
 LEFT OUTER JOIN PARA3 (NOLOCK) ON PARA3.PARA3_CODE=A.PARA3_CODE  
 LEFT OUTER JOIN PARA4 (NOLOCK) ON PARA4.PARA4_CODE=A.PARA4_CODE
 WHERE (@CDEPARTMENT='' OR A.DEPARTMENT_ID=@CDEPARTMENT)  
 AND (@CSECTION='' OR SECTIONM.SECTION_CODE=@CSECTION)  
 AND (@CSUBSECTION='' OR SECTIOND.SUB_SECTION_CODE=@CSUBSECTION)  
 GROUP BY A.DEPARTMENT, SECTIONM.SECTION_NAME, SECTIOND.SUB_SECTION_NAME,A.PRODUCT_CODE,PARA1.PARA1_NAME,PARA3.PARA3_NAME,PARA4.PARA4_NAME  
 
 
 SELECT * FROM #TMPREC
 WHERE ( @NREC_QTY  =0 OR REC_QTY>0)
 ORDER BY DEPARTMENT

END
