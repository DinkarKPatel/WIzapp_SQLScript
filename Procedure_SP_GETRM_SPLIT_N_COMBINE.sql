create PROCEDURE SP_GETRM_SPLIT_N_COMBINE
(
  @CSP_ID varchar(50)='39804A033AA-255E-4669-B5E1-7C104A4A3643',
  @CDEPT_ID varchar(4)=''
)
as
begin

--(dinkar) Replace  left(memoid,2) to Location_code 
	 
	 SELECT  K.SECTION_NAME, J.SUB_SECTION_NAME,B.ARTICLE_NO,T.AVG_Qty As AVG_QUANTITY,ISNULL(T.ADD_AVG_QTY,0) AS ADD_AVG_QTY,
	         A.QUANTITY AS FG_QTY,ISNULL(SKU.PRODUCT_CODE ,'') AS PRODUCT_CODE,

			 CONVERT(NUMERIC(14,2), (CASE WHEN ISNULL(UC.CONVERSION_VALUE,0) =0 THEN A.QUANTITY* (isnull(T.AVG_Qty,0)+ISNULL(T.ADD_AVG_QTY,0))
	         ELSE (A.QUANTITY*(isnull(T.AVG_Qty,0)+ISNULL(T.ADD_AVG_QTY,0)))/ISNULL(UC.CONVERSION_VALUE,0) END)  ) AS QUANTITY ,

			  CONVERT(NUMERIC(14,2), (CASE WHEN ISNULL(UC.CONVERSION_VALUE,0) =0 THEN A.QUANTITY
	         ELSE (A.QUANTITY*(isnull(T.AVG_Qty,0)+ISNULL(T.ADD_AVG_QTY,0)))/ISNULL(UC.CONVERSION_VALUE,0) END) *ISNULL(T.Rate,0) ) AS AMOUNT ,
			 
	         I.*, C.PARA1_NAME,
			 D.PARA2_NAME,CAST('' AS VARCHAR(100)) PARA3_NAME,CAST('' AS VARCHAR(100)) PARA4_NAME,CAST('' AS VARCHAR(100)) PARA5_NAME,CAST('' AS VARCHAR(100)) PARA6_NAME,         
			 B.ARTICLE_NAME, B.CODING_SCHEME, T.*, T.rate as purchase_price,ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],  
			 ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED], '' AS [SKU_DT_CREATED],  
			 B.GEN_EAN_CODES,  '' AS OTHER_XN_PRODUCT_CODE,D.PARA2_ORDER, B.SIZE_RATE_DIFF ,B.SIZE_CENTER_POINT,     
			 CAST(0 AS NUMERIC(14,3)) AS [STK_QUANTITY],B.STOCK_NA,    
			 CAST('' AS VARCHAR(100)) FORM_NAME,B.FIX_MRP,  '' AS PRODUCT_NAME,B.FIX_PRICE_ARTICLE,CONVERT(NUMERIC(2),0) AS  MODE,    
			 B.ALIAS AS ARTICLE_ALIAS,ISNULL(BIN.BIN_NAME ,'') AS BIN_NAME,ISNULL(BIN.BIN_ID,'000')  AS BIN_ID   ,
			 CAST(ISNULL(PMT.QUANTITY_IN_STOCK,0) AS NUMERIC(14,3)) AS [QUANTITY_IN_STOCK]  ,A.ROW_ID AS REF_ROW_ID
	 FROM SNC_SNC_DET_UPLOAD A
	 JOIN ART_BOM T ON A.ARTICLE_CODE =T.ARTICLE_CODE 
	 JOIN ARTICLE B1 (NOLOCK) ON T.ARTICLE_CODE = B1.ARTICLE_CODE         
	 JOIN ARTICLE B (NOLOCK) ON T.BOM_ARTICLE_CODE = B.ARTICLE_CODE         
	 JOIN PARA1 C (NOLOCK) ON T.BOM_PARA1_CODE = C.PARA1_CODE        
	 JOIN PARA2 D (NOLOCK) ON T.BOM_PARA2_CODE = D.PARA2_CODE        
	 JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE        
	 JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE        
	 JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE 
	 LEFT JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.ARTICLE_NO
	 LEFT JOIN PMT01106 PMT (NOLOCK) ON SKU.PRODUCT_CODE =PMT.PRODUCT_CODE AND A.BIN_ID= PMT.BIN_ID and pmt.dept_id=@CDEPT_ID
	 LEFT JOIN BIN  (NOLOCK) ON BIN.BIN_ID =PMT.BIN_ID 
	 LEFT JOIN PARA3 E (NOLOCK) ON E.PARA3_CODE  = SKU.PARA3_CODE   
	 LEFT OUTER JOIN UOM_CONVERSION UC (NOLOCK) ON UC.UOM_CODE=I.UOM_CODE
    LEFT OUTER JOIN BOM_UOM BU (NOLOCK) ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE    
	 WHERE SP_ID=@CSP_ID
	 AND  A.ARTICLE_CODE <>''

end
	 

	 
	