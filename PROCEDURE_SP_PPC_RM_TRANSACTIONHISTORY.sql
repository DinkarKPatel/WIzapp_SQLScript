CREATE PROCEDURE SP_PPC_RM_TRANSACTIONHISTORY  
( 
 @CPRODUCTCODE VARCHAR(20)='',
 @FROMDATE DATETIME = '',    
 @TODATE DATETIME = '' 
)
----WITH ENCRYPTION
  
AS  
BEGIN  

 
  DECLARE @DTSQL NVARCHAR(MAX)
  DECLARE @OUTPUTC TABLE ( DEPT_ID VARCHAR(2), XN_TYPE VARCHAR(30), XN_DT DATETIME,         
        XN_ID VARCHAR(40), XN_NO VARCHAR(40), PRODUCT_CODE VARCHAR(50),ARTICLE_NO VARCHAR(500),       
        XN_PARTY_NAME VARCHAR(500), XN_QTY NUMERIC(10,3),JOB_NAME VARCHAR(100))        

 --1.PURCHASE
 SET @DTSQL=N' SELECT LEFT(A.MRR_ID,2) AS DEPT_ID,
      ''PPC_PUR'' AS XN_TYPE,A.RECEIPT_DT AS XN_DT,A.MRR_ID AS XN_ID,
      A.MRR_NO AS XN_NO,C.PRODUCT_CODE,ART.ARTICLE_NO, LM.AC_NAME,C.QUANTITY AS QUANTITY,
      '''' AS JOB_NAME
      FROM PPC_PIM01106 A
      JOIN PPC_PID01106  B ON A.MRR_ID =B.MRR_ID 
      JOIN PPC_PID01106_BARCODE C ON B.ROW_ID=C.PID_ROW_ID
      JOIN ARTICLE ART ON ART.ARTICLE_CODE=B.ARTICLE_CODE
      JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
      WHERE A.CANCELLED=0  AND '''+@CPRODUCTCODE +'''=' + 'C.PRODUCT_CODE'
 PRINT @DTSQL
 INSERT @OUTPUTC
 EXEC SP_EXECUTESQL @DTSQL
 
 --2.DEBIT NOTE
 SET @DTSQL=N' SELECT LEFT(A.RM_ID,2) AS DEPT_ID,
      ''PPC_PRT'' AS XN_TYPE,A.RM_DT AS XN_DT,A.RM_ID AS XN_ID,
      A.RM_NO AS XN_NO,C.PRODUCT_CODE,ART.ARTICLE_NO, LM.AC_NAME,B.QUANTITY,'''' AS JOB_NAME
      FROM PPC_RMM01106 A
      JOIN PPC_RMD01106  B ON A.RM_ID =B.RM_ID 
      JOIN PPC_SKU C ON B.PRODUCT_UID=C.PRODUCT_UID
      JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE
      JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
      WHERE A.CANCELLED=0  AND '''+@CPRODUCTCODE +'''=' + 'C.PRODUCT_CODE'
 PRINT @DTSQL
 INSERT @OUTPUTC
 EXEC SP_EXECUTESQL @DTSQL
 
 --3.AGENCY MATERIAL ISSUE
 
 SET @DTSQL=N' SELECT LEFT(A.MEMO_ID,2) AS DEPT_ID,
      ''PPC_AMI'' AS XN_TYPE,A.MEMO_DT AS XN_DT,A.MEMO_ID AS XN_ID,
      A.MEMO_NO AS XN_NO,C.PRODUCT_CODE,ART.ARTICLE_NO, LM.AC_NAME,B.QUANTITY,JOBS.JOB_NAME
      FROM PPC_AGENCY_ISSUE_MATERIAL_MST A
      JOIN PPC_AGENCY_ISSUE_MATERIAL_DET   B ON A.MEMO_ID =B.MEMO_ID 
      JOIN PPC_SKU C ON B.PRODUCT_UID=C.PRODUCT_UID
      JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE
      JOIN LM01106 LM ON LM.AC_CODE=C.AC_CODE
      JOIN JOBS ON B.JOB_CODE=JOBS.JOB_CODE
      WHERE A.CANCELLED=0  AND '''+@CPRODUCTCODE +'''=' + 'C.PRODUCT_CODE'
 PRINT @DTSQL
 INSERT @OUTPUTC
 EXEC SP_EXECUTESQL @DTSQL
 

    
    
				INSERT @OUTPUTC    
				SELECT  A.DEPT_ID,'PPC_OPS' AS XN_TYPE,     
				  @FROMDATE AS XN_DT,'PPC_OPS' AS XN_ID,           
				  'PPC_OPS' AS XN_NO,A.PRODUCT_CODE,ARTICLE.ARTICLE_NO,       
				  '' AS XN_PARTY_NAME,    
				  SUM( (CASE WHEN A.XN_TYPE='PPC_OPS' OR (A.XN_TYPE IN ('PPC_PUR')     
				  AND (XN_DT  < @FROMDATE) AND ARTICLE.STOCK_NA=0 ) THEN 1     
				  WHEN A.XN_TYPE IN ('PPC_AMI','PPC_PRT')     
				  AND (CONVERT(VARCHAR(10),XN_DT,126) < @FROMDATE) AND ARTICLE.STOCK_NA=0 THEN -1 ELSE 0 END) * (XN_QTY)) AS XN_QTY,    
				  '' AS JOB_NAME           
				FROM @OUTPUTC A 
				JOIN PPC_FG_SKU SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE     
				JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE     
				JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE   
				WHERE A.PRODUCT_CODE=@CPRODUCTCODE  AND XN_DT<@FROMDATE  
				GROUP BY A.DEPT_ID,A.PRODUCT_CODE,ARTICLE.ARTICLE_NO
				HAVING SUM( (CASE WHEN A.XN_TYPE='PPC_OPS' OR (A.XN_TYPE IN ('PPC_PUR')     
				AND (CONVERT(VARCHAR(10),XN_DT,126)  < @FROMDATE) AND ARTICLE.STOCK_NA=0 ) THEN 1     
				WHEN A.XN_TYPE IN ('PPC_AMI','PPC_PRT')     
				AND (CONVERT(VARCHAR(10),XN_DT,126) < @FROMDATE) AND ARTICLE.STOCK_NA=0 THEN -1 ELSE 0 END) * (XN_QTY)) >0 


              SELECT  A.DEPT_ID,LOC.DEPT_NAME, A.PRODUCT_CODE,         
			  A.XN_PARTY_NAME ,
			  ISNULL(CAST(SUM(CASE WHEN  XN_TYPE IN ('PPC_OPS','PPC_PUR')     
			  THEN XN_QTY ELSE NULL END) AS NUMERIC(18,3)),0) AS XN_IN_QTY, 
			  ISNULL(CAST(SUM(CASE WHEN  XN_TYPE IN('PPC_AMI','PPC_PRT')
			  THEN XN_QTY ELSE NULL END) AS NUMERIC(18,3)),0) AS XN_OUT_QTY,   
			  SUM(A.XN_QTY) AS XN_QTY,
			  A.XN_TYPE, A.XN_NO, A.XN_DT,
			  ART .ARTICLE_NO,SD.SUB_SECTION_NAME ,SM.SECTION_NAME ,
			  P1.PARA1_NAME,P2.PARA2_NAME,
			  '' AS ORDER_NO       
			
			 FROM @OUTPUTC A    
			 JOIN LOCATION LOC ON LOC.DEPT_ID =A.DEPT_ID 
			 JOIN PPC_SKU SKU ON A.PRODUCT_CODE=A.PRODUCT_CODE 
			 JOIN ARTICLE ART ON ART.article_code =SKU .ARTICLE_CODE 
			 JOIN Sectiond SD ON SD.sub_section_code =ART.sub_section_code 
			 JOIN sectionM SM ON SM.section_code =SD.section_code    
			 join para1 p1 on p1.para1_code =sku.PARA1_CODE 
			 join para2 p2 on p2.para2_code =sku.PARA2_CODE 
			 WHERE (CONVERT(VARCHAR(10),XN_DT,126)  BETWEEN @FROMDATE AND @TODATE )   
			 GROUP BY  A.PRODUCT_CODE,    LOC.DEPT_NAME, A.XN_PARTY_NAME ,A.XN_TYPE,A.XN_NO,A.XN_DT,        
			 A.DEPT_ID,A.XN_PARTY_NAME  ,ART .ARTICLE_NO,SD.SUB_SECTION_NAME ,SM.SECTION_NAME ,
			  P1.PARA1_NAME,P2.PARA2_NAME
			  
             
 
END
