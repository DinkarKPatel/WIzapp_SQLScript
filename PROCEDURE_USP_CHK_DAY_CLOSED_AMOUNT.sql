create PROCEDURE DBO.USP_CHK_DAY_CLOSED_AMOUNT
(
 @NSPID INT,
 @CDATE as datetime='',
 @Cdept_id varchar(2)=''
)
AS
BEGIN
  DECLARE @ERRMSG VARCHAR(MAX)
         ,@CROWCOUNT INT
         ,@FILTER VARCHAR(500)
         ,@CDBSOURCE VARCHAR(200)
         ,@UPLOADMASTERTABLE VARCHAR(200)
         ,@CMASTERTABLENAME VARCHAR(200)
         ,@CKEYFIELD1 VARCHAR(100)
      --   @CDATE DATETIME 
 
  SET @ERRMSG=''
  SET @CDBSOURCE= ''
  SET @UPLOADMASTERTABLE='DAYCLOSE_CC_BATCH_COLLECTION_UPLOAD'
  SET @CMASTERTABLENAME='CC_BATCH_COLLECTION'
  SET @CKEYFIELD1='BATCH_DT'
   IF ISNULL(@NSPID,0) = 0
    BEGIN
     SET @ERRMSG='PLEASE PROVIDE SPID'
     GOTO PROC_END;
    END
   
  
declare @nCHANGE_DATE_CARD_COLLECTION varchar(10) 
select top 1 @nCHANGE_DATE_CARD_COLLECTION=VALUE  from USER_ROLE_DET where FORM_OPTION ='CHANGE_DATE_CARD_COLLECTION' and VALUE =1

IF ISNULL(@NCHANGE_DATE_CARD_COLLECTION,'')<>'1'
BEGIN
    SELECT @CDATE = dbo.fn_getlastrundate()
    SET @CDATE= DATEADD (DAY,1,@CDATE)
END  
else
begin
   update DAYCLOSE_CC_BATCH_COLLECTION_UPLOAD set batch_dt =@CDATE where SP_ID =@NSPID

end

if ISNULL(@CDATE,'')=''
begin
     SET @ERRMSG='PLease select  date ' 
	  GOTO PROC_END;
end
 --  set @CDATE='2019-10-09'

 if isnull(@Cdept_id,'')=''
     select @Cdept_id=DEPT_ID from NEW_APP_LOGIN_INFO where spid=@NSPID

	--DECLARE TABLE TO CONTAINS PAYMODE DETAILS
	DECLARE @TBL_PAYMODEDETAILS AS TABLE(PAYMODE_CODE VARCHAR(100),PAYMODE_NAME VARCHAR(200)
									 ,PAYMODE_GRP_CODE VARCHAR(100),AMOUNT NUMERIC(10,2))
										 
	DECLARE  @OUTPUT_TABLE_FINAL AS TABLE (PAYMODE_NAME  VARCHAR(200),
									ERRMSG  VARCHAR(1000)) 
	DECLARE @OUTPUT_TABLE AS TABLE(PAYMODE_CODE VARCHAR(100))

 BEGIN TRY
 BEGIN TRANSACTION 

   INSERT INTO @TBL_PAYMODEDETAILS(PAYMODE_CODE,PAYMODE_NAME,PAYMODE_GRP_CODE,AMOUNT)
	SELECT A.PAYMODE_CODE,PAYMODE_NAME,PAYMODE_GRP_CODE,ISNULL(B.AMOUNT,0) AS AMOUNT
		 FROM DBO.PAYMODE_MST A WITH(NOLOCK)
		LEFT JOIN 
		(
		SELECT A.PAYMODE_CODE
		  	, ISNULL( SUM(AMOUNT),0) AS AMOUNT FROM DBO.PAYMODE_XN_DET A WITH(NOLOCK)
		JOIN CMM01106 B WITH(NOLOCK) ON A.MEMO_ID=B.CM_ID
		WHERE b.cancelled=0 and  B.CM_DT=CAST(@CDATE AS DATE) AND PAYMODE_CODE IN (SELECT PAYMODE_CODE FROM DBO.PAYMODE_MST WITH(NOLOCK)
	     WHERE ((PAYMODE_GRP_CODE ='0000001' AND PAYMODE_CODE='0000000')
		  OR PAYMODE_GRP_CODE ='0000002'))
		   and left(b.cm_id,2)=@Cdept_id
		GROUP BY A.PAYMODE_CODE
		)B ON B.PAYMODE_CODE=  A.PAYMODE_CODE
 
	     WHERE ((PAYMODE_GRP_CODE ='0000001' AND A.PAYMODE_CODE='0000000')
		  OR PAYMODE_GRP_CODE ='0000002')
		  
	--DECLARE TABLE FOR OUTPUT
	
	
	 
	 DECLARE @CMATCH_NET_AMOUNT VARCHAR(10)
	 SELECT TOP 1 @CMATCH_NET_AMOUNT=value  FROM config WHERE config_option ='CC_BATCH_COLLECTION_MATCH_NET_AMOUNT'
	 
    IF ISNULL(@CMATCH_NET_AMOUNT,'')='1'
    BEGIN
        
        DECLARE @NBATCH_NET_AMOUNT NUMERIC(10,2),@NPAYMODE_NET_AMOUNT NUMERIC(10,2)
        
        SELECT @NBATCH_NET_AMOUNT=SUM(AMOUNT) FROM  DAYCLOSE_CC_BATCH_COLLECTION_UPLOAD T WITH(NOLOCK)
        WHERE T.SP_ID=@NSPID
	    SELECT @NPAYMODE_NET_AMOUNT=SUM(AMOUNT) FROM @TBL_PAYMODEDETAILS
	    
	    IF ISNULL(@NBATCH_NET_AMOUNT,0)>@NPAYMODE_NET_AMOUNT
	    BEGIN
	           
	         SET @ERRMSG='NET NOT MATCH BATCH COLLECTION AMOUNT ' +rtrim(LTRIM(STR(@NBATCH_NET_AMOUNT)))+ ' TOTAL AMOUNT '+rtrim(ltrim(STR(@NPAYMODE_NET_AMOUNT)))
	         INSERT INTO @OUTPUT_TABLE_FINAL(PAYMODE_NAME,ERRMSG)
	         select 'all' PAYMODE_NAME,@ERRMSG
	         GOTO PROC_END;
	    END
    
    END
    
	
	INSERT INTO @OUTPUT_TABLE(PAYMODE_CODE)
	SELECT P.PAYMODE_CODE FROM  DAYCLOSE_CC_BATCH_COLLECTION_UPLOAD T WITH(NOLOCK)
	JOIN @TBL_PAYMODEDETAILS P ON T.PAYMODE_CODE=P.PAYMODE_CODE 
	WHERE T.SP_ID=@NSPID AND T.AMOUNT <> P.AMOUNT AND ISNULL(T.AMOUNT,0)<> 0
	AND ISNULL(@CMATCH_NET_AMOUNT,'')<>'1'
	SET @CROWCOUNT=@@ROWCOUNT;
	
	 
    IF (@CROWCOUNT > 0)
       BEGIN
		   INSERT INTO @OUTPUT_TABLE_FINAL(PAYMODE_NAME,ERRMSG)
			SELECT P.PAYMODE_NAME,'PAY AMOUNT NOT MATCH' AS [ERRMSG] FROM @TBL_PAYMODEDETAILS P
			JOIN @OUTPUT_TABLE O ON P.PAYMODE_CODE=O.PAYMODE_CODE
		    SET @ERRMSG='PAY AMOUNT NOT MATCH' 
       END
    ELSE
      BEGIN
        
        SET @FILTER='B.SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
        EXEC UPDATEMASTERXN 
				  @CSOURCEDB	= @CDBSOURCE
				, @CSOURCETABLE = @UPLOADMASTERTABLE
				, @CDESTDB		= ''
				, @CDESTTABLE	= @CMASTERTABLENAME
				, @CKEYFIELD1	= @CKEYFIELD1
				, @BALWAYSUPDATE = 1
				, @CFILTERCONDITION=@FILTER
      END 
       

   
      
DELETE FROM  DAYCLOSE_CC_BATCH_COLLECTION_UPLOAD WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID)))
      
 
 END TRY
	 BEGIN CATCH
				 SET @ERRMSG='ERROR IN PROCEDURE USP_CHK_DAY_CLOSED_AMOUNT || ERROR MESSAGE |' + ERROR_MESSAGE();
	 END CATCH
  PROC_END:
    
    IF @@TRANCOUNT > 0 
    BEGIN
          IF ISNULL(@ERRMSG,'') =''
		     COMMIT;
		  ELSE
		   ROLLBACK;
   --END
   --ELSE
   --BEGIN
      
   END   
        SELECT ISNULL(@ERRMSG,'') AS ERRMSG
    
       IF  ISNULL(@ERRMSG,'') <>'' 
          SELECT * FROM @OUTPUT_TABLE_FINAL 
        
      
        

END 
 ------------------------------------------------------ END OF PROCEDURE USP_CHK_DAY_CLOSED_AMOUNT new

