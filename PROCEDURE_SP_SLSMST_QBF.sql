CREATE PROCEDURE SP_SLSMST_QBF    --(LocId 3 digit change by Sanjay:30-10-2024)
@CWHERE  NVARCHAR(50),  
@CTPAY  NVARCHAR(100)='',  
@CTARGETTABLENAME NVARCHAR(100)='',  
@BCASHIER BIT=0  
AS    
BEGIN  
 DECLARE @CCMD NVARCHAR(MAX),@CCMD1 NVARCHAR(MAX),@CCMD2 NVARCHAR(MAX),@CCMD3 NVARCHAR(MAX)  
   
 IF OBJECT_ID('TEMPDB..#CMID','U') IS NOT NULL  
  DROP TABLE #CMID  
    
 IF OBJECT_ID('TEMPDB..#CMDET','U') IS NOT NULL  
  DROP TABLE #CMDET    
    
  CREATE TABLE #CMID(CM_ID VARCHAR(22))  
    
  IF @BCASHIER=1  
  INSERT #CMID(CM_ID)  
  SELECT CM_ID FROM DSD01106(NOLOCK) WHERE DS_ID=@CWHERE  
  ELSE   
  INSERT #CMID(CM_ID)  
  SELECT @CWHERE  
  
   SELECT MST.CM_ID AS CM_ID,MST.CM_NO AS MST_CM_NO,MST.CANCELLED AS MST_CANCELLED,   
   MST.CM_DT AS MST_CM_DT,MST.FIN_YEAR AS MST_FIN_YEAR,MST.ATD_CHARGES AS MST_ATD_CHARGES,MST.ROUND_OFF AS MST_ROUND_OFF,  
   MST.SUBTOTAL+MST.SUBTOTAL_R AS MST_SUBTOTAL,MST.SUBTOTAL AS MST_SUBTOTAL_S, MST.SUBTOTAL_R AS MST_SUBTOTAL_R,MST.DISCOUNT_PERCENTAGE AS MST_DISCOUNT_PERCENTAGE,MST.DISCOUNT_AMOUNT AS MST_DISCOUNT_AMOUNT ,    
   MST.NET_AMOUNT AS MST_NET_AMOUNT ,MST.REMARKS AS MST_REMARKS,MST.MEMO_TYPE AS MST_MEMO_TYPE,     
   MST.CM_NO,MST.CM_DT,MST.SUBTOTAL,MST.NET_AMOUNT,MST.CANCELLED,MST.REMARKS,MST.CM_TIME,  
   MST.ATD_CHARGES,MST.COPIES_PTD,MST.ROUND_OFF,MST.CASH_TENDERED,MST.LAST_UPDATE,MST.CM_MODE,  
   B.QUANTITY AS QUANTITY,B.DISCOUNT_PERCENTAGE ,B.DISCOUNT_AMOUNT ,  
   'T'+(CASE WHEN B.TAX_PERCENTAGE=0 THEN 'F' WHEN ROUND(B.TAX_PERCENTAGE,0)=B.TAX_PERCENTAGE THEN LTRIM(RTRIM(STR(B.TAX_PERCENTAGE)))  
   ELSE LTRIM(RTRIM(STR(B.TAX_PERCENTAGE,6,2))) END) AS TAX_STATUS,B.TAX_PERCENTAGE ,B.TAX_AMOUNT ,  
   B.NET,B.MRP ,B.WEIGHTED_AVG_DISC_PCT,B.WEIGHTED_AVG_DISC_AMT,B.ITEM_DESC,
   LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),LEN(B.PRODUCT_CODE ))) as product_code,B.TAX_METHOD,  
   MST.CUSTOMER_CODE,MST.USER_CODE,B.EMP_CODE,B.EMP_CODE1,B.EMP_CODE2,B.TS,MST.DT_CODE,  
   (CASE WHEN B.TAX_METHOD=2 THEN B.TAX_AMOUNT ELSE 0 END)  AS TAX_EXC_AMT,  
   (CASE WHEN B.TAX_METHOD=1 THEN B.TAX_AMOUNT ELSE 0 END)  AS TAX_INC_AMT,B.SR_NO,B.FORM_ID,  
   INV_TYPE,INV_MODE,REALIZE_SALE,B.BASIC_DISCOUNT_PERCENTAGE,  
    B.CARD_DISCOUNT_PERCENTAGE,  
    B.BASIC_DISCOUNT_AMOUNT,  
    B.CARD_DISCOUNT_AMOUNT  
       ,B.HSN_CODE  
  ,B.GST_PERCENTAGE  
  ,B.CGST_AMOUNT  
  ,B.SGST_AMOUNT  
  ,B.IGST_AMOUNT  
  ,B.XN_VALUE_WITHOUT_GST  
  ,B.XN_VALUE_WITH_GST  
  ,L.LOC_GST_NO 
  , MST.OTHER_CHARGES_GST_PERCENTAGE,MST.OTHER_CHARGES_HSN_CODE,MST.OTHER_CHARGES_IGST_AMOUNT,MST.OTHER_CHARGES_CGST_AMOUNT,MST.OTHER_CHARGES_SGST_AMOUNT 
  ,CAST(ROUND((ISNULL(b.CMM_DISCOUNT_AMOUNT,0)+ISNULL(b.DISCOUNT_AMOUNT,0))/(b.MRP*b.QUANTITY)*100,2) AS NUMERIC(7,3))[TOTAL_DISCOUNT_PERCENTAGE]  
  ,CAST(CAST(ROUND(((ISNULL(b.CMM_DISCOUNT_AMOUNT,0)+ISNULL(b.DISCOUNT_AMOUNT,0))),2) AS NUMERIC(10,2)) AS NUMERIC(10,2))[TOTAL_DISCOUNT_AMOUNT]   
  ,B.Gst_Cess_Amount 
  ,mst.ACH_NO,mst.ACH_DT,mst.IRN_QR_CODE,mst.EINV_IRN_NO
     INTO #CMDET  
   FROM CMM01106 MST (NOLOCK)  
   JOIN CMD01106 B (NOLOCK) ON MST.CM_ID=B.CM_ID  
   JOIN #CMID C (NOLOCK) ON B.CM_ID=C.CM_ID  
   JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=mst.location_Code  
     
 IF ISNULL(@CTARGETTABLENAME,'')<>'' AND  ISNULL(@CTPAY,'')='' RETURN  
      
	
    IF ISNULL(@CTARGETTABLENAME,'')=''  
    BEGIN  
    SET @CCMD= N'SELECT  D.USER_CUSTOMER_CODE AS  MST_USER_CUSTOMER_CODE,    
    MST.CM_ID AS CM_ID,    
    MST.CM_NO AS MST_CM_NO,   
    MST.CANCELLED AS MST_CANCELLED,   
    MST.CM_DT AS MST_CM_DT,    
    MST.FIN_YEAR AS MST_FIN_YEAR,    
    MST.ATD_CHARGES AS MST_ATD_CHARGES,  
    MST.ROUND_OFF AS MST_ROUND_OFF,  
    MST.SUBTOTAL AS MST_SUBTOTAL,    
    MST.DISCOUNT_PERCENTAGE AS MST_DISCOUNT_PERCENTAGE,     
    MST.DISCOUNT_AMOUNT AS MST_DISCOUNT_AMOUNT ,    
    MST.NET_AMOUNT AS MST_NET_AMOUNT ,    
    MST.REMARKS AS MST_REMARKS,   
    MST.MEMO_TYPE AS MST_MEMO_TYPE,    
    E.USERNAME AS MST_USERNAME,  
    B.QUANTITY AS QUANTITY,    
    B.DISCOUNT_PERCENTAGE ,    
    B.DISCOUNT_AMOUNT ,    
    EMP1.EMP_NAME AS MST_EMP_NAME,  
    EMP1.EMP_ALIAS,    
    ''T''+(CASE WHEN B.TAX_PERCENTAGE=0 THEN ''F'' WHEN ROUND(B.TAX_PERCENTAGE,0)=B.TAX_PERCENTAGE THEN LTRIM(RTRIM(STR(B.TAX_PERCENTAGE)))  
          ELSE LTRIM(RTRIM(STR(B.TAX_PERCENTAGE,6,2))) END) AS TAX_STATUS,    
     isnull(B.GST_PERCENTAGE,0)+isnull(b.tax_percentage,0) as tax_percentage ,isnull(b.tax_amount,0)+isnull(b.igst_amount,0)+isnull(b.sgst_amount,0)+isnull(cgst_amount,0)    tax_amount  ,     
    B.NET,  
    B.MRP ,  
   D.CUSTOMER_TITLE+'' ''+D.CUSTOMER_FNAME +'' ''+ D.CUSTOMER_LNAME AS MST_CUST_NAME,  
     D.ADDRESS1 +'' ''+D.ADDRESS2   AS MST_ADDRESS0,  
     X.ADDRESS  AS MST_ADDRESS1,  
     MST.PAY_MODE   
  --******************************************************************   
  ,MST.FC_RATE  
  ,MST.POSTEDINAC  
  ,MST.CM_NO  
  ,MST.CM_DT  
  ,MST.CM_MODE  
  ,MST.SUBTOTAL  
  ,MST.DT_CODE  
  ,MST.NET_AMOUNT  
  ,MST.CUSTOMER_CODE  
  ,MST.CANCELLED  
  ,MST.REMARKS  
  ,MST.USER_CODE  
  ,MST.LAST_UPDATE  
  ,MST.EXEMPTED  
  ,'''' AS COMPUTER_NAME  
  ,MST.SENT_TO_HO  
  ,MST.CM_TIME  
  ,MST.REF_CM_ID  
  ,MST.FIN_YEAR  
  ,MST.ATD_CHARGES  
  ,MST.COPIES_PTD  
  ,MST.ROUND_OFF  
  ,MST.SMS_SENT  
  ,MST.CASH_TENDERED  
  ,MST.MEMO_TYPE  
  ,B.ROW_ID  
  ,B.EMP_CODE  
  ,B.SLSDET_ROW_ID  
  ,B.REALIZE_SALE  
  ,B.RFNET  
  ,B.TAX_TYPE  
  ,B.TAX_METHOD  
  ,B.WEIGHTED_AVG_DISC_PCT  
  ,B.WEIGHTED_AVG_DISC_AMT  
  ,D.DT_ANNIVERSARY  
  ,D.AREA_CODE  
  ,D.LOCATION_ID  
  ,D.ADDRESS9  
  ,D.USER_CUSTOMER_CODE  
  ,D.CUSTOMER_TITLE  
  ,D.CUSTOMER_FNAME  
  ,D.CUSTOMER_LNAME  
  ,D.ADDRESS1  
  ,D.ADDRESS2  
  ,D.PHONE1  
  ,D.PHONE2  
  ,D.MOBILE  
  ,D.EMAIL  
  ,D.OPENING_BALANCE  
  ,D.DT_BIRTH  
  ,D.REF_CUSTOMER_CODE  
  ,D.PREFIX_CODE  
  ,D.FLAT_DISC_CUSTOMER  
  ,D.FLAT_DISC_PERCENTAGE  
  ,D.PRIVILEGE_CUSTOMER  
  ,D.DT_CARD_ISSUE  
  ,D.DT_CARD_EXPIRY  
  ,D.CARD_NO  
  ,D.CARD_NAME  
  ,D.FLAT_DISC_PERCENTAGE_DURING_SALES  
  ,E.USERNAME  
  ,E.MAJOR_USER_CODE  
  ,E.USER_ALIAS  
  ,E.DISCOUNT_PERCENTAGE_LEVEL  
  ,E.VIEW_DATA_AFTER_DFM  
  ,EMP1.EMP_NAME  
  ,EMP1.EMP_HEAD  
  ,DTM.DT_NAME  
  ,DTM.UPDATE_AC  
  ,SKU.IMAGE_NAME  
  ,SKU.CHALLAN_NO  
  ,LM.OPENING_BALANCE_CR_DR  
  ,LM.TDS_CODE  
  ,LM.AC_NAME  
  ,LM.ALIAS  
  ,LM.HEAD_CODE  
  ,LM.CLOSING_BALANCE  
  ,LM.CLOSING_BALANCE_CR_DR  
  ,LM.PRINT_LEDGER  
  ,LM.UPLOADED_TO_ACTIVSTREAM  
  ,FORM.FORM_NAME  
  ,FORM.PURCHASE_AC_CODE  
  ,FORM.SALE_AC_CODE  
  ,FORM.TAX_AC_CODE  
  ,FORM.POST_TAX_SEPARATELY  
  ,FORM.PUR_RETURN_AC_CODE  
  ,FORM.SALE_RETURN_AC_CODE  
  ,FORM.PHYSICAL_FORM  
  ,FORM.SERIES  
  ,FORM.EXCISE_ACCESSIBLE_PERCENTAGE  
  ,FORM.EXCISE_DUTY_PERCENTAGE  
  ,FORM.EXCISE_EDU_CESS_PERCENTAGE  
  ,FORM.EXCISE_HEDU_CESS_PERCENTAGE  
  ,FORM.EXCISE_EDU_CESS_AC_CODE  
  ,FORM.EXCISE_HEDU_CESS_AC_CODE  
  ,FORM.EXCISE_DUTY_AC_CODE  
  ,HD.HEAD_NAME  
  ,HD.MAJOR_HEAD_CODE  
  ,HD.PHYSICAL  
  ,HD.PRINT_HEAD  
  ,HD.CREDITOR_DEBTOR_CODE  
  ,CMP.WORKABLE  
  ,CMP.PIN  
  ,CMP.LOGO_PATH  
  ,CMP.WEB_ADDRESS  
  ,CMP.SSPL_FIRST_HDSR  
  ,CMP.POLICY_NO  
  ,CMP.PAN_NO  
  ,CMP.EMAIL_ID  
  ,CMP.STATE  
  ,CMP.COUNTRY  
  ,CMP.MOBILE AS COMPANY_MOBILE  
  ,CMP.CONTACT_NAME  
  ,CMP.TDS_AC_NO  
  ,CMP.COMPANY_NAME  
  ,CMP.ADDRESS1 AS COMPANY_ADDRESS1  
  ,CMP.ADDRESS2 AS COMPANY_ADDRESS2  
  ,CMP.CITY  
  ,CMP.PHONES_FAX  
  ,CMP.CST_NO  
  ,CMP.CST_DT  
  ,CMP.SST_NO  
  ,CMP.SST_DT  
  ,CMP.TIN_NO  
  ,CMP.TAN_NO  
  ,CMP.GRP_CODE  
  ,CMP.ADDRESS9 AS COMPANY_ADDRESS9  
  ,CMP.AREA_CODE AS COMPANY_AREA_CODE  
  ,CA.AREA_NAME AS CUSTOMER_AREA  
  ,CC.CITY AS CUSTOMER_CITY  
  ,CS.STATE AS CUSTOMER_STATE  
  ,CRG.REGION_NAME AS CUSTOMER_REGION  
  ,CPX.PREFIX_NAME  
  ,DC.CUSTOMER_FNAME+ '' ''+DC.CUSTOMER_LNAME AS REF_CUSOTMER  
  ,EU.USERNAME AS MAJOR_USER  
  ,EMP2.EMP_NAME AS MAJOR_EMP_NAME,  
  
   SKU.ARTICLE_CODE, ARTICLE_NO, ARTICLE_NAME, SKU.PARA1_CODE,    
   PARA1_NAME, SKU.PARA2_CODE,PARA2_NAME, SKU.PARA3_CODE,PARA3_NAME, UOM_NAME,       
   CODING_SCHEME,  ART.INACTIVE,   
   SKU.PURCHASE_PRICE,  SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,    
   SKU.PARA4_CODE,SKU.PARA5_CODE,SKU.PARA6_CODE,    
   PARA4_NAME,PARA5_NAME,PARA6_NAME,ART.UOM_CODE,ISNULL(UOM_TYPE,0) AS [UOM_TYPE],    
   ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],    
   ART.STOCK_NA,SKU.PRODUCT_NAME    
  -----********************************************************  
  ,SKU.AC_CODE  
  ,SKU.INV_NO  
  ,SKU.INV_DT  
  ,SKU.RECEIPT_DT  
  ,SKU.FORM_ID  
  ,MP_PERCENTAGE  
  ,ART.PARA1_SET  
  ,ART.PARA2_SET  
  ,SKU_CODE  
  ,ARTICLE_DESC  
  ,SD.SUB_SECTION_CODE  
  ,DISCON  
  ,WHOLESALE_PRICE  
  ,WSP_PERCENTAGE  
  ,MIN_PRICE  
  ,ARTICLE_TYPE  
  ,CREATED_ON  
  ,ARTICLE_GROUP_CODE  
  ,GENERATE_BARCODES_WITHARTICLE_PREFIX  
  ,ARTICLE_GEN_MODE  
  ,ARTICLE_PRD_MODE  
  ,ARTICLE_SET_CODE  
  ,OH_PERCENTAGE  
  ,OH_AMOUNT  
  ,SKU.FIX_MRP  
  ,SD.SECTION_CODE  
  ,SD.MFG_CATEGORY  
  ,LEFT(sku.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',sku.PRODUCT_CODE)-1,-1),LEN(sku.PRODUCT_CODE ))) as product_code,  
  T10.EMP_NAME AS MST_EMP_NAME1,    
  T11.EMP_NAME AS MST_EMP_NAME2,  
  T10.EMP_NAME AS EMP_NAME1,    
  T11.EMP_NAME AS EMP_NAME2,  
  (CASE WHEN ISNULL(B.ITEM_DESC,'''')<>''''  THEN B.ITEM_DESC ELSE SD.SUB_SECTION_NAME END) AS ITEM_DESC  
  ,B.TS  
  ,PAY.CASH_AMOUNT,PAY.CC_AMOUNT,PAY.CN_AMOUNT,PAY.ADVANCE_AMOUNT_ADJUSTED,PAY.CREDIT_AMOUNT,  
  PAY.OTHER_DOC_AMOUNT,PAY.BANK_CHARGES ,P4.ALIAS AS P4_ALIAS ,MST.PAYBACK ,ART.ALIAS AS [ARTICLE_ALIAS],  
    (CASE WHEN B.TAX_METHOD=2 THEN B.TAX_AMOUNT ELSE 0 END)  AS TAX_EXC_AMT,  
    (CASE WHEN B.TAX_METHOD=1 THEN B.TAX_AMOUNT ELSE 0 END)  AS TAX_INC_AMT,  
    B.BASIC_DISCOUNT_PERCENTAGE,  
    B.CARD_DISCOUNT_PERCENTAGE,  
    B.BASIC_DISCOUNT_AMOUNT,  
    B.CARD_DISCOUNT_AMOUNT,  
    CMP.BL_COMPANY_NAME,  
  SM.BL_SECTION_NAME,  
  SD.BL_SUB_SECTION_NAME,  
  ART.BL_ARTICLE_NAME,  
  ISNULL(RPS.CM_NO,'''') AS PACK_SLIP_NO ,
  B.Gst_Cess_Amount ,MST.Total_Gst_Cess_Amount   
  ,mst.ACH_NO,mst.ACH_DT,mst.IRN_QR_CODE,mst.EINV_IRN_NO  
  FROM CMM01106 MST (NOLOCK)   
  JOIN CMD01106 B (NOLOCK) ON B.CM_ID=MST.CM_ID    
  JOIN  SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE  
  JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE      
  JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
  JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
  JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE      
  JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE      
  JOIN PARA3 P3 (NOLOCK) ON SKU.PARA3_CODE = P3.PARA3_CODE      
  JOIN PARA4 P4 (NOLOCK) ON SKU.PARA4_CODE = P4.PARA4_CODE      
  JOIN PARA5 P5 (NOLOCK) ON SKU.PARA5_CODE = P5.PARA5_CODE      
  JOIN PARA6 P6 (NOLOCK) ON SKU.PARA6_CODE = P6.PARA6_CODE      
  LEFT OUTER JOIN UOM  (NOLOCK) ON ART.UOM_CODE = UOM.UOM_CODE  
  LEFT OUTER JOIN CUSTDYM D (NOLOCK) ON D.CUSTOMER_CODE=MST.CUSTOMER_CODE     
  JOIN USERS E (NOLOCK) ON E.USER_CODE = MST.USER_CODE    
  LEFT OUTER JOIN EMPLOYEE EMP1 (NOLOCK) ON EMP1.EMP_CODE= B.EMP_CODE    
  LEFT OUTER JOIN VW_BILL_PAYMODE PAY (NOLOCK) ON PAY.MEMO_ID=MST.CM_ID AND PAY.XN_TYPE=''SLS''  
  LEFT OUTER JOIN   
  (  
   SELECT AREA_CODE ,AD1 .AREA_NAME +'' ''+AD2 .CITY +CHAR(10)+AD3 .STATE+'''' +AD1 .PINCODE AS ADDRESS  FROM AREA AD1   
   LEFT OUTER JOIN CITY AD2 (NOLOCK) ON AD2.CITY_CODE=AD1.CITY_CODE  
   LEFT OUTER JOIN STATE AD3 (NOLOCK) ON AD3.STATE_CODE =AD2.STATE_CODE  
   LEFT OUTER JOIN REGIONM AD4 (NOLOCK) ON AD4.REGION_CODE=AD3.REGION_CODE  
  )X ON X.AREA_CODE=D.AREA_CODE  
  -----********************  
  LEFT OUTER JOIN DTM (NOLOCK) ON MST.DT_CODE=DTM.DT_CODE  
  JOIN LM01106 LM (NOLOCK) ON SKU.AC_CODE=LM.AC_CODE  
  LEFT JOIN FORM (NOLOCK) ON SKU.FORM_ID=FORM.FORM_ID  
  JOIN HD01106 HD (NOLOCK) ON LM.HEAD_CODE=HD.HEAD_CODE  
  JOIN COMPANY CMP (NOLOCK) ON CMP.COMPANY_CODE=''01''  
  JOIN AREA CA (NOLOCK) ON D.AREA_CODE=CA.AREA_CODE  
  JOIN CITY CC (NOLOCK) ON CA.CITY_CODE=CC.CITY_CODE  
  JOIN STATE CS (NOLOCK) ON CC.STATE_CODE=CS.STATE_CODE  
  JOIN REGIONM CRG (NOLOCK) ON CS.REGION_CODE=CRG.REGION_CODE  
  LEFT OUTER JOIN PREFIX CPX (NOLOCK) ON D.PREFIX_CODE=CPX.PREFIX_CODE  
  LEFT OUTER JOIN CUSTDYM DC (NOLOCK) ON D.REF_CUSTOMER_CODE=DC.CUSTOMER_CODE  
  JOIN USERS EU (NOLOCK) ON E.MAJOR_USER_CODE=EU.USER_CODE  
  LEFT OUTER JOIN  EMPLOYEE EMP2  (NOLOCK) ON EMP1.EMP_HEAD=EMP2.EMP_CODE  
  LEFT OUTER JOIN EMPLOYEE T10 (NOLOCK) ON T10.EMP_CODE = B.EMP_CODE1  
  LEFT OUTER JOIN EMPLOYEE T11 (NOLOCK) ON T11.EMP_CODE = B.EMP_CODE2  
  LEFT OUTER JOIN  
  (  
    SELECT C.ROW_ID,B.CM_NO  
	  FROM  RPS_MST B   
     JOIN RPS_DET C ON B.CM_ID =C.CM_ID   
    WHERE B.CANCELLED =0 and  ISNULL(B.REF_CM_ID,'''')<>''''
  ) RPS ON RPS.ROW_ID =B.PACK_SLIP_ROW_ID   
    
  WHERE MST.CM_ID ='''+@CWHERE+''''  
    
  PRINT @CCMD  
    EXEC SP_EXECUTESQL @CCMD  
 END  
 ELSE  
 BEGIN  

  SET @CCMD= N'IF OBJECT_ID('''+@CTARGETTABLENAME+N''',''U'') IS NOT NULL   
  DROP TABLE '+@CTARGETTABLENAME+N'   
  SELECT  D.USER_CUSTOMER_CODE AS  MST_USER_CUSTOMER_CODE,E.USERNAME AS MST_USERNAME,  
    EMP1.EMP_NAME AS MST_EMP_NAME,EMP1.EMP_ALIAS,       
   D.CUSTOMER_TITLE+'' ''+D.CUSTOMER_FNAME +'' ''+ D.CUSTOMER_LNAME AS MST_CUST_NAME,D.ADDRESS1 +'' ''+D.ADDRESS2   AS MST_ADDRESS0,  
   AREA_NAME +'' ''+CC.CITY +CHAR(10)+CS.STATE+'''' +PINCODE AS MST_ADDRESS1, D.DT_ANNIVERSARY,D.ADDRESS9  
  ,D.CUSTOMER_TITLE,D.CUSTOMER_FNAME,D.CUSTOMER_LNAME,D.ADDRESS1,D.ADDRESS2,D.PHONE1,D.PHONE2,D.MOBILE  
  ,D.EMAIL,D.OPENING_BALANCE,D.DT_BIRTH,D.DT_CARD_ISSUE,D.DT_CARD_EXPIRY,D.CARD_NO,D.CARD_NAME  
  ,E.USERNAME,E.USER_ALIAS,EMP1.EMP_NAME,DTM.DT_NAME,SKU.IMAGE_NAME'  
  SET @CCMD1=N',CMP.PIN,CMP.LOGO_PATH,CMP.WEB_ADDRESS,CMP.POLICY_NO  
  ,CMP.PAN_NO,CMP.EMAIL_ID,CMP.STATE,CMP.COUNTRY,CMP.MOBILE AS COMPANY_MOBILE,CMP.CONTACT_NAME,CMP.TDS_AC_NO,CMP.COMPANY_NAME  
  ,CMP.ADDRESS1 AS COMPANY_ADDRESS1,CMP.ADDRESS2 AS COMPANY_ADDRESS2,CMP.CITY,CMP.PHONES_FAX,CMP.CST_NO,CMP.CST_DT,CMP.SST_NO  
  ,CMP.SST_DT,CMP.ADDRESS9 AS COMPANY_ADDRESS9,CA.AREA_NAME AS CUSTOMER_AREA,CC.CITY AS CUSTOMER_CITY,CS.STATE AS CUSTOMER_STATE,CRG.REGION_NAME AS CUSTOMER_REGION  
  ,CPX.PREFIX_NAME,DC.CUSTOMER_FNAME+ '' ''+DC.CUSTOMER_LNAME AS REF_CUSOTMER,EU.USERNAME AS MAJOR_USER,EMP2.EMP_NAME AS MAJOR_EMP_NAME  
  ,ARTICLE_NO, ARTICLE_NAME,PARA1_NAME,PARA2_NAME,PARA3_NAME, UOM_NAME,SM.SECTION_NAME, SD.SUB_SECTION_NAME  
  ,PARA4_NAME,PARA5_NAME,PARA6_NAME,ISNULL(UOM_TYPE,0) AS [UOM_TYPE],SKU.PRODUCT_NAME,ARTICLE_DESC  
  ,T11.EMP_NAME AS MST_EMP_NAME2,T10.EMP_NAME AS EMP_NAME1,T10.EMP_NAME AS MST_EMP_NAME1,T11.EMP_NAME AS EMP_NAME2  
  ,B123.CASH_AMOUNT,B123.CC_AMOUNT,B123.CN_AMOUNT,B123.ADVANCE_AMOUNT_ADJUSTED,B123.CREDIT_AMOUNT  
  ,B123.OTHER_DOC_AMOUNT,B123.BANK_CHARGES ,P4.ALIAS AS P4_ALIAS,  
  AREA_NAME +'' ''+CC.CITY +CHAR(10)+CS.STATE+'''' +PINCODE  AS ADDRESS,MST.*,   
  ISNULL(FRM.FORM_NAME,'''') AS FORM_NAME,  
  FORM.TAX_PERCENTAGE AS  ITEM_TAX_PERCENTAGE,  
  D.TIN_NO AS ITEM_TIN_NO,INV_TYPE AS INVOICE_TYPE,INV_MODE AS INVOICE_MODE,  
  CMP.GST_NO,ISNULL(D.CUS_GST_STATE_CODE,'''') AS GST_STATE_CODE ,D.CUS_GST_NO
  '
  SET @CCMD2=N' INTO '+@CTARGETTABLENAME+ '  
  FROM #CMDET MST (NOLOCK)    
  JOIN  SKU (NOLOCK) ON SKU.PRODUCT_CODE=MST.PRODUCT_CODE  
  JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE      
  JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
  JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
  JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE      
  JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE      
  JOIN PARA3 P3 (NOLOCK) ON SKU.PARA3_CODE = P3.PARA3_CODE      
  JOIN PARA4 P4 (NOLOCK) ON SKU.PARA4_CODE = P4.PARA4_CODE      
  JOIN PARA5 P5 (NOLOCK) ON SKU.PARA5_CODE = P5.PARA5_CODE      
  JOIN PARA6 P6 (NOLOCK) ON SKU.PARA6_CODE = P6.PARA6_CODE      
  LEFT OUTER JOIN UOM  (NOLOCK) ON ART.UOM_CODE = UOM.UOM_CODE   
  LEFT OUTER JOIN CUSTDYM D (NOLOCK) ON D.CUSTOMER_CODE=MST.CUSTOMER_CODE      
  JOIN USERS E (NOLOCK) ON E.USER_CODE = MST.USER_CODE     
  LEFT OUTER JOIN EMPLOYEE EMP1 (NOLOCK) ON EMP1.EMP_CODE= MST.EMP_CODE     
  LEFT OUTER JOIN DTM (NOLOCK) ON MST.DT_CODE=DTM.DT_CODE   
  LEFT OUTER JOIN FORM FRM (NOLOCK) ON FRM.FORM_ID=MST.FORM_ID   
  LEFT JOIN LM01106 LM (NOLOCK) ON SKU.AC_CODE=LM.AC_CODE  
  LEFT JOIN FORM (NOLOCK) ON SKU.FORM_ID=FORM.FORM_ID  
  JOIN HD01106 HD (NOLOCK) ON LM.HEAD_CODE=HD.HEAD_CODE  
  JOIN COMPANY CMP (NOLOCK) ON  CMP.COMPANY_CODE=''01'' '  
  SET @CCMD3=N' LEFT JOIN LM01106 DLM (NOLOCK) ON FORM.EXCISE_DUTY_AC_CODE=DLM.AC_CODE  
  LEFT JOIN LM01106 ELM (NOLOCK) ON FORM.EXCISE_EDU_CESS_AC_CODE=ELM.AC_CODE  
  LEFT JOIN LM01106 HLM (NOLOCK) ON FORM.EXCISE_HEDU_CESS_AC_CODE=HLM.AC_CODE  
  LEFT JOIN LM01106 PRLM (NOLOCK) ON FORM.PUR_RETURN_AC_CODE=PRLM.AC_CODE  
  LEFT JOIN LM01106 SRLM (NOLOCK) ON FORM.SALE_RETURN_AC_CODE=SRLM.AC_CODE  
  LEFT JOIN LM01106 PLM (NOLOCK) ON FORM.PURCHASE_AC_CODE=PLM.AC_CODE  
  LEFT JOIN LM01106 SLM (NOLOCK) ON FORM.SALE_AC_CODE=SLM.AC_CODE  
  LEFT JOIN LM01106 TLM (NOLOCK) ON FORM.TAX_AC_CODE=TLM.AC_CODE  
  JOIN AREA CA (NOLOCK) ON D.AREA_CODE=CA.AREA_CODE  
  JOIN CITY CC (NOLOCK) ON CA.CITY_CODE=CC.CITY_CODE  
  JOIN STATE CS (NOLOCK) ON CC.STATE_CODE=CS.STATE_CODE  
  JOIN REGIONM CRG (NOLOCK) ON CS.REGION_CODE=CRG.REGION_CODE  
  LEFT OUTER JOIN PREFIX CPX (NOLOCK) ON D.PREFIX_CODE=CPX.PREFIX_CODE  
  LEFT OUTER JOIN CUSTDYM DC (NOLOCK) ON D.REF_CUSTOMER_CODE=DC.CUSTOMER_CODE  
  JOIN USERS EU (NOLOCK) ON E.MAJOR_USER_CODE=EU.USER_CODE  
  LEFT OUTER JOIN  EMPLOYEE EMP2  (NOLOCK) ON EMP1.EMP_HEAD=EMP2.EMP_CODE   
  LEFT OUTER JOIN EMPLOYEE T10 (NOLOCK) ON T10.EMP_CODE = MST.EMP_CODE1   
  LEFT OUTER JOIN EMPLOYEE T11 (NOLOCK) ON T11.EMP_CODE = MST.EMP_CODE2   
  LEFT OUTER JOIN ' + @CTPAY + ' B123 ON  MST.CM_ID= B123.MEMO_ID  
  ORDER BY MST.TS'  
  SET @CCMD=@CCMD+@CCMD1+@CCMD2+@CCMD3  
    
    
  PRINT @CCMD  
  EXEC SP_EXECUTESQL @CCMD  
 END  
  
END  

---END OF PROCEDURE - SP_SLSMST_QBF
