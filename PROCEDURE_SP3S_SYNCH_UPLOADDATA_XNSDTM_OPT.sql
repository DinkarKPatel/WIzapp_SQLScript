CREATE PROCEDURE SP3S_SYNCH_UPLOADDATA_XNSDTM_OPT
(
	@cSPId VARCHAR(50),  
    @CERRMSG VARCHAR(MAX) OUTPUT  
)
AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@CSTEP VARCHAR(10),@CTABLE_SUFFIX VARCHAR(100),
	@CTABLENAME VARCHAR(100),@CTMP_TABLENAME VARCHAR(100),@CKEYFIELD VARCHAR(100),
	@CTABLESSTR VARCHAR(MAX),@CSOURCEDB VARCHAR(100),@CMERGEDB VARCHAR(100),
	@CFILTERCONDITION VARCHAR(100)

	SET @CMERGEDB=''
	SET @CSOURCEDB=''
	SET @cFiLterCondition=' b.sp_id='''+@cSPId+''''
	
	BEGIN TRY 
			
			SET @CTABLE_SUFFIX = 'UPLOAD'
			
			SET @CSTEP = 20 
			SET @CTABLENAME='DTM'  
			SET @CTMP_TABLENAME='XNSDTM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
			SET @CKEYFIELD='DT_CODE'  
			SET @CSTEP=40 
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION=@CFILTERCONDITION
		   		
				
				DELETE A FROM  XNSDTM_DTM_UPLOAD A WHERE SP_ID=@cSPId      
	END TRY
	BEGIN CATCH
	 SET @CERRMSG='P:SP3S_SYNCH_UPLOADDATA_XNSDTM_OPT, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH

EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0  
		COMMIT  
	ELSE
	IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0  
		ROLLBACK  

		
END
--END OF THE PROCEDURES SP_MERGE_MIRROR_XNSDTM_DATA
