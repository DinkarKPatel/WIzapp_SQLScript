CREATE PROCEDURE SP3S_MEMOPRINT_DYNAMIC
@CXNTYPE VARCHAR(10)='SLS',
@CMEMOID VARCHAR(40),
@NSPID VARCHAR(40)
AS
BEGIN
	DECLARE @CTARGETTABLENAME VARCHAR(1000),@CSTEP VARCHAR(10),@CCMD NVARCHAR(MAX),@CERRORMSG VARCHAR(MAX),
			@CLAYOUTEXPR VARCHAR(MAX),@CJOINEXPR VARCHAR(MAX),@CPAYMODEEXPR VARCHAR(MAX),
			@CTABLENAME VARCHAR(1000),@CCHILDCOLNAME VARCHAR(1000)

BEGIN TRY	
	
	SET @CSTEP = 10
	SET @CERRORMSG=''
	
	SET @CPAYMODEEXPR = ''
	
	SET @CSTEP = 30	
	SET @CTARGETTABLENAME = 'MASTER.DBO.TEMP_SLS_'+LTRIM(RTRIM((@NSPID)))
	    
	IF OBJECT_ID(@CTARGETTABLENAME,'U') IS NOT NULL  
	BEGIN
		SET @CCMD=N'DROP TABLE '+@CTARGETTABLENAME
		EXEC SP_EXECUTESQL @CCMD
	END    
	
	SET @CSTEP = 40
    SET @CJOINEXPR = ISNULL(@CJOINEXPR,'')  
	
	SELECT TOP 1 @CTABLENAME=TABLE_NAME,@CCHILDCOLNAME=CHILD_COLNAME FROM DYNAMICPRINT_TABLES (NOLOCK) 
	WHERE XN_TYPE=@CXNTYPE AND PARENT_TABLE_NAME=''	
	ORDER BY TABLES_JOIN_ORDER
	
	SELECT @CLAYOUTEXPR=LAYOUT_EXPR,@CJOINEXPR=JOIN_EXPR FROM DYNAMICPRINT_EXPR (NOLOCK)
	WHERE XN_TYPE=@CXNTYPE

	IF @CXNTYPE='SLS'
	BEGIN

		SET @CSTEP = 50	
		
		SET @CPAYMODEEXPR=N' LEFT OUTER JOIN (SELECT A.MEMO_ID,  
		  SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000001'' THEN AMOUNT ELSE 0 END) AS CASH_AMOUNT,  
		    
		  SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000002'' THEN AMOUNT ELSE 0 END) AS CC_AMOUNT,  
		  
		  SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000003'' AND  A.PAYMODE_CODE = ''0000001''  
			 THEN AMOUNT ELSE 0 END) AS CN_AMOUNT,  
		  
		  SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000003'' AND A.PAYMODE_CODE = ''0000002''  
			 THEN AMOUNT ELSE 0 END) AS ADVANCE_AMOUNT_ADJUSTED,  
		  
		  SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000003'' AND A.PAYMODE_CODE NOT IN ( ''0000001'', ''0000002'' )  
			 THEN AMOUNT ELSE 0 END) AS OTHER_DOC_AMOUNT,  
		  
		  
		  SUM(CASE WHEN A.PAYMODE_CODE=''0000004'' THEN AMOUNT ELSE 0 END) AS CREDIT_AMOUNT,
		  SUM(CASE WHEN A.PAYMODE_CODE=''CMR0001'' THEN AMOUNT ELSE 0 END) AS CREDIT_REFUND_AMOUNT,  
		  
		  SUM(CASE WHEN B.PAYMODE_GRP_CODE NOT IN ( ''0000001'',''0000002'',''0000003'',''0000004'')  
		  AND A.PAYMODE_CODE <> ''0000003''  
			 THEN AMOUNT ELSE 0 END) AS MISC_AMOUNT  
		FROM PAYMODE_XN_DET A (NOLOCK)  
		JOIN PAYMODE_MST B (NOLOCK) ON A.PAYMODE_CODE = B.PAYMODE_CODE  
		JOIN PAYMODE_GRP_MST C (NOLOCK) ON B.PAYMODE_GRP_CODE = C.PAYMODE_GRP_CODE  
		WHERE A.MEMO_ID='''+@CMEMOID+''' AND A.XN_TYPE= ''SLS''
		GROUP BY A.MEMO_ID) PAY ON PAY.MEMO_ID=CMM01106.CM_ID' 		
		
		SET @CLAYOUTEXPR=@CLAYOUTEXPR+',PAY.*'	
	END
	
	SET @CSTEP = 80			           
	SET @CCMD = 'SELECT '+@CLAYOUTEXPR+' INTO '+@CTARGETTABLENAME+' FROM ' + @CTABLENAME + @CJOINEXPR+@CPAYMODEEXPR+
				' WHERE '+@CTABLENAME+'.'+@CCHILDCOLNAME+'='''+@CMEMOID+''''
	PRINT ISNULL(@CCMD,'NULL DYNAKIC PRINT EXPR')
	
	EXEC SP_EXECUTESQL @CCMD			            
	
	GOTO END_PROC
END TRY

BEGIN CATCH
	SELECT @CERRORMSG='PROCEDURE SP3S_MEMOPRINT_DYNAMIC STEP: '+@CSTEP+ ' LINE NO. :'+
	ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
	
	GOTO END_PROC
END CATCH

END_PROC:
	IF ISNULL(@CERRORMSG,'')<>''
		SELECT 	@CERRORMSG AS ERRMSG
END
----- END OF PROCEDURE SP3S_MEMOPRINT_DYNAMIC
