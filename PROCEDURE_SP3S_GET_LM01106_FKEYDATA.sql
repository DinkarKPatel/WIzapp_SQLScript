CREATE PROCEDURE SP3S_GET_LM01106_FKEYDATA
@CSOURCEDB VARCHAR(200),
@CSOURCETABLE VARCHAR(200),
@CSOURCEKEYFIELD VARCHAR(200),
@CXNTYPE VARCHAR(10),
@CTABLESUFFIX VARCHAR(40),
@CLOCID VARCHAR(5),
@CERRORMSG VARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	BEGIN TRY
		DECLARE @CCMD NVARCHAR(MAX),@CTEMPTABLE VARCHAR(1000),@CTEMPTABLE1 VARCHAR(1000),@CTEMPTABLE2 VARCHAR(1000),
				@CTEMPTABLE3 VARCHAR(1000),@CTEMPTABLE4 VARCHAR(1000),@CTEMPTABLE5 VARCHAR(1000),
				@CKEYFIELDVAL VARCHAR(40),@CDESTDB VARCHAR(200),@CFILTERCONDITION VARCHAR(MAX),@NSTEP INT,
				@CHEAD_CODE CHAR(10)
		
		SET @CDESTDB='WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.'
		
		
		SET @NSTEP=10		

		IF OBJECT_ID('TEMPDB..#TMPMISSINGHDDATA','U') IS NOT NULL
			DROP TABLE #TMPMISSINGHDDATA
		
		SELECT HEAD_CODE INTO #TMPMISSINGHDDATA FROM HD01106 WHERE 1=2
		
		IF @CSOURCETABLE<>'#TMPMISSINGLMDATA'			
		BEGIN
			PRINT 'RECREATE MISSING LM'+@CSOURCETABLE
			IF OBJECT_ID('TEMPDB..#TMPMISSINGLMDATA','U') IS NOT NULL
				DROP TABLE #TMPMISSINGLMDATA
			
			SELECT AC_CODE INTO #TMPMISSINGLMDATA FROM LM01106 WHERE 1=2
		END	
		
		
		IF OBJECT_ID('TEMPDB..#TMPMISSINGAREADATA','U') IS NOT NULL
			DROP TABLE #TMPMISSINGAREADATA
		
		SET @NSTEP=20
		SELECT AREA_CODE INTO #TMPMISSINGAREADATA FROM AREA WHERE 1=2
										
		SET @CTEMPTABLE=(CASE WHEN LEFT(@CSOURCETABLE,1)='#' THEN @CSOURCETABLE ELSE @CSOURCEDB+'[TMP_'+@CXNTYPE+'_'+@CSOURCETABLE+'_'+@CTABLESUFFIX+']' END)
		SET @CTEMPTABLE1=@CSOURCEDB+'[TMP_'+@CXNTYPE+'_AREA_'+@CTABLESUFFIX+']'
		SET @CTEMPTABLE2=@CSOURCEDB+'[TMP_'+@CXNTYPE+'_LM01106_'+@CTABLESUFFIX+']'
		SET @CTEMPTABLE3=@CSOURCEDB+'[TMP_'+@CXNTYPE+'_LMP01106_'+@CTABLESUFFIX+']'
		SET @CTEMPTABLE4=@CSOURCEDB+'[TMP_'+@CXNTYPE+'_HD01106_'+@CTABLESUFFIX+']'
		
		
				
		SET @NSTEP=30
		IF OBJECT_ID(@CTEMPTABLE4,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT B.HEAD_CODE FROM '+@CTEMPTABLE+' A
						JOIN '+@CTEMPTABLE2+' B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN '+@CTEMPTABLE4+' C ON C.HEAD_CODE=B.HEAD_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.HD01106 D ON D.HEAD_CODE=B.HEAD_CODE
						WHERE C.HEAD_CODE IS NULL AND D.HEAD_CODE IS NULL
						UNION
						SELECT DISTINCT B.HEAD_CODE FROM '+@CTEMPTABLE4+' A
						JOIN HD01106 B ON B.HEAD_CODE=A.HEAD_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.HD01106 D ON D.HEAD_CODE=B.MAJOR_HEAD_CODE
						WHERE D.HEAD_CODE IS NULL'
		ELSE
		IF OBJECT_ID(@CTEMPTABLE2,'U') IS NOT NULL
			SET @CCMD=N'SELECT DISTINCT B.HEAD_CODE FROM '+@CTEMPTABLE+' A
						JOIN '+@CTEMPTABLE2+' B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.HD01106 C ON C.HEAD_CODE=B.HEAD_CODE
						WHERE C.HEAD_CODE IS NULL
						UNION
						SELECT DISTINCT B.HEAD_CODE FROM '+@CTEMPTABLE+' A
						JOIN LM01106 B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.HD01106 C ON C.HEAD_CODE=B.HEAD_CODE
						WHERE C.HEAD_CODE IS NULL'
		ELSE
			SET @CCMD=N'SELECT DISTINCT B.HEAD_CODE FROM '+@CTEMPTABLE+' A
						JOIN LM01106 B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.HD01106 C ON C.HEAD_CODE=B.HEAD_CODE
						WHERE C.HEAD_CODE IS NULL'

		PRINT @CCMD	
		INSERT #TMPMISSINGHDDATA
		EXEC SP_EXECUTESQL @CCMD
		
		IF @CSOURCETABLE<>'#TMPMISSINGLMDATA'
		BEGIN		
			SET @NSTEP=35
			IF OBJECT_ID(@CTEMPTABLE2,'U') IS NOT NULL
				SET @CCMD=N'SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
							LEFT OUTER JOIN '+@CTEMPTABLE2+'  B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.LM01106 C ON C.AC_CODE=A.'+@CSOURCEKEYFIELD+'
							WHERE B.AC_CODE IS NULL AND C.AC_CODE IS NULL AND A.'+@CSOURCEKEYFIELD+' IS NOT NULL'
			ELSE
				SET @CCMD=N'SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.LM01106 B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
							WHERE B.AC_CODE IS NULL AND A.'+@CSOURCEKEYFIELD+' IS NOT NULL'

			PRINT @CCMD	
			INSERT #TMPMISSINGLMDATA
			EXEC SP_EXECUTESQL @CCMD
		END
		
		IF OBJECT_ID(@CTEMPTABLE1,'U') IS NOT NULL OR OBJECT_ID(@CTEMPTABLE3,'U') IS NOT NULL
		BEGIN
			SET @NSTEP=40
			IF OBJECT_ID(@CTEMPTABLE1,'U') IS NOT NULL AND OBJECT_ID(@CTEMPTABLE3,'U') IS NOT NULL
				SET @CCMD=N'SELECT DISTINCT B.AREA_CODE FROM '+@CTEMPTABLE+'  A
							JOIN '+@CTEMPTABLE3+'  B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
							LEFT OUTER JOIN '+@CTEMPTABLE1+'  C ON C.AREA_CODE=B.AREA_CODE
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.AREA D ON D.AREA_CODE=C.AREA_CODE
							WHERE C.AREA_CODE IS NULL AND D.AREA_CODE IS NULL
							UNION
							SELECT DISTINCT B.AREA_CODE FROM '+@CTEMPTABLE+'  A
							JOIN LMP01106 B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.AREA C ON C.AREA_CODE=B.AREA_CODE
							WHERE C.AREA_CODE IS NULL'
			ELSE
			IF OBJECT_ID(@CTEMPTABLE3,'U') IS NOT NULL
				SET @CCMD=N'SELECT DISTINCT B.AREA_CODE FROM '+@CTEMPTABLE+'  A
							JOIN '+@CTEMPTABLE3+'  B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.AREA C ON C.AREA_CODE=B.AREA_CODE
							WHERE C.AREA_CODE IS NULL
							UNION
							SELECT DISTINCT B.AREA_CODE FROM '+@CTEMPTABLE+'  A
							JOIN LMP01106 B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.AREA C ON C.AREA_CODE=B.AREA_CODE
							WHERE C.AREA_CODE IS NULL'
			ELSE
			IF OBJECT_ID(@CTEMPTABLE1,'U') IS NOT NULL
				SET @CCMD=N'SELECT DISTINCT B.AREA_CODE FROM '+@CTEMPTABLE+'  A
							JOIN LMP01106 B ON B.AC_CODE=A.'+@CSOURCEKEYFIELD+'
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.AREA C ON C.AREA_CODE=B.AREA_CODE
							LEFT OUTER JOIN '+@CTEMPTABLE1+'  D ON D.AREA_CODE=B.AREA_CODE
							WHERE C.AREA_CODE IS NULL AND D.AREA_CODE IS NULL'
										
			INSERT #TMPMISSINGAREADATA
			EXEC SP_EXECUTESQL @CCMD
		END

		IF EXISTS (SELECT TOP 1 AREA_CODE FROM #TMPMISSINGAREADATA)
		BEGIN
			SET @NSTEP=45
			EXEC SP3S_GET_AREA_FKEYDATA
			@CSOURCEDB='',
			@CSOURCETABLE='#TMPMISSINGAREADATA',
			@CSOURCEKEYFIELD='AREA_CODE',
			@CXNTYPE=@CXNTYPE,
			@CTABLESUFFIX=@CTABLESUFFIX,
			@CLOCID=@CLOCID,
			@CERRORMSG=@CERRORMSG OUTPUT
		END	
		
		IF EXISTS (SELECT TOP 1 HEAD_CODE FROM #TMPMISSINGHDDATA)
		BEGIN
			PRINT 'INSERT MISSING HD DATA'+@CSOURCETABLE
			SET @NSTEP=50

			IF CURSOR_STATUS('GLOBAL','CUR_MAJOR_HEADS') IN (0,1)
			BEGIN
				CLOSE CUR_MAJOR_HEADS
				DEALLOCATE CUR_MAJOR_HEADS
			END	
			
			DECLARE CUR_MAJOR_HEADS CURSOR FOR SELECT HEAD_CODE FROM #TMPMISSINGHDDATA
			OPEN CUR_MAJOR_HEADS
			FETCH NEXT FROM CUR_MAJOR_HEADS INTO @CHEAD_CODE
			WHILE @@FETCH_STATUS=0
			BEGIN
				SET @NSTEP=55
				SET @CFILTERCONDITION= ' (B.HEAD_CODE IN (SELECT HEAD_CODE FROM DBO.FNIT_MAJORHEADS('''+@CHEAD_CODE+'''))
									     OR B.HEAD_CODE='''+@CHEAD_CODE+''')' 
				
				EXEC UPDATEMASTERXN_MIRROR
				@CSOURCEDB='',
				@CSOURCETABLE='HD01106',
				@CDESTDB=@CDESTDB,
				@CDESTTABLE='HD01106',
				@CKEYFIELD1='HEAD_CODE',
				@LINSERTONLY=0,
				@CFILTERCONDITION=@CFILTERCONDITION,
				@LUPDATEONLY=0,
				@BALWAYSUPDATE=1
			
				FETCH NEXT FROM CUR_MAJOR_HEADS INTO @CHEAD_CODE
			END
			CLOSE CUR_MAJOR_HEADS
			DEALLOCATE CUR_MAJOR_HEADS

		END

		
		IF EXISTS (SELECT TOP 1 AC_CODE FROM #TMPMISSINGLMDATA)
		BEGIN
			PRINT 'INSERT MISSING LM DATA'+@CSOURCETABLE
			
		
			SET @NSTEP=60
			SET @CFILTERCONDITION= 'B.AC_CODE IN (SELECT AC_CODE FROM #TMPMISSINGLMDATA)'
			
			EXEC UPDATEMASTERXN_MIRROR
			@CSOURCEDB='',
			@CSOURCETABLE='LM01106',
			@CDESTDB=@CDESTDB,
			@CDESTTABLE='LM01106',
			@CKEYFIELD1='AC_CODE',
			@LINSERTONLY=0,
			@CFILTERCONDITION=@CFILTERCONDITION,
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1
		END
									
		GOTO END_PROC									
	END TRY
	
	BEGIN CATCH

		SELECT @CERRORMSG='PROCEDURE SP3S_GET_LM01106_FKEYDATA : '+ISNULL(ERROR_PROCEDURE(),'NULL P')+'STEP :'+STR(ISNULL(@NSTEP,0))+ ' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')

		PRINT 'ENTER CATCH OF SP3S_GET_LM01106_FKEYDATA :'+@CERRORMSG
		GOTO END_PROC
	END CATCH
	
END_PROC:
		
END
----'END OF PROCEDURE SP3S_GET_LM01106_FKEYDATA'
