CREATE PROCEDURE SP3S_SYNCH_UPLOADDATA_SCF_OPT
(
    @NSPID VARCHAR(50)
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @DTSQL NVARCHAR(MAX),@CTMP_TABLENAME VARCHAR(200),
			@CJOINSTR VARCHAR(MAX),@CERRORMSG VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100),
			@CTABLENAME VARCHAR(200),@CERRMSGOUT VARCHAR(MAX),@CSTEP VARCHAR(20),@CKEYFIELD VARCHAR(100)
			,@CKEYFIELD1 VARCHAR(100),@CTABLE_SUFFIX VARCHAR(50),@CTABLESSTR VARCHAR(500),@CSOURCEDB VARCHAR(10),
			@CMERGEDB VARCHAR(10),@BMSTINSERTONLY BIT,@CMEMOID VARCHAR(50),@BCANCELLED BIT,@CFILTERCONDITION VARCHAR(1000),
			@BADDMODE BIT
	
	BEGIN TRY

		SET @CSTEP = 10
			
		SET @CERRORMSG=''
	  
 	   BEGIN TRANSACTION
 	   
/*STATE,CITY,AREA,HD01106,LM01106,LMP01106,UOM,SECTIONM,SECTIOND,,ARTICLE,PARA1,PARA2,PARA3,PARA4,PARA5,PARA6
,ATTRM,ATTR_KEY,ART_ATTR,SKU,SKU_OH,SKU_BO,FORM,SCM01106,SCF01106,SCM01106_AUDIT,SCF01106_AUDIT,SCF_IMPORT_LOG*/


	SELECT @CSOURCEDB='',@CMERGEDB='',@BMSTINSERTONLY=1
	
	SET @CTABLE_SUFFIX='UPLOAD'
	
	SELECT TOP 1 @CMEMOID = B.MEMO_ID ,@BCANCELLED=CANCELLED 
    FROM SCF_SCM01106_UPLOAD B (NOLOCK)
	WHERE SP_ID=@nSpId
   
    IF ISNULL(@CMEMOID,'')=''
		GOTO EXIT_PROC
		
    SET @CFILTERCONDITION = 'B.ISSUE_ID='''+@CMEMOID+''' AND B.SP_ID='+LTRIM(RTRIM((@NSPID )))+''''
	

		DECLARE @CMEMOIDSEARCH VARCHAR(100)
		SELECT TOP 1 @CMEMOIDSEARCH=A.MEMO_ID FROM scm01106 A (NOLOCK) WHERE A.MEMO_ID=@CMEMOID
		
		
	IF ISNULL(@CMEMOIDSEARCH,'')<>''
		SET @BADDMODE=0
	ELSE
		SET @BADDMODE=1


    IF @BADDMODE=0
	BEGIN	
		
		 IF @bCancelled=1 
		BEGIN
			UPDATE scm01106 WITH (ROWLOCK) SET cancelled=1 WHERE MEMO_ID=@cMemoid
			GOTO lblUpdaePmt
		END

	END
	
	   SET @CSTEP = 160
	   SET @CTABLENAME='UOM'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='UOM_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=170
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 							
							  
	   SET @CSTEP = 162
	   SET @CTABLENAME='SECTIONM'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='SECTION_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=164
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 											
							  
	   SET @CSTEP = 166
	   SET @CTABLENAME='SECTIOND'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='SUB_SECTION_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=168
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 																		  		  
		
	   SET @CSTEP = 180
	   SET @CTABLENAME='ARTICLE'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='ARTICLE_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=190
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 						
		
	   SET @CSTEP = 200
	   SET @CTABLENAME='PARA1'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA1_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=210
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 					
	
	   SET @CSTEP = 220
	   SET @CTABLENAME='PARA2'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA2_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=230
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 				
	
	   SET @CSTEP = 240
	   SET @CTABLENAME='PARA3'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA3_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=350
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 			
	
	   SET @CSTEP = 260
	   SET @CTABLENAME='PARA4'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA4_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=270
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 			

	   SET @CSTEP = 280
	   SET @CTABLENAME='PARA5'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA5_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=290
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 			

	   SET @CSTEP = 300
	   SET @CTABLENAME='PARA6'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PARA6_CODE'
	   SET @CKEYFIELD1=''
	   SET @CSTEP=310
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2=@CKEYFIELD1,@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 			

	   SET @CSTEP = 380
	   SET @CTABLENAME='SKU'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PRODUCT_CODE'
	   SET @CSTEP=390
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	
	   
	   SET @CSTEP = 400
	   SET @CTABLENAME='SKU_OH'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='PRODUCT_CODE'
	   SET @CSTEP=410
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	   
	   SET @CSTEP = 460
	   SET @CTABLENAME='SCM01106'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='MEMO_ID'
	   
	   SET @CSTEP=470
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	   


	   IF @BADDMODE =0
	   BEGIN
		   SET @CSTEP = 480
		   SET @DTSQL='DELETE FROM '+@CMERGEDB+'SCC01106 WITH (ROWLOCK) WHERE MEMO_ID='''+@CMEMOID+''''
		   EXEC SP_EXECUTESQL @DTSQL

			SET @CSTEP = 500
		   SET @DTSQL='DELETE FROM '+@CMERGEDB+'SCF01106 WITH (ROWLOCK) WHERE MEMO_ID='''+@CMEMOID+''''
		   EXEC SP_EXECUTESQL @DTSQL
	   

	   END

	   
	   SET @CSTEP = 490
	   SET @CTABLENAME='SCC01106'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='MEMO_ID'

	   SET @CSTEP=495

	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	   
	  
	   SET @CSTEP = 510
	   SET @CTABLENAME='SCF01106'
	   SET @CTMP_TABLENAME='SCF_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	   SET @CKEYFIELD='MEMO_ID'
	   
	   SET @CSTEP=520
	   
	   EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 

		SET @CSTEP=530 
		
	lblUpdaePmt:
	EXEC SP3S_MERGE_LOCPMT  
	@cTempTable='SCF_PMT01106_UPLOAD',  
	@cMemoIdCol='SP_ID',  
	@cMemoId =@nSpId

	SET @CSTEP=100    	

			DELETE A FROM SCF_ARTICLE_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_PARA1_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_PARA2_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_PARA3_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_PARA4_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_PARA5_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_PARA6_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_PMT01106_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_SCC01106_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_SCF01106_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_SCM01106_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_SECTIOND_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_SECTIONM_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_SKU_OH_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_SKU_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
			DELETE A FROM SCF_UOM_UPLOAD A (NOLOCK) WHERE A.SP_ID=@nSpId 
	  			   

	END TRY
	BEGIN CATCH
		SET @CERRMSG='P:SP_MERGE_MIRROR_SCF_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH

EXIT_PROC:
	
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
	END
	ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK
	

END	
---END OF PROCEDURE - SP_MERGE_MIRROR_SCF_DATA
