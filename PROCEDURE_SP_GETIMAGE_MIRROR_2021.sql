CREATE PROCEDURE SP_GETIMAGE_MIRROR_2021  --EXEC SP_GETIMAGE_MIRROR_2021    1,'22'
(    
   @NMODE INT, -- 1 FOR PULL 2 FOR PUSH 3 FOR ACKNOWLEDGE    5 FOR DELETION
   @LOC_ID VARCHAR(100)='',       
   @DT_CR VARCHAR(100)=''    
)    
AS    
BEGIN    
	--INSERT INTO IMAGE_TEST(LOC_ID , DT_DR ,LAST_UPDATE ) SELECT @LOC_ID,@DT_CR,GETDATE()
     DECLARE @DTSQL NVARCHAR(MAX), @NSTEP VARCHAR(10),@CJOINSTR VARCHAR(MAX),      
     @CNT INT,@CERRORMSG VARCHAR(2000),@TMP_PRODUCT_CODE VARCHAR(100),@CPRODUCTCODECOL VARCHAR(MAX),
	 @CPRODUCTCODECOL_KRR VARCHAR(MAX),      
     @IFIND INT,@DT_CREATED VARCHAR(1000),      
     @CONFIG_TYP NUMERIC(10),@TMPTABLENAME VARCHAR(100),@COLNAME VARCHAR(100),@CDTCREATEDCOL VARCHAR(MAX),      
     @CPURJOINSTR VARCHAR(1000),@CPURWC VARCHAR(1000),@CCURLOCID VARCHAR(10),@CHOLOCID VARCHAR(10),      
     @CMASTERTABLENAME VARCHAR(100),@TMP_PREV_PRODUCT_CODE VARCHAR(100),@CPRODUCTCODECOL_P VARCHAR(MAX),  
     @BNEWIMAGEMETHOD BIT,@CTABLENAME VARCHAR(100),@CTEMPMASTERTABLE VARCHAR(100),@CKEYFIELD VARCHAR(100),  
     @CIMAGE_NAME VARCHAR(1000)  
     DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(500),TMP_TABLENAME VARCHAR(500),XN_ID VARCHAR(40))
     DECLARE    @CIMAGE_DOWNLOAD_FOR_N_DAYS VARCHAR(10)
       
BEGIN TRY        
       
	DECLARE @CTEMPDBNAME1 VARCHAR(40),@CTEMPDBNAME VARCHAR(40)  

	SELECT TOP 1 @CCURLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'       
	SELECT TOP 1 @CHOLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'       
	SELECT TOP 1 @CIMAGE_DOWNLOAD_FOR_N_DAYS=VALUE FROM CONFIG WHERE CONFIG_OPTION='IMAGE_DOWNLOAD_FOR_N_DAYS'       

	SET @CIMAGE_DOWNLOAD_FOR_N_DAYS=ISNULL(@CIMAGE_DOWNLOAD_FOR_N_DAYS,'7')
	PRINT @CIMAGE_DOWNLOAD_FOR_N_DAYS
	SET @BNEWIMAGEMETHOD=0     
	SELECT TOP 1 @CONFIG_TYP=VALUE FROM CONFIG 
	WHERE   CONFIG_OPTION LIKE 'PICT_SOURCE'   


	SET @CTEMPDBNAME = DB_NAME()+ '.DBO.'   


	IF ISNULL(@CONFIG_TYP,0)=0      
	BEGIN      
		SET @CERRORMSG = 'PLEASE DEFINE A VALID IMAGE SOURCE IN CONFIG....'        
		GOTO LBLLAST       
	END      

	SET @NSTEP=10      
      
    ----PICK NEW METHOD --  
    --IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG)  
    --BEGIN  
        SET @CONFIG_TYP=3  
        SET @BNEWIMAGEMETHOD=1  
        INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('IMAGE_INFO_CONFIG')  
    --END  
      
    IF @BNEWIMAGEMETHOD=1  
    BEGIN  
		DECLARE @CIAMGEFILTER VARCHAR(MAX),@CIAMGEFILTER1 VARCHAR(MAX),@CIAMGE_INFO_COLUMNS VARCHAR(MAX)  
		SET @CIAMGEFILTER='1=1 '  
		SET @CIAMGEFILTER1=''  
		SET @CIAMGE_INFO_COLUMNS=''  
          
		IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG WHERE ISNULL(PRODUCT,0) =1 )  
		BEGIN  
			SET @CIAMGEFILTER=@CIAMGEFILTER+' AND SKU.PRODUCT_CODE=IMAGE_INFO.PRODUCT_CODE '  
			SET @CIAMGEFILTER1=@CIAMGEFILTER1+(CASE WHEN @CIAMGEFILTER1<>'' THEN ',' ELSE '' END)+'SKU.PRODUCT_CODE'  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'SKU.PRODUCT_CODE'  
		END  
		ELSE  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+''''' AS PRODUCT_CODE'  
     
		IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG WHERE ISNULL(ARTICLE ,0) =1 )  
		BEGIN  
			SET @CIAMGEFILTER=@CIAMGEFILTER+' AND ARTICLE.ARTICLE_CODE=IMAGE_INFO.ARTICLE_CODE'  
			SET @CIAMGEFILTER1=@CIAMGEFILTER1+(CASE WHEN @CIAMGEFILTER1<>'' THEN ',' ELSE '' END)+'ARTICLE.ARTICLE_CODE'  
			SET @CONFIG_TYP=1  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'ARTICLE.ARTICLE_CODE'  
		END  
		ELSE  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'''00000000'' AS ARTICLE_CODE'  
     
		IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG WHERE ISNULL(PARA1 ,0) =1)  
		BEGIN  
			SET @CIAMGEFILTER=@CIAMGEFILTER+' AND PARA1.PARA1_CODE=IMAGE_INFO.PARA1_CODE'  
			SET @CIAMGEFILTER1=@CIAMGEFILTER1+(CASE WHEN @CIAMGEFILTER1<>'' THEN ',' ELSE '' END)+'PARA1.PARA1_CODE'  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'PARA1.PARA1_CODE'  
		END  
		ELSE  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'''0000000'' AS PARA1_CODE'  
  
		IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG WHERE ISNULL(PARA2 ,0) =1)  
		BEGIN  
			SET @CIAMGEFILTER=@CIAMGEFILTER+' AND  PARA2.PARA2_CODE=IMAGE_INFO.PARA2_CODE'  
			SET @CIAMGEFILTER1=@CIAMGEFILTER1+(CASE WHEN @CIAMGEFILTER1<>'' THEN ',' ELSE '' END)+'PARA2.PARA2_CODE'  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'PARA2.PARA2_CODE'  
		END  
		ELSE  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'''00000000'' AS PARA2_CODE'  

		IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG WHERE ISNULL(PARA3 ,0) =1 )  
		BEGIN  
			SET @CIAMGEFILTER=@CIAMGEFILTER+' AND  PARA3.PARA3_CODE=IMAGE_INFO.PARA3_CODE'  
			SET @CIAMGEFILTER1=@CIAMGEFILTER1+(CASE WHEN @CIAMGEFILTER1<>'' THEN ',' ELSE '' END)+'PARA3.PARA3_CODE'  
			SET @CONFIG_TYP=2  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'PARA3.PARA3_CODE'  
		END  
		ELSE  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'''0000000'' AS PARA3_CODE'  


		IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG WHERE ISNULL(PARA4 ,0) =1)  
		BEGIN  
			SET @CIAMGEFILTER=@CIAMGEFILTER+' AND  PARA4.PARA4_CODE=IMAGE_INFO.PARA4_CODE'  
			SET @CIAMGEFILTER1=@CIAMGEFILTER1+(CASE WHEN @CIAMGEFILTER1<>'' THEN ',' ELSE '' END)+'PARA4.PARA4_CODE'  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'PARA4.PARA4_CODE'  
		END  
		ELSE  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'''0000000'' AS PARA4_CODE'  

		IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG WHERE ISNULL(PARA5 ,0) =1)  
		BEGIN  
			SET @CIAMGEFILTER=@CIAMGEFILTER+' AND  PARA5.PARA5_CODE=IMAGE_INFO.PARA5_CODE'  
			SET @CIAMGEFILTER1=@CIAMGEFILTER1+(CASE WHEN @CIAMGEFILTER1<>'' THEN ',' ELSE '' END)+'PARA5.PARA5_CODE'  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'PARA5.PARA5_CODE'  
		END  
		ELSE  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'''0000000'' AS PARA5_CODE'  

		IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG WHERE ISNULL(PARA6 ,0) =1)  
		BEGIN  
			SET @CIAMGEFILTER=@CIAMGEFILTER+' AND  PARA6.PARA6_CODE=IMAGE_INFO.PARA6_CODE'  
			SET @CIAMGEFILTER1=@CIAMGEFILTER1+(CASE WHEN @CIAMGEFILTER1<>'' THEN ',' ELSE '' END)+'PARA6.PARA6_CODE'  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'PARA6.PARA6_CODE'    
		END  
		ELSE  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'''0000000'' AS PARA6_CODE'  

		IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG WHERE ISNULL(SUB_SECTION  ,0) =1)  
		BEGIN  
			SET @CIAMGEFILTER=@CIAMGEFILTER+' AND  SECTIOND.SUB_SECTION_CODE=IMAGE_INFO.SUB_SECTION_CODE '  
			SET @CIAMGEFILTER1=@CIAMGEFILTER1+(CASE WHEN @CIAMGEFILTER1<>'' THEN ',' ELSE '' END)+'SECTIOND.SUB_SECTION_CODE'  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'SECTIOND.SUB_SECTION_CODE'     
		END  
		ELSE  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'''0000000'' AS SUB_SECTION_CODE'  

		IF EXISTS (SELECT TOP 1 'U' FROM IMAGE_INFO_CONFIG WHERE ISNULL(SECTION   ,0) =1)  
		BEGIN  
			SET @CIAMGEFILTER=@CIAMGEFILTER+' AND  SECTIONM.SECTION_CODE=IMAGE_INFO.SECTION_CODE '  
			SET @CIAMGEFILTER1=@CIAMGEFILTER1+(CASE WHEN @CIAMGEFILTER1<>'' THEN ',' ELSE '' END)+'SECTIONM.SECTION_CODE'  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'SECTIONM.SECTION_CODE'  
		END  
		ELSE  
			SET @CIAMGE_INFO_COLUMNS=@CIAMGE_INFO_COLUMNS+(CASE WHEN @CIAMGE_INFO_COLUMNS<>'' THEN ',' ELSE '' END)+'''0000000'' AS SECTION_CODE'  

	END  
    -- SELECT ''''''
    PRINT   'ROHIT '+@CIAMGEFILTER1 
    IF REPLACE(@CIAMGEFILTER1,'''','')=''
	    GOTO LBLLAST
	IF OBJECT_ID('TEMPDB..#KRR','U') IS NOT NULL  
		DROP TABLE #KRR  
		
	CREATE TABLE #KRR(PCODE VARCHAR(MAX) )  
		

	--IF @NMODE=3      
	BEGIN      
	  
		SET @NSTEP=35  
		SET @TMP_PRODUCT_CODE='KRR'  
		SET @DTSQL=N'  
		SELECT PRODUCT_CODE  
		FROM  
		(  
		SELECT ROW_NUMBER() OVER (PARTITION BY '+@CIAMGEFILTER1+' ORDER BY '+@CIAMGEFILTER1+') AS SRNO,SKU.PRODUCT_CODE   
		FROM SKU (NOLOCK)      
		JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE  
		JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE      
		JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE      
		JOIN PARA1  (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE      
		JOIN PARA2  (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE      
		JOIN PARA3  (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE      
		JOIN PARA4  (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE      
		JOIN PARA5  (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE      
		JOIN PARA6  (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE     
		JOIN  
		(  
			SELECT PRODUCT_CODE ,INV_DT  AS MEMO_DT
			FROM IND01106 A (NOLOCK)   
			JOIN INM01106 B (NOLOCK)  ON B.INV_ID=A.INV_ID  
			WHERE A.PRODUCT_CODE<>'''' AND B.INV_MODE=2  AND B.party_dept_id='''+@LOC_ID+'''
			GROUP BY A.PRODUCT_CODE ,INV_DT
			UNION
			SELECT A.PRODUCT_CODE  ,MRR_DT  AS MEMO_DT
			FROM PID01106 A (NOLOCK)   
			JOIN PIM01106 B (NOLOCK)  ON B.MRR_ID=A.MRR_ID  
			WHERE A.PRODUCT_CODE<>'''' AND B.PUR_FOR_DEPT_ID='''+@LOC_ID+'''
			GROUP BY A.PRODUCT_CODE ,MRR_DT 
			
		)Z ON Z.PRODUCT_CODE=SKU.PRODUCT_CODE    
		JOIN '+DB_NAME()+'_IMAGE..IMAGE_INFO  IMAGE_INFO  (NOLOCK) ON  '+ @CIAMGEFILTER +       
		' WHERE ISNULL(IMAGE_INFO.DEPT_ID,'''')<>'''+@LOC_ID+'''
		AND (ISNULL(IMAGE_INFO.LAST_UPDATE,'''')>='''+@DT_CR+''' OR ISNULL(Z.MEMO_DT,'''')>'''+@DT_CR+''')
		)X WHERE X.SRNO=1  
		ORDER BY PRODUCT_CODE'     
		--MRR_CREATION_DEPT_ID='''+ @CCURLOCID + '''  
		PRINT @DTSQL  
		INSERT INTO #KRR(PCODE)       
		EXEC SP_EXECUTESQL @DTSQL  

		SET @TMP_PRODUCT_CODE='KRR1'  
		IF @BNEWIMAGEMETHOD=1  
		BEGIN  
			SET @CTABLENAME='IMAGE_INFO'  
			SET @CTEMPMASTERTABLE=@CTEMPDBNAME + '[TMP_IMG_'+@CTABLENAME+'_'+LTRIM(RTRIM(REPLACE(@TMP_PRODUCT_CODE,'-','_')))+']'  
			SET @CKEYFIELD='IMAGE_NAME'  

			SET @DTSQL=N'IF OBJECT_ID('''+@CTEMPMASTERTABLE+''',''U'') IS NOT NULL    
						 DROP TABLE '+@CTEMPMASTERTABLE+''  
			EXEC SP_EXECUTESQL @DTSQL 
			 
			SET @DTSQL=N'SELECT DISTINCT IMAGE_INFO.IMG_ID 
			INTO '+@CTEMPMASTERTABLE+'    
			FROM SKU (NOLOCK)      
			JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE   
			JOIN PARA1 (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE   
			JOIN PARA2 (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE  
			JOIN PARA3 (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE    
			JOIN PARA4 (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE  
			JOIN PARA5 (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE  
			JOIN PARA6 (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE  
			JOIN '+DB_NAME()+'_IMAGE..IMAGE_INFO  IMAGE_INFO (NOLOCK) ON  '+@CIAMGEFILTER+   
			' WHERE SKU.PRODUCT_CODE IN (SELECT * FROM #KRR)'  
			PRINT @DTSQL      
			EXEC SP_EXECUTESQL @DTSQL  
			SET @TMP_PRODUCT_CODE='KRR'  
		END       

		                  
		GOTO LBLLAST        
	END      
	               
	          
	END TRY        
	      
	BEGIN CATCH        
		
		SET @CERRORMSG='P:SP_GETIMAGE_MIRROR, STEP:'+@NSTEP+', MESSAGE:'+ERROR_MESSAGE()        
		print 'enter catch'+@cErrormsg
		GOTO LBLLAST        
	END CATCH        
      
LBLLAST:       
     PRINT 'ROHIT'  
     IF ISNULL(@CTEMPMASTERTABLE,'')<>''  
     BEGIN  
		SET @DTSQL=N'IF OBJECT_ID('''+ISNULL(@CTEMPMASTERTABLE,'')+''',''U'') IS NOT NULL  
		BEGIN  
		SELECT IMG_ID,FILENAME=IMG_ID, ERRORMSG='''+ISNULL(@CERRORMSG,'')+''' FROM '+ISNULL(@CTEMPMASTERTABLE,'') +  
		'END'  
		PRINT @DTSQL  
		EXEC SP_EXECUTESQL @DTSQL  
     END  
	 ELSE  
	 BEGIN  
		SELECT IMG_ID='',FILENAME='', ERRORMSG=''  WHERE 1=2
	 END   
    
	SET @DTSQL = N'IF OBJECT_ID( ''' + @CTEMPMASTERTABLE + ''',''U'') IS NOT NULL  
	DROP TABLE ' + @CTEMPMASTERTABLE  
	--EXEC SP_EXECUTESQL @DTSQL  
END