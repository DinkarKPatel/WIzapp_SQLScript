CREATE VIEW VW_BUYPLAN_PENDENCY
AS

SELECT SECTION_NAME,SUB_SECTION_NAME,
ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,
SUM(CAL_PP) AS PURCHASE_PRICE,SUM(CAL_RSP) AS RSP,BUY_PLAN_MEMO_NO,BUY_PLAN_MEMO_DATE,
SUM(CAL_BUY_PLAN_QUANTITY)CAL_BUY_PLAN_QUANTITY,
SUM(CAL_PO_QUANTITY)CAL_PO_QUANTITY,
SUM(CAL_GRN_QUANTITY) CAL_GRN_QUANTITY,
CONVERT(NUMERIC(10,2),ISNULL(SUM(T.CAL_PP*T.CAL_BUY_PLAN_QUANTITY),0)) AS CAL_BUY_PLAN_VALUE_AT_PP,
CONVERT(NUMERIC(10,2),ISNULL(SUM(T.CAL_RSP * T.CAL_BUY_PLAN_QUANTITY),0)) AS CAL_BUY_PLAN_VALUE_AT_RSP,
CONVERT(NUMERIC(10,2),ISNULL(SUM(T.CAL_PO_VALUE_AT_PP),0)) AS CAL_PO_VALUE_AT_PP,
CONVERT(NUMERIC(10,2),ISNULL(SUM(T.CAL_PO_VALUE_AT_RSP),0)) AS CAL_PO_VALUE_AT_RSP,
CONVERT(NUMERIC(10,2),ISNULL(SUM(T.CAL_GRN_VALUE_AT_PP),0)) AS CAL_GRN_VALUE_AT_PP,
CONVERT(NUMERIC(10,2),ISNULL(SUM(T.CAL_GRN_VALUE_AT_RSP),0)) AS CAL_GRN_VALUE_AT_RSP


FROM 
(
SELECT B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,B.PARA3_CODE,B.PARA4_CODE,
B.PARA5_CODE,B.PARA6_CODE,   B.PURCHASE_PRICE AS CAL_PP,B.MRP AS CAL_RSP,
A.MEMO_NO AS BUY_PLAN_MEMO_NO,CAST(A.MEMO_DT AS DATE) AS BUY_PLAN_MEMO_DATE,
ISNULL(B.QUANTITY,0) AS CAL_BUY_PLAN_QUANTITY,
ISNULL(W.PO_QUANTITY,0) AS CAL_PO_QUANTITY,
ISNULL(Z.GRN_QUANTITY,0) AS CAL_GRN_QUANTITY,
B.QUANTITY,

CONVERT(NUMERIC(10,2),ISNULL((W.PO_VALUE_AT_PP),0)) AS CAL_PO_VALUE_AT_PP,
CONVERT(NUMERIC(10,2),ISNULL((W.PO_VALUE_AT_RSP),0)) AS CAL_PO_VALUE_AT_RSP,
CONVERT(NUMERIC(10,2),ISNULL((Z.GRN_VALUE_AT_PP),0)) AS CAL_GRN_VALUE_AT_PP,
CONVERT(NUMERIC(10,2),ISNULL((Z.GRN_VALUE_AT_RSP),0)) AS CAL_GRN_VALUE_AT_RSP

FROM BUY_PLAN_MST A(NOLOCK)
JOIN BUY_PLAN_DET B(NOLOCK) ON A.MEMO_NO=B.MEMO_NO

LEFT JOIN 
(
SELECT A.BUY_PLAN_ROW_ID,SUM(A.QUANTITY) AS PO_QUANTITY,
SUM(A.QUANTITY * A.PURCHASE_PRICE) AS PO_VALUE_AT_PP, 
SUM(A.QUANTITY * A.MRP) AS PO_VALUE_AT_RSP 

FROM POD01106 A (NOLOCK) 
JOIN POM01106 B(NOLOCK) ON A.PO_ID=B.PO_ID
JOIN BUY_PLAN_DET C (NOLOCK) ON C.ROW_ID=A.BUY_PLAN_ROW_ID
JOIN BUY_PLAN_MST D (NOLOCK) ON D.MEMO_NO=C.MEMO_NO
WHERE B.CANCELLED=0 AND D.CANCELLED=0
GROUP BY  A.BUY_PLAN_ROW_ID
)W ON B.ROW_ID=W.BUY_PLAN_ROW_ID

LEFT JOIN 
(
SELECT C.BUY_PLAN_ROW_ID,SUM(A.QUANTITY) AS GRN_QUANTITY,
SUM(A.QUANTITY * SKU.PURCHASE_PRICE) AS GRN_VALUE_AT_PP, 
SUM(A.QUANTITY * SKU.MRP) AS GRN_VALUE_AT_RSP 

FROM GRN_PS_DET A (NOLOCK) 
JOIN GRN_PS_MST B(NOLOCK) ON A.MEMO_ID=B.MEMO_ID
JOIN POD01106 C (NOLOCK) ON C.ROW_ID=A.PO_ROW_ID
JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
JOIN POM01106 D(NOLOCK) ON D.PO_ID=C.PO_ID
WHERE B.CANCELLED=0 AND D.CANCELLED=0
GROUP BY  C.BUY_PLAN_ROW_ID
)Z ON B.ROW_ID=Z.BUY_PLAN_ROW_ID
)T
JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=T.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM(NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1(NOLOCK) ON PARA1.PARA1_CODE=T.PARA1_CODE
JOIN PARA2(NOLOCK) ON PARA2.PARA2_CODE=T.PARA2_CODE
JOIN PARA3(NOLOCK) ON PARA3.PARA3_CODE=T.PARA3_CODE
JOIN PARA4(NOLOCK) ON PARA4.PARA4_CODE=T.PARA4_CODE
JOIN PARA5(NOLOCK) ON PARA5.PARA5_CODE=T.PARA5_CODE
JOIN PARA6(NOLOCK) ON PARA6.PARA6_CODE=T.PARA6_CODE

GROUP BY
BUY_PLAN_MEMO_NO,BUY_PLAN_MEMO_DATE,
ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,
SECTION_NAME,SUB_SECTION_NAME
