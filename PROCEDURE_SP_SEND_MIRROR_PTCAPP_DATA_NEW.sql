CREATE PROCEDURE SP_SEND_MIRROR_PTCAPP_DATA_NEW
(
 @CUPLOADEDXNID AS VARCHAR(50)='',
 @CCURLOCID VARCHAR(5),
 @BACKNOWLEDGE BIT=0,
 @COUTPUT VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
     DECLARE @DTSQL NVARCHAR(MAX),@CERRMSG VARCHAR(500),@CSTEP VARCHAR(100),
     @CMEMOID VARCHAR(100),@DMEMOLASTUPDATE DATETIME,@CTEMPDBNAME VARCHAR(100),
     @CTEMPTABLENAME VARCHAR(100),@CTEMPPEDTABLENAME VARCHAR(100)
     
     SET @CTEMPDBNAME=''	
     SET @CTEMPTABLENAME='PED_XN_APPROVAL'
     SET @CTEMPPEDTABLENAME='PED01106'

  BEGIN TRY
      SET @CSTEP=00
	     IF @CUPLOADEDXNID<>''
	     GOTO LBLTABLEINFO
	  
	    DECLARE @IMAXLEVEL INT
			--GETTING THE MAX LEVEL OF APPROVAL FOR PURCHASE TRANSACTION
	   SELECT @IMAXLEVEL=MAX(LEVEL_NO) FROM XN_APPROVAL_CHECKLIST_LEVELS WHERE XN_TYPE='PTC' 
	   SET @IMAXLEVEL=ISNULL(@IMAXLEVEL,0)
      
	 LBLTABLEINFO:
	   SET @CSTEP=30
	  --CHNAGE BY BAIJNATH
	  SET @CMEMOID=@CUPLOADEDXNID
      IF ISNULL(@CMEMOID,'')=''
	     GOTO END_PROC
	  SET @CSTEP=40  


	  SELECT PED01106.*,'PTCAPP_PED01106_UPLOAD' AS TARGET_TABLENAME FROM PED01106 WHERE pem_memo_id=@CMEMOID
      

	  SELECT B.*,'PTCAPP_PTCBills_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS PTCAPP_MEMO_ID FROM PED01106 A
	  JOIN PTCBills B (NOLOCK) ON A.row_id =B.PED_ROW_ID 
	  WHERE pem_memo_id=@CMEMOID

      
  END TRY
    BEGIN CATCH
	SET @CERRMSG='P: SP_SEND_MIRROR_PTCAPP_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
  END CATCH 
		
  END_PROC:
	PRINT 'END OF PROC:'+@CUPLOADEDXNID
	
END
