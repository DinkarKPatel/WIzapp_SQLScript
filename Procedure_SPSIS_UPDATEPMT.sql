CREATE PROCEDURE SPSIS_UPDATEPMT
(
   @CSPID VARCHAR(50)=''
)
AS
BEGIN
    
	IF EXISTS (SELECT TOP 1 'U' FROM SAVETRAN_BARCODE_NETQTY A (NOLOCK)
	          LEFT JOIN PMT01106 B (NOLOCK) ON A.DEPT_ID =B.DEPT_ID AND A.PRODUCT_CODE =B.product_code AND A.BIN_ID =B.BIN_ID 
			  WHERE B.product_code IS NULL AND A.SP_ID=@CSPID)
	BEGIN
	    
		 INSERT PMT01106	( BIN_ID, DEPT_ID, last_update, product_code, quantity_in_stock )  
		 SELECT DISTINCT 	A.BIN_ID, A.DEPT_ID, GETDATE() last_update, A.product_code, 0 quantity_in_stock
		 FROM SAVETRAN_BARCODE_NETQTY A (NOLOCK)
	     LEFT JOIN PMT01106 B (NOLOCK) ON A.DEPT_ID =B.DEPT_ID AND A.PRODUCT_CODE =B.product_code AND A.BIN_ID =B.BIN_ID 
		 WHERE B.product_code IS NULL AND A.SP_ID=@CSPID

	END


	UPDATE A SET QUANTITY_IN_STOCK =A.QUANTITY_IN_STOCK +ISNULL(B.XN_QTY,0) ,last_update=GETDATE()
	FROM PMT01106 A (NOLOCK)
	JOIN
	(
       SELECT DEPT_ID,BIN_ID, PRODUCT_CODE,
	           SUM(XN_QTY) AS XN_QTY
	   FROM SAVETRAN_BARCODE_NETQTY A (NOLOCK)
	   WHERE A.SP_ID=@CSPID
	   GROUP BY DEPT_ID,BIN_ID, PRODUCT_CODE
	) B ON A.DEPT_ID=B.DEPT_ID AND A.BIN_ID=B.BIN_ID AND A.PRODUCT_CODE =B.PRODUCT_CODE


	delete a from SAVETRAN_BARCODE_NETQTY a (nolock) where A.SP_ID=@CSPID


END