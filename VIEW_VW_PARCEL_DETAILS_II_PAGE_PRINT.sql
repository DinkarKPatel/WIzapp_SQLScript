CREATE  VIEW VW_PARCEL_DETAILS_II_PAGE_PRINT  
  
AS    


SELECT   PM.PARCEL_MEMO_NO,PM.PARCEL_MEMO_ID AS MEMO_ID,'01'+DBO.FN_GETFINYEAR(PM.PARCEL_MEMO_DT) AS FIN_YEAR,CONVERT(VARCHAR,PM.PARCEL_MEMO_DT,105) AS PARCEL_MEMO_DT,
	       CONVERT(VARCHAR,PM.RECEIPT_DT,105) AS RECEIPT_DT,LM.AC_NAME,
	       CANCELLED=CASE WHEN PM.CANCELLED <>0 THEN 'CANCELLED' ELSE '' END,
	       PM.ANG_TYPE,
		  PM.DEPT_ID,PM.COMPANY_CODE,US.USERNAME,EU.USERNAME AS EDIT_USERNAME
		  ,PM.PAY_TYPE,PM.CASH_RECEIPT_NO,PM.BILTY_NO,PM.REMARKS AS MST_REMARKS
		  ,PM.XN_TYPE,(CASE WHEN PM.MODE=1 THEN 'OUTWARD' ELSE 'INWARD' END) AS MODE
		  ,AM.ANGADIA_NAME AS TRANSPORTER 
		  ,UOM.UOM_NAME
		  ,PD.GOODS_DESC,PD.REMARKS AS DET_REMARKS
		  ,(CASE WHEN ISNULL( C.REF_MEMO_ID,'') = '' THEN 'UNOPENED' ELSE 'OPENED' END) AS STATUS 
		  ,C.REF_MEMO_ID
		  ,'' as REF_MEMO_NO 
		  ,C.TOTAL_BOXES  
		  ,pD.party_inv_no as BILL_CHALLAN_NO
		  ,(CASE WHEN PM.CANCELLED=0 THEN PD.QUANTITY ELSE 0 END) AS QUANTITY 
		  ,(CASE WHEN PM.CANCELLED=0 THEN PD.QTY ELSE 0 END) AS WEIGHT 
		   ,(CASE WHEN PM.CANCELLED=0 THEN  PM.TOTAL_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT 
	FROM PARCEL_MST PM (NOLOCK)
	JOIN PARCEL_DET PD (NOLOCK) ON PM.PARCEL_MEMO_ID=PD.PARCEL_MEMO_ID
	LEFT JOIN
	(
		SELECT A.PARCEL_MEMO_ID,
			   0 AS TOTAL_BOXES,
			   REF_MEMO_ID=(SELECT STUFF((SELECT CASE WHEN ISNULL(REF_MEMO_ID,'') <> '' THEN ' , ' ELSE '' END +REF_MEMO_ID FROM parcel_det  B  WHERE A.PARCEL_MEMO_ID =B.PARCEL_MEMO_ID GROUP BY REF_MEMO_ID  FOR XML PATH('')),1,2,''))
			   
		FROM  parcel_det  A
		GROUP BY A.PARCEL_MEMO_ID
	)C ON PM.PARCEL_MEMO_ID=C.PARCEL_MEMO_ID
	JOIN LM01106 LM (NOLOCK) ON PD.AC_CODE=LM.AC_CODE
	JOIN ANGM AM (NOLOCK) ON PM.ANGADIA_CODE=AM.ANGADIA_CODE
	JOIN LOCATION LN (NOLOCK) ON LN.DEPT_ID=PM.DEPT_ID
	JOIN USERS US (NOLOCK) ON PM.USER_CODE=US.USER_CODE
	JOIN USERS EU (NOLOCK) ON PM.EDT_USER_CODE=EU.USER_CODE
	JOIN UOM (NOLOCK) ON PD.UOM_CODE=UOM.UOM_CODE
	 --WHERE  ( PM.PARCEL_MEMO_DT BETWEEN '2017-04-01' AND '2018-03-31')
