CREATE PROCEDURE SP3S_EOSS_GETDISCOUNTS--(LocId 3 digit change by Sanjay:05-11-2024)
@BSALESSETUPINEFFECT BIT,
@DXNDT DATETIME,
@CUSERCODE CHAR(7)='',
@CCUSTOMERCODE VARCHAR(15)='',
@BGETBCDISC BIT,
@BMANUALBILL BIT=0,
@CLOCATIONID VARCHAR(5)='',
@BMANUALCMMDISC BIT=0,
@BCALLEDFROMCASHMEMO BIT=0,
@BWIZCLIPCUSTOMER BIT=0,
@NSPID VARCHAR(40)='0',
@BCALLEDFROMPACKSLIP BIT=0,	
@CPOSSCHEMEECOUPONID VARCHAR(20)='',
@CERRORMSG VARCHAR(MAX) OUTPUT
AS
BEGIN

	 PRINT 'ENTER  EOSS GETDISCOUNTS-PLEASE-1'  	 

  	 DECLARE @COUTPUTVAR VARCHAR(100),@CPICKSLRDISCMODE VARCHAR(5),@CPRODUCTCODE VARCHAR(100),
  	 @CSUBSECTIONCODE VARCHAR(10),@CCMDROWID VARCHAR(100),@NXNQTY NUMERIC(10,2),@NMRP NUMERIC(10,2),
  	 @NDISCPCT NUMERIC(7,3),@CROUNDITEMLEVEL VARCHAR(5),@CCURDEPTID VARCHAR(5),@CHODEPTID VARCHAR(5),
  	 @NORDER INT,@NFILTERMODE INT,@NGETFILTERMODE INT,@CJOINSTRBUY VARCHAR(MAX),@CJOINSTRGET VARCHAR(MAX),
  	 @CADDFILTER VARCHAR(MAX),@BAPPLYEXCLTAXONDISCITEMS BIT,@CTOPVARIABLE VARCHAR(100),@NSCHEMEMODE INT,
  	 @CCMDPRODUCTCODE VARCHAR(50),@DISC_METHOD INT,@NNET NUMERIC(14,2),@DISC_FIGURE NUMERIC(10,2),@NDISC NUMERIC(10,2),
  	 @NSCHEMEQTY NUMERIC(10,3),@CSCHEMEDETROWID VARCHAR(100),@CBUNDLEID CHAR(7),@CSCHEMENAME VARCHAR(500),
  	 @CCMD NVARCHAR(MAX),@CPROCNAME VARCHAR(200),@BRETVAL BIT,@CFILTERJOINSTR VARCHAR(MAX),@CFILTER VARCHAR(MAX),
  	 @DISCOUNT_PERCENTAGE1 NUMERIC(10,3),@DISCOUNT_PERCENTAGE2 NUMERIC(10,3),@DISCOUNT_PERCENTAGE3 NUMERIC(10,3),
	 @NNETPRICE NUMERIC(10,2),@NDISCAMT NUMERIC(10,2),@D_FILTER VARCHAR(MAX),@NEFFECTIVEDISCPCT NUMERIC(7,3),
	 @CSCHEMEMEMONO VARCHAR(100),@BCHECKONLYVALUEBASEDSCHEME BIT,@BVALUEBASEDSCHEME BIT,@CPCFOUND VARCHAR(100),
	 @NSTEP VARCHAR(20),@BDEBUGMODE BIT,@CSTR VARCHAR(200),@NBASEVALUE NUMERIC(10,2),
	 @BFOUND BIT,@NCURRENTDISCAMT NUMERIC(10,2),@NLASTSLRDISCPCT NUMERIC(6,2),@NLASTSLRDISCAMT NUMERIC(10,2),
	 @NADDNLDISCPCT NUMERIC(6,2),@NSUBTOTAL NUMERIC(10,2),@CPROMOTIONALSCHEMEID VARCHAR(10),@CGROUPCODE VARCHAR(20),
	 @COPTSEARCHPARANAME VARCHAR(100),@NMEMOORDER NUMERIC(4,0),@BFLAG BIT,@CPICKDISCONBARCODESCAN VARCHAR(4),
	 @CMANUALSCHEMESETMEMONO VARCHAR(20)
	 	 
	 IF @NSPID='0'
		SET @NSPID=@@SPID
	 
	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP
BEGIN TRY
		
	 SELECT @BDEBUGMODE=1 
	 SELECT TOP 1 @CPICKDISCONBARCODESCAN=LTRIM(RTRIM(VALUE)) FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='PICK_DISC_DURING_SCANNING'
			 
	 SET @NSTEP = 10
	 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	 
	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP
	
	IF @CLOCATIONID=''
		SELECT @CCURDEPTID=DEPT_ID FROM NEW_APP_LOGIN_INFO (NOLOCK) WHERE SPID=@@SPID
	ELSE
		SET @CCURDEPTID=@CLOCATIONID
	
	IF ISNULL(@CCURDEPTID,'')=''
	BEGIN
		SET @CERRORMSG='LOCATION ID CANNOT FOUND BLANK FOR SPID:'+STR(@@SPID)+' WHILE APPLYING SCHEME'
		GOTO EXIT_PROC
	END
		
	DECLARE @CENABLEOPTIMIZEDSCHEMES VARCHAR(4)
	SELECT TOP 1 @CENABLEOPTIMIZEDSCHEMES=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_OPTIMIZED_EOSS_SCHEMES'		

	SET @NSTEP = 10.2
	 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	 
	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP
	SELECT DISTINCT A.SCHEME_SETUP_DET_ROW_ID,PRODUCT_CODE,CONVERT(BIT,0) GET_BC INTO #TMPSKUACTIVETITLES FROM SKU_ACTIVE_TITLES A (NOLOCK) WHERE 1=2
	SELECT DISTINCT A.SCHEME_SETUP_DET_ROW_ID INTO #TMPACTIVETITLES FROM SKU_ACTIVE_TITLES A (NOLOCK) WHERE 1=2
	 SET @NSTEP = 10.5
	 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	 
	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP	
	SET @CMANUALSCHEMESETMEMONO=''
	SELECT TOP 1 @CMANUALSCHEMESETMEMONO=ISNULL(MANUAL_SCHEME_SETUP_MEMO_NO,'')
	FROM SLS_CMM01106_UPLOAD (NOLOCK) WHERE SP_ID=@NSPID

	SELECT PRODUCT_CODE,CMD_ROW_ID,DISCOUNT_PERCENTAGE, DISCOUNT_AMOUNT,convert(numeric(7,2),0)  last_packslip_sls_DISCOUNT_PERCENTAGE,
	convert(numeric(10,2),0)  as last_packslip_sls_DISCOUNT_AMount,QUANTITY INTO #TMPSLRDISC
	FROM #TMPCMD A WHERE 1=2


	IF @BCALLEDFROMPACKSLIP=1
	BEGIN
	 	INSERT #TMPSLRDISC (PRODUCT_CODE,CMD_ROW_ID,DISCOUNT_PERCENTAGE, DISCOUNT_AMOUNT,last_packslip_sls_DISCOUNT_PERCENTAGE,last_packslip_sls_DISCOUNT_AMOUNT, QUANTITY)
		SELECT PRODUCT_CODE,CMD_ROW_ID,(CASE WHEN isnull(weighted_avg_disc_pct,0)<>0 THEN weighted_avg_disc_pct ELSE DISCOUNT_percentage end),
		(CASE WHEN isnull(weighted_avg_disc_amt,0)<>0 THEN weighted_avg_disc_amt ELSE DISCOUNT_AMOUNT end),A.DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,QUANTITY
		FROM #TMPCMD A  WHERE A.QUANTITY<0 
	END

	SET @CENABLEOPTIMIZEDSCHEMES=ISNULL(@CENABLEOPTIMIZEDSCHEMES,'')

	IF ISNULL(@CENABLEOPTIMIZEDSCHEMES,'')='1'
	BEGIN
		 SET @NSTEP = 10.8
	 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	 
	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP
		INSERT INTO #TMPSKUACTIVETITLES (PRODUCT_CODE,SCHEME_SETUP_DET_ROW_ID,GET_BC)
		SELECT DISTINCT T.PRODUCT_CODE,A.SCHEME_SETUP_DET_ROW_ID,0 GET_BC FROM SKU_ACTIVE_TITLES A (NOLOCK)
		JOIN SCHEME_SETUP_DET B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
		JOIN SCHEME_SETUP_MST C (NOLOCK) ON C.MEMO_NO=B.MEMO_NO
		JOIN #TMPCMD T ON T.PRODUCT_CODE=A.PRODUCT_CODE
		LEFT OUTER JOIN SCHEME_SETUP_LOC D (NOLOCK) ON D.MEMO_NO=C.MEMO_NO
		WHERE (D.DEPT_ID=@CCURDEPTID OR D.MEMO_NO IS NULL)
		AND (ISNULL(B.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR 
		    ( @BWIZCLIPCUSTOMER=1 AND (VALIDATESCHEME_WIZCLIP_MODE<>2 OR @CPOSSCHEMEECOUPONID<>'')))
		AND @DXNDT BETWEEN C.APPLICABLE_FROM_DT AND C.APPLICABLE_TO_DT	
		AND C.INACTIVE=0 AND (C.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')

		INSERT INTO #TMPSKUACTIVETITLES (PRODUCT_CODE,SCHEME_SETUP_DET_ROW_ID,GET_BC)
		SELECT DISTINCT T.PRODUCT_CODE,A.SCHEME_SETUP_DET_ROW_ID,1 GET_BC FROM SKU_ACTIVE_TITLES_GET A (NOLOCK)
		JOIN SCHEME_SETUP_DET B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
		JOIN SCHEME_SETUP_MST C (NOLOCK) ON C.MEMO_NO=B.MEMO_NO
		JOIN #TMPCMD T ON T.PRODUCT_CODE=A.PRODUCT_CODE
		LEFT OUTER JOIN SCHEME_SETUP_LOC D (NOLOCK) ON D.MEMO_NO=C.MEMO_NO
		WHERE (D.DEPT_ID=@CCURDEPTID OR D.MEMO_NO IS NULL)
		AND (ISNULL(B.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR 
		    ( @BWIZCLIPCUSTOMER=1 AND (VALIDATESCHEME_WIZCLIP_MODE<>2 OR @CPOSSCHEMEECOUPONID<>'')))
		AND @DXNDT BETWEEN C.APPLICABLE_FROM_DT AND C.APPLICABLE_TO_DT	
		AND C.INACTIVE=0 AND (C.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')
		
			 SET @NSTEP = 12.2
	 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	 
	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP
		INSERT INTO #TMPSKUACTIVETITLES (PRODUCT_CODE,SCHEME_SETUP_DET_ROW_ID,GET_BC)
		SELECT DISTINCT A.PRODUCT_CODE,A.SCHEME_SETUP_DET_ROW_ID,0 GET_BC FROM SKU_ACTIVE_TITLES A (NOLOCK)
		JOIN SCHEME_SETUP_DET B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
		JOIN SCHEME_SETUP_MST C (NOLOCK) ON C.MEMO_NO=B.MEMO_NO
		JOIN #TMPCMD T ON LEFT(T.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',T.PRODUCT_CODE)-1,-1),LEN(T.PRODUCT_CODE )))=A.PRODUCT_CODE
		LEFT OUTER JOIN SCHEME_SETUP_LOC D (NOLOCK) ON D.MEMO_NO=C.MEMO_NO
		WHERE (D.DEPT_ID=@CCURDEPTID OR D.MEMO_NO IS NULL)
		AND (ISNULL(B.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR 
		    ( @BWIZCLIPCUSTOMER=1 AND (VALIDATESCHEME_WIZCLIP_MODE<>2 OR @CPOSSCHEMEECOUPONID<>'')))
		AND @DXNDT BETWEEN C.APPLICABLE_FROM_DT AND C.APPLICABLE_TO_DT	
		AND C.INACTIVE=0 AND CHARINDEX('@',T.PRODUCT_CODE)>0
		AND (C.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')

			 SET @NSTEP = 12.6
	 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	 
	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP
		INSERT INTO #TMPSKUACTIVETITLES (PRODUCT_CODE,SCHEME_SETUP_DET_ROW_ID,GET_BC)
		SELECT DISTINCT A.PRODUCT_CODE,A.SCHEME_SETUP_DET_ROW_ID,1 GET_BC FROM SKU_ACTIVE_TITLES_GET A (NOLOCK)
		JOIN SCHEME_SETUP_DET B (NOLOCK) ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
		JOIN SCHEME_SETUP_MST C (NOLOCK) ON C.MEMO_NO=B.MEMO_NO
		JOIN #TMPCMD T ON LEFT(T.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',T.PRODUCT_CODE)-1,-1),LEN(T.PRODUCT_CODE )))=A.PRODUCT_CODE
		LEFT OUTER JOIN SCHEME_SETUP_LOC D (NOLOCK) ON D.MEMO_NO=C.MEMO_NO
		WHERE (D.DEPT_ID=@CCURDEPTID OR D.MEMO_NO IS NULL)
		AND (ISNULL(B.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR 
		    ( @BWIZCLIPCUSTOMER=1 AND (VALIDATESCHEME_WIZCLIP_MODE<>2 OR @CPOSSCHEMEECOUPONID<>'')))
		AND @DXNDT BETWEEN C.APPLICABLE_FROM_DT AND C.APPLICABLE_TO_DT	
		AND C.INACTIVE=0 AND CHARINDEX('@',T.PRODUCT_CODE)>0
		AND (C.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')

		--- HAD TO CONSIDER THIS SPECIAL CASE BECAUSE SKU_ACTIVE_TITLES BUILD CHANGE PENDING FOR PARAS COMBINATION TYPE OF SCHEME

		 SET @NSTEP = 13.2
		 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	 
		 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP
		INSERT INTO #TMPSKUACTIVETITLES (PRODUCT_CODE,SCHEME_SETUP_DET_ROW_ID)
		SELECT '',A.ROW_ID SCHEME_SETUP_DET_ROW_ID FROM SCHEME_SETUP_DET A (NOLOCK)
		JOIN SCHEME_SETUP_MST C (NOLOCK) ON C.MEMO_NO=A.MEMO_NO
		LEFT OUTER JOIN SCHEME_SETUP_LOC D (NOLOCK) ON D.MEMO_NO=C.MEMO_NO
		LEFT JOIN #TMPSKUACTIVETITLES SAT ON SAT.SCHEME_SETUP_DET_ROW_ID=A.ROW_ID
		WHERE (D.DEPT_ID=@CCURDEPTID OR D.MEMO_NO IS NULL)
		AND (ISNULL(A.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR 
		    ( @BWIZCLIPCUSTOMER=1 AND (VALIDATESCHEME_WIZCLIP_MODE<>2 OR @CPOSSCHEMEECOUPONID<>'')))
		AND @DXNDT BETWEEN C.APPLICABLE_FROM_DT AND C.APPLICABLE_TO_DT	
		AND C.INACTIVE=0 AND (C.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')
		AND (FILTER_MODE=6 OR GET_FILTER_MODE=6)
		AND SAT.PRODUCT_CODE IS NULL
	END
	ELSE
	BEGIN
		 SET @NSTEP = 14.1
	 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	 
	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP
		INSERT INTO #TMPSKUACTIVETITLES (PRODUCT_CODE,SCHEME_SETUP_DET_ROW_ID)
		SELECT A.PRODUCT_CODE,B.ROW_ID FROM  
		SCHEME_SETUP_DET B (NOLOCK)
		JOIN SCHEME_SETUP_MST C (NOLOCK) ON C.MEMO_NO=B.MEMO_NO
		LEFT OUTER JOIN SCHEME_SETUP_LOC D (NOLOCK) ON D.MEMO_NO=C.MEMO_NO,#TMPCMD A
		WHERE (D.DEPT_ID=@CCURDEPTID OR D.MEMO_NO IS NULL OR LOC_APPLICABLE_MODE=1)
		AND (ISNULL(B.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR 
		    ( @BWIZCLIPCUSTOMER=1 AND (VALIDATESCHEME_WIZCLIP_MODE<>2 OR @CPOSSCHEMEECOUPONID<>'')))
		AND @DXNDT BETWEEN C.APPLICABLE_FROM_DT AND C.APPLICABLE_TO_DT	
		AND C.INACTIVE=0
		AND (C.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')
	END
	
		 SET @NSTEP = 15.6
	 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	 

	 --IF @@SPID=138
		--SELECT 'CHECK TMPSKUACT',* FROM #TMPSKUACTIVETITLES

	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP
	INSERT #TMPACTIVETITLES
	SELECT DISTINCT SCHEME_SETUP_DET_ROW_ID  FROM #TMPSKUACTIVETITLES

	DECLARE @CPICKROUNDITEMLEVELFROMLOC VARCHAR(4)
	SELECT TOP 1 @CPICKROUNDITEMLEVELFROMLOC = VALUE  FROM CONFIG WHERE  CONFIG_OPTION='PICK_SLS_ROUND_OFF_FROMLOC'
	
	IF ISNULL(@CPICKROUNDITEMLEVELFROMLOC,'')<>'1'
		SELECT TOP 1 @CROUNDITEMLEVEL = VALUE  FROM CONFIG WHERE  CONFIG_OPTION='SLS_ROUND_ITEM_NET'
	ELSE
		SELECT TOP 1 @CROUNDITEMLEVEL = SLS_ROUND_ITEM_LEVEL  FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CLOCATIONID

	 SET @NSTEP = 16.4
	 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	 
	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP
  	 
  	 SET @CROUNDITEMLEVEL=ISNULL(@CROUNDITEMLEVEL,'')
  	 
  	 SELECT TOP 1 @CCURDEPTID=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'
 	 SELECT TOP 1 @CHODEPTID=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'
	  	
	 IF @CLOCATIONID<>''
		SET @CCURDEPTID=@CLOCATIONID

	 SELECT TOP 1 @CPICKSLRDISCMODE=ISNULL(DISCOUNT_PICKMODE_SLR,1) FROM LOCATION WHERE DEPT_ID=@CCURDEPTID
	 
	 --- THIS IS DONE REGARDING ASKING FOR NEW OPTION OF APPLYING SALE RETURN DISCOUNT WITH 2 OPTIONS ONLY NOW (1. TOLERANCE BASED 2.MAX DISCOUNT)
	 --- PREVIOUS OPTIONS HAVE BEED DISCARDED NOW AS PER TICKIT#0523-00163 (DATE : 16-05-2023)
	 --- WE HAVE TO MANIPULATE THE NEW OPTION VALUE AS ALREADY REFERENCE OF THESE VALUE LIES IN MULTIPLE SCHEME PROCEDURES
	 --- (Date : 12-07-2023) Now taken back the option of Current Eoss also as per pressure by clients One plus and many more 
	 --- as per Sir and Sonu,Ved
	 IF ISNULL(@CPICKSLRDISCMODE,0) IN (0,1) -- (1.TOLERANCE BASED(DEFAULT) 2.MAX DISCOUNT,3. Current Scheme)
		SET @CPICKSLRDISCMODE= 3
	 ELSE
	 IF ISNULL(@CPICKSLRDISCMODE,0) IN (0,3) -- (1.TOLERANCE BASED(DEFAULT) 2.MAX DISCOUNT,3. Current Scheme)
		SET @CPICKSLRDISCMODE = 2
	 ELSE
		SET @CPICKSLRDISCMODE= 1

	 DECLARE @TBCPROCESSED TABLE (PRODUCT_CODE VARCHAR(100),CMD_ROW_ID VARCHAR(100))
	 
	 SET @BCHECKONLYVALUEBASEDSCHEME=0
	
	 SET @NSTEP = 20
	 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE

	 PRINT 'ENTER  EOSS GETDISCOUNTS-STEP#'+@NSTEP

	 PRINT 'ENTER OPTIMIZED EOSS GETDISCOUNTS-2'  	 
	 
	 --SELECT @BSALESSETUPINEFFECT AS BSALESSETUPINEFFECT	 
  	 IF @BSALESSETUPINEFFECT=1
  	 BEGIN
		
		PRINT 'ENTER STEP#'+@NSTEP
		SET @NSTEP = 30
		EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
			
		SELECT TOP 1 @BAPPLYEXCLTAXONDISCITEMS=ISNULL(EXCLUSIVE_VAT,0) FROM LOCATION WHERE DEPT_ID=@CCURDEPTID
				
		UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=0,DISCOUNT_AMOUNT=0,BASIC_DISCOUNT_PERCENTAGE=0,CARD_DISCOUNT_PERCENTAGE=0,
		BASIC_DISCOUNT_AMOUNT=0,CARD_DISCOUNT_AMOUNT=0,NET=(CASE WHEN NET<0 THEN -MRP ELSE MRP END)*ABS(QUANTITY)
				
		IF CURSOR_STATUS('GLOBAL','CMDCUR') IN (0,1)
		BEGIN
			CLOSE CMDCUR
			DEALLOCATE CMDCUR
		END
			
		SET @CTOPVARIABLE=''
		
		SET @BFLAG=0
		
		PRINT 'CHECK BAR CODE MATCH'
		
	    SET @NSTEP = 40
	    EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE


		SELECT B.ROW_ID AS SCHEME_SETUP_DET_ROW_ID
		INTO #TMPSLSBCTITLES 
		FROM SCHEME_SETUP_DET B (NOLOCK) 
				JOIN SCHEME_SETUP_MST C (NOLOCK) ON  C.MEMO_NO= B.MEMO_NO
				LEFT OUTER JOIN SCHEME_SETUP_LOC G (NOLOCK) ON G.MEMO_NO=C.MEMO_NO
				LEFT OUTER JOIN SCHEME_SETUP_HAPPYHOURS HH (NOLOCK) ON HH.MEMO_NO=B.MEMO_NO
				LEFT OUTER JOIN SCHEME_SETUP_WEEKDAYS_DETAILS WD (NOLOCK) ON WD.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID 
				AND WD.WEEKDAY_NAME=DATENAME(WEEKDAY,GETDATE())
				WHERE (G.DEPT_ID=@CCURDEPTID OR G.MEMO_NO IS NULL)
				AND @DXNDT BETWEEN C.APPLICABLE_FROM_DT AND C.APPLICABLE_TO_DT AND B.FILTER_MODE=2
				AND (ISNULL(B.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR @BWIZCLIPCUSTOMER=1)
				AND SCHEME_MODE=1 AND C.INACTIVE=0
				AND (HH.MEMO_NO IS NULL OR HAPPY_HOURS_RESTRICTION_APPLICABLE=0 OR  CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,GETDATE()))))+':'+
				LTRIM(RTRIM(STR(DATEPART(MI,GETDATE()))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,GETDATE())))))
				BETWEEN 
				CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,FROM_TIME))))+':'+
				LTRIM(RTRIM(STR(DATEPART(MI,FROM_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,FROM_TIME)))))
				AND
				CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,TO_TIME))))+':'+
				LTRIM(RTRIM(STR(DATEPART(MI,TO_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,TO_TIME))))))
				AND (ISNULL(WEEKDAY_WISE_APPLICABLE,0)=0 OR WD.SELECTED=1)
				AND (C.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')

		SELECT TOP 1 @CTOPVARIABLE=A.PRODUCT_CODE FROM SCHEME_SETUP_SLSBC A (NOLOCK)
		JOIN #TMPSLSBCTITLES B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		JOIN #TMPCMD C ON C.PRODUCT_CODE=A.PRODUCT_CODE

		--IF @@SPID=758
		--BEGIN
		--	SELECT 'CHECK BASEBC',@DXNDT XN_DT, * FROM #TMPCMDBASEBC
		--	SELECT 'CHECK TMPCMD', CMD_ROW_ID,* FROM #TMPCMD
		--	SELECT 'CHECK SKUACTIVE',* FROM #TMPSKUACTIVETITLES
		--END
		IF ISNULL(@CTOPVARIABLE,'')='' AND @BGETBCDISC=0			 
			SELECT TOP 1 @CTOPVARIABLE=A.PRODUCT_CODE FROM SCHEME_SETUP_SLSBC A (NOLOCK)
			JOIN #TMPSLSBCTITLES B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
			JOIN #TMPCMDBASEBC C ON C.PRODUCT_CODE=A.PRODUCT_CODE
									
		IF ISNULL(@CTOPVARIABLE,'')<>'' 
		BEGIN
		
			PRINT 'BAR CODE MATCH FOUND'	
			
			SET @NSTEP = 50
			EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
				
			SELECT DISTINCT T.PRODUCT_CODE,T.MRP,(T.QUANTITY-T.SCHEME_APPLIED_QTY) AS QTY,T.CMD_ROW_ID,
			D.SCHEME_NAME,A.DISCOUNT_FIGURE,A.DISCOUNT_MODE,D.ROW_ID,SCHEME_APPLIED_QTY,
			PROCESSING_ORDER,B.MEMO_NO,
			ISNULL(A.ADDITIONAL_DISCOUNT_PERCENTAGE,0) AS ADDITIONAL_DISCOUNT_PERCENTAGE,MEMO_PROCESSING_ORDER
			INTO #TMPBCSCHEMES FROM #TMPCMD T 
			JOIN SCHEME_SETUP_SLSBC A (NOLOCK)  ON T.PRODUCT_CODE=A.PRODUCT_CODE
			JOIN SCHEME_SETUP_DET D (NOLOCK) ON D.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID
			JOIN SCHEME_SETUP_MST B (NOLOCK) ON D.MEMO_NO= B.MEMO_NO
			JOIN #TMPSLSBCTITLES C (NOLOCK) ON C.SCHEME_SETUP_DET_ROW_ID=A.SCHEME_SETUP_DET_ROW_ID
			LEFT OUTER JOIN SCHEME_SETUP_LOC G (NOLOCK) ON G.MEMO_NO=D.MEMO_NO
			LEFT OUTER JOIN RPS_MST H (NOLOCK) ON H.CM_ID=T.PACK_SLIP_ID
			LEFT OUTER JOIN SCHEME_SETUP_HAPPYHOURS HH (NOLOCK) ON HH.MEMO_NO=B.MEMO_NO
			LEFT OUTER JOIN SCHEME_SETUP_WEEKDAYS_DETAILS WD (NOLOCK) ON WD.SCHEME_SETUP_DET_ROW_ID=D.ROW_ID 
			AND WD.WEEKDAY_NAME=DATENAME(WEEKDAY,GETDATE())
			WHERE (G.DEPT_ID=@CCURDEPTID OR G.MEMO_NO IS NULL)
			AND (ISNULL(D.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR @BWIZCLIPCUSTOMER=1)
			AND @DXNDT BETWEEN B.APPLICABLE_FROM_DT AND B.APPLICABLE_TO_DT	
			AND SCHEME_MODE=1  AND B.INACTIVE=0
			AND (HH.MEMO_NO IS NULL OR HAPPY_HOURS_RESTRICTION_APPLICABLE=0 OR  CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,GETDATE()))))+':'+
			LTRIM(RTRIM(STR(DATEPART(MI,GETDATE()))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,GETDATE())))))
			BETWEEN 
			CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,FROM_TIME))))+':'+
			LTRIM(RTRIM(STR(DATEPART(MI,FROM_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,FROM_TIME)))))
			AND
			CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,TO_TIME))))+':'+
			LTRIM(RTRIM(STR(DATEPART(MI,TO_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,TO_TIME))))))
			AND D.FILTER_MODE=2 
			AND (T.QUANTITY-T.SCHEME_APPLIED_QTY>0 OR (ISNULL(@CPICKSLRDISCMODE,'')<>'3' 
			AND T.QUANTITY<0 AND ABS(T.QUANTITY)-T.SCHEME_APPLIED_QTY>0))
			AND (ISNULL(WEEKDAY_WISE_APPLICABLE,0)=0 OR WD.SELECTED=1)
			AND (B.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')

			UNION ALL
			SELECT DISTINCT TB.PRODUCT_CODE,T.MRP,(T.QUANTITY-T.SCHEME_APPLIED_QTY) AS QTY,T.CMD_ROW_ID,
			D.SCHEME_NAME,A.DISCOUNT_FIGURE,A.DISCOUNT_MODE,D.ROW_ID,SCHEME_APPLIED_QTY,
			PROCESSING_ORDER,B.MEMO_NO,
			ISNULL(A.ADDITIONAL_DISCOUNT_PERCENTAGE,0) AS ADDITIONAL_DISCOUNT_PERCENTAGE,MEMO_PROCESSING_ORDER
			FROM #TMPCMDBASEBC TB 
			JOIN #TMPCMD T ON T.CMD_ROW_ID=TB.CMD_ROW_ID
			JOIN SCHEME_SETUP_SLSBC A (NOLOCK)  ON TB.PRODUCT_CODE=A.PRODUCT_CODE
			JOIN SCHEME_SETUP_DET D (NOLOCK) ON D.ROW_ID=A.SCHEME_SETUP_DET_ROW_ID
			JOIN SCHEME_SETUP_MST B (NOLOCK) ON D.MEMO_NO= B.MEMO_NO
			LEFT OUTER JOIN SCHEME_SETUP_LOC G (NOLOCK) ON G.MEMO_NO=D.MEMO_NO
			LEFT OUTER JOIN RPS_MST H (NOLOCK) ON H.CM_ID=T.PACK_SLIP_ID
			LEFT OUTER JOIN SCHEME_SETUP_HAPPYHOURS HH (NOLOCK) ON HH.MEMO_NO=B.MEMO_NO
			LEFT OUTER JOIN SCHEME_SETUP_WEEKDAYS_DETAILS WD (NOLOCK) ON WD.SCHEME_SETUP_DET_ROW_ID=D.ROW_ID 
			AND WD.WEEKDAY_NAME=DATENAME(WEEKDAY,GETDATE())
			WHERE (G.DEPT_ID=@CCURDEPTID OR G.MEMO_NO IS NULL)
			AND (ISNULL(D.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR @BWIZCLIPCUSTOMER=1)
			AND @DXNDT BETWEEN B.APPLICABLE_FROM_DT AND B.APPLICABLE_TO_DT	
			AND SCHEME_MODE=1  AND B.INACTIVE=0
			AND (HH.MEMO_NO IS NULL OR HAPPY_HOURS_RESTRICTION_APPLICABLE=0 OR  CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,GETDATE()))))+':'+
			LTRIM(RTRIM(STR(DATEPART(MI,GETDATE()))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,GETDATE())))))
			BETWEEN 
			CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,FROM_TIME))))+':'+
			LTRIM(RTRIM(STR(DATEPART(MI,FROM_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,FROM_TIME)))))
			AND
			CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,TO_TIME))))+':'+
			LTRIM(RTRIM(STR(DATEPART(MI,TO_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,TO_TIME))))))
			AND D.FILTER_MODE=2 
			AND (T.QUANTITY-T.SCHEME_APPLIED_QTY>0 OR (ISNULL(@CPICKSLRDISCMODE,'')<>'3' 
			AND T.QUANTITY<0 AND ABS(T.QUANTITY)-T.SCHEME_APPLIED_QTY>0))
			AND (ISNULL(WEEKDAY_WISE_APPLICABLE,0)=0 OR WD.SELECTED=1)	
			AND (B.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')
			ORDER BY MEMO_PROCESSING_ORDER,MEMO_NO DESC,PROCESSING_ORDER
			
			--IF @@SPID=168
			--	SELECT 'CHK TMPBC',* FROM #TMPBCSCHEMES


		
			WHILE @BFLAG=0
			BEGIN
				PRINT 'ENTER BAR CODE WISE DISCOUNT-1'
			
				SELECT TOP 1 @CCMDPRODUCTCODE=PRODUCT_CODE,@NMRP=MRP,@NXNQTY=QTY,@CCMDROWID=CMD_ROW_ID,
				@CSCHEMENAME=SCHEME_NAME,@DISC_FIGURE=DISCOUNT_FIGURE,@DISC_METHOD=DISCOUNT_MODE,
				@CSCHEMEDETROWID=ROW_ID,@NSCHEMEQTY=SCHEME_APPLIED_QTY,@NORDER=PROCESSING_ORDER,
				@CSCHEMEMEMONO=MEMO_NO,@NADDNLDISCPCT=ADDITIONAL_DISCOUNT_PERCENTAGE,@NMEMOORDER=MEMO_PROCESSING_ORDER
				FROM #TMPBCSCHEMES
				
				PRINT 'ENTER BAR CODE WISE DISCOUNT-2'										
				IF EXISTS (SELECT TOP 1 PRODUCT_CODE FROM @TBCPROCESSED WHERE CMD_ROW_ID=@CCMDROWID)
					GOTO LBLNEXTBC
				
				PRINT 'ENTER BAR CODE WISE DISCOUNT-3'	
				SET @NSTEP = 60
			    EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE

				SELECT @NNET = (CASE WHEN ISNULL(@DISC_METHOD,0)=1 THEN @NMRP-(@NMRP*@DISC_FIGURE/100)
									 WHEN ISNULL(@DISC_METHOD,0)=2 THEN 
									 (CASE WHEN ISNULL(@DISC_FIGURE,0)>@NMRP THEN @NMRP ELSE ISNULL(@DISC_FIGURE,0) END)
									 ELSE (CASE WHEN ISNULL(@DISC_FIGURE,0)>@NMRP THEN 0 ELSE @NMRP-ISNULL(@DISC_FIGURE,0) END) END)*@NXNQTY

				
				PRINT 'ENTER SLSBC :'+@CCMDPRODUCTCODE+':'+STR(@NXNQTY)
				
				SET @NDISC = (@NMRP*@NXNQTY)-@NNET
								
				IF @DISC_METHOD=1
					SET @NDISCPCT=@DISC_FIGURE
				ELSE
					SET @NDISCPCT = (@NDISC/(@NMRP*@NXNQTY))*100

				IF @NADDNLDISCPCT<>0
				BEGIN
					SET @NNET=@NNET-(@NNET*@NADDNLDISCPCT/100)
					SET @NDISC = (@NMRP*@NXNQTY)-@NNET	
					SET @NDISCPCT = (@NDISC/(@NMRP*@NXNQTY))*100
				END
				
				PRINT 'ENTER DISC-5:'+ISNULL(STR(@NDISCPCT,10,2),'NULL')+':'+ISNULL(STR(@DISC_FIGURE,6,2),'NULL')
				
				IF @NSCHEMEQTY=0
					UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=@NDISCPCT,DISCOUNT_AMOUNT=@NDISC,SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
									   NET=@NNET,SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSCHEMENAME,
									   scheme_applied_amount=@NDISC
					WHERE CMD_ROW_ID=@CCMDROWID
				ELSE
				BEGIN
					UPDATE #TMPCMD SET DISCOUNT_AMOUNT=DISCOUNT_AMOUNT+@NDISC,SCHEME_APPLIED_AMOUNT=@NDISC,
									   SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSCHEMENAME
					WHERE CMD_ROW_ID=@CCMDROWID			
					
					UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ABS(ROUND((DISCOUNT_AMOUNT/(MRP*QUANTITY))*100,2)),
									   NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT	
					WHERE CMD_ROW_ID=@CCMDROWID								   
				END	
				
				
				---- WE HAVE TO UPDATE THIS COLUMNS BECAUSE SCHEMES APPLICABILITY IS DEPENDENT UPON THIS 
				---- COLUMN TO CONSIDER THE LOT QUANTIT BAR CODES
				UPDATE #TMPCMD SET SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID  WHERE CMD_ROW_ID=@CCMDROWID
						
			 	SET @NSTEP = 70
				EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
								
				INSERT INTO @TBCPROCESSED ( PRODUCT_CODE,CMD_ROW_ID ) 
				SELECT @CCMDPRODUCTCODE,@CCMDROWID

				IF NOT EXISTS (SELECT A.PRODUCT_CODE FROM #TMPCMD A LEFT OUTER JOIN @TBCPROCESSED B
					   ON A.CMD_ROW_ID=B.CMD_ROW_ID WHERE B.PRODUCT_CODE IS NULL)
				BEGIN	   
					GOTO LBLSCHEMELOOP
				END
			
			LBLNEXTBC:
				
				DELETE FROM #TMPBCSCHEMES WHERE CMD_ROW_ID=@CCMDROWID
				
				IF NOT EXISTS (SELECT TOP 1 PRODUCT_CODE FROM #TMPBCSCHEMES)
					BREAK		   
			END
			
		END
		
		PRINT 'SCHEME_SETUP_SLSART-0 ENTER'

LBLSCHEMELOOP:
		

		PRINT 'ENTER OPTIMIZED EOSS GETDISCOUNTS-3'
		IF @BGETBCDISC=1 AND ISNULL(@CPICKDISCONBARCODESCAN,'')<>'1'
		 	GOTO END_PROC

		PRINT 'ENTER OPTIMIZED EOSS GETDISCOUNTS-3.5'
		SET @NSTEP = 80
		
		EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE

		IF NOT EXISTS (SELECT A.PRODUCT_CODE FROM #TMPCMD A LEFT OUTER JOIN @TBCPROCESSED B
					   ON A.CMD_ROW_ID=B.CMD_ROW_ID WHERE B.PRODUCT_CODE IS NULL)
			SET @BCHECKONLYVALUEBASEDSCHEME=1
		
		SELECT SN.*,NEWID() AS UNQ_ID,SKU.ARTICLE_CODE AS SKU_ARTICLE_CODE,
		SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PARA3_CODE,SKU.PARA4_CODE,SKU.PARA5_CODE,SKU.PARA6_CODE,
		ARTICLE.SUB_SECTION_CODE,SD.SECTION_CODE,SX.RECEIPT_DT
		INTO #CMDITV 
		FROM #TMPCMD B
		JOIN SKU_NAMES SN (NOLOCK) ON SN.PRODUCT_CODE=B.PRODUCT_CODE
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=SN.PRODUCT_CODE
		JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
		JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
		LEFT JOIN SKU_XFP SX (NOLOCK) ON SX.PRODUCT_CODE=B.PRODUCT_CODE	AND SX.DEPT_ID=@CLOCATIONID					


		DELETE A FROM #CMDITV A WHERE A.UNQ_ID<>(SELECT TOP 1 UNQ_ID FROM #CMDITV B WHERE B.PRODUCT_CODE=A.PRODUCT_CODE)
		
		SELECT PARA4_NAME AS PARA_NAME INTO #TMPOPTPARAS FROM PARA4 WHERE 1=2
							  
									  
		SET @CCMD=N'SELECT DISTINCT '+@COPTSEARCHPARANAME+' FROM #CMDITV'	
		
		INSERT #TMPOPTPARAS (PARA_NAME)
		EXEC SP_EXECUTESQL @CCMD
		
		PRINT 'ENTER OPTIMIZED EOSS GETDISCOUNTS-4'
		
		--IF @@SPID=758
		--	SELECT SCHEME_NAME, 'CHECK FINAL ACTIVE TITLES',* FROM #TMPACTIVETITLES A
		--	JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID

		--SELECT * FROM #TMPOPTPARAS
		IF CURSOR_STATUS('GLOBAL','SCHEMEAPPLYCUR') IN (0,1)
		BEGIN
			CLOSE SCHEMEAPPLYCUR
			DEALLOCATE SCHEMEAPPLYCUR
		END

		SET @NSTEP = 90
		EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
			
		SELECT DISTINCT A.ROW_ID,A.SCHEME_NAME,ISNULL(C.SP_NAME,'') AS SP_NAME,PROCESSING_ORDER,
		FILTER_MODE,ISNULL(GET_FILTER_MODE,0) AS GET_FILTER_MODE,A.SCHEME_MODE,A.DISC_METHOD,A.DISCOUNT_PERCENTAGE,
		A.DISCOUNT_PERCENTAGE2,A.DISCOUNT_PERCENTAGE3,A.NET_PRICE,A.DISCOUNT_AMOUNT,A.BUY_FILTER_CRITERIA,D.MEMO_NO,
		C.VALUE_BASED_SCHEME,C.PROMOTIONAL_SCHEME_ID,D.MEMO_PROCESSING_ORDER
		INTO #TMPNONBCSCHEMES
		FROM SCHEME_SETUP_DET A (NOLOCK)
		LEFT OUTER JOIN PROMOTIONAL_SCHEMES_MST C (NOLOCK) ON C.PROMOTIONAL_SCHEME_ID=A.PROMOTIONAL_SCHEME_ID
		JOIN SCHEME_SETUP_MST D (NOLOCK) ON D.MEMO_NO=A.MEMO_NO
		LEFT OUTER JOIN SCHEME_SETUP_HAPPYHOURS HH (NOLOCK) ON HH.MEMO_NO=D.MEMO_NO
		LEFT OUTER JOIN SCHEME_SETUP_LOC G (NOLOCK) ON G.MEMO_NO=D.MEMO_NO
		LEFT OUTER JOIN #TMPACTIVETITLES AT ON AT.SCHEME_SETUP_DET_ROW_ID=A.ROW_ID
		LEFT OUTER JOIN SCHEME_SETUP_WEEKDAYS_DETAILS WD (NOLOCK) ON WD.SCHEME_SETUP_DET_ROW_ID=A.ROW_ID 
		AND WD.WEEKDAY_NAME=DATENAME(WEEKDAY,GETDATE())
		WHERE (A.SCHEME_MODE=2 OR A.FILTER_MODE<>2)  AND @DXNDT BETWEEN D.APPLICABLE_FROM_DT AND D.APPLICABLE_TO_DT
		AND (@BGETBCDISC=0 OR (@BGETBCDISC=1 AND A.SCHEME_MODE=1))
		AND (G.DEPT_ID=@CCURDEPTID OR G.MEMO_NO IS NULL)
		AND (ISNULL(A.APPLICABLE_FOR_PRIVILEGE_CUSTOMER,0)=0 OR @BWIZCLIPCUSTOMER=1)
		AND AT.SCHEME_SETUP_DET_ROW_ID IS NOT NULL 
		AND (@BCHECKONLYVALUEBASEDSCHEME<>1 OR C.VALUE_BASED_SCHEME=1) AND D.INACTIVE=0
		AND (HH.MEMO_NO IS NULL OR HAPPY_HOURS_RESTRICTION_APPLICABLE=0 OR CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,GETDATE()))))+':'+
		LTRIM(RTRIM(STR(DATEPART(MI,GETDATE()))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,GETDATE())))))
		BETWEEN 
		CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,FROM_TIME))))+':'+
		LTRIM(RTRIM(STR(DATEPART(MI,FROM_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,FROM_TIME)))))
		AND
		CONVERT(DATETIME,'1900-01-01 '+LTRIM(RTRIM(STR(DATEPART(HH,TO_TIME))))+':'+
		LTRIM(RTRIM(STR(DATEPART(MI,TO_TIME))))+':'+LTRIM(RTRIM(STR(DATEPART(SS,TO_TIME))))))
		AND (ISNULL(WEEKDAY_WISE_APPLICABLE,0)=0 OR WD.SELECTED=1)
		AND (D.MEMO_NO=@CMANUALSCHEMESETMEMONO OR @CMANUALSCHEMESETMEMONO='')
		AND ISNULL(C.BILL_LEVEL_SCHEME,0)=0
		ORDER BY D.MEMO_PROCESSING_ORDER,D.MEMO_NO DESC,PROCESSING_ORDER
		
		--IF @@SPID=300
		--BEGIN
		--	SELECT 'CHECK NONBCSCHEMES',* FROM #TMPNONBCSCHEMES
		--	SELECT T.PRODUCT_CODE,T.MRP,T.QUANTITY,T.SCHEME_APPLIED_QTY,T.CMD_ROW_ID,T.SCHEME_APPLIED_QTY,
		--		   SCHEME_SETUP_DET_ROW_ID,BASIC_DISCOUNT_PERCENTAGE	
		--		FROM #TMPCMD T
		--END
		--IF @@SPID=61
		--	SELECT 'CHECK NONBCSCHEMES',@BMANUALCMMDISC AS BMANUALCMMDISC,@BCHECKONLYVALUEBASEDSCHEME AS BCHECKONLYVALUEBASEDSCHEME,
		--	* FROM #TMPNONBCSCHEMES									

		DECLARE @NNONBCSCHCOUNT INT,@CSCHCNT VARCHAR(4)
		SELECT @NNONBCSCHCOUNT=COUNT(*) FROM  #TMPNONBCSCHEMES		
		SET @CSCHCNT=LTRIM(RTRIM(STR(@NNONBCSCHCOUNT)))
				
		WHILE @BFLAG=0
		BEGIN
			SET @NSTEP=92
			EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@CSCHCNT
			PRINT 'ENTER FILTER TITLES'
			SELECT TOP 1 @CSCHEMEDETROWID=ISNULL(ROW_ID,''),@CSCHEMENAME=ISNULL(SCHEME_NAME,''),
			@CPROCNAME=ISNULL(SP_NAME,''),
			@NORDER=ISNULL(PROCESSING_ORDER,0),
			@NFILTERMODE=ISNULL(FILTER_MODE,0),@NGETFILTERMODE=ISNULL(GET_FILTER_MODE,0),
			@NSCHEMEMODE=ISNULL(SCHEME_MODE,0),
			@DISC_METHOD=ISNULL(DISC_METHOD,0),@DISCOUNT_PERCENTAGE1=ISNULL(DISCOUNT_PERCENTAGE,0),
			@DISCOUNT_PERCENTAGE2=ISNULL(DISCOUNT_PERCENTAGE2,0),
			@DISCOUNT_PERCENTAGE3=ISNULL(DISCOUNT_PERCENTAGE3,0),@NNETPRICE=ISNULL(NET_PRICE,0),
			@NDISCAMT=ISNULL(DISCOUNT_AMOUNT,0),@D_FILTER=ISNULL(BUY_FILTER_CRITERIA,''),
			@CSCHEMEMEMONO=ISNULL(MEMO_NO,''),@BVALUEBASEDSCHEME=ISNULL(VALUE_BASED_SCHEME,0),
			@CPROMOTIONALSCHEMEID=ISNULL(PROMOTIONAL_SCHEME_ID,''),
			@NMEMOORDER=ISNULL(MEMO_PROCESSING_ORDER,0) FROM #TMPNONBCSCHEMES
			ORDER BY MEMO_PROCESSING_ORDER,MEMO_NO DESC,PROCESSING_ORDER
			

			SET @NSTEP=94
			EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
						
			PRINT 'PROCESSING TITLE : '+@CSCHEMENAME+'('+STR(@NSCHEMEMODE)+')'	
			
				--IF @@SPID=114 AND @CSCHEMENAME='BUY 1-2 GET 50 %'
				--	SELECT 'CHECK TMPCMD B4 ENTERING SCHEME',@NSCHEMEMODE,* FROM #TMPCMD

			SET @NSTEP=96
			IF @NSCHEMEMODE=1 AND @NFILTERMODE<>6 --- PROCESS FLAT DISCOUNTS
			BEGIN
				
				SET @NSTEP=98
				PRINT 'PROCESSING TITLE 1: '+@CSCHEMENAME+'('+STR(@NSCHEMEMODE)+')'	
			    SET @NSTEP = 100
			    EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE

				IF @BCHECKONLYVALUEBASEDSCHEME=1
					GOTO LBLNEXTSCHEME

				PRINT 'PROCESSING TITLE 2: '+@CSCHEMENAME+'('+STR(@NSCHEMEMODE)+')'					
				DECLARE CMDCUR CURSOR FOR 
				SELECT T.PRODUCT_CODE,T.MRP,T.QUANTITY-T.SCHEME_APPLIED_QTY,T.CMD_ROW_ID,T.SCHEME_APPLIED_QTY
				FROM #TMPCMD T WHERE (T.QUANTITY-T.SCHEME_APPLIED_QTY>0 OR (ISNULL(@CPICKSLRDISCMODE,'')<>'3' 
				AND T.QUANTITY<0 AND ABS(T.QUANTITY)-T.SCHEME_APPLIED_QTY>0)) AND T.BASIC_DISCOUNT_PERCENTAGE=0
				AND ISNULL(T.SCHEME_SETUP_DET_ROW_ID,'')=''
					
				OPEN CMDCUR
				FETCH NEXT FROM CMDCUR INTO @CCMDPRODUCTCODE,@NMRP,@NXNQTY,@CCMDROWID,@NSCHEMEQTY
				WHILE @@FETCH_STATUS=0
				BEGIN
					PRINT 'ENTER DISC-2'
					
				    SET @NSTEP = 105
				    EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	
					SELECT @DISC_FIGURE=0,@CPCFOUND = ''
					
					IF @NFILTERMODE=1 --- FILTER BASED
					BEGIN			
						SET @NSTEP = 110	
						EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE	
						SET @CFILTER = N' AND   ' + (CASE WHEN @D_FILTER<>'' THEN '( ' + @D_FILTER+ ' ) ' ELSE '1=1' END)
						
						SET @CFILTER = REPLACE(@CFILTER,'INV_NO','PURCHASE_BILL_NO')
						SET @CFILTER = REPLACE(@CFILTER,'INV_DT','PURCHASE_BILL_DT')

						SET @CCMD=N'SELECT @CPCFOUNDOUT=ITV.PRODUCT_CODE FROM #CMDITV ITV '+
						 (CASE WHEN @CENABLEOPTIMIZEDSCHEMES='1' THEN 'JOIN #TMPSKUACTIVETITLES SACT ON SACT.PRODUCT_CODE=ITV.PRODUCT_CODE '+
							' AND SACT.SCHEME_SETUP_DET_ROW_ID='''+@CSCHEMEDETROWID+''' AND SACT.GET_BC=0 ' ELSE '' END)+
							' WHERE ITV.PRODUCT_CODE='''+@CCMDPRODUCTCODE+''''+
									(CASE WHEN @CENABLEOPTIMIZEDSCHEMES='1' THEN '' ELSE  @CFILTER END)
											
						PRINT @CCMD						
						EXEC SP_EXECUTESQL @CCMD,N'@CPCFOUNDOUT VARCHAR(100) OUTPUT',@CPCFOUNDOUT=@CPCFOUND OUTPUT

						SET @NEFFECTIVEDISCPCT	=ISNULL(@DISCOUNT_PERCENTAGE1,0)

						IF(ISNULL(@DISCOUNT_PERCENTAGE2,0)>0)
							SET @NEFFECTIVEDISCPCT	=@NEFFECTIVEDISCPCT+((100-@NEFFECTIVEDISCPCT) * @DISCOUNT_PERCENTAGE2/100)
							
						IF(ISNULL(@DISCOUNT_PERCENTAGE3,0)>0)
							SET @NEFFECTIVEDISCPCT	=@NEFFECTIVEDISCPCT+((100-@NEFFECTIVEDISCPCT) * @DISCOUNT_PERCENTAGE3/100)
						
						SELECT  @DISC_FIGURE=(CASE WHEN ISNULL(@DISC_METHOD,0)=1 THEN  @NEFFECTIVEDISCPCT WHEN ISNULL(@DISC_METHOD,0)=2 THEN @NNETPRICE
											  ELSE @NDISCAMT END)							
					END
					ELSE
					IF @NFILTERMODE=3 --- ARTICLE BASED
					BEGIN				
						SET @NSTEP = 115
						EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE	
						SELECT TOP 1 @DISC_FIGURE=C.DISCOUNT_FIGURE,@DISC_METHOD=C.DISCOUNT_MODE,@CPCFOUND=A.PRODUCT_CODE
						FROM SKU A (NOLOCK) JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE
						JOIN  SCHEME_SETUP_SLSART C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE
						WHERE A.PRODUCT_CODE=@CCMDPRODUCTCODE AND C.SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID 
						
					END
					ELSE
					IF @NFILTERMODE=4 --- STYLE BASED
					BEGIN			
						SET @NSTEP = 120
						EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE		
						SELECT TOP 1 @DISC_FIGURE=C.DISCOUNT_FIGURE,@DISC_METHOD=C.DISCOUNT_MODE,@CPCFOUND=A.PRODUCT_CODE
						FROM SKU A (NOLOCK) JOIN PARA3 B (NOLOCK) ON A.PARA3_CODE=B.PARA3_CODE
								   JOIN  SCHEME_SETUP_SLSPARA C (NOLOCK) ON C.PARA3_CODE=B.PARA3_CODE
								   WHERE A.PRODUCT_CODE=@CCMDPRODUCTCODE AND C.SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID 

					END
										
					IF ISNULL(@CPCFOUND,'')<>''
					BEGIN					
						PRINT 'FLAT DISC :'+STR(@DISC_FIGURE)+' FOUND FOR PC:'+@CPCFOUND+' AGST TITLE:'+@CSCHEMENAME
						SET @NSTEP = 125
						EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE

						SET @NNET = (CASE WHEN ISNULL(@DISC_METHOD,0)=1 THEN @NMRP-(@NMRP*@DISC_FIGURE/100)
									 WHEN ISNULL(@DISC_METHOD,0)=2 THEN 
									 (CASE WHEN ISNULL(@DISC_FIGURE,0)>@NMRP THEN @NMRP ELSE ISNULL(@DISC_FIGURE,0) END)
									 ELSE (CASE WHEN ISNULL(@DISC_FIGURE,0)>@NMRP THEN 0 ELSE @NMRP-ISNULL(@DISC_FIGURE,0) END) END)*@NXNQTY
				
						
						PRINT 'ENTER SLSBC :'+@CCMDPRODUCTCODE+':'+STR(@NXNQTY)
						
						SET @NDISC = (@NMRP*@NXNQTY)-@NNET
						
						IF @DISC_METHOD=1
							SET @NDISCPCT=@DISC_FIGURE
						ELSE
							SET @NDISCPCT = (@NDISC/(@NMRP*@NXNQTY))*100
						
						PRINT 'ENTER DISC-5'
						
						SET @NSTEP = 130
						EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE

						IF @NSCHEMEQTY=0
						BEGIN
							PRINT 'UPDATE BASIC DISC:'+STR(@NDISCPCT,10,2)
							UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=@NDISCPCT,DISCOUNT_AMOUNT=@NDISC,SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
											   NET=@NNET,SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSCHEMENAME,
											   SCHEME_APPLIED_AMOUNT=@NDISC
							WHERE CMD_ROW_ID=@CCMDROWID
						END	
						ELSE
						BEGIN
							UPDATE #TMPCMD SET DISCOUNT_AMOUNT=DISCOUNT_AMOUNT+@NDISC,
											   SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSCHEMENAME,
											   SCHEME_APPLIED_AMOUNT=SCHEME_APPLIED_AMOUNT+@NDISC
							WHERE CMD_ROW_ID=@CCMDROWID			
							
							UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ABS(ROUND((DISCOUNT_AMOUNT/(MRP*QUANTITY))*100,2)),
											   NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT	
							WHERE CMD_ROW_ID=@CCMDROWID								   
						END	
						
						UPDATE #TMPCMD SET SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID WHERE CMD_ROW_ID=@CCMDROWID
																				
						INSERT INTO @TBCPROCESSED ( PRODUCT_CODE,CMD_ROW_ID ) 
						SELECT @CCMDPRODUCTCODE,@CCMDROWID

						IF NOT EXISTS (SELECT A.PRODUCT_CODE FROM #TMPCMD A LEFT OUTER JOIN @TBCPROCESSED B
							   ON A.CMD_ROW_ID=B.CMD_ROW_ID WHERE B.PRODUCT_CODE IS NULL)
						BEGIN	   
							SET @BCHECKONLYVALUEBASEDSCHEME=1
							GOTO LBLNEXTSCHEME
						END	
					END
												   
					PRINT 'SLS-5.4-'+@CCMDPRODUCTCODE			
					FETCH NEXT FROM CMDCUR INTO @CCMDPRODUCTCODE,@NMRP,@NXNQTY,@CCMDROWID,@NSCHEMEQTY

				END
				
				CLOSE CMDCUR
				DEALLOCATE CMDCUR
			END
			
			ELSE
			IF @NSCHEMEMODE=1 AND @NFILTERMODE=6
			BEGIN
				SET @NSTEP = 132
				EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
				EXEC SP3S_EOSS_APPLY_ALLMASTERS_FLAT_DISCOUNT @CSCHEMEDETROWID,@CERRORMSG OUTPUT
				IF ISNULL(@CERRORMSG,'')<>''
					GOTO END_PROC
			END
			ELSE
			IF @NSCHEMEMODE=2--- PROCESS POWER SCHEMES
			BEGIN	
				SET @NSTEP = 134
				EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
				--IF @@SPID=298
				--	SELECT 'CHECK NEXT SCHEME',@BCHECKONLYVALUEBASEDSCHEME,@BVALUEBASEDSCHEME,
				--	@BMANUALCMMDISC,@BBILLLEVELSCHEME
				
				---REMOVED THIS CONDITION FROM BELOW IF STATEMENT AS ISSUE WAS COMING WHEN USER
				--- WAS INPUTTING MANUAL DISCOUNT AND SCHEME WAS GETTING REMOVED
				--OR (@BMANUALCMMDISC=1)
				IF (@BCHECKONLYVALUEBASEDSCHEME=1 AND @BVALUEBASEDSCHEME<>1 ) 
				BEGIN	
					GOTO LBLNEXTSCHEME
				END

				IF @NFILTERMODE=1 
					SELECT @CJOINSTRBUY= (CASE WHEN @CENABLEOPTIMIZEDSCHEMES='1' THEN ' JOIN #TMPSKUACTIVETITLES SACT ON SACT.PRODUCT_CODE=ITV.PRODUCT_CODE '+
					' AND SACT.SCHEME_SETUP_DET_ROW_ID='''''+@CSCHEMEDETROWID+''''' AND SACT.GET_BC=0' ELSE '' END)
				ELSE	
				IF @NFILTERMODE=2
					SELECT @CJOINSTRBUY=' JOIN SCHEME_SETUP_SLSBC SLSBC ON SLSBC.PRODUCT_CODE=
					LEFT(ITV.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''''@'''',ITV.PRODUCT_CODE)-1,-1),LEN(ITV.PRODUCT_CODE )))
										  JOIN SCHEME_SETUP_DET SLSDET ON SLSDET.ROW_ID=SLSBC.SCHEME_SETUP_DET_ROW_ID'								   
				ELSE
				IF @NFILTERMODE=3 AND @CPROMOTIONALSCHEMEID<>'SCH0015'
					SELECT @CJOINSTRBUY=' JOIN SCHEME_SETUP_SLSART SLSART ON SLSART.ARTICLE_CODE=ITV.SKU_ARTICLE_CODE
									   JOIN SCHEME_SETUP_DET SLSDET ON SLSDET.ROW_ID=SLSART.SCHEME_SETUP_DET_ROW_ID'
				ELSE
				IF @NFILTERMODE=4
					SELECT @CJOINSTRBUY=' JOIN SCHEME_SETUP_SLSPARA SLSPARA ON SLSPARA.PARA3_CODE=ITV.PARA3_CODE
									   JOIN SCHEME_SETUP_DET SLSDET ON SLSDET.ROW_ID=SLSPARA.SCHEME_SETUP_DET_ROW_ID'
				ELSE
				IF @NFILTERMODE=6 OR ((@NFILTERMODE=3 OR @NGETFILTERMODE=6) AND @CPROMOTIONALSCHEMEID='SCH0015')
				BEGIN
					EXEC SP3S_EOSS_GETSCHEMES_PARA_COMBINATION
					@SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
					@CJOINSTRBUY=@CJOINSTRBUY OUTPUT,
					@CJOINSTRGET=@CJOINSTRGET OUTPUT,
					@CERRORMSG=@CERRORMSG OUTPUT

					IF ISNULL(@CERRORMSG,'')<>''
						GOTO END_PROC
				END

 				IF @NGETFILTERMODE IN (0,1)
					SELECT @CJOINSTRGET=(CASE WHEN @CENABLEOPTIMIZEDSCHEMES='1' THEN ' JOIN #TMPSKUACTIVETITLES SACT ON SACT.PRODUCT_CODE=ITV.PRODUCT_CODE '+
					' AND SACT.SCHEME_SETUP_DET_ROW_ID='''''+@CSCHEMEDETROWID+''''' AND SACT.GET_BC=1' ELSE '' END)
				ELSE	
				IF (@NGETFILTERMODE=2 )
					SELECT @CJOINSTRGET=' JOIN SCHEME_SETUP_SLSBC_GET SLSBC ON SLSBC.PRODUCT_CODE=
									LEFT(ITV.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''''@'''',ITV.PRODUCT_CODE)-1,-1),LEN(ITV.PRODUCT_CODE )))
									   JOIN SCHEME_SETUP_DET SLSDET ON SLSDET.ROW_ID=SLSBC.SCHEME_SETUP_DET_ROW_ID'								   
				ELSE
				IF (@NGETFILTERMODE=3  AND @CPROMOTIONALSCHEMEID<>'SCH0015')
					SELECT   @CJOINSTRGET=' JOIN SCHEME_SETUP_SLSART_GET SLSART ON SLSART.ARTICLE_CODE=ITV.SKU_ARTICLE_CODE
									   JOIN SCHEME_SETUP_DET SLSDET ON SLSDET.ROW_ID=SLSART.SCHEME_SETUP_DET_ROW_ID'								   
				ELSE
				IF (@NGETFILTERMODE=4 )
					SELECT @CJOINSTRGET=' JOIN SCHEME_SETUP_SLSPARA_GET SLSPARA ON SLSPARA.PARA3_CODE=ITV.PARA3_CODE
									   JOIN SCHEME_SETUP_DET SLSDET ON SLSDET.ROW_ID=SLSPARA.SCHEME_SETUP_DET_ROW_ID'
									   
				
				SET @NSTEP = 135
				EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0015')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_15 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''','''+@NSPID+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0010')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_10 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''','''+@NSPID+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0002')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_2 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''','''+@NSPID+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0014') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_14 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''','''+@NSPID+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0007') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_7 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''','''+@NSPID+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0006') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_6 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''','''+@NSPID+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0003') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_3 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0004') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_4 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''',@CERRORMSG OUTPUT'				
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0005') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_5 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0008') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_8 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0009') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_9 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0011') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_11 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0012') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_12 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''',@CERRORMSG OUTPUT'
				ELSE
				IF @CPROMOTIONALSCHEMEID IN ('SCH0013') --,'SCH0007','SCH0006')
					SET @CCMD=N'EXEC SP3S_EOSS_SCHEMES_13 '''+@CSCHEMEDETROWID+''','''+@CSCHEMENAME+''','''+@CROUNDITEMLEVEL+''',
								'''+@CJOINSTRBUY+''','''+@CJOINSTRGET+''',
								'''+@CPICKSLRDISCMODE+''',@CERRORMSG OUTPUT'

				PRINT @CCMD
				SET @CSTR='SCH_GETDISC('+@CSCHEMENAME+')('+@CPROCNAME+')'
				SET @NSTEP = 137
			
				EXEC SP_CHKXNSAVELOG @CSTR,@NSTEP,0,@NSPID,@BDEBUGMODE
					
				PRINT ISNULL(@CCMD,'NULL CMD')			
				EXEC SP_EXECUTESQL @CCMD,N'@CERRORMSG VARCHAR(MAX) OUTPUT',@CERRORMSG OUTPUT
							
				IF ISNULL(@CERRORMSG,'')<>''
					GOTO END_PROC

				SET @NSTEP = 138
				----- AFTER APPLYING ALL SALE SETUP DISCOUNTS, CALCULATE WEIGHTED AVG DISCOUNT
				EXEC SP3S_EOSS_UPDATESCHEME_WTDDISC	 
				@CSCHEMESETROWID=@CSCHEMEDETROWID,
				@CLOCID=@CLOCATIONID,
				@CERRORMSG=@CERRORMSG OUTPUT
				
				SET @NSTEP = 139
				IF ISNULL(@CERRORMSG,'')<>''
					GOTO END_PROC
			END
			
			LBLNEXTSCHEME:
			
			SET @NSTEP = 140
			EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
			DELETE FROM #TMPNONBCSCHEMES WHERE ROW_ID=@CSCHEMEDETROWID
			
			SET @NSTEP = 141	
			IF NOT EXISTS (SELECT TOP 1 ROW_ID FROM #TMPNONBCSCHEMES)
				BREAK
			
			SET @NSTEP = 142				
		END	

		
		SET @NSTEP = 143
		EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
		EXEC SP3S_EOSS_UPDATE_ADDITIONAL_DISCOUNT_FLATSCHEME
		
		SET @NSTEP = 143.5
		--IF @@SPID=61
		--	SELECT 'CHECK #TMPCMD AFTER EOSS',* FROM #TMPCMD 

		UPDATE #TMPCMD SET BASIC_DISCOUNT_PERCENTAGE=DISCOUNT_PERCENTAGE,BASIC_DISCOUNT_AMOUNT=DISCOUNT_AMOUNT
		
	 END
	   	 
END_PROC:
	
	IF ISNULL(@CERRORMSG,'')='' AND @BGETBCDISC=0
	BEGIN
	
			--IF @@SPID=221
			--	SELECT 'FINAL #TMPCMD AFTER APPLYING DISCOUNT',QUANTITY,CMD_ROW_ID,BASIC_DISCOUNT_AMOUNT,BASIC_DISCOUNT_PERCENTAGE,PRODUCT_CODE,REF_CMD_ROW_ID,SLS_TITLE FROM #TMPCMD

			SET @NSTEP = 145
			EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE

			INSERT #TMPCMD (PRODUCT_CODE,SUB_SECTION_CODE,QUANTITY,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,
				SCHEME_APPLIED_AMOUNT,SCHEME_SETUP_DET_ROW_ID,SCHEME_ID,DISCOUNT_PERCENTAGE,MRP,NET,
				CMD_ROW_ID,PACK_SLIP_ID,USER_CODE,BILL_LEVEL_DISCOUNT_PERCENTAGE,SLS_TITLE,BNGN_QTY,
				BNGN_DISCOUNT,WEIGHTED_AVG_DISC_PCT,WEIGHTED_AVG_DISC_AMT,ITEM_ROUND_OFF,APPLY_EXCLUSIVE_TAX,
				EXCLUSIVE_VAT_TO_DISC,CARD_DISCOUNT,BILL_LEVEL_DISCOUNT_AMOUNT,FORM_ID,PACK_SLIP_ROW_ID,
				MANUAL_TAX_METHOD,CARD_DISCOUNT_PERCENTAGE,BASIC_DISCOUNT_PERCENTAGE,CARD_DISCOUNT_AMOUNT,
				BASIC_DISCOUNT_AMOUNT,BNGN_ROW_ID,SP_ID,CUT_SIZE,REF_CMD_ROW_ID,CMD_MRP,FIX_MRP_ITEM)			
			SELECT PRODUCT_CODE,SUB_SECTION_CODE,SUM(QUANTITY) ,SUM(DISCOUNT_AMOUNT),SUM(SCHEME_APPLIED_QTY),
				SUM(SCHEME_APPLIED_AMOUNT),'' SCHEME_SETUP_DET_ROW_ID,'' SCHEME_ID,0 DISCOUNT_PERCENTAGE,MRP,
				SUM((MRP*QUANTITY)-DISCOUNT_AMOUNT) NET,
				REF_CMD_ROW_ID CMD_ROW_ID,PACK_SLIP_ID,'' USER_CODE,BILL_LEVEL_DISCOUNT_PERCENTAGE,'' SLS_TITLE,
				SUM(BNGN_QTY),0 BNGN_DISCOUNT,0 WEIGHTED_AVG_DISC_PCT,SUM(WEIGHTED_AVG_DISC_AMT),
				0 ITEM_ROUND_OFF,0 APPLY_EXCLUSIVE_TAX,0 EXCLUSIVE_VAT_TO_DISC,0 CARD_DISCOUNT,
				BILL_LEVEL_DISCOUNT_AMOUNT,
				FORM_ID,PACK_SLIP_ROW_ID,MANUAL_TAX_METHOD,CARD_DISCOUNT_PERCENTAGE,0 BASIC_DISCOUNT_PERCENTAGE,
				SUM(CARD_DISCOUNT_AMOUNT),SUM(BASIC_DISCOUNT_AMOUNT),'' BNGN_ROW_ID,SP_ID,0 CUT_SIZE,'' REF_CMD_ROW_ID,
				CMD_MRP,FIX_MRP_ITEM
				FROM #TMPCMD WHERE REF_CMD_ROW_ID<>''
				GROUP BY PRODUCT_CODE,SUB_SECTION_CODE,REF_CMD_ROW_ID,MRP,PACK_SLIP_ID,
				BILL_LEVEL_DISCOUNT_PERCENTAGE,BILL_LEVEL_DISCOUNT_AMOUNT,FORM_ID,PACK_SLIP_ROW_ID,MANUAL_TAX_METHOD,
				CARD_DISCOUNT_PERCENTAGE,SP_ID,CMD_MRP,FIX_MRP_ITEM

				SET @NSTEP = 148
			EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
				UPDATE A SET SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID,SLS_TITLE=B.SLS_TITLE,
				BNGN_ROW_ID=B.BNGN_ROW_ID,CUT_SIZE=B.CUT_SIZE,BASIC_DISCOUNT_PERCENTAGE=ROUND((A.BASIC_DISCOUNT_AMOUNT/(A.MRP*A.QUANTITY))*100,2) 
				FROM #TMPCMD A JOIN #TMPCMD B ON A.CMD_ROW_ID=B.REF_CMD_ROW_ID
				WHERE B.SCHEME_SETUP_DET_ROW_ID<>''

				--IF @@SPID=221
				--	SELECT 'FINAL #TMPCMD',QUANTITY,CMD_ROW_ID,BASIC_DISCOUNT_AMOUNT,BASIC_DISCOUNT_PERCENTAGE,PRODUCT_CODE,REF_CMD_ROW_ID,SLS_TITLE FROM #TMPCMD

				DELETE FROM #TMPCMD WHERE REF_CMD_ROW_ID<>''

				--IF @@SPID=221
				--	SELECT 'FINAL #TMPCMD AFTER DELETION',QUANTITY,CMD_ROW_ID,BASIC_DISCOUNT_AMOUNT,BASIC_DISCOUNT_PERCENTAGE,PRODUCT_CODE,REF_CMD_ROW_ID,SLS_TITLE FROM #TMPCMD
	END

	SET @NSTEP = 153
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE


	SET @NSTEP = 156
	IF @BCALLEDFROMCASHMEMO=1
		INSERT #TMPSLRDISC (PRODUCT_CODE,CMD_ROW_ID,DISCOUNT_PERCENTAGE, DISCOUNT_AMOUNT,quantity)
		SELECT A.PRODUCT_CODE,A.CMD_ROW_ID,(CASE WHEN isnull(weighted_avg_disc_amt,0)<>0 THEN weighted_avg_disc_pct ELSE BASIC_DISCOUNT_PERCENTAGE end),
		(CASE WHEN isnull(weighted_avg_disc_amt,0)<>0 THEN weighted_avg_disc_amt ELSE BASIC_DISCOUNT_AMOUNT end),A.QUANTITY
		FROM #TMPCMD A  WHERE A.QUANTITY<0

	IF ISNULL(@CPICKSLRDISCMODE,'')='3' 
	BEGIN
		IF @BCALLEDFROMCASHMEMO=1
		BEGIN
			SET @NSTEP = 160
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
			UPDATE  A SET BASIC_DISCOUNT_PERCENTAGE=ISNULL(B.LAST_SLS_DISCOUNT_PERCENTAGE,0),
			BASIC_DISCOUNT_AMOUNT=A.MRP*B.QUANTITY*ISNULL(B.LAST_SLS_DISCOUNT_PERCENTAGE,0)/100,
			DISCOUNT_PERCENTAGE=ISNULL(B.LAST_SLS_DISCOUNT_PERCENTAGE,0),
			DISCOUNT_AMOUNT=A.MRP*B.QUANTITY*ISNULL(B.LAST_SLS_DISCOUNT_PERCENTAGE,0)/100,
			NET=(A.MRP*A.QUANTITY)-(A.MRP*B.QUANTITY*ISNULL(B.LAST_SLS_DISCOUNT_PERCENTAGE,0)/100),
			SLS_TITLE=ISNULL(B.LAST_APPLIED_SCHEME_NAME,'')
			FROM #TMPCMD A JOIN SLS_CMD01106_UPLOAD B ON A.CMD_ROW_ID=B.ROW_ID
			WHERE B.SP_ID=@NSPID AND B.QUANTITY<0

			SET @NSTEP=161.5
			UPDATE A WITH (ROWLOCK) SET SCHEME_NAME=A.LAST_APPLIED_SCHEME_NAME
			FROM SLS_CMD01106_UPLOAD A 
			WHERE A.SP_ID=@NSPID AND A.QUANTITY<0 AND ISNULL(A.LAST_SLS_DISCOUNT_PERCENTAGE,0)<>0
			AND ISNULL(SCHEME_NAME,'')=''
			--IF @@SPID=64
			--	SELECT BASIC_DISCOUNT_PERCENTAGE,BASIC_DISCOUNT_AMOUNT,PRODUCT_CODE FROM #TMPCMD
		END
		ELSE
		IF @BCALLEDFROMPACKSLIP=1
		BEGIN


			SET @NSTEP = 170
			EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
			SET @CCMD=N'UPDATE A SET BASIC_DISCOUNT_PERCENTAGE=(CASE  WHEN B.OLD_NET<>B.NET AND ISNULL(B.OLD_NET,0)<>0 THEN ABS((((B.OLD_MRP*B.QUANTITY)-
						  (B.OLD_NET-ISNULL(B.OLD_CMM_DISCOUNT_AMOUNT ,0)))*100)/(B.OLD_MRP*A.QUANTITY))

						  WHEN B.OLD_MRP<>B.MRP AND ISNULL(B.OLD_MRP,0)<>0 
					      THEN (100-(((B.OLD_MRP-(B.OLD_MRP*ISNULL(B.BASIC_DISCOUNT_PERCENTAGE,0)/100))
						  -((B.OLD_MRP-(B.OLD_MRP*ISNULL(B.BASIC_DISCOUNT_PERCENTAGE,0)/100))*C.DISCOUNT_PERCENTAGE/100))/B.OLD_MRP)*100) 

						   WHEN B.WEIGHTED_AVG_DISC_PCT<>0  THEN ((B.WEIGHTED_AVG_DISC_AMT+ISNULL(B.CMM_DISCOUNT_AMOUNT,0))/(B.MRP*B.QUANTITY))*100
						   ELSE (100-(((B.MRP-(B.MRP*ISNULL(B.BASIC_DISCOUNT_PERCENTAGE,0)/100))-((B.MRP-(B.MRP*
						   ISNULL(B.BASIC_DISCOUNT_PERCENTAGE,0)/100))*C.DISCOUNT_PERCENTAGE/100))/B.MRP)*100) END)
						FROM #TMPCMD A
						JOIN CMD01106 B ON A.PRODUCT_CODE=B.PRODUCT_CODE
						JOIN CMM01106 C ON C.CM_ID=B.CM_ID
						WHERE CANCELLED=0 AND A.QUANTITY<0 AND B.QUANTITY>0
						AND C.CM_ID=(SELECT TOP 1 D.CM_ID FROM CMD01106 D JOIN CMM01106 E ON E.CM_ID=D.CM_ID
									 WHERE D.PRODUCT_CODE=A.PRODUCT_CODE AND E.LOCATION_CODE=C.LOCATION_CODE
									 AND D.QUANTITY>0 AND CANCELLED=0
									 ORDER BY E.CM_DT DESC,E.CM_NO DESC)'
			 EXEC SP_EXECUTESQL @CCMD
			 
			 SET @NSTEP = 175
			 EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
			 UPDATE #TMPCMD SET BASIC_DISCOUNT_AMOUNT=MRP*QUANTITY*BASIC_DISCOUNT_PERCENTAGE/100 WHERE QUANTITY<0

			 UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=BASIC_DISCOUNT_PERCENTAGE+CARD_DISCOUNT_PERCENTAGE,
			 DISCOUNT_AMOUNT=BASIC_DISCOUNT_AMOUNT+CARD_DISCOUNT_AMOUNT
		 			 
		END
		
	END	

	--IF @@SPID=221
	--	SELECT 'SLR CUR DISC',* FROM #TMPSLRDISC

		--IF @@SPID=170
		--BEGIN
		--	SELECT 'CHECK #TMPSLRDISC',@CPICKSLRDISCMODE CPICKSLRDISCMODE,* FROM #TMPSLRDISC			
		--	SELECT 'CHECK #TMPCMD',* FROM #TMPCMD
		--END

		
	PRINT 'ENTER STEP#'+@NSTEP
	IF EXISTS (SELECT TOP 1 PRODUCT_CODE FROM #TMPCMD WHERE QUANTITY<0) AND ISNULL(@CPICKSLRDISCMODE,'') IN ('','1','4')
	BEGIN

		SET @NSTEP = 190
		 
		EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
		
		PRINT 'NOW APPLY MAX SLR DISC - 1'
		SET @BFOUND=1
		
		--SELECT 'CHECK #TMPCMD',* FROM #TMPCMD			
		
		
		
		WHILE @BFOUND=1
		BEGIN
			SET @CPRODUCTCODE=''
					
			
			SELECT TOP 1 @CPRODUCTCODE=PRODUCT_CODE,@NCURRENTDISCAMT=DISCOUNT_AMOUNT,
			@CCMDROWID=CMD_ROW_ID FROM #TMPSLRDISC
			
			IF @BCALLEDFROMPACKSLIP=1
				SELECT TOP 1 @NCURRENTDISCAMT=(CASE WHEN isnull(weighted_avg_disc_amt,0)<>0 THEN weighted_avg_disc_amt ELSE DISCOUNT_AMOUNT end) 
				FROM #tmpCmd where cmd_row_id=@CCMDROWID

			IF ISNULL(@CPRODUCTCODE,'')=''
				BREAK

			--IF @@SPID=221
			--BEGIN
			--	SELECT 'CHECK #TMPSLRDISC',* FROM #TMPSLRDISC			
			--	SELECT 'CHECK #TMPCMD',* FROM #TMPCMD
			--END
		
		SET @NSTEP=			193
		EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE	
			
			IF @BCALLEDFROMCASHMEMO=1		
				SELECT @NLASTSLRDISCPCT=ISNULL(B.LAST_SLS_DISCOUNT_PERCENTAGE,0),@NLASTSLRDISCAMT=(A.MRP*B.QUANTITY*ISNULL(B.LAST_SLS_DISCOUNT_PERCENTAGE,0)/100) FROM #TMPCMD A
				JOIN SLS_CMD01106_UPLOAD B ON A.CMD_ROW_ID=B.ROW_ID
				WHERE B.SP_ID=@NSPID AND A.CMD_ROW_ID=@CCMDROWID
			ELSE
				SELECT @NLASTSLRDISCPCT=last_packslip_sls_DISCOUNT_PERCENTAGE,@NLASTSLRDISCAMT=last_packslip_sls_DISCOUNT_AMount FROM  #tmpSlrDisc a
				WHERE A.CMD_ROW_ID=@CCMDROWID
						
			PRINT 'NOW APPLY MAX SLR DISC - 2'+@CPRODUCTCODE+':'+STR(@NLASTSLRDISCPCT)+':'+STR(@NLASTSLRDISCAMT)+':'+STR(@NCURRENTDISCAMT)
			
			IF ((@CPICKSLRDISCMODE='1' AND ABS(@NLASTSLRDISCAMT)>ABS(@NCURRENTDISCAMT))
			 OR (@CPICKSLRDISCMODE='4' AND ABS(@NLASTSLRDISCAMT)<ABS(@NCURRENTDISCAMT))) 
			BEGIN
				PRINT 'NOW APPLY MAX SLR DISC - 3'+@CPRODUCTCODE+':'+STR(@NLASTSLRDISCPCT)+':'+STR(@NLASTSLRDISCAMT)+':'+STR(@NCURRENTDISCAMT)
				UPDATE #TMPCMD SET BASIC_DISCOUNT_PERCENTAGE=@NLASTSLRDISCPCT,
				BASIC_DISCOUNT_AMOUNT=ABS(@NLASTSLRDISCAMT)*-1 WHERE CMD_ROW_ID=@CCMDROWID
			END
			ELSE			
			BEGIN
				PRINT 'NOW APPLY DEFAULT LAST SLR DISCOUNT '
				UPDATE #TMPCMD SET 	BASIC_DISCOUNT_AMOUNT=ABS(BASIC_DISCOUNT_AMOUNT)*-1 WHERE CMD_ROW_ID=@CCMDROWID
			END

			
			DELETE FROM #TMPSLRDISC WHERE CMD_ROW_ID=@CCMDROWID			
		END
	END				

	IF EXISTS (SELECT TOP 1 PRODUCT_CODE FROM #TMPCMD WHERE QUANTITY<0 AND ISNULL(BILL_LEVEL_DISCOUNT_PERCENTAGE,0)<>0)
	BEGIN
		SET @NSTEP=195
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
--		SELECT 'BEFORE RECAL BILL LEVEL DISCOUNT',BILL_LEVEL_DISCOUNT_AMOUNT,SUM(NET) AS NET,SUM((MRP*QUANTITY)-BASIC_DISCOUNT_AMOUNT) AS NET_CALC FROM #TMPCMD
--		GROUP BY BILL_LEVEL_DISCOUNT_AMOUNT

		UPDATE A SET BILL_LEVEL_DISCOUNT_AMOUNT=ROUND(B.NET*BILL_LEVEL_DISCOUNT_PERCENTAGE/100,2)
		FROM #TMPCMD  A JOIN (SELECT SUM((MRP*QUANTITY)-BASIC_DISCOUNT_AMOUNT) AS NET FROM #TMPCMD) B ON 1=1		



--		SELECT 'AFTER RECAL BILL LEVEL DISCOUNT',BILL_LEVEL_DISCOUNT_AMOUNT,SUM(NET) AS NET,SUM((MRP*QUANTITY)-BASIC_DISCOUNT_AMOUNT) AS NET_CALC FROM #TMPCMD
--		GROUP BY BILL_LEVEL_DISCOUNT_AMOUNT
	END

		--IF @@SPID=61
		--	SELECT 'CHECK #TMPCMD FINAL AFTER EOSS',* FROM #TMPCMD 	
	GOTO EXIT_PROC
END TRY

BEGIN CATCH
	SET @CERRORMSG='ERROR IN PROC SP3S_EOSS_GETDISCOUNTS AT STEP#'+LTRIM(RTRIM(STR(@NSTEP)))+' '+ERROR_MESSAGE()
	
	PRINT 'ENTER CATCH BLOCK OF SP3S_EOSS_GETDISCOUNTS '+@CERRORMSG

	GOTO EXIT_PROC

END CATCH


EXIT_PROC:
	
	IF @BGETBCDISC=1
	BEGIN
		PRINT 'UPDATE GETBC DP-1'
		--IF @@SPID=252
		--	SELECT 'CHECK #TMPCMD BEFORE',MRP,NET,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT, * FROM #TMPCMD

		SET @NSTEP=197
		EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
		UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ROUND((DISCOUNT_AMOUNT/MRP)*100,2) WHERE DISCOUNT_PERCENTAGE=0
		AND DISCOUNT_AMOUNT<>0

		PRINT 'UPDATE GETBC DP-2'
		UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ROUND(((MRP-(NET/QUANTITY))/MRP)*100,2) WHERE DISCOUNT_PERCENTAGE=0
		AND DISCOUNT_AMOUNT=0 AND NET<>0

		PRINT 'UPDATE GETBC DP-3'
		UPDATE #TMPCMD SET DISCOUNT_AMOUNT=MRP*DISCOUNT_PERCENTAGE*QUANTITY/100 WHERE DISCOUNT_AMOUNT=0

		PRINT 'UPDATE GETBC DP-4'
		UPDATE #TMPCMD SET NET=((MRP*QUANTITY)-DISCOUNT_AMOUNT) WHERE NET=0


		--IF @@SPID=252
		--	SELECT 'CHECK #TMPCMD AFTER UPDATING',MRP,NET,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT, * FROM #TMPCMD
	END



	--IF @@SPID=114
	--	SELECT 'CHECK #TMPCMD FINAL-2 AFTER EOSS',* FROM #TMPCMD 

	PRINT 'LAST STEP OF SP3S_EOSS_GETDISCOUNTS :'+STR(@NSTEP)	
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@BDEBUGMODE
	SET @NSTEP=199	

END
---- 'END OF CREATING PROCEDURE SP3S_EOSS_GETDISCOUNTS'