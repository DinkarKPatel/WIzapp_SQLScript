

--**** START OF PROCEDURE UPDATEMASTERXN
CREATE PROCEDURE UPDATEMASTERXN_INS 
			@CSOURCEDB VARCHAR(100),
			@CSOURCETABLE VARCHAR(100),
			@CDESTDB VARCHAR(100),
			@CDESTTABLE VARCHAR(100),
			@CKEYFIELD1 VARCHAR(40)='',
			@CFILTERCONDITION VARCHAR(500)=''
--WITH ENCRYPTION			
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @CWC VARCHAR(100),
			@CINSERTSTR NVARCHAR(MAX),
			@CINSERTSTRVALUE NVARCHAR(MAX),
			@CWHERECLAUSE NVARCHAR(MAX),
			@CCMD NVARCHAR(MAX),@CCURLOCID CHAR(2),
			@LDONOTREPLNULLS BIT,
			@CSOURCETABLESTR VARCHAR(100),@CDESTTABLESTR VARCHAR(100)
	
	
	SELECT @CSOURCETABLESTR=(CASE WHEN LEFT(@CSOURCETABLE,1)<>'[' THEN '[' ELSE '' END)+
				  @CSOURCETABLE+(CASE WHEN RIGHT(@CSOURCETABLE,1)<>']' THEN ']' ELSE '' END),
		 @CDESTTABLESTR=(CASE WHEN LEFT(@CDESTTABLE,1)<>'[' THEN '[' ELSE '' END)+
				  @CDESTTABLE+(CASE WHEN RIGHT(@CDESTTABLE,1)<>']' THEN ']' ELSE '' END)
				  

	SET @CWC = ''
	IF @CKEYFIELD1 <> ''
		SET @CWC = 'A.' + @CKEYFIELD1 + ' = B.' + @CKEYFIELD1
	
	IF @CWC <> ''
		SET @CWC = ' ON ' + @CWC 


	EXEC SP_INSERTCOLUMNLIST @CSOURCETABLE,@LDONOTREPLNULLS,'', @CINSERTSTR OUTPUT, @CINSERTSTRVALUE OUTPUT, 'B'

	
	SET @CCMD = N' INSERT ' + @CDESTDB + @CDESTTABLESTR+
				  ' ( ' + @CINSERTSTR + ' ) ' +
				 ' SELECT ' + @CINSERTSTRVALUE + 
				 ' FROM ' + @CSOURCEDB + @CSOURCETABLESTR+ ' B '

	IF (@CFILTERCONDITION<>'')
	BEGIN
		SET @CCMD = @CCMD +  ' WHERE ' + @CFILTERCONDITION
	END

	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
END
--*************************************** END OF PROCEDURE UPDATEMASTERXN_INS
