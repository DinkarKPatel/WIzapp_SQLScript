CREATE VIEW VW_SALEAPPROVAL_LIST  

AS       
  
SELECT A.MEMO_NO,A.MEMO_DT,A.MEMO_ID,
(CASE WHEN A.CANCELLED = 1 THEN 0  ELSE ISNULL(D.TOTAL_QUANTITY,0) END) AS TOTAL_QUANTITY,  
(CASE WHEN A.CANCELLED = 1 THEN 0  ELSE A.SUBTOTAL END) AS SUBTOTAL,  
(CASE WHEN A.CANCELLED = 1 THEN 0  ELSE A.NET_AMOUNT END) AS NET_AMOUNT,  
(CASE WHEN A.MEMO_TYPE=1 THEN B.CUSTOMER_FNAME + ' ' + B.CUSTOMER_LNAME  ELSE C.AC_NAME END) AS CUSTOMER_NAME,  
(CASE WHEN A.CANCELLED = 1 THEN 0  ELSE A.ROUND_OFF END) AS ROUND_OFF,
A.DISCOUNT_PERCENTAGE,  
(CASE WHEN A.CANCELLED = 1 THEN 0  ELSE A.DISCOUNT_AMOUNT END) AS DISCOUNT_AMOUNT ,  
(CASE WHEN A.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END) AS CANCELLED,
(CASE WHEN A.MEMO_TYPE = 1 THEN 'SALE APPROVAL' ELSE 'WHOLE SALE APPROVAL' END) AS MEMO_TYPE,
(CASE WHEN ISNULL(E.COUNT_ROWP,0)<= 0 THEN 'APPROVAL SETTELED' ELSE 
(CASE WHEN ISNULL(E.COUNT_ROWP,0)>0 AND ISNULL(F.COUNT_ROW,0)> 0 THEN 'PARTIALLY SETTELED' ELSE 'PENDING' END )END) AS STATUS,

A.FIN_YEAR 
--ISNULL(E.COUNT_ROWP,0) AS PENDING_QTY ,ISNULL(F.COUNT_ROW,0) AS RETURN_QTY 
,A.location_Code
FROM APM01106 A (NOLOCK)   
LEFT JOIN CUSTDYM B (NOLOCK) ON A.CUSTOMER_CODE = B.CUSTOMER_CODE  
LEFT JOIN LMV01106 C (NOLOCK) ON A.AC_CODE = C.AC_CODE  
LEFT OUTER JOIN   
(SELECT MEMO_ID,SUM(QUANTITY) AS TOTAL_QUANTITY FROM APD01106 GROUP BY MEMO_ID) D ON D.MEMO_ID=A.MEMO_ID 
LEFT OUTER JOIN
(
SELECT COUNT(A.MEMO_ID) AS COUNT_ROWP, A.MEMO_ID,A.MEMO_TYPE
FROM APM01106 A 
JOIN APD01106 B ON A.MEMO_ID = B.MEMO_ID         
LEFT OUTER JOIN         
(SELECT APD_ROW_ID,C.MEMO_TYPE,SUM(A.QUANTITY) AS RET_QTY FROM APPROVAL_RETURN_DET A       
JOIN APPROVAL_RETURN_MST MST ON A.MEMO_ID=MST.MEMO_ID       
JOIN APD01106 B ON A.APD_ROW_ID=B.ROW_ID     
JOIN APM01106 C ON C.MEMO_ID=B.MEMO_ID        
WHERE C.CANCELLED=0 AND MST.CANCELLED=0    
GROUP BY APD_ROW_ID,C.MEMO_TYPE) C ON C.APD_ROW_ID=B.ROW_ID  AND C.MEMO_TYPE = A.MEMO_TYPE
WHERE (B.QUANTITY-ISNULL(C.RET_QTY,0)) > 0  
GROUP BY A.MEMO_ID,A.MEMO_TYPE 
) E ON A.MEMO_ID = E.MEMO_ID AND A.MEMO_TYPE = E.MEMO_TYPE 

LEFT OUTER JOIN
(

 SELECT COUNT(APM.MEMO_ID) AS COUNT_ROW,APM.MEMO_ID,APM.MEMO_TYPE 
 FROM APPROVAL_RETURN_DET A
 JOIN APD01106 APD ON A.APD_ROW_ID=APD.ROW_ID
 JOIN APM01106 APM ON APM.MEMO_ID=APD.MEMO_ID
 GROUP BY APM.MEMO_ID,APM.MEMO_TYPE
) F ON A.MEMO_ID = F.MEMO_ID AND A.MEMO_TYPE = F.MEMO_TYPE
