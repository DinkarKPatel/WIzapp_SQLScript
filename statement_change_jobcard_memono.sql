
IF NOT EXISTS (SELECT TOP 1 'U'  FROM INFORMATION_SCHEMA .COLUMNS 
WHERE TABLE_NAME ='ORD_PLAN_MST' AND COLUMN_NAME ='MEMO_NO' AND DATA_TYPE ='varchar' )
BEGIN
   
   
   DECLARE @CCMD1 NVARCHAR(MAX)
   
   
   IF OBJECT_ID ('TEMPDB..#TMPCONS','U') IS NOT NULL
      DROP TABLE #TMPCONS
   
 
   SELECT  TABLE_NAME ,CONSTRAINT_NAME into #TMPCONS FROM INFORMATION_SCHEMA .CONSTRAINT_COLUMN_USAGE
   WHERE TABLE_NAME ='ORD_PLAN_MST'
   AND COLUMN_NAME IN('MEMO_NO')
   
   
   DECLARE @CTABLE_NAME VARCHAR(100),@CCONSNAME VARCHAR(1000)
   
   WHILE EXISTS (SELECT TOP 1 'U' FROM #TMPCONS)
   BEGIN
       
       
       SELECT TOP 1 @CTABLE_NAME=TABLE_NAME ,@CCONSNAME=CONSTRAINT_NAME FROM #TMPCONS
      
       
       SET @CCMD1=N' ALTER TABLE '+@CTABLE_NAME+' DROP CONSTRAINT ' +@CCONSNAME
       EXEC SP_EXECUTESQL @CCMD1
       
       DELETE FROM #TMPCONS WHERE TABLE_NAME=@CTABLE_NAME AND CONSTRAINT_NAME=@CCONSNAME
       
   
   END
   

   ALTER TABLE ORD_PLAN_MST ALTER COLUMN MEMO_NO VARCHAR(25) NOT NULL
   ALTER TABLE ORD_PLAN_MST ADD CONSTRAINT UNQ_ORD_PLAN_MST_MEMO_NO UNIQUE (DEPT_ID, FIN_YEAR, MEMO_NO)
   
END



 ;with cte as
 (
 select NEWLASTKEYVAL=  
 CASE WHEN LEN(REPLACE(LASTKEYVAL,PREFIX,''))<=6 THEN
  PREFIX+CAST(REPLICATE ('0',6-LEN(REPLACE(LASTKEYVAL,PREFIX,''))) AS VARCHAR(100))
       +REPLACE(LASTKEYVAL,PREFIX,'')   
       ELSE
     PREFIX+CAST(RIGHT(LASTKEYVAL,6) AS VARCHAR(100)) END,*
 FROM KEYS  A  (NOLOCK)
 WHERE TABLENAME ='ORD_PLAN_MST' 
 AND FINYEAR ='01122'
 )

 UPDATE CTE SET LASTKEYVAL=NEWLASTKEYVAL WHERE NEWLASTKEYVAL <>LASTKEYVAL 
UPDATE A SET PREFIX=PREFIX+'-' 
FROM KEYS A (NOLOCK)
WHERE TABLENAME ='ORD_PLAN_MST' and FinYear ='01122'
AND RIGHT(PREFIX,1)<>'-'
