create  PROCEDURE SPOLAP_SEND_MIRROR_SNC_DATA  
(  
  @CUPLOADEDXNID VARCHAR(50)  
 ,@BACKNOWLEDGE BIT=0 
 ,@CERRMSG VARCHAR(1000) OUTPUT  
)  
AS  
BEGIN  
DECLARE @DTSQL NVARCHAR(MAX),@NSPID INT,@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),  
@CTEMPEMPLOYEETABLE VARCHAR(200),@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),  
@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX),  
@CTEMPMASTERTABLE VARCHAR(200),@CTEMPDETAILTABLE VARCHAR(200),@CTEMPLMTABLE VARCHAR(200),  
@CTEMPLMPTABLE VARCHAR(200),@CTEMPAREATABLE VARCHAR(200),@CTEMPCITYTABLE VARCHAR(200),  
@CTEMPSKUTABLE VARCHAR(200),@CTEMPARTTABLE VARCHAR(200),@CTEMPSDTABLE VARCHAR(200),  
@CTEMPARTATTRTABLE VARCHAR(200),@CTEMPDETAILTABLE1 VARCHAR(200),@CTEMPDETAILTABLE2 VARCHAR(200),  
@CTEMPSNCARTICLETABLE VARCHAR(200),@CTEMPSNCSKUTABLE VARCHAR(200),@CTEMPSNCBARCODETABLE VARCHAR(200),  
@CTEMPART_ATTRTABLE VARCHAR(500)  ,@CTEMPDBNAME varchar(100)
  

BEGIN TRY  
SET @CSTEP=00  
  

 set @CTEMPDBNAME=''
--CHNAGE BY BAIJNATH  
SET @CMEMOID=@CUPLOADEDXNID  
  
SET @CSTEP=40  
---- IF NO MEMO FOUND , JUST END THE PROCESS  
IF ISNULL(@CMEMOID,'')=''  
GOTO END_PROC  
  
LBLTABLEINFO:  
SET @CSTEP=50  

EXEC SP3S_GET_CURSOR_BASED_ON_OLAP_XNSSENDING_COLS @cXNTYPE='SNC',@cTABLENAME='SNC_MST',@cKEYNAME='MEMO_ID',@cKEYVALUE=@CMEMOID,@bSKUNAMES=0,@CERRMSG=@CERRMSG OUTPUT 
	IF ISNULL(@CERRMSG,'')<>'' 
		GOTO END_PROC

SET @CSTEP=240  
---- SEND THE SNC_BARCODE_DET TABLE  

EXEC SP3S_GET_CURSOR_BASED_ON_OLAP_XNSSENDING_COLS @cXNTYPE='SNC',@cTABLENAME='SNC_CONSUMABLE_DET',@cKEYNAME='MEMO_ID',@cKEYVALUE=@CMEMOID,@bSKUNAMES=0,@CERRMSG=@CERRMSG OUTPUT 
	IF ISNULL(@CERRMSG,'')<>'' 
		GOTO END_PROC


SET @CSTEP=300  
EXEC SP3S_GET_CURSOR_BASED_ON_OLAP_XNSSENDING_COLS @cXNTYPE='SNC',@cTABLENAME='SNC_DET',@cKEYNAME='MEMO_ID',@cKEYVALUE=@CMEMOID,@bSKUNAMES=0,@CERRMSG=@CERRMSG OUTPUT 
	IF ISNULL(@CERRMSG,'')<>'' 
		GOTO END_PROC
  
SET @CSTEP=320  
---- SEND THE SNC MEMO DETAIL TABLE  
SELECT DISTINCT 'SNC_SNC_BARCODE_DET_upload' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID  
FROM SNC_BARCODE_DET  A (NOLOCK)
JOIN SNC_DET B (NOLOCK) ON A.REFROW_ID =B.ROW_ID 
WHERE B.MEMO_ID =@CMEMOID

SET @CSTEP=325  


SELECT DISTINCT 'OLAP_SKU_upload' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID  
FROM SKU A
JOIN SNC_BARCODE_DET  B (NOLOCK) ON A.product_code =B.PRODUCT_CODE 
JOIN SNC_DET C (NOLOCK) ON B.REFROW_ID =C.ROW_ID 
WHERE C.MEMO_ID =@CMEMOID



SELECT DISTINCT 'OLAP_SKU_names_upload' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID  
FROM sku_names A
JOIN SNC_BARCODE_DET  B (NOLOCK) ON A.product_code =B.PRODUCT_CODE 
JOIN SNC_DET C (NOLOCK) ON B.REFROW_ID =C.ROW_ID 
WHERE C.MEMO_ID =@CMEMOID


SET @CSTEP=261
SELECT DISTINCT 'OLAP_PMT01106_UPLOAD' AS TARGET_TABLENAME, A.DEPT_ID,A.PRODUCT_CODE,A.BIN_ID,A.QUANTITY_IN_STOCK
 FROM PMT01106 A 
 JOIN SNC_BARCODE_DET B ON B.PRODUCT_CODE=A.PRODUCT_CODE
 JOIN SNC_DET C ON B.REFROW_ID=C.ROW_ID
  WHERE C.MEMO_ID=@CMEMOID
 UNION
 SELECT DISTINCT 'OLAP_PMT01106_UPLOAD' AS TARGET_TABLENAME, A.DEPT_ID,A.PRODUCT_CODE,A.BIN_ID,A.QUANTITY_IN_STOCK
 FROM PMT01106 A 
 JOIN SNC_CONSUMABLE_DET B ON B.PRODUCT_CODE=A.PRODUCT_CODE AND a.bin_id=b.bin_id
 WHERE B.MEMO_ID =@CMEMOID  

   
GOTO END_PROC  
  
END TRY  
BEGIN CATCH  
SET @CERRMSG='P: SPOLAP_SEND_MIRROR_SNC_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
GOTO END_PROC  
END CATCH  
END_PROC:  

END  

