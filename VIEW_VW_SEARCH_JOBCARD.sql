CREATE VIEW VW_SEARCH_JOBCARD
AS
SELECT A.MEMO_NO,A.MEMO_ID,A.MEMO_DT, A.CANCELLED,A.TOTAL_QUANTITY_STR
,(CASE WHEN A.CANCELLED=1 THEN 'YES' ELSE 'NO' END) AS CANCELLED_STR
,A.ORD_PLAN_MODE
,(CASE WHEN A.ORD_PLAN_MODE=1 THEN 'DIRECT' ELSE 'AGAINST ORDER' END) AS ORD_PLAN_MODE_STR
,A.AC_CODE,B.AC_NAME,X.ORDER_ID,X.ORDER_NO,X.REF_NO ,X.ORDER_DT ,X.BUYER_NAME
,(CASE	WHEN X1.MEMO_ID IS NULL THEN 'PENDING' 
		WHEN X3.MEMO_ID IS NOT NULL AND X3.ORD_QTY=X3.TRF_QTY THEN 'SETTLED'	
		WHEN X3.MEMO_ID IS NOT NULL AND X3.ORD_QTY<>X3.TRF_QTY THEN 'PARCIALLY SETTLED'
		ELSE 'IN PROCESS' END) AS ORD_PLAN_ISSUED_STR
,CONVERT(INT,(CASE	WHEN X1.MEMO_ID IS NULL THEN 1 
					WHEN X3.MEMO_ID IS NOT NULL AND X3.ORD_QTY=X3.TRF_QTY THEN 2
					WHEN X3.MEMO_ID IS NOT NULL AND X3.ORD_QTY<>X3.TRF_QTY THEN 3
					ELSE 0 END) 
		) AS ORD_PLAN_ISSUED,U.username 
FROM ORD_PLAN_MST A (NOLOCK)
JOIN LM01106 B  (NOLOCK)ON B.AC_CODE=A.AC_CODE
JOIN USERS U (NOLOCK) ON A.user_code = U.USER_CODE
LEFT OUTER JOIN 
(
	SELECT A.MEMO_ID,C.ORDER_ID ,C.ORDER_NO,C.REF_NO,C.ORDER_DT,D.AC_NAME BUYER_NAME
	FROM ORD_PLAN_DET A  (NOLOCK)
	JOIN BUYER_ORDER_DET B  (NOLOCK) ON B.ROW_ID=A.WOD_ROW_ID
	JOIN BUYER_ORDER_MST C  (NOLOCK) ON C.ORDER_ID=B.ORDER_ID
	JOIN LM01106 D  (NOLOCK) ON D.AC_CODE=C.AC_CODE
	WHERE A.WOD_ROW_ID<>''
	GROUP BY A.MEMO_ID,C.ORDER_ID	,C.ORDER_NO,C.REF_NO,C.ORDER_DT,D.AC_NAME
)X ON X.MEMO_ID=A.MEMO_ID
LEFT OUTER JOIN 
(
	SELECT A.MEMO_ID
	FROM ORD_PLAN_DET A (NOLOCK) 
	JOIN ORD_PLAN_BARCODE_DET B (NOLOCK) ON B.REFROW_ID=A.ROW_ID
	JOIN JOBWORK_ISSUE_DET C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
	JOIN JOBWORK_ISSUE_MST C1 (NOLOCK) ON C1.ISSUE_ID=C.ISSUE_ID
	WHERE C1.CANCELLED=0
	GROUP BY A.MEMO_ID
)X1 ON X1.MEMO_ID=A.MEMO_ID
LEFT OUTER JOIN 
(
	SELECT A.MEMO_ID,SUM(A.QUANTITY)AS ORD_QTY,SUM(C.QUANTITY) AS TRF_QTY
	FROM ORD_PLAN_DET A (NOLOCK) 
	JOIN ORD_PLAN_BARCODE_DET B (NOLOCK) ON B.REFROW_ID=A.ROW_ID
	LEFT OUTER JOIN TRANSFER_TO_TRADING_DET C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
	LEFT OUTER JOIN TRANSFER_TO_TRADING_MST C1 (NOLOCK) ON C1.MEMO_ID=C.MEMO_ID
	WHERE C1.CANCELLED=0
	GROUP BY A.MEMO_ID
)X3 ON X3.MEMO_ID=A.MEMO_ID
