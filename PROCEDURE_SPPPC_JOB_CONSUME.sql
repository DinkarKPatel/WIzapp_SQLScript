CREATE PROCEDURE SPPPC_JOB_CONSUME
( 
 @CROW_ID VARCHAR(100)='',
 @CJOB_NAME VARCHAR(100)=''
)
AS
BEGIN

     SELECT JOBS.JOB_CODE AS JOB_CODE,JOBS.JOB_NAME,
           A.ORDER_ID, B.ARTICLE_CODE,B.PARA1_CODE,
           B.SIZEGROUP_CODE,B.PARA3_CODE,B.QUANTITY,
     CAST(CASE WHEN CON.REF_ROW_ID IS NULL THEN 0 ELSE 1 END AS BIT)  AS CHK,
     C.BOM_ARTICLE_CODE,ART.ARTICLE_NO AS ARTICLE, 
     AVG_QTY AS BOM_QTY,
     ISNULL(USED_QTY,0) AS USED_QTY,
     ISNULL(CONSUME_QTY,0) AS CONSUME_QTY,
     UOM.UOM_NAME,
     CAST(0 AS BIT) AS DEBIT_FOR_JOBWORK
     FROM PPC_BUYER_ORDER_MST A
     JOIN PPC_BUYER_ORDER_DET B ON A.ORDER_ID=B.ORDER_ID
     JOIN PPC_BO_ART_BOM C ON B.ROW_ID=C.REF_ROW_ID
     JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.BOM_ARTICLE_CODE
     JOIN UOM ON UOM.UOM_CODE=ART.UOM_CODE
     JOIN JOBS ON JOBS.JOB_NAME=@CJOB_NAME
     LEFT OUTER JOIN PPC_BO_ART_JOBS_CONSUME CON ON CON.REF_ROW_ID=@CROW_ID AND CON.JOB_CODE=JOBS.JOB_CODE
     AND C.BOM_ARTICLE_CODE=CON.BOM_ARTICLE_CODE
     LEFT OUTER JOIN
     (
      SELECT  BOM_ARTICLE_CODE, REF_ROW_ID,SUM(CONSUME_QTY ) AS USED_QTY 
      FROM  PPC_BO_ART_JOBS_CONSUME A
      JOIN JOBS B ON A.JOB_CODE=B.JOB_CODE 
      WHERE REF_ROW_ID=@CROW_ID AND B.JOB_NAME<>@CJOB_NAME
      GROUP BY  BOM_ARTICLE_CODE,REF_ROW_ID
     ) U ON U.REF_ROW_ID =C.REF_ROW_ID  AND U.BOM_ARTICLE_CODE=C.BOM_ARTICLE_CODE --AND U.JOB_CODE=JOBS.JOB_CODE
     WHERE B.ROW_ID=@CROW_ID --AND  AVG_QTY-ISNULL(USED_QTY,0)>0
     --JOIN PPC_BUYER_ORDER_DET B ON A.ORDER_ID=B.ORDER_ID
     
    -- SELECT * FROM PPC_BO_ART_BOM

END
