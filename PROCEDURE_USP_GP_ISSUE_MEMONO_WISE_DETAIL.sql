CREATE PROCEDURE USP_GP_ISSUE_MEMONO_WISE_DETAIL
(
 @CMEMO_NO VARCHAR(50) = ''
)
AS
  BEGIN
		SELECT CHK,MEMO_ID,INV_ID
		  ,INV_NO,INV_DT,AC_NAME,QUANTITY
		  ,[WEIGHT],TOTAL_BOXES
		  ,FIN_YEAR,USER_CODE,LAST_UPDATE,EDT_USER_CODE
		  ,[REMARKS_MST],[REMARKS_DET],HANDOVER_USER_CODE
		  ,HANDOVER_LAST_UPDATE
		  ,ISNULL(LTRIM(RTRIM(ANGADIA_ADD1)),'')+' '+ISNULL(LTRIM(RTRIM(ANGADIA_ADD2)),'')+' ' 
		  + ISNULL(LTRIM(RTRIM(AREA_NAME)),'')+' '+ISNULL(LTRIM(RTRIM(CITY)),'')
		  
		  AS [ADDRESS]
		  ,TRANSPORTER_CODE,TRANSPORTER_NAME
	       FROM 
	       (
			SELECT 0 AS CHK,GPD.MEMO_ID,GPD.INV_ID
				  ,INM.INV_NO,INM.INV_DT,LM.AC_NAME
				  ,CAST(SUM(IND.QUANTITY) AS NUMERIC(10,2))AS QUANTITY
				  ,PRb.QTY AS [WEIGHT],0 as TOTAL_BOXES
				  ,GPM.FIN_YEAR,GPM.USER_CODE,GPM.LAST_UPDATE,GPM.EDT_USER_CODE
				  ,GPM.REMARKS AS [REMARKS_MST],GPD.REMARKS AS [REMARKS_DET],GPM.HANDOVER_USER_CODE
				  ,HANDOVER_LAST_UPDATE,AGM.ANGADIA_ADD1,AGM.ANGADIA_ADD2,AR.AREA_NAME,CT.CITY,
				  GPM.TRANSPORTER_CODE,AGM.ANGADIA_NAME AS TRANSPORTER_NAME
			FROM DBO.TBL_GP_ISSUE_MST GPM WITH(NOLOCK)
				JOIN DBO.TBL_GP_ISSUE_DET GPD WITH(NOLOCK) ON GPM.MEMO_ID=GPD.MEMO_ID
				LEFT JOIN TBL_GP_RETURN_MST GRM (NOLOCK) ON GRM.ISSUE_MEMO_ID=GPM.MEMO_ID
				LEFT JOIN TBL_GP_RETURN_DET GRD (NOLOCK) ON GRD.MEMO_ID=GRM.MEMO_ID
				
				 JOIN IND01106 IND WITH(NOLOCK) ON GPD.INV_ID=IND.INV_ID
				 JOIN INM01106 INM WITH(NOLOCK) ON IND.INV_ID=INM.INV_ID
				 LEFT JOIN TBL_GP_RETURN_LOG LOG (NOLOCK) ON LOG.INV_ID=INM.INV_ID 
				
				JOIN PARCEL_DET PRB WITH(NOLOCK) ON INM.INV_ID=PRB.REF_MEMO_ID
				JOIN PARCEL_MST PRM WITH(NOLOCK) ON PRB.PARCEL_MEMO_ID=PRM.PARCEL_MEMO_ID
				JOIN LM01106 LM WITH(NOLOCK) ON INM.AC_CODE=LM.AC_CODE
				JOIN DBO.ANGM AGM WITH(NOLOCK) ON GPM.TRANSPORTER_CODE=AGM.ANGADIA_CODE
				JOIN DBO.AREA AR WITH(NOLOCK) ON AGM.AREA_CODE=AR.AREA_CODE
				JOIN DBO.CITY CT WITH(NOLOCK) ON AR.CITY_CODE=CT.CITY_CODE
		    WHERE (@CMEMO_NO  = '' OR GPM.MEMO_NO=@CMEMO_NO) AND LOG.INV_ID IS NULL
			GROUP BY GPD.MEMO_ID,GPD.INV_ID,GPD.REMARKS
				  ,INM.INV_NO,INM.INV_DT,LM.AC_NAME
				  ,PRb.QTY
				  ,GPM.FIN_YEAR,GPM.USER_CODE,GPM.LAST_UPDATE,GPM.EDT_USER_CODE
				  ,GPM.REMARKS ,GPM.HANDOVER_USER_CODE
				  ,HANDOVER_LAST_UPDATE
				,AGM.ANGADIA_ADD1,AGM.ANGADIA_ADD2,AR.AREA_NAME,CT.CITY,
				GPM.TRANSPORTER_CODE,AGM.ANGADIA_NAME
		  )T

  END
