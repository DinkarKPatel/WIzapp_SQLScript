CREATE PROCEDURE SP_PROCESS_SKURECDT--(LocId 3 digit change by Sanjay:06-11-2024)
@NMODE INT
--WITH ENCRYPTION
AS  
BEGIN  
       
	 DECLARE @CERRORMSG VARCHAR(1000), @CCURDEPTID varCHAR(4),	 @CHODEPTID varCHAR(4),@NSTEP INT, 
			 @CCMD NVARCHAR(MAX),@BPROCEED BIT, @CTARGETTABLENAME VARCHAR(100),@BDONOTSEND BIT,
			 @NRECCOUNT INT,@CTEMPTARGETTABLENAME VARCHAR(500),@CXNTYPE	VARCHAR(MAX),@CDEPTID VARCHAR(5),
			 @CCUTOFFDATE VARCHAR(10),@NAGEINGDAYS1 INT,@NAGEINGDAYS2 INT,@CSLSMEMONO VARCHAR(30)
	 
	 
	 SET @NSTEP=10
	 	    
	 SELECT @CERRORMSG='',@BPROCEED=1
	   
	 SELECT TOP 1 @CCURDEPTID = [VALUE] FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'  
	 
	 SELECT TOP 1 @CHODEPTID = [VALUE] FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'  
	   
	 DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(MAX),  
								  DEPT_ID VARCHAR(10),MEMO_LAST_UPDATE DATETIME)  
	 
	 SET @NSTEP=20
	 

BEGIN TRY

	 IF @NMODE=1 AND @CCURDEPTID<>@CHODEPTID
	 BEGIN
		SET @CERRORMSG='THIS PROCESS CANNOT BE RUN FROM LOCATION....'
		GOTO LBLLAST
	 END
	 
	 IF @NMODE=2 AND @CCURDEPTID=@CHODEPTID
	 BEGIN
		SET @CERRORMSG='THIS PROCESS CANNOT BE RUN FROM HEAD OFFICE....'
		GOTO LBLLAST
	 END
	 		 
	 IF @NMODE=2
		GOTO LBLMERGE
		
LBLSEND:  

	 SELECT TOP 1 @CCUTOFFDATE=VALUE  FROM CONFIG WHERE CONFIG_OPTION='SEND_SKURECDT_CUTOFFDATA'
	 
	 IF ISNULL(@CCUTOFFDATE,'')=''
	 BEGIN
		SET @CERRORMSG='CUT OFF DATE FOR SENDING SKU RECEIPT DATES NOT DEFINED IN SYSTEM CONFIGURATION.....PLEASE CHECK'
		GOTO LBLLAST
	 END
	 
	 SELECT TOP 1 @NAGEINGDAYS1=AGE_DAYS1,@NAGEINGDAYS2=AGE_DAYS2,@CSLSMEMONO=A.SLS_MEMO_NO FROM SLSDET A JOIN SLSMST B ON A.SLS_MEMO_NO=B.SLS_MEMO_NO 
	 WHERE CONVERT(VARCHAR,GETDATE(),110) BETWEEN SLS_FROM_DT AND SLS_TO_DT 
	 AND AGE_DAYS1<>0 AND AGE_DAYS2<>0
	 
	 IF ISNULL(@NAGEINGDAYS1,0)=0
	 BEGIN
		SET @CERRORMSG='NO ACTIVE SALES SETUP TITLE HAVING AGEING DAYS START RANGE FOUND.....PLEASE CHECK'
		GOTO LBLLAST
	 END

	 IF ISNULL(@NAGEINGDAYS2,0)=0
	 BEGIN
		SET @CERRORMSG='NO ACTIVE SALES SETUP TITLE HAVING AGEING DAYS END RANGE FOUND.....PLEASE CHECK'
		GOTO LBLLAST
	 END
	 
	 SET @NSTEP=30	 
 	 
 	 SET @CTARGETTABLENAME = 'SKU_RECEIPT_DATES'
 	 PRINT @CTEMPTARGETTABLENAME  
 	 
 	 
 	 IF CURSOR_STATUS('GLOBAL','SLSAGEINGCUR') IN (0,1)
 	 BEGIN
 		CLOSE SLSAGEINGCUR
 		DEALLOCATE SLSAGEINGCUR
 	 END
 	 
 	 DECLARE SLSAGEINGCUR CURSOR FOR SELECT DEPT_ID FROM LOCSLSSET  WHERE SLS_MEMO_NO=@CSLSMEMONO
 	 AND DEPT_ID<>@CCURDEPTID
 	 
 	 OPEN SLSAGEINGCUR
 	 FETCH NEXT FROM SLSAGEINGCUR INTO @CDEPTID
 	 WHILE @@FETCH_STATUS=0
 	 BEGIN
		
 		SET @NSTEP=40
		SET @CTEMPTARGETTABLENAME = 'TMP_'+@CTARGETTABLENAME+'_'+@CDEPTID+'_'+LTRIM(RTRIM(STR(@@SPID)))  		
 		SET @CCMD =N'IF OBJECT_ID('''+@CTEMPTARGETTABLENAME+ ''',''U'') IS NOT NULL 
 						DROP TABLE ' +@CTEMPTARGETTABLENAME
 		EXEC SP_EXECUTESQL @CCMD  
		
		SET @NSTEP=50
	    SET @CCMD =N'SELECT PRODUCT_CODE,B.RECEIPT_DT INTO '+@CTEMPTARGETTABLENAME+' FROM PID01106 A (NOLOCK)
					 JOIN PIM01106 B (NOLOCK) ON A.MRR_ID=B.MRR_ID 
					 WHERE INV_MODE=2 AND LEFT(B.MRR_ID,2)='''+@CDEPTID+''' AND B.RECEIPT_DT>='''+@CCUTOFFDATE+''' AND CANCELLED=0 
					 AND A.TS=(SELECT TOP 1 D.TS FROM PID01106 D WITH (NOLOCK,INDEX=IND_PID01106_PC)
							   JOIN PIM01106 E (NOLOCK) ON A.MRR_ID=B.MRR_ID 
							   WHERE PRODUCT_CODE=A.PRODUCT_CODE
							   AND INV_MODE=2 AND LEFT(E.MRR_ID,2)='''+@CDEPTID+''' AND E.RECEIPT_DT>='''+@CCUTOFFDATE+'''
							   AND E.CANCELLED=0 ORDER BY E.RECEIPT_DT)'
		PRINT @CCMD					 
		EXEC SP_EXECUTESQL @CCMD
		
		
		SET @NSTEP=60
		SET @NRECCOUNT=0
		
		SET @CCMD=N'SELECT @NRECCOUNT=COUNT(*) FROM '+@CTEMPTARGETTABLENAME
		EXEC SP_EXECUTESQL @CCMD,N'@NRECCOUNT INT OUTPUT',@NRECCOUNT OUTPUT 
		
		SET @NSTEP=70
		IF ISNULL(@NRECCOUNT,0)>0
			INSERT @TXNSSENDINFO (ORG_TABLENAME,TMP_TABLENAME,XN_ID,DEPT_ID,MEMO_LAST_UPDATE)   		
			SELECT 'SKU_RECEIPT_DATES' AS ORG_TABLENAME,@CTEMPTARGETTABLENAME AS TMP_TABLENAME,@CDEPTID AS XN_ID,
			@CDEPTID AS DEPT_ID,'' AS MEMO_LAST_UPDATE			

 		FETCH NEXT FROM SLSAGEINGCUR INTO @CDEPTID
 	 END

	 CLOSE SLSAGEINGCUR
	 DEALLOCATE SLSAGEINGCUR

	 GOTO LBLLAST  
	    
LBLMERGE:  
	 
	 SET @NSTEP=80
	 BEGIN TRANSACTION
	 
	 TRUNCATE TABLE SKU_RECEIPT_DATES
	 
	 SET @CCMD=N'SELECT PRODUCT_CODE,RECEIPT_DT FROM TMP_DOCSKURECDT_SKU_RECEIPT_DATES_'+@CCURDEPTID
	 
	 INSERT SKU_RECEIPT_DATES (PRODUCT_CODE,RECEIPT_DT)
	 EXEC SP_EXECUTESQL @CCMD
	 
	 SET @NSTEP=90
	 
	 SET @CCMD=N'DROP TABLE TMP_DOCSKURECDT_SKU_RECEIPT_DATES_'+@CCURDEPTID
	 EXEC SP_EXECUTESQL @CCMD
	 
	 GOTO LBLLAST
	
END TRY


BEGIN CATCH
	SELECT @CERRORMSG='PROCEDURE SP_PROCESS_SKURECDT : STEP: '+STR(@NSTEP)+' LINE NO. :'+
	ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
			
	GOTO LBLLAST
END CATCH
	     
LBLLAST:  
   
   SET @NSTEP=100
   IF @@TRANCOUNT>0
   BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			COMMIT TRANSACTION
		ELSE
			ROLLBACK		
   END
   
   IF @NMODE=1 AND ISNULL(@CERRORMSG,'')=''
   BEGIN
		SET @NSTEP=110
		IF EXISTS (SELECT TOP 1 * FROM @TXNSSENDINFO)
			SELECT * FROM @TXNSSENDINFO
		ELSE
			SELECT 'DOCSKURECDT' AS MEMO_ID,'NO DATA FOUND FOR SENDING RECEIPT DATES OF SKU' AS ERRMSG
			
   END		
   ELSE
		SELECT 'DOCSKURECDT' AS MEMO_ID,ISNULL(@CERRORMSG,'') AS ERRMSG
END  
--********************************************** END OF PROCEDURE SP_PROCESS_SKURECDT
