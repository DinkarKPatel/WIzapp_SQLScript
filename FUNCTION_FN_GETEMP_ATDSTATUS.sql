CREATE FUNCTION FN_GETEMP_ATDSTATUS
(@CEMPID CHAR(7),@DATDDT DATETIME,@NABSENTSTATUS INT,@DSHIFTTIMEIN DATETIME,
 @DSHIFTTIMEOUT DATETIME,@DATDTIMEIN DATETIME,@DATDTIMEOUT DATETIME,
 @DEARLYCUTOFF DATETIME,@DLATECUTOFF DATETIME,@DHALFDAYCUTOFF DATETIME,@CWEEKLYOFF VARCHAR(10) )
 RETURNS VARCHAR(10)
AS
BEGIN
	DECLARE @CATDSTATUS VARCHAR(10),@CATDSTATUS1 VARCHAR(10),@CATDSTATUS2 VARCHAR(10),
	@CATDSTATUS3 VARCHAR(10)
	
	SELECT @CATDSTATUS1='',@CATDSTATUS2='',@CATDSTATUS3=''
	
	IF (@NABSENTSTATUS IN (1,2,3,4) AND ISNULL(@DATDTIMEIN,'') = '' AND ISNULL(@DATDTIMEOUT,'') = '')
	BEGIN
			IF @NABSENTSTATUS = 1 
				SET @CATDSTATUS = 'WO'
			ELSE
			IF @NABSENTSTATUS = 2	
				SET @CATDSTATUS = 'AB'
			ELSE
			IF @NABSENTSTATUS = 3	
				SET @CATDSTATUS = 'LV'
			ELSE
			IF @NABSENTSTATUS = 4	
				SET @CATDSTATUS = 'BO'	
				
	END
	ELSE
	BEGIN
			IF @CWEEKLYOFF=DATENAME(DW,@DATDDT)
				SET @CATDSTATUS1 = 'W'
			
			IF (@DATDTIMEIN='' OR @DATDTIMEOUT='' OR
			   (@DATDTIMEIN>@DHALFDAYCUTOFF	OR @DATDTIMEOUT<@DHALFDAYCUTOFF) OR
			   (@DATDTIMEIN>@DLATECUTOFF AND @DATDTIMEIN<=@DHALFDAYCUTOFF AND
				@DATDTIMEOUT<@DEARLYCUTOFF AND @DATDTIMEOUT>@DHALFDAYCUTOFF)) AND ISNULL(@CATDSTATUS1,'') <> 'W'
   				SET @CATDSTATUS2 = 'LV'	
			
			IF ISNULL(@CATDSTATUS2,'')<>'LV'
			BEGIN
				IF (@DATDTIMEIN <= @DSHIFTTIMEIN AND @DATDTIMEOUT>=@DSHIFTTIMEOUT)
					SET @CATDSTATUS2 = 'P'    
				
				IF (@DATDTIMEIN <= @DSHIFTTIMEIN) AND @CATDSTATUS2<>'P'
					SET @CATDSTATUS2 = 'O'
				ELSE
				IF (@DATDTIMEIN > @DSHIFTTIMEIN) AND (@DATDTIMEIN <= @DLATECUTOFF) AND @CATDSTATUS2 <> 'LV'	
					SET @CATDSTATUS2 = 'L'			
				ELSE
				IF (@DATDTIMEIN > @DLATECUTOFF) AND (@DATDTIMEIN <= @DHALFDAYCUTOFF) AND @CATDSTATUS2 <> 'LV'	
					SET @CATDSTATUS2 = 'H'			

				IF (@DATDTIMEOUT >= @DSHIFTTIMEOUT) AND @CATDSTATUS2<>'P'
					SET @CATDSTATUS3 = 'O'
				ELSE
				IF (@DATDTIMEOUT < @DSHIFTTIMEOUT) AND (@DATDTIMEOUT >= @DEARLYCUTOFF) AND @CATDSTATUS2 <> 'LV'	
					SET @CATDSTATUS3 = 'E'			
				ELSE
				IF (@DATDTIMEOUT < @DEARLYCUTOFF) AND (@DATDTIMEOUT >= @DHALFDAYCUTOFF) AND @CATDSTATUS2 <> 'LV'	
					SET @CATDSTATUS3 = 'H'			
			
			END
			
		SET @CATDSTATUS = ISNULL(@CATDSTATUS1,'')+ISNULL(@CATDSTATUS2,'')+ISNULL(@CATDSTATUS3,'')
	END
	
	RETURN @CATDSTATUS
		
END
