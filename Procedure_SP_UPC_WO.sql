
CREATE   PROCEDURE SP_UPC_WO    
(    
 @CORDER_ID VARCHAR(100)='',     
 @CWO_ID VARCHAR(100)='',  
 @CPARA1_CODE VARCHAR(100)='',    
 @CPARA2_CODE VARCHAR(10)='' ,
 @CARTICLE_CODE VARCHAR(15)=''
  
)    
AS    
BEGIN    
     
     
     IF OBJECT_ID ('TEMPDB..#TMPPRODUCT','U') IS NOT NULL
	   DROP TABLE #TMPPRODUCT
	 

    SELECT ISNULL(BO.AC_CODE,A.AC_CODE ) AS AC_CODE,
           ISNULL(BM.ORDER_NO ,'') AS ORDER_NO,
           ISNULL(BM.ORDER_DT ,'') AS ORDER_DT,
           A.MEMO_NO ,A.MEMO_DT ,B.ARTICLE_CODE ,
           B.PARA1_CODE ,B.PARA2_CODE,
          C.PRODUCT_CODE ,UPC.QUANTITY_IN_STOCK
    INTO #TMPPRODUCT
    FROM ORD_PLAN_MST A (NOLOCK)
    JOIN ORD_PLAN_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
    JOIN ORD_PLAN_BARCODE_DET C (NOLOCK) ON B.ROW_ID=C.REFROW_ID
    JOIN JOBWORK_PMT UPC ON UPC.PRODUCT_CODE =C.PRODUCT_CODE 
    LEFT JOIN BUYER_ORDER_DET BD (NOLOCK) ON BD.ROW_ID=WOD_ROW_ID
    LEFT JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID=BD.ORDER_ID
    LEFT OUTER JOIN BUYER_ORDER_MST BO ON BO.ORDER_ID= ISNULL(UPC.ORDER_ID ,BM.ORDER_ID )     
    WHERE A.CANCELLED=0 AND ISNULL(BM.CANCELLED,0)=0 AND ISNULL(UPC.QUANTITY_IN_STOCK ,0)>0
    AND ISNULL(ISNULL(UPC.ORDER_ID ,BM.ORDER_ID ),'')=@CORDER_ID
    AND(@CARTICLE_CODE='' OR  B.ARTICLE_CODE =@CARTICLE_CODE)
    AND B.PARA1_CODE =@CPARA1_CODE
    AND B.PARA2_CODE =@CPARA2_CODE
    AND A.MEMO_ID  =@CWO_ID
    
    DELETE A FROM #TMPPRODUCT A
    JOIN jobwork_receipt_det B ON A.PRODUCT_CODE =B.product_code 
    JOIN jobwork_receipt_mst C ON B.RECEIPT_ID =C.receipt_id 
    WHERE ISNULL(C.CANCELLED,0)=0
    
    
    
    SELECT A.* ,LM.AC_NAME 
    FROM #TMPPRODUCT A
    JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE 
  
      
      
END
