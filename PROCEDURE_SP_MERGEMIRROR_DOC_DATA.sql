CREATE PROCEDURE SP_MERGEMIRROR_DOC_DATA
@CLOCID VARCHAR(5),
@CXNTYPE VARCHAR(20),
@CXNID VARCHAR(50)
AS
BEGIN
	
	DECLARE @CMERGEDB VARCHAR(200),@CMERGEDBNAME VARCHAR(200),@CCMD NVARCHAR(MAX),@CRUN VARCHAR(2),@CERRMSG VARCHAR(MAX),
			@CSOURCEDB VARCHAR(200),@CPRIMARYDBEXETIME DATETIME,@CMIRRORDBEXETIME DATETIME,@BCHKLIST BIT,
			@CXNINFOTABLE VARCHAR(200),@CMIRRORINGENABLED VARCHAR(1),@BMSTINSERTONLY BIT,@CTEMPXNSTABLELIST VARCHAR(100),
			@CNEWMEMOID VARCHAR(50)



			

	SET @CMERGEDBNAME=DB_NAME()
	SET @BMSTINSERTONLY=1

	SET @CMERGEDB = @CMERGEDBNAME+'.DBO.'
	SET @CSOURCEDB = DB_NAME()+'_TEMP.DBO.'
	
	SET @CERRMSG=''	
	SET @BCHKLIST = 0
	--SET @CTEMPXNSTABLELIST = @CSOURCEDB+'TMP_'+@CXNTYPE+'_XNSTABLELIST_'+LTRIM(RTRIM(REPLACE(@CXNID,'-','_')))
	--SET @CCMD = N'IF OBJECT_ID('''+@CTEMPXNSTABLELIST+''',''U'') IS NOT NULL
	--				SET @BCHKLIST = 1
	--			  ELSE 
	--			  	SET @BCHKLIST = 0'
	--PRINT @CCMD
	--EXEC SP_EXECUTESQL @CCMD,N'@BCHKLIST BIT OUTPUT',@BCHKLIST OUTPUT
	--IF (@BCHKLIST = 1)
	--BEGIN			  	
	--	EXEC SP_CHK_TABLELIST @CSOURCEDB,@CMERGEDB,@CXNTYPE,@CXNID,@CERRMSG OUTPUT
	--END
	
	IF ISNULL(@CERRMSG,'') <> ''
	BEGIN
		GOTO EXIT_PROC
	END
	
	IF NOT EXISTS(SELECT TOP 1 'U' FROM SYS.DATABASES WHERE NAME=@CMERGEDBNAME)
	BEGIN
		SET @CERRMSG='P:SP_MERGE_MIRROR_DATA, MESSAGE: MIRROR DATABASE FOR DEPT_ID : '+LTRIM(RTRIM(@CLOCID))+' DOESNT EXISTS.'
		GOTO EXIT_PROC
	END
	
	SET @CCMD=N'SELECT @CRUN=VALUE FROM '+@CMERGEDB+'CONFIG WHERE CONFIG_OPTION=''DATA_SYNCH_RUNNING'''
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD,N'@CRUN VARCHAR(1) OUTPUT',@CRUN OUTPUT
	
	IF @CRUN='1'
	BEGIN
		SET @CERRMSG='RETRY'
		GOTO EXIT_PROC
	END
			
	EXEC SP3S_CHKTABLES_MIRRORDATA
	@CXNTYPE=@CXNTYPE,
	@CMEMOID=@CXNID,
	@CLOCID=@CLOCID,
	@CSOURCEDB=@CSOURCEDB,
	@CERRORMSG=@CERRMSG OUTPUT
	
	IF ISNULL(@CERRMSG,'')<>''
		GOTO EXIT_PROC
	
	SET @CNEWMEMOID=@CXNID
			
	--IF @CXNTYPE='DOCWSL' 
	--BEGIN
	--	PRINT 'SP_MERGE_MIRROR_DOCWSL_DATA'
	--	EXEC SP_MERGE_MIRROR_DOCWSL_DATA					
	--	@CMEMOID=@CXNID,
	--	@CLOCID=@CLOCID ,
	--	@CMRRID=@CNEWMEMOID OUTPUT,
	--	@CERRMSG=@CERRMSG OUTPUT					
	--END
	--ELSE
	--IF @CXNTYPE='DOCPRT' 
	--BEGIN
	--	PRINT 'SP_MERGE_MIRROR_DOCPRT_DATA'
	--	DECLARE @CMRRID VARCHAR(100),@DRMDT DATETIME

	--	SELECT @DRMDT=RM_DT FROM DOCPRT_RMM01106_MIRROR WHERE RM_ID=@CXNID

	--	EXEC SAVETRAN_MERGE_MIRRO_DOCPRT_DATA 
	--		 @CMEMOID = @CXNID,  
	--		 @DRECEIPTDT = '', 
	--		 @DLOGINDT = @DRMDT, 
	--		 @CMEMONOPREFIX = 'GWSR', 
	--		 @CWIZAPPUSERCODE = '0000000', 
	--		 @CERRMSG = @cErrmsg OUTPUT, 
	--		 @BNEGSTOCKFOUND = '', 
	--		 @CCNID = @CMRRID OUTPUT ,
	--		 @BCALLEDFORSISLOC=0

	--		 IF ISNULL(@CERRMSG,'')<>''
	--			GOTO EXIT_PROC			
	--END	
	--ELSE
	IF @CXNTYPE='DOCGV' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCGV_DATA'
		EXEC SP_MERGE_MIRROR_DOCGV_DATA					
		@CMEMOID=@CXNID,
		@CERRMSG=@CERRMSG OUTPUT					
	END	
	ELSE
	IF @CXNTYPE='DOCMBAPP' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCMBAPP_DATA'
		EXEC SP_MERGE_MIRROR_DOCMBAPP_DATA					
		@CMEMOID=@CXNID,
		@CERRMSG=@CERRMSG OUTPUT					
	END	
	ELSE
	IF @CXNTYPE='DOCIRT' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCIRT_DATA'
		EXEC SP_MERGE_MIRROR_DOCIRT_DATA					
		@CMEMOID=@CXNID,
		@CERRMSG=@CERRMSG OUTPUT					
	END					
	ELSE
	IF @CXNTYPE='DOCPCO' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCPCO_DATA'
		EXEC SP_MERGE_MIRROR_DOCPCO_DATA					
		@CMEMOID=@CXNID,
		@CERRMSG=@CERRMSG OUTPUT					
	END
	ELSE
	IF @CXNTYPE='DOCPRCL' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCPRCL_DATA'
		EXEC SP_MERGE_MIRROR_DOCPRCL_DATA					
		@CMEMOID=@CXNID,
		@CERRMSG=@CERRMSG OUTPUT					
	END
	ELSE
	IF @CXNTYPE='DOCPOADJ' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCPOADJ_DATA'
		EXEC SP_MERGE_MIRROR_DOCPOADJ_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT					
	END	
	ELSE
	IF @CXNTYPE='DOCPO' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCPO_DATA'
		EXEC SP_MERGE_MIRROR_DOCPO_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CERRMSG=@CERRMSG OUTPUT					
	END	
							
								
	ELSE
	IF @CXNTYPE='DOCPO_APP' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCPOAPP_DATA'
		EXEC SP_MERGE_MIRROR_DOCPOAPP_DATA					
		@CMEMOID=@CXNID,
		@CERRMSG=@CERRMSG OUTPUT					
	END
	ELSE
	IF @CXNTYPE='DOCWSL_APP' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCWSLAPP_DATA'
		EXEC SP_MERGE_MIRROR_DOCWSLAPP_DATA					
		@CMEMOID=@CXNID,
		@CERRMSG=@CERRMSG OUTPUT					
	END
	ELSE
	IF @CXNTYPE='DOCPRT_APP' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCPRTAPP_DATA'
		EXEC SP_MERGE_MIRROR_DOCPRTAPP_DATA					
		@CMEMOID=@CXNID,
		@CERRMSG=@CERRMSG OUTPUT					
	END											
	ELSE
	IF @CXNTYPE='DOCPUR' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCPUR_DATA'
		EXEC SP_MERGE_MIRROR_DOCPUR_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT					
	END									
	ELSE
	IF @CXNTYPE='DOCMRP' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCMRP_DATA'
		EXEC SP_MERGE_MIRROR_DOCMRP_DATA_NEW
		@CERRMSG=@CERRMSG OUTPUT					
	END
	ELSE
	IF @CXNTYPE='DOCASN' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCASN_DATA'
		EXEC SP_MERGE_MIRROR_DOCASN_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CERRMSG=@CERRMSG OUTPUT					
	END	
	ELSE
	IF @CXNTYPE='DOCWBO' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCWBO_DATA'
		EXEC SP_MERGE_MIRROR_DOCWBO_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID ,
		@CERRMSG=@CERRMSG OUTPUT					
	END											
	ELSE
	IF @CXNTYPE='DOCDNPF' 
	BEGIN
		PRINT 'SP_MERGE_MIRROR_DOCDNPF_DATA'
		EXEC SP_MERGE_MIRROR_DOCDNPF_DATA					
		@CMEMOID=@CXNID,
		@CLOCID=@CLOCID,
		@CSOURCEDB=@CSOURCEDB,
		@CMERGEDB=@CMERGEDB,
		@BMSTINSERTONLY=@BMSTINSERTONLY,
		@CERRMSG=@CERRMSG OUTPUT						
	END			
EXIT_PROC:
	
	IF ISNULL(@CERRMSG,'')<>''
		INSERT MIRROR_MERGE_LOG (MEMO_ID,ERRMSG,LAST_UPDATE,XN_TYPE)
		SELECT @CXNID AS MEMO_ID,ISNULL(@CERRMSG,'') AS ERRMSG,GETDATE() AS LAST_UPDATE,@CXNTYPE AS XN_TYPE
	ELSE
		DELETE FROM MIRROR_MERGE_LOG WHERE MEMO_ID=@CXNID AND XN_TYPE=@CXNTYPE
	
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
		INSERT MIRROR_MERGE_SUCCESS_LOG (MEMO_ID,LAST_UPDATE,XN_TYPE)
		SELECT @CXNID AS MEMO_ID,GETDATE() AS LAST_UPDATE,@CXNTYPE AS XN_TYPE
		
		SET @CERRMSG='SUCCESS'
	END	
	
	SELECT ISNULL(@CERRMSG,'') AS ERRMSG,@CNEWMEMOID  AS MEMO_ID
END
----- 'END OF CREATING PROCEDURE SP_MERGEMIRROR_DOC_DATA'
