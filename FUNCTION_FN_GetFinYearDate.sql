-- FUNCTION TO RETURN THE START OR END DATE OF GIVEN FIN-YEAR
-- @NMODE = 1 - STARTDATE; 2 - ENDDATE
CREATE FUNCTION FN_GETFINYEARDATE
(
	@CFINYEAR VARCHAR(10),
	@NMODE INT
)
RETURNS DATETIME
--WITH ENCRYPTION
AS
BEGIN
	IF @NMODE NOT IN ( 1,2 )
		SET @NMODE = 1

	DECLARE @CSENTURYID VARCHAR(10),
			@CYEARID VARCHAR(10),
			@NYEARNO INT,
			@DRETVAL DATETIME
			
	SET @CSENTURYID = SUBSTRING( @CFINYEAR, 3,1)
	SET @CYEARID = RIGHT( @CFINYEAR, 2) 

	SET @NYEARNO = (CONVERT(INT,@CSENTURYID) + 19) * 100 + CONVERT(INT,@CYEARID)
	DECLARE @cFinyearStartingMonth VARCHAR(4),@nStartingMonth INT
	SELECT TOP 1 @cFinyearStartingMonth=value FROM config (NOLOCK) WHERE config_option='finyear_starting_month'

	IF ISNULL(@cFinyearStartingMonth,'')<>''
	BEGIN
		SET @cFinyearStartingMonth=(CASE WHEN LEN(@cFinyearStartingMonth)<2 THEN '0' ELSE '' END)+@cFinyearStartingMonth
	END
	ELSE
		SET @cFinyearStartingMonth='04'

	IF @NMODE = 1
		SET @DRETVAL = CONVERT(DATETIME, CONVERT(VARCHAR,@NYEARNO-1) + '-'+@cFinyearStartingMonth+'-01')
	ELSE
		SET @DRETVAL = CONVERT(DATETIME, CONVERT(VARCHAR,@NYEARNO) + '-03-31')
	
	RETURN @DRETVAL
END
--******************************* END OF FUNCTION FN_GETFINYEARDATE
