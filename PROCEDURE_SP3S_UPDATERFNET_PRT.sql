CREATE PROCEDURE SP3S_UPDATERFNET_PRT
@CRMID VARCHAR(40)
AS
BEGIN
	DECLARE @CROWID VARCHAR(50),@NTAX NUMERIC(10,2),@NINCLTAX NUMERIC(10,2),@NSUMRFNET NUMERIC(10,2),@NSUBTOTAL NUMERIC(10,2),
			@NSUMRFNETWT NUMERIC(10,2),@NOH_AMOUNT NUMERIC(14,2),@NTOTALQTY NUMERIC(10,3),@NOH_TAXABLE_VALUE NUMERIC(14,2),@Drm_DT DATETIME

	SELECT TOP 1 @CROWID = ROW_ID FROM rmd01106 A WITH (ROWLOCK) WHERE rm_id=@CRMID

	PRINT 'UPDRFNET-4'
			
	SELECT @NTAX=0,@NINCLTAX=0

	UPDATE A SET RFNET =0,RFNET_WOTAX =0 FROM rmd01106 A WITH (ROWLOCK) WHERE rm_id=@CRMID

	SELECT   @NOH_AMOUNT= ISNULL(B.FREIGHT_TAXABLE_VALUE,0) + 
		ISNULL(B.FREIGHT_IGST_AMOUNT ,0)+ISNULL(B.FREIGHT_CGST_AMOUNT ,0)+ISNULL(B.FREIGHT_SGST_AMOUNT ,0)+
		ISNULL(B.OTHER_CHARGES_TAXABLE_VALUE,0) + 
		ISNULL(B.OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_CGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_SGST_AMOUNT ,0),  --B.ROUND_OFF
		
		@NTOTALQTY=B.TOTAL_QUANTITY,
		@NOH_TAXABLE_VALUE= ISNULL(B.FREIGHT_TAXABLE_VALUE,0) + ISNULL(B.OTHER_CHARGES_TAXABLE_VALUE,0) ,
		@Drm_DT=B.rm_dt   
	FROM rmm01106 B  WITH (ROWLOCK) WHERE rm_id =@CRMID

	IF @Drm_DT<'2017-07-01'
	   RETURN
			
     IF ISNULL(@NOH_AMOUNT,0)=0
	 BEGIN
	      
		  UPDATE A SET RFNET=A.XN_VALUE_WITH_GST+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0) ,RFNET_WOTAX =A.XN_VALUE_WITHOUT_GST+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0)   
		  FROM  rmd01106 A WITH (ROWLOCK) WHERE rm_id=@CRMID
		  

	 END
	 ELSE
	 BEGIN
	     
		  UPDATE A SET RFNET=A.XN_VALUE_WITH_GST+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0)+ ((@NOH_AMOUNT/CASE WHEN ISNULL(@NTOTALQTY,0)=0 THEN 1 ELSE @NTOTALQTY END )*A.invoice_quantity ) ,
		               RFNET_WOTAX =A.XN_VALUE_WITHOUT_GST+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0) + ((@NOH_TAXABLE_VALUE/CASE WHEN ISNULL(@NTOTALQTY,0)=0 THEN 1 ELSE @NTOTALQTY END )*A.invoice_quantity )  
		  FROM  rmd01106 A WITH (ROWLOCK) WHERE rm_id=@CRMID
		  


	 END




	SELECT @NSUBTOTAL= total_amount FROM rmm01106  (NOLOCK) WHERE  rm_id  = @CRMID

	SELECT @NSUMRFNET = SUM(RFNET) FROM rmd01106  WHERE rm_id  = @CRMID
				
	IF @NSUMRFNET <> @NSUBTOTAL
	BEGIN
		PRINT 'UPDRFNET-6'
		UPDATE rmd01106  SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
		WHERE rm_id = @CRMID AND ROW_ID = @CROWID
	END

	update rmm01106 with (rowlock) set HO_SYNCH_LAST_UPDATE ='' WHERE rm_id=@CRMID
END		