create PROCEDURE SP_SEND_MIRROR_DOCIRT_OPT_DATA_NEW
(	
	 @CREQXNID VARCHAR(50)
	,@CTARGATELOCID VARCHAR(5)
	,@BACKNOWLEDGE BIT=0
	,@nSendingMode NUMERIC(1,0)=1
	,@CERRMSG VARCHAR(1000) OUTPUT
)	
--WITH ENCRYPTION
AS
/*
	SP_SEND_MIRROR_IRT_DATA_208_03_02_14 : THIS PROCEDURE WILL SEND ITEM RATE REVISION.
*/
BEGIN
	DECLARE @DTSQL NVARCHAR(MAX),@NSPID INT,@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),
	@CSTEP VARCHAR(5),
	@NLOCTYPE NUMERIC(10),
	@BPURLOC BIT,
	@DMEMODT DATETIME,@BFLOWPP BIT

	DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),XN_ID VARCHAR(40))  	

BEGIN TRY 	
	---- CALL ACKNOWLEDGEMENT OF MEMO SUCCESSFUL MERGING AT MIRRORING SERVER
	
		
	SET @CSTEP=10
	
	SELECT @NLOCTYPE=LOC_TYPE,@BPURLOC=PUR_LOC,@BFLOWPP=UPD_PURINFO FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CTARGATELOCID
			
	SET @CSTEP=20
	
	SET @CMEMOID=@CREQXNID
	
		
LBLTABLEINFO:
	
	SET @CSTEP=50
	
LBLDELETETEMP:
	
	IF @BACKNOWLEDGE=1
		GOTO END_PROC
			
	SET @CSTEP=100
	---- SEND THE IRM MEMO MASTER TABLE
	SELECT DISTINCT 'DOCIRT_IRM01106_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS XN_ID FROM irm01106(NOLOCK) A WHERE a.irm_memo_id =@CMEMOID
	
	SET @CSTEP=150
	---- SEND THE IRT MEMO DETAIL TABLE
	SELECT DISTINCT 'DOCIRT_IRd01106_MIRROR' AS TARGET_TABLENAME,A.* FROM ird01106(NOLOCK) A WHERE a.irm_memo_id =@CMEMOID
	AND ISNULL(NEW_PRODUCT_CODE,'')=''
	

	SET @CSTEP=200
    SELECT DISTINCT 'DOCIRT_SKU_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.* FROM SKU(NOLOCK) A
    JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
    WHERE B.IRM_MEMO_ID =@CMEMOID

	 
	 IF OBJECT_ID ('TEMPDB..#TMPHSN','U') IS NOT NULL
		DROP TABLE #TMPHSN

	SELECT DISTINCT  A.HSN_CODE  
	INTO #TMPHSN
	FROM HSN_MST A (NOLOCK)
	JOIN IRD01106 B (NOLOCK) ON (A.HSN_CODE =B.NEW_HSN_CODE  OR A.HSN_CODE =B.OLD_HSN_CODE )
	WHERE B.IRM_MEMO_ID =@CMEMOID
	UNION 
	SELECT DISTINCT  A.HSN_CODE  FROM HSN_MST A (NOLOCK)
	JOIN SKU B (NOLOCK) ON A.HSN_CODE =B.HSN_CODE 
	JOIN IRD01106 IRD (NOLOCK) ON IRD.PRODUCT_CODE =B.PRODUCT_CODE 
	WHERE IRD.IRM_MEMO_ID =@CMEMOID

	SELECT DISTINCT 'DOCIRT_HSN_MST_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.* FROM HSN_MST (NOLOCK) A
	JOIN #TMPHSN B ON A.hsn_code =B.hsn_code 

	SET @CSTEP=210
	
	SELECT DISTINCT 'DOCIRT_HSN_DET_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.* FROM HSN_DET (NOLOCK) A
	JOIN #TMPHSN B ON A.hsn_code =B.hsn_code 
    
    INSERT INTO DOCXN_MSTCODES(XNTYPE,MEMOID,ARTICLECODE,dept_id )
    select 'DOCIRT' XNTYPE ,@CMEMOID,sk.article_code ,@CTARGATELOCID as dept_id
    from ird01106 a (nolock)
    join sku sk (nolock) on a.product_code =sk.product_code 
    where a.irm_memo_id =@CMEMOID
    Union 
    select 'DOCIRT' XNTYPE ,@CMEMOID,a.OLD_ARTICLE_CODE ,@CTARGATELOCID as dept_id
    from ird01106 a (nolock)
    where a.irm_memo_id =@CMEMOID
    Union 
    select 'DOCIRT' XNTYPE ,@CMEMOID,a.ARTICLE_CODE ,@CTARGATELOCID as dept_id
    from ird01106 a (nolock)
    where a.irm_memo_id =@CMEMOID
   	
    SET @CSTEP=250
    ---- SEND THE ARTICLE TABLE
    
    SELECT DISTINCT 'DOCIRT_ARTICLE_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM ARTICLE A(NOLOCK) 
    join DOCXN_MSTCODES b (nolock) on a.article_code =b.articleCode 
    where b.MEMOID=@CMEMOID and b.xntype='DOCIRT' and b.dept_id=@CTARGATELOCID
    
    --SELECT DISTINCT 'DOCIRT_ARTICLE_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    --FROM ARTICLE(NOLOCK) A
    --JOIN SKU SK(NOLOCK) ON A.ARTICLE_CODE=SK.ARTICLE_CODE
    --JOIN IRD01106(NOLOCK) B ON  SK.PRODUCT_CODE=B.PRODUCT_CODE
    --WHERE B.IRM_MEMO_ID =@CMEMOID
    --UNION
    --SELECT DISTINCT 'DOCIRT_ARTICLE_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    --FROM ARTICLE(NOLOCK) A
    --JOIN IRD01106(NOLOCK) B ON  A.ARTICLE_CODE=B.OLD_ARTICLE_CODE 
    --WHERE B.IRM_MEMO_ID =@CMEMOID
    --UNION
    --SELECT DISTINCT 'DOCIRT_ARTICLE_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    --FROM ARTICLE(NOLOCK) A
    --JOIN IRD01106(NOLOCK) B ON  A.ARTICLE_CODE=B.ARTICLE_CODE 
    --WHERE B.IRM_MEMO_ID =@CMEMOID    
    

    SET @CSTEP=260
    ---- SEND THE ART_ATTR TABLE 
    
    SELECT DISTINCT 'DOCIRT_ARTicle_FIX_ATTR_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM ARTicle_FIX_ATTR(NOLOCK) A
    join DOCXN_MSTCODES b (nolock) on a.article_code =b.articleCode 
     where b.MEMOID=@CMEMOID and b.xntype='DOCIRT' and b.dept_id=@CTARGATELOCID
     
    SET @CSTEP=270
    ---- SEND THE SECTIOND TABLE
    SELECT DISTINCT 'DOCIRT_SECTIOND_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM SECTIOND(NOLOCK) A
    JOIN ARTICLE(NOLOCK) ART ON ART.SUB_SECTION_CODE=A.SUB_SECTION_CODE
    JOIN DOCXN_MSTCODES TMP (NOLOCK)  ON TMP.ARTICLECODE =ART.ARTICLE_CODE 
    WHERE tmp.memoid =@CMEMOID  and  tmp.xntype='DOCIRT' and tmp.dept_id=@CTARGATELOCID
	
	SET @CSTEP=280
    ---- SEND THE SECTIONM TABLE
    SELECT DISTINCT 'DOCIRT_SECTIONM_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM SECTIONM(NOLOCK) A
    JOIN SECTIOND(NOLOCK) SD ON SD.SECTION_CODE=A.SECTION_CODE
    JOIN ARTICLE(NOLOCK) ART ON ART.SUB_SECTION_CODE=SD.SUB_SECTION_CODE
    join DOCXN_MSTCODES tmp (nolock) on tmp.ARTICLECODE =art.article_code 
    WHERE tmp.memoid =@CMEMOID  and  tmp.xntype='DOCIRT' AND TMP.DEPT_ID=@CTARGATELOCID
	    
    SET @CSTEP=290
    ---- SEND THE PARA1 TABLE
    SELECT DISTINCT 'DOCIRT_PARA1_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA1(NOLOCK) A
    JOIN SKU(NOLOCK) SK ON A.PARA1_CODE=SK.PARA1_CODE
    JOIN IRD01106(NOLOCK) B ON  B.product_code=SK.product_code
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA1_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA1(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.PARA1_CODE=B.OLD_PARA1_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA1_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA1(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.PARA1_CODE=B.para1_code 
    WHERE B.IRM_MEMO_ID =@CMEMOID

	
	SET @CSTEP=300
    ---- SEND THE PARA2 TABLE
    SELECT DISTINCT 'DOCIRT_PARA2_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA2(NOLOCK) A
    JOIN SKU(NOLOCK) SK ON A.PARA2_CODE=SK.PARA2_CODE
    JOIN IRD01106(NOLOCK) B ON  B.product_code=SK.product_code
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA2_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA2(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.PARA2_CODE=B.OLD_PARA2_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA2_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA2(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.PARA2_CODE=B.PARA2_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
	
	SET @CSTEP=310
    ---- SEND THE PARA3 TABLE
    SELECT DISTINCT 'DOCIRT_PARA3_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA3(NOLOCK) A
    JOIN SKU(NOLOCK) SK ON A.PARA3_CODE=SK.PARA3_CODE
    JOIN IRD01106(NOLOCK) B ON  b.product_code=sk.product_code
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA3_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA3(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.PARA3_CODE=B.OLD_PARA3_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA3_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA3(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.PARA3_CODE=B.PARA3_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
	
	SET @CSTEP=320
    ---- SEND THE PARA4 TABLE
    SELECT DISTINCT 'DOCIRT_PARA4_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA4 A
    JOIN SKU(NOLOCK) SK ON A.PARA4_CODE=SK.PARA4_CODE
    JOIN IRD01106 B ON  b.product_code=sk.product_code
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA4_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA4 A
    JOIN IRD01106 B ON  A.PARA4_CODE=B.OLD_PARA4_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA4_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA4 A
    JOIN IRD01106 B ON  A.PARA4_CODE=B.PARA4_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    
  
	SET @CSTEP=330
    ---- SEND THE PARA5 TABLE
	SELECT DISTINCT 'DOCIRT_PARA5_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
	FROM PARA5(NOLOCK) A
    JOIN SKU(NOLOCK) SK ON A.PARA5_CODE=SK.PARA5_CODE
    JOIN IRD01106(NOLOCK) B ON  B.product_code=SK.product_code
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA5_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA5(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.PARA5_CODE=B.OLD_PARA5_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA5_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA5(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.PARA5_CODE=B.PARA5_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    
   
	SET @CSTEP=340
    ---- SEND THE PARA6 TABLE
    SELECT DISTINCT 'DOCIRT_PARA6_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA6(NOLOCK) A
    JOIN SKU(NOLOCK) SK ON A.PARA6_CODE=SK.PARA6_CODE
    JOIN IRD01106(NOLOCK) B ON  B.product_code=SK.product_code
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA6_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA6(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.PARA6_CODE=B.OLD_PARA6_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_PARA6_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA6(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.PARA6_CODE=B.PARA6_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    
    SET @CSTEP=345
    SELECT DISTINCT 'DOCIRT_PARA7_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM PARA7(NOLOCK) A
    JOIN SKU(NOLOCK) SK ON A.PARA7_CODE=SK.PARA7_CODE
    JOIN IRD01106(NOLOCK) B ON  B.product_code=SK.product_code
    WHERE B.IRM_MEMO_ID =@CMEMOID
    
	
	SET @CSTEP=350
    ---- SEND THE UOM TABLE
    SELECT DISTINCT 'DOCIRT_UOM_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM UOM(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.UOM_CODE=B.UOM_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    UNION
    SELECT DISTINCT 'DOCIRT_UOM_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCIRT_MEMO_ID,A.*  
    FROM UOM(NOLOCK) A
    JOIN IRD01106(NOLOCK) B ON  A.UOM_CODE=B.OLD_UOM_CODE 
    WHERE B.IRM_MEMO_ID =@CMEMOID
    
	SET @CSTEP=370
    ---- SEND THE ATTRM TABLE 

    DECLARE @NCOUNT INT,@BLOOP INT,@CCMD NVARCHAR(MAX)
	SET @NCOUNT=25
	SET @BLOOP=1
	WHILE (@BLOOP <=@NCOUNT )
	BEGIN
	  
		   SET @CCMD=N' IF EXISTS(SELECT  TOP 1 ''U''
			FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)
			JOIN ARTICLE_FIX_ATTR A (NOLOCK) ON ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code=A.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code
			join DOCXN_MSTCODES tmp (nolock)  on tmp.ARTICLECODE =a.article_code 
			WHERE tmp.memoid ='''+@CMEMOID+''' and  tmp.xntype=''DOCIRT''  AND TMP.DEPT_ID='''+@CTARGATELOCID+'''
			AND 	ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000'' )
				SELECT 	DISTINCT ''DOCIRT_ATTR'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_MST_MIRROR'' AS TARGET_TABLENAME,'''+@CMEMOID+''' AS DOCIRT_MEMO_ID,ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.* 
				FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)
				JOIN ARTICLE_FIX_ATTR A (NOLOCK) ON ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code=A.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code
				JOIN DOCXN_MSTCODES TMP (NOLOCK)  ON TMP.ARTICLECODE =A.ARTICLE_CODE 
				WHERE tmp.memoid ='''+@CMEMOID+''' and  tmp.xntype=''DOCIRT'' AND TMP.DEPT_ID='''+@CTARGATELOCID+'''
                 '

				
		   PRINT  @CCMD
		   EXEC SP_EXECUTESQL @CCMD
	       
		   SET @BLOOP=@BLOOP +1
	END    

END TRY

BEGIN CATCH
	PRINT 'ENTER CATCH BLOCK OF DOCIRT'
	SET @CERRMSG='P: SP_SEND_MIRROR_DOCIRT_OPT_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 		

END_PROC:

delete A from DOCXN_MSTCODES A (nolock)   where a.MEMOID=@CMEMOID and a.xntype='DOCIRT' and  a.dept_id=@CTARGATELOCID
	
END
---END OF PROCEDURE - SP_SEND_MIRROR_DOCIRT_OPT_DATA_NEW



