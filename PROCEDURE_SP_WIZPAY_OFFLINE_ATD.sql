CREATE PROC SP_WIZPAY_OFFLINE_ATD
(
 @CFROM DATETIME,
 @CTODT DATETIME,
 @CWHERE VARCHAR(50)
)
AS
BEGIN
SELECT LOCATION_ID, B.DEPT_NAME,ATD_DATE,SUM(OFFLINE_IN) AS OFFLINE_IN,
SUM(TOTAL) AS TOTAL
FROM (
SELECT LOCATION_ID,CONVERT(VARCHAR,IST_TIME,110) AS ATD_DATE, COUNT(*) AS OFFLINE_IN,0 AS TOTAL 
FROM EMP_WPAYATT 
WHERE  ATD_MODE=1 GROUP BY LOCATION_ID,CONVERT(VARCHAR,IST_TIME,110)
UNION 
SELECT LOCATION_ID,CONVERT(VARCHAR,IST_TIME,110) AS ATD_DATE,0 AS OFFLINE_IN,
COUNT(DISTINCT EMP_ID+CONVERT(VARCHAR,IST_TIME,110)) AS TOTAL FROM EMP_WPAYATT
GROUP BY LOCATION_ID,CONVERT(VARCHAR,IST_TIME,110)
) A 
JOIN LOCATION B ON A.LOCATION_ID= B.DEPT_ID 
WHERE (LOCATION_ID= @CWHERE OR @CWHERE = '') AND  ATD_DATE BETWEEN @CFROM AND @CTODT
GROUP BY A.LOCATION_ID, B.DEPT_NAME,ATD_DATE

END
