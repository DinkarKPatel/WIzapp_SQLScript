CREATE PROCEDURE SP3SGETPRODUCTSTOCK
(
  @NMODE INT=1
) 
AS  
BEGIN  
  
IF OBJECT_ID ('TEMPDB..#PRODUCTSTOCK','U') IS NOT NULL  
   DROP TABLE #PRODUCTSTOCK  
      
   CREATE TABLE #PRODUCTSTOCK  
   (  
    DEPT_ID VARCHAR(MAX)  
   ,DEPT_ALIAS VARCHAR(MAX)  
   ,PRODUCT_CODE VARCHAR(MAX)  
   ,CBSQTY INT  
   )  
  
  IF @NMODE=1
  GOTO LBLMODE1
  ELSE IF @NMODE=2
  GOTO LBLMODE2 
  ELSE 
  GOTO ENDPROC  
     
  LBLMODE1:  
  
   IF OBJECT_ID('PRODUCTLOCATION','U') IS NULL  
  CREATE TABLE PRODUCTLOCATION(DEPT_ID CHAR(2) NOT NULL)  
     
  IF OBJECT_ID('PARA3UPLOAD','U') IS NULL  
  CREATE TABLE PARA3UPLOAD(PARA3_CODE CHAR(9) NOT NULL PRIMARY KEY)  
     
     INSERT INTO #PRODUCTSTOCK (DEPT_ID,DEPT_ALIAS,PRODUCT_CODE,CBSQTY)  
  
     SELECT A.DEPT_ID,L.DEPT_ALIAS,A.PRODUCT_CODE  
       ,CAST(SUM((CASE   
       WHEN A.XN_TYPE='OPS' OR   
       (A.XN_TYPE IN ('API','SCF','OPS','PRD', 'PUR', 'CHI', 'SLR','UNC','APR', 'WSR', 'PFI', 'PFG', 'BCG'  
       ,'MRP','DCI','PSB','JWR'))   
   THEN 1   
       WHEN A.XN_TYPE IN ('APO','SCC','BOC','PRT','CHO','SLS','CNC','APP','WSL','CIP', 'CRM', 'DCO','MIP'  
   ,'CSB','JWI','DLM')   
   THEN -1 ELSE 0 END)   
  * (XN_QTY)) AS NUMERIC(14,2)) AS CBSQTY  
 FROM VW_XNSREPS A  (NOLOCK)   
 JOIN PRODUCTLOCATION P ON A.DEPT_ID=P.DEPT_ID  
 JOIN LOCATION L ON L.DEPT_ID=P.DEPT_ID  
 JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE  
 JOIN ARTICLE C ON B.ARTICLE_CODE=C.ARTICLE_CODE  
 WHERE C.STOCK_NA=0  
 GROUP BY A.DEPT_ID,L.DEPT_ALIAS,A.PRODUCT_CODE 
 

 
	  
	 SELECT A.DEPT_ID,A.DEPT_ALIAS,A.PRODUCT_CODE,B.PRODUCT_NAME ,C.PARA1_NAME,D.PARA2_NAME,E.PARA3_NAME,B.MRP,A.CBSQTY   
	 FROM #PRODUCTSTOCK A   
	 JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE  
	 JOIN PARA1 C ON C.PARA1_CODE=B.PARA1_CODE  
	 JOIN PARA2 D ON D.PARA2_CODE=B.PARA2_CODE  
	 JOIN PARA3 E ON E.PARA3_CODE=B.PARA3_CODE  
	 WHERE CBSQTY>0   
		AND ISNULL(E.DT_CREATED,'')<>''   
		AND ISNULL(E.DT_CREATED,'')<>'19000101'  
		AND E.PARA3_CODE<>'0000000'  
	      
	 SELECT DISTINCT E.PARA3_CODE,E.PARA3_NAME,E.DT_CREATED  
	 FROM #PRODUCTSTOCK A   
	 JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE  
	 JOIN PARA1 C ON C.PARA1_CODE=B.PARA1_CODE  
	 JOIN PARA2 D ON D.PARA2_CODE=B.PARA2_CODE  
	 JOIN PARA3 E ON E.PARA3_CODE=B.PARA3_CODE  
	 LEFT JOIN PARA3UPLOAD PU ON E.PARA3_CODE=PU.PARA3_CODE  
	 WHERE CBSQTY>0   
		AND ISNULL(E.DT_CREATED,'')<>''   
		AND ISNULL(E.DT_CREATED,'')<>'19000101'  
		AND E.PARA3_CODE<>'0000000'  
		AND PU.PARA3_CODE IS NULL 
 
 GOTO ENDPROC
 LBLMODE2:

 INSERT INTO #PRODUCTSTOCK (DEPT_ID,DEPT_ALIAS,PRODUCT_CODE,CBSQTY)  
  
     SELECT A.DEPT_ID,L.DEPT_ALIAS,A.PRODUCT_CODE  
       ,CAST(SUM((CASE   
       WHEN A.XN_TYPE='OPS' OR   
       (A.XN_TYPE IN ('API','SCF','OPS','PRD', 'PUR', 'CHI', 'SLR','UNC','APR', 'WSR', 'PFI', 'PFG', 'BCG'  
       ,'MRP','DCI','PSB','JWR'))   
   THEN 1   
       WHEN A.XN_TYPE IN ('APO','SCC','BOC','PRT','CHO','SLS','CNC','APP','WSL','CIP', 'CRM', 'DCO','MIP'  
   ,'CSB','JWI','DLM')   
   THEN -1 ELSE 0 END)   
  * (XN_QTY)) AS NUMERIC(14,2)) AS CBSQTY  
 FROM VW_XNSREPS A  (NOLOCK)   
 JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE  
 JOIN ARTICLE C ON B.ARTICLE_CODE=C.ARTICLE_CODE  
 JOIN LOCATION L ON L.DEPT_ID=A.DEPT_ID  
LEFT  JOIN AREA ON AREA.AREA_CODE=L.AREA_CODE
LEFT  JOIN CITY ON CITY.CITY_CODE=AREA.CITY_CODE
LEFT JOIN STATE ON STATE.STATE_CODE=CITY.STATE_CODE
 
 WHERE C.STOCK_NA=0 
 AND L.SIS_LOC<>1 
 AND L.INACTIVE<>1  
 AND L.DEPT_ALIAS<>'HO' 
 AND CITY.CITY_CODE='0100000001'
 
 GROUP BY A.DEPT_ID,L.DEPT_ALIAS,A.PRODUCT_CODE 


 
	  
	 SELECT A.DEPT_ALIAS,
	 
	 (CASE WHEN E.PARA3_NAME='NA' THEN '' ELSE E.PARA3_NAME END+'-'+
	 CASE WHEN C.PARA1_NAME='NA' THEN '' ELSE C.PARA1_NAME END+'-'+
	 CASE WHEN 
	 D.PARA2_NAME='NA' THEN '' ELSE D.PARA2_NAME END)AS SKU,
	 COUNT(*)AS CBSQTY ,ISNULL(B.MRP,0) AS MRP  
	 FROM #PRODUCTSTOCK A   
	 JOIN SKU B   ON A.PRODUCT_CODE=B.PRODUCT_CODE  
	 JOIN PARA1 C ON C.PARA1_CODE=B.PARA1_CODE  
	 JOIN PARA2 D ON D.PARA2_CODE=B.PARA2_CODE  
	 JOIN PARA3 E ON E.PARA3_CODE=B.PARA3_CODE  
	 WHERE CBSQTY>0  
		AND E.PARA3_CODE<>'0000000' 
		GROUP BY A.DEPT_ALIAS,ISNULL(B.MRP,0),
	 
	 	 (CASE WHEN E.PARA3_NAME='NA' THEN '' ELSE E.PARA3_NAME END+'-'+
	 CASE WHEN C.PARA1_NAME='NA' THEN '' ELSE C.PARA1_NAME END+'-'+
	 CASE WHEN 
	 D.PARA2_NAME='NA' THEN '' ELSE D.PARA2_NAME END)
  
  GOTO ENDPROC
 
   ENDPROC: 
END 
--END OF PROCEDURE - SP3SGETPRODUCTSTOCK
