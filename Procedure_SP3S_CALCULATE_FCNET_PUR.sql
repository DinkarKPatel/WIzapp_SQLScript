CREATE Procedure SP3S_CALCULATE_FCNET_PUR --(LocId 3 digit change by Sanjay:04-11-2024)
(
 @CMRRID VARCHAR(50),
 @BCALLEDFORLIST BIT=0,
 @cCurLocId varCHAR(4)
)
AS
BEGIN

		IF OBJECT_ID ('TEMPDB..#TMPFCRATE','U') IS  NULL
		BEGIN
		      SELECT ROW_ID  =CAST('' AS VARCHAR(100)),
					 CAST(0 AS NUMERIC(14,2)) AS FC_NET,
					 CAST(0 AS NUMERIC(14,2)) AS FC_GST_PERCENTAGE,
					 CAST(0 AS INT) AS FC_TAX_METHOD,
					 CAST(0 AS BIT) AS IS_IGST,
					 CAST(0 AS NUMERIC(14,2)) AS FC_XN_VALUE_WITHOUT_GST,
					 CAST(0 AS NUMERIC(10,2)) AS FC_IGST_AMOUNT,
					 CAST(0 AS NUMERIC(10,2)) AS FC_CGST_AMOUNT,
					 CAST(0 AS NUMERIC(10,2)) AS FC_SGST_AMOUNT,
					 CAST(0 AS NUMERIC(14,2)) AS FC_XN_VALUE_WITH_GST
			   INTO #TMPFCRATE
			   WHERE 1=2


		 END

	   DECLARE @nInvMode NUMERIC(1,0),@cHoLocId VARCHAR(4),@bServerLoc BIT,@cInvId VARCHAR(40)
   
   
	   SELECT @nInvMode=inv_mode,@bServerLoc=ISNULL(server_loc,0),@cInvId=a.inv_id
	   FROM pim01106 a (NOLOCK) JOIN location b (NOLOCK) ON a.location_Code=b.dept_id
	   WHERE mrr_id=@cMrrId

	   SELECT @cHoLocId = value FROM config (NOLOCK) WHERE config_option='ho_location_id'
	  

         
		  IF (@bServerLoc=1 OR @cHoLocId=@cCurLocId) AND @nInvMode=2
           BEGIN

	    		INSERT INTO #TMPFCRATE(ROW_ID,FC_NET,FC_GST_PERCENTAGE,FC_TAX_METHOD,IS_IGST)
				SELECT A.ROW_ID ,
					   FC_NET = ((A.net_rate*A.INVOICE_QUANTITY)-A.INMDISCOUNTAMOUNT)/B.fc_rate,
					   A.GST_PERCENTAGE,B.bill_level_tax_method ,
					   CASE WHEN A.igst_amount <>0 THEN 1 ELSE 0 END AS IS_IGST
				FROM IND01106 A  (NOLOCK) 
				JOIN INM01106 B (NOLOCK) ON A.INV_ID=B.INV_ID 
				WHERE A.INV_ID = @cInvId  
				AND ISNULL(B.fc_rate,0)<>0

		   END
		   ELSE
		   BEGIN
		        
				
	    		INSERT INTO #TMPFCRATE(ROW_ID,FC_NET,FC_GST_PERCENTAGE,FC_TAX_METHOD,IS_IGST)
				SELECT A.ROW_ID ,
					   FC_NET = ((A.PURCHASE_PRICE*A.INVOICE_QUANTITY)-(A.PIMDiscountAmount))/B.fc_rate,
					   A.GST_PERCENTAGE,B.bill_level_tax_method ,
					   CASE WHEN A.igst_amount <>0 THEN 1 ELSE 0 END AS IS_IGST
				FROM PID01106 A  (NOLOCK) 
				JOIN pim01106 B (NOLOCK) ON A.mrr_id=B.mrr_id 
				WHERE A.mrr_id = @CMRRID  
				AND ISNULL(B.fc_rate,0)<>0


		   END


			UPDATE TMP SET 
			                FC_XN_VALUE_WITHOUT_GST =ROUND(FC_NET-(FC_NET*(CASE WHEN FC_TAX_METHOD=2 THEN ((ISNULL(TMP.FC_GST_PERCENTAGE,0))/  
			               (100 + ISNULL(TMP.FC_GST_PERCENTAGE,0))) ELSE 0 END)),2),

			               FC_XN_VALUE_WITH_GST= ROUND((FC_NET)+((FC_NET)*(CASE WHEN FC_TAX_METHOD=2 THEN 0   
                           ELSE ((ISNULL(TMP.FC_GST_PERCENTAGE,0))/100) END)) ,2)

			FROM #TMPFCRATE TMP

			UPDATE TMP SET 
			                FC_IGST_AMOUNT =CASE WHEN IS_IGST=1 THEN FC_XN_VALUE_WITH_GST-FC_XN_VALUE_WITHOUT_GST
							               ELSE 0 END ,
                             FC_CGST_AMOUNT =ROUND(CASE WHEN IS_IGST<>1 THEN FC_XN_VALUE_WITH_GST-FC_XN_VALUE_WITHOUT_GST
							               ELSE 0 END/2,2),
                             FC_SGST_AMOUNT=ROUND(CASE WHEN IS_IGST<>1 THEN FC_XN_VALUE_WITH_GST-FC_XN_VALUE_WITHOUT_GST
							               ELSE 0 END/2,2)
			FROM #TMPFCRATE TMP


		IF @BCALLEDFORLIST=0
		BEGIN
		    
		 DECLARE @NFCOTH NUMERIC(10,2),@NFCFREIGHT NUMERIC(10,2)

		   SELECT @NFCFREIGHT=ROUND(FREIGHT+CASE WHEN OH_TAX_METHOD =1 THEN  ISNULL(FREIGHT_IGST_AMOUNT,0)+ISNULL(FREIGHT_CGST_AMOUNT,0)+ISNULL(FREIGHT_SGST_AMOUNT,0)
		        ELSE 0 END /ISNULL(FC_RATE,0),2)
		   FROM pim01106 WITH (NOLOCK) WHERE mrr_id= @CMRRID
		   AND FREIGHT <>0 AND ISNULL(FC_RATE,0)<>0

		   
		   SELECT @NFCOTH=ROUND(other_charges+CASE WHEN OH_TAX_METHOD =1 THEN  ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(other_charges_CGST_AMOUNT,0)+ISNULL(other_charges_SGST_AMOUNT,0)
		        ELSE 0 END /ISNULL(FC_RATE,0),2)
		   FROM pim01106 WITH (NOLOCK) WHERE mrr_id= @CMRRID
		   AND other_charges <>0 AND ISNULL(FC_RATE,0)<>0

		   SELECT SUM(FC_XN_VALUE_WITH_GST)+isnull(@NFCOTH,0)+isnull(@NFCFREIGHT,0) AS FC_TOTAL_AMOUNT
		   from #TMPFCRATE

		END
	
	
		

END