create PROCEDURE UPDATEPMT_SNC  
  @CXNTYPE			VARCHAR(10),  
  @CXNNO			VARCHAR(40),  
  @CXNID			VARCHAR(40),  
  @NREVERTFLAG		BIT = 0,  
  @NALLOWNEGSTOCK	BIT = 0,  
  @NCHKDELBARCODES	BIT = 0,  
  @NUPDATEMODE		INT=0,   
  @CCMD				NVARCHAR(4000) OUTPUT  
  
  --*** PARAMETERS :  
  --*** @CXNTYPE -		TRANSACTION TYPE (MODULE SPECIFIC)  
  --*** @CXNNO -		TRANSACTION NO ( MEMO NO OF MASTER TABLE )  
  --*** @CXNID -		TRANSACTION ID ( MEMO ID OF MASTER TABLE )  
  --*** @NREVERTFLAG -	A FLAG TO INDICATE WHETHER THIS PROCEDURE IS CALLED TO REVERT STOCK  
  --*** @NALLOWNEGSTOCK - FLAG TO INDICATE WHETHER OR NOT ALLOW NEGATIVE STOCK  
  --*** @NRETVAL - OUTPUT PARAMETER RETURNED BY THIS PROCEDURE (BIT 1-SUCCESS, 0-UNSUCCESS)  
----WITH ENCRYPTION
AS  
BEGIN  
	 DECLARE @NOUTFLAG INT, @NRETVAL BIT,@CXNTABLE VARCHAR(50),@CEXPR NVARCHAR(500),@CXNIDPARA VARCHAR(50),  
	   @BCANCELLED BIT  
	   
	 SET @NRETVAL = 0  
	 SET @CCMD = ''  
	    
	 IF @NREVERTFLAG = 1  
	  SET @NOUTFLAG = -1  
	 ELSE  
	  SET @NOUTFLAG = 1  
	PRINT 'UPDATEPMT_SNC STEP 0' 
	 
	 --IF NOT EXISTS ( SELECT TOP 1 A.PRODUCT_CODE FROM SNC_BARCODE_DET A JOIN SNC_DET B ON A.REFROW_ID=B.ROW_ID
		--			 WHERE B.MEMO_ID=@CXNID) 
		--   GOTO END_PROC --RECON PMT XN REBUILD WITHOUT CHECKING OF NEW BARCODE
	PRINT 'UPDATEPMT_SNC STEP 1'
	
	INSERT PMT01106 (PRODUCT_CODE,  QUANTITY_IN_STOCK, DEPT_ID,BIN_ID, LAST_UPDATE )    
	SELECT DISTINCT A1.PRODUCT_CODE,0 AS QUANTITY_IN_STOCK,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ as DEPT_ID,C.BIN_ID,GETDATE() AS LAST_UPDATE    
     FROM SNC_BARCODE_DET A1
     JOIN SNC_DET B ON A1.REFROW_ID=B.ROW_ID   
     JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID    
     JOIN SKU D ON A1.PRODUCT_CODE = D.PRODUCT_CODE    
     LEFT OUTER JOIN PMT01106 PMT ON PMT.PRODUCT_CODE = A1.PRODUCT_CODE AND PMT.DEPT_ID = C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=C.BIN_ID    
	 WHERE C.WIP=0 AND C.MEMO_ID = @CXNID AND PMT.PRODUCT_CODE IS NULL   
	
	
	INSERT WIP_PMT (PRODUCT_CODE,  QUANTITY_IN_STOCK, DEPT_ID,BIN_ID, LAST_UPDATE,WIP_UID,BASE_PRICE,VALUE_ADDITION,JOB_CODE ,XN_ROW_ID,
	                 Article_code ,para1_code,para2_code,para3_CODE,PARA4_CODE,PARA5_CODE,PARA6_CODE )    
	SELECT A1.PRODUCT_CODE,0 AS QUANTITY_IN_STOCK,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ AS DEPT_ID,C.BIN_ID,GETDATE() AS LAST_UPDATE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ +CONVERT(VARCHAR(MAX),NEWID()) ,B.PURCHASE_PRICE,0,'0000000' ,B.ROW_ID  ,
	       B.Article_code ,B.para1_code,B.para2_code,B.para3_CODE,B.PARA4_CODE,B.PARA5_CODE,B.PARA6_CODE
     FROM SNC_BARCODE_DET A1
     JOIN SNC_DET B ON A1.REFROW_ID=B.ROW_ID   
     JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID     
     LEFT OUTER JOIN WIP_PMT PMT ON PMT.PRODUCT_CODE = A1.PRODUCT_CODE AND PMT.DEPT_ID = C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=C.BIN_ID AND PMT.XN_ROW_ID=B.ROW_ID   
	 WHERE C.WIP=1 AND C.MEMO_ID = @CXNID AND PMT.PRODUCT_CODE IS NULL
	
	 PRINT 'UPDATEPMT_SNC STEP 2'  			  
	
	 INSERT PMT01106 (PRODUCT_CODE,  QUANTITY_IN_STOCK, DEPT_ID,BIN_ID, LAST_UPDATE )    
	 SELECT DISTINCT B.PRODUCT_CODE,0 AS QUANTITY_IN_STOCK,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ AS DEPT_ID,B.BIN_ID,GETDATE() AS LAST_UPDATE
   	 FROM SNC_CONSUMABLE_DET B  
	 JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
	 JOIN SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE  
	 LEFT OUTER JOIN PMT01106 PMT ON PMT.PRODUCT_CODE = B.PRODUCT_CODE AND PMT.DEPT_ID = C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=B.BIN_ID    
	 WHERE B.WIP=0 AND B.MEMO_ID = @CXNID AND PMT.PRODUCT_CODE IS NULL
	 
	 PRINT 'UPDATEPMT_SNC STEP 3'
	
	 --*** UPDATING THE QUANTITY IN STOCK INTO PMT01106 FOR THE GIVEN MEMO  
	 UPDATE A SET QUANTITY_IN_STOCK = QUANTITY_IN_STOCK + ( @NOUTFLAG * X.QUANTITY )  
	 FROM  PMT01106 A  
	 JOIN   
	 ( 
		SELECT A.PRODUCT_CODE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ AS DEPT_ID,C.BIN_ID,SUM(CASE WHEN E.CODING_SCHEME=3 THEN 1 ELSE B.QUANTITY END) AS QUANTITY   
		FROM SNC_DET B  
		JOIN SNC_BARCODE_DET A ON A.REFROW_ID=B.ROW_ID
		JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
		JOIN SKU D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
		JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
		WHERE C.WIP=0 AND B.MEMO_ID = @CXNID AND E.STOCK_NA=0  
		GROUP BY A.PRODUCT_CODE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ , C.BIN_ID  
	 )X ON A.PRODUCT_CODE = X.PRODUCT_CODE AND A.BIN_ID = X.BIN_ID AND A.DEPT_ID = X.DEPT_ID  
	 
	 PRINT 'UPDATEPMT_SNC STEP 4'	
	 
	 UPDATE A SET QUANTITY_IN_STOCK = QUANTITY_IN_STOCK - ( @NOUTFLAG * X.QUANTITY )  
	 FROM  PMT01106 A  
	 JOIN   
	 ( 
		SELECT B.PRODUCT_CODE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ AS DEPT_ID, B.BIN_ID,SUM(B.QUANTITY) AS QUANTITY   
		FROM SNC_CONSUMABLE_DET B  
		JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
		JOIN SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE  
		JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
		WHERE B.WIP=0 AND B.MEMO_ID = @CXNID AND E.STOCK_NA=0  
		GROUP BY B.PRODUCT_CODE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ , B.BIN_ID  
	 )X ON A.PRODUCT_CODE = X.PRODUCT_CODE AND A.BIN_ID = X.BIN_ID AND A.DEPT_ID = X.DEPT_ID  


	
	  --*** UPDATING THE QUANTITY IN STOCK INTO PMT01106 FOR THE GIVEN MEMO  
	 UPDATE A SET QUANTITY_IN_STOCK = QUANTITY_IN_STOCK + ( @NOUTFLAG * X.QUANTITY ) 
	 FROM  WIP_PMT A  
	 JOIN   
	 ( 
		SELECT B.ROW_ID, A.PRODUCT_CODE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ AS DEPT_ID, C.BIN_ID,SUM(CASE WHEN E.CODING_SCHEME=3 THEN 1 ELSE B.QUANTITY END) AS QUANTITY  
		FROM SNC_DET B  
		JOIN SNC_BARCODE_DET A ON A.REFROW_ID=B.ROW_ID
		JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
		JOIN WIP_PMT D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
		JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
		WHERE C.WIP=1 AND B.MEMO_ID = @CXNID AND E.STOCK_NA=0  
		GROUP BY A.PRODUCT_CODE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ , C.BIN_ID  ,B.ROW_ID,
		 b.ARTICLE_CODE ,b.para1_code,b.para2_code,b.para3_CODE,b.PARA4_CODE,b.PARA5_CODE,b.PARA6_CODE
	 )X ON A.PRODUCT_CODE = X.PRODUCT_CODE AND A.BIN_ID = X.BIN_ID 
	 AND A.DEPT_ID = X.DEPT_ID AND X.ROW_ID=A.XN_ROW_ID
	 WHERE A.JOB_CODE='0000000'
	 
	 PRINT 'UPDATEPMT_SNC STEP 4'	
	 
	 UPDATE A SET QUANTITY_IN_STOCK = QUANTITY_IN_STOCK - ( @NOUTFLAG * X.QUANTITY )  
	 FROM  WIP_PMT A  
	 JOIN   
	 ( 
		SELECT B.WIP_UID, B.PRODUCT_CODE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ AS DEPT_ID, B.BIN_ID,SUM(B.QUANTITY) AS QUANTITY   
		FROM SNC_CONSUMABLE_DET B  
		JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
		JOIN WIP_PMT D ON B.PRODUCT_CODE = D.PRODUCT_CODE  
		JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
		WHERE B.WIP=1 AND B.MEMO_ID = @CXNID AND E.STOCK_NA=0  
		GROUP BY B.PRODUCT_CODE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ , B.BIN_ID  ,B.WIP_UID
	 )X ON A.PRODUCT_CODE = X.PRODUCT_CODE AND A.BIN_ID = X.BIN_ID 
	 AND A.DEPT_ID = X.DEPT_ID AND A.WIP_UID=X.WIP_UID  
	  
     SET @NRETVAL = 1  --*** SUCCESS  
	 PRINT 'UPDATEPMT_SNC STEP 5'
	 SELECT @BCANCELLED=CANCELLED FROM SNC_MST WHERE MEMO_ID=@CXNID  

	 --*** CHECKING FOR NEGATIVE STOCK  
	 --*** IF USER OPTED NOT TO ALLOW NEGATIVE STOCK AND STOCK IS GOING OUT  
	 PRINT 'UPDATEPMT_SNC STEP 6'
	 IF @NALLOWNEGSTOCK = 0 OR @BCANCELLED=1   
	 BEGIN  
	  IF EXISTS (	SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM PMT01106 PMT
					JOIN SNC_BARCODE_DET A ON A.PRODUCT_CODE=PMT.PRODUCT_CODE
					JOIN SNC_DET B  ON B.ROW_ID=A.REFROW_ID
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN SKU D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE C.WIP=0 AND  B.MEMO_ID = @CXNID AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=C.BIN_ID
					--27 APR 2018
					AND C.CANCELLED=0
					--27 APR 2018
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
					UNION ALL
					SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM PMT01106 PMT
					JOIN 
					(
					SELECT product_code,MEMO_ID,BIN_ID ,WIP  FROM  SNC_CONSUMABLE_DET 
					GROUP BY product_code,MEMO_ID,BIN_ID ,WIP
					)B  ON PMT.PRODUCT_CODE=B.PRODUCT_CODE
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE B.WIP=0 AND  B.MEMO_ID = @CXNID AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=B.BIN_ID
					--27 APR 2018
					AND C.CANCELLED=0
					--27 APR 2018
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
					UNION ALL
					SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM WIP_PMT PMT
					JOIN SNC_BARCODE_DET A ON A.PRODUCT_CODE=PMT.PRODUCT_CODE
					JOIN SNC_DET B  ON B.ROW_ID=A.REFROW_ID
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN WIP_PMT D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE C.WIP=1 AND  B.MEMO_ID = @CXNID AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=C.BIN_ID AND B.ROW_ID=PMT.XN_ROW_ID
					AND PMT.JOB_CODE='0000000'
					--27 APR 2018
					AND C.CANCELLED=0
					--27 APR 2018
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
					UNION ALL
					SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM WIP_PMT PMT
					JOIN 
					(
					SELECT product_code,MEMO_ID,BIN_ID ,WIP,WIP_UID  FROM  SNC_CONSUMABLE_DET 
					GROUP BY product_code,MEMO_ID,BIN_ID ,WIP,WIP_UID
					)B  ON PMT.PRODUCT_CODE=B.PRODUCT_CODE
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN WIP_PMT D ON B.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE B.WIP=1 AND  B.MEMO_ID = @CXNID AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=B.BIN_ID AND B.WIP_UID=PMT.WIP_UID
					--27 APR 2018
					AND C.CANCELLED=0
					--27 APR 2018
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
			)  
	  BEGIN  
	   SET @NRETVAL = 0  --*** UNSUCCESS  
	   /*
	   --27 APR 2018
	   SET @CCMD = N'SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM PMT01106 PMT
					JOIN SNC_BARCODE_DET A ON A.PRODUCT_CODE=PMT.PRODUCT_CODE
					JOIN SNC_DET B  ON B.ROW_ID=A.REFROW_ID
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN SKU D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE C.WIP=0 AND  B.MEMO_ID = '''+@CXNID+''' AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.DEPT_ID AND PMT.BIN_ID=C.BIN_ID
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
					UNION ALL
					SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM PMT01106 PMT
					JOIN SNC_CONSUMABLE_DET B  ON PMT.PRODUCT_CODE=B.PRODUCT_CODE
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE B.WIP=0 AND  B.MEMO_ID = '''+@CXNID+''' AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.DEPT_ID AND PMT.BIN_ID=B.BIN_ID
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
					UNION ALL
					SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM WIP_PMT PMT
					JOIN SNC_BARCODE_DET A ON A.PRODUCT_CODE=PMT.PRODUCT_CODE
					JOIN SNC_DET B  ON B.ROW_ID=A.REFROW_ID
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN SKU D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE C.WIP=1 AND  B.MEMO_ID =  '''+@CXNID+'''  AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.DEPT_ID AND PMT.BIN_ID=C.BIN_ID AND B.ROW_ID=PMT.WIP_UID
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
					UNION ALL
					SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM WIP_PMT PMT
					JOIN SNC_CONSUMABLE_DET B  ON PMT.PRODUCT_CODE=B.PRODUCT_CODE
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE B.WIP=1 AND  B.MEMO_ID = '''+@CXNID+'''  AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.DEPT_ID AND PMT.BIN_ID=B.BIN_ID AND B.WIP_UID=PMT.WIP_UID
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0'  
			--27 APR 2018
			*/
			--27 APR 2018
			SET @CCMD='SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM PMT01106 PMT
					JOIN SNC_BARCODE_DET A ON A.PRODUCT_CODE=PMT.PRODUCT_CODE
					JOIN SNC_DET B  ON B.ROW_ID=A.REFROW_ID
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN SKU D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE C.WIP=0 AND  B.MEMO_ID = '''+@CXNID+''' AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=C.BIN_ID
					AND C.CANCELLED=0
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
					UNION ALL
					SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM PMT01106 PMT
					JOIN 
					(
					SELECT product_code,MEMO_ID,BIN_ID ,WIP  FROM  SNC_CONSUMABLE_DET 
					GROUP BY product_code,MEMO_ID,BIN_ID ,WIP
					)B  ON PMT.PRODUCT_CODE=B.PRODUCT_CODE
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE B.WIP=0 AND  B.MEMO_ID = '''+@CXNID+''' AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=B.BIN_ID
					AND C.CANCELLED=0
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
					UNION ALL
					SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM WIP_PMT PMT
					JOIN SNC_BARCODE_DET A ON A.PRODUCT_CODE=PMT.PRODUCT_CODE
					JOIN SNC_DET B  ON B.ROW_ID=A.REFROW_ID
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN WIP_PMT D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE C.WIP=1 AND  B.MEMO_ID = '''+@CXNID+''' AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=C.BIN_ID AND B.ROW_ID=PMT.XN_ROW_ID
					AND PMT.JOB_CODE=''0000000''
					AND C.CANCELLED=0
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
					UNION ALL
					SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM WIP_PMT PMT
					JOIN 
					(
					SELECT product_code,MEMO_ID,BIN_ID ,WIP,WIP_UID  FROM  SNC_CONSUMABLE_DET 
					GROUP BY product_code,MEMO_ID,BIN_ID ,WIP,WIP_UID
					)B  ON PMT.PRODUCT_CODE=B.PRODUCT_CODE
					JOIN SNC_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN WIP_PMT D ON B.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE B.WIP=1 AND  B.MEMO_ID = '''+@CXNID+''' AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=B.BIN_ID AND B.WIP_UID=PMT.WIP_UID
					AND C.CANCELLED=0
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0'		
	  END  
	   PRINT @CCMD  
   END   
	  
END_PROC:  
	PRINT 'UPDATEPMT_SNC STEP OUT'  
END  
--***************************** END OF PROCEDURE UPDATEPMT_SNC

