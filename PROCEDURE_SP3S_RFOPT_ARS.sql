create PROCEDURE SP3S_RFOPT_ARS(@ARS_ID VARCHAR(100)='',@LOC VARCHAR(MAX)='')  
AS  
BEGIN  
SET NOCOUNT ON  
--DECLARE @ARS_ID VARCHAR(100)='',@LOC VARCHAR(MAX)=''  
  
DECLARE @SQL VARCHAR(MAX),@FIELDS VARCHAR(MAX),@JOIN VARCHAR(MAX),@PARA_SET BIT=0  
  
IF OBJECT_ID('TEMPDB..#LOC') IS NOT NULL DROP TABLE #LOC              
CREATE TABLE #LOC (LOC VARCHAR(5))          
  
IF @ARS_ID=''  
   INSERT #LOC SELECT DISTINCT DEPT_ID FROM LOCATION(NOLOCK) WHERE INACTIVE=0  
ELSE  
   INSERT #LOC SELECT DISTINCT DEPT_ID FROM ARS_DET (NOLOCK) WHERE ARS_ID=@ARS_ID  
     
SELECT @SQL=''''+REPLACE(@LOC,',',''',''')+''''        
SET @SQL='DELETE #LOC WHERE LOC NOT '+@LOC+''        
--PRINT '--LOC '+@SQL  
IF @LOC<>'' EXEC(@SQL)          
DELETE #LOC WHERE LOC NOT IN (SELECT DEPT_ID FROM LOCATION WHERE PUR_LOC=1 UNION SELECT '15')  
  
  
IF EXISTS(SELECT TOP 1 * FROM ARTICLE (NOLOCK) WHERE PARA1_SET=1 OR PARA2_SET=1) and 1=1  
   SET @PARA_SET=1          
  
IF OBJECT_ID('tempdb..##PLAN_MAPPED_EXCEL_FILEDS_RF') IS NOT NULL DROP TABLE ##PLAN_MAPPED_EXCEL_FILEDS_RF        
IF OBJECT_ID('tempdb..##RF_STOCK') IS NOT NULL DROP TABLE ##RF_STOCK  
IF OBJECT_ID('tempdb..#ARS_PRODUCTS') IS NOT NULL DROP TABLE #ARS_PRODUCTS  
CREATE TABLE #ARS_PRODUCTS(PRODUCT_CODE VARCHAR(1000),ARTICLE_CODE VARCHAR(1000))  
  
CREATE TABLE ##PLAN_MAPPED_EXCEL_FILEDS_RF(FIELD VARCHAR(1000),TABLE_NAME VARCHAR(200))        
SET @SQL=''  
SELECT @SQL=COALESCE(@SQL,'')+'IF NOT EXISTS(SELECT TOP 1 '+NAME+' FROM '+OBJECT_NAME(ID)+' WHERE '+NAME+' LIKE ''0000000%'' AND ARS_ID='''+CAST(@ARS_ID AS VARCHAR)+''')  
INSERT ##PLAN_MAPPED_EXCEL_FILEDS_RF (FIELD) SELECT '''+NAME+''';'+CHAR(13)         
FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='ARS_DET' AND name LIKE '%CODE'        
--PRINT '29 '+@SQL  
IF ISNULL(@ARS_ID,'')!=''  
EXEC(@SQL)  
  
UPDATE ##PLAN_MAPPED_EXCEL_FILEDS_RF SET TABLE_NAME='ARTICLE' WHERE FIELD='ARTICLE_CODE'  
UPDATE ##PLAN_MAPPED_EXCEL_FILEDS_RF SET TABLE_NAME='SKU' WHERE FIELD LIKE 'PARA%'  
UPDATE ##PLAN_MAPPED_EXCEL_FILEDS_RF SET TABLE_NAME=REPLACE(FIELD,'_KEY_CODE','') WHERE FIELD LIKE 'ATTR%KEY_CODE'  
UPDATE ##PLAN_MAPPED_EXCEL_FILEDS_RF SET TABLE_NAME='SECTIONM' WHERE FIELD LIKE 'SECTION_CODE'  
UPDATE ##PLAN_MAPPED_EXCEL_FILEDS_RF SET TABLE_NAME='SECTIOND' WHERE FIELD LIKE 'SUB_SECTION_CODE'  
  
SET @JOIN=''        
SELECT @JOIN=COALESCE(@JOIN,'')+'AD.'+FIELD+'='+TABLE_NAME+'.'+FIELD+' AND '        
FROM ##PLAN_MAPPED_EXCEL_FILEDS_RF        
SET @JOIN=RTRIM(@JOIN)  
IF RIGHT(@JOIN,3)='AND'  
SET @JOIN=LEFT(@JOIN,LEN(@JOIN)-3)  
--PRINT @JOIN  
IF OBJECT_ID('tempdb..##PLAN_MAPPED_EXCEL_FILEDS_RF') IS NOT NULL DROP TABLE ##PLAN_MAPPED_EXCEL_FILEDS_RF  
  
IF @ARS_ID!=''  
SET @SQL='SELECT SKU.PRODUCT_CODE,SKU.ARTICLE_CODE  
FROM ARS_MST AM (NOLOCK) JOIN ARS_DET AD (NOLOCK) ON AM.ARS_ID=AD.ARS_ID   
JOIN ARTICLE (NOLOCK)   
JOIN SKU (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE  
JOIN SECTIOND (NOLOCK) ON SECTIOND.sub_section_code=ARTICLE.sub_section_code  
JOIN SECTIONM (NOLOCK) ON SECTIONM.section_code=SECTIOND.section_code  
JOIN ARTICLE_FIX_ATTR AF (NOLOCK)  
JOIN ATTR1_MST (NOLOCK) ON ATTR1_MST.ATTR1_KEY_CODE=AF.ATTR1_KEY_CODE  
JOIN ATTR2_MST (NOLOCK) ON ATTR2_MST.ATTR2_KEY_CODE=AF.ATTR2_KEY_CODE  
JOIN ATTR3_MST (NOLOCK) ON ATTR3_MST.ATTR3_KEY_CODE=AF.ATTR3_KEY_CODE  
JOIN ATTR4_MST (NOLOCK) ON ATTR4_MST.ATTR4_KEY_CODE=AF.ATTR4_KEY_CODE  
JOIN ATTR5_MST (NOLOCK) ON ATTR5_MST.ATTR5_KEY_CODE=AF.ATTR5_KEY_CODE  
JOIN ATTR6_MST (NOLOCK) ON ATTR6_MST.ATTR6_KEY_CODE=AF.ATTR6_KEY_CODE  
JOIN ATTR7_MST (NOLOCK) ON ATTR7_MST.ATTR7_KEY_CODE=AF.ATTR7_KEY_CODE  
JOIN ATTR8_MST (NOLOCK) ON ATTR8_MST.ATTR8_KEY_CODE=AF.ATTR8_KEY_CODE  
JOIN ATTR9_MST (NOLOCK) ON ATTR9_MST.ATTR9_KEY_CODE=AF.ATTR9_KEY_CODE  
JOIN ATTR10_MST (NOLOCK) ON ATTR10_MST.ATTR10_KEY_CODE=AF.ATTR10_KEY_CODE  
JOIN ATTR11_MST (NOLOCK) ON ATTR11_MST.ATTR11_KEY_CODE=AF.ATTR11_KEY_CODE  
JOIN ATTR12_MST (NOLOCK) ON ATTR12_MST.ATTR12_KEY_CODE=AF.ATTR12_KEY_CODE  
JOIN ATTR13_MST (NOLOCK) ON ATTR13_MST.ATTR13_KEY_CODE=AF.ATTR13_KEY_CODE  
JOIN ATTR14_MST (NOLOCK) ON ATTR14_MST.ATTR14_KEY_CODE=AF.ATTR14_KEY_CODE  
JOIN ATTR15_MST (NOLOCK) ON ATTR15_MST.ATTR15_KEY_CODE=AF.ATTR15_KEY_CODE  
JOIN ATTR16_MST (NOLOCK) ON ATTR16_MST.ATTR16_KEY_CODE=AF.ATTR16_KEY_CODE  
JOIN ATTR17_MST (NOLOCK) ON ATTR17_MST.ATTR17_KEY_CODE=AF.ATTR17_KEY_CODE  
JOIN ATTR18_MST (NOLOCK) ON ATTR18_MST.ATTR18_KEY_CODE=AF.ATTR18_KEY_CODE  
JOIN ATTR19_MST (NOLOCK) ON ATTR19_MST.ATTR19_KEY_CODE=AF.ATTR19_KEY_CODE  
JOIN ATTR20_MST (NOLOCK) ON ATTR20_MST.ATTR20_KEY_CODE=AF.ATTR20_KEY_CODE  
JOIN ATTR21_MST (NOLOCK) ON ATTR21_MST.ATTR21_KEY_CODE=AF.ATTR21_KEY_CODE  
JOIN ATTR22_MST (NOLOCK) ON ATTR22_MST.ATTR22_KEY_CODE=AF.ATTR22_KEY_CODE  
JOIN ATTR23_MST (NOLOCK) ON ATTR23_MST.ATTR23_KEY_CODE=AF.ATTR23_KEY_CODE  
JOIN ATTR24_MST (NOLOCK) ON ATTR24_MST.ATTR24_KEY_CODE=AF.ATTR24_KEY_CODE  
JOIN ATTR25_MST (NOLOCK) ON ATTR25_MST.ATTR25_KEY_CODE=AF.ATTR25_KEY_CODE  
ON AF.ARTICLE_CODE=ARTICLE.ARTICLE_CODE  
ON '+CASE ISNULL(@JOIN,'') WHEN '' THEN '1=1' ELSE @JOIN END+'  
WHERE '+CASE WHEN ISNULL(@ARS_ID,'')='' THEN '1=1' ELSE 'AM.ARS_ID='''+@ARS_ID+'''' END  
ELSE  
SET @SQL='SELECT SKU.PRODUCT_CODE,SKU.ARTICLE_CODE  
FROM ARTICLE (NOLOCK)   
JOIN SKU (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE  
JOIN SECTIOND (NOLOCK) ON SECTIOND.sub_section_code=ARTICLE.sub_section_code  
JOIN SECTIONM (NOLOCK) ON SECTIONM.section_code=SECTIOND.section_code  
JOIN ARTICLE_FIX_ATTR AF (NOLOCK)  
JOIN ATTR1_MST (NOLOCK) ON ATTR1_MST.ATTR1_KEY_CODE=AF.ATTR1_KEY_CODE  
JOIN ATTR2_MST (NOLOCK) ON ATTR2_MST.ATTR2_KEY_CODE=AF.ATTR2_KEY_CODE  
JOIN ATTR3_MST (NOLOCK) ON ATTR3_MST.ATTR3_KEY_CODE=AF.ATTR3_KEY_CODE  
JOIN ATTR4_MST (NOLOCK) ON ATTR4_MST.ATTR4_KEY_CODE=AF.ATTR4_KEY_CODE  
JOIN ATTR5_MST (NOLOCK) ON ATTR5_MST.ATTR5_KEY_CODE=AF.ATTR5_KEY_CODE  
JOIN ATTR6_MST (NOLOCK) ON ATTR6_MST.ATTR6_KEY_CODE=AF.ATTR6_KEY_CODE  
JOIN ATTR7_MST (NOLOCK) ON ATTR7_MST.ATTR7_KEY_CODE=AF.ATTR7_KEY_CODE  
JOIN ATTR8_MST (NOLOCK) ON ATTR8_MST.ATTR8_KEY_CODE=AF.ATTR8_KEY_CODE  
JOIN ATTR9_MST (NOLOCK) ON ATTR9_MST.ATTR9_KEY_CODE=AF.ATTR9_KEY_CODE  
JOIN ATTR10_MST (NOLOCK) ON ATTR10_MST.ATTR10_KEY_CODE=AF.ATTR10_KEY_CODE  
JOIN ATTR11_MST (NOLOCK) ON ATTR11_MST.ATTR11_KEY_CODE=AF.ATTR11_KEY_CODE  
JOIN ATTR12_MST (NOLOCK) ON ATTR12_MST.ATTR12_KEY_CODE=AF.ATTR12_KEY_CODE  
JOIN ATTR13_MST (NOLOCK) ON ATTR13_MST.ATTR13_KEY_CODE=AF.ATTR13_KEY_CODE  
JOIN ATTR14_MST (NOLOCK) ON ATTR14_MST.ATTR14_KEY_CODE=AF.ATTR14_KEY_CODE  
JOIN ATTR15_MST (NOLOCK) ON ATTR15_MST.ATTR15_KEY_CODE=AF.ATTR15_KEY_CODE  
JOIN ATTR16_MST (NOLOCK) ON ATTR16_MST.ATTR16_KEY_CODE=AF.ATTR16_KEY_CODE  
JOIN ATTR17_MST (NOLOCK) ON ATTR17_MST.ATTR17_KEY_CODE=AF.ATTR17_KEY_CODE  
JOIN ATTR18_MST (NOLOCK) ON ATTR18_MST.ATTR18_KEY_CODE=AF.ATTR18_KEY_CODE  
JOIN ATTR19_MST (NOLOCK) ON ATTR19_MST.ATTR19_KEY_CODE=AF.ATTR19_KEY_CODE  
JOIN ATTR20_MST (NOLOCK) ON ATTR20_MST.ATTR20_KEY_CODE=AF.ATTR20_KEY_CODE  
JOIN ATTR21_MST (NOLOCK) ON ATTR21_MST.ATTR21_KEY_CODE=AF.ATTR21_KEY_CODE  
JOIN ATTR22_MST (NOLOCK) ON ATTR22_MST.ATTR22_KEY_CODE=AF.ATTR22_KEY_CODE  
JOIN ATTR23_MST (NOLOCK) ON ATTR23_MST.ATTR23_KEY_CODE=AF.ATTR23_KEY_CODE  
JOIN ATTR24_MST (NOLOCK) ON ATTR24_MST.ATTR24_KEY_CODE=AF.ATTR24_KEY_CODE  
JOIN ATTR25_MST (NOLOCK) ON ATTR25_MST.ATTR25_KEY_CODE=AF.ATTR25_KEY_CODE  
ON AF.ARTICLE_CODE=ARTICLE.ARTICLE_CODE  
WHERE '+CASE WHEN ISNULL(@ARS_ID,'')='' THEN '1=1' ELSE 'AM.ARS_ID='''+@ARS_ID+'''' END  
PRINT @SQL  
INSERT #ARS_PRODUCTS EXEC(@SQL)  
  
  
  
ALTER TABLE #ARS_PRODUCTS ADD XN_DT DATETIME  
UPDATE #ARS_PRODUCTS SET XN_DT=CONVERT(DATE,GETDATE())  
  
SELECT #LOC.LOC DEPT_ID,#ARS_PRODUCTS.PRODUCT_CODE,#ARS_PRODUCTS.XN_DT,CAST(0 AS FLOAT)OPS_QTY,CAST(0 AS FLOAT)PRD_QTY,CAST(0 AS FLOAT)SLR_QTY,CAST(0 AS FLOAT)SLS_QTY  
,CAST(0 AS FLOAT)MIR_QTY,CAST(0 AS FLOAT)MIS_QTY,CAST(0 AS FLOAT)DNPR_QTY,CAST(0 AS FLOAT)DNPI_QTY  
,CAST(0 AS FLOAT)TTM_QTY,CAST(0 AS FLOAT)SCC_QTY,CAST(0 AS FLOAT)SCF_QTY,CAST(0 AS FLOAT)BOC_QTY,CAST(0 AS FLOAT)JWR_QTY  
,CAST(0 AS FLOAT)JWI_QTY,CAST(0 AS FLOAT)CIP_QTY,CAST(0 AS FLOAT)PFI_QTY,CAST(0 AS FLOAT)WSR_QTY,CAST(0 AS FLOAT)WPI_QTY  
,CAST(0 AS FLOAT)API_QTY,CAST(0 AS FLOAT)WPR_QTY,CAST(0 AS FLOAT)WSL_QTY,CAST(0 AS FLOAT)APO_QTY,CAST(0 AS FLOAT)UNC_QTY  
,CAST(0 AS FLOAT)CNC_QTY,CAST(0 AS FLOAT)SAUM_QTY,CAST(0 AS FLOAT)SACM_QTY,CAST(0 AS FLOAT)SAU_QTY  
,CAST(0 AS FLOAT)SAC_QTY,CAST(0 AS FLOAT)APR_QTY,CAST(0 AS FLOAT)APP_QTY,CAST(0 AS FLOAT)PRT_QTY,CAST(0 AS FLOAT)CHO_QTY  
,CAST(0 AS FLOAT)TRO_QTY,CAST(0 AS FLOAT)TRI_QTY,CAST(0 AS FLOAT)GRNPSOUT_QTY,CAST(0 AS FLOAT)GRNPSIN_QTY  
,CAST(0 AS FLOAT)CHI_QTY,CAST(0 AS FLOAT)PUR_QTY,CAST(0 AS FLOAT)DCI_QTY,CAST(0 AS FLOAT)DCO_QTY,CAST(0 AS FLOAT)GIT_QTY  
,''--@ARS_ID   
ARS_ID  
INTO ##RF_STOCK   
FROM #ARS_PRODUCTS,#LOC  
  
ALTER TABLE ##RF_STOCK ALTER COLUMN ARS_ID VARCHAR(100) NULL  
CREATE NONCLUSTERED INDEX IX_LOC_RFSTOCK ON ##RF_STOCK ([DEPT_ID]) INCLUDE ([PRODUCT_CODE])  
  
UPDATE R SET OPS_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(SELECT A.dept_id,A.product_code,SUM(A.QUANTITY_OB) QTY  
FROM OPS01106 A WITH (NOLOCK)    
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON A.DEPT_ID=L.LOC  
JOIN sku b (NOLOCK) ON a.product_code=b.product_code    
JOIN article c (NOLOCK) ON c.article_code=b.article_code    
JOIN sectionD d (NOLOCK) ON d.sub_section_code=c.sub_section_code    
JOIN sectionm e (NOLOCK) ON e.section_code=d.section_code    
WHERE ISNULL(e.ITEM_TYPE,0) in (0,1) AND ISNULL(A.QUANTITY_OB,0)<>0  
GROUP BY A.dept_id,A.product_code  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.dept_id  
  
  
UPDATE R SET PRD_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(SELECT B.DEPT_ID,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM PRD_STK_TRANSFER_DTM_DET A WITH (NOLOCK)    
JOIN PRD_STK_TRANSFER_DTM_MST B WITH (NOLOCK) ON A.MEMO_ID = B.MEMO_ID         
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.DEPT_ID=L.LOC  
WHERE B.CANCELLED=0  
GROUP BY B.DEPT_ID,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.dept_id  
  
  
  
UPDATE R SET DCO_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT C.DEPT_ID,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM FLOOR_ST_DET A WITH (NOLOCK)    
JOIN FLOOR_ST_MST B WITH (NOLOCK) ON A.MEMO_ID  = B.MEMO_ID          
JOIN LOCATION C WITH (NOLOCK) ON C.DEPT_ID=B.location_Code      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0        
GROUP BY C.DEPT_ID,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.dept_id  
  
  
  
UPDATE R SET DCI_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT C.DEPT_ID,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM FLOOR_ST_DET A (NOLOCK)        
JOIN FLOOR_ST_MST B (NOLOCK) ON A.MEMO_ID  = B.MEMO_ID          
JOIN LOCATION C (NOLOCK) ON C.DEPT_ID=B.location_Code      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.DEPT_ID=L.LOC  
WHERE  B.CANCELLED = 0 AND ISNULL(B.RECEIPT_DT,'')<>''         
GROUP BY C.DEPT_ID,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.dept_id  
  
  
UPDATE R SET PUR_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT B.DEPT_ID,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM PID01106 A WITH(NOLOCK)        
JOIN PIM01106 B WITH(NOLOCK) ON A.MRR_ID = B.MRR_ID    
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.DEPT_ID=L.LOC  
LEFT OUTER JOIN pim01106 c (NOLOCK) ON c.ref_converted_mrntobill_mrrid=b.mrr_id    
WHERE B.CANCELLED = 0 AND c.mrr_id IS NULL  AND B.INV_MODE IN (0,1)  
AND A.PRODUCT_CODE<>'' AND B.RECEIPT_DT<>''    
AND ISNULL(B.xn_item_type,0) in (0,1)     
GROUP BY B.DEPT_ID,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.dept_id  
  
  
UPDATE R SET CHI_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT B.DEPT_ID,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM PID01106 A WITH(NOLOCK)        
JOIN PIM01106 B WITH(NOLOCK) ON A.MRR_ID = B.MRR_ID    
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.DEPT_ID=L.LOC  
LEFT OUTER JOIN pim01106 c (NOLOCK) ON c.ref_converted_mrntobill_mrrid=b.mrr_id    
WHERE B.CANCELLED = 0 AND c.mrr_id IS NULL  AND B.INV_MODE NOT IN (0,1)  
AND A.PRODUCT_CODE<>'' AND B.RECEIPT_DT<>''    
AND ISNULL(B.xn_item_type,0) in (0,1)   
GROUP BY B.DEPT_ID,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.dept_id  
  
  
UPDATE R SET GRNPSIN_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM GRN_PS_DET A WITH(NOLOCK)        
JOIN GRN_PS_MST B WITH(NOLOCK) ON A.MEMO_ID  = B.MEMO_ID    
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.location_Code =L.LOC  
WHERE B.CANCELLED = 0     
GROUP BY L.LOC,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET GRNPSOUT_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM PID01106 A WITH(NOLOCK)        
JOIN PIM01106 B WITH(NOLOCK) ON A.MRR_ID = B.MRR_ID    
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0     
AND A.PRODUCT_CODE<>'' AND B.RECEIPT_DT<>''    
AND ISNULL(B.PIM_MODE,0)=6    
AND ISNULL(B.xn_item_type,0) in (0,1)     
GROUP BY L.LOC,ARS.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC   
  
  
UPDATE R SET TRI_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM IND01106 A WITH(NOLOCK)    
JOIN INM01106 B WITH(NOLOCK) ON A.INV_ID = B.INV_ID        
JOIN LOCATION D WITH(NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID       
JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID') LOC ON 1=1    
JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID') HO ON 1=1     
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.PARTY_DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND ISNULL(D.SIS_LOC,0)=0 AND INV_MODE=2      
 AND LOC.value =HO.value     
 AND ISNULL(B.xn_item_type,0) in (0,1)   
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC     
   
  
UPDATE R SET TRI_QTY=ISNULL(TRI_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM RMD01106 A WITH(NOLOCK)        
JOIN RMM01106 B WITH(NOLOCK) ON A.RM_ID = B.RM_ID        
JOIN LOCATION D WITH(NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID        
JOIN LOCATION E WITH(NOLOCK) ON E.DEPT_ID=B.location_Code       
JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID') LOC ON 1=1    
JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID') HO ON 1=1    
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.PARTY_DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND B.DN_TYPE IN (0,1)  -- AND EXPORTED=1       
 AND ISNULL(E.SIS_LOC,0)=0 AND MODE=2      
 AND LOC.value =HO.value    
 AND ISNULL(B.xn_item_type,0) in (0,1)      
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
   
UPDATE R SET TRO_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM PID01106 A WITH(NOLOCK)    
 JOIN PIM01106 B WITH(NOLOCK) ON A.MRR_ID = B.MRR_ID        
 JOIN LOCATION D WITH(NOLOCK) ON D.DEPT_ID=B.DEPT_ID      
 JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID') LOC ON 1=1    
 JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID') HO ON 1=1    
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND B.RECEIPT_DT<>'' AND ISNULL(D.SIS_LOC,0)=0 AND INV_MODE=2      
 AND LOC.VALUE=HO.VALUE AND ISNULL(B.xn_item_type,0) in (0,1)     
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
  
UPDATE R SET TRO_QTY=ISNULL(TRO_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM CND01106 A WITH(NOLOCK)        
JOIN CNM01106 B WITH(NOLOCK) ON A.CN_ID = B.CN_ID        
JOIN LOCATION D WITH(NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID       
JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID') LOC ON 1=1    
JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID') HO ON 1=1     
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.BILLED_FROM_DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND B.RECEIPT_DT<>'' AND B.MODE=2 AND ISNULL(D.SIS_LOC,0)=0      
AND LOC.VALUE=HO.VALUE AND ISNULL(B.xn_item_type,0) in (0,1)     
GROUP BY L.LOC,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
  
UPDATE R SET CHO_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM RMD01106 A WITH(NOLOCK)    
JOIN RMM01106 B WITH(NOLOCK) ON A.RM_ID = B.RM_ID        
JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code       
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND B.DN_TYPE IN (0,1) AND ISNULL(C.SIS_LOC,0)<>1 AND ISNULL(B.xn_item_type,0) in (0,1) AND MODE=2  
GROUP BY L.LOC,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
     
UPDATE R SET PRT_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM RMD01106 A WITH(NOLOCK)    
JOIN RMM01106 B WITH(NOLOCK) ON A.RM_ID = B.RM_ID        
JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code       
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND B.DN_TYPE IN (0,1) AND ISNULL(C.SIS_LOC,0)<>1 AND ISNULL(B.xn_item_type,0) in (0,1) AND MODE!=2     
GROUP BY L.LOC,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET APP_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM APD01106 A WITH(NOLOCK)        
JOIN APM01106 B WITH(NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.location_Code =L.LOC  
WHERE B.CANCELLED = 0        
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET APR_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,B.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM APPROVAL_RETURN_DET A WITH(NOLOCK)        
JOIN APD01106 B WITH(NOLOCK) ON A.APD_ROW_ID = B.ROW_ID        
JOIN APPROVAL_RETURN_MST C WITH(NOLOCK) ON C.MEMO_ID = A.MEMO_ID        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON B.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.location_Code =L.LOC  
WHERE C.CANCELLED = 0        
GROUP BY L.LOC,B.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
---CHK1  
UPDATE R SET SAC_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(ABS(A.QUANTITY)) QTY  
FROM ICD01106 A WITH(NOLOCK)        
 JOIN ICM01106 B WITH(NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID        
 JOIN SKU WITH(NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE      
 JOIN ARTICLE D WITH(NOLOCK) ON D.ARTICLE_CODE=SKU.ARTICLE_CODE      
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code     
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0 AND   ISNULL(B.xn_item_type,0) in (0,1)       
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
---CHK2  
UPDATE R SET SAU_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM ICD01106 A WITH(NOLOCK)        
 JOIN ICM01106 B WITH(NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID        
 JOIN SKU WITH(NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE      
 JOIN ARTICLE D WITH(NOLOCK) ON D.ARTICLE_CODE=SKU.ARTICLE_CODE      
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0 AND   ISNULL(B.xn_item_type,0) in (0,1)       
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
---CHK3  
UPDATE R SET SACM_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM ICD01106 A WITH(NOLOCK)        
 JOIN ICM01106 B WITH(NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID        
 JOIN SKU WITH(NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE      
 JOIN ARTICLE D WITH(NOLOCK) ON D.ARTICLE_CODE=SKU.ARTICLE_CODE      
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code     
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0 AND   ISNULL(B.xn_item_type,0) in (0,1)       
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
---CHK4  
UPDATE R SET SAUM_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM ICD01106 A WITH(NOLOCK)        
 JOIN ICM01106 B WITH(NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID        
 JOIN SKU WITH(NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE      
 JOIN ARTICLE D WITH(NOLOCK) ON D.ARTICLE_CODE=SKU.ARTICLE_CODE      
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code       
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND   ISNULL(B.xn_item_type,0) in (0,1)       
GROUP BY L.LOC,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
---CHK5  
UPDATE R SET CNC_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM ICD01106 A WITH(NOLOCK)        
 JOIN ICM01106 B WITH(NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID        
 JOIN SKU WITH(NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE      
 JOIN ARTICLE D WITH(NOLOCK) ON D.ARTICLE_CODE=SKU.ARTICLE_CODE      
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code    
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0 AND   ISNULL(B.xn_item_type,0) in (0,1)       
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
---CHK6  
UPDATE R SET UNC_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM ICD01106 A WITH(NOLOCK)        
 JOIN ICM01106 B WITH(NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID        
 JOIN SKU WITH(NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE      
 JOIN ARTICLE D WITH(NOLOCK) ON D.ARTICLE_CODE=SKU.ARTICLE_CODE      
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code       
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0 AND   ISNULL(B.xn_item_type,0) in (0,1)       
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
--ALTER TABLE ##RF_STOCK ADD CHO_QTY FLOAT  
UPDATE R SET CHO_QTY=ISNULL(CHO_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
 FROM IND01106 A WITH(NOLOCK)        
 JOIN INM01106 B WITH(NOLOCK) ON A.INV_ID = B.INV_ID        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0     
 AND B.INV_MODE=2  
 AND ISNULL(B.xn_item_type,0) in (0,1) --AND B.ENTRY_MODE<>2      
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET APO_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
 FROM IND01106 A WITH(NOLOCK)        
 JOIN INM01106 B WITH(NOLOCK) ON A.INV_ID = B.INV_ID        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0   
 AND B.INV_MODE!=2  AND B.BIN_TRANSFER=1  
 AND ISNULL(B.xn_item_type,0) in (0,1) --AND B.ENTRY_MODE<>2      
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET WSL_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
 FROM IND01106 A WITH(NOLOCK)        
 JOIN INM01106 B WITH(NOLOCK) ON A.INV_ID = B.INV_ID        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0     
 AND B.INV_MODE!=2  AND B.BIN_TRANSFER!=1  
 AND ISNULL(B.xn_item_type,0) in (0,1) --AND B.ENTRY_MODE<>2      
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
  
UPDATE R SET WPR_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM IND01106 A WITH(NOLOCK)       
 JOIN INM01106 B WITH(NOLOCK) ON A.INV_ID = B.INV_ID     
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.DEPT_ID=L.LOC   
JOIN     
 (SELECT DET.PS_ID, DET.BIN_ID,C.PS_NO,DET.PRODUCT_CODE     
  FROM WPS_DET DET WITH(NOLOCK)    
  JOIN WPS_MST C WITH(NOLOCK) ON DET.PS_ID =C.PS_ID        
  WHERE C.CANCELLED = 0 AND ISNULL(DET.PS_ID,'')<>''     
  GROUP BY DET.PS_ID, DET.BIN_ID,C.PS_NO,DET.PRODUCT_CODE    
 ) DET ON A.PRODUCT_CODE=DET.PRODUCT_CODE AND A.PS_ID=DET.PS_ID AND a.BIN_ID=det.BIN_ID    
 WHERE B.CANCELLED = 0  AND ISNULL(B.xn_item_type,0) in (0,1)      
 GROUP BY L.LOC,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
  
UPDATE R SET API_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM IND01106 A WITH(NOLOCK)        
 JOIN INM01106 B WITH(NOLOCK) ON A.INV_ID = B.INV_ID        
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code   
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0 AND B.BIN_TRANSFER=1      
 AND B.ENTRY_MODE<>2   AND ISNULL(B.xn_item_type,0) in (0,1)     
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET WPI_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM WPS_DET A WITH(NOLOCK)        
 JOIN WPS_MST B WITH(NOLOCK) ON A.PS_ID = B.PS_ID        
 JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code     
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0        
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
   
UPDATE R SET CHI_QTY=ISNULL(CHI_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM CND01106 A (NOLOCK)        
 JOIN CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID        
 JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=B.BILLED_FROM_DEPT_ID      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON LOC.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0 AND B.CN_TYPE<>2 AND (MODE<>2 OR B.RECEIPT_DT<>'')      
 AND ISNULL(B.xn_item_type,0) in (0,1)         
 AND MODE=2  
GROUP BY L.LOC,A.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET API_QTY=ISNULL(API_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM CND01106 A (NOLOCK)        
 JOIN CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID        
 JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=B.BILLED_FROM_DEPT_ID      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON LOC.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0 AND B.CN_TYPE<>2 AND (MODE<>2 OR B.RECEIPT_DT<>'')      
 AND ISNULL(B.xn_item_type,0) in (0,1)         
 AND MODE!=2 AND (B.BIN_TRANSFER=1 OR B.MODE=3)  
GROUP BY L.LOC,A.PRODUCT_CODE    
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET WSR_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM CND01106 A (NOLOCK)        
 JOIN CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID        
 JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=B.BILLED_FROM_DEPT_ID      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON LOC.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0 AND B.CN_TYPE<>2 AND (MODE<>2 OR B.RECEIPT_DT<>'')      
 AND ISNULL(B.xn_item_type,0) in (0,1)         
 AND MODE!=2 AND NOT (B.BIN_TRANSFER=1 OR B.MODE=3)  
 GROUP BY L.LOC,A.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET APO_QTY=ISNULL(APO_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM CND01106 A (NOLOCK)        
 JOIN CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID        
 LEFT OUTER JOIN LOCATION C ON C.DEPT_ID=B.PARTY_DEPT_ID      
 JOIN (SELECT TOP 1 * FROM  config WHERE CONFIG_OPTION='LOCATION_ID') CL ON 1=1    
 JOIN (SELECT TOP 1 * FROM  config WHERE CONFIG_OPTION='HO_LOCATION_ID') HL ON 1=1    
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON CASE WHEN B.BIN_TRANSFER=1 THEN B.LOCATION_CODE ELSE B.PARTY_DEPT_ID END=L.LOC  
 WHERE B.CANCELLED = 0   
 AND (B.BIN_TRANSFER=1 OR ISNULL(C.SIS_LOC,0)=1)     
 AND ISNULL(B.xn_item_type,0) in (0,1)      
 AND B.BIN_TRANSFER=1  
  and (CL.value =HL.value or CL.value = (CASE WHEN B.BIN_TRANSFER=1 THEN B.location_Code  ELSE B.PARTY_DEPT_ID END))    
GROUP BY L.LOC,A.PRODUCT_CODE    
 )T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
    
UPDATE R SET CHO_QTY=ISNULL(CHO_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
FROM CND01106 A (NOLOCK)        
 JOIN CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID        
 LEFT OUTER JOIN LOCATION C ON C.DEPT_ID=B.PARTY_DEPT_ID      
 JOIN (SELECT TOP 1 * FROM  config WHERE CONFIG_OPTION='LOCATION_ID') CL ON 1=1    
 JOIN (SELECT TOP 1 * FROM  config WHERE CONFIG_OPTION='HO_LOCATION_ID') HL ON 1=1    
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON CASE WHEN B.BIN_TRANSFER=1 THEN B.location_Code  ELSE B.PARTY_DEPT_ID END=L.LOC  
 WHERE B.CANCELLED = 0 AND (B.BIN_TRANSFER=1 OR ISNULL(C.SIS_LOC,0)=1)     
 AND ISNULL(B.xn_item_type,0) in (0,1)      
 AND B.BIN_TRANSFER!=1  
  and (CL.value =HL.value or CL.value = (CASE WHEN B.BIN_TRANSFER=1 THEN B.location_Code  ELSE B.PARTY_DEPT_ID END))    
GROUP BY L.LOC,A.PRODUCT_CODE    
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
  
UPDATE R SET PFI_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM IRD01106 A (NOLOCK)        
 JOIN IRM01106 B (NOLOCK) ON A.IRM_MEMO_ID = B.IRM_MEMO_ID        
 JOIN LOCATION C (NOLOCK) ON C.DEPT_ID=B.location_Code      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.NEW_PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE A.NEW_PRODUCT_CODE<>''        
GROUP BY L.LOC,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC   
  
  
UPDATE R SET PFI_QTY=ISNULL(PFI_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM SCF01106 A (NOLOCK)        
 JOIN SCM01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
 JOIN LOCATION C (NOLOCK) ON C.DEPT_ID=B.location_Code     
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED=0 AND A.PRODUCT_CODE<>''        
GROUP BY L.LOC,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
  
  
UPDATE R SET CIP_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(ABS(A.QUANTITY)) QTY  
FROM IRD01106 A (NOLOCK)        
JOIN IRM01106 B (NOLOCK) ON A.IRM_MEMO_ID = B.IRM_MEMO_ID        
JOIN LOCATION C (NOLOCK) ON C.DEPT_ID=B.location_Code      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
WHERE A.NEW_PRODUCT_CODE<>''     
GROUP BY L.LOC,ARS.PRODUCT_CODE  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC   
   
   
UPDATE R SET CIP_QTY=ISNULL(CIP_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(ABS(A.QUANTITY+ADJ_QUANTITY))QTY  
  FROM SCC01106 A (NOLOCK)        
 JOIN SCM01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
 JOIN LOCATION C (NOLOCK) ON C.DEPT_ID=B.location_Code      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED=0 AND A.PRODUCT_CODE<>''         
GROUP BY L.LOC,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC     
  
  
  
UPDATE R SET JWI_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM JOBWORK_ISSUE_DET A (NOLOCK)        
 JOIN JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID        
 JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE        
 JOIN SKU C (NOLOCK) ON C.PRODUCT_CODE=A.PRODUCT_CODE        
 JOIN LOCATION LOC (NOLOCK) ON LOC.MAJOR_DEPT_ID=B.location_Code      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON LOC.DEPT_ID=L.LOC  
 WHERE  B.CANCELLED=0 AND B.ISSUE_TYPE=1  AND ISNULL(B.WIP,0)=0     
 AND ISNULL(B.ISSUE_MODE,0)<>1      
GROUP BY L.LOC,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
   
  
UPDATE R SET JWR_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
 FROM JOBWORK_RECEIPT_DET A (NOLOCK)        
 JOIN JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID        
 JOIN SKU C (NOLOCK) ON C.PRODUCT_CODE=A.PRODUCT_CODE        
 JOIN JOBWORK_ISSUE_DET D (NOLOCK) ON D.ROW_ID=A.REF_ROW_ID        
 JOIN JOBWORK_ISSUE_MST E (NOLOCK) ON E.ISSUE_ID = D.ISSUE_ID        
 JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=B.location_Code      
 JOIN PRD_AGENCY_MST PAM(NOLOCK) ON PAM.AGENCY_CODE=B.AGENCY_CODE      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON LOC.MAJOR_DEPT_ID=L.LOC  
 WHERE  B.CANCELLED=0 AND E.ISSUE_TYPE=1  AND ISNULL(B.WIP,0)=0  AND ISNULL(B.RECEIVE_MODE,0)<>1     
GROUP BY L.LOC,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
  
  
UPDATE R SET BOC_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(E.CONS_QTY_PER_PICE*P.QUANTITY) QTY  
FROM WSL_ORDER_BOM E(NOLOCK)         
 LEFT OUTER JOIN WSL_ORDER_DET C (NOLOCK) ON E.REF_ROW_ID=C.ROW_ID 
 LEFT OUTER JOIN WSL_ORDER_MST D (NOLOCK) ON C.ORDER_ID=D.ORDER_ID        
 JOIN POD01106 P ON C.ROW_ID = P.WOD_ROW_ID         
 JOIN POM01106 PM ON P.PO_ID = PM.PO_ID          
 LEFT OUTER JOIN SKU ON E.PRODUCT_CODE=SKU.PRODUCT_CODE        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON E.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON PM.location_Code=L.LOC  
 WHERE  PM.CANCELLED = 0        
GROUP BY L.LOC,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET SCF_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC DEPT_ID,ARS.PRODUCT_CODE,SUM(CASE WHEN S1.BARCODE_CODING_SCHEME=3 THEN B2.TOTAL_QTY ELSE A.QUANTITY END) QTY  
FROM SNC_DET A (NOLOCK)        
 JOIN SNC_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
 JOIN      
 (      
 SELECT REFROW_ID AS [ROW_ID],PRODUCT_CODE,COUNT(*) AS [TOTAL_QTY]      
 FROM SNC_BARCODE_DET (NOLOCK)      
 GROUP BY REFROW_ID,PRODUCT_CODE      
 )B2 ON A.ROW_ID = B2.ROW_ID      
 JOIN ARTICLE A1 WITH(NOLOCK) ON A1.ARTICLE_CODE=A.ARTICLE_CODE     
 JOIN SKU S1(NOLOCK) ON S1.product_code=B2.PRODUCT_CODE     
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON B2.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.location_Code =L.LOC  
 WHERE  B.WIP=0 AND B.CANCELLED=0 AND B2.PRODUCT_CODE<>''        
GROUP BY L.LOC ,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.dept_id  
  
  
  
UPDATE R SET SCC_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC ,ARS.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM SNC_CONSUMABLE_DET A (NOLOCK)        
 JOIN SNC_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.location_Code =L.LOC  
 WHERE A.WIP=0 AND B.CANCELLED=0 AND A.PRODUCT_CODE<>''       
GROUP BY L.LOC ,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
   
  
UPDATE R SET TTM_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(ABS(A.QTY))QTY  
 FROM PRD_TRANSFER_MAIN_DET A (NOLOCK)        
 JOIN PRD_TRANSFER_MAIN_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.location_Code =L.LOC  
 WHERE B.CANCELLED=0 AND A.PRODUCT_CODE<>''    
GROUP BY L.LOC,ARS.PRODUCT_CODE        
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
UPDATE R SET TTM_QTY=ISNULL(TTM_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
 FROM PPC_TRANSFER_TO_TRADING_DET A (NOLOCK)        
 JOIN PPC_TRANSFER_TO_TRADING_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.LOCATION_CODE = L.LOC  
 WHERE B.CANCELLED=0 AND A.PRODUCT_CODE<>''    
GROUP BY L.LOC,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
   
UPDATE R SET TTM_QTY=ISNULL(TTM_QTY,0)+ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(ABS(A.QUANTITY))QTY  
FROM TRANSFER_TO_TRADING_DET A (NOLOCK)        
 JOIN TRANSFER_TO_TRADING_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.LOCTION_CODE=L.LOC  
 WHERE B.CANCELLED=0 AND A.PRODUCT_CODE<>''                
GROUP BY L.LOC,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
   
   
  
UPDATE R SET DNPI_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
 FROM DNPS_DET A (NOLOCK)        
 JOIN DNPS_MST B (NOLOCK) ON A.PS_ID = B.PS_ID        
 JOIN LOCATION C (NOLOCK) ON C.DEPT_ID=B.location_Code       
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
 WHERE B.CANCELLED = 0        
GROUP BY L.LOC,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
   
  
UPDATE R SET DNPR_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(A.QUANTITY) QTY  
 FROM RMD01106 A (NOLOCK)        
 JOIN RMM01106 B (NOLOCK) ON A.RM_ID = B.RM_ID     
 JOIN dnps_mst C ON A.ps_id =C.ps_id        
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.location_Code =L.LOC  
 WHERE B.CANCELLED = 0 AND ISNULL(A.PS_ID,'')<>''    
 AND ISNULL(B.xn_item_type,0) in (0,1)        
GROUP BY L.LOC,ARS.PRODUCT_CODE   
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
  
UPDATE R SET MIS_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(A.STOCK_QTY) QTY  
  FROM BOM_ISSUE_DET A (NOLOCK)      
  JOIN BOM_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID      
  JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.location_Code =L.LOC  
  WHERE B.CANCELLED=0         
GROUP BY L.LOC,ARS.PRODUCT_CODE    
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
    
  
UPDATE R SET MIR_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,ARS.PRODUCT_CODE,SUM(A.STOCK_QTY) QTY  
  FROM BOM_ISSUE_DET A (NOLOCK)      
  JOIN BOM_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID      
  JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON B.location_Code =L.LOC  
  WHERE B.CANCELLED=0         
GROUP BY L.LOC,ARS.PRODUCT_CODE    
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
  
  
  
  
  
UPDATE R SET SLS_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,B.CM_DT,SUM(ABS(A.QUANTITY)) QTY  
FROM CMD01106 A WITH(NOLOCK)        
JOIN CMM01106 B WITH(NOLOCK) ON A.CM_ID = B.CM_ID        
JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND ISNULL(B.xn_item_type,0) in (0,1)  AND A.QUANTITY >= 0       
AND CONVERT(DATE,B.CM_DT)=CONVERT(DATE,GETDATE())  
GROUP BY L.LOC,A.PRODUCT_CODE,B.CM_DT  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
INSERT ##RF_STOCK(DEPT_ID,PRODUCT_CODE,XN_DT,SLS_QTY)  
SELECT L.LOC,A.PRODUCT_CODE,B.CM_DT,SUM(ABS(A.QUANTITY)) QTY  
FROM CMD01106 A WITH(NOLOCK)        
JOIN CMM01106 B WITH(NOLOCK) ON A.CM_ID = B.CM_ID        
JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code       
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND ISNULL(B.xn_item_type,0) in (0,1)  AND A.QUANTITY >= 0 AND CONVERT(DATE,B.CM_DT)<CONVERT(DATE,GETDATE())  
GROUP BY L.LOC,A.PRODUCT_CODE,B.CM_DT  
  
UPDATE R SET SLR_QTY=ISNULL(T.QTY,0)  
FROM ##RF_STOCK R  
JOIN(  
SELECT L.LOC,A.PRODUCT_CODE,B.CM_DT,SUM(ABS(A.QUANTITY))QTY  
FROM CMD01106 A WITH(NOLOCK)        
JOIN CMM01106 B WITH(NOLOCK) ON A.CM_ID = B.CM_ID        
JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code       
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND ISNULL(B.xn_item_type,0) in (0,1)AND A.QUANTITY < 0            
AND CONVERT(DATE,B.CM_DT)=CONVERT(DATE,GETDATE())  
GROUP BY L.LOC,A.PRODUCT_CODE,B.CM_DT  
)T ON R.PRODUCT_CODE=T.product_code AND R.DEPT_ID=T.LOC  
  
  
INSERT ##RF_STOCK(DEPT_ID,PRODUCT_CODE,XN_DT,SLR_QTY)  
SELECT L.LOC,A.PRODUCT_CODE,B.CM_DT,SUM(ABS(A.QUANTITY)) QTY  
FROM CMD01106 A WITH(NOLOCK)        
JOIN CMM01106 B WITH(NOLOCK) ON A.CM_ID = B.CM_ID        
JOIN LOCATION C WITH(NOLOCK) ON C.DEPT_ID=B.location_Code      
JOIN #ARS_PRODUCTS ARS (NOLOCK) ON A.PRODUCT_CODE=ARS.PRODUCT_CODE  
JOIN #LOC L ON C.MAJOR_DEPT_ID=L.LOC  
WHERE B.CANCELLED = 0 AND ISNULL(B.xn_item_type,0) in (0,1)  AND A.QUANTITY < 0 AND CONVERT(DATE,B.CM_DT)<CONVERT(DATE,GETDATE())  
GROUP BY L.LOC,A.PRODUCT_CODE,B.CM_DT  

DELETE FROM ##RF_STOCK
WHERE OPS_QTY+PRD_QTY+SLR_QTY+SLS_QTY+MIR_QTY+MIS_QTY+DNPR_QTY+DNPI_QTY+TTM_QTY+SCC_QTY+SCF_QTY+BOC_QTY+JWR_QTY+JWI_QTY+CIP_QTY+PFI_QTY+WSR_QTY+WPI_QTY+API_QTY+WPR_QTY+WSL_QTY+APO_QTY+UNC_QTY+CNC_QTY+SAUM_QTY+SACM_QTY+SAU_QTY+SAC_QTY+APR_QTY+APP_QTY+PRT_QTY+CHO_QTY+TRO_QTY+TRI_QTY+GRNPSOUT_QTY+GRNPSIN_QTY+CHI_QTY+PUR_QTY+DCI_QTY+DCO_QTY+GIT_QTY=0
  
--IF OBJECT_ID('RF_OPT_ARS') IS NOT NULL DROP TABLE RF_OPT_ARS  
--SELECT * INTO RF_OPT_ARS FROM ##RF_STOCK  
SET NOCOUNT OFF  
END 
