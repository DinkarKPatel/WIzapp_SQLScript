create PROCEDURE SP_BUYERS_ORDER_REPORT
@CMEMO_ID VARCHAR(100),
@CTEMPTABLE VARCHAR(100)=''
AS
IF OBJECT_ID('TEMPBD.#TMPBUYERORDERPRINT','U') IS NOT NULL
   DROP TABLE  TEMPBD.#TMPBUYERORDERPRINT
   
SELECT T1.CANCELLED, T1.ORDER_DT,T1.ORDER_NO,T1.TAX_AMOUNT,T1.TAX_PERCENTAGE,T2.AC_NAME,T1.TOTAL_AMOUNT, 
T1.FREIGHT AS FREIGHT,T1.OTHER_CHARGES AS OTHER_CHARGES,T1.DISCOUNT_AMOUNT AS MST_DISCOUNT_AMOUNT,      
T1.SUBTOTAL AS AMOUNT_WO_TAX,PARA1.PARA1_NAME,PARA2.PARA2_NAME,PARA2.PARA2_ORDER,PARA3.PARA3_NAME,  
T3.ORDER_ID,T3.PARA1_CODE,T3.PARA2_CODE,T3.PARA3_CODE,T3.PARA4_CODE,T3.PARA5_CODE,T3.PARA6_CODE
,T3.QUANTITY,T3.ROW_ID,T3.LAST_UPDATE,T3.TS,T3.WS_PRICE,T3.RFNET,T3.ARTICLE_CODE,T3.GROSS_WSP
,T3.DISCOUNT_PERCENTAGE,T3.DISCOUNT_AMOUNT,T3.REMARKS,T3.PRODUCT_CODE,T3.MANUAL_DISCOUNT,T3.ORDER_TYPE
,T3.SERIAL_NO,T3.REF_PRODUCT_CODE,T3.CANCELLED_USER_CODE,T3.CANCELLED_REMARKS,T3.CANCELLED_DATE,T3.PRINT_LABEL
,T3.MST_OTHER_CHARGES,T3.ORD_MST_DISCOUNT_AMOUNT
,T1.PAYMENT_DETAILS,SECTIOND.SUB_SECTION_NAME,SECTIONM.SECTION_NAME,ARTICLE.ARTICLE_NO,  
T3.QUANTITY AS QTY  ,COM.COMPANY_CODE  
,T1.TRAIL_DT,T1.DELIVERY_DT ,T1.REMARKS AS MST_REMARKS,
T2.ADDRESS0,T2.ADDRESS1,T2.ADDRESS2,T2.AREA_NAME,T2.CITY,T2.STATE,T2.PINCODE,
CUST.USER_CUSTOMER_CODE,CUST.CUSTOMER_FNAME,CUST.CUSTOMER_LNAME,
CUST.MOBILE  AS CUST_MOBILE,CUST.EMAIL
,CUST.ADDRESS1 AS CUST_ADDRESS1
,CUST.ADDRESS2 AS CIST_ADDRESS2 
,ar.area_name AS CUST_AREA 
,CUST.PIN AS CUST_PIN
,ct.CITY AS CUST_CITY
,st.STATE AS CUST_STATE
,e.REGION_NAME AS CUST_REGION_NAME ,	
ARTICLE.DT_CREATED AS ART_DT_CREATED, EMP.EMP_NAME,T1.REF_NO,ADV.AMOUNT,D.ATTRIBUTE_NAME ,D.MEASURMENT ,D.PREV_MEASURE,
CASH_AMOUNT=ISNULL(ADV.CASH_AMOUNT,0),
CC_AMOUNT=ISNULL(ADV.CC_AMOUNT,0),
CN_AMOUNT=ISNULL(ADV.CN_AMOUNT,0),
ADVANCE_AMOUNT_ADJUSTED=ISNULL(ADV.ADVANCE_AMOUNT_ADJUSTED,0),
OTHER_DOC_AMOUNT=ISNULL(ADV.OTHER_DOC_AMOUNT,0),
CREDIT_AMOUNT=ISNULL(ADV.CREDIT_AMOUNT,0),
BANK_CHARGES=ISNULL(ADV.BANK_CHARGES,0),
MISC_AMOUNT=ISNULL(ADV.MISC_AMOUNT,0),
SKU_DT_CREATED=ISNULL(SKU.DT_CREATED,''),
(CASE WHEN CUST.CUSTOMER_TITLE <> '' THEN CUST.CUSTOMER_TITLE ELSE ISNULL(TP.PREFIX_NAME,'') END ) AS CUSTOMER_TITLE
INTO #TMPBUYERORDERPRINT
FROM WSL_ORDER_MST T1      
JOIN LMV01106 T2 ON T1.AC_CODE = T2.AC_CODE   
JOIN custdym CUST (nolock) ON T1.CUSTOMER_CODE = CUST.CUSTOMER_CODE 
JOIN AREA ar (nolock) ON Ar.AREA_CODE = cust.AREA_CODE   
JOIN CITY Ct (nolock) ON ar.CITY_CODE = Ct.CITY_CODE   
JOIN STATE st (nolock) ON st.STATE_CODE = ct.STATE_CODE  
JOIN REGIONM E (nolock) ON st.REGION_CODE = E.REGION_CODE
LEFT OUTER JOIN PREFIX TP ON CUST.PREFIX_CODE= TP.PREFIX_CODE    
JOIN WSL_ORDER_DET T3 ON T3.ORDER_ID = T1.ORDER_ID      
JOIN ARTICLE ON ARTICLE.ARTICLE_CODE = T3.ARTICLE_CODE      
JOIN SECTIOND ON SECTIOND.SUB_SECTION_CODE= ARTICLE.SUB_SECTION_CODE      
JOIN SECTIONM ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE      
JOIN PARA1 ON PARA1.PARA1_CODE = T3.PARA1_CODE      
JOIN PARA2 ON PARA2.PARA2_CODE = T3.PARA2_CODE      
JOIN PARA3 ON PARA3.PARA3_CODE = T3.PARA3_CODE   
LEFT JOIN SKU ON SKU.PRODUCT_CODE=T3.PRODUCT_CODE
LEFT OUTER JOIN COMPANY COM ON 1=1 AND COM.COMPANY_CODE='01'   
LEFT OUTER JOIN 
(
 SELECT B.ORDER_ID,SUM(C.AMOUNT) AS AMOUNT,
  ISNULL(SUM(CASH_AMOUNT),0) AS CASH_AMOUNT,
  ISNULL(SUM(CC_AMOUNT),0) AS CC_AMOUNT,
  ISNULL(SUM(CN_AMOUNT),0) AS CN_AMOUNT,
  ISNULL(SUM(ADVANCE_AMOUNT_ADJUSTED),0) AS ADVANCE_AMOUNT_ADJUSTED,
  ISNULL(SUM(OTHER_DOC_AMOUNT),0) AS OTHER_DOC_AMOUNT, 
  ISNULL(SUM(CREDIT_AMOUNT),0) AS CREDIT_AMOUNT, 
  ISNULL(SUM(BANK_CHARGES),0) AS BANK_CHARGES,  
  ISNULL(SUM(MISC_AMOUNT),0) AS MISC_AMOUNT 
 FROM  WSL_ORDER_ADV_RECEIPT B 
 LEFT OUTER JOIN ARC01106 C ON B.ADV_REC_ID = C.ADV_REC_ID
 LEFT OUTER JOIN VW_BILL_PAYMODE VW ON B.ADV_REC_ID=VW.MEMO_ID
 WHERE XN_TYPE='ARC'
 GROUP BY B.ORDER_ID
)  ADV ON T1.ORDER_ID = ADV.ORDER_ID 

LEFT OUTER JOIN  
(
	 SELECT B.TMD_ROW_ID,C.ATTRIBUTE_CODE,C.ATTRIBUTE_NAME ,B.MEASURMENT ,B.PREV_MEASURE  
	 FROM ATTRM (NOLOCK) C   
	 JOIN TDD01106 (NOLOCK) B ON   C.ATTRIBUTE_CODE = B.ATTRIBUTE_CODE  
	 JOIN WSL_ORDER_DET (NOLOCK) A ON B.TMD_ROW_ID = A.ROW_ID  
	 WHERE C.ATTRIBUTE_TYPE = 5 AND C.INACTIVE = 0 
	
 ) D   
 ON T3.ROW_ID = D.TMD_ROW_ID 


LEFT OUTER JOIN EMPLOYEE EMP ON T1.SALE_EMP_CODE = EMP.EMP_CODE      
WHERE   ISNULL(T3.CANCELLED,0)=0  AND T1.ORDER_ID =@CMEMO_ID   
ORDER BY T3.SERIAL_NO 



   IF CURSOR_STATUS('GLOBAL','CUR_MEASUREMENT') IN (0,1)  
		    BEGIN  
			CLOSE CUR_MEASUREMENT  
		    DEALLOCATE CUR_MEASUREMENT  
		    END
        
		DECLARE @COLUMN_NAME VARCHAR(100),@COLUMN_ALIAS VARCHAR(100)
		DECLARE @CCMD NVARCHAR(MAX)



			 DECLARE CUR_MEASUREMENT CURSOR FOR 
			  SELECT MM.M_NAME,MM.M_ALIAS
					FROM MEASUREMENT_MST (NOLOCK) MM 
			  GROUP BY MM.M_NAME,MM.M_ALIAS
			OPEN CUR_MEASUREMENT

			FETCH NEXT FROM CUR_MEASUREMENT INTO  @COLUMN_NAME,@COLUMN_ALIAS
			WHILE @@FETCH_STATUS =0
			BEGIN
		    
		   SET @CCMD=N'ALTER TABLE #TMPBUYERORDERPRINT ADD ['+@COLUMN_NAME+'] VARCHAR(100)'
		   PRINT @CCMD
		   EXEC SP_EXECUTESQL @CCMD
		   
		   IF @COLUMN_NAME=@COLUMN_ALIAS
		   SET @COLUMN_ALIAS=@COLUMN_ALIAS+'_1'
		   
		  IF  ISNULL(@COLUMN_ALIAS,'')<>''
		   BEGIN
		     SET @CCMD=N'ALTER TABLE #TMPBUYERORDERPRINT ADD ['+@COLUMN_ALIAS+'] VARCHAR(100)'
		     PRINT @CCMD
		     EXEC SP_EXECUTESQL @CCMD
		   END
		    
		        SET @CCMD=N'UPDATE #TMPBUYERORDERPRINT SET ['+@COLUMN_NAME+']=TDD.MEASURMENT   
				FROM #TMPBUYERORDERPRINT T
				LEFT JOIN 
				(SELECT TMD_ROW_ID,MEASURMENT,ATTRIBUTE_CODE FROM TDD01106 ) TDD ON TDD.TMD_ROW_ID =T.ROW_ID 
				JOIN ARTICLE_MEASUREMENTS AM (NOLOCK) ON AM.ARTICLE_CODE =T.ARTICLE_CODE AND AM.M_CODE=TDD.ATTRIBUTE_CODE 
				JOIN MEASUREMENT_MST (NOLOCK) MM ON MM.M_CODE =AM.M_CODE  WHERE  M_NAME='''+@COLUMN_NAME+''''
		    
			PRINT @CCMD
		    EXEC SP_EXECUTESQL @CCMD
			 IF  ISNULL(@COLUMN_ALIAS,'')<>''
		     BEGIN
			     SET @CCMD=N'UPDATE #TMPBUYERORDERPRINT SET ['+@COLUMN_ALIAS+']=TDD.MEASURMENT   
				FROM #TMPBUYERORDERPRINT T
				LEFT JOIN 
				(SELECT TMD_ROW_ID,MEASURMENT,ATTRIBUTE_CODE FROM TDD01106 ) TDD ON TDD.TMD_ROW_ID =T.ROW_ID 
				JOIN ARTICLE_MEASUREMENTS AM (NOLOCK) ON AM.ARTICLE_CODE =T.ARTICLE_CODE AND AM.M_CODE=TDD.ATTRIBUTE_CODE 
				JOIN MEASUREMENT_MST (NOLOCK) MM ON MM.M_CODE =AM.M_CODE  WHERE  M_ALIAS='''+@COLUMN_ALIAS+''''
				PRINT @CCMD
		        EXEC SP_EXECUTESQL @CCMD
		     END 	
			FETCH NEXT FROM CUR_MEASUREMENT INTO  @COLUMN_NAME,@COLUMN_ALIAS
			END
			CLOSE CUR_MEASUREMENT
			DEALLOCATE CUR_MEASUREMENT
			
			IF ISNULL(@CTEMPTABLE,'')=''
			SELECT * FROM #TMPBUYERORDERPRINT
			ELSE
			SET @CCMD=N'IF OBJECT_ID('''+@CTEMPTABLE+''',''U'') IS NOT NULL  
						DROP TABLE '+@CTEMPTABLE+'
						SELECT * INTO '+@CTEMPTABLE+' FROM  #TMPBUYERORDERPRINT'
				PRINT @CCMD
				EXEC SP_EXECUTESQL @CCMD
