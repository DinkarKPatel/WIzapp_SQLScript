CREATE PROCEDURE SP_PRD_WORKORDER_PENDING_PCS
(
	@DFROMDT DATE,
	@DTODT  DATE,
	@NPENDING INT=0
)
AS
BEGIN

      IF OBJECT_ID('TEMPDB..#TMPORDER_PENDING','U') IS NOT NULL
     DROP TABLE #TMPORDER_PENDING
     
  SELECT  MST.MEMO_ID AS ORDER_ID
			,MST.MEMO_NO AS ORDER_NO
			,MST.MEMO_DT  AS ORDER_DT
			,MST.ARTICLE_SET_CODE
			,AR1.ARTICLE_NAME AS FG_ARTICLE_NAME
			,AR1.ARTICLE_NO AS FG_ARTICLE_NO
			,AR1.ARTICLE_CODE AS FG_ARTICLE_CODE
			,PARA1.PARA1_CODE
			,PARA1.PARA1_NAME
			,PARA2.PARA2_CODE
			,PARA2.PARA2_NAME
		    ,DET1.QUANTITY AS WO_QTY
			,DET.QUANTITY AS REQUIRED_QTY	 
	INTO #TMPORDER_PENDING  
	FROM PRD_WO_ART_BOM A (NOLOCK)      
	JOIN PRD_WO_DET B (NOLOCK) ON A.REF_ROW_ID = B.ROW_ID
	JOIN PRD_WO_MST MST (NOLOCK) ON B.MEMO_ID=MST.MEMO_ID
	JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE =B.ARTICLE_CODE
	JOIN ARTICLE AR1 (NOLOCK) ON AR1.ARTICLE_CODE =MST.ARTICLE_SET_CODE     
	JOIN PARA1 P1 (NOLOCK) ON A.PARA1_CODE=P1.PARA1_CODE
	JOIN PARA2 P2 (NOLOCK) ON A.PARA2_CODE=P2.PARA2_CODE
	JOIN
	(
	 SELECT PARA1_CODE,PARA2_CODE,REF_ROW_ID,SUM(QUANTITY) AS QUANTITY 
	 FROM PRD_WO_SUB_DET C
	 GROUP BY REF_ROW_ID,PARA1_CODE,PARA2_CODE
	) DET ON B.ROW_ID=DET.REF_ROW_ID
	JOIN ARTICLE C (NOLOCK) ON A.BOM_ARTICLE_CODE = C.ARTICLE_CODE 
	JOIN
	(
	 SELECT  REF_ROW_ID,SUM(QUANTITY) AS QUANTITY 
	 FROM PRD_WO_SUB_DET C
	 GROUP BY REF_ROW_ID
	) DET1 ON B.ROW_ID=DET1.REF_ROW_ID
	JOIN PARA1  (NOLOCK) ON DET.PARA1_CODE=PARA1.PARA1_CODE
	JOIN PARA2  (NOLOCK) ON DET.PARA2_CODE=PARA2.PARA2_CODE
	WHERE MST.MEMO_DT BETWEEN @DFROMDT AND @DTODT AND
	 MST.CANCELLED=0
	AND MARK_AS_COMPLETED=1
	--AND MST.MEMO_ID='HO0111700000HO00000559'
	GROUP BY MST.MEMO_ID 
			,MST.MEMO_NO 
			,MST.MEMO_DT  
			,MST.ARTICLE_SET_CODE
			,AR1.ARTICLE_NAME 
			,AR1.ARTICLE_NO 
			,AR1.ARTICLE_CODE 
			,PARA1.PARA1_CODE
			,PARA1.PARA1_NAME
			,PARA2.PARA2_CODE
			,PARA2.PARA2_NAME
		    ,DET1.QUANTITY 
			,DET.QUANTITY
			
			SELECT A.*,ISNULL(B.CUTTING_QTY,0) AS CUTTING_QTY,
			ISNULL(A.REQUIRED_QTY,0)-ISNULL(B.CUTTING_QTY,0) AS PENDING_QTY
			FROM #TMPORDER_PENDING A
			LEFT OUTER JOIN
			(
			  SELECT C.REF_WO_ID ,A.PARA1_CODE,A.PARA2_CODE ,SUM(ISSUE_QTY) AS CUTTING_QTY
			  FROM 
			  PRD_STK_TRANSFER_MATERIAL_DET A
			  JOIN PRD_STK_TRANSFER_MST B ON A.MEMO_ID =B.MEMO_ID
			  JOIN
			  (
			   SELECT REF_WO_ID ,MEMO_ID 
			   FROM PRD_STK_TRANSFER_DET  A
			   GROUP BY REF_WO_ID ,MEMO_ID 
			  ) C ON B.MEMO_ID=C.MEMO_ID
			  WHERE B.CANCELLED=0
			  GROUP BY C.REF_WO_ID ,A.PARA1_CODE,A.PARA2_CODE 
			) B ON A.ORDER_ID =B.REF_WO_ID 
			AND A.PARA1_CODE=B.PARA1_CODE 
			AND A.PARA2_CODE=B.PARA2_CODE
       WHERE (@NPENDING=0 OR ISNULL(A.REQUIRED_QTY,0)-ISNULL(B.CUTTING_QTY,0)>0)
       
 
	
END

---END OF PROCEDURE - SP_PRD_WORKORDER_PENDING_PCS
