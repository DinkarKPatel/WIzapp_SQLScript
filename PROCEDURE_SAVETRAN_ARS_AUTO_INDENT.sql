create PROCEDURE SAVETRAN_ARS_AUTO_INDENT
(
	@nMode	int=1,
	@cIndentID varchar(40)='',
	@CFINYEAR VARCHAR(10),
	@SP_ID INT
)  
AS  
BEGIN  
SET NOCOUNT ON  

DECLARE @CCMD NVARCHAR(MAX),@TABLE_NAME VARCHAR(100),@SNO VARCHAR(4),@ERROR VARCHAR(MAX)='',@STEP FLOAT  
,@PRINT_ON BIT=1,@CODE_LEN INT=15,@MAX VARCHAR(15),@CNEWKEYVAL VARCHAR(100),@ID VARCHAR(100)

UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET SECTION_CODE=REPLICATE('0',7) WHERE ISNULL(SECTION_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET SUB_SECTION_CODE=REPLICATE('0',7) WHERE ISNULL(SUB_SECTION_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ARTICLE_CODE=REPLICATE('0',8) WHERE ISNULL(ARTICLE_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET PARA1_CODE=REPLICATE('0',7) WHERE ISNULL(PARA1_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET PARA2_CODE=REPLICATE('0',7) WHERE ISNULL(PARA2_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET PARA3_CODE=REPLICATE('0',7) WHERE ISNULL(PARA3_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET PARA4_CODE=REPLICATE('0',7) WHERE ISNULL(PARA4_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET PARA5_CODE=REPLICATE('0',7) WHERE ISNULL(PARA5_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET PARA6_CODE=REPLICATE('0',7) WHERE ISNULL(PARA6_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR1_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR1_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR2_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR2_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR3_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR3_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR4_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR4_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR5_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR5_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR6_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR6_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR7_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR7_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR8_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR8_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR9_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR9_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR10_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR10_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR11_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR11_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR12_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR12_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR13_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR13_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR14_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR14_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR15_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR15_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR16_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR16_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR17_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR17_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR18_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR18_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR19_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR19_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR20_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR20_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR21_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR21_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR22_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR22_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR23_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR23_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR24_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR24_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET ATTR25_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR25_KEY_CODE,'')='' AND SP_ID=@SP_ID
UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD WITH (ROWLOCK) SET USER_CODE=REPLICATE('0',7) WHERE ISNULL(USER_CODE,'')='' AND SP_ID=@SP_ID


BEGIN TRY  
BEGIN TRANSACTION  
SET @STEP=1  
IF @NMODE=1
   UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD SET INDENT_ID='LATER',INDENT_DT=CONVERT(DATE,GETDATE()) WHERE ISNULL(INDENT_ID,'')=''
   
SET @STEP=2
DECLARE LOC CURSOR FOR SELECT DISTINCT DEPT_ID FROM ARS_ARS_PLAN_DETAIL_UPLOAD (NOLOCK) WHERE SP_ID=@SP_ID AND @NMODE=1 AND INDENT_ID='LATER'
OPEN LOC
FETCH NEXT FROM LOC INTO @SNO
WHILE @@FETCH_STATUS=0
  BEGIN
	  EXEC GETNEXTKEY 'ARS_INDENT_MST','INDENT_NO',7,@SNO,1,'',1,@CNEWKEYVAL OUTPUT
      IF ISNULL(@CNEWKEYVAL,'')='' 
         BEGIN
            SET @ERROR='Unable to generate Indent_ID'
            GOTO END_PROC
         END
      ELSE
         UPDATE ARS_ARS_PLAN_DETAIL_UPLOAD SET INDENT_ID=@SNO+@CFINYEAR+@CNEWKEYVAL WHERE SP_ID=@SP_ID AND DEPT_ID=@SNO
      FETCH NEXT FROM LOC INTO @SNO
  END
CLOSE LOC
DEALLOCATE LOC
SET @SNO=''

SET @STEP=3
MERGE ARS_INDENT_MST D
USING(SELECT DISTINCT A.INDENT_ID,A.INDENT_DT,L.DEPT_ID,L.DEPT_AC_CODE AC_CODE,0 CANCELLED,A.ARS_ID REF_ARS_ID,''ROW_ID,SUBSTRING(A.INDENT_ID,8,100) INDENT_NO,A.USER_CODE FROM ARS_ARS_PLAN_DETAIL_UPLOAD A (NOLOCK) JOIN LOCATION L ON L.DEPT_ID=A.DEPT_ID WHERE SP_ID=@SP_ID)S ON D.INDENT_ID=S.INDENT_ID
WHEN MATCHED THEN UPDATE SET D.DEPT_ID=S.DEPT_ID,D.AC_CODE=S.AC_CODE,D.REF_ARS_ID=ISNULL(S.REF_ARS_ID,''),D.LAST_UPDATE=GETDATE(),D.CANCELLED=ISNULL(S.CANCELLED,0)
WHEN NOT MATCHED THEN INSERT (INDENT_ID,INDENT_DT,DEPT_ID,AC_CODE,CANCELLED,REF_ARS_ID,LAST_UPDATE,INDENT_NO,FIN_YEAR,USER_CODE) VALUES(S.INDENT_ID,S.INDENT_DT,S.DEPT_ID,S.AC_CODE,0,S.REF_ARS_ID,GETDATE(),S.INDENT_NO,@CFINYEAR,S.USER_CODE);

SET @STEP=4
MERGE ARS_INDENT_DET D
USING (SELECT A.INDENT_ID, SECTION_CODE, SUB_SECTION_CODE, ARTICLE_CODE, PARA1_CODE, PARA2_CODE, PARA3_CODE, PARA4_CODE, PARA5_CODE, PARA6_CODE, ATTR1_KEY_CODE, ATTR2_KEY_CODE, ATTR3_KEY_CODE, ATTR4_KEY_CODE, ATTR5_KEY_CODE, ATTR6_KEY_CODE, ATTR7_KEY_CODE, ATTR8_KEY_CODE, ATTR9_KEY_CODE, ATTR10_KEY_CODE, ATTR11_KEY_CODE, ATTR12_KEY_CODE, ATTR13_KEY_CODE, ATTR14_KEY_CODE, ATTR15_KEY_CODE, ATTR16_KEY_CODE, ATTR17_KEY_CODE, ATTR18_KEY_CODE, ATTR19_KEY_CODE, ATTR20_KEY_CODE, ATTR21_KEY_CODE, ATTR22_KEY_CODE, ATTR23_KEY_CODE, ATTR24_KEY_CODE, ATTR25_KEY_CODE, ''PRODUCT_CODE, REORDER_QTY, ''ROW_ID FROM ARS_ARS_PLAN_DETAIL_UPLOAD A (NOLOCK) WHERE SP_ID=@SP_ID)S ON D.INDENT_ID=S.INDENT_ID
WHEN MATCHED THEN UPDATE SET D.SECTION_CODE=S.SECTION_CODE,D.SUB_SECTION_CODE=S.SUB_SECTION_CODE
,D.ARTICLE_CODE=S.ARTICLE_CODE, D.PARA1_CODE=S.PARA1_CODE, D.PARA2_CODE=S.PARA2_CODE, D.PARA3_CODE=S.PARA3_CODE, D.PARA4_CODE=S.PARA4_CODE, D.PARA5_CODE=S.PARA5_CODE, D.PARA6_CODE=S.PARA6_CODE
,D.ATTR1_KEY_CODE=S.ATTR1_KEY_CODE,		D.ATTR2_KEY_CODE=S.ATTR2_KEY_CODE, D.ATTR3_KEY_CODE=S.ATTR3_KEY_CODE, D.ATTR4_KEY_CODE=S.ATTR4_KEY_CODE, D.ATTR5_KEY_CODE=S.ATTR5_KEY_CODE
,D.ATTR6_KEY_CODE=S.ATTR6_KEY_CODE,		D.ATTR7_KEY_CODE=S.ATTR7_KEY_CODE, D.ATTR8_KEY_CODE=S.ATTR8_KEY_CODE, D.ATTR9_KEY_CODE=S.ATTR9_KEY_CODE, D.ATTR10_KEY_CODE=S.ATTR10_KEY_CODE
,D.ATTR11_KEY_CODE=S.ATTR11_KEY_CODE,	D.ATTR12_KEY_CODE=S.ATTR12_KEY_CODE, D.ATTR13_KEY_CODE=S.ATTR13_KEY_CODE, D.ATTR14_KEY_CODE=S.ATTR14_KEY_CODE, D.ATTR15_KEY_CODE=S.ATTR15_KEY_CODE
,D.ATTR16_KEY_CODE=S.ATTR16_KEY_CODE,	D.ATTR17_KEY_CODE=S.ATTR17_KEY_CODE, D.ATTR18_KEY_CODE=S.ATTR18_KEY_CODE, D.ATTR19_KEY_CODE=S.ATTR19_KEY_CODE, D.ATTR20_KEY_CODE=S.ATTR20_KEY_CODE
,D.ATTR21_KEY_CODE=S.ATTR21_KEY_CODE,	D.ATTR22_KEY_CODE=S.ATTR22_KEY_CODE, D.ATTR23_KEY_CODE=S.ATTR23_KEY_CODE, D.ATTR24_KEY_CODE=S.ATTR24_KEY_CODE, D.ATTR25_KEY_CODE=S.ATTR25_KEY_CODE
,D.REORDER_QTY=S.REORDER_QTY
WHEN NOT MATCHED THEN INSERT (INDENT_ID, SECTION_CODE, SUB_SECTION_CODE, ARTICLE_CODE, PARA1_CODE, PARA2_CODE, PARA3_CODE, PARA4_CODE, PARA5_CODE, PARA6_CODE, ATTR1_KEY_CODE, ATTR2_KEY_CODE, ATTR3_KEY_CODE, ATTR4_KEY_CODE, ATTR5_KEY_CODE, ATTR6_KEY_CODE, ATTR7_KEY_CODE, ATTR8_KEY_CODE, ATTR9_KEY_CODE, ATTR10_KEY_CODE, ATTR11_KEY_CODE, ATTR12_KEY_CODE, ATTR13_KEY_CODE, ATTR14_KEY_CODE, ATTR15_KEY_CODE, ATTR16_KEY_CODE, ATTR17_KEY_CODE, ATTR18_KEY_CODE, ATTR19_KEY_CODE, ATTR20_KEY_CODE, ATTR21_KEY_CODE, ATTR22_KEY_CODE, ATTR23_KEY_CODE, ATTR24_KEY_CODE, ATTR25_KEY_CODE, PRODUCT_CODE, REORDER_QTY, ROW_ID) VALUES(S.INDENT_ID, S.SECTION_CODE, S.SUB_SECTION_CODE, S.ARTICLE_CODE, S.PARA1_CODE, S.PARA2_CODE, S.PARA3_CODE, S.PARA4_CODE, S.PARA5_CODE, S.PARA6_CODE, S.ATTR1_KEY_CODE, S.ATTR2_KEY_CODE, S.ATTR3_KEY_CODE, S.ATTR4_KEY_CODE, S.ATTR5_KEY_CODE, S.ATTR6_KEY_CODE, S.ATTR7_KEY_CODE, S.ATTR8_KEY_CODE, S.ATTR9_KEY_CODE, S.ATTR10_KEY_CODE, S.ATTR11_KEY_CODE, S.ATTR12_KEY_CODE, S.ATTR13_KEY_CODE, S.ATTR14_KEY_CODE, S.ATTR15_KEY_CODE, S.ATTR16_KEY_CODE, S.ATTR17_KEY_CODE, S.ATTR18_KEY_CODE, S.ATTR19_KEY_CODE, S.ATTR20_KEY_CODE, S.ATTR21_KEY_CODE, S.ATTR22_KEY_CODE, S.ATTR23_KEY_CODE, S.ATTR24_KEY_CODE, S.ATTR25_KEY_CODE, S.PRODUCT_CODE, S.REORDER_QTY, S.ROW_ID);

SET @STEP=5  
SELECT TOP 1 @ID=INDENT_ID FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SP_ID
DELETE FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SP_ID
IF @PRINT_ON=1 PRINT CAST(@STEP AS VARCHAR)+'--'+CHAR(13)+'DELETE FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID='+CAST(@SP_ID AS VARCHAR)
END TRY  
  
BEGIN CATCH  
  SET @ERROR='PROCEDURE SAVETRAN_ASR_AUTO_INDENT: STEP- ' + LTRIM(CAST(@STEP AS VARCHAR)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()  
END CATCH  
    
END_PROC:  
--PRINT @CCMD
IF @@TRANCOUNT>0 AND @ERROR=''  
   COMMIT  
ELSE  
   ROLLBACK  
SELECT @ERROR ERR_MSG,@ID MEMO_ID        
SET NOCOUNT OFF  
END--PROCEDURE
