CREATE PROCEDURE SP_PAY
(
 @CMEMOID VARCHAR(50),
 @CXNTYPE VARCHAR(50),
 @CTABLE VARCHAR(500),
 @BCASHIER BIT=0
)
--WITH ENCRYPTION

AS
BEGIN
	DECLARE @CCOL VARCHAR(40), 
			@CCMD NVARCHAR(MAX),
			@CRETCOLSTR NVARCHAR(MAX)
		
			
	SET @CRETCOLSTR = N''
	
	IF OBJECT_ID('TEMPDB..#CCMIDS','U') IS NOT NULL
		DROP TABLE #CCMIDS
		
		CREATE TABLE #CCMIDS(CM_ID VARCHAR(22))
		
		IF @BCASHIER=1
		INSERT #CCMIDS(CM_ID)
		SELECT CM_ID FROM DSD01106(NOLOCK) WHERE DS_ID=@CMEMOID
		ELSE 
		INSERT #CCMIDS(CM_ID)
		SELECT @CMEMOID

	DECLARE CUR_CT CURSOR FOR
		
	SELECT	DISTINCT B.PAYMODE_NAME 
	FROM PAYMODE_XN_DET A (NOLOCK)
	JOIN PAYMODE_MST	B (NOLOCK) ON A.PAYMODE_CODE = B.PAYMODE_CODE
	JOIN PAYMODE_GRP_MST C (NOLOCK) ON B.PAYMODE_GRP_CODE = C.PAYMODE_GRP_CODE
	JOIN #CCMIDS CMS ON CMS.CM_ID=A.MEMO_ID
	WHERE  A.XN_TYPE= @CXNTYPE
	ORDER BY B.PAYMODE_NAME

	OPEN CUR_CT

	FETCH NEXT FROM CUR_CT INTO @CCOL
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @CRETCOLSTR = @CRETCOLSTR + ( CASE WHEN @CRETCOLSTR<>'' THEN N', ' ELSE '' END ) + N'
						  SUM(CASE WHEN B.PAYMODE_NAME = ''' + @CCOL + ''' THEN A.AMOUNT ELSE 0 END) AS [' + @CCOL + '] '

		
		FETCH NEXT FROM CUR_CT INTO @CCOL
	END
	CLOSE CUR_CT
	DEALLOCATE CUR_CT

	SET @CRETCOLSTR = @CRETCOLSTR + ( CASE WHEN @CRETCOLSTR<>'' THEN N', ' ELSE '' END ) + N'
	
	SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000001'' THEN AMOUNT ELSE 0 END) AS CASH_AMOUNT,  
    
	  SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000002'' THEN AMOUNT ELSE 0 END) AS CC_AMOUNT,  
	  
	  SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000003'' AND  A.PAYMODE_CODE = ''0000001''  
		 THEN AMOUNT ELSE 0 END) AS CN_AMOUNT,  
	  
	  SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000003'' AND A.PAYMODE_CODE = ''0000002''  
		 THEN AMOUNT ELSE 0 END) AS ADVANCE_AMOUNT_ADJUSTED,  
	  
	  SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000003'' AND A.PAYMODE_CODE NOT IN ( ''0000001'', ''0000002'' )  
		 THEN AMOUNT ELSE 0 END) AS OTHER_DOC_AMOUNT,  
	  
	  SUM(CASE WHEN B.PAYMODE_GRP_CODE = ''0000004'' THEN AMOUNT ELSE 0 END) AS CREDIT_AMOUNT,  
	  
	  SUM(CASE WHEN B.PAYMODE_GRP_CODE NOT IN ( ''0000001'',''0000002'',''0000003'',''0000004'') AND A.PAYMODE_CODE = ''0000003''  
		 THEN AMOUNT ELSE 0 END) AS BANK_CHARGES,  
	  
	  SUM(CASE WHEN B.PAYMODE_GRP_CODE NOT IN ( ''0000001'',''0000002'',''0000003'',''0000004'')  AND A.PAYMODE_CODE <> ''0000003''  
		 THEN AMOUNT ELSE 0 END) AS MISC_AMOUNT '
     
	
	SET @CCMD =N'IF OBJECT_ID('''+@CTABLE+''', ''U'' ) IS NOT NULL
		         DROP TABLE '+@CTABLE
		         
	EXEC SP_EXECUTESQL @CCMD

	SET @CCMD = N' SELECT	A.MEMO_ID' + (CASE WHEN @CRETCOLSTR<>'' THEN ', ' ELSE '' END) + @CRETCOLSTR + 
				' INTO '+@CTABLE+ '	
				FROM PAYMODE_XN_DET A (NOLOCK)
				JOIN PAYMODE_MST	B (NOLOCK) ON A.PAYMODE_CODE = B.PAYMODE_CODE
				JOIN PAYMODE_GRP_MST C (NOLOCK) ON B.PAYMODE_GRP_CODE = C.PAYMODE_GRP_CODE
				JOIN #CCMIDS CMS ON CMS.CM_ID=A.MEMO_ID
				WHERE   A.XN_TYPE= '''+@CXNTYPE+''' GROUP BY A.MEMO_ID'
					
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD


END
