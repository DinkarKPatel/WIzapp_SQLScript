
DELETE FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CNM01106' AND FIELD_NAME='AC_CODE') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CNM01106','','AC_CODE','','UPDATE','AC CODE'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CNM01106' AND FIELD_NAME='DISCOUNT_PERCENTAGE') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CNM01106','','DISCOUNT_PERCENTAGE','','UPDATE','DISC %'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CNM01106' AND FIELD_NAME='DISCOUNT_AMOUNT') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CNM01106','','DISCOUNT_AMOUNT','','UPDATE','DISC AMT'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CNM01106' AND FIELD_NAME='FREIGHT') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CNM01106','','FREIGHT','','UPDATE','FREIGHT'

IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CNM01106' AND FIELD_NAME='OTHER_CHARGES') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CNM01106','','OTHER_CHARGES','','UPDATE','OTHER CHARGES'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CNM01106' AND FIELD_NAME='TOTAL_AMOUNT') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CNM01106','','TOTAL_AMOUNT','','UPDATE','NET AMOUNT'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CNM01106' AND FIELD_NAME='CANCELLED') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CNM01106','','CANCELLED','','UPDATE','CANCELLED'

IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CNM01106' AND FIELD_NAME='INSURANCE') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CNM01106','','INSURANCE','','UPDATE','INSURANCE AMT'   
--
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CND01106' AND FIELD_NAME='BILL_LEVEL_TAX_METHOD') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CND01106','','BILL_LEVEL_TAX_METHOD','','UPDATE','BILL LEVEL TAX METHOD'   
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CND01106' AND FIELD_NAME='PRODUCT_CODE') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CND01106','','PRODUCT_CODE','','UPDATE','BARCODE'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CND01106' AND FIELD_NAME='DISCOUNT_PERCENTAGE') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL)SELECT 'WSR','CND01106','','DISCOUNT_PERCENTAGE','','UPDATE','ITEM DISC %'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CND01106' AND FIELD_NAME='DISCOUNT_AMOUNT') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CND01106','','DISCOUNT_AMOUNT','','UPDATE','ITEM DISC AMT'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CND01106' AND FIELD_NAME='ITEM_TAX_PERCENTAGE') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CND01106','','ITEM_TAX_PERCENTAGE','','UPDATE','ITEM TAX %'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CND01106' AND FIELD_NAME='ITEM_TAX_AMOUNT') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CND01106','','ITEM_TAX_AMOUNT','','UPDATE','ITEM TAX AMT'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CND01106' AND FIELD_NAME='RATE') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CND01106','','RATE','','UPDATE','RATE'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CND01106' AND FIELD_NAME='QUANTITY') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CND01106','','QUANTITY','','UPDATE','QTY'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='WSR' AND TABLE_NAME='CND01106' AND FIELD_NAME='') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'WSR','CND01106','','','','DELETE',''

   
   
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=1 WHERE TABLE_NAME='CNM01106' AND FIELD_NAME='TOTAL_AMOUNT'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=2 WHERE TABLE_NAME='CNM01106' AND FIELD_NAME='AC_CODE'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=3 WHERE TABLE_NAME='CNM01106' AND FIELD_NAME LIKE 'DISC%'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=4 WHERE TABLE_NAME='CNM01106' AND FIELD_NAME='OTHER_CHARGES'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=4 WHERE TABLE_NAME='CNM01106' AND FIELD_NAME='INSURANCE'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=4 WHERE TABLE_NAME='CNM01106' AND FIELD_NAME='FREIGHT'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=6 WHERE TABLE_NAME='CNM01106' AND FIELD_NAME='CANCELLED'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=7 WHERE TABLE_NAME='CND01106' AND FIELD_NAME='BILL_LEVEL_TAX_METHOD'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=1 WHERE TABLE_NAME='CND01106' AND FIELD_NAME='PRODUCT_CODE'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=2 WHERE TABLE_NAME='CND01106' AND FIELD_NAME='RATE'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=3 WHERE TABLE_NAME='CND01106' AND FIELD_NAME='QUANTITY'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=4 WHERE TABLE_NAME='CND01106' AND FIELD_NAME LIKE 'DISC%'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=5 WHERE TABLE_NAME='CND01106' AND FIELD_NAME LIKE 'ITEM_TAX%'


UPDATE XN_AUDIT_TRIAL_MST SET TRIG=UPPER(TRIG)

UPDATE X SET X.DATA_TYPE=C.DATA_TYPE
FROM XN_AUDIT_TRIAL_MST X 
JOIN INFORMATION_SCHEMA.COLUMNS C ON C.TABLE_NAME=X.TABLE_NAME AND C.COLUMN_NAME=X.FIELD_NAME
WHERE TRIG='UPDATE'


IF OBJECT_ID('TEMPDB..#PKEY','U') IS NOT NULL
   DROP TABLE #PKEY
SELECT DISTINCT X.TABLE_NAME,COL.COLUMN_NAME,COL.ORDINAL_POSITION
INTO #PKEY
FROM XN_AUDIT_TRIAL_MST X (ROWLOCK) 
JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS PK
JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE COL ON PK.TABLE_NAME=COL.TABLE_NAME AND PK.CONSTRAINT_NAME=COL.CONSTRAINT_NAME AND PK.CONSTRAINT_TYPE='PRIMARY KEY'
ON X.TABLE_NAME=PK.TABLE_NAME
WHERE XN_TYPE ='WSR'
DECLARE @TAB VARCHAR(100),@KEY VARCHAR(1000)
IF CURSOR_STATUS('GLOBAL','PKEY') IN (0,1)
   BEGIN
     CLOSE PKEY
	 DEALLOCATE PKEY
   END
DECLARE PKEY CURSOR FOR SELECT DISTINCT TABLE_NAME FROM #PKEY
OPEN PKEY
FETCH NEXT FROM PKEY INTO @TAB
WHILE @@FETCH_STATUS=0
  BEGIN
    SET @KEY='' 
    SELECT @KEY=COALESCE('',@KEY)+COLUMN_NAME+'+' FROM #PKEY WHERE TABLE_NAME=@TAB ORDER BY ORDINAL_POSITION
    UPDATE XN_AUDIT_TRIAL_MST SET KEY_FIELDS=UPPER(@KEY) WHERE TABLE_NAME=@TAB
    FETCH NEXT FROM PKEY INTO @TAB
  END
CLOSE PKEY
DEALLOCATE PKEY


IF EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE TABLE_NAME='CNM01106' AND XN_TYPE='WSR' AND KEY_FIELDS='' AND TRIG='UPDATE')
   UPDATE XN_AUDIT_TRIAL_MST SET KEY_FIELDS='CN_ID+' WHERE TABLE_NAME='CNM01106' AND XN_TYPE='WSR' AND TRIG='UPDATE'
IF EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE TABLE_NAME='CND01106' AND XN_TYPE='WSR' AND KEY_FIELDS='' AND TRIG='UPDATE')
   UPDATE XN_AUDIT_TRIAL_MST SET KEY_FIELDS='CN_ID+PRODUCT_CODE+' WHERE TABLE_NAME='CND01106' AND XN_TYPE='WSR' AND TRIG='UPDATE'


   