CREATE PROCEDURE SP3S_SLR_RECON
	@NQUERYID			NUMERIC(5),
	@CWHERE				VARCHAR(MAX),
	@CFINYEAR			VARCHAR(5)='',  
	@NNAVMODE			NUMERIC(2)=1,  
	@CWIZAPPUSERCODE	VARCHAR(10)='',
	@CREFMEMONO			VARCHAR(MAX)=''
	
AS
BEGIN

IF @NQUERYID=1 
	GOTO NAV
ELSE IF @NQUERYID=2 
	GOTO MST
ELSE IF @NQUERYID=3 
	GOTO DET
ELSE IF @NQUERYID=4 
	GOTO GETDATA
ELSE IF @NQUERYID=5 
	GOTO GETREPORT

NAV:
	EXECUTE SP_NAVIGATE 'SLR_RECON_MST',@NNAVMODE,@CREFMEMONO,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERE,0  
	GOTO SSPL
MST:
	SELECT A.*,C.USERNAME,CAST(0 AS NUMERIC(14,2)) AS [QUANTITY]
	FROM SLR_RECON_MST A (NOLOCK)
	JOIN USERS C ON C.USER_CODE=A.USER_CODE
	WHERE A.MEMO_ID=@CWHERE
	GOTO SSPL	
DET:

	SELECT A.*,CAST(0 AS NUMERIC(14,2)) AS SRNO,  
	EMP.EMP_NAME, CMD.PRODUCT_CODE, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, C.PARA1_CODE,    
	C.PARA1_NAME, D.PARA2_CODE, D.PARA2_NAME, F.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,       
	CMD.DEPT_ID, B.CODING_SCHEME,  B.INACTIVE,CAST(0 AS NUMERIC(14,2)) AS QUANTITY_IN_STOCK ,   
	SKU.PURCHASE_PRICE,  SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,    
	G.PARA4_CODE,H.PARA5_CODE,I.PARA6_CODE,    
	PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],    
	B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],    
	B.STOCK_NA,   
	CONVERT (BIT,(CASE WHEN A.QUANTITY <0 THEN 1 ELSE 0 END)) AS SALERETURN ,CAST(0 AS BIT) AS CREDIT_REFUND,  
	'' AS HOLD_ID,'' AS CMD_HOLD_ROW_ID, CMD.MRP AS [LOCSKU_MRP],SKU.PRODUCT_NAME,  
	EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2  ,(CASE WHEN ISNULL(SKU.FIX_MRP,0)=0 THEN SKU.MRP ELSE SKU.FIX_MRP END) AS [FIX_MRP],
	(CASE WHEN ISNULL(CMD.HOLD_FOR_ALTER,0)=0 THEN 'N' ELSE 'Y' END) AS [HOLD_FOR_ALTER_TXT],
	(CASE WHEN ISNULL(CMD.PACK_SLIP_ID,'')='' THEN '' ELSE RIGHT(CMD.PACK_SLIP_ID,10 ) END) AS [PACK_SLIP_NO]
	,ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],B.ALIAS AS ARTICLE_ALIAS ,SD.SUB_SECTION_CODE,SM.SECTION_CODE,
	CONVERT(BIT,0 ) AS [BRANDWISE_DISC],ISNULL(SLS_TITLE,'') AS SLS_TITLE,ISNULL(N.NARRATION,'') AS [NARRATION]
	,CMM.CM_NO	,CONVERT(VARCHAR(20),CMM.CM_DT,105) AS [CM_DT],cmd.product_code as org_product_code
	FROM  SLR_RECON_DET  A  (NOLOCK) 
	JOIN SLR_RECON_MST MST (NOLOCK) ON MST.MEMO_ID=A.MEMO_ID
	JOIN CMD01106 CMD (NOLOCK) ON CMD.ROW_ID=A.CMD_ROW_ID
	JOIN CMM01106 CMM (NOLOCK) ON CMD.CM_ID=CMM.CM_ID AND CMM.CANCELLED=0
	JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=CMD.PRODUCT_CODE  
	LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=CMD.BIN_ID  
	JOIN ARTICLE B  (NOLOCK) ON SKU.ARTICLE_CODE = B.ARTICLE_CODE      
	JOIN SECTIOND SD  (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	JOIN SECTIONM SM  (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	JOIN PARA1 C  (NOLOCK) ON SKU.PARA1_CODE = C.PARA1_CODE      
	JOIN PARA2 D  (NOLOCK) ON SKU.PARA2_CODE = D.PARA2_CODE      
	JOIN PARA3 F  (NOLOCK) ON SKU.PARA3_CODE = F.PARA3_CODE      
	JOIN PARA4 G  (NOLOCK) ON SKU.PARA4_CODE = G.PARA4_CODE      
	JOIN PARA5 H  (NOLOCK) ON SKU.PARA5_CODE = H.PARA5_CODE      
	JOIN PARA6 I  (NOLOCK) ON SKU.PARA6_CODE = I.PARA6_CODE      
	JOIN UOM E  (NOLOCK) ON B.UOM_CODE = E.UOM_CODE 
	LEFT OUTER JOIN NRM N (NOLOCK) ON N.NRM_ID=ISNULL(CMD.NRM_ID  ,'0000000')
	LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON CMD.EMP_CODE = EMP.EMP_CODE   
	LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON CMD.EMP_CODE1 = EMP1.EMP_CODE     
	LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON CMD.EMP_CODE2 = EMP2.EMP_CODE    
	LEFT OUTER JOIN SLSDET S (NOLOCK) ON S.ROW_ID =CMD.SLSDET_ROW_ID
	WHERE A.MEMO_ID=@CWHERE  
	GOTO SSPL
	
GETDATA:
	SELECT A.*,A.SR_NO AS SRNO,  
	EMP.EMP_NAME, A.PRODUCT_CODE, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, C.PARA1_CODE,    
	C.PARA1_NAME, D.PARA2_CODE, D.PARA2_NAME, F.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,       
	A.DEPT_ID, B.CODING_SCHEME,  B.INACTIVE,ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK ,   
	SKU.PURCHASE_PRICE,  SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,    
	G.PARA4_CODE,H.PARA5_CODE,I.PARA6_CODE,    
	PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],    
	B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],    
	B.STOCK_NA,   
	CONVERT (BIT,(CASE WHEN A.QUANTITY <0 THEN 1 ELSE 0 END)) AS SALERETURN ,CAST(0 AS BIT) AS CREDIT_REFUND,  
	'' AS HOLD_ID,'' AS CMD_HOLD_ROW_ID, A.MRP AS [LOCSKU_MRP],SKU.PRODUCT_NAME,  
	EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2  ,(CASE WHEN ISNULL(SKU.FIX_MRP,0)=0 THEN SKU.MRP ELSE SKU.FIX_MRP END) AS [FIX_MRP],
	(CASE WHEN ISNULL(A.HOLD_FOR_ALTER,0)=0 THEN 'N' ELSE 'Y' END) AS [HOLD_FOR_ALTER_TXT],
	(CASE WHEN ISNULL(A.PACK_SLIP_ID,'')='' THEN '' ELSE RIGHT(A.PACK_SLIP_ID,10 ) END) AS [PACK_SLIP_NO]
	,ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],B.ALIAS AS ARTICLE_ALIAS ,SD.SUB_SECTION_CODE,SM.SECTION_CODE,
	CONVERT(BIT,0 ) AS [BRANDWISE_DISC],ISNULL(SLS_TITLE,'') AS SLS_TITLE,ISNULL(N.NARRATION,'') AS [NARRATION]
	,CMM.CM_NO	,CONVERT(VARCHAR(20),CMM.CM_DT,105) AS [CM_DT],A.product_code as org_product_code
	FROM posgrrecos R 
	JOIN CMD01106  A  (NOLOCK) ON R.CMDRowId=A.ROW_ID
	JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=A.CM_ID
	JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
	LEFT OUTER JOIN PMT01106 P  (NOLOCK) ON P.PRODUCT_CODE=A.PRODUCT_CODE AND P.BIN_ID=A.BIN_ID  and CMM.location_Code =p.DEPT_ID 
	LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID  
	JOIN ARTICLE B  (NOLOCK) ON SKU.ARTICLE_CODE = B.ARTICLE_CODE      
	JOIN SECTIOND SD  (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	JOIN SECTIONM SM  (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	JOIN PARA1 C  (NOLOCK) ON SKU.PARA1_CODE = C.PARA1_CODE      
	JOIN PARA2 D  (NOLOCK) ON SKU.PARA2_CODE = D.PARA2_CODE      
	JOIN PARA3 F  (NOLOCK) ON SKU.PARA3_CODE = F.PARA3_CODE      
	JOIN PARA4 G  (NOLOCK) ON SKU.PARA4_CODE = G.PARA4_CODE      
	JOIN PARA5 H  (NOLOCK) ON SKU.PARA5_CODE = H.PARA5_CODE      
	JOIN PARA6 I  (NOLOCK) ON SKU.PARA6_CODE = I.PARA6_CODE      
	JOIN UOM E  (NOLOCK) ON B.UOM_CODE = E.UOM_CODE 
	LEFT OUTER JOIN NRM N (NOLOCK) ON N.NRM_ID=ISNULL(A.NRM_ID  ,'0000000')
	LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON A.EMP_CODE = EMP.EMP_CODE   
	LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON A.EMP_CODE1 = EMP1.EMP_CODE     
	LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON A.EMP_CODE2 = EMP2.EMP_CODE    
	LEFT OUTER JOIN SLSDET S (NOLOCK) ON S.ROW_ID =A.SLSDET_ROW_ID
	WHERE CMM.CANCELLED=0 --AND A.QUANTITY<0 
	AND R.GRQuantity-R.RecoQty>0
	AND CMM.CM_DT=@CWHERE and  CMM.location_Code  = @CFINYEAR
	GOTO SSPL

GETREPORT:
	
	SELECT A.*,A.SR_NO AS SRNO,  
	EMP.EMP_NAME, A.PRODUCT_CODE, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, C.PARA1_CODE,    
	C.PARA1_NAME, D.PARA2_CODE, D.PARA2_NAME, F.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,       
	A.DEPT_ID, B.CODING_SCHEME,  B.INACTIVE,ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK ,   
	SKU.PURCHASE_PRICE,  SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,    
	G.PARA4_CODE,H.PARA5_CODE,I.PARA6_CODE,    
	PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],    
	B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],    
	B.STOCK_NA,   
	CONVERT (BIT,(CASE WHEN A.QUANTITY <0 THEN 1 ELSE 0 END)) AS SALERETURN ,CAST(0 AS BIT) AS CREDIT_REFUND,  
	'' AS HOLD_ID,'' AS CMD_HOLD_ROW_ID, A.MRP AS [LOCSKU_MRP],SKU.PRODUCT_NAME,  
	EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2  ,(CASE WHEN ISNULL(SKU.FIX_MRP,0)=0 THEN SKU.MRP ELSE SKU.FIX_MRP END) AS [FIX_MRP],
	(CASE WHEN ISNULL(A.HOLD_FOR_ALTER,0)=0 THEN 'N' ELSE 'Y' END) AS [HOLD_FOR_ALTER_TXT],
	(CASE WHEN ISNULL(A.PACK_SLIP_ID,'')='' THEN '' ELSE RIGHT(A.PACK_SLIP_ID,10 ) END) AS [PACK_SLIP_NO]
	,ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],B.ALIAS AS ARTICLE_ALIAS ,SD.SUB_SECTION_CODE,SM.SECTION_CODE,
	CONVERT(BIT,0 ) AS [BRANDWISE_DISC],ISNULL(SLS_TITLE,'') AS SLS_TITLE,ISNULL(N.NARRATION,'') AS [NARRATION]
	,CMM.CM_NO	,CONVERT(VARCHAR(20),CMM.CM_DT,105) AS [CM_DT],ISNULL(X.QUANTITY,0) AS [RETURNED_QTY]
	FROM  CMD01106  A  (NOLOCK) 
	JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=A.CM_ID
	JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
	LEFT OUTER JOIN PMT01106 P  (NOLOCK) ON P.PRODUCT_CODE=A.PRODUCT_CODE AND P.BIN_ID=A.BIN_ID  
	LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID  
	JOIN ARTICLE B  (NOLOCK) ON SKU.ARTICLE_CODE = B.ARTICLE_CODE      
	JOIN SECTIOND SD  (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	JOIN SECTIONM SM  (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	JOIN PARA1 C  (NOLOCK) ON SKU.PARA1_CODE = C.PARA1_CODE      
	JOIN PARA2 D  (NOLOCK) ON SKU.PARA2_CODE = D.PARA2_CODE      
	JOIN PARA3 F  (NOLOCK) ON SKU.PARA3_CODE = F.PARA3_CODE      
	JOIN PARA4 G  (NOLOCK) ON SKU.PARA4_CODE = G.PARA4_CODE      
	JOIN PARA5 H  (NOLOCK) ON SKU.PARA5_CODE = H.PARA5_CODE      
	JOIN PARA6 I  (NOLOCK) ON SKU.PARA6_CODE = I.PARA6_CODE      
	JOIN UOM E  (NOLOCK) ON B.UOM_CODE = E.UOM_CODE 
	LEFT OUTER JOIN NRM N (NOLOCK) ON N.NRM_ID=ISNULL(A.NRM_ID,'0000000')
	LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON A.EMP_CODE = EMP.EMP_CODE   
	LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON A.EMP_CODE1 = EMP1.EMP_CODE     
	LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON A.EMP_CODE2 = EMP2.EMP_CODE    
	LEFT OUTER JOIN SLSDET S (NOLOCK) ON S.ROW_ID =A.SLSDET_ROW_ID
	LEFT OUTER JOIN 
	(
		SELECT A.CMD_ROW_ID,A.QUANTITY 
		FROM SLR_RECON_DET A (NOLOCK)
		JOIN SLR_RECON_MST B (NOLOCK) ON B.MEMO_ID=A.MEMO_ID
		WHERE B.CANCELLED=0 AND A.MEMO_ID=@CREFMEMONO
	)X ON X.CMD_ROW_ID=A.ROW_ID
	WHERE CMM.CANCELLED=0 AND A.QUANTITY<0 AND CMM.CM_DT=@CWHERE
	GOTO SSPL	
SSPL:	

END

