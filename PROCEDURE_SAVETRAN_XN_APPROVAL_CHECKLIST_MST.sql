create PROCEDURE SAVETRAN_XN_APPROVAL_CHECKLIST_MST
(
	 @CSPID			VARCHAR(50),
	 @BDELETE       BIT=0
)
--WITH ENCRYPTION
AS
BEGIN
DECLARE @CERRMSG VARCHAR(500),@CSTEP VARCHAR(10)
	   ,@CCMD NVARCHAR(MAX),@CNEWCHECKLIST_CODE VARCHAR(10),@BREFEXISTS BIT
	   ,@CHECKLIST_DESC VARCHAR(100)

DECLARE @TOUTPUT TABLE(CHECKLIST_CODE VARCHAR(50),ERRMSG VARCHAR(500))

---LIST OF TABLES TO SAVE
DECLARE @TXN_APPROVAL_CHECKLIST_MST VARCHAR(100)


SET @TXN_APPROVAL_CHECKLIST_MST='MSTLOC_XN_APPROVAL_CHECKLIST_MST_UPLOAD'

BEGIN TRY
BEGIN TRANSACTION
		    SET @CSTEP=10  
		    SET @CCMD = N'DELETE A FROM XN_APPROVAL_CHECKLIST_MST A
		    JOIN '+@TXN_APPROVAL_CHECKLIST_MST+' B ON A.CHECKLIST_CODE=B.CHECKLIST_CODE AND A.XN_TYPE=B.XN_TYPE WHERE B.[DELETE1]=1 AND B.SP_ID='''+@CSPID+''' '
		    PRINT @CCMD
		    EXEC SP_EXECUTESQL @CCMD
		   
  
            SET @CSTEP=20  
		    SET @CCMD = N'DELETE A FROM  '+@TXN_APPROVAL_CHECKLIST_MST+' A  WHERE A.[DELETE1]=1 AND A.SP_ID='''+@CSPID+''' '
		    PRINT @CCMD
		    EXEC SP_EXECUTESQL @CCMD
		 
		    
			--VALIDATION FOR BLANK CHECKLIST_DESC
			SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TXN_APPROVAL_CHECKLIST_MST+' WHERE ISNULL(CHECKLIST_DESC,'''')=''''  AND SP_ID= '''+@CSPID+''')
					        SET @CERRMSG=''CHECKLIST_DESC  CANNOT BE BLANK.'''
			PRINT @CCMD					        
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT
			
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC
			
			SET @CSTEP=70
			SET @CCMD = N'DELETE A FROM XN_APPROVAL_CHECKLIST_MST A
		    JOIN '+@TXN_APPROVAL_CHECKLIST_MST+' B ON A.CHECKLIST_DESC=B.CHECKLIST_DESC AND A.XN_TYPE=B.XN_TYPE WHERE LEFT(B.CHECKLIST_CODE,5)=''LATER''
			AND   B.SP_ID= '''+@CSPID+''''
		    PRINT @CCMD
		    EXEC SP_EXECUTESQL @CCMD
		   
			--VALIDATION FOR UNIQUE CHECKLISTDESC
			--SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TXN_APPROVAL_CHECKLIST_MST+' A JOIN XN_APPROVAL_CHECKLIST_MST B ON A.CHECKLIST_DESC=B.CHECKLIST_DESC
			--					  AND A.XN_TYPE=B.XN_TYPE)
			--		        SET @CERRMSG=''CHECKLIST_DESC  ALREADY EXISTS.'''
			--PRINT @CCMD
			--EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC
				
	    
	    IF OBJECT_ID ('TEMPDB..#TMPXN_APPROVAL_CHECKLIST_MST','U') IS NOT NULL
	        DROP TABLE #TMPXN_APPROVAL_CHECKLIST_MST
	        
	        SELECT * INTO #TMPXN_APPROVAL_CHECKLIST_MST FROM MSTLOC_XN_APPROVAL_CHECKLIST_MST_UPLOAD WHERE 1>2

	       
	       	SET @CCMD=N'SELECT * FROM '+@TXN_APPROVAL_CHECKLIST_MST+' A WHERE LEFT(CHECKLIST_CODE,5)=''LATER'' AND SP_ID= '''+@CSPID+''' '
			PRINT @CCMD
			INSERT INTO #TMPXN_APPROVAL_CHECKLIST_MST
			EXEC SP_EXECUTESQL @CCMD
	       

		  
	       
	       
	    WHILE(SELECT TOP 1 'U' FROM #TMPXN_APPROVAL_CHECKLIST_MST) = 'U'
		BEGIN
		
		   SELECT TOP 1 @CHECKLIST_DESC=CHECKLIST_DESC FROM #TMPXN_APPROVAL_CHECKLIST_MST
		   
			SET @CSTEP=100
			LBL_GENARTKEY:
			EXEC GETNEXTKEY @CTABLENAME='XN_APPROVAL_CHECKLIST_MST'
							,@CCOLNAME='CHECKLIST_CODE'
							,@NWIDTH='10'
							,@CPREFIX=''
							,@NLZEROS=1
							,@CFINYEAR=''
							,@NROWCOUNT=0
							,@CNEWKEYVAL=@CNEWCHECKLIST_CODE OUTPUT	
			
			IF ISNULL(@CNEWCHECKLIST_CODE,'')=''	
			BEGIN	
				SET @CERRMSG='ERROR GENERATING DEPARTMENT CODE.'
				GOTO END_PROC
			END	
			
			SET @CSTEP=110				
			IF EXISTS(SELECT TOP 1 'U' FROM XN_APPROVAL_CHECKLIST_MST WHERE CHECKLIST_CODE=@CNEWCHECKLIST_CODE)
				GOTO LBL_GENARTKEY
			
			---UPDATE THE CHECKLIST_CODE IN ALL TEMP TABLES
			SET @CSTEP=120
			---UPDATING CHECKLIST_CODE IN SECTIONM
			SET @CCMD=N'UPDATE '+@TXN_APPROVAL_CHECKLIST_MST+' SET CHECKLIST_CODE='''+@CNEWCHECKLIST_CODE+''' WHERE LEFT(CHECKLIST_CODE,5)=''LATER'' AND CHECKLIST_DESC = '''+@CHECKLIST_DESC+''' AND SP_ID= '''+@CSPID+''' '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD 
			
						
		    SET @CCMD = N'DELETE FROM #TMPXN_APPROVAL_CHECKLIST_MST WHERE CHECKLIST_DESC = '''+@CHECKLIST_DESC+''''
		    PRINT @CCMD
		    EXEC SP_EXECUTESQL @CCMD
		END	
				
	
	SET @CSTEP=160

	DECLARE @CWHERECLAUSE VARCHAR(1000)
    SET @CWHERECLAUSE = ' SP_ID='''+LTRIM(RTRIM((@CSPID)))+''''
	--UPDATING XN_APPROVAL_CHECKLIST_MST MASTER
	EXEC UPDATEMASTERXN
			 @CSOURCEDB=''
			,@CSOURCETABLE=@TXN_APPROVAL_CHECKLIST_MST
			,@CDESTDB=''
			,@CDESTTABLE='XN_APPROVAL_CHECKLIST_MST'
			,@CKEYFIELD1='CHECKLIST_CODE'
			,@CKEYFIELD2=''
			,@CKEYFIELD3=''
			,@LINSERTONLY=0
			,@CFILTERCONDITION=@CWHERECLAUSE
			,@CXNTYPE=''
			,@LUPDATEONLY=0
			,@BALWAYSUPDATE=1
	
END TRY
BEGIN CATCH 
	SET @CERRMSG='SAVETRAN_XN_APPROVAL_CHECKLIST_MST: STEP - '+ISNULL(@CSTEP,'')+', MESSAGE - '+ERROR_MESSAGE() 
END CATCH

END_PROC:

IF @@TRANCOUNT>0  
 BEGIN  
  IF ISNULL(@CERRMSG,'')='' 
   COMMIT TRANSACTION  
  ELSE  
   ROLLBACK  
 END  
IF ISNULL(@CERRMSG,'')=''
BEGIN
	SET @CSTEP=150
	SET @CCMD=N'SELECT CHECKLIST_CODE,'''' AS ERRMSG FROM '+@TXN_APPROVAL_CHECKLIST_MST+' where SP_ID='''+@CSPID+''' '
	PRINT @CCMD		
	INSERT @TOUTPUT(CHECKLIST_CODE ,ERRMSG)			        
	EXEC SP_EXECUTESQL @CCMD
END
ELSE
BEGIN
INSERT @TOUTPUT(CHECKLIST_CODE ,ERRMSG)		
SELECT '',@CERRMSG
END

DELETE A FROM MSTLOC_XN_APPROVAL_CHECKLIST_MST_UPLOAD A (NOLOCK) WHERE SP_ID=@CSPID
	


SELECT * FROM @TOUTPUT

END
--END OF PROCEDURE - SAVETRAN_XN_APPROVAL_CHECKLIST_MST
