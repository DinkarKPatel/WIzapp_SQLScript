create PROCEDURE SPOLAP_SEND_MIRROR_XNSCUST_DATA
(
	@CREQXNID VARCHAR(20)='', 
	@CERRMSG VARCHAR(MAX) OUTPUT  
)
AS
BEGIN
		DECLARE @CCMD NVARCHAR(MAX),@CSTEP VARCHAR(100),@CFILTERCONDITION VARCHAR(200),@CCUTOFFDATE VARCHAR(10),
				@CMEMOID VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTABLENAME VARCHAR(100),@CTEMPMASTERTABLE VARCHAR(100),
				@BRECFOUND BIT,@CCUST_CODE_STRING VARCHAR(MAX),@DMEMOLASTUPDATE DATETIME
		DECLARE @cCols NVARCHAR(MAX), @cCmdCols NVARCHAR(MAX)

		
BEGIN TRY
	
	SET @CSTEP=110
	---- SEND THE LEDGER MASTER TABLE
	SELECT @cCols=COALESCE(@cCols+',','')+colname 	FROM olap_xnssending_cols WHERE tablename='CUSTDYM' 

	SET @cCmdCols=N'
	   SELECT ''OLAPCUST_CUSTDYM_UPLOAD'' AS TARGET_TABLENAME,'+@cCols+' FROM CUSTDYM  (NOLOCK)   WHERE CUSTOMER_CODE='''+@CREQXNID+''''
	PRINT @cCmdCols
	EXEC SP_EXECUTESQL @cCmdCols

	SET @CSTEP=130

	SET @cCols=NULL
	SELECT @cCols=COALESCE(@cCols+',','')+'A.'+colname 	FROM olap_xnssending_cols WHERE tablename='AREA' 
	PRINT @cCOls


	SET @cCmdCols=N'
	   SELECT ''OLAPCUST_AREA_UPLOAD'' AS TARGET_TABLENAME,'+@cCols+' FROM AREA A
	   JOIN  CUSTDYM B  (NOLOCK) ON A.AREA_CODE=B.AREA_CODE   WHERE B.CUSTOMER_CODE='''+@CREQXNID+''''
	PRINT @cCmdCols
	EXEC SP_EXECUTESQL @cCmdCols


	SET @CSTEP=140

	SET @cCols=NULL
	SELECT @cCols=COALESCE(@cCols+',','')+'A.'+colname 	FROM olap_xnssending_cols WHERE tablename='CITY' 
	PRINT @cCOls

	SET @cCmdCols=N'
	   SELECT ''OLAPCUST_CITY_UPLOAD'' AS TARGET_TABLENAME,'+@cCols+' FROM CITY  A JOIN area b ON A.CITY_CODE = B.CITY_CODE
	   JOIN CUSTDYM c ON c.AREA_CODE = B.AREA_CODE   WHERE C.CUSTOMER_CODE='''+@CREQXNID+''''
	PRINT @cCmdCols
	EXEC SP_EXECUTESQL @cCmdCols


	SET @CSTEP=150

	SET @cCols=NULL
	SELECT @cCols=COALESCE(@cCols+',','')+'A.'+colname 	FROM olap_xnssending_cols WHERE tablename='STATE' 
	PRINT @cCOls

	SET @cCmdCols=N'
	   SELECT ''OLAPCUST_STATE_UPLOAD'' AS TARGET_TABLENAME,'+@cCols+' FROM STATE  A JOIN CITY B ON A.STATE_CODE = B.STATE_CODE
		JOIN area c ON c.CITY_CODE = B.CITY_CODE
		JOIN CUSTDYM d ON d.AREA_CODE = c.AREA_CODE   WHERE D.CUSTOMER_CODE='''+@CREQXNID+''''
	PRINT @cCmdCols
	EXEC SP_EXECUTESQL @cCmdCols


	SET @CSTEP=160

	SET @cCols=NULL
	SELECT @cCols=COALESCE(@cCols+',','')+'A.'+colname 	FROM olap_xnssending_cols WHERE tablename='REGIONM' 
	PRINT @cCOls

	SET @cCmdCols=N'
	    SELECT ''OLAPCUST_REGIONM_UPLOAD'' AS TARGET_TABLENAME,'+@cCols+' FROM REGIONM  A JOIN STATE  B	ON A.REGION_CODE = B.REGION_CODE
		JOIN CITY c ON c.STATE_CODE = B.STATE_CODE
		JOIN area d ON d.CITY_CODE = c.CITY_CODE
		JOIN CUSTDYM e ON e.AREA_CODE = d.AREA_CODE   WHERE E.CUSTOMER_CODE='''+@CREQXNID+''''
	PRINT @cCmdCols
	EXEC SP_EXECUTESQL @cCmdCols



END TRY

BEGIN CATCH
	SET @CERRMSG='P: SPOLAP_SEND_MIRROR_XNSCUST_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:

END
