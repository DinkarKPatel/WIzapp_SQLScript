create PROCEDURE UPDATEMASTERXN_MIRROR 
			@CSOURCEDB VARCHAR(100),
			@CSOURCETABLE VARCHAR(100),
			@CDESTDB VARCHAR(100),
			@CDESTTABLE VARCHAR(100),
			@CKEYFIELD1 VARCHAR(40)='',
			@CKEYFIELD2 VARCHAR(40)='',
			@CKEYFIELD3 VARCHAR(40)='',
			@LINSERTONLY BIT = 0,
			@CJOINSTR VARCHAR(MAX)='',
			@CFILTERCONDITION VARCHAR(500)='',
			@LUPDATEONLY BIT = 0,
			@BALWAYSUPDATE BIT=0,
			@CXNTYPE VARCHAR(10)='',
			@BUPDATEXNS BIT =0,
			@CSEARCHTABLE VARCHAR(100)='',
			@BINSVERSIONNO BIT=0,
			@NINSSPID INT=0,
			@CINSSPID VARCHAR(50)='',
			@cUpdateStrPara VARCHAR(4000)='',
			@bThruUpdatestrPara BIT=0,
			@CINSSPIDCol VARCHAR(100)='',
			@cLogSpId VARCHAR(50)=''
--WITH ENCRYPTION			
AS
BEGIN
	DECLARE @cStep varchar(20)
	IF @cLogSpId=''
		SET @cLogSpId=ltrim(rtrim(str(@@spid)))

	SET @cStep='10'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1

	SET NOCOUNT ON

	IF @bThruUpdatestrPara=1 AND @cUpdateStrPara='' AND @LUpdateOnly=1
		RETURN

	SET @cStep='20'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1

	DECLARE @CWC VARCHAR(100),
			@CINSERTSTR NVARCHAR(MAX),
			@CINSERTSTRVALUE VARCHAR(MAX),
			@CUPDATESTR	VARCHAR(MAX),
			@CWHERECLAUSE NVARCHAR(MAX),
			@CCMD NVARCHAR(MAX),
			@LDONOTREPLNULLS BIT,@CUSERIDPREFIX VARCHAR(30),
			@CSOURCETABLEEXPR VARCHAR(1000),@CSOURCETABLESTR VARCHAR(1000),@CDESTTABLESTR VARCHAR(1000),@CDISTINCTSTR VARCHAR(200),
			@CDESTTABLESEARCH VARCHAR(500),@CDESTTABLEEXPRSUFFIX VARCHAR(4000),@CSOURCETABLEEXPRSUFFIX VARCHAR(4000)
	
	SET @CDESTTABLESEARCH=(CASE WHEN @CSEARCHTABLE='' THEN @CDESTTABLE ELSE @CSEARCHTABLE END)

	SELECT @CDESTTABLEEXPRSUFFIX='',@CSOURCETABLEEXPRSUFFIX=''

	SET @cStep='30'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1
	
	SELECT TOP 1 @CINSERTSTR=INSERTSTR,@CINSERTSTRVALUE=INSERTSTRVALUE  FROM MIRRORXNSINFO (NOLOCK)
	WHERE TABLENAME=@CDESTTABLESEARCH

	--para2_code =  ISNULL( B.para2_code, '')
	
	IF @cXnType='SYNCHSKU'
	BEGIN
		SELECT @cUpdateStrPara=NULL

		declare @cCurlocid varchar(4),@bUpdPurInfo bit

		SELECT TOP 1 @cCurLocId=value FROM  config (NOLOCK) WHERE config_option='location_id'
		
		SELECT TOP 1 @bUpdPurInfo=ISNULL(upd_purinfo,0) FROM  location (NOLOCK) WHERE dept_id=@cCurLocId


		SELECT @cUpdateStrPara=coalesce(@cUpdateStrPara+',','')+column_name+'=b.'+column_name FROM  synch_sku_cols a (NOLOCK)
		WHERE table_name=@CDESTTABLE AND (isnull(a.restricted_column,0)<>1 OR @bUpdPurInfo=1)
	END

	SET @cStep='40'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1
	IF @BINSVERSIONNO=1
		SELECT @CDESTTABLEEXPRSUFFIX=',VERSION_NO',@CSOURCETABLEEXPRSUFFIX=',B.VERSION_NO'
	ELSE
	IF @NINSSPID<>0
		SELECT @CDESTTABLEEXPRSUFFIX=',SP_ID',@CSOURCETABLEEXPRSUFFIX=','+LTRIM(RTRIM(STR(@NINSSPID)))
	ELSE		
	IF @CINSSPIDCol<>''
	BEGIN
		SELECT  @CDESTTABLEEXPRSUFFIX=',VERSION_NO',@CSOURCETABLEEXPRSUFFIX=',1 as version_no'
		IF CHARINDEX(@CINSSPIDCol,@CINSERTSTRVALUE)>0
			SET @CINSERTSTRVALUE=REPLACE(@CINSERTSTRVALUE,'b.'+@CINSSPIDCol,''''+@CINSSPID+'''')
		ELSE
			SELECT @CDESTTABLEEXPRSUFFIX=@CDESTTABLEEXPRSUFFIX+','+@CINSSPIDCol,
				   @CSOURCETABLEEXPRSUFFIX=@CSOURCETABLEEXPRSUFFIX+','''+@CINSSPID+''''

	END
	ELSE
	IF @CINSSPID<>''
		SELECT @CDESTTABLEEXPRSUFFIX=',SP_ID',@CSOURCETABLEEXPRSUFFIX=','''+@CINSSPID+''''
		
	SET @cStep='50'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1
	SET @CDESTTABLESTR=(CASE WHEN LEFT(@CDESTTABLE,1)<>'[' THEN '[' ELSE '' END)+
		@CDESTTABLE+(CASE WHEN RIGHT(@CDESTTABLE,1)<>']' THEN ']' ELSE '' END)


	SET @CSOURCETABLEEXPR=@CSOURCEDB+@CSOURCETABLE
		
	SET @CSOURCETABLESTR=(CASE WHEN LEFT(@CSOURCETABLE,1)<>'[' THEN '[' ELSE '' END)+
				  @CSOURCETABLE+(CASE WHEN RIGHT(@CSOURCETABLE,1)<>']' THEN ']' ELSE '' END)
	
		
	SET @cStep='60'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1
	SET @CWC = ''
	IF @CKEYFIELD1 <> ''
		SET @CWC = 'A.' + @CKEYFIELD1 + ' = B.' + @CKEYFIELD1
	IF @CKEYFIELD2 <> ''
		SET @CWC = @CWC + ( CASE WHEN @CWC<>'' THEN ' AND ' ELSE '' END ) + 'A.' + @CKEYFIELD2 + ' = B.' + @CKEYFIELD2
	IF @CKEYFIELD3 <> ''
		SET @CWC = @CWC + ( CASE WHEN @CWC<>'' THEN ' AND ' ELSE '' END ) + 'A.' + @CKEYFIELD3 + ' = B.' + @CKEYFIELD3
	IF @CWC <> ''
		SET @CWC = ' ON ' + @CWC 

	IF @LINSERTONLY = 0 
	BEGIN
		
	SET @cStep='70'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1
		PRINT 'PREPARE UPDATE STATEMENT FOR :'+@CDESTTABLE
		IF isnull(@cUpdateStrPara,'')=''
			SELECT TOP 1 @CUPDATESTR=UPDATESTR FROM MIRRORXNSINFO (NOLOCK) WHERE TABLENAME=@CDESTTABLESEARCH
		ELSE	
			SET @cUpdateStr=@cUpdateStrPara


	SET @cStep='80'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1
		SET @CWHERECLAUSE=(CASE WHEN @BALWAYSUPDATE<>1 THEN ' WHERE A.LAST_UPDATE<B.LAST_UPDATE ' ELSE '' END)
	


		SET @CCMD = N'UPDATE A WITH (ROWLOCK) SET ' + @CUPDATESTR +
					 ' FROM ' + @CSOURCEDB + @CSOURCETABLESTR + ' B  (NOLOCK) ' + 
					 ' JOIN ' + @CDESTDB + @CDESTTABLESTR + ' A ' +@CWC +@CJOINSTR+ @CWHERECLAUSE + 
					 (CASE WHEN @CFILTERCONDITION<>'' THEN (CASE WHEN @CWHERECLAUSE='' THEN ' WHERE ' ELSE ' AND ' END)
					  ELSE '' END)+@CFILTERCONDITION


		PRINT @CCMD			  
		EXEC SP_EXECUTESQL @CCMD
	END
	
	IF @LUPDATEONLY = 1
		RETURN
	
	SET @cStep='90'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1
	DECLARE @bNoDistinct BIT
	SET @bNoDistinct=(CASE WHEN (LEFT(@CSOURCETABLE,4) IN ('WSL_','WPS_','PUR_','PRT_') OR LEFT(@CSOURCETABLE,3) IN ('PO_')
						   OR @CXNTYPE IN ('WSL','WPS','PUR','PRT'))			
						   AND @BUPDATEXNS=1 THEN 1 ELSE 0 END)	
	
	
	SET @CDISTINCTSTR = (CASE WHEN @CSOURCETABLE LIKE '%EMP_WPAYATT%' OR @CSOURCETABLE LIKE '%IMAGE_XN_DET%' THEN '' ELSE ' DISTINCT ' END)	

	PRINT 'PREPARE INSERT STATEMENT FOR MIRROR TABLE :'+@CDESTTABLE
	
	SET @cStep='100'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1
	

	SET @CCMD = N' INSERT ' + @CDESTDB + @CDESTTABLESTR+
				  ' ( ' + @CINSERTSTR +@CDESTTABLEEXPRSUFFIX+ ' ) ' +
				 ' SELECT '+@CDISTINCTSTR+@CINSERTSTRVALUE + @CSOURCETABLEEXPRSUFFIX+
				 ' FROM ' + @CSOURCEDB + @CSOURCETABLESTR+ ' B (NOLOCK) ' + 
				 (CASE WHEN @NINSSPID<>0 OR @CINSSPID<>'' THEN @CJOINSTR
					   WHEN @BUPDATEXNS=0 OR @LINSERTONLY=0 THEN  
				 ' LEFT OUTER JOIN ' + @CDESTDB + @CDESTTABLESTR + ' A (NOLOCK) ' + @CWC +@CJOINSTR+
				 ' WHERE A.' + @CKEYFIELD1 + ' IS NULL ' ELSE '' END)

	IF (@CFILTERCONDITION<>'') 
	BEGIN
		SET @CCMD = @CCMD + 
					( CASE WHEN @CKEYFIELD1<>'' AND (@LINSERTONLY=0 OR @BUPDATEXNS=0)  THEN ' AND ' ELSE ' WHERE ' END ) + 
					@CFILTERCONDITION
	END
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD

	SET @cStep='110'
	EXEC SP_CHKXNSAVELOG 'genstr',@CSTEP,0,@cLogSpId,'',1
END
--*************************************** END OF PROCEDURE UPDATEMASTERXN_MIRROR