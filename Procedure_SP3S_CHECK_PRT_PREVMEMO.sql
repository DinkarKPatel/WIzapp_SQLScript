CREATE PROCEDURE SP3S_CHECK_PRT_PREVMEMO--(LocId 3 digit change by Sanjay:04-11-2024)
@CFINYEAR VARCHAR(5),
@CMEMONO VARCHAR(50),
@CMEMOPREFIX varchar(25),
@cSourceLocationCode VARCHAR(4),
@CERRORMSG VARCHAR(MAX) OUTPUT
AS
BEGIN

	PRINT 'CHECK SERIES-1:'+isnull(@cMemoNo,'null memo no')
	DECLARE @CFIRSTMEMONO VARCHAR(20),@NLENVALUE NUMERIC(4,0),@CMEMONOLEN VARCHAR(4),
	@NMEMONOLEN NUMERIC(2,0),@NPREVMEMONO NUMERIC(12,0),@CPREVMEMONO VARCHAR(25),@CPREVMEMONOSEARCH VARCHAR(25)
	
	--SELECT @CMEMONO AS CMEMONOVAL
	SET @CERRORMSG=''


	SET @NMEMONOLEN=LEN(@CMEMONO)
	
	PRINT 'CHECK SERIES-2.2'	
	SET @NLENVALUE=@NMEMONOLEN-LEN(@CMEMOPREFIX)
	
	PRINT 'CHECK SERIES-2.5:'+@CMEMOPREFIX+':'+@CMEMONO	   
	SET @NPREVMEMONO=CONVERT(NUMERIC(12,0),REPLACE(@CMEMONO,@CMEMOPREFIX,''))

	
	PRINT 'CHECK SERIES-3'
	
	IF @NPREVMEMONO>1
	BEGIN
		SET @NPREVMEMONO=@NPREVMEMONO-1
		
		SELECT @CFIRSTMEMONO=MIN(RM_NO) 
		FROM rmm01106   A (NOLOCK)
		WHERE a.location_Code=@cSourceLocationCode
		AND A.FIN_YEAR=@CFINYEAR AND LEFT(@CMEMONO,LEN(@CMEMOPREFIX))=@CMEMOPREFIX 
		AND LEN(RM_NO)=LEN(@CMEMONO)
		AND LEFT(A.RM_NO,len(@cSourceLocationCode)+3)=LEFT(@CMEMONO,len(@cSourceLocationCode)+3)
		
		
		PRINT 'CHECK SERIES-4'				   
        IF isnull(@CFIRSTMEMONO,'') > @CMEMONO
			SET @CFIRSTMEMONO=@CMEMONO						   		
		
	
		SET @CPREVMEMONO=@CMEMOPREFIX+REPLICATE('0',@NLENVALUE-LEN(LTRIM(RTRIM(STR(@NPREVMEMONO)))))+LTRIM(RTRIM(STR(@NPREVMEMONO)))

		DECLARE @bCheckedOther BIT
		set @bCheckedOther=0


lblChkAgain:		
		SET @CPREVMEMONOSEARCH=''
		
		PRINT 'CHECK SERIES-5'
		SELECT TOP 1 @CPREVMEMONOSEARCH=rm_no   
		FROM rmm01106   WITH (NOLOCK) WHERE rm_no=@CPREVMEMONO AND FIN_YEAR=@CFINYEAR
	
		IF ISNULL(@CPREVMEMONOSEARCH,'')='' AND @CMEMONO<>ISNULL(@CFIRSTMEMONO,'') AND ISNULL(@CFIRSTMEMONO,'')<>''
		BEGIN
			PRINT 'CHECK SERIES-6'
			SET @CERRORMSG='PREVIOUS MEMO NO. :'+@CPREVMEMONO+' NOT FOUND...CANNOT SAVE'
			
		END	
	END
END


	