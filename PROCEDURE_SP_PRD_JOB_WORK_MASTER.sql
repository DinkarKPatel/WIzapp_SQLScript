CREATE PROCEDURE  SP_PRD_JOB_WORK_MASTER
(
 @NMODE INT ,
 @JOB_CODE CHAR(7),
 @NART_TYPE INT=0,
 @CAC_CODE VARCHAR(100)='',
 @CARTICLE_CODE VARCHAR(100)=''

)
AS
BEGIN

IF @NMODE=1
GOTO LBLJOBMST 
ELSE
IF @NMODE=2
GOTO LBLJOBDET 
ELSE
IF @NMODE=3
GOTO LBLARTICLE 
      
     
   LBLJOBMST:
   
   SELECT A.JOB_CODE,A.JOB_NAME,
   CASE WHEN ISNULL(MST.ARTICLE_TYPE,0)=0 THEN 2 ELSE  MST.ARTICLE_TYPE END AS ARTICLE_TYPE,
   CASE WHEN ISNULL(MST.CALCULATION,0)=0 THEN 1 ELSE  MST.CALCULATION END AS CALCULATION,
   ISNULL(STD_RATE,0) AS STD_RATE,
   ISNULL(EXCEPTIONS,0) AS EXCEPTIONS
   FROM JOBS (NOLOCK) A
   LEFT OUTER JOIN PRD_JOB_RATE_MST (NOLOCK) MST ON A.JOB_CODE =MST.JOB_CODE
   WHERE A.JOB_CODE =@JOB_CODE 
   
   GOTO END_PROC   

   LBLJOBDET:
   
   SELECT A.JOB_CODE ,A.AGENCY_CODE ,B.AGENCY_NAME ,
          A.ARTICLE_CODE AS ARTICLE_CODE,
          AR.ARTICLE_NAME,
          AR.ARTICLE_NO,
          ISNULL(A.RATE,0) AS RATE,
          A.ROW_ID ROW_ID
   FROM PRD_JOB_RATE_DET A
   JOIN ARTICLE AR ON A.ARTICLE_CODE=AR.ARTICLE_CODE
   JOIN JOBS J ON J.JOB_CODE=A.JOB_CODE
   JOIN PRD_AGENCY_MST (NOLOCK) B ON A.AGENCY_CODE=B.AGENCY_CODE
   WHERE A.JOB_CODE =@JOB_CODE 
   AND (@CAC_CODE=''  OR B.AC_CODE =@CAC_CODE)
   AND (@CARTICLE_CODE='' OR AR.ARTICLE_CODE  =@CARTICLE_CODE)

   GOTO END_PROC  

LBLARTICLE:
     
     SELECT ARTICLE_NO,ARTICLE_NAME, ARTICLE_CODE 
     FROM ARTICLE 
     WHERE ARTICLE_TYPE =@NART_TYPE
 
    
END_PROC:
END
