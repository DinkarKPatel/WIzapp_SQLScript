CREATE PROCEDURE VALIDATEXN_ARC
(
		@CXNID VARCHAR(40),
		@NUPDATEMODE INT,
		@CCMD VARCHAR(1000) OUTPUT
		--*** PARAMETERS :
		--*** @CXNID - TRANSACTION ID ( MEMO ID OF MASTER TABLE )
)
--WITH ENCRYPTION
AS
BEGIN
	
	
	DECLARE @NPAYMODETOTAMT NUMERIC(14,2),@CERRORMSG VARCHAR(MAX),@CEXPRERRORMSG VARCHAR(MAX)
	
	IF @NUPDATEMODE NOT IN (1,4)
	BEGIN
		EXEC VALIDATEXN_ARC_BEFORE_EDIT @CXNID,0,@CERRORMSG OUTPUT,@CEXPRERRORMSG OUTPUT
		
		IF ISNULL(@CERRORMSG,'')<>''
		BEGIN
			SET @CCMD=@CERRORMSG
			
			IF ISNULL(@CEXPRERRORMSG,'')<>''
				EXEC SP_EXECUTESQL @CEXPRERRORMSG
			
			GOTO END_PROC	
		END
	END
	
	DECLARE @CARCTABLE TABLE ( ADV_REC_ID VARCHAR(22), ADV_REC_DT DATETIME, AMOUNT NUMERIC(10,2), 
							   DISCOUNT_AMOUNT NUMERIC(10,2), NET_AMOUNT NUMERIC(10,2), 
							   FIN_YEAR VARCHAR(10), CUSTOMER_CODE VARCHAR(20), CANCELLED BIT,AC_CODE VARCHAR(20),ARCT INT )
	INSERT @CARCTABLE
	SELECT ADV_REC_ID, ADV_REC_DT, AMOUNT, DISCOUNT_AMOUNT, NET_AMOUNT, FIN_YEAR, CUSTOMER_CODE, CANCELLED,AC_CODE,ARCT
	FROM ARC01106 WHERE ADV_REC_ID = @CXNID

	SET @CCMD = ''
	
	SELECT	@NPAYMODETOTAMT = SUM(A.AMOUNT)
	FROM PAYMODE_XN_DET A 
	JOIN PAYMODE_MST B ON A.PAYMODE_CODE = B.PAYMODE_CODE
	JOIN ARC01106 C ON C.ADV_REC_ID=A.MEMO_ID
	WHERE MEMO_ID = @CXNID AND XN_TYPE = 'ARC' AND (ARC_TYPE<>2 OR ISNULL(A.ADJ_MEMO_ID,'')='')




	SET @NPAYMODETOTAMT = ISNULL(@NPAYMODETOTAMT,0)

	IF EXISTS (SELECT ADV_REC_ID FROM @CARCTABLE WHERE NET_AMOUNT<>@NPAYMODETOTAMT)
		SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'NET AMOUNT PAID/RECEIVED SHOULD BE EQUAL TO THE SUM OF ALL PAYMENT MODES... '
	
	IF @NUPDATEMODE=4 --- No more validations required If called from Payment mode edit only
		GOTO END_PROC

	IF EXISTS (SELECT ADV_REC_ID FROM @CARCTABLE WHERE CUSTOMER_CODE IN ( '', '000000000000') AND AC_CODE IN ( '', '0000000000'))
		SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'CUSTOMER NAME SHOULD NOT BE EMPTY... '


	
	IF EXISTS (SELECT ADV_REC_ID FROM @CARCTABLE WHERE (AMOUNT<=0 OR NET_AMOUNT<0))
		SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'RECEIPT WITH INVALID AMOUNT ....PLEASE CHECK '

	IF EXISTS (SELECT ADV_REC_ID FROM @CARCTABLE WHERE (DISCOUNT_AMOUNT > AMOUNT))
		SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'DISCOUNT MORE THAN RECEIPT AMOUNT IS NOT ALLOWED... '

	IF EXISTS (SELECT ADV_REC_DT FROM @CARCTABLE WHERE FIN_YEAR<>'01'+DBO.FN_GETFINYEAR(ADV_REC_DT))
		SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'MISMATCH BETWEEN RECEIPT DATE & FIN YEAR ..... '


	IF EXISTS(SELECT TOP 1 'U' FROM @CARCTABLE A JOIN WSL_ORDER_ADV_RECEIPT B ON A.ADV_REC_ID=B.ADV_REC_ID
			  JOIN WSL_ORDER_MST C ON B.ORDER_ID=C.ORDER_ID WHERE A.CUSTOMER_CODE<>C.CUSTOMER_CODE)
		SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'CUSTOMER MISMATCH BETWEEN ADVANCE AND RETAIL ORDER FOUND.'	  

   IF EXISTS(SELECT TOP 1 'U' FROM @CARCTABLE A LEFT JOIN  ARC_GVSALE_DETAILS  B (nolock) ON A.ADV_REC_ID=B.adv_rec_id
			  WHERE ARCT=4 and ISNULL(B.gv_srno,'')=''  )
	SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+' Gift voucher can not be saved without Selecting GVNO.'	  
	
	IF OBJECT_ID('tempdb..#tmpRec','U') IS NOT NULL
		DROP TABLE #tmpRec
	
	SELECT cm_id INTO #tmpRec FROM cmm_credit_receipt (NOLOCK) WHERE adv_rec_id=@CXNID

	IF EXISTS (SELECT TOP 1 * FROM #tmpRec)
	BEGIN
		DECLARE @cBillno VARCHAR(15),@nRecAmt NUMERIC(10,2),@nBillAmt NUMERIC(10,2),@nRefundAmt NUMERIC(10,2)

		SELECT TOP 1 @cBillno=a.cm_no,@nBillAmt=b.amount,@nRecAmt=d.[RECEIPT_AMOUNT],
		@nRefundAmt=isnull(d1.[REfund_AMOUNT],0)  FROM CMM01106 A (NOLOCK)
		JOIN paymode_xn_det B (nolock) ON B.MEMO_ID = A.CM_ID
		JOIN #tmpRec  c (NOLOCK) ON c.cm_id=a.cm_id
		JOIN 
		(	
			SELECT A1.CM_ID,SUM(A1.RECEIPT_AMOUNT) AS [RECEIPT_AMOUNT]
			FROM CMM_CREDIT_RECEIPT A1 (NOLOCK)
			JOIN #tmpRec b ON a1.cm_id=b.cm_id
			JOIN arc01106 c (NOLOCK) ON c.adv_rec_id=a1.adv_rec_id
			WHERE c.cancelled=0
			GROUP BY A1.CM_ID 
		)D ON D.CM_ID = A.CM_ID
		LEFT OUTER JOIN 
		(	
			SELECT A.adj_memo_id as cm_id,SUM(A.AMOUNT) AS [REfund_AMOUNT]
			FROM PAYMODE_XN_DET A (NOLOCK)
			JOIN CMM01106 B (NOLOCK) ON B.CM_ID=A.MEMO_ID
			WHERE B.CANCELLED=0 AND a.paymode_code='CMR0001'
			GROUP BY A.adj_memo_id 
		)D1 ON D1.CM_ID = A.CM_ID
		WHERE paymode_code='0000004' AND (b.amount-(d.[RECEIPT_AMOUNT]+ISNULL(d1.refund_amount,0)))<0


		
		IF ISNULL(@cBillno,'')<>''
		BEGIN
			SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'Receipt amount against Bill no. :'+@cBillno+
			' is going more than Pending amount (Bill Amt:'+ltrim(rtrim(str(@nBillAmt,10,2)))+' Receive Amt :'+
			ltrim(rtrim(str(@nRecAmt,10,2)))+' Refund Amt :'+ltrim(rtrim(str(@nRefundAmt,10,2)))  	  
		END
		
	END
	
END_PROC:
END
--******************************************* END OF PROCEDURE VALIDATEXN_ARC
