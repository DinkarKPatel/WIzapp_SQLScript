CREATE PROCEDURE SP3S_MONTLY_RECONCILATION_REPORT
(
 @CDATE VARCHAR(100)='',
 @CLOCID VARCHAR(5)=''
)
AS
BEGIN
    DECLARE @DTSQL NVARCHAR(MAX),@CTABLENAME VARCHAR(100),@CFM_DT DATETIME,@CTO_DT DATETIME,@FIN_YEAR VARCHAR(10),
            @DTSQL1 NVARCHAR(MAX),@DTSQL2 NVARCHAR(MAX),@DTSQL3 NVARCHAR(MAX),@DTSQL4 NVARCHAR(MAX),
            @DTSQL5 NVARCHAR(MAX)
    
    SET @CTABLENAME=DB_NAME()+'_RFOPT.DBO.RF_OPT'


IF OBJECT_ID ('TEMPDB..#TMPTRAN','U') IS NOT NULL
   DROP TABLE #TMPTRAN
	   
	SELECT 
	 1 AS ORDER_NO,'PARTY PURCHASE' AS TRANS,	'PUR' AS XN_TYPE INTO #TMPTRAN UNION ALL
	SELECT 2, 'PARTY DEBIT NOTE',	'PRT' UNION ALL
	SELECT 3, 'GROUP TRANSFER IN','PUR_CHI' UNION ALL
	SELECT 4, 'GROUP TRANSFER OUT','RMM_CHO' UNION ALL
	SELECT 5, 'GROUP TRANSFER OUT','DNPS_CHO' UNION ALL
	SELECT 6, 'GROUP TRANSFER OUT','INM_CHO' UNION ALL
	SELECT 7, 'GROUP TRANSFER OUT','CNM_CHO' UNION ALL
	SELECT 5, 'RETAIL SALE',	'CMM_SLS' UNION ALL
	SELECT 6, 'RETAIL SALE RETURN','CMM_SLR' UNION ALL
	SELECT 7, 'RETAIL APPROVAL ISSUES','API' UNION ALL
	SELECT 8, 'RETAIL APPROVAL RETURN','APR' UNION ALL
	SELECT 9, 'PARTY WS INVOICE',	'WSI' UNION ALL
	SELECT 10, 'PARTY WS CREDIT NOTE',	'CNM_WSR' UNION ALL
	SELECT 11, 'CANCELLATION',	'CNC' UNION ALL
	SELECT 12, 'UN-CANCELLATION',	'UNC' UNION ALL
	SELECT 13, 'CONSUMPTION',	'IRM_CIP' UNION ALL
	SELECT 14, 'PRODUCTION',	'IRM_PFI' UNION ALL
	SELECT 15, 'JOB WORK ISSUE',	'JWI' UNION ALL
	SELECT 16, 'JOB WORK RETURN',	'JWR' UNION ALL
	SELECT 16, 'APPROVAL ISSUE',	'APP' UNION ALL
    SELECT 17, 'APPROVAL RETURN',	'APR'
   
   
     SELECT @CFM_DT=CONVERT(VARCHAR(11),MIN(FM_DT) ,120) ,@CTO_DT=CONVERT(VARCHAR(11),MAX(TO_DT) ,120) FROM MONTHLY_RECONCILATION_LOC

      
      SELECT A.DEPT_ID AS LOCATION_ID,A.XN_TYPE ,A.XN_QTY AS QTY ,A.TRANS,A.MTHNAME,
              XN_QTY=ISNULL(XN_QTY,0) -ISNULL(B.RF_XN_QTY,0) 
	     FROM
		 (
		  SELECT A.DEPT_ID,A.XN_TYPE ,C.TRANS,
		  RIGHT(CAST(YEAR(FM_DT) AS VARCHAR(5)),2)+'_'+CASE WHEN MONTH(FM_DT)<10 THEN '0'+ CAST(MONTH(FM_DT) AS VARCHAR(2)) ELSE CAST(MONTH(FM_DT) AS VARCHAR(2)) END AS MTHNAME
		  ,SUM(CONVERT(NUMERIC(12,3),(ISNULL(A.XN_QTY,0)))) AS  XN_QTY
		  FROM MONTHLY_RECONCILATION_LOC A
          LEFT OUTER JOIN #TMPTRAN C ON A.XN_TYPE =C.XN_TYPE 
          WHERE (@CLOCID='' OR A.DEPT_ID=@CLOCID)
          GROUP BY A.DEPT_ID,A.XN_TYPE,C.TRANS,
		  RIGHT(CAST(YEAR(FM_DT) AS VARCHAR(5)),2)+'_'+CASE WHEN MONTH(FM_DT)<10 THEN '0'+ CAST(MONTH(FM_DT) AS VARCHAR(2)) ELSE CAST(MONTH(FM_DT) AS VARCHAR(2)) END
		 ) A
		 LEFT OUTER JOIN
		 (
		  
		  SELECT  A.DEPT_ID,A.XN_TYPE,
		  RIGHT(CAST(YEAR(FM_DT) AS VARCHAR(5)),2)+'_'+CASE WHEN MONTH(FM_DT)<10 THEN '0'+ CAST(MONTH(FM_DT) AS VARCHAR(2)) ELSE CAST(MONTH(FM_DT) AS VARCHAR(2)) END AS MTHNAME,
	      CONVERT(NUMERIC(12,3),SUM(ISNULL(A.XN_QTY,0))) AS  RF_XN_QTY 
	      FROM DBO.MONTHLY_RECONCILATION_HO A
	      GROUP BY A.DEPT_ID,A.XN_TYPE,
		  RIGHT(CAST(YEAR(FM_DT) AS VARCHAR(5)),2)+'_'+CASE WHEN MONTH(FM_DT)<10 THEN '0'+ CAST(MONTH(FM_DT) AS VARCHAR(2)) ELSE CAST(MONTH(FM_DT) AS VARCHAR(2)) END
		  ) B ON A.DEPT_ID =B.DEPT_ID AND A.MTHNAME=B.MTHNAME AND A.XN_TYPE=B.XN_TYPE
		 ORDER BY A.MTHNAME DESC

END
