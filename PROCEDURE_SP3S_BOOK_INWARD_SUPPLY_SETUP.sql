CREATE PROCEDURE SP3S_BOOK_INWARD_SUPPLY_SETUP
(
 @NQUERY    NUMERIC(2),        
 @CWHERE    NVARCHAR(MAX)='' 
)
   AS 
  BEGIN

DECLARE @DT DATETIME,@DT_STR VARCHAR(10)
SET @DT='2099-12-31'
IF @NQUERY=6
   BEGIN
	 SET @DT_STR=LEFT(@CWHERE,10)
	 IF @CWHERE<>''
		SET @DT=SUBSTRING(@DT_STR,7,4)+'-'+SUBSTRING(@DT_STR,4,2)+'-'+SUBSTRING(@DT_STR,1,2)
   END		
  
IF @NQUERY=1          
	GOTO LBLMST        
ELSE IF @NQUERY=2        
	GOTO LBLDET        
ELSE IF @NQUERY=3       
	GOTO LBLLOC 
ELSE IF @NQUERY=4        
	GOTO LBLSUPPLIER
ELSE IF @NQUERY=5       
	GOTO LBLSUPPLY
ELSE IF @NQUERY=6      
	GOTO LBLHSN
ELSE IF @NQUERY=7
	GOTO LBLUOM
ELSE IF @NQUERY=8
	GOTO LBLALLMEMO
ELSE IF @NQUERY=9
	GOTO LBLMSTDET


LBLMST:

	  SELECT A.*,B.TDS_NAME FROM SUPPLY_EXPENSE_XN_MST A 
	  LEFT OUTER JOIN TDS_SECTION B ON A.TDS_CODE= B.TDS_CODE WHERE MEMO_ID=@CWHERE 
	  
	  GOTO ENDPROC 
  
LBLDET:

        SELECT A.*,B.SUPPLY_NAME,C.UOM_NAME,'' TAXTYPE 
          FROM SUPPLY_EXPENSE_XN_DET A JOIN SUPPLY_EXPENSE_MST B ON A.SUPPLY_CODE=B.SUPPLY_CODE 
          JOIN UOM C ON C.UOM_CODE=A.UOM_CODE    
		WHERE MEMO_ID= @CWHERE AND B.INACTIVE=0 AND C.INACTIVE=0
		GOTO ENDPROC 
		
		    
LBLLOC:

          SELECT DEPT_ID,DEPT_NAME FROM LOCATION WHERE INACTIVE=0
		   
		  GOTO ENDPROC
		  		  
LBLSUPPLIER:
		SELECT LM.AC_CODE,LM.AC_NAME ,
		 ISNULL(ACC.ADDRESS0,'') + ' ' + ISNULL(ACC.ADDRESS1,'') + ' ' + ISNULL(ACC.ADDRESS2,'') + ' ' + 
		    ISNULL(ACC.AREA_NAME,'') + ' ' + ISNULL(ACC.CITY,'') + ' ' +   
			ISNULL(ACC.STATE,'') AS SUPP_ADDRESS,
			ISNULL(ACC.AC_GST_NO,'') AS AC_GST_NO
		FROM LM01106 LM
		LEFT OUTER JOIN LMV01106 ACC ON ACC.AC_CODE=LM.AC_CODE
		GOTO ENDPROC


LBLSUPPLY:
				
		SELECT SUPPLY_CODE,SUPPLY_NAME,INPUT_GST_CREDIT FROM SUPPLY_EXPENSE_MST
		WHERE  INACTIVE=0
		GOTO ENDPROC
		
LBLHSN:
				
   --SELECT A.HSN_CODE,B.TAX_PERCENTAGE 
   --FROM HSN_MST A (NOLOCK) 
   --JOIN HSN_DET B (NOLOCK) ON A.HSN_CODE=B.HSN_CODE  
   ;WITH CTE AS
   (SELECT A.HSN_CODE,ISNULL(B.TAX_PERCENTAGE,0) AS TAX_PERCENTAGE
    ,RNO=ROW_NUMBER()OVER(PARTITION BY A.HSN_CODE ORDER BY B.WEF DESC)
    FROM HSN_MST A (NOLOCK) 
    LEFT OUTER JOIN HSN_DET B (NOLOCK) ON A.HSN_CODE=B.HSN_CODE  
    WHERE ISNULL(B.WEF,'')<@DT OR A.TAXABLE_ITEM= 0
   ) 
   SELECT HSN_CODE,TAX_PERCENTAGE FROM CTE WHERE RNO=1 AND HSN_CODE <> '' ORDER BY 1
   GOTO ENDPROC
    		
LBLUOM:
				
	SELECT UOM_CODE,UOM_NAME FROM UOM WHERE INACTIVE=0
	GOTO ENDPROC
		
LBLALLMEMO:

        SELECT MEMO_NO,MEMO_ID FROM SUPPLY_EXPENSE_XN_MST
         GOTO ENDPROC 	
        
LBLMSTDET:
   
       SELECT B.AC_NAME,DEPT_NAME,D.USERNAME,A.AC_CODE,BILL_NO,BILL_DT,MEMO_ID,MEMO_NO
			,MEMO_DT,A.DEPT_ID,CANCELLED,TOTAL_AMOUNT,A.ROUND_OFF
		   ,A.USER_CODE,A.FIN_YEAR ,
		    ISNULL(ACC.ADDRESS0,'') + ' ' + ISNULL(ACC.ADDRESS1,'') + ' ' + ISNULL(ACC.ADDRESS2,'') + ' ' + 
		    ISNULL(ACC.AREA_NAME,'') + ' ' + ISNULL(ACC.CITY,'') + ' ' +   
			ISNULL(ACC.STATE,'') AS SUPP_ADDRESS,
			ISNULL(ACC.AC_GST_NO,'') AS AC_GST_NO,T.TDS_NAME ,A.TDS_CODE,A.TDS_AMOUNT,A.MANUAL_ROUND_OFF
		   
		   FROM SUPPLY_EXPENSE_XN_MST A 
       JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
       LEFT OUTER JOIN LMV01106 ACC ON ACC.AC_CODE=B.AC_CODE
       JOIN LOCATION C ON C.DEPT_ID=A.DEPT_ID
       JOIN USERS D ON D.USER_CODE=A.USER_CODE
       LEFT OUTER JOIN TDS_SECTION T ON A.TDS_CODE= T.TDS_CODE
       WHERE MEMO_ID=@CWHERE
        
        
       SELECT SUPPLY_NAME,UOM_NAME,MEMO_ID,A.SUPPLY_CODE,HSN_CODE,GST_PERCENTAGE,QUANTITY,A.UOM_CODE,
       RATE,IGST_AMOUNT,CGST_AMOUNT,SGST_AMOUNT,XN_VALUE_WITHOUT_GST,XN_VALUE_WITH_GST,NARRATION,
       A.INPUT_GST_CREDIT AS INPUT_GST_CREDIT, ROW_ID,GST_CALC_TAX_METHOD FROM SUPPLY_EXPENSE_XN_DET A 
       JOIN SUPPLY_EXPENSE_MST B ON A.SUPPLY_CODE=B.SUPPLY_CODE
      LEFT JOIN UOM C ON C.UOM_CODE=A.UOM_CODE 
       
       WHERE MEMO_ID=@CWHERE
        GOTO ENDPROC        					

ENDPROC:
  
END
