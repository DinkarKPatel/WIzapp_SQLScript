CREATE PROCEDURE SP3S_GETITEMS_REPAIR_N_DEFECTIVE
(
	@clocId			VARCHAR(10)='',
	@cSPID			varchar(50)='',
	@cProductCode	varchar(50)='',
	@cForDeptID		VARCHAR(50)='',
	@bShowAllData	BIT=0
)
AS
BEGIN
	DECLARE @cHOID VARCHAR(5)
	SELECT @cHOID=VALUE FROM CONFIG WHERE CONFIG_OPTION ='HO_LOCATION_ID'
	DELETE FROM WSL_ITEM_DETAILS WHERE SP_ID=@cSPID

	INSERT WSL_ITEM_DETAILS	(  BIN_ID, PRODUCT_CODE, quantity,sp_id)  
	SELECT B.BIN_ID, B.PRODUCT_CODE, QUANTITY_IN_STOCK,@cSPID 
	FROM PMT01106 B
	LEFT OUTER JOIN HOLD_BACK_DELIVER_DET C  (NOLOCK) ON C.product_code =B.product_code 
	WHERE B.BIN_ID='999' AND QUANTITY_IN_STOCK>0 AND DEPT_ID=@clocId
	AND (@cProductCode='' OR B.product_code=@cProductCode)
    AND  @bShowAllData=1
	AND @cHOID<>@clocid
	AND C.product_code IS NULL

	INSERT WSL_ITEM_DETAILS	(  BIN_ID, PRODUCT_CODE, quantity,sp_id)  
	SELECT B.BIN_ID, B.PRODUCT_CODE, QUANTITY_IN_STOCK,@cSPID 
	FROM PMT01106 B
	JOIN HOLD_BACK_DELIVER_DET C  (NOLOCK) ON C.product_code =B.product_code 
	JOIN HOLD_BACK_DELIVER_MST D (NOLOCK) ON D.MEMO_ID =C.MEMO_ID 
	WHERE C.delivered=0 AND  B.BIN_ID='999' AND QUANTITY_IN_STOCK>0 AND DEPT_ID=@clocId
	AND (@cProductCode='' OR B.product_code=@cProductCode)
    AND D.cancelled=0 AND ((@cHOID=@clocid AND ISNULL(c.HBD_STATUS,0)>1 
	AND ( LEFT(B.product_code,2)=@cForDeptID  or @bShowAllData=1)   ))
	/*
	--OR (  @bShowAllData=1)   )
	MAtterMost : vivekborar 20-12-2024 4:26 PM
	DAMILANO 
	REPAIR BARCODE NOT SHOWING IN REPAIR USER BUT SHOWING IN ADMIN USER
	KINDLY CHECK AND SOLVE THIS ON URGENT BASIS
	BARCODE NO - D7-RPR-905
	*/
	INSERT WSL_ITEM_DETAILS	(  BIN_ID, PRODUCT_CODE, quantity,sp_id)  
	SELECT B.BIN_ID, B.PRODUCT_CODE, QUANTITY_IN_STOCK,@cSPID 
	FROM PMT01106 B
	JOIN HOLD_BACK_DELIVER_DET C  (NOLOCK) ON C.product_code =B.product_code 
	JOIN HOLD_BACK_DELIVER_MST D (NOLOCK) ON D.MEMO_ID =C.MEMO_ID 
	WHERE C.delivered=0 AND  B.BIN_ID='999' AND QUANTITY_IN_STOCK>0 AND DEPT_ID=@clocId
	AND (@cProductCode='' OR B.product_code=@cProductCode)
	AND D.cancelled=0 AND (@cHOID<>@clocid AND (ISNULL(c.HBD_STATUS,0)= 0 OR ISNULL(@bShowAllData,0)=1))

	--SELECT * FROM WSL_ITEM_DETAILS WHERE SP_ID=@cSPID
	
	EXEC SP3S_GETWSL_DATA @NBOXNO=1,@NSPID=@cSPID,@NMODE=1,@NPASTE=1,@cLOCID=@clocId,@BNOOUTPUT=1

	SELECT A.* ,D.memo_no AS HBD_MEMO_NO,CONVERT(VARCHAR(25),C.DELIVERY_DT ,105) DELIVERY_DT ,CUST.customer_fname ,CUST.customer_lname ,CUST.mobile,JOBS.JOB_NAME
	FROM WSL_ITEM_DETAILS A 
	LEFT OUTER JOIN HOLD_BACK_DELIVER_DET C  (NOLOCK) ON C.product_code =A.PRODUCT_CODE
	LEFT OUTER JOIN HOLD_BACK_DELIVER_MST D (NOLOCK) ON D.MEMO_ID =C.MEMO_ID  AND D.CANCELLED =0
	LEFT OUTER JOIN CUSTDYM CUST (NOLOCK) ON CUST .CUSTOMER_CODE =D.CUSTOMER_CODE 
	LEFT OUTER JOIN JOBS (NOLOCK) ON JOBS.job_code =C.job_code 
	--LEFT OUTER JOIN ITEM_STATUS B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
	WHERE SP_ID=@CSPID
END