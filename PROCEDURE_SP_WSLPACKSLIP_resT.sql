CREATE PROCEDURE SP_WSLPACKSLIP_resT--(LocId 3 digit change only increased the parameter width by Sanjay:04-11-2024)
 @NQUERYID NUMERIC (3,0) ,  
 @CMEMOID VARCHAR(40) = '',  
 @CWHERE  VARCHAR(500) = '',
 @NNAVMODE NUMERIC(1,0) = 0,  
 @CFINYEAR VARCHAR(5)='',
 @CLOCID varchar(4)=''
--WITH ENCRYPTION
AS  
BEGIN  
  
IF @NQUERYID = 6  
GOTO LBLSTOCKDETAILS  
  
ELSE IF @NQUERYID = 8  
GOTO LBLREPORTS  
  
ELSE IF @NQUERYID = 9  
GOTO LBLPRODUCTCODELIST  

ELSE IF @NQUERYID = 10    
GOTO LBLWPSMSTREP    
    
ELSE IF @NQUERYID = 11
GOTO LBLWPSDETREP 
    
ELSE IF @NQUERYID = 12  
GOTO LBL12       
  
ELSE IF @NQUERYID = 13  
GOTO LBLARTICLELIST 

ELSE IF @NQUERYID = 14  
GOTO LBLCOLORLIST 

ELSE IF @NQUERYID = 15  
GOTO LBLSIZELIST 

ELSE IF @NQUERYID = 16  
GOTO LBLORDERMST

ELSE IF @NQUERYID = 17  
GOTO LBLORDERDET
ELSE IF @NQUERYID = 18  
GOTO LBLXNBOXDETAILS  
    
ELSE    
GOTO LAST    

LBLXNBOXDETAILS:

	--SELECT *,CAST('' AS VARCHAR(50)) AS SP_ID FROM xnBoxDetails WHERE xn_type='WPS' AND Ref_memo_id=@CWHERE
	EXEC SP_WSLPACKSLIP_18 @CWHERE=@CWHERE
GOTO LAST

 
LBLGETMASTER:  
  
	--SELECT T1.*,T2.USERNAME,T4.AC_NAME,T4.ADDRESS0,T4.ADDRESS1,T4.ADDRESS2,     
	--T4.AREA_NAME,T4.CITY,T4.[STATE],T4.PINCODE,ISNULL(T6.DEPT_NAME,'') AS DEPT_NAME ,T6.DEPT_ID   
	--,ISNULL(T7.PS_ID,'') AS REF_PS_ID ,ISNULL(T7.INV_NO,'') AS REF_INV_NO,BIN.BIN_NAME    
	--FROM WPS_MST T1     
	--JOIN USERS T2  ON T1.USER_CODE = T2.USER_CODE    
	--JOIN LMV01106 T4 ON T4.AC_CODE = T1.AC_CODE    
	--LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=T1.TARGET_BIN_ID      
	--LEFT OUTER JOIN LOCATION T6 ON T6.DEPT_ID = T1.PARTY_DEPT_ID    
	--LEFT OUTER JOIN   
	--(
	--SELECT A.PS_ID,B.INV_NO FROM IND01106 A 
	--JOIN INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID 
	--WHERE B.CANCELLED=0
	--GROUP BY A.PS_ID,B.INV_NO 
	--) T7 ON T1.PS_ID = T7.PS_ID    
	--WHERE T1.PS_ID = @CMEMOID   
	
	
	
	SELECT T1.*,T2.USERNAME,T5.AC_NAME,T4.ADDRESS0,T4.ADDRESS1,T4.ADDRESS2,     
	lm_area.AREA_NAME,lm_city.CITY,lm_state.[STATE],lm_area.PINCODE,ISNULL(T6.DEPT_NAME,'') AS DEPT_NAME ,T6.DEPT_ID   
	,ISNULL(T7.PS_ID,'') AS REF_PS_ID ,ISNULL(T7.INV_NO,'') AS REF_INV_NO,BIN.BIN_NAME,
	 AG.ANGADIA_NAME,AG.INSURANCE_PERCENTAGE ,
    T4.CREDIT_DAYS,T4.DISCOUNT_PERCENTAGE AS LM_DISC_PER,T4.TIN_NO  
    , LMB.AC_NAME AS BROKER_AC_NAME,CAST('' AS varchar(50)) AS SP_ID
	FROM WPS_MST T1 (nOlOck)    
	JOIN USERS T2  (nOlOck)  ON T1.USER_CODE = T2.USER_CODE    
	JOIN LMp01106 T4 (nOlOck) ON T4.AC_CODE = T1.AC_CODE    
	JOIN LM01106 T5 (nOlOck) ON T5.AC_CODE = T1.AC_CODE    
	join area lm_area (nolock) on lm_area.area_code=t4.area_code
	join city lm_city (nolock) on lm_city.city_code=lm_area.city_code
	join state lm_sTAte (nolock) on lm_sTAte.StaTE_code=lm_cItY.State_code
	LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=T1.TARGET_BIN_ID      
	LEFT OUTER JOIN LOCATION T6 ON T6.DEPT_ID = T1.PARTY_DEPT_ID    
	LEFT OUTER JOIN   
	(
	SELECT A.PS_ID,B.INV_NO FROM IND01106 A 
	JOIN INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID 
	jOin wps_mst c (NolOCK) oN c.ps_id=a.ps_id ---Join with wps_mst taken which was missing (Sanjay)
	WHERE c.ps_id=@CMEMOID AnD B.CANCELLED=0
	GROUP BY A.PS_ID,B.INV_NO 
	) T7 ON T1.PS_ID = T7.PS_ID  
	--LEFT JOIN AREA AR ON T1.SHIPPING_AREA_CODE=AR.AREA_CODE
 --   LEFT JOIN CITY CT ON CT.CITY_CODE=AR.CITY_CODE
 --   LEFT JOIN STATE ST ON CT.STATE_CODE=ST.STATE_CODE
    LEFT JOIN ANGM AG ON AG.ANGADIA_CODE=T1.ANGADIA_CODE  
    LEFT OUTER JOIN LMV01106 LMB ON  T1.BROKER_AC_CODE= LMB.AC_CODE   
	WHERE T1.PS_ID = @CMEMOID   
	
	
	
   
GOTO LAST  
  
  
LBLSTOCKDETAILS:  
  
 --SELECT *  
 --FROM PMT01106 T1  
 --JOIN PMV01106 T2 ON T1.PRODUCT_CODE = T2.PRODUCT_CODE  
 --WHERE T1.QUANTITY_IN_STOCK > 0  
 SELECT T1.*,T1.PRODUCT_CODE, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, S.PARA1_CODE,    
    C.PARA1_NAME, S.PARA2_CODE, D.PARA2_NAME, S.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,       
    T1.DEPT_ID, S.BARCODE_CODING_SCHEME AS CODING_SCHEME,  B.INACTIVE, T1.QUANTITY_IN_STOCK,    
    S.PURCHASE_PRICE,  S.MRP,S.WS_PRICE,  '' AS SCHEME_ID, SM.SECTION_NAME, SD.SUB_SECTION_NAME,    
    S.PARA4_CODE,S.PARA5_CODE,S.PARA6_CODE,    
    PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],    
    B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],S.DT_CREATED AS [SKU_DT_CREATED],    
    B.STOCK_NA,S.FIX_MRP,S.PRODUCT_NAME,B.ALIAS AS ARTICLE_ALIAS   
 FROM PMT01106 T1 (nolock)  
 JOIN SKU S (nolock) ON T1.PRODUCT_CODE = S.PRODUCT_CODE     
 JOIN ARTICLE B (nolock) ON S.ARTICLE_CODE = B.ARTICLE_CODE      
 JOIN SECTIOND SD (nolock) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
 JOIN SECTIONM SM (nolock) ON SD.SECTION_CODE = SM.SECTION_CODE    
 JOIN PARA1 C (nolock) ON S.PARA1_CODE = C.PARA1_CODE      
 JOIN PARA2 D (nolock) ON S.PARA2_CODE = D.PARA2_CODE      
 JOIN PARA3 F (nolock) ON S.PARA3_CODE = F.PARA3_CODE      
 JOIN PARA4 G (nolock) ON S.PARA4_CODE = G.PARA4_CODE      
 JOIN PARA5 H (nolock) ON S.PARA5_CODE = H.PARA5_CODE      
 JOIN PARA6 I (nolock) ON S.PARA6_CODE = I.PARA6_CODE      
 JOIN UOM   E (nolock) ON B.UOM_CODE = E.UOM_CODE     
 WHERE T1.QUANTITY_IN_STOCK > 0  
GOTO LAST  
  
LBLREPORTS:  
  
 SELECT * FROM VW_WL_WSLINV WHERE MST_MEMO_NO = @CMEMOID  
  
GOTO LAST  
  
LBLPRODUCTCODELIST:  
  
 SELECT T3.ARTICLE_NO,T1.PRODUCT_CODE,T4.SUB_SECTION_NAME,T5.SECTION_NAME,T3.ARTICLE_CODE,
 T3.ALIAS AS ARTICLE_ALIAS   
 FROM SKU T1 (nolock)   
 LEFT OUTER JOIN PMT01106 T2 (nolock) ON T1.PRODUCT_CODE = T2.PRODUCT_CODE  
 JOIN ARTICLE T3 (nolock) ON T1.ARTICLE_CODE = T3.ARTICLE_CODE  
 JOIN SECTIOND T4 (nolock) ON T3.SUB_SECTION_CODE = T4.SUB_SECTION_CODE  
 JOIN SECTIONM T5 (nolock) ON T5.SECTION_CODE = T4.SECTION_CODE  
 WHERE T1.PRODUCT_CODE <> '' AND T2.QUANTITY_IN_STOCK > 0  
 AND T2.DEPT_ID=@CWHERE
 ORDER BY  T1.PRODUCT_CODE     
   
 GOTO LAST  

LBLWPSMSTREP:
    SELECT TOP 1 A.*    
    FROM VW_WPS_MST  A  
    WHERE A.PS_ID=@CMEMOID 
   GOTO LAST
   
LBLWPSDETREP:

   SELECT A.*,ROW_NUMBER() OVER (PARTITION BY A.PS_ID ORDER BY A.TS)  AS SR_NO_NEW  
    FROM VW_WPS_DET A  WHERE PS_ID=@CMEMOID 
   GOTO LAST
   
   
   
LBL12:  
   
   SELECT TOP 1 B.INV_ID  FROM WPS_MST A
   JOIN IND01106 B ON B.PS_ID=A.PS_ID
   WHERE A.PS_ID=@CWHERE
   
   
   GOTO LAST  
   
LBLARTICLELIST:
	
	SELECT DISTINCT S.ARTICLE_CODE ,A.ARTICLE_NO 
	FROM SKU S (nolock) JOIN  ARTICLE A (nolock) ON S.ARTICLE_CODE = A.ARTICLE_CODE 
	JOIN PARA1 P1 (nolock) ON S.PARA1_CODE = P1.PARA1_CODE 
	JOIN PARA2 P2 (nolock) ON S.PARA2_CODE = P2.PARA2_CODE 
	WHERE SUBSTRING(S.PRODUCT_CODE,3,3) = 'XNS'	ORDER BY A.ARTICLE_NO
 
 GOTO LAST
 
 LBLCOLORLIST:
	
	SELECT DISTINCT S.PARA1_CODE ,P1.PARA1_NAME 
	FROM SKU S (nolock) JOIN  ARTICLE A (nolock) ON S.ARTICLE_CODE = A.ARTICLE_CODE 
	JOIN PARA1 P1 (nolock) ON S.PARA1_CODE = P1.PARA1_CODE 
	JOIN PARA2 P2 (nolock) ON S.PARA2_CODE = P2.PARA2_CODE 
	WHERE SUBSTRING(S.PRODUCT_CODE,3,3) = 'XNS' ORDER BY P1.PARA1_NAME 
 
 GOTO LAST
 
 LBLSIZELIST:
	
	SELECT DISTINCT S.PARA2_CODE ,P2.PARA2_NAME 
	FROM SKU S (nolock) JOIN  ARTICLE A (nolock) ON S.ARTICLE_CODE = A.ARTICLE_CODE 
	JOIN PARA1 P1 (nolock) ON S.PARA1_CODE = P1.PARA1_CODE 
	JOIN PARA2 P2 (nolock) ON S.PARA2_CODE = P2.PARA2_CODE 
	WHERE SUBSTRING(S.PRODUCT_CODE,3,3) = 'XNS' ORDER BY P2.PARA2_NAME 
 
 GOTO LAST
 
 LBLORDERMST:
		
      
    SELECT A.ORDER_ID AS PO_ID, A.ORDER_NO AS PO_NO, A.ORDER_DT AS PO_DT,A.REF_NO 
    FROM WSL_ORDER_MST A (nolock)
    WHERE ORDER_ID IN 
    (
		SELECT A.ORDER_ID 
		FROM WSL_ORDER_DET A (nolock) JOIN WSL_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
		JOIN SKU S (nolock) ON S.ARTICLE_CODE = A.ARTICLE_CODE AND S.PARA1_CODE = A.PARA1_CODE AND S.PARA2_CODE = A.PARA2_CODE
		JOIN PMT01106 PMT (nolock) ON PMT.PRODUCT_CODE = S.PRODUCT_CODE 
		LEFT OUTER JOIN 
		(
			SELECT A.REF_WO_DET_ROW_ID,SUM(A.QUANTITY) AS PUR_QTY FROM
			WPS_DET A (nolock) JOIN WPS_MST B ON A.PS_ID =B.PS_ID 
			WHERE B.AC_CODE=@CWHERE 
			AND CANCELLED=0 GROUP BY REF_WO_DET_ROW_ID
		)  C ON A.ROW_ID = C.REF_WO_DET_ROW_ID 
		WHERE B.AC_CODE= @CWHERE AND PMT.DEPT_ID = @CMEMOID 
		AND SUBSTRING(S.PRODUCT_CODE,3,3) = 'XNS' AND PMT.QUANTITY_IN_STOCK > 0
		AND A.QUANTITY-ISNULL(C.PUR_QTY,0)>0  
	)
	ORDER BY PO_DT DESC     
      
	
 GOTO LAST
 
 LBLORDERDET:
	SELECT POM.ORDER_ID AS PO_ID, K.SECTION_NAME, J.SUB_SECTION_NAME, I.UOM_CODE,I.UOM_NAME, C.PARA1_NAME,  
	D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,B.ARTICLE_NO,   
	B.ARTICLE_NAME, S.BARCODE_CODING_SCHEME AS CODING_SCHEME,B.STOCK_NA, A.WS_PRICE AS RATE,S.PRODUCT_CODE,S.MRP,A.*,A.WS_PRICE * A.QUANTITY AS 'AMOUNT'  ,
	ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],
	CAST( 0 AS BIT) AS CHECKED,(A.QUANTITY-ISNULL(PI.PUR_QTY,0))  AS PO_QTY,
	CAST( 0 AS NUMERIC(10,2))  AS PO_SCHEME_QUANTITY,
	(A.QUANTITY-ISNULL(PI.PUR_QTY,0)) AS REC_QTY,B.STOCK_NA,A.WS_PRICE AS [WHOLESALE_PRICE],
	B.ALIAS AS ARTICLE_ALIAS 
	FROM WSL_ORDER_DET A (NOLOCK) 
	JOIN WSL_ORDER_MST POM (NOLOCK) ON A.ORDER_ID = POM.ORDER_ID 
	JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE   
	JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE  
	JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE  
	JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE  
	JOIN PARA4 F (NOLOCK) ON A.PARA4_CODE = F.PARA4_CODE  
	JOIN PARA5 G (NOLOCK) ON A.PARA5_CODE = G.PARA5_CODE  
	JOIN PARA6 H (NOLOCK) ON A.PARA6_CODE = H.PARA6_CODE  
	JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE  
	JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE  
	JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE		
	--JOIN FORM FRM (NOLOCK) ON FRM.FORM_ID=A.FORM_ID 
	JOIN SKU S (nolock) ON S.ARTICLE_CODE = A.ARTICLE_CODE AND S.PARA1_CODE = A.PARA1_CODE AND S.PARA2_CODE = A.PARA2_CODE
	JOIN PMT01106 PMT (nolock) ON PMT.PRODUCT_CODE = S.PRODUCT_CODE 
	LEFT OUTER JOIN 
	(
		SELECT REF_WO_DET_ROW_ID,SUM(QUANTITY) AS PUR_QTY FROM
		WPS_DET A (nolock) JOIN WPS_MST B (nolock) ON A.PS_ID=B.PS_ID
		WHERE B.AC_CODE=@CWHERE 	AND CANCELLED=0 
		GROUP BY REF_WO_DET_ROW_ID
	
	) PI ON A.ROW_ID = PI.REF_WO_DET_ROW_ID 
	 	
	WHERE POM.AC_CODE= @CWHERE  AND PMT.DEPT_ID = @CMEMOID 
	AND SUBSTRING(S.PRODUCT_CODE,3,3) = 'XNS' AND PMT.QUANTITY_IN_STOCK > 0
	AND A.QUANTITY-ISNULL(PI.PUR_QTY,0)>0  
 GOTO LAST
 
 
  LAST:  
END
