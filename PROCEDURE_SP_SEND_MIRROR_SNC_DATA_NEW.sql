create PROCEDURE SP_SEND_MIRROR_SNC_DATA_NEW  
(  
 @CUPLOADEDXNID VARCHAR(50)  
,@CCURLOCID VARCHAR(5)  
,@BACKNOWLEDGE BIT=0  
,@CERRMSG VARCHAR(1000) OUTPUT  
)  
AS  
BEGIN  
DECLARE @DTSQL NVARCHAR(MAX),@NSPID INT,@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),  
@CTEMPEMPLOYEETABLE VARCHAR(200),@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),  
@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX),  
@CTEMPMASTERTABLE VARCHAR(200),@CTEMPDETAILTABLE VARCHAR(200),@CTEMPLMTABLE VARCHAR(200),  
@CTEMPLMPTABLE VARCHAR(200),@CTEMPAREATABLE VARCHAR(200),@CTEMPCITYTABLE VARCHAR(200),  
@CTEMPSKUTABLE VARCHAR(200),@CTEMPARTTABLE VARCHAR(200),@CTEMPSDTABLE VARCHAR(200),  
@CTEMPARTATTRTABLE VARCHAR(200),@CTEMPDETAILTABLE1 VARCHAR(200),@CTEMPDETAILTABLE2 VARCHAR(200),  
@CTEMPSNCARTICLETABLE VARCHAR(200),@CTEMPSNCSKUTABLE VARCHAR(200),@CTEMPSNCBARCODETABLE VARCHAR(200),  
@CTEMPART_ATTRTABLE VARCHAR(500)  ,@CTEMPDBNAME varchar(100)
  

BEGIN TRY  
SET @CSTEP=00  
  

 set @CTEMPDBNAME=''
--CHNAGE BY BAIJNATH  
SET @CMEMOID=@CUPLOADEDXNID  
  
SET @CSTEP=40  
---- IF NO MEMO FOUND , JUST END THE PROCESS  
IF ISNULL(@CMEMOID,'')=''  
GOTO END_PROC  
  
LBLTABLEINFO:  
SET @CSTEP=50  

---- SEND THE SNC MEMO MASTER TABLE  
SELECT DISTINCT 'SNC_SNC_MST_MIRROR' AS TARGET_TABLENAME,A.*  FROM SNC_MST  A (NOLOCK)  WHERE A.MEMO_ID  =@CMEMOID  
    
  
SET @CSTEP=240  
---- SEND THE SNC_BARCODE_DET TABLE  
SELECT DISTINCT 'SNC_SNC_CONSUMABLE_DET_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID  FROM SNC_CONSUMABLE_DET  A (NOLOCK)  WHERE A.MEMO_ID  =@CMEMOID  

--SELECT * FROM TMP_SNC_SNC_CONSUMABLE_DET_0201115000000200000002  
  
SET @CSTEP=300  
---- SEND THE SNC MEMO DETAIL TABLE  
SELECT DISTINCT 'SNC_SNC_DET_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID  FROM SNC_DET  A (NOLOCK)  WHERE A.MEMO_ID  =@CMEMOID  
  
SET @CSTEP=320  
---- SEND THE SNC MEMO DETAIL TABLE  

SELECT DISTINCT 'SNC_SNC_BARCODE_DET_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID  
FROM SNC_BARCODE_DET  A (NOLOCK)
JOIN SNC_DET B (NOLOCK) ON A.REFROW_ID =B.ROW_ID 
WHERE B.MEMO_ID =@CMEMOID

SET @CSTEP=325  


SELECT DISTINCT 'SNC_SKU_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID  
FROM SKU A
JOIN SNC_BARCODE_DET  B (NOLOCK) ON A.product_code =B.PRODUCT_CODE 
JOIN SNC_DET C (NOLOCK) ON B.REFROW_ID =C.ROW_ID 
WHERE C.MEMO_ID =@CMEMOID



SET @CSTEP=330  

IF OBJECT_ID ('TEMPDB..#TMPSKU','U') IS NOT NULL
DROP TABLE #TMPSKU

SELECT DISTINCT  A.* 
INTO #TMPSKU
FROM SKU A
JOIN SNC_BARCODE_DET  B (NOLOCK) ON A.product_code =B.PRODUCT_CODE 
JOIN SNC_DET C (NOLOCK) ON B.REFROW_ID =C.ROW_ID 
WHERE C.MEMO_ID =@CMEMOID



SELECT DISTINCT 'SNC_ARTICLE_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM ARTICLE A
JOIN SNC_DET B ON A.ARTICLE_CODE =B.ARTICLE_CODE 
WHERE B.MEMO_ID=@CMEMOID
UNION
SELECT DISTINCT 'SNC_ARTICLE_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM ARTICLE A
JOIN #TMPSKU B ON A.ARTICLE_CODE =B.ARTICLE_CODE 


  
SET @CSTEP=340  

SELECT DISTINCT 'SNC_PARA1_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA1 A
JOIN SNC_DET B ON A.para1_code  =B.para1_code 
WHERE B.MEMO_ID=@CMEMOID
UNION
SELECT DISTINCT 'SNC_PARA1_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA1 A
JOIN #TMPSKU B ON A.para1_code  =B.para1_code 

  
SET @CSTEP=350  


SELECT DISTINCT 'SNC_PARA2_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA2 A
JOIN SNC_DET B ON A.para2_code  =B.para2_code 
WHERE B.MEMO_ID=@CMEMOID
UNION
SELECT DISTINCT 'SNC_PARA2_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA2 A
JOIN #TMPSKU B ON A.para2_code  =B.para2_code 


SET @CSTEP=360  

SELECT DISTINCT 'SNC_PARA3_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA3 A
JOIN SNC_DET B ON A.para3_code  =B.para3_code 
WHERE B.MEMO_ID=@CMEMOID
UNION
SELECT DISTINCT 'SNC_PARA3_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA3 A
JOIN #TMPSKU B ON A.para3_code  =B.para3_code 


 
  
SET @CSTEP=370 


SELECT DISTINCT 'SNC_PARA4_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA4 A
JOIN SNC_DET B ON A.para4_code  =B.para4_code 
WHERE B.MEMO_ID=@CMEMOID
UNION
SELECT DISTINCT 'SNC_PARA4_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA4 A
JOIN #TMPSKU B ON A.para4_code  =B.para4_code 

SET @CSTEP=380  
 
 
SELECT DISTINCT 'SNC_PARA5_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA5 A
JOIN SNC_DET B ON A.para5_code  =B.para5_code 
WHERE B.MEMO_ID=@CMEMOID
UNION
SELECT DISTINCT 'SNC_PARA5_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA5 A
JOIN #TMPSKU B ON A.para5_code  =B.para5_code 

  
SET @CSTEP=390  

SELECT DISTINCT 'SNC_PARA6_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA6 A
JOIN SNC_DET B ON A.para6_code  =B.para6_code 
WHERE B.MEMO_ID=@CMEMOID
UNION
SELECT DISTINCT 'SNC_PARA6_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM PARA6 A
JOIN #TMPSKU B ON A.para6_code  =B.para6_code 

  
SET @CSTEP=410  
SELECT DISTINCT 'SNC_SKU_OH_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM SKU_OH A
JOIN #TMPSKU B ON A.product_code   =B.product_code 
 
  
SET @CSTEP=420 
IF OBJECT_ID('TEMPDB..#TMPARTICLE','U') IS NOT NULL
   DROP TABLE #TMPARTICLE
    SELECT DISTINCT  A.SUB_SECTION_CODE,A.ARTICLE_CODE   
	INTO #TMPARTICLE
	FROM ARTICLE A
	JOIN SNC_DET B ON A.ARTICLE_CODE =B.ARTICLE_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION
	SELECT A.SUB_SECTION_CODE ,A.ARTICLE_CODE 
	FROM ARTICLE A
	JOIN #TMPSKU B ON A.ARTICLE_CODE =B.ARTICLE_CODE 



SELECT DISTINCT 'SNC_SECTIOND_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM sectionD A
JOIN #TMPARTICLE B ON A.sub_section_code =B.sub_section_code 



SELECT DISTINCT 'SNC_SECTIONM_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS SNC_MEMO_ID 
FROM sectionm A
JOIN sectionD B ON A.section_code =B.section_code 
JOIN #TMPARTICLE C ON B.sub_section_code =C.sub_section_code 

SET @CSTEP=261
SELECT DISTINCT 'SNC_pmt01106_MIRROR' AS TARGET_TABLENAME, A.DEPT_ID,A.PRODUCT_CODE,A.BIN_ID,A.QUANTITY_IN_STOCK
 FROM PMT01106 A 
 JOIN SNC_BARCODE_DET B ON B.PRODUCT_CODE=A.PRODUCT_CODE
 JOIN SNC_DET C ON B.REFROW_ID=C.ROW_ID
  WHERE C.MEMO_ID=@CMEMOID
 UNION
 SELECT DISTINCT 'SNC_pmt01106_MIRROR' AS TARGET_TABLENAME, A.DEPT_ID,A.PRODUCT_CODE,A.BIN_ID,A.QUANTITY_IN_STOCK
 FROM PMT01106 A 
 JOIN SNC_CONSUMABLE_DET B ON B.PRODUCT_CODE=A.PRODUCT_CODE AND a.bin_id=b.bin_id
 WHERE B.MEMO_ID =@CMEMOID  

   
GOTO END_PROC  
  
END TRY  
BEGIN CATCH  
SET @CERRMSG='P: SP_SEND_MIRROR_SNC_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
GOTO END_PROC  
END CATCH  
END_PROC:  

END  

