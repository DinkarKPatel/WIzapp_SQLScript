CREATE PROCEDURE PPC_SAVETRAN_AGENCY_JOBS
(
	 @NSPID			INT=0
)
----WITH ENCRYPTION
AS
BEGIN
DECLARE @CERRMSG VARCHAR(500),@CSTEP VARCHAR(10)
	   ,@CCMD NVARCHAR(MAX),@CNEWJOB_CODE VARCHAR(10)

DECLARE @TOUTPUT TABLE(JOB_CODE VARCHAR(50),ERRMSG VARCHAR(500))

---LIST OF TABLES TO SAVE
DECLARE @TAGENCYJOBS VARCHAR(100)
--,@TSKU VARCHAR(100)


SET @TAGENCYJOBS='MST_AGENCY_JOBS_UPLOAD'
--SET @TSKU=@CTABLE_PREFIX+'SKU'+@CTABLE_SUFFIX

BEGIN TRY
BEGIN TRANSACTION
		   SET @CSTEP=10
		  
			--VALIDATION OF VALID ARTICLE
			SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TAGENCYJOBS+' A LEFT JOIN JOBS B ON A.JOB_CODE=B.JOB_CODE
								  WHERE  A.SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''' AND B.JOB_CODE IS NULL)
					        SET @CERRMSG=''INVALID JOB.'' '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT	
			
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC	
				
		
			SET @CSTEP=80
			--VALIDATION ON PARA1_CODE OF BOM
			SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM '+@TAGENCYJOBS+' A LEFT JOIN PRD_AGENCY_MST B ON A.AGENCY_CODE=B.AGENCY_CODE
								  WHERE  A.SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''' AND B.AGENCY_CODE IS NULL)
					        SET @CERRMSG=''INVALID AGENCY. '' '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD,N'@CERRMSG VARCHAR(500) OUTPUT',@CERRMSG OUTPUT	
			
			IF ISNULL(@CERRMSG,'')<>''
				GOTO END_PROC		
			
	
			SET @CCMD=N'SELECT @CNEWJOB_CODE=AGENCY_CODE FROM '+@TAGENCYJOBS +' WHERE  SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD,N'@CNEWJOB_CODE VARCHAR(10) OUTPUT',@CNEWJOB_CODE OUTPUT
			
	
			SET @CSTEP=250
			
			--DELETE THE EXISTING RECORD FOR THIS AGENCY JOBS
			DELETE FROM  AGENCY_JOBS WHERE AGENCY_CODE=@CNEWJOB_CODE
	
	DECLARE @FILTER VARCHAR(MAX)
	SET @FILTER=' B.SP_ID= '''+LTRIM(RTRIM(STR(@NSPID)))+''' '	
	
	--SP_INSERTSTR PPC_SIZEGROUP_PARA2
    EXEC UPDATEMASTERXN 
			 @CSOURCEDB=''
			,@CSOURCETABLE=@TAGENCYJOBS
			,@CDESTDB=''
			,@CDESTTABLE='AGENCY_JOBS'
			,@CKEYFIELD1='AGENCY_CODE'
			,@CKEYFIELD2=''
			,@CKEYFIELD3=''
			,@LINSERTONLY=0
			,@CFILTERCONDITION=@FILTER
			,@LUPDATEXNS=0
			,@CXNTYPE=''
			,@LUPDATEONLY=0
			,@CUSERID=''
			,@BALWAYSUPDATE=1

		
END TRY
BEGIN CATCH 
	SET @CERRMSG='SAVETRAN_AGENCY_JOBS: STEP - '+ISNULL(@CSTEP,'')+', MESSAGE - '+ERROR_MESSAGE() 
END CATCH

END_PROC:

IF @@TRANCOUNT>0  
 BEGIN  
  IF ISNULL(@CERRMSG,'')='' 
   COMMIT TRANSACTION  
  ELSE  
   ROLLBACK  
 END  

--DROP TEMP TABLES
IF ISNULL(@CERRMSG,'')=''
BEGIN
    DELETE FROM MST_AGENCY_JOBS_UPLOAD WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID)))
END

INSERT @TOUTPUT(JOB_CODE,ERRMSG)
SELECT @CNEWJOB_CODE,ISNULL(@CERRMSG,'')

SELECT * FROM @TOUTPUT

END
--END OF PROCEDURE - SAVETRAN_SIZEGROUP
