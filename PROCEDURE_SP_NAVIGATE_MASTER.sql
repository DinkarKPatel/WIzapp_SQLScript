CREATE PROCEDURE SP_NAVIGATE_MASTER 
@CTABLENAME VARCHAR(MAX),
@NNAVMODE INT,
@CMEMONO VARCHAR(MAX),
@CMEMONOCOL VARCHAR(MAX)='MST_NAME',
@CMEMOIDCOL VARCHAR(MAX)='MST_CODE',
@CWHERECLAUSE VARCHAR(MAX)=''
AS
BEGIN
    
	IF LEFT(REPLACE(@CWHERECLAUSE,' ',''),3)='AND'
	BEGIN
	IF LEFT (@CWHERECLAUSE,3)='AND'
	SET @CWHERECLAUSE=SUBSTRING(@CWHERECLAUSE,4,LEN(@CWHERECLAUSE))
	IF LEFT (@CWHERECLAUSE,4)=' AND'
	SET @CWHERECLAUSE=SUBSTRING(@CWHERECLAUSE,5,LEN(@CWHERECLAUSE))
    END
    
	DECLARE @DMEMODT DATETIME,@CCMD NVARCHAR(MAX)
	
	DECLARE @TNAVIGATE TABLE (MEMO_NO VARCHAR(MAX),MEMO_NAME VARCHAR(MAX))
		
		
	SET @CCMD = N'SELECT TOP 1 '+@CMEMONOCOL+','+@CMEMOIDCOL+' FROM '+@CTABLENAME+'
	 WHERE 1=1 '+
	((CASE WHEN @CWHERECLAUSE<>'' THEN ' AND '+@CWHERECLAUSE ELSE '' END)+
				   (CASE WHEN @NNAVMODE IN(0,2,3) THEN ' AND '+@CMEMONOCOL+(CASE WHEN @NNAVMODE=2 THEN '<' WHEN @NNAVMODE=3 THEN '>' ELSE '=' END)+''''+@CMEMONO+'''' ELSE '' END)+
				 ' ORDER BY '+@CMEMONOCOL+(CASE WHEN @NNAVMODE IN (1,3) THEN ' ASC ' ELSE ' DESC ' END))
   
    PRINT @CCMD
    
	INSERT @TNAVIGATE			 
	EXEC SP_EXECUTESQL @CCMD                           
	
	--IF NOT EXISTS (SELECT TOP 1 MEMO_NO FROM @TNAVIGATE)
	--BEGIN
	--	SET @CCMD = N'SELECT TOP 1 '+@CMEMONOCOL+' FROM '+@CTABLENAME+' 
	--	WHERE 1=1  '+
	--		(CASE WHEN @BINCLUDEESTIMATE=1 THEN '' ELSE ' AND MEMO_TYPE<>2 ' END)+
	--				  (CASE WHEN @CWHERECLAUSE<>'' THEN ' AND '+@CWHERECLAUSE ELSE '' END)+
	--				  (CASE WHEN @NNAVMODE IN(0,2,3) THEN ' AND '+@CMEMODTCOL+ 
	--				  (CASE WHEN @NNAVMODE=2 THEN '<' WHEN @NNAVMODE=3 THEN '>' ELSE '=' END)+
	--				  ''''+CONVERT(VARCHAR,@DMEMODT,110)+''' AND '+@CMEMONOCOL+'<>'''+@CMEMONO+'''' ELSE '' END)+
	--				  ' ORDER BY '+@CMEMODTCOL+(CASE WHEN @NNAVMODE IN (1,3) THEN ' ASC ' ELSE ' DESC ' END)+
	--				 ' ,'+@CMEMONOCOL+(CASE WHEN @NNAVMODE IN (1,3) THEN ' ASC ' ELSE ' DESC ' END)
	--	INSERT @TNAVIGATE				 
	--	EXEC SP_EXECUTESQL @CCMD	
	--END
	
	IF NOT EXISTS (SELECT TOP 1 MEMO_NO FROM @TNAVIGATE)
	BEGIN
		SET @CCMD=N'SELECT '+@CMEMONOCOL+','+@CMEMOIDCOL+' FROM '+@CTABLENAME+' WHERE '+@CMEMONOCOL+'='''+@CMEMONO+''''
		PRINT @CCMD	
		
		INSERT @TNAVIGATE				 
		EXEC SP_EXECUTESQL @CCMD	
	END
	
	IF OBJECT_ID('TEMPDB..#TMPNAV','U') IS NOT NULL
		DROP TABLE #TMPNAV
	
	SELECT MEMO_NO,MEMO_NAME INTO #TMPNAV FROM @TNAVIGATE
	
	SET @CCMD=N'SELECT MEMO_NO AS '+@CMEMONOCOL+',MEMO_NAME AS '+@CMEMOIDCOL+' FROM #TMPNAV'
	EXEC SP_EXECUTESQL @CCMD	
	
END
