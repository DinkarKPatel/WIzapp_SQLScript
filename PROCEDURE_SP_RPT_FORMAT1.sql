CREATE PROCEDURE SP_RPT_FORMAT1--(LocId 3 digit change by Sanjay:30-10-2024)
(
  @CFROMDATE DATETIME,
  @CTODATE DATETIME,
  @LOCID VARCHAR(10),
  @CCATEGORY VARCHAR(100),
  @CPRODUCT VARCHAR(100)
)
--WITH ENCRYPTION

AS
BEGIN


SELECT A.PRODUCT_CODE,SKU.PRODUCT_NAME,PARA2.PARA2_NAME,PARA2.PARA2_ORDER,
       PARA3.PARA3_NAME ,SKU.MRP ,M.MST AS CAL_MST_QTY
       
,SUM( CASE  WHEN A.XN_TYPE='SLS' AND XN_DT BETWEEN @CFROMDATE AND @CTODATE THEN XN_QTY 
            WHEN A.XN_TYPE='SLR' AND XN_DT BETWEEN @CFROMDATE AND @CTODATE
            THEN - (ABS(XN_QTY)) ELSE 0 END) AS CAL_SALE_ACH_LAST_30
            
,SUM( (CASE WHEN A.XN_TYPE='OPS' OR (A.XN_TYPE IN ('OPS','PRD', 'PUR', 'CHI', 'SLR','UNC','APR', 'WSR', 'PFI', 'PFG', 'BCG','MRP','DCI','PSB','JWR') 
            AND XN_DT <= @CTODATE ) THEN 1 
            WHEN A.XN_TYPE IN ('PRT','CHO','SLS','CNC','APP','WSL','CIP', 'CRM', 'DCO','MIP','CSB','JWI','DLM') 
            AND XN_DT <= @CTODATE  THEN -1 ELSE 0 END) * (XN_QTY))  AS CAL_CBS
            
,ISNULL(M.MST,0)- SUM( (CASE WHEN A.XN_TYPE='OPS' OR (A.XN_TYPE IN ('OPS','PRD', 'PUR', 'CHI', 'SLR','UNC','APR', 'WSR', 'PFI', 'PFG', 'BCG','MRP','DCI','PSB','JWR') 
AND XN_DT <=@CTODATE) THEN 1 
WHEN A.XN_TYPE IN ('PRT','CHO','SLS','CNC','APP','WSL','CIP', 'CRM', 'DCO','MIP','CSB','JWI','DLM') 
AND XN_DT <= @CTODATE  THEN -1 ELSE 0 END) * (XN_QTY)) AS CAL_REQ_QTY

,(ISNULL(M.MST,0)- SUM( (CASE WHEN A.XN_TYPE='OPS' OR (A.XN_TYPE IN ('OPS','PRD', 'PUR', 'CHI', 'SLR','UNC','APR', 'WSR', 'PFI', 'PFG', 'BCG','MRP','DCI','PSB','JWR') 
AND XN_DT <= @CTODATE) THEN 1 
WHEN A.XN_TYPE IN ('PRT','CHO','SLS','CNC','APP','WSL','CIP', 'CRM', 'DCO','MIP','CSB','JWI','DLM') 
AND XN_DT <= @CTODATE  THEN -1 ELSE 0 END) * (XN_QTY)))*SKU.MRP  AS CAL_REQ_AMT

FROM VW_XNSREPS A  (NOLOCK) 
JOIN SKU (NOLOCK) ON A.PRODUCT_CODE = SKU.PRODUCT_CODE 
JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE 
JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE  = PARA2.PARA2_CODE 
JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE  = PARA3.PARA3_CODE 
JOIN LOC_VIEW LOC  (NOLOCK) ON A.DEPT_ID = LOC.DEPT_ID
LEFT OUTER  JOIN
(
 SELECT DEPT_ID,PRODUCT_CODE,MST,MBQ
 FROM MBQ_DET (NOLOCK)
 WHERE MONTH= MONTH(@CTODATE) AND YEAR= YEAR(@CTODATE)
) M ON A.PRODUCT_CODE= M.PRODUCT_CODE  AND M.DEPT_ID = LOC.DEPT_ID
WHERE (LOC.DEPT_ID =@LOCID OR @LOCID='') AND (PARA3.PARA3_NAME= @CCATEGORY OR @CCATEGORY='') AND
      (A.PRODUCT_CODE=@CPRODUCT OR @CPRODUCT='' )
GROUP BY A.PRODUCT_CODE,SKU.PRODUCT_NAME,
         PARA3.PARA3_NAME ,PARA2.PARA2_ORDER,PARA2.PARA2_NAME,SKU.MRP ,M.MST
ORDER BY A.PRODUCT_CODE,SKU.PRODUCT_NAME,PARA2.PARA2_ORDER,PARA2.PARA2_NAME,
         PARA3.PARA3_NAME ,SKU.MRP ,M.MST
         
END
