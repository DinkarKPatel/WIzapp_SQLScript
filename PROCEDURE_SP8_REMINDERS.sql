CREATE PROCEDURE SP8_REMINDERS            
(            
  @DFROM_DT DATETIME            
 ,@DTO_DT DATETIME            
 ,@CAC_CODES VARCHAR(MAX)            
 ,@CFIN_YEAR VARCHAR(5)            
 ,@CFORM_ID VARCHAR(7)            
 ,@NMODE NUMERIC(1)=1 /*1 FOR SUMMARY AND 2 FOR DETAILS*/            
 ,@BSKIPWSR BIT=0           
 ,@BPPENDING INT =1   /* 1 FOR PENDING AND 2 FOR NO PENDING    */          
)            
AS            
BEGIN            
 DECLARE @DTSQL NVARCHAR(MAX),@DTSQL1 NVARCHAR(MAX)            
             
 IF OBJECT_ID('TEMPDB..#REMINDERS','U') IS NOT NULL            
  DROP TABLE #REMINDERS            
             
 CREATE TABLE #REMINDERS(INV_NO VARCHAR(15),INV_DT DATETIME,FIN_YEAR VARCHAR(7),NET_AMOUNT NUMERIC(18,2),      
 QTY NUMERIC(18,3),FORM_ID VARCHAR(7),AC_CODE VARCHAR(10)) 
 
 
  IF OBJECT_ID('TEMPDB..#REMINDERS1','U') IS NOT NULL            
  DROP TABLE #REMINDERS1            
             
 CREATE TABLE #REMINDERS1(INV_NO VARCHAR(15),INV_DT DATETIME,FIN_YEAR VARCHAR(7),NET_AMOUNT NUMERIC(18,2),      
 QTY NUMERIC(18,3),FORM_ID VARCHAR(7),AC_CODE VARCHAR(10),FORM_NO VARCHAR(20),FORM_DT DATETIME)            
          
IF @BPPENDING = 1          
             
  SET @DTSQL=N'SELECT A.INV_NO, A.INV_DT,DBO.FN_GETDISPLAYFINYEAR(A.FIN_YEAR) AS FIN_YEAR, (SUM((B.QUANTITY  *B.RATE )- B.DISCOUNT_AMOUNT  )- A.DISCOUNT_AMOUNT ) AS NET_AMOUNT ,      
              SUM(B.QUANTITY) AS QTY, B.ITEM_FORM_ID AS FORM_ID,A.AC_CODE         
         FROM INM01106 A (NOLOCK)      
         JOIN IND01106 B (NOLOCK) ON A.INV_ID = B.INV_ID WHERE A.CANCELLED = 0 AND B.ITEM_FORM_ID ='''+@CFORM_ID+'''         
         --A.FIN_YEAR = '''+@CFIN_YEAR+'''        
         AND A.AC_CODE IN '+@CAC_CODES+'AND A.INV_DT<='''+CONVERT(VARCHAR,@DTO_DT,110)+'''         
         -- A.INV_DT BETWEEN '''+CONVERT(VARCHAR,@DFROM_DT,110)+''' AND '''+CONVERT(VARCHAR,@DTO_DT,110)+'''                  
   AND A.INV_ID NOT IN( SELECT XN_ID FROM FTM (NOLOCK) WHERE XN_TYPE= ''SLS'')                  
   GROUP BY A.INV_NO, A.INV_DT,DBO.FN_GETDISPLAYFINYEAR(A.FIN_YEAR), A.DISCOUNT_AMOUNT , B.ITEM_FORM_ID, 
   A.AC_CODE '          
 IF @BSKIPWSR=0               
 SET @DTSQL=@DTSQL+N' UNION ALL             
  SELECT A.CN_NO, A.CN_DT,DBO.FN_GETDISPLAYFINYEAR(A.FIN_YEAR) AS FIN_YEAR, ( -1 * (SUM(((B.QUANTITY  *B.RATE )- B.DISCOUNT_AMOUNT  ))- A.DISCOUNT_AMOUNT) ) AS NET_AMOUNT ,      
   -1*SUM(B.QUANTITY)AS QTY, B.ITEM_FORM_ID AS FORM_ID,A.AC_CODE       
   FROM CNM01106 A (NOLOCK)      
   JOIN CND01106 B (NOLOCK) ON A.CN_ID= B.CN_ID   WHERE A.CANCELLED = 0 AND B.ITEM_FORM_ID ='''+@CFORM_ID+'''               
   -- A.FIN_YEAR = '''+@CFIN_YEAR+'''               
    AND A.AC_CODE IN '+@CAC_CODES+'  AND A.CN_DT<='''+CONVERT(VARCHAR,@DTO_DT,110)+'''              
     -- A.CN_DT BETWEEN '''+CONVERT(VARCHAR,@DFROM_DT,110)+''' AND '''+CONVERT(VARCHAR,@DTO_DT,110)+'''                  
    AND A.CN_ID NOT IN( SELECT XN_ID FROM FTM (NOLOCK) WHERE XN_TYPE= ''SLR'')        
        GROUP BY A.CN_NO, A.CN_DT,DBO.FN_GETDISPLAYFINYEAR(A.FIN_YEAR), A.DISCOUNT_AMOUNT, B.ITEM_FORM_ID,       
                 A.AC_CODE '             
                
  PRINT @DTSQL            
              
  INSERT #REMINDERS(INV_NO,INV_DT,FIN_YEAR,NET_AMOUNT,QTY,FORM_ID,AC_CODE)            
  EXEC SP_EXECUTESQL @DTSQL                  
           
           
           
 IF @BPPENDING =2          
   SET @DTSQL1=N'SELECT A.INV_NO, A.INV_DT,DBO.FN_GETDISPLAYFINYEAR(A.FIN_YEAR) AS FIN_YEAR,       
               (SUM((B.QUANTITY  *B.RATE )- B.DISCOUNT_AMOUNT  )- A.DISCOUNT_AMOUNT ) AS NET_AMOUNT ,      
                SUM(B.QUANTITY) AS QTY, B.ITEM_FORM_ID AS FORM_ID,A.AC_CODE,F.FORM_NO,F.FORM_DT          
         FROM INM01106 A (NOLOCK)      
         JOIN FTM F (NOLOCK) ON F.XN_ID=A.INV_ID                 
         JOIN IND01106 B (NOLOCK) ON A.INV_ID = B.INV_ID WHERE A.CANCELLED = 0 AND A.B.ITEM_FORM_ID ='''+@CFORM_ID+'''       
          --A.FIN_YEAR = '''+@CFIN_YEAR+'''        
         AND A.AC_CODE IN '+@CAC_CODES+'AND A.INV_DT<='''+CONVERT(VARCHAR,@DTO_DT,110)+'''         
         --  A.INV_DT BETWEEN '''+CONVERT(VARCHAR,@DFROM_DT,110)+''' AND '''+CONVERT(VARCHAR,@DTO_DT,110)+'''                
   AND A.INV_ID  IN( SELECT XN_ID FROM FTM (NOLOCK) WHERE XN_TYPE= ''SLS'')                  
   GROUP BY A.INV_NO, A.INV_DT,DBO.FN_GETDISPLAYFINYEAR(A.FIN_YEAR), A.DISCOUNT_AMOUNT , B.ITEM_FORM_ID,       
            A.AC_CODE,F.FORM_NO,F.FORM_DT '          
 IF @BSKIPWSR=0               
 SET @DTSQL1=@DTSQL1+N' UNION ALL             
  SELECT A.CN_NO, A.CN_DT,DBO.FN_GETDISPLAYFINYEAR(A.FIN_YEAR) AS FIN_YEAR,       
  ( -1 * (SUM(((B.QUANTITY  *B.RATE )- B.DISCOUNT_AMOUNT  ))- A.DISCOUNT_AMOUNT) ) AS NET_AMOUNT ,      
   -1*SUM(B.QUANTITY)AS QTY, B.ITEM_FORM_ID AS FORM_ID,A.AC_CODE,F.FORM_NO,F.FORM_DT        
   FROM CNM01106 A (NOLOCK)       
   JOIN FTM F ON F.XN_ID=A.CN_ID          
  JOIN CND01106 B (NOLOCK) ON A.CN_ID= B.CN_ID   WHERE A.CANCELLED = 0 AND B.ITEM_FORM_ID ='''+@CFORM_ID+'''            
      -- A.FIN_YEAR = '''+@CFIN_YEAR+'''           
      AND A.AC_CODE IN '+@CAC_CODES+'       AND A.CN_DT<='''+CONVERT(VARCHAR,@DTO_DT,110)+'''             
      -- A.CN_DT BETWEEN '''+CONVERT(VARCHAR,@DFROM_DT,110)+''' AND '''+CONVERT(VARCHAR,@DTO_DT,110)+'''                  
  AND A.CN_ID  IN( SELECT XN_ID FROM FTM (NOLOCK) WHERE XN_TYPE= ''SLR'')         
  GROUP BY A.CN_NO, A.CN_DT,DBO.FN_GETDISPLAYFINYEAR(A.FIN_YEAR), A.DISCOUNT_AMOUNT, B.ITEM_FORM_ID,       
           A.AC_CODE,F.FORM_NO,F.FORM_DT '             
                
  PRINT @DTSQL1            
              
  INSERT #REMINDERS1(INV_NO,INV_DT,FIN_YEAR,NET_AMOUNT,QTY,FORM_ID,AC_CODE,FORM_NO,FORM_DT)            
  EXEC SP_EXECUTESQL @DTSQL1            
           
           
           
           
             
IF @NMODE=1 AND @BPPENDING=1           
 GOTO LBL_RETURNSUMMARY            
IF @NMODE=2 AND @BPPENDING=1           
 GOTO LBL_RETURNDETAIL            
             
LBL_RETURNSUMMARY:             
  ---RETURN SUMMARY            
  SELECT CAST(0 AS INT) AS SNO,L.AC_NAME,F.FORM_NAME,L.ADDRESS0,L.ADDRESS1,L.ADDRESS2,L.AREA_NAME,L.PINCODE,L.CITY,        L.STATE, L.PAN_NO, L.PHONES_R, L.PHONES_O, L.PHONES_FAX,L.MOBILE, L.CST_NO, L.SST_NO, L.TIN_NO, L.E_MAIL            
      ,A.FIN_YEAR            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 4 AND 6 THEN (A.NET_AMOUNT) ELSE 0 END) AS QTR1_AMOUNT            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 7 AND 9 THEN (A.NET_AMOUNT) ELSE 0 END) AS QTR2_AMOUNT            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 10 AND 12 THEN (A.NET_AMOUNT) ELSE 0 END) AS QTR3_AMOUNT            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 1 AND 3 THEN (A.NET_AMOUNT) ELSE 0 END) AS QTR4_AMOUNT            
      ,SUM(A.NET_AMOUNT) AS NET_AMOUNT            
                  
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 4 AND 6 THEN (A.QTY) ELSE 0 END) AS QTR1_QTY            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 7 AND 9 THEN (A.QTY) ELSE 0 END) AS QTR2_QTY            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 10 AND 12 THEN (A.QTY) ELSE 0 END) AS QTR3_QTY            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 1 AND 3 THEN (A.QTY) ELSE 0 END) AS QTR4_QTY            
      ,SUM(A.QTY) AS NET_QTY            
  FROM #REMINDERS A            
  JOIN FORM F ON A.FORM_ID=F.FORM_ID            
  JOIN LMV01106 L ON A.AC_CODE=L.AC_CODE            
  GROUP BY L.AC_NAME,A.FIN_YEAR,F.FORM_NAME,L.ADDRESS0,L.ADDRESS1,L.ADDRESS2,L.AREA_NAME,L.PINCODE,L.CITY,      
         L.STATE, L.PAN_NO, L.PHONES_R, L.PHONES_O, L.PHONES_FAX,L.MOBILE, L.CST_NO, L.SST_NO, L.TIN_NO, L.E_MAIL               
  ORDER BY A.FIN_YEAR,L.AC_NAME            
GOTO END_PROC            
            
LBL_RETURNDETAIL:            
  ---RETURN DETAILS    
  SELECT CAST(0 AS INT) AS SNO,A.FIN_YEAR,L.AC_CODE,L.AC_NAME,F.FORM_NAME,L.ADDRESS0,L.ADDRESS1,L.ADDRESS2,      
  L.AREA_NAME,L.PINCODE,L.CITY,L.STATE, L.PAN_NO, L.PHONES_R, L.PHONES_O, L.PHONES_FAX,L.MOBILE,       
  L.CST_NO, L.SST_NO, L.TIN_NO, L.E_MAIL           
     ,INV_NO,INV_DT,NET_AMOUNT,QTY          
  FROM #REMINDERS A            
  JOIN FORM F ON A.FORM_ID=F.FORM_ID            
  JOIN LMV01106 L ON A.AC_CODE=L.AC_CODE            
  ORDER BY L.AC_CODE,INV_DT            
GOTO END_PROC 


--- REPORT FOR RECEIVEING

           
             
IF @NMODE=1 AND @BPPENDING=2            
 GOTO NPLBL_RETURNSUMMARY            
IF @NMODE=2 AND @BPPENDING=2            
 GOTO NPLBL_RETURNDETAIL            
             
NPLBL_RETURNSUMMARY:             
  ---RETURN SUMMARY            
  SELECT CAST(0 AS INT) AS SNO,L.AC_NAME,F.FORM_NAME,L.ADDRESS0,L.ADDRESS1,L.ADDRESS2,L.AREA_NAME,L.PINCODE,L.CITY,        L.STATE, L.PAN_NO, L.PHONES_R, L.PHONES_O, L.PHONES_FAX,L.MOBILE, L.CST_NO, L.SST_NO, L.TIN_NO, L.E_MAIL            
      ,A.FIN_YEAR            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 4 AND 6 THEN (A.NET_AMOUNT) ELSE 0 END) AS QTR1_AMOUNT            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 7 AND 9 THEN (A.NET_AMOUNT) ELSE 0 END) AS QTR2_AMOUNT            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 10 AND 12 THEN (A.NET_AMOUNT) ELSE 0 END) AS QTR3_AMOUNT            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 1 AND 3 THEN (A.NET_AMOUNT) ELSE 0 END) AS QTR4_AMOUNT            
      ,SUM(A.NET_AMOUNT) AS NET_AMOUNT            
                  
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 4 AND 6 THEN (A.QTY) ELSE 0 END) AS QTR1_QTY            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 7 AND 9 THEN (A.QTY) ELSE 0 END) AS QTR2_QTY            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 10 AND 12 THEN (A.QTY) ELSE 0 END) AS QTR3_QTY            
      ,SUM(CASE WHEN MONTH(A.INV_DT) BETWEEN 1 AND 3 THEN (A.QTY) ELSE 0 END) AS QTR4_QTY            
      ,SUM(A.QTY) AS NET_QTY,A.FORM_NO,A.FORM_DT            
  FROM #REMINDERS1 A            
  JOIN FORM F ON A.FORM_ID=F.FORM_ID            
  JOIN LMV01106 L ON A.AC_CODE=L.AC_CODE            
  GROUP BY L.AC_NAME,A.FIN_YEAR,F.FORM_NAME,L.ADDRESS0,L.ADDRESS1,L.ADDRESS2,L.AREA_NAME,L.PINCODE,L.CITY,      
         L.STATE, L.PAN_NO, L.PHONES_R, L.PHONES_O, L.PHONES_FAX,L.MOBILE, L.CST_NO, L.SST_NO, L.TIN_NO, L.E_MAIL      
         ,A.FORM_NO,A.FORM_DT           
  ORDER BY A.FIN_YEAR,L.AC_NAME            
GOTO END_PROC            
            
NPLBL_RETURNDETAIL:            
  ---RETURN DETAILS            
  SELECT CAST(0 AS INT) AS SNO,A.FIN_YEAR,L.AC_CODE,L.AC_NAME,F.FORM_NAME,L.ADDRESS0,L.ADDRESS1,L.ADDRESS2,      
  L.AREA_NAME,L.PINCODE,L.CITY,L.STATE, L.PAN_NO, L.PHONES_R, L.PHONES_O, L.PHONES_FAX,L.MOBILE,       
  L.CST_NO, L.SST_NO, L.TIN_NO, L.E_MAIL           
     ,INV_NO,INV_DT,NET_AMOUNT,QTY,A.FORM_NO,A.FORM_DT           
  FROM #REMINDERS1 A            
  JOIN FORM F ON A.FORM_ID=F.FORM_ID            
  JOIN LMV01106 L ON A.AC_CODE=L.AC_CODE            
  ORDER BY L.AC_CODE,INV_DT            
GOTO END_PROC            

        
END_PROC:             
END            
--END OF PROCEDURE - SP8_REMINDERS
