CREATE PROCEDURE SP_WL_DROPTEMPTABLES
--WITH ENCRYPTION
AS 
BEGIN
	DECLARE @CTABLENAME VARCHAR(MAX),
			@CDATABASENAME VARCHAR(MAX),
			@CCMD NVARCHAR(MAX)
	
	--exec SP3S_DELETE_MIRROR_TABLES
	
	DECLARE @JUNCC TABLE ( TABLENAME VARCHAR(MAX) )
	SET @CDATABASENAME = DB_NAME()
	INSERT @JUNCC ( TABLENAME )
	SELECT @CDATABASENAME + '.DBO.['+NAME +']'  
	FROM SYS.TABLES
	WHERE 
	(
		NAME LIKE '/_/_%' ESCAPE '/'
	OR	NAME LIKE '/_%' ESCAPE '/' )

	INSERT @JUNCC ( TABLENAME )
	SELECT @CDATABASENAME + '.DBO.['+NAME +']' 
	FROM SYSOBJECTS
	WHERE (NAME LIKE 'TEMP/_%/_%' ESCAPE '/' OR NAME LIKE 'TMP/_%/_%' ESCAPE '/')
	AND   TYPE = 'U'

	INSERT @JUNCC ( TABLENAME )
	SELECT @CDATABASENAME + '.DBO.['+NAME +']'
	FROM SYSOBJECTS
	WHERE NAME LIKE 'TMP/_%/_%' ESCAPE '/'
	AND   TYPE = 'U'

	IF EXISTS ( SELECT * FROM CONFIG WHERE CONFIG_OPTION = 'ENABLE_TEMP_DATABASE' AND VALUE = '1' )
	BEGIN
		SET @CDATABASENAME = DB_NAME() + '_TEMP'

		SET @CCMD = N'
					SELECT ''' + @CDATABASENAME + '.DBO.['' + NAME +'']'' AS NAME
					FROM ' + @CDATABASENAME + '.DBO.SYSOBJECTS
					WHERE NAME LIKE ''TEMP/_%/_%'' ESCAPE ''/''
					AND   TYPE = ''U'''
		
		PRINT @CCMD
		
		INSERT @JUNCC ( TABLENAME )
		EXEC SP_EXECUTESQL @CCMD
	END
	
	
		SET @CDATABASENAME = 'MASTER'

		SET @CCMD = N'
					SELECT ''' + @CDATABASENAME + '.DBO.['' + NAME +'']'' AS NAME
					FROM ' + @CDATABASENAME + '.DBO.SYSOBJECTS
					WHERE NAME LIKE ''TEMP/_%/_%'' ESCAPE ''/''
					AND   TYPE = ''U'''
		
		PRINT @CCMD
		
		INSERT @JUNCC ( TABLENAME )
		EXEC SP_EXECUTESQL @CCMD
		
	
	DECLARE JUNK_CUR CURSOR FOR
	SELECT TABLENAME FROM @JUNCC

	OPEN JUNK_CUR

	FETCH NEXT FROM JUNK_CUR INTO @CTABLENAME
	WHILE @@FETCH_STATUS = 0
	BEGIN
		PRINT 'DROPPING TEMP TABLE ' +  @CTABLENAME

		IF OBJECT_ID(''+@CTABLENAME+'','U') IS NOT NULL
		BEGIN
			SET @CCMD = N'DROP TABLE '+RTRIM(LTRIM(@CTABLENAME))
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
		END 

		FETCH NEXT FROM JUNK_CUR INTO @CTABLENAME
	END
	CLOSE JUNK_CUR
	DEALLOCATE JUNK_CUR

	exec SP3S_TRUNCATE_UPLOAD_TABLES
END
