CREATE PROCEDURE SP_PRD_APPROVAL_REPORT
(
  @DFM_DT DATETIME,
  @DTO_DT DATETIME,
  @CAC_CODE VARCHAR(100)='',
  @NPENDING INT=0
  
)
AS
BEGIN
	SELECT B.ISSUE_DT AS ISSUE_DT,CUSTOMER AS CUSTOMER_NAME,EMP_NAME,SECTION_NAME,SUB_SECTION_NAME,ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,PRODUCT_CODE,REMARKS,PARA2_ORDER,SUM(ISNULL(APP_QTY , 0)) AS APP_QTY,SUM(ISNULL(APR_QTY , 0)) AS APR_QTY,
	       SUM(ISNULL(APP_QTY , 0))-SUM(ISNULL(APR_QTY , 0)) AS NET_QTY
	FROM 
	(
	SELECT A.ISSUE_DT,CUSTOMER_FNAME +CUSTOMER_LNAME+AC_NAME AS CUSTOMER,EMP.EMP_NAME, SECTIONM.SECTION_NAME,SECTIOND.SUB_SECTION_NAME,ARTICLE.ARTICLE_NO,PARA1.PARA1_NAME,PARA2.PARA2_NAME,PARA3.PARA3_NAME,PARA4.PARA4_NAME,PARA5.PARA5_NAME,PARA6.PARA6_NAME,A.PRODUCT_CODE AS PRODUCT_CODE,A.REMARKS AS REMARKS,PARA2.PARA2_ORDER
	,CAST(SUM(A.APP_QTY) AS NUMERIC(14,2)) AS APP_QTY,CAST(SUM(A.APR_QTY) AS NUMERIC(14,2)) AS APR_QTY
	FROM 
	(
	 SELECT A.MEMO_DT AS ISSUE_DT, B.PRODUCT_UID,A.AC_CODE,A.CUSTOMER_CODE, A.DEPT_ID, 'APP' AS XN_TYPE,A.MEMO_ID AS CM_ID ,B.PRODUCT_CODE,B.EMP_CODE ,B.EMP_CODE1,B.EMP_CODE2,
			B.QUANTITY AS APP_QTY, 0 AS APR_QTY,B.MRP,B.RFNET,0 AS TAX_PERCENTAGE,A.DISCOUNT_PERCENTAGE,
	 '' AS ROW_ID,0 AS REPEAT_PUR_ORDER,A.REMARKS
	 FROM PRD_APM01106 A (NOLOCK)
	 JOIN PRD_APD01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID
	 WHERE A.CANCELLED = 0 AND A.MEMO_DT BETWEEN @DFM_DT AND @DTO_DT
	 AND (@CAC_CODE='' OR (AC_CODE=@CAC_CODE OR CUSTOMER_CODE=@CAC_CODE))
	 UNION ALL
	 SELECT D.MEMO_DT AS ISSUE_DT,B.PRODUCT_UID,D.AC_CODE,D.CUSTOMER_CODE, A.DEPT_ID,'APR' AS XN_TYPE,A.MEMO_ID AS CM_ID  ,C.PRODUCT_CODE,B.EMP_CODE,C.EMP_CODE1,C.EMP_CODE2,
	 0 AS APP_QTY, B.QUANTITY AS APR_QTY,C.MRP,C.RFNET ,0 AS TAX_PERCENTAGE,C.DISCOUNT_PERCENTAGE,
	 '' AS ROW_ID,0 AS REPEAT_PUR_ORDER,D.REMARKS
	 FROM PRD_APPROVAL_RETURN_MST A (NOLOCK)
	 JOIN PRD_APPROVAL_RETURN_DET B  (NOLOCK) ON A.MEMO_ID = B.MEMO_ID 
	 JOIN PRD_APD01106 C (NOLOCK) ON B.APD_ROW_ID = C.ROW_ID 
	 JOIN PRD_APM01106 D ON C.MEMO_ID = D.MEMO_ID 
	 WHERE A.CANCELLED = 0  AND A.MEMO_DT BETWEEN @DFM_DT AND @DTO_DT  
	 AND (@CAC_CODE='' OR (D.AC_CODE=@CAC_CODE OR D.CUSTOMER_CODE=@CAC_CODE))
	) A

	JOIN PRD_SKU SKU (NOLOCK) ON A.PRODUCT_UID = SKU.PRODUCT_UID 
	JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE 
	JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE
	JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE 
	JOIN PARA1 (NOLOCK) ON PARA1.PARA1_CODE = SKU.PARA1_CODE
	JOIN PARA2 (NOLOCK) ON PARA2.PARA2_CODE = SKU.PARA2_CODE
	JOIN PARA3 (NOLOCK) ON PARA3.PARA3_CODE = SKU.PARA3_CODE
	JOIN PARA4 (NOLOCK) ON PARA4.PARA4_CODE = SKU.PARA4_CODE
	JOIN PARA5 (NOLOCK) ON PARA5.PARA5_CODE = SKU.PARA5_CODE
	JOIN PARA6 (NOLOCK) ON PARA6.PARA6_CODE = SKU.PARA6_CODE
	JOIN LOCATION  (NOLOCK) ON A.DEPT_ID = LOCATION.DEPT_ID 
	JOIN CUSTDYM CUST (NOLOCK) ON CUST.CUSTOMER_CODE=A.CUSTOMER_CODE
	JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=A.AC_CODE
	LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON EMP.EMP_CODE=A.EMP_CODE
	GROUP BY A.ISSUE_DT,CUSTOMER_FNAME +CUSTOMER_LNAME+AC_NAME,EMP.EMP_NAME,SECTIONM.SECTION_NAME,SECTIOND.SUB_SECTION_NAME,ARTICLE.ARTICLE_NO,PARA1.PARA1_NAME,
	PARA2.PARA2_ORDER, PARA2.PARA2_SET,PARA2.PARA2_NAME ,PARA4.PARA4_NAME,PARA5.PARA5_NAME,PARA6.PARA6_NAME,
	A.PRODUCT_CODE,A.REMARKS,PARA3.PARA3_NAME

	 ) B 
	 GROUP BY B.ISSUE_DT,CUSTOMER,EMP_NAME,SECTION_NAME,SUB_SECTION_NAME,ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,PRODUCT_CODE,REMARKS,PARA2_ORDER
	 HAVING (@NPENDING=0 OR SUM(ISNULL(APP_QTY , 0))-SUM(ISNULL(APR_QTY , 0))>0)
	 ORDER BY CUSTOMER,SECTION_NAME,SUB_SECTION_NAME,ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,PRODUCT_CODE,REMARKS,PARA2_ORDER
	 
 END
