CREATE PROCEDURE SP_OUTPUTMATERIALCON    
@NQUERYID NUMERIC (2,0),    
@CMEMOID VARCHAR(40),    
@CWHERE VARCHAR(500),    
@CPRODUCTCODE VARCHAR(50),    
@CFINYEAR VARCHAR(5),    
@NNAVMODE NUMERIC(2,0),
@CWHERE1 VARCHAR(500)='',    
@CWHERE2 VARCHAR(500)=''       
--WITH ENCRYPTION
AS    
BEGIN    
    
DECLARE @CCMD NVARCHAR(4000),    
@CCMD1 NVARCHAR(MAX),    
@CHEADCODESTR VARCHAR(1000),    
@CDEBTORSTR VARCHAR(1000),    
@CCREDITORSTR VARCHAR(1000)     
    
IF     
@NQUERYID = 1    
GOTO LBLNAVIGATE    
    
ELSE IF     
@NQUERYID = 2    
GOTO LBLGETMASTERS    
    
ELSE IF     
@NQUERYID = 3    
GOTO LBLGETDETAILS    
    
ELSE IF     
@NQUERYID = 4    
GOTO LBLGETDEPARTMENT    
    
ELSE IF    
@NQUERYID = 5    
GOTO LBLGETWORKORDERMASTER    
    
ELSE IF    
@NQUERYID = 6    
GOTO LBLGETWORKORDERDETAILS    
    
ELSE IF    
@NQUERYID = 7    
GOTO LBLGETORDERWISEITEMS    
    
ELSE IF    
@NQUERYID = 8    
GOTO LBLGETWODETAILS    
    
ELSE IF     
@NQUERYID = 9    
GOTO LBLGETLEDGERS    
    
ELSE IF     
@NQUERYID = 10    
GOTO LBLGETJOBS    
    
ELSE IF     
@NQUERYID = 11    
GOTO LBLGETCOMPONENT    
    
ELSE IF       
@NQUERYID = 12      
GOTO LBLINSTYPELIST     
    
ELSE IF       
@NQUERYID = 13      
GOTO LBLPARALIST     
    
ELSE IF       
@NQUERYID = 14      
GOTO LBLOPINSTYPELIST     
    
ELSE IF       
@NQUERYID = 15      
GOTO LBLOPPARALIST     
    
LBLNAVIGATE:    
 EXECUTE SP_NAVIGATE 'PRD_OP_MATERIAL_CON_MST',@NNAVMODE,@CMEMOID,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERE    
GOTO LAST    
    
LBLGETMASTERS:    
 SELECT DISTINCT T1.*, T2.USERNAME,ISNULL(T6.MEMO_ID,'') AS WORK_ORDER_MEMO_ID,    
 ISNULL(T6.MEMO_NO,'') AS WORK_ORDER_MEMO_NO,    
 ISNULL(T6.REF_NO,'') AS WORK_REFNO,ISNULL(JOB.JOB_NAME,'') AS JOB_NAME,    
 (CASE WHEN T6.MEMO_DT <> '' THEN CONVERT(CHAR(10),ISNULL(T6.MEMO_DT,''),105) ELSE ''  END) AS WORKORDERDT,    
 ART.ARTICLE_NO     
 FROM PRD_OP_MATERIAL_CON_MST T1    
 JOIN USERS T2 ON T1.USER_CODE = T2.USER_CODE     
 JOIN ARTICLE ART ON T1.REF_COMPONENT_ARTICLE_CODE = ART.ARTICLE_CODE    
    LEFT OUTER JOIN PRD_WO_MST T6 ON T1.REF_PRD_WORKORDER_MEMOID= T6.MEMO_ID    
    LEFT OUTER JOIN JOBS JOB ON T1.JOB_CODE = JOB.JOB_CODE     
 WHERE T1.MEMO_ID = @CMEMOID    
GOTO LAST    
    
LBLGETDETAILS:    
      
  DECLARE @CREFWORKORDERMEMOID VARCHAR(MAX),@CCOMPONENTID VARCHAR(MAX),@CDEPTID VARCHAR(MAX)    
  DECLARE @OUTPUTTYPE INT    
      
  SET @OUTPUTTYPE=0    
  DECLARE @CCMD2 NVARCHAR(MAX)    
 IF @CMEMOID <> ''    
 BEGIN    
  SET @CDEPTID = SUBSTRING(@CWHERE,5,15)    
  SELECT TOP 1 @CREFWORKORDERMEMOID=REF_PRD_WORKORDER_MEMOID FROM PRD_OP_MATERIAL_CON_MST WHERE MEMO_ID = @CMEMOID    
  SELECT TOP 1 @CCOMPONENTID = REF_COMPONENT_ARTICLE_CODE  FROM PRD_OP_MATERIAL_CON_MST WHERE MEMO_ID = @CMEMOID    
  SELECT TOP 1 @OUTPUTTYPE = MODE FROM PRD_OP_MATERIAL_CON_MST WHERE MEMO_ID = @CMEMOID    
 END    
 ELSE    
 BEGIN    
  SELECT @CREFWORKORDERMEMOID = '',@CCOMPONENTID = '', @CDEPTID = ''    
 END    
 IF(@OUTPUTTYPE = 0)    
 BEGIN    
   SET @CCMD = N'SELECT CAST(1 AS BIT) AS CHCK    
   ,C.UOM_NAME,D.*    
   ,B.ARTICLE_NO,B.ARTICLE_NAME,PARA1.PARA1_NAME,PARA2.PARA2_NAME    
   ,ISNULL(P.WIP,0) AS QUANTITY_IN_STOCK    
   ,ISNULL(REC.TOTAL_RECEIVE_QTY,0) AS TOTAL_REC_QTY    
   ,ISNULL(OP.TOTAL_OP_QTY,0) AS TOTAL_OP_QTY     
   ,0 AS TOTAL_CC_QTY    
   ,(ISNULL(REC.TOTAL_RECEIVE_QTY,0) - ISNULL(OP.TOTAL_OP_QTY,0)) AS BALANCE_QTY     
   FROM PRD_OP_MATERIAL_CON_DET D     
   JOIN ARTICLE B ON D.ARTICLE_CODE  = B.ARTICLE_CODE     
   JOIN UOM C ON B.UOM_CODE = C.UOM_CODE      
   JOIN PARA1 ON PARA1.PARA1_CODE = D.PARA1_CODE    
   JOIN PARA2 ON PARA2.PARA2_CODE = D.PARA2_CODE    
   LEFT OUTER JOIN (SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP        
   FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID     
   WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +''' AND SKU.WORK_ORDER_ID = '''+@CREFWORKORDERMEMOID+''') P ON   
   P.PRODUCT_UID=D.PRODUCT_UID --P.ARTICLE_CODE = D.ARTICLE_CODE   AND P.PARA1_CODE = D.PARA1_CODE AND P.PARA2_CODE  = D.PARA2_CODE  
   '    
   SET @CCMD2 = N' LEFT OUTER JOIN    
   (SELECT T1.ARTICLE_CODE,T1.AVG_QTY,T1.PARA1_CODE,T1.PARA2_CODE,SUM(T1.QUANTITY) AS TOTAL_RECEIVE_QTY     
   FROM PRD_ISSUE_MATERIAL_DET T1     
   JOIN PRD_ISSUE_MATERIAL_MST T2 ON T1.MEMO_ID = T2.MEMO_ID     
   JOIN PRD_MATERIAL_RECEIPT_MST T3 ON T3.REF_PRD_MATERIAL_ISSUE_MEMOID = T2.MEMO_ID     
   WHERE  T2.REF_PRD_WORKORDER_MEMOID = '''+@CREFWORKORDERMEMOID+'''     
   AND T1.REF_COMPONENT_ARTICLE_CODE = '''+@CCOMPONENTID+'''    
   AND T2.TARGET_DEPARTMENT_ID = '''+@CDEPTID+'''    
   AND T2.CANCELLED = 0 AND T1.TYPE = 1    
   GROUP BY T1.ARTICLE_CODE,T1.AVG_QTY,T1.PARA1_CODE,T1.PARA2_CODE)    
   REC ON REC.ARTICLE_CODE = D.ARTICLE_CODE AND REC.PARA1_CODE =  D.PARA1_CODE  AND REC.PARA2_CODE = D.PARA2_CODE    
   LEFT OUTER JOIN     
   (SELECT D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,SUM(D.QUANTITY) AS TOTAL_OP_QTY FROM PRD_OP_MATERIAL_CON_DET D     
   JOIN PRD_OP_MATERIAL_CON_MST M ON M.MEMO_ID = D.MEMO_ID     
   WHERE  M.REF_PRD_WORKORDER_MEMOID = '''+@CREFWORKORDERMEMOID+'''     
   AND M.REF_COMPONENT_ARTICLE_CODE = '''+@CCOMPONENTID+'''    
   AND M.SOURCE_DEPARTMENT_ID = '''+@CDEPTID+'''    
   AND M.CANCELLED = 0 GROUP BY D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE)    
   OP ON OP.ARTICLE_CODE = D.ARTICLE_CODE AND OP.PARA1_CODE = D.PARA1_CODE  AND OP.PARA2_CODE = D.PARA2_CODE     
   WHERE D.MEMO_ID = '''+@CMEMOID+''''    
       
   PRINT @CCMD + @CCMD2    
   EXECUTE (@CCMD + @CCMD2)    
 END    
    
 IF(@OUTPUTTYPE = 1)    
 BEGIN    
   SET @CCMD = N'SELECT CAST(1 AS BIT) AS CHCK    
   ,C.UOM_NAME,D.*    
   ,B.ARTICLE_NO,B.ARTICLE_NAME,PARA1.PARA1_NAME,PARA2.PARA2_NAME    
   ,ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK    
   ,ISNULL(REC.TOTAL_REC_QTY,0) AS TOTAL_REC_QTY      
   ,ISNULL(OP.TOTAL_OP_QTY,0) AS TOTAL_OP_QTY      
   ,ISNULL(CC.TOTAL_CC_QTY,0) AS TOTAL_CC_QTY     
   ,(ISNULL(REC.TOTAL_REC_QTY,0) - (ISNULL(OP.TOTAL_OP_QTY,0) + ISNULL(CC.TOTAL_CC_QTY,0))) AS BALANCE_QTY     
   FROM PRD_OP_MATERIAL_CON_DET D    
   JOIN ARTICLE B ON D.ARTICLE_CODE  = B.ARTICLE_CODE     
   JOIN UOM C ON B.UOM_CODE = C.UOM_CODE      
   JOIN PARA1 ON PARA1.PARA1_CODE = D.PARA1_CODE    
   JOIN PARA2 ON PARA2.PARA2_CODE = D.PARA2_CODE    
   LEFT OUTER JOIN   
   (  
    SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP    
    ,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE,SKU.COM_PARA2_CODE         
    FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID     
      
    WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +''' AND SKU.WORK_ORDER_ID = '''+@CREFWORKORDERMEMOID+'''  
   ) P ON P.PRODUCT_UID=D.PRODUCT_UID-- P.ARTICLE_CODE = D.ARTICLE_CODE  AND P.PARA1_CODE = D.PARA1_CODE   
   --AND P.PARA2_CODE  = D.PARA2_CODE    
   '    
   SET @CCMD2 = N' LEFT OUTER JOIN     
   (SELECT T1.ARTICLE_CODE,T1.AVG_QTY,T1.PARA1_CODE,T1.PARA2_CODE,SUM(T1.QUANTITY) AS TOTAL_REC_QTY     
   FROM PRD_ISSUE_MATERIAL_DET T1     
   JOIN PRD_ISSUE_MATERIAL_MST T2 ON T1.MEMO_ID = T2.MEMO_ID     
   JOIN PRD_MATERIAL_RECEIPT_MST T3 ON T3.REF_PRD_MATERIAL_ISSUE_MEMOID = T2.MEMO_ID     
   WHERE  T2.REF_PRD_WORKORDER_MEMOID = '''+@CREFWORKORDERMEMOID+'''     
   AND T1.REF_COMPONENT_ARTICLE_CODE = '''+@CCOMPONENTID +'''    
   AND T2.TARGET_DEPARTMENT_ID = '''+@CDEPTID+''' AND T2.CANCELLED = 0 AND T1.TYPE = 0    
   GROUP BY T1.ARTICLE_CODE,T1.AVG_QTY,T1.PARA1_CODE,T1.PARA2_CODE)    
   REC ON REC.ARTICLE_CODE = D.ARTICLE_CODE AND REC.PARA1_CODE = D.PARA1_CODE     
   LEFT OUTER JOIN     
   (SELECT B.ARTICLE_CODE,B.AVG_QTY,B.PARA1_CODE,B.PARA2_CODE,SUM(B.QUANTITY) AS  TOTAL_OP_QTY    
   FROM PRD_OP_MATERIAL_CON_RWM_DET B JOIN PRD_OP_MATERIAL_CON_MST A ON A.MEMO_ID = B.MEMO_ID     
   WHERE A.REF_PRD_WORKORDER_MEMOID = '''+@CREFWORKORDERMEMOID+'''     
   AND A.SOURCE_DEPARTMENT_ID = '''+@CDEPTID+''' AND    
   A.REF_COMPONENT_ARTICLE_CODE ='''+@CCOMPONENTID+''' AND A.CANCELLED = 0    
   GROUP BY B.ARTICLE_CODE,B.AVG_QTY,B.PARA1_CODE,B.PARA2_CODE)     
   OP ON OP.ARTICLE_CODE = D.ARTICLE_CODE AND OP.PARA1_CODE = D.PARA1_CODE    
   LEFT OUTER JOIN     
   (SELECT D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,D.AVG_QTY,SUM(D.QUANTITY) AS TOTAL_CC_QTY      
   FROM PRD_DEPARTMENT_RMCONSUMPTION_DET D     
   JOIN PRD_DEPARTMENT_OUTPUT_MST M ON M.MEMO_ID = D.MEMO_ID    
   WHERE M.REF_PRD_WORKORDER_MEMOID = '''+@CREFWORKORDERMEMOID+'''     
   AND M.DEPARTMENT_ID = '''+@CDEPTID+'''     
   AND D.REF_FINISHED_ARTICLE_CODE = '''+@CCOMPONENTID+''' AND M.CANCELLED= 0    
   GROUP BY  D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,D.AVG_QTY) CC ON     
   CC.ARTICLE_CODE = D.ARTICLE_CODE AND CC.PARA1_CODE = D.PARA1_CODE     
   WHERE D.MEMO_ID = '''+@CMEMOID+''''    
   PRINT @CCMD + @CCMD2    
   EXECUTE (@CCMD + @CCMD2)    
 END    
    
    
GOTO LAST    
    
LBLGETDEPARTMENT:    
 SELECT * FROM PRD_DEPARTMENT_MST WHERE DEPARTMENT_ID <> @CWHERE AND INACTIVE = 0    
GOTO LAST    
    
LBLGETWORKORDERMASTER:    
 SELECT DISTINCT T1.*,CONVERT(CHAR(10),ISNULL(T1.MEMO_DT,''),105) AS MEMO_DATE    
    FROM PRD_WO_MST T1    
    JOIN PRD_WO_DET T2 ON T2.MEMO_ID = T1.MEMO_ID    
    WHERE T1.CANCELLED = 0 AND T1.MARK_AS_COMPLETED =1     
    AND T1.MEMO_ID IN     
    (SELECT DISTINCT  B.REF_PRD_WORKORDER_MEMOID FROM PRD_MATERIAL_RECEIPT_MST R  
   JOIN PRD_ISSUE_MATERIAL_MST I ON R.REF_PRD_MATERIAL_ISSUE_MEMOID = I.MEMO_ID 
   JOIN PRD_ISSUE_MATERIAL_DET B ON B.MEMO_ID=I.MEMO_ID      
   WHERE R.DEPARTMENT_ID = @CWHERE     
   )    
       
GOTO LAST    
    
LBLGETWORKORDERDETAILS:    
    
IF @NNAVMODE = 0    
  BEGIN    
   SET @CCMD = N'SELECT CAST( 0 AS BIT) AS CHCK,D.UOM_NAME,    
   (ISNULL(REC.TOTAL_RECEIVE_QTY,0) - ISNULL(OP.TOTAL_OP_QTY,0)) AS QUANTITY,    
    A.ROW_ID AS REF_PRD_WO_DET_ROW_ID,1 AS AVG_QTY,    
   M.PARA1_CODE,B.ARTICLE_NO,B.ARTICLE_NAME,PARA1.PARA1_NAME,M.PARA2_CODE     
   ,PARA2.PARA2_NAME,A.ARTICLE_CODE ,A.ROW_ID AS ROW_ID ,CAST(0 AS VARCHAR(40)) AS REF_ROW_ID      
   ,ISNULL(P.WIP,0) AS QUANTITY_IN_STOCK ,ISNULL(REC.TOTAL_RECEIVE_QTY,0) AS TOTAL_REC_QTY    
   ,ISNULL(OP.TOTAL_OP_QTY,0) AS TOTAL_OP_QTY ,0 AS TOTAL_CC_QTY    
   ,(ISNULL(REC.TOTAL_RECEIVE_QTY,0) - ISNULL(OP.TOTAL_OP_QTY,0)) AS BALANCE_QTY,    
   P.MRP,P.WS_PRICE,P.PURCHASE_PRICE,CAST(0 AS NUMERIC(10,2)) AS PURCHASE_PRICE,P.PRODUCT_UID       
   FROM PRD_WO_DET A JOIN PRD_WO_SUB_DET M ON M.REF_ROW_ID = A.ROW_ID     
    JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE JOIN UOM D ON B.UOM_CODE = D.UOM_CODE     
    LEFT OUTER JOIN     
    (  
    SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP,    
    SKU.MRP,SKU.WS_PRICE,SKU.PURCHASE_PRICE   
    ,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE,SKU.COM_PARA2_CODE           
   FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID     
   WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +''' AND SKU.WORK_ORDER_ID = '''+@CMEMOID+'''  
   ) P  ON P.ARTICLE_CODE = A.ARTICLE_CODE AND P.PARA1_CODE =  M.PARA1_CODE    
   AND P.PARA2_CODE = M.PARA2_CODE AND P.COMPONENT_CODE=A.ARTICLE_CODE  
    JOIN PARA1 ON PARA1.PARA1_CODE = M.PARA1_CODE JOIN PARA2 ON PARA2.PARA2_CODE = M.PARA2_CODE '    
        
    SET @CCMD1 = N' LEFT OUTER JOIN     
   (SELECT T1.ARTICLE_CODE,T1.AVG_QTY,T1.PARA1_CODE,T1.PARA2_CODE,SUM(T1.QUANTITY) AS TOTAL_RECEIVE_QTY     
   FROM PRD_ISSUE_MATERIAL_DET T1     
   JOIN PRD_ISSUE_MATERIAL_MST T2 ON T1.MEMO_ID = T2.MEMO_ID     
   JOIN PRD_MATERIAL_RECEIPT_MST T3 ON T3.REF_PRD_MATERIAL_ISSUE_MEMOID = T2.MEMO_ID     
   WHERE  T2.REF_PRD_WORKORDER_MEMOID = '''+@CMEMOID+'''      
   AND T1.REF_COMPONENT_ARTICLE_CODE = '''+@CPRODUCTCODE+'''    
   AND T2.TARGET_DEPARTMENT_ID = '''+@CWHERE+'''    
   AND T2.CANCELLED = 0 AND T1.TYPE = 1    
   GROUP BY T1.ARTICLE_CODE,T1.AVG_QTY,T1.PARA1_CODE,T1.PARA2_CODE  
   ) REC ON REC.ARTICLE_CODE = A.ARTICLE_CODE AND REC.PARA1_CODE =  M.PARA1_CODE  AND REC.PARA2_CODE = M.PARA2_CODE    
    
   LEFT OUTER JOIN     
    
   (SELECT D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,SUM(D.QUANTITY) AS TOTAL_OP_QTY   
   FROM PRD_OP_MATERIAL_CON_DET D     
   JOIN PRD_OP_MATERIAL_CON_MST M ON M.MEMO_ID = D.MEMO_ID     
   WHERE  M.REF_PRD_WORKORDER_MEMOID = '''+@CMEMOID+'''      
   AND M.REF_COMPONENT_ARTICLE_CODE = '''+@CPRODUCTCODE+'''    
   AND M.SOURCE_DEPARTMENT_ID = '''+@CWHERE+'''    
   AND M.CANCELLED = 0   
   GROUP BY D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE  
   )     OP ON OP.ARTICLE_CODE = A.ARTICLE_CODE AND OP.PARA1_CODE = M.PARA1_CODE    
   AND OP.PARA2_CODE = M.PARA2_CODE     
   WHERE A.MEMO_ID ='''+@CMEMOID+'''      
   AND A.ARTICLE_CODE = '''+@CPRODUCTCODE+''' AND ISNULL(P.WIP,0) > 0 '    
    PRINT @CCMD + @CCMD1    
   EXECUTE (@CCMD + @CCMD1)    
  END    
 ELSE    
  BEGIN    
   SET @CCMD = N'SELECT CAST(0 AS BIT) AS CHCK,ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,    
   D.UOM_NAME,(ISNULL(REC.TOTAL_REC_QTY,0) - (ISNULL(OP.TOTAL_OP_QTY,0) + ISNULL(CC.TOTAL_CC_QTY,0))) AS QUANTITY,A.ROW_ID AS REF_PRD_WO_BOM_ROW_ID,    
   (A.BOM_ARTICLE_CODE + P.PRODUCT_UID ) AS ROW_ID,    
   A.*,B.*,PARA1.PARA1_NAME  ,PARA2.PARA2_NAME     
   ,ISNULL(REC.TOTAL_REC_QTY,0) AS TOTAL_REC_QTY      
   ,ISNULL(OP.TOTAL_OP_QTY,0) AS TOTAL_OP_QTY      
   ,ISNULL(CC.TOTAL_CC_QTY,0) AS TOTAL_CC_QTY     
   ,(ISNULL(REC.TOTAL_REC_QTY,0) - (ISNULL(OP.TOTAL_OP_QTY,0) + ISNULL(CC.TOTAL_CC_QTY,0))) AS BALANCE_QTY     
   ,P.MRP,P.WS_PRICE,CAST(0 AS NUMERIC(10,2)) AS PURCHASE_PRICE--P.PURCHASE_PRICE  
   ,P.PRODUCT_UID    
   FROM PRD_WO_ART_BOM A     
    JOIN ARTICLE B ON A.BOM_ARTICLE_CODE = B.ARTICLE_CODE     
    JOIN PRD_WO_DET C ON A.REF_ROW_ID = C.ROW_ID     
    JOIN UOM D ON B.UOM_CODE = D.UOM_CODE     
    JOIN PARA1 ON PARA1.PARA1_CODE = A.PARA1_CODE    
    JOIN PARA2 ON PARA2.PARA2_CODE = A.PARA2_CODE    
    LEFT JOIN     
    (SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP,    
    SKU.MRP,SKU.WS_PRICE,SKU.PURCHASE_PRICE   
        ,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE,SKU.COM_PARA2_CODE       
   FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID     
   WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +''' AND SKU.WORK_ORDER_ID = '''+@CMEMOID+'''  
   ) P     ON P.ARTICLE_CODE = A.BOM_ARTICLE_CODE AND P.PARA1_CODE = A.PARA1_CODE   
   AND P.PARA2_CODE = A.PARA2_CODE AND C.ARTICLE_CODE=P.COMPONENT_CODE'    
        
    SET @CCMD1 = N' LEFT OUTER JOIN     
   (SELECT T1.ARTICLE_CODE,T1.AVG_QTY,T1.PARA1_CODE,T1.PARA2_CODE,SUM(T1.QUANTITY) AS TOTAL_REC_QTY     
   FROM PRD_ISSUE_MATERIAL_DET T1     
   JOIN PRD_ISSUE_MATERIAL_MST T2 ON T1.MEMO_ID = T2.MEMO_ID     
   JOIN PRD_MATERIAL_RECEIPT_MST T3 ON T3.REF_PRD_MATERIAL_ISSUE_MEMOID = T2.MEMO_ID     
   WHERE  T2.REF_PRD_WORKORDER_MEMOID = '''+@CMEMOID+'''     
   AND T1.REF_COMPONENT_ARTICLE_CODE = '''+@CPRODUCTCODE+'''     
   AND T2.TARGET_DEPARTMENT_ID = '''+@CWHERE+''' AND T2.CANCELLED = 0 AND T1.TYPE = 0    
   GROUP BY T1.ARTICLE_CODE,T1.AVG_QTY,T1.PARA1_CODE,T1.PARA2_CODE)    
   REC ON REC.ARTICLE_CODE = A.BOM_ARTICLE_CODE AND REC.PARA1_CODE = A.PARA1_CODE AND REC.PARA2_CODE = A.PARA2_CODE     
   LEFT OUTER JOIN     
   (SELECT B.ARTICLE_CODE,B.AVG_QTY,B.PARA1_CODE,B.PARA2_CODE,SUM(B.QUANTITY) AS  TOTAL_OP_QTY    
   FROM PRD_OP_MATERIAL_CON_RWM_DET B JOIN PRD_OP_MATERIAL_CON_MST A ON A.MEMO_ID = B.MEMO_ID     
   WHERE A.REF_PRD_WORKORDER_MEMOID = '''+@CMEMOID+'''    
   AND A.SOURCE_DEPARTMENT_ID = '''+@CWHERE+''' AND    
   A.REF_COMPONENT_ARTICLE_CODE ='''+@CPRODUCTCODE+''' AND A.CANCELLED = 0    
   GROUP BY B.ARTICLE_CODE,B.AVG_QTY,B.PARA1_CODE,B.PARA2_CODE)     
   OP ON OP.ARTICLE_CODE = A.BOM_ARTICLE_CODE AND OP.PARA1_CODE = A.PARA1_CODE AND OP.PARA2_CODE = A.PARA2_CODE    
   LEFT OUTER JOIN     
   (SELECT D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,D.AVG_QTY,SUM(D.QUANTITY) AS TOTAL_CC_QTY      
   FROM PRD_DEPARTMENT_RMCONSUMPTION_DET D     
   JOIN PRD_DEPARTMENT_OUTPUT_MST M ON M.MEMO_ID = D.MEMO_ID    
   WHERE M.REF_PRD_WORKORDER_MEMOID = '''+@CMEMOID+'''     
   AND M.DEPARTMENT_ID = '''+@CWHERE+'''     
   AND D.REF_FINISHED_ARTICLE_CODE = '''+@CPRODUCTCODE+''' AND M.CANCELLED= 0    
   GROUP BY  D.ARTICLE_CODE,D.PARA1_CODE,D.PARA2_CODE,D.AVG_QTY) CC ON     
   CC.ARTICLE_CODE = A.BOM_ARTICLE_CODE AND CC.PARA1_CODE = A.PARA1_CODE AND CC.PARA2_CODE = A.PARA2_CODE     
   WHERE C.MEMO_ID = '''+@CMEMOID+''' AND C.ARTICLE_CODE = '''+@CPRODUCTCODE+''' AND P.COM_PARA1_CODE ='''+@CWHERE1+''' AND P.COM_PARA2_CODE='''+@CWHERE2+''' 
   AND ISNULL(P.QUANTITY_IN_STOCK,0) > 0'    
    PRINT @CCMD + @CCMD1    
   EXECUTE (@CCMD + @CCMD1)    
  END    
     
GOTO LAST    
    
LBLGETORDERWISEITEMS:    
IF @NNAVMODE = 0    
  BEGIN    
   SET @CCMD = N'SELECT CAST(0 AS BIT) AS CHCK,ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,    
   D.UOM_NAME,CAST(0 AS NUMERIC(10,2)) AS QUANTITY,A.ROW_ID AS REF_PRD_WO_BOM_ROW_ID,    
   A.*,B.*,PARA1.PARA1_NAME,PARA2.PARA2_NAME,P.PRODUCT_UID ,P.PURCHASE_PRICE     
   FROM PRD_WO_ART_BOM A     
    JOIN ARTICLE B ON A.BOM_ARTICLE_CODE = B.ARTICLE_CODE     
    JOIN PRD_WO_DET C ON A.REF_ROW_ID = C.ROW_ID     
    JOIN UOM D ON B.UOM_CODE = D.UOM_CODE     
    JOIN PARA1 ON PARA1.PARA1_CODE = A.PARA1_CODE    
    JOIN PARA2 ON PARA2.PARA2_CODE = A.PARA2_CODE    
    LEFT OUTER JOIN     
    (SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP     
    ,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE,SKU.COM_PARA2_CODE ,SKU.PURCHASE_PRICE    
   FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID     
   WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +''' AND SKU.WORK_ORDER_ID = '''+@CMEMOID+'''  
   ) P ON P.ARTICLE_CODE = A.BOM_ARTICLE_CODE AND P.PARA1_CODE = A.PARA1_CODE AND P.PARA2_CODE = A.PARA2_CODE    
   AND P.COMPONENT_CODE=C.ARTICLE_CODE  
    WHERE C.MEMO_ID = '''+@CMEMOID+'''    
    AND C.ARTICLE_CODE = '''+@CPRODUCTCODE+''' AND ISNULL(P.QUANTITY_IN_STOCK,0) > 0 AND P.COM_PARA1_CODE ='''+@CWHERE1+''' AND P.COM_PARA2_CODE='''+@CWHERE2+''''    
    PRINT @CCMD    
   EXECUTE SP_EXECUTESQL @CCMD    
  END    
ELSE    
  BEGIN    
   SET @CCMD = N'SELECT CAST(0 AS BIT) AS CHCK,ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,    
   D.UOM_NAME,CAST(0 AS NUMERIC(10,2)) AS QUANTITY,A.ROW_ID AS REF_PRD_WO_BOM_ROW_ID,    
   (A.BOM_ARTICLE_CODE + A.PARA1_CODE + A.PARA2_CODE) AS REF_ROW_ID,CAST(1 AS NUMERIC(10,2)) AS AVG_QTY,    
   A.*,B.*,PARA1.PARA1_NAME,PARA2.PARA2_NAME,P.PRODUCT_UID   ,P.PURCHASE_PRICE     
   FROM PRD_WO_ART_BOM A     
    JOIN ARTICLE B ON A.BOM_ARTICLE_CODE = B.ARTICLE_CODE     
    JOIN PRD_WO_DET C ON A.REF_ROW_ID = C.ROW_ID     
    JOIN UOM D ON B.UOM_CODE = D.UOM_CODE     
    JOIN PARA1 ON PARA1.PARA1_CODE = A.PARA1_CODE    
    JOIN PARA2 ON PARA2.PARA2_CODE = A.PARA2_CODE    
    LEFT OUTER JOIN     
    (SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP    
        ,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE,SKU.COM_PARA2_CODE ,SKU.PURCHASE_PRICE    
   FROM PRD_SKU SKU JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID     
   WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +''' AND SKU.WORK_ORDER_ID = '''+@CMEMOID+''') P     
   ON P.ARTICLE_CODE = A.BOM_ARTICLE_CODE AND P.PARA1_CODE = A.PARA1_CODE AND P.PARA2_CODE = A.PARA2_CODE    
    AND P.COMPONENT_CODE=C.ARTICLE_CODE   
    WHERE C.MEMO_ID = '''+@CMEMOID+'''    
    AND C.ARTICLE_CODE = '''+@CPRODUCTCODE+''' AND ISNULL(P.QUANTITY_IN_STOCK,0) > 0 AND P.COM_PARA1_CODE ='''+@CWHERE1+''' AND P.COM_PARA2_CODE='''+@CWHERE2+''' '    
    PRINT @CCMD    
   EXECUTE SP_EXECUTESQL @CCMD    
  END     
     
GOTO LAST    
    
LBLGETWODETAILS:    
 SET @CCMD = N'SELECT CAST(1 AS BIT) AS CHCK,B.*,A.ARTICLE_CODE,A.ARTICLE_NAME,A.ARTICLE_NO    
   ,A.ARTICLE_DESC,U.UOM_NAME,     
   PARA1.PARA1_NAME,PARA2.PARA2_NAME    
   ,ISNULL(P.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK ,P.PURCHASE_PRICE     
   FROM     
   PRD_OP_MATERIAL_CON_RWM_DET B     
   JOIN PRD_OP_MATERIAL_CON_MST M ON B.MEMO_ID = M.MEMO_ID     
   JOIN ARTICLE A ON B.ARTICLE_CODE = A.ARTICLE_CODE     
   JOIN UOM U ON A.UOM_CODE = U.UOM_CODE     
   JOIN PARA1 ON PARA1.PARA1_CODE = B.PARA1_CODE    
   JOIN PARA2 ON PARA2.PARA2_CODE = B.PARA2_CODE    
   LEFT OUTER JOIN   
   (  
    SELECT SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,    
    SKU.PRODUCT_UID,PMT.QUANTITY_IN_STOCK,PMT.WIP,SKU.WORK_ORDER_ID        
    ,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE,SKU.COM_PARA2_CODE   ,SKU.PURCHASE_PRICE     
    FROM PRD_SKU SKU   
    JOIN PRD_PMT PMT ON SKU.PRODUCT_UID = PMT.PRODUCT_UID     
    WHERE PMT.DEPARTMENT_ID = '''+ @CWHERE +'''  
   ) P ON P.PRODUCT_UID=B.PRODUCT_UID --P.ARTICLE_CODE = B.ARTICLE_CODE AND P.PARA1_CODE = B.PARA1_CODE AND P.PARA2_CODE = B.PARA2_CODE     
   AND P.WORK_ORDER_ID = M.REF_PRD_WORKORDER_MEMOID    
   WHERE B.MEMO_ID = '''+@CMEMOID+''''    
     
 PRINT @CCMD    
 EXECUTE SP_EXECUTESQL @CCMD    
    
 GOTO LAST    
    
LBLGETLEDGERS:    
 SELECT T1.* FROM LMV01106 T1    
 JOIN PRD_AGENCY_MST T2 ON T1.AC_CODE = T2.AC_CODE    
 GOTO LAST    
    
LBLGETJOBS:    
 SELECT DISTINCT JOBS.* FROM PRD_WO_DET D     
 JOIN PRD_WO_ART_JOBS J ON D.ROW_ID = J.REF_ROW_ID     
 JOIN JOBS ON J.JOB_CODE = JOBS.JOB_CODE     
 WHERE D.MEMO_ID =@CMEMOID     
 ORDER BY JOBS.JOB_NAME    
 GOTO LAST    
    
LBLGETCOMPONENT:    
    
 SELECT A.ROW_ID,B.ARTICLE_CODE,B.ARTICLE_NO ,WOS.PARA1_CODE AS COM_PARA1_CODE,WOS.PARA2_CODE AS COM_PARA2_CODE,  
PC1.PARA1_NAME, PC2.PARA2_NAME    ,B.ARTICLE_CODE+'-'+WOS.PARA1_CODE AS UNIQUE_COL  
 FROM PRD_WO_DET A   
 JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE  
 JOIN PRD_WO_SUB_DET WOS ON WOS.REF_ROW_ID=A.ROW_ID     
 JOIN PARA1 PC1 ON PC1.PARA1_CODE=WOS.PARA1_CODE  
 JOIN PARA2 PC2 ON PC2.PARA2_CODE=WOS.PARA2_CODE  
 WHERE MEMO_ID = @CMEMOID     
 AND A.ARTICLE_CODE     
 IN(   
  SELECT D.REF_COMPONENT_ARTICLE_CODE FROM PRD_MATERIAL_RECEIPT_MST R    
  JOIN PRD_ISSUE_MATERIAL_MST I ON R.REF_PRD_MATERIAL_ISSUE_MEMOID = I.MEMO_ID     
  JOIN PRD_ISSUE_MATERIAL_DET D ON I.MEMO_ID = D.MEMO_ID    
  WHERE D.REF_PRD_WORKORDER_MEMOID = @CMEMOID AND R.DEPARTMENT_ID = @CWHERE AND I.CANCELLED=0    
  GROUP BY D.REF_COMPONENT_ARTICLE_CODE  
   )    
 GOTO LAST    
    
LBLINSTYPELIST:    
 SELECT CAST(0 AS BIT) AS CHK ,B.QI_TYPE_CODE,B.QI_TYPE_NAME,D.JOB_CODE    
 FROM QUALITY_INS_TYPES_JOBS A    
 JOIN JOBS D ON A.QI_JOB_CODE = D.JOB_CODE     
 JOIN QUALITY_INS_TYPES B ON A.QI_TYPE_CODE = B.QI_TYPE_CODE     
 WHERE D.JOB_CODE = @CWHERE     
     
 GOTO LAST      
    
LBLPARALIST:    
 SELECT CAST(0 AS BIT) AS CHK,B.QI_TYPE_CODE AS INS_TYPE_CODE,    
 E.QIPARA_CODE AS INS_PARA_CODE,E.QIPARA_NAME,    
 CAST(1 AS BIT) AS OK,CAST(0 AS BIT) AS NOTOK ,    
 CAST(0 AS BIT) AS OKWITHVARIATION,CAST('' AS VARCHAR(100)) AS REMARKS,CAST('' AS CHAR(20)) AS ROW_ID     
 FROM QUALITY_INS_TYPES_JOBS A    
 JOIN JOBS D ON A.QI_JOB_CODE = D.JOB_CODE     
 JOIN QUALITY_INS_TYPES B ON A.QI_TYPE_CODE = B.QI_TYPE_CODE     
 JOIN QUALITY_INS_TYPES_PARA  C ON B.QI_TYPE_CODE = C.QI_TYPE_CODE     
 JOIN QUALITY_INSPECTION_PARA E ON E.QIPARA_CODE =C.QI_PARA_CODE     
 WHERE D.JOB_CODE = @CWHERE     
GOTO LAST      
    
    
    
LBLOPINSTYPELIST:    
 SELECT DISTINCT CAST(1 AS BIT) AS CHK, B.QI_TYPE_CODE,B.QI_TYPE_NAME     
 FROM INSPECTION_XN_DET A    
 JOIN QUALITY_INS_TYPES B ON A.INS_TYPE_CODE = B.QI_TYPE_CODE     
 WHERE A.XN_MEMO_ID = @CMEMOID     
     
 UNION ALL    
     
 SELECT CAST(0 AS BIT) AS CHK ,B.QI_TYPE_CODE,B.QI_TYPE_NAME    
 FROM QUALITY_INS_TYPES_JOBS A    
 JOIN JOBS D ON A.QI_JOB_CODE = D.JOB_CODE     
 JOIN QUALITY_INS_TYPES B ON A.QI_TYPE_CODE = B.QI_TYPE_CODE     
 WHERE D.JOB_CODE = (SELECT JOB_CODE FROM PRD_OP_MATERIAL_CON_MST WHERE MEMO_ID = @CMEMOID )     
 AND B.QI_TYPE_CODE NOT IN (SELECT DISTINCT INS_TYPE_CODE FROM INSPECTION_XN_DET WHERE XN_MEMO_ID = @CMEMOID)    
GOTO LAST    
    
LBLOPPARALIST:    
 SELECT CAST(1 AS BIT) AS CHK    
 ,A.XN_MEMO_ID,A.XN_TYPE,A.INS_TYPE_CODE,A.INS_PARA_CODE    
 ,A.LAST_UPDATE,A.TS,A.OK,A.NOTOK,A.OKWITHVARIATION,A.REMARKS    
 ,E.QIPARA_NAME ,A.ROW_ID     
 FROM INSPECTION_XN_DET A    
 JOIN QUALITY_INSPECTION_PARA E ON A.INS_PARA_CODE =E.QIPARA_CODE      
 WHERE A.XN_MEMO_ID = @CMEMOID      
     
 UNION ALL    
     
 SELECT CAST(0 AS BIT) AS CHK    
 ,@CMEMOID  AS XN_MEMO_ID    
 ,'OMC' AS XN_TYPE     
 ,B.QI_TYPE_CODE AS INS_TYPE_CODE    
 ,E.QIPARA_CODE AS INS_PARA_CODE    
 ,CAST('' AS DATETIME) AS LAST_UPDATE    
 ,CAST('' AS TIMESTAMP) AS TS    
 ,CAST(1 AS BIT) AS OK    
 ,CAST(0 AS BIT) AS NOTOK     
 ,CAST(0 AS BIT) AS OKWITHVARIATION    
 ,CAST('' AS VARCHAR(100)) AS REMARKS    
 ,E.QIPARA_NAME   
 ,CAST('' AS CHAR(20)) AS ROW_ID     
 FROM QUALITY_INS_TYPES_JOBS A    
 JOIN JOBS D ON A.QI_JOB_CODE = D.JOB_CODE     
 JOIN QUALITY_INS_TYPES B ON A.QI_TYPE_CODE = B.QI_TYPE_CODE     
 JOIN QUALITY_INS_TYPES_PARA  C ON B.QI_TYPE_CODE = C.QI_TYPE_CODE     
 JOIN QUALITY_INSPECTION_PARA E ON E.QIPARA_CODE =C.QI_PARA_CODE     
 LEFT OUTER JOIN      
 (SELECT INS_PARA_CODE,INS_TYPE_CODE FROM INSPECTION_XN_DET WHERE XN_MEMO_ID = @CMEMOID)     
 SUB ON SUB.INS_PARA_CODE = E.QIPARA_CODE AND SUB.INS_TYPE_CODE = B.QI_TYPE_CODE     
 WHERE D.JOB_CODE  = (SELECT JOB_CODE FROM PRD_OP_MATERIAL_CON_MST WHERE MEMO_ID = @CMEMOID )    
 AND SUB.INS_PARA_CODE IS NULL    
     
 GOTO LAST     
    
LAST:    
END
