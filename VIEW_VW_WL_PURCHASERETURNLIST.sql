CREATE VIEW VW_WL_PURCHASERETURNLIST      

AS       
SELECT  T3.AC_NAME AS SUPPLIER_NAME,CASE WHEN T1.DN_TYPE=1 THEN 'REGULAR' WHEN T1.DN_TYPE=2 THEN 'FININCIAL' ELSE '' END AS [MEMO_TYPE],    
CASE WHEN T1.MODE=1  THEN 'PARTY DEBIT NOTE' WHEN T1.MODE=2 THEN 'GROUP DEBIT NOTE' ELSE '' END AS MEMO_MODE,    
CASE WHEN T1.APPROVED=1 OR T1.APPROVED=0 THEN 'PENDING FOR APPROVAL' WHEN T1.APPROVED=2 THEN 'APPROVED' WHEN T1.APPROVED=3 THEN 'DISAPPROVED' ELSE '' END AS [STATUS],    
T1.RM_DT AS MEMO_DT, T1.RM_NO AS MEMO_NO,      
(CASE WHEN T1.CANCELLED = 0 THEN T1.SUBTOTAL ELSE 0 END) AS GROSS_RETURN_VALUE,      
T1.DISCOUNT_PERCENTAGE AS DISCOUNT_PERCENTAGE ,      
(CASE WHEN T1.CANCELLED = 0 THEN T1.DISCOUNT_AMOUNT ELSE 0 END) AS DISCOUNT_AMOUNT ,      
(CASE WHEN T1.CANCELLED = 0 THEN T1.FREIGHT ELSE 0 END) AS FREIGHT,      
(CASE WHEN T1.CANCELLED = 0 THEN T1.OTHER_CHARGES ELSE 0 END) AS OTHER_CHARGES,      
(CASE WHEN T1.CANCELLED = 0 THEN T1.TOTAL_AMOUNT ELSE 0 END) AS NET_RETURN_VALUE,      
T1.ROUND_OFF,      
T1.REMARKS , 
CASE WHEN ISNULL(T1.CN_NO,'')='' THEN 'NOT RECEIVED'  ELSE 'RECEIVED' END AS CN_RECEIVE,      
ISNULL(T1.CN_AMOUNT,0) AS CN_AMOUNT ,    
(CASE WHEN T1.CANCELLED = 1 THEN 0 ELSE ISNULL(T2.TOTAL_QUANTITY,0) END) AS TOTAL_QUANTITY,      
(CASE WHEN T1.CANCELLED = 1 THEN 0 ELSE ISNULL(T2.ITEM_GROSS_RETURN_VALUE,0) END) AS ITEM_GROSS_RETURN_VALUE,      
T1.RM_ID AS MEMO_ID,    
(CASE WHEN T1.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END) AS CANCELLED  ,    
(CASE WHEN T1.POSTEDINAC= 1 THEN 'POSTED' ELSE 'PENDING' END) AS AC_POSTED    
,T1.FIN_YEAR  ,COM.COMPANY_CODE,T1.MEMO_TYPE AS ER_FLAG,    
L.DEPT_ID  AS LOC_ID,L.DEPT_NAME AS LOC_NAME ,  
F.FORM_NAME AS TAX_TYPE,T2.TAX_PERCENTAGE ,T2.TAX_AMOUNT,
ISNULL(P.PARCEL_MEMO_NO,'') AS  PARCEL_MEMO_NO,  
ISNULL(P.PARCEL_MEMO_DT,'') AS  PARCEL_MEMO_DT,   
ISNULL(P.BILTY_NO,'') AS  BILTY_NO,  
ISNULL(AN.ANGADIA_NAME,'') AS  PARCEL_TRANSPORTER_NAME,  
ISNULL(LM.AC_NAME,'') AS  PARCEL_AC_NAME,
ISNULL(P.TOTAL_AMOUNT,0) AS  TOTAL_AMOUNT 

FROM RMM01106 T1      
JOIN LMV01106 T3 ON T3.AC_CODE = T1.AC_CODE  
LEFT OUTER JOIN parcel_det   B ON B.REF_MEMO_ID=T1.RM_ID 
LEFT OUTER JOIN PARCEL_MST P ON P.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID AND P.XN_TYPE='PRT'
LEFT OUTER JOIN LM01106 LM ON LM.AC_CODE=b.AC_CODE      
LEFT OUTER JOIN ANGM AN ON AN.ANGADIA_CODE=P.ANGADIA_CODE     

LEFT OUTER JOIN       
(  
  SELECT RM_ID,ITEM_FORM_ID,ITEM_TAX_PERCENTAGE AS TAX_PERCENTAGE,  
         SUM(QUANTITY) AS TOTAL_QUANTITY,SUM(QUANTITY*PURCHASE_PRICE) AS ITEM_GROSS_RETURN_VALUE,  
         SUM(ITEM_TAX_AMOUNT) AS TAX_AMOUNT      
 FROM RMD01106 GROUP BY RM_ID,ITEM_FORM_ID,ITEM_TAX_PERCENTAGE  
)  T2 ON T2.RM_ID=T1.RM_ID     
 LEFT OUTER JOIN COMPANY COM ON 1=1 AND COM.COMPANY_CODE='01'    
 LEFT OUTER JOIN LOCATION  L (NOLOCK) ON T1.location_code/*LEFT(T1.RM_ID,2)*//*Rohit 05-11-2024*/ = L.DEPT_ID        
LEFT OUTER JOIN FORM F ON T2.ITEM_FORM_ID = F.FORM_ID
