CREATE PROCEDURE SP3S_TARGET_LINKED_SALEPERSON_INCENTIVE_REPORT  
(  
@CDEPT_ID VARCHAR(5),  
@MONTH VARCHAR(10),  
@FIN_YEAR VARCHAR(10)  
)  
AS  
BEGIN  
   
        DECLARE @CCMD NVARCHAR(MAX),@CTARGET_MONTH VARCHAR(5),@TARGET_ACH_PER NUMERIC(10,2),@TARGET_ACH_PER_FINAL NUMERIC(10,2)  
        DECLARE @TABLE TABLE(LOCATION VARCHAR(100),TARGET INT,SALE INT,TARGET_ACH_PER INT,EMP_CODE VARCHAR(100),EMP_NAME VARCHAR(100),  
        SALEWITH1 VARCHAR(100),SALEWITH2 VARCHAR(100),SALEWITH3 VARCHAR(100),  
        INCWITH1 VARCHAR(100),INCWITH2 VARCHAR(100),INCWITH3 VARCHAR(100),SALEAMOUNT VARCHAR(100),  
        INCAMT VARCHAR(100),INCPAYBLE VARCHAR(100),PAYBLE_AMOUNT VARCHAR(100) )  
          
        IF OBJECT_ID('TEMPDB..#TMP','U') IS NOT NULL  
        DROP TABLE  #TMP  
          
        IF OBJECT_ID('TEMPDB..#TMPNEW','U') IS NOT NULL  
        DROP TABLE  #TMPNEW  
          
        --SET @CTARGET_MONTH=''  
        --SET @CTARGET_MONTH=LEFT(@FIN_YEAR,4)  
          
       SET @CCMD=N'SELECT DEPT_NAME AS LOCATION,TARGET_AMOUNT AS TARGET,SUM(AMOUNT) AS SALE,  
                   CAST((SUM(AMOUNT)/TARGET_AMOUNT *100) AS INT) AS TARGET_ACH_PER ,
                    ''0000000'' AS EMP_CODE, 
                   '''' AS EMP_NAME, 
                  
                   '' '' AS SALEWITH1,  
                   '' '' AS SALEWITH2 ,'' '' AS SALEWITH3,  
                   '' '' AS INCWITH1,'' '' AS INCWITH2,'' '' AS INCWITH3,  
                   '' '' AS SALEAMOUNT,'''' AS INCAMT,'' '' AS INCPAYBLE,'' '' AS PAYBLE_AMOUNT  
  
        FROM LOCATION A JOIN LOC_SALE_TARGET B ON A.DEPT_ID=B.DEPT_ID  
        JOIN CMM01106 CMM ON CMM.LOCATION_CODE=A.DEPT_ID  
        JOIN PAYMODE_XN_DET  PAY ON PAY.MEMO_ID=CMM.CM_ID  
         
  WHERE CMM.CANCELLED=0 AND B.TARGET_MONTH='''+@MONTH+''' AND A.DEPT_ID='''+@CDEPT_ID+'''   
  AND B.FIN_YEAR='''+@FIN_YEAR+'''  
  AND MONTH(CM_DT)='''+@MONTH+''' GROUP BY DEPT_NAME,TARGET_AMOUNT'  
  PRINT @CCMD  
  INSERT INTO @TABLE(LOCATION,TARGET,SALE,TARGET_ACH_PER,EMP_CODE,EMP_NAME,SALEWITH1,SALEWITH2,SALEWITH3,  
  INCWITH1,INCWITH2,INCWITH3,SALEAMOUNT,INCAMT,INCPAYBLE,PAYBLE_AMOUNT)  
  EXEC SP_EXECUTESQL @CCMD  
    
    
   SELECT @TARGET_ACH_PER=TARGET_ACH_PER FROM @TABLE  
    IF  @TARGET_ACH_PER > 100  
    SET @TARGET_ACH_PER=100   
      
    SELECT @TARGET_ACH_PER_FINAL=ISNULL(INCENTIVE_PERCENTAGE,0)   
    FROM EMP_TARGET_INCENTIVE WHERE (FROM_VALUE <= @TARGET_ACH_PER AND TO_VALUE >=@TARGET_ACH_PER)  
      
    UPDATE @TABLE SET INCPAYBLE=FLOOR(@TARGET_ACH_PER_FINAL)  
    
     SELECT DISTINCT EMP INTO #TMP  
  FROM   
  (  
  SELECT EMP_CODE AS EMP FROM  CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID   
  WHERE CMM.LOCATION_CODE =@CDEPT_ID AND MONTH(CMM.CM_DT)=@MONTH AND FIN_YEAR='01117'  
  AND EMP_CODE <> '0000000'  
  
  UNION ALL  
  
  SELECT EMP_CODE1 AS EMP FROM  CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID   
  WHERE CMM.LOCATION_CODE=@CDEPT_ID AND MONTH(CMM.CM_DT)=@MONTH AND FIN_YEAR='01117'  
       AND EMP_CODE1 <> '0000000'  
  UNION ALL  
  
  
  SELECT EMP_CODE2 AS EMP FROM  CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID   
  WHERE CMM.LOCATION_CODE=@CDEPT_ID AND MONTH(CMM.CM_DT)=@MONTH AND FIN_YEAR='01117'  
  AND EMP_CODE2 <> '0000000'  
  )A  
    
   IF OBJECT_ID('TEMPDB..#TMPEMPSALE','U') IS NOT NULL  
   DROP TABLE #TMPEMPSALE  
    
  CREATE TABLE #TMPEMPSALE  
  (  
  EMP_CODE VARCHAR(7),  
  SALEWITH1 NUMERIC(10,2),  
  SALEWITH2 NUMERIC(10,2),  
  SALEWITH3  NUMERIC(10,2),  
  INCWITH1  NUMERIC(10,2),  
  INCWITH2  NUMERIC(10,2),  
  INCWITH3  NUMERIC(10,2) ,  
  SALEAMOUNT NUMERIC(10,2),  
  INCAMT NUMERIC(10,2),  
  INCPAYBLE NUMERIC(10,2),  
  PAYBLE_AMOUNT NUMERIC(10,2)  
  )  
    
  INSERT INTO #TMPEMPSALE (EMP_CODE)  
        SELECT * FROM #TMP  
    
    
      
  SET NOCOUNT ON  
  DECLARE @BLOOP BIT,@NCNT INT,@CEMP VARCHAR(7),@CEMP1SALE NUMERIC(10,2),  
  @CEMP2SALE NUMERIC(10,2),@CEMP3SALE NUMERIC(10,2),  
  @CEMP1INC NUMERIC(10,2),  
  @CEMP2INC NUMERIC(10,2),@CEMP3INC NUMERIC(10,2),@CSALEAMT NUMERIC(10,2),@CINCPAYBLE NUMERIC(10,2),  
  @CINCAMT NUMERIC(10,2)  
  SET @BLOOP=0  
  SET @NCNT=1  
  
  WHILE @BLOOP=0  
  BEGIN  
     
   SET @CEMP=''  
   SET @CEMP1SALE=0  
   SET @CEMP2SALE=0  
   SET @CEMP3SALE=0  
   SET @CEMP1INC=0   
   SET @CEMP2INC=0  
   SET @CEMP3INC=0   
   SET @CSALEAMT=0  
   SET @CINCAMT=0  
   SET @CINCPAYBLE=0  
   SET @NCNT=@NCNT+1  
   SELECT TOP 1 @CEMP=EMP FROM #TMP  
     
   IF ISNULL(@CEMP,'')=''  
    BREAK  
           
    SELECT @CEMP1SALE=ISNULL(SUM(NET),0) FROM CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID  
    WHERE CMM.LOCATION_CODE=@CDEPT_ID AND MONTH(CM_DT)=@MONTH AND EMP_CODE=@CEMP AND FIN_YEAR='01117'  
      
    SELECT @CEMP2SALE=ISNULL(SUM(NET),0) FROM CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID  
    WHERE CMM.LOCATION_CODE=@CDEPT_ID AND MONTH(CM_DT)=@MONTH AND EMP_CODE1=@CEMP AND FIN_YEAR='01117'  
      
    SELECT @CEMP3SALE=ISNULL(SUM(NET),0)  FROM CMM01106 CMM JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID  
    WHERE CMM.LOCATION_CODE=@CDEPT_ID AND MONTH(CM_DT)=@MONTH AND EMP_CODE2=@CEMP AND FIN_YEAR='01117'  
      
      
    SELECT @CEMP1INC=ISNULL(D.COM_PER_1,0),@CEMP2INC=ISNULL(D.COM_PER_2,0),@CEMP3INC=ISNULL(D.COM_PER_3,0)  
     FROM EMPLOYEE E JOIN EMPCATEGORY D ON D.CATEGORY_CODE=E.CATEGORY_CODE  
    WHERE  E.EMP_CODE=@CEMP   
      
      
    SET @CSALEAMT=SUM(@CEMP1SALE+@CEMP2SALE+@CEMP3SALE)  
    SET @CINCAMT=ROUND(SUM(((@CEMP1SALE * @CEMP1INC)/100)+((@CEMP2SALE * @CEMP2INC)/100)+((@CEMP3SALE * @CEMP3INC)/100)),0)  
                  
      
     
      
    SET @CINCPAYBLE=FLOOR((@CINCAMT * @TARGET_ACH_PER_FINAL /100))  
      
    UPDATE #TMPEMPSALE SET SALEWITH1=@CEMP1SALE,SALEWITH2=@CEMP2SALE,SALEWITH3=@CEMP3SALE  
            ,INCWITH1=@CEMP1INC,INCWITH2=@CEMP2INC,INCWITH3=@CEMP3INC,SALEAMOUNT=@CSALEAMT  
            ,INCAMT=@CINCAMT,PAYBLE_AMOUNT=@CINCPAYBLE  
           WHERE EMP_CODE=@CEMP  
  
     
     
   DELETE FROM #TMP WHERE EMP=@CEMP  
  END  
    
    
  SELECT LOCATION,TARGET,SALE,EC.CATEGORY_NAME ,ISNULL(EG.EMP_GRP_NAME,'') AS EMP_GRP_NAME,TARGET_ACH_PER,INCPAYBLE,A.EMP_NAME,SALEWITH1,SALEWITH2,SALEWITH3,INCWITH1,INCWITH2,  
  INCWITH3,SALEAMOUNT,INCAMT,PAYBLE_AMOUNT  
  FROM @TABLE A 
  JOIN EMPLOYEE B ON A.EMP_CODE=B.EMP_CODE   
  JOIN EMPCATEGORY EC ON EC.CATEGORY_CODE =B.CATEGORY_CODE 
  LEFT OUTER JOIN EMP_GRP_LINK EGL ON EGL.EMP_CODE=B.EMP_CODE 
  LEFT OUTER JOIN EMPLOYEE_GRP EG ON EG.EMP_GRP_CODE =EGL.EMP_GRP_CODE  
  UNION ALL  
  SELECT '' AS LOCATION,'' AS TARGET,'' AS SALE,EC.CATEGORY_NAME ,ISNULL(EG.EMP_GRP_NAME,'') AS EMP_GRP_NAME,'' AS TARGET_ACH_PER,  
  '' AS INCPAYBLE,EMP_NAME,CONVERT(VARCHAR(100),SALEWITH1),CONVERT(VARCHAR(100),SALEWITH2)  
  ,CONVERT(VARCHAR(100),SALEWITH3),  
  CONVERT(VARCHAR(100),INCWITH1),CONVERT(VARCHAR(100),INCWITH2),CONVERT(VARCHAR(100),INCWITH3),  
  CONVERT(VARCHAR(100),SALEAMOUNT),CONVERT(VARCHAR(100),INCAMT),CONVERT(VARCHAR(100),PAYBLE_AMOUNT)  
  FROM  #TMPEMPSALE A 
  JOIN EMPLOYEE B ON A.EMP_CODE=B.EMP_CODE   
  JOIN EMPCATEGORY EC ON EC.CATEGORY_CODE =B.CATEGORY_CODE 
  LEFT OUTER JOIN EMP_GRP_LINK EGL ON EGL.EMP_CODE=B.EMP_CODE 
  LEFT OUTER JOIN EMPLOYEE_GRP EG ON EG.EMP_GRP_CODE =EGL.EMP_GRP_CODE  
END
