CREATE PROCEDURE SP_SEND_MIRROR_DOCPO_OPT_DATA_NEW --(LocId 3 digit change by Sanjay:30-10-2024)
	 @CREQXNID VARCHAR(50)
	,@CTARGETLOCID VARCHAR(5)
	,@CREQCHALLANNO VARCHAR(20)=''
	,@CREQCHALLANFINYEAR VARCHAR(20)=''
	,@BACKNOWLEDGE BIT=0
	,@CERRMSG VARCHAR(1000) OUTPUT
AS
/*

	SP_SEND_MIRROR_DOCPO_OPT_DATA_NEW : THIS PROCEDURE USE TO SEND DOCPO DATA
*/
BEGIN
	DECLARE @DTSQL NVARCHAR(MAX),@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),
	@CTEMPEMPLOYEETABLE VARCHAR(200),@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),
	@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX),@CCUTOFFDATE VARCHAR(20),
	@CTEMPMASTERTABLE VARCHAR(200),@CTEMPDETAILTABLE VARCHAR(200),@CTEMPLMTABLE VARCHAR(200),
	@CTEMPLMPTABLE VARCHAR(200),@CTEMPAREATABLE VARCHAR(200),@CTEMPCITYTABLE VARCHAR(200),
	@CTEMPPMODEXNTABLE VARCHAR(200),@CTEMPPMODETABLE VARCHAR(200),@CSTNAPPROVAL BIT,
	@CCLOCID VARCHAR(10),@CHOLOCID VARCHAR(10),@BSENDPURINFOLOC BIT,
	@CTEMPSKUTABLE VARCHAR(500),@CTEMPSKUOHTABLE VARCHAR(500),
	@NTARGETLOCTYPE INT,@BTARGETPURLOC BIT,@CTEMPSLSBCTABLE VARCHAR(500),@CTEMPSLSDETTABLE VARCHAR(500), 
	@BGETCHALLANTHRUMIRROR BIT,@CPARTYDEPTID VARCHAR(5),@NMODE INT,
	@BCOMPLETED BIT,@BEXPORTED BIT,@CDISPATCHDETAILS VARCHAR(500),@CDONOTSENDCHALLANWODISPATCHDETAILS VARCHAR(2),
	@CJOINSTR VARCHAR(1000),@BTEMPDATADELETED BIT,@NSPID INT,@BDONOTSENDCHALLANWITHOUTDISPATCH BIT
	
	SET @NSPID = @@SPID
	
LBLSTART:
	
	PRINT 'ENTER SP_SEND_MIRROR_DOCPO_OPT_DATA_NEW'
	 	
	DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(500),TMP_TABLENAME VARCHAR(500),XN_ID VARCHAR(40))  

		

BEGIN TRY 	
			
	SET @CSTEP=10	
	SET @CFILTERCONDITION=''
	
	
	IF @BACKNOWLEDGE=1
		GOTO LBLTABLEINFO

	
	IF @CREQCHALLANNO<>''
	BEGIN
		SET @DTSQL=N'SELECT TOP 1 @CMEMOID=A.po_id,@DMEMOLASTUPDATE=A.LAST_UPDATE
					 FROM POM01106 A (NOLOCK) 
					 WHERE A.po_no='''+@CREQCHALLANNO+''' AND A.FIN_YEAR='''+@CREQCHALLANFINYEAR+''''
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL,N'@CMEMOID VARCHAR(50) OUTPUT,@DMEMOLASTUPDATE DATETIME OUTPUT',
		@CMEMOID OUTPUT,@DMEMOLASTUPDATE OUTPUT

		
		IF ISNULL(@CMEMOID,'')=''
		BEGIN
			SET @CERRMSG = 'po NO. :'+@CREQCHALLANNO+' NOT FOUND AT HEAD OFFICE FOR FINANCIAL YEAR :'+@CREQCHALLANFINYEAR
			GOTO END_PROC
		END
		
		SELECT @CPARTYDEPTID=DEPT_ID
		FROM pom01106 (NOLOCK) WHERE po_id =@CMEMOID
		

		
		IF @CPARTYDEPTID<>@CTARGETLOCID
		BEGIN
			SET @CERRMSG = 'PO NO. :'+@CREQCHALLANNO+' IS NOT CREATED FOR TARGET LOCATION :'+@CTARGETLOCID
			GOTO END_PROC
		END
		
     
		SET @CREQXNID=@CMEMOID
	        
	
					
	END	
 
LBLTABLEINFO:
	
	SET @CMEMOID = @CREQXNID

	IF @BACKNOWLEDGE=1
		GOTO END_PROC
		
	SET @CSTEP=50
	---- POPULATE LIST OF TABLES 
		
	PRINT 'SEND CHALLAN DIRECTLY OPT-2'
	
	SET @CFILTERCONDITION=' B.PO_ID='''+@CMEMOID+''''
	
	---- SEND THE PURCHASE ORDER MEMO MASTER TABLE
	
	SELECT 	@CMEMOID AS XN_ID,'DOCPO_POM01106_MIRROR' AS TARGET_TABLENAME,* FROM POM01106 (NOLOCK) WHERE PO_ID=@CMEMOID
	
	SELECT 	'DOCPO_POD01106_MIRROR' AS TARGET_TABLENAME,* FROM POD01106 (NOLOCK) WHERE PO_ID=@CMEMOID		
	
	SELECT 	DISTINCT 'DOCPO_SKU_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM SKU A (NOLOCK)
	JOIN POD01106 B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE WHERE PO_ID=@CMEMOID					

	
			
	SELECT 	DISTINCT 'DOCPO_LM01106_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM LM01106 A (NOLOCK)
	JOIN POM01106 C (NOLOCK) ON C.AC_CODE=A.AC_CODE
	WHERE PO_ID=@CMEMOID
	
	
	SELECT 	DISTINCT 'DOCPO_LMP01106_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM LMP01106 A (NOLOCK)
	JOIN POM01106 C (NOLOCK) ON C.AC_CODE=A.AC_CODE
	WHERE PO_ID=@CMEMOID						
				
	
	SELECT 	DISTINCT 'DOCPO_HD01106_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM HD01106 A (NOLOCK)
	JOIN LM01106 B (NOLOCK) ON A.HEAD_CODE=B.HEAD_CODE
	JOIN POM01106 D (NOLOCK) ON D.AC_CODE=B.AC_CODE
	WHERE PO_ID=@CMEMOID					
	
		
	SELECT 	DISTINCT 'DOCPO_ARTICLE_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM ARTICLE A (NOLOCK)
	JOIN POD01106 C (NOLOCK) ON C.ARTICLE_CODE=A.ARTICLE_CODE
	WHERE PO_ID=@CMEMOID
	UNION 
	SELECT 	DISTINCT 'DOCPO_ARTICLE_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM ARTICLE A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.ARTICLE_CODE=A.ARTICLE_CODE
	JOIN POD01106 C (NOLOCK) ON C.PRODUCT_CODE=b.PRODUCT_CODE
	WHERE PO_ID=@CMEMOID
	
	SELECT 	DISTINCT 'DOCPO_UOM_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,U.* 
	FROM UOM U(NOLOCK) 
	JOIN ARTICLE A (NOLOCK) ON A.UOM_CODE=U.UOM_CODE
	JOIN POD01106 C (NOLOCK) ON C.ARTICLE_CODE=A.ARTICLE_CODE
	WHERE PO_ID=@CMEMOID
	
	

	SELECT 	DISTINCT 'DOCPO_SECTIOND_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM SECTIOND A (NOLOCK)
	JOIN ARTICLE B (NOLOCK) ON B.SUB_SECTION_CODE=A.SUB_SECTION_CODE
	JOIN POD01106 D (NOLOCK) ON D.ARTICLE_CODE=B.ARTICLE_CODE
	WHERE PO_ID=@CMEMOID
	
	SELECT 	DISTINCT 'DOCPO_SECTIONM_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM SECTIONM A (NOLOCK)
	JOIN SECTIOND B (NOLOCK) ON B.SECTION_CODE=A.SECTION_CODE
	JOIN ARTICLE C (NOLOCK) ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
	JOIN POD01106 E (NOLOCK) ON E.ARTICLE_CODE=C.ARTICLE_CODE
	WHERE PO_ID=@CMEMOID


	SELECT 	DISTINCT 'DOCPO_PARA1_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA1 A (NOLOCK)
	JOIN POD01106 C (NOLOCK) ON C.PARA1_CODE=A.PARA1_CODE
	WHERE PO_ID=@CMEMOID
	union
	SELECT 	DISTINCT 'DOCPO_PARA1_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA1 A (NOLOCK)
	join ART_PARA1 b (NOLOCK) on a.para1_code =b.para1_code 
	JOIN POD01106 C (NOLOCK) ON  b.article_code =C.article_code 
	WHERE PO_ID=@CMEMOID
	UNION 
	SELECT 	DISTINCT 'DOCPO_PARA1_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA1 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA1_CODE=A.PARA1_CODE
	JOIN POD01106 C (NOLOCK) ON C.PRODUCT_CODE=b.PRODUCT_CODE
	WHERE PO_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPO_PARA2_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA2 A (NOLOCK)
	JOIN POD01106 C (NOLOCK) ON C.PARA2_CODE=A.PARA2_CODE
	WHERE PO_ID=@CMEMOID
	union 
	SELECT 	DISTINCT 'DOCPO_PARA2_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA2 A (NOLOCK)
	join ART_det b (NOLOCK) on a.para2_code =b.para2_code 
	JOIN POD01106 C (NOLOCK) ON  b.article_code =C.article_code 
	WHERE PO_ID=@CMEMOID
	UNION 
	SELECT 	DISTINCT 'DOCPO_PARA2_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA2 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA2_CODE=A.PARA2_CODE
	JOIN POD01106 C (NOLOCK) ON C.PRODUCT_CODE=b.PRODUCT_CODE
	WHERE PO_ID=@CMEMOID



	SELECT 	DISTINCT 'DOCPO_PARA3_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA3 A (NOLOCK)
	JOIN POD01106 C (NOLOCK) ON C.PARA3_CODE=A.PARA3_CODE
	WHERE PO_ID=@CMEMOID
	UNION 
	SELECT 	DISTINCT 'DOCPO_PARA3_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA3 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA3_CODE=A.PARA3_CODE
	JOIN POD01106 C (NOLOCK) ON C.PRODUCT_CODE=b.PRODUCT_CODE
	WHERE PO_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPO_PARA4_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA4 A (NOLOCK)
	JOIN POD01106 C (NOLOCK) ON C.PARA4_CODE=A.PARA4_CODE
	WHERE PO_ID=@CMEMOID
	UNION 
	SELECT 	DISTINCT 'DOCPO_PARA4_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA4 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA4_CODE=A.PARA4_CODE
	JOIN POD01106 C (NOLOCK) ON C.PRODUCT_CODE=b.PRODUCT_CODE
	WHERE PO_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPO_PARA5_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA5 A (NOLOCK)
	JOIN POD01106 C (NOLOCK) ON C.PARA5_CODE=A.PARA5_CODE
	WHERE PO_ID=@CMEMOID
	UNION 
	SELECT 	DISTINCT 'DOCPO_PARA5_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA5 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA5_CODE=A.PARA5_CODE
	JOIN POD01106 C (NOLOCK) ON C.PRODUCT_CODE=b.PRODUCT_CODE
	WHERE PO_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPO_PARA6_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA6 A (NOLOCK)
	JOIN POD01106 C (NOLOCK) ON C.PARA6_CODE=A.PARA6_CODE
	WHERE PO_ID=@CMEMOID
	UNION 
	SELECT 	DISTINCT 'DOCPO_PARA6_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM PARA6 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA6_CODE=A.PARA6_CODE
	JOIN POD01106 C (NOLOCK) ON C.PRODUCT_CODE=b.PRODUCT_CODE
	WHERE PO_ID=@CMEMOID

	IF OBJECT_ID ('TEMPDB..#TMP_ARTICLE_FIX_ATTR','U') IS NOT NULL
	   drop table #TMP_ARTICLE_FIX_ATTR
	
	 SELECT  DISTINCT 'DOCPO_ARTICLE_FIX_ATTR_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,ARTICLE_FIX_ATTR.* 
	 into #TMP_ARTICLE_FIX_ATTR
	 FROM POD01106 A (NOLOCK)
	 JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
	 JOIN ARTICLE ART (NOLOCK) ON B.ARTICLE_CODE =ART.ARTICLE_CODE 
	 JOIN ARTICLE_FIX_ATTR (NOLOCK) ON ARTICLE_FIX_ATTR.ARTICLE_CODE =ART.ARTICLE_CODE 
	 WHERE PO_ID=@CMEMOID  and a.product_code <>''
	 union 
	 SELECT  DISTINCT 'DOCPO_ARTICLE_FIX_ATTR_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,ARTICLE_FIX_ATTR.* 
	 FROM POD01106 A (NOLOCK)
	 JOIN ARTICLE ART (NOLOCK) ON a.ARTICLE_CODE =ART.ARTICLE_CODE 
	 JOIN ARTICLE_FIX_ATTR (NOLOCK) ON ARTICLE_FIX_ATTR.ARTICLE_CODE =ART.ARTICLE_CODE 
	 WHERE PO_ID=@CMEMOID  

	 SELECT * FROM #TMP_ARTICLE_FIX_ATTR


     
 DECLARE @NCOUNT INT,@BLOOP INT,@CCMD NVARCHAR(MAX)  
 SET @NCOUNT=25  
 SET @BLOOP=1  
 WHILE (@BLOOP <=@NCOUNT )  
 BEGIN  
         
       
   SET @CCMD=N' IF EXISTS(SELECT  TOP 1 ''U''  
   FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)  
   JOIN ARTICLE_FIX_ATTR A (NOLOCK) ON ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code=A.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code  
   JOIN #TMP_ARTICLE_FIX_ATTR tmp ON A.ARTICLE_CODE=TMP.ARTICLE_CODE
   WHERE 
   ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000'' )  
    SELECT  DISTINCT ''DOCPO_ATTR'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_MST_MIRROR'' AS TARGET_TABLENAME,'''+@CMEMOID+''' AS DOCPO_MEMO_ID,ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.*   
    FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)  
    JOIN ARTICLE_FIX_ATTR A (NOLOCK) ON ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code=A.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code  
    JOIN #TMP_ARTICLE_FIX_ATTR tmp ON A.ARTICLE_CODE=TMP.ARTICLE_CODE
    WHERE ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000'' '  
      
     PRINT  @CCMD  
     EXEC SP_EXECUTESQL @CCMD  
     SET @BLOOP=@BLOOP +1  
     
 END  


    SELECT 	DISTINCT 'DOCPO_ART_PARA1_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM ART_PARA1 A (NOLOCK)
	JOIN POD01106 C (NOLOCK) ON  A.article_code =C.article_code 
	WHERE PO_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPO_ART_DET_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPO_MEMO_ID,A.* FROM ART_DET A (NOLOCK)
	JOIN POD01106 C (NOLOCK) ON A.article_code =C.article_code 
	WHERE PO_ID=@CMEMOID
  
	
	GOTO END_PROC
	
END TRY
BEGIN CATCH
	SET @CERRMSG='P: SP_SEND_MIRROR_DOCPO_OPT_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 		

END_PROC:
		
END
---END OF PROCEDURE - SP_SEND_MIRROR_DOCPO_OPT_DATA_NEW
