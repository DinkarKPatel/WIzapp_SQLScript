IF OBJECT_ID('PBM01106','U') IS NOT NULL
BEGIN
	DECLARE @CCMD NVARCHAR(MAX)
	
	SET @CCMD=N'INSERT PIM01106	( MEMO_TYPE, EXCISE_DUTY_AMOUNT, PIM_MODE, MEMO_PREFIX, TAXFORM_STORAGE_MODE, BILL_LEVEL_TAX_METHOD, REMARKS, MANUAL_DISCOUNT, MANUAL_ROUNDOFF, BILL_CHALLAN_MODE, SENT_FOR_RECON, INV_MODE, EMP_CODE, PUR_CAL_METHOD, PARTY_INV_AMOUNT, BIN_ID, BROKER_AC_CODE, BROKER_COMM_PERCENTAGE, BROKER_COMM_AMOUNT, MANUAL_BROKER_COMM, ACCOUNTS_DEPT_ID, MRR_DT, MEMO_TIME, CHI_ENTRY_REF_NO, TERMS, CHECKED_BY, RECEIVED_BY, USER_CODE, SENT_TO_HO, MRR_ID, FIN_YEAR, EDT_USER_CODE, CREDIT_DAYS, CR_DISCOUNT_PERCENTAGE, POSTEDINAC, MRR_NO, INV_NO, INV_DT, BILL_NO, RECEIPT_DT, AC_CODE, TOTAL_AMOUNT, SUBTOTAL, DISCOUNT_PERCENTAGE, DISCOUNT_AMOUNT, OTHER_CHARGES, FREIGHT, TAX_PERCENTAGE, TAX_AMOUNT, ROUND_OFF, LAST_UPDATE, 
	CANCELLED, DEPT_ID, POSTTAXDISCOUNTAMOUNT,  APPROVEDLEVELNO, THROUGH, GENERATED_BY_CHRECON, SEND_TO_LOC, INV_ID, FROM_EXCEL, EXCEL_FILE_PATH, MRR_CREATION_DEPT_ID, BARCODE_PREFIX, ROUTE_FORM1, ROUTE_FORM2, PARTY_STATE_CODE, OTHER_CHARGES_GST_PERCENTAGE, OTHER_CHARGES_HSN_CODE, OTHER_CHARGES_IGST_AMOUNT, OTHER_CHARGES_CGST_AMOUNT, OTHER_CHARGES_SGST_AMOUNT, FREIGHT_GST_PERCENTAGE, FREIGHT_HSN_CODE, FREIGHT_IGST_AMOUNT, FREIGHT_CGST_AMOUNT, FREIGHT_SGST_AMOUNT, TOTAL_QUANTITY, OH_TAX_METHOD, FREIGHT_TAXABLE_VALUE, OTHER_CHARGES_TAXABLE_VALUE, FRIGHT_PAY_MODE, EDIT_INFO, ALLOW_EDIT_AT, DO_NOT_CALC_GST_OH, GST_ROUND_OFF, DO_NOT_CREATE_FDN, EDIT_COUNT, TOTAL_BOX_NO, XN_ITEM_TYPE, TOTAL_QUANTITY_STR, REF_CONVERTED_MRNTOBILL_MRRID )  
	SELECT  1 AS MEMO_TYPE, A.EXCISE_DUTY_AMOUNT,5 AS PIM_MODE,'''' AS MEMO_PREFIX, A.TAXFORM_STORAGE_MODE, A.BILL_LEVEL_TAX_METHOD, 
	A.REMARKS, A.MANUAL_DISCOUNT, A.MANUAL_ROUNDOFF,0 AS BILL_CHALLAN_MODE,0 AS  SENT_FOR_RECON, 1 AS INV_MODE,''0000000'' AS EMP_CODE, 
	0 AS PUR_CAL_METHOD,0 AS  PARTY_INV_AMOUNT,''000'' AS BIN_ID,''0000000000'' AS BROKER_AC_CODE,0 AS  BROKER_COMM_PERCENTAGE, 
	0 AS BROKER_COMM_AMOUNT,0 AS  MANUAL_BROKER_COMM,A.location_code AS ACCOUNTS_DEPT_ID,a.BILL_DT AS MRR_DT, 
	A.LAST_UPDATE AS MEMO_TIME,'''' AS CHI_ENTRY_REF_NO,'''' AS TERMS,'''' AS CHECKED_BY, '''' AS RECEIVED_BY, A.USER_CODE, 
	0 AS SENT_TO_HO,STUFF(MEMO_ID,8,0,''PBM'') AS  MRR_ID,A.FIN_YEAR, A.EDT_USER_CODE, A.CREDIT_DAYS, A.CR_DISCOUNT_PERCENTAGE, 
	0 AS POSTEDINAC,STUFF(MEMO_NO,3,0,''PBM'') AS MRR_NO,'''' AS INV_NO,a.BILL_DT AS INV_DT, A.BILL_NO,a.BILL_DT AS RECEIPT_DT, A.AC_CODE, 
	A.TOTAL_AMOUNT, A.SUBTOTAL, A.DISCOUNT_PERCENTAGE, A.DISCOUNT_AMOUNT, A.OTHER_CHARGES, A.FREIGHT,0 AS  TAX_PERCENTAGE, A.TAX_AMOUNT, 
	A.ROUND_OFF, A.LAST_UPDATE, A.CANCELLED,A.location_code AS DEPT_ID,0 AS  POSTTAXDISCOUNTAMOUNT,
	A.APPROVEDLEVELNO,'''' AS THROUGH,0 AS GENERATED_BY_CHRECON,0 AS SEND_TO_LOC,'''' AS INV_ID,0 AS FROM_EXCEL, 
	'''' AS EXCEL_FILE_PATH,B.location_code AS  MRR_CREATION_DEPT_ID,'''' AS BARCODE_PREFIX, 
	'''' AS ROUTE_FORM1,'''' AS  ROUTE_FORM2, A.PARTY_STATE_CODE, A.OTHER_CHARGES_GST_PERCENTAGE, A.OTHER_CHARGES_HSN_CODE, 
	A.OTHER_CHARGES_IGST_AMOUNT, A.OTHER_CHARGES_CGST_AMOUNT, A.OTHER_CHARGES_SGST_AMOUNT, A.FREIGHT_GST_PERCENTAGE, 
	A.FREIGHT_HSN_CODE, A.FREIGHT_IGST_AMOUNT, A.FREIGHT_CGST_AMOUNT, A.FREIGHT_SGST_AMOUNT,0 AS TOTAL_QUANTITY,
	A.OH_TAX_METHOD,A.FREIGHT_TAXABLE_VALUE, A.OTHER_CHARGES_TAXABLE_VALUE,0 AS  FRIGHT_PAY_MODE,'''' AS EDIT_INFO,'''' AS  ALLOW_EDIT_AT, 
	0 AS DO_NOT_CALC_GST_OH,0 AS GST_ROUND_OFF,0 AS DO_NOT_CREATE_FDN,0 AS EDIT_COUNT,0 AS TOTAL_BOX_NO, 
	1 AS XN_ITEM_TYPE,'''' AS  TOTAL_QUANTITY_STR, '''' AS REF_CONVERTED_MRNTOBILL_MRRID 
	FROM PBM01106 A LEFT OUTER JOIN PIM01106 B ON STUFF(A.MEMO_ID,8,0,''PBM'')=B.MRR_ID
	WHERE A.CANCELLED=0 AND B.MRR_ID IS NULL'
	
	EXEC SP_EXECUTESQL @CCMD

	SET @CCMD=N'INSERT PID01106	( PARA4_CODE, PARA5_CODE, PARA6_CODE, ARTICLE_CODE, PARA1_CODE, PARA2_CODE, QUANTITY, PURCHASE_PRICE, 
	MRP, PRODUCT_CODE, PRINT_LABEL, MP_PERCENTAGE, ROW_ID, LAST_UPDATE, PARA3_CODE, MRR_ID, SRNO, WHOLESALE_PRICE, 
	WSP_PERCENTAGE, GROSS_PURCHASE_PRICE, DISCOUNT_PERCENTAGE, DISCOUNT_AMOUNT, BOX_NO, PO_ROW_ID, INVOICE_QUANTITY, 
	SCHEME_QUANTITY, FORM_ID, TAX_PERCENTAGE, TAX_AMOUNT, RFNET, RFNET_WOTAX, FIX_MRP, USER_SRNO, MANUAL_MRP, MANUAL_WSP,
	 MANUAL_DISCOUNT, MD_PERCENTAGE, WD_PERCENTAGE, AUTO_SRNO, MANUAL_GPP, MANUAL_WSPP, MANUAL_MPP, MANUAL_DPP, BIN_ID,
	 AREA_LENGTH, AREA_WIDTH, AREA_SQARE, AREA_UOM_CODE, AREA_RATE_PP, MATERIAL_COST, RATE_AREA_SQUARE, 
	 CASHDISCOUNTAMOUNT, PIMDISCOUNTAMOUNT, PIMPOSTTAXDISCOUNTAMOUNT, PIMEXCISEDUTYAMOUNT, PRTAMOUNT, W8_CHALLAN_ID, 
	 VENDOR_EAN_NO, ITEM_EXCISE_DUTY_PERCENTAGE, ITEM_EXCISE_DUTY_AMOUNT, PRTAMOUNT_CREDITED, MANUAL_MDP, HSN_CODE, 
	 GST_PERCENTAGE, IGST_AMOUNT, CGST_AMOUNT, SGST_AMOUNT, XN_VALUE_WITHOUT_GST, XN_VALUE_WITH_GST, TAX_ROUND_OFF, 
	 BOX_ID, MANUAL_FIX_MRP, PO_ID )  
	 
	 SELECT ''0000000'' AS PARA4_CODE,''0000000'' AS PARA5_CODE,''0000000'' AS PARA6_CODE,''00000000'' AS ARTICLE_CODE,
	 ''0000000'' AS PARA1_CODE,''0000000'' AS PARA2_CODE, A.QUANTITY, A.PURCHASE_PRICE, 
	 0 AS MRP, A.PRODUCT_CODE,0 AS PRINT_LABEL, A.MP_PERCENTAGE, A.ROW_ID, A.LAST_UPDATE,''0000000'' AS PARA3_CODE, 
	 STUFF(A.MEMO_ID,8,0,''PBM'') AS MRR_ID,0 AS  SRNO,0 AS WHOLESALE_PRICE, 
	 A.WSP_PERCENTAGE, A.GROSS_PURCHASE_PRICE, A.DISCOUNT_PERCENTAGE, A.DISCOUNT_AMOUNT, 0 AS BOX_NO,'''' AS PO_ROW_ID, 
	 A.QUANTITY AS INVOICE_QUANTITY, 0 AS SCHEME_QUANTITY, A.FORM_ID, A.TAX_PERCENTAGE, A.TAX_AMOUNT, 
	 A.RFNET, A.RFNET_WOTAX,0 AS  FIX_MRP, 
	 0 AS USER_SRNO, A.MANUAL_MRP, A.MANUAL_WSP, A.MANUAL_DISCOUNT, A.MD_PERCENTAGE, A.WD_PERCENTAGE,0 AS AUTO_SRNO, 
	 0 AS MANUAL_GPP,0 AS MANUAL_WSPP,0 AS MANUAL_MPP,0 AS  MANUAL_DPP,''000'' AS BIN_ID,0 AS AREA_LENGTH,0 AS AREA_WIDTH, 
	 0 AS AREA_SQARE,'''' AS AREA_UOM_CODE,0 AS AREA_RATE_PP,0 AS MATERIAL_COST, 
	 0 AS RATE_AREA_SQUARE,0 AS CASHDISCOUNTAMOUNT,0 AS PIMDISCOUNTAMOUNT,0 AS PIMPOSTTAXDISCOUNTAMOUNT, 
	 0 AS PIMEXCISEDUTYAMOUNT,0 AS PRTAMOUNT,'''' AS W8_CHALLAN_ID,'''' AS VENDOR_EAN_NO, 
	 0 AS ITEM_EXCISE_DUTY_PERCENTAGE,0 AS ITEM_EXCISE_DUTY_AMOUNT,0 AS PRTAMOUNT_CREDITED,0 AS  MANUAL_MDP, 
	 A.HSN_CODE, A.GST_PERCENTAGE, A.IGST_AMOUNT, A.CGST_AMOUNT, A.SGST_AMOUNT, A.XN_VALUE_WITHOUT_GST, A.XN_VALUE_WITH_GST, 
	 0 AS TAX_ROUND_OFF,'''' AS BOX_ID,0 AS MANUAL_FIX_MRP,'''' AS PO_ID FROM PBD01106 A
	 JOIN PBM01106 B ON A.MEMO_ID=B.MEMO_ID
	 LEFT OUTER JOIN PID01106 C ON C.ROW_ID=A.ROW_ID
	 WHERE CANCELLED=0 AND C.ROW_ID IS NULL'
     
     EXEC SP_EXECUTESQL @CCMD
     
	SET @CCMD=N'UPDATE A SET REF_CONVERTED_MRNTOBILL_MRRID=C.MRR_ID FROM PIM01106 A
	JOIN PBD01106 B ON A.MRR_ID=B.REF_MRR_ID
	JOIN PIM01106 C ON C.MRR_ID=STUFF(B.MEMO_ID,8,0,''PBM'')
	WHERE ISNULL(A.REF_CONVERTED_MRNTOBILL_MRRID,'''')='''''
	EXEC SP_EXECUTESQL @CCMD
	
	SET @CCMD=N'UPDATE A SET XN_TYPE=''PUR'',MEMO_ID=C.MRR_ID FROM POSTACT_VOUCHER_LINK A
	JOIN PBM01106 B ON A.MEMO_ID=B.MEMO_ID
	JOIN PIM01106 C ON C.MRR_ID=STUFF(B.MEMO_ID,8,0,''PBM'')
	WHERE A.XN_TYPE=''PBM''' 
	EXEC SP_EXECUTESQL @CCMD
	
	
	SET @CCMD=N'IF OBJECT_ID(''PBM01106_BACKUP_31072018'',''U'') IS NULL
					SELECT * INTO PBM01106_BACKUP_31072018 FROM PBM01106'
	EXEC SP_EXECUTESQL @CCMD

	SET @CCMD=N'IF OBJECT_ID(''PBD01106_BACKUP_31072018'',''U'') IS NULL
					SELECT * INTO PBD01106_BACKUP_31072018 FROM PBD01106'
	EXEC SP_EXECUTESQL @CCMD	

	SET @CCMD=N'DROP TABLE PBD01106'
	EXEC SP_EXECUTESQL @CCMD	

	SET @CCMD=N'DROP TABLE PBM01106'
	EXEC SP_EXECUTESQL @CCMD		
END