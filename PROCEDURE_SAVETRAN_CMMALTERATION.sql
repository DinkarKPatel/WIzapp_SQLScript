CREATE PROCEDURE SAVETRAN_CMMALTERATION
(@nMode INT,@cCM_ID VARCHAR(50))
AS
BEGIN
SET NOCOUNT ON
DECLARE @ERR VARCHAR(MAX)='',@nStep int
BEGIN TRY
BEGIN TRAN
SET @nStep=10
DELETE D
FROM CMM_ALTERATION D JOIN CMM_ALTERATION_UPLOAD S
ON D.CM_ID=S.CM_ID
WHERE D.CM_ID=@cCM_ID

SET @nStep=20
IF @nMode=1
   INSERT CMM_ALTERATION(CM_ID,PRODUCT_CODE,JOB_CODE,SYS_RATE,RATE,REMARKS,LAST_UPDATE,ROW_ID)
   SELECT CM_ID,PRODUCT_CODE,JOB_CODE,SYS_RATE,RATE,REMARKS,GETDATE()LAST_UPDATE,ROW_ID FROM CMM_ALTERATION_UPLOAD WHERE CM_ID=@CCM_ID
   
SET @nStep=30   
DELETE FROM CMM_ALTERATION_UPLOAD WHERE CM_ID=@cCM_ID
END TRY
BEGIN CATCH
  SET @ERR='Some error occured at step '+CAST(@nStep AS VARCHAR)
  GOTO END_PROC
END CATCH
END_PROC:
IF @@TRANCOUNT>0 AND @ERR=''
   COMMIT
ELSE
   ROLLBACK   
SELECT @ERR ERRMSG   
SET NOCOUNT OFF
END
