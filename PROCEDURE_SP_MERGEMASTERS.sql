CREATE PROCEDURE SP_MERGEMASTERS
(
	@CTABLENAME VARCHAR(100),
	@CCOLUMNNAME VARCHAR(100),
	@COLDVALUE VARCHAR(100),
	@CNEWVALUE VARCHAR(100)
)
--WITH ENCRYPTION

AS
BEGIN
	DECLARE @CCHILDTABLENAME VARCHAR(100),
			@CCHILDCOLUMNNAME VARCHAR(100),
			@CEXCLUDETABLES NVARCHAR(4000),
			@CCMD NVARCHAR(4000)

	-- EXCLUSIONS
	SET @CEXCLUDETABLES =N''
	
	IF @CTABLENAME = 'SECTIOND'
		SET @CEXCLUDETABLES = N'SD_ATTR,CAMPAIGN_SECTIOND'		

	IF @CTABLENAME = 'ATTRM'
		SET @CEXCLUDETABLES = N'SD_ATTR'		

	IF @CTABLENAME = 'ARTICLE'
		SET @CEXCLUDETABLES = N'ART_ATTR, ART_RATE, ART_PARA1, ART_DET, ART_JOBS, ART_BOM'

	IF @CTABLENAME = 'ARTICLE_GROUP'
		SET @CEXCLUDETABLES = N'ART_GRP_ATTR, ART_GRP_PARA1, ART_GRP_DET'

	IF @CTABLENAME = 'PARA1'
		SET @CEXCLUDETABLES = N'ART_GRP_PARA1, ART_PARA1'

	IF @CTABLENAME = 'PARA2'
		SET @CEXCLUDETABLES = N'ART_GRP_DET, ART_DET'

	IF @CTABLENAME = 'LM01106'
		SET @CEXCLUDETABLES = N'LMP01106'
		
	IF UPPER(@CTABLENAME) <>'PREFIX'
	BEGIN
		DECLARE REF_CUR CURSOR FOR
		SELECT C.NAME AS CHILDTABLENAME, E.NAME AS CHILDCOLNAME
		FROM SYSREFERENCES A (NOLOCK)
		JOIN SYSOBJECTS B (NOLOCK) ON A.CONSTID = B.ID     
		JOIN SYSOBJECTS C (NOLOCK) ON A.FKEYID = C.ID    
		JOIN SYSOBJECTS D (NOLOCK) ON A.RKEYID = D.ID    
		JOIN SYSCOLUMNS E (NOLOCK) ON A.FKEY1 = E.COLID AND A.FKEYID = E.ID    
		JOIN SYSCOLUMNS F (NOLOCK) ON A.RKEY1 = F.COLID AND A.RKEYID = F.ID    
		WHERE D.NAME = @CTABLENAME
		AND   C.NAME <> @CTABLENAME
		AND   CHARINDEX( C.NAME, @CEXCLUDETABLES ) = 0

		OPEN REF_CUR

		FETCH NEXT FROM REF_CUR INTO @CCHILDTABLENAME, @CCHILDCOLUMNNAME
		WHILE @@FETCH_STATUS = 0
		BEGIN

			SET @CCMD = N' UPDATE ' + @CCHILDTABLENAME + 
						N' SET ' + @CCHILDCOLUMNNAME + ' = ''' + @CNEWVALUE + '''
						   WHERE ' + @CCHILDCOLUMNNAME + ' = ''' + @COLDVALUE + ''''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			FETCH NEXT FROM REF_CUR INTO @CCHILDTABLENAME, @CCHILDCOLUMNNAME
		END
		CLOSE REF_CUR
		DEALLOCATE REF_CUR

		
		IF EXISTS ( SELECT NAME FROM SYSCOLUMNS WHERE NAME = 'INACTIVE' AND ID = OBJECT_ID(@CTABLENAME) )
		BEGIN
			SET @CCMD = N' UPDATE ' + @CTABLENAME + ' SET INACTIVE = 1 
						   WHERE ' + @CCOLUMNNAME + ' = ''' + @COLDVALUE + ''''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
		END
	END	
	ELSE 
	BEGIN
		IF @COLDVALUE=''
			RETURN

		IF @CNEWVALUE=''
			RETURN
		
		UPDATE CUSTDYM SET CUSTOMER_TITLE = @CNEWVALUE WHERE CUSTOMER_TITLE = @COLDVALUE
		
		DELETE FROM PREFIX WHERE PREFIX_NAME = @COLDVALUE
	END	
END_PROC:

END
