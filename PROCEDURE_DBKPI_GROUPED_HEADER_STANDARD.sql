CREATE PROCEDURE DBKPI_GROUPED_HEADER_STANDARD(@SetupID varchar(100),@FromDT VARCHAR(10),@ToDt VARCHAR(10),@PNO INT=1)
AS
BEGIN
SET NOCOUNT ON
IF @PNO ='' OR @PNO IS NULL OR @PNO='0' SET @PNO=1
DECLARE @CAT VARCHAR(100),@LOC INT,@PAGE_SIZE INT,@DEF_SIZE INT=1000,@SUB_TOTAL_REQ INT=0
SELECT TOP 1 @SUB_TOTAL_REQ=CAST(VALUE AS INT) FROM CONFIG WHERE config_option='SUBT'

IF OBJECT_ID('tempdb..#TMP') IS NOT NULL DROP TABLE #TMP
IF OBJECT_ID('TEMPDB..#tmpRepFinal_tmp') IS NOT NULL DROP TABLE #tmpRepFinal_tmp
CREATE TABLE #tmpRepFinal_tmp (DEPT_ID VARCHAR(10),ARTICLE_NO VARCHAR(400),SNO INT,SUB_TOTAL_REC INT)

EXEC SP3S_GETSLSTARGET_REP @cMemoId='2',@nMode=2,@FromDT=@FROMDT,@ToDt=@TODT,@PNO=@PNO,@show_err=0

SELECT @CAT=CASE WHEN PARA_NAME LIKE 'PARA%' THEN (SELECT TOP 1 VALUE FROM CONFIG WHERE  config_option=LEFT(PARA_NAME,4)) 
			     ELSE REPLACE(UPPER(PARA_NAME),'_',' ') END 
FROM POS_DYNAMIC_DASHBOARD_SETUP(NOLOCK) WHERE setup_id=@SetupID

SELECT @CAT='ARTICLE NO'
SELECT @LOC=COUNT(DISTINCT DEPT_ID) FROM #tmpRepFinal_tmp

SELECT UPPER(@SetupID) SetupID
,LEFT(L.DEPT_ALIAS,20) PARA_NAME
,@CAT CATEGORY_NAME
,COUNT(*) PARA_COUNT
,RANK()OVER(ORDER BY LEFT(L.DEPT_ALIAS,20))-0 PNO
,COUNT(*) C_PARA_COUNT
,ROW_NUMBER()OVER(ORDER BY LEFT(L.DEPT_ALIAS,20))-0 SNO
,T.DEPT_ID
INTO #TMP
FROM #tmpRepFinal_tmp T(NOLOCK)
JOIN location L ON L.dept_id=T.DEPT_ID
GROUP BY L.DEPT_ALIAS,T.DEPT_ID
ORDER BY 1,2

UPDATE T1 SET C_PARA_COUNT=(SELECT SUM(T2.C_PARA_COUNT) FROM #TMP T2 WHERE T2.PNO<T1.PNO) FROM #TMP T1 WHERE T1.PNO>=0
--FROM 0
--UPDATE #TMP SET PNO=PNO+ISNULL(C_PARA_COUNT,0)
--SELECT SetupID,PARA_NAME,CATEGORY_NAME,PARA_COUNT,CASE PNO WHEN 0 THEN 0 ELSE PNO-1 END AS PNO,PARA_COUNT+PNO-1 LAST_VAL,SNO FROM #TMP
--OR 
--FROM 1
UPDATE #TMP SET PNO=PNO+ISNULL(C_PARA_COUNT,0)-(SNO-1) WHERE SNO>1
SELECT SetupID,PARA_NAME,CATEGORY_NAME
,PARA_COUNT AS PARA_COUNT
,PNO AS PNO
,PNO+PARA_COUNT-1 AS LAST_VAL
,SNO,@LOC LOC_COUNT,DEPT_ID 
FROM #TMP ORDER BY 2
SET NOCOUNT OFF
END