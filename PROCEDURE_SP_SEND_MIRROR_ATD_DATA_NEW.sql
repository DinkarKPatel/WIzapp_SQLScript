CREATE PROCEDURE SP_SEND_MIRROR_ATD_DATA_NEW
(	
	 @CUPLOADEDXNID VARCHAR(50)
	,@CCURLOCID VARCHAR(5) 
	,@BACKNOWLEDGE BIT=0
	,@CERRMSG VARCHAR(1000) OUTPUT
)	
--WITH ENCRYPTION
AS
/*
	SP_SEND_MIRROR_ATD_DATA_NEW_208_03_02_14 : THIS PROCEDURE WILL SEND PURCHASE ORDER ADJUSTMENT DATA FROM LOCATION TO HO.
*/
BEGIN
	DECLARE @DTSQL NVARCHAR(MAX),@NSPID INT,@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),
	@CTEMPEMPLOYEETABLE VARCHAR(200),@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),
	@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX),
	@CKEYFIELD VARCHAR(100),@CTEMPMASTERTABLE VARCHAR(200)

BEGIN TRY 	
	---- CALL ACKNOWLEDGEMENT OF MEMO SUCCESSFUL MERGING AT MIRRORING SERVER
	
	DECLARE @CTEMPDBNAME VARCHAR(40)
	
	SET @CTEMPDBNAME=''	
	
    		
    
    
    	 		
	SET @CSTEP=10 --NEW ADD UNMERGED DATE: 16-APRIL-2014
	SET @CFILTERCONDITION=''
	SELECT TOP 1 @CCURLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'	

	--CHANGE BY BAIJNATH
		SET @CMEMOID=@CUPLOADEDXNID

	SET @CSTEP=40
	---- IF NO MEMO FOUND , JUST END THE PROCESS
	IF ISNULL(@CMEMOID,'')=''
		GOTO END_PROC
		
LBLTABLEINFO:
	PRINT 'ATD DATA FOUND'
	SET @CSTEP=50

	
	SET @CSTEP=220
	---- SEND THE ATD MEMO MASTER TABLE
	SELECT A.*,'ATD_EMP_WPAYATT_UPLOAD' AS TARGET_TABLENAME FROM EMP_WPAYATT A (NOLOCK) WHERE ROW_ID =@CMEMOID

	
	SET @CSTEP=230
	---- SEND THE ATD MEMO DETAIL TABLE
	SELECT A.*,'ATD_EMP_MST_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS ATD_MEMO_ID  FROM EMP_MST A (NOLOCK) 
	JOIN EMP_WPAYATT B (NOLOCK) ON A.emp_id =B.emp_id 
	WHERE B.row_id=@CMEMOID

	
	GOTO END_PROC
		

END TRY
BEGIN CATCH
	PRINT 'ENTER CATCH OF ATD'
	SET @CERRMSG='P: SP_SEND_MIRROR_ATD_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 		
END_PROC:
		
	PRINT 'LAST STEP OF ATD:'+@CSTEP+@CUPLOADEDXNID+ISNULL(@CERRMSG,'')

END
---END OF PROCEDURE - SP_SEND_MIRROR_ATD_DATA_NEW
