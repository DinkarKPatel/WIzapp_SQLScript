-- SP3S_SEND_ALL_INV_MASTERS

create PROCEDURE SP3S_SEND_ALL_INV_MASTERS
(
@NMODE INT,   -- 1-INVENTORY MASTER'S
@PATH NVARCHAR(MAX),
@CDEPT_ID VARCHAR(5)=''
)
AS
BEGIN

      DECLARE @CSTEP INT ,@CERRMSG VARCHAR(MAX),@CCMD NVARCHAR(MAX),@CDATABSENAME NVARCHAR(MAX),@CDATAFILENAME NVARCHAR(MAX)

       
     BEGIN TRY
     
     IF @NMODE=2
      SET @CDATABSENAME='INV_MST'
     

		SET @CCMD=N' IF EXISTS(SELECT * FROM SYS.DATABASES WHERE NAME='''+@CDATABSENAME+''')
					BEGIN 
					ALTER DATABASE ['+@CDATABSENAME+'] SET  SINGLE_USER WITH ROLLBACK IMMEDIATE
					DROP DATABASE '+@CDATABSENAME+'
					END'
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD         



		SET @CCMD=N'IF  NOT EXISTS(SELECT * FROM SYS.DATABASES WHERE NAME='''+@CDATABSENAME+''')
		CREATE DATABASE '+@CDATABSENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD 
		 
 
BEGIN TRAN              
  IF @NMODE=1
  BEGIN
   
			SET @CSTEP=10--- SECTION 
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..SECTIONM FROM SECTIONM A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD 

			SET @CSTEP=20--- SUB_SECTION
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..SECTIOND FROM SECTIOND A (NOLOCK) where 1=2' 
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=30--- PARA1 
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..PARA1 FROM PARA1 A (NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=40--- PARA2 
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..PARA2 FROM PARA2 A (NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=50--- PARA3
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..PARA3 FROM PARA3 A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=60--- PARA4 
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..PARA4 FROM PARA4 A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=70--- PARA5 
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..PARA5 FROM PARA5 A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=80--- PARA6 
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..PARA6 FROM PARA6 A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=90--- UOM 
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..UOM FROM UOM A(NOLOCK) where 1=2 '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=100--- HSN_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..HSN_MST FROM HSN_MST A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=110--- HSN_DET
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..HSN_DET FROM HSN_DET A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=120--- JOBS 
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..JOBS FROM JOBS A(NOLOCK) where 1=2 '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD


			SET @CSTEP=130--- FORM 
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..FORM FROM FORM A(NOLOCK) where 1=2 '
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=140 -- SKU
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..SKU FROM SKU A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD


			SET @CSTEP=150 -- ARTICLE
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ARTICLE FROM ARTICLE A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD


			SET @CSTEP=160--- ART_PARA1
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ART_PARA1 FROM ART_PARA1 A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=170--- ART_DET
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ART_DET FROM ART_DET A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=180--- ART_BOM
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ART_BOM FROM ART_BOM A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=190--- ART_JOBS
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ART_JOBS FROM ART_JOBS A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=200-- ARTICLE_FIX_ATTR
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ARTICLE_FIX_ATTR FROM ARTICLE_FIX_ATTR A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=210--- SD_ATTR_AVATAR
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..SD_ATTR_AVATAR FROM SD_ATTR_AVATAR A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=220--- ATTR1_MST
			SET @CCMD=N' SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR1_MST FROM ATTR1_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=230--- ATTR2_MST
			SET @CCMD=N' SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR2_MST FROM ATTR2_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=240--- ATTR3_MST
			SET @CCMD=N' SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR3_MST FROM ATTR3_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=250--- ATTR4_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR4_MST FROM ATTR4_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=260--- ATTR5_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR5_MST FROM ATTR5_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=270--- ATTR6_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR6_MST FROM ATTR6_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=280--- ATTR7_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR7_MST FROM ATTR7_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=290--- ATTR8_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR8_MST FROM ATTR8_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=300--- ATTR9_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR9_MST FROM ATTR9_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=310--- ATTR10_MST
			SET @CCMD=N' SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR10_MST FROM ATTR10_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=320--- ATTR11_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR11_MST FROM ATTR11_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=330--- ATTR12_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR12_MST FROM ATTR12_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=340--- ATTR13_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR13_MST FROM ATTR13_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=350--- ATTR14_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR14_MST FROM ATTR14_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=360--- ATTR15_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR15_MST FROM ATTR15_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=370--- ATTR16_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR16_MST FROM ATTR16_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=380--- ATTR17_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR17_MST FROM ATTR17_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=390--- ATTR18_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR18_MST FROM ATTR18_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=400--- ATTR19_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR19_MST FROM ATTR19_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=410--- ATTR20_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR20_MST FROM ATTR20_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=420--- ATTR21_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR21_MST FROM ATTR21_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=430--- ATTR22_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR22_MST FROM ATTR22_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=440--- ATTR23_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR23_MST FROM ATTR23_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=450--- ATTR24_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR24_MST FROM ATTR24_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD

			SET @CSTEP=460--- ATTR25_MST
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..ATTR25_MST FROM ATTR25_MST A(NOLOCK)'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
			SET @CSTEP=140 -- SKU_OH
			SET @CCMD=N'SELECT DISTINCT A.* INTO '+@CDATABSENAME+'..SKU_OH FROM SKU_OH A(NOLOCK) where 1=2'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD


       
   END  
  			


END TRY  
	BEGIN CATCH  
		SET @CERRMSG='P: SP3S_SEND_ALL_INV_MASTERS, STEP: '+CAST(@CSTEP AS VARCHAR(5))+', MESSAGE: ' + ERROR_MESSAGE()
		GOTO END_PROC  
	END CATCH   

END_PROC:  
	
	 
	 IF ISNULL(@CERRMSG,'')='' 
			COMMIT TRANSACTION
			
		ELSE
			ROLLBACK
			
	IF  ISNULL(@CERRMSG,'')<>'' 
		SELECT ISNULL(@CERRMSG,'') AS ERRMSG
	ELSE 
	 BEGIN
              

	           SET @CCMD=N'BACKUP DATABASE ['+@CDATABSENAME+'] TO  DISK ='''+@PATH+'\'+@CDATABSENAME+'.BAK'''
	           PRINT @CCMD
              EXEC SP_EXECUTESQL @CCMD
              
              SET @CCMD=N' IF EXISTS(SELECT * FROM SYS.DATABASES WHERE NAME='''+@CDATABSENAME+''')
			   BEGIN 
				ALTER DATABASE ['+@CDATABSENAME+'] SET  SINGLE_USER WITH ROLLBACK IMMEDIATE
				DROP DATABASE '+@CDATABSENAME+'
			   END'
			   PRINT @CCMD
			   EXEC SP_EXECUTESQL @CCMD
			  	
	       

       SELECT '' AS ERRMSG
	 END

END

---END OF PROCEDURE - SP3S_SEND_ALL_INV_MASTERS
