CREATE PROCEDURE SP3SBUILDPRDJWI
(
	 @CXNID			VARCHAR(50)
	,@NUPDATEMODE	NUMERIC(2)
	,@CERRMSG		VARCHAR(MAX) OUTPUT
)
AS
BEGIN
/*
XNTYPE FILTER IS REQUIRED DURING DELETION FROM RFOPT TABLE BECAUSE IN SOME CASES LIKE TRO FROM PIM01106
,THE INSERTED XN_ID IS THAT OF WHOLESALE INVOICE.
*/
	DECLARE @CCMD NVARCHAR(MAX),@CRFDBNAME VARCHAR(500),@CSTEP VARCHAR(10)
BEGIN TRY

	DECLARE @BBUILDRFOPT BIT
	
	EXEC SP3S_CHKRFOPT_BUILD @BBUILDRFOPT OUTPUT
	
	IF @BBUILDRFOPT=0
		RETURN
		
	SET @CRFDBNAME=DB_NAME()+'_RFOPT.DBO.'
	IF @NUPDATEMODE=0
	BEGIN
		SET @CSTEP = 5
		SET @CCMD=N'INSERT '+@CRFDBNAME+'RF_OPT(DEPT_ID,XN_TYPE,XN_DT,XN_NO,XN_ID,PRODUCT_CODE,
				  XN_PARTY_CODE,XN_QTY,XN_NET,XN_DA,TAX_AMOUNT,BIN_ID)
				  SELECT LEFT(B.ISSUE_ID,2) AS DEPT_ID,  
				   ''PRDJWI'' AS XN_TYPE,  
				   B.ISSUE_DT AS XN_DT,  
				   B.ISSUE_NO AS XN_NO,  
				   ''PRDJWI''+B.ISSUE_ID AS XN_ID,
				   A.PRODUCT_CODE,  
				   ''LM''+D.AC_CODE AS XN_PARTY_CODE,   
				   ABS(A.QUANTITY) AS XN_QTY,  
				   CONVERT(NUMERIC(10,2),0) AS XN_NET,  
				   CONVERT(NUMERIC(10,2),0) AS XN_DA ,  
				   CONVERT(NUMERIC(10,2),0) AS TAX_AMOUNT
				   ,A.BIN_ID  AS [BIN_ID]      
				 FROM PRD_JOBWORK_ISSUE_DET A (NOLOCK)  
				 JOIN PRD_JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID  
				 JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE  
				 WHERE B.CANCELLED=0 '
		PRINT @CCMD 
		EXEC SP_EXECUTESQL @CCMD	
		
		GOTO ENDPROC
	END
	
	SET @CSTEP = 10
	IF @NUPDATEMODE<>1
	BEGIN
	    
	    IF @nUpdateMode=4
		  SET @CCMD=N'DELETE A FROM '+@CRFDBNAME+'RF_OPT A WHERE A.XN_ID=''PRDJWI''+'''+@CXNID+''''
		ELSE
		IF @NUPDATEMODE=3		
		BEGIN
		  SET @CCMD=N'INSERT '+@CRFDBNAME+'RF_OPT(DEPT_ID,XN_TYPE,XN_DT,XN_NO,XN_ID,PRODUCT_CODE,
					  XN_PARTY_CODE,XN_QTY,XN_NET,XN_DA,TAX_AMOUNT,BIN_ID)
					  SELECT LEFT(B.ISSUE_ID,2) AS DEPT_ID,  
					   ''PRDJWI'' AS XN_TYPE,  
					   B.ISSUE_DT AS XN_DT,  
					   B.ISSUE_NO AS XN_NO,  
					   ''PRDJWI''+B.ISSUE_ID AS XN_ID,
					   A.PRODUCT_CODE,  
					   ''LM''+D.AC_CODE AS XN_PARTY_CODE,   
					   ABS(A.QUANTITY)* -1 AS XN_QTY,  
					   CONVERT(NUMERIC(10,2),0) AS XN_NET,  
					   CONVERT(NUMERIC(10,2),0) AS XN_DA ,  
					   CONVERT(NUMERIC(10,2),0) AS TAX_AMOUNT
					   ,A.BIN_ID  AS [BIN_ID]      
					 FROM PRD_JOBWORK_ISSUE_DET A (NOLOCK)  
					 JOIN PRD_JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID  
					 JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE  
					 WHERE B.CANCELLED=0 
					  AND B.ISSUE_ID='''+@CXNID+''''
				  
			PRINT @CCMD 
			EXEC SP_EXECUTESQL @CCMD
		END
	END
	
	IF @NUPDATEMODE<>3
	BEGIN
		SET @CSTEP = 20
		SET @CCMD=N'INSERT '+@CRFDBNAME+'RF_OPT(DEPT_ID,XN_TYPE,XN_DT,XN_NO,XN_ID,PRODUCT_CODE,
				  XN_PARTY_CODE,XN_QTY,XN_NET,XN_DA,TAX_AMOUNT,BIN_ID)
				  SELECT LEFT(B.ISSUE_ID,2) AS DEPT_ID,  
				   ''PRDJWI'' AS XN_TYPE,  
				   B.ISSUE_DT AS XN_DT,  
				   B.ISSUE_NO AS XN_NO,  
				   ''PRDJWI''+B.ISSUE_ID AS XN_ID,
				   A.PRODUCT_CODE,  
				   ''LM''+D.AC_CODE AS XN_PARTY_CODE,   
				   ABS(A.QUANTITY) AS XN_QTY,  
				   CONVERT(NUMERIC(10,2),0) AS XN_NET,  
				   CONVERT(NUMERIC(10,2),0) AS XN_DA ,  
				   CONVERT(NUMERIC(10,2),0) AS TAX_AMOUNT
				   ,A.BIN_ID  AS [BIN_ID]      
				 FROM PRD_JOBWORK_ISSUE_DET A (NOLOCK)  
				 JOIN PRD_JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID  
				 JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE  
				 WHERE B.CANCELLED=0 
				  AND B.ISSUE_ID='''+@CXNID+''''
		PRINT @CCMD 
		EXEC SP_EXECUTESQL @CCMD
	END
END TRY
BEGIN CATCH
	SET @CERRMSG='SP3SBUILDPRDJWI: STEP :'+@CSTEP+',ERROR :'+ERROR_MESSAGE()
END CATCH	

ENDPROC:

END
--END OF PROCEDURE - SP3SBUILDJWI
