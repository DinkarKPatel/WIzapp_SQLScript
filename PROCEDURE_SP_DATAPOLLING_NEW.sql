CREATE PROCEDURE SP_DATAPOLLING_NEW
(
 @CDATE VARCHAR(10),
 @CWHERE VARCHAR(1000),
 @CDEPTID VARCHAR(10)=''
)
--WITH ENCRYPTION

AS
BEGIN

--(dinkar) Replace  left(memoid,2) to Location_code 

--FOR MERGING STATUS
DECLARE @NCOUNT INT,@NNORECPT INT, @NAMTRECPT NUMERIC (14,4)

SET @NCOUNT=(SELECT COUNT(*) FROM LOCATION WHERE ISNULL(DATA_POLLING,0)=0)

SELECT @NNORECPT=COUNT(ADV_REC_ID),@NAMTRECPT=SUM(AMOUNT) FROM ARC01106
WHERE CANCELLED = 0 AND ADV_REC_DT = @CDATE
           
 SELECT @NCOUNT AS NO_LOC,COUNT(DISTINCT location_Code ) AS NO_LOC_BILL_CREATED,COUNT(DISTINCT CM_NO) AS NO_BILLS,       
        SUM(RFNET) AS BILL_AMOUNT,(@NCOUNT-COUNT(DISTINCT location_Code)) AS NO_LOC_BILL_NOT_CREATED,
        @NNORECPT AS NO_RECPT,@NAMTRECPT AS RECPT_AMOUNT
 FROM CMM01106 (NOLOCK)
 JOIN CMD01106 (NOLOCK) ON CMM01106.CM_ID= CMD01106.CM_ID
 WHERE CANCELLED =0 AND CM_MODE=1  AND CM_DT= @CDATE   


 
--FOR ONLINE DATA

 SELECT B.DEPT_ID + ' '+B.DEPT_NAME AS DEPT_NAME,B.DEPT_ALIAS,C.AREA_NAME,D.CITY,ST.STATE,
        COUNT(DISTINCT A.CM_NO) AS NO_BILLS, SUM(RFNET) AS BILL_AMOUNT,MAX(CM_TIME) AS MAX_CM_DT,
        DATEDIFF(DD,MAX(CM_TIME),GETDATE()) AS DUE_DAYS,
        RTRIM(LTRIM(STR((DATEDIFF(MINUTE,MAX(CM_TIME),GETDATE())/60)))) +':' + 
        RTRIM(LTRIM(STR((DATEDIFF(MINUTE,MAX(CM_TIME),GETDATE())%60)))) + ' MIN'  AS DUE_TIME,
         CAST(DATEDIFF(SECOND,MAX(CM_TIME),GETDATE())/60/60/24 %7 AS VARCHAR(100)) + ' DAYS, ' +
        CAST(DATEDIFF(SECOND,MAX(CM_TIME),GETDATE())/60/60%24  AS VARCHAR(100))  + ' HR, '+
        CAST(DATEDIFF(SECOND,MAX(CM_TIME),GETDATE())/60%60  AS VARCHAR(100)) + ' MIN' AS TIMEDIFF
        ,E.NO_RECPT,E.RECPT_AMOUNT,SSCL.LAST_UPDATE AS EOSS_LAST_MERGE_ON
 FROM CMM01106 A (NOLOCK) 
 JOIN CMD01106 (NOLOCK) ON A.CM_ID= CMD01106.CM_ID
 JOIN LOCATION B ON A.location_Code= B.DEPT_ID
 JOIN AREA C (NOLOCK) ON B.AREA_CODE = C.AREA_CODE 
 JOIN CITY D (NOLOCK) ON C.CITY_CODE = D.CITY_CODE 
 JOIN STATE ST (NOLOCK) ON D.STATE_CODE = ST.STATE_CODE 
 LEFT JOIN SCHEME_SETUP_ACK_LOG SSCL (NOLOCK) ON SSCL.DEPT_ID=B.DEPT_ID  
 LEFT OUTER JOIN 
 (SELECT  location_Code AS DEPT_ID,COUNT(ADV_REC_ID) AS NO_RECPT,SUM(AMOUNT) AS RECPT_AMOUNT FROM ARC01106 
 WHERE ADV_REC_DT = @CDATE AND CANCELLED = 0 
 GROUP BY location_Code) E 
 ON E.DEPT_ID = B.DEPT_ID 
 
 WHERE ISNULL(B.DATA_POLLING,0)=0 AND A.CANCELLED =0 AND A.CM_MODE=1  AND A.CM_DT= @CDATE
 GROUP BY B.DEPT_ID,B.DEPT_NAME,B.DEPT_ALIAS,C.AREA_NAME,D.CITY,ST.STATE,E.NO_RECPT,E.RECPT_AMOUNT,SSCL.LAST_UPDATE
 ORDER BY ST.STATE,BILL_AMOUNT DESC
  


----FOR OFFLINE DATA


 SELECT B.DEPT_ID + ' '+B.DEPT_NAME AS DEPT_NAME,B.DEPT_ALIAS,C.AREA_NAME,D.CITY,ST.STATE,
        --COUNT(A.CM_NO) AS NO_BILLS, SUM(NET_AMOUNT) AS BILL_AMOUNT,
        0 AS NO_BILLS,0 AS BILL_AMOUNT,
        MAX(CM_TIME) AS MAX_CM_DT,        
        DATEDIFF(DD,MAX(CM_TIME),GETDATE()) AS DUE_DAYS,
        RTRIM(LTRIM(STR(((DATEDIFF(MINUTE,MAX(CM_TIME),GETDATE())/60)/24)))) +':' 
        + RTRIM(LTRIM(STR((DATEDIFF(MINUTE,MAX(CM_TIME),GETDATE())%60)))) + ' MIN'  AS DUE_TIME,
        CAST(DATEDIFF(SECOND,MAX(CM_TIME),GETDATE())/60/60/24 /30 AS VARCHAR(100)) + ' MONTH, ' +
        CAST(DATEDIFF(SECOND,MAX(CM_TIME),GETDATE())/60/60/24 %30 AS VARCHAR(100)) + ' DAYS, ' +
        CAST(DATEDIFF(SECOND,MAX(CM_TIME),GETDATE())/60/60%24  AS VARCHAR(100))  + ' HR, '+
        CAST(DATEDIFF(SECOND,MAX(CM_TIME),GETDATE())/60%60  AS VARCHAR(100)) + ' MIN' AS TIMEDIFF,
        SSCL.LAST_UPDATE AS EOSS_LAST_MERGE_ON
 FROM LOCATION B  (NOLOCK) 
 LEFT OUTER JOIN CMM01106 A ON A.location_Code= B.DEPT_ID
 JOIN AREA C (NOLOCK) ON B.AREA_CODE = C.AREA_CODE 
 JOIN CITY D (NOLOCK) ON C.CITY_CODE = D.CITY_CODE  
 JOIN STATE ST (NOLOCK) ON D.STATE_CODE = ST.STATE_CODE 
 LEFT JOIN SCHEME_SETUP_ACK_LOG SSCL (NOLOCK) ON SSCL.DEPT_ID=B.DEPT_ID  
 WHERE ISNULL(B.DATA_POLLING,0)=0 AND ISNULL(A.CANCELLED,0) =0 AND ISNULL(A.CM_MODE,1)=1  AND 
 B.DEPT_ID NOT IN (SELECT location_Code FROM CMM01106 WHERE CM_DT=@CDATE AND CM_MODE=1 AND CANCELLED=0
                   GROUP BY location_Code)
 GROUP BY B.DEPT_ID,B.DEPT_NAME,B.DEPT_ALIAS,C.AREA_NAME,D.CITY,ST.STATE,SSCL.LAST_UPDATE 
 ORDER BY MAX_CM_DT DESC
 
 
END
