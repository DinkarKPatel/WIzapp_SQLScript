create PROCEDURE SP_SEND_MIRROR_MSTEMP_NEW
@CTARGETLOCID VARCHAR(5)
----WITH ENCRYPTION
AS
BEGIN

    DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION NVARCHAR(MAX),@DMEMOLASTUPDATE DATETIME
           ,@CXNTYPE VARCHAR(10),@CMEMOID VARCHAR(100),@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100)
           ,@BRECFOUND BIT,@CTEMPSKUTABLE VARCHAR(100),@CTEMPLMTABLE VARCHAR(100),@TMP_AREA VARCHAR(100)
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CLOCMSTLUPD VARCHAR(20),@CCURDEPTID VARCHAR(5)
           ,@CHODEPTID VARCHAR(5),@NRECCOUNT INT,@CERRORMSG VARCHAR(MAX),@CREPLOCTABLE VARCHAR(500),@NLOCTYPE INT
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(2),@CPRINTMSTTEMPTABLE VARCHAR(400),@CTILLLOCSTEMPTABLE VARCHAR(200) 
           ,@CPARTYRATEMSTTEMPTABLE VARCHAR(500)
           ,@CEMP_GRP_LINKTEMPTABLE VARCHAR(400),@CEMPLOYEE_GRPTEMPTABLE VARCHAR(400),
           @CEMPLOYEETEMPTABLE VARCHAR(400),@CEMPCATEGORYTEMPTABLE VARCHAR(400),@CEMP_GRP_LINKTEMPTABLE1 VARCHAR(400)
     
    DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),ERRMSG VARCHAR(MAX)) 
    
    BEGIN TRY
    
	SET @CSTEP=0

	SET @CTEMPDBNAME = ''
	SET @CSTEP=10
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	SET @CFILTERCONDITION=''
	SET @CSTEP=20

	SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
	
	SELECT @NLOCTYPE=LOC_TYPE FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	
	IF @CCURDEPTID<>@CHODEPTID
	BEGIN
		SELECT '' AS LAST_UPDATE,'' AS ERRMSG
		GOTO END_PROC
	END		
	
	SET @CSTEP =60
	SET @CTABLENAME ='EMPLOYEE_GRP'
	SELECT DISTINCT  'MSTEMP_EMPLOYEE_GRP_MIRROR' AS TARGET_TABLENAME,EMPLOYEE_GRP.*,1 AS PICK_FROM_CURRENT_DB FROM EMPLOYEE_GRP (NOLOCK)
	WHERE DEPT_ID=@CTARGETLOCID


	
	
	SET @CSTEP =277

	SET @CTABLENAME ='EMP_GRP_LINK'
	SELECT DISTINCT  'MSTEMP_EMP_GRP_LINK_MIRROR' AS TARGET_TABLENAME,EMP_GRP_LINK.*,1 AS PICK_FROM_CURRENT_DB FROM EMP_GRP_LINK (NOLOCK)
	JOIN EMPLOYEE_GRP B (NOLOCK) ON EMP_GRP_LINK.EMP_GRP_CODE=B.EMP_GRP_CODE
	WHERE B.DEPT_ID=@CTARGETLOCID


	SET @CSTEP =278
	SET @CTABLENAME ='EMPLOYEE'

	
			IF OBJECT_ID ('TEMPDB..#TMPEMPLOYEE','U') IS NOT NULL
			   DROP TABLE #TMPEMPLOYEE

			  
		
			;WITH Employee_CTE  AS  
			(  
			   SELECT EMPLOYEE.EMP_CODE,EMPLOYEE.EMP_NAME,EMPLOYEE.EMP_HEAD  FROM EMPLOYEE (NOLOCK)
			   JOIN  EMP_GRP_LINK (NOLOCK) ON EMPLOYEE.emp_code =EMP_GRP_LINK.EMP_CODE 
			   JOIN EMPLOYEE_GRP B (NOLOCK) ON EMP_GRP_LINK.EMP_GRP_CODE=B.EMP_GRP_CODE
			   WHERE B.DEPT_ID=@CTARGETLOCID
			   UNION ALL  
			   SELECT e.EMP_CODE,e.EMP_NAME,e.EMP_HEAD  
			   from EMPLOYEE e   
			   INNER JOIN Employee_CTE c ON e.EMP_CODE = c.EMP_HEAD  
			   WHERE ISNULL(E.EMP_CODE,'') NOT IN('0000000','')
			   and c.EMP_HEAD <>c.emp_code 
			)  
			
			SELECT DISTINCT EMP_CODE  INTO #TMPEMPLOYEE FROM Employee_CTE order by EMP_CODE  
           option (maxrecursion 1000);

	SELECT DISTINCT  'MSTEMP_EMPLOYEE_MIRROR' AS TARGET_TABLENAME,EMPLOYEE.*,1 AS PICK_FROM_CURRENT_DB FROM EMPLOYEE (NOLOCK)
	JOIN  #TMPEMPLOYEE B (NOLOCK) ON EMPLOYEE.emp_code =B.EMP_CODE 
	

	
	SET @CSTEP =279
	SET @CTABLENAME ='EMPCATEGORY'

	SELECT DISTINCT  'MSTEMP_EMPCATEGORY_MIRROR' AS TARGET_TABLENAME,EMPCATEGORY.*,1 AS PICK_FROM_CURRENT_DB FROM EMPCATEGORY (NOLOCK)
	JOIN EMPLOYEE (NOLOCK) ON EMPCATEGORY.CATEGORY_CODE=EMPLOYEE.CATEGORY_CODE
	JOIN  #TMPEMPLOYEE B (NOLOCK) ON EMPLOYEE.emp_code =B.EMP_CODE 

	--SELECT DISTINCT  'MSTEMP_EMPLOYEE_MIRROR' AS TARGET_TABLENAME,EMPLOYEE.*,1 AS PICK_FROM_CURRENT_DB FROM EMPLOYEE (NOLOCK)
	--JOIN  EMP_GRP_LINK (NOLOCK) ON EMPLOYEE.emp_code =EMP_GRP_LINK.EMP_CODE 
	--JOIN EMPLOYEE_GRP B (NOLOCK) ON EMP_GRP_LINK.EMP_GRP_CODE=B.EMP_GRP_CODE
	--WHERE B.DEPT_ID=@CTARGETLOCID


	
	--SET @CSTEP =279
	--SET @CTABLENAME ='EMPCATEGORY'

	--SELECT DISTINCT  'MSTEMP_EMPCATEGORY_MIRROR' AS TARGET_TABLENAME,EMPCATEGORY.*,1 AS PICK_FROM_CURRENT_DB FROM EMPCATEGORY (NOLOCK)
	--JOIN EMPLOYEE (NOLOCK) ON EMPCATEGORY.CATEGORY_CODE=EMPLOYEE.CATEGORY_CODE
	--JOIN  EMP_GRP_LINK (NOLOCK) ON EMPLOYEE.emp_code =EMP_GRP_LINK.EMP_CODE 
	--JOIN EMPLOYEE_GRP B (NOLOCK) ON EMP_GRP_LINK.EMP_GRP_CODE=B.EMP_GRP_CODE
	--WHERE B.DEPT_ID=@CTARGETLOCID

		
	GOTO END_PROC
     
END TRY

BEGIN CATCH
	SET @CERRORMSG='P: SP_SEND_MIRROR_MSTEMP_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 	
	
END_PROC:

	SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
 END

------------- END OF PROCEDURE SP_SEND_MIRROR_MSTEMP


