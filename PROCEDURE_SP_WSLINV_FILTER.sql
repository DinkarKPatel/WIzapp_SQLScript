CREATE PROC SP_WSLINV_FILTER--(LocId 3 digit change Sanjay:04-11-2024)
(    
@NINV_MODE NUMERIC(1),           /* @NINV_MODE:0 FOR ALL,1 FOR GROUP,2 FOR PARTY*/    
@NINV_STATUS NUMERIC(1),         /* @NINV_STATUS:0 FOR ALL,1 FOR BOX,2 FOR PICK SLIP,3 FOR PICK LIST,4 FOR AGAINST ORDER */      
@DFROMDATE DATETIME,    /* @DFROMDATE:2013-04-20 FOR FILTER FROM MEMO DATE */    
@DTODATE DATETIME,     /* @DTODATE:2014-08-05 FOR FILTER TO MEMO DATE */    
    
@INV_TYPE NUMERIC(1),            --@INV_TYPE:0 FOR ALL, 1 FOR REGULARAND 2 FOR LOT     
@INV_METHOD NUMERIC(1),          --@INV_METHOD:0 FOR ALL , 1 FOR OUTSTANDING AND 2 FOR LOCAL    
@TAX_METHOD NUMERIC(1),          --@TAX_METHOD:0 FOR ALL , 1 FOR EXCLUSIVE AND 2 FOR INCLUSIVE      
@TAX_TYPE NUMERIC(1),            --@TAX_TYPE:0 FOR ALL , 1 FOR BLII LEVEL AND 2 FOR ITEM LEVEL     
    
@CAC_CODE VARCHAR(100),    /* @CAC_CODE:WHOLESALE FROM AC_CODE */    
@CFORM_ID VARCHAR(10)='',         /*ENTER FORM OR BLANK*/    
@CDEPT_ID VARCHAR(100),       /* @CDEPT_ID:WHOLESALE FROM DEPT_ID */    
@CAC_BRK_ID VARCHAR(100),   /* @AC_BRK_ID:WHOLESALE FROM DEPT_ID */    
@NCANCELLED NUMERIC(1),           /* @NCANCELLED:0 OR 1 CHECK CANCLE STATUS */    
@CCHALLAN_ID VARCHAR(100),         /* @CCHALLAN_ID:'' NO FILTER ELSE FILTER FOR CHALLAN_ID*/    
@CSALESPERSON VARCHAR(10),    
@CSDEPT_ID VARCHAR(100)='',      /* @CDEPT_ID:WHOLESALE FROM DEPT_ID */    
@LOC VARCHAR(4)='' ,
@HEAD_CODE VARCHAR(50)='' ,
@NITEM_TYPE NUMERIC(1)=0,
@NBILL_LEVEL_DISC_METHOD NUMERIC(1)=0,
@NPAYMENT_MODE NUMERIC(1)=0,
@BESTIMATE NUMERIC(1)=1,
@CUSER_CODE VARCHAR(7)='',
@NAC_STATUS NUMERIC(1)=0 ,      /* @NAC_STATUS:0 FOR ALL,1 FOR PENDING, 2 FOR UPDATE*/     
@CCITY_CODE VARCHAR(10)=''
)     
--WITH ENCRYPTION    
AS    
BEGIN    
	 print 'wslinv-1:'+convert(varchar,getdate(),113)    

	  SELECT INM.INV_ID    
	 INTO #FILTER_INM    
	 FROM INM01106 INM(NOLOCK) 
	 WHERE 1=2

	 INSERT INTO #FILTER_INM(INV_ID)
	 SELECT a.INV_ID
	 FROM IND01106 a
	 JOIN INM01106 b on b.INV_ID=a.INV_ID
	 WHERE  (B.INV_DT BETWEEN  @DFROMDATE AND @DTODATE) AND  ISNULL(@CSALESPERSON,'')<>'' AND (a.emp_code=@CSALESPERSON
	 OR a.emp_code=@CSALESPERSON
	 OR a.emp_code2= @CSALESPERSON
	 OR b.emp_code= @CSALESPERSON)
	 GROUP BY a.INV_ID

	 --SELECT * FROM #FILTER_INM
	 INSERT INTO #FILTER_INM(INV_ID)
	 SELECT INM.INV_ID    
	 FROM INM01106 INM(NOLOCK)    
	 WHERE (INM.INV_DT BETWEEN  @DFROMDATE AND @DTODATE)
	 AND ISNULL(@CSALESPERSON,'')=''
	 --FOR GATE PASS ISSUE NO    
	 
	  SELECT MEMO_ID 
	  INTO #tmpPVl 
	  FROM POSTACT_VOUCHER_LINK PVL(NOLOCK) 
	  JOIN VM01106 VM (NOLOCK) ON PVL.VM_ID =VM.VM_ID 
	  JOIN #FILTER_INM inm ON inm.INV_ID=pvl.MEMO_ID
	  WHERE  PVL.XN_TYPE IN ('WSL','WSLCHO') AND VM.CANCELLED=0
	  group by MEMO_ID

	
	 
	 print 'wslinv-2:'+convert(varchar,getdate(),113)    

     
     SELECT PM.PARCEL_MEMO_NO,PM.PARCEL_MEMO_DT,LM.AC_NAME AS PARCEL_AC_NAME,ANGM.ANGADIA_NAME AS PARCEL_TRANSPORTER_NAME,PM.BILTY_NO,    
	  PB.REF_MEMO_ID,PM.TOT_BOXES,PM.TOT_WEIGHT,PM.receipt_dt AS BILTY_DT
	  INTO #tmpParcel FROM PARCEL_MST PM (NOLOCK)    
	  JOIN parcel_det  PB (NOLOCK) ON PM.PARCEL_MEMO_ID =PB.PARCEL_MEMO_ID     
	  JOIN ANGM (NOLOCK) ON ANGM.ANGADIA_CODE =PM.ANGADIA_CODE    
	  JOIN LM01106 LM (NOLOCK)  ON LM.AC_CODE=PB.AC_CODE    
	  WHERE PM.CANCELLED =0  AND PM.XN_TYPE='WSL'  
	  GROUP BY PM.PARCEL_MEMO_NO,PM.PARCEL_MEMO_DT,    
	  PB.REF_MEMO_ID,LM.AC_NAME,BILTY_NO,ANGM.ANGADIA_NAME  ,PM.TOT_BOXES,PM.TOT_WEIGHT  ,PM.receipt_dt

	print 'wslinv-3:'+convert(varchar,getdate(),113)    	 
	 CREATE INDEX IND_TMPPARCEL ON #tmpParcel (REF_MEMO_ID)


	-- DECLARE @NDISPLAY_BILLS_CURRENT_USER_ONLY NUMERIC(1,0)

	--SELECT @NDISPLAY_BILLS_CURRENT_USER_ONLY = CONVERT(NUMERIC(1),(CASE WHEN VALUE='' THEN '0' ELSE VALUE END ))    
	-- FROM USER_ROLE_DET A JOIN USERS B ON A.ROLE_ID=B.ROLE_ID 
	-- WHERE USER_CODE=@CUSER_CODE AND FORM_NAME='FRMSALE'     
	-- AND FORM_OPTION='DISPLAY_BILLS_ALL_USERS'    	  
	-- print 'wslinv-2:'+convert(varchar,getdate(),113)    
	     
	 print 'wslinv-4:'+convert(varchar,getdate(),113)     
	 SELECT T1.entry_mode, CONVERT(VARCHAR,T1.INV_DT,105) AS MEMO_DT,T1.INV_ID AS MEMO_ID,T1.INV_NO AS MEMO_NO,     
	 T3.AC_NAME AS CUSTOMER_NAME,T1.DISCOUNT_PERCENTAGE AS DISCOUNT_PERCENTAGE ,        
	 T1.DISCOUNT_AMOUNT ,   T1.FREIGHT,T1.INSURANCE,t1.OTHER_CHARGES, T1.NET_AMOUNT AS NET_SALE_VALUE,    
	 T1.REMARKS,isnull(LMSH.AC_NAME, '') as SHIPPING_AC_NAME ,isnull(LMSH.ADDRESS0, T1.SHIPPING_ADDRESS) as SHIPPING_ADDRESS ,
	 ISNULL(LMSH.ADDRESS0, T1.SHIPPING_ADDRESS2) AS SHIPPING_ADDRESS2, 
	 ISNULL(LMSH.ADDRESS0,T1.SHIPPING_ADDRESS3) AS SHIPPING_ADDRESS3,   
	 OCTROI_AMOUNT,T1.MANUAL_INV_NO,  T1.TOTAL_QUANTITY,T1.TOTAL_QUANTITY_STR,
	 CONVERT(VARCHAR(20),'') CANCELLED, t1.CANCELLED AS CANCELLED_FLAG,t1.SUBTOTAL,t1.ROUND_OFF,  
	 PARCEL_TRANSPORTER_NAME= ISNULL(PARCEL_TRANSPORTER_NAME,''),    
	 PARCEL_MEMO_NO=ISNULL(PARCEL_MEMO_NO,''),    
	 PARCEL_MEMO_DT=ISNULL(CONVERT(VARCHAR,PARCEL_MEMO_DT,105),''),    
	 BILTY_NO=ISNULL(BILTY_NO,''),    
	 BILTY_DT=ISNULL(CONVERT(VARCHAR,BILTY_DT,105),''),   
	 PARCEL_AC_NAME=ISNULL(PARCEL_AC_NAME,''),   
	 EXPORTED EXPORTED_FLAG,
	 mrr_dt,RECEIPT_DT pur_receipt_dt,     T3.TIN_NO,    
	  ISNULL(F.AC_NAME,'') AS BROKER_AC_NAME  ,  
	 SLOC.DEPT_NAME,SLOC.DEPT_ID,'' AS DOC_ATTACHED,    
	 '' AS GP_ISSUE_NO,    
	 '' AS GP_ISSUE_ID,    
	 SLOC.DEPT_ID sloc_dept_id,SLOC.DEPT_NAME sloc_dept_name
	 ,TLOC.DEPT_ID tloc_dept_id,TLOC.DEPT_NAME tloc_dept_name
	 ,t1.EDIT_COUNT edit_count_no  , t1.TOTAL_BOX_NO ,u.username as USERNAME
	 ,u1.username as EDT_USERNAME ,T1.Total_Gst_Amount ,
		convert(varchar(30),'')  AS AC_POSTED,pvl.memo_id posted_memo_id,
	    T1.Total_Gst_Cess_Amount,T1.EINV_IRN_NO,T1.inv_dt,CAST(0 AS BIT) AS CHK,t1.Inv_mode
		,ISNULL(BLOC.Enable_EInvoice,0) AS Enable_EInvoice_flag,
		ISNULL(BLOC.loc_gst_no,'') AS loc_gst_no,TLOC.loc_gst_no tloc_gst_no,T3.Ac_gst_no 
		,T1.ACH_NO,T1.ACH_DT,T3.DISCOUNT_PERCENTAGE AS CD_PERCENTAGE,T3.E_MAIL,T1.Ac_Code,T3.E_MAIL_CC
		,T1.XN_ITEM_TYPE,T1.broker_comm_percentage,T1.broker_comm_amount,T1.AUTO_EWAYBILL_NO
		,ANGM.TOT_BOXES,ANGM.TOT_WEIGHT,T3.CITY,T3.MOBILE,T1.CREDIT_DAYS,ISNULL(T1.Tcs_Amount	,0) as TCS_AMOUNT
	 --18 NOV 2017    
	 INTO #tmpInvList
	 FROM INM01106 T1 (NOLOCK)
	 JOIN #FILTER_INM FT1 (NOLOCK) ON T1.INV_ID=FT1.INV_ID    
	 JOIN LMV01106 T3 ON T3.AC_CODE = T1.AC_CODE   
	 JOIN users U (NOLOCK) ON T1.USER_CODE=U.user_code  --ADDED BY CHANDAN ON 29-06-2019
	 LEFT OUTER JOIN LM01106 T4 ON T4.AC_CODE = T1.BROKER_AC_CODE    
	 LEFT JOIN LM01106 F(NOLOCK) ON T1.BROKER_AC_CODE= F.AC_CODE     
	 LEFT OUTER JOIN EMPLOYEE T5 ON T5.EMP_CODE = T1.EMP_CODE     
	 LEFT OUTER JOIN users u1 ON T1.edt_user_code=u1.user_code     
	 LEFT OUTER JOIN COMPANY COM ON 1=1 AND COM.COMPANY_CODE='01'     
	 LEFT JOIN PIM01106 PUR (NOLOCK) ON PUR.INV_ID=T1.INV_ID   and isnull(pur.CANCELLED,0)=0  
	 LEFT OUTER JOIN LOCATION SLOC ON T1.location_code= SLOC.DEPT_ID    
	 LEFT OUTER JOIN LOCATION TLOC ON T1.PARTY_DEPT_ID= TLOC.DEPT_ID  
	 LEFT OUTER JOIN LOCATION BLOC ON T1.DEPT_ID= BLOC.DEPT_ID  
	 LEFT OUTER JOIN #tmpPVL PVL ON PVL.MEMO_ID=t1.INV_ID  
	 LEFT JOIN LMV01106 LMSH (NOLOCK) ON LMSH.AC_CODE =T1.SHIPPING_AC_CODE 


	 LEFT JOIN #tmpParcel ANGM ON ANGM.REF_MEMO_ID=T1.INV_ID 
	 WHERE  T1.INV_DT BETWEEN @DFROMDATE AND @DTODATE       
	 AND (ISNULL(@NINV_MODE, 0)= 0 OR (T1.INV_MODE=@NINV_MODE))     
	 AND (ISNULL(@NINV_STATUS, 0)= 0 OR (ENTRY_MODE=@NINV_STATUS))       
	 AND (@INV_TYPE=0 OR T1.LOTTYPE=@INV_TYPE)    
	 AND (@INV_METHOD=0 OR T1.INV_TYPE=@INV_METHOD)     
	 AND (@TAX_METHOD=0 OR T1.BILL_LEVEL_TAX_METHOD=@TAX_METHOD)    
	 AND (ISNULL(@CAC_CODE,'')='' OR T3.AC_CODE=@CAC_CODE)    
	 AND (ISNULL(@CSDEPT_ID,'')='' OR BLOC.dept_id=@CSDEPT_ID)    
	 AND (ISNULL(@CDEPT_ID,'')='' OR tloc.DEPT_ID=@CDEPT_ID)    
	 AND (ISNULL(@CAC_BRK_ID,'')='' OR T1.BROKER_AC_CODE=@CAC_BRK_ID)
	 AND (ISNULL(@HEAD_CODE,'')='' OR T3.HEAD_CODE=@HEAD_CODE)    
	 AND (@LOC='' OR SLOC.DEPT_ID=@LOC)  
	AND (@NCANCELLED=2 OR T1.CANCELLED = CAST(@NCANCELLED as BIT))  
	     
     AND (@NITEM_TYPE=0 OR T1.XN_ITEM_TYPE=@NITEM_TYPE)   
	 AND (@NBILL_LEVEL_DISC_METHOD =0 OR T1.Bill_LEVEL_DISC_METHOD=@NBILL_LEVEL_DISC_METHOD)
	 AND (@NPAYMENT_MODE    =0 OR T1.pay_mode=@NPAYMENT_MODE)
	 AND (ISNULL(@BESTIMATE,0)=0 OR T1.MEMO_TYPE= @BESTIMATE)
    
	AND ((@NAC_STATUS=0)  OR (@NAC_STATUS=1 AND  ISNULL(PVL.MEMO_ID,'')='')       
        OR (@NAC_STATUS=2 AND (ISNULL(PVL.MEMO_ID,'')<>''))) 
	AND (@CCITY_CODE='' OR T3.CITY_CODE=@CCITY_CODE)
	
	print 'wslinv-5:'+convert(varchar,getdate(),113)    	 
	UPDATE #tmpInvList SET DISCOUNT_AMOUNT=0 ,FREIGHT=0,INSURANCE=0,OTHER_CHARGES=0,NET_SALE_VALUE=0,
	TOTAL_QUANTITY=0,TOTAL_QUANTITY_STR='',CANCELLED='CANCELLED',SUBTOTAL=0,ROUND_OFF=0 WHERE cancelled_flag=1  

	print 'wslinv-6:'+convert(varchar,getdate(),113)    	 
	SELECT a.*,(CASE WHEN XN_ITEM_TYPE IN (1,4) THEN ISNULL(Enable_EInvoice_flag,0)  ELSE 0 END) AS Enable_EInvoice,
	ISNULL((SLOC_DEPT_ID +'-'+ SLOC_DEPT_NAME ),'')AS SOURCE_LOCATION    ,
	 ISNULL((TLOC_DEPT_ID +'-'+ TLOC_DEPT_NAME),'') AS TARGET_LOCATION    ,
     (CASE WHEN Inv_mode=2 THEN ISNULL(TLOC_gst_no,'') ELSE ISNULL(Ac_gst_no,'') END) party_gst_no,
	(CASE   WHEN ISNULL(posted_memo_id,'')<> '' THEN 'POSTED' ELSE 'PENDING'  END) ac_status,
	(CASE WHEN ISNULL(EDIT_COUNT_no,0)>0 THEN 'EDITED (' + RTRIM(LTRIM(STR(EDIT_COUNT_no)))+ ')' ELSE '' END ) AS edit_count,
    (CASE WHEN mrr_DT = NULL THEN '' ELSE CONVERT(VARCHAR(20),PUR_receipt_DT,105)   END) receipt_dt,
		(CASE WHEN EXPORTED_FLAG = 1 THEN 'Y' ELSE 'N'   END) exported
	FROM #tmpInvList a
	ORDER BY inv_dt

	print 'wslinv-7:'+convert(varchar,getdate(),113)    

 

END    
--END OF PROCEDURE - SP_WSLINV_FILTER 