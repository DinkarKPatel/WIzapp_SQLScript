CREATE PROCEDURE SP_MERGE_MIRROR_BIN_MST_DATA
(
	@CMEMOID VARCHAR(50),  
    @CLOCID VARCHAR(2), 
    @CSOURCEDB VARCHAR(100),
	@CMERGEDB VARCHAR(100),
	@BMSTINSERTONLY BIT, 
    @CERRMSG VARCHAR(MAX) OUTPUT  
)
AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@CSTEP VARCHAR(10),@CTABLE_SUFFIX VARCHAR(100),
	@CTABLENAME VARCHAR(100),@CTMP_TABLENAME VARCHAR(100),@CKEYFIELD VARCHAR(100),@CREF_CUSTOMER_CODE VARCHAR(100),
	@CTABLESSTR VARCHAR(MAX)
	
	DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(40))
	BEGIN TRY 
			
			SET @CTABLE_SUFFIX = REPLACE(@CMEMOID,'-','_') 
			
			INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('BIN_MST')
			
		    
			SET @CSTEP = 140
			SET @CTABLENAME='BIN'  
			SET @CTMP_TABLENAME='[TMP_BIN_MST_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
			SET @CKEYFIELD='BIN_ID'  
			SET @CSTEP= 160
			
			
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=1                    
        
	END TRY
    	BEGIN CATCH
	 SET @CERRMSG='P:SP_MERGE_MIRROR_BIN_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH

EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0  
		COMMIT  
	ELSE
	IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0  
		ROLLBACK  

   IF ISNULL(@CERRMSG,'')=''	
	   EXEC SP3S_DROPTEMPTABLES_MIRRORDATA
		@CXNTYPE='BIN_MST',
		@CTABLESUFFIX=@CTABLE_SUFFIX,
		@CTABLESSTR=@CTABLESSTR
		
END
--END OF THE PROCEDURES SP_MERGE_MIRROR_BIN_MST_DATA
