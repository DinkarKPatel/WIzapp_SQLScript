create PROCEDURE SPWOW_Audittrail_WPS
(
 @XN_ID VARCHAR(1000)
,@XN_SP_ID VARCHAR(40)=''
,@CANCEL INT=0 
,@cWizuserCode varchar(10)=''
,@cComputerName VARCHAR(1000)=''
,@cWinuserName VARCHAR(1000)=''
,@nBoxNo    NUMERIC(3,0)=0
)
AS
BEGIN
  SET NOCOUNT ON

  DECLARE @cWizuserName VARCHAR(1000),@cMstTable varchar(100),@cDtlTable varchar(100),
          @EDITED bit,@XN_TYPE varchar(10),@ROWID varchar(50),@UPDATED_ON dateTime,
		  @SQL varchar(max),@SQL2 varchar(max)

  select @EDITED=0,@XN_TYPE='WPS',@cMstTable='WPS_MST',@cDtlTable='WPS_DET'
 
  SET @ROWID=LEFT(NEWID(),40)
  
  SELECT @CWIZUSERNAME=ISNULL(U.USERNAME,'') FROM USERS U WHERE U.USER_CODE=@CWIZUSERCODE
  
  SET @UPDATED_ON=GETDATE()
 
  IF @CANCEL=1
     BEGIN
        INSERT XN_AUDIT_TRIAL_DET WITH (ROWLOCK) (XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME ,WINUSERNAME ,CWIZUSERCODE,CWIZUSERNAME,PRODUCT_CODE)
        SELECT TOP 1 @XN_ID,@XN_TYPE,@cMstTable,@XN_ID,'CANCELLED','BIT','CANCEL',@ROWID,'NO','YES',CONVERT(VARCHAR(40),@UPDATED_ON,113),@cComputerName ,@cWinuserName,@CWIZUSERCODE,@CWIZUSERNAME,'' 
        RETURN
     END
 
  SET @SQL='UPDATE T SET '
  SELECT @SQL=COALESCE(@SQL,'')+'T.NEW_'+FIELD_NAME+' = I.'+FIELD_NAME+',' FROM XN_AUDIT_TRIAL_MST (NOLOCK) WHERE TABLE_NAME=@cMstTable AND TRIG='UPDATE' ORDER BY ORDER_ID
  SET @SQL=LEFT(@SQL,LEN(@SQL)-1)+' FROM [##WPSM_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+'] T JOIN '+@cMstTable+' I (NOLOCK) ON I.ps_id='''+@XN_ID+''';'
  print @sql	
  EXEC(@SQL)

 
  SET @SQL=''
  SELECT @SQL=COALESCE(@SQL,'')+'INSERT XN_AUDIT_TRIAL_DET (XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)
  SELECT '''+@XN_ID+''','''+@XN_TYPE+''', '''+@cMstTable+''', OLD_'+LEFT(KEY_FIELDS,LEN(KEY_FIELDS)-1)+', '''+FIELD_NAME+''', '''+DATA_TYPE+''', '''+TRIG+''', '''+@ROWID+''', OLD_'+FIELD_NAME+' , NEW_'+FIELD_NAME+' , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@cWinuserName+''', '''+@cComputerName+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',''''
  FROM [##WPSM_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+'] 
  WHERE NEW_'+FIELD_NAME+'<>OLD_'+FIELD_NAME+';'
  FROM XN_AUDIT_TRIAL_MST (NOLOCK) 
  WHERE TABLE_NAME=@cMstTable AND TRIG='UPDATE'
  print @sql
  EXEC(@SQL)


  if @nBoxNo>0
  begin

		DROP TABLE IF EXISTS #TMPWPS_DET

		SELECT PS_ID,PRODUCT_CODE ,RATE ,QUANTITY 		 INTO #TMPWPS_DET		FROM WPS_DET (NOLOCK) WHERE PS_ID=@XN_ID
		AND BOX_NO =@nBoxNo

	   SELECT @SQL2=COALESCE(@SQL2,'')    
		  +'INSERT XN_AUDIT_TRIAL_DET (XN_ID,XN_TYPE, TABLE_NAME, KEY_VALUE, FIELD_NAME, DATA_TYPE, TXN_MODE, ID, OLDVAL, NEWVAL, AUDITED_ON, COMPUTER_NAME, WINUSERNAME, CWIZUSERCODE, CWIZUSERNAME, PRODUCT_CODE)'+CHAR(13)    
		  +'SELECT '''+@XN_ID+''','''+@XN_TYPE+''', '''+@cDtlTable+''', isnull(  OLD_'+REPLACE(LEFT(KEY_FIELDS,LEN(KEY_FIELDS)-1),'+','+OLD_')+',b.ps_id+b.product_code) , '''+FIELD_NAME+''', '''+DATA_TYPE+''', '''+TRIG+''', '''+@ROWID+''', isnull(OLD_'+FIELD_NAME+',0) , b.'+FIELD_NAME+' , '''+CONVERT(VARCHAR,@UPDATED_ON,113)+''', '''+@cComputerName +''', '''+@cWinuserName+''', '''+@CWIZUSERCODE+''', '''+@CWIZUSERNAME+''',isnull(OLD_PRODUCT_CODE,product_code)
		  FROM [##WPSD_'+CAST(@XN_SP_ID AS VARCHAR(40))+'_'+@XN_ID+'] a' +
		  ' full outer JOIN #TMPWPS_DET B (nolock) ON A.OLD_PS_ID=B.PS_ID AND A.old_PRODUCT_CODE=B.PRODUCT_CODE '
		  + ' where  isnull(b.ps_id,a.old_ps_id)='''+@XN_ID+'''
		  and isnull(OLD_'+FIELD_NAME+',''0'') <> isnull(b.'+FIELD_NAME+',''0'') ;' 
		  FROM XN_AUDIT_TRIAL_MST (NOLOCK)     
		  WHERE TABLE_NAME='WPS_DET' AND TRIG='UPDATE' 

	  print @SQL2
	  EXEC(@SQL2)


 end
   
END
