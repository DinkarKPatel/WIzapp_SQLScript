create PROCEDURE SP_ITEMSTATUS  
(   
  @CQUERYID INT,   
  @BILLNO NVARCHAR(50)='',     
  @PRODUCT_CODE NVARCHAR(20)='',  
  @CFINYEAR NVARCHAR(10)='' ,  
  @CCUSTCODE NVARCHAR(20)='',  
  @NMODE  INT=1,  
  @DTDELIVERYFROM NVARCHAR(20)='',  
  @DTDELIVERYTO NVARCHAR(20)='',  
  @AGENCY NVARCHAR(500)='',  
  @NMODE1 INT=0,--PENDING STATUS (1: LEVEL1) (2: LEVEL2) (3: LEVEL3)  
  @CLOCID VARCHAR(4)='' ,
  @bsummary bit=0,  
  @DTHBDFROM NVARCHAR(20)='',  
  @DTHBDTO NVARCHAR(20)=''
)   
--WITH ENCRYPTION  
AS   
BEGIN  
   
 ----Putting return in this Procedure till next discussion with Sir.   
 --return  
 DECLARE @CCMD NVARCHAR(MAX),@CCMD01 NVARCHAR(MAX),@CCMD02 NVARCHAR(MAX),@DLAST_DT DATETIME,@CCMD1 NVARCHAR(MAX),
 @CCMD2 NVARCHAR(MAX),@CCMD3 NVARCHAR(MAX)  
    SELECT @DLAST_DT=DATEADD (YY,-1, DBO.FN_GETFINYEARDATE (@CFINYEAR,1))  
  
 IF @CQUERYID =1    
  EXEC SP_ITEMSTATUS_1 @CQUERYID=@CQUERYID,@BILLNO=@BILLNO ,@PRODUCT_CODE=@PRODUCT_CODE,@CFINYEAR=@CFINYEAR,@CCUSTCODE=@CCUSTCODE,@NMODE=@NMODE,@DTDELIVERYFROM=@DTDELIVERYFROM,@DTDELIVERYTO=@DTDELIVERYTO,@AGENCY=@AGENCY,@NMODE1=@NMODE1,@CLOCID=@CLOCID,@bsummary=@bsummary,@DTHBDFROM=@DTHBDFROM,@DTHBDTO=@DTHBDTO
 ELSE IF @CQUERYID =2    
  EXEC SP_ITEMSTATUS_2 @CQUERYID=@CQUERYID,@BILLNO=@BILLNO ,@PRODUCT_CODE=@PRODUCT_CODE,@CFINYEAR=@CFINYEAR,@CCUSTCODE=@CCUSTCODE,@NMODE=@NMODE,@DTDELIVERYFROM=@DTDELIVERYFROM,@DTDELIVERYTO=@DTDELIVERYTO,@AGENCY=@AGENCY,@NMODE1=@NMODE1,@CLOCID=@CLOCID
 ELSE IF @CQUERYID =3  
   SELECT ac_code,agency_name FROM PRD_AGENCY_MST (NOLOCK)   
   
END   
  
/*
CREATE PROCEDURE SP_ITEMSTATUS
( 
  @CQUERYID INT, 
  @BILLNO NVARCHAR(50)='',   
  @PRODUCT_CODE NVARCHAR(20)='',
  @CFINYEAR NVARCHAR(10)='' ,
  @CCUSTCODE NVARCHAR(20)='',
  @NMODE		INT=1,
  @DTDELIVERYFROM NVARCHAR(20)='',
  @DTDELIVERYTO NVARCHAR(20)='',
  @AGENCY NVARCHAR(500)='',
  @NMODE1	INT=0,--PENDING STATUS (1: LEVEL1) (2: LEVEL2) (3: LEVEL3)
  @CLOCID NVARCHAR(2)=''
) 
--WITH ENCRYPTION
AS 
BEGIN
	return ---- Running very slow on SUvidha....Need to discuss with Sir

	DECLARE @CCMD NVARCHAR(MAX),@DLAST_DT DATETIME,@CCMD1 NVARCHAR(MAX),@CCMD2 NVARCHAR(MAX),@CCMD3 NVARCHAR(MAX)
    SELECT @DLAST_DT=DATEADD (YY,-1, DBO.FN_GETFINYEARDATE (@CFINYEAR,1))

	IF @CQUERYID =1  
		GOTO LBLITEMDETAILS 
	ELSE IF @CQUERYID =2  
		GOTO LBLTOP  
	ELSE IF @CQUERYID =3
		GOTO LBLAGENCY  
  
	LBLITEMDETAILS: --QueryID=1
	
	PRINT @DLAST_DT
	
	IF OBJECT_ID('TEMPDB..#TMPHOLDS','U') IS NOT NULL
    DROP TABLE #TMPHOLDS
 
 SELECT	DISTINCT ISNULL(C.PRODUCT_CODE,SKU_REPAIR.PRODUCT_CODE) AS PRODUCT_CODE, 
	    B.QUANTITY, B.DELIVERED, A.MEMO_DT, 
		B.DELIVERY_DT ,
		B.REMARKS, A.REMARKS AS REMARKS_MST,
		B.ROW_ID,A.CANCELLED
		,A.CUSTOMER_CODE
		,REF_CMD_ROW_ID
		,JOB_CODE
		,ISNULL( M.CM_NO,A.MEMO_NO) AS CM_NO, 
        C.EMP_CODE,C.EMP_CODE1,C.EMP_CODE2,
		C.MRP,ISNULL(M.FIN_YEAR,@CFINYEAR) AS FIN_YEAR,
		SKU.ARTICLE_CODE,
		SKU.PARA1_CODE,
		SKU.PARA2_CODE,
		ISNULL(M.CM_DT,A.MEMO_DT) AS CM_DT
		,ISNULL(A.MEMO_NO,'') HOLDBACK_NO
		--ADDED ON 7 MAR 2019
		,HOLDBACK_DT=CASE YEAR(ISNULL(A.MEMO_DT,'')) WHEN 1900 THEN '' ELSE CONVERT(VARCHAR,A.MEMO_DT,105) END
INTO #TMPHOLDS
FROM HOLD_BACK_DELIVER_MST A (NOLOCK) 
JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID
LEFT JOIN CMD01106 C (NOLOCK) ON C.ROW_ID = B.REF_CMD_ROW_ID
LEFT JOIN CMM01106 M (NOLOCK) ON C.CM_ID = M.CM_ID
LEFT JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=C.PRODUCT_CODE
LEFT JOIN SKU_REPAIR (NOLOCK) ON SKU_REPAIR.PRODUCT_CODE=B.PRODUCT_CODE
WHERE A.MEMO_DT>=@DLAST_DT
AND (@BILLNO='' OR M.CM_NO=@BILLNO)
AND (@DTDELIVERYFROM='' OR B.DELIVERY_DT>=@DTDELIVERYFROM)
AND (@DTDELIVERYTO='' OR B.DELIVERY_DT<=@DTDELIVERYTO)
AND A.CANCELLED=0
AND(@CLOCID='' OR LEFT(A.MEMO_NO,2)=@CLOCID)
--SELECT * FROM #TMPHOLDS
SET @CCMD=N'SELECT DISTINCT  HLDS.PRODUCT_CODE,HLDS.ARTICLE_NAME,HLDS.CM_NO,HLDS.ARTICLE_NO,HLDS.SECTION_NAME,
				HLDS.SUB_SECTION_NAME,HLDS.QUANTITY,HLDS.PARA1_NAME,HLDS.PARA2_NAME,
				(CASE WHEN ISNULL(HLDS.JOB_NAME,'''') = '''' THEN ISSS.JOB_NAME ELSE HLDS.JOB_NAME END) AS JOB_NAME,
				(CASE WHEN HLDS.DELIVERED = 0 THEN ''YES'' ELSE ''NO'' END) AS HOLD_DELIVER,
				ISNULL(CONVERT(VARCHAR, HLDS.MEMO_DT,105),'''') AS HOLD_DELIVER_DT,
				(CASE WHEN  ISNULL(ISSS.PRODUCT_CODE,'''')= '''' THEN CASE WHEN HLDS.DELIVERED = 0 THEN ''NO'' ELSE '''' END ELSE ''YES'' END) AS JOBWORKS_ISSUE,
				ISNULL(CONVERT(VARCHAR,ISSS.ISSUE_DT,105),'''') AS ISSUE_DT,
				ISNULL(ISSS.ISSUE_NO,'''') AS ISSUE_NO,
				(CASE WHEN  ISNULL(RCV.PRODUCT_CODE,'''')= '''' THEN CASE WHEN HLDS.DELIVERED = 0 THEN ''NO'' ELSE '''' END ELSE ''YES'' END) AS JOBWORKS_RECEIVED,
				ISNULL(CONVERT(VARCHAR,RCV.RECEIPT_DT,105),'''') AS RECEIVED_DT,
				ISNULL(RCV.RECEIPT_NO,'''') AS RECEIPT_NO,
				(CASE WHEN  ISNULL(DLVY.PRODUCT_CODE,'''')= '''' THEN CASE WHEN HLDS.DELIVERED = 0 THEN ''NO'' ELSE '''' END ELSE ''YES'' END) AS DELIVERED_TO_CUSTOMER,
				ISNULL(CONVERT(VARCHAR,DLVY.MEMO_DT,105),'''') AS DELIVERED_DATE,
				DLVY.DELIVERED_TO,ISSS.AGENCY_NAME,CONVERT(VARCHAR,HLDS.DUE_DT,105) AS DUE_DT,HLDS.EMP_NAME,
				HLDS.EMP_NAME2,HLDS.EMP_NAME3,
				HLDS.REMARKS AS ITEM_REMARKS,HLDS.REMARKS_MST AS BILL_REMARKS,HLDS.MRP,
				HLDS.CUSTOMER_NAME,CONVERT(VARCHAR,HLDS.CM_DT,105) AS CM_DT,
				DATEDIFF(D,HLDS.DUE_DT,ISNULL(DLVY.MEMO_DT,GETDATE())) AS DUE_DAYS
				,ISNULL(CONVERT(VARCHAR,ISSS.DUE_DT,105),'''') AS JOBOWRK_DUE_DT
				,DATEDIFF(D,ISSS.DUE_DT,ISNULL(RCV.RECEIPT_DT,GETDATE())) AS JOBOWRK_DUE_DAYS
				,HLDS.USER_CUSTOMER_CODE
				--ADDED ON 7 MAR 2019
				,HLDS.HOLDBACK_NO,HLDS.HOLDBACK_DT
				,RCV.JOB_RATE,
				RCV.AMOUNT
				FROM 
				(	
					SELECT	B.PRODUCT_CODE, ART.ARTICLE_NAME, B.CM_NO,ART.ARTICLE_NO, SM.SECTION_NAME, SD.SUB_SECTION_NAME, 
							B.QUANTITY, P1.PARA1_NAME, P2.PARA2_NAME, F.JOB_NAME, B.DELIVERED, B.MEMO_DT, 
							B.DELIVERY_DT AS [DUE_DT],EMP.EMP_NAME,EMP1.EMP_NAME AS [EMP_NAME2],EMP2.EMP_NAME AS [EMP_NAME3],
							B.REMARKS, B.REMARKS AS REMARKS_MST,B.MRP,B.ROW_ID,B.CANCELLED,B.FIN_YEAR,B.CUSTOMER_CODE,B.CM_DT,LTRIM(RTRIM(H.CUSTOMER_TITLE+'' ''+H.CUSTOMER_FNAME+'' ''+H.CUSTOMER_LNAME)) AS [CUSTOMER_NAME]
							,ISNULL(H.USER_CUSTOMER_CODE,'''') USER_CUSTOMER_CODE
							,B.HOLDBACK_NO,B.HOLDBACK_DT
					FROM #TMPHOLDS B (NOLOCK) 
					LEFT JOIN ARTICLE ART (NOLOCK) ON B.ARTICLE_CODE = ART.ARTICLE_CODE
					LEFT JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE
					LEFT JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE
					LEFT JOIN PARA1 P1 (NOLOCK) ON B.PARA1_CODE = P1.PARA1_CODE
					LEFT JOIN PARA2 P2 (NOLOCK) ON B.PARA2_CODE = P2.PARA2_CODE
					LEFT JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE
					LEFT OUTER JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE
					LEFT JOIN CUSTDYM H (NOLOCK) ON B.CUSTOMER_CODE = H.CUSTOMER_CODE
					LEFT JOIN AREA I (NOLOCK) ON I.AREA_CODE = H.AREA_CODE
					LEFT JOIN EMPLOYEE EMP(NOLOCK) ON EMP.EMP_CODE=B.EMP_CODE
					LEFT JOIN EMPLOYEE EMP1(NOLOCK) ON EMP1.EMP_CODE=B.EMP_CODE1
					LEFT JOIN EMPLOYEE EMP2(NOLOCK) ON EMP2.EMP_CODE=B.EMP_CODE2
					LEFT JOIN COMPANY COM (NOLOCK) ON COM.COMPANY_CODE=''01''
				)HLDS 
				LEFT JOIN 
				(	
					SELECT G.PRODUCT_CODE, F.JOB_NAME, A.ISSUE_DT, D.AGENCY_NAME,
									G.REF_HBD_ROW_ID, A.CANCELLED, G.ROW_ID,G.DUE_DT,A.ISSUE_NO
					FROM POST_SALES_JOBWORK_ISSUE_MST A (NOLOCK) 
					JOIN POST_SALES_JOBWORK_ISSUE_DET G (NOLOCK) ON A.ISSUE_ID = G.ISSUE_ID 
					JOIN JOBS F (NOLOCK) ON F.JOB_CODE = G.JOB_CODE    
					JOIN #TMPHOLDS h on H.ROW_ID=  G.REF_HBD_ROW_ID  
					JOIN PRD_AGENCY_MST D (NOLOCK) ON A.AGENCY_CODE = D.AGENCY_CODE   
					WHERE A.CANCELLED=0 AND LEFT(A.issue_id,2)='+(CASE WHEN @CLOCID='' THEN  ' LEFT(A.issue_id,2) ' ELSE ' '''+@CLOCID +''' ' END )+'
				)ISSS ON ISSS.REF_HBD_ROW_ID=HLDS.ROW_ID  '
	SET @CCMD1=N'LEFT JOIN 
				(	
					SELECT Q.PRODUCT_CODE, A.RECEIPT_DT, B.REF_ROW_ID, A.CANCELLED,
					       b.job_rate,
					       CONVERT(NUMERIC(10,2),(B.JOB_RATE*B.QUANTITY)) AS AMOUNT,
					       A.RECEIPT_NO
					FROM COMPANY COM 
					JOIN POST_SALES_JOBWORK_RECEIPT_MST A (NOLOCK) ON COM.COMPANY_CODE =''01'' 
					JOIN POST_SALES_JOBWORK_RECEIPT_DET B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID    
					JOIN POST_SALES_JOBWORK_ISSUE_DET M (NOLOCK) ON M.ROW_ID = B.REF_ROW_ID 
					JOIN POST_SALES_JOBWORK_ISSUE_MST N (NOLOCK) ON M.ISSUE_ID = N.ISSUE_ID 
					JOIN HOLD_BACK_DELIVER_DET G (NOLOCK) ON M.REF_HBD_ROW_ID = G.ROW_ID
					JOIN CMD01106 Q (NOLOCK) ON Q.ROW_ID = G.REF_CMD_ROW_ID    
					JOIN CMM01106 P (NOLOCK) ON Q.CM_ID = P.CM_ID
					JOIN PRD_AGENCY_MST Y (NOLOCK) ON N.AGENCY_CODE = Y.AGENCY_CODE 
					JOIN JOBS F (NOLOCK) ON F.JOB_CODE = M.JOB_CODE 
					JOIN #TMPHOLDS h on H.ROW_ID=  M.REF_HBD_ROW_ID  
					WHERE A.CANCELLED=0 AND LEFT(A.RECEIPT_ID,2)='+(CASE WHEN @CLOCID='' THEN  ' LEFT(A.RECEIPT_ID,2) ' ELSE ' '''+@CLOCID +''' ' END )+'
					UNION ALL
					
					SELECT SKU_REPAIR.PRODUCT_CODE, A.RECEIPT_DT, B.REF_ROW_ID, A.CANCELLED,
					        b.job_rate,
					       CONVERT(NUMERIC(10,2),(B.JOB_RATE*B.QUANTITY)) AS AMOUNT,
					       A.RECEIPT_NO
					FROM COMPANY COM 
					JOIN POST_SALES_JOBWORK_RECEIPT_MST A (NOLOCK) ON COM.COMPANY_CODE =''01'' 
					JOIN POST_SALES_JOBWORK_RECEIPT_DET B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID    
					JOIN POST_SALES_JOBWORK_ISSUE_DET M (NOLOCK) ON M.ROW_ID = B.REF_ROW_ID 
					JOIN POST_SALES_JOBWORK_ISSUE_MST N (NOLOCK) ON M.ISSUE_ID = N.ISSUE_ID 
					JOIN HOLD_BACK_DELIVER_DET G (NOLOCK) ON M.REF_HBD_ROW_ID = G.ROW_ID
					JOIN #TMPHOLDS h on H.ROW_ID=  M.REF_HBD_ROW_ID  
					JOIN PRD_AGENCY_MST Y (NOLOCK) ON N.AGENCY_CODE = Y.AGENCY_CODE 
					JOIN SKU_REPAIR (NOLOCK) ON SKU_REPAIR.PRODUCT_CODE=B.PRODUCT_CODE
					WHERE A.CANCELLED=0 AND LEFT(A.RECEIPT_ID,2)='+(CASE WHEN @CLOCID='' THEN  ' LEFT(A.RECEIPT_ID,2) ' ELSE ' '''+@CLOCID +''' ' END )+'		
				) RCV ON RCV.REF_ROW_ID=ISSS.ROW_ID '
			SET @CCMD2=N'LEFT JOIN 
				(	
					SELECT C.PRODUCT_CODE, A.MEMO_DT, A.DELIVERED_TO, B.REF_HBD_ROW_ID, A.CANCELLED
					FROM COMPANY COM 
					JOIN SLS_DELIVERY_MST A (NOLOCK) ON COM.COMPANY_CODE =''01'' 
					JOIN SLS_DELIVERY_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID   
					JOIN HOLD_BACK_DELIVER_DET M (NOLOCK) ON B.REF_HBD_ROW_ID = M.ROW_ID   
					JOIN HOLD_BACK_DELIVER_MST N (NOLOCK) ON M.MEMO_ID = N.MEMO_ID
					JOIN #TMPHOLDS h on H.ROW_ID=  M.ROW_ID
					LEFT OUTER JOIN POST_SALES_JOBWORK_ISSUE_DET P (NOLOCK) ON P.REF_HBD_ROW_ID = M.ROW_ID 
					JOIN CMD01106 C (NOLOCK) ON C.ROW_ID = M.REF_CMD_ROW_ID   
					JOIN CMM01106 G (NOLOCK) ON C.CM_ID = G.CM_ID   
					JOIN JOBS F (NOLOCK) ON F.JOB_CODE = ISNULL(P.JOB_CODE ,M.JOB_CODE)
					WHERE  N.MEMO_DT >= '''+CONVERT(VARCHAR(10), @DLAST_DT,121)+'''
					AND A.CANCELLED=0 AND LEFT(A.MEMO_ID,2)='+(CASE WHEN @CLOCID='' THEN  ' LEFT(A.MEMO_ID,2) ' ELSE ' '''+@CLOCID +''' ' END )+'
					UNION ALL
					
					SELECT SKU_REPAIR.PRODUCT_CODE, A.MEMO_DT, A.DELIVERED_TO, B.REF_HBD_ROW_ID, A.CANCELLED
					FROM COMPANY COM 
					JOIN SLS_DELIVERY_MST A (NOLOCK) ON COM.COMPANY_CODE =''01'' 
					JOIN SLS_DELIVERY_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID   
					JOIN HOLD_BACK_DELIVER_DET M (NOLOCK) ON B.REF_HBD_ROW_ID = M.ROW_ID   
					JOIN HOLD_BACK_DELIVER_MST N (NOLOCK) ON M.MEMO_ID = N.MEMO_ID 
					LEFT OUTER JOIN POST_SALES_JOBWORK_ISSUE_DET P (NOLOCK) ON P.REF_HBD_ROW_ID = M.ROW_ID 
					LEFT OUTER  JOIN POST_SALES_JOBWORK_ISSUE_MST ISSMST (NOLOCK) ON ISSMST.ISSUE_ID=P.ISSUE_ID 
					LEFT OUTER JOIN POST_SALES_JOBWORK_RECEIPT_DET Q (NOLOCK) ON P.ROW_ID = Q.REF_ROW_ID  
					LEFT OUTER  JOIN POST_SALES_JOBWORK_RECEIPT_MST RMST ON RMST.RECEIPT_ID=Q.RECEIPT_ID
					JOIN SKU_REPAIR (NOLOCK) ON SKU_REPAIR.PRODUCT_CODE=M.PRODUCT_CODE  
					JOIN #TMPHOLDS h on H.ROW_ID=  M.ROW_ID  
					
					WHERE  N.MEMO_DT >= '''+CONVERT(VARCHAR(10), @DLAST_DT,121)+'''
				AND A.CANCELLED=0 AND LEFT(A.MEMO_ID,2)='+(CASE WHEN @CLOCID='' THEN  ' LEFT(A.MEMO_ID,2) ' ELSE ' '''+@CLOCID +''' ' END )+' 
				) DLVY ON HLDS.ROW_ID=DLVY.REF_HBD_ROW_ID '
				SET @CCMD3=N'WHERE 1=1  '
				+ (CASE WHEN ISNULL(@BILLNO,'''')<>'' THEN ' AND ( HLDS.CM_NO='''+@BILLNO+''' AND HLDS.CANCELLED=0 AND HLDS.FIN_YEAR='''+@CFINYEAR+''' )' ELSE '' END)
				+ (CASE WHEN ISNULL(@PRODUCT_CODE,'''')<>'' THEN ' AND (HLDS.CANCELLED=0 AND HLDS.FIN_YEAR='''+@CFINYEAR+''' AND HLDS.PRODUCT_CODE='''+@PRODUCT_CODE+''')' ELSE '' END)
				+ (CASE WHEN ISNULL(@CCUSTCODE,'''')<>'' THEN ' AND (HLDS.CUSTOMER_CODE='''+ @CCUSTCODE+ ''' ) ' ELSE '' END)
				+ (CASE WHEN ISNULL(@NMODE,1)=1 THEN ' AND  DLVY.REF_HBD_ROW_ID IS NULL ' 
						WHEN ISNULL(@NMODE,1)=2 THEN ' AND  DLVY.REF_HBD_ROW_ID IS NOT NULL ' ELSE '' END)
				+ (CASE WHEN ISNULL(@NMODE1,1)=1 THEN ' AND  ISSS.PRODUCT_CODE IS NULL ' 
						WHEN ISNULL(@NMODE1,1)=2 THEN ' AND  (ISSS.PRODUCT_CODE IS NOT NULL AND RCV.PRODUCT_CODE IS NULL) ' 
						WHEN ISNULL(@NMODE1,1)=3 THEN ' AND  (ISSS.PRODUCT_CODE IS NOT NULL AND RCV.PRODUCT_CODE IS NOT NULL AND DLVY.REF_HBD_ROW_ID IS NULL) '
						ELSE '' END)
				+' AND '+CASE @AGENCY WHEN '' THEN '1=1' ELSE 'ISSS.AGENCY_NAME='''+@AGENCY+'''' END
				+' ORDER BY HLDS.PRODUCT_CODE '

		PRINT @CCMD
		PRINT @CCMD1
		PRINT @CCMD2
		PRINT @CCMD3
		EXEC(@CCMD+@CCMD1+@CCMD2 +@CCMD3 )
   --EXEC SP_EXECUTESQL (@CCMD+@CCMD1+@CCMD2  )
   GOTO LAST
  
 LBLTOP:
 	SELECT TOP 1 CM_NO FROM 
 	(	
		SELECT	B.PRODUCT_CODE, M.CM_NO, M.CM_DT
		FROM COMPANY COM (NOLOCK)
		JOIN HOLD_BACK_DELIVER_MST A (NOLOCK) ON COM.COMPANY_CODE ='01'
		JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID
		JOIN CMD01106 C (NOLOCK) ON C.ROW_ID = B.REF_CMD_ROW_ID
		JOIN CMM01106 M (NOLOCK) ON C.CM_ID = M.CM_ID
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=C.PRODUCT_CODE
		JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE
		JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE
		JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE
		JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE
		JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE
		JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE
		LEFT OUTER JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE
		JOIN CUSTDYM H (NOLOCK) ON A.CUSTOMER_CODE = H.CUSTOMER_CODE
		JOIN AREA I (NOLOCK) ON I.AREA_CODE = H.AREA_CODE
		JOIN EMPLOYEE EMP(NOLOCK) ON EMP.EMP_CODE=C.EMP_CODE
		JOIN EMPLOYEE EMP1(NOLOCK) ON EMP1.EMP_CODE=C.EMP_CODE1
		JOIN EMPLOYEE EMP2(NOLOCK) ON EMP2.EMP_CODE=C.EMP_CODE2
		UNION
		SELECT B.PRODUCT_CODE, '' AS CM_NO, '' AS CM_DT
		FROM COMPANY COM 
		JOIN HOLD_BACK_DELIVER_MST A (NOLOCK) ON COM.COMPANY_CODE ='01' 
		JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID 
		JOIN SKU_REPAIR SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE
		JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE    
		JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE  
		JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE  
		JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE 
		LEFT OUTER JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE         
		JOIN CUSTDYM H (NOLOCK) ON A.CUSTOMER_CODE = H.CUSTOMER_CODE
		JOIN AREA I (NOLOCK) ON I.AREA_CODE = H.AREA_CODE
	) AS VW_POSTSALES_HBDPRINT
	WHERE PRODUCT_CODE=@PRODUCT_CODE
	ORDER BY CM_DT DESC
	GOTO LAST
  
  
  
  
	LBLAGENCY:
	SELECT ac_code,agency_name FROM PRD_AGENCY_MST (NOLOCK)	
	GOTO LAST

LAST:  
  
END 
*/