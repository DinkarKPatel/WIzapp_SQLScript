CREATE PROCEDURE SP_GETLM_INFO

AS
BEGIN
     
     DECLARE @HEAD_CODE VARCHAR(MAX),@CCMD NVARCHAR(MAX)
     SET @HEAD_CODE=(SELECT DBO.FN_ACT_TRAVTREE('0000000018'))
     SET @HEAD_CODE=ISNULL(@HEAD_CODE,'')+ ','+(SELECT DBO.FN_ACT_TRAVTREE('0000000021'))
   
     
     SET @CCMD=N' SELECT '''' AS CLIENT_ID,LM.AC_NAME,LMP.ADDRESS1 ,LMP.ADDRESS2,CITY ,STATE,  
     LMP.MOBILE,LMP.E_MAIL AS EMAIL,ISNULL(SUM(P.TOTAL_AMOUNT),0) AS PUR_AMT, ISNULL(SUM(L.NET_AMOUNT),0) AS SLS_AMT
     FROM LM01106 LM (NOLOCK)  
     JOIN LMP01106 LMP (NOLOCK) ON LM.AC_CODE =LMP.AC_CODE   
     JOIN CITY (NOLOCK) ON CITY.CITY_CODE =LMP.CITY_CODE   
     JOIN STATE (NOLOCK) ON STATE.STATE_CODE =CITY.STATE_CODE 
     LEFT OUTER JOIN PIM01106 P (NOLOCK) ON LM.AC_CODE= P.AC_CODE AND P.CANCELLED=0
     LEFT OUTER JOIN INM01106 L  (NOLOCK) ON LM.AC_CODE= L.AC_CODE  AND L.CANCELLED=0
     WHERE AC_NAME <> '''' AND LM.HEAD_CODE IN('+@HEAD_CODE+')  
     GROUP BY LM.AC_NAME,LMP.ADDRESS1 ,LMP.ADDRESS2,CITY ,STATE,
     LMP.MOBILE,LMP.E_MAIL '  
     
     PRINT @CCMD
     EXEC SP_EXECUTESQL @CCMD
END
