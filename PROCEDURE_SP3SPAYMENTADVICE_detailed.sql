CREATE PROCEDURE SP3SPAYMENTADVICE_DETAILED
(  
  @CVMID VARCHAR(40)=''  
)  
AS  
BEGIN  
	 DECLARE @DVOUCHERDT DATETIME,@BPAYRECLINKFOUND BIT,@CPARTYACCODE CHAR(10),@CDEBTORHEADS VARCHAR(2000),  
	   @CCREDITORHEADS VARCHAR(2000) ,@cHEAD_CODE VARCHAR(MAX),@cHEAD_CODE1 VARCHAR(MAX) 
	 DECLARE @COST_CENTER_DEPT_ID VARCHAR(100)
	 SELECT TOP 1 @COST_CENTER_DEPT_ID=COST_CENTER_DEPT_ID FROM VD01106 (NOLOCK) WHERE VM_ID=@CVMID  
	 SET @COST_CENTER_DEPT_ID=ISNULL(@COST_CENTER_DEPT_ID,'')
	 IF OBJECT_ID('TEMPDB..#LOCADD','U') IS NOT NULL
		DROP TABLE #LOCADD
		
	 SELECT L.DEPT_ID LOC_DEPT_ID,L.DEPT_NAME LOC_DEPT_NAME,L.PHONE LOC_PHONE,L.ADDRESS1 LOC_ADDRESS1,L.ADDRESS2 LOC_ADDRESS2,
	 ISNULL(A.AREA_NAME,'') LOC_AREA,ISNULL(A.PINCODE,'') LOC_PINCODE,ISNULL(C.CITY,'')CITY,ISNULL(S.STATE,'')LOC_STATE,ISNULL(R.REGION_NAME,'')LOC_REGION,
	 ISNULL(CN.COUNTRY_NAME,'')LOC_COUNTRY
	 INTO #LOCADD
	 FROM LOCATION L (NOLOCK)   
	 LEFT JOIN AREA A (NOLOCK) ON A.AREA_CODE=L.AREA_CODE
	 LEFT JOIN CITY C (NOLOCK) ON C.CITY_CODE=A.CITY_CODE
	 LEFT JOIN STATE S (NOLOCK) ON S.STATE_CODE=C.STATE_CODE
	 LEFT JOIN REGIONM R (NOLOCK) ON R.REGION_CODE=S.REGION_CODE
	 LEFT JOIN COUNTRY CN (NOLOCK) ON CN.COUNTRY_CODE=R.COUNTRY_CODE
	 WHERE L.DEPT_ID=@COST_CENTER_DEPT_ID
   
	 SELECT @CDEBTORHEADS = DBO.FN_ACT_TRAVTREE( '0000000018' ),  
		  @CCREDITORHEADS = DBO.FN_ACT_TRAVTREE( '0000000021' )   
   
	 SELECT @DVOUCHERDT=VOUCHER_DT FROM VM01106 WHERE VM_ID=@CVMID  
   
	 IF OBJECT_ID('TEMPDB..#TMPBB','U') IS NOT NULL  
		 DROP TABLE #TMPBB  

			 IF OBJECT_ID('TEMPDB..#TEMPPAYMENTADVICE','U') IS NOT NULL  
		 DROP TABLE #TEMPPAYMENTADVICE  
   
	 SELECT DISTINCT AC_CODE,REF_NO INTO #TMPBB FROM BILL_BY_BILL_REF A  
	 JOIN VD01106 B ON A.VD_ID=B.VD_ID  
	 WHERE B.VM_ID=@CVMID  
   
	 DECLARE @VTYPE VARCHAR(100)   

	 SELECT TOP 1 @VTYPE=VT.VOUCHER_TYPE+' ADVICE' FROM VM01106 VM JOIN VCHTYPE VT ON VM.VOUCHER_CODE=VT.VOUCHER_CODE
	 WHERE VM_ID=@CVMID

	SET @cHEAD_CODE		=	DBO.FN_ACT_TRAVTREE('0000000013') ----ADD VARIABLE BY GAURI ON 17/4/2019
	SET @cHEAD_CODE1	= DBO.FN_ACT_TRAVTREE('0000000014')  ----ADD VARIABLE BY GAURI ON 17/4/2019
	
	 SELECT  LM.AC_NAME,LMP.ADDRESS0,LMP.ADDRESS1,LMP.ADDRESS2,AREA_NAME,CITY.CITY,PINCODE,STATE,LMP.PHONES_R,LMP.PHONES_O,  
		LMP.PHONES_FAX,LMP.CST_NO,LMP.TIN_NO,CO.COMPANY_NAME,CO.ADDRESS1 AS CADDRESS1,CO.ADDRESS2 AS CADDRESS2,  
		'CITY - '+CO.CITY +', '+ 'STATE - '+CO.STATE +', '+ 'PIN - '+CO.PIN AS CCITY,  
		CO.PHONES_FAX AS CPHONES_FAX,CO.TIN_NO AS CTIN_NO,CO.CIN AS CCIN,CO.LOGO_PATH,BANK.BANK_NAME,  
		BANK.NARRATION,@DVOUCHERDT AS VOUCHER_DT,BANK.CREDIT_AMOUNT AS PAID_AMOUNT,CO.EMAIL_ID
		,@VTYPE INVOICE_HDR
		,LOC.*  
		INTO #TEMPPAYMENTADVICE
		FROM LM01106 LM   
	 JOIN LMP01106 LMP ON LMP.AC_CODE=LM.AC_CODE  
	 JOIN VD01106 C  (NOLOCK) ON C.AC_CODE = LM.AC_CODE  
	 JOIN COMPANY CO (NOLOCK) ON CO.COMPANY_CODE='01'  
	 JOIN AREA ON AREA.AREA_CODE=LMP.AREA_CODE  
	 JOIN CITY ON CITY.CITY_CODE=AREA.CITY_CODE  
	 JOIN (SELECT AC_NAME AS BANK_NAME,NARRATION,A.CREDIT_AMOUNT FROM VD01106 A   
		   JOIN LM01106 B ON A.AC_CODE=B.AC_CODE  
		   WHERE VM_ID=@CVMID AND (CHARINDEX(B.HEAD_CODE,@cHEAD_CODE)>0   ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019 
		   OR CHARINDEX(B.HEAD_CODE,@cHEAD_CODE1)>0)) BANK ON 1=1          ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019 
	 LEFT JOIN #LOCADD LOC ON 1=1      
	 WHERE VM_ID=@CVMID AND LMP.BILL_BY_BILL=1  
   
	 SELECT TOP 1 @CPARTYACCODE=A.AC_CODE FROM VD01106 A   
	 JOIN LMP01106 LMP ON LMP.AC_CODE=A.AC_CODE  
	 WHERE VM_ID=@CVMID AND LMP.BILL_BY_BILL=1  
   
    
	 IF EXISTS (SELECT TOP 1 A.REF_BB_ROW_ID FROM PAYMENT_RECEIPT_ADJLINK A JOIN BILL_BY_BILL_REF B ON A.REF_BB_ROW_ID=B.BB_ROW_ID  
		  JOIN VD01106 C ON C.VD_ID=B.VD_ID WHERE C.VM_ID=@CVMID)  
	  SET @BPAYRECLINKFOUND=1        
	 ELSE  
	  SET @BPAYRECLINKFOUND=0  
   
	 IF OBJECT_ID('TEMPDB..#TMPPYTADV_BILLS','U') IS NOT NULL  
	  DROP TABLE #TMPPYTADV_BILLS  
  
	 IF OBJECT_ID('TEMPDB..#TMPPYTADV_ADJUSTMENTS','U') IS NOT NULL  
	  DROP TABLE #TMPPYTADV_ADJUSTMENTS  
        
	 PRINT 'POPULATE BILLS DATA'   
   
	 SELECT A.REF_NO,SUM(A.AMOUNT*(CASE WHEN A.X_TYPE='CR' THEN -1 ELSE 1 END)) AS BILL_AMOUNT,  
	 A.REF_NO AS  BILL_NO,MAX(VOUCHER_DT) AS BILL_DT,MAX(ADJ_REMARKS) AS ADJ_REMARKS,CONVERT(NUMERIC(10,2),0) AS PAID_AMOUNT  
	 INTO #TMPPYTADV_BILLS  
	 FROM BILL_BY_BILL_REF A (NOLOCK)   
	 JOIN VD01106 B  (NOLOCK) ON A.VD_ID = B.VD_ID   
	 JOIN VM01106 V  (NOLOCK) ON B.VM_ID = V.VM_ID   
	 JOIN LM01106 LM  (NOLOCK) ON LM.AC_CODE=B.AC_CODE  
	 JOIN LMP01106 LMP  (NOLOCK) ON LMP.AC_CODE=LM.AC_CODE  
	 JOIN LMV01106 L (NOLOCK) ON L.AC_CODE=B.AC_CODE  
	 JOIN COMPANY CO (NOLOCK) ON CO.COMPANY_CODE='01'  
	 JOIN #TMPBB D ON D.AC_CODE=B.AC_CODE AND D.REF_NO=A.REF_NO  
	 WHERE V.VM_ID IN   
	 (SELECT C.VM_ID FROM BILL_BY_BILL_REF A 
	  JOIN VD01106 B ON A.VD_ID=B.VD_ID  
	  JOIN VM01106 C ON C.VM_ID=B.VM_ID  
	  JOIN #TMPBB D ON D.AC_CODE=B.AC_CODE AND D.REF_NO=A.REF_NO  
	  WHERE CANCELLED=0 AND C.VM_ID<>@CVMID GROUP BY C.VM_ID,A.REF_NO,B.AC_CODE   
	  HAVING SUM(CASE WHEN A.X_TYPE='CR' THEN -AMOUNT ELSE AMOUNT END)<0  
	 )
	 AND D.AC_CODE+D.REF_NO IN 
	 (SELECT D.AC_CODE+D.REF_NO FROM BILL_BY_BILL_REF A 
	  JOIN VD01106 B ON A.VD_ID=B.VD_ID  
	  JOIN VM01106 C ON C.VM_ID=B.VM_ID  
	  JOIN #TMPBB D ON D.AC_CODE=B.AC_CODE AND D.REF_NO=A.REF_NO  
	  WHERE CANCELLED=0 AND C.VM_ID<>@CVMID GROUP BY D.AC_CODE,D.REF_NO
	  HAVING SUM(CASE WHEN A.X_TYPE='CR' THEN -AMOUNT ELSE AMOUNT END)<0  
	 )	 
	 GROUP BY A.REF_NO
	 
	 UNION ALL
	 SELECT A.REF_NO,SUM(A.AMOUNT*(CASE WHEN A.X_TYPE='DR' THEN -1 ELSE 1 END)) AS BILL_AMOUNT,  
	 A.REF_NO AS  BILL_NO,MAX(VOUCHER_DT) AS BILL_DT,MAX(ADJ_REMARKS) AS ADJ_REMARKS,CONVERT(NUMERIC(10,2),0) AS PAID_AMOUNT  
	 FROM BILL_BY_BILL_REF A (NOLOCK)   
	 JOIN VD01106 B  (NOLOCK) ON A.VD_ID = B.VD_ID   
	 JOIN VM01106 V  (NOLOCK) ON B.VM_ID = V.VM_ID   
	 JOIN LM01106 LM  (NOLOCK) ON LM.AC_CODE=B.AC_CODE  
	 JOIN LMP01106 LMP  (NOLOCK) ON LMP.AC_CODE=LM.AC_CODE  
	 JOIN LMV01106 L (NOLOCK) ON L.AC_CODE=B.AC_CODE  
	 JOIN COMPANY CO (NOLOCK) ON CO.COMPANY_CODE='01'  
	 JOIN #TMPBB D ON D.AC_CODE=B.AC_CODE AND D.REF_NO=A.REF_NO  
	 LEFT OUTER JOIN 
	 (SELECT D.AC_CODE,D.REF_NO FROM BILL_BY_BILL_REF A  
	  JOIN VD01106 B ON A.VD_ID=B.VD_ID  
	  JOIN VM01106 C ON C.VM_ID=B.VM_ID  
	  JOIN #TMPBB D ON D.AC_CODE=B.AC_CODE AND D.REF_NO=A.REF_NO  
	  WHERE CANCELLED=0 AND C.VM_ID<>@CVMID
	 ) E ON E.AC_CODE=D.AC_CODE AND E.REF_NO=D.REF_NO
	 
	 WHERE V.VM_ID=@CVMID AND E.REF_NO IS NULL
	 GROUP BY A.REF_NO
	 
	 --SELECT 'CHECK #TMPBB',* FROM #TMPBB

	 --SELECT 'CHECK NEW',* FROM #TMPPYTADV_BILLS  
   
	 PRINT 'POPULATE ADJUSTMENTS DATA'  
    
	 IF OBJECT_ID('TEMPDB..#TMPPYTADV_ADJUSTMENTS','U') IS NOT NULL  
	  DROP TABLE #TMPPYTADV_ADJUSTMENTS  
       
	 SELECT VM_ADJ.BILL_NO AS ADJ_MEMO_NO,VM_ADJ.VOUCHER_DT AS ADJ_MEMO_DT,SUM(BB_ADJ.AMOUNT*  
	 (CASE WHEN BB_ADJ.X_TYPE='DR' THEN -1 ELSE 1 END)) AS ADJ_AMOUNT,ADJ_REMARKS,  
	 (CASE WHEN REPLACE(BB_ADJ.REF_NO,'/'+DBO.FN_GETDATE_DDMMYY(VM_ADJ.VOUCHER_DT),'')=VM_ADJ.BILL_NO OR  
		  REPLACE(BB_ADJ.REF_NO,'/'+CONVERT(VARCHAR,VM_ADJ.VOUCHER_DT,112),'')=VM_ADJ.BILL_NO THEN '' ELSE BB_ADJ.REF_NO END) AS REF_NO  
   
	 INTO #TMPPYTADV_ADJUSTMENTS FROM BILL_BY_BILL_REF BB_ADJ   
	 JOIN VD01106 VD_ADJ ON VD_ADJ.VD_ID=BB_ADJ.VD_ID  
	 JOIN VM01106 VM_ADJ ON VM_ADJ.VM_ID=VD_ADJ.VM_ID  
	 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=VD_ADJ.AC_CODE  
     JOIN #TMPBB D ON D.AC_CODE=VD_ADJ.AC_CODE AND D.REF_NO=BB_ADJ.REF_NO  
	 WHERE VM_ADJ.VM_ID+VD_ADJ.AC_CODE IN   
	 (SELECT C.VM_ID+B.AC_CODE FROM BILL_BY_BILL_REF A  
	  JOIN VD01106 B ON A.VD_ID=B.VD_ID  
	  JOIN VM01106 C ON C.VM_ID=B.VM_ID  
	  JOIN #TMPBB D ON D.AC_CODE=B.AC_CODE AND D.REF_NO=A.REF_NO  
	  WHERE CANCELLED=0 AND C.VM_ID<>@CVMID GROUP BY C.VM_ID,A.REF_NO,B.AC_CODE   
	  HAVING SUM(CASE WHEN A.X_TYPE='CR' THEN -AMOUNT ELSE AMOUNT END)>=0  
	 )   
	 AND VM_ADJ.VOUCHER_DT<=@DVOUCHERDT AND VM_ADJ.CANCELLED=0   
	 GROUP BY BB_ADJ.REF_NO,VM_ADJ.BILL_NO,VM_ADJ.VOUCHER_DT,ADJ_REMARKS  
   
 
 
	 UPDATE A SET  PAID_AMOUNT=B.PAID_AMOUNT FROM #TMPPYTADV_BILLS A  
	 JOIN (SELECT REF_NO,SUM(CASE WHEN A.X_TYPE='DR' THEN AMOUNT ELSE -AMOUNT END) AS PAID_AMOUNT FROM   
		BILL_BY_BILL_REF A JOIN VD01106 B ON A.VD_ID=B.VD_ID   
		WHERE B.VM_ID=@CVMID GROUP BY REF_NO) B ON A.REF_NO=B.REF_NO  
	 WHERE A.BILL_AMOUNT<0     
  
	 INSERT #TMPPYTADV_BILLS (REF_NO,BILL_NO,BILL_DT,BILL_AMOUNT,PAID_AMOUNT,ADJ_REMARKS)  
	 SELECT VOUCHER_NO AS REF_NO,VOUCHER_NO AS  BILL_NO,VOUCHER_DT AS BILL_DT,  
	 A.CREDIT_AMOUNT AS BILL_AMOUNT,0 AS PAID_AMOUNT,'CASH DISCOUNT' AS ADJ_XN_REMARKS  
	 FROM VD01106 A JOIN LM01106 B ON A.AC_CODE=B.AC_CODE  
	 JOIN VM01106 C ON C.VM_ID=A.VM_ID  
	 WHERE C.VM_ID=@CVMID AND CHARINDEX(B.HEAD_CODE,DBO.FN_ACT_TRAVTREE('0000000010'))>0  

	 SELECT * FROM #TEMPPAYMENTADVICE
        
	 SELECT BILL_NO,BILL_DT,ADJ_REMARKS,(CASE WHEN BILL_AMOUNT>0 THEN BILL_AMOUNT ELSE 0 END) AS DEBIT_AMOUNT,  
	 (CASE WHEN BILL_AMOUNT<0 THEN ABS(BILL_AMOUNT) ELSE 0  END) AS CREDIT_AMOUNT,PAID_AMOUNT  
	 FROM #TMPPYTADV_BILLS ORDER BY (CASE WHEN BILL_AMOUNT<0 THEN 1 ELSE 2 END),BILL_DT,BILL_NO --WHERE REF_NO='PUR_HO0111600000HO00005153'  
   
	 SELECT ADJ_MEMO_NO AS BILL_NO,REF_NO,ADJ_REMARKS,(CASE WHEN ADJ_AMOUNT<0 THEN ABS(ADJ_AMOUNT) ELSE 0 END) AS DEBIT_AMOUNT,  
	 (CASE WHEN ADJ_AMOUNT>0 THEN ADJ_AMOUNT ELSE 0  END) AS CREDIT_AMOUNT,ADJ_MEMO_DT AS BILL_DT   
	 FROM #TMPPYTADV_ADJUSTMENTS ORDER BY (CASE WHEN ADJ_AMOUNT<0 THEN 1 ELSE 2 END),BILL_DT,BILL_NO  --WHERE REF_NO='PUR_HO0111600000HO00005153'  
   

	IF EXISTS(SELECT 'U' FROM SYS.TABLES WHERE NAME ='TPAYMENTADVICE' AND DATEDIFF(d,create_date,getdate())<>0)
  		DROP TABLE TPAYMENTADVICE

	IF  OBJECT_ID('TPAYMENTADVICE','U') IS NULL	
	BEGIN
		select * 
		INTO TPAYMENTADVICE2
		from #TEMPPAYMENTADVICE
		WHERE 1=2
   END

   IF EXISTS(SELECT 'U' FROM SYS.TABLES WHERE NAME ='TPAYMENTADVICE1' AND DATEDIFF(d,create_date,getdate())<>0)
  		DROP TABLE TPAYMENTADVICE1

	IF  OBJECT_ID('TPAYMENTADVICE1','U') IS NULL	
	BEGIN
		SELECT BILL_NO,BILL_DT,ADJ_REMARKS,(CASE WHEN BILL_AMOUNT>0 THEN BILL_AMOUNT ELSE 0 END) AS DEBIT_AMOUNT,  
	 (CASE WHEN BILL_AMOUNT<0 THEN ABS(BILL_AMOUNT) ELSE 0  END) AS CREDIT_AMOUNT,PAID_AMOUNT  
	 INTO TPAYMENTADVICE1
	 FROM #TMPPYTADV_BILLS
	 WHERE 1=2
   END

   IF EXISTS(SELECT 'U' FROM SYS.TABLES WHERE NAME ='TPAYMENTADVICE2' AND DATEDIFF(d,create_date,getdate())<>0)
  		DROP TABLE TPAYMENTADVICE2

	IF  OBJECT_ID('TPAYMENTADVICE2','U') IS NULL	
	BEGIN
		SELECT ADJ_MEMO_NO AS BILL_NO,REF_NO,ADJ_REMARKS,(CASE WHEN ADJ_AMOUNT<0 THEN ABS(ADJ_AMOUNT) ELSE 0 END) AS DEBIT_AMOUNT,  
	 (CASE WHEN ADJ_AMOUNT>0 THEN ADJ_AMOUNT ELSE 0  END) AS CREDIT_AMOUNT,ADJ_MEMO_DT AS BILL_DT   
	 INTO TPAYMENTADVICE2
	 FROM #TMPPYTADV_ADJUSTMENTS
	WHERE 1=2
   END

	ENDPROC:  
  
END  
--END OF PROCEDURE - SP3SPAYMENTADVICE
