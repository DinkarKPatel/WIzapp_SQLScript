-- PROCEDURE TO SAVE A TRANSACTION APPROVAL MEMO 
create PROCEDURE SAVETRAN_TRANSACTION_APPROVAL
(
	@NUPDATEMODE		NUMERIC(1,0),
	@NSPID				varchar(50),
	@CMEMONOPREFIX		VARCHAR(50),
	@CFINYEAR			VARCHAR(10),
	@CMACHINENAME		VARCHAR(100)='',
	@CWINDOWUSERNAME	VARCHAR(100)='',
	@CWIZAPPUSERCODE	VARCHAR(10)='0000000',
	@CMEMOID			VARCHAR(40)='',
	@CLOCID				VARCHAR(4)=''
)
AS
BEGIN

		--changes by Dinkar in location id varchar(4)..
	-- @NUPDATEMODE:	1- NEW MEMO ADDED, 
	--					2- EXISTING MEMO EDITED, 
	
	DECLARE @CTEMPDBNAME			VARCHAR(100),
			@CMASTERTABLENAME		VARCHAR(100),
			@CTEMPMASTERTABLENAME	VARCHAR(1000),
			@CTEMPMASTERTABLE		VARCHAR(1000),
			@CERRORMSG				VARCHAR(500),
			@CLOCATIONID			VARCHAR(4),
			@CHODEPTID				VARCHAR(4),
			@CCMD					NVARCHAR(4000),
			@CCMDOUTPUT				NVARCHAR(4000),
			@NSAVETRANLOOP			BIT,
			@NSTEP					INT,
			@BNEGSTOCKFOUND			BIT,
			@CVALUSERARC			CHAR(2),
			@ARCTYPE                INT,
			@ARCT                   INT,
			@CMEMODT                DATETIME	,@NLEVELNO NUMERIC(2,0),@BINVALIDENTRYFOUND BIT
			,@CXNTYPE VARCHAR(20)
			,@CREFXNTYPE VARCHAR(20)
			,@ICURRENTLEVEL INT
			,@IMAXLEVEL INT,
			 @CMEMO_ID VARCHAR(50)
			

	DECLARE @OUTPUT TABLE ( ERRMSG VARCHAR(2000), MEMO_ID VARCHAR(100))
	
	

	SET @NSTEP = 0		-- SETTTING UP ENVIRONMENT
    
	-- TEMPORARY DATABASE Discarded now onwards as per Meeting on 30-10-2020 mentioned in Client issues List
	SET @CTEMPDBNAME = ''
		
	SET @CMASTERTABLENAME	= 'TRANSACTION_APPROVAL_DET'
	SET @CTEMPMASTERTABLENAME	= 'XNS_TRANSACTION_APPROVAL_DET_UPLOAD'
	SET @CTEMPMASTERTABLE	= @CTEMPDBNAME + @CTEMPMASTERTABLENAME
	
	
	
	SET @CCMD=N'SELECT TOP 1 @CXNTYPE=XN_TYPE,@ICURRENTLEVEL=LEVEL_NO FROM '+@CTEMPMASTERTABLE +' WHERE SP_ID= '''+@NSPID+''' '
    EXEC SP_EXECUTESQL @CCMD,N'@CXNTYPE VARCHAR(20) OUTPUT,@ICURRENTLEVEL INT OUTPUT',@CXNTYPE OUTPUT,@ICURRENTLEVEL OUTPUT
		
	SET @CERRORMSG			= ''
	
	
	SET @CLOCATIONID=@CLOCID
		
	SELECT @CHODEPTID		= [VALUE] FROM CONFIG WHERE  CONFIG_OPTION='HO_LOCATION_ID'		

	SET @NSTEP = 10		-- GETTING DEPTID INFO FROM TEMP TABLE
	BEGIN TRY
	BEGIN TRANSACTION			
		
		IF ISNULL(@CXNTYPE,'')=''
		BEGIN
		   SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' TRANSACTION TYPE CAN NOT BE BLANK : ' 
			GOTO END_PROC
		END
		
		if @CXNTYPE in('pur','PBM')
		begin
		   
		   	SELECT @IMAXLEVEL=ISNULL(MAX(LEVEL_NO),0)
			FROM XN_APPROVAL_CHECKLIST_LEVELS
			WHERE XN_TYPE in('PUR','PBM') AND INACTIVE=0

		end
		else
		begin

			SELECT @IMAXLEVEL=ISNULL(MAX(LEVEL_NO),0)
			FROM XN_APPROVAL_CHECKLIST_LEVELS
			WHERE XN_TYPE=@CXNTYPE AND INACTIVE=0

		end


		
		IF @NUPDATEMODE = 1 -- ADDMODE	
		BEGIN	

		
			
			SET @NSTEP = 113	
			SET @CCMD = 'UPDATE A SET A.LEVEL_NO=(CASE WHEN ISNULL(A.LEVEL_NO,0)=0 THEN B.LEVEL_NO ELSE A.LEVEL_NO END),
						 ROW_ID=NEWID() FROM ' +
						 @CTEMPMASTERTABLE + ' A 
						 JOIN XN_APPROVAL_CHECKLIST_LEVEL_USERS B ON A.USER_CODE=B.USER_CODE
						 JOIN XN_APPROVAL_CHECKLIST_LEVELS C ON C.LEVEL_NO=B.LEVEL_NO AND C.XN_TYPE='''+RTRIM(LTRIM((@CXNTYPE)))+'''
						 WHERE SP_ID='''+@NSPID+''' '

			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
		END					-- END OF ADDMODE
		--SELECT @CTEMPDBNAME,@CTEMPMASTERTABLENAME,@CMASTERTABLENAME

		 DECLARE @CWHERECLAUSE VARCHAR(1000)
		 SET @CWHERECLAUSE='  SP_ID='''+ LTRIM(RTRIM((@NSPID)))+''''

		SET @NSTEP = 140
		EXEC UPDATEMASTERXN_OPT
			  @CSOURCEDB	= @CTEMPDBNAME
			, @CSOURCETABLE = @CTEMPMASTERTABLENAME
			, @CDESTDB		= ''
			, @CDESTTABLE	= @CMASTERTABLENAME
			, @CKEYFIELD1	= 'ROW_ID'
			, @BALWAYSUPDATE = 0
			, @LINSERTONLY=1
			,@CFILTERCONDITION=@CWHERECLAUSE
			
		-- VALIDATING ENTRIES 
		
		IF @CCMDOUTPUT <> ''
		BEGIN
			SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' DATA VALIDATION FAILED : ' + @CCMDOUTPUT + '...'
			GOTO END_PROC
		END
				
		
		--C.LEVEL_NO
		-- START UPDATING XN TABLES	
		/*UPDATE APPROVAL_LEVELNO*/		
			
		IF @CXNTYPE IN ('PUR','PBM')
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM PIM01106 A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.MRR_ID=C.XN_ID  
						 WHERE C.SP_ID ='''+@NSPID +''' '
  		PRINT @CCMD  						   
		EXEC SP_EXECUTESQL @CCMD 
		END
			
		 
		ELSE IF @CXNTYPE='PO'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END),
													 approved=case when C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+' then 2 else approved end 
  						 FROM POM01106 A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.PO_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  		PRINT @CCMD  						   
		EXEC SP_EXECUTESQL @CCMD 
			
	   END	
	   ELSE IF @CXNTYPE in('WSL','GRPWSL')
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM INM01106 A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.INV_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  		PRINT @CCMD  						   
		EXEC SP_EXECUTESQL @CCMD 
			
	   END		
	   ELSE IF @CXNTYPE='BDGPL'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM BUDGET_PLAN_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.MEMO_NO=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  		PRINT @CCMD  						   
		EXEC SP_EXECUTESQL @CCMD 
			
	   END	
	   ELSE IF @CXNTYPE='BUYPL'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM BUY_PLAN_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.MEMO_NO=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  		PRINT @CCMD  						   
		EXEC SP_EXECUTESQL @CCMD
		END 
		
		ELSE IF @CXNTYPE='WSLORD'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM BUYER_ORDER_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.ORDER_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 

			SET @CCMD=N'UPDATE A SET Approved=1
  						 FROM BUYER_ORDER_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.ORDER_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' and a.ApprovedLevelNo=99 '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 
			
		END	
        ELSE IF @CXNTYPE='ASN'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM ASN_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.MEMO_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +'''  '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 			
			
	   END	
	   ELSE IF @CXNTYPE='QC'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM QC_XN_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.MEMO_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 			
			
	   END 
	    ELSE IF @CXNTYPE='VCH'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM VM01106 A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.VM_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +'''  '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	   
       ELSE IF @CXNTYPE='PRT'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM RMM01106 A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.RM_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +'''  '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	    ELSE IF @CXNTYPE='EDT'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM TBL_EOSS_DISC_SHARE_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +'''  '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	    ELSE IF @CXNTYPE='ARO'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM ARO_PLAN_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.PLAN_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +'''  '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	  
       ELSE IF @CXNTYPE='PTC'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM PED01106 A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.pem_memo_id=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	   
	    ELSE IF @CXNTYPE='SLSCRI'
	    BEGIN
			IF @ICURRENTLEVEL=1
				BEGIN
					    SET @CCMD=N'SELECT XN_ID,1 FROM '+@CTEMPMASTERTABLE+' WHERE SP_ID ='''+@NSPID +''' '  
					PRINT @CCMD
					
					INSERT CREDITBILLS(CM_ID,APPROVEDLEVELNO)
					EXEC SP_EXECUTESQL @CCMD
				END
			ELSE 
				BEGIN
					SET @CCMD=N'UPDATE A 
										SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
																 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
															 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
															 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  								 FROM CREDITBILLS A
  								 JOIN '+@CTEMPMASTERTABLE+' C ON A.cm_id=C.XN_ID 
								 WHERE C.SP_ID ='''+@NSPID +''' '
  					PRINT @CCMD  						   
					EXEC SP_EXECUTESQL @CCMD 						
					
			   END 	
		END	   
	   
	    ELSE IF @CXNTYPE='CRDISS'
	    BEGIN
			IF @ICURRENTLEVEL=1
				BEGIN
					SET @CCMD=N'SELECT XN_ID,1 FROM '+@CTEMPMASTERTABLE +' WHERE SP_ID ='''+@NSPID +''' '
					PRINT @CCMD
					
					INSERT CARDISSUE(adv_rec_id,APPROVEDLEVELNO)
					EXEC SP_EXECUTESQL @CCMD
				END
			ELSE 
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM CARDISSUE A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.adv_rec_id=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	 END  
	   ELSE IF @CXNTYPE='SFT'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM TILL_SHIFT_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.shift_id=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +'''  '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END
	   
	   ELSE IF @CXNTYPE in ('EOSSDSLS','SLSEDT')
	   BEGIN
			IF @ICURRENTLEVEL=1
				BEGIN
					SET @CCMD=N'SELECT XN_ID,1 FROM '+@CTEMPMASTERTABLE+' WHERE SP_ID ='''+@NSPID +''' '
					PRINT @CCMD
					
					INSERT EOSSDISABLEDSLS(CM_ID,APPROVEDLEVELNO)
					EXEC SP_EXECUTESQL @CCMD
				END
			ELSE 
				BEGIN
					SET @CCMD=N'UPDATE A 
										SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
																 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
															 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
															 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  								 FROM EOSSDISABLEDSLS A
  								 JOIN '+@CTEMPMASTERTABLE+' C ON A.cm_id=C.XN_ID 
								 WHERE C.SP_ID ='''+@NSPID +''' '
  					PRINT @CCMD  						   
					EXEC SP_EXECUTESQL @CCMD 						
					
			   END 				 					   
		END

		ELSE IF @CXNTYPE='EOSSSOR'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM eosssorm A WITH (ROWLOCK)
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.memo_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 

       ELSE IF @CXNTYPE='WSR'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM CNM01106 A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.cn_id=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	   	ELSE IF @CXNTYPE='jc'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM ord_plan_mst A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.memo_id=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +'''  '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	   ELSE IF @CXNTYPE='JWI'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM JOBWORK_ISSUE_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.ISSUE_ID=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	   ELSE IF @CXNTYPE='JWR'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM JOBWORK_RECEIPT_MST A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.receipt_id=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	   ELSE IF @CXNTYPE='WPS'
		BEGIN
			SET @CCMD=N'UPDATE A 
								SET APPROVEDLEVELNO=(CASE WHEN ISNULL(C.APPROVAL_STATUS,0)=1 AND 
														 C.LEVEL_NO='+LTRIM(RTRIM(STR(@IMAXLEVEL)))+'
													 THEN ''99'' ELSE CASE WHEN ISNULL(C.DISAPPROVAL_STATUS,0)= 1 
													 THEN C.LEVEL_NO-1 ELSE C.LEVEL_NO END END)
  						 FROM Wps_mst A
  						 JOIN '+@CTEMPMASTERTABLE+' C ON A.ps_id=C.XN_ID 
						 WHERE C.SP_ID ='''+@NSPID +''' '
  			PRINT @CCMD  						   
			EXEC SP_EXECUTESQL @CCMD 						
			
	   END 
	 
		
	END TRY
	BEGIN CATCH
		SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		GOTO END_PROC
	END CATCH
	
END_PROC:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')='' AND ISNULL(@BINVALIDENTRYFOUND,0)=0
		BEGIN
		         
	 IF @CXNTYPE='PO' AND EXISTS(SELECT TOP 1 'U' FROM CONFIG_PO_BO A (NOLOCK))
		BEGIN
		     
			  SELECT A.PO_ID ,A.ac_code ,A.PO_DT ,A.last_update,A.ApprovedLevelNo
			  INTO #TMPPOLIST
			  FROM POM01106 A
  			  JOIN XNS_TRANSACTION_APPROVAL_DET_UPLOAD C ON A.PO_ID=C.XN_ID 
			  WHERE C.SP_ID =@NSPID
			  GROUP BY A.PO_ID ,A.ac_code ,A.PO_DT  ,A.last_update,A.ApprovedLevelNo



			  	IF EXISTS(SELECT TOP 1 'U' FROM CONFIG_PO_BO A (NOLOCK) JOIN #TMPPOLIST B (NOLOCK) ON A.SOURCE_AC_CODE=B.AC_CODE WHERE  PO_DT >='2018-11-20')
				BEGIN
					
						UPDATE A SET LAST_UPDATE=GETDATE() 
						FROM UPLOAD_MIRRORPO_BO A WITH (ROWLOCK) 
						JOIN #TMPPOLIST B (NOLOCK) ON A.PO_ID=B.PO_ID 
						WHERE  PO_DT >='2018-11-20'
						AND A.XN_TYPE='PO' 

						INSERT UPLOAD_MIRRORPO_BO WITH (ROWLOCK) (XN_TYPE, PO_ID, LAST_UPDATE, ERRMSG ,HO_DEPT_ID,IP)   
						SELECT DISTINCT 'PO' AS XN_TYPE, A.PO_ID AS PO_ID, 
						A.LAST_UPDATE AS LAST_UPDATE,'' AS  ERRMSG,
						(SELECT TOP 1 HO_DEPT_ID FROM CONFIG_PO_BO (NOLOCK)) AS HO_DEPT_ID,
						(SELECT TOP 1 IP FROM CONFIG_PO_BO (NOLOCK)) AS IP
						FROM #TMPPOLIST A WITH (NOLOCK)
						LEFT JOIN UPLOAD_MIRRORPO_BO B (NOLOCK) ON A.PO_ID=B.PO_ID AND B.XN_TYPE='PO'
						AND (@IMAXLEVEL=0 OR A.APPROVEDLEVELNO=99)
						AND B.PO_ID IS NULL
						AND EXISTS(SELECT TOP 1 PRODUCT_CODE FROM POD01106 PD(NOLOCK) WHERE PD.PO_ID=A.PO_ID AND ISNULL(PD.PRODUCT_CODE,'')<>'')
						
					END 
				END

			
		    
			COMMIT TRANSACTION
		END	
		ELSE
			ROLLBACK
	END
	
	IF ISNULL(@BINVALIDENTRYFOUND,0)=0
	BEGIN
		INSERT @OUTPUT ( ERRMSG, MEMO_ID)
		SELECT  ISNULL(@CERRORMSG,''),CASE WHEN ISNULL(@CERRORMSG,'')='' THEN 'SUCESS' ELSE 'FAIL' END

		SELECT * FROM @OUTPUT	
	END	
	
  
  DELETE A FROM XNS_TRANSACTION_APPROVAL_DET_UPLOAD A (NOLOCK) WHERE SP_ID=@NSPID
		
	
	
	
END
------------------------------------------------------ END OF PROCEDURE SAVETRAN_TRANSACTION_APPROVAL
