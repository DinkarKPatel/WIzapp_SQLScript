CREATE PROCEDURE SP3S_MIRROR_CHKMISSINGSERIES
@CXNTYPE VARCHAR(10),
@CTABLENAME VARCHAR(200),
@CMEMONOCOL VARCHAR(100),
@CMEMOIDCOL VARCHAR(100),
@NMEMONOLEN INT,
@NMEMOIDLEN INT,
@CWHERECLAUSE VARCHAR(MAX)
--WITH ENCRYPTION
AS

BEGIN

	PRINT 'CHECK MISSING SERIES-1'+@CXNTYPE
	--- @CWHERECLAUSE='CM_MODE = 1 AND SUBSTRING(CM_NO, 5, 1)<>'N''
	--********** START OF BATCH
	DECLARE @CCMD NVARCHAR(MAX)
	DECLARE @TMPSERIES TABLE ( FIN_YEAR VARCHAR(5),DEPT_ID VARCHAR(5),PREFIX VARCHAR(10),MIN_NO INT,MAX_NO INT,MEMO_CNT INT )


--SELECT @NMEMONOLEN
	DECLARE @CPREFIX VARCHAR(10), @NLOOPCNT INT,
			@NMIN BIGINT, 
			@NMAX BIGINT,
			@NCTR BIGINT,
			@CXNID VARCHAR(40),@CDEPTID VARCHAR(5),@CFINYEAR VARCHAR(10)

	IF OBJECT_ID('TEMPDB..#TMPMEMOIDS','U') IS NOT NULL
		DROP TABLE #TMPMEMOIDS
	
	PRINT 'CHECK MISSING SERIES-2'+@CXNTYPE
	SELECT CM_ID AS MEMO_ID,@CXNTYPE AS XN_TYPE,CONVERT(VARCHAR(10),'') AS MEMO_PREFIX INTO #TMPMEMOIDS FROM CMM01106 (NOLOCK) WHERE 1=2
	
		
	IF CURSOR_STATUS('GLOBAL','SERIESCUR') IN (0,1)
	BEGIN
		CLOSE SERIESCUR
		DEALLOCATE SERIESCUR
	END

	PRINT 'CHECK MISSING SERIES-3'+@CXNTYPE

	SET @CWHERECLAUSE=(CASE WHEN @CWHERECLAUSE='' THEN '1=1' ELSE @CWHERECLAUSE END)
	
	IF @CXNTYPE='SLS'
		SET @CCMD=N'SELECT FIN_YEAR,LEFT('+@CMEMOIDCOL+',2) AS DEPT_ID,LEFT('+@CMEMONOCOL+',LEN(MEMO_PREFIX)), 
					MIN(CAST(RIGHT(RTRIM('+@CMEMONOCOL+'),12-LEN(MEMO_PREFIX)) AS INT)) AS MIN_NO,
					MAX(CAST(RIGHT(RTRIM('+@CMEMONOCOL+'),12-LEN(MEMO_PREFIX)) AS INT)) AS MAX_NO,
					COUNT(*) AS MEMO_CNT  FROM '+@CTABLENAME+' (NOLOCK) WHERE 1=1 '+@CWHERECLAUSE+' AND LEN(MEMO_NO)=12
					GROUP BY FIN_YEAR,LEFT('+@CMEMOIDCOL+',2),LEFT('+@CMEMONOCOL+',LEN(MEMO_PREFIX))
					UNION
					SELECT FIN_YEAR,LEFT('+@CMEMOIDCOL+',2) AS DEPT_ID,LEFT('+@CMEMONOCOL+',LEN(MEMO_PREFIX)), 
					MIN(CAST(RIGHT(RTRIM('+@CMEMONOCOL+'),10-LEN(MEMO_PREFIX)) AS INT)) AS MIN_NO,
					MAX(CAST(RIGHT(RTRIM('+@CMEMONOCOL+'),10-LEN(MEMO_PREFIX)) AS INT)) AS MAX_NO,
					COUNT(*) AS MEMO_CNT  FROM '+@CTABLENAME+' (NOLOCK) WHERE 1=1 '+@CWHERECLAUSE+' AND LEN(MEMO_NO)=10
					GROUP BY FIN_YEAR,LEFT('+@CMEMOIDCOL+',2),LEFT('+@CMEMONOCOL+',LEN(MEMO_PREFIX))'
	ELSE
		SET @CCMD=N'SELECT FIN_YEAR,LEFT('+@CMEMOIDCOL+',2) AS DEPT_ID,LEFT('+@CMEMONOCOL+',LEN(MEMO_PREFIX)), 
					MIN(CAST(RIGHT(RTRIM('+@CMEMONOCOL+'),'+LTRIM(RTRIM(STR(@NMEMONOLEN)))+'-LEN(MEMO_PREFIX)) AS INT)) AS MIN_NO,
					MAX(CAST(RIGHT(RTRIM('+@CMEMONOCOL+'),'+LTRIM(RTRIM(STR(@NMEMONOLEN)))+'-LEN(MEMO_PREFIX)) AS INT)) AS MAX_NO,
					COUNT(*) AS MEMO_CNT  FROM '+@CTABLENAME+' (NOLOCK) WHERE 1=1 '+@CWHERECLAUSE+
					' GROUP BY FIN_YEAR,LEFT('+@CMEMOIDCOL+',2),LEFT('+@CMEMONOCOL+',LEN(MEMO_PREFIX))'	
	PRINT @CCMD
	
	PRINT 'CHECK MISSING SERIES-4'+@CXNTYPE
	INSERT @TMPSERIES
	EXEC SP_EXECUTESQL @CCMD
	
	
	
	
	
	DECLARE @NMEMOCNT INT,@NLASTMAX INT,@CLASTPREFIX VARCHAR(10),@NLOOP INT,@NMAXLOOP INT
	
	DECLARE SERIESCUR CURSOR FOR
	SELECT	FIN_YEAR,DEPT_ID,PREFIX,MIN_NO,MAX_NO,MEMO_CNT
	FROM @TMPSERIES ORDER BY PREFIX
	
	PRINT 'CHECK MISSING SERIES-5'+@CXNTYPE
	OPEN SERIESCUR

	FETCH NEXT FROM SERIESCUR INTO @CFINYEAR,@CDEPTID,@CPREFIX,@NMIN, @NMAX,@NMEMOCNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SELECT @NCTR = @NMIN,@NMAXLOOP=@NMAX
		WHILE @NCTR <= @NMAXLOOP
		BEGIN
			PRINT 'CHECK MISSING SERIES-7'+@CXNTYPE+'PREFIX:'+@CPREFIX+' MIN :'+STR(@NMIN)+' MAX:'+STR(@NMAXLOOP)+'CNT:'+STR(@NCTR)
			SET @CXNID = @CDEPTID+@CFINYEAR+REPLICATE('0',@NMEMOIDLEN-@NMEMONOLEN-7) +
						 @CPREFIX+REPLICATE('0',@NMEMONOLEN-(LEN(@CPREFIX)+LEN(LTRIM(RTRIM(STR(@NCTR))))))+
						 LTRIM(RTRIM(STR(@NCTR)))

			INSERT #TMPMEMOIDS ( MEMO_ID,XN_TYPE,MEMO_PREFIX ) VALUES ( @CXNID,@CXNTYPE,@CPREFIX )

			SET @NCTR = @NCTR + 1
		END
					
		FETCH NEXT FROM SERIESCUR INTO @CFINYEAR,@CDEPTID,@CPREFIX, @NMIN, @NMAX,@NMEMOCNT
	END
	CLOSE SERIESCUR
	DEALLOCATE SERIESCUR
	
	
	
	PRINT 'CHECK MISSING SERIES-8'+@CXNTYPE
	SET @CCMD=N'SELECT '+(CASE WHEN @CXNTYPE='CHI' THEN 'SUBSTRING(RIGHT(A.MEMO_ID,10),3,2) ' ELSE
				' LEFT(A.MEMO_ID,2) ' END)+' AS DEPT_ID,'''+@CXNTYPE+''' AS XN_TYPE,A.MEMO_ID,GETDATE() AS LAST_UPDATE,
				A.MEMO_PREFIX FROM #TMPMEMOIDS  A LEFT OUTER JOIN '+@CTABLENAME+' B ON A.MEMO_ID=B.'+@CMEMOIDCOL+'
				WHERE B.'+@CMEMOIDCOL+' IS NULL'
	
	PRINT @CCMD
		
	INSERT #TMPMISSINGSERIES (DEPT_ID,XN_TYPE,MEMO_ID,LAST_UPDATE,MEMO_PREFIX)
	EXEC SP_EXECUTESQL @CCMD
	
	--SELECT * FROM #TMPMEMOIDS
	--SELECT * FROM #TMPMEMODET NEW
	
	PRINT 'CHECK MISSING SERIES-9'+@CXNTYPE	
END
--*************** END OF PROCEDURE SP3S_MIRROR_CHKMISSINGSERIES
