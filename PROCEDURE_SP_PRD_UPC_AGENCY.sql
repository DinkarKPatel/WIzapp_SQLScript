CREATE   PROCEDURE SP_PRD_UPC_AGENCY    
(    
 @CORDER_ID VARCHAR(100)='',    
 @CPARA1_CODE VARCHAR(100)='',    
 @JOB_CODE CHAR(10)='',  
 @CWO_ID VARCHAR(100)='',  
 @CPARA2_CODE VARCHAR(10)=''  
)    
AS    
BEGIN    
       DECLARE @NSTK INT  
  IF OBJECT_ID ('TEMPDB..#TMPALLOCATION','U') IS NOT NULL      
    DROP TABLE #TMPALLOCATION      
    
    IF @JOB_CODE IN('1','')
    BEGIN
    SET @JOB_CODE=''
    
    END
          
  SELECT ORDER_ID,WO_ID AS MEMO_ID ,CAST('' AS VARCHAR(100)) AS ARTICLE_CODE,    
  PARA1_CODE,PARA2_CODE,PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE       
  INTO #TMPALLOCATION    
  FROM PRD_UPCPMT WHERE 1=2    
      
  DECLARE @DTSQL NVARCHAR(MAX)    
  SET @DTSQL=N' SELECT B.ORDER_ID,ISNULL(PMT1.WO_ID,ISNULL(A.MEMO_ID,'''')) AS MEMO_ID ,    
  B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,ISNULL(PMT1.PRODUCT_CODE,ISNULL(A.PRODUCT_CODE,'''')) AS PRODUCT_CODE,    
  ISNULL(PMT1.QUANTITY_IN_STOCK,ISNULL(A.QUANTITY_IN_STOCK,0)) AS QUANTITY_IN_STOCK,    
  ISNULL(PMT1.JOB_CODE,ISNULL(A.JOB_CODE,'''')) AS JOB_CODE          
  FROM BUYER_ORDER_DET B       
  JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID       
  LEFT JOIN      
  (      
   SELECT A.ORDER_ID,C.ARTICLE_SET_CODE ,A.MEMO_ID,PMT.PARA1_CODE,PMT.PARA2_CODE,    
   PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE    
   FROM      
  (SELECT DISTINCT * FROM PRD_WO_ORDERS) A           
  JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID             
  JOIN    
  (    
   SELECT WO_ID,PARA1_CODE,PARA2_CODE,PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE    
   FROM PRD_UPCPMT WHERE ISNULL(ORDER_ID,'''')=''''    
  ) PMT ON PMT.WO_ID=C.MEMO_ID       
  WHERE C.CANCELLED=0       
  ) A ON A.ORDER_ID=B.ORDER_ID           
  AND B.PARA1_CODE = A.PARA1_CODE           
  AND B.PARA2_CODE = A.PARA2_CODE           
  AND B.ARTICLE_CODE = A.ARTICLE_SET_CODE     
  LEFT JOIN    
  (    
   SELECT ORDER_ID, WO_ID,PARA1_CODE,PARA2_CODE,PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE    
   FROM PRD_UPCPMT WHERE ISNULL(ORDER_ID,'''')<>''''    
  ) PMT1 ON PMT1.ORDER_ID=M.ORDER_ID       
  AND B.PARA1_CODE=PMT1.PARA1_CODE    
  AND B.PARA2_CODE=PMT1.PARA2_CODE     
  WHERE  M.CANCELLED=0        
  AND M.ORDER_DT>=''2017-01-01''      
     AND B.ORDER_ID= '''+@CORDER_ID+'''        
     AND B.PARA1_CODE= '''+@CPARA1_CODE+'''     
     AND ('''+RTRIM(LTRIM(@JOB_CODE))+'''='''' OR ISNULL(PMT1.JOB_CODE,ISNULL(A.JOB_CODE,''''))= '''+RTRIM(LTRIM(@JOB_CODE))+''')   
     AND ISNULL(PMT1.WO_ID,ISNULL(A.MEMO_ID,''''))= '''+@CWO_ID+'''   
     AND ISNULL(PMT1.PARA2_CODE,ISNULL(A.PARA2_CODE,''''))= '''+@CPARA2_CODE +'''      
     '      
  PRINT @DTSQL      
  INSERT INTO #TMPALLOCATION      
  EXEC SP_EXECUTESQL @DTSQL      
      
      
      
      
 --SELECT * INTO TMPALLOCATION FROM #TMPALLOCATION   
 
  IF @JOB_CODE<>''
  BEGIN  
   
  SELECT MST.REF_AGENCY_CODE AS AGENCY_CODE ,LM.AGENCY_NAME ,    
         MST.MEMO_NO AS ISSUE_NO,CONVERT(VARCHAR,MST.MEMO_DT,105) AS ISSUE_DT,    
         PMT.PRODUCT_CODE,    
         1 AS ISSUE_QTY    
  FROM #TMPALLOCATION TMP    
  JOIN PRD_UPCPMT PMT ON TMP.PRODUCT_CODE=PMT.PRODUCT_CODE    
  JOIN PRD_AGENCY_ISSUE_MATERIAL_UPC ISSUE ON ISSUE.PRODUCT_CODE= PMT.PRODUCT_CODE     
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST MST ON MST.MEMO_ID =ISSUE.MEMO_ID    
  LEFT OUTER JOIN     
  (    
  SELECT DET.ISSUE_ID, A.* FROM PRD_AGENCY_MATERIAL_RECEIPT_UPC  A    
  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST MST ON A.MEMO_ID=MST.MEMO_ID    
  JOIN    
  (    
   SELECT ISSUE.MEMO_ID AS ISSUE_ID, A.MEMO_ID FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A    
   JOIN PRD_AGENCY_ISSUE_MATERIAL_DET ISSUE ON A.REF_ROW_ID=ISSUE.ROW_ID    
   GROUP BY ISSUE.MEMO_ID , A.MEMO_ID    
  ) DET ON MST.MEMO_ID=DET.MEMO_ID    
  WHERE  MST.CANCELLED=0    
  ) REC ON ISSUE.MEMO_ID =REC.ISSUE_ID AND ISSUE.PRODUCT_CODE =REC.PRODUCT_CODE     
  JOIN PRD_AGENCY_MST  LM ON MST.REF_AGENCY_CODE=ISNULL (LM.AGENCY_CODE,AC_CODE)    
  WHERE   MST.CANCELLED =0    
  GROUP BY PMT.PRODUCT_CODE,MST.REF_AGENCY_CODE ,LM.AGENCY_NAME,MST.MEMO_NO ,CONVERT(VARCHAR,MST.MEMO_DT,105)    
  HAVING  SUM(ISSUE.QUANTITY)-SUM(ISNULL(REC.QUANTITY,0))>0    
  ORDER BY MST.MEMO_NO    
  END
  ELSE
  BEGIN
    
     --SELECT MST.REF_AGENCY_CODE AS AGENCY_CODE ,LM.AGENCY_NAME ,    
     --    MST.MEMO_NO AS ISSUE_NO,CONVERT(VARCHAR,MST.MEMO_DT,105) AS ISSUE_DT,    
     --    PMT.PRODUCT_CODE,    
     --    1 AS ISSUE_QTY 
     --FROM #TMPALLOCATION A
     IF OBJECT_ID ('TEMPDB..#TMPLASTISSUE','U') IS NOT NULL
        DROP TABLE #TMPLASTISSUE
        
    ; WITH CTE AS
     (
     SELECT A.MEMO_ID ,A.PRODUCT_CODE ,B.REF_AGENCY_CODE,B.MEMO_NO ,B.MEMO_DT ,
            SR=ROW_NUMBER () OVER (PARTITION BY  A.PRODUCT_CODE ORDER BY B.LAST_UPDATE DESC) 
     FROM PRD_AGENCY_ISSUE_MATERIAL_UPC A
     JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID 
     JOIN #TMPALLOCATION C ON A.PRODUCT_CODE =C .PRODUCT_CODE 
     JOIN PRD_UPCPMT PMT ON PMT.PRODUCT_CODE=C.PRODUCT_CODE
     WHERE B.CANCELLED =0 AND PMT.QUANTITY_IN_STOCK>0
     )
     
     SELECT * INTO #TMPLASTISSUE FROM CTE  WHERE SR=1
     
     
     SELECT A.REF_AGENCY_CODE AS AGENCY_CODE ,LM.AGENCY_NAME  AS AGENCY_NAME ,    
         A.MEMO_NO AS ISSUE_NO,CONVERT(VARCHAR,A.MEMO_DT,105) AS ISSUE_DT,    
         A.PRODUCT_CODE,    
         1 AS ISSUE_QTY  
     FROM #TMPLASTISSUE A
     JOIN PRD_AGENCY_MST LM ON A.REF_AGENCY_CODE =LM.AGENCY_CODE  
   
      
  
  END     
         
END
