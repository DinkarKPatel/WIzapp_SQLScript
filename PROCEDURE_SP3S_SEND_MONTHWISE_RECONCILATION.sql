CREATE  PROCEDURE SP3S_SEND_MONTHWISE_RECONCILATION
(
 @DTODATE DATETIME='',
 @CXNID VARCHAR(20)='',
 @NCUTOFFDAYS INT=0
)
--WITH ENCRYPTION
AS
BEGIN
    DECLARE @CDEPTID VARCHAR(5),@CHODEPTID VARCHAR(2),@DFM_DT VARCHAR(20),@BPURLOC BIT,
            @TABLENAME_PAYMODE VARCHAR(100),@TMPTABLENAME_PAYMODE VARCHAR(100),@CDATASOURCE VARCHAR(100),
            @CERRMSG VARCHAR(MAX),@CSTEP VARCHAR(5),@CSEARCHXNID VARCHAR(20)
             

BEGIN TRY
    
    SET @CSTEP=10
    
	DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),XN_ID VARCHAR(60),XN_TYPE VARCHAR(6),ERRMSG VARCHAR(MAX))
		    
    SET @CSTEP=20
    DECLARE @CTEMPDBNAME VARCHAR(40)
	SET @CTEMPDBNAME = DB_NAME() + '_TEMP.DBO.'		

	SELECT  TOP 1 @CDEPTID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID' 
	SELECT  TOP 1 @CHODEPTID=VALUE  FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'
	
	SET @CSTEP=30
	DECLARE @TABLENAME VARCHAR(100),@TMPTABLENAME VARCHAR(100),@DTSQL NVARCHAR(MAX)
	
	IF @CDEPTID=@CHODEPTID
		GOTO END_PROC
	
	IF @CXNID<>''
		GOTO END_PROC      

    EXEC SP3S_CREATE_MONTHWISE_RECONCILATION
    @DTODATE=@DTODATE,
    @CDEPTID=@CDEPTID,
    @NCUTOFFDAYS=@NCUTOFFDAYS,
    @CERRMSG=@CERRMSG OUTPUT
        
    IF ISNULL(@CERRMSG,'')<>''
		GOTO END_PROC
    
    	
	SELECT TOP 1 @CSEARCHXNID=XN_ID FROM MIRRORLOG WHERE XN_TYPE='MRECON' AND XN_ID=CONVERT(VARCHAR,DATEADD (DAY,-1,@DTODATE),112) AND LAST_UPDATE=''   
    
    IF ISNULL(@CSEARCHXNID,'')=''
    BEGIN
		GOTO END_PROC   
    END
    
	SET @CSTEP=40
	SET @TABLENAME='MONTHLY_RECONCILATION_LOC'
	SET @TABLENAME_PAYMODE='MONTHLY_PAYMODE_DETAILS'
	
	SET @TMPTABLENAME=@CTEMPDBNAME+'TMP_'+@TABLENAME+'_'+@CDEPTID
	SET @TMPTABLENAME_PAYMODE=@CTEMPDBNAME+'TMP_'+@TABLENAME_PAYMODE +'_'+@CDEPTID
	
	SET @CSTEP=50
	SET @DTSQL=N'IF OBJECT_ID('''+@TMPTABLENAME+''',''U'') IS NOT NULL
				   DROP TABLE '+@TMPTABLENAME+'
	             IF OBJECT_ID('''+@TMPTABLENAME_PAYMODE+''',''U'') IS NOT NULL
				   DROP TABLE '+@TMPTABLENAME_PAYMODE+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @CSTEP=60
	
	INSERT INTO @TXNSSENDINFO
	SELECT @TABLENAME,'TMP_'+@TABLENAME+'_'+@CDEPTID,CONVERT(VARCHAR,DATEADD (DAY,-1,@DTODATE),112),'MRECON' ,''
	UNION ALL
	SELECT @TABLENAME_PAYMODE ,'TMP_'+@TABLENAME_PAYMODE +'_'+@CDEPTID,CONVERT(VARCHAR,DATEADD (DAY,-1,@DTODATE),112),'MRECON',''
	
	SET @CSTEP=70
	SET @DTSQL=N'SELECT * INTO '+@TMPTABLENAME+' 
	FROM MONTHLY_RECONCILATION_LOC A' 
	
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @CSTEP=80
	SET @DTSQL=N'SELECT * INTO '+@TMPTABLENAME_PAYMODE+' FROM MONTHLY_PAYMODE_DETAILS'
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	GOTO END_PROC
END TRY

BEGIN CATCH
	
	SET @CERRMSG='PROCEDURE SP3S_SEND_MONTHWISE_RECONCILATION : STEP#'+@CSTEP+' '+ERROR_MESSAGE()
	
	GOTO END_PROC
END CATCH	
	
	
END_PROC:
	
	PRINT 'LAST STEP:'+@CSTEP	
	IF @CXNID=''
	BEGIN
		IF 	ISNULL(@CERRMSG,'')<>''
		BEGIN
			IF EXISTS (SELECT TOP 1 * FROM @TXNSSENDINFO)
				UPDATE @TXNSSENDINFO SET ERRMSG=@CERRMSG
			ELSE
				INSERT 	@TXNSSENDINFO (ERRMSG)
				SELECT @CERRMSG
		END	
		
		SELECT * FROM @TXNSSENDINFO
	END		
	ELSE
	BEGIN
		UPDATE MIRRORLOG WITH (ROWLOCK) SET LAST_UPDATE=GETDATE() WHERE XN_TYPE='MRECON' AND XN_ID=@CXNID
		SELECT ISNULL(@CERRMSG,'') AS ERRMSG	
	END	
END
