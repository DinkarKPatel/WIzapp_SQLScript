CREATE PROCEDURE SP3S_B2B_GSTR--(LocId 3 digit change by Sanjay:04-11-2024)
(
  @DFMDATE DATETIME='',
  @DTODATE DATETIME='',
  @CGSTN_NO VARCHAR(100)='',
  @CLOC_TYPE INT=0,--0 FOR ALL 1 FOR ONLY COMPANY OWNED,
  @CDEPT_ID VARCHAR(4)='',
  @BCALLEDFORGSTR9 BIT=0
  
)
AS
BEGIN
      
	  IF OBJECT_ID ('TEMPDB..#TMP_DO_NOT_CONSIDER_FOR_GSTRREPS','U') is  null
	 SELECT A.user_code INTO #TMP_DO_NOT_CONSIDER_FOR_GSTRREPS FROM USERS A
	 WHERE ISNULL(DO_NOT_CONSIDER_FOR_GSTRREPS,0)=1
     
      DECLARE @TBLB2BMEMO TABLE (MEMO_ID VARCHAR(100),XN_TYPE VARCHAR(20),GSTIN_UIN_RECIPIENT VARCHAR(100),PLACE_OF_SUPPLY VARCHAR(100),RECEIVER_NAME VARCHAR(200))
     
      INSERT INTO @TBLB2BMEMO(MEMO_ID,XN_TYPE,GSTIN_UIN_RECIPIENT,PLACE_OF_SUPPLY,RECEIVER_NAME)
      SELECT A.INV_ID ,
             'PARTY INVOICE' AS XN_TYPE,
             LMP.AC_GST_NO  AS GSTIN_UIN_RECIPIENT,
             C.GST_STATE_CODE+'-'+C.GST_STATE_NAME  AS PLACE_OF_SUPPLY,
             LM.AC_NAME AS RECEIVER_NAME 
      FROM INM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.LOCATION_CODE
      JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      JOIN GST_STATE_MST C (NOLOCK)  ON A.PARTY_STATE_CODE  =C.GST_STATE_CODE
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      and ISNULL(LMP.AC_GST_NO,'')<>''
      and ISNULL(LMP.AC_GST_NO,'')<>ISNULL(B.LOC_GST_NO ,'')
      AND (@CDEPT_ID='' OR A.LOCATION_CODE=@CDEPT_ID) 
      AND A.XN_ITEM_TYPE <>5
      AND A.INV_MODE =1
	  AND A.SUPPLY_TYPE_CODE NOT IN('EXPWP','EXPWOP')
	  
	  INSERT INTO @TBLB2BMEMO(MEMO_ID,XN_TYPE,GSTIN_UIN_RECIPIENT,PLACE_OF_SUPPLY,RECEIVER_NAME)
	  select  a.INV_ID ,
	          'GROUP INVOICE' XN_TYPE,
	           TL.LOC_GST_NO GSTIN_UIN_RECIPIENT,
	           C.GST_STATE_CODE+'-'+C.GST_STATE_NAME AS PLACE_OF_SUPPLY,
	           TL.DEPT_NAME RECEIVER_NAME
	  FROM INM01106  A (NOLOCK)
	  JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.LOCATION_CODE
      JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      JOIN GST_STATE_MST C (NOLOCK)  ON A.PARTY_STATE_CODE  =C.GST_STATE_CODE
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND ISNULL(TL.LOC_GST_NO,'')<>''
      AND ISNULL(TL.LOC_GST_NO,'')<>ISNULL(B.LOC_GST_NO ,'')
      AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID) 
      and a.XN_ITEM_TYPE <>5
      AND A.INV_MODE <>1
	  and a.SUPPLY_TYPE_CODE not in('EXPWP','EXPWOP')
	   
        
     
	    DECLARE @TBLB2B TABLE (MEMO_ID VARCHAR(100),SR INT, RTYPE VARCHAR(10), XN_TYPE VARCHAR(20),GSTIN_UIN_RECIPIENT VARCHAR(100),INVOICE_NO VARCHAR(50),INVOICE_DT VARCHAR(15),
                            INVOICE_VALUE NUMERIC(12,2),PLACE_OF_SUPPLY VARCHAR(100),REVERSE_CHARGE CHAR(1),INVOICE_TYPE VARCHAR(50),
                            E_COMMERCE_GSTIN VARCHAR(100),RATE NUMERIC(8,2),TAXABLE_VALUE NUMERIC(12,2),CESS_AMOUNT NUMERIC(8,2),RECEIVER_NAME VARCHAR(200),
							CGST_AMOUNT NUMERIC(12,2),SGST_AMOUNT NUMERIC(12,2),IGST_AMOUNT NUMERIC(12,2) )
                            
  
      --WSL INVOICE
      
      --**** STATR B2B----(WSL INVOICE)
     INSERT INTO @TBLB2B(MEMO_ID,SR ,RTYPE,XN_TYPE ,GSTIN_UIN_RECIPIENT ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                  REVERSE_CHARGE,INVOICE_TYPE , E_COMMERCE_GSTIN ,RATE ,TAXABLE_VALUE ,CESS_AMOUNT,RECEIVER_NAME,
				  CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT)
     SELECT A.INV_ID,SR=CAST(2 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            b.XN_TYPE  AS XN_TYPE,
            b.GSTIN_UIN_RECIPIENT  AS GSTIN_UIN_RECIPIENT,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('Regular B2B' AS VARCHAR(50)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            A.OTHER_CHARGES_GST_PERCENTAGE AS RATE,
            A.OTHER_CHARGES_TAXABLE_VALUE  AS TAXABLE_VALUE,
            0 AS CESS_AMOUNT ,
            b.RECEIVER_NAME AS RECEIVER_NAME  ,
			A.OTHER_CHARGES_CGST_AMOUNT,A.OTHER_CHARGES_SGST_AMOUNT,A.OTHER_CHARGES_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN @TBLB2BMEMO B  ON a.inv_id  =b.memo_id 
      WHERE  ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
      
      
       INSERT INTO @TBLB2B(MEMO_ID,SR ,RTYPE,XN_TYPE ,GSTIN_UIN_RECIPIENT ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                  REVERSE_CHARGE,INVOICE_TYPE , E_COMMERCE_GSTIN ,RATE ,TAXABLE_VALUE ,CESS_AMOUNT,RECEIVER_NAME,
				  CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT)
				  
      SELECT A.INV_ID,SR=CAST(2 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            b.XN_TYPE,
            b.GSTIN_UIN_RECIPIENT,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,--(CONFUSION)
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('Regular B2B' AS VARCHAR(50)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            A.FREIGHT_GST_PERCENTAGE AS RATE,
            A.FREIGHT_TAXABLE_VALUE  AS TAXABLE_VALUE,
            0 AS CESS_AMOUNT,
            b.RECEIVER_NAME   ,
			A.FREIGHT_CGST_AMOUNT,A.FREIGHT_SGST_AMOUNT,A.FREIGHT_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN @TBLB2BMEMO B  ON a.inv_id  =b.memo_id 
      WHERE  ISNULL(A.FREIGHT_GST_PERCENTAGE,0)>0
 
      
      INSERT INTO @TBLB2B(MEMO_ID,SR ,RTYPE,XN_TYPE ,GSTIN_UIN_RECIPIENT ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                  REVERSE_CHARGE,INVOICE_TYPE , E_COMMERCE_GSTIN ,RATE ,TAXABLE_VALUE ,CESS_AMOUNT,RECEIVER_NAME,
				  CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT)
      
       SELECT A.INV_ID,SR=CAST(2 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            b.XN_TYPE,
            b.GSTIN_UIN_RECIPIENT,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,--(CONFUSION)
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('Regular B2B' AS VARCHAR(50)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            A.INSURANCE_GST_PERCENTAGE AS RATE,
            A.INSURANCE_TAXABLE_VALUE  AS TAXABLE_VALUE,
            0 AS CESS_AMOUNT ,
            b.RECEIVER_NAME  ,
			A.INSURANCE_CGST_AMOUNT,A.INSURANCE_SGST_AMOUNT,A.INSURANCE_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN @TBLB2BMEMO B  ON a.inv_id  =b.memo_id 
      WHERE  ISNULL(A.INSURANCE_GST_PERCENTAGE,0)>0
     
      
      INSERT INTO @TBLB2B(MEMO_ID,SR ,RTYPE,XN_TYPE ,GSTIN_UIN_RECIPIENT ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                  REVERSE_CHARGE,INVOICE_TYPE , E_COMMERCE_GSTIN ,RATE ,TAXABLE_VALUE ,CESS_AMOUNT,RECEIVER_NAME,
				  CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT)
      
        SELECT A.INV_ID,SR=CAST(2 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            b.XN_TYPE,
            b.GSTIN_UIN_RECIPIENT,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,--(CONFUSION)
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('Regular B2B' AS VARCHAR(50)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            A.PACKING_GST_PERCENTAGE AS RATE,
            A.PACKING_TAXABLE_VALUE  AS TAXABLE_VALUE,
            0 AS CESS_AMOUNT  ,
            b.RECEIVER_NAME ,
			A.PACKING_CGST_AMOUNT,A.PACKING_SGST_AMOUNT,A.PACKING_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN @TBLB2BMEMO B  ON a.inv_id  =b.memo_id 
      WHERE  ISNULL(A.PACKING_GST_PERCENTAGE,0)>0
      
	   
      INSERT INTO @TBLB2B(MEMO_ID,SR ,RTYPE,XN_TYPE ,GSTIN_UIN_RECIPIENT ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                  REVERSE_CHARGE,INVOICE_TYPE , E_COMMERCE_GSTIN ,RATE ,TAXABLE_VALUE ,CESS_AMOUNT,RECEIVER_NAME,
				  CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT)
     SELECT A.INV_ID,SR=CAST(2 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            b.XN_TYPE,
            b.GSTIN_UIN_RECIPIENT,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,--(CONFUSION)
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('Regular B2B' AS VARCHAR(50)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            IND.GST_PERCENTAGE  AS RATE,
            ISNULL(IND.XN_VALUE_WITHOUT_GST,0) AS TAXABLE_VALUE,
            IND.Gst_cess_amount  AS CESS_AMOUNT,
            b.RECEIVER_NAME   ,
			IND.CGST_AMOUNT,IND.SGST_AMOUNT,IND.IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN @TBLB2BMEMO B  ON a.inv_id  =b.memo_id 
      JOIN IND01106 IND (nolock) ON A.INV_ID =IND.INV_ID 
     
    DECLARE @TBLB2BCMM TABLE (MEMO_ID VARCHAR(100),XN_TYPE VARCHAR(20),GSTIN_UIN_RECIPIENT VARCHAR(100),PLACE_OF_SUPPLY VARCHAR(100),RECEIVER_NAME VARCHAR(200))

	 INSERT INTO @TBLB2BCMM(MEMO_ID,XN_TYPE,GSTIN_UIN_RECIPIENT,PLACE_OF_SUPPLY,RECEIVER_NAME)
	   SELECT A.CM_ID,'SLS' AS XN_TYPE,
            A.Party_Gst_No AS GSTIN_UIN_RECIPIENT,         
            CS.GST_STATE_CODE+'-'+Cs.GST_STATE_NAME  AS PLACE_OF_SUPPLY,
            ISNULL(CUST.CUSTOMER_FNAME ,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS RECEIVER_NAME
     FROM CMM01106 A (NOLOCK)
     JOIN CUSTDYM CUST (NOLOCK) ON A.CUSTOMER_CODE =CUST.CUSTOMER_CODE
     JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code 
     LEFT JOIN GST_STATE_MST CS (NOLOCK)  ON CS.GST_STATE_CODE =A.PARTY_STATE_CODE 
	 LEFT JOIN #TMP_DO_NOT_CONSIDER_FOR_GSTRREPS U ON A.USER_CODE =U.user_code 
     WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
     AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
     AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
     AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
	 AND ISNULL(A.Party_Gst_No,'')<>''
	 AND A.NET_AMOUNT>0
	 AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID)
	 AND U.user_code IS NULL
	 AND A.SUPPLY_TYPE_CODE NOT IN('EXPWP','EXPWOP')
     
       --**** STATR B2B----(RETAIL SALE)
      INSERT INTO @TBLB2B(MEMO_ID,SR ,RTYPE,XN_TYPE ,GSTIN_UIN_RECIPIENT ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                  REVERSE_CHARGE,INVOICE_TYPE , E_COMMERCE_GSTIN ,RATE ,TAXABLE_VALUE ,CESS_AMOUNT,RECEIVER_NAME ,
				   CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT)
        SELECT A.CM_ID,
            SR=CAST(1 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            'SLS' AS XN_TYPE,
            A.Party_Gst_No AS GSTIN_UIN_RECIPIENT,
            CAST(A.CM_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.CM_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            B.PLACE_OF_SUPPLY,
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('Regular B2B' AS VARCHAR(50)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            A.OTHER_CHARGES_GST_PERCENTAGE AS RATE,
            ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE  ,0) AS TAXABLE_VALUE,
            0 AS CESS_AMOUNT,
            B.RECEIVER_NAME,
			A.OTHER_CHARGES_CGST_AMOUNT,A.OTHER_CHARGES_SGST_AMOUNT,A.OTHER_CHARGES_IGST_AMOUNT
     FROM CMM01106 A (NOLOCK)
     JOIN @TBLB2BCMM  B ON A.cm_id =B.MEMO_ID 
	 WHERE  ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
	
	
	 INSERT INTO @TBLB2B(MEMO_ID,SR ,RTYPE,XN_TYPE ,GSTIN_UIN_RECIPIENT ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                  REVERSE_CHARGE,INVOICE_TYPE , E_COMMERCE_GSTIN ,RATE ,TAXABLE_VALUE ,CESS_AMOUNT,RECEIVER_NAME,
				  CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT)
     SELECT A.CM_ID,
            SR=CAST(1 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            'SLS' AS XN_TYPE,
            A.Party_Gst_No AS GSTIN_UIN_RECIPIENT,
            CAST(A.CM_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.CM_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            B.PLACE_OF_SUPPLY,
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('Regular B2B' AS VARCHAR(50)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            CMD.gst_percentage  AS RATE,
            ISNULL(CMD.XN_VALUE_WITHOUT_GST,0) AS TAXABLE_VALUE,
            CMD.Gst_cess_amount  AS CESS_AMOUNT ,
            B.RECEIVER_NAME,
			CMD.CGST_AMOUNT,CMD.SGST_AMOUNT,CMD.IGST_AMOUNT
     FROM CMM01106 A (NOLOCK)
     JOIN @TBLB2BCMM  B ON A.cm_id =B.MEMO_ID  
     JOIN CMD01106 CMD (NOLOCK) ON A.CM_ID =CMD.CM_ID 
    
	 

	 IF @BCALLEDFORGSTR9=1
	 BEGIN
	     IF OBJECT_ID ('TEMPDB..##B2B','U') IS NOT NULL 
		 DROP TABLE ##B2B

		 SELECT * INTO ##B2B FROM @TBLB2B
		 RETURN
	 END
	 
	 

	   DECLARE @CEINVOICE_PREFIX VARCHAR(10)
	   select @CEINVOICE_PREFIX=value  from CONFIG where config_option ='EINVOICE_PREFIX'
	   set @CEINVOICE_PREFIX=ISNULL(@CEINVOICE_PREFIX,'')


      SELECT RTYPE,GSTIN_UIN_RECIPIENT AS [GSTIN/UIN OF RECIPIENT],
             RECEIVER_NAME AS [RECEIVER NAME],
             CASE WHEN (@CEINVOICE_PREFIX<>'' AND LEFT(RTRIM(LTRIM(A.INVOICE_NO)),1)='0' and CAST( INVOICE_DT  AS DATETIME) >=  isnull(EINVOICE_CUTOFF_DATE,'') ) THEN @CEINVOICE_PREFIX ELSE '' END+INVOICE_NO AS [INVOICE NUMBER],
             INVOICE_DT AS [INVOICE DATE],
             INVOICE_VALUE AS [INVOICE VALUE] ,
             PLACE_OF_SUPPLY AS [PLACE OF SUPPLY],
             REVERSE_CHARGE AS [REVERSE CHARGE],
             CAST('' AS VARCHAR(100)) as [Applicable % of Tax Rate],
             INVOICE_TYPE AS [INVOICE TYPE] , 
             E_COMMERCE_GSTIN AS [E-COMMERCE GSTIN],
             RATE AS RATE,
             SUM(TAXABLE_VALUE) AS [TAXABLE VALUE] ,
             SUM(CESS_AMOUNT) AS [CESS AMOUNT]
      FROM @TBLB2B A
	  LEFT JOIN LOCATION L (NOLOCK) ON L.DEPT_ID =LEFT (A.INVOICE_NO,2)
      GROUP BY RTYPE,GSTIN_UIN_RECIPIENT ,
      CASE WHEN (@CEINVOICE_PREFIX<>'' AND LEFT(RTRIM(LTRIM(A.INVOICE_NO)),1)='0' and CAST( INVOICE_DT  AS DATETIME) >= isnull(EINVOICE_CUTOFF_DATE,'')) THEN @CEINVOICE_PREFIX ELSE '' END+INVOICE_NO,
	  INVOICE_DT ,RECEIVER_NAME,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
      REVERSE_CHARGE ,INVOICE_TYPE  , E_COMMERCE_GSTIN ,RATE 
      ORDER BY INVOICE_DT,CASE WHEN (@CEINVOICE_PREFIX<>'' AND LEFT(RTRIM(LTRIM(A.INVOICE_NO)),1)='0' and CAST( INVOICE_DT  AS DATETIME) >=  isnull(EINVOICE_CUTOFF_DATE,'')) THEN @CEINVOICE_PREFIX ELSE '' END+INVOICE_NO

	  --DROP TABLE TBLB2B
	  --SELECT * INTO TBLB2B FROM @TBLB2B
             
      SELECT 'B2B' AS RTYPE,
             0 AS [NO. OF RECIPIENTS],
             0 AS [NO. OF INVOICES],
             0 AS [TOTAL INVOICE VALUE] ,
             0 AS [TOTAL TAXABLE VALUE] ,
             0 AS [TOTAL CESS] 
     --**** END B2B----(WSL INVOICE)
    --UNREGINTRED DELER  CNDN MORE THEN 2.5L
          
END

