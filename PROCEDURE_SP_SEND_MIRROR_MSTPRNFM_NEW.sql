create PROCEDURE DBO.SP_SEND_MIRROR_MSTPRNFM_NEW
(
 @CTARGETLOCID VARCHAR(5)
)
AS
 BEGIN
   DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION NVARCHAR(MAX)
           ,@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPLMTABLE VARCHAR(100)
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CCURDEPTID VARCHAR(5)
           ,@CHODEPTID VARCHAR(5),@CERRORMSG VARCHAR(MAX),@CREPLOCTABLE VARCHAR(500),@NLOCTYPE INT
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(2),@JOINMASTERTABLE VARCHAR(200),@JOINTEMPTABLE VARCHAR(200)

    DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),ERRMSG VARCHAR(MAX)) 
    
    BEGIN TRY
    
	SET @CSTEP=0

	SET @CTEMPDBNAME = ''
	
	SET @CSTEP=10
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	SET @CFILTERCONDITION=''
	 
	SET @CSTEP=20

	SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
	
	SELECT @NLOCTYPE=LOC_TYPE FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	
	IF @CCURDEPTID<>@CHODEPTID
	BEGIN
		SELECT '' AS LAST_UPDATE,'' AS ERRMSG
		
		GOTO END_PROC
	END		
    SET @CSTEP=30
	
	
	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=40
    ---SELECT DATA FROM LOC_BILLING_RULES TABLE

	IF OBJECT_ID ('TEMPDB..#TMPPRINTID','U') IS NOT NULL
	   DROP TABLE #TMPPRINTID

	 
	SELECT DISTINCT  PRINTMASTER.PRINTID INTO #TMPPRINTID FROM PRINTMASTER (NOLOCK)
	JOIN PRINTLOCATION B (NOLOCK) ON PRINTMASTER.PRINTID=B.PRINTID	
	 WHERE LEFT(PRINTMASTER.PRINTID,2)=@CCURDEPTID AND B.DEPTID=@CTARGETLOCID



	 SELECT DISTINCT  'MSTPRNFM_reports_opt_locs_MIRROR' AS TARGET_TABLENAME,reports_opt_locs.*,1 AS PICK_FROM_CURRENT_DB FROM reports_opt_locs (NOLOCK)
	 where Dept_id =@CTARGETLOCID

	SELECT DISTINCT  'MSTPRNFM_reports_opt_MIRROR' AS TARGET_TABLENAME,reports_opt.*,1 AS PICK_FROM_CURRENT_DB FROM reports_opt  (nolock)
	join reports_opt_locs (NOLOCK) on reports_opt.row_id =reports_opt_locs.Format_row_id
	where reports_opt_locs.Dept_id =@CTARGETLOCID

	 SET @CTABLENAME = 'PRINTMASTER'

    SELECT DISTINCT  'MSTPRNFM_PRINTMASTER_MIRROR' AS TARGET_TABLENAME,PRINTMASTER.*,1 AS PICK_FROM_CURRENT_DB FROM PRINTMASTER (NOLOCK)
	JOIN #TMPPRINTID B (NOLOCK) ON PRINTMASTER.PRINTID=B.PRINTID	
	

	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=50
    ---SELECT DATA FROM LOC_BILLING_RULES TABLE
	SET @CTABLENAME = 'REPORTS'

	 SELECT DISTINCT  'MSTPRNFM_REPORTS_MIRROR' AS TARGET_TABLENAME,REPORTS.*,1 AS PICK_FROM_CURRENT_DB FROM REPORTS (NOLOCK)
	 WHERE UDRF=1

     
    --INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=60
    ---SELECT DATA FROM LOC_BILLING_RULES TABLE
	SET @CTABLENAME = 'PRINTDETAIL'

	SELECT DISTINCT  'MSTPRNFM_PRINTDETAIL_MIRROR' AS TARGET_TABLENAME,PRINTDETAIL.*,1 AS PICK_FROM_CURRENT_DB FROM PRINTDETAIL (NOLOCK)
	JOIN #TMPPRINTID B (NOLOCK) ON PRINTDETAIL.PRINTID=B.PRINTID	

	
      
    --INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=70
    ---SELECT DATA FROM LOC_BILLING_RULES TABLE
	SET @CTABLENAME = 'PRINTDESCRIPTION'
    
	SELECT DISTINCT  'MSTPRNFM_PRINTDESCRIPTION_MIRROR' AS TARGET_TABLENAME,PRINTDESCRIPTION.*,1 AS PICK_FROM_CURRENT_DB FROM PRINTDESCRIPTION (NOLOCK)
	JOIN #TMPPRINTID B (NOLOCK) ON PRINTDESCRIPTION.PRINTID=B.PRINTID	

     
       
    --INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=80
    ---SELECT DATA FROM LOC_BILLING_RULES TABLE
	SET @CTABLENAME = 'PRINTHEADER'
	SELECT DISTINCT  'MSTPRNFM_PRINTHEADER_MIRROR' AS TARGET_TABLENAME,PRINTHEADER.*,1 AS PICK_FROM_CURRENT_DB FROM PRINTHEADER (NOLOCK)
	JOIN #TMPPRINTID B (NOLOCK) ON PRINTHEADER.PRINTID=B.PRINTID	


    
     --INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=90
    ---SELECT DATA FROM LOC_BILLING_RULES TABLE
	SET @CTABLENAME = 'PRINTLOCATION'
	SELECT DISTINCT  'MSTPRNFM_PRINTLOCATION_MIRROR' AS TARGET_TABLENAME,PRINTLOCATION.*,1 AS PICK_FROM_CURRENT_DB FROM PRINTLOCATION (NOLOCK)
	JOIN #TMPPRINTID B (NOLOCK) ON PRINTLOCATION.PRINTID=B.PRINTID	
	


	END TRY
	
	BEGIN CATCH
	    SET @CERRORMSG='P: SP_SEND_MIRROR_MSTPRNFM_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()+ 'ERROR QUERY || '+@DTSQL
	    GOTO END_PROC
    END CATCH 
    
    END_PROC:
    
    SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
 END
