CREATE PROCEDURE SP_EMPPAYSLIPINFO       
(      
	@CEMPID CHAR(7),      
	@NMONTH INT,      
	@NYEAR INT      
)      
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @DSTARTTIME DATETIME
	
	SET @DSTARTTIME=GETDATE()

	-- MASTER INFORMATION       
	SELECT  A.REF_ID, A.EMP_TITLE + ' ' + A.EMP_FNAME + ' ' + A.EMP_LNAME AS 'EMP_NAME', A.BASIC_SALARY,       
			B.DESIG_NAME, C.DEPARTMENT_NAME, A.PAN_NO, D.SHIFT_NAME,  A.WEEKLY_OFF1, A.WEEKLY_OFF2       
	FROM EMP_MST A       
	JOIN EMP_DESIG B ON A.DESIG_ID = B.DESIG_ID      
	JOIN EMP_DEPARTMENT C ON A.DEPARTMENT_ID = C.DEPARTMENT_ID      
	JOIN EMP_SHIFTS D ON A.SHIFT_ID = D.SHIFT_ID      
	--- JOIN (SELECT DISTINCT EMP_ID FROM EMP_SALARY_PROFILE )E ON E.EMP_ID=A.EMP_ID  
	WHERE A.EMP_ID =@CEMPID AND A.EMP_STATUS = 0      

	-- SALARY PROFILE DETAIL      
	SELECT  A.*,B.PAY_NAME, 0 AS ORG_AMOUNT,                
			CASE       
			WHEN B.PAY_TYPE = 1 THEN 'DEDUCTION'       
			WHEN B.PAY_TYPE = 2 THEN 'ADDITION'      
			END AS PAY_TYPE       
	FROM EMP_SALARY_PROFILE A       
	JOIN EMP_PAY B (NOLOCK) ON A.PAY_ID = B.PAY_ID      
	JOIN EMP_MST C (NOLOCK) ON A.EMP_ID = C.EMP_ID    
	WHERE C.EMP_ID = @CEMPID      
	ORDER BY ALIAS      

	-- ATTENDANCE DETAIL      
	SELECT A.ATTENDANCE_DT, A.TIME_IN, A.TIME_OUT, D.SHIFT_NAME, D.SHIFT_TIME_IN, D.SHIFT_TIME_OUT, D.HALFDAY_CUTOFF      
	FROM EMP_ATTENDANCE A       
	JOIN EMP_SHIFTS D ON A.SHIFT_ID = D.SHIFT_ID      
	WHERE A.EMP_ID = @CEMPID AND MONTH(A.ATTENDANCE_DT) = @NMONTH AND YEAR(A.ATTENDANCE_DT) = @NYEAR      
	AND (A.TIME_IN <> '1900-01-01 00:00:00.000' OR A.TIME_OUT <> '1900-01-01 00:00:00.000')      
	ORDER BY A.ATTENDANCE_DT, A.TIME_IN      

	-- LEAVE DETAIL      
	SELECT A.DATE_FROM, A.DATE_TO, A.NO_OF_LEAVES, A.LEAVES_APPROVED, B.LEAVE_NAME, B.NO_OF_LEAVES AS 'APPLIED_LEAVES'      
	FROM EMP_LEAVE_DETAILS A       
	JOIN EMP_LEAVE_MASTER B ON A.LEAVE_CODE = B.LEAVE_CODE      
	WHERE EMP_ID = @CEMPID AND A.APPROVED = 1      

	-- LOAN DETAIL      
	SELECT  A.LOAN_ID, A.TENURE, A.LOAN_AMOUNT, A.INTEREST_RATE, A.LOAN_TYPE, A.EMI_AMOUNT,       
			A.SETTLEMENT_TYPE, A.APPROVED_AMOUNT FROM EMP_LOAN_MST A      
	WHERE A.EMP_ID = @CEMPID AND A.LOAN_STATUS = 1 AND A.SETTLED = 0      

    
	INSERT WIZPAY_LOG	( SP_NAME, START_TIME, END_TIME )  
	SELECT 	 'SP_EMPPAYSLIPINFO:'+@CEMPID+'-'+STR(@NMONTH)+'-'+STR(@NYEAR) AS SP_NAME,@DSTARTTIME AS START_TIME,GETDATE() AS  END_TIME 

END
