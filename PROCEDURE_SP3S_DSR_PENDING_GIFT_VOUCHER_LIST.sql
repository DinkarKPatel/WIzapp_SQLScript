CREATE PROCEDURE SP3S_DSR_PENDING_GIFT_VOUCHER_LIST--(LocId 3 digit change by Sanjay:05-11-2024)
(
  @DFM_DT DATETIME,
  @DTO_DT DATETIME,
  @CDEPT_ID VARCHAR(4)=''
)
AS
BEGIN
     
      DECLARE @CHO_DEPT_ID VARCHAR(5)

	  IF @CDEPT_ID=''
      SELECT TOP 1 @CDEPT_ID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 

      SELECT TOP 1 @CHO_DEPT_ID=VALUE  FROM CONFIG  WHERE CONFIG_OPTION ='HO_LOCATION_ID'
      IF @CDEPT_ID=@CHO_DEPT_ID
      SET @CDEPT_ID=''
 
    ----PENDINF SALE GIFT VOUCHER-------
      SELECT ARC.location_Code AS LOC_ID,DEPT_NAME AS LOC_NAME,
              A.GV_SRNO AS GV_NO,A.QUANTITY,
			   (case when B.DENOMINATION <=0 then A. DENOMINATION ELSE B.DENOMINATION END )AS DENOMINATION,

              ADV_REC_NO AS SALE_RECEIPT_NO,CONVERT(VARCHAR(10),ADV_REC_DT,105) AS SALE_DATE,
              CUSTOMER_NAME=CASE WHEN ISNULL(C.MOBILE,'')<> '' THEN ISNULL(C.MOBILE,'')+', ' ELSE '' END + 
              ISNULL(C.CUSTOMER_FNAME,'') +' '+ISNULL(CUSTOMER_LNAME,'') ,
              CONVERT(VARCHAR,B.DT_EXPIRY,105) AS EXPIRY_DT,
              DAYS_TO_EXPIRY=DATEDIFF (DD,@DTO_DT,B.DT_EXPIRY)
       FROM ARC_GVSALE_DETAILS A (NOLOCK)
	   JOIN SKU_GV_MST B (NOLOCK) ON B.GV_SRNO=A.GV_SRNO
	   JOIN ARC01106 ARC (NOLOCK) ON ARC.ADV_REC_ID=A.ADV_REC_ID     
	   JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=ARC.location_Code
	   JOIN CUSTDYM C (NOLOCK) ON C.CUSTOMER_CODE=ARC.CUSTOMER_CODE
	   LEFT JOIN
	   (
	       SELECT  B.ADJ_MEMO_ID, C.CM_DT AS BILL_DT ,GV_SRNO 
	       FROM  PAYMODE_XN_DET B (NOLOCK) 
		   JOIN CMM01106 C ON C.CM_ID=B.MEMO_ID
	       WHERE C.CANCELLED =0 AND  B.XN_TYPE='SLS' AND PAYMODE_CODE='GVC0001'
	       GROUP BY B.ADJ_MEMO_ID, C.CM_DT ,GV_SRNO
	   ) P ON  P.GV_SRNO =A.GV_SRNO  
	   WHERE ISNULL(ARC.CANCELLED,0)=0 
	   AND P.BILL_DT IS NULL 
	   AND( B.DT_EXPIRY>=@DTO_DT or  B.DT_EXPIRY='')
	   AND B.DT_CREATED BETWEEN @DFM_DT AND @DTO_DT
      UNION ALL
      SELECT  TARGET_DEPT_ID  AS LOC_ID,DEPT_NAME AS LOC_NAME,
              B.GV_SRNO AS GV_NO,B.QUANTITY,C.DENOMINATION,
              MEMO_NO AS SALE_RECEIPT_NO,CONVERT(VARCHAR(10),MEMO_DT,105) AS SALE_DATE,
              CUSTOMER_NAME='' ,
              CONVERT(VARCHAR,C.DT_EXPIRY,105) AS EXPIRY_DT,
              DAYS_TO_EXPIRY=DATEDIFF (DD,@DTO_DT,C.DT_EXPIRY)
      FROM GV_STKXFER_MST A (NOLOCK)
      JOIN GV_STKXFER_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID
      JOIN SKU_GV_MST C (NOLOCK) ON B.GV_SRNO=C.GV_SRNO
      JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=A.TARGET_DEPT_ID
      LEFT JOIN
	 (
	  SELECT  B.ADJ_MEMO_ID, C.CM_DT AS BILL_DT ,GV_SRNO 
	  FROM  PAYMODE_XN_DET B (NOLOCK) 
	  JOIN CMM01106 C ON C.CM_ID=B.MEMO_ID
	  WHERE C.CANCELLED =0 AND  B.XN_TYPE='SLS' AND PAYMODE_CODE='GVC0001'
	  GROUP BY B.ADJ_MEMO_ID, C.CM_DT ,GV_SRNO
	 ) P ON  P.GV_SRNO =B.GV_SRNO  
      WHERE A.CANCELLED=0 
      AND (@CDEPT_ID='' OR TARGET_DEPT_ID =@CDEPT_ID)
      AND ( C.DT_EXPIRY>=@DTO_DT or  c.DT_EXPIRY='')
	  AND A.MEMO_DT BETWEEN @DFM_DT AND @DTO_DT
	  AND P.BILL_DT IS NULL 
END
-- END OF PROCEDURE SP3S_DSR_PENDING_GIFT_VOUCHER_LIST
