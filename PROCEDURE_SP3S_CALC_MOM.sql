CREATE PROCEDURE SP3S_CALC_MOM
(
	 @CPROCESS_ID VARCHAR(50)
	,@CXN_TYPE VARCHAR(10)='EXP_ANLS'
	,@CERRMSG VARCHAR(500) OUTPUT
)	
--WITH ENCRYPTION
AS
BEGIN

	DECLARE @CALERT VARCHAR(500),@CSTEP VARCHAR(5),@BXNS_EXISTS BIT,@BDEPT_EXISTS BIT,@BAC_EXISTS BIT
	,@BMONTH_EXISTS BIT,@CDEPT_ID VARCHAR(5),@CAC_CODE VARCHAR(15),@NMONTH NUMERIC(2)	

BEGIN TRY
	SET @CSTEP=10
	IF ISNULL(@CPROCESS_ID,'')=''
	BEGIN
		SET @CERRMSG='P:SP3S_CALC_MOM,STEP:'+@CSTEP+',MESSAGE: PROCESS ID CANNOT BE BLANK....'
		GOTO EXIT_PROC
	END
	
	SET @CSTEP=20
	IF @CXN_TYPE='EXP_ANLS'
		GOTO LBL_EXP_MTH
	ELSE GOTO EXIT_PROC	
	
LBL_EXP_MTH:	
	SET @CSTEP=30
	IF OBJECT_ID('TEMPDB..#XNS','U') IS NOT NULL
		DROP TABLE #XNS
	SET @CSTEP=40
	SELECT DISTINCT XN_TYPE INTO #XNS FROM EXP_ANLS_DET WHERE PROCESS_ID=@CPROCESS_ID 	
	IF @@ROWCOUNT>0
		SET @BXNS_EXISTS=1
	
	---OUTER CURSOR (XNS)
	WHILE @BXNS_EXISTS=1
	BEGIN
		SELECT TOP 1 @CXN_TYPE=XN_TYPE FROM #XNS
		IF OBJECT_ID('TEMPDB..#DEPTS','U') IS NOT NULL
			DROP TABLE #DEPTS
		
		SELECT DISTINCT DEPT_ID INTO #DEPTS FROM EXP_ANLS_DET WHERE PROCESS_ID=@CPROCESS_ID
		IF @@ROWCOUNT>0
			SET @BDEPT_EXISTS=1
		---INNER CURSOR 1(DEPTS)	
		WHILE @BDEPT_EXISTS=1
		BEGIN
			SELECT TOP 1 @CDEPT_ID=DEPT_ID FROM #DEPTS
			
			IF OBJECT_ID('TEMPDB..#LMS','U') IS NOT NULL
				DROP TABLE #LMS
			
			SELECT DISTINCT EXP_CODE AS AC_CODE INTO #LMS FROM EXP_ANLS_DET WHERE PROCESS_ID=@CPROCESS_ID AND XN_TYPE=@CXN_TYPE AND DEPT_ID=@CDEPT_ID	
			IF @@ROWCOUNT>0
				SET @BAC_EXISTS=1
				----INNER CURSOR 2(LEDGERS)
				WHILE @BAC_EXISTS=1
				BEGIN
					SELECT TOP 1 @CAC_CODE=AC_CODE FROM #LMS
					
					IF OBJECT_ID('TEMPDB..#MONTHS','U') IS NOT NULL
						DROP TABLE #MONTHS
					
					SELECT DISTINCT MONTH INTO #MONTHS FROM EXP_ANLS_DET WHERE PROCESS_ID=@CPROCESS_ID AND XN_TYPE=@CXN_TYPE AND DEPT_ID=@CDEPT_ID	AND EXP_CODE=@CAC_CODE AND EXP_AMOUNT>0 ORDER BY MONTH DESC
					IF @@ROWCOUNT>0
						SET @BMONTH_EXISTS=1
						---INNER CURSOR 3(MONTHS)
						WHILE @BMONTH_EXISTS=1
						BEGIN
							SELECT TOP 1 @NMONTH=MONTH FROM #MONTHS						
							
							IF EXISTS(SELECT TOP 1 'U' FROM #MONTHS WHERE MONTH=@NMONTH-1)
							BEGIN	
								UPDATE A SET EXP_MOM_PCT=((A.EXP_AMOUNT-B.EXP_AMOUNT)/B.EXP_AMOUNT)*100
											,ES_MOM_PCT=(CASE WHEN ISNULL(B.EXP_SLS_PCT,0)<>0 THEN ((ISNULL(A.EXP_SLS_PCT,0)-ISNULL(B.EXP_SLS_PCT,0))/ISNULL(B.EXP_SLS_PCT,0)) END)
								FROM EXP_ANLS_DET A
								JOIN (SELECT TOP 1 EXP_AMOUNT,EXP_SLS_PCT FROM EXP_ANLS_DET WHERE PROCESS_ID=@CPROCESS_ID AND XN_TYPE=@CXN_TYPE AND DEPT_ID=@CDEPT_ID	AND EXP_CODE=@CAC_CODE AND MONTH=@NMONTH-1) B ON 1=1
								WHERE XN_TYPE=@CXN_TYPE AND DEPT_ID=@CDEPT_ID	AND EXP_CODE=@CAC_CODE AND MONTH=@NMONTH
								
							END
							DELETE #MONTHS WHERE MONTH=@NMONTH
							
							IF NOT EXISTS(SELECT TOP 1 MONTH FROM #MONTHS)
								SET @BMONTH_EXISTS=0
						END

					DELETE #LMS WHERE AC_CODE=@CAC_CODE
					
					IF NOT EXISTS(SELECT TOP 1 AC_CODE FROM #LMS)
						SET @BAC_EXISTS=0
				END
			
			DELETE #DEPTS WHERE DEPT_ID=@CDEPT_ID
			
			IF NOT EXISTS(SELECT TOP 1 DEPT_ID FROM #DEPTS)
				SET @BDEPT_EXISTS=0
		END	
		
		DELETE #XNS WHERE XN_TYPE=@CXN_TYPE	
		
		IF NOT EXISTS(SELECT TOP 1 XN_TYPE FROM #XNS)
			SET @BXNS_EXISTS=0
	END	
	
END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP3S_CALC_MOM,STEP:'+@CSTEP+',MESSAGE:'+ERROR_MESSAGE()
	GOTO EXIT_PROC
END CATCH

EXIT_PROC:
	IF ISNULL(@CERRMSG,'')<>''
		SELECT @CERRMSG AS ERRMSG
END
--END OF PROCEDURE - SP3S_CALC_MOM
