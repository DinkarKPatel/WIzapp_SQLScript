CREATE VIEW SKU_AT  
AS  
WITH CTE AS  
(  
  SELECT ARTICLE_CODE,PARA1_CODE,PARA2_CODE,CASE  WHEN CHARINDEX('@',ISNULL(S.PRODUCT_CODE,''))=0 THEN ISNULL(S.PRODUCT_CODE,'')   
              WHEN CHARINDEX('@',ISNULL(S.PRODUCT_CODE,''))=1 THEN LEFT(ISNULL(S.PRODUCT_CODE,''),1)  
              ELSE LEFT(ISNULL(S.PRODUCT_CODE,''),CHARINDEX('@',ISNULL(S.PRODUCT_CODE,''))-1)   
              END AS PRODUCT_CODE  
  ,R=ROW_NUMBER()OVER(PARTITION BY ARTICLE_CODE,PARA1_CODE,PARA2_CODE ORDER BY LEN(PRODUCT_CODE) DESC)  
  --,CASE WHEN CHARINDEX('@',ISNULL(S.PRODUCT_CODE,''))=0 THEN 0  
  --ELSE CAST(RIGHT(SUBSTRING(ISNULL(S.PRODUCT_CODE,''),CHARINDEX('@',ISNULL(S.PRODUCT_CODE,''))+1,100),4) AS INT)  
  -- END AS ORDERING   
  FROM SKU S(NOLOCK)   
  WHERE CHARINDEX('@',PRODUCT_CODE)>0 AND S.BARCODE_CODING_SCHEME=1
)  
SELECT ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PRODUCT_CODE,R FROM CTE WHERE R=1  
UNION  
SELECT ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PRODUCT_CODE,1 FROM SKU S (NOLOCK) WHERE CHARINDEX('@',PRODUCT_CODE)=0  AND S.BARCODE_CODING_SCHEME=1
