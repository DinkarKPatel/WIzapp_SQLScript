CREATE PROCEDURE SP3S_APPLY_PARTY_Rate_WSL--(LocId 3 digit change by Sanjay:04-11-2024)
(        
 @NSPID int,
 @cLOCID varchar(5)='',
 @CXNTYPE varchar(10)='wsl',
 @BGrouoInvoice bit=0
)                      
AS                        
BEGIN                        
	  print 'enter SP3S_APPLY_PARTY_Rate_WSL '
      DECLARE @CPARTYRATEFILTER VARCHAR(1000),@CTERMSCODE VARCHAR(20),@NCUSTOMRATETYPE INT,
      @CTARGETLOCID VARCHAR(5),@CSOURCELOCID VARCHAR(5),@NDEFAULTRATETYPE INT,@BENABLEEXCISDUTY BIT,
      @BCUSTOMPROCEXISTS BIT,@CSTEP VARCHAR(5),@CTERRMSG VARCHAR(MAX),
      @CERRPC VARCHAR(50),@CERRORMSG VARCHAR(MAX),@NINVTYPE INT,@NBILLLEVELTAXMETHOD INT,@NRATEPICKINGMETHOD INT,
      @NPARTYDISCPCT NUMERIC(7,3),@CPRODUCTCODE VARCHAR(50),@BPARTYRATEFILTERAPPLICABLE BIT,@BDONOTCALEXCISE BIT,
      @CPARTYRATEMEMOID VARCHAR(40),@NCALMODE INT,@NLOTPRICE NUMERIC(10,2),@NXFERTYPE INT,@CROUNDNETRATE VARCHAR(4),
      @BGSTBILL BIT,@DINVDT DATETIME,@CPARTYSTATECODE CHAR(7),@BGROUPINV BIT,
	  @tmptblname varchar(100),@dtsql nvarchar(max),@nManualRateInvoice BIT
	
	
	  BEGIN TRY
	  	  SET @CSTEP=10
		
		    SELECT TOP 1 @CROUNDNETRATE=VALUE FROM CONFIG WHERE CONFIG_OPTION='WSL_ITEM_LEVEL_ROUND_OFF'
		       
		  SET @CROUNDNETRATE=ISNULL(@CROUNDNETRATE,'')
		  
		  SELECT @CPARTYRATEMEMOID=PARTY_RATE_MEMO_ID FROM WSL_INV_SETTINGS WHERE SP_ID=@NSPID
		  		  		  
		  SELECT TOP 1 @NINVTYPE=ISNULL(INV_TYPE,1),@NXFERTYPE=ISNULL(XFER_TYPE,0),@NDEFAULTRATETYPE=DEFAULT_RATE_TYPE,@NCUSTOMRATETYPE=ISNULL(A.CUSTOM_RATE_TYPE,0),
		  @BPARTYRATEFILTERAPPLICABLE=ISNULL(PARTYRATE_FILTER_APPLICABLE,0),@CTERMSCODE=ISNULL(TERMS_CODE,''), 
		  @CTARGETLOCID=TARGET_LOCATION_ID,@CSOURCELOCID=A.LOCATION_ID,
		  @BENABLEEXCISDUTY=ISNULL(ENABLE_EXCISE_DUTY,0),@BCUSTOMPROCEXISTS=ISNULL(CUSTOM_PROC_EXISTS,0),
		  @NBILLLEVELTAXMETHOD=BILL_LEVEL_TAX_METHOD,@NRATEPICKINGMETHOD=ISNULL(C.RATE_PICKING_METHOD,0),
		--  @NPARTYDISCPCT=(CASE WHEN ISNULL(DISCOUNT_PICKING_MODE,0)=2 THEN 0 ELSE PARTY_DISCOUNT_PCT END),
		  @NPARTYDISCPCT=(PARTY_DISCOUNT_PCT), --as Discuss with Anil sir and sanjiv sir this above conditions is not Required)-27-10-2022
		  @NCALMODE=MST_CAL_MODE,@BDONOTCALEXCISE=ISNULL(DONOT_CALC_EXCISE,0),
		  @NLOTPRICE=A.LOT_PRICE,@BGSTBILL=ISNULL(GST_BILL,0),@DINVDT=INV_DT,
		  @CPARTYSTATECODE=PARTY_STATE_CODE
		  FROM WSL_INV_SETTINGS A (NOLOCK)
		  LEFT OUTER JOIN LOCATION B ON A.LOCATION_ID=B.DEPT_ID
		  LEFT OUTER JOIN 
		  (SELECT M.MEMO_ID,RATE_PICKING_METHOD,DISCOUNT_PICKING_MODE,MST_CAL_MODE--,D.VALUE 
		   FROM PARTY_RATE_MST M 
		   WHERE M.MEMO_ID=@CPARTYRATEMEMOID) C ON C.MEMO_ID=A.PARTY_RATE_MEMO_ID
		  WHERE SP_ID=@NSPID

		
		  
		  IF ISNULL(@CPARTYRATEMEMOID,'')=''
		  BEGIN
				SELECT @NDEFAULTRATETYPE=1,@NPARTYDISCPCT=0
		  END
		  
		
		  IF @NRATEPICKINGMETHOD=1 AND ISNULL(@CTERMSCODE,'')=''
		  BEGIN
				SET @CERRORMSG='PLEASE SELECT A VALID TERMS NAME FOR INVOICING'
				GOTO END_PROC
		  END

		  SELECT sfp.product_code,fc_rate as ws_price
		       into #tmpSFP
		  FROM sku_fc_prices sfp (NOLOCK)
		  JOIN location loc (NOLOCK) ON 1=1
		  JOIN wsl_item_details c (NOLOCK) ON c.PRODUCT_CODE=sfp.product_code
		  WHERE c.sp_id=@NSPID 
		  and loc.dept_id= @cLOCID AND sfp.fc_code=loc.fc_code   

		  SELECT PRODUCT_CODE,xfer_price 
		       INTO #TMPSKU_FXP
		  FROM SKU_Xfp (NOLOCK) WHERE 1=2

		  declare @CHODEPT_ID varchar(4)
	     SELECT @CHODEPT_ID=value FROM CONFIG WHERE CONFIG_OPTION ='HO_LOCATION_ID'

		  if @BGrouoInvoice=1 and @CXNTYPE='WSL' and  @cLOCID<>@CHODEPT_ID
		  begin
		       
			   insert into #TMPSKU_FXP(PRODUCT_CODE,xfer_price)
			    SELECT PRODUCT_CODE,xfer_price 
			    FROM SKU_Xfp (NOLOCK) WHERE DEPT_ID=@CLOCID

		  end

		 -- if @@spid=483
			--select top 1 'check rate b4 applying',rate,net_rate,discount_percentage,discount_amount,product_code, * from wsl_item_details where sp_id=@@spid 
			--and product_code='22RW139561'

		
	

		 UPDATE A SET RATE=(CASE WHEN ISNULL(MANUAL_RATE,0)=1 THEN RATE WHEN @NLOTPRICE<>0 THEN @NLOTPRICE 
					 WHEN sf.product_code IS NOT NULL THEN sf.ws_price  	
					 WHEN ISNULL(ST.MRP_WSP_MODE,0)=2 OR @NDEFAULTRATETYPE=1 AND ISNULL(SKU.WS_PRICE,0)>0 THEN 
					 SKU.WS_PRICE
					 WHEN @NDEFAULTRATETYPE=3 THEN (CASE WHEN @BGROUOINVOICE=1 AND @CXNTYPE ='WSL' and  isnull(SKU.PURCHASE_PRICE,0)=0 THEN XFP.xfer_price ELSE SKU.PURCHASE_PRICE END) 
					  ELSE SKU.MRP END),
		  DISCOUNT_AMOUNT=CASE WHEN ISNULL(MANUAL_DISCOUNT,0)=1 then A.DISCOUNT_AMOUNT ELSE 0 END,
		  DISCOUNT_PERCENTAGE=(CASE WHEN ISNULL(a.MANUAL_DP,0)=1 then a.DISCOUNT_PERCENTAGE  WHEN @NLOTPRICE<>0 THEN 0 
		  ELSE ISNULL(@NPARTYDISCPCT,0)*
		  (CASE WHEN ISNULL(@NCALMODE,3)=1 THEN -1 ELSE 1 END) END)
			  ,HSN_CODE=SKU.HSN_CODE
		FROM [WSL_ITEM_DETAILS] A
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
		LEFT JOIN WSL_INV_SETTINGS ST ON A.SP_ID=ST.SP_ID
		LEFT OUTER JOIN #tmpSFP  SF ON sf.product_code=a.PRODUCT_CODE
		left join #TMPSKU_FXP xfp on xfp.PRODUCT_CODE=a.PRODUCT_CODE
		WHERE A.SP_ID=@NSPID AND ISNULL(ERRMSG,'')=''



		UPDATE WSL_ITEM_DETAILS SET DISCOUNT_AMOUNT=(RATE * INVOICE_QUANTITY * DISCOUNT_PERCENTAGE) / 100
		WHERE SP_ID=@NSPID AND ISNULL(manual_discount,0)=0

		UPDATE WSL_ITEM_DETAILS SET NET_RATE=RATE-(RATE * DISCOUNT_PERCENTAGE/ 100)
		WHERE SP_ID=@NSPID AND ISNULL(MANUAL_NET_RATE,0)=0

	    UPDATE WSL_ITEM_DETAILS SET Rate=NET_RATE+(RATE * DISCOUNT_PERCENTAGE/ 100)
		WHERE SP_ID=@NSPID AND ISNULL(MANUAL_NET_RATE,0)=1 and isnull(manual_rate,0)=0

			
					  
		  SET @CSTEP=45	
	
		  SELECT TOP 1 @CPRODUCTCODE=PRODUCT_CODE FROM WSL_ITEM_DETAILS 
		  WHERE SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0		
		  
		
		 -- if @@spid=483
			--select top 1 'check final rate',rate,net_rate,discount_percentage,discount_amount,product_code, * from wsl_item_details where sp_id=@@spid and product_code='22RW139561'

		  SET @nManualRateInvoice=0		
		  IF NOT EXISTS (SELECT TOP 1 product_code FROM wsl_item_details (NOLOCK) WHERE sp_id=@NSPID
						 AND (isnull(manual_rate,0)=0 or isnull(manual_net_rate,0)=0))
				SET @nManualRateInvoice=1	
				

		  
		  IF @NLOTPRICE=0 AND @nManualRateInvoice=0
		  BEGIN
	
			  IF @NRATEPICKINGMETHOD=1 AND ISNULL(@CTERMSCODE,'')<>'' AND ISNULL(@CPRODUCTCODE,'')<>''
			  BEGIN
			  
					PRINT 'UPDATE RATES FOR TERMS'
					SET @CSTEP=60			  
					IF @BGSTBILL=1
						EXEC SP3S_GETINVRATE_TERMS_GST  @NSPID,'WSL',@CERRORMSG OUTPUT					
					ELSE	
						EXEC SP3S_GETINVRATE_TERMS_NEW @NSPID,'WSL',@CERRORMSG OUTPUT
					
					IF ISNULL(@CERRORMSG,'')<>''
						GOTO END_PROC
			  END		
			  ELSE
			  IF @NRATEPICKINGMETHOD=2 AND @BCUSTOMPROCEXISTS=1 AND ISNULL(@CPRODUCTCODE,'')<>''
			  BEGIN
			  
					PRINT 'UPDATE RATES FOR CUSTOM PROC'
					SET @CSTEP=70			  
					EXEC SP3S_GETINVRATE_CUSTOM @NSPID
			  END	
			  ELSE
			  IF @NRATEPICKINGMETHOD=3 AND @BPARTYRATEFILTERAPPLICABLE=1 AND ISNULL(@CPRODUCTCODE,'')<>''
			  BEGIN
			
			
					PRINT 'UPDATE RATES FOR PARTY RATE:'+STR(@NSPID)
					SET @CSTEP=65			  
					EXEC SP3S_APPLY_PARTY_RATE_NEW @NSPID,@CERRORMSG OUTPUT,@CXNTYPE,@cLOCID,@BGrouoInvoice=@BGrouoInvoice
					 
					IF ISNULL(@CERRORMSG,'')<>''
						GOTO END_PROC
			  END		
			  ELSE
				PRINT 'UPDATE BASIC RATES'
		  END
		  			  
LBLRECALAMOUNT:		  		  		  
		  

		 	--if @@spid=162
				--select @nManualRateInvoice nManualRateInvoice,@NLOTPRICE NLOTPRICE,@NRATEPICKINGMETHOD NRATEPICKINGMETHOD,
				--@BPARTYRATEFILTERAPPLICABLE PARTYRATEFILTERAPPLICABLE,@CPARTYRATEMEMOID CPARTYRATEMEMOID
		
			  SET @CSTEP=125
			  UPDATE WSL_ITEM_DETAILS SET NET_RATE=(CASE WHEN INVOICE_QUANTITY=0 THEN 0 ELSE (RATE-(DISCOUNT_AMOUNT/INVOICE_QUANTITY)) END)
			  WHERE SP_ID=@NSPID AND ISNULL(MANUAL_NET_RATE,0)=0
			  
			  SET @CSTEP=127  
			   
			  UPDATE A  set Rate=RATE+(ABS(DISCOUNT_AMOUNT)/invoice_quantity),DISCOUNT_AMOUNT=0,DISCOUNT_PERCENTAGE=0
			  FROM WSL_ITEM_DETAILS A (NOLOCK)  WHERE SP_ID=@NSPID AND DISCOUNT_AMOUNT<0

			  
			  SET @CSTEP=130			  
			  IF @CROUNDNETRATE='1'
				  UPDATE WSL_ITEM_DETAILS SET NET_RATE=ROUND(NET_RATE,0) WHERE SP_ID=@NSPID
				  AND ISNULL(MANUAL_NET_RATE,0)=0
				  
			  IF @CROUNDNETRATE='1'	  --add same config rate and net_rate for nagarmal as on(2024-02-27)
			       UPDATE WSL_ITEM_DETAILS SET RATE =ROUND(RATE,0) WHERE SP_ID=@NSPID
				   AND ISNULL(MANUAL_RATE,0)=0
				   
				

			  UPDATE A SET  BASEAMOUNT_FOR_TAX = NET_RATE - (NET_RATE*B.BILL_DISC_PCT/100),
			                AMOUNT=NET_RATE*INVOICE_QUANTITY,
							AMOUNT_MRP=mrp*INVOICE_QUANTITY
			  FROM WSL_ITEM_DETAILS A JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
			  WHERE A.SP_ID=@NSPID   

	
		    --Einvoiceing Enable doen not upload negative Amount changes discuss with sanjay sir Instruction with sanjiv sir (19042022)
		    --again DIscuss with Sir for Duke Insutruction With Pankaj donot check Einvoice..
		  --if exists (select top 1'u' from location (nolock) where dept_id=@cLOCID and isnull(Enable_EInvoice,0)=1)
		  --begin
		       
			  --UPDATE A  set Rate=RATE+(ABS(DISCOUNT_AMOUNT)/invoice_quantity),DISCOUNT_AMOUNT=0,DISCOUNT_PERCENTAGE=0
			  --FROM WSL_ITEM_DETAILS A (NOLOCK)  WHERE SP_ID=@NSPID AND DISCOUNT_AMOUNT<0

		--  end
		  --shiftd to @CSTEP=127  
		  	 	  
		  GOTO END_PROC
	  END TRY
	  
	  BEGIN CATCH
			PRINT 'ENTER CATCH BLOCK'
			SET @CERRORMSG='ERROR IN PROCEDURE SP3S_GETWSL_DATA : STEP #'+@CSTEP+' '+ERROR_MESSAGE()
			GOTO END_PROC 
	  END CATCH

END_PROC:
		PRINT 'LAST STEP of SP3S_APPLY_PARTY_Rate_WSL:'+@CSTEP
		
	
	  IF ISNULL(@CERRORMSG,'')<>'' and not exists (select  top 1 'u' from WSL_ITEM_DETAILS where   SP_ID=@NSPID and ISNULL (errmsg,'')<>'')
	  		UPDATE WSL_ITEM_DETAILS SET ERRMSG=@CERRORMSG WHERE SP_ID=@NSPID
	  
	
	
	  		
END
------------- END OF PROCEDURE SP3S_APPLY_PARTY_WSL

