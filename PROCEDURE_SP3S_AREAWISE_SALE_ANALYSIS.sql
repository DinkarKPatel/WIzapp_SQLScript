CREATE PROCEDURE SP3S_AREAWISE_SALE_ANALYSIS
(
	 @DFROMDT DATETIME
	,@DTODT   DATETIME
	,@CFILTER VARCHAR(MAX)
)
--WITH ENCRYPTION
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
/*
	EXEC SP3S_AREAWISE_SALE_ANALYSIS '2014-01-31','2015-04-30 16:38:50.470','LOC_VIEW.DEPT_ID=''00'''	
*/
	DECLARE @CFROM_FINYEAR VARCHAR(10),@CTO_FINYEAR VARCHAR(10),@CLOOP_FINYEAR VARCHAR(10)
		   ,@NFROM_MONTH NUMERIC(2),@NTO_MONTH NUMERIC(2)
		   ,@CCMD NVARCHAR(MAX)
	--INITIALIZING THE FROMDT AND TODT TO THE FIRST DAY OF THE DATE
	SET @DFROMDT=CONVERT(VARCHAR(10),DATEADD(M,0,DATEADD(D,1-DATEPART(D,@DFROMDT),@DFROMDT)),110)
	SET @DTODT=CONVERT(VARCHAR(10),DATEADD(M,0,DATEADD(D,1-DATEPART(D,@DTODT),@DTODT)),110)
	
	--SELECT @DFROMDT,@DTODT
	
	IF OBJECT_ID('TEMPDB..#MONTHS','U') IS NOT NULL
		DROP TABLE #MONTHS
	
	CREATE TABLE #MONTHS(MONTH_DATE DATETIME,MONTH_NO NUMERIC(2),FIN_YEAR VARCHAR(10))	
	
	--GETTING MONTHS FINANCIAL YEARWISE FOR WHICH DATA IS TO BE RETRIEVED.
	WHILE @DFROMDT<=@DTODT
	BEGIN
		INSERT #MONTHS(MONTH_DATE,MONTH_NO,FIN_YEAR)
		SELECT @DFROMDT,MONTH(@DFROMDT),'01'+DBO.FN_GETFINYEAR(@DFROMDT)
	
		SET @DFROMDT=DATEADD(MONTH,1,@DFROMDT)
	END
	--SELECT * FROM #MONTHS
	
	---GETTING PSFPD FIGURES
	IF OBJECT_ID('TEMPDB..#PSFPD','U') IS NOT NULL
		DROP TABLE #PSFPD
	
	SELECT MST.TITLE_NAME,MST.MEMO_ID,DET.DEPT_ID,DET.FIN_YEAR
		  ,DET.MONTH_NAME
		  ,DET.MONTH_NO
		  ,DET.AREA_ALLOCATED
		  ,DET.NRV 
		  ,DET.PSFPD
	INTO #PSFPD	  
	FROM FILTER_PSFPD_MST MST
	JOIN FILTER_PSFPD_DET DET ON MST.MEMO_ID=DET.MEMO_ID
	JOIN #MONTHS C ON DET.FIN_YEAR=C.FIN_YEAR AND C.MONTH_NO=DET.MONTH_NO	
	
	SET @CCMD=N'SELECT A.TITLE_NAME,A.DEPT_ID
		  ,LOC_VIEW.DEPT_NAME
		  ,LOC_VIEW.AREA_NAME
		  ,LOC_VIEW.CITY
		  ,LOC_VIEW.STATE		
		  ,DBO.FN3S_FINYEAR_DISPLAY(A.FIN_YEAR) AS FIN_YEAR
		  ,LEFT(A.MONTH_NAME,3) AS MONTH_NAME
		  ,A.MONTH_NO
		  ,A.AREA_ALLOCATED
		  ,A.NRV
		  ,A.PSFPD
		  ,LOC_ATTR_VALUE.*
	FROM #PSFPD A
	JOIN LOC_VIEW ON A.DEPT_ID=LOC_VIEW.DEPT_ID			   
	LEFT OUTER JOIN LOC_ATTR_VALUE ON A.DEPT_ID= LOC_ATTR_VALUE.DEPT_ID'
	+(CASE WHEN ISNULL(@CFILTER,'')='' THEN '' ELSE ' WHERE '+@CFILTER END)	
	PRINT @CCMD
	
	EXEC SP_EXECUTESQL @CCMD
	
END
--END OF PROCEDURE - SP3S_AREAWISE_SALE_ANALYSIS
