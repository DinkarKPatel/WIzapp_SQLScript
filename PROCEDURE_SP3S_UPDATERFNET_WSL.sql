create PROCEDURE SP3S_UPDATERFNET_WSL  
@CINV_ID VARCHAR(40)  
AS  
BEGIN  
 DECLARE @CROWID VARCHAR(50),@NTAX NUMERIC(10,2),@NINCLTAX NUMERIC(10,2),@NSUMRFNET NUMERIC(10,2),@NSUBTOTAL NUMERIC(10,2),  
   @NSUMRFNETWT NUMERIC(10,2),@NOH_AMOUNT NUMERIC(14,2),@NTOTALQTY NUMERIC(10,3),@NOH_TAXABLE_VALUE NUMERIC(14,2),@DINV_DT DATETIME  
  
 SELECT TOP 1 @CROWID = ROW_ID FROM IND01106 A WITH (ROWLOCK) WHERE INV_ID=@CINV_ID  
  
 PRINT 'UPDRFNET-4'  
     
 SELECT @NTAX=0,@NINCLTAX=0  
  
 UPDATE A SET RFNET =0,RFNET_WOTAX =0 FROM IND01106 A WITH (ROWLOCK) WHERE INV_ID=@CINV_ID  
  
 SELECT   @NOH_AMOUNT= ISNULL(B.FREIGHT_TAXABLE_VALUE,0) +   
  ISNULL(B.FREIGHT_IGST_AMOUNT ,0)+ISNULL(B.FREIGHT_CGST_AMOUNT ,0)+ISNULL(B.FREIGHT_SGST_AMOUNT ,0)+  
  ISNULL(B.OTHER_CHARGES_TAXABLE_VALUE,0) +   
  ISNULL(B.OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_CGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_SGST_AMOUNT ,0)+  --B.ROUND_OFF  
  B.OCTROI_AMOUNT+ ISNULL(B.TCS_AMOUNT,0)+  
  ISNULL(B.INSURANCE_TAXABLE_VALUE,0)+  
  ISNULL(B.INSURANCE_IGST_AMOUNT ,0)+ISNULL(B.INSURANCE_CGST_AMOUNT ,0)+ISNULL(B.INSURANCE_SGST_AMOUNT ,0)+  
  B.EXCISE_DUTY_AMOUNT+  
  B.EXCISE_EDU_CESS_AMOUNT+B.EXCISE_HEDU_CESS_AMOUNT,  
  @NTOTALQTY=B.TOTAL_QUANTITY,  
  @NOH_TAXABLE_VALUE= ISNULL(B.FREIGHT_TAXABLE_VALUE,0) + ISNULL(B.OTHER_CHARGES_TAXABLE_VALUE,0) + isnull(B.OCTROI_AMOUNT,0)+   
  ISNULL(B.INSURANCE_TAXABLE_VALUE,0)+B.EXCISE_DUTY_AMOUNT+B.EXCISE_EDU_CESS_AMOUNT+B.EXCISE_HEDU_CESS_AMOUNT,  
  @DINV_DT=B.INV_DT   
 FROM INM01106 B  WITH (ROWLOCK) WHERE INV_ID=@CINV_ID  

 set @NOH_TAXABLE_VALUE=isnull(@NOH_TAXABLE_VALUE,0)

  
 IF @DINV_DT<'2017-07-01'  
    RETURN  
     
     IF ISNULL(@NOH_AMOUNT,0)=0  
  BEGIN  
         
    UPDATE A SET RFNET=isnull(A.XN_VALUE_WITH_GST,0)+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0) ,RFNET_WOTAX =isnull(A.XN_VALUE_WITHOUT_GST,0)+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0)     
    FROM  IND01106 A WITH (ROWLOCK) WHERE INV_ID=@CINV_ID  
      
  
  END  
  ELSE  
  BEGIN  
        
    UPDATE A SET RFNET=isnull(A.XN_VALUE_WITH_GST,0)+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0)+ ((@NOH_AMOUNT/CASE WHEN ISNULL(@NTOTALQTY,0)=0 THEN 1 ELSE @NTOTALQTY END )*A.invoice_quantity ) ,  
                 RFNET_WOTAX =isnull(A.XN_VALUE_WITHOUT_GST,0)+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0) + ((@NOH_TAXABLE_VALUE/CASE WHEN ISNULL(@NTOTALQTY,0)=0 THEN 1 ELSE @NTOTALQTY END )*A.invoice_quantity )    
    FROM  IND01106 A WITH (ROWLOCK) WHERE INV_ID=@CINV_ID  
      
  
  
  END  
  
  
  
  
 SELECT @NSUBTOTAL= NET_AMOUNT FROM INM01106  (NOLOCK) WHERE  INV_ID  = @CINV_ID  
  
 SELECT @NSUMRFNET = SUM(RFNET) FROM IND01106  WHERE INV_ID  = @CINV_ID  
      
 IF @NSUMRFNET <> @NSUBTOTAL  
 BEGIN  
  PRINT 'UPDRFNET-6'  
  UPDATE IND01106  SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET )   
  WHERE INV_ID = @CINV_ID AND ROW_ID = @CROWID  
 END  
  
 update inm01106 with (rowlock) set HO_SYNCH_LAST_UPDATE=''  WHERE inv_id=@CINV_ID  
  
END     -- END OF WHOLESALE INVOICE  