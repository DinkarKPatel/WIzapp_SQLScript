CREATE PROCEDURE SP_SYNCH_MIRRORDATA_IRR_SINGLE
(
	@CLOCID VARCHAR(3)
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
SET NOCOUNT ON
BEGIN
	/*
		SP_MERGE_MIRROR_IRR_DATA_208_2014_02_05 : 
		THIS PROCEDURE WILL MERGE DATA FROM TEMPORARY TABLE TO ACTUAL TABLE.
		TABLE NAMES AND ITS MERGING ORDER WILL BE FIXED AND WILL BE DEFINED HERE.	
	*/
DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
	   ,@CTABLENAME VARCHAR(200),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
	   ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	   ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(500),@CMEMOID VARCHAR(100),@NVERSIONNO INT,
	   @CMEMOIDSEARCH varchar(100),@BADDMODE bit,@CMERGEDB varchar(100),@CSOURCEDB varchar(100),
	   @BMSTINSERTONLY bit,@CFILTERCONDITION1 VARCHAR(100)
	   
BEGIN TRY
SET @CSTEP=20
  LBLSTART:
    

	 SET @CMERGEDB=''
	 SET @CSOURCEDB=''
    SELECT @CMEMOID='',@NVERSIONNO=0
	set @BMSTINSERTONLY=1
  
BEGIN TRANSACTION 
	
    SELECT TOP 1 @CMEMOID = B.IRM_MEMO_ID ,@NVERSIONNO=VERSION_NO
    FROM IRR_IRM01106_MIRROR B (NOLOCK)
    LEFT OUTER JOIN MIRROR_SYNCH_LOG C (NOLOCK) ON C.MEMO_ID=B.IRM_MEMO_ID AND C.XN_TYPE='IRR'
    WHERE (LEFT(B.IRM_MEMO_ID,2)=@CLOCID )  AND DATEDIFF(SS,B.VERSION_LAST_UPDATE,GETDATE())>60 AND C.MEMO_ID IS NULL
    ORDER BY B.IRM_MEMO_ID,VERSION_NO DESC
    

    IF ISNULL(@CMEMOID,'')=''
		GOTO EXIT_PROC
		
    SET @CFILTERCONDITION = 'B.IRR_MEMO_ID='''+@CMEMOID+''' AND B.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO)))
	
	SET @CFILTERCONDITION1='B.IRM_MEMO_ID='''+@CMEMOID+''' AND B.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO)))

	SET @CSTEP=20
	SET @CMEMOIDSEARCH=''
	SELECT TOP 1 @CMEMOIDSEARCH=A.irm_memo_id  FROM irm01106  A (NOLOCK) WHERE A.irm_memo_id =@CMEMOID
	
	IF ISNULL(@CMEMOIDSEARCH,'')<>''
		SET @BADDMODE=0
	ELSE
		SET @BADDMODE=1

	SET @CSTEP=30

	SET @CTABLENAME='IRD01106'
	SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='IRM_MEMO_ID'
	SET @CSTEP=90
	SET @DTSQL=N'DELETE '+@CMERGEDB+'['+@CTABLENAME+'] WITH (ROWLOCK) WHERE '+@CKEYFIELD+'='''+@CMEMOID+''''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL

    SET @CSTEP=40
	SET @CTABLENAME='IRM01106'
	SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='IRM_MEMO_ID'
	SET @CSTEP=310
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION1,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 


    SET @CSTEP = 50
    SET @CTABLENAME='ARTICLE'
    SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
    SET @CKEYFIELD='ARTICLE_CODE'
    
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
						  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
						  ,@BALWAYSUPDATE=1 						
	
    SET @CSTEP = 60
    SET @CTABLENAME='PARA1'
    SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
    SET @CKEYFIELD='PARA1_CODE'
    
    
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
						  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
						  ,@BALWAYSUPDATE=1 					

    SET @CSTEP = 70
    SET @CTABLENAME='PARA2'
    SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
    SET @CKEYFIELD='PARA2_CODE'
    
    
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
						  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
						  ,@BALWAYSUPDATE=1 				

    SET @CSTEP = 80
    SET @CTABLENAME='PARA3'
    SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
    SET @CKEYFIELD='PARA3_CODE'
    
    
    
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
						  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
						  ,@BALWAYSUPDATE=1 			

    SET @CSTEP = 90
    SET @CTABLENAME='PARA4'
    SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
    SET @CKEYFIELD='PARA4_CODE'
    
    
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
						  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
						  ,@BALWAYSUPDATE=1 			

    SET @CSTEP = 100
    SET @CTABLENAME='PARA5'
    SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
    SET @CKEYFIELD='PARA5_CODE'
    
    
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
						  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
						  ,@BALWAYSUPDATE=1 			

    SET @CSTEP = 110
    SET @CTABLENAME='PARA6'
    SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
    SET @CKEYFIELD='PARA6_CODE'
    
    
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
						  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
						  ,@BALWAYSUPDATE=1 			

	SET @CSTEP=120
	SET @CTABLENAME='SKU'
	SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PRODUCT_CODE'
	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	
	PRINT 'NOW INSERT SKU_OH'
	SET @CSTEP=130
	SET @CTABLENAME='SKU_OH'
	SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PRODUCT_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
	
	PRINT 'NOW INSERT IRD01106'						  
	SET @CSTEP=140
	SET @CTABLENAME='IRD01106'
	SET @CTMP_TABLENAME='IRR_'+@CTABLENAME+'_mirror'
	SET @CKEYFIELD='IRM_MEMO_ID'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION1,@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 

	SET @CSTEP=145 

	DECLARE @CXN_TYPE VARCHAR(10)
	SET @CXN_TYPE=''
   IF EXISTS (SELECT TOP 1 'U'  FROM IRD01106 WHERE IRM_MEMO_ID=@CMEMOID AND ISNULL(NEW_PRODUCT_CODE,'')<>'')
	SET @CXN_TYPE='IRR'

	EXEC SP3S_MERGE_LOCPMT  
	@cTempTable='IRR_PMT01106_MIRROR',  
	@cMemoIdCol='IRR_MEMO_ID',  
	@cMemoId =@CMEMOID

	
	DELETE A FROM IRR_ARTICLE_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_IRD01106_MIRROR A (NOLOCK) WHERE IRM_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_IRM01106_MIRROR A (NOLOCK) WHERE IRM_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_PARA1_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_PARA2_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_PARA3_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_PARA4_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_PARA5_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_PARA6_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_PMT01106_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_SECTIOND_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_SECTIONM_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_SKU_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	DELETE A FROM IRR_SKU_OH_MIRROR A (NOLOCK) WHERE IRR_MEMO_ID=@CMEMOID
	
	
   IF ISNULL(@CERRMSG,'')=''
		COMMIT
	ELSE
		GOTO EXIT_PROC
	
    GOTO LBLSTART
				  	

END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP_SYNCH_MIRRORDATA_IRR_SINGLE, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
END CATCH

EXIT_PROC:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')=''
		BEGIN
			COMMIT TRANSACTION
		END	
		ELSE 
			ROLLBACK
	END		
	
END	
---END OF PROCEDURE - SP_SYNCH_MIRRORDATA_IRR_SINGLE

