
create PROC VALIDATEXN_BOM_ISU_BEFORE_EDIT 
	@CMEMOID VARCHAR(30),
	@BCANCELXN BIT,
	@CERRORMSG VARCHAR(200) OUTPUT,
	@CEXPRERRORMSG VARCHAR(200) OUTPUT
--WITH recompile
AS
BEGIN
	
	DECLARE @CTEXT VARCHAR(10),@CPRODUCTCODE VARCHAR(50)
	
	SELECT @CPRODUCTCODE=''
	
	SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)

	DECLARE @JOBWORK_ISSUE_ID VARCHAR(50)

	SELECT @JOBWORK_ISSUE_ID=JOBWORK_ISSUE_ID  FROM BOM_ISSUE_MST A WHERE   A.ISSUE_ID=@CMEMOID

	IF OBJECT_ID ('#TMPISSUEID','U') IS NOT NULL
	   DROP TABLE #TMPISSUEID

	SELECT   B.ISSUE_ID 
	into #tmpissueid 
	FROM JOBWORK_ISSUE_MST B (NOLOCK)
	JOIN JOBWORK_ISSUE_DET C (NOLOCK) ON B.ISSUE_ID=C.ISSUE_ID
	JOIN TRANSFER_TO_TRADING_DET D ON D.PRODUCT_CODE =C.PRODUCT_CODE
	JOIN TRANSFER_TO_TRADING_MST E ON E.MEMO_ID=D.MEMO_ID
	WHERE B.ISSUE_ID=@JOBWORK_ISSUE_ID and E.CANCELLED=0

	IF EXISTS(select top 1 'u' from #tmpissueid)
	BEGIN	
		SET @CERRORMSG='BARCODE ALREADY TRANSFERRED TO TRADING.........CAN NOT '+@CTEXT
		RETURN
	END

		
END


