CREATE PROCEDURE SP3S_PROCESS_ONLINE_CN_ADV
(
  @NMODE INT
 ,@CUST_CODE VARCHAR (100)
 ,@CLOCID VARCHAR(100)
 ,@CUNKNOWNPARA VARCHAR(5)=''
 ,@CCNID VARCHAR(100)=''
 )
 AS
 BEGIN
 
	DECLARE @cCutoffDate VARCHAR(10)
	
	SELECT TOP 1 @cCutoffDate=value FROM config WHERE config_option='CUTOFF_DATE_FOR_PENDING_ADV_CN_CR'
	SET @cCutoffDate=ISNULL(@cCutoffDate,'')
	
	DECLARE @cCustDetails TABLE(CUSTOMER_CODE VARCHAR(50),USER_CUSTOMER_CODE VARCHAR(50), MOBILE VARCHAR(50))	

	INSERT INTO @cCustDetails(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE)
	SELECT CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE
	FROM CUSTDYM
	WHERE CUSTOMER_CODE=@CUST_CODE 
	
	INSERT INTO @cCustDetails(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE)
	SELECT A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE
	FROM CUSTDYM A
	left join @cCustDetails c on a.customer_code =c.CUSTOMER_CODE 
	WHERE C.CUSTOMER_CODE IS NULL AND A.USER_CUSTOMER_CODE=@CUST_CODE 

	INSERT INTO @cCustDetails(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE)
	SELECT A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE
	FROM CUSTDYM A
	left join @cCustDetails c on a.customer_code =c.CUSTOMER_CODE 
	WHERE C.CUSTOMER_CODE IS NULL AND A.mobile=@CUST_CODE 
	
	/*Rohit 06-02-2023 : Changes done for Cantabill ADV Adustment
	INSERT INTO @cCustDetails(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE)
	SELECT A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE
	FROM CUSTDYM A
	JOIN @cCustDetails B ON B.USER_CUSTOMER_CODE=A.user_customer_code
	WHERE B.CUSTOMER_CODE<>A.customer_code
	AND ISNULL(B.USER_CUSTOMER_CODE,'') <>''


	INSERT INTO @cCustDetails(CUSTOMER_CODE,USER_CUSTOMER_CODE,MOBILE)
	SELECT   A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE
	FROM CUSTDYM A
	JOIN @cCustDetails B ON B.MOBILE=A.mobile
	left join @cCustDetails c on a.customer_code =c.CUSTOMER_CODE 
	WHERE B.CUSTOMER_CODE<>A.customer_code
	AND ISNULL(B.MOBILE,'') <>'' AND C.CUSTOMER_CODE IS NULL
	group by   A.CUSTOMER_CODE,A.USER_CUSTOMER_CODE,A.MOBILE
	*/
	
	 IF EXISTS(SELECT TABLE_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='LOCATION' AND COLUMN_NAME='DEPT_ID' AND CHARACTER_MAXIMUM_LENGTH>=4)
	 BEGIN
	 IF @NMODE=1 -- FOR CREDIT NOTE
		BEGIN
 		SELECT  CM_NO,CM_ID,CM_DT,ABS(PAY.AMOUNT) AS AMOUNT,0 [BIT], ISNULL(CMM.location_Code,LEFT(CMM.CM_ID,2)) AS ADJ_LOCATION_CODE
			FROM CMM01106 CMM(NOLOCK)
			--JOIN CUSTDYM R (NOLOCK) ON CMM.CUSTOMER_CODE = R.customer_code 
			JOIN @cCustDetails R ON CMM.CUSTOMER_CODE = R.customer_code 
			JOIN PAYMODE_XN_DET PAY(NOLOCK) ON PAY.memo_id=CMM.CM_ID AND PAY.amount<0
			LEFT JOIN
			(
			  SELECT P.ADJ_MEMO_ID       
			  FROM PAYMODE_XN_DET P (NOLOCK)     
			  JOIN CMM01106 Q (NOLOCK) ON P.MEMO_ID = Q.CM_ID  
			  --JOIN CUSTDYM R (NOLOCK) ON Q.CUSTOMER_CODE = R.customer_code     
			  JOIN @cCustDetails R  ON Q.CUSTOMER_CODE = R.customer_code 
			  WHERE P.PAYMODE_CODE = '0000001'      
			  AND   Q.CANCELLED = 0    
			  --AND (@CUST_CODE='' OR (q.CUSTOMER_CODE=@CUST_CODE OR R.user_customer_code = @CUST_CODE OR R.mobile=@CUST_CODE) )  
			  AND   Q.CM_ID <> @CCNID  
			  
			  UNION ALL  
			    
			  SELECT P.ADJ_MEMO_ID       
			  FROM PAYMODE_XN_DET P (NOLOCK)     
			  JOIN ARC01106 Q (NOLOCK) ON P.MEMO_ID = Q.ADV_REC_ID  
			  --JOIN CUSTDYM R (NOLOCK) ON Q.CUSTOMER_CODE = R.customer_code         
			  JOIN @cCustDetails R  ON Q.CUSTOMER_CODE = R.customer_code 
			  WHERE P.PAYMODE_CODE = '0000001'      
			  AND   Q.CANCELLED = 0      
			  --AND (@CUST_CODE='' OR (q.CUSTOMER_CODE=@CUST_CODE OR R.user_customer_code = @CUST_CODE OR R.mobile=@CUST_CODE) )  
			  AND   Q.ADV_REC_ID <> @CCNID  

				  
			)P1 ON P1.ADJ_MEMO_ID=CMM.CM_ID 
			WHERE PAY.PAYMODE_CODE IN ('0000004')
				AND SUBSTRING(CM_NO,3+LEN(CMM.location_code),1)='N' 
				AND CANCELLED=0  
				AND (@CCNID='' OR  CMM.CM_NO=@CCNID)
				AND ISNULL(P1.ADJ_MEMO_ID,'')=''
				--AND (@CUST_CODE='' OR CMM.CUSTOMER_CODE=@CUST_CODE)
				 --AND (@CUST_CODE='' OR (CMM.CUSTOMER_CODE=@CUST_CODE OR R.user_customer_code = @CUST_CODE OR R.mobile=@CUST_CODE) )  
				and cmm.CM_DT>=@cCutoffDate

		END
		
     IF @NMODE=2 -- FOR ADVANCE
		BEGIN
			SELECT  ADV_REC_NO AS CM_NO,ADV_REC_ID AS CM_ID,ADV_REC_DT AS CM_DT,ABS(sum(PAY.AMOUNT)) AS AMOUNT,0 [BIT],ARC.ref_no,
			ISNULL(ARC.location_Code,LEFT(ARC.ADV_REC_ID,2)) AS ADJ_LOCATION_CODE
			INTO #TEMP
			FROM ARC01106 ARC(NOLOCK)
			--JOIN CUSTDYM R (NOLOCK) ON ARC.CUSTOMER_CODE = R.customer_code 
			JOIN @cCustDetails R  ON ARC.CUSTOMER_CODE = R.customer_code 
			JOIN PAYMODE_xN_DET PAY(NOLOCK) ON PAY.memo_id=ARC.ADV_REC_ID  
			LEFT JOIN
			(
			  SELECT P.ADJ_MEMO_ID       
			  FROM PAYMODE_XN_DET P (NOLOCK)     
			  JOIN CMM01106 Q (NOLOCK) ON P.MEMO_ID = Q.CM_ID  
			   --JOIN CUSTDYM R (NOLOCK) ON Q.CUSTOMER_CODE = R.customer_code      
			   JOIN @cCustDetails R  ON Q.CUSTOMER_CODE = R.customer_code 
			  WHERE P.PAYMODE_CODE = '0000002'      
			  AND   Q.CANCELLED = 0      
			 ---- AND (@CUST_CODE='' OR q.CUSTOMER_CODE=@CUST_CODE)
			 -- AND (@CUST_CODE='' OR (q.CUSTOMER_CODE=@CUST_CODE OR R.user_customer_code = @CUST_CODE OR R.mobile=@CUST_CODE) )  
			  AND   Q.CM_ID <> @CCNID  
			  UNION
			  SELECT P.ADJ_MEMO_ID       
			  FROM PAYMODE_XN_DET P   (NOLOCK)   
			  JOIN ARC01106 Q (NOLOCK) ON P.MEMO_ID = Q.ADV_REC_ID  
			  -- JOIN CUSTDYM R (NOLOCK) ON Q.CUSTOMER_CODE = R.customer_code      
			  JOIN @cCustDetails R ON Q.CUSTOMER_CODE = R.customer_code 
			  WHERE P.PAYMODE_CODE = '0000002'      
			  AND   Q.CANCELLED = 0    
			 ---- AND (@CUST_CODE='' OR q.CUSTOMER_CODE=@CUST_CODE)  
			 -- AND (@CUST_CODE='' OR (q.CUSTOMER_CODE=@CUST_CODE OR R.user_customer_code = @CUST_CODE OR R.mobile=@CUST_CODE) )  
			  AND   Q.ADV_REC_ID <> @CCNID   
	
			)P1 ON P1.ADJ_MEMO_ID=ARC.ADV_REC_ID 
				WHERE  CANCELLED=0  
				AND (@CCNID='' OR  ARC.ADV_REC_NO=@CCNID)
				AND ISNULL(P1.ADJ_MEMO_ID,'')=''
				AND ARC.ARCT=2
				and arc.adv_rec_dt>=@cCutoffDate
				group by ADV_REC_NO ,ADV_REC_ID ,ADV_REC_DT,ARC.ref_no,ISNULL(ARC.location_Code,LEFT(ARC.ADV_REC_ID,2))

		    SELECT CM_NO,CM_ID,CM_DT,SUM(AMOUNT) AMOUNT,[BIT],ref_no,ADJ_LOCATION_CODE 
			FROM #TEMP 
			GROUP BY CM_NO,CM_ID,CM_DT,[BIT],ref_no,ADJ_LOCATION_CODE
		END		
		END
		ELSE
		BEGIN
			IF @NMODE=1 -- FOR CREDIT NOTE
			BEGIN
 			SELECT  CM_NO,CM_ID,CM_DT,ABS(PAY.AMOUNT) AS AMOUNT,0 [BIT], LEFT(CMM.CM_ID,2) AS ADJ_LOCATION_CODE
				FROM CMM01106 CMM(NOLOCK)
				--JOIN CUSTDYM R (NOLOCK) ON CMM.CUSTOMER_CODE = R.customer_code 
				JOIN @cCustDetails R ON CMM.CUSTOMER_CODE = R.customer_code 
				JOIN PAYMODE_XN_DET PAY(NOLOCK) ON PAY.memo_id=CMM.CM_ID AND PAY.amount<0
				LEFT JOIN
				(
				  SELECT P.ADJ_MEMO_ID       
				  FROM PAYMODE_XN_DET P (NOLOCK)     
				  JOIN CMM01106 Q (NOLOCK) ON P.MEMO_ID = Q.CM_ID  
				  --JOIN CUSTDYM R (NOLOCK) ON Q.CUSTOMER_CODE = R.customer_code     
				  JOIN @cCustDetails R  ON Q.CUSTOMER_CODE = R.customer_code 
				  WHERE P.PAYMODE_CODE = '0000001'      
				  AND   Q.CANCELLED = 0    
				  --AND (@CUST_CODE='' OR (q.CUSTOMER_CODE=@CUST_CODE OR R.user_customer_code = @CUST_CODE OR R.mobile=@CUST_CODE) )  
				  AND   Q.CM_ID <> @CCNID  
			  
				  UNION ALL  
			    
				  SELECT P.ADJ_MEMO_ID       
				  FROM PAYMODE_XN_DET P (NOLOCK)     
				  JOIN ARC01106 Q (NOLOCK) ON P.MEMO_ID = Q.ADV_REC_ID  
				  --JOIN CUSTDYM R (NOLOCK) ON Q.CUSTOMER_CODE = R.customer_code         
				  JOIN @cCustDetails R  ON Q.CUSTOMER_CODE = R.customer_code 
				  WHERE P.PAYMODE_CODE = '0000001'      
				  AND   Q.CANCELLED = 0      
				  --AND (@CUST_CODE='' OR (q.CUSTOMER_CODE=@CUST_CODE OR R.user_customer_code = @CUST_CODE OR R.mobile=@CUST_CODE) )  
				  AND   Q.ADV_REC_ID <> @CCNID  

				  
				)P1 ON P1.ADJ_MEMO_ID=CMM.CM_ID 
				WHERE PAY.PAYMODE_CODE IN ('0000004')
					AND SUBSTRING(CM_NO,3+LEN(CMM.location_code),1)='N' 
					AND CANCELLED=0  
					AND (@CCNID='' OR  CMM.CM_NO=@CCNID)
					AND ISNULL(P1.ADJ_MEMO_ID,'')=''
					--AND (@CUST_CODE='' OR CMM.CUSTOMER_CODE=@CUST_CODE)
					 --AND (@CUST_CODE='' OR (CMM.CUSTOMER_CODE=@CUST_CODE OR R.user_customer_code = @CUST_CODE OR R.mobile=@CUST_CODE) )  
					and cmm.CM_DT>=@cCutoffDate

			END
		
		 IF @NMODE=2 -- FOR ADVANCE
			BEGIN
				SELECT ADV_REC_NO AS CM_NO,ADV_REC_ID AS CM_ID,ADV_REC_DT AS CM_DT,ABS(sum(PAY.AMOUNT)) AS AMOUNT,0 [BIT],ARC.ref_no,
				LEFT(ARC.ADV_REC_ID,2) AS ADJ_LOCATION_CODE
				INTO #TEMP1
				FROM ARC01106 ARC(NOLOCK)
				--JOIN CUSTDYM R (NOLOCK) ON ARC.CUSTOMER_CODE = R.customer_code 
				JOIN @cCustDetails R  ON ARC.CUSTOMER_CODE = R.customer_code 
				JOIN PAYMODE_xN_DET PAY(NOLOCK) ON PAY.memo_id=ARC.ADV_REC_ID  
				LEFT JOIN
				(
				  SELECT P.ADJ_MEMO_ID       
				  FROM PAYMODE_XN_DET P (NOLOCK)     
				  JOIN CMM01106 Q (NOLOCK) ON P.MEMO_ID = Q.CM_ID  
				   --JOIN CUSTDYM R (NOLOCK) ON Q.CUSTOMER_CODE = R.customer_code      
				   JOIN @cCustDetails R  ON Q.CUSTOMER_CODE = R.customer_code 
				  WHERE P.PAYMODE_CODE = '0000002'      
				  AND   Q.CANCELLED = 0      
				 ---- AND (@CUST_CODE='' OR q.CUSTOMER_CODE=@CUST_CODE)
				 -- AND (@CUST_CODE='' OR (q.CUSTOMER_CODE=@CUST_CODE OR R.user_customer_code = @CUST_CODE OR R.mobile=@CUST_CODE) )  
				  AND   Q.CM_ID <> @CCNID  
				  UNION
				  SELECT P.ADJ_MEMO_ID       
				  FROM PAYMODE_XN_DET P   (NOLOCK)   
				  JOIN ARC01106 Q (NOLOCK) ON P.MEMO_ID = Q.ADV_REC_ID  
				  -- JOIN CUSTDYM R (NOLOCK) ON Q.CUSTOMER_CODE = R.customer_code      
				  JOIN @cCustDetails R ON Q.CUSTOMER_CODE = R.customer_code 
				  WHERE P.PAYMODE_CODE = '0000002'      
				  AND   Q.CANCELLED = 0    
				 ---- AND (@CUST_CODE='' OR q.CUSTOMER_CODE=@CUST_CODE)  
				 -- AND (@CUST_CODE='' OR (q.CUSTOMER_CODE=@CUST_CODE OR R.user_customer_code = @CUST_CODE OR R.mobile=@CUST_CODE) )  
				  AND   Q.ADV_REC_ID <> @CCNID   
	
				)P1 ON P1.ADJ_MEMO_ID=ARC.ADV_REC_ID 
					WHERE  CANCELLED=0  
					AND (@CCNID='' OR  ARC.ADV_REC_NO=@CCNID)
					AND ISNULL(P1.ADJ_MEMO_ID,'')=''
					AND ARC.ARCT=2
					and arc.adv_rec_dt>=@cCutoffDate
					group by ADV_REC_NO ,ADV_REC_ID ,ADV_REC_DT,ARC.ref_no,LEFT(ARC.ADV_REC_ID,2)

				SELECT CM_NO,CM_ID,CM_DT,SUM(AMOUNT) AMOUNT,[BIT],ref_no,ADJ_LOCATION_CODE 
				FROM #TEMP1 
				GROUP BY CM_NO,CM_ID,CM_DT,[BIT],ref_no,ADJ_LOCATION_CODE
			END	
		END
END

