create PROCEDURE VALIDATEXN_CHECKSUM
(
		@CXNID VARCHAR(40),
		@CSPID VARCHAR(50),	
		@ckeyfielname varchar(20),				
		@CCMD VARCHAR(1000) OUTPUT
)
AS
BEGIN

  set @CCMD=''
 BEGIN TRY 

      IF NOT EXISTS (SELECT TOP 1 'U' FROM  XNTYPE_CHECKSUM_MST  (nolock) WHERE SP_ID=@CSPID)
	  BEGIN
		  SET @CCMD='No Record found in check sum upload tables  '
		  RETURN
	  END

	  DECLARE @CTABLENAME VARCHAR(100),@NROWCOUNT NUMERIC(6,0),@DTSQL nvarchar(max),@NAFTERSAVEOWCOUNT NUMERIC(6,0)

	  WHILE EXISTS (SELECT TOP 1 'U' FROM XNTYPE_CHECKSUM_MST (NOLOCK) WHERE SP_ID=@CSPID)
      BEGIN
	      
			  SELECT TOP 1 @CTABLENAME=TABLENAME ,@NROWCOUNT=ROW_COUNT  
			  FROM XNTYPE_CHECKSUM_MST (nolock) WHERE SP_ID=@CSPID


			  if @CTABLENAME in('BILL_BY_BILL_REF','VD_CHQBOOK','VDT01106')
			  begin
			       
				 SET  @DTSQL='  SELECT @NAFTERSAVEOWCOUNT=COUNT(*) FROM '+@CTABLENAME+' A (NOLOCK)
				   JOIN VD01106 B (NOLOCK) ON A.VD_ID =B.VD_ID 
				   WHERE B.VM_ID ='''+@CXNID+''''
				   print @DTSQL +'validate 1'
				   EXEC SP_EXECUTESQL @DTSQL,N'@NAFTERSAVEOWCOUNT NUMERIC(6,0) OUTPUT',@NAFTERSAVEOWCOUNT OUTPUT

			  END
			  ELSE IF @CTABLENAME IN('PAYMENT_RECEIPT_ADJLINK')
			  BEGIN
			       
				   SELECT @NAFTERSAVEOWCOUNT=COUNT(*)  FROM PAYMENT_RECEIPT_ADJLINK A  (NOLOCK)
				   JOIN BILL_BY_BILL_REF B (NOLOCK) ON A.REF_BB_ROW_ID=B.BB_ROW_ID
				   JOIN VD01106 C (NOLOCK) ON C.VD_ID=B.VD_ID WHERE C.VM_ID=@CXNID
				    print @DTSQL +'validate 2'


			  END
			  ELSE IF @CTABLENAME IN('ACC_MEMO_REVERSAL')
			  BEGIN
			       
				   SELECT @NAFTERSAVEOWCOUNT=COUNT(*)  FROM ACC_MEMO_REVERSAL A  (NOLOCK)
				   WHERE a.memo_vm_id=@CXNID
				   print 'validate 3'

			  END
			  ELSE
			  BEGIN

					  SET  @DTSQL='SELECT @NAFTERSAVEOWCOUNT =COUNT(*) FROM '+@CTABLENAME+' WHERE '+@CKEYFIELNAME+'='''+@CXNID+'''  '
					  print @DTSQL+'validate 4'
					  EXEC SP_EXECUTESQL @DTSQL,N'@NAFTERSAVEOWCOUNT NUMERIC(6,0) OUTPUT',@NAFTERSAVEOWCOUNT OUTPUT

			  end

			   IF @CTABLENAME IN('BILL_BY_BILL_REF')
			   BEGIN
			       
				     IF ISNULL(@NROWCOUNT,0)>ISNULL(@NAFTERSAVEOWCOUNT,0)
					  BEGIN
						  SET @CCMD='QUANTITY MISMATCH BEFORE SAVE QTY '+STR(ISNULL(@NROWCOUNT,0))+' AND  AFTER SAVE '+STR(ISNULL(@NAFTERSAVEOWCOUNT,0))+' TABLE '+@CTABLENAME
						  RETURN
					  END


			   END
			   ELSE  
			   IF ISNULL(@NROWCOUNT,0)<>ISNULL(@NAFTERSAVEOWCOUNT,0)
			   BEGIN
				  SET @CCMD='QUANTITY MISMATCH BEFORE SAVE QTY '+STR(ISNULL(@NROWCOUNT,0))+' AND  AFTER SAVE '+STR(ISNULL(@NAFTERSAVEOWCOUNT,0))+' table '+@CTABLENAME
				  RETURN
			   END

			  DELETE A FROM XNTYPE_CHECKSUM_MST A(NOLOCK) WHERE SP_ID =@CSPID AND TABLENAME=@CTABLENAME

	  END


  END TRY  
  BEGIN CATCH
	  print 'enter catch of VALIDATEXN_CHECKSUM '
	  SELECT @CCMD='ERROR MESSAGE IN PROCEDURE VALIDATEXN_CHECKSUM '+CAST(ERROR_MESSAGE() AS VARCHAR(1000))
  END CATCH  

END_PROC:


END