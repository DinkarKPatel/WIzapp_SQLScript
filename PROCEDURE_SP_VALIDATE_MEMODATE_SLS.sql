CREATE PROCEDURE SP_VALIDATE_MEMODATE_SLS--(LocId 3 digit change by Sanjay:06-11-2024)
@CXNTYPE VARCHAR(10),
@nSpId VARCHAR(40)='',
@cKeysTable VARCHAR(100)='',
@CERRORMSG VARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CMASTERTABLENAME VARCHAR(200),@CMAXMEMONO VARCHAR(50),@DMAXMEMODATE DATETIME,@DMINMEMODATE DATETIME,@CCURMEMONO VARCHAR(50)
				   ,@CCMD NVARCHAR(MAX),@CKEYFIELDCOL VARCHAR(100),@CKEYFIELDCOL2 VARCHAR(100),@CKEYDATECOL VARCHAR(50)
				   ,@DMEMODT DATETIME,@NMEMOPREFIXLEN INT,@CMINCMNO VARCHAR(15),@cMemonoCol VARCHAR(20)
				   ,@CFINYEAR VARCHAR(10),@nCurMemoNO NUMERIC(5,0),@nNextMemoNo NUMERIC(5,0),@CNEXTMEMONO VARCHAR(50)
				   ,@NMINCMNO INT,@CWHERECLAUSE VARCHAR(MAX),@CMEMOPREFIX VARCHAR(10),@cMemoDtCol VARCHAR(20)
				   ,@CDONOTENFORCEDAYCLOSE VARCHAR(4),@DMAXMEMODT DATETIME,@cMemonoPrefix VARCHAR(25)
				   ,@cMemoIdCol VARCHAR(20),@cStep VARCHAR(20),@nRightChars NUMERIC(4,0)

BEGIN TRY	
	
	SET @cStep='680.10'				 
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@nSpId,1

	SET @CERRORMSG=''
	
	SET @cStep='680.20'	
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@nSpId,1
		
	SET @CMASTERTABLENAME='sls_cmm01106_upload'
	


	SET @cStep='680.30'
		EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@nSpId,1
	SET @cMemoDtCol='cm_dt'
	
	SET @cStep='680.40'
	SET @cMemoNoCol='cm_no' 
	
	SET @cStep='680.50'
	SET @cMemoIdCol='sp_id'


	SET @cStep='680.60'
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@nSpId,1

	SET @cCmd=N'SELECT @DMEMODT='+@cMemoDtCol+',@CCURMEMONO=ltrim(rtrim('+@cMemonoCol+')) FROM '+@CMASTERTABLENAME+' (NOLOCK) 
				WHERE '+@cMemoIdCol+'='''+@nSpId+''''
	PRINT @cCmd	
	EXEC SP_EXECUTESQL @cCmd,N'@DMEMODT DATETIME OUTPUT,@CCURMEMONO VARCHAR(50) OUTPUT',
	@DMEMODT OUTPUT,@CCURMEMONO OUTPUT

	SET @cStep='680.65'
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@nSpId,1
	SELECT @CFINYEAR='01'+DBO.FN_GETFINYEAR(@DMemoDt)

	SET @cCmd=N'SELECT @NMEMOPREFIXLEN=CHARINDEX(''-'','+@cMemonoCol+'),@cMemonoPrefix=LEFT('+@cMemonoCol+',CHARINDEX(''-'','+@cMemonoCol+'))
				FROM  '+@CMASTERTABLENAME+' (NOLOCK) WHERE '+@cMemoIdCol+'='''+@nSpId+''''
	PRINT @cCmd
	EXEC SP_EXECUTESQL @cCmd,N'@NMEMOPREFIXLEN NUMERIC(2,0) OUTPUT,@cMemonoPrefix VARCHAR(25) OUTPUT',
	@NMEMOPREFIXLEN OUTPUT,@cMemonoPrefix OUTPUT

	SET @cStep='680.70'
	EXEC SP_CHKXNSAVELOG 'SLS',@cStep,0,@nSpId,1

	SET @CCMD=N'SELECT @DMAXMEMODATE=last_cm_dt FROM ['+@cKeysTable+']
	WHERE prefix='''+@cMemonoPrefix+''' AND FINYEAR='''+@CFINYEAR+''''
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD,N'@DMAXMEMODATE DATETIME OUTPUT',@DMAXMEMODATE OUTPUT
			
	IF @DMEMODT<@DMAXMEMODATE
	BEGIN
		SET @CERRORMSG='CURRENT MEMO DATE CANNOT BE LESS THAN - '+CONVERT(VARCHAR,@DMAXMEMODATE,105)
		GOTO END_PROC
	END	

	GOTO END_PROC
END TRY

BEGIN CATCH
	SET @CERRORMSG='Error in Procedure SP_VALIDATE_MEMODATE_SLS at Step#'+@cStep+' '+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH
END_PROC:

END
-----END OF PROCEDURE SP_VALIDATE_MEMODATE_SLS