create PROC SP3S_VALIDATEXN_EDIT_BY_LEVELUSER 
@CXNTYPE VARCHAR(40),
@CMEMOID VARCHAR(100),
@BCANCELXN BIT,
@CUSERCODE CHAR(7),
@CERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CTEXT VARCHAR(10),@CPRODUCTCODE VARCHAR(50),@CMASTERTABLENAME VARCHAR(200),@CKEYFIELD VARCHAR(100),
			@CCMD NVARCHAR(MAX),@NLEVEL INT,@CMEMOIDFOUND VARCHAR(40),
			@CXNMASTERTABLENAME VARCHAR(100),@CXNKEYFIELD VARCHAR(100)
	
	SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)
	
	SELECT TOP 1 @NLEVEL=LEVEL_NO FROM  XN_APPROVAL_CHECKLIST_LEVEL_USERS (NOLOCK) 
	WHERE XN_TYPE=@CXNTYPE AND USER_CODE=@CUSERCODE
	

	IF @CXNTYPE='PUR'
	BEGIN
	    
	   
	    IF EXISTS (SELECT TOP  1 'U' FROM PIM01106 A (NOLOCK) WHERE MRR_ID=@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM PIM01106 A (NOLOCK) WHERE MRR_ID=@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	END
	ELSE
	IF @CXNTYPE='PRT'
	BEGIN
		IF EXISTS (SELECT TOP  1 'U' FROM RMM01106 A (NOLOCK) WHERE RM_ID=@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM RMM01106 A (NOLOCK) WHERE RM_ID =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	END
	ELSE
	IF @CXNTYPE='PTC'
	BEGIN
		SELECT	@CMASTERTABLENAME='PEM01106',@CKEYFIELD='PEM_MEMO_ID' 
		SET @CXNMASTERTABLENAME='PED_XN_APPROVAL'
		SET @CXNKEYFIELD='PED_ROW_ID'
	END
	ELSE
	IF @CXNTYPE='VCH'
	BEGIN
		IF EXISTS (SELECT TOP  1 'U' FROM VM01106 A (NOLOCK) WHERE VM_ID=@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM VM01106 A (NOLOCK) WHERE VM_ID =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	END				
	ELSE
	IF @CXNTYPE='PO'
	BEGIN
		IF EXISTS (SELECT TOP  1 'U' FROM POM01106  A (NOLOCK) WHERE PO_ID =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM POM01106  A (NOLOCK) WHERE PO_ID =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	END
	ELSE
	IF @CXNTYPE='BDGPL'
	BEGIN
		IF EXISTS (SELECT TOP  1 'U' FROM BUDGET_PLAN_MST  A (NOLOCK) WHERE MEMO_NO =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM BUDGET_PLAN_MST  A (NOLOCK) WHERE MEMO_NO =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	END
	ELSE
	IF @CXNTYPE='BUYPL'
	BEGIN
		IF EXISTS (SELECT TOP  1 'U' FROM BUY_PLAN_MST  A (NOLOCK) WHERE MEMO_NO =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM BUY_PLAN_MST  A (NOLOCK) WHERE MEMO_NO =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	END
	ELSE
	IF @CXNTYPE='WSLORD'
	BEGIN
	   declare @CALLOW_TO_EDIT_APPROVED_ORDER varchar(10)
	   
	   SELECT TOP 1 @CALLOW_TO_EDIT_APPROVED_ORDER =VALUE FROM USER_ROLE_DET A(NOLOCK)    
	   JOIN USERS B(NOLOCK) ON A.ROLE_ID=B.ROLE_ID    
	   WHERE USER_CODE=@CUSERCODE --AND USER_CODE<>'0000000'    
	   AND FORM_NAME='frmBuyersOrder_wsl'     
	   AND FORM_OPTION='ALLOW_TO_EDIT_APPROVED_ORDER'  
	 
	if ISNULL(@CALLOW_TO_EDIT_APPROVED_ORDER,'')<>'1'
	begin
	
		IF EXISTS (SELECT TOP  1 'U' FROM BUYER_ORDER_MST  A (NOLOCK) WHERE ORDER_ID =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM BUYER_ORDER_MST  A (NOLOCK) WHERE ORDER_ID =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	  
	 end  
	    
	END
	ELSE
	IF @CXNTYPE='EDT'
	BEGIN
		IF EXISTS (SELECT TOP  1 'U' FROM TBL_EOSS_DISC_SHARE_MST  A (NOLOCK) WHERE ID =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM TBL_EOSS_DISC_SHARE_MST  A (NOLOCK) WHERE ID =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	END
	ELSE
	IF @CXNTYPE='JC'
	BEGIN
		IF EXISTS (SELECT TOP  1 'U' FROM ORD_PLAN_MST  A (NOLOCK) WHERE MEMO_ID =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM ORD_PLAN_MST  A (NOLOCK) WHERE MEMO_ID  =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	END
	ELSE
	IF @CXNTYPE='JW' --temperory Remove
	BEGIN
		IF EXISTS (SELECT TOP  1 'U' FROM jobwork_issue_mst  A (NOLOCK) WHERE issue_id  =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM jobwork_issue_mst  A (NOLOCK) WHERE issue_id =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	END
	ELSE
	IF @CXNTYPE='JW' --temperory Remove
	BEGIN
		IF EXISTS (SELECT TOP  1 'U' FROM jobwork_receipt_mst  A (NOLOCK) WHERE receipt_id =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) =@NLEVEL)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY USER.....CAN NOT '+@CTEXT
	        GOTO END_PROC
	    END
	    
	     IF EXISTS (SELECT TOP  1 'U' FROM jobwork_receipt_mst  A (NOLOCK) WHERE receipt_id =@CMEMOID AND ISNULL(APPROVEDLEVELNO,0) >@NLEVEL-1)
	    BEGIN
	        SET @CERRORMSG='TRANSACTION HAS BEEN APPROVED BY HIGHER LEVEL USER.....CAN NOT '+@CTEXT
		    GOTO END_PROC
	    END
	END
	
END_PROC:
		
END
