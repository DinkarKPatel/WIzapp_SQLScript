CREATE PROCEDURE SP_SEND_MIRROR_DOCPRT_OPT_DATA_NEW
(	
	 @CREQXNID VARCHAR(50)
	,@CTARGETLOCID VARCHAR(5)
	,@CREQCHALLANNO VARCHAR(35)=''
	,@CREQCHALLANFINYEAR VARCHAR(20)=''
	,@BACKNOWLEDGE BIT=0
	,@CERRMSG VARCHAR(1000) OUTPUT
)	
AS
/*
	SP_SEND_MIRROR_DOCPRT_OPT_DATA_NEW : THIS PROCEDURE WILL SEND GROUP DEBIT NOTE. 
*/
BEGIN
	DECLARE @DTSQL NVARCHAR(MAX),@NSPID INT,@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),
	@CTEMPEMPLOYEETABLE VARCHAR(200),@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),
	@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX),@CCUTOFFDATE VARCHAR(20),
	@CTEMPMASTERTABLE VARCHAR(200),@CTEMPDETAILTABLE VARCHAR(200),@CTEMPLMTABLE VARCHAR(200),
	@CTEMPLMPTABLE VARCHAR(200),@CTEMPAREATABLE VARCHAR(200),@CTEMPCITYTABLE VARCHAR(200),
	@BSENDPURINFOLOC BIT,@CTEMPSKUTABLE VARCHAR(500),@CTEMPSKUOHTABLE VARCHAR(500),
	@NTARGETLOCTYPE INT,@BTARGETPURLOC BIT,@CTEMPTABLEDB VARCHAR(100),@CCURDEPTID VARCHAR(5),
	@CHODEPTID VARCHAR(5),@BGETCHALLANTHRUMIRROR BIT,@CPARTYDEPTID VARCHAR(5),@NMODE INT,
	@BEXPORTED BIT,@CDISPATCHDETAILS VARCHAR(1000),@CDONOTSENDCHALLANWODISPATCHDETAILS VARCHAR(2),
	@CJOINSTR VARCHAR(1000),@BTEMPDATADELETED BIT,@BDONOTSENDCHALLANWITHOUTDISPATCH BIT
	
	DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(500),TMP_TABLENAME VARCHAR(500),XN_ID VARCHAR(40))  	
	
 	
	SET @CTEMPTABLEDB = DB_NAME()+'_TEMP.DBO.'
		
BEGIN TRY 	

	---- CALL ACKNOWLEDGEMENT OF MEMO SUCCESSFUL MERGING AT MIRRORING SERVER
	SET @CSTEP=00
	
	
	IF @BACKNOWLEDGE=1
		GOTO LBLTABLEINFO
	
	IF @CREQCHALLANNO=''
	BEGIN
		SELECT @CREQCHALLANNO=RM_NO,@CREQCHALLANFINYEAR=FIN_YEAR FROM RMM01106 WHERE RM_ID=@CREQXNID
		IF ISNULL(@CREQCHALLANNO,'')=''
		BEGIN
			SET @CERRMSG = 'CHALLAN ID:'+@CREQXNID+' NOT FOUND AT HEAD OFFICE '
			GOTO END_PROC
		END	
	END		
	
	IF @CREQCHALLANNO<>''
	BEGIN
		SET @DTSQL=N'SELECT TOP 1 @CMEMOID=A.RM_ID,@DMEMOLASTUPDATE=A.LAST_UPDATE  FROM RMM01106 A 
					 WHERE A.RM_NO='''+@CREQCHALLANNO+''' AND A.FIN_YEAR='''+@CREQCHALLANFINYEAR+''''
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL,N'@CMEMOID VARCHAR(50) OUTPUT,@DMEMOLASTUPDATE DATETIME OUTPUT',
		@CMEMOID OUTPUT,@DMEMOLASTUPDATE OUTPUT
		
		IF ISNULL(@CMEMOID,'')=''
		BEGIN
			SET @CERRMSG = 'CHALLAN NO. :'+@CREQCHALLANNO+' NOT FOUND AT HEAD OFFICE FOR FINANCIAL YEAR :'+@CREQCHALLANFINYEAR
			GOTO END_PROC
		END
		
		SELECT @CPARTYDEPTID=PARTY_DEPT_ID,@NMODE=MODE,@BEXPORTED=EXPORTED,
		@CDISPATCHDETAILS=ANGADIA_DETAIL
		FROM RMM01106 (NOLOCK) WHERE RM_ID=@CMEMOID
		
		
		IF @NMODE<>2
		BEGIN
			SET @CERRMSG = 'MEMO NO. :'+@CREQCHALLANNO+' IS NOT A GROUP TRANSFER CHALLAN'
			GOTO END_PROC
		END
		
		IF @CPARTYDEPTID<>@CTARGETLOCID
		BEGIN
			SET @CERRMSG = 'CHALLAN NO. :'+@CREQCHALLANNO+' IS NOT CREATED FOR TARGET LOCATION :'+@CTARGETLOCID
			GOTO END_PROC
		END
		
		
		
		SELECT @BDONOTSENDCHALLANWITHOUTDISPATCH=ISNULL(DONOTSENDCHALLANWITHOUTDISPATCH,0) FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID 
  
     IF NOT EXISTS (SELECT TOP 1 * FROM PARCEL_DET WHERE REF_MEMO_ID=@CREQXNID) AND @BDONOTSENDCHALLANWITHOUTDISPATCH=1
       BEGIN
			SET @CERRMSG = 'CHALLAN NO. :'+@CREQCHALLANNO+' IS NOT HAVING ANY DISPATCH DETAILS'
			GOTO END_PROC
		END

		----IF @BEXPORTED=0 OR @CDISPATCHDETAILS=''
		----BEGIN
		----	SET @CERRMSG = 'CHALLAN NO. :'+@CREQCHALLANNO+' IS NOT HAVING ANY DISPATCH DETAILS'
		----	GOTO END_PROC
		----END			
	END	
	ELSE
		SET @CMEMOID=@CREQXNID
		
LBLTABLEINFO:

	IF @BACKNOWLEDGE=1
		GOTO END_PROC
	
	SET @CSTEP=80

	SELECT TOP 1 @BSENDPURINFOLOC=UPD_PURINFO,@NTARGETLOCTYPE=LOC_TYPE,@BTARGETPURLOC=PUR_LOC FROM LOCATION (NOLOCK)
	WHERE DEPT_ID=@CTARGETLOCID
	
	IF @BTARGETPURLOC=1 AND @NTARGETLOCTYPE=1
		SET @BSENDPURINFOLOC=1
	
	IF 	@NTARGETLOCTYPE=2
		SET @BSENDPURINFOLOC=0
	
	SET @BSENDPURINFOLOC=ISNULL(@BSENDPURINFOLOC,0)
	SET @CSTEP=70
	---- POPULATE LIST OF TABLES 
		
	PRINT 'SEND CHALLAN DIRECTLY-1'
	
	SET @CFILTERCONDITION=' B.RM_ID='''+@CMEMOID+''''
	SET @CSTEP=80
	
	SELECT 	@CMEMOID AS XN_ID,'DOCPRT_RMM01106_MIRROR'  AS TARGET_TABLENAME,* FROM RMM01106 (NOLOCK) WHERE RM_ID=@CMEMOID		

	SELECT 	'DOCPRT_RMD01106_MIRROR' AS TARGET_TABLENAME,* FROM RMD01106 (NOLOCK) WHERE RM_ID=@CMEMOID		
	
	--BOXM 20 JAN 2018
	SELECT DISTINCT 'DOCPRT_BOXM_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.*
	FROM BOXM A (NOLOCK)
	JOIN 
	( SELECT BOX_ID,RM_ID FROM RMD01106 (NOLOCK) 
	  GROUP BY BOX_ID,RM_ID
	) B ON A.BOX_ID =B.BOX_ID 
	WHERE B.RM_ID =@CMEMOID

	--BOXD 20 JAN 2018
	SELECT DISTINCT 'DOCPRT_BOXD_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.*
	FROM BOXD A (NOLOCK)
	JOIN 
	( SELECT BOX_ID,RM_ID FROM RMD01106 (NOLOCK)
	  GROUP BY BOX_ID,RM_ID
	) B ON A.BOX_ID =B.BOX_ID 
	WHERE B.RM_ID =@CMEMOID
	--BOXD 20 JAN 2018
	
		
	SELECT DISTINCT 'DOCPRT_SKU_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM SKU A (NOLOCK)
	JOIN RMD01106 B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE WHERE RM_ID=@CMEMOID					
		
	SET @CSTEP=110
		
	IF NOT (@BSENDPURINFOLOC=0 OR @NTARGETLOCTYPE=2)
	BEGIN
		SELECT DISTINCT 'DOCPRT_SKU_OH_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM SKU_OH A (NOLOCK)
		JOIN RMD01106 B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE WHERE RM_ID=@CMEMOID					
	END
	
	SELECT DISTINCT	'DOCPRT_ARTICLE_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM ARTICLE A (NOLOCK)
	JOIN SKU B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE
	JOIN RMD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE WHERE RM_ID=@CMEMOID					

	SELECT 	DISTINCT 'DOCPRT_SECTIOND_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM SECTIOND A (NOLOCK)
	JOIN ARTICLE B (NOLOCK) ON B.SUB_SECTION_CODE=A.SUB_SECTION_CODE
	JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE
	JOIN RMD01106 D (NOLOCK) ON D.PRODUCT_CODE=C.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPRT_HSN_MST_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM HSN_MST A(NOLOCK)
	JOIN SKU B (NOLOCK) ON A.HSN_CODE=B.HSN_CODE
	JOIN rmD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE 
	WHERE rm_ID=@CMEMOID					
	UNION
	SELECT 	DISTINCT 'DOCPRT_HSN_MST_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM HSN_MST A(NOLOCK)
	JOIN RMD01106 B (NOLOCK) ON A.HSN_CODE=B.HSN_CODE
	WHERE rm_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT 'DOCPRT_HSN_MST_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM HSN_MST A (NOLOCK)
	JOIN ARTICLE C (NOLOCK) ON C.HSN_CODE=A.HSN_CODE
	JOIN SECTIOND B (NOLOCK) ON B.SUB_SECTION_CODE=C.SUB_SECTION_CODE
	JOIN SKU D (NOLOCK) ON D.ARTICLE_CODE=C.ARTICLE_CODE
	JOIN RMD01106 E (NOLOCK) ON E.PRODUCT_CODE=D.PRODUCT_CODE
	WHERE rm_ID=@CMEMOID

	
	SELECT 	DISTINCT 'DOCPRT_HSN_DET_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM HSN_DET A (NOLOCK)
	
	JOIN ARTICLE C (NOLOCK) ON C.HSN_CODE=A.HSN_CODE
	JOIN SECTIOND B (NOLOCK) ON B.SUB_SECTION_CODE=C.SUB_SECTION_CODE
	JOIN SKU D (NOLOCK) ON D.ARTICLE_CODE=C.ARTICLE_CODE
	JOIN RMD01106 E (NOLOCK) ON E.PRODUCT_CODE=D.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID
	
	
	SELECT 	DISTINCT 'DOCPRT_SECTIONM_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM SECTIONM A (NOLOCK)
	JOIN SECTIOND B (NOLOCK) ON B.SECTION_CODE=A.SECTION_CODE
	JOIN ARTICLE C (NOLOCK) ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE
	JOIN SKU D (NOLOCK) ON D.ARTICLE_CODE=C.ARTICLE_CODE
	JOIN RMD01106 E (NOLOCK) ON E.PRODUCT_CODE=D.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPRT_PARA1_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM PARA1 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA1_CODE=A.PARA1_CODE
	JOIN RMD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPRT_PARA2_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM PARA2 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA2_CODE=A.PARA2_CODE
	JOIN RMD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPRT_PARA3_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM PARA3 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA3_CODE=A.PARA3_CODE
	JOIN RMD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPRT_PARA4_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM PARA4 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA4_CODE=A.PARA4_CODE
	JOIN RMD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPRT_PARA5_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM PARA5 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA5_CODE=A.PARA5_CODE
	JOIN RMD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPRT_PARA6_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM PARA6 A (NOLOCK)
	JOIN SKU B (NOLOCK) ON B.PARA6_CODE=A.PARA6_CODE
	JOIN RMD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPRT_ART_ATTR_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM ART_ATTR A (NOLOCK)
	JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE
	JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE
	JOIN RMD01106 D (NOLOCK) ON D.PRODUCT_CODE=C.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID

	SELECT 	DISTINCT 'DOCPRT_ATTR_KEY_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM ATTR_KEY A (NOLOCK)
	JOIN ART_ATTR B (NOLOCK) ON B.KEY_CODE=A.KEY_CODE
	JOIN ARTICLE C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE
	JOIN SKU D (NOLOCK) ON D.ARTICLE_CODE=C.ARTICLE_CODE
	JOIN RMD01106 E (NOLOCK) ON E.PRODUCT_CODE=D.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID	

	SELECT 	DISTINCT 'DOCPRT_ATTRM_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM ATTRM A (NOLOCK)
	JOIN ATTR_KEY B (NOLOCK) ON B.ATTRIBUTE_CODE=A.ATTRIBUTE_CODE
	JOIN ART_ATTR C (NOLOCK) ON C.KEY_CODE=B.KEY_CODE
	JOIN ARTICLE D (NOLOCK) ON D.ARTICLE_CODE=C.ARTICLE_CODE
	JOIN SKU E (NOLOCK) ON E.ARTICLE_CODE=D.ARTICLE_CODE
	JOIN RMD01106 F (NOLOCK) ON F.PRODUCT_CODE=E.PRODUCT_CODE
	WHERE RM_ID=@CMEMOID	

	SELECT 	DISTINCT 'DOCPRT_FORM_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
	FROM FORM A (NOLOCK)
	JOIN RMD01106 B (NOLOCK) ON A.FORM_ID=B.ITEM_FORM_ID
	WHERE RM_ID=@CMEMOID AND B.ITEM_FORM_ID<>'0000000' 
	
	IF @BSENDPURINFOLOC=1
	BEGIN
		SELECT 	DISTINCT 'DOCPRT_LM01106_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
		FROM LM01106 A (NOLOCK)
		JOIN SKU B (NOLOCK) ON A.AC_CODE=B.AC_CODE
		JOIN RMD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
		WHERE RM_ID=@CMEMOID					

		SELECT 	DISTINCT 'DOCPRT_LMP01106_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* 
		FROM LMP01106 A (NOLOCK)
		JOIN SKU B (NOLOCK) ON A.AC_CODE=B.AC_CODE
		JOIN RMD01106 C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
		WHERE RM_ID=@CMEMOID					
		
		SELECT 	DISTINCT 'DOCPRT_HD01106_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM HD01106 A (NOLOCK)
		JOIN LM01106 B (NOLOCK) ON A.HEAD_CODE=B.HEAD_CODE
		JOIN SKU C (NOLOCK) ON C.AC_CODE=B.AC_CODE
		JOIN RMD01106 D (NOLOCK) ON D.PRODUCT_CODE=C.PRODUCT_CODE
		WHERE RM_ID=@CMEMOID					
		
		SELECT 	DISTINCT 'DOCPRT_AREA_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM AREA A (NOLOCK)
		JOIN LMP01106 B (NOLOCK) ON B.AREA_CODE=A.AREA_CODE
		JOIN SKU C (NOLOCK) ON C.AC_CODE=B.AC_CODE
		JOIN RMD01106 D (NOLOCK) ON D.PRODUCT_CODE=C.PRODUCT_CODE
		WHERE RM_ID=@CMEMOID					

		SELECT 	DISTINCT 'DOCPRT_CITY_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM CITY A (NOLOCK)
		JOIN AREA B (NOLOCK) ON A.CITY_CODE=B.CITY_CODE
		JOIN LMP01106 C (NOLOCK) ON C.AREA_CODE=B.AREA_CODE
		JOIN SKU D (NOLOCK) ON D.AC_CODE=C.AC_CODE
		JOIN RMD01106 E (NOLOCK) ON E.PRODUCT_CODE=D.PRODUCT_CODE
		WHERE RM_ID=@CMEMOID					

		SELECT 	DISTINCT 'DOCPRT_STATE_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM STATE A (NOLOCK)
		JOIN CITY B (NOLOCK) ON A.STATE_CODE=B.STATE_CODE
		JOIN AREA C (NOLOCK) ON C.CITY_CODE=B.CITY_CODE
		JOIN LMP01106 D (NOLOCK) ON D.AREA_CODE=C.AREA_CODE
		JOIN SKU E (NOLOCK) ON E.AC_CODE=D.AC_CODE
		JOIN RMD01106 F (NOLOCK) ON F.PRODUCT_CODE=E.PRODUCT_CODE
		WHERE RM_ID=@CMEMOID					
	END
			
	SELECT 	DISTINCT 'DOCPRT_PARCEL_MST_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM PARCEL_MST A (NOLOCK)
	JOIN PARCEL_DET B (NOLOCK) ON B.PARCEL_MEMO_ID=A.PARCEL_MEMO_ID
	WHERE B.REF_MEMO_ID=@CMEMOID AND A.XN_TYPE='PRT'
			
	SELECT 	DISTINCT 'DOCPRT_PARCEL_DET_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS DOCPRT_MEMO_ID,A.* FROM PARCEL_DET A (NOLOCK)
	JOIN PARCEL_MST C (NOLOCK) ON C.PARCEL_MEMO_ID=A.PARCEL_MEMO_ID
	WHERE A.REF_MEMO_ID=@CMEMOID AND C.XN_TYPE='PRT'



	GOTO END_PROC
		

END TRY

BEGIN CATCH
	SET @CERRMSG='P: SP_SEND_MIRROR_DOCPRT_OPT_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 		

END_PROC:
	
END
---END OF PROCEDURE - SP_SEND_MIRROR_DOCPRT_OPT_DATA_NEW
