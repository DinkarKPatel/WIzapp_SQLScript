CREATE PROCEDURE SP_SEND_MIRROR_JWR_DATA_NEW  
(   
  @CUPLOADEDXNID VARCHAR(50)  
 ,@CCURLOCID VARCHAR(5)  
 ,@BACKNOWLEDGE BIT=0    
 ,@CERRMSG VARCHAR(1000) OUTPUT  
)  
--WITH ENCRYPTION  
AS  
BEGIN  
     DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION VARCHAR(MAX),  
             @CMEMOID VARCHAR(50),@DMEMOLASTUPDATE DATETIME,  
             @CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPMASTERTABLE VARCHAR(100),  
             @CTEMPDETAILTABLE VARCHAR(100),@BRECFOUND BIT  
       
       
    
BEGIN TRY  
     DECLARE @CTEMPDBNAME VARCHAR(100)  
 

  set @CTEMPDBNAME=''
  SET @CMEMOID=@CUPLOADEDXNID  
  SET @CSTEP=00  
 
    SET @CSTEP=40  
 ---- IF NO MEMO FOUND , JUST END THE PROCESS  
 IF ISNULL(@CMEMOID,'')=''  
  GOTO END_PROC  
   
 LBLTABLEINFO:  
    
 SET @CSTEP=220  
 ---- SEND THE JWR MEMO MASTER TABLE  
  SELECT A.*,'JWR_JOBWORK_RECEIPT_MST_UPLOAD' AS TARGET_TABLENAME FROM JOBWORK_RECEIPT_MST A (NOLOCK) WHERE RECEIPT_ID=@CMEMOID 
   
 SET @CSTEP=250  
 ---- SEND THE JWR MEMO DETAIL TABLE  
 SELECT A.*,'JWR_JOBWORK_RECEIPT_DET_UPLOAD' AS TARGET_TABLENAME FROM JOBWORK_RECEIPT_DET A (NOLOCK) WHERE RECEIPT_ID=@CMEMOID 
    
 
  SET @CSTEP=251 
 ---- SEND THE PMT01106 TABLE  
  SELECT DISTINCT 'JWR_PMT01106_UPLOAD' AS TARGET_TABLENAME, @CMEMOID AS JWR_MEMO_ID ,A.DEPT_ID,A.product_code,A.BIN_ID,A.quantity_in_stock  
	  FROM PMT01106 A (NOLOCK)  
	  JOIN JOBWORK_RECEIPT_DET B (NOLOCK) ON B.product_code=A.product_code
	  WHERE B.receipt_id=@CMEMOID 


 GOTO END_PROC  
   
 END TRY  
BEGIN CATCH  
 SET @CERRMSG='P: SP_SEND_MIRROR_JWR_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
 GOTO END_PROC  
END CATCH    
   
END_PROC:  
 
END  