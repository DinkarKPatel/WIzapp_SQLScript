create  PROCEDURE SP_JOBWORK_REPORT_PCS  

(  
 @CAGENCY_CODE VARCHAR(100)='',  
 @NPENDING INT=0,
 @NSUMMARY INT=0,  -- 1 FOR SUMMARY 2 FOR DETAILS
 @CARTICLE_CODE VARCHAR(10)='',
 @DAS_ON DATETIME=''
)  
AS  
BEGIN  
   --(dinkar) Replace  left(memoid,2) to Location_code     
      DECLARE @DTSQL NVARCHAR(MAX),@AC_CODE VARCHAR(100)  
     IF @CAGENCY_CODE=''  
     BEGIN  
     SET @AC_CODE=''  
     SET @CAGENCY_CODE='IN('''')'  
     END  
     ELSE   
     BEGIN  
     SET @AC_CODE='LATER'  
     END  
        
     IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL  
        DROP TABLE #TMPISSUE  
  
     
     SELECT A.AGENCY_CODE ,AM.AGENCY_NAME ,ART.ARTICLE_NO AS FG_ARTICLE_NO ,
            ART.ARTICLE_NAME AS FG_ARTICLE_NAME,
            P1.PARA1_NAME ,P2.PARA2_NAME ,B.ROW_ID ,B.QUANTITY AS ISSUE_QTY,
            ISNULL(C.QUANTITY,0) AS REC_QTY ,
            CAST('' AS VARCHAR(15)) AS ORDER_NO,
            B.PRODUCT_CODE  
     into #TMPISSUE
     FROM JOBWORK_ISSUE_MST  A (NOLOCK)
     JOIN JOBWORK_ISSUE_DET B ON A.ISSUE_ID =B.ISSUE_ID 
     JOIN PRD_AGENCY_MST AM (NOLOCK) ON A.AGENCY_CODE=AM.AGENCY_CODE 
     JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =B.PRODUCT_CODE 
     JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
     JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE 
     JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE 
     LEFT JOIN JOBWORK_RECEIPT_DET C (NOLOCK) ON B.ROW_ID =C.REF_ROW_ID 
     LEFT JOIN JOBWORK_RECEIPT_MST D (NOLOCK) ON C.RECEIPT_ID =D.RECEIPT_ID 
     WHERE A.CANCELLED =0 AND ISNULL(D.CANCELLED ,0)=0
     and 1=2
     
     set @DTSQL=N' SELECT A.AGENCY_CODE ,AM.AGENCY_NAME ,ART.ARTICLE_NO ,ART.ARTICLE_NAME,
            P1.PARA1_NAME ,P2.PARA2_NAME ,B.ROW_ID ,B.QUANTITY AS ISSUE_QTY,
            ISNULL(C.QUANTITY,0) AS REC_QTY ,
            '''' AS ORDER_NO ,
            B.PRODUCT_CODE
     FROM JOBWORK_ISSUE_MST  A (NOLOCK)
     JOIN JOBWORK_ISSUE_DET B ON A.ISSUE_ID =B.ISSUE_ID 
     JOIN PRD_AGENCY_MST AM (NOLOCK) ON A.AGENCY_CODE=AM.AGENCY_CODE 
     JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =B.PRODUCT_CODE 
     JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
     JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE 
     JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE 
     LEFT JOIN JOBWORK_RECEIPT_DET C (NOLOCK) ON B.ROW_ID =C.REF_ROW_ID 
     LEFT JOIN JOBWORK_RECEIPT_MST D (NOLOCK) ON C.RECEIPT_ID =D.RECEIPT_ID 
     WHERE A.CANCELLED =0 AND ISNULL(D.CANCELLED ,0)=0 
     AND ('''+@AC_CODE+'''='''' OR AM.AC_CODE  '+@CAGENCY_CODE+' )  
     AND ('''+@CARTICLE_CODE+'''='''' OR ART.ARTICLE_CODE='''+@CARTICLE_CODE+''')  
     AND ('''+CONVERT(VARCHAR(10), @DAS_ON,121)+'''=''1900-01-01'' OR A.issue_dt<='''+CONVERT(VARCHAR(10), @DAS_ON,121)+''')    
     
     '
     PRINT @DTSQL
     INSERT INTO #TMPISSUE
     EXEC (@DTSQL)
     
    -- SET @NSUMMARY=1
   
   IF ISNULL(@NSUMMARY,0)=1
   BEGIN
	   SELECT A.AGENCY_NAME,  
			  A.FG_ARTICLE_NO,  
			  A.FG_ARTICLE_NAME,  
			  A.PARA1_NAME AS FG_COLOR,  
			  A.PARA2_NAME AS FG_SIZE,  
	   SUM(A.ISSUE_QTY) AS ISSUE_QTY ,  
	   SUM(ISNULL(A.REC_QTY,0)) AS REC_QTY,  
	   SUM(A.ISSUE_QTY)-SUM(ISNULL(A.REC_QTY,0)) AS PENDING_QTY  
	   FROM #TMPISSUE A  
	   WHERE (@NPENDING=0 OR  A.ISSUE_QTY-ISNULL(A.REC_QTY,0) >0)
	   GROUP BY A.AGENCY_NAME,  
			  A.FG_ARTICLE_NO,  
			  A.FG_ARTICLE_NAME,  
			  A.PARA1_NAME ,  
			  A.PARA2_NAME 
	   ORDER BY AGENCY_NAME  
  END
  ELSE
  BEGIN
       
       
   UPDATE A SET ORDER_NO=MST.MEMO_NO--ORDER NO DISPLY JOB CARD NO 
   FROM #TMPISSUE A     
   JOIN
  (
    SELECT C.PRODUCT_CODE,A.MEMO_NO,A.MEMO_DT,
           ISNULL(BM.ORDER_NO,'''') AS  ORDER_NO,
           ISNULL(BM.ORDER_DT,'''') AS  ORDER_DT,
           ISNULL(BM.ORDER_ID,'''') AS  ORDER_ID
    FROM ORD_PLAN_MST A (NOLOCK)
    JOIN ORD_PLAN_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
    JOIN ORD_PLAN_BARCODE_DET C (NOLOCK) ON B.ROW_ID=C.REFROW_ID
    LEFT JOIN BUYER_ORDER_DET BD (NOLOCK) ON BD.ROW_ID=WOD_ROW_ID
    LEFT JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID=BD.ORDER_ID
    WHERE A.CANCELLED=0 AND ISNULL(BM.CANCELLED,0)=0
  ) MST ON A.PRODUCT_CODE=MST.PRODUCT_CODE
  LEFT OUTER JOIN JOBWORK_PMT UPC ON UPC.PRODUCT_CODE =A.PRODUCT_CODE 
  LEFT OUTER JOIN BUYER_ORDER_MST BO ON BO.ORDER_ID= ISNULL(UPC.ORDER_ID ,MST.ORDER_ID )     
       
       SELECT A.ORDER_NO ,
			  A.AGENCY_NAME,  
			  A.FG_ARTICLE_NO,  
			  A.FG_ARTICLE_NAME,  
			  A.PARA1_NAME AS FG_COLOR,  
			  A.PARA2_NAME AS FG_SIZE,  
	   SUM(A.ISSUE_QTY) AS ISSUE_QTY ,  
	   SUM(ISNULL(A.REC_QTY,0)) AS REC_QTY,  
	   SUM(A.ISSUE_QTY)-SUM(ISNULL(A.REC_QTY,0)) AS PENDING_QTY  
	   FROM #TMPISSUE A  
	   WHERE (@NPENDING=0 OR  A.ISSUE_QTY-ISNULL(A.REC_QTY,0) >0)
	   GROUP BY A.ORDER_NO ,A.AGENCY_NAME,  A.FG_ARTICLE_NO,  
	   A.FG_ARTICLE_NAME,  A.PARA1_NAME ,A.PARA2_NAME
	   ORDER BY AGENCY_NAME  
	   
	   
  
  END        
END
