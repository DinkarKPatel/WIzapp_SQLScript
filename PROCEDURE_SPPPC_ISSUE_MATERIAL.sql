
create PROCEDURE SPPPC_ISSUE_MATERIAL
(  
 @NQUERYID INT=0,  
 @CMEMO_ID VARCHAR(100)='',  
 @CAC_NAME  VARCHAR(100)='',  
 @CBILL_NO VARCHAR(50)='',  
 @CROW_ID VARCHAR(100)='',  
 @CJOB_CODE VARCHAR(10)='',  
 @CARTICLE_CODE VARCHAR(10)='',  
 @CFIN_YEAR VARCHAR(5)='',  
 @NARTICLE_TYPE INT=0,  
 @CUSER_CODE CHAR(10)=''  ,
 @DFM_DT DATETIME ='',
 @DTO_DT DATETIME=''
)  
AS  
BEGIN  
  
--DROP TABLE TMP  
--SELECT @NARTICLE_TYPE AS A  
--INTO TMP  
  
--SELECT * FROM TMP  
  
   DECLARE @CCONSUMEFREESTOCK VARCHAR(10)  
   SET @CCONSUMEFREESTOCK=0  
    
   SELECT @CCONSUMEFREESTOCK=VALUE  FROM USER_ROLE_DET A  
   JOIN USER_ROLE_MST B ON A.ROLE_ID =B.ROLE_ID   
   JOIN USERS U ON U.ROLE_ID =B.ROLE_ID   
   WHERE GROUP_NAME='TRANSACTION' AND FORM_NAME ='FIRSTJOBORDER.ASPX'  
   AND DISPLAY_NAME='ALLOW CONSUMPTION OF UNALLOACATED STOCK'  
   AND U.USER_CODE =@CUSER_CODE  
   --SET @CCONSUMEFREESTOCK=1  
   
   IF @NQUERYID<>1 OR (@NQUERYID=1 AND (@CMEMO_ID<>'' OR @CAC_NAME<>'' OR @CBILL_NO<>''))
   SET @DFM_DT=''
     
    IF @NQUERYID IN (1,2,3,4)  
    BEGIN  
          
          
    IF OBJECT_ID('TEMPDB..#TMPPRODUCT','U') IS NOT NULL  
    DROP TABLE #TMPPRODUCT  
            
   SELECT DET.ORDER_DT, DET.ORDER_NO, JOB.MEMO_ID,JOB.MEMO_NO,JOB.MEMO_DT, JOB.AC_CODE,  
      LM.AC_NAME,DET.BILL_NO,  
    B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,  
    SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,  
    SKU.PARA1_CODE,P1.PARA1_NAME,  
    SKU.PARA2_CODE,P2.PARA2_NAME,  
    SKU.PARA3_CODE,P3.PARA3_NAME ,  
    SKU.PRODUCT_CODE,  
    DET.ROW_ID,  
    JOB_CODE,  
    JOB.QUANTITY AS QUANTITY,  
    DET.ORDER_ID  
      INTO #TMPPRODUCT  
   FROM PPC_FGBCG_MST A  (NOLOCK)
   JOIN PPC_FGBCG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID   
   JOIN PPC_FG_SKU SKU (NOLOCK) ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID   
   JOIN  
   (  
      SELECT  A.ORDER_ID, B.ORDER_DT, B.ORDER_NO, B.AC_CODE,A.ARTICLE_CODE ,  
             ROW_ID,B.BILL_NO 
      FROM PPC_BUYER_ORDER_DET A (NOLOCK)  
      JOIN PPC_BUYER_ORDER_MST B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID  
      WHERE B.CANCELLED=0  
     GROUP BY A.ORDER_ID,B.ORDER_DT, B.ORDER_NO,B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO  
   ) DET ON DET.ROW_ID=B.BO_DET_ROW_ID   
   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =B.ARTICLE_CODE   
   JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE   
   JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE   
   JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE =SKU.PARA3_CODE   
   JOIN PPC_SIZEGROUP SG (NOLOCK) ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE   
   JOIN  
   (  
    SELECT B.AC_CODE, A.MEMO_ID,B.MEMO_NO,B.MEMO_DT, JOB_CODE, PRODUCT_CODE,A.QUANTITY  
    FROM PPC_AGENCY_ISSUE_FG_FIRST_DET  A  (NOLOCK) 
    JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID   
    WHERE B.CANCELLED=0 AND APPROVED=1 AND ISNULL(B.MEMO_TYPE,0) IN(0,1)  
    AND (@CMEMO_ID='' OR  A.MEMO_ID=@CMEMO_ID) 
    and (@DFM_DT='' or B.memo_dt between @DFM_DT and @DTO_DT)  
    UNION ALL
    --CHANGES
    SELECT B.AC_CODE, A.MEMO_ID,B.MEMO_NO,B.MEMO_DT, JOB_CODE, PRODUCT_CODE,A.QUANTITY  
    FROM PPC_AGENCY_ISSUE_FG_DET  A  (NOLOCK) 
    JOIN PPC_AGENCY_ISSUE_FG_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID   
    WHERE B.CANCELLED=0 AND APPROVED=1 AND ISNULL(B.MEMO_TYPE,0) IN(0,1)  
    AND (@CMEMO_ID='' OR  A.MEMO_ID=@CMEMO_ID)  
    and (@DFM_DT='' or B.memo_dt between @DFM_DT and @DTO_DT)
   ) JOB ON JOB.PRODUCT_CODE =SKU.PRODUCT_CODE  
   JOIN LM01106 LM ON LM.AC_CODE =JOB.AC_CODE   
   WHERE  
    (@CAC_NAME='' OR LM.AC_NAME=@CAC_NAME)  
    AND(@CBILL_NO='' OR DET.BILL_NO=@CBILL_NO)     
       
       
   --     UNION ALL  
   --     SELECT DET.ORDER_DT, DET.ORDER_NO, JOB.MEMO_ID,JOB.MEMO_NO,JOB.MEMO_DT, JOB.AC_CODE,  
   --   LM.AC_NAME,DET.BILL_NO,  
   -- B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,  
   -- SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,  
   -- SKU.PARA1_CODE,P1.PARA1_NAME,  
   -- SKU.PARA2_CODE,P2.PARA2_NAME,  
   -- SKU.PARA3_CODE,P3.PARA3_NAME ,  
   -- SKU.PRODUCT_CODE,  
   -- DET.ROW_ID,  
   -- JOB_CODE,  
   -- JOB.QUANTITY AS QUANTITY,  
   -- DET.ORDER_ID  
   --FROM PPC_FGBCG_MST A (NOLOCK)  
   --JOIN PPC_FGBCG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID   
   --JOIN PPC_FG_SKU SKU (NOLOCK) ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID   
   --JOIN  
   --(  
   --    SELECT  A.ORDER_ID, B.ORDER_DT, B.ORDER_NO, B.AC_CODE,A.ARTICLE_CODE ,  
   --            ROW_ID,B.BILL_NO 
   -- FROM PPC_BUYER_ORDER_DET A (NOLOCK) 
   -- JOIN PPC_BUYER_ORDER_MST B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID  
   -- WHERE B.CANCELLED=0  
   --  GROUP BY A.ORDER_ID,B.ORDER_DT, B.ORDER_NO,B.AC_CODE,A.ARTICLE_CODE ,ROW_ID,B.BILL_NO  
   --) DET ON DET.ROW_ID=B.BO_DET_ROW_ID   
   --JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE   
   --JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE   
   --JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE   
   --JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE =SKU.PARA3_CODE   
   --JOIN PPC_SIZEGROUP SG (NOLOCK) ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE   
   --JOIN  
   --(  
   -- SELECT B.AC_CODE, A.MEMO_ID,B.MEMO_NO,B.MEMO_DT, JOB_CODE, PRODUCT_CODE,A.QUANTITY  
   -- FROM PPC_AGENCY_ISSUE_FG_DET  A  (NOLOCK) 
   -- JOIN PPC_AGENCY_ISSUE_FG_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID   
   -- WHERE B.CANCELLED=0 AND APPROVED=1 AND ISNULL(B.MEMO_TYPE,0) IN(0,1)  
   -- AND (@CMEMO_ID='' OR  A.MEMO_ID=@CMEMO_ID)  
   --) JOB ON JOB.PRODUCT_CODE =SKU.PRODUCT_CODE  
   --      JOIN LM01106 LM ON LM.AC_CODE =JOB.AC_CODE   
       
   
  --CREATE INDEX IX_TMPPRODUCT_ROW_ID ON #TMPPRODUCT(ROW_ID)  
  --CREATE INDEX IX_TMPPRODUCT_JOB_CODE ON #TMPPRODUCT(JOB_CODE)  
    
  IF OBJECT_ID('TEMPDB..#TMPCONSUME','U') IS NOT NULL  
   DROP TABLE #TMPCONSUME  
    
  --SELECT  A.ORDER_DT, A.ORDER_NO,A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.AC_CODE,A.AC_NAME,  
  --A.BILL_NO,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA3_CODE,A.SIZEGROUP_CODE,A.ROW_ID,A.JOB_CODE,  
  --A.PARA3_NAME,A.ARTICLE_NO,A.PARA1_NAME,A.SIZEGROUP_NAME,  
  --ISNULL(BU.CONVERSION_UOM_NAME,UOM_NAME) AS UOM_NAME,  
  --UC.CONVERSION_VALUE,  
  --UOM.UOM_CODE,ORDER_ID,JOB_NAME,  
  --CN.BOM_ARTICLE_CODE,  
  --CONSUME_QTY AS CONSUME_QTY,  
  --BOM_QTY,  
  --BOM_QTY AS AVG_QTY,  
  --SUM(A.QUANTITY) AS QUANTITY,  
  ----CONVERT(NUMERIC(10,0),CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY )-ISNULL(ISSUE_QUANTITY,0)*UC.CONVERSION_VALUE)  
  --REQ_QTY=CASE WHEN UC.CONVERSION_VALUE =0 THEN SUM(A.QUANTITY)*CONSUME_QTY   
  --ELSE SUM(A.QUANTITY)*CONSUME_QTY /UC.CONVERSION_VALUE END ,  
  --BOM.ROW_ID AS BO_BOM_ROW_ID  
  --INTO #TMPCONSUME         
  --FROM #TMPPRODUCT A  
  --JOIN JOBS ON A.JOB_CODE=JOBS.JOB_CODE  
  --JOIN PPC_BO_ART_JOBS_CONSUME CN ON CN.REF_ROW_ID=A.ROW_ID AND CN.JOB_CODE=A.JOB_CODE  
  --JOIN PPC_BO_ART_BOM BOM ON BOM.REF_ROW_ID=A.ROW_ID AND BOM.BOM_ARTICLE_CODE=CN.BOM_ARTICLE_CODE  
  --JOIN ARTICLE ART ON ART.ARTICLE_CODE=CN.BOM_ARTICLE_CODE  
  --JOIN UOM ON UOM.UOM_CODE=ART.UOM_CODE  
  --LEFT OUTER JOIN PPC_UOM_CONVERSION UC ON UC.UOM_CODE=UOM.UOM_CODE  
  --LEFT OUTER JOIN PPC_BOM_UOM BU ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE  
  --WHERE CN.CONSUME_QTY>0  
  --GROUP BY A.ORDER_DT, A.ORDER_NO,A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.AC_CODE,  
  --A.AC_NAME,A.BILL_NO,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA3_CODE,SIZEGROUP_CODE,A.ROW_ID,A.JOB_CODE,  
  --PARA3_NAME,A.ARTICLE_NO,PARA1_NAME,SIZEGROUP_NAME,  
  --ISNULL(BU.CONVERSION_UOM_NAME,UOM_NAME),  
  --UOM.UOM_CODE,ORDER_ID,JOB_NAME,  
  --CN.BOM_ARTICLE_CODE,CN.CONSUME_QTY,BOM_QTY ,UC.CONVERSION_VALUE,BOM.ROW_ID  
  
  ;with TMPPRODUCT  
  AS  
  (  
   SELECT  A.ORDER_DT, A.ORDER_NO,A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.AC_CODE,A.AC_NAME,  
   A.BILL_NO,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA3_CODE,A.SIZEGROUP_CODE,A.ROW_ID,A.JOB_CODE,  
   A.PARA3_NAME,A.ARTICLE_NO,A.PARA1_NAME,A.SIZEGROUP_NAME,ORDER_ID,  
   SUM(A.QUANTITY) AS QUANTITY  
   FROM #TMPPRODUCT A  
   GROUP BY A.ORDER_DT, A.ORDER_NO,A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.AC_CODE,A.AC_NAME,  
   A.BILL_NO,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA3_CODE,A.SIZEGROUP_CODE,A.ROW_ID,A.JOB_CODE,  
   A.PARA3_NAME,A.ARTICLE_NO,A.PARA1_NAME,A.SIZEGROUP_NAME,ORDER_ID  
  )   
  SELECT  A.ORDER_DT, A.ORDER_NO,A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.AC_CODE,A.AC_NAME,  
  A.BILL_NO,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA3_CODE,A.SIZEGROUP_CODE,A.ROW_ID,A.JOB_CODE,  
  A.PARA3_NAME,A.ARTICLE_NO,A.PARA1_NAME,A.SIZEGROUP_NAME,  
  ISNULL(BU.CONVERSION_UOM_NAME,UOM_NAME) AS UOM_NAME,  
  UC.CONVERSION_VALUE,  
  UOM.UOM_CODE,ORDER_ID,JOB_NAME,  
  CN.BOM_ARTICLE_CODE,  
  CONSUME_QTY AS CONSUME_QTY,  
  BOM_QTY,  
  BOM_QTY AS AVG_QTY,  
  (A.QUANTITY) AS QUANTITY,  
  REQ_QTY=CASE WHEN UC.CONVERSION_VALUE =0 THEN (A.QUANTITY)*CONSUME_QTY   
  ELSE (A.QUANTITY)*CONSUME_QTY /UC.CONVERSION_VALUE END ,  
  BOM.ROW_ID AS BO_BOM_ROW_ID  
  INTO #TMPCONSUME  
  FROM TMPPRODUCT A (NOLOCK)  
  JOIN JOBS (NOLOCK)ON A.JOB_CODE=JOBS.JOB_CODE  
  JOIN   
  (   
   SELECT REF_ROW_ID, JOB_CODE,BOM_ARTICLE_CODE,CONSUME_QTY,BOM_QTY   
   FROM PPC_BO_ART_JOBS_CONSUME  (NOLOCK)  
   WHERE CONSUME_QTY>0  
  )CN ON CN.REF_ROW_ID=A.ROW_ID AND CN.JOB_CODE=A.JOB_CODE  
  JOIN  
  (  
   SELECT BOM_ARTICLE_CODE,REF_ROW_ID,ROW_ID   
   FROM PPC_BO_ART_BOM  (NOLOCK)  
  )BOM ON BOM.REF_ROW_ID=A.ROW_ID AND BOM.BOM_ARTICLE_CODE=CN.BOM_ARTICLE_CODE  
  JOIN ARTICLE ART (NOLOCK)ON ART.ARTICLE_CODE=CN.BOM_ARTICLE_CODE  
  JOIN UOM (NOLOCK)ON UOM.UOM_CODE=ART.UOM_CODE  
  LEFT OUTER JOIN PPC_UOM_CONVERSION UC (NOLOCK) ON UC.UOM_CODE=UOM.UOM_CODE  
  LEFT OUTER JOIN PPC_BOM_UOM BU (NOLOCK) ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE  
  
 IF OBJECT_ID('TEMPDB..#TMPPENDING','U') IS NOT NULL  
  DROP TABLE #TMPPENDING  
   
 SELECT A.ORDER_DT, A.ORDER_NO,A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.AC_CODE,A.AC_NAME,  
        A.BILL_NO,A.ARTICLE_CODE,PARA1_CODE,PARA3_CODE,SIZEGROUP_CODE,A.ROW_ID,A.JOB_CODE,  
        A.BOM_ARTICLE_CODE,  
        B.QUANTITY AS ISSUE_QUANTITY,  
        PARA3_NAME,ARTICLE_NO,PARA1_NAME,SIZEGROUP_NAME,UOM_NAME,UOM_CODE,ORDER_ID,JOB_NAME,  
        CONSUME_QTY,  
        BOM_QTY,  
        AVG_QTY AS AVG_QTY,  
        A.QUANTITY,  
        REQ_QTY=CAST(REQ_QTY-ISNULL(B.QUANTITY,0) AS NUMERIC(10,3)),  
        PENDING_QTY=CAST(0 AS NUMERIC(10,3))  
  INTO #TMPPENDING  
  FROM #TMPCONSUME A  
  LEFT OUTER JOIN  
  (   
  SELECT PMT.BO_BOM_ROW_ID,SKU.ARTICLE_CODE, REF_ROW_ID,SUM(QUANTITY) AS QUANTITY   
  FROM PPC_AGENCY_ISSUE_MATERIAL_DET A (NOLOCK)  
  JOIN PPC_AGENCY_ISSUE_MATERIAL_MST B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID  
  JOIN PPC_SKU SKU (NOLOCK) ON A.PRODUCT_UID=SKU.PRODUCT_UID  
  JOIN PPC_PMT PMT (NOLOCK) ON SKU.PRODUCT_UID =PMT.PRODUCT_UID   
  WHERE B.CANCELLED=0  
  AND REF_ROW_ID<>''  
  AND (@CMEMO_ID='' OR  REF_ROW_ID=@CMEMO_ID)  
  GROUP BY PMT.BO_BOM_ROW_ID,SKU.ARTICLE_CODE,REF_ROW_ID  
  ) B ON A.MEMO_ID=B.REF_ROW_ID   
  AND (ISNULL(@CCONSUMEFREESTOCK,'')='1' OR A.BO_BOM_ROW_ID =B.BO_BOM_ROW_ID )  
  AND A.BOM_ARTICLE_CODE = B.ARTICLE_CODE  
  
 --DELETE  FROM #TMPPENDING WHERE ISNULL(REQ_QTY,0)>0  
   
 --SELECT * FROM  #TMPPENDING WHERE MEMO_ID='01011180000001FI000061 '  
   
    DELETE  FROM #TMPPENDING WHERE ISNULL(REQ_QTY,0)<=0  
   
    END  
   
 IF @NQUERYID=1  
   GOTO LBLPENDINGCUTTING  
 ELSE IF @NQUERYID=2  
  GOTO LBLPENDINGCUTTINGDET  
 ELSE IF @NQUERYID=3  
  GOTO LBLRM  
  ELSE IF @NQUERYID=4  
  GOTO LBLRMBARCODE  
  ELSE IF @NQUERYID=5  
  GOTO LBLISSUEMST  
  ELSE IF @NQUERYID=6  
  GOTO LBLISSUEDET  
  ELSE IF @NQUERYID=7  
  GOTO LBLDEBITCOUNT  
 ELSE  
 GOTO END_PROC  
   
 LBLPENDINGCUTTING:  
      
        
 SELECT A.MEMO_ID, A.MEMO_NO,REPLACE(CONVERT(VARCHAR(11),A.MEMO_DT,106),' ','/') AS MEMO_DT ,  
     A.AC_CODE,A.AC_NAME,  
     A.JOB_CODE,0 AS CANCELLED,1 AS APPROVED,A.BILL_NO,JOBS.JOB_NAME,  
     A.ROW_ID AS BO_ROW_ID,  
     A.QUANTITY AS QUANTITY,MEMO_DT  
 FROM #TMPPENDING A  
 JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE=A.JOB_CODE  
 WHERE (@CAC_NAME='' OR A.AC_NAME=@CAC_NAME)  
 AND(@CBILL_NO='' OR A.BILL_NO=@CBILL_NO)   
 GROUP BY A.MEMO_ID, A.MEMO_NO,REPLACE(CONVERT(VARCHAR(11),A.MEMO_DT,106),' ','/') ,  
    A.AC_CODE,A.AC_NAME,  
     A.JOB_CODE,A.BILL_NO,JOBS.JOB_NAME,A.ROW_ID,A.QUANTITY,MEMO_DT  
    ORDER BY A.MEMO_DT DESC,A.MEMO_ID DESC  
   
   
       
  GOTO END_PROC  
   
   
 LBLPENDINGCUTTINGDET:  
         
         
    SELECT A.ORDER_NO,  
           A.ORDER_DT,   
           A.PARA3_CODE ,  
           A.PARA3_NAME ,  
           A.ARTICLE_CODE,  
           A.ARTICLE_NO ,  
           A.PARA1_CODE,  
           A.PARA1_NAME,  
           A.SIZEGROUP_CODE,  
           A.SIZEGROUP_NAME,  
           A.QUANTITY AS QUANTITY,  
           '' AS UOM_NAME,  
            '' AS UOM_CODE,  
           CAST('' AS VARCHAR(100)) PARA2_CODE,  
           CAST('' AS VARCHAR(100)) PARA2_NAME,  
           A.ORDER_ID,  
           A.AC_NAME,  
           A.AC_CODE,  
           A.JOB_CODE,  
           A.JOB_NAME,  
           A.BILL_NO,  
           A.MEMO_ID  AS REF_ROW_ID,  
           A.ROW_ID AS BO_ROW_ID  
             
     FROM #TMPPENDING A  
     WHERE A.MEMO_ID=@CMEMO_ID  
     AND (@CROW_ID='' OR  A.ROW_ID=@CROW_ID)  
     AND (@CJOB_CODE='' OR A.JOB_CODE=@CJOB_CODE)  
     GROUP BY A.ORDER_NO,  
           A.ORDER_DT,   
           A.PARA3_CODE ,  
           A.PARA3_NAME ,  
           A.ARTICLE_CODE,  
           A.ARTICLE_NO ,  
           A.PARA1_CODE,  
           A.PARA1_NAME,  
           A.SIZEGROUP_CODE,  
           A.SIZEGROUP_NAME,  
           A.QUANTITY,  
           A.ORDER_ID ,  
           A.AC_NAME,  
           A.AC_CODE,  
           A.JOB_CODE,  
           A.JOB_NAME,  
           A.BILL_NO,  
           A.MEMO_ID,  
            A.ROW_ID   
             
    
      
      
 GOTO END_PROC  
   
   
 LBLRM:  
   
      
 SELECT  A.ARTICLE_CODE,A.ARTICLE_NO AS FG_ARTICLE_NO,  
         A.PARA1_CODE,A.PARA1_NAME,  
         A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,  
         A.PARA3_CODE,A.PARA3_NAME,  
         A.BOM_ARTICLE_CODE ,  
         ART.ARTICLE_NO AS BOM_ARTICLE_NO,  
   A.JOB_CODE,  
   CAST(A.BOM_QTY AS NUMERIC(10,3)) AS BOM_QTY,  
   CAST(A.CONSUME_QTY AS NUMERIC(10,3)) AS CONSUME_QTY,  
   CAST(A.AVG_QTY AS NUMERIC(10,3)) AS AVG_QTY,  
   --CONVERT(NUMERIC(10,3),CONVERT(NUMERIC(10,3),A.CONSUME_QTY*A.QUANTITY)-ISNULL(ISSUE_QUANTITY,0)*UC.CONVERSION_VALUE) AS REQ_QTY,  
   CONVERT(NUMERIC(10,3),A.CONSUME_QTY*A.QUANTITY) AS REQ_QTY,  
   A.UOM_CODE,  
   A.UOM_NAME,  
   UOM.UOM_NAME AS STOCK_UOM,  
   CONVERT(NUMERIC(10,3),CASE WHEN UC.CONVERSION_VALUE=0 THEN  CONVERT(NUMERIC(10,3),A.CONSUME_QTY*A.QUANTITY)  
   ELSE CONVERT(NUMERIC(10,3),A.CONSUME_QTY*A.QUANTITY)/UC.CONVERSION_VALUE END)-ISNULL(ISSUE_QUANTITY,0) AS STOCK_QTY,  
   ART.ARTICLE_TYPE,  
   CASE WHEN ART.ARTICLE_TYPE=1 THEN 'FINISH GOOD'  
        WHEN ART.ARTICLE_TYPE=2 THEN 'RAW ARTICLE'  
        WHEN ART.ARTICLE_TYPE=3 THEN 'ACCESSORIES'  
        WHEN ART.ARTICLE_TYPE=4 THEN 'TRIM'  
        ELSE 'PACKING MATERIAL' END AS ARTICLE_TYPE_NAME  
 FROM #TMPPENDING A  
 JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=A.BOM_ARTICLE_CODE  
 JOIN UOM (NOLOCK) ON UOM.UOM_CODE=ART.UOM_CODE  
 LEFT JOIN PPC_UOM_CONVERSION UC (NOLOCK) ON UC.UOM_CODE =UOM.UOM_CODE  
 WHERE  A.JOB_CODE=@CJOB_CODE  
 AND A.ROW_ID=@CROW_ID  
 AND(@NARTICLE_TYPE=0 OR ART.ARTICLE_TYPE =@NARTICLE_TYPE)  
 AND A.CONSUME_QTY>0  
 AND CONVERT(NUMERIC(10,3),A.CONSUME_QTY*A.QUANTITY)>0  
 ORDER BY A.BOM_ARTICLE_CODE  
    
   
      
 GOTO END_PROC  
   
 LBLRMBARCODE:  
  --SELECT @CCONSUMEFREESTOCK,@NARTICLE_TYPE  
     
   IF ISNULL(@CCONSUMEFREESTOCK,'')<>'1'  
   BEGIN  
   --DROP TABLE TMPPENDING  
   --SELECT *,@CROW_ID AS R INTO TMPPENDING FROM #TMPPENDING  
     
 SELECT CAST(0 AS BIT) AS CHK,    
             B.ARTICLE_CODE,ART.ARTICLE_NO AS FG_ARTICLE_NO,  
    B.PARA1_CODE,P1.PARA1_NAME,  
    B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME,  
    B.PARA3_CODE,P3.PARA3_NAME,  
    C.BOM_ARTICLE_CODE ,  
    ART1.ARTICLE_NO AS BOM_ARTICLE_NO,  
   C.JOB_CODE,JOBS.JOB_NAME,  
    CAST(C.BOM_QTY AS NUMERIC(10,3)) AS BOM_QTY,  
    CAST(C.CONSUME_QTY AS NUMERIC(10,3)) AS CONSUME_QTY,  
    CAST(D.AVG_QTY AS NUMERIC(10,3)) AS AVG_QTY,  
    CONVERT(NUMERIC(10,0),CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY )-ISNULL(ISSUE_QUANTITY,0)*UC.CONVERSION_VALUE) AS REQ_QTY,  
    BU.CONVERSION_UOM_NAME AS UOM_NAME,  
    CAST(CASE WHEN UC.CONVERSION_VALUE=0 THEN CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY )  
    ELSE  CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY )/UC.CONVERSION_VALUE END AS NUMERIC(10,3))-ISNULL(PEND.ISSUE_QUANTITY,0)  AS STOCK_QTY,  
    UOM.UOM_NAME AS STOCK_UOM,  
    UOM.UOM_CODE,  
      
    PMT.PRODUCT_UID,  
    P2.PARA2_CODE,  
    P2.PARA2_NAME,  
    PMT.PRODUCT_CODE,  
    CAST(PMT.QUANTITY_IN_STOCK AS NUMERIC(10,3)) AS QUANTITY_IN_STOCK,  
    CAST(0 AS NUMERIC(10,3)) AS QUANTITY,  
    B.ROW_ID,  
    CAST(ART1.PURCHASE_PRICE   AS NUMERIC(10,0)) AS RATE,  
    CAST(0 AS NUMERIC(10,0)) AS AMOUNT,  
    CAST(0 AS NUMERIC(10,0)) AS NET_AMOUNT,  
    CAST('' AS VARCHAR(40)) AS REF_ROW_ID,  
    CAST('' AS VARCHAR(40)) AS IMAGE_1,  
    ISNULL(B.ITEM_REMARKS,'') AS WSL_REMARKS,  
    ISNULL(ART1.DEBIT_MATERIAL,0) AS DEBIT_MATERIAL  
 FROM PPC_BUYER_ORDER_MST A (NOLOCK)  
 JOIN PPC_BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID  
 JOIN PPC_BO_ART_BOM D (NOLOCK) ON D.REF_ROW_ID=B.ROW_ID  
 JOIN PPC_BO_ART_JOBS_CONSUME C (NOLOCK) ON B.ROW_ID=C.REF_ROW_ID AND D.BOM_ARTICLE_CODE=C.BOM_ARTICLE_CODE  
 JOIN  
 (  
  SELECT BOM_ARTICLE_CODE,JOB_CODE,ISSUE_QUANTITY  
  FROM #TMPPENDING  
  GROUP BY BOM_ARTICLE_CODE,JOB_CODE,ISSUE_QUANTITY  
 ) PEND ON PEND.BOM_ARTICLE_CODE =C.BOM_ARTICLE_CODE AND PEND.JOB_CODE=C.JOB_CODE  
 JOIN  
 (   
    SELECT B.BO_DET_ROW_ID,SUM(DET.QUANTITY) AS QUANTITY  
    FROM PPC_FGBCG_MST A (NOLOCK)  
    JOIN PPC_FGBCG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID   
    JOIN PPC_FG_SKU SKU (NOLOCK) ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID   
       JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET DET (NOLOCK) ON DET.PRODUCT_CODE=SKU.PRODUCT_CODE  
       JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST MST (NOLOCK) ON MST.MEMO_ID=DET.MEMO_ID  
       WHERE MST.CANCELLED =0  
       AND (@CMEMO_ID='' OR  MST.MEMO_ID=@CMEMO_ID)  
       GROUP BY B.BO_DET_ROW_ID  
         
 ) FG ON FG.BO_DET_ROW_ID=B.ROW_ID   
 JOIN   
 (  
   SELECT SKU.PARA2_CODE , A.PRODUCT_CODE , A.PRODUCT_UID , A.BO_BOM_ROW_ID ,SUM(QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK   
   FROM PPC_PMT A (NOLOCK)  
   JOIN PPC_SKU SKU (NOLOCK) ON A.PRODUCT_UID =SKU.PRODUCT_UID  
   GROUP BY SKU.PARA2_CODE ,A.PRODUCT_CODE ,A.PRODUCT_UID , A.BO_BOM_ROW_ID  
 ) PMT ON PMT.BO_BOM_ROW_ID=D.ROW_ID    
 ----AND PMT.BO_BOM_ROW_ID=D.ROW_ID  
 ---- AND PMT.PID_ROW_ID=G.ROW_ID  
 JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=B.ARTICLE_CODE  
 JOIN ARTICLE ART1 (NOLOCK) ON ART1.ARTICLE_CODE=D.BOM_ARTICLE_CODE  
 JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=B.PARA1_CODE  
 JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE=B.PARA3_CODE  
 JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=PMT.PARA2_CODE  
    JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE=C.JOB_CODE  
 JOIN PPC_SIZEGROUP SG (NOLOCK) ON SG.SIZEGROUP_CODE=B.SIZEGROUP_CODE  
 JOIN UOM (NOLOCK) ON UOM.UOM_CODE=ART1.UOM_CODE  
 LEFT OUTER JOIN PPC_UOM_CONVERSION UC (NOLOCK) ON UC.UOM_CODE=UOM.UOM_CODE  
 LEFT OUTER JOIN PPC_BOM_UOM BU (NOLOCK) ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE  
 WHERE A.CANCELLED=0   
 --AND F.CANCELLED=0 AND H.CANCELLED=0  
 AND C.JOB_CODE=@CJOB_CODE  
 AND PMT.QUANTITY_IN_STOCK>0  
 AND (@CARTICLE_CODE='' OR C.BOM_ARTICLE_CODE=@CARTICLE_CODE)  
  --AND A.ORDER_ID=@CMEMO_ID  
 AND B.ROW_ID=@CROW_ID  
 AND (@NARTICLE_TYPE=0 OR ART1.ARTICLE_TYPE =@NARTICLE_TYPE)  
 AND C.CONSUME_QTY>0  
 AND CONVERT(NUMERIC(10,0),CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY )-ISNULL(ISSUE_QUANTITY,0)*UC.CONVERSION_VALUE)>0  
 UNION ALL  
 SELECT CAST(0 AS BIT) AS CHK,    
     B.ARTICLE_CODE,ART.ARTICLE_NO AS FG_ARTICLE_NO,  
  B.PARA1_CODE,P1.PARA1_NAME,  
  B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME,  
  B.PARA3_CODE,P3.PARA3_NAME,  
  C.BOM_ARTICLE_CODE ,  
  ART1.ARTICLE_NO AS BOM_ARTICLE_NO,  
  C.JOB_CODE,JOBS.JOB_NAME,  
  CAST(C.BOM_QTY AS NUMERIC(10,3)) AS BOM_QTY,  
  CAST(C.CONSUME_QTY AS NUMERIC(10,3)) AS CONSUME_QTY,  
  CAST(D.AVG_QTY AS NUMERIC(10,3)) AS AVG_QTY,  
  CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY ) AS REQ_QTY,  
  BU.CONVERSION_UOM_NAME AS UOM_NAME,  
  CAST(CASE WHEN UC.CONVERSION_VALUE=0 THEN CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY )  
  ELSE  CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY )/UC.CONVERSION_VALUE END AS NUMERIC(10,3))  AS STOCK_QTY,  
  UOM.UOM_NAME AS STOCK_UOM,  
  UOM.UOM_CODE,   
  PMT.PRODUCT_UID,  
  P2.PARA2_CODE,  
  P2.PARA2_NAME,  
  PMT.PRODUCT_CODE,  
  CAST(PMT.QUANTITY_IN_STOCK AS NUMERIC(10,3)) AS QUANTITY_IN_STOCK,  
  CAST(0 AS NUMERIC(10,3)) AS QUANTITY,  
  B.ROW_ID,  
  CAST(0 AS NUMERIC(10,0)) AS RATE,  
  CAST(0 AS NUMERIC(10,0)) AS AMOUNT,  
  CAST(0 AS NUMERIC(10,0)) AS NET_AMOUNT,  
  CAST('' AS VARCHAR(40)) AS REF_ROW_ID,  
  CAST('' AS VARCHAR(40)) AS IMAGE_1,  
  ISNULL(B.ITEM_REMARKS,'') AS WSL_REMARKS,  
     ISNULL(ART1.DEBIT_MATERIAL,0) AS DEBIT_MATERIAL  
 FROM PPC_BUYER_ORDER_MST A (NOLOCK)  
 JOIN PPC_BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID  
 JOIN PPC_BO_ART_BOM D (NOLOCK) ON D.REF_ROW_ID=B.ROW_ID  
 JOIN PPC_BO_ART_JOBS_CONSUME C (NOLOCK) ON B.ROW_ID=C.REF_ROW_ID AND D.BOM_ARTICLE_CODE=C.BOM_ARTICLE_CODE  
 JOIN  
 (  
  SELECT BOM_ARTICLE_CODE,JOB_CODE  
  FROM #TMPPENDING  
  GROUP BY BOM_ARTICLE_CODE,JOB_CODE  
 ) PEND ON PEND.BOM_ARTICLE_CODE =C.BOM_ARTICLE_CODE AND PEND.JOB_CODE=C.JOB_CODE  
 JOIN  
 (   
    SELECT B.BO_DET_ROW_ID,SUM(DET.QUANTITY) AS QUANTITY  
    FROM PPC_FGBCG_MST A (NOLOCK)  
    JOIN PPC_FGBCG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID   
    JOIN PPC_FG_SKU SKU (NOLOCK) ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID   
       JOIN PPC_AGENCY_ISSUE_FG_DET DET (NOLOCK) ON DET.PRODUCT_CODE=SKU.PRODUCT_CODE  
       JOIN PPC_AGENCY_ISSUE_FG_MST MST (NOLOCK) ON MST.MEMO_ID=DET.MEMO_ID  
       WHERE MST.CANCELLED =0  
       AND (@CMEMO_ID='' OR  MST.MEMO_ID=@CMEMO_ID)  
       GROUP BY B.BO_DET_ROW_ID  
         
 ) FG ON FG.BO_DET_ROW_ID=B.ROW_ID   
 JOIN   
 (  
   SELECT SKU.PARA2_CODE ,A.PRODUCT_CODE , A.PRODUCT_UID , A.BO_BOM_ROW_ID ,SUM(QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK   
   FROM PPC_PMT A (NOLOCK)  
   JOIN PPC_SKU SKU (NOLOCK) ON A.PRODUCT_UID =SKU.PRODUCT_UID  
   GROUP BY SKU.PARA2_CODE ,A.PRODUCT_CODE ,A.PRODUCT_UID , A.BO_BOM_ROW_ID  
 ) PMT ON PMT.BO_BOM_ROW_ID=D.ROW_ID    
 JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=B.ARTICLE_CODE  
 JOIN ARTICLE ART1 (NOLOCK) ON ART1.ARTICLE_CODE=D.BOM_ARTICLE_CODE  
 JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=B.PARA1_CODE  
 JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE=B.PARA3_CODE  
 JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=PMT.PARA2_CODE  
    JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE=C.JOB_CODE  
 JOIN PPC_SIZEGROUP SG (NOLOCK) ON SG.SIZEGROUP_CODE=B.SIZEGROUP_CODE  
 JOIN UOM (NOLOCK) ON UOM.UOM_CODE=ART1.UOM_CODE  
 LEFT OUTER JOIN PPC_UOM_CONVERSION UC (NOLOCK) ON UC.UOM_CODE=UOM.UOM_CODE  
 LEFT OUTER JOIN PPC_BOM_UOM BU (NOLOCK) ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE  
 WHERE A.CANCELLED=0  
 AND C.JOB_CODE=@CJOB_CODE  
 AND PMT.QUANTITY_IN_STOCK>0  
 AND (@CARTICLE_CODE='' OR C.BOM_ARTICLE_CODE=@CARTICLE_CODE)  
  --AND A.ORDER_ID=@CMEMO_ID  
 AND B.ROW_ID=@CROW_ID  
 AND (@NARTICLE_TYPE=0 OR ART1.ARTICLE_TYPE =@NARTICLE_TYPE)  
 AND C.CONSUME_QTY>0  
 AND CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY )>0  
 ORDER BY C.BOM_ARTICLE_CODE  
   
 END   
 ELSE  
 BEGIN  
  
          
  IF OBJECT_ID('TEMPDB..#TMPISSUERM','U') IS NOT NULL  
     DROP TABLE #TMPISSUERM  
--SELECT * INTO TMPPENDING FROM #TMPPENDING  
  
  
  
  SELECT A.* ,B.QUANTITY_IN_STOCK,B.PARA2_CODE,B.PRODUCT_CODE,B.PRODUCT_UID,  
  SR=ROW_NUMBER () OVER (PARTITION BY A.BOM_ARTICLE_CODE ORDER BY QUANTITY_IN_STOCK DESC)  
  INTO #TMPISSUERM  
  FROM #TMPPENDING A  
  JOIN   
  (  
   SELECT SKU.PRODUCT_CODE,SKU.PRODUCT_UID ,SKU.ARTICLE_CODE ,SKU.PARA1_CODE ,SKU.PARA2_CODE ,  
       PMT.QUANTITY_IN_STOCK   
   FROM PPC_SKU SKU (NOLOCK)  
   JOIN PPC_PMT PMT (NOLOCK) ON SKU.PRODUCT_UID=PMT.PRODUCT_UID   
   WHERE PMT.QUANTITY_IN_STOCK >0   
   AND ISNULL(PMT.BO_BOM_ROW_ID ,'')=''  
  ) B ON A.BOM_ARTICLE_CODE=B.ARTICLE_CODE  
  ORDER BY B.QUANTITY_IN_STOCK DESC  
  
  
  
  SELECT CAST(0 AS BIT) AS CHK,    
    A.ARTICLE_CODE,ART.ARTICLE_NO AS FG_ARTICLE_NO,  
    A.PARA1_CODE,P1.PARA1_NAME,  
    A.SIZEGROUP_CODE,SG.SIZEGROUP_NAME,  
    A.PARA3_CODE,P3.PARA3_NAME,  
    A.BOM_ARTICLE_CODE ,  
    ART1.ARTICLE_NO AS BOM_ARTICLE_NO,  
    A.JOB_CODE,JOBS.JOB_NAME,  
    CAST(A.BOM_QTY AS NUMERIC(10,3)) AS BOM_QTY,  
    CAST(A.CONSUME_QTY AS NUMERIC(10,3)) AS CONSUME_QTY,  
    CAST(A.AVG_QTY AS NUMERIC(10,3)) AS AVG_QTY,  
    CONVERT(NUMERIC(10,0),A.CONSUME_QTY*A.QUANTITY ) AS REQ_QTY,  
    BU.CONVERSION_UOM_NAME AS UOM_NAME,  
    CAST(CASE WHEN UC.CONVERSION_VALUE=0 THEN CONVERT(NUMERIC(10,0),A.CONSUME_QTY*A.QUANTITY )  
    ELSE  CONVERT(NUMERIC(10,0),A.CONSUME_QTY*A.QUANTITY )/UC.CONVERSION_VALUE END AS NUMERIC(10,3))  AS STOCK_QTY,  
    UOM.UOM_NAME AS STOCK_UOM,  
    UOM.UOM_CODE,   
    A.PRODUCT_UID,  
    A.PARA2_CODE,  
    P2.PARA2_NAME,  
    A.PRODUCT_CODE,  
    CAST(A.QUANTITY_IN_STOCK AS NUMERIC(10,3)) AS QUANTITY_IN_STOCK,  
    CAST(0 AS NUMERIC(10,3)) AS QUANTITY,  
    A.ROW_ID,  
    CAST(0 AS NUMERIC(10,0)) AS RATE,  
    CAST(0 AS NUMERIC(10,0)) AS AMOUNT,  
    CAST(0 AS NUMERIC(10,0)) AS NET_AMOUNT,  
    CAST('' AS VARCHAR(40)) AS REF_ROW_ID,  
    CAST('' AS VARCHAR(40)) AS IMAGE_1,  
    CAST('' AS VARCHAR(100)) AS WSL_REMARKS,  
    ISNULL(ART1.DEBIT_MATERIAL,0) AS DEBIT_MATERIAL  
  FROM #TMPISSUERM A  
  JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=A.ARTICLE_CODE  
  JOIN ARTICLE ART1 (NOLOCK) ON ART1.ARTICLE_CODE=A.BOM_ARTICLE_CODE  
  JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=A.PARA1_CODE  
  JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE=A.PARA3_CODE  
  JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=A.PARA2_CODE  
  JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE=A.JOB_CODE  
  JOIN PPC_SIZEGROUP SG (NOLOCK) ON SG.SIZEGROUP_CODE=A.SIZEGROUP_CODE  
  JOIN UOM (NOLOCK) ON UOM.UOM_CODE=ART1.UOM_CODE  
  LEFT OUTER JOIN PPC_UOM_CONVERSION UC (NOLOCK) ON UC.UOM_CODE=UOM.UOM_CODE  
  LEFT OUTER JOIN PPC_BOM_UOM BU (NOLOCK) ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE  
       WHERE (@NARTICLE_TYPE=0 OR ART1.ARTICLE_TYPE =@NARTICLE_TYPE)  
       AND (@CARTICLE_CODE='' OR A.BOM_ARTICLE_CODE=@CARTICLE_CODE)  
      
   
 END  
   
   
   
 GOTO END_PROC  
   
   
 LBLISSUEMST:  
   
      SELECT A.MEMO_NO,REPLACE(CONVERT(VARCHAR(11),A.MEMO_DT ,106),' ','/') AS MEMO_DT,  
             A.MEMO_ID,A.BILL_NO,A.AGENCY_CODE,AG.AC_NAME AS AGENCY_NAME,A.CANCELLED, B.JOB_CODE,JOBS.JOB_NAME,  
             RIGHT(B.REF_ROW_ID,10) AS JOB_ORDER_ISSUE_NO,  
             SUM(B.QUANTITY) AS QUANTITY,A.MEMO_DT AS M_DT,  
             'GST NO: '+ISNULL(C.GST_NO,'')  AS GST_NO,  
             'GST NO: '+ISNULL(LMP.AC_GST_NO,'')  AS AC_GST_NO,  
             ISNULL(FG.FG_QTY ,0) AS FG_QTY  
      FROM PPC_AGENCY_ISSUE_MATERIAL_MST A (NOLOCK)  
      JOIN PPC_AGENCY_ISSUE_MATERIAL_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID  
      JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE=B.JOB_CODE  
      LEFT JOIN LM01106 AG (NOLOCK) ON AG.AC_CODE=A.AGENCY_CODE  
      LEFT JOIN LMP01106  LMP (NOLOCK) ON AG.AC_CODE=LMP.AC_CODE  
      JOIN COMPANY C (NOLOCK) ON C.COMPANY_CODE ='01'  
      LEFT JOIN  
      (         
  SELECT A.MEMO_ID ,SUM(QUANTITY) AS FG_QTY FROM PPC_AGENCY_ISSUE_FG_DET A (NOLOCK)  
  JOIN PPC_AGENCY_ISSUE_FG_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID   
  WHERE B.CANCELLED =0  
  GROUP BY A.MEMO_ID  
  UNION ALL  
  SELECT A.MEMO_ID ,SUM(QUANTITY) AS FG_QTY   
  FROM PPC_AGENCY_ISSUE_FG_FIRST_DET A (NOLOCK)  
  JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST  B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID   
  WHERE B.CANCELLED =0  
  GROUP BY A.MEMO_ID  
      )FG ON FG.MEMO_ID =B.REF_ROW_ID  
      WHERE (@CBILL_NO='' OR A.BILL_NO=@CBILL_NO)  
      AND (@CAC_NAME='' OR A.AGENCY_CODE=@CAC_NAME)  
      AND (@CMEMO_ID='' OR A.MEMO_ID=@CMEMO_ID)  
      AND (@CJOB_CODE='' OR B.JOB_CODE=@CJOB_CODE)  
      AND(@CFIN_YEAR='' OR A.FIN_YEAR=@CFIN_YEAR)  
      GROUP BY A.MEMO_NO,REPLACE(CONVERT(VARCHAR(11),A.MEMO_DT ,106),' ','/') ,  
      A.MEMO_DT,A.MEMO_ID,A.BILL_NO,A.AGENCY_CODE,AG.AC_NAME,A.CANCELLED, B.JOB_CODE,JOBS.JOB_NAME,  
      RIGHT(B.REF_ROW_ID,10), 'GST NO: '+ISNULL(C.GST_NO,'')  , 'GST NO: '+ISNULL(LMP.AC_GST_NO,''),  
      FG.FG_QTY   
      ORDER BY A.MEMO_DT DESC,A.MEMO_ID DESC  
   
   
 GOTO END_PROC  
   
 LBLISSUEDET:  
         
        SELECT A.MEMO_NO,REPLACE(CONVERT(VARCHAR(11),A.MEMO_DT ,106),' ','/') AS MEMO_DT,  
             A.MEMO_ID,A.BILL_NO,A.AGENCY_CODE,AG.AC_NAME AS AGENCY_NAME,A.CANCELLED,  
              ART.ARTICLE_CODE,ART.ARTICLE_NO AS FG_ARTICLE_NO,  
     P1.PARA1_CODE,P1.PARA1_NAME,  
     SG.SIZEGROUP_CODE,SG.SIZEGROUP_NAME,  
     P3.PARA3_CODE,P3.PARA3_NAME,  
     SKU.ARTICLE_CODE AS BOM_ARTICLE_CODE ,  
     ART1.ARTICLE_NO AS BOM_ARTICLE_NO,  
     B.JOB_CODE,JOBS.JOB_NAME,  
     B.QUANTITY,  
     B.AVG_QTY,  
     B.QUANTITY AS STOCK_QTY,  
     BU.CONVERSION_UOM_NAME AS STOCK_UOM,  
     CAST(C.BOM_QTY AS NUMERIC(10,3)) AS BOM_QTY,  
     CAST(C.CONSUME_QTY AS NUMERIC(10,3)) AS CONSUME_QTY,  
     CAST(C.BOM_QTY AS NUMERIC(10,3)) AS AVG_QTY,  
    --UC.CONVERSION_UOM_NAME AS UOM_NAME,  
    --CAST(CASE WHEN UC.CONVERSION_VALUE=0 THEN CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY )  
    --ELSE  CONVERT(NUMERIC(10,0),C.CONSUME_QTY*FG.QUANTITY )/UC.CONVERSION_VALUE END AS NUMERIC(10,3))  AS STOCK_QTY,  
    --UOM.UOM_NAME AS STOCK_UOM,  
    --UOM.UOM_CODE,  
     PMT.QUANTITY_IN_STOCK,   
     UOM.UOM_CODE,  
     UOM.UOM_NAME,  
     B.PRODUCT_UID,  
     P2.PARA2_CODE,  
     P2.PARA2_NAME,  
     B.ROW_ID,  
     B.RATE,  
     B.AMOUNT,  
     B.NET_AMOUNT,  
     B.REF_ROW_ID,  
     SKU.PRODUCT_CODE,  
     CAST('' AS VARCHAR(100)) AS IMAGE_1,  
     ISNULL(B.DEBIT_MATERIAL,0) AS DEBIT_MATERIAL  
      FROM PPC_AGENCY_ISSUE_MATERIAL_MST A (NOLOCK)  
      JOIN PPC_AGENCY_ISSUE_MATERIAL_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID  
      JOIN PPC_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=B.PRODUCT_UID  
      JOIN PPC_PMT PMT (NOLOCK) ON SKU.PRODUCT_UID=PMT.PRODUCT_UID  
      JOIN  
      (  
        SELECT B.BILL_NO, A.ROW_ID,A.ARTICLE_CODE,BOM.ROW_ID AS BOM_ROW_ID   
        FROM PPC_BUYER_ORDER_DET A (NOLOCK)  
        JOIN PPC_BUYER_ORDER_MST B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID  
        JOIN PPC_BO_ART_BOM BOM (NOLOCK) ON BOM.REF_ROW_ID =A.ROW_ID   
        GROUP BY B.BILL_NO,A.ROW_ID,A.ARTICLE_CODE,BOM.ROW_ID   
      )FG ON FG.BILL_NO =A.BILL_NO AND PMT.BO_BOM_ROW_ID=FG.BOM_ROW_ID   
      JOIN PPC_BO_ART_JOBS_CONSUME C ON FG.ROW_ID=C.REF_ROW_ID AND SKU.ARTICLE_CODE=C.BOM_ARTICLE_CODE  
   AND B.JOB_CODE=C.JOB_CODE  
      LEFT JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=FG.ARTICLE_CODE   
      JOIN ARTICLE ART1 (NOLOCK) ON ART1.ARTICLE_CODE=SKU.ARTICLE_CODE  
      LEFT JOIN PPC_SIZEGROUP SG (NOLOCK) ON SG.SIZEGROUP_CODE=''  
      JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE=B.JOB_CODE  
      JOIN UOM (NOLOCK) ON UOM.UOM_CODE=ART1.UOM_CODE  
      LEFT OUTER JOIN PPC_UOM_CONVERSION UC (NOLOCK) ON UC.UOM_CODE =UOM.UOM_CODE   
      LEFT OUTER JOIN PPC_BOM_UOM BU (NOLOCK) ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE  
      JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=SKU.PARA1_CODE  
      JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=SKU.PARA2_CODE  
      JOIN PARA3 P3 (NOLOCK) ON P3.PARA3_CODE=SKU.PARA3_CODE  
      JOIN LM01106 AG (NOLOCK)  ON AG.AC_CODE=A.AGENCY_CODE  
      WHERE (@CBILL_NO='' OR A.BILL_NO=@CBILL_NO)  
      AND (@CAC_NAME='' OR A.AGENCY_CODE=@CAC_NAME)  
      AND (@CMEMO_ID='' OR A.MEMO_ID=@CMEMO_ID)  
      AND (@CJOB_CODE='' OR B.JOB_CODE=@CJOB_CODE)  
   
   
 GOTO END_PROC  
   
 LBLDEBITCOUNT:  
     SELECT MEMO_ID,  MAX(CAST(ISNULL(DEBIT_MATERIAL,0) AS INT)) AS DEBIT_MATERIAL   
     FROM PPC_AGENCY_ISSUE_MATERIAL_DET A (NOLOCK)  
     WHERE  (@CMEMO_ID='' OR A.MEMO_ID=@CMEMO_ID)  
     GROUP BY MEMO_ID   
   
 GOTO END_PROC  
    
 END_PROC:  
END

