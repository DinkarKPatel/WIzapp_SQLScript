CREATE PROCEDURE SP3S_BUDGET_PLAN  
(  
	@NQUERYID INT , 
	@CWHERE VARCHAR(100)
)  
AS   
BEGIN  
        
         
 IF @NQUERYID=1  
 BEGIN  
	SELECT * FROM SEASON_MST WHERE INACTIVE=0 AND SEASON_NAME<>''
 END
 ELSE  IF @NQUERYID=2  
 BEGIN  
	SELECT * FROM SECTIONM WHERE  INACTIVE=0 AND SECTION_NAME<>''
 END   
 ELSE  IF @NQUERYID=3
 BEGIN  
	SELECT A.*,B.SEASON_NAME ,
	CAST((CASE WHEN DATEDIFF(D,A.EXPIRY_DT,GETDATE())>0 THEN 1 ELSE 0 END) AS BIT) AS EXPIRED, '' AS SP_ID
	FROM BUDGET_PLAN_MST A
	JOIN SEASON_MST B ON B.SEASON_ID=A.SEASON_ID
	WHERE MEMO_NO=@CWHERE
 END   
 ELSE  IF @NQUERYID=4 
 BEGIN  
	SELECT A.*,B.SECTION_NAME,CONVERT(NUMERIC(14,2),ISNULL(F.BUY_PLAN_AMOUNT,0)) AS BUY_PLAN_AMOUNT,CONVERT(NUMERIC(14,2),(A.BUDGET_AMOUNT-ISNULL(F.BUY_PLAN_AMOUNT,0))) AS PENDING_AMOUNT ,'' AS SP_ID
	FROM BUDGET_PLAN_DET A
	JOIN SECTIONM B ON B.SECTION_CODE=A.SECTION_CODE
	LEFT OUTER JOIN  
	(  
		SELECT  A1.BUDGET_PLAN_MEMO_NO AS MEMO_NO,D.SECTION_CODE,SUM(QUANTITY*A.PURCHASE_PRICE) AS BUY_PLAN_AMOUNT 
		FROM BUY_PLAN_DET A 
		JOIN BUY_PLAN_MST A1   ON A1.MEMO_NO=A.MEMO_NO  
		JOIN ARTICLE B ON B.ARTICLE_CODE=A.ARTICLE_CODE  
		JOIN SECTIOND C ON C.SUB_SECTION_CODE=B.SUB_SECTION_CODE  
		JOIN SECTIONM D ON D.SECTION_CODE=C.SECTION_CODE  
		WHERE A1.CANCELLED=0 AND A1.BUDGET_PLAN_MEMO_NO =@CWHERE
		GROUP BY A1.BUDGET_PLAN_MEMO_NO,D.SECTION_CODE
	)F ON F.SECTION_CODE=A.SECTION_CODE AND F.MEMO_NO=A.MEMO_NO 
	WHERE A.MEMO_NO=@CWHERE
 END      
 ELSE  IF @NQUERYID=5
 BEGIN  
	SELECT A.*,B.SEASON_NAME,
	CAST((CASE WHEN DATEDIFF(D,A.EXPIRY_DT,GETDATE())>0 THEN 1 ELSE 0 END) AS BIT) AS EXPIRED, 
	'' AS SP_ID
	FROM BUDGET_PLAN_MST A
	JOIN SEASON_MST B ON B.SEASON_ID=A.SEASON_ID
	ORDER BY B.SEASON_NAME,A.BUDGET_PLAN_NAME,MEMO_DT
 END   
       
END
