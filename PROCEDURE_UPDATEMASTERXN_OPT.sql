CREATE PROCEDURE UPDATEMASTERXN_OPT 
			@CSOURCEDB VARCHAR(100)='',
			@CSOURCETABLE VARCHAR(100),
			@CDESTDB VARCHAR(100)='',
			@CDESTTABLE VARCHAR(100),
			@CKEYFIELD1 VARCHAR(40)='',
			@CKEYFIELD2 VARCHAR(40)='',
			@CKEYFIELD3 VARCHAR(40)='',
			@LINSERTONLY BIT = 0,
			@CFILTERCONDITION VARCHAR(500)='',
			@LUPDATEXNS BIT=0,
			@CXNTYPE VARCHAR(20)='',
			@LUPDATEONLY BIT = 0,
			@BALWAYSUPDATE BIT=0,
			@cUpdatestrPara VARCHAR(MAX)='',
			@bThruUpdatestrPara bit=0,
			@CFILTERCONDITIONUpdate VARCHAR(500)=''
--WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @CWC VARCHAR(1000),
			@CINSERTSTR NVARCHAR(MAX),
			@CINSERTSTRVALUE VARCHAR(MAX),
			@CUPDATESTR	VARCHAR(MAX),
			@CWHERECLAUSE NVARCHAR(MAX),
			@CCMD NVARCHAR(MAX),
			@LDONOTREPLNULLS BIT,@CUSERIDPREFIX VARCHAR(30),
			@CSOURCETABLESTR VARCHAR(100),@CDESTTABLESTR VARCHAR(100),@CDISTINCTSTR VARCHAR(200)
	
	PRINT 'Start inserting table :'+@CDESTTABLE
	IF @bThruUpdatestrPara=1 AND @cUpdateStrPara='' AND @LUpdateOnly=1
		RETURN	
	
	SET @CDESTTABLESTR=(CASE WHEN LEFT(@CDESTTABLE,1)<>'[' THEN '[' ELSE '' END)+
				  @CDESTTABLE+(CASE WHEN RIGHT(@CDESTTABLE,1)<>']' THEN ']' ELSE '' END)

	SET @CSOURCETABLESTR=(CASE WHEN LEFT(@CSOURCETABLE,1)<>'[' THEN '[' ELSE '' END)+
				  @CSOURCETABLE+(CASE WHEN RIGHT(@CSOURCETABLE,1)<>']' THEN ']' ELSE '' END)

	SET @CWC = ''
	IF @CKEYFIELD1 <> ''
		SET @CWC = 'A.' + @CKEYFIELD1 + ' = B.' + @CKEYFIELD1
	IF @CKEYFIELD2 <> ''
		SET @CWC = @CWC + ( CASE WHEN @CWC<>'' THEN ' AND ' ELSE '' END ) + 'A.' + @CKEYFIELD2 + ' = B.' + @CKEYFIELD2
	IF @CKEYFIELD3 <> ''
		SET @CWC = @CWC + ( CASE WHEN @CWC<>'' THEN ' AND ' ELSE '' END ) + 'A.' + @CKEYFIELD3 + ' = B.' + @CKEYFIELD3
	IF @CWC <> ''
		SET @CWC = ' ON ' + @CWC 

	IF @LINSERTONLY = 0 AND (@bThruUpdatestrPara=0 OR @cUpdateStrPara<>'')
	BEGIN

		IF @cUpdateStrPara=''
			SELECT TOP 1 @CUPDATESTR=UPDATESTR FROM XNSINFO (NOLOCK) WHERE TABLENAME=@CDESTTABLE
		ELSE	
			SET @cUpdateStr=@cUpdateStrPara
					

		SET @CWHERECLAUSE=(CASE WHEN @BALWAYSUPDATE<>1 THEN ' WHERE A.LAST_UPDATE<B.LAST_UPDATE ' ELSE '' END)

		SET @CCMD = N'UPDATE A SET ' + @CUPDATESTR +
					 ' FROM ' + @CSOURCEDB + @CSOURCETABLESTR + ' B' + 
					 ' JOIN ' + @CDESTDB + @CDESTTABLESTR + ' A ' + @CWC + @CWHERECLAUSE + 
					 (CASE WHEN @CFILTERCONDITION<>'' OR @CFILTERCONDITIONUpdate<>'' THEN (CASE WHEN @CWHERECLAUSE='' THEN ' WHERE ' ELSE ' AND ' END)
					  ELSE '' END)+(CASE WHEN @CFILTERCONDITIONUpdate<>'' THEN @CFILTERCONDITIONUpdate ELSE @CFILTERCONDITION END)
		PRINT @CCMD			  
		EXEC SP_EXECUTESQL @CCMD
	END
	
	IF @LUPDATEONLY = 1
		RETURN
	
	SELECT TOP 1 @CINSERTSTR=INSERTSTR,@CINSERTSTRVALUE=INSERTSTRVALUE  FROM XNSINFO (NOLOCK)
	WHERE TABLENAME=@CDESTTABLE

	DECLARE @bNoDistinct BIT
	SET @bNoDistinct=(CASE WHEN (LEFT(@CSOURCETABLE,4) IN ('WSL_','WPS_','PUR_','PRT_') OR LEFT(@CSOURCETABLE,3) IN ('PO_'))
						   AND @lUPDATEXNS=1 THEN 1 ELSE 0 END)	

	SET @CDISTINCTSTR = (CASE WHEN @CDESTTABLE IN ('EMP_WPAYATT','IMAGE_XN_DET') OR @bNoDistinct=1 THEN '' ELSE ' DISTINCT ' END)	
	
	
	SET @CCMD = N' INSERT ' + @CDESTDB + @CDESTTABLESTR+
				  ' ( ' + @CINSERTSTR + ' ) ' +
				 ' SELECT '+@CDISTINCTSTR+@CINSERTSTRVALUE + 
				 ' FROM ' + @CSOURCEDB + @CSOURCETABLESTR+ ' B (NOLOCK) ' + 

				 ( CASE WHEN @CKEYFIELD1<>'' AND @LUPDATEXNS=0 THEN 
					' LEFT OUTER JOIN ' + @CDESTDB + @CDESTTABLESTR + ' A  (NOLOCK) ' + @CWC +
					' WHERE A.' + @CKEYFIELD1 + ' IS NULL ' 
				   ELSE '' END )
	

--PRINT @CCMD
--PRINT @CFILTERCONDITION

	IF (@CFILTERCONDITION<>'')
	BEGIN
		SET @CCMD = @CCMD + 
					( CASE WHEN @LUPDATEXNS=0 AND @CKEYFIELD1<>'' THEN ' AND ' ELSE ' WHERE ' END ) + 
					@CFILTERCONDITION
	END

	--if @@spid=90
	--	select @cCmd
		
	PRINT 'CMD FOR :'+@CDESTTABLE+ISNULL(@CCMD,'NULL INSCMD')
	EXEC SP_EXECUTESQL @CCMD
END
--*************************************** END OF PROCEDURE UPDATEMASTERXN_OPT