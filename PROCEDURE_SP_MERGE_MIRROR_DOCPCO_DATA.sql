CREATE PROCEDURE SP_MERGE_MIRROR_DOCPCO_DATA        
(        
	 @CMEMOID VARCHAR(50), 
	 @bHoLoc BIT=0,       
	 @CERRMSG VARCHAR(MAX) OUTPUT        
)        
AS        
BEGIN 
  SET NOCOUNT ON        
  
 BEGIN TRY        
  
  DECLARE @CCURDEPTID VARCHAR(4),@CHODEPTID VARCHAR(4),@CSTEP VARCHAR(4),@CERRORMSG VARCHAR(MAX)

  SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'
  SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'
    
  SET @CSTEP = 10        
  SET @CERRORMSG=''        
 
 
  IF @BHOLOC=0
	BEGIN TRANSACTION        
  
  SET @CSTEP = 20 		
	UPDATE A SET REFLIFTID=(CASE WHEN REFLIFTID='''' THEN NULL ELSE REFLIFTID END),
	SHIFT_ID=(CASE WHEN SHIFT_ID='' THEN NULL ELSE SHIFT_ID END),user_code=ISNULL(b.user_code,'0000000'),
	location_Code =a.target_location_Code ,
	source_location_code =a.location_Code 
	FROM docpco_pco_mst_upload A  WITH (ROWLOCK)
	LEFT OUTER JOIN users b (NOLOCK) ON a.user_code=b.user_code
	
	
	
  SET @CSTEP = 30 		
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB='',@CSOURCETABLE='docpco_pco_mst_upload',@CDESTDB=''        
         ,@CDESTTABLE='pci_mst',@CKEYFIELD1='memo_id',@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0,@BALWAYSUPDATE=1         
         
     	  	            
 END TRY        
 BEGIN CATCH
  PRINT 'CATCH START'       
  SET @CERRMSG='P:SP_MERGE_MIRROR_DOCPCO_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
 END CATCH        
        
EXIT_PROC:        
	
	PRINT 'LAST STEP:'+@CSTEP
	
	IF @@TRANCOUNT>0 AND @BHOLOC=0
	BEGIN
		IF ISNULL(@CERRORMSG,'')='' 
		BEGIN
			COMMIT TRANSACTION
		END	
		ELSE
			ROLLBACK
	END
	
	DELETE FROM docpco_pco_mst_upload WITH (ROWLOCk) WHERE memo_id=@CMEMOID
	 
END 
------ END OF CREATING PROCEDURE - SP_MERGE_MIRROR_DOCPCO_DATA