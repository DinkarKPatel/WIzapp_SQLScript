CREATE PROCEDURE SPPPC_POADJUSTMENT
(  
 @CQUERYID  NUMERIC(2),  
 @CWHERE   NVARCHAR(MAX)='',  
 @CFINYEAR  VARCHAR(5)='',  
 @CDEPTID  VARCHAR(2)='',  
 @NNAVMODE  NUMERIC(2)=1,  
 @CWHERECLAUSE VARCHAR(500)=''  
   
)  
--WITH ENCRYPTION

AS  
BEGIN  
DECLARE @CCMD NVARCHAR(MAX)  
SET @CCMD=''  
IF @CQUERYID=1  
	GOTO LBLPOLU  
ELSE IF @CQUERYID=2  
	GOTO LBLMST  
ELSE IF @CQUERYID=3  
	GOTO LBLDET   
ELSE IF @CQUERYID=4 
	GOTO LBLQBF
ELSE IF @CQUERYID=5 
	GOTO LBLPENDINGPO 
ELSE IF @CQUERYID=6 
	GOTO LBLPENDINGPODETAILS      
ELSE   
GOTO LAST  
    
LBLPOLU:  
		
		SELECT MEMO_NO,MEMO_ID FROM PPC_PO_ADJ_MST WHERE (@CWHERE='' OR MEMO_ID=@CWHERE)
GOTO LAST  
   
LBLMST:  
  
		SELECT  MST.*,A.PO_NO,A.REF_NO,A.PO_DT, A.AC_CODE ,  
		B.AC_NAME, B.ADDRESS0,    
		B.ADDRESS1, B.ADDRESS2, B.AREA_NAME, B.CITY, B.PINCODE, B.STATE, B.SST_NO,    
		B.SST_DT, B.TIN_NO, B.TIN_DT,
		B.ADDRESS0 + '' + B.ADDRESS1 + '' + B.ADDRESS2 + '' + B.AREA_NAME + '' + B.CITY + '' + B.STATE AS SUPP_ADDRESS,
		D.USERNAME,E.USERNAME AS EDT_USERNAME ,C.LOGO_PATH
		FROM PPC_PO_ADJ_MST MST (NOLOCK) 
		JOIN PPC_POM01106 A (NOLOCK) ON A.PO_ID=MST.REF_PO_ID    
		JOIN LMV01106 B (NOLOCK) ON A.AC_CODE = B.AC_CODE     
		JOIN USERS D (NOLOCK) ON MST.USER_CODE = D.USER_CODE     
		JOIN USERS E (NOLOCK) ON MST.EDT_USER_CODE = E.USER_CODE    
		JOIN COMPANY C ON C.COMPANY_CODE='01'     
		WHERE (@CWHERE='' OR MST.MEMO_ID = @CWHERE  )
   
GOTO LAST  
      
LBLDET:  
  
		SELECT  DET.*,  0 AS SERIAL_NO,B.DT_CREATED,CAST(0 AS BIT) AS CHK ,
		CONVERT(NUMERIC(10,2),0) AS INVOICE_QUANTITY,CONVERT(NUMERIC(10,2),0) AS PENDING_QTY,
		CONVERT(NUMERIC(10,2),0) AS PUR_QTY,B.ARTICLE_NO, B.ARTICLE_NAME, B.CODING_SCHEME,  B.PARA1_SET,
		B.PARA2_SET,I.UOM_CODE, I.UOM_NAME, I.UOM_TYPE, C.PARA1_NAME,D.PARA2_NAME,E.PARA3_NAME,
		'' AS JRD_ROW_ID, '' AS JID_ROW_ID, '' AS JOD_ROW_ID , M.SUB_SECTION_NAME,
		N.SECTION_NAME,ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],
		ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],
	    B.ALIAS AS ARTICLE_ALIAS     
		FROM PPC_PO_ADJ_DET DET (NOLOCK) 
		JOIN PPC_PO_ADJ_MST MST (NOLOCK) ON MST.MEMO_ID=DET.MEMO_ID 
		JOIN PPC_POD01106 A (NOLOCK)ON A.ROW_ID=DET.PO_ROW_ID     
		LEFT OUTER JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE     
		LEFT OUTER JOIN PARA1 C ON A.PARA1_CODE = C.PARA1_CODE    
		LEFT OUTER JOIN PARA2 D ON A.PARA2_CODE = D.PARA2_CODE     
		LEFT OUTER JOIN PARA3 E ON A.PARA3_CODE = E.PARA3_CODE       
		LEFT OUTER JOIN UOM I ON B.UOM_CODE = I.UOM_CODE     
		LEFT OUTER JOIN POM01106 R ON R.PO_ID= A.PO_ID     
		LEFT OUTER JOIN SECTIOND M ON B.SUB_SECTION_CODE = M.SUB_SECTION_CODE   
		LEFT OUTER JOIN SECTIONM N ON M.SECTION_CODE = N.SECTION_CODE   
		WHERE DET.MEMO_ID = @CWHERE  
		ORDER BY  SRNO   
		GOTO LAST  
      
LBLQBF:  
  
		SET @CCMD=N'SELECT DISTINCT MEMO_ID ,MST_MEMO_NO ,MST_MEMO_DT    
		FROM VW_PPC_POADJUSTMENT_QBF  '+@CWHERE  
		EXEC SP_EXECUTESQL @CCMD  
      
GOTO LAST  
 
 LBLPENDINGPO:  
		SELECT  PO_ID,PO_NO,PO_DT,REF_NO,L.AC_NAME,L.AC_CODE,
		L.ADDRESS0 + '' + L.ADDRESS1 + '' + L.ADDRESS2 + '' + L.AREA_NAME + '' + L.CITY + '' + L.STATE AS SUPP_ADDRESS  
		FROM PPC_POM01106 P
	    JOIN LMV01106 L (NOLOCK) ON L.AC_CODE = P.AC_CODE    
		WHERE PO_ID IN   
		(  
		SELECT A.PO_ID   
		FROM PPC_POD01106 A JOIN PPC_POM01106 B ON A.PO_ID=B.PO_ID   
		LEFT OUTER JOIN (SELECT PO_ROW_ID,SUM(QUANTITY) AS PUR_QTY FROM  
		PPC_PID01106 A JOIN PPC_PIM01106 B ON A.MRR_ID=B.MRR_ID WHERE  CANCELLED=0 --CHENGES REQUIRED
		GROUP BY PO_ROW_ID)  C ON A.ROW_ID = C.PO_ROW_ID  
		
		LEFT OUTER JOIN (SELECT PO_ROW_ID,SUM(ADJ_QUANTITY) AS ADJ_QTY FROM  
		PPC_PO_ADJ_DET A JOIN PPC_PO_ADJ_MST B ON A.MEMO_ID=B.MEMO_ID 
		JOIN PPC_POM01106 C ON C.PO_ID=B.REF_PO_ID ---CHANGES REQUIRED
		WHERE C.CANCELLED=0 GROUP BY PO_ROW_ID) D ON A.ROW_ID = D.PO_ROW_ID 	
		WHERE  A.QUANTITY-(ISNULL(C.PUR_QTY,0)+ISNULL(D.ADJ_QTY,0))>0    
		)  
		ORDER BY PO_NO      
  
 GOTO LAST 
 
 
 LBLPENDINGPODETAILS:     
 
 IF @NNAVMODE=1
 BEGIN
		SELECT K.SECTION_NAME, J.SUB_SECTION_NAME, I.*, C.PARA1_NAME,    
		D.PARA2_NAME,E.PARA3_NAME,B.ARTICLE_NO,     
		B.ARTICLE_NAME, B.CODING_SCHEME,B.STOCK_NA, A.*,A.PURCHASE_PRICE * A.QUANTITY AS 'AMOUNT'  ,  
		ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],  
		CAST( 0 AS BIT) AS CHECKED,(A.QUANTITY-ISNULL(PI.PUR_QTY,0))  AS PO_QTY,  
		(A.QUANTITY-(ISNULL(PI.PUR_QTY,0)+ISNULL(P2.ADJ_QTY,0))) AS PENDING_QTY,
		ISNULL(PI.PUR_QTY,0) AS PUR_QTY,B.STOCK_NA,B.WHOLESALE_PRICE AS [WHOLESALE_PRICE],
		ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],      
        B.ALIAS AS ARTICLE_ALIAS,''  AS PRODUCT_CODE,A.ROW_ID AS PO_ROW_ID ,
        A.ADJ_QUANTITY  
		FROM PPC_POD01106 A (NOLOCK)   
		JOIN PPC_POM01106 POM (NOLOCK) ON A.PO_ID = POM.PO_ID   
		JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE     
		JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE    
		JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE    
		JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE     
		JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE    
		JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE    
		JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE    
		LEFT OUTER JOIN   
		(  
			SELECT PO_ROW_ID,SUM(A.QUANTITY) AS PUR_QTY,0 AS FOC_QTY FROM  --CHANGES_REQUIRED
			PPC_PID01106 A JOIN PPC_PIM01106 B ON A.MRR_ID=B.MRR_ID  
			JOIN PPC_POD01106 C ON C.ROW_ID=A.PO_ROW_ID
			WHERE  B.CANCELLED=0 
			AND C.PO_ID=@CWHERE  
			GROUP BY PO_ROW_ID  

		) PI ON A.ROW_ID = PI.PO_ROW_ID 
		
		LEFT OUTER JOIN   
		(  
			SELECT PO_ROW_ID,SUM(ADJ_QUANTITY) AS ADJ_QTY  FROM  
			PPC_PO_ADJ_DET A JOIN PPC_PO_ADJ_MST B ON A.MEMO_ID=B.MEMO_ID    
			JOIN PPC_POM01106 C ON C.PO_ID=B.REF_PO_ID
			WHERE C.PO_ID=@CWHERE
			GROUP BY PO_ROW_ID  

		) P2 ON A.ROW_ID = P2.PO_ROW_ID     
		 
		WHERE A.QUANTITY-(ISNULL(PI.PUR_QTY,0)+ISNULL(P2.ADJ_QTY,0))>0 
		AND A.PO_ID=@CWHERE   
		ORDER BY A.SRNO     
		
END
ELSE
BEGIN
     
     SELECT K.SECTION_NAME, J.SUB_SECTION_NAME, I.*, C.PARA1_NAME,    
		D.PARA2_NAME,E.PARA3_NAME,B.ARTICLE_NO,     
		B.ARTICLE_NAME, B.CODING_SCHEME,B.STOCK_NA,P2.ADJ_QTY AS ADJ_QUANTITY, A.*,A.PURCHASE_PRICE * A.QUANTITY AS 'AMOUNT'  ,  
		ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],  
		CAST( 0 AS BIT) AS CHECKED,(A.QUANTITY-ISNULL(PI.PUR_QTY,0))  AS PO_QTY,  
		(A.QUANTITY-(ISNULL(PI.PUR_QTY,0)+ISNULL(P2.ADJ_QTY,0))) AS PENDING_QTY,
		ISNULL(PI.PUR_QTY,0) AS PUR_QTY,B.STOCK_NA,B.WHOLESALE_PRICE AS [WHOLESALE_PRICE],
		ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],      
        B.ALIAS AS ARTICLE_ALIAS,''  AS PRODUCT_CODE,A.ROW_ID AS PO_ROW_ID   
		FROM PPC_POD01106 A (NOLOCK)   
		JOIN PPC_POM01106 POM (NOLOCK) ON A.PO_ID = POM.PO_ID   
		JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE     
		JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE    
		JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE    
		JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE     
		JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE    
		JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE    
		JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE    
		LEFT OUTER JOIN   
		(  
			SELECT PO_ROW_ID,SUM(A.QUANTITY) AS PUR_QTY,0 AS FOC_QTY FROM  --CHANGES_REQUIRED
			PPC_PID01106 A JOIN PPC_PIM01106 B ON A.MRR_ID=B.MRR_ID  
			JOIN PPC_POD01106 C ON C.ROW_ID=A.PO_ROW_ID
			WHERE  B.CANCELLED=0 
			--AND C.PO_ID=@CWHERE  
			GROUP BY PO_ROW_ID  

		) PI ON A.ROW_ID = PI.PO_ROW_ID 
		
	  JOIN   
		(  
			SELECT A.MEMO_ID, PO_ROW_ID,SUM(ADJ_QUANTITY) AS ADJ_QTY  FROM  
			PPC_PO_ADJ_DET A JOIN PPC_PO_ADJ_MST B ON A.MEMO_ID=B.MEMO_ID    
			JOIN PPC_POM01106 C ON C.PO_ID=B.REF_PO_ID
			WHERE A.MEMO_ID=@CWHERE
			GROUP BY A.MEMO_ID,PO_ROW_ID  

	) P2 ON A.ROW_ID = P2.PO_ROW_ID     
		 
		WHERE --A.QUANTITY-(ISNULL(PI.PUR_QTY,0)+ISNULL(P2.ADJ_QTY,0))>0 AND
		 P2.MEMO_ID=@CWHERE   
		ORDER BY A.SRNO  

END		
		
		

 GOTO LAST               
                
  
LAST:  
  
END
