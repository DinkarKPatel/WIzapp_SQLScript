create PROCEDURE SP_SEND_MIRROR_DOCPUR_DATA_OPT
(	
	 @CREQXNID VARCHAR(50)
	,@CTARGETLOCID VARCHAR(5)
	,@CERRMSG VARCHAR(1000) OUTPUT
)	
--WITH ENCRYPTION
AS
/*
	SP_SEND_MIRROR_POADJ_DATA_208_03_02_14 : THIS PROCEDURE WILL SEND PURCHASE ORDER ADJUSTMENT DATA FROM LOCATION TO HO.
*/
BEGIN
	DECLARE @DTSQL NVARCHAR(MAX),@NSPID INT,@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),
	@CTEMPEMPLOYEETABLE VARCHAR(200),@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),
	@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX),@CCUTOFFDATE VARCHAR(20)
	,@CKEYFIELD VARCHAR(100),@CTEMPARTICLETABLE VARCHAR(500),@CTEMPSKUTABLE VARCHAR(500),@CTEMPARTTABLE VARCHAR(200)
    ,@CTEMPSECTIONDTABLE VARCHAR(100),@CTEMPDETAILTABLE VARCHAR(200),@CTEMPMASTERTABLE VARCHAR(500)
    ,@BSENDPURINFOLOC BIT,@BSENDPURINFOLOCMRRDT VARCHAR(10)
    
	DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),XN_ID VARCHAR(40))  	
BEGIN TRY 	
	---- CALL ACKNOWLEDGEMENT OF MEMO SUCCESSFUL MERGING AT MIRRORING SERVER
	DECLARE @CTEMPDBNAME1 VARCHAR(40),@CTEMPDBNAME VARCHAR(40)
	SET @CSTEP=0

	SET @CSTEP=5
	
	SET @CSTEP=10
	SELECT @BSENDPURINFOLOC=UPD_PURINFO FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID
	
	SET @CSTEP=20
	
	SET @CMEMOID=@CREQXNID
			
LBLTABLEINFO:
	SET @CSTEP=50

	
	SET @CSTEP=60
	SET @CSTEP=220
	---- SEND THE PO MEMO MASTER TABLE

	SELECT 	@CMEMOID AS XN_ID,'DOCPUR_config_UPLOAD' AS TARGET_TABLENAME,* FROM CONFIG (NOLOCK) 
	WHERE CONFIG_OPTION='SEND_ALL_PURCHASE_TO_TARGET' 

	SELECT 	@CMEMOID AS XN_ID,'DOCPUR_location_UPLOAD' AS TARGET_TABLENAME,* FROM location (NOLOCK) 
	WHERE dept_id=@cTargetLocId
		
	SELECT 	@CMEMOID AS XN_ID,'DOCPUR_PIM01106_UPLOAD' AS TARGET_TABLENAME,* FROM PIM01106 (NOLOCK) 
	WHERE MRR_ID=@CMEMOID

	SELECT 	@CMEMOID AS XN_ID,'DOCPUR_PID01106_UPLOAD' AS TARGET_TABLENAME,* FROM PID01106 (NOLOCK) 
	WHERE MRR_ID=@CMEMOID

	SELECT distinct  	@CMEMOID AS XN_ID,'DOCPUR_LM01106_UPLOAD' AS TARGET_TABLENAME,a.* FROM LM01106 A (NOLOCK)
	join (
	SELECT AC_CODE FROM PIM01106 
	WHERE MRR_ID=@CMEMOID
	UNION 
	SELECT BROKER_AC_CODE FROM PIM01106 
	WHERE MRR_ID=@CMEMOID AND ISNULL(broker_ac_code,'') not in ('','0000000000')
	UNION 
	SELECT a.AC_CODE FROM SKU A (NOLOCK) --damilano has different ac_code of lot code
	JOIN PID01106 PID (NOLOCK) ON A.PRODUCT_CODE=PID.PRODUCT_CODE
	WHERE MRR_ID=@CMEMOID
	GROUP BY a.AC_CODE
	union 
	SELECT a.AC_CODE FROM SKU A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),
	LEN(B.PRODUCT_CODE )))=a.product_code
	WHERE MRR_ID=@CMEMOID AND b.PRODUCT_CODE LIKE '%@%' 

	) b ON a.ac_code=b.ac_code
	

	SELECT 	@CMEMOID AS XN_ID,'DOCPUR_SKU_UPLOAD' AS TARGET_TABLENAME,a.* FROM SKU A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON a.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_SKU_UPLOAD' AS TARGET_TABLENAME,a.* FROM SKU A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),
	LEN(B.PRODUCT_CODE )))=a.product_code
	WHERE MRR_ID=@CMEMOID AND CHARINDEX ('@',B.PRODUCT_CODE)>0
	
	SELECT 	@CMEMOID AS XN_ID,'DOCPUR_SKU_OH_UPLOAD' AS TARGET_TABLENAME,a.* FROM SKU_OH A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON a.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_SKU_OH_UPLOAD' AS TARGET_TABLENAME,a.* FROM SKU_OH A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON LEFT(B.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',B.PRODUCT_CODE)-1,-1),
	LEN(B.PRODUCT_CODE )))=a.product_code
	WHERE MRR_ID=@CMEMOID AND b.PRODUCT_CODE LIKE '%@%' 


	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_ARTICLE_UPLOAD' AS TARGET_TABLENAME,a.* FROM article A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON a.article_code=b.article_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_ARTICLE_UPLOAD' AS TARGET_TABLENAME,a.* FROM article A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.article_code=b.article_code
	JOIN pid01106 c (NOLOCK) ON c.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	UNION  
	 SELECT  DISTINCT @CMEMOID AS XN_ID,'DOCPUR_ARTICLE_UPLOAD' AS TARGET_TABLENAME,a.* FROM article A (NOLOCK)   
	 JOIN sku b (NOLOCK) ON a.article_code=b.article_code  
	 JOIN pid01106 c (NOLOCK) ON LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',c.PRODUCT_CODE)-1,-1),LEN(c.PRODUCT_CODE )))=b.product_code  
	 WHERE MRR_ID=@CMEMOID  

	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_SECTIOND_UPLOAD' AS TARGET_TABLENAME,c.* FROM article A (NOLOCK) 
	JOIN sectiond c (NOLOCK) ON c.sub_section_code=a.sub_section_code
	JOIN pid01106 b (NOLOCK) ON a.article_code=b.article_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_SECTIOND_UPLOAD' AS TARGET_TABLENAME,d.* FROM article A (NOLOCK) 
	JOIN sectiond d (NOLOCK) ON d.sub_section_code=a.sub_section_code
	JOIN sku b (NOLOCK) ON a.article_code=b.article_code
	JOIN pid01106 c (NOLOCK) ON c.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	UNION  
	 SELECT  DISTINCT @CMEMOID AS XN_ID,'DOCPUR_SECTIOND_UPLOAD' AS TARGET_TABLENAME,d.* FROM article A (NOLOCK)   
	 JOIN sectiond d (NOLOCK) ON d.sub_section_code=a.sub_section_code
	 JOIN sku b (NOLOCK) ON a.article_code=b.article_code  
	 JOIN pid01106 c (NOLOCK) ON LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',c.PRODUCT_CODE)-1,-1),  
	 LEN(c.PRODUCT_CODE )))=b.product_code  
	 WHERE MRR_ID=@CMEMOID  

	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_SECTIONM_UPLOAD' AS TARGET_TABLENAME,a.* FROM sectionm A (NOLOCK) 
	JOIN sectiond sd (NOLOCK) ON sd.section_code=a.section_code
	JOIN article art (NOLOCK) ON art.sub_section_code=sd.sub_section_code
	JOIN sku b (NOLOCK) ON art.article_code=b.article_code
	JOIN pid01106 c (NOLOCK) ON c.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	UNION 
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_SECTIONM_UPLOAD' AS TARGET_TABLENAME,a.* FROM sectionm A (NOLOCK) 
	JOIN sectiond sd (NOLOCK) ON sd.section_code=a.section_code
	JOIN article art (NOLOCK) ON art.sub_section_code=sd.sub_section_code
	JOIN pid01106 c (NOLOCK) ON c.article_code=art.article_code
	WHERE MRR_ID=@CMEMOID
	UNION 
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_SECTIONM_UPLOAD' AS TARGET_TABLENAME,a.* FROM sectionm A (NOLOCK) 
	JOIN sectiond sd (NOLOCK) ON sd.section_code=a.section_code
	JOIN article art (NOLOCK) ON art.sub_section_code=sd.sub_section_code
	JOIN sku b (NOLOCK) ON art.article_code=b.article_code
	JOIN pid01106 c (NOLOCK) ON LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',c.PRODUCT_CODE)-1,-1),  
	LEN(c.PRODUCT_CODE )))=b.product_code  
	WHERE MRR_ID=@CMEMOID

	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_PARA1_UPLOAD' AS TARGET_TABLENAME,a.* FROM para1 A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON a.para1_code=b.para1_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_PARA1_UPLOAD' AS TARGET_TABLENAME,a.* FROM para1 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para1_code=b.para1_code
	JOIN pid01106 c (NOLOCK) ON c.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	union 
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_PARA1_UPLOAD' AS TARGET_TABLENAME,a.* FROM para1 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para1_code=b.para1_code
	JOIN pid01106 c (NOLOCK) ON LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',c.PRODUCT_CODE)-1,-1),
	LEN(c.PRODUCT_CODE )))=b.product_code
	WHERE MRR_ID=@CMEMOID



	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_PARA2_UPLOAD' AS TARGET_TABLENAME,a.* FROM para2 A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON a.para2_code=b.para2_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_PARA2_UPLOAD' AS TARGET_TABLENAME,a.* FROM para2 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para2_code=b.para2_code
	JOIN pid01106 c (NOLOCK) ON c.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	union 
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_PARA2_UPLOAD' AS TARGET_TABLENAME,a.* FROM para2 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para2_code=b.para2_code
	JOIN pid01106 c (NOLOCK) ON LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',c.PRODUCT_CODE)-1,-1),
	LEN(c.PRODUCT_CODE )))=b.product_code
	WHERE MRR_ID=@CMEMOID


	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_para3_UPLOAD' AS TARGET_TABLENAME,a.* FROM para3 A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON a.para3_code=b.para3_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_para3_UPLOAD' AS TARGET_TABLENAME,a.* FROM para3 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para3_code=b.para3_code
	JOIN pid01106 c (NOLOCK) ON c.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	union 
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_PARA3_UPLOAD' AS TARGET_TABLENAME,a.* FROM para3 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para3_code=b.para3_code
	JOIN pid01106 c (NOLOCK) ON LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',c.PRODUCT_CODE)-1,-1),
	LEN(c.PRODUCT_CODE )))=b.product_code
	WHERE MRR_ID=@CMEMOID

	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_para4_UPLOAD' AS TARGET_TABLENAME,a.* FROM para4 A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON a.para4_code=b.para4_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_para4_UPLOAD' AS TARGET_TABLENAME,a.* FROM para4 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para4_code=b.para4_code
	JOIN pid01106 c (NOLOCK) ON c.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	union 
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_PARA4_UPLOAD' AS TARGET_TABLENAME,a.* FROM para4 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para4_code=b.para4_code
	JOIN pid01106 c (NOLOCK) ON LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',c.PRODUCT_CODE)-1,-1),
	LEN(c.PRODUCT_CODE )))=b.product_code
	WHERE MRR_ID=@CMEMOID

	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_para5_UPLOAD' AS TARGET_TABLENAME,a.* FROM para5 A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON a.para5_code=b.para5_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_para5_UPLOAD' AS TARGET_TABLENAME,a.* FROM para5 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para5_code=b.para5_code
	JOIN pid01106 c (NOLOCK) ON c.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	union 
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_PARA5_UPLOAD' AS TARGET_TABLENAME,a.* FROM para5 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para5_code=b.para5_code
	JOIN pid01106 c (NOLOCK) ON LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',c.PRODUCT_CODE)-1,-1),
	LEN(c.PRODUCT_CODE )))=b.product_code
	WHERE MRR_ID=@CMEMOID

	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_para6_UPLOAD' AS TARGET_TABLENAME,a.* FROM para6 A (NOLOCK) 
	JOIN pid01106 b (NOLOCK) ON a.para6_code=b.para6_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_para6_UPLOAD' AS TARGET_TABLENAME,a.* FROM para6 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para6_code=b.para6_code
	JOIN pid01106 c (NOLOCK) ON c.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID
	union 
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_PARA6_UPLOAD' AS TARGET_TABLENAME,a.* FROM para6 A (NOLOCK) 
	JOIN sku b (NOLOCK) ON a.para6_code=b.para6_code
	JOIN pid01106 c (NOLOCK) ON LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',c.PRODUCT_CODE)-1,-1),
	LEN(c.PRODUCT_CODE )))=b.product_code
	WHERE MRR_ID=@CMEMOID

	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_uom_UPLOAD' AS TARGET_TABLENAME,a.* FROM uom A (NOLOCK) 
	JOIN article b (NOLOCK) ON a.uom_code=b.uom_code
	JOIN pid01106 c (NOLOCK) ON c.article_code=b.article_code
	WHERE MRR_ID=@CMEMOID
	UNION
	SELECT 	DISTINCT @CMEMOID AS XN_ID,'DOCPUR_uom_UPLOAD' AS TARGET_TABLENAME,a.* FROM uom A (NOLOCK) 
	JOIN article art (NOLOCK) ON art.uom_code=a.uom_code
	JOIN sku b (NOLOCK) ON art.article_code=b.article_code
	JOIN pid01106 c (NOLOCK) ON c.product_code=b.product_code
	WHERE MRR_ID=@CMEMOID

	--HSN Start

	if object_id ('tempdb..#tmpHsn','u') is not null
	   drop table #tmpHsn
	
	SELECT 	 'DOCPUR_HSN_MST_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS XN_ID,A.* into #tmpHsn FROM HSN_MST A(NOLOCK)
	JOIN SKU B (NOLOCK) ON A.HSN_CODE=B.HSN_CODE
	JOIN pid01106  C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE 
	WHERE mrr_id=@CMEMOID					
	UNION
	SELECT 	 'DOCPUR_HSN_MST_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS XN_ID,A.* FROM HSN_MST A(NOLOCK)
	JOIN pid01106 B (NOLOCK) ON A.HSN_CODE=B.HSN_CODE
	WHERE mrr_id=@CMEMOID
	UNION
	SELECT 	 'DOCPUR_HSN_MST_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS XN_ID,A.* FROM HSN_MST A (NOLOCK)
	JOIN ARTICLE C (NOLOCK) ON C.HSN_CODE=A.HSN_CODE
	JOIN SECTIOND B (NOLOCK) ON B.SUB_SECTION_CODE=C.SUB_SECTION_CODE
	JOIN SKU D (NOLOCK) ON D.ARTICLE_CODE=C.ARTICLE_CODE
	JOIN pid01106 E (NOLOCK) ON E.PRODUCT_CODE=D.PRODUCT_CODE
	WHERE mrr_id=@CMEMOID
	--changes
	union
						
	SELECT 	 'DOCPUR_HSN_MST_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS XN_ID,A.* FROM HSN_MST A(NOLOCK)
	JOIN SKU B (NOLOCK) ON A.HSN_CODE=B.HSN_CODE
	JOIN pid01106 C (NOLOCK) ON LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',c.PRODUCT_CODE)-1,-1),LEN(c.PRODUCT_CODE )))=B.PRODUCT_CODE 
	WHERE mrr_id=@CMEMOID	 	 and c.PRODUCT_CODE LIKE '%@%' 				
	
	UNION
	SELECT 	 'DOCPUR_HSN_MST_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS XN_ID,A.* FROM HSN_MST A (NOLOCK)
	JOIN ARTICLE C (NOLOCK) ON C.HSN_CODE=A.HSN_CODE
	JOIN SECTIOND B (NOLOCK) ON B.SUB_SECTION_CODE=C.SUB_SECTION_CODE
	JOIN SKU D (NOLOCK) ON D.ARTICLE_CODE=C.ARTICLE_CODE
	JOIN pid01106 E (NOLOCK) ON LEFT(e.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',e.PRODUCT_CODE)-1,-1),LEN(e.PRODUCT_CODE )))=D.PRODUCT_CODE
	WHERE mrr_id =@CMEMOID   and e.PRODUCT_CODE LIKE '%@%' 


	SELECT * FROM #TMPHSN 
	
	SELECT 	DISTINCT 'DOCPUR_HSN_DET_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS XN_ID,A.* FROM HSN_DET A(NOLOCK)
	join #TMPHSN b on a.HSN_CODE =b.hsn_code 
	--HSN end
	
   	SELECT 	DISTINCT 'DOCPUR_PURCHASEORDERPROCESSINGNEW_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS XN_ID,A.* 
   	FROM PURCHASEORDERPROCESSINGNEW A (nolock)
    JOIN PID01106 B (nolock) ON A.ROWID=B.ROW_ID
    WHERE XNTYPE ='PURCHASEINVOICE' AND B.mrr_id =@CMEMOID
    
    
	    
	SET @CTEMPDBNAME=DB_NAME()+'_IMAGE'
	  
	SET @DTSQL=N'SELECT DISTINCT *,''DOCPUR_IMAGE_INFO_DOC_UPLOAD'' AS TARGET_TABLENAME FROM '+@CTEMPDBNAME+'..IMAGE_INFO_DOC WHERE XN_TYPE=''frmTranPurchaseInvoice'' AND MEMO_ID='''+@CMEMOID+''''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL


--hardcoded send attribulte 1 passed in challan Procedure so need for parameter 	

 PRINT 'Sending article fix attributes agst Challan'  
 SELECT   'DOCPUR_ARTICLE_FIX_ATTR_Upload' AS TARGET_TABLENAME,@CMEMOID AS DOCPUR_MEMO_ID,A.* FROM ARTICLE_FIX_ATTR A (NOLOCK)  
 JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE  
 JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
 JOIN pid01106  D (NOLOCK) ON D.PRODUCT_CODE=C.PRODUCT_CODE  
 WHERE mrr_id =@CMEMOID  
 UNION  
 SELECT   'DOCPUR_ARTICLE_FIX_ATTR_Upload' AS TARGET_TABLENAME,@CMEMOID AS DOCPUR_MEMO_ID,A.* FROM ARTICLE_FIX_ATTR A (NOLOCK)  
 JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE  
 JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
 JOIN pid01106 D (NOLOCK) ON LEFT(D.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',D.PRODUCT_CODE)-1,-1),LEN(D.PRODUCT_CODE )))=C.PRODUCT_CODE  
 WHERE mrr_id =@CMEMOID AND  D.PRODUCT_CODE LIKE '%@%'  
   
   
 PRINT 'Sending sd_attr agst Challan'  
 SELECT   'DOCPUR_SD_ATTR_AVATAR_Upload' AS TARGET_TABLENAME,@CMEMOID AS DOCPUR_MEMO_ID,A.* FROM SD_ATTR_AVATAR A (NOLOCK)  
    JOIN SECTIOND SD(NOLOCK) ON SD.SUB_SECTION_CODE=A.SUB_SECTION_CODE  
 JOIN ARTICLE B (NOLOCK) ON SD.SUB_SECTION_CODE=B.SUB_SECTION_CODE  
 JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
 JOIN pid01106 D (NOLOCK) ON D.PRODUCT_CODE=C.PRODUCT_CODE  
 WHERE mrr_id =@CMEMOID  
 UNION  
 SELECT   'DOCPUR_SD_ATTR_AVATAR_Upload' AS TARGET_TABLENAME,@CMEMOID AS DOCPUR_MEMO_ID,A.* FROM SD_ATTR_AVATAR A (NOLOCK)  
 JOIN SECTIOND SD(NOLOCK) ON SD.SUB_SECTION_CODE=A.SUB_SECTION_CODE  
 JOIN ARTICLE B (NOLOCK) ON SD.SUB_SECTION_CODE=B.SUB_SECTION_CODE  
 JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
 JOIN pid01106 D (NOLOCK) ON LEFT(D.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',D.PRODUCT_CODE)-1,-1),LEN(D.PRODUCT_CODE )))=C.PRODUCT_CODE  
 WHERE mrr_id =@CMEMOID and D.PRODUCT_CODE LIKE '%@%'  
   
 
 
 SELECT  'DOCPUR_USERS_UPLOAD' AS TARGET_TABLENAME,@CMEMOID AS DOCPUR_MEMO_ID,A.*  FROM USERS A (nolock)
 JOIN
 (
   SELECT  USER_CODE FROM PIM01106 A (NOLOCK) WHERE MRR_ID =@CMEMOID UNION 
   SELECT  EDT_USER_CODE FROM PIM01106 A (NOLOCK) WHERE MRR_ID =@CMEMOID
 ) B ON A.USER_CODE =B.USER_CODE 
    
 
  
 DECLARE @NCOUNT INT,@BLOOP INT,@CCMD NVARCHAR(MAX)  
 SET @NCOUNT=25  
 SET @BLOOP=1  
 WHILE (@BLOOP <=@NCOUNT )  
 BEGIN  
     PRINT 'Sending article attribute#'+str(@bLoop)+' agst Challan'              
     SET @CCMD=N'   
    SELECT   ''DOCPUR_ATTR'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_MST_Upload'' AS TARGET_TABLENAME,'''+@CMEMOID+''' AS DOCPUR_MEMO_ID,ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.*   
    FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)  
    JOIN ARTICLE_FIX_ATTR A (NOLOCK) ON ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code=A.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code  
    JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE  
    JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
    JOIN pid01106 D (NOLOCK) ON D.PRODUCT_CODE=C.PRODUCT_CODE  
    WHERE mrr_id='''+@CMEMOID+'''  
    and  ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000''  
    union  
    SELECT   ''DOCPUR_ATTR'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_MST_Upload'' AS TARGET_TABLENAME,'''+@CMEMOID+''' AS DOCPUR_MEMO_ID,ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.*   
    FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)  
    JOIN ARTICLE_FIX_ATTR A (NOLOCK) ON ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code=A.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code  
    JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE  
    JOIN SKU C (NOLOCK) ON C.ARTICLE_CODE=B.ARTICLE_CODE  
    JOIN pid01106 D (NOLOCK) ON LEFT(D.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',D.PRODUCT_CODE)-1,-1),LEN(D.PRODUCT_CODE )))=C.PRODUCT_CODE  
    WHERE mrr_id='''+@CMEMOID+''' and d.PRODUCT_CODE LIKE ''%@%''  
    and  ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000'' '  
          
     PRINT  @CCMD  
     EXEC SP_EXECUTESQL @CCMD  
          
     SET @BLOOP=@BLOOP +1  
 END  
   
   
	
	  

	
	GOTO END_PROC
END TRY

BEGIN CATCH
	SET @CERRMSG='P: SP_SEND_MIRROR_DOCPUR_DATA_OPT, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 		

END_PROC:
	
END
---END OF PROCEDURE - SP_SEND_MIRROR_DOCPUR_DATA_OPT