
 CREATE PROCEDURE SP_PRODUCT_STATUS_REPORT_6
(
 @nQueryID	INT=0,  
 @DFM_DT DATETIME='',  
 @DTO_DT DATETIME='',  
 @REF_NO VARCHAR(100)='',  
 @BUYER_NAME VARCHAR(100)='',  
 @CORDER_NO VARCHAR(100)='',  
 @JOBCARD_NO VARCHAR(100)=''  
   
)  
AS  
BEGIN  
      
	if isnull(@REF_NO,'')<>'' or isnull(@BUYER_NAME,'')<>'' or isnull(@CORDER_NO,'')<>'' or isnull(@JOBCARD_NO,'')<>''
	set @DFM_DT=''

      
      IF OBJECT_ID ('TEMPDB..#TMPJOBCARD','U') IS NOT NULL
         DROP TABLE #TMPJOBCARD
      
      SELECT A.MEMO_NO AS JOBCARD_NO,
             A.MEMO_DT AS JOBCARD_DT,
             A.MEMO_ID AS JOBCARD_ID,
             BM.ORDER_NO ,
             BM.ORDER_DT ,
             BM.REF_NO ,
             C.PRODUCT_CODE
      INTO #TMPJOBCARD
      FROM ORD_PLAN_MST  A (NOLOCK)
      JOIN ORD_PLAN_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
      JOIN ORD_PLAN_BARCODE_DET C (NOLOCK) ON B.ROW_ID =C.REFROW_ID 
      LEFT JOIN BUYER_ORDER_DET BD (NOLOCK) ON BD.ROW_ID =B.WOD_ROW_ID 
      LEFT JOIN BUYER_ORDER_MST BM  (NOLOCK) ON BD.ORDER_ID =BM.ORDER_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =BM.AC_CODE  
      WHERE A.CANCELLED =0 AND ISNULL(BM.CANCELLED,0)=0
      AND (@REF_NO='' OR ISNULL(BM.REF_NO,'')=@REF_NO)  
	  AND (@BUYER_NAME='' OR ISNULL(LM.AC_CODE ,'')=@BUYER_NAME)  
	  AND (@CORDER_NO='' OR ISNULL(BM.ORDER_ID,'')=@CORDER_NO)  
	  AND (@JOBCARD_NO='' OR ISNULL(a.MEMO_ID,'')=@JOBCARD_NO)  
	  AND (@DFM_DT='' or ISNULL(BM.ORDER_DT,ISNULL(a.MEMO_DT ,'')) BETWEEN @DFM_DT AND @DTO_DT  )
      
    ;WITH JWI_SUMMARY AS
    (  
      SELECT A.* ,C.ISSUE_NO ,CONVERT(VARCHAR,C.ISSUE_DT,105) AS ISSUE_DT,
      ISNULL(E.RECEIPT_NO,'') AS RECEIPT_NO,
      ISNULL(CONVERT(VARCHAR,E.RECEIPT_DT,105),'') AS RECEIPT_DT,
      B.JOB_CODE ,AM.AGENCY_NAME,JOBS.JOB_NAME ,ART.ARTICLE_NO ,ART.ARTICLE_NAME,
      B.QUANTITY AS ISSUE_QTY ,ISNULL(D.QUANTITY,0) AS JWR_QTY,B.JOB_RATE
      FROM #TMPJOBCARD A
      JOIN JOBWORK_ISSUE_DET B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
      JOIN JOBWORK_ISSUE_MST C (NOLOCK) ON B.ISSUE_ID =C.ISSUE_ID 
      JOIN PRD_AGENCY_MST AM (NOLOCK) ON AM.AGENCY_CODE =C.AGENCY_CODE 
      JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE =B.JOB_CODE 
      JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =A.PRODUCT_CODE 
      JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
      LEFT JOIN JOBWORK_RECEIPT_DET D (NOLOCK) ON D.REF_ROW_ID =B.ROW_ID 
      LEFT JOIN JOBWORK_RECEIPT_MST E (NOLOCK) ON D.RECEIPT_ID =E.RECEIPT_ID 
      WHERE C.CANCELLED =0 AND ISNULL(E.CANCELLED,0)=0
    )  

    
    SELECT ISNULL(ORDER_NO,'') AS  [Buyer Order No],
           ISNULL(ref_NO,'') AS  [Buyer Ref No],
           JOBCARD_NO AS [Job Card No],
           ISSUE_NO AS [Issue No],
           ISSUE_DT AS [Issue  Date],
           RECEIPT_NO AS [Receive No],
           RECEIPT_DT AS [Receive  Date],
           AGENCY_NAME AS [Job Worker Name],
           job_name as [Job Name] ,
           ARTICLE_NO AS [Item No],
           ARTICLE_NAME AS [Item Name],
           SUM(ISSUE_QTY) AS [Issue Qty],
           SUM(ISNULL(JWR_QTY,0)) AS [Jwr Qty],
           ISNULL(JOB_RATE,0) AS Rate,
           CONVERT(NUMERIC(10,2),SUM(ISNULL(JWR_QTY,0)*ISNULL(JOB_RATE,0))) AS Amount
           
    FROM JWI_SUMMARY
    GROUP BY ORDER_NO,JOBCARD_NO ,ISSUE_NO ,ISSUE_DT ,RECEIPT_NO ,
    RECEIPT_DT ,AGENCY_NAME ,JOB_NAME ,ARTICLE_NO ,ARTICLE_NAME,JOB_RATE,ISNULL(ref_NO,'')
    order by JOBCARD_NO,ISSUE_NO,ISSUE_DT,RECEIPT_NO,RECEIPT_DT
	
END

