CREATE PROC SP_BWD_SAVETRAN  
@SPID VARCHAR(50)
--	WITH ENCRYPTION  
AS  
BEGIN  
DECLARE @STEP INT;  
DECLARE @CMD NVARCHAR(MAX);  
DECLARE @MEMO_ID VARCHAR(50);  

DECLARE @CTEMPMASTERNAME VARCHAR(100),@CTEMPDETAILNAME VARCHAR(100),@CERRORMSG varchar(1000)
  
SET @STEP=100  
set @CERRORMSG=''

SET @CTEMPMASTERNAME='MSTLOC_BWD_MST_UPLOAD'
SET @CTEMPDETAILNAME='MSTLOC_BWD_det_UPLOAD'
  
BEGIN TRANSACTION
BEGIN TRY

SET @CMD=N'SELECT TOP 1 @MEMO_ID = MEMO_ID FROM '+@CTEMPMASTERNAME+'  WHERE SP_ID ='''+@SPID+'''  '
EXEC SP_EXECUTESQL @CMD,N'@MEMO_ID VARCHAR(50) OUTPUT',@MEMO_ID OUTPUT  
  
PRINT @MEMO_ID  
  
SET @STEP=110  


UPDATE A SET MEMO_ID=@MEMO_ID FROM  MSTLOC_BWD_DET_UPLOAD A WHERE SP_ID=@SPID

  
SET @CMD=N'  
UPDATE A SET A.CARD_NAME=B.CARD_NAME,A.PARA_NAME=B.PARA_NAME,LAST_UPDATE=GETDATE(),A.MEMO_DT=B.MEMO_DT ,
EXP_MONTH_NO=B.EXP_MONTH_NO,ISSUE_CHARGES=B.ISSUE_CHARGES,RENEW_CHARGES=B.RENEW_CHARGES,
NORMAL_DISC_PER=B.NORMAL_DISC_PER,EOSS_DISC_PER=B.EOSS_DISC_PER,cutoff_disc_per=B.cutoff_disc_per
FROM BWD_MST A JOIN '+@CTEMPMASTERNAME+'  B ON A.MEMO_ID=B.MEMO_ID 
WHERE SP_ID ='''+@SPID+'''
'  
  
PRINT @STEP;  
PRINT @CMD;  
  
EXEC SP_EXECUTESQL @CMD;  
  
SET @STEP=120  
  
SET @CMD=N'  
INSERT INTO BWD_MST (CARD_NAME,PARA_NAME,LAST_UPDATE,MEMO_DT,MEMO_ID,EXP_MONTH_NO,ISSUE_CHARGES,RENEW_CHARGES,NORMAL_DISC_PER,EOSS_DISC_PER,cutoff_disc_per)  
SELECT A.CARD_NAME,A.PARA_NAME,A.LAST_UPDATE,A.MEMO_DT,A.MEMO_ID,A.EXP_MONTH_NO,A.ISSUE_CHARGES,A.RENEW_CHARGES,A.NORMAL_DISC_PER,A.EOSS_DISC_PER,A.cutoff_disc_per
FROM '+@CTEMPMASTERNAME+' A LEFT OUTER JOIN BWD_MST B ON A.MEMO_ID=B.MEMO_ID  
WHERE B.MEMO_ID IS NULL 
AND  SP_ID ='''+@SPID+''''  
  
PRINT @STEP;  
PRINT @CMD;  
  
EXEC SP_EXECUTESQL @CMD;  
  
SET @STEP=130  
  
DELETE FROM BWD_DET WHERE MEMO_ID=@MEMO_ID  
--DELETE FROM BWD_MST WHERE MEMO_ID=@MEMO_ID  
  
PRINT @STEP;  
  
SET @STEP=140  
SET @CMD=N'  
INSERT INTO BWD_DET (DISC_PER,PARA_CODE,LAST_UPDATE,MEMO_ID,ROW_ID,A.EOSS_DISC_PER)   
SELECT A.DISC_PER,A.PARA_CODE,A.LAST_UPDATE,A.MEMO_ID,A.ROW_ID,A.EOSS_DISC_PER FROM '+@CTEMPDETAILNAME+' A 
LEFT OUTER JOIN BWD_DET B ON A.MEMO_ID = B.MEMO_ID AND A.PARA_CODE = B.PARA_CODE  
WHERE B.MEMO_ID IS NULL AND  SP_ID ='''+@SPID+''' '  
  
PRINT @STEP;  
PRINT @CMD;  
  
EXEC SP_EXECUTESQL @CMD;  

 END TRY
	BEGIN CATCH
		SET @CERRORMSG = 'P:- SP3S_UPLOADINV_FORAPI STEP- SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		GOTO END_PROC
	END CATCH
	
END_PROC:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')='' 
			COMMIT TRANSACTION
		ELSE
			ROLLBACK
	END


delete a from MSTLOC_BWD_mst_UPLOAD a (nolock) where sp_id=@SPID
delete a from MSTLOC_BWD_det_UPLOAD a (nolock) where sp_id=@SPID

END

