CREATE PROCEDURE SP_UPDATECOLUMNLIST 
				@CSOURCETABLENAME VARCHAR(50),
				@CKEYFIELD1 VARCHAR(40),
				@CKEYFIELD2 VARCHAR(40)='',
				@CKEYFIELD3 VARCHAR(40)='',
				@NMODE INT = 1,
				@CUSERID VARCHAR(30)='',	 
				@CRETFIELDS NVARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CCOLNAME VARCHAR(50), 
			@CCOLTYPE VARCHAR(50),
			@CCOLVALUE VARCHAR(100),
			@CCMD NVARCHAR(1000),
			@CTARGETCOLNAME VARCHAR(50), 
			@CISNULLVALUE VARCHAR(10),
			@LEXCLUSIONS BIT,@BISNULLABLE BIT,
			@CDEFAULTVALUE VARCHAR(100),@CUSERIDPREFIX VARCHAR(30)
	
	SET @CUSERIDPREFIX=(CASE WHEN @CUSERID<>'' THEN @CUSERID+'.' ELSE '' END)

	
	SET @CRETFIELDS = N''
	SET @LEXCLUSIONS = 0

	IF EXISTS ( SELECT NAME FROM SYSOBJECTS WHERE NAME = '__EXCLUSIONS' )
	BEGIN	
		IF EXISTS ( SELECT TABLE_NAME FROM __EXCLUSIONS WHERE TABLE_NAME = @CSOURCETABLENAME )
		SET @LEXCLUSIONS = 1
	END

	DECLARE ABC CURSOR FOR 
	SELECT COLNAME, COLTYPE,ISNULLABLE FROM #TTARGETCOL
			
	OPEN ABC
	FETCH NEXT FROM ABC INTO @CCOLNAME, @CCOLTYPE,@BISNULLABLE
	WHILE @@FETCH_STATUS = 0
	BEGIN
		
		IF @CCOLTYPE IN ( 'INT', 'SMALLINT', 'NUMERIC', 'BIT','TINYINT' )
			SET @CISNULLVALUE = '0'
		ELSE 
			SET @CISNULLVALUE = ''''''

		IF @CCOLNAME NOT IN ( @CKEYFIELD1, @CKEYFIELD2, @CKEYFIELD3 ) -- AND @CTARGETCOLNAME=@CCOLNAME
		BEGIN
			IF @LEXCLUSIONS=1 
				SELECT @CDEFAULTVALUE = DEFAULT_VALUE FROM __EXCLUSIONS 
				WHERE TABLE_NAME = @CSOURCETABLENAME
				AND COLUMN_NAME = @CCOLNAME

			IF @CDEFAULTVALUE IS NULL
				SET @CCOLVALUE = (CASE WHEN @BISNULLABLE=1 THEN 'B.'+@CCOLNAME ELSE ' ISNULL( B.' + @CCOLNAME + ', ' + @CISNULLVALUE + ')' END)
			ELSE
			BEGIN
				IF @CCOLTYPE IN ( 'INT', 'SMALLINT', 'NUMERIC', 'BIT','TINYINT' )
					SET @CCOLVALUE = @CDEFAULTVALUE
				ELSE 
					SET @CCOLVALUE = '''' + @CDEFAULTVALUE + ''''
			END

			IF @NMODE = 1
				SET @CRETFIELDS = @CRETFIELDS + ( CASE WHEN @CRETFIELDS<>'' THEN ', ' + CHAR(13) ELSE '' END )  +  
								  @CCOLNAME + ' = ' + @CCOLVALUE
			ELSE
				SET @CRETFIELDS = @CRETFIELDS + ( CASE WHEN @CRETFIELDS<>'' THEN ' AND ' + CHAR(13) ELSE '' END )  +  
								  'A.'+@CCOLNAME + ' <> ' + @CCOLVALUE
			
			IF @LEXCLUSIONS = 1
				SET @CDEFAULTVALUE = NULL

		END
		FETCH NEXT FROM ABC INTO @CCOLNAME, @CCOLTYPE ,@BISNULLABLE
	END

	CLOSE ABC
	DEALLOCATE ABC

	IF @NMODE = 2 AND @CRETFIELDS <> ''
		SET @CRETFIELDS = ' WHERE ' + @CRETFIELDS

END
