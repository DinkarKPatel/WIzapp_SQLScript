CREATE PROCEDURE SP3S_UPLOADBILL_CAPILLARY
(
	@CCM_ID		VARCHAR(50)
)
AS
BEGIN
	SELECT CONVERT(INT ,SR_NO) AS [SERIAL],CONVERT(NUMERIC(14,2),ABS((A1.QUANTITY * A1.MRP)-A1.DISCOUNT_AMOUNT)) AS [LINE_AMOUNT]  
	,B1.PRODUCT_NAME AS [DESCRIPTION],A1.PRODUCT_CODE AS [ITEM_CODE],ABS(A1.QUANTITY) AS [QTY],A1.MRP AS [RATE]  
	,CONVERT(NUMERIC(14,2),ABS(A1.QUANTITY * A1.MRP)) AS [VALUE],ABS(A1.DISCOUNT_AMOUNT) AS [LINE_DISCOUNT_AMOUNT]
	,(CASE WHEN A1.QUANTITY<0 THEN 'R' ELSE 'S' END)AS [SALE_TYPE],LTRIM(RTRIM(ISNULL(REF_SLS_MEMO_NO,''))) AS REF_SLS_MEMO_NO,
	CONVERT(VARCHAR(20),ISNULL(REF_SLS_MEMO_DT  ,''),111) AS REF_SLS_MEMO_DT,
	  
	'' AS [BILL_CLIENT_ID],(CASE WHEN A.NET_AMOUNT<0 THEN 'REGULAR' ELSE 'REGULAR' END)AS [TYPE],  
	LTRIM(RTRIM(A.CM_NO)) AS [NUMBER],ABS(A.NET_AMOUNT) AS [AMOUNT],CAST(CAST(B.ITEM_COUNT AS INT) AS VARCHAR(5)) + ' LINE ITEM(S)' AS [NOTES],  
	CONVERT(VARCHAR(20),A.CM_DT,111) AS [BILLING_TIME],ABS(A.NET_AMOUNT+A.DISCOUNT_AMOUNT) AS [GROSS_AMOUNT],ABS(A.DISCOUNT_AMOUNT) AS [DISCOUNT],A.CM_ID,  
	  
	A2.MOBILE AS MOBILE,A2.EMAIL AS EMAIL,A2.CUSTOMER_CODE  AS EXTERNAL_ID,A2.CUSTOMER_FNAME AS FIRSTNAME,A2.CUSTOMER_LNAME AS LASTNAME,  
	'M' AS GENDER,GETDATE() AS REGISTERED_ON,CAST('' AS VARCHAR(MAX)) AS ERR_MSG  
	   
	FROM CMD01106 A1 (NOLOCK)  
	JOIN SKU B1 (NOLOCK) ON B1.PRODUCT_CODE=A1.PRODUCT_CODE    
	JOIN CMM01106 A (NOLOCK) ON A.CM_ID=A1.CM_ID  
	JOIN   
	(  
		SELECT CM_ID,COUNT(PRODUCT_CODE) AS [ITEM_COUNT] FROM CMD01106 (NOLOCK) GROUP BY CM_ID  
	)B ON B.CM_ID=A.CM_ID  
	JOIN CUSTDYM A2 (NOLOCK) ON A2.CUSTOMER_CODE=A.CUSTOMER_CODE  
	WHERE  ISNULL(A2.MOBILE,'')<>'' AND LEN(A2.MOBILE)=10 AND (A1.CM_ID=@CCM_ID OR @CCM_ID='')  
	ORDER BY A1.CM_ID,A1.SR_NO 
END
