create PROCEDURE SP3S_VALIDATE_SUPPLIERDRBALANCE
@CLOCATIONID VARCHAR(5),
@cFinyear VARCHAR(5),
@nPrtMode NUMERIC(1,0),
@nSpId VARCHAR(40),
@cErrormsg varchar(2000) output
AS
BEGIN	
	DECLARE @cCmd NVARCHAR(MAX),@dDnDate DATETIME,@NOPENINGBAL NUMERIC(14,2),@CDNACCODE CHAR(10),@NDNSUPPLIERAMOUNT NUMERIC(14,2),
	        @CAcname varchar(100)

	SET @cErrormsg=''

	SELECT TOP 1 @DDNDATE=RM_DT,@NDNSUPPLIERAMOUNT= TOTAL_AMOUNT,@CDNACCODE=ac_code
	FROM prt_rmm01106_upload (NOLOCK) WHERE SP_ID=ltrim(rtrim(@NSPID))
	
	SELECT @NOPENINGBAL=SUM(BALANCE) FROM loc_ledger_balance (NOLOCK) WHERE ac_code=@CDNACCODE
		---DBO.FN_ACT_CLOSING_NEW(@CDNACCODE,@CLOCATIONID,@DDNDATE,@CFINYEAR,'01')
		--commented use of function as it will slow down our cloud (28-01-2021)
		
		IF @NOPENINGBAL+@NDNSUPPLIERAMOUNT>0
		BEGIN
			IF @NPRTMODE=2
				UPDATE #TMPDNSUPPLIER SET CANCELLED=1 WHERE AC_CODE=@CDNACCODE
			ELSE
			BEGIN

			     SELECT @CACNAME=AC_NAME FROM LM01106 (NOLOCK) WHERE AC_CODE=@CDNACCODE
				 SET @CACNAME=ISNULL(@CACNAME,'')
				
				SET @CERRORMSG='A/C BALANCE OF SUPPLIER GOING NEGATIVE :'+ISNULL(@CACNAME+'('+ @CDNACCODE+')','NULL DNACCODE')+'-'+
								ISNULL(@CLOCATIONID,'NULLLOCID')+'-'+
								ISNULL(CONVERT(VARCHAR,@DDNDATE,110),'NULLDATE')+'-'+LTRIM(RTRIM(STR(@NOPENINGBAL)))+'-'+
								LTRIM(RTRIM(STR(@NDNSUPPLIERAMOUNT)))+' .....CANNOT PROCEED' 	
								
				goto end_proc
			END	
		END
			
	

end_proc:

END