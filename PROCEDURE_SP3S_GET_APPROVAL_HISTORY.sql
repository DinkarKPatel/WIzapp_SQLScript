CREATE PROCEDURE SP3S_GET_APPROVAL_HISTORY
(
	@nMode		INT,
	@cXN_TYPE	VARCHAR(20),
	@cXN_ID		VARCHAR(100)
	
)
AS
BEGIN
	DECLARE @dt TABLE(SR_NO VARCHAR(5),XN_ID VARCHAR(100),MEMO_NO VARCHAR(20),XN_STATUS VARCHAR(20),LEVEL_NO VARCHAR(5),REMARKS VARCHAR(100),
	WINUSERNAME  VARCHAR(100),SYSTEMUSERNAME  VARCHAR(100),LAST_UPDATE DATETIME,USERNAME  VARCHAR(100))

	INSERT INTO @dt(SR_NO ,XN_ID ,MEMO_NO ,XN_STATUS ,LEVEL_NO ,REMARKS ,WINUSERNAME  ,SYSTEMUSERNAME  ,LAST_UPDATE ,USERNAME)
	SELECT  ROW_NUMBER() OVER (PARTITION BY XN_TYPE,XN_ID ORDER BY XN_TYPE,XN_ID,A.last_update) SR_NO,XN_ID,
	--SUBSTRING(XN_ID,CHARINDEX(TRIM('0' FROM SUBSTRING(XN_ID,8,100)),XN_ID),100) AS MEMO_NO,
	REPLACE(REPLACE(RTRIM(LTRIM(REPLACE(REPLACE(SUBSTRING(XN_ID,8,100),' ','%'),'0',' '))),' ','0'),'%',' ') AS MEMO_NO,
	(CASE WHEN APPROVAL_STATUS=1 THEN 'APPROVED' WHEN  DISAPPROVAL_STATUS=1 THEN 'DISAPPROVED' ELSE '' END) AS [STATUS],
	LEVEL_NO,APPROVAL_REMARKS AS REMARKS,
	WINUSERNAME,SYSTEMUSERNAME,CONVERT(VARCHAR(50),A.LAST_UPDATE,113) AS LAST_UPDATE,B.USERNAME
	FROM TRANSACTION_APPROVAL_DET A
	JOIN USERS B ON B.USER_CODE=A.USER_CODE
	WHERE XN_TYPE=@cXN_TYPE
	AND (@cXN_ID='' OR A.XN_ID=@cXN_ID)
	
	if @nMode=1
		SELECT SR_NO AS [SNO],MEMO_NO AS [MEMO NO],XN_STATUS AS [STATUS],LEVEL_NO AS [LEVEL],REMARKS ,WINUSERNAME  AS [WINDOWS USER],
		SYSTEMUSERNAME  AS [COMPUTER NAME],CONVERT(VARCHAR(50),LAST_UPDATE,113) AS [UPDATED ON] ,USERNAME AS [USER]
		FROM @dt
		ORDER BY XN_ID,LAST_UPDATE
	else
	SELECT SR_NO AS [SNO],XN_ID,MEMO_NO AS [MEMO NO],XN_STATUS AS [STATUS],LEVEL_NO AS [LEVEL],REMARKS ,WINUSERNAME  AS [WINDOWS USER],
		SYSTEMUSERNAME  AS [COMPUTER NAME],CONVERT(VARCHAR(50),LAST_UPDATE,113) AS [UPDATED ON] ,USERNAME AS [USER]
		FROM @dt
		ORDER BY XN_ID,LAST_UPDATE
			
END