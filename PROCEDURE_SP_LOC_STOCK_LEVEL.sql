CREATE PROCEDURE SP_LOC_STOCK_LEVEL
(
  @NMODE INT,
  @CMEMO_ID VARCHAR(100)='',
  @DISPLAYMSG VARCHAR(100)=''
)
--WITH ENCRYPTION 
AS
BEGIN
     
     IF @NMODE=1
     BEGIN
		 IF OBJECT_ID('TEMPDB..#TMPLOCSTOCK','U') IS NOT NULL
			DROP TABLE #TMPLOCSTOCK
	        
		 SELECT DEPT_ID AS LOC_ID,DEPT_NAME  INTO #TMPLOCSTOCK   FROM LOCATION 
     
     IF OBJECT_ID('TEMPDB..#TMPNEWSEASON','U') IS NOT NULL
        DROP TABLE #TMPNEWSEASON
    
		  SELECT ROW_NUMBER() OVER (ORDER BY SEASON_NAME) AS SR, SEASON_NAME INTO #TMPNEWSEASON  
		  FROM SEASON_MST WHERE SEASON_NAME NOT IN
		 (SELECT NAME FROM SYS.COLUMNS WHERE OBJECT_ID =OBJECT_ID('LOC_STOCK_LEVEL_DET'))
	      
	    IF (SELECT COUNT(*) FROM SEASON_MST)=0
	     RETURN
	   
		  DECLARE @MINSR INT,@MAXSR INT,@SEASON_NAME VARCHAR(200),@DTSQL NVARCHAR(MAX)
		  SET @MINSR=1
		  SET @MAXSR=(SELECT MAX(SR) FROM #TMPNEWSEASON)
		  WHILE @MINSR <=@MAXSR 
		  BEGIN
		  SET @SEASON_NAME=(SELECT SEASON_NAME FROM #TMPNEWSEASON WHERE SR=@MINSR )
	      
		  SET @DTSQL=N'ALTER TABLE LOC_STOCK_LEVEL_DET ADD  ['+@SEASON_NAME+'] NUMERIC(18,0)'
		  PRINT @DTSQL
		  EXEC SP_EXECUTESQL @DTSQL
	      
	      
		  SET @MINSR=@MINSR+1
      END
      
       IF OBJECT_ID('TEMPDB..#TMPDROPSEASON','U') IS NOT NULL
        DROP TABLE #TMPDROPSEASON
      
			SELECT ROW_NUMBER() OVER (ORDER BY PERIOD_FROM ,PERIOD_TO) AS SR, NAME 
		   INTO #TMPDROPSEASON 
		   FROM SYS.COLUMNS A
		   LEFT JOIN SEASON_MST  M ON M.SEASON_NAME =A.NAME 
		   WHERE OBJECT_ID =OBJECT_ID('LOC_STOCK_LEVEL_DET')
			AND 
		   NAME NOT IN
		  (SELECT SEASON_NAME  FROM SEASON_MST ) 
		  AND NAME NOT IN
		   ('MEMO_ID','DEPT_ID','ROW_ID','LAST_UPDATE','TS','FIN_YEAR')
		  ORDER BY PERIOD_FROM ,PERIOD_TO
      
      
      
		  SET @MINSR=1
		  SET @MAXSR=(SELECT MAX(SR) FROM #TMPDROPSEASON)
       WHILE @MINSR <=@MAXSR 
	   BEGIN
		  SET @SEASON_NAME=(SELECT NAME FROM #TMPDROPSEASON WHERE SR=@MINSR )
	      
		  SET @DTSQL=N'ALTER TABLE LOC_STOCK_LEVEL_DET DROP COLUMN  ['+@SEASON_NAME+'] '
		  PRINT @DTSQL
		  EXEC SP_EXECUTESQL @DTSQL
	      
	      
		  SET @MINSR=@MINSR+1
       END
     
		IF OBJECT_ID('TEMPDB..#TMPSR','U') IS NOT NULL
		   DROP TABLE #TMPSR


		SELECT SEASON_NAME,SR=ROW_NUMBER() OVER (ORDER BY PERIOD_FROM ,PERIOD_TO ) 
		INTO #TMPSR
		FROM SEASON_MST 
		ORDER BY PERIOD_FROM ,PERIOD_TO 

		DECLARE @SR INT,@MSR INT,@SEASONNAME VARCHAR(100),@COL_NAME VARCHAR(MAX)
				SET @COL_NAME=''

		SET @SR=1
		SET @MSR=(SELECT MAX(SR) FROM #TMPSR)

		WHILE @SR<=@MSR
		BEGIN
		    
			SET @SEASONNAME=(SELECT  SEASON_NAME FROM #TMPSR WHERE SR=@SR )
		    
			IF @SR =1
			SET @COL_NAME=@SEASONNAME
			ELSE
			 SET @COL_NAME=@COL_NAME+','+@SEASONNAME
			SET @SR=@SR+1
		 END
		
		
      
      IF @DISPLAYMSG=''
      BEGIN
		  IF OBJECT_ID('TEMPDB..#TMPLOCSTOCK_FINAL','U') IS NOT NULL
			DROP TABLE #TMPLOCSTOCK_FINAL
	      
		  SELECT  A.LOC_ID,A.DEPT_NAME,B.*  INTO  #TMPLOCSTOCK_FINAL FROM #TMPLOCSTOCK A
		  LEFT JOIN LOC_STOCK_LEVEL_DET B ON A.LOC_ID=B.DEPT_ID AND 1=2
		  ORDER BY DEPT_NAME
	      
		  UPDATE #TMPLOCSTOCK_FINAL SET DEPT_ID=LOC_ID
		  ALTER TABLE #TMPLOCSTOCK_FINAL DROP COLUMN LOC_ID
	      
		  SET @DTSQL=N'SELECT MEMO_ID,DEPT_ID,DEPT_NAME,MEMO_ID,ROW_ID,LAST_UPDATE,FIN_YEAR,
                          '+@COL_NAME+' 
                   FROM #TMPLOCSTOCK_FINAL
                   ORDER BY DEPT_ID '
                   PRINT @DTSQL
                   EXEC SP_EXECUTESQL @DTSQL
      
      END
      END
      
      
END
--END OF PROCEDURE SP_LOC_STOCK_LEVEL
