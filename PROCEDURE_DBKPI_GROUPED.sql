CREATE PROCEDURE DBKPI_GROUPED(@SetupID varchar(100),@DT VARCHAR(10),@SortingID int=0)
AS
BEGIN
	IF @SortingID NOT IN (0,1,2,3) RETURN

	SET NOCOUNT ON
	DECLARE @SQL VARCHAR(MAX)='',@CAT VARCHAR(100),@CCMD VARCHAR(MAX)

	IF OBJECT_ID('tempdb..#DATA') IS NOT NULL DROP TABLE #DATA
	CREATE TABLE #DATA(MAIN_HEADER VARCHAR(100),HEADER VARCHAR(100),LY_MTD FLOAT,CY_MTD FLOAT,[VARIANCE_MTD] VARCHAR(100)/*NUMERIC(20,2)*/
	,LY_YTD FLOAT,CY_YTD FLOAT,[VARIANCE_YTD] VARCHAR(100)
	,CATEGORY_NAME VARCHAR(100),SNO INT,MAIN_HEADER_COUNT INT,HEADER_NO INT
	,LY_STD FLOAT,CY_STD FLOAT,[VARIANCE_STD] VARCHAR(100))

	SELECT @CAT=CASE WHEN PARA_NAME LIKE 'PARA%' 
	THEN (SELECT TOP 1 VALUE FROM CONFIG WHERE  config_option=LEFT(PARA_NAME,5)+'_caption') ELSE REPLACE(UPPER(PARA_NAME),'_',' ') END 
	FROM POS_DYNAMIC_DASHBOARD_SETUP(NOLOCK) 
	WHERE setup_id=@SetupID

	INSERT #DATA (MAIN_HEADER,HEADER ,LY_MTD ,CY_MTD ,LY_YTD,CY_YTD ,
	LY_STD ,CY_STD,CATEGORY_NAME,SNO ,MAIN_HEADER_COUNT ,HEADER_NO,[VARIANCE_STD] )
	SELECT CY.KPI_NAME,CY.PARA_NAME
	,ISNULL(LY.MTD_VALUE,0),ISNULL(CY.MTD_VALUE,0)
	,ISNULL(LY.YTD_VALUE,0),ISNULL(CY.YTD_VALUE,0)
	,ISNULL(LY.STD_VALUE,0),ISNULL(CY.STD_VALUE,0)
	,@CAT
	,ROW_NUMBER()OVER(PARTITION BY CY.KPI_NAME ORDER BY CY.PARA_NAME)
	,0
	,DENSE_RANK()OVER(ORDER BY CY.PARA_NAME)
	,0
	FROM POS_DYNAMIC_DBDATA CY (NOLOCK)
	LEFT JOIN POS_DYNAMIC_DBDATA LY (NOLOCK) ON CY.setup_id=LY.setup_id AND CY.kpi_name=LY.kpi_name AND 
	CY.para_name=LY.para_name AND LY.db_dt=DATEadd(YY,-1,CY.db_dt)
	WHERE CY.setup_id=@SetupID AND CY.db_dt=@DT
	AND CY.KPI_NAME NOT LIKE '%COLOR_CODE'
	ORDER BY 1,2

	SET @CCMD=';WITH CTE AS(SELECT *,R=ROW_NUMBER()OVER(ORDER BY CY_YTD DESC,HEADER) FROM #DATA WHERE MAIN_HEADER='''+CASE @SortingID WHEN 1 THEN 'NRV' WHEN 2 THEN 'PROFIT AMOUNT' WHEN 3 THEN 'GMROI' END+''')
	   UPDATE T SET HEADER_NO=C.R FROM #DATA T JOIN CTE C ON T.HEADER=C.HEADER;'
	PRINT @CCMD   
	IF @SortingID<>0 EXEC(@CCMD)
	--SELECT 355,* FROM #DATA
	UPDATE #DATA SET VARIANCE_MTD=CAST((ISNULL(CY_MTD,0)-ISNULL(LY_MTD,0))/CASE ISNULL(LY_MTD,0) WHEN 0 THEN 1 ELSE LY_MTD END*100.0 AS DECIMAL(18,2)) WHERE ISNULL(LY_MTD,0)!=0
	UPDATE #DATA SET VARIANCE_YTD=CAST((ISNULL(CY_YTD,0)-ISNULL(LY_YTD,0))/CASE ISNULL(LY_YTD,0) WHEN 0 THEN 1 ELSE LY_YTD END*100.0 AS DECIMAL(18,2)) WHERE ISNULL(LY_YTD,0)!=0
	UPDATE #DATA SET VARIANCE_STD=CAST((ISNULL(CY_STD,0)-ISNULL(LY_STD,0))/CASE ISNULL(LY_STD,0) WHEN 0 THEN 1 ELSE LY_STD END*100.0 AS DECIMAL(18,2)) WHERE ISNULL(LY_STD,0)!=0

	UPDATE #DATA SET VARIANCE_MTD='N.A.' WHERE LY_MTD=0
	UPDATE #DATA SET VARIANCE_YTD='N.A.' WHERE LY_YTD=0
	UPDATE #DATA SET VARIANCE_STD='N.A.' WHERE LY_STD=0
	UPDATE #DATA SET MAIN_HEADER_COUNT=(SELECT COUNT(DISTINCT HEADER) FROM #DATA)

	SELECT MAIN_HEADER,HEADER,LY_MTD,CY_MTD,ISNULL(VARIANCE_MTD,0)VARIANCE_MTD,LY_YTD,CY_YTD,ISNULL(VARIANCE_YTD,0)VARIANCE_YTD,CATEGORY_NAME,MAIN_HEADER_COUNT,HEADER_NO,LY_STD,CY_STD,ISNULL(VARIANCE_STD,0)VARIANCE_STD 
	,TXT_COLOR=CASE WHEN MAIN_HEADER IN ('Cost of Goods Sold','GMROI','PROFIT AMOUNT','PROFIT%','NRV' ) THEN '#FFFABD'
					WHEN MAIN_HEADER IN ('No. of Bills','ABS','ATS') THEN '#D8DBDE'
					ELSE '#C7FFD3' END
	FROM #DATA
	ORDER BY HEADER_NO
	,CASE MAIN_HEADER 
	WHEN 'NRV' THEN '1A'
	WHEN 'PROFIT%' THEN '1B'
	WHEN 'PROFIT AMOUNT' THEN '1C'
	WHEN 'GMROI' THEN '1D'
	WHEN 'Cost of Goods Sold' THEN '1E'
	WHEN 'No. of Bills' THEN '2A'
	WHEN 'ABS' THEN '2B'
	WHEN 'ATS' THEN '2C'
	ELSE MAIN_HEADER END
	SET NOCOUNT OFF
END