create PROCEDURE SP_SEND_MIRROR_IRR_DATA_NEW  
(   
  @CUPLOADEDXNID VARCHAR(50)  
 ,@CCURLOCID VARCHAR(5)   
 ,@BACKNOWLEDGE BIT=0  
 ,@CERRMSG VARCHAR(1000) OUTPUT  
)   
--WITH ENCRYPTION  
AS  
/*  
 SP_SEND_MIRROR_IRR_DATA_NEW_208_05_02_14 : THIS PROCEDURE WILL SEND RATE REVISION DATA FROM LOCATION TO HO.  
*/  
BEGIN  
 DECLARE @DTSQL NVARCHAR(MAX),@CSPID VARCHAR(10),@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),  
 @CTEMPMASTERTABLE VARCHAR(200),@CTEMPICDTABLE VARCHAR(200),@CTEMPSKUTABLE VARCHAR(200)  
 ,@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX)  
 ,@CKEYFIELD VARCHAR(100),@CTEMPARTTABLE VARCHAR(200),@CTEMPSDTABLE VARCHAR(200)  
 ,@CTEMPDETAILTABLE VARCHAR(200)  
  

BEGIN TRY    
 ---- CALL ACKNOWLEDGEMENT OF MEMO SUCCESSFUL MERGING AT MIRRORING SERVER  
 DECLARE @CTEMPDBNAME VARCHAR(40)  
 
 set @CTEMPDBNAME=''
   
         
 SET @CSTEP=10  
 SET @CFILTERCONDITION=''  
  
 SELECT TOP 1 @CCURLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'   
   
   
 SET @CSTEP=30  
 --CHANGE BY BAIJNATH  
 SET @CMEMOID=@CUPLOADEDXNID  
 SET @CSTEP=40  
 ---- IF NO MEMO FOUND , JUST END THE PROCESS  
 IF ISNULL(@CMEMOID,'')=''  
  GOTO END_PROC  
  
LBLTABLEINFO:  
 SET @CSTEP=50  
 ---- POPULATE LIST OF TABLES   
  
 SET @CSTEP=105  
 ---- SEND THE IRR MEMO MASTER TABLE  
 SELECT DISTINCT 'IRR_IRM01106_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS XN_ID FROM IRM01106 A (NOLOCK)  WHERE A.irm_memo_id =@CMEMOID  
      
 SET @CSTEP=110  
 ---- SEND THE IRD01106 RELATED TO IRR TABLE  
 SELECT DISTINCT 'IRR_IRD01106_MIRROR' AS TARGET_TABLENAME,A.*  FROM IRD01106 A (NOLOCK)  WHERE A.irm_memo_id =@CMEMOID  
  
 SET @CSTEP=115  
 ---- SEND THE IRD01106 RELATED TO IRR TABLE  
  SELECT DISTINCT 'IRR_SKU_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS IRR_MEMO_ID FROM SKU A (NOLOCK) 
  JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
  WHERE B.IRM_MEMO_ID =@CMEMOID 
  union 
  SELECT DISTINCT 'IRR_SKU_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS IRR_MEMO_ID  FROM SKU A (NOLOCK) 
  JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE =B.NEW_PRODUCT_CODE 
  WHERE B.IRM_MEMO_ID =@CMEMOID  


  
 SET @CSTEP=120  
 ---- SEND THE SKU_OH RELATED TO GIVEN MEMO  
 SELECT DISTINCT 'IRR_SKU_OH_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS IRR_MEMO_ID  FROM SKU_OH A (NOLOCK) 
  JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
  WHERE B.IRM_MEMO_ID =@CMEMOID 
  union 
  SELECT DISTINCT 'IRR_SKU_OH_MIRROR' AS TARGET_TABLENAME,A.*,@CMEMOID AS IRR_MEMO_ID  FROM SKU_OH A (NOLOCK) 
  JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE =B.NEW_PRODUCT_CODE 
  WHERE B.IRM_MEMO_ID =@CMEMOID  

 SET @CSTEP=130  
 ---- SEND THE ARTICLE RELATED TO GIVEN IRR MEMO  
  IF OBJECT_ID ('TEMPDB..#TMPART','U') IS NOT NULL
     DROP TABLE #TMPART
 

  SELECT ARTICLE_CODE into #TMPART FROM IRD01106 A (NOLOCK) WHERE A.IRM_MEMO_ID =@CMEMOID 
  UNION
  SELECT OLD_ARTICLE_CODE FROM IRD01106 A (NOLOCK) WHERE A.IRM_MEMO_ID =@CMEMOID 
  UNION
  SELECT A.ARTICLE_CODE 
  FROM SKU A (NOLOCK) 
  JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
  WHERE B.IRM_MEMO_ID =@CMEMOID 
  UNION 
  SELECT A.ARTICLE_CODE   FROM SKU A (NOLOCK) 
  JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE =B.NEW_PRODUCT_CODE 
  WHERE B.IRM_MEMO_ID =@CMEMOID  
 
  SELECT DISTINCT 'IRR_ARTICLE_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS IRR_MEMO_ID 
  FROM ARTICLE A (NOLOCK)
  join #TMPART art on ART.article_code =A.article_code 
   
 SET @CSTEP=135  
 ---- SEND THE SECTIOND RELATED TO GIVEN IRR MEMO  

  SELECT DISTINCT 'IRR_SECTIOND_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS IRR_MEMO_ID 
  FROM SECTIOND A (NOLOCK)
  JOIN ARTICLE ART (NOLOCK) ON A.SUB_SECTION_CODE =ART.SUB_SECTION_CODE 
  JOIN #TMPART B ON ART.ARTICLE_CODE =B.ARTICLE_CODE 
   
 SET @CSTEP=140  
 ---- SEND THE SECTIONM RELATED TO GIVEN IRR MEMO  

  SELECT DISTINCT 'IRR_SECTIONM_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS IRR_MEMO_ID 
  FROM SECTIONM A
  JOIN  SECTIOND SD (NOLOCK) ON A.SECTION_CODE =SD.SECTION_CODE 
  JOIN ARTICLE ART (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE 
  join #TMPART B ON ART.ARTICLE_CODE =B.ARTICLE_CODE 
   
   
 SET @CSTEP=145  
 ---- SEND THE PARA1 RELATED TO GIVEN IRR MEMO  
 IF OBJECT_ID ('TEMPDB..#TMPPARA','U') IS NOT NULL
     DROP TABLE #TMPPARA

  SELECT PARA1_CODE,PARA2_CODE ,PARA3_CODE ,PARA4_CODE ,PARA5_CODE ,PARA6_CODE into #TMPPARA  FROM IRD01106 A (NOLOCK) WHERE A.IRM_MEMO_ID =@CMEMOID 
  UNION
  SELECT OLD_PARA1_CODE,OLD_PARA2_CODE ,OLD_PARA3_CODE ,OLD_PARA4_CODE ,OLD_PARA5_CODE ,OLD_PARA6_CODE  FROM IRD01106 A (NOLOCK) WHERE A.IRM_MEMO_ID =@CMEMOID 
  UNION
  SELECT a.PARA1_CODE,a.PARA2_CODE ,a.PARA3_CODE ,a.PARA4_CODE ,a.PARA5_CODE ,a.PARA6_CODE
  FROM SKU A (NOLOCK) 
  JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE =B.PRODUCT_CODE 
  WHERE B.IRM_MEMO_ID =@CMEMOID 
  UNION 
  SELECT a.PARA1_CODE,a.PARA2_CODE ,a.PARA3_CODE ,a.PARA4_CODE ,a.PARA5_CODE ,a.PARA6_CODE  
  FROM SKU A (NOLOCK) 
  JOIN IRD01106 B (NOLOCK) ON A.PRODUCT_CODE =B.NEW_PRODUCT_CODE 
  WHERE B.IRM_MEMO_ID =@CMEMOID  

  SELECT DISTINCT 'IRR_PARA1_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS IRR_MEMO_ID 
  FROM PARA1 A (NOLOCK)
  JOIN #TMPPARA B ON A.PARA1_CODE =B.PARA1_CODE 
   
 SET @CSTEP=150  
 ---- SEND THE PARA2 RELATED TO GIVEN IRR MEMO  
   
  SELECT DISTINCT 'IRR_PARA2_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS IRR_MEMO_ID 
  FROM PARA2 A (NOLOCK)
  JOIN #TMPPARA B ON A.PARA2_CODE =B.PARA2_CODE 



 SET @CSTEP=155  
 ---- SEND THE PARA3 RELATED TO GIVEN IRR MEMO  
 
  SELECT DISTINCT 'IRR_PARA3_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS IRR_MEMO_ID 
  FROM PARA3 A (NOLOCK)
  JOIN #TMPPARA B ON A.PARA3_CODE =B.PARA3_CODE 
   
 SET @CSTEP=160  
 ---- SEND THE PARA4 RELATED TO GIVEN IRR MEMO  
 
  SELECT DISTINCT 'IRR_PARA4_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS IRR_MEMO_ID 
  FROM PARA4 A (NOLOCK)
  JOIN #TMPPARA B ON A.PARA4_CODE =B.PARA4_CODE 
     
   
 SET @CSTEP=165  
 ---- SEND THE PARA5 RELATED TO GIVEN IRR MEMO  

 
  SELECT DISTINCT 'IRR_PARA5_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS IRR_MEMO_ID 
  FROM PARA5 A (NOLOCK)
  JOIN #TMPPARA B ON A.PARA5_CODE =B.PARA5_CODE 
     
   
 SET @CSTEP=170  
 ---- SEND THE PARA6 RELATED TO GIVEN IRR MEMO  
 
 
  SELECT DISTINCT 'IRR_PARA6_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS IRR_MEMO_ID 
  FROM PARA6 A (NOLOCK)
  JOIN #TMPPARA B ON A.PARA6_CODE =B.PARA6_CODE 
     
 SET @CSTEP=171
 ---- SEND THE PMT01106 TABLE  
 
 SELECT DISTINCT 'IRR_pmt01106_MIRROR' AS TARGET_TABLENAME, A.DEPT_ID,A.PRODUCT_CODE,A.BIN_ID,A.QUANTITY_IN_STOCK
 FROM PMT01106 A 
 JOIN IRD01106 B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
 WHERE B.IRM_MEMO_ID =@CMEMOID  
 UNION
 SELECT DISTINCT 'IRR_pmt01106_MIRROR' AS TARGET_TABLENAME, A.DEPT_ID,A.PRODUCT_CODE,A.BIN_ID,A.QUANTITY_IN_STOCK
 FROM PMT01106 A 
 JOIN IRD01106 B ON A.PRODUCT_CODE =B.NEW_PRODUCT_CODE 
 WHERE B.IRM_MEMO_ID =@CMEMOID  



 SET @CSTEP=175  
 
 GOTO END_PROC  
  
END TRY  
BEGIN CATCH  
PRINT 'ERROR IN IRR SENDING'+ERROR_MESSAGE()
 SET @CERRMSG='P: SP_SEND_MIRROR_IRR_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
 GOTO END_PROC  
END CATCH     
  
END_PROC:  
  
END  
---END OF PROCEDURE - SP_SEND_MIRROR_IRR_DATA_NEW  