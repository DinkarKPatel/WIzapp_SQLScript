CREATE PROCEDURE SP_PRD_MATERIAL_ISSUE_DYING_PENDING
(
 @ISSUE_ID VARCHAR(100)=''
)
AS
BEGIN
    
    
    IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL
       DROP TABLE #TMPISSUE
    
    SELECT D.AGENCY_NAME AS ISSUED_TO ,A.MEMO_NO AS ISSUE_NO,A.MEMO_DT AS ISSUE_DT,
           E.JOB_NAME,
           B.REF_PRD_WORKORDER_MEMOID AS WO_ID,
           MST.MEMO_NO AS WO_NO,
           AR.ARTICLE_NO AS DESIGN_NO, 
           AR.ARTICLE_NAME AS DESIGN_NAME,
           P1.PARA1_NAME AS DESIGN_COLOR,
           A.ISSUE_QTY AS QTY_PCS,
           AR1.ARTICLE_NO AS RM_ARTICLE_NO,
           AR1.ARTICLE_NAME AS RM_ARTICLE_NAME,
           P11.PARA1_CODE AS PARA1_CODE,
           P11.PARA1_NAME AS RM_COLOR,
           CAST(SUM(B.QUANTITY) AS VARCHAR(10))+' '+UOM.UOM_NAME AS QTY,
           SUM(B.QUANTITY) AS QTY_CAL,
           UOM.UOM_NAME,
           B.ITEM_REMARKS,
           COM.COMPANY_NAME,
           COM.LOGO_PATH,
           COM.ADDRESS1,
           COM.ADDRESS2,
           COM.CITY,
           COM.PHONES_FAX,
           C.MEMO_ID AS ISSUE_ID,
           C.REMARKS
    INTO #TMPISSUE
    FROM  PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING B (NOLOCK)  
    JOIN PRD_AGENCY_ISSUE_MATERIAL_MST_PENDING C (NOLOCK) ON B.MEMO_ID=C.MEMO_ID
    JOIN PRD_AGENCY_MST D (NOLOCK) ON C.REF_AGENCY_CODE=D.AGENCY_CODE
    JOIN JOBS E (NOLOCK) ON E.JOB_CODE=B.JOB_CODE
    JOIN PRD_WO_MST MST (NOLOCK) ON MST.MEMO_ID=B.REF_PRD_WORKORDER_MEMOID 
    LEFT JOIN
    (
     SELECT C.MEMO_NO,C.MEMO_DT, A.MEMO_ID,B.REF_PRD_WORKORDER_MEMOID AS ORDER_ID,A.ISSUE_QTY,A.ARTICLE_CODE,A.PARA1_CODE 
     FROM PRD_AGENCY_ISSUE_ROW_MATERIAL_DET A
     JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID AND A.ROW_ID=B.REF_MATERIAL_ROW_ID
     JOIN PRD_AGENCY_ISSUE_MATERIAL_MST C (NOLOCK) ON A.MEMO_ID=C.MEMO_ID
     GROUP BY C.MEMO_NO,C.MEMO_DT, A.MEMO_ID,B.REF_PRD_WORKORDER_MEMOID ,A.ISSUE_QTY,A.ARTICLE_CODE,A.PARA1_CODE 
    ) A ON A.MEMO_ID=B.REF_ISSUE_ID AND A.ORDER_ID=B.REF_PRD_WORKORDER_MEMOID
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=A.ARTICLE_CODE
    JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=A.PARA1_CODE
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=B.PRODUCT_UID
    JOIN ARTICLE AR1 (NOLOCK) ON AR1.ARTICLE_CODE=SKU.ARTICLE_CODE 
    JOIN PARA1 P11 (NOLOCK) ON P11.PARA1_CODE=SKU.PARA1_CODE
    JOIN UOM (NOLOCK) ON UOM.UOM_CODE=AR1.UOM_CODE
    JOIN COMPANY COM (NOLOCK) ON COM.COMPANY_CODE='01'
    WHERE C.MEMO_ID=@ISSUE_ID
    GROUP BY D.AGENCY_NAME ,A.MEMO_NO ,A.MEMO_DT ,
           E.JOB_NAME,
           B.REF_PRD_WORKORDER_MEMOID ,
           AR.ARTICLE_NO , 
           AR.ARTICLE_NAME ,
           P1.PARA1_NAME ,
           A.ISSUE_QTY ,
           AR1.ARTICLE_NO ,
           AR1.ARTICLE_NAME ,
           P11.PARA1_NAME ,
           UOM.UOM_NAME,B.ITEM_REMARKS,
           COM.COMPANY_NAME,
           COM.LOGO_PATH,
           COM.ADDRESS1,
           COM.ADDRESS2,
           COM.CITY,
           COM.PHONES_FAX,
           C.MEMO_ID,C.REMARKS,P11.PARA1_CODE,MST.MEMO_NO



SELECT A.* ,C.QTY_MTR
FROM #TMPISSUE A
JOIN 
(
	 
	 SELECT  A.ISSUE_ID,
	 --SUM(A.QTY_PCS) AS TOTAL_QTY_PCS,
	 SUM(CASE WHEN UOM_NAME<>'PCS' THEN QTY_CAL ELSE 0 END) AS QTY_MTR
	 FROM #TMPISSUE A
	 GROUP BY A.ISSUE_ID
) C ON A.ISSUE_ID=C.ISSUE_ID 
ORDER BY WO_NO,RM_ARTICLE_NO


SELECT  A.ISSUED_TO,A.ISSUE_NO,A.ISSUE_DT,
     SUM(A.QTY_PCS) AS FG_QTY_PCS,
     C.QTY_MTR  AS QTY_MTR,
     ISNULL(B.QUANTITY,0) AS SAMPLE
FROM
(
SELECT  A.ISSUED_TO,A.ISSUE_NO,A.ISSUE_DT,A.WO_ID,A.PARA1_CODE,  A.ISSUE_ID,QTY_PCS 
FROM #TMPISSUE A
GROUP BY A.ISSUED_TO,A.ISSUE_NO,A.ISSUE_DT,A.WO_ID,A.PARA1_CODE,  A.ISSUE_ID,QTY_PCS
) A
JOIN
(
     SELECT  A.ISSUE_ID,
	 SUM(CASE WHEN UOM_NAME<>'PCS' THEN QTY_CAL ELSE 0 END) AS QTY_MTR
	 FROM #TMPISSUE A
	 GROUP BY A.ISSUE_ID
) C ON A.ISSUE_ID=C.ISSUE_ID
LEFT JOIN
 (
  SELECT B.REF_ISSUE_ID,SUM(A.QUANTITY) AS QUANTITY 
  FROM PRD_AGENCY_ISSUE_MATERIAL_DET_SAMPLE A
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST_SAMPLE B ON A.MEMO_ID=B.MEMO_ID
  WHERE B.CANCELLED=0
  GROUP BY B.REF_ISSUE_ID
) B ON A.ISSUE_ID=B.REF_ISSUE_ID
GROUP BY A.ISSUED_TO,A.ISSUE_NO,A.ISSUE_DT,B.QUANTITY,C.QTY_MTR


END
