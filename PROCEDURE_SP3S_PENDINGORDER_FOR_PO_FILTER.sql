create PROCEDURE SP3S_PENDINGORDER_FOR_PO_FILTER
(
	@CWHERE NVARCHAR(MAX)='',
	@DLOGINDT DATEtIME='',
	@cdept_id varchar(5)=''
)
AS
BEGIN

	DECLARE @CSIZE VARCHAR(MAX),@CSIZE_SUM VARCHAR(MAX),@CSIZE_SUM_TOTAL VARCHAR(MAX),@CCMD NVARCHAR(MAX)
	PRINT @CWHERE
	SET @CWHERE=REPLACE(@CWHERE,'`','''')
	IF OBJECT_ID('TEMPDB..#PENDINGBUYERORDER','U') IS NOT NULL
		DROP TABLE #PENDINGBUYERORDER

	IF OBJECT_ID('TEMPDB..##PENDINGORDER_PIVOT','U') IS NOT NULL
		DROP TABLE ##PENDINGORDER_PIVOT
		
	CREATE TABLE #PENDINGBUYERORDER
	(
		ORDER_ID		VARCHAR(MAX),
		ORDER_NO	VARCHAR(MAX),
		ORDER_DT		DATETIME,
		AC_NAME		VARCHAR(MAX),
		QUANTITY		NUMERIC(14,2)
	)
	BEGIN TRY

		SET @CCMD=N'
		SELECT BUYER_ORDER_MST.ORDER_ID,BUYER_ORDER_MST.ORDER_NO,BUYER_ORDER_MST.ORDER_DT,LMV01106.AC_NAME,
		A.QUANTITY-(CASE WHEN MEMO_TYPE=1 THEN (ISNULL(B1.QUANTITY,0)+ISNULL(a.INV_QTY,0)) ELSE (ISNULL(B1.QUANTITY,0)+ISNULL(B.QUANTITY,0)) END) AS QUANTITY
		FROM BUYER_ORDER_DET A 
		LEFT OUTER JOIN
		(
			SELECT WOD_ROW_ID,SUM(QUANTITY) AS QUANTITY 
			FROM POD01106  
			JOIN POM01106 ON POD01106.PO_ID = POM01106.PO_ID
			WHERE POM01106.CANCELLED = 0  AND ISNULL(WOD_ROW_ID,'''') <> '''' 
			GROUP BY WOD_ROW_ID
		) B ON A.ROW_ID = B.WOD_ROW_ID
		LEFT OUTER JOIN
		(
			SELECT ORD_ROW_ID,SUM(QUANTITY) AS QUANTITY 
			FROM PLD01106  
			JOIN PLM01106 ON PLD01106.MEMO_ID = PLM01106.MEMO_ID
			WHERE PLM01106.CANCELLED = 0  AND ISNULL(ORD_ROW_ID,'''') <> '''' 
			GROUP BY ORD_ROW_ID
		) B1 ON A.ROW_ID = B1.ORD_ROW_ID
		JOIN BUYER_ORDER_MST (NOLOCK) ON A.ORDER_ID = BUYER_ORDER_MST.ORDER_ID
		JOIN LMV01106 (NOLOCK) ON BUYER_ORDER_MST.AC_CODE = LMV01106.AC_CODE
		WHERE BUYER_ORDER_MST.MEMO_TYPE in(1,2)
		and BUYER_ORDER_MST.wbo_for_dept_id='''+@cdept_id+'''
		and BUYER_ORDER_MST.DELIVERY_DT>='''+convert(varchar(10),@DLOGINDT,121)+'''
		AND A.QUANTITY-(CASE WHEN MEMO_TYPE=1 THEN (ISNULL(B1.QUANTITY,0)+ISNULL(a.INV_QTY,0)) ELSE (ISNULL(B1.QUANTITY,0)+ISNULL(B.QUANTITY,0)) END)>0
		AND BUYER_ORDER_MST.CANCELLED = 0 AND ISNULL(BUYER_ORDER_MST.Short_close,0) = 0  
		'
		
		PRINT 'STEP 1 :'+ @CCMD
		
		INSERT INTO  #PENDINGBUYERORDER
		EXEC SP_EXECUTESQL @CCMD

		--IF (0= @@ROWCOUNT)
		--BEGIN
		--	SELECT CONVERT(BIT,0) AS BCHK,ARTICLE_NO,ARTICLE_CODE,PARA1_CODE,PARA1_NAME FROM #PENDINGBUYERORDER
		--	RETURN
		--END
		

		--SELECT  
		--@CSIZE=ISNULL(@CSIZE,'')+(CASE WHEN ISNULL(@CSIZE,'')='' THEN '' ELSE ',' END ) +'['+PARA2_NAME+']',
		--@CSIZE_SUM=ISNULL(@CSIZE_SUM,'')+(CASE WHEN ISNULL(@CSIZE_SUM,'')='' THEN '' ELSE ',' END ) +'SUM(['+PARA2_NAME+']) AS ['+PARA2_NAME+']',
		--@CSIZE_SUM_TOTAL=ISNULL(@CSIZE_SUM_TOTAL,'')+(CASE WHEN ISNULL(@CSIZE_SUM_TOTAL,'')='' THEN '' ELSE '+' END ) +'ISNULL(SUM(['+PARA2_NAME+']),0)'
		--FROM #PENDINGBUYERORDER
		--GROUP BY PARA2_NAME
		
		----SELECT @CSIZE ,@CSIZE_SUM,@CSIZE_SUM_TOTAL

		--SET @CCMD=N'
		--SELECT ARTICLE_NO,ARTICLE_CODE,PARA1_CODE,PARA1_NAME,'+@CSIZE+
		--'INTO ##PENDINGORDER_PIVOT
		--FROM 
		--(
		--	SELECT * FROM #PENDINGBUYERORDER
		--)X
		--PIVOT
		--(
		--	SUM(QUANTITY)
		--	FOR PARA2_NAME IN ('+@CSIZE+')
		--)PVT'

		--PRINT 'STEP 2 :'+ @CCMD
		
		--EXEC SP_EXECUTESQL @CCMD
		
			
		
		SELECT CONVERT(BIT,0) AS BCHK,ORDER_ID,ORDER_NO,ORDER_DT,AC_NAME,SUM(QUANTITY) AS QUANTITY
		FROM #PENDINGBUYERORDER
		GROUP BY ORDER_ID,ORDER_NO,ORDER_DT,AC_NAME
		
		
	END TRY
	BEGIN CATCH
		SELECT @@ERROR
	END CATCH
END

--EXEC SP3S_PENDINGORDER_FOR_PO_FILTER ''