create PROCEDURE SAVETRAN_Proforma--(LocId 3 digit change by Sanjay:06-11-2024)
(
	@NUPDATEMODE		NUMERIC(2,0),
	@NSPID				varchar(40)='',
	@CMEMONOPREFIX      varchar(20)='',
	@CFINYEAR          VARCHAR(5),
	@MEMO_ID            VARCHAR(22) =''

)
AS
BEGIN
    DECLARE  @LENABLETEMPDATABASE	BIT,@CTEMPDBNAME VARCHAR(100),@NSTEP INT,@CLOCATIONID VARCHAR(4),
             @CMASTERTABLENAME VARCHAR(100),@CDETAILTABLENAME VARCHAR(100),
             @CTEMPMASTERTABLENAME VARCHAR(100),@CTEMPDETAILTABLENAME VARCHAR(100),
             @CTEMPMASTERTABLE VARCHAR(100),@CTEMPDETAILTABLE VARCHAR(100),
             @CKEYFIELD1 VARCHAR(100),@CMEMONO VARCHAR(10),
             @NMEMONOLEN INT,@CCMD NVARCHAR(MAX),@NSAVETRANLOOP INT,@CMEMONOVAL VARCHAR(20),
             @TMP_BOX_NO VARCHAR(100),@CKEYFIELDVAL1 VARCHAR(100),
             @BOX_ID_FIN_YEAR VARCHAR(4),@CHODEPT_ID VARCHAR(4),@CPREFIX VARCHAR(10),@CERRORMSG varchar(1000)
    
	SET @CTEMPDBNAME = ''
	
	SET	@NSTEP = 2
	
	SET @CMASTERTABLENAME	= 'DebitNote_Proforma_MST'
	SET @CDETAILTABLENAME	= 'DebitNote_Proforma_Det'
		
	SET @CTEMPMASTERTABLENAME	= 'DNPF_DebitNote_Proforma_MST_UPLOAD'
	SET @CTEMPDETAILTABLENAME	= 'DNPF_DebitNote_Proforma_DET_UPLOAD'
			
	SET @CTEMPMASTERTABLE	= @CTEMPDBNAME + @CTEMPMASTERTABLENAME
	SET @CTEMPDETAILTABLE	= @CTEMPDBNAME + @CTEMPDETAILTABLENAME
	
	SET @CKEYFIELD1			= 'Memo_Id'
	SET @CMEMONO			= 'Memo_No'
	  
	  IF @NUPDATEMODE IN (1,2)
		SELECT @CLOCATIONID =LOCATION_CODE  FROM DNPF_DebitNote_Proforma_MST_UPLOAD (NOLOCK) WHERE sp_id=@NSPID
	  ELSE
		SELECT @CLOCATIONID =LOCATION_CODE  FROM DebitNote_Proforma_MST (NOLOCK) WHERE Memo_Id=@MEMO_ID
  

	    select @CHODEPT_ID=VALUE  from config where config_option ='HO_LOCATION_ID'
   
   
	BEGIN TRY	
	BEGIN TRANSACTION

	SET	@NSTEP = 4
	IF ISNULL(@CLOCATIONID,'')=''
	BEGIN
	    SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + 'LOCATION IS CAN NOT BE BLANK'
	    GOTO END_PROC

	END

	SET	@NSTEP = 6
	IF @CLOCATIONID<>@CHODEPT_ID
	BEGIN 
	     
		 SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + 'Proforma Setup allow only Head Office'
	     GOTO END_PROC
	END



	IF @NUPDATEMODE=3 
	BEGIN
	     IF ISNULL(@MEMO_ID,'')=''
		 BEGIN
			SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + 'BOX ID CAN NOT BE BLANK FOR CANCELATION'
			GOTO END_PROC
		END
	   UPDATE DebitNote_Proforma_MST SET CANCELLED=1 WHERE Memo_id =@MEMO_ID
      GOTO END_PROC
	END
	
    UPDATE DNPF_DEBITNOTE_PROFORMA_MST_UPLOAD SET LOCATION_CODE =@CLOCATIONID WHERE SP_ID =@NSPID AND ISNULL(LOCATION_CODE,'')=''

		IF @NUPDATEMODE = 1 -- ADDMODE	
		BEGIN	
			SET @NSTEP = 20		-- GENERATING NEW KEY
			
			if @CMEMONOPREFIX=''
			SET @CMEMONOPREFIX=@CLOCATIONID+'-'

			 SET @NMEMONOLEN= LEN(@CMEMONOPREFIX)+6
			

			
			SET @NSAVETRANLOOP=0
			WHILE @NSAVETRANLOOP=0
			BEGIN
				EXEC GETNEXTKEY @CMASTERTABLENAME, @CMEMONO, @NMEMONOLEN, @CMEMONOPREFIX, 1,
								@CFINYEAR,0, @CMEMONOVAL OUTPUT   
				
				SET @NSTEP = 30
				
				PRINT @CMEMONOVAL
				SET @CCMD=N'IF EXISTS ( SELECT '+@CMEMONO+' FROM '+@CMASTERTABLENAME+' 
										WHERE '+@CKEYFIELD1+'='''+@CMEMONOVAL+''' )
								SET @NLOOPOUTPUT=0
							ELSE
								SET @NLOOPOUTPUT=1'
				PRINT @CCMD
				EXEC SP_EXECUTESQL @CCMD, N'@NLOOPOUTPUT BIT OUTPUT',@NLOOPOUTPUT=@NSAVETRANLOOP OUTPUT
			END
            
              
            SET @NSTEP = 40
            SET @CKEYFIELDVAL1 = @CLOCATIONID + RIGHT(@CFINYEAR,2)+ LTRIM(RTRIM(@CMEMONOVAL))  
            
            IF @CKEYFIELDVAL1 IS NULL OR @CKEYFIELDVAL1 LIKE '%LATER%'  
			BEGIN
				  SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR CREATING NEXT MEMO ID....'
				  GOTO END_PROC
			END
            
			-- UPDATING NEWLY GENERATED JOB ORDER NO AND JOB ORDER ID IN PIM AND PID TEMP TABLES
			SET @CCMD = 'UPDATE ' + @CTEMPMASTERTABLE + ' SET ' + @CMEMONO+'=''' + @CMEMONOVAL+''',' + 
						@CKEYFIELD1+' = '''+@CKEYFIELDVAL1+''' WHERE   SP_ID='''+LTRIM(RTRIM(@NSPID))+''''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
		
      

		END					-- END OF ADDMODE
		ELSE				-- CALLED FROM EDITMODE
		BEGIN				-- START OF EDITMODE
		
			SET @NSTEP = 50		-- GETTING ID INFO FROM TEMP TABLE

			-- GETTING JOB ORDER ID WHICH IS BEING EDITED
			SET @CCMD = 'SELECT @CKEYFIELDVAL1 = ' + @CKEYFIELD1 + ', @CMEMONOVAL = ' + @CMEMONO + ' FROM '
						+ @CTEMPMASTERTABLE +' WHERE  SP_ID='''+@NSPID+''' '
			
			EXEC SP_EXECUTESQL @CCMD, N'@CKEYFIELDVAL1 VARCHAR(50) OUTPUT, @CMEMONOVAL VARCHAR(50) OUTPUT', 
							   @CKEYFIELDVAL1 OUTPUT, @CMEMONOVAL OUTPUT
			IF (@CKEYFIELDVAL1 IS NULL ) OR (@CMEMONOVAL IS NULL )
			BEGIN
				  SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR ACCESSING THE RECORD TO BE MODIFIED...'
				  GOTO END_PROC  		
			END


			SET @CCMD = N'DELETE A FROM ' + @CDETAILTABLENAME + ' A   
			   WHERE A.MEMO_ID = ''' + @CKEYFIELDVAL1 + '''  
			   AND A.ROW_ID IN   
			   (  
				SELECT A.ROW_ID   
				FROM ' + @CDETAILTABLENAME + ' A   
				LEFT OUTER JOIN ' + @CTEMPDETAILTABLE + ' B ON A.ROW_ID = B.ROW_ID  and  b.sp_id ='''+@NSPID+'''
				WHERE A.MEMO_ID = ''' + @CKEYFIELDVAL1 + '''  
				AND   B.ROW_ID IS NULL  
			   )'  
			PRINT @CCMD        
			EXEC SP_EXECUTESQL @CCMD  

		
		END					-- END OF EDITMODE

		SET @NSTEP = 95
		
		-- RECHECKING IF ID IS STILL LATER
		IF @CKEYFIELDVAL1 IS NULL OR @CKEYFIELDVAL1 LIKE '%LATER%'
		BEGIN
			SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR CREATING NEXT MEMO ID....'
			GOTO END_PROC
		END
		 DECLARE @CWHERECLAUSE VARCHAR(100)
         SET @CWHERECLAUSE = ' b.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''

		-- UPDATING MASTER TABLE (PIM01106) FROM TEMP TABLE
		SET @NSTEP = 100		-- UPDATING MASTER TABLE

	
		
			EXEC UPDATEMASTERXN_OPT 
				  @CSOURCEDB	= @CTEMPDBNAME
				, @CSOURCETABLE = @CTEMPMASTERTABLENAME
				, @CDESTDB		= ''
				, @CDESTTABLE	= @CMASTERTABLENAME
				, @CKEYFIELD1	= @CKEYFIELD1
				, @BALWAYSUPDATE = 1
				,@CFILTERCONDITION=@CWHERECLAUSE

			-- UPDATING TRANSACTION TABLE (PID01106) FROM TEMP TABLE
			SET @NSTEP = 110		-- UPDATING TRANSACTION TABLE

			-- UPDATING ROW_ID IN TEMP TABLES - PAYMODE_XN_DET
			SET @CCMD = N'UPDATE ' + @CTEMPDETAILTABLE + ' SET ROW_ID = ''' + @CLOCATIONID + ''' + CONVERT(VARCHAR(40), NEWID())
						  WHERE LEFT(ROW_ID,5) = ''LATER'' AND   SP_ID='''+@NSPID+''' '
			EXEC SP_EXECUTESQL @CCMD

			SET @NSTEP = 115                                                                                                                     
			
            SET @CCMD = 'UPDATE ' + @CTEMPDETAILTABLE + ' SET ' + @CKEYFIELD1+'=''' + @CKEYFIELDVAL1+''' WHERE  SP_ID='''+@NSPID+''''
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
	
			-- INSERTING/UPDATING THE ENTRIES IN PRD_JID TABLE FROM TEMPTABLE
			SET @NSTEP = 117		-- UPDATING TRANSACTION TABLE - INSERTING NEW ENTRIES

		
			-- PAYMODE_XN_DET
			EXEC UPDATEMASTERXN_OPT 
				  @CSOURCEDB	= @CTEMPDBNAME
				, @CSOURCETABLE = @CTEMPDETAILTABLENAME
				, @CDESTDB		= ''
				, @CDESTTABLE	= @CDETAILTABLENAME
				, @CKEYFIELD1	= 'ROW_ID'
				, @BALWAYSUPDATE = 1			
				,@CFILTERCONDITION=@CWHERECLAUSE	

		
       
	
	END TRY
	BEGIN CATCH
		SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		GOTO END_PROC
	END CATCH

	
END_PROC:
    
    IF @@TRANCOUNT>0 
	BEGIN
		IF ISNULL(@CERRORMSG,'')='' 
		BEGIN
			commit TRANSACTION
		END	
		ELSE
		    ROLLBACK	
	END	

	
	   SELECT @CERRORMSG AS ERRMSG,@CKEYFIELDVAL1 AS MEMO_ID

	  DELETE A FROM DNPF_DebitNote_Proforma_MST_UPLOAD A (NOLOCK) WHERE SP_ID=@NSPID
	  DELETE A FROM DNPF_DebitNote_Proforma_MST_UPLOAD A (NOLOCK) WHERE SP_ID=@NSPID

END
