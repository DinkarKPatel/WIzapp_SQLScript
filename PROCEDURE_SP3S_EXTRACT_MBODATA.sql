CREATE PROCEDURE SP3S_EXTRACT_MBODATA--(LocId 3 digit change by Sanjay:06-11-2024)
@NMODE INT,
@CXNTYPE VARCHAR(10),
@CLOCID VARCHAR(5),
@DCUTOFFDATE DATETIME='',
@NSPID INT=0
AS
BEGIN
	DECLARE @DSEARCHXNDT DATETIME,@CSOURCEDB VARCHAR(200),@CTEMPTABLENAME VARCHAR(200),@CTEMPTABLE VARCHAR(200),
	@CCMD NVARCHAR(MAX),@CSEARCHXNTYPE VARCHAR(10),@CLASTRUNDATE VARCHAR(15),@CDONOTENFORCEDAYCLOSE VARCHAR(4),
	@DLASTRUNDATE DATETIME
	
		
	SET @CSOURCEDB=DB_NAME()+'_TEMP.DBO.'
	SET @NSPID=@@SPID
	
	SET @CTEMPTABLENAME='TMP_MBOXNSDATA_'+LTRIM(RTRIM(STR(@NSPID)))
	SET @CTEMPTABLE=@CSOURCEDB+@CTEMPTABLENAME
		
	IF @NMODE=1
	BEGIN

		SELECT TOP 1 @CDONOTENFORCEDAYCLOSE = VALUE FROM CONFIG  WHERE CONFIG_OPTION = 'DO_NOT_ENFORCE_LAST_RUN_DT'
		
		SET @CDONOTENFORCEDAYCLOSE = ISNULL(@CDONOTENFORCEDAYCLOSE,'')
		
		IF @CDONOTENFORCEDAYCLOSE='1'
		BEGIN
			SELECT @DLASTRUNDATE=MAX(CM_DT) FROM CMM01106 
			
			IF ISNULL(@DLASTRUNDATE,'')=''
				SELECT @DLASTRUNDATE=MAX(RECEIPT_DT) FROM PIM01106 
			
			IF ISNULL(@DLASTRUNDATE,'')<>''
				SET @DLASTRUNDATE=@DLASTRUNDATE-1
		END			
		ELSE
		BEGIN
			SELECT TOP 1 @CLASTRUNDATE = dbo.fn_getlastrundate()
			IF ISNULL(@CLASTRUNDATE,'')<>''
				SET @DLASTRUNDATE=CONVERT(DATETIME,@CLASTRUNDATE)
		END
		
		IF ISNULL(@DLASTRUNDATE,'')=''
			SET @DLASTRUNDATE=@DCUTOFFDATE
	
		IF @CXNTYPE='SLS'
		BEGIN
			SELECT TOP 1 @DSEARCHXNDT=CM_DT,@CSEARCHXNTYPE='MBOSLS' FROM CMM01106 A (NOLOCK) 
			LEFT OUTER JOIN MIRRORLOG B ON CONVERT(VARCHAR,A.CM_DT,112)=B.XN_ID AND B.XN_TYPE='MBOSLS'
			WHERE CM_DT BETWEEN @DCUTOFFDATE AND @DLASTRUNDATE AND B.XN_ID IS NULL ORDER BY CM_DT 
		END	
		ELSE
		IF @CXNTYPE='CHI'
		BEGIN
			SELECT TOP 1 @DSEARCHXNDT=RECEIPT_DT,@CSEARCHXNTYPE='MBOPUR' FROM PIM01106 A (NOLOCK) 
			LEFT OUTER JOIN MIRRORLOG B ON CONVERT(VARCHAR,A.RECEIPT_DT,112)=B.XN_ID AND B.XN_TYPE='MBOPUR'
			WHERE RECEIPT_DT BETWEEN @DCUTOFFDATE AND @DLASTRUNDATE AND B.XN_ID IS NULL AND RECEIPT_DT<>''  ORDER BY RECEIPT_DT
			
			IF ISNULL(@DSEARCHXNDT,'')=''
				SELECT TOP 1 @DSEARCHXNDT=RECEIPT_DT,@CSEARCHXNTYPE='MBOWSR' FROM CNM01106 A (NOLOCK) 
				LEFT OUTER JOIN MIRRORLOG B ON CONVERT(VARCHAR,A.RECEIPT_DT,112)=B.XN_ID AND B.XN_TYPE='MBOWSR'
				WHERE RECEIPT_DT BETWEEN @DCUTOFFDATE AND @DLASTRUNDATE AND B.XN_ID IS NULL AND RECEIPT_DT<>''  ORDER BY RECEIPT_DT			
		END	
		ELSE
		IF @CXNTYPE='CHO'
		BEGIN
			SELECT TOP 1 @DSEARCHXNDT=RM_DT,@CSEARCHXNTYPE='MBOPRT' FROM RMM01106 A (NOLOCK) 
			LEFT OUTER JOIN MIRRORLOG B ON CONVERT(VARCHAR,A.RM_DT,112)=B.XN_ID AND B.XN_TYPE='MBOPRT'
			WHERE RM_DT BETWEEN @DCUTOFFDATE AND @DLASTRUNDATE AND B.XN_ID IS NULL AND RM_DT<>''  ORDER BY RM_DT
			
			IF ISNULL(@DSEARCHXNDT,'')=''
				SELECT TOP 1 @DSEARCHXNDT=INV_DT,@CSEARCHXNTYPE='MBOWSL' FROM INM01106 A (NOLOCK) 
				LEFT OUTER JOIN MIRRORLOG B ON CONVERT(VARCHAR,A.INV_DT,112)=B.XN_ID AND B.XN_TYPE='MBOWSL'
				WHERE INV_DT BETWEEN @DCUTOFFDATE AND @DLASTRUNDATE AND B.XN_ID IS NULL  ORDER BY INV_DT			
			
		END

	
		IF ISNULL(@DSEARCHXNDT,'')<>''
		BEGIN
					
			IF OBJECT_ID(@CTEMPTABLE,'U') IS NOT NULL
			BEGIN
				SET @CCMD=N'DROP TABLE '+@CTEMPTABLE
				EXEC SP_EXECUTESQL @CCMD
			END	
			
			IF @CXNTYPE='SLS'
				SET @CCMD=N'SELECT '''+@CXNTYPE+'_MBODATA'' AS TARGET_TABLENAME,''MBOSLS'' AS XN_TYPE,'''+@CLOCID+''' AS DEPT_ID,CM_NO AS MEMO_NO,CONVERT(VARCHAR,CM_DT,112) AS MEMO_DT,PRODUCT_CODE,QUANTITY,RFNET AS NET,CANCELLED
				INTO '+@CTEMPTABLE+' FROM CMD01106 A JOIN CMM01106 B ON A.CM_ID=B.CM_ID
				WHERE B.CM_DT='''+CONVERT(VARCHAR,@DSEARCHXNDT,110)+''' ORDER BY CM_NO'
			ELSE
			IF @CXNTYPE='CHI' AND @CSEARCHXNTYPE='MBOPUR'
				SET @CCMD=N'SELECT '''+@CXNTYPE+'_MBODATA'' AS TARGET_TABLENAME,''MBOPUR'' AS XN_TYPE,'''+@CLOCID+''' AS DEPT_ID,
				''PUR''+MRR_NO AS MEMO_NO,CONVERT(VARCHAR,RECEIPT_DT,112) AS MEMO_DT,
				PRODUCT_CODE,QUANTITY,CANCELLED INTO '+@CTEMPTABLE+' FROM PID01106 A JOIN PIM01106 B ON A.MRR_ID=B.MRR_ID
				WHERE B.RECEIPT_DT='''+CONVERT(VARCHAR,@DSEARCHXNDT,110)+''''
			ELSE	
			IF @CXNTYPE='CHI' AND @CSEARCHXNTYPE='MBOWSR'
				SET @CCMD=N'SELECT '''+@CXNTYPE+'_MBODATA'' AS TARGET_TABLENAME,''MBOWSR'' AS XN_TYPE,'''+@CLOCID+''' AS DEPT_ID,
				''WSR''+CN_NO AS MEMO_NO,CONVERT(VARCHAR,RECEIPT_DT,112) AS MEMO_DT,
				PRODUCT_CODE,QUANTITY,CANCELLED INTO '+@CTEMPTABLE+' FROM CND01106 A JOIN CNM01106 B ON A.CN_ID=B.CN_ID
				WHERE B.RECEIPT_DT='''+CONVERT(VARCHAR,@DSEARCHXNDT,110)+'''
				ORDER BY MEMO_NO'
			ELSE
			IF @CXNTYPE='CHO' AND @CSEARCHXNTYPE='MBOPRT'
				SET @CCMD=N'SELECT '''+@CXNTYPE+'_MBODATA'' AS TARGET_TABLENAME,''MBOPRT'' AS XN_TYPE,'''+@CLOCID+''' AS DEPT_ID,
				''PRT''+RM_NO AS MEMO_NO,CONVERT(VARCHAR,RM_DT,112) AS MEMO_DT,PRODUCT_CODE,QUANTITY,CANCELLED
				INTO '+@CTEMPTABLE+' FROM RMD01106 A JOIN RMM01106 B ON A.RM_ID=B.RM_ID
				WHERE B.RM_DT='''+CONVERT(VARCHAR,@DSEARCHXNDT,110)+''''
			ELSE
			IF @CXNTYPE='CHO' AND @CSEARCHXNTYPE='MBOWSL'
				SET @CCMD=N'SELECT '''+@CXNTYPE+'_MBODATA'' AS TARGET_TABLENAME,''MBOWSL'' AS XN_TYPE,'''+@CLOCID+''' AS DEPT_ID,
				''WSL''+INV_NO AS MEMO_NO,CONVERT(VARCHAR,INV_DT,112) AS MEMO_DT,PRODUCT_CODE,QUANTITY,CANCELLED
				INTO '+@CTEMPTABLE+' FROM IND01106 A JOIN INM01106 B ON A.INV_ID=B.INV_ID
				WHERE B.INV_DT='''+CONVERT(VARCHAR,@DSEARCHXNDT,110)+'''
				ORDER BY MEMO_NO'
				
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
			SET @CCMD=N'SELECT '''+@CTEMPTABLE+''' AS TMP_TABLENAME,'+LTRIM(RTRIM(STR(@NSPID)))+' AS SP_ID,
			'''+@CLOCID+CONVERT(VARCHAR,@DSEARCHXNDT,112)+@CSEARCHXNTYPE+''' AS FILE_NAME'
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
		END				
		ELSE
			SELECT '' AS TMP_TABLENAME,0 AS SP_ID,'' AS FILE_NAME
	END		
	
	ELSE
	IF @NMODE=2
	BEGIN	
		 IF @CXNTYPE='SLS'
			 SET @CCMD=N'SELECT XN_TYPE,MEMO_DT AS XN_ID,MAX(LAST_UPDATE) AS LAST_UPDATE 
			 FROM CMM01106 A (NOLOCK) JOIN '+@CTEMPTABLE+' B ON A.CM_DT=B.MEMO_DT
			 GROUP BY XN_TYPE,MEMO_DT'
		 ELSE
		 IF @CXNTYPE='CHI'		 
			 SET @CCMD=N'SELECT XN_TYPE,MEMO_DT AS XN_ID,MAX(LAST_UPDATE) AS LAST_UPDATE 
			 FROM PIM01106 A (NOLOCK) JOIN '+@CTEMPTABLE+' B ON A.RECEIPT_DT=B.MEMO_DT
			 WHERE XN_TYPE=''MBOPUR''
			 GROUP BY XN_TYPE,MEMO_DT
			 UNION
			 SELECT XN_TYPE,MEMO_DT AS XN_ID,MAX(LAST_UPDATE) AS LAST_UPDATE 
			 FROM CNM01106 A (NOLOCK) JOIN '+@CTEMPTABLE+' B ON A.RECEIPT_DT=B.MEMO_DT
			 WHERE XN_TYPE=''MBOWSR''
			 GROUP BY XN_TYPE,MEMO_DT'
		 ELSE
		 IF @CXNTYPE='CHO'		 
			 SET @CCMD=N'SELECT XN_TYPE,MEMO_DT AS XN_ID,MAX(LAST_UPDATE) AS LAST_UPDATE 
			 FROM RMM01106 A (NOLOCK) JOIN '+@CTEMPTABLE+' B ON A.RM_DT=B.MEMO_DT
			 WHERE XN_TYPE=''MBOPRT''
			 GROUP BY XN_TYPE,MEMO_DT
			 UNION
			 SELECT XN_TYPE,MEMO_DT AS XN_ID,MAX(LAST_UPDATE) AS LAST_UPDATE 
			 FROM INM01106 A (NOLOCK) JOIN '+@CTEMPTABLE+' B ON A.INV_DT=B.MEMO_DT
			 WHERE XN_TYPE=''MBOWSL''
			 GROUP BY XN_TYPE,MEMO_DT'

		INSERT MIRRORLOG (XN_TYPE, XN_ID, LAST_UPDATE)  			 
		EXEC SP_EXECUTESQL @CCMD
	END
END
