CREATE PROCEDURE SP_VALIDATEXN_BEFORESAVE_WSL--(LocId 3 digit change by Sanjay:30-10-2024)
(
	@NSPID			VARCHAR(40),
	@CUSERCODE		NVARCHAR(10),
	@NUPDATEMODE	INT,
	@CRETVAL		NVARCHAR(MAX) OUTPUT,
	@BNEGSTOCKFOUND BIT OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
BEGIN TRY

	DECLARE @CCMD			NVARCHAR(MAX),
			@CTEMPINM		NVARCHAR(MAX),
			@CTEMPIND		NVARCHAR(MAX),
			@NSTEP			INT,@cMissingPcFcMrp VARCHAR(50),@CINVID VARCHAR(50),@NOLDENTRYMODE NUMERIC(1,0),
			@CERRPRODUCTCODE	VARCHAR(50),
			@CTEMPDBNAME	VARCHAR(50),@cErrpc VARCHAR(50),
			@CSTATECODE CHAR(7),@CLOCSSTMEMOID VARCHAR(40),@CCMDSUBSECTION VARCHAR(100),@CCURLOCID VARCHAR(4),
			@CSTATENAME VARCHAR(100),@CERREMPCODE CHAR(7),@NCMMDISCOUNT NUMERIC(6,2),@NCRDISCOUNTPCT NUMERIC(10,2),
			@NCRDAYS INT,@NDISCOUNTAMT NUMERIC(10,2),@NTAXAMT NUMERIC(10,2),@NDISCOUNTPCT NUMERIC(6,2),@NTAXPCT NUMERIC(6,2),
			@CERRARTICLENO VARCHAR(100),@CERRPARA1NAME VARCHAR(50),@CERRPARA2NAME VARCHAR(50),@NENTRYMODE INT,
			@CALLOWBLANKINVOICE VARCHAR(5),@CGSTCUTOFFDATE VARCHAR(10),@BGSTBILL BIT,@cTargetLocId VARCHAR(4),
			@INVMODE INT,@TAXPERC NUMERIC(7,3),@TAXPERC1 NUMERIC(7,3),@CLOCATION VARCHAR(4),@INVDT DATETIME,@CPRODUCT_CODE VARCHAR(50),@NMRP NUMERIC(14,2),
			@BFLAG BIT,@CCONVALTAX VARCHAR(4),@CDONOTALLOWMIXINGLOCALTAX VARCHAR(4),@CWHERECLAUSE VARCHAR(200)


	SET @NSTEP=0

	SET @CTEMPDBNAME=''
	SET @NSTEP=1
	--+LTRIM(RTRIM(@NSPID))
	SET @CTEMPINM=@CTEMPDBNAME+ 'WSL_INM01106_UPLOAD'
	SET @CTEMPIND=@CTEMPDBNAME+ 'WSL_IND01106_UPLOAD'
	SET @CRETVAL=''


	DECLARE @tInm Table (inv_id VARCHAR(50),location_code VARCHAR(4), inv_no VARCHAR(50),party_dept_id VARCHAR(4),inv_mode NUMERIC(1,0),inv_dt DATETIME,
	fin_year VARCHAR(5),ENTRY_MODE NUMERIC(1,0),DISCOUNT_PERCENTAGE NUMERIC(6,2),xn_item_type int)

	DECLARE @tInd Table (inv_id VARCHAR(50),product_code VARCHAR(50),DISCOUNT_PERCENTAGE NUMERIC(6,2),
	DISCOUNT_AMOUNT NUMERIC(10,2),rate numeric(10,2),quantity numeric(14,3),BO_DET_ROW_ID VARCHAR(50))

	INSERT @tInm (inv_id,location_code,inv_no,party_dept_id,inv_mode,inv_dt,fin_year,ENTRY_MODE,xn_item_type)
	SELECT inv_id,location_code,inv_no,party_dept_id,inv_mode,inv_dt,fin_year,ENTRY_MODE ,xn_item_type
	FROM wsl_inm01106_upload (NOLOCK) WHERE sp_id=@nSpId

	INSERT @tInd (inv_id,product_code,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,rate,quantity,BO_DET_ROW_ID)
	SELECT inv_id,product_code,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,rate,quantity,BO_DET_ROW_ID
	FROM wsl_ind01106_upload (NOLOCK) WHERE sp_id=@nSpId

	--VALIDATING RECORD COUNT

	declare @nxn_itemtype int 
	select @nxn_itemtype=xn_item_type,@NENTRYMODE=entry_mode from @tInm

	IF NOT EXISTS (SELECT TOP 1 inv_id FROM @tInm)
		SET @CRETVAL='NO RECORD FOUND AT MASTER LEVEL..... CANNOT PROCEED'
	IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		GOTO ATLAST

	IF EXISTS (SELECT product_code from @TInd GROUP BY product_code having sum(quantity)=0)
	BEGIN
		DECLARE @cZeroPc VARCHAR(50)
		SELECT TOP 1 @cZeroPc=product_code FROM
					(select product_code from @TInd GROUP BY product_code having sum(quantity)=0) a

		SET @CRETVAL='Bar code# '+@cZeroPc+' having  Zero quantity not allowed '
		GOTO ATLAST
	END		

	IF EXISTS (SELECT TOP 1 a.product_code from @TInd a JOIN buyer_order_det b (NOLOCK) ON b.row_id=a.BO_DET_ROW_ID
			   JOIN buyer_order_mst c (NOLOCK) ON c.order_id=b.order_id	
			   WHERE ISNULL(c.Short_close,0)=1 AND c.memo_type=1)
	BEGIN
		DECLARE @cShortCloseBONo VARCHAR(50),@dShortCloseboDt DATETIME

		SELECT TOP 1 @CERRPRODUCTCODE=a.product_code,@cShortCloseBONo=c.order_no,@dShortCloseboDt=c.order_dt
		from @TInd a JOIN buyer_order_det b (NOLOCK) ON b.row_id=a.BO_DET_ROW_ID
		JOIN buyer_order_mst c (NOLOCK) ON c.order_id=b.order_id	
		WHERE ISNULL(c.Short_close,0)=1 AND c.memo_type=1

		SET @CRETVAL='Bar code# '+@CERRPRODUCTCODE+' being Invoiced against Short Close Buyer Order#'+@cShortCloseBONo+'
					  Dated :'+CONVERT(VARCHAR,@dShortCloseboDt,105)+'...Cannot save'
		GOTO ATLAST
	END		

	DECLARE @cEnableFcXns VARCHAR(4)
	SELECT TOP 1 @cEnableFcXns=value FROM config WHERE config_option='ENABLE_MULTI_CURRENCY'

	IF ISNULL(@cEnableFcXns,'')='1'
	BEGIN

		SELECT TOP 1 @cMissingPcFcMrp=a.PRODUCT_CODE FROM @tInd A 
		JOIN @tInm b  ON a.INV_ID=b.inv_id 
		JOIN location c (NOLOCK) ON c.dept_id=b.party_dept_id
		JOIN location e (NOLOCK) ON e.dept_id=b.location_code
		LEFT OUTER JOIN sku_fc_prices d (NOLOCK) ON d.product_code=a.PRODUCT_CODE AND c.fc_code=d.fc_code 
		WHERE b.inv_mode=2 AND d.product_code IS NULL
		AND ISNULL(c.fc_code,'') NOT IN ('','0000000') 
		AND ISNULL(e.fc_code,'0000000')<>ISNULL(c.fc_code,'0000000')
		AND ISNULL(e.fc_code,'')<>'' 
	
		IF ISNULL(@cMissingPcFcMrp,'')<>''
		BEGIN
			SELECT DISTINCT a.PRODUCT_CODE,0 AS QUANTITY_IN_STOCK,'Following bar code(s) FC MRP details for Target Location not found' AS ERRMSG
			FROM @tInd A 
			JOIN @tInm b ON a.INV_ID=b.inv_id
			JOIN location c (NOLOCK) ON c.dept_id=b.party_dept_id
			LEFT OUTER JOIN sku_fc_prices d (NOLOCK) ON d.product_code=a.PRODUCT_CODE AND c.fc_code=d.fc_code 
			WHERE d.product_code	IS NULL

			SET @BNEGSTOCKFOUND=1
		
			RETURN
		END
	END
							   
	SET @NSTEP=2

	SELECT @CGSTCUTOFFDATE=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION ='GST_CUT_OFF_DATE'

	SET @NSTEP=4
	--VALIDATING FINYEAR
	SELECT @CRETVAL=(CASE WHEN '01' + LTRIM(RTRIM((DBO.FN_GETFINYEAR(INV_DT))))=FIN_YEAR THEN '' 
				ELSE 'MEMO DATE IS NOT IN CURRENT FINANCIAL YEAR...CAN NOT PROCEED' END)
				FROM @tINM 

	IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		GOTO ATLAST

	SET @NSTEP=5



	SET @NSTEP=10
	--VALIDATING DISCOUNT PERCENTAGE
	SELECT TOP 1 @NDISCOUNTPCT=DISCOUNT_PERCENTAGE FROM @tINM WHERE DISCOUNT_PERCENTAGE>100 

	IF ISNULL(@NDISCOUNTPCT,0)<>0
	BEGIN
		SET @CRETVAL='DISCOUNT PERCENTAGE SHOULD BE LESS THAN OR EQUAL TO 100..... CANNOT PROCEED'
		GOTO ATLAST
	END

	SET @NSTEP=14
	--VALIDATING ITEM LEVEL DISCOUNT PERCENTAGE
	SELECT TOP 1 @CERRPRODUCTCODE=PRODUCT_CODE FROM @tInd A WHERE DISCOUNT_PERCENTAGE>100 

	IF ISNULL(@CERRPRODUCTCODE,'')<>''
	BEGIN
		SET @CRETVAL='ITEM CODE: '+@CERRPRODUCTCODE +'...DISCOUNT PERCENTAGE SHOULD LESS THAN OR EQUAL TO 100..... CANNOT PROCEED'
		GOTO ATLAST
	END

	SET @NSTEP=14.2
	SELECT @CINVID=INV_ID,@INVMODE = INV_MODE,@cTargetLocId=party_dept_id,@INVDT=INV_DT  FROM @tInm

	SET @BGSTBILL=0

	IF (@INVDT>=CONVERT(DATE,@CGSTCUTOFFDATE) OR ISNULL(@CGSTCUTOFFDATE,'')='')
		SET @BGSTBILL=1


	SET @NSTEP=15
	--VALIDATING ITEM LEVEL DISCOUNT AMOUNT
	SELECT TOP 1 @CERRPRODUCTCODE=PRODUCT_CODE FROM @tInd 
	WHERE ABS(DISCOUNT_AMOUNT)<0 AND ABS(DISCOUNT_PERCENTAGE)>=0
		
	IF ISNULL(@CERRPRODUCTCODE,'')<>''
	BEGIN
		SET @CRETVAL='ITEM CODE: '+@CERRPRODUCTCODE +'...DISCOUNT AMOUNT SHOULD BE MORE THAN OR EQUAL TO ZERO..... CANNOT PROCEED'
		GOTO ATLAST
	END

	IF @NUPDATEMODE=1
	BEGIN
		SET @NSTEP=20
	
		SET @CCMD=N'UPDATE '+ @CTEMPINM + N' SET EDT_USER_CODE='''+@CUSERCODE+''' WHERE LTRIM(RTRIM(EDT_USER_CODE)) = '''' AND SP_ID='''+LTRIM(RTRIM(@NSPID))+''''
		EXEC SP_EXECUTESQL @CCMD

	END

	SET @NSTEP=27
	/*UNMERGED:25OCT2013*/

	SELECT TOP 1 @CALLOWBLANKINVOICE=VALUE FROM CONFIG WHERE CONFIG_OPTION='CREATE_BLANK_INVOICE' 

	IF ISNULL(@CALLOWBLANKINVOICE,'')<>'1' 
	BEGIN
		IF NOT EXISTS (SELECT TOP 1 PRODUCT_CODE FROM @tInd)
			SET @CRETVAL='BLANK DETAILS  CAN NOT BE SAVED..... PLEASE CHECK'

		IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
			GOTO ATLAST
	END

	SET @NSTEP=37

	--VALIDATING RATE & NET RATE
	SELECT TOP 1 @CERRPRODUCTCODE=A.PRODUCT_CODE FROM @tInd A
	JOIN SKU_NAMES B ON A.PRODUCT_CODE=B.PRODUCT_CODE
	WHERE isnull(A.RATE,0)<=0 AND  isnull(B.SKU_ITEM_TYPE,0)<>2 and @nxn_itemtype<>5

	IF ISNULL(@CERRPRODUCTCODE,'')<>'' OR ISNULL(@CERRARTICLENO,'')<>''
	BEGIN
		SET @CRETVAL='ITEM CODE: '+@CERRPRODUCTCODE +'...RATE SHOULD NOT BE LESS THAN OR EQUAL TO ZERO..... CANNOT PROCEED'
		GOTO ATLAST
	END	


	IF @NUPDATEMODE=2
	BEGIN
		SET @NSTEP=50
		SELECT @NOLDENTRYMODE=ENTRY_MODE FROM INM01106 WHERE INV_ID=@CINVID
	
		IF @NENTRYMODE<>@NOLDENTRYMODE
		BEGIN
			SET @CRETVAL='ENTRY MODE CANNOT BE MODIFIED..... PLEASE CHECK'
			GOTO ATLAST
		END
	END

	SET @NSTEP=55
	SET @CWHERECLAUSE=' AND SP_ID='''+LTRIM(RTRIM(@NSPID))+''''

	EXEC SP3S_VALIDATEXN_ITEMTYPE
	@CTEMPMASTERTABLE=@CTEMPINM,
	@CTEMPDETAILTABLE=@CTEMPIND,
	@CWHERECLAUSE=@CWHERECLAUSE,
	@CERRORMSG=@CRETVAL OUTPUT

	IF @CRETVAL<>''
		GOTO ATLAST

 --ONLY CENTRALIZED LOCATION VALIDATE STOCK
   --IF @INVMODE=2
   --BEGIN
       
	  -- IF EXISTS (SELECT TOP 1 'U' FROM INM01106 A 
	  -- JOIN LOCATION B ON


   --END



			
	SET @CRETVAL=''

ATLAST:
	IF LTRIM(RTRIM(ISNULL(@CRETVAL,'')))<>''
		SET @CRETVAL=ISNULL(@CRETVAL,'') +'(SP_VALIDATEXN_BEFORESAVE_WSL)'
		
END TRY

BEGIN CATCH
	SET @CRETVAL=N'ERROR FOUND IN '+ISNULL(ERROR_PROCEDURE(),'SP_VALIDATEXN_BEFORESAVE_WSL ')+
	'STEP :'+LTRIM(RTRIM(STR(@NSTEP)))  +' MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')  
END CATCH
END
----  END OF PROCEDURE SP_VALIDATEXN_BEFORESAVE_WSL
