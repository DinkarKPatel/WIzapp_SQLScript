CREATE PROCEDURE SP_AUDIT_LOG_DETAILS  
(  
 @NQUERYID INT=0,  
 @CFMDT DATETIME='',  
 @CTODT DATETIME='',  
 @LOC_ID VARCHAR(100)='',  
 @NMODE INT=2,  
 @CMEMO_ID VARCHAR(100)='',  
 @CAUDIT_ID VARCHAR(100)=''  
)   
AS  
BEGIN  
  
IF @NQUERYID=1  
   GOTO LBL_INMAUDIT  
ELSE IF @NQUERYID=2  
   GOTO LBL_CMMAUDIT  
ELSE IF @NQUERYID=3  
   GOTO LBL_PIMAUDIT    
ELSE IF @NQUERYID=4  
   GOTO LBL_VDMAUDIT     
ELSE IF @NQUERYID=5  
   GOTO LBL_RMDAUDIT     
ELSE IF @NQUERYID=6  
   GOTO LBL_INMAUDIT_MST        
ELSE IF @NQUERYID=7  
   GOTO LBL_INDAUDIT_DET     
ELSE IF @NQUERYID=8  
   GOTO LBL_CMMAUDIT_MST           
ELSE IF @NQUERYID=9  
   GOTO LBL_CMDAUDIT_DET  
ELSE IF @NQUERYID=10  
   GOTO LBL_PIMAUDIT_MST           
ELSE IF @NQUERYID=11  
   GOTO LBL_PIDAUDIT_DET     
ELSE IF @NQUERYID=12  
   GOTO LBL_VMAUDIT_MST   
ELSE IF @NQUERYID=13  
   GOTO LBL_VDAUDIT_DET  
ELSE IF @NQUERYID=14  
   GOTO LBL_RMMAUDIT_MST    
ELSE IF @NQUERYID=15  
   GOTO LBL_RMDAUDIT_DET    
ELSE IF @NQUERYID=16  
GOTO LBL_CNMAUDIT    
ELSE IF @NQUERYID=17  
GOTO LBL_CNM_AUDIT_MST    
ELSE IF @NQUERYID=18  
GOTO LBL_CNM_AUDIT_DET                         
ELSE   
GOTO END_PROC  
   
   DECLARE @SR INT,@CURAUDITID VARCHAR(10)
   SET @SR=0
   
LBL_INMAUDIT:--WSL INVOICE  
    SELECT  X.INV_ID AS MEMO_ID, X.INV_NO AS MEMO_NO, CONVERT(VARCHAR,X.INV_DT,105)  AS MEMO_DT,CONVERT(VARCHAR,X.AUDITDATETIME,105) AS AUDITDATETIME
           ,NET_AMOUNT=X.NET_AMOUNT ,SUM(C.QUANTITY) AS QUANTITY,X.AUDITID
           ,X.WINUSERNAME,U.USERNAME,X.COMPUTERNAME,CAST(0 AS BIT)AS VISIT  
    FROM INM01106_AUDIT X (NOLOCK)  
    JOIN   
    (  
		SELECT  A.INV_ID AS MEMO_ID, MAX(A.AUDITDATETIME) AS AUDITDATETIME 
		FROM INM01106_AUDIT A (NOLOCK)  
		GROUP BY  A.INV_ID  
    ) B ON X.INV_ID =B.MEMO_ID  AND CONVERT(VARCHAR,X.AUDITDATETIME,120) =CONVERT(VARCHAR,B.AUDITDATETIME,120)
    JOIN IND01106_AUDIT C (NOLOCK) ON X.AUDITID =C.AUDITID AND X.INV_ID =C.INV_ID     
    JOIN USERS U (NOLOCK) ON U.USER_CODE =X.USER_CODE   
    WHERE X.INV_DT BETWEEN @CFMDT AND @CTODT  
		AND (@NMODE=2 OR X.CANCELLED=@NMODE)  
		AND (@LOC_ID='' OR LEFT(X.INV_ID,2)=@LOC_ID)  
    GROUP BY X.INV_ID, X.INV_NO ,X.INV_DT,X.AUDITDATETIME ,X.NET_AMOUNT,  
			 X.AUDITID, X.AUDITDATETIME,X.WINUSERNAME, X.COMPUTERNAME,U.USERNAME  
	ORDER BY X.AUDITDATETIME      
 GOTO END_PROC   
      
 LBL_CMMAUDIT:--CASH MEMO     
     SELECT X.CM_ID AS MEMO_ID, X.CM_NO AS MEMO_NO, CONVERT(VARCHAR,X.CM_DT,105)  AS MEMO_DT,CONVERT(VARCHAR,X.AUDITDATETIME,105) AS AUDITDATETIME
           ,NET_AMOUNT=X.NET_AMOUNT,SUM(C.QUANTITY) AS QUANTITY,X.AUDITID
           ,X.WINUSERNAME,U.USERNAME , X.COMPUTERNAME,CAST(0 AS BIT)AS VISIT  
     FROM CMM01106_AUDIT X (NOLOCK)  
     JOIN   
     (  
		SELECT  A.CM_ID AS MEMO_ID, MAX(A.AUDITDATETIME) AS AUDITDATETIME--,SUM(A.QUANTITY) AS QUANTITY  
		FROM CMM01106_AUDIT A (NOLOCK)   
		GROUP BY  A.CM_ID  
      ) B ON X.CM_ID =B.MEMO_ID  AND CONVERT(VARCHAR,X.AUDITDATETIME,120) =CONVERT(VARCHAR,B.AUDITDATETIME,120)
      JOIN CMD01106_AUDIT C (NOLOCK) ON X.AUDITID =C.AUDITID AND X.CM_ID =C.CM_ID    
      JOIN USERS U (NOLOCK) ON U.USER_CODE =X.USER_CODE   
      WHERE X.CM_DT BETWEEN @CFMDT AND @CTODT  
	        AND (@NMODE=2 OR X.CANCELLED=@NMODE)  
		    AND (@LOC_ID='' OR LEFT(X.CM_ID,2)=@LOC_ID)  
      GROUP BY X.CM_ID, X.CM_NO ,X.CM_DT,X.AUDITDATETIME ,X.NET_AMOUNT,  
			   X.AUDITID, X.AUDITDATETIME,X.WINUSERNAME, X.COMPUTERNAME,U.USERNAME  
	  ORDER BY X.AUDITDATETIME  
 GOTO END_PROC      
    
 LBL_PIMAUDIT:   --PURCHASE INVOICE SELECT * FROM PIM01106       
     SELECT X.MRR_ID AS MEMO_ID, X.MRR_NO AS MEMO_NO, CONVERT(VARCHAR,X.MRR_DT,105) AS MEMO_DT,CONVERT(VARCHAR,X.AUDITDATETIME,105) AS AUDITDATETIME
           ,NET_AMOUNT=X.TOTAL_AMOUNT,SUM(C.QUANTITY) AS QUANTITY,X.AUDITID
           ,X.WINUSERNAME,U.USERNAME , X.COMPUTERNAME,CAST(0 AS BIT)AS VISIT  
     FROM PIM01106_AUDIT X (NOLOCK)  
     JOIN   
     (  
		SELECT  A.MRR_ID AS MEMO_ID, MAX(A.AUDITDATETIME) AS AUDITDATETIME--,SUM(A.QUANTITY) AS QUANTITY  
		FROM PIM01106_AUDIT A (NOLOCK)  
		GROUP BY  A.MRR_ID  
     ) B ON X.MRR_ID =B.MEMO_ID  AND CONVERT(VARCHAR,X.AUDITDATETIME,120) =CONVERT(VARCHAR,B.AUDITDATETIME,120)  
     JOIN PID01106_AUDIT C (NOLOCK) ON C.AUDITID =X.AUDITID AND C.MRR_ID =X.MRR_ID   
     JOIN USERS U (NOLOCK) ON U.USER_CODE =X.USER_CODE   
     WHERE X.MRR_DT BETWEEN @CFMDT AND @CTODT  
           AND (@NMODE=2 OR X.CANCELLED=@NMODE)  
           AND (@LOC_ID='' OR LEFT(X.MRR_ID,2)=@LOC_ID)  
     GROUP BY X.MRR_ID, X.MRR_NO ,X.MRR_DT,X.AUDITDATETIME ,X.TOTAL_AMOUNT,  
              X.AUDITID, X.AUDITDATETIME,X.WINUSERNAME, X.COMPUTERNAME,U.USERNAME  
     ORDER BY X.AUDITDATETIME      
 GOTO END_PROC   
  
 LBL_VDMAUDIT:             
     SELECT X.VM_ID AS MEMO_ID, X.VOUCHER_NO AS MEMO_NO, CONVERT(VARCHAR,X.VOUCHER_DT,105)  AS MEMO_DT,CONVERT(VARCHAR,X.AUDITDATETIME,105) AS AUDITDATETIME
            ,NET_AMOUNT=X.DRTOTAL ,SUM(1) AS QUANTITY, X.AUDITID,X.WINUSERNAME
            ,U.USERNAME , X.COMPUTERNAME,CAST(0 AS BIT)AS VISIT  
     FROM VM01106_AUDIT X (NOLOCK)  
     JOIN   
     (  
		SELECT  A.VM_ID AS MEMO_ID, MAX(A.AUDITDATETIME) AS AUDITDATETIME--,SUM(1) AS QUANTITY  
		FROM VM01106_AUDIT A (NOLOCK)  
		GROUP BY  A.VM_ID  
     ) B ON X.VM_ID =B.MEMO_ID  AND CONVERT(VARCHAR,X.AUDITDATETIME,120) =CONVERT(VARCHAR,B.AUDITDATETIME,120)
     JOIN VD01106_AUDIT C (NOLOCK) ON C.AUDITID =X.AUDITID AND C.VM_ID =X.VM_ID     
     JOIN USERS U (NOLOCK) ON U.USER_CODE =X.USER_CODE   
     WHERE X.VOUCHER_DT BETWEEN @CFMDT AND @CTODT  
           AND (@NMODE=2 OR X.CANCELLED=@NMODE)  
           AND (@LOC_ID='' OR LEFT(X.VM_ID,2)=@LOC_ID)  
    GROUP BY X.VM_ID, X.VOUCHER_NO ,X.VOUCHER_DT,X.AUDITDATETIME ,X.DRTOTAL,
             X.AUDITID, X.AUDITDATETIME,X.WINUSERNAME, X.COMPUTERNAME,U.USERNAME  
    ORDER BY X.AUDITDATETIME  
 GOTO END_PROC 
      
 LBL_RMDAUDIT:  
     SELECT X.RM_ID AS MEMO_ID, X.RM_NO AS MEMO_NO,CONVERT(VARCHAR, X.RM_DT,105)  AS MEMO_DT,CONVERT(VARCHAR,X.AUDITDATETIME,105) AS AUDITDATETIME
            ,NET_AMOUNT=X.TOTAL_AMOUNT,SUM(C.QUANTITY) AS QUANTITY,X.AUDITID
            ,X.WINUSERNAME,U.USERNAME , X.COMPUTERNAME,CAST(0 AS BIT)AS VISIT  
     FROM RMM01106_AUDIT X (NOLOCK)  
     JOIN   
     (  
		SELECT  A.RM_ID AS MEMO_ID, MAX(A.AUDITDATETIME) AS AUDITDATETIME--,SUM(A.QUANTITY) AS QUANTITY  
		FROM RMM01106_AUDIT A (NOLOCK)    
		GROUP BY  A.RM_ID  
     ) B ON X.RM_ID =B.MEMO_ID  AND CONVERT(VARCHAR,X.AUDITDATETIME,120) =CONVERT(VARCHAR,B.AUDITDATETIME,120)  
     JOIN RMD01106_AUDIT C (NOLOCK) ON C.AUDITID =X.AUDITID AND C.RM_ID =X.RM_ID 
     JOIN USERS U (NOLOCK) ON U.USER_CODE =X.USER_CODE   
     WHERE X.RM_DT BETWEEN @CFMDT AND @CTODT  
           AND (@NMODE=2 OR X.CANCELLED=@NMODE)  
           AND (@LOC_ID='' OR LEFT(X.RM_ID,2)=@LOC_ID)  
     GROUP BY X.RM_ID, X.RM_NO ,X.RM_DT,X.AUDITDATETIME ,X.TOTAL_AMOUNT,  
              X.AUDITID, X.AUDITDATETIME,X.WINUSERNAME, X.COMPUTERNAME,U.USERNAME  
     ORDER BY X.AUDITDATETIME     
 GOTO END_PROC  
     
 LBL_INMAUDIT_MST:  
     IF OBJECT_ID('TEMPDB..#TMPINM_MST','U') IS NOT NULL
        DROP TABLE #TMPINM_MST
        
       SELECT TOP 1 @CURAUDITID=SUBSTRING(AUDITID,1,6)+CAST(SUBSTRING(AUDITID,7,LEN(AUDITID ))-1 AS VARCHAR(100)) FROM INM01106_AUDIT WHERE INV_ID=@CMEMO_ID ORDER BY AUDITDATETIME 
              
        SELECT SR=ROW_NUMBER () OVER (ORDER BY X.AUDITDATETIME DESC), X.AUDITID, T6.DEPT_NAME,X.DEPT_ID,T4.AC_NAME,X.AC_CODE,  
               X.INV_NO,X.INV_ID,MEMO_PREFIX,T2.USERNAME ,X.USER_CODE,  
               SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,X.FREIGHT,                                 
               X.OTHER_CHARGES,NET_AMOUNT,INSURANCE,  
               CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT,CONVERT(NUMERIC(10,2), 0 )AS TOTAL_CUSTOM_DUTY_AMOUNT,     
               OCTROI_PERCENTAGE,OCTROI_AMOUNT,ROUND_OFF,DT_NAME,X.DT_CODE,INV_DT,        
               GRLR_DATE,APPROVED,BILL_LEVEL_TAX_METHOD,MEMO_TYPE,ENTRY_MODE,  
               INV_MODE,TAXFORM_STORAGE_MODE,LOTTYPE,  
               INV_TYPE,XFER_TYPE,PAY_MODE,X.MANUAL_DISCOUNT,MANUAL_OCTROI,  
               MANUAL_ROUNDOFF,TOTAL_CUSTOM_DUTY_AMT,  
               AMOUNT=SUM(T1.QUANTITY*T1.RATE),SUM(T1.QUANTITY) AS QUANTITY,X.AUDITDATETIME,X.MANUAL_INV_NO   
               INTO #TMPINM_MST
         FROM INM01106_AUDIT X (NOLOCK)  
         JOIN IND01106_AUDIT T1 (NOLOCK) ON X.AUDITID =T1.AUDITID AND X.INV_ID =T1.INV_ID   
         LEFT OUTER JOIN LOCATION T6 (NOLOCK) ON T6.DEPT_ID = X.DEPT_ID    
         JOIN LM01106 T4 (NOLOCK) ON T4.AC_CODE = X.AC_CODE   
         LEFT OUTER JOIN USERS T2 (NOLOCK) ON X.USER_CODE = T2.USER_CODE   
         LEFT JOIN DTM (NOLOCK) ON DTM.DT_CODE = X.DT_CODE   
         WHERE T1.INV_ID = @CMEMO_ID        
         GROUP BY  X.AUDITID,T6.DEPT_NAME,X.DEPT_ID,T4.AC_NAME,X.AC_CODE,  
                   X.INV_NO,X.INV_ID,MEMO_PREFIX,T2.USERNAME ,X.USER_CODE,  
                   SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,X.FREIGHT,                                 
                   X.OTHER_CHARGES,INSURANCE,  
                   OCTROI_PERCENTAGE,OCTROI_AMOUNT,ROUND_OFF,DT_NAME,X.DT_CODE,INV_DT,        
                   GRLR_DATE,APPROVED,BILL_LEVEL_TAX_METHOD,MEMO_TYPE,ENTRY_MODE,  
                   INV_MODE,TAXFORM_STORAGE_MODE,LOTTYPE,  
                   NET_AMOUNT,INV_TYPE,XFER_TYPE,PAY_MODE,X.MANUAL_DISCOUNT,MANUAL_OCTROI,  
                   MANUAL_ROUNDOFF,TOTAL_CUSTOM_DUTY_AMT,X.AUDITDATETIME,X.MANUAL_INV_NO   
         UNION ALL
         SELECT SR=0, AUDITID=@CURAUDITID, T6.DEPT_NAME,X.DEPT_ID,T4.AC_NAME,X.AC_CODE,  
                X.INV_NO,X.INV_ID,MEMO_PREFIX,T2.USERNAME ,X.USER_CODE,  
                SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,X.FREIGHT,                                 
                X.OTHER_CHARGES,NET_AMOUNT,INSURANCE,  
                CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT,CONVERT(NUMERIC(10,2), 0 )AS TOTAL_CUSTOM_DUTY_AMOUNT,     
                OCTROI_PERCENTAGE,OCTROI_AMOUNT,ROUND_OFF,DT_NAME,X.DT_CODE,INV_DT,        
                GRLR_DATE,APPROVED,BILL_LEVEL_TAX_METHOD,MEMO_TYPE,ENTRY_MODE,  
                INV_MODE,TAXFORM_STORAGE_MODE,LOTTYPE,  
                INV_TYPE,XFER_TYPE,PAY_MODE,X.MANUAL_DISCOUNT,MANUAL_OCTROI,  
                MANUAL_ROUNDOFF,TOTAL_CUSTOM_DUTY_AMT,  
                AMOUNT=SUM(T1.QUANTITY*T1.RATE),SUM(T1.QUANTITY) AS QUANTITY ,NULL,MANUAL_INV_NO  
         FROM INM01106 X (NOLOCK)  
         JOIN IND01106 T1 (NOLOCK) ON  X.INV_ID =T1.INV_ID   
         LEFT OUTER JOIN LOCATION T6 (NOLOCK) ON T6.DEPT_ID = X.DEPT_ID    
         JOIN LM01106 T4 (NOLOCK) ON T4.AC_CODE = X.AC_CODE   
         LEFT OUTER JOIN USERS T2 (NOLOCK) ON X.USER_CODE = T2.USER_CODE   
         LEFT JOIN DTM (NOLOCK) ON DTM.DT_CODE = X.DT_CODE   
         WHERE T1.INV_ID = @CMEMO_ID        
         GROUP BY  T6.DEPT_NAME,X.DEPT_ID,T4.AC_NAME,X.AC_CODE,  
                   X.INV_NO,X.INV_ID,MEMO_PREFIX,T2.USERNAME ,X.USER_CODE,  
                   SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,X.FREIGHT,                                 
                   X.OTHER_CHARGES,INSURANCE,  
                   OCTROI_PERCENTAGE,OCTROI_AMOUNT,ROUND_OFF,DT_NAME,X.DT_CODE,INV_DT,        
                   GRLR_DATE,APPROVED,BILL_LEVEL_TAX_METHOD,MEMO_TYPE,ENTRY_MODE,  
                   INV_MODE,TAXFORM_STORAGE_MODE,LOTTYPE,  
                   NET_AMOUNT,INV_TYPE,XFER_TYPE,PAY_MODE,X.MANUAL_DISCOUNT,MANUAL_OCTROI,  
                   MANUAL_ROUNDOFF,TOTAL_CUSTOM_DUTY_AMT,X.MANUAL_INV_NO   
         ORDER BY X.AUDITDATETIME DESC
         
          UPDATE #TMPINM_MST SET SR=(SELECT MAX(SR) FROM #TMPINM_MST)+1 WHERE SR=0
          SELECT TOP 1 @SR=SR FROM #TMPINM_MST WHERE AUDITID =@CAUDIT_ID ORDER BY AUDITDATETIME DESC
   
          SELECT * FROM #TMPINM_MST WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)  
   
          SELECT * FROM #TMPINM_MST WHERE AUDITID<>'' AND (@CAUDIT_ID =''  OR SR=@SR+1 )
       
 GOTO END_PROC     

 LBL_INDAUDIT_DET:  
     IF OBJECT_ID('TEMPDB..#TMPINM_DET','U') IS NOT NULL
        DROP TABLE #TMPINM_DET
        SELECT TOP 1 @CURAUDITID=SUBSTRING(AUDITID,1,6)+CAST(SUBSTRING(AUDITID,7,LEN(AUDITID ))-1 AS VARCHAR(100)) FROM INM01106_AUDIT WHERE INV_ID=@CMEMO_ID ORDER BY AUDITDATETIME 
        
        SELECT SR.SR AS SR, X.AUDITID, EMP.EMP_NAME,X.EMP_CODE,RATE,EMP1.EMP_NAME AS EMP_NAME1,T1.EMP_CODE1,  
               EMP2.EMP_NAME  AS EMP_NAME2,T1.EMP_CODE2,MANUAL_INV_NO,  
               FORM_NAME,ITEM_FORM_ID,  
               ITEM_TAX_AMOUNT,FORM_TYPE,TOTAL_CUSTOM_DUTY_AMT,CONVERT(VARCHAR,BOX_DT,105) AS BOX_DT,
               ISNULL(PS_DT ,'')  AS PS_DT,  
               ROW_NUMBER() OVER (ORDER BY T1.BOX_NO,T1.PS_ID) AS S_NO,  
               ISNULL(PS_NO,'') AS PS_NO,BOX_NO,S.PRODUCT_CODE,ARTICLE_NO,SUB_SECTION_NAME,         
               INVOICE_QUANTITY,SECTION_NAME,QUANTITY ,SCHEME_QUANTITY,                  
               T1.MRP,T1.DISCOUNT_PERCENTAGE,                    
               T1.DISCOUNT_AMOUNT,NET_RATE,(T1.INVOICE_QUANTITY*T1.NET_RATE) AS AMOUNT,  
               PARA1_NAME,PARA2_NAME,PARA6_NAME,  
               ROW_ID,B.ARTICLE_CODE,S.PRODUCT_NAME,ITEM_TAX_PERCENTAGE,  
               BIN_NAME,PARTY_MRP,  
               B.ALIAS AS ARTICLE_ALIAS,ARTICLE_NAME,T1.MANUAL_DISCOUNT,  
               CUSTOM_DUTY_AMT,CVD_AMT,  
               CUSTOM_DUTY_PER,CVD_PER,CHALLAN_NO,  
               E.UOM_NAME,E.UOM_CODE,X.AUDITDATETIME 
         INTO #TMPINM_DET                  
	     FROM INM01106_AUDIT X (NOLOCK)  
	     JOIN IND01106_AUDIT T1 (NOLOCK) ON X.AUDITID =T1.AUDITID AND X.INV_ID =T1.INV_ID  
	     JOIN
		 (
		   SELECT AUDITID,AUDITDATETIME,ROW_NUMBER () OVER (ORDER BY AUDITDATETIME DESC) AS SR 
		   FROM INM01106_AUDIT INM 
		   WHERE INM.INV_ID = @CMEMO_ID  
		   GROUP BY AUDITID,AUDITDATETIME
		 ) SR ON SR.AUDITID =X.AUDITID 
	     JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = T1.PRODUCT_CODE    
	     JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE      
	     JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	     JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	     JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE      
	     JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE      
	     JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE      
	     JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE      
	     JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE      
	     JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE    
	     JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE    
	     JOIN BIN B1 ON B1.BIN_ID=ISNULL(T1.BIN_ID,'000')  
	     LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON T1.EMP_CODE= EMP.EMP_CODE     
	     LEFT OUTER JOIN EMPLOYEE EMP1 (NOLOCK) ON T1.EMP_CODE1= EMP1.EMP_CODE      
	     LEFT OUTER JOIN EMPLOYEE EMP2 (NOLOCK) ON T1.EMP_CODE2= EMP2.EMP_CODE      
         JOIN FORM J (NOLOCK)ON T1.ITEM_FORM_ID= J.FORM_ID                   
         LEFT OUTER JOIN 
         (SELECT  PS_NO,PS_ID, CONVERT(VARCHAR,PS_DT,105) AS PS_DT FROM WPS_MST WPSM (NOLOCK)                    
          ) WPSM ON T1.PS_ID= WPSM.PS_ID                      
         WHERE T1.INV_ID = @CMEMO_ID  
             
         UNION ALL
         SELECT SR=0, AUDITID=@CURAUDITID, EMP.EMP_NAME,X.EMP_CODE,RATE,EMP1.EMP_NAME AS EMP_NAME1,T1.EMP_CODE1,  
                EMP2.EMP_NAME  AS EMP_NAME2,T1.EMP_CODE2,MANUAL_INV_NO,  
                FORM_NAME,ITEM_FORM_ID,  
                ITEM_TAX_AMOUNT,FORM_TYPE,TOTAL_CUSTOM_DUTY_AMT,CONVERT(VARCHAR,BOX_DT,105) AS BOX_DT,ISNULL(PS_DT,'') AS PS_DT,  
                ROW_NUMBER() OVER (ORDER BY T1.BOX_NO,T1.PS_ID) AS S_NO,  
                ISNULL(PS_NO,'') AS PS_NO,BOX_NO,S.PRODUCT_CODE,ARTICLE_NO,SUB_SECTION_NAME,         
                INVOICE_QUANTITY,SECTION_NAME,QUANTITY ,SCHEME_QUANTITY,                  
                T1.MRP,T1.DISCOUNT_PERCENTAGE,                    
                T1.DISCOUNT_AMOUNT,NET_RATE,(T1.INVOICE_QUANTITY*T1.NET_RATE) AS AMOUNT,  
                PARA1_NAME,PARA2_NAME,PARA6_NAME,  
                ROW_ID,B.ARTICLE_CODE,S.PRODUCT_NAME,ITEM_TAX_PERCENTAGE,  
                BIN_NAME,PARTY_MRP,  
                B.ALIAS AS ARTICLE_ALIAS,ARTICLE_NAME,T1.MANUAL_DISCOUNT,  
                CUSTOM_DUTY_AMT,CVD_AMT,  
                CUSTOM_DUTY_PER,CVD_PER,CHALLAN_NO,  
                E.UOM_NAME,E.UOM_CODE,AUDITDATETIME=NULL                    
	     FROM INM01106 X (NOLOCK)  
	     JOIN IND01106 T1 (NOLOCK) ON  X.INV_ID =T1.INV_ID  
	     JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = T1.PRODUCT_CODE    
	     JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE      
	     JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	     JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	     JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE      
	     JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE      
	     JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE      
	     JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE      
	     JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE      
	     JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE    
	     JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE    
	     JOIN BIN B1 ON B1.BIN_ID=ISNULL(T1.BIN_ID,'000')  
	     LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON T1.EMP_CODE= EMP.EMP_CODE     
	     LEFT OUTER JOIN EMPLOYEE EMP1 (NOLOCK) ON T1.EMP_CODE1= EMP1.EMP_CODE      
	     LEFT OUTER JOIN EMPLOYEE EMP2 (NOLOCK) ON T1.EMP_CODE2= EMP2.EMP_CODE      
         JOIN FORM J (NOLOCK)ON T1.ITEM_FORM_ID= J.FORM_ID
         LEFT JOIN                    
         (SELECT  PS_NO,PS_ID, CONVERT(VARCHAR,PS_DT,105) AS PS_DT FROM WPS_MST WPSM (NOLOCK)                    
          ) WPSM ON T1.PS_ID= WPSM.PS_ID                      
         WHERE T1.INV_ID = @CMEMO_ID   
         ORDER BY  X.AUDITDATETIME DESC      
         
          UPDATE #TMPINM_DET SET SR=(SELECT MAX(SR) FROM #TMPINM_DET)+1 WHERE SR=0
          SELECT TOP 1 @SR=SR FROM #TMPINM_DET WHERE AUDITID =@CAUDIT_ID
   
          SELECT * FROM #TMPINM_DET WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)  
   
          SELECT * FROM #TMPINM_DET WHERE AUDITID<>'' AND (@CAUDIT_ID =''  OR SR=@SR+1 )
     
	   
   
   
 GOTO END_PROC  
 LBL_CMMAUDIT_MST:  
     IF OBJECT_ID('TEMPDB..#TMPCMM_MST','U') IS NOT NULL 
        DROP TABLE #TMPCMM_MST
     SELECT TOP 1 @CURAUDITID=SUBSTRING(AUDITID,1,6)+CAST(SUBSTRING(AUDITID,7,LEN(AUDITID ))-1 AS VARCHAR(100)) FROM CMM01106_AUDIT WHERE CM_ID=@CMEMO_ID ORDER BY AUDITDATETIME 
     
		SELECT SR=ROW_NUMBER () OVER (ORDER BY X.AUDITDATETIME DESC), X.AUDITID, T6.DEPT_NAME,LEFT (X.CM_ID,2) AS DEPT_ID,T4.AC_NAME,X.AC_CODE,  
			   X.CM_NO,X.CM_ID,T2.USERNAME ,X.USER_CODE,  
			   SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,                             
			   NET_AMOUNT,ROUND_OFF,DT_NAME,X.DT_CODE,CM_DT,        
			   MEMO_TYPE,  CM_MODE,  
			   PAY_MODE,X.MANUAL_DISCOUNT,  
			   MANUAL_ROUNDOFF,AMOUNT=SUM(T1.QUANTITY*T1.MRP),  
			   SUM(T1.QUANTITY) AS QUANTITY ,USER_CUSTOMER_CODE,  
			   X.CUSTOMER_CODE,SUBTOTAL_R,  
			   CONVERT(NUMERIC(14,2),X.SUBTOTAL+X.SUBTOTAL_R) AS [SUBTOTAL_T],    
			   CONVERT(NUMERIC(14,3),(CASE WHEN (X.SUBTOTAL+X.SUBTOTAL_R)<>0 THEN (X.DISCOUNT_AMOUNT*100)/ (X.SUBTOTAL+X.SUBTOTAL_R) ELSE 0 END)) AS [DISCOUNT_PERCENTAGE_CALC],  
			   ATD_CHARGES,SUM(CAST(ISNULL(TAX_AMOUNT ,0) AS NUMERIC(14,2))) AS [TOTAL_TAX] ,  
			   ADDRESS=ISNULL(ADDRESS9,'')+' '+ ISNULL(ADDRESS0 ,'')+ISNULL(C.ADDRESS1 ,'')+ISNULL(C.ADDRESS2 ,''),X.AUDITDATETIME 
	   INTO #TMPCMM_MST 
	   FROM CMM01106_AUDIT X (NOLOCK)  
	   JOIN CMD01106_AUDIT T1 (NOLOCK) ON X.CM_ID =T1.CM_ID   
	   JOIN CUSTDYM C (NOLOCK) ON C.CUSTOMER_CODE =X.CUSTOMER_CODE   
	   LEFT OUTER JOIN LOCATION T6 (NOLOCK) ON T6.DEPT_ID = LEFT (X.CM_ID,2)    
	   JOIN LM01106 T4 (NOLOCK) ON T4.AC_CODE = X.AC_CODE   
	   LEFT OUTER JOIN USERS T2 (NOLOCK) ON X.USER_CODE = T2.USER_CODE   
	   LEFT JOIN DTM (NOLOCK) ON DTM.DT_CODE = X.DT_CODE   
	   WHERE T1.CM_ID = @CMEMO_ID      
	   GROUP BY X.AUDITID, T6.DEPT_NAME,LEFT (X.CM_ID,2),T4.AC_NAME,X.AC_CODE,  
				X.CM_NO,X.CM_ID,T2.USERNAME ,X.USER_CODE,  
				SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,                             
				NET_AMOUNT,ROUND_OFF,DT_NAME,X.DT_CODE,CM_DT,        
				MEMO_TYPE,CM_MODE,PAY_MODE,X.MANUAL_DISCOUNT,  
				MANUAL_ROUNDOFF,USER_CUSTOMER_CODE,X.CUSTOMER_CODE,  
				SUBTOTAL_R,CONVERT(NUMERIC(14,2),X.SUBTOTAL+X.SUBTOTAL_R) ,   
				CONVERT(NUMERIC(14,3),(CASE WHEN (X.SUBTOTAL+X.SUBTOTAL_R)<>0 THEN (X.DISCOUNT_AMOUNT*100)/ (X.SUBTOTAL+X.SUBTOTAL_R) ELSE 0 END)) ,  
				ATD_CHARGES,  
				ISNULL(ADDRESS9,'')+' '+ ISNULL(ADDRESS0 ,'')+ISNULL(C.ADDRESS1 ,'')+ISNULL(C.ADDRESS2 ,''),X.AUDITDATETIME
		UNION ALL
		SELECT SR=0, AUDITID=@CURAUDITID, T6.DEPT_NAME,LEFT (X.CM_ID,2) AS DEPT_ID,T4.AC_NAME,X.AC_CODE,  
			   X.CM_NO,X.CM_ID,T2.USERNAME ,X.USER_CODE,  
			   SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,                             
			   NET_AMOUNT,ROUND_OFF,DT_NAME,X.DT_CODE,CM_DT,        
			   MEMO_TYPE,  CM_MODE,  
			   PAY_MODE,X.MANUAL_DISCOUNT,  
			   MANUAL_ROUNDOFF,AMOUNT=SUM(T1.QUANTITY*T1.MRP),  
			   SUM(T1.QUANTITY) AS QUANTITY ,USER_CUSTOMER_CODE,  
			   X.CUSTOMER_CODE,SUBTOTAL_R,   
			   CONVERT(NUMERIC(14,2),X.SUBTOTAL+X.SUBTOTAL_R) AS [SUBTOTAL_T],   
			   CONVERT(NUMERIC(14,3),(CASE WHEN (X.SUBTOTAL+X.SUBTOTAL_R)<>0 THEN (X.DISCOUNT_AMOUNT*100)/ (X.SUBTOTAL+X.SUBTOTAL_R) ELSE 0 END)) AS [DISCOUNT_PERCENTAGE_CALC],  
			   ATD_CHARGES,SUM(CAST(ISNULL(TAX_AMOUNT ,0) AS NUMERIC(14,2))) AS [TOTAL_TAX] ,  
			   ADDRESS=ISNULL(ADDRESS9,'')+' '+ ISNULL(ADDRESS0 ,'')+ISNULL(C.ADDRESS1 ,'')+ISNULL(C.ADDRESS2 ,''),NULL 
	    FROM CMM01106 X (NOLOCK)  
	    JOIN CMD01106 T1 (NOLOCK) ON X.CM_ID =T1.CM_ID   
	    JOIN CUSTDYM C (NOLOCK) ON C.CUSTOMER_CODE =X.CUSTOMER_CODE   
	    LEFT OUTER JOIN LOCATION T6 (NOLOCK) ON T6.DEPT_ID = LEFT (X.CM_ID,2)    
	    JOIN LM01106 T4 (NOLOCK) ON T4.AC_CODE = X.AC_CODE   
	    LEFT OUTER JOIN USERS T2 (NOLOCK) ON X.USER_CODE = T2.USER_CODE   
	    LEFT JOIN DTM (NOLOCK) ON DTM.DT_CODE = X.DT_CODE   
	    WHERE T1.CM_ID = @CMEMO_ID        
	    GROUP BY  T6.DEPT_NAME,LEFT (X.CM_ID,2),T4.AC_NAME,X.AC_CODE,  
				  X.CM_NO,X.CM_ID,T2.USERNAME ,X.USER_CODE,  
				  SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,                             
				  NET_AMOUNT,ROUND_OFF,DT_NAME,X.DT_CODE,CM_DT,        
				  MEMO_TYPE,CM_MODE,PAY_MODE,X.MANUAL_DISCOUNT,  
				  MANUAL_ROUNDOFF,USER_CUSTOMER_CODE,X.CUSTOMER_CODE,  
				  SUBTOTAL_R,CONVERT(NUMERIC(14,2),X.SUBTOTAL+X.SUBTOTAL_R) ,   
				  CONVERT(NUMERIC(14,3),(CASE WHEN (X.SUBTOTAL+X.SUBTOTAL_R)<>0 THEN (X.DISCOUNT_AMOUNT*100)/ (X.SUBTOTAL+X.SUBTOTAL_R) ELSE 0 END)) ,  
				  ATD_CHARGES,  
				  ISNULL(ADDRESS9,'')+' '+ ISNULL(ADDRESS0 ,'')+ISNULL(C.ADDRESS1 ,'')+ISNULL(C.ADDRESS2 ,'')  
				          
	 UPDATE #TMPCMM_MST SET SR=(SELECT MAX(SR) FROM #TMPCMM_MST)+1 WHERE SR=0
	  
	 SELECT TOP 1 @SR=SR FROM #TMPCMM_MST WHERE AUDITID =@CAUDIT_ID ORDER BY AUDITDATETIME DESC
   
     SELECT * FROM #TMPCMM_MST WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)  --ORDER BY SR DESC 
   
     SELECT * FROM #TMPCMM_MST WHERE AUDITID<>'' AND (@CAUDIT_ID =''  OR SR=@SR+1 )--ORDER BY SR DESC  
   
 
   
	    
 GOTO END_PROC  
 
LBL_CMDAUDIT_DET:
    IF OBJECT_ID('TEMPDB..#TMPCMM_DET','U') IS NOT NULL 
       DROP TABLE #TMPCMM_DET 
        SELECT TOP 1 @CURAUDITID=SUBSTRING(AUDITID,1,6)+CAST(SUBSTRING(AUDITID,7,LEN(AUDITID ))-1 AS VARCHAR(100)) FROM CMM01106_AUDIT WHERE CM_ID=@CMEMO_ID ORDER BY AUDITDATETIME 
          
        SELECT SR.SR AS SR, X.AUDITID, T1.PRODUCT_CODE,T1.QUANTITY,UOM_NAME  
              ,T1.FIX_MRP,T1.MRP,T1.DISCOUNT_PERCENTAGE,T1.DISCOUNT_AMOUNT  
              ,'T'+(CASE WHEN T1.TAX_PERCENTAGE=0 THEN 'F' WHEN ROUND(T1.TAX_PERCENTAGE,0)=T1.TAX_PERCENTAGE THEN LTRIM(RTRIM(STR(T1.TAX_PERCENTAGE)))  
                   ELSE LTRIM(RTRIM(STR(T1.TAX_PERCENTAGE,6,2))) END) AS TAX_STATUS  
              ,T1.TAX_PERCENTAGE,T1.TAX_AMOUNT,T1.NET,EMP.EMP_NAME,EMP1.EMP_NAME AS EMP_NAME1  
              ,EMP2.EMP_NAME AS EMP_NAME2,ARTICLE_NO,SUB_SECTION_NAME,SECTION_NAME,T1.ROW_ID,T1.DEPT_ID,T1.EMP_CODE,T1.EMP_CODE2  
              ,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME  
              ,B.ARTICLE_CODE,(CASE WHEN ISNULL(T1.HOLD_FOR_ALTER,0)=0 THEN 'N' ELSE 'Y' END) AS [HOLD_FOR_ALTER_TXT]  
              ,(CASE WHEN ISNULL(T1.PACK_SLIP_ID,'')='' THEN '' ELSE RIGHT(T1.PACK_SLIP_ID,10 ) END) AS [PACK_SLIP_NO]  
              ,T1.PACK_SLIP_ID,T1.XN_TYPE,T1.FOC_QUANTITY,B.ALIAS AS ARTICLE_ALIAS,T1.REPEAT_PUR_ORDER,T1.NRM_ID  
              ,ISNULL(N.NARRATION,'') AS [NARRATION]  
              ,CONVERT(VARCHAR(10),'') AS [BUYER_ORDER_NO]  
              ,TAX_METHOD,E.UOM_CODE ,SR_NO,X.AUDITDATETIME 
         INTO #TMPCMM_DET                        
		 FROM CMM01106_AUDIT X (NOLOCK)  
		 JOIN CMD01106_AUDIT T1 (NOLOCK) ON X.AUDITID =T1.AUDITID AND X.CM_ID =T1.CM_ID  
		 JOIN
		 (
		   SELECT AUDITID,AUDITDATETIME,ROW_NUMBER () OVER (ORDER BY AUDITDATETIME DESC) AS SR FROM CMM01106_AUDIT CMM 
		   WHERE CMM.CM_ID = @CMEMO_ID  
		   GROUP BY AUDITID,AUDITDATETIME
		 ) SR ON SR.AUDITID =X.AUDITID 
		 JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = T1.PRODUCT_CODE    
		 JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE      
		 JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
		 JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
		 JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE      
		 JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE      
		 JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE      
		 JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE      
		 JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE      
		 JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE    
		 JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE    
		 JOIN BIN B1 ON B1.BIN_ID=ISNULL(T1.BIN_ID,'000')  
		 LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON T1.EMP_CODE= EMP.EMP_CODE     
		 LEFT OUTER JOIN EMPLOYEE EMP1 (NOLOCK) ON T1.EMP_CODE1= EMP1.EMP_CODE      
		 LEFT OUTER JOIN EMPLOYEE EMP2 (NOLOCK) ON T1.EMP_CODE2= EMP2.EMP_CODE     
		 LEFT OUTER JOIN NRM N (NOLOCK) ON N.NRM_ID=ISNULL(T1.NRM_ID  ,'0000000')                 
		 WHERE T1.CM_ID = @CMEMO_ID 
		      
         UNION ALL
         SELECT SR=0, AUDITID=@CURAUDITID, T1.PRODUCT_CODE,T1.QUANTITY,UOM_NAME  
               ,T1.FIX_MRP,T1.MRP,T1.DISCOUNT_PERCENTAGE,T1.DISCOUNT_AMOUNT  
               ,'T'+(CASE WHEN T1.TAX_PERCENTAGE=0 THEN 'F' WHEN ROUND(T1.TAX_PERCENTAGE,0)=T1.TAX_PERCENTAGE THEN LTRIM(RTRIM(STR(T1.TAX_PERCENTAGE)))  
                ELSE LTRIM(RTRIM(STR(T1.TAX_PERCENTAGE,6,2))) END) AS TAX_STATUS  
               ,T1.TAX_PERCENTAGE,T1.TAX_AMOUNT,T1.NET,EMP.EMP_NAME,EMP1.EMP_NAME AS EMP_NAME1  
               ,EMP2.EMP_NAME AS EMP_NAME2,ARTICLE_NO,SUB_SECTION_NAME,SECTION_NAME,T1.ROW_ID,T1.DEPT_ID,T1.EMP_CODE,T1.EMP_CODE2  
               ,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME  
               ,B.ARTICLE_CODE,(CASE WHEN ISNULL(T1.HOLD_FOR_ALTER,0)=0 THEN 'N' ELSE 'Y' END) AS [HOLD_FOR_ALTER_TXT]  
               ,(CASE WHEN ISNULL(T1.PACK_SLIP_ID,'')='' THEN '' ELSE RIGHT(T1.PACK_SLIP_ID,10 ) END) AS [PACK_SLIP_NO]  
               ,T1.PACK_SLIP_ID,T1.XN_TYPE,T1.FOC_QUANTITY,B.ALIAS AS ARTICLE_ALIAS,T1.REPEAT_PUR_ORDER,T1.NRM_ID  
               ,ISNULL(N.NARRATION,'') AS [NARRATION]  
               ,CONVERT(VARCHAR(10),'') AS [BUYER_ORDER_NO]  
               ,TAX_METHOD,E.UOM_CODE ,SR_NO,AUDITDATETIME=NULL                     
		  FROM CMM01106 X (NOLOCK)  
		  JOIN CMD01106 T1 (NOLOCK) ON  X.CM_ID =T1.CM_ID  
		  JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = T1.PRODUCT_CODE    
		  JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE      
		  JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
		  JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
		  JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE      
		  JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE      
		  JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE      
		  JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE      
		  JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE      
		  JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE    
		  JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE    
		  JOIN BIN B1 ON B1.BIN_ID=ISNULL(T1.BIN_ID,'000')  
		  LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON T1.EMP_CODE= EMP.EMP_CODE     
		  LEFT OUTER JOIN EMPLOYEE EMP1 (NOLOCK) ON T1.EMP_CODE1= EMP1.EMP_CODE      
		  LEFT OUTER JOIN EMPLOYEE EMP2 (NOLOCK) ON T1.EMP_CODE2= EMP2.EMP_CODE     
		  LEFT OUTER JOIN NRM N (NOLOCK) ON N.NRM_ID=ISNULL(T1.NRM_ID  ,'0000000')                 
		  WHERE T1.CM_ID = @CMEMO_ID      
          
          UPDATE #TMPCMM_DET SET SR=(SELECT MAX(SR) FROM #TMPCMM_DET)+1 WHERE SR=0
          SELECT TOP 1 @SR=SR FROM #TMPCMM_DET WHERE AUDITID =@CAUDIT_ID
   
          SELECT * FROM #TMPCMM_DET WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)  
   
          SELECT * FROM #TMPCMM_DET WHERE AUDITID<>'' AND (@CAUDIT_ID =''  OR SR=@SR+1 )
     
           
 GOTO END_PROC  
      
 LBL_PIMAUDIT_MST:   
     IF OBJECT_ID('TEMPDB..#TMPPUR_MST','U') IS NOT NULL 
        DROP TABLE #TMPPUR_MST
         
         SELECT TOP 1 @CURAUDITID=SUBSTRING(AUDITID,1,6)+CAST(SUBSTRING(AUDITID,7,LEN(AUDITID ))-1 AS VARCHAR(100)) FROM PIM01106_AUDIT WHERE MRR_ID=@CMEMO_ID ORDER BY AUDITDATETIME 
             
        SELECT SR=ROW_NUMBER () OVER (ORDER BY X.AUDITDATETIME DESC), X.AUDITID, T6.DEPT_NAME,X.DEPT_ID,T4.AC_NAME AS SUPP_NAME,X.AC_CODE,T4.ALIAS,  
               X.INV_NO,X.MRR_NO,MEMO_PREFIX,T2.USERNAME ,X.USER_CODE,  
               SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,X.FREIGHT,                                 
               X.OTHER_CHARGES,TOTAL_AMOUNT ,    
               ROUND_OFF,MRR_DT,X.MRR_ID,BILL_LEVEL_TAX_METHOD,MEMO_TYPE,  
               INV_MODE,TAXFORM_STORAGE_MODE,X.MANUAL_DISCOUNT,  
               MANUAL_ROUNDOFF, AMOUNT=SUM(T1.QUANTITY*T1.MRP),SUM(T1.QUANTITY) AS QUANTITY,  
               BILL_NO,--CONFUSTION(MST/DET)  
               X.EMP_CODE,MRR_NO   
               EMP_NAME,---CONFUSTION(MST/DET)  CREDIT_DAYS,  
               EXCISE_DUTY_AMOUNT,X.TAX_AMOUNT,PARTY_INV_AMOUNT,  
               (X.PARTY_INV_AMOUNT-  X.TOTAL_AMOUNT) AS DIFFERENCE_AMOUNT,  
               RECEIPT_DT,INV_DT, BILL_CHALLAN_MODE,PUR_CAL_METHOD,  
               PIM_MODE,X.CREDIT_DAYS,X.AUDITDATETIME 
          INTO #TMPPUR_MST 
          FROM PIM01106_AUDIT X (NOLOCK)  
          JOIN PID01106_AUDIT T1 (NOLOCK) ON X.AUDITID =T1.AUDITID AND X.MRR_ID =T1.MRR_ID   
          LEFT OUTER JOIN LOCATION T6 (NOLOCK) ON T6.DEPT_ID = X.DEPT_ID    
          JOIN LM01106 T4 (NOLOCK) ON T4.AC_CODE = X.AC_CODE   
          LEFT OUTER JOIN USERS T2 (NOLOCK) ON X.USER_CODE = T2.USER_CODE  
          JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE =X.EMP_CODE  
          WHERE T1.MRR_ID = @CMEMO_ID      
          GROUP BY  X.AUDITID,T6.DEPT_NAME,X.DEPT_ID,T4.AC_NAME,X.AC_CODE,MRR_NO,BILL_NO,  
				    X.INV_NO,MRR_DT,MEMO_PREFIX,T2.USERNAME ,X.USER_CODE,  
				    SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,X.FREIGHT,                                 
				    X.OTHER_CHARGES,  
				    ROUND_OFF,INV_DT,X.MRR_ID,BILL_LEVEL_TAX_METHOD,MEMO_TYPE,  
				    INV_MODE,TAXFORM_STORAGE_MODE,TOTAL_AMOUNT ,X.MANUAL_DISCOUNT,  
				    MANUAL_ROUNDOFF,X.EMP_CODE,EMP_NAME,---CONFUSTION(MST/DET)  
				    CREDIT_DAYS,--CONFUSTION(MST/DET)  
				    EXCISE_DUTY_AMOUNT,X.TAX_AMOUNT,  PARTY_INV_AMOUNT,  
				    (X.PARTY_INV_AMOUNT-  X.TOTAL_AMOUNT),  RECEIPT_DT,  
				    INV_DT,  T4.ALIAS,BILL_CHALLAN_MODE,  PUR_CAL_METHOD,  
				    PIM_MODE,X.CREDIT_DAYS,X.AUDITDATETIME   
           UNION ALL
           SELECT SR=0,  AUDITID=@CURAUDITID, 
                   T6.DEPT_NAME,X.DEPT_ID,T4.AC_NAME AS SUPP_NAME,X.AC_CODE,T4.ALIAS,  
				   X.INV_NO,X.MRR_NO,MEMO_PREFIX,T2.USERNAME ,X.USER_CODE,  
				   SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,X.FREIGHT,                                 
				   X.OTHER_CHARGES,TOTAL_AMOUNT ,    
				   ROUND_OFF,MRR_DT,X.MRR_ID,BILL_LEVEL_TAX_METHOD,MEMO_TYPE,  
				   INV_MODE,TAXFORM_STORAGE_MODE,X.MANUAL_DISCOUNT,  
				   MANUAL_ROUNDOFF, AMOUNT=SUM(T1.QUANTITY*T1.MRP),SUM(T1.QUANTITY) AS QUANTITY,  
				   BILL_NO,--CONFUSTION(MST/DET)  
				   X.EMP_CODE,MRR_NO   
				   EMP_NAME,---CONFUSTION(MST/DET)  CREDIT_DAYS,  
				   EXCISE_DUTY_AMOUNT,X.TAX_AMOUNT,PARTY_INV_AMOUNT,  
				   (X.PARTY_INV_AMOUNT-  X.TOTAL_AMOUNT) AS DIFFERENCE_AMOUNT,  
				   RECEIPT_DT,INV_DT, BILL_CHALLAN_MODE,PUR_CAL_METHOD,  
				   PIM_MODE,X.CREDIT_DAYS,AUDITDATETIME=NULL 
			  FROM PIM01106 X (NOLOCK)  
			  JOIN PID01106 T1 (NOLOCK) ON  X.MRR_ID =T1.MRR_ID   
			  LEFT OUTER JOIN LOCATION T6 (NOLOCK) ON T6.DEPT_ID = X.DEPT_ID    
			  JOIN LM01106 T4 (NOLOCK) ON T4.AC_CODE = X.AC_CODE   
			  LEFT OUTER JOIN USERS T2 (NOLOCK) ON X.USER_CODE = T2.USER_CODE  
			  JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE =X.EMP_CODE  
			  WHERE T1.MRR_ID = @CMEMO_ID      
             -- AND(@CAUDIT_ID ='' OR  X.AUDITID =@CAUDIT_ID)   
             GROUP BY T6.DEPT_NAME,X.DEPT_ID,T4.AC_NAME,X.AC_CODE,MRR_NO,BILL_NO,  
                      X.INV_NO,MRR_DT,MEMO_PREFIX,T2.USERNAME ,X.USER_CODE,  
					  SUBTOTAL,X.DISCOUNT_PERCENTAGE,X.DISCOUNT_AMOUNT,X.FREIGHT,                                 
					  X.OTHER_CHARGES,  
					  ROUND_OFF,INV_DT,X.MRR_ID,BILL_LEVEL_TAX_METHOD,MEMO_TYPE,  
					  INV_MODE,TAXFORM_STORAGE_MODE,TOTAL_AMOUNT ,X.MANUAL_DISCOUNT,  
					  MANUAL_ROUNDOFF,X.EMP_CODE,EMP_NAME,---CONFUSTION(MST/DET)  
					  CREDIT_DAYS,--CONFUSTION(MST/DET)  
					  EXCISE_DUTY_AMOUNT,X.TAX_AMOUNT,  PARTY_INV_AMOUNT,  
					 (X.PARTY_INV_AMOUNT-  X.TOTAL_AMOUNT),  RECEIPT_DT,  
					  INV_DT,  T4.ALIAS,BILL_CHALLAN_MODE,  PUR_CAL_METHOD,  
					  PIM_MODE,X.CREDIT_DAYS
           
            UPDATE #TMPPUR_MST SET SR=(SELECT MAX(SR) FROM #TMPPUR_MST)+1 WHERE SR=0
            
         	SELECT TOP 1 @SR=SR FROM #TMPPUR_MST WHERE AUDITID =@CAUDIT_ID ORDER BY AUDITDATETIME DESC
   
            SELECT * FROM #TMPPUR_MST WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)  --ORDER BY SR DESC 
   
            SELECT * FROM #TMPPUR_MST WHERE AUDITID<>'' AND (@CAUDIT_ID =''  OR SR=@SR+1 )--ORDER BY SR DESC    
     
  GOTO END_PROC  
      
  LBL_PIDAUDIT_DET:  
      IF OBJECT_ID('TEMPDB..#TMPPUR_DET','U') IS NOT NULL 
         DROP TABLE #TMPPUR_DET   
         SELECT TOP 1 @CURAUDITID=SUBSTRING(AUDITID,1,6)+CAST(SUBSTRING(AUDITID,7,LEN(AUDITID ))-1 AS VARCHAR(100)) FROM PIM01106_AUDIT WHERE MRR_ID=@CMEMO_ID ORDER BY AUDITDATETIME 
             
         SELECT  SR=SR,X.AUDITID,SRNO,BOX_NO,ARTICLE_NO,T1.PRODUCT_CODE,  
			    SUB_SECTION_NAME,SECTION_NAME,  
			    PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,  
			    INVOICE_QUANTITY,SCHEME_QUANTITY,QUANTITY,UOM_NAME,  
			    T1.GROSS_PURCHASE_PRICE,T1.DISCOUNT_PERCENTAGE,T1.DISCOUNT_AMOUNT,T1.PURCHASE_PRICE,  
			    T1.FIX_MRP,T1.MRP,T1.WHOLESALE_PRICE,  
			    (T1.INVOICE_QUANTITY*T1.MRP) AS AMOUNT,  
			    T1.MP_PERCENTAGE,T1.WSP_PERCENTAGE,FORM_NAME,  
			    T1.TAX_PERCENTAGE,T1.TAX_AMOUNT,T1.FORM_ID,B.ARTICLE_CODE,T1.ROW_ID,  
			    T1.PARA1_CODE,T1.PARA2_CODE,T1.PARA3_CODE,T1.PARA4_CODE,T1.PARA5_CODE,T1.PARA6_CODE,  
			    E.UOM_CODE,S.BARCODE_CODING_SCHEME AS CODING_SCHEME,  PRODUCT_NAME, USER_SRNO,MD_PERCENTAGE,WD_PERCENTAGE,  
			    B.PARA1_SET,B.PARA2_SET,MANUAL_MRP, T1.MANUAL_WSP,  
			    T1.MANUAL_DISCOUNT,B.ALIAS AS ARTICLE_ALIAS,  
			    ARTICLE_NAME,MATERIAL_COST,X.AUDITDATETIME 
	    INTO #TMPPUR_DET          
	    FROM PIM01106_AUDIT X (NOLOCK)  
	    JOIN PID01106_AUDIT T1 (NOLOCK) ON X.AUDITID =T1.AUDITID AND X.MRR_ID =T1.MRR_ID  
	    JOIN
		 (
		   SELECT AUDITID,AUDITDATETIME,ROW_NUMBER () OVER (ORDER BY AUDITDATETIME DESC) AS SR FROM PIM01106_AUDIT PIM 
		   WHERE PIM.MRR_ID = @CMEMO_ID  
		   GROUP BY AUDITID,AUDITDATETIME
		 ) SR ON SR.AUDITID =X.AUDITID 
	    JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = T1.PRODUCT_CODE    
	    JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE      
	    JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	    JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	    JOIN PARA1 C (NOLOCK) ON T1.PARA1_CODE = C.PARA1_CODE      
	    JOIN PARA2 D (NOLOCK) ON T1.PARA2_CODE = D.PARA2_CODE      
	    JOIN PARA3 F (NOLOCK) ON T1.PARA3_CODE = F.PARA3_CODE      
	    JOIN PARA4 G (NOLOCK) ON T1.PARA4_CODE = G.PARA4_CODE      
	    JOIN PARA5 H (NOLOCK) ON T1.PARA5_CODE = H.PARA5_CODE      
	    JOIN PARA6 I (NOLOCK) ON T1.PARA6_CODE = I.PARA6_CODE    
	    JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE    
	    JOIN BIN B1 ON B1.BIN_ID=ISNULL(T1.BIN_ID,'000')  
        LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON X.EMP_CODE= EMP.EMP_CODE      
        JOIN FORM J (NOLOCK)ON T1.FORM_ID= J.FORM_ID                                
        WHERE T1.MRR_ID = @CMEMO_ID      
            -- AND(@CAUDIT_ID ='' OR  X.AUDITID =@CAUDIT_ID)    
        UNION ALL
        SELECT SR=0, AUDITID=@CURAUDITID,SRNO,BOX_NO,ARTICLE_NO,T1.PRODUCT_CODE,  
			   SUB_SECTION_NAME,SECTION_NAME,  
			   PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,  
			   INVOICE_QUANTITY,SCHEME_QUANTITY,QUANTITY,UOM_NAME,  
			   T1.GROSS_PURCHASE_PRICE,T1.DISCOUNT_PERCENTAGE,T1.DISCOUNT_AMOUNT,T1.PURCHASE_PRICE,  
			   T1.FIX_MRP,T1.MRP,T1.WHOLESALE_PRICE,  
			   (T1.INVOICE_QUANTITY*T1.MRP) AS AMOUNT,  
			   T1.MP_PERCENTAGE,T1.WSP_PERCENTAGE,FORM_NAME,  
			   T1.TAX_PERCENTAGE,T1.TAX_AMOUNT,T1.FORM_ID,B.ARTICLE_CODE,T1.ROW_ID,  
			   T1.PARA1_CODE,T1.PARA2_CODE,T1.PARA3_CODE,T1.PARA4_CODE,T1.PARA5_CODE,T1.PARA6_CODE,  
			   E.UOM_CODE,S.BARCODE_CODING_SCHEME AS CODING_SCHEME,  PRODUCT_NAME, USER_SRNO,MD_PERCENTAGE,WD_PERCENTAGE,  
			   B.PARA1_SET,B.PARA2_SET,MANUAL_MRP, T1.MANUAL_WSP,  
			   T1.MANUAL_DISCOUNT,B.ALIAS AS ARTICLE_ALIAS,  
			   ARTICLE_NAME,MATERIAL_COST,AUDITDATETIME=NULL         
	   FROM PIM01106 X (NOLOCK)  
	   JOIN PID01106 T1 (NOLOCK) ON X.MRR_ID =T1.MRR_ID  
	   JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = T1.PRODUCT_CODE    
	   JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE      
	   JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	   JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	   JOIN PARA1 C (NOLOCK) ON T1.PARA1_CODE = C.PARA1_CODE      
	   JOIN PARA2 D (NOLOCK) ON T1.PARA2_CODE = D.PARA2_CODE      
	   JOIN PARA3 F (NOLOCK) ON T1.PARA3_CODE = F.PARA3_CODE      
	   JOIN PARA4 G (NOLOCK) ON T1.PARA4_CODE = G.PARA4_CODE      
	   JOIN PARA5 H (NOLOCK) ON T1.PARA5_CODE = H.PARA5_CODE      
	   JOIN PARA6 I (NOLOCK) ON T1.PARA6_CODE = I.PARA6_CODE    
	   JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE    
	   JOIN BIN B1 ON B1.BIN_ID=ISNULL(T1.BIN_ID,'000')  
       LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON X.EMP_CODE= EMP.EMP_CODE      
       JOIN FORM J (NOLOCK)ON T1.FORM_ID= J.FORM_ID                                
       WHERE T1.MRR_ID = @CMEMO_ID      
      
          UPDATE #TMPPUR_DET SET SR=(SELECT MAX(SR) FROM #TMPPUR_DET)+1 WHERE SR=0
         
          SELECT TOP 1 @SR=SR FROM #TMPPUR_DET WHERE AUDITID =@CAUDIT_ID ORDER BY AUDITDATETIME DESC
   
          SELECT * FROM #TMPPUR_DET WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID) ORDER BY AUDITDATETIME DESC   
   
          SELECT * FROM #TMPPUR_DET WHERE AUDITID<>'' AND (@CAUDIT_ID =''  OR SR=@SR+1 ) ORDER BY AUDITDATETIME DESC   
          
 GOTO END_PROC  
         
 LBL_VMAUDIT_MST:  
      IF OBJECT_ID('TEMPDB..#TMPVM_MST','U') IS NOT NULL 
         DROP TABLE #TMPVM_MST   
              
         SELECT VM.AUDITID , VM.MRR_LIST,VOUCHER_TYPE,  
                T3.USERNAME  AS AUDITED_BY,VM.VM_ID,VM.VOUCHER_NO,VM.VOUCHER_DT,VM.VOUCHER_CODE,  
                VM.DRTOTAL,VM.CRTOTAL,VM.BILL_NO,VM.CASH_VOUCHER,BILL_DT,  
                VM.BILL_TYPE,REF_NO,VM.SALE_VOUCHER,VM.DEPT_ID,T6.DEPT_NAME ,  
                VM.BILL_ID,VM.CANCELLED,VM.FREEZE,  
                VM.QUANTITY,VM.ANGADIA_CODE,VM.LR_NO,  
                VM.LR_DT,VM.BILL_AC_CODE,VM.APPROVED,VM.REF_VM_ID,  
                VM.USER_CODE,AUDITED_DT,VM.SR_NO,T2.USERNAME  
          INTO #TMPVM_MST 
         FROM VM01106_AUDIT  VM (NOLOCK)  
         JOIN VD01106_AUDIT  VD  (NOLOCK) ON VM.AUDITID =VD.AUDITID AND VM.VM_ID =VD.VM_ID  
         JOIN VCHTYPE VC (NOLOCK) ON VC.VOUCHER_CODE =VM.VOUCHER_CODE   
         LEFT OUTER JOIN LOCATION T6 (NOLOCK) ON T6.DEPT_ID = VM.DEPT_ID    
         LEFT OUTER JOIN USERS T2 (NOLOCK) ON VM.USER_CODE = T2.USER_CODE  
         LEFT OUTER JOIN USERS T3 (NOLOCK) ON VM.AUDITED_USER_CODE = T2.USER_CODE  
         WHERE VM.VM_ID = @CMEMO_ID       
         GROUP BY VM.AUDITID,VM.VM_ID,VM.VOUCHER_NO,VM.VOUCHER_DT,VM.VOUCHER_CODE,  
                  VM.DRTOTAL,VM.CRTOTAL,VM.BILL_NO,VM.CASH_VOUCHER,BILL_DT,  
                  VM.BILL_TYPE,REF_NO,VM.SALE_VOUCHER,VM.DEPT_ID,  
                  VM.BILL_ID,VM.CANCELLED,VM.FREEZE,  
                  VM.QUANTITY,VM.ANGADIA_CODE,VM.LR_NO,  
                  VM.LR_DT,VM.BILL_AC_CODE,VM.APPROVED,VM.REF_VM_ID,  
                  VM.USER_CODE,AUDITED_DT,VM.SR_NO,DEPT_NAME ,T2.USERNAME, T3.USERNAME,VOUCHER_TYPE,VM.MRR_LIST 
         UNION ALL
         SELECT AUDITID='' , VM.MRR_LIST,VOUCHER_TYPE,  
                T3.USERNAME  AS AUDITED_BY,VM.VM_ID,VM.VOUCHER_NO,VM.VOUCHER_DT,VM.VOUCHER_CODE,  
                VM.DRTOTAL,VM.CRTOTAL,VM.BILL_NO,VM.CASH_VOUCHER,BILL_DT,  
                VM.BILL_TYPE,REF_NO,VM.SALE_VOUCHER,VM.DEPT_ID,T6.DEPT_NAME ,  
                VM.BILL_ID,VM.CANCELLED,VM.FREEZE,  
                VM.QUANTITY,VM.ANGADIA_CODE,VM.LR_NO,  
                VM.LR_DT,VM.BILL_AC_CODE,VM.APPROVED,VM.REF_VM_ID,  
                VM.USER_CODE,AUDITED_DT,VM.SR_NO,T2.USERNAME   
         FROM VM01106  VM (NOLOCK)  
         JOIN VD01106  VD  (NOLOCK) ON  VM.VM_ID =VD.VM_ID  
         JOIN VCHTYPE VC (NOLOCK) ON VC.VOUCHER_CODE =VM.VOUCHER_CODE   
         LEFT OUTER JOIN LOCATION T6 (NOLOCK) ON T6.DEPT_ID = VM.DEPT_ID    
         LEFT OUTER JOIN USERS T2 (NOLOCK) ON VM.USER_CODE = T2.USER_CODE  
         LEFT OUTER JOIN USERS T3 (NOLOCK) ON VM.AUDITED_USER_CODE = T2.USER_CODE  
         WHERE VM.VM_ID = @CMEMO_ID         
         GROUP BY VM.VM_ID,VM.VOUCHER_NO,VM.VOUCHER_DT,VM.VOUCHER_CODE,  
                  VM.DRTOTAL,VM.CRTOTAL,VM.BILL_NO,VM.CASH_VOUCHER,BILL_DT,  

                  VM.BILL_TYPE,REF_NO,VM.SALE_VOUCHER,VM.DEPT_ID,  
                  VM.BILL_ID,VM.CANCELLED,VM.FREEZE,  
                  VM.QUANTITY,VM.ANGADIA_CODE,VM.LR_NO,  
                  VM.LR_DT,VM.BILL_AC_CODE,VM.APPROVED,VM.REF_VM_ID,  
                  VM.USER_CODE,AUDITED_DT,VM.SR_NO,DEPT_NAME ,T2.USERNAME, T3.USERNAME,VOUCHER_TYPE,VM.MRR_LIST    
         ORDER BY VM.VM_ID   
             
          SELECT * FROM #TMPVM_MST WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)
             
          SELECT * FROM #TMPVM_MST WHERE AUDITID <>''      
  GOTO END_PROC  
         
  LBL_VDAUDIT_DET:  
      IF OBJECT_ID('TEMPDB..#TMPVM_DET','U') IS NOT NULL 
         DROP TABLE #TMPVM_DET  
                       
     SELECT VD.AUDITID , X_TYPE,VM.DEPT_ID AS COST_CENTER_CODE,AC_NAME,  
            DEBIT_AMOUNT,CREDIT_AMOUNT,NARRATION,  
            CLOSINGBALANCE=0,VD_ID,VD.AC_CODE,VD.VM_ID,  
            VD.CHK_RECON,VD.RECON_DT,VD.COMPANY_CODE,VD.AUTOENTRY,  
            VD.CONTROL_AC,VD.VAT_ENTRY,VD.SECONDARY_NARRATION  
     INTO #TMPVM_DET    
     FROM VM01106_AUDIT  VM (NOLOCK)  
     JOIN VD01106_AUDIT  VD  (NOLOCK) ON VM.AUDITID =VD.AUDITID AND VM.VM_ID =VD.VM_ID      
     JOIN LM01106 T4 (NOLOCK) ON T4.AC_CODE = VD.AC_CODE                          
     WHERE VD.VM_ID = @CMEMO_ID      
          -- AND(@CAUDIT_ID ='' OR  VD.AUDITID =@CAUDIT_ID)
     UNION ALL
      SELECT AUDITID='' , X_TYPE,VM.DEPT_ID AS COST_CENTER_CODE,AC_NAME,  
            DEBIT_AMOUNT,CREDIT_AMOUNT,NARRATION,  
            CLOSINGBALANCE=0,VD_ID,VD.AC_CODE,VD.VM_ID,  
            VD.CHK_RECON,VD.RECON_DT,VD.COMPANY_CODE,VD.AUTOENTRY,  
            VD.CONTROL_AC,VD.VAT_ENTRY,VD.SECONDARY_NARRATION   
     FROM VM01106  VM (NOLOCK)  
     JOIN VD01106  VD  (NOLOCK) ON  VM.VM_ID =VD.VM_ID      
     JOIN LM01106 T4 (NOLOCK) ON T4.AC_CODE = VD.AC_CODE                          
     WHERE VD.VM_ID = @CMEMO_ID    

     
     
     SELECT * FROM #TMPVM_DET WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)
     
     SELECT * FROM #TMPVM_DET  WHERE AUDITID <>''
 GOTO END_PROC  
 
 LBL_RMMAUDIT_MST: 
    IF OBJECT_ID('TEMPDB..#TMPRMM_MST','U') IS NOT NULL
    DROP TABLE #TMPRMM_MST  
   SELECT TOP 1 @CURAUDITID=SUBSTRING(AUDITID,1,6)+CAST(SUBSTRING(AUDITID,7,LEN(AUDITID ))-1 AS VARCHAR(100)) FROM RMM01106_AUDIT WHERE RM_ID=@CMEMO_ID ORDER BY AUDITDATETIME 
   
   SELECT SR=ROW_NUMBER () OVER (ORDER BY RM.AUDITDATETIME DESC), RM.AUDITID ,  RM_NO,RM_DT,  
          ISNULL(LMP.ADDRESS0,'')+ ' '+ ISNULL(LMP.ADDRESS1,'') + ' ' + ISNULL(LMP.ADDRESS2,'') SUPP_ADDRESS,  
          MODE,L.DEPT_NAME,LM.AC_NAME AS SUPP_NAME ,TAXFORM_STORAGE_MODE,  
          L1.DEPT_NAME AS ACCOUNTS_DEPT_NAME,MEMO_PREFIX,B1.BIN_NAME,LM1.AC_NAME AS  BROKER_AC_NAME,  
          CN_NO,BROKER_COMM_PERCENTAGE,BROKER_COMM_AMOUNT,  
          LM. ALIAS AS SUPP_ALIAS,RM.REMARKS,RM.DISCOUNT_AMOUNT,  
          SUBTOTAL,RM.DISCOUNT_PERCENTAGE,  
          CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT_EXCLUSIVE,  
          CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT_INCLUSIVE,  
          OTHER_CHARGES,FREIGHT,RM.EXCISE_DUTY_AMOUNT,  
          ROUND_OFF,TOTAL_AMOUNT,USERNAME,DN_TYPE,MEMO_TYPE,  
          ENTRY_MODE,CANCELLED,SUM(QUANTITY ) AS TOTAL_QTY,RM.AUDITDATETIME,B2.BIN_NAME AS TARGET_BIN_NAME 
   INTO #TMPRMM_MST  
   FROM RMM01106_AUDIT RM  
   JOIN RMD01106_AUDIT RD ON RM.AUDITID =RD.AUDITID AND RM.RM_ID  =RD.RM_ID  
   JOIN LOCATION L (NOLOCK) ON L.DEPT_ID =LEFT(RM.RM_ID,2)      
   JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = RD.PRODUCT_CODE    
   JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE      
   JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
   JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
   JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE      
   JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE      
   JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE      
   JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE      
   JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE      
   JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE    
   JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE    
   JOIN BIN B1 ON B1.BIN_ID=ISNULL(RD.BIN_ID,'000')   
   JOIN BIN B2 ON B2.BIN_ID=ISNULL(RM.TARGET_BIN_ID ,'000')  
   JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE = RM.AC_CODE   
   JOIN USERS U (NOLOCK) ON U.USER_CODE=RM.USER_CODE  
   LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE = RM.AC_CODE   
   LEFT JOIN LM01106 LM1 ON LM1.AC_CODE =RM.BROKER_AC_CODE   
   LEFT JOIN LOCATION  L1 ON L1.DEPT_ID  =RM.ACCOUNTS_DEPT_ID    
   WHERE RM.RM_ID = @CMEMO_ID      
         -- AND(@CAUDIT_ID ='' OR  RM.AUDITID =@CAUDIT_ID)  
   GROUP BY RM_NO,RM_DT,RM.AUDITID ,  
            ISNULL(LMP.ADDRESS0,'')+ ' '+ ISNULL(LMP.ADDRESS1,'') + ' ' + ISNULL(LMP.ADDRESS2,''),  
            MODE,L.DEPT_NAME,LM.AC_NAME  ,TAXFORM_STORAGE_MODE,  
            L1.DEPT_NAME ,MEMO_PREFIX,B1.BIN_NAME,LM1.AC_NAME ,  
            CN_NO,BROKER_COMM_PERCENTAGE,BROKER_COMM_AMOUNT,  
            LM. ALIAS,RM.REMARKS,RM.DISCOUNT_AMOUNT,OTHER_CHARGES,  
            SUBTOTAL,RM.DISCOUNT_PERCENTAGE,  
            FREIGHT,RM.EXCISE_DUTY_AMOUNT,  
            ROUND_OFF,TOTAL_AMOUNT,USERNAME,DN_TYPE,MEMO_TYPE,  
            MODE,ENTRY_MODE,CANCELLED,RM.AUDITDATETIME,B2.BIN_NAME   
   UNION ALL
    SELECT SR=0, AUDITID=@CURAUDITID ,  RM_NO,RM_DT,  
          ISNULL(LMP.ADDRESS0,'')+ ' '+ ISNULL(LMP.ADDRESS1,'') + ' ' + ISNULL(LMP.ADDRESS2,'') SUPP_ADDRESS,  
          MODE,L.DEPT_NAME,LM.AC_NAME AS SUPP_NAME ,TAXFORM_STORAGE_MODE,  
          L1.DEPT_NAME AS ACCOUNTS_DEPT_NAME,MEMO_PREFIX,B1.BIN_NAME,LM1.AC_NAME AS  BROKER_AC_NAME,  
          CN_NO,BROKER_COMM_PERCENTAGE,BROKER_COMM_AMOUNT,  
          LM. ALIAS AS SUPP_ALIAS,RM.REMARKS,RM.DISCOUNT_AMOUNT,  
          SUBTOTAL,RM.DISCOUNT_PERCENTAGE,  
          CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT_EXCLUSIVE,  
          CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT_INCLUSIVE,  
          OTHER_CHARGES,FREIGHT,RD.EXCISE_DUTY_AMOUNT,  
          ROUND_OFF,TOTAL_AMOUNT,USERNAME,DN_TYPE,MEMO_TYPE,  
          ENTRY_MODE,CANCELLED,SUM(QUANTITY ) AS TOTAL_QTY,AUDITDATETIME=NULL,B2.BIN_NAME AS TARGET_BIN_NAME    
   FROM RMM01106 RM  
   JOIN RMD01106 RD ON  RM.RM_ID  =RD.RM_ID  
   JOIN LOCATION L (NOLOCK) ON L.DEPT_ID =LEFT(RM.RM_ID,2)      
   JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = RD.PRODUCT_CODE    
   JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE      
   JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
   JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
   JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE      
   JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE      
   JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE      
   JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE      
   JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE      
   JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE    
   JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE    
   JOIN BIN B1 ON B1.BIN_ID=ISNULL(RD.BIN_ID,'000')
    JOIN BIN B2 ON B2.BIN_ID=ISNULL(RM.TARGET_BIN_ID ,'000')       
   JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE = RM.AC_CODE   
   JOIN USERS U (NOLOCK) ON U.USER_CODE=RM.USER_CODE  
   LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE = RM.AC_CODE   
   LEFT JOIN LM01106 LM1 ON LM1.AC_CODE =RM.BROKER_AC_CODE   
   LEFT JOIN LOCATION  L1 ON L1.DEPT_ID  =RM.ACCOUNTS_DEPT_ID    
   WHERE RM.RM_ID = @CMEMO_ID      
   GROUP BY RM_NO,RM_DT,  
            ISNULL(LMP.ADDRESS0,'')+ ' '+ ISNULL(LMP.ADDRESS1,'') + ' ' + ISNULL(LMP.ADDRESS2,''),  
            MODE,L.DEPT_NAME,LM.AC_NAME  ,TAXFORM_STORAGE_MODE,  
            L1.DEPT_NAME ,MEMO_PREFIX,B1.BIN_NAME,LM1.AC_NAME ,  
            CN_NO,BROKER_COMM_PERCENTAGE,BROKER_COMM_AMOUNT,  
            LM. ALIAS,RM.REMARKS,RM.DISCOUNT_AMOUNT,OTHER_CHARGES,  
            SUBTOTAL,RM.DISCOUNT_PERCENTAGE,  
            FREIGHT,RD.EXCISE_DUTY_AMOUNT,  
            ROUND_OFF,TOTAL_AMOUNT,USERNAME,DN_TYPE,MEMO_TYPE,  
            MODE,ENTRY_MODE,CANCELLED,B2.BIN_NAME   
   ORDER BY RM.AUDITDATETIME DESC 
   
    UPDATE #TMPRMM_MST SET SR=(SELECT MAX(SR) FROM #TMPRMM_MST)+1 WHERE SR=0
    
   SELECT TOP 1 @SR=SR FROM #TMPRMM_MST WHERE AUDITID =@CAUDIT_ID ORDER BY AUDITDATETIME DESC
   
   SELECT * FROM #TMPRMM_MST WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)  
   
   SELECT * FROM #TMPRMM_MST WHERE AUDITID<>'' AND (@CAUDIT_ID =''  OR SR=@SR+1 )
   
   
 GOTO END_PROC  
 
 LBL_RMDAUDIT_DET:  
 
 IF OBJECT_ID('TEMPDB..#TMPRMM','U') IS NOT NULL
    DROP TABLE #TMPRMM   
 SELECT TOP 1 @CURAUDITID=SUBSTRING(AUDITID,1,6)+CAST(SUBSTRING(AUDITID,7,LEN(AUDITID ))-1 AS VARCHAR(100)) FROM RMM01106_AUDIT WHERE RM_ID=@CMEMO_ID ORDER BY AUDITDATETIME 
    
 SELECT SR=SR, RM.AUDITID , ISNULL(PS_NO,'') AS PS_NO,   
          CASE WHEN PS_DT IS NULL THEN '' ELSE CONVERT(VARCHAR,PS_DT,105) END AS PS_DT,   
          RD.PRODUCT_CODE,RD.GROSS_PURCHASE_PRICE,PUR_DISCOUNT_PERCENTAGE,PUR_DISCOUNT_AMOUNT  
          PUR_PURCHASE_PRICE,RD.DISCOUNT_PERCENTAGE,RD.DISCOUNT_AMOUNT,INV_RATE,RATE,  
          DN_DISCOUNT_PERCENTAGE,DN_DISCOUNT_AMOUNT,RD.PURCHASE_PRICE,ARTICLE_NO,  
          INVOICE_QUANTITY,SCHEME_QUANTITY,QUANTITY,AMOUNT,  
          FORM_NAME,ITEM_TAX_PERCENTAGE,  
          ITEM_TAX_AMOUNT,(CASE WHEN  RD.BILL_LEVEL_TAX_METHOD = 2 THEN 'INCLUSIVE' ELSE 'EXCLUSIVE' END) AS TAX_METHOD_NAME,  
          RD.BILL_LEVEL_TAX_METHOD,RD.EXCISE_DUTY_AMOUNT,BILL_NO,CHALLAN_NO,INV_DT,  
          PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,  
          ROW_ID,PRODUCT_NAME,WS_PRICE,S.MRP,RD.REMARKS,BOX_NO,BOX_DT,  
          ITEM_FORM_ID,B.ARTICLE_CODE,S.PARA1_CODE,S.PARA2_CODE,S.PARA3_CODE,S.PARA4_CODE,S.PARA5_CODE,  
          UOM_TYPE,E.UOM_CODE,  
          CAST((RD.EXCISE_DUTY_AMOUNT*RD.QUANTITY) AS NUMERIC(10,2)) AS TOTAL_EXCISE_DUTY_AMOUNT,BIN_NAME,B.ALIAS AS ARTICLE_ALIAS,   
          RM.AUDITDATETIME 
           INTO #TMPRMM
	 FROM RMM01106_AUDIT RM  
	 JOIN RMD01106_AUDIT RD ON RM.AUDITID =RD.AUDITID AND RM.RM_ID  =RD.RM_ID   
	 JOIN
	 (
	   SELECT AUDITID,AUDITDATETIME,ROW_NUMBER () OVER (ORDER BY AUDITDATETIME DESC) AS SR FROM RMM01106_AUDIT RM 
	   WHERE RM.RM_ID = @CMEMO_ID 
	   GROUP BY AUDITID,AUDITDATETIME
	 ) SR ON SR.AUDITID =RM.AUDITID 
	 JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = RD.PRODUCT_CODE    
	 JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE   
	 JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE      
	 JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE      
	 JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE      
	 JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE      
	 JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE      
	 JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE   
	 JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE    
	 JOIN BIN  (NOLOCK) ON BIN.BIN_ID=RD.BIN_ID     
	 JOIN FORM FR (NOLOCK) ON FR.FORM_ID =RD.ITEM_FORM_ID   
	 LEFT OUTER JOIN DNPS_MST PSM (NOLOCK) ON PSM.PS_ID= RD.PS_ID         
	 WHERE RM.RM_ID = @CMEMO_ID     
	 UNION ALL
     SELECT SR=0,  AUDITID=@CURAUDITID , ISNULL(PS_NO,'') AS PS_NO,   
          CASE WHEN PS_DT IS NULL THEN '' ELSE CONVERT(VARCHAR,PS_DT,105) END AS PS_DT,   
          RD.PRODUCT_CODE,RD.GROSS_PURCHASE_PRICE,PUR_DISCOUNT_PERCENTAGE,PUR_DISCOUNT_AMOUNT  
          PUR_PURCHASE_PRICE,RD.DISCOUNT_PERCENTAGE,RD.DISCOUNT_AMOUNT,INV_RATE,RATE,  
          DN_DISCOUNT_PERCENTAGE,DN_DISCOUNT_AMOUNT,RD.PURCHASE_PRICE,ARTICLE_NO,  
          INVOICE_QUANTITY,SCHEME_QUANTITY,QUANTITY,AMOUNT,  
          FORM_NAME,ITEM_TAX_PERCENTAGE,  
          ITEM_TAX_AMOUNT,(CASE WHEN  RD.BILL_LEVEL_TAX_METHOD = 2 THEN 'INCLUSIVE' ELSE 'EXCLUSIVE' END) AS TAX_METHOD_NAME,  
          RD.BILL_LEVEL_TAX_METHOD,RD.EXCISE_DUTY_AMOUNT,BILL_NO,CHALLAN_NO,INV_DT,  
          PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,  
          ROW_ID,PRODUCT_NAME,WS_PRICE,S.MRP,RD.REMARKS,BOX_NO,BOX_DT,  
          ITEM_FORM_ID,B.ARTICLE_CODE,S.PARA1_CODE,S.PARA2_CODE,S.PARA3_CODE,S.PARA4_CODE,S.PARA5_CODE,  
          UOM_TYPE,E.UOM_CODE,  
          CAST((RD.EXCISE_DUTY_AMOUNT*RD.QUANTITY) AS NUMERIC(10,2)) AS TOTAL_EXCISE_DUTY_AMOUNT,BIN_NAME,B.ALIAS AS ARTICLE_ALIAS,  
           AUDITDATETIME='1900-01-01'  
	 FROM RMM01106 RM  
	 JOIN RMD01106 RD ON  RM.RM_ID  =RD.RM_ID   
	 JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = RD.PRODUCT_CODE    
	 JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE   
	 JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE      
	 JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE      
	 JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE      
	 JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE      
	 JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE      
	 JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE   
	 JOIN UOM   E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE    
	 JOIN BIN  (NOLOCK) ON BIN.BIN_ID=RD.BIN_ID     
	 JOIN FORM FR (NOLOCK) ON FR.FORM_ID =RD.ITEM_FORM_ID   
	 LEFT OUTER JOIN DNPS_MST PSM (NOLOCK) ON PSM.PS_ID= RD.PS_ID         
	 WHERE RM.RM_ID = @CMEMO_ID  
	 ORDER BY AUDITDATETIME DESC     
	 
    UPDATE #TMPRMM SET SR=(SELECT MAX(SR) FROM #TMPRMM)+1 WHERE SR=0
    SELECT TOP 1 @SR=SR FROM #TMPRMM WHERE AUDITID =@CAUDIT_ID
   
    SELECT * FROM #TMPRMM WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)  
   
    SELECT * FROM #TMPRMM WHERE AUDITID<>'' AND (@CAUDIT_ID =''  OR SR=@SR+1 )
        
  GOTO END_PROC  
  
 LBL_CNMAUDIT:--CREDIT NOTE  
       
    SELECT  X.CN_ID AS MEMO_ID, X.CN_ID AS MEMO_NO, CONVERT(VARCHAR,X.CN_DT,105) AS MEMO_DT,CONVERT(VARCHAR,X.AUDITDATETIME,105) AS AUDITDATETIME,NET_AMOUNT=X.TOTAL_AMOUNT,
           SUM(C.QUANTITY) AS QUANTITY,X.AUDITID,X.WINUSERNAME,U.USERNAME , X.COMPUTERNAME,CAST(0 AS BIT)AS VISIT  
    FROM CNM01106_AUDIT X (NOLOCK)  
    JOIN   
    (  
		SELECT  A.CN_ID AS MEMO_ID, MAX(A.AUDITDATETIME) AS AUDITDATETIME--,SUM(A.QUANTITY) AS QUANTITY  
		FROM CNM01106_AUDIT A (NOLOCK)  
		GROUP BY  A.CN_ID  
    ) B ON X.CN_ID =B.MEMO_ID  AND CONVERT(VARCHAR,X.AUDITDATETIME,120) =CONVERT(VARCHAR,B.AUDITDATETIME,120) 
    JOIN CND01106_AUDIT C (NOLOCK) ON C.AUDITID =X.AUDITID AND C.CN_ID =X.CN_ID    
    JOIN USERS U (NOLOCK) ON U.USER_CODE =X.USER_CODE   
    WHERE X.CN_DT BETWEEN @CFMDT AND @CTODT  
          AND (@NMODE=2 OR X.CANCELLED=@NMODE)  
          AND (@LOC_ID='' OR LEFT(X.CN_ID,2)=@LOC_ID)  
    GROUP BY X.CN_ID, X.CN_ID ,X.CN_DT,X.AUDITDATETIME ,X.TOTAL_AMOUNT,  
             X.AUDITID, X.AUDITDATETIME,X.WINUSERNAME, X.COMPUTERNAME,U.USERNAME  
    ORDER BY X.AUDITDATETIME  
      
  GOTO END_PROC   
  LBL_CNM_AUDIT_MST:-- CREDIT NOTE MASTER  
    
     IF OBJECT_ID('TEMPDB..#TMPCNM_MST','U') IS NOT NULL
         DROP TABLE #TMPCNM_MST 
         
     SELECT TOP 1 @CURAUDITID=SUBSTRING(AUDITID,1,6)+CAST(SUBSTRING(AUDITID,7,LEN(AUDITID ))-1 AS VARCHAR(100)) FROM CNM01106_AUDIT WHERE CN_ID=@CMEMO_ID ORDER BY AUDITDATETIME 
               
     SELECT SR=ROW_NUMBER () OVER (ORDER BY A.AUDITDATETIME DESC), A.AUDITID,A.CN_DT,A.CN_TYPE,A.TOTAL_AMOUNT,A.RECEIPT_DT,  
            T4.AC_NAME,T4.ADDRESS0+' '+T4.ADDRESS1+' ' +T4.ADDRESS2+' '             
            +T4.AREA_NAME+' ' +T4.CITY+' ' +T4.[STATE]+' '+T4.PINCODE AS PARTY_ADDRESS,  
            A.MODE,A.CN_ID,  
            ISNULL(T5.DEPT_NAME,'') AS PARTY_DEPT_NAME ,  
            A.TAXFORM_STORAGE_MODE,A.BROKER_AC_CODE,A.GRLR_DATE,A.MANUAL_DN_DT,  
            CASE WHEN A.CANCELLED=0 THEN 'CANCELLED' ELSE '' END AS CANCELLED,  
            A.MEMO_TYPE,A.MEMO_PREFIX,A.CN_NO,A.AC_CODE,T2.USERNAME,A.USER_CODE AS USERCODE,A.SUBTOTAL,  
            A.DISCOUNT_PERCENTAGE,A.DISCOUNT_AMOUNT,A.FREIGHT,A.OTHER_CHARGES,A.REMARKS,A.ROUND_OFF,  
            CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT_INCLUSIVE ,CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT_EXCLUSIVE,  
            A.MANUAL_INV_NO,A.MANUAL_DN_NO,A.MANUAL_DN_AMOUNT,A.PARTY_DEPT_ID,  
            ISNULL(T7.AC_NAME,'') AS BROKER_AC_NAME,BIN_NAME,A.BIN_ID,
            BROKER_COMM_PERCENTAGE,BROKER_COMM_AMOUNT,A.AUDITDATETIME   
      INTO #TMPCNM_MST
      FROM CNM01106_AUDIT (NOLOCK) A  
      JOIN LMV01106 T4 (NOLOCK) ON T4.AC_CODE = A.AC_CODE    
      LEFT OUTER JOIN LOCATION T5 (NOLOCK) ON T5.DEPT_ID = A.PARTY_DEPT_ID  
      LEFT OUTER JOIN LMV01106 T7 (NOLOCK) ON T7.AC_CODE = A.BROKER_AC_CODE   
      LEFT OUTER JOIN BIN B1 ON B1.BIN_ID=ISNULL(A.BIN_ID,'000')        
      JOIN USERS T2 (NOLOCK)  ON A.USER_CODE = T2.USER_CODE    
      WHERE A.CN_ID = @CMEMO_ID      
            --AND(@CAUDIT_ID ='' OR  A.AUDITID =@CAUDIT_ID)   
      UNION ALL
      SELECT SR=0, AUDITID=@CURAUDITID,A.CN_DT,A.CN_TYPE,A.TOTAL_AMOUNT,A.RECEIPT_DT,  
            T4.AC_NAME,T4.ADDRESS0+' '+T4.ADDRESS1+' ' +T4.ADDRESS2+' '             
            +T4.AREA_NAME+' ' +T4.CITY+' ' +T4.[STATE]+' '+T4.PINCODE AS PARTY_ADDRESS,  
            A.MODE,A.CN_ID,  
            ISNULL(T5.DEPT_NAME,'') AS PARTY_DEPT_NAME ,  
            A.TAXFORM_STORAGE_MODE,A.BROKER_AC_CODE,A.GRLR_DATE,A.MANUAL_DN_DT,  
            CASE WHEN A.CANCELLED=0 THEN 'CANCELLED' ELSE '' END AS CANCELLED,  
            A.MEMO_TYPE,A.MEMO_PREFIX,A.CN_NO,A.AC_CODE,T2.USERNAME,A.USER_CODE AS USERCODE,A.SUBTOTAL,  
            A.DISCOUNT_PERCENTAGE,A.DISCOUNT_AMOUNT,A.FREIGHT,A.OTHER_CHARGES,A.REMARKS,A.ROUND_OFF,  
            CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT_INCLUSIVE ,CONVERT(NUMERIC(10,2), 0 )AS TAX_AMOUNT_EXCLUSIVE,  
            A.MANUAL_INV_NO,A.MANUAL_DN_NO,A.MANUAL_DN_AMOUNT,A.PARTY_DEPT_ID,  
            ISNULL(T7.AC_NAME,'') AS BROKER_AC_NAME,BIN_NAME,A.BIN_ID,
            BROKER_COMM_PERCENTAGE,BROKER_COMM_AMOUNT,AUDITDATETIME=NULL   
      FROM CNM01106 (NOLOCK) A  
      JOIN LMV01106 T4 (NOLOCK) ON T4.AC_CODE = A.AC_CODE    
      LEFT OUTER JOIN LOCATION T5 (NOLOCK) ON T5.DEPT_ID = A.PARTY_DEPT_ID  
      LEFT OUTER JOIN LMV01106 T7 (NOLOCK) ON T7.AC_CODE = A.BROKER_AC_CODE   
      LEFT OUTER JOIN BIN B1 ON B1.BIN_ID=ISNULL(A.BIN_ID,'000')        
      JOIN USERS T2 (NOLOCK)  ON A.USER_CODE = T2.USER_CODE    
      WHERE A.CN_ID = @CMEMO_ID  
      ORDER BY A.AUDITDATETIME DESC 
   
      UPDATE #TMPCNM_MST SET SR=(SELECT MAX(SR) FROM #TMPCNM_MST)+1 WHERE SR=0
      
      SELECT TOP 1 @SR=SR FROM #TMPCNM_MST WHERE AUDITID =@CAUDIT_ID ORDER BY AUDITDATETIME DESC
    
      SELECT * FROM #TMPCNM_MST WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)  
   
      SELECT * FROM #TMPCNM_MST WHERE AUDITID<>'' AND (@CAUDIT_ID =''  OR SR=@SR+1 )  
       
                
 GOTO END_PROC       
 LBL_CNM_AUDIT_DET:  
      
     IF OBJECT_ID('TEMPDB..#TMPCNM_DET','U') IS NOT NULL
         DROP TABLE #TMPCNM_DET
       SELECT TOP 1 @CURAUDITID=SUBSTRING(AUDITID,1,6)+CAST(SUBSTRING(AUDITID,7,LEN(AUDITID ))-1 AS VARCHAR(100)) FROM CNM01106_AUDIT WHERE CN_ID=@CMEMO_ID ORDER BY AUDITDATETIME               
      SELECT SR AS S_NO,B.AUDITID   
             ,B.PRODUCT_CODE,B.GROSS_RATE,B.IND_DISCOUNT_PERCENTAGE,B.IND_DISCOUNT_AMOUNT,B.IND_RATE  
             ,B.INM_DISCOUNT_PERCENTAGE,B.INM_DISCOUNT_AMOUNT,B.INV_NET_RATE,B.INVOICE_QUANTITY,B.SCHEME_QUANTITY  
             ,B.QUANTITY,B.RATE,B.DISCOUNT_PERCENTAGE,B.DISCOUNT_AMOUNT,B.NET_RATE,S.MRP,FORM_NAME  
             ,B.ITEM_TAX_PERCENTAGE,B.ITEM_TAX_AMOUNT  
             ,(CASE WHEN  B.BILL_LEVEL_TAX_METHOD = 2 THEN 'INCLUSIVE' ELSE 'EXCLUSIVE' END) AS TAX_METHOD_NAME   
             ,ARTICLE_NO,SECTION_NAME  
             ,SUB_SECTION_NAME,(QUANTITY *S.MRP) AS AMOUNT,EMP.EMP_NAME AS EMP_NAME   
             ,EMP1.EMP_NAME AS EMP_NAME1,EMP2.EMP_NAME AS EMP_NAME2  
             ,PARA1_NAME, CONVERT(VARCHAR,B.INV_DT,105) AS REF_INV_DT,PARA2_NAME  
             ,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,B.ROW_ID,PRODUCT_NAME  
             ,ITEM_TAX_ID='',ART.ARTICLE_CODE,S.PARA1_CODE  
             ,D.PARA2_CODE,B.EMP_CODE,B.EMP_CODE1,B.EMP_CODE2,B.REF_INV_ID  
             ,BIN_NAME,ART.ALIAS AS ARTICLE_ALIAS,ARTICLE_NAME  
             ,B.BILL_LEVEL_TAX_METHOD,B.ITEM_FORM_ID
             ,E.UOM_CODE,UOM_NAME,A.AUDITDATETIME
      INTO #TMPCNM_DET
      FROM CNM01106_AUDIT A (NOLOCK)  
      JOIN CND01106_AUDIT B (NOLOCK) ON A.AUDITID =B.AUDITID AND A.CN_ID =B.CN_ID 
      JOIN
	  (
	   SELECT AUDITID,AUDITDATETIME,ROW_NUMBER () OVER (ORDER BY AUDITDATETIME DESC) AS SR FROM CNM01106_AUDIT CNM 
	   WHERE CNM.CN_ID = @CMEMO_ID 
	   GROUP BY AUDITID,AUDITDATETIME
	  ) SR ON SR.AUDITID =A.AUDITID  
      JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = B.PRODUCT_CODE    
	  JOIN ARTICLE ART (NOLOCK) ON S.ARTICLE_CODE = ART.ARTICLE_CODE      
	  JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	  JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	  JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE      
	  JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE      
	  JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE      
	  JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE      
	  JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE      
	  JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE  
	  JOIN FORM  (NOLOCK) ON FORM.FORM_ID =B.ITEM_FORM_ID   
	  LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON B.EMP_CODE= EMP.EMP_CODE     
	  LEFT OUTER JOIN EMPLOYEE EMP1 (NOLOCK) ON B.EMP_CODE1= EMP1.EMP_CODE      
	  LEFT OUTER JOIN EMPLOYEE EMP2 (NOLOCK) ON B.EMP_CODE2= EMP2.EMP_CODE  
	  LEFT OUTER JOIN INM01106 INM (NOLOCK) ON INM.INV_ID= B.REF_INV_ID 
	  JOIN UOM   E (NOLOCK) ON E.UOM_CODE = ART.UOM_CODE           
	  JOIN BIN B1 ON B1.BIN_ID=ISNULL(B.BIN_ID,'000')  
	  WHERE A.CN_ID = @CMEMO_ID      
           --AND(@CAUDIT_ID ='' OR  A.AUDITID =@CAUDIT_ID)   
      UNION ALL
      SELECT 0 AS S_NO ,AUDITID=@CURAUDITID 
             ,B.PRODUCT_CODE,B.GROSS_RATE,B.IND_DISCOUNT_PERCENTAGE,B.IND_DISCOUNT_AMOUNT,B.IND_RATE  
             ,B.INM_DISCOUNT_PERCENTAGE,B.INM_DISCOUNT_AMOUNT,B.INV_NET_RATE,B.INVOICE_QUANTITY,B.SCHEME_QUANTITY  
             ,B.QUANTITY,B.RATE,B.DISCOUNT_PERCENTAGE,B.DISCOUNT_AMOUNT,B.NET_RATE,S.MRP,FORM_NAME  
             ,B.ITEM_TAX_PERCENTAGE,B.ITEM_TAX_AMOUNT  
             ,(CASE WHEN  B.BILL_LEVEL_TAX_METHOD = 2 THEN 'INCLUSIVE' ELSE 'EXCLUSIVE' END) AS TAX_METHOD_NAME   
             ,ARTICLE_NO,SECTION_NAME  
             ,SUB_SECTION_NAME,(QUANTITY *S.MRP) AS AMOUNT,EMP.EMP_NAME AS EMP_NAME   
             ,EMP1.EMP_NAME AS EMP_NAME1,EMP2.EMP_NAME AS EMP_NAME2  
             ,PARA1_NAME, CONVERT(VARCHAR,B.INV_DT,105) AS REF_INV_DT,PARA2_NAME  
             ,PARA3_NAME,PARA4_NAME,PARA5_NAME,PARA6_NAME,B.ROW_ID,PRODUCT_NAME  
             ,ITEM_TAX_ID='',ART.ARTICLE_CODE,S.PARA1_CODE  
             ,D.PARA2_CODE,B.EMP_CODE,B.EMP_CODE1,B.EMP_CODE2,B.REF_INV_ID  
             ,BIN_NAME,ART.ALIAS AS ARTICLE_ALIAS,ARTICLE_NAME  
             ,B.BILL_LEVEL_TAX_METHOD,B.ITEM_FORM_ID 
             ,E.UOM_CODE,UOM_NAME,AUDITDATETIME=NULL 
      FROM CNM01106 A (NOLOCK)  
      JOIN CND01106 B (NOLOCK) ON  A.CN_ID =B.CN_ID  
      JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = B.PRODUCT_CODE    
	  JOIN ARTICLE ART (NOLOCK) ON S.ARTICLE_CODE = ART.ARTICLE_CODE      
	  JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
	  JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
	  JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE      
	  JOIN PARA2 D (NOLOCK) ON S.PARA2_CODE = D.PARA2_CODE      
	  JOIN PARA3 F (NOLOCK) ON S.PARA3_CODE = F.PARA3_CODE      
	  JOIN PARA4 G (NOLOCK) ON S.PARA4_CODE = G.PARA4_CODE      
	  JOIN PARA5 H (NOLOCK) ON S.PARA5_CODE = H.PARA5_CODE      
	  JOIN PARA6 I (NOLOCK) ON S.PARA6_CODE = I.PARA6_CODE  
	  JOIN FORM  (NOLOCK) ON FORM.FORM_ID =B.ITEM_FORM_ID   
	  LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON B.EMP_CODE= EMP.EMP_CODE     
	  LEFT OUTER JOIN EMPLOYEE EMP1 (NOLOCK) ON B.EMP_CODE1= EMP1.EMP_CODE      
	  LEFT OUTER JOIN EMPLOYEE EMP2 (NOLOCK) ON B.EMP_CODE2= EMP2.EMP_CODE  
	  LEFT OUTER JOIN INM01106 INM (NOLOCK) ON INM.INV_ID= B.REF_INV_ID 
	  JOIN UOM   E (NOLOCK) ON E.UOM_CODE = ART.UOM_CODE           
	  JOIN BIN B1 ON B1.BIN_ID=ISNULL(B.BIN_ID,'000')  
	  WHERE A.CN_ID = @CMEMO_ID    
	  ORDER BY A.AUDITDATETIME DESC     
   
        UPDATE #TMPCNM_DET SET S_NO=(SELECT MAX(S_NO) FROM #TMPCNM_DET)+1 WHERE S_NO=0
      
        SELECT TOP 1 @SR=S_NO FROM #TMPCNM_DET WHERE AUDITID =@CAUDIT_ID
   
        SELECT * FROM #TMPCNM_DET WHERE (@CAUDIT_ID ='' OR  AUDITID =@CAUDIT_ID)  
   
        SELECT * FROM #TMPCNM_DET WHERE AUDITID<>'' AND (@CAUDIT_ID =''  OR S_NO=@SR+1 )  
	   
  GOTO END_PROC   
         
END_PROC:     
END     
--END OF PROCEDURE - SP_AUDIT_LOG_DETAILS
