CREATE PROCEDURE SP_CHECKSTOCK_GV   
 @CPRODUCTCODE VARCHAR(50),
 @BDONOTCHECKSTOCK BIT=0,
 @bCalledFromCancellation BIT=0
-- WITH ENCRYPTION
AS    
BEGIN    
	DECLARE @NSTKQTY NUMERIC(10,3),@CPRDCODE VARCHAR(100),@INSTOCK NUMERIC(14,2),@CCMD NVARCHAR(MAX),
			@nGvType NUMERIC(1,0)
	
	SELECT TOP 1 @CPRDCODE=GV_SRNO,@nGvType=ISNULL(gv_type,1) FROM SKU_GV_MST (NOLOCK) WHERE GV_SRNO=@CPRODUCTCODE   	
    
    IF @CPRDCODE IS NULL      
		SET @CCMD= N'SELECTED GV NOT FOUND....PLEASE CHECK'
	ELSE
	IF @nGvType=2 AND ISNULL(@bCalledFromCancellation,0)=0
	BEGIN
		SET @CCMD= N'Freebies type of GV(s) not allowed to be sold....PLEASE CHECK'
	END
	BEGIN	
		SELECT @INSTOCK=SUM(PMT.QUANTITY_IN_STOCK) 
		FROM PMT_GV_MST PMT (NOLOCK)
		WHERE PMT.GV_SRNO =@CPRDCODE
		

  		IF @INSTOCK<=0 AND (@BDONOTCHECKSTOCK=0 OR ISNULL(@bCalledFromCancellation,0)=1)
			SET @CCMD= N'GV NOT IN STOCK....PLEASE CHECK' 
	END
	SELECT ISNULL(@CCMD,'') AS RETMSG     	       	 

	SELECT *   
	FROM PMT_GV_MST PMT (NOLOCK) 
	JOIN  SKU_GV_MST GV (NOLOCK) ON GV.GV_SRNO=PMT.GV_SRNO
	WHERE GV.GV_SRNO=@CPRDCODE
END
