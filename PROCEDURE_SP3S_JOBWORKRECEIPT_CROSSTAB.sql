CREATE PROCEDURE SP3S_JOBWORKRECEIPT_CROSSTAB  
(      
 @nQueryID  INT,      
 @cDeptID  VARCHAR(50),      
 @cWhere   VARCHAR(50)='',      
 @cWhere1  VARCHAR(50)=''      
)      
AS      
BEGIN      
 IF @nQueryID=1      
 BEGIN      
   SELECT A.ARTICLE_NO,A.article_name,A.article_code,B.UOM_CODE,B.UOM_NAME, B.UOM_TYPE  
   FROM article A (NOLOCK)   
   JOIN UOM B (NOLOCK)  ON A.UOM_CODE = B.UOM_CODE     
   WHERE A.coding_scheme=3 AND (A.article_name LIKE @cWhere1 OR A.article_no LIKE @cWhere1)  
 END      
 ELSE IF @nQueryID=2      
 BEGIN      
 IF EXISTS(SELECT TOP 1 article_code FROM art_para1 WHERE article_code=@cWhere)  
 BEGIN  
  SELECT A.PARA1_NAME,A.PARA1_CODE  
  FROM PARA1  A (NOLOCK)  
  JOIN art_para1 B  (NOLOCK) ON B.para1_code=A.para1_code  
  WHERE A.inactive=0 AND B.article_code=@cWhere AND A.PARA1_NAME LIKE @cWhere1  
 END  
 ELSE  
 BEGIN  
  SELECT PARA1_NAME,PARA1_CODE  
  FROM PARA1  (NOLOCK)  
  WHERE inactive=0 AND PARA1_NAME LIKE @cWhere1  
 END  
 END      
 ELSE IF @nQueryID=3      
 BEGIN      
 IF EXISTS(SELECT TOP 1 article_code FROM art_det WHERE article_code=@cWhere)  
 BEGIN  
  SELECT A.PARA2_NAME,A.PARA2_CODE  
  FROM PARA2  A (NOLOCK)  
  JOIN art_det B  (NOLOCK) ON B.para2_code=A.para2_code  
  WHERE A.inactive=0 AND B.article_code=@cWhere AND A.PARA2_NAME LIKE @cWhere1  
 END  
 ELSE  
 BEGIN  
  SELECT PARA2_NAME,PARA2_CODE  
  FROM PARA2 (NOLOCK)   
  WHERE inactive=0 AND PARA2_NAME LIKE @cWhere1  
 END     
 END     
 ELSE IF @nQueryID=4      
 BEGIN      
 SELECT  A.ARTICLE_CODE, A.ARTICLE_NO, A.ARTICLE_NAME ,       
 B.SUB_SECTION_NAME,B.SUB_SECTION_CODE,C.SECTION_CODE, C.SECTION_NAME  
 ,A.CODING_SCHEME   ,A.PARA1_SET,A.PARA2_SET,A.ALIAS AS ARTICLE_ALIAS      
 FROM ARTICLE A (NOLOCK)     
 JOIN SECTIOND B (NOLOCK) ON A.SUB_SECTION_CODE = B.SUB_SECTION_CODE        
 JOIN SECTIONM C (NOLOCK)  ON B.SECTION_CODE = C.SECTION_CODE    
 WHERE A.ARTICLE_TYPE =1 AND ARTICLE_PRD_MODE <> 3  AND A.INACTIVE =0   
 AND ISNULL(A.ARTICLE_NO,'')<>''   AND ISNULL(C.ITEM_TYPE,1)=1 AND  A.ARTICLE_NO=@cWhere  
 UNION ALL  
 SELECT  A.ARTICLE_CODE, A.ALIAS AS [ARTICLE_NO], A.ARTICLE_NAME ,       
 B.SUB_SECTION_NAME,B.SUB_SECTION_CODE,C.SECTION_CODE, C.SECTION_NAME  
 ,A.CODING_SCHEME   ,A.PARA1_SET,A.PARA2_SET,A.ALIAS AS ARTICLE_ALIAS      
 FROM ARTICLE A (NOLOCK)     
 JOIN SECTIOND B (NOLOCK) ON A.SUB_SECTION_CODE = B.SUB_SECTION_CODE        
 JOIN SECTIONM C (NOLOCK)  ON B.SECTION_CODE = C.SECTION_CODE    
 WHERE A.ARTICLE_TYPE =1 AND ARTICLE_PRD_MODE <> 3  AND A.INACTIVE =0   
 AND ISNULL(A.ARTICLE_NO,'')<>'' AND ISNULL(A.ALIAS,'')<>''     
 AND ISNULL(C.ITEM_TYPE,1)=1 AND  ISNULL(A.ALIAS,'')=@cWhere  
 END   
 ELSE IF @nQueryID=5      
 BEGIN  
 SELECT A.ARTICLE_CODE, A.ARTICLE_DESC, A.ARTICLE_NAME,     
 A.ARTICLE_NO, A.CODING_SCHEME,      
 A.PURCHASE_PRICE, A.MRP, A.WHOLESALE_PRICE AS WS_PRICE, A.CREATED_ON,     
 A.PARA1_SET, A.PARA2_SET, B.UOM_CODE,B.UOM_NAME, B.UOM_TYPE,A.DT_CREATED,  
 A.ALIAS AS ARTICLE_ALIAS   ,A.HSN_CODE   
 FROM ARTICLE A (NOLOCK)       
 JOIN UOM B (NOLOCK)  ON A.UOM_CODE = B.UOM_CODE      
 WHERE A.ARTICLE_TYPE =1 AND ARTICLE_PRD_MODE <> 3 AND  A.ARTICLE_CODE = @CWHERE  AND  A.INACTIVE =0     
 END   
 ELSE IF @nQueryID=6      
 BEGIN  
 SELECT DISTINCT A.ARTICLE_CODE, A.PARA1_CODE, B.PARA1_NAME       
 FROM ART_PARA1 A (NOLOCK)       
 JOIN PARA1 B (NOLOCK)  ON A.PARA1_CODE = B.PARA1_CODE    
 WHERE A.ARTICLE_CODE = @CWHERE        
 ORDER BY B.PARA1_NAME    
      
 END   
 ELSE IF @nQueryID=7      
 BEGIN  
 SELECT DISTINCT A.ARTICLE_CODE, A.PARA2_CODE, B.PARA2_NAME,B.PARA2_ORDER ,A.MRP,A.WS_PRICE   
 FROM ART_DET A (NOLOCK)       
 JOIN PARA2 B (NOLOCK)  ON A.PARA2_CODE = B.PARA2_CODE      
 WHERE A.ARTICLE_CODE = @CWHERE       
 ORDER BY B.PARA2_ORDER      
 END   
 ELSE IF @nQueryID=8  
 BEGIN  
 DECLARE @DTSQL NVARCHAR(MAX),@CCOLS NVARCHAR(MAX)  
 SELECT AP.ARTICLE_CODE,P1.PARA1_CODE,P1.PARA1_NAME,P2.PARA2_ORDER,P2.PARA2_NAME  
 ,CAST(0 AS NUMERIC(14,2)) AS QUANTITY  
 INTO #ARTPARAS  
 FROM   
 (  
  ---CARTESIAN PRODUCT OF MATCHING ARTICLES   
  SELECT DISTINCT AP1.ARTICLE_CODE,AP1.PARA1_CODE,AP2.PARA2_CODE  
  FROM ART_PARA1 AP1(NOLOCK)  
  JOIN ART_DET AP2(NOLOCK) ON AP1.ARTICLE_CODE=AP2.ARTICLE_CODE  
  WHERE AP1.ARTICLE_CODE=@CWHERE  
  UNION  
  ---DETAILS FOR MISSING ARTICLES IN ART_DET  
  SELECT DISTINCT AP1.ARTICLE_CODE,AP1.PARA1_CODE,'0000000' AS PARA2_CODE  
  FROM ART_PARA1 AP1(NOLOCK)  
  LEFT JOIN ART_DET AP2(NOLOCK) ON AP1.ARTICLE_CODE=AP2.ARTICLE_CODE  
  WHERE AP2.ARTICLE_CODE IS NULL AND AP1.ARTICLE_CODE=@CWHERE  
  UNION  
  ---DETAILS FOR MISSING ARTICLES IN ART_PARA1  
  SELECT DISTINCT AP2.ARTICLE_CODE,'0000000' AS PARA1_CODE,AP2.PARA2_CODE  
  FROM ART_DET AP2(NOLOCK)  
  LEFT JOIN ART_PARA1 AP1(NOLOCK) ON AP1.ARTICLE_CODE=AP2.ARTICLE_CODE  
  WHERE AP1.ARTICLE_CODE IS NULL AND AP2.ARTICLE_CODE=@CWHERE  
 )AP  
 JOIN PARA1 P1(NOLOCK) ON P1.PARA1_CODE=AP.PARA1_CODE  
 JOIN PARA2 P2(NOLOCK) ON P2.PARA2_CODE=AP.PARA2_CODE  
 GROUP BY AP.ARTICLE_CODE,P1.PARA1_CODE,P1.PARA1_NAME,P2.PARA2_ORDER,P2.PARA2_NAME  
  
 --SELECT * FROM #ARTPARAS   
 SELECT DISTINCT UPPER(PARA2_NAME) AS PARA2_NAME ,PARA2_ORDER INTO #SIZES FROM #ARTPARAS    
  
 ALTER TABLE #ARTPARAS DROP COLUMN PARA2_ORDER   
  
 SELECT @CCOLS=ISNULL(@CCOLS+',','')+QUOTENAME(PARA2_NAME)  
 FROM #SIZES  
 ORDER BY PARA2_ORDER ASC  
 --SELECT @CCOLS  
  
 SELECT * INTO #ARTPARAS_DUP FROM #ARTPARAS  
   
 UPDATE #ARTPARAS_DUP SET QUANTITY=0  
  
 SET @DTSQL=N'SELECT PARA1_CODE AS COLOR_CODE,PARA1_NAME AS COLOR,CAST(0 AS NUMERIC(14,2)) AS TOTAL,'+@CCOLS+',0 AS IS_ENTRYCOL ,CAST(0 AS BIT) AS IS_MANUAL   
    FROM #ARTPARAS   
    PIVOT(SUM(QUANTITY) FOR PARA2_NAME IN ('+@CCOLS+')) AS PTABLE  
    UNION ALL  
    SELECT PARA1_CODE AS COLOR_CODE,PARA1_NAME AS COLOR,CAST(0 AS NUMERIC(14,2)) AS TOTAL,'+@CCOLS+',1 AS IS_ENTRYCOL  ,CAST(0 AS BIT) AS IS_MANUAL   
    FROM #ARTPARAS_DUP   
    PIVOT(SUM(QUANTITY) FOR PARA2_NAME IN ('+@CCOLS+')) AS PTABLE  
    ORDER BY PARA1_NAME,IS_ENTRYCOL ASC'  
 PRINT @DTSQL  
 EXEC SP_EXECUTESQL @DTSQL  
   
 END  
 ELSE IF @nQueryID=99      
 BEGIN      
 SELECT A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,B.PARA1_CODE,B.PARA1_NAME,C.PARA2_CODE,C.PARA2_NAME,  
 CAST(0 AS NUMERIC(14,2)) AS QUANTITY,CAST('' AS VARCHAR(50)) AS ROW_ID,CAST('' AS VARCHAR(50)) AS REF_ROW_ID  
 ,CAST('' AS VARCHAR(50)) AS DEPT_ID,CAST('' AS VARCHAR(50)) AS BIN_ID,CAST('' AS VARCHAR(50)) AS JOB_CODE,  
 CAST('' AS NUMERIC(14,2)) AS JOB_RATE,CAST('' AS VARCHAR(50)) AS FIX_PRODUCT_CODE,  
 A.PARA1_SET, A.PARA2_SET, U.UOM_CODE,U.UOM_NAME, U.UOM_TYPE,CAST('' AS VARCHAR(50)) AS REMARKS  
 FROM ARTICLE A,para1 B,Para2 C, UOM U  
 WHERE 1=2  
 END      
END 