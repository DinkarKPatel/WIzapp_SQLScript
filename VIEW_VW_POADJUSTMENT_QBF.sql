CREATE VIEW VW_POADJUSTMENT_QBF     

AS        
SELECT         
MST.MEMO_DT AS 'MST_MEMO_DT',    
MST.MEMO_ID AS 'MEMO_ID',         
MST.MEMO_NO AS 'MST_MEMO_NO',   
MST.FIN_YEAR AS 'MST_FIN_YEAR',       
A.REF_NO AS 'MST_REF_NO',   
A.PO_NO AS 'MST_PO_NO',      
MST.REMARKS AS 'MST_REMARKS',                
B.AC_NAME AS 'MST_SUPPLIER_NAME',          
H.USERNAME AS 'MST_USERNAME',
B.AC_NAME AS 'MST_AC_NAME',  
A.PO_DT AS 'MST_PO_DT',     
I.PO_QTY AS INVOICE_QUANTITY,  
I.PUR_QTY,      
I.PENDING_QTY AS PENDING_QTY,  
I.ADJ_QTY AS ADJ_QUANTITY,  
I.PURCHASE_PRICE,
I.ARTICLE_NO, 
I.ARTICLE_NAME,I.PARA1_SET, I.PARA2_SET,I.UOM_CODE, I.UOM_NAME, I.UOM_TYPE,  
I.PARA1_NAME,I.PARA2_NAME,I.PARA3_NAME, I.PARA4_NAME, I.PARA5_NAME, I.PARA6_NAME,   
I.SUB_SECTION_NAME,I.SECTION_NAME,I.PRODUCT_NAME    
   
FROM PO_ADJ_MST MST (NOLOCK)  
JOIN POM01106 A (NOLOCK) ON A.PO_ID=MST.REF_PO_ID                   
JOIN LM01106 B (NOLOCK)  ON A.AC_CODE = B.AC_CODE           
JOIN USERS H (NOLOCK) ON MST.USER_CODE = H.USER_CODE        
JOIN    
(    
	SELECT  DET.MEMO_ID,   
	A.INVOICE_QUANTITY AS PO_QTY,(A.INVOICE_QUANTITY-(ISNULL(PI.PUR_QTY,0)+ISNULL(P2.ADJ_QTY,0))) AS PENDING_QTY,  
	ISNULL(PI.PUR_QTY,0) AS PUR_QTY,ISNULL(DET.ADJ_QUANTITY,0) AS ADJ_QTY,ISNULL(DET.PURCHASE_PRICE,0) AS PURCHASE_PRICE,
    B.ARTICLE_NO, B.ARTICLE_NAME, B.CODING_SCHEME,  B.PARA1_SET, B.PARA2_SET,I.UOM_CODE, I.UOM_NAME, I.UOM_TYPE,  
    C.PARA1_NAME,D.PARA2_NAME,E.PARA3_NAME, F.PARA4_NAME, G.PARA5_NAME, H.PARA6_NAME,   
    M.SUB_SECTION_NAME,N.SECTION_NAME,SKU.PRODUCT_NAME     
	FROM PO_ADJ_DET DET (NOLOCK)   
	JOIN POD01106 A (NOLOCK)ON A.ROW_ID=DET.PO_ROW_ID   
	LEFT OUTER JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE     
	LEFT OUTER JOIN PARA1 C ON A.PARA1_CODE = C.PARA1_CODE    
	LEFT OUTER JOIN PARA2 D ON A.PARA2_CODE = D.PARA2_CODE     
	LEFT OUTER JOIN PARA3 E ON A.PARA3_CODE = E.PARA3_CODE     
	LEFT OUTER JOIN PARA4 F ON A.PARA4_CODE = F.PARA4_CODE     
	LEFT OUTER JOIN PARA5 G ON A.PARA5_CODE = G.PARA5_CODE     
	LEFT OUTER JOIN PARA6 H ON A.PARA6_CODE = H.PARA6_CODE     
	LEFT OUTER JOIN UOM I ON B.UOM_CODE = I.UOM_CODE     
	LEFT OUTER JOIN POM01106 R ON R.PO_ID= A.PO_ID     
	LEFT OUTER JOIN SECTIOND M ON B.SUB_SECTION_CODE = M.SUB_SECTION_CODE   
	LEFT OUTER JOIN SECTIONM N ON M.SECTION_CODE = N.SECTION_CODE   
    LEFT OUTER JOIN SKU ON SKU.PRODUCT_CODE=A.PRODUCT_CODE      
	LEFT OUTER JOIN     
	(    
	SELECT PO_ROW_ID,SUM(INVOICE_QUANTITY) AS PUR_QTY,SUM(SCHEME_QUANTITY) AS FOC_QTY FROM    
	PID01106 A JOIN PIM01106 B ON A.MRR_ID=B.MRR_ID    
	WHERE CANCELLED=0     
	GROUP BY PO_ROW_ID    

	) PI ON DET.PO_ROW_ID = PI.PO_ROW_ID    

	LEFT OUTER JOIN     
	(    
	SELECT PO_ROW_ID,SUM(ADJ_QUANTITY) AS ADJ_QTY  FROM    
	PO_ADJ_DET A JOIN PO_ADJ_MST B ON A.MEMO_ID=B.MEMO_ID      
	GROUP BY PO_ROW_ID    
  
 ) P2 ON A.ROW_ID = P2.PO_ROW_ID     
     
)I ON MST.MEMO_ID = I.MEMO_ID
