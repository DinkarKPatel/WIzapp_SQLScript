CREATE PROCEDURE SPDB_ANNUAL_TARGET
(
 @FINYEAR VARCHAR(10)
)
AS
BEGIN
DECLARE @CHEADCODE VARCHAR(4000) 
SET @CHEADCODE=DBO.FN_ACT_TRAVTREE('0000000021') 

INSERT DB_ANNUAL_PURCHASE_TARGET (FIN_YEAR, AC_NAME, AREA_NAME, CITY, STATE, ANNUAL_TARGET, PURCHASE_AMOUNT)
SELECT B.FIN_YEAR,A.AC_NAME,A.AREA_NAME ,A.CITY ,A.STATE,
MAX(ISNULL(B.ANNUL_TARGET,0)) AS ANNUL_TARGET,(ISNULL(SUM(X.PUR),0)-ISNULL(SUM(PRT),0)) AS PURCHASE_AMOUNT
FROM LMV01106 A (NOLOCK) 
JOIN SUPPLIER_ANNUAL_TARGET B (NOLOCK) ON A.AC_CODE= B.AC_CODE  AND B.FIN_YEAR = @FINYEAR
LEFT OUTER JOIN
(
 SELECT AC_CODE ,SUM(SUBTOTAL-DISCOUNT_AMOUNT) AS PUR
 FROM PIM01106  (NOLOCK) WHERE INV_MODE =1 AND CANCELLED =0 AND FIN_YEAR = @FINYEAR
 GROUP BY AC_CODE
) X  ON X.AC_CODE= B.AC_CODE 

LEFT OUTER JOIN
(
 SELECT AC_CODE ,SUM( CASE WHEN DN_TYPE <> 2 THEN SUBTOTAL-DISCOUNT_AMOUNT  ELSE TOTAL_AMOUNT END) AS PRT
 FROM RMM01106 (NOLOCK)  WHERE MEMO_TYPE =1 AND CANCELLED =0 AND FIN_YEAR = @FINYEAR
 GROUP BY AC_CODE
) Y ON Y.AC_CODE= B.AC_CODE 
WHERE  A.AC_NAME <> ''  AND CHARINDEX(HEAD_CODE,@CHEADCODE)>0  AND ISNULL(INACTIVE,0)=0 AND ISNULL(B.ANNUL_TARGET,0)>0  
GROUP BY  B.ROW_ID,B.FIN_YEAR,B.LAST_UPDATE,A.AC_CODE, A.AC_NAME,A.AREA_NAME ,A.CITY ,A.STATE--,E.DN_TYPE  
ORDER BY AC_NAME

END
