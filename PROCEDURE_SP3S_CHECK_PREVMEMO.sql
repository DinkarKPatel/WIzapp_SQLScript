CREATE PROCEDURE SP3S_CHECK_PREVMEMO--(LocId 3 digit change by Sanjay:06-11-2024)
@CFINYEAR VARCHAR(5),
@CMEMONO VARCHAR(50),
@CLOCATIONID VARCHAR(4),
@CERRORMSG VARCHAR(MAX) OUTPUT
AS
BEGIN

	PRINT 'CHECK SERIES-1:'+isnull(@cMemoNo,'null memo no')
	DECLARE @CFIRSTMEMONO VARCHAR(20),@CMEMOPREFIX VARCHAR(10),@NLENVALUE NUMERIC(4,0),@CMEMONOLEN VARCHAR(4),
	@NMEMONOLEN NUMERIC(2,0),@NPREVMEMONO NUMERIC(12,0),@CPREVMEMONO VARCHAR(15),@CPREVMEMONOSEARCH VARCHAR(15)
	
	--SELECT @CMEMONO AS CMEMONOVAL
	SET @CERRORMSG=''

	SELECT TOP 1 @CMEMONOLEN=VALUE FROM CONFIG WHERE CONFIG_OPTION='SLS_MEMO_LEN'
	
	IF ISNULL(@CMEMONOLEN,'')<>''
		SET @NMEMONOLEN=CONVERT(INT,@CMEMONOLEN)
	ELSE
		SET @NMEMONOLEN=10

	IF @cFinyear>='01121'
		set @nMemonolen=10+len(@cLocationId)
		
	PRINT 'CHECK SERIES-2'	
	IF CHARINDEX('-',@CMEMONO,1)=0
       SET @CMEMOPREFIX=@CLOCATIONID
    ELSE   					   
	   SET @CMEMOPREFIX=LEFT(@CMEMONO,CHARINDEX('-',@CMEMONO,1))
	
	PRINT 'CHECK SERIES-2.2'	
	SET @NLENVALUE=@NMEMONOLEN-LEN(@CMEMOPREFIX)

	
	PRINT 'CHECK SERIES-2.5:'+@CMEMOPREFIX+':'+@CMEMONO	   
	SET @NPREVMEMONO=CONVERT(NUMERIC(12,0),REPLACE(@CMEMONO,@CMEMOPREFIX,''))
	
	PRINT 'CHECK SERIES-3'

		
	IF @NPREVMEMONO>1
	BEGIN
		SET @NPREVMEMONO=@NPREVMEMONO-1

		SELECT @CFIRSTMEMONO=MIN(CM_NO) 
		FROM CMM01106 A (NOLOCK)
		JOIN CMD01106 B (NOLOCK) ON A.CM_ID=B.CM_ID 
		WHERE a.location_Code=@CLOCATIONID
		AND A.FIN_YEAR=@CFINYEAR AND LEFT(@CMEMONO,LEN(@CMEMOPREFIX))=@CMEMOPREFIX 
		AND LEN(CM_NO)=LEN(@CMEMONO)
		AND LEFT(A.CM_NO,len(@CMEMOPREFIX))=LEFT(@CMEMONO,LEN(@CMEMOPREFIX))
		
	
		SET @CPREVMEMONO=@CMEMOPREFIX+REPLICATE('0',@NLENVALUE-LEN(LTRIM(RTRIM(STR(@NPREVMEMONO)))))+LTRIM(RTRIM(STR(@NPREVMEMONO)))
        
		
		DECLARE @bCheckedOther BIT
		set @bCheckedOther=0

		DECLARE @cOldPrev VARCHAR(50)
lblChkAgain:		
		SET @CPREVMEMONOSEARCH=''
		
		
		PRINT 'CHECK SERIES-5'
		SELECT TOP 1 @CPREVMEMONOSEARCH=CM_NO 
		FROM CMM01106 WITH (INDEX(UNQ_CMM01106_CM_NO),NOLOCK) WHERE CM_NO=@CPREVMEMONO AND FIN_YEAR=@CFINYEAR

		IF @cOldPrev IS NULL
			SET @cOldPrev=@CPREVMEMONO
			
		IF ISNULL(@CPREVMEMONOSEARCH,'')='' AND @CMEMONO<>ISNULL(@CFIRSTMEMONO,'') AND ISNULL(@CFIRSTMEMONO,'')<>''
		BEGIN
			
			IF @NMEMONOLEN>=12 AND @bCheckedOther=0
			BEGIN
				SELECT @CPREVMEMONO=REPLACE(@cPrevmemono,'-00','-'),@CERRORMSG='',@bCheckedOther=1
				GOTO lblChkAgain
			END
		
			PRINT 'CHECK SERIES-6'
			SET @CERRORMSG='(S)PREVIOUS MEMO NO. :'+@cOldPrev+' Fin Year:('+@CFINYEAR+') NOT FOUND...CANNOT SAVE'
			
		END	
	END
END