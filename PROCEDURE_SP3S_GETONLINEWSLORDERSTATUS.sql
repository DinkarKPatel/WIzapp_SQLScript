CREATE PROC SP3S_GETONLINEWSLORDERSTATUS
(
@cRefNo varchar(100)
)

As
Begin

SELECT A.Ref_no,A.ORDER_NO,A.ORDER_ID,CONVERT(VARCHAR,ORDER_DT,105) AS ORDER_DT,LM.AC_NAME,		
CANCELLED=CASE WHEN A.CANCELLED=0 THEN '' ELSE 'CANCELLED' END,
STATUS=CASE WHEN A.CANCELLED=0 THEN CASE WHEN  ISNULL(CNT_PL_ORDER_ID,0)+ISNULL(WSL_QTY,0)+ISNULL(PS_QTY,0)=0 THEN 'PENDING'
WHEN  ISNULL(CNT_PL_ORDER_ID,0)+ISNULL(WSL_QTY,0)+ISNULL(PS_QTY,0)< SUM(B.QUANTITY)  AND ISNULL(CNT_PL_ORDER_ID,0)+ISNULL(WSL_QTY,0)+ISNULL(PS_QTY,0)>0   THEN 'PARTIAL-SETTELED'
ELSE 'COMPLETED' END  ELSE '' END		
FROM BUYER_ORDER_MST A (NOLOCK) 
JOIN BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID
LEFT JOIN
(
SELECT ORDER_ID,SUM(PL.PICK_LIST_QTY) AS CNT_PL_ORDER_ID FROM WSL_PICKLIST_DET PL (NOLOCK)
JOIN WSL_PICKLIST_MST PM (NOLOCK) ON PL.PICK_LIST_ID=PM.PICK_LIST_ID
WHERE PM.CANCELLED=0
GROUP BY ORDER_ID
) PL ON PL.ORDER_ID=A.ORDER_ID
LEFT OUTER JOIN
(
SELECT A.ORDER_ID,SUM(QUANTITY) AS WSL_QTY FROM IND01106 A
JOIN INM01106 B ON A.INV_ID=B.INV_ID
WHERE B.CANCELLED=0
GROUP BY A.ORDER_ID
) IND ON IND.ORDER_ID=A.ORDER_ID
LEFT OUTER JOIN
(
SELECT B.ORDER_ID,SUM(QUANTITY) AS PS_QTY 
FROM WPS_MST A
JOIN WPS_DET B ON A.PS_ID=B.PS_ID
WHERE A.CANCELLED=0
GROUP BY B.ORDER_ID
) WSP ON WSP.ORDER_ID=A.ORDER_ID
JOIN LMV01106 LM (NOLOCK) ON LM.AC_CODE=A.AC_CODE
Where A.Ref_no = @cRefNo	
		
GROUP BY A.Ref_no,A.ORDER_NO,A.ORDER_ID,ORDER_DT,A.CANCELLED ,
A.AC_CODE,LM.AC_NAME,LM.AREA_NAME,ISNULL(A.TOTAL_PICK_LIST_QTY,0)	
,CNT_PL_ORDER_ID,WSL_QTY,PS_QTY
		 
END


