CREATE PROC PPC_SAVETRAN_USERS  
(  
 @NUPDATEMODE NUMERIC(1,0),  --@NUPDATEMODE 1 FOR ADD,2 FOR EDIT   
 @NSPID INT,                  
 @CFINYEAR CHAR(5)='',   
 @CLOCID VARCHAR(2)='',      --@CLOCID  
 @CUSERS_CODE VARCHAR(7)=''   --@USERS CODE REQUIRED FOR EDIT MODE  
)  
------WITH ENCRYPTION  
AS  
BEGIN  
  DECLARE @CMASTERTABLENAME VARCHAR(100),  
          @CTEMPMASTERTABLE VARCHAR(100),  
          @CTEMPDBNAME VARCHAR(100),    
          @NSTEP VARCHAR(10),  
          @BENABLETEMPDB BIT,  
          @CERRORMSG VARCHAR(500),  
          @CKEYFIELD VARCHAR(22),   
          @NCKEYFIELDLEN INT,    
          @NSAVETRANLOOP BIT,  
          @CCMD NVARCHAR(MAX),  
          @CMEMODEPTID VARCHAR(2),  
          @CNEW_USERS_CODE VARCHAR(7)  
      
    DECLARE @OUTPUT TABLE(ERRMSG VARCHAR(2000),CAT_ID VARCHAR(22))  
    SET @NSTEP = 0  -- SETTTING UP ENVIRONMENT    
    
 
   SET @CTEMPDBNAME = ''   
   SET @CMASTERTABLENAME ='USERS'    
    
   SET @CTEMPMASTERTABLE  ='MST_USERS_UPLOAD'  
 
 
   SET @CKEYFIELD = 'USER_CODE'  
         SET @NCKEYFIELDLEN = 7  
         SET @NSTEP = 10  -- BEGIN TRANSACTION      
 
   BEGIN TRANSACTION  
   BEGIN TRY       
     SET @NSTEP = 30  --CALL FROM ADD MODE  
  IF @NUPDATEMODE = 1  
  BEGIN  
     SET @NSAVETRANLOOP=0  
     WHILE @NSAVETRANLOOP=0  
     BEGIN  
      --EXEC GETNEXTKEY @CMASTERTABLENAME, @CKEYFIELD, @NCKEYFIELDLEN, '01', 1,@CFINYEAR='',@NROWCOUNT=0, @CNEW_USERS_CODE OUTPUT     
      EXEC GETNEXTKEY @CMASTERTABLENAME, @CKEYFIELD, @NCKEYFIELDLEN, '', 1,@CFINYEAR,0,@CNEW_USERS_CODE OUTPUT     
      SET @CCMD= N'IF EXISTS(SELECT '+@CKEYFIELD+' FROM '+@CMASTERTABLENAME+' WHERE '+@CKEYFIELD+' = '''+@CNEW_USERS_CODE+''')  
          SET @NLOOPOUTPUT=0  
          ELSE  
          SET @NLOOPOUTPUT=1'  
      PRINT @CCMD  
      EXEC SP_EXECUTESQL @CCMD,N'@NLOOPOUTPUT BIT OUTPUT',@NLOOPOUTPUT=@NSAVETRANLOOP OUTPUT  
     END  
     SET @NSTEP = 40   
     --SET @CNEW_USERS_CODE = @CLOCID + @CFINYEAR+ REPLICATE('0', 15-LEN(LTRIM(RTRIM(@CNEW_CALL_CODE1)))) + LTRIM(RTRIM(@CNEW_CALL_CODE1))     
     IF @CNEW_USERS_CODE IS NULL    
     BEGIN  
        SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR CREATING NEXT USER CODE....'  
        GOTO END_PROC      
     END  
       
     SET @NSTEP = 60 -- UPDATING NEW ID INTO TEMP TABLES  
     SET @CCMD=N'UPDATE '+@CTEMPMASTERTABLE+' SET '+@CKEYFIELD+'='''+@CNEW_USERS_CODE+''',LAST_UPDATE=GETDATE(),MAJOR_USER_CODE='''+@CNEW_USERS_CODE+''' WHERE SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''  
     PRINT @CCMD   
     EXEC SP_EXECUTESQL @CCMD   
       
 
  END--END FROM ADD MODE  
  ELSE  
  BEGIN--CALL FROM EDIT AND CANCELLED MODE  
       SET @NSTEP = 80  -- GETTING MEMO ID FROM TEMP TABLE  
       SET @CCMD=N'SELECT @CNEW_USERS_CODE='+@CKEYFIELD+' FROM ' +@CMASTERTABLENAME+ ' WHERE USER_CODE= '''+@CUSERS_CODE+''' '   
       PRINT @CCMD  
       EXEC SP_EXECUTESQL @CCMD,N'@CNEW_USERS_CODE VARCHAR(7) OUTPUT',@CNEW_USERS_CODE OUTPUT  
         
       SET @NSTEP = 90  
       IF @CNEW_USERS_CODE IS NULL    
       BEGIN  
         
         SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR PLEASE ENTER USERS CODE FOR UPDATING....'   
         GOTO END_PROC      
         
       END  
         
       IF @NUPDATEMODE = 2  
       BEGIN  
       SET @CCMD = N'UPDATE ' + @CTEMPMASTERTABLE + ' SET LAST_UPDATE=GETDATE()  WHERE ' + @CKEYFIELD + ' = ''' + @CNEW_USERS_CODE + ''' AND SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''  
       EXEC SP_EXECUTESQL @CCMD  
      END     

          
  END  
   
 
	  SET @NSTEP = 140  
	  IF LTRIM(RTRIM(ISNULL(@CNEW_USERS_CODE,'LATER'))) = 'LATER'  
	  BEGIN  
	   SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR CREATING NEXT USERS_CODE....'  
	   GOTO END_PROC  
	  END  
	    
	  SET @NSTEP = 160  
	  
	   DECLARE @FILTER VARCHAR(MAX)
	SET @FILTER=' B.SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
		     
		 -- UPDATING MASTER TABLE FROM TEMP TABLE  
	  IF @NUPDATEMODE = 1 OR @NUPDATEMODE = 2  
	  BEGIN  
	    
		EXEC UPDATEMASTERXN   
		   @CSOURCEDB = ''  
		 , @CSOURCETABLE = @CTEMPMASTERTABLE  
		 , @CDESTDB  = ''  
		 , @CDESTTABLE = @CMASTERTABLENAME  
		 , @CKEYFIELD1 = @CKEYFIELD  
		 , @BALWAYSUPDATE = 1  
		 ,@CFILTERCONDITION=@FILTER
	       
	   
	   END
   END TRY  
   BEGIN CATCH  
    SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()  
    GOTO END_PROC  
    END CATCH  
END_PROC:  

--SELECT * FROM USERS WHERE USER_CODE ='0000010'
  IF @@TRANCOUNT>0  
  BEGIN  
   IF ISNULL(@CERRORMSG,'')=''  
    COMMIT TRANSACTION  
   ELSE  
    ROLLBACK    
  END   
  IF ISNULL(@CERRORMSG,'')=''  
  BEGIN

    DELETE FROM MST_USERS_UPLOAD WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID)))
  END
   
                  
  SELECT ISNULL(@CERRORMSG,'') AS ERRMSG,@CNEW_USERS_CODE AS USERS_CODE  
END  
--'END OF  PROCEDURE SAVETRAN_USERS'
