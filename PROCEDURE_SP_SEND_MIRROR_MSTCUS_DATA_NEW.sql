CREATE PROCEDURE SP_SEND_MIRROR_MSTCUS_DATA_NEW
(
 @CUSER_CUSTOMER_CODE VARCHAR(100),
 @CMEMOID VARCHAR(100)='',
 @CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
     DECLARE @CTEMPDBNAME VARCHAR(100),@CSTEP VARCHAR(10),@CFILTERCONDITION VARCHAR(100),@CTABLENAME VARCHAR(100),
             @CTEMPTABLE VARCHAR(100),@DTSQL NVARCHAR(MAX),@CTEMPDETAILTABLE VARCHAR(100),
             @CTEMPAREATABLE VARCHAR(100),@CTEMPCITYTABLE VARCHAR(100),@CTEMPSTATETABLE VARCHAR(100),
             @CTEMPREGIONMTABLE VARCHAR(100)
     DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),XN_ID VARCHAR(100)) 
     BEGIN TRY

     DECLARE @CTEMPDBNAME1 VARCHAR(100)
	 SET @CTEMPDBNAME1=''
	 SET @CTEMPDBNAME=''

	 
	SET @CSTEP=10
	SET @CFILTERCONDITION=''
	 
    LBLTABLEINFO:


	SET @CSTEP=40
	
	IF NOT EXISTS(SELECT TOP 1 'U' FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID' AND VALUE IN 
				  (SELECT LTRIM(RTRIM(VALUE)) FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'))
	RETURN  --CHECK IT
	
	
	
	IF ISNULL(@CMEMOID,'')<>'' AND ISNULL(@CUSER_CUSTOMER_CODE,'')=''
	GOTO LBLSETFLAG
	
	IF ISNULL(@CMEMOID,'')<>''
	BEGIN
	SET @CSTEP=60
	--1 SEND THE CASH MEMO FOR  CREDIT NOTE  MASTER TABLE
	SET @CTABLENAME ='CREDITNOTE_PENDING'
	SET @CTEMPTABLE=@CTEMPDBNAME + 'TMP_MSTCUS_'+@CTABLENAME+'_'+LTRIM(RTRIM(REPLACE(@CMEMOID,'-','_')))
	SET @DTSQL=N'SELECT DISTINCT A.CM_ID,A.CM_NO,A.CM_DT,A.CUSTOMER_CODE,NET_AMOUNT INTO '+@CTEMPTABLE+'  FROM CMM01106 A
				LEFT JOIN
				(
				  SELECT MEMO_ID,PAYMODE_CODE, AMOUNT,REF_NO ,ADJ_MEMO_ID 
				  FROM PAYMODE_XN_DET WHERE (XN_TYPE=''SLS'' OR XN_TYPE=''ARC'')
				  AND ADJ_MEMO_ID<>''''
				  
				) B ON A.CM_ID =B.ADJ_MEMO_ID 
				WHERE SUBSTRING(A.CM_NO,5,1)=''N'' 
				AND B.ADJ_MEMO_ID IS NULL
				AND A.CM_ID='''+@CMEMOID+''''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	     
	END
	
	SET @CSTEP=80
	--1 SEND THE CUSTDYM   TABLE
	SET @CTABLENAME ='CUSTDYM'
	SELECT DISTINCT  'MSTCUS_CUSTDYM_MIRROR' AS TARGET_TABLENAME,CUSTDYM.*,1 AS PICK_FROM_CURRENT_DB FROM CUSTDYM (NOLOCK)
	 WHERE USER_CUSTOMER_CODE=@CUSER_CUSTOMER_CODE
	

	SET @CSTEP=90
	--1 SEND THE AREA   TABLE
	SET @CTABLENAME ='AREA'

	SELECT DISTINCT  'MSTCUS_AREA_MIRROR' AS TARGET_TABLENAME,AREA.*,1 AS PICK_FROM_CURRENT_DB FROM AREA (NOLOCK)
    join CUSTDYM (NOLOCK) on AREA.area_code=CUSTDYM.area_code
	WHERE USER_CUSTOMER_CODE=@CUSER_CUSTOMER_CODE


	
	SET @CSTEP=100
	--1 SEND THE CITY   TABLE
	SET @CTABLENAME ='CITY'

	
	SELECT DISTINCT  'MSTCUS_CITY_MIRROR' AS TARGET_TABLENAME,CITY.*,1 AS PICK_FROM_CURRENT_DB FROM CITY (NOLOCK)
	join AREA (NOLOCK) on area .city_code =city.CITY_CODE 
    join CUSTDYM (NOLOCK) on AREA.area_code=CUSTDYM.area_code
	WHERE USER_CUSTOMER_CODE=@CUSER_CUSTOMER_CODE


	SET @CSTEP=110
	--1 SEND THE CITY   TABLE
	SET @CTABLENAME ='STATE'
    
	SELECT DISTINCT  'MSTCUS_STATE_MIRROR' AS TARGET_TABLENAME,STATE.*,1 AS PICK_FROM_CURRENT_DB FROM STATE (NOLOCK)
	join CITY (NOLOCK) on city .state_code =STATE.state_code 
	join AREA (NOLOCK) on area .city_code =city.CITY_CODE 
    join CUSTDYM (NOLOCK) on AREA.area_code=CUSTDYM.area_code
	WHERE USER_CUSTOMER_CODE=@CUSER_CUSTOMER_CODE

	
	SET @CSTEP=120
	--1 SEND THE CITY   TABLE
	SET @CTABLENAME ='REGIONM'
	SELECT DISTINCT  'MSTCUS_REGIONM_MIRROR' AS TARGET_TABLENAME,REGIONM.*,1 AS PICK_FROM_CURRENT_DB FROM REGIONM (NOLOCK)
	join STATE (NOLOCK) on state.region_code =regionM .region_code 
	join CITY (NOLOCK) on city .state_code =STATE.state_code 
	join AREA (NOLOCK) on area .city_code =city.CITY_CODE 
    join CUSTDYM (NOLOCK) on AREA.area_code=CUSTDYM.area_code
	WHERE USER_CUSTOMER_CODE=@CUSER_CUSTOMER_CODE

	GOTO END_PROC
	LBLSETFLAG:

	
	
	 END TRY
BEGIN CATCH
	SET @CERRMSG='P: SP_SEND_MIRROR_MSTCUS_DATA_new, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 	
	
END_PROC:
		

    select  ISNULL(@CERRMSG,'') as errmsg
		
		
END
--- 'END OF PROCEDURE SP_SEND_MIRROR_MSTCUS_DATA'


