create PROCEDURE [DBO].[SP3S_INV_JOBCARD_ISSUE_12]          
(          
  @IMODE INT ,          
  @CWHERE VARCHAR(MAX)='',      
  @CAGENCYCODE VARCHAR(20)='',      
  @FINYEAR VARCHAR(10)=''  ,    
  @DEPTID VARCHAR(10)='' ,
  @NRETURNMODE INT=0,
  @CPRODUCT_CODE VARCHAR(50)='',
  @bitemReturn bit =0
          
)      
----WITH ENCRYPTION
AS          
          
BEGIN        
 DECLARE @CCMD NVARCHAR(MAX), @CSPID VARCHAR(50)
 
 
 SET @CSPID=@@SPID 
 

	IF iSNull( @CPRODUCT_CODE ,'')<>''
	BEGIN
	    DELETE A FROM JWI_BARCODE A (NOLOCK) WHERE SP_ID=@CSPID
		INSERT INTO jwi_barcode(product_code,sp_id)
		SELECT ISNULL( @CPRODUCT_CODE,'') ,@CSPID
	END

        
    DELETE FROM  JWI_OrderItemDetails WHERE SP_ID=@CSPID
	INSERT INTO JWI_OrderItemDetails(PRODUCT_CODE,REFROW_ID,SECTION_NAME,SUB_SECTION_NAME,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,
              PARA6_NAME,ARTICLE_NO,ARTICLE_NAME,QUANTITY,ISSUED_QTY,CHK,SUB_SECTION_CODE,SECTION_CODE,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PARA3_CODE,PARA4_CODE,
              PARA5_CODE,PARA6_CODE,JOB_CODE,JOB_NAME,MEMO_ID,WIP_UID,QUANTITY_IN_STOCK,MERCHANT_NAME,BUYER_NAME,PURCHASE_PRICE,SP_ID)

		SELECT A.PRODUCT_CODE,a.REFROW_ID,K.SECTION_NAME, J.SUB_SECTION_NAME, C.PARA1_NAME,        
		D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,B.ARTICLE_NO,         
		B.ARTICLE_NAME,
		CAST(CASE WHEN @CPRODUCT_CODE<>'' THEN  0 ELSE B1.QUANTITY_IN_STOCK END AS NUMERIC(14,2)) AS QUANTITY,
		CAST(0 AS NUMERIC(14,2)) AS ISSUED_QTY,
		CAST(CASE WHEN @CPRODUCT_CODE<>'' THEN  0 ELSE 1 END AS BIT) AS CHK
		,J.SUB_SECTION_CODE,J.SECTION_CODE,T.ARTICLE_CODE,T.PARA1_CODE,T.PARA2_CODE,T.PARA3_CODE,T.PARA4_CODE,T.PARA5_CODE,T.PARA6_CODE
		,CAST(jobs.job_code  AS VARCHAR(20)) AS JOB_CODE,CAST(jobs.job_name  AS VARCHAR(200)) AS JOB_NAME,T2.MEMO_ID
		,REFROW_ID AS WIP_UID,B1.QUANTITY_IN_STOCK,
		ISNULL(EMP.emp_name,'') AS MERCHANT_NAME,ISNULL(lm.AC_NAME,'') AS BUYER_NAME,
		isnull(b1.BOM_VALUE,0)+isnull(b1.FG_VALUE,0) as PURCHASE_PRICE,
		@CSPID AS SP_ID
		FROM ORD_PLAN_BARCODE_DET A (NOLOCK)
		JOIN jwi_barcode AA (NOLOCK) ON AA.product_code=A.PRODUCT_CODE AND AA.SP_ID=@CSPID
		JOIN ORD_PLAN_DET T1 (NOLOCK) ON  A.REFROW_ID=T1.ROW_ID
		JOIN ORD_PLAN_MST T2 (NOLOCK) ON  T1.MEMO_ID=T2.MEMO_ID 
		JOIN
		(
			 SELECT JW_PMT.PRODUCT_CODE ,JW_PMT.BIN_ID,JW_PMT.DEPT_ID,JW_PMT.JOB_CODE ,
			 BOMST.ac_code ,JW_PMT.ITEM_MERCHANT_CODE,
			 SUM(QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK,
			 isnull(JW_PMT.BOM_VALUE,0) as BOM_VALUE,
             isnull(JW_PMT.FG_VALUE,0) as FG_VALUE
			 FROM JOBWORK_PMT  JW_PMT (NOLOCK)
			 JOIN jwi_barcode AA (NOLOCK) ON AA.product_code=JW_PMT.PRODUCT_CODE AND AA.SP_ID=@CSPID
			 LEFT OUTER JOIN BUYER_ORDER_MST BOMST (NOLOCK) ON BOMST.ORDER_ID=JW_PMT.ORDER_ID
			 --where PRODUCT_CODE =@cproduct_code
			 GROUP BY JW_PMT.PRODUCT_CODE ,JW_PMT.BIN_ID,JW_PMT.DEPT_ID,JW_PMT.JOB_CODE,
			 BOMST.ac_code ,JW_PMT.ITEM_MERCHANT_CODE,
			 isnull(JW_PMT.BOM_VALUE,0),isnull(JW_PMT.FG_VALUE,0)
		) B1 ON B1.PRODUCT_CODE=A.PRODUCT_CODE AND T1.BIN_ID=B1.BIN_ID AND T2.DEPT_ID=B1.DEPT_ID 
		LEFT JOIN 
		(
		  SELECT DISTINCT  T3.JOB_ORDER AS CUR_JOB_ORDER,T3.JOB_CODE AS CUR_JOB_CODE,  T3.MEMO_ID,T3.ARTICLE_CODE  ,PJ.JOB_CODE AS PREV_JOB_CODE ,
			PJ.JOB_ORDER  AS PREV_JOB_ORDER
			FROM
			ORD_PLAN_JOB T3 (NOLOCK) 
			LEFT JOIN
			(
			  SELECT PJ.MEMO_ID,PJ.ARTICLE_CODE  ,PJ.JOB_CODE ,PJ.JOB_ORDER  
			  FROM ORD_PLAN_JOB  PJ (NOLOCK)
			) PJ ON  T3.MEMO_ID=PJ.MEMO_ID AND T3.ARTICLE_CODE=PJ.ARTICLE_CODE
			 and PJ.JOB_ORDER between CASE WHEN isnull(@BITEMRETURN,0) =0  then  T3.JOB_ORDER-1 else T3.JOB_ORDER end 
			 and CASE WHEN isnull(@BITEMRETURN,0) =0  then  T3.JOB_ORDER-1 else T3.JOB_ORDER+1 end 
			--AND T3.JOB_ORDER- CASE WHEN isnull(@BITEMRETURN,0) =0 THEN 1 ELSE -1 END =PJ.JOB_ORDER 
			AND T3.JOB_CODE=  @CAGENCYCODE  and isnull(T3.JOB_ORDER,0)>0
		
		)TMP ON TMP.MEMO_ID=T1.MEMO_ID AND TMP.ARTICLE_CODE=T1.ARTICLE_CODE 
		--JOIN WIP_PMT B1 ON B1.PRODUCT_CODE=A.PRODUCT_CODE AND T1.BIN_ID=B1.BIN_ID AND T2.DEPT_ID=B1.DEPT_ID
		JOIN SKU T (NOLOCK) ON T.PRODUCT_CODE=B1.PRODUCT_CODE
		JOIN ARTICLE B (NOLOCK) ON T.ARTICLE_CODE = B.ARTICLE_CODE         
		JOIN PARA1 C (NOLOCK) ON T.PARA1_CODE = C.PARA1_CODE        
		JOIN PARA2 D (NOLOCK) ON T.PARA2_CODE = D.PARA2_CODE        
		JOIN PARA3 E (NOLOCK) ON T.PARA3_CODE = E.PARA3_CODE        
		JOIN PARA4 F (NOLOCK) ON T.PARA4_CODE = F.PARA4_CODE        
		JOIN PARA5 G (NOLOCK) ON T.PARA5_CODE = G.PARA5_CODE        
		JOIN PARA6 H (NOLOCK) ON T.PARA6_CODE = H.PARA6_CODE        
		JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE        
		JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE        
		JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE     
		JOIN BIN  BIN (NOLOCK) ON BIN.BIN_ID=ISNULL(B1.BIN_ID,'000') 
		LEFT JOIN BUYER_ORDER_DET BD (NOLOCK) ON BD.row_id =T1 .WOD_ROW_ID 
		LEFT JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID=BD.ORDER_ID
		LEFT OUTER JOIN employee EMP (NOLOCK) ON EMP.emp_code=ISNULL(B1.ITEM_MERCHANT_CODE,BD.ITEM_MERCHANT_CODE )
		LEFT OUTER JOIN lm01106 lm (NOLOCK) ON lm.AC_Code=ISNULL(B1.ac_code,BM.AC_CODE)
		join jobs (nolock) on jobs.job_code =@CAGENCYCODE
		WHERE T2.CANCELLED=0 AND ISNULL(T2.SHORT_CLOSE,0)=0 AND  B1.QUANTITY_IN_STOCK>0
		--and a.PRODUCT_CODE =@cproduct_code 
		AND (ISNULL(T2.ENFORCE_JOB_ORDER,0) =0 OR ((ISNULL(B1.JOB_CODE,'')='' AND ISNULL(TMP.CUR_JOB_ORDER,0) =1)OR 
		( ISNULL(B1.JOB_CODE,'') =ISNULL(TMP.PREV_JOB_CODE,'') )))
		AND (ISNULL(T2.ENFORCE_JOB_ORDER,0) =0 OR CUR_JOB_CODE=@CAGENCYCODE)

		 UPDATE B SET B.JOB_RATE=A.RATE
		FROM JOB_RATE_DET A (NOLOCK)
		JOIN JWI_OrderItemDetails B (NOLOCK) ON B.ARTICLE_CODE=A.ARTICLE_CODE  AND A.JOB_CODE=B.JOB_CODE 
		where B.sp_id=@cspid
		
		--IF EXISTS (SELECT TOP 1 'U' FROM JWI_OrderItemDetails WHERE ISNULL(JOB_RATE,0)=0 and sp_id=@cspid)
		--BEGIN
		--	UPDATE X SET RATE =A.RATE
		--	FROM JOB_RATE_DET A(NOLOCK)
		--	JOIN ARTICLE B (NOLOCK) ON B.ARTICLE_CODE=A.ARTICLE_CODE
		--	JOIN JWR_MISSING_BARCODE_UPLOAD X (NOLOCK) ON X.ARTICLE_CODE=A.ARTICLE_CODE AND A.JOB_CODE=X.JOB_CODE	 
		--	WHERE --ISNULL(A.AGENCY_CODE,'')='' 	AND 
		--	ISNULL(X.RATE ,0)=0 	
		--	and x.sp_id=@csp_id
		--END

		IF EXISTS (SELECT TOP 1 'U' FROM JWI_OrderItemDetails WHERE ISNULL(JOB_RATE,0)=0 and sp_id=@cspid)
		BEGIN
			UPDATE B SET JOB_RATE =A.Job_rate
			FROM art_jobs A(NOLOCK)
			JOIN JWI_OrderItemDetails B (NOLOCK) ON B.ARTICLE_CODE=A.ARTICLE_CODE AND A.JOB_CODE=B.JOB_CODE
			WHERE ISNULL(B.JOB_RATE ,0)=0 	
			and B.sp_id=@cspid
		END


	 SELECT PRODUCT_CODE,REFROW_ID,SECTION_NAME,SUB_SECTION_NAME,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,PARA5_NAME,
              PARA6_NAME,ARTICLE_NO,ARTICLE_NAME,QUANTITY,ISSUED_QTY,CHK,SUB_SECTION_CODE,SECTION_CODE,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PARA3_CODE,PARA4_CODE,
              PARA5_CODE,PARA6_CODE,JOB_CODE,JOB_NAME,MEMO_ID,WIP_UID,QUANTITY_IN_STOCK,MERCHANT_NAME,BUYER_NAME,PURCHASE_PRICE,SP_ID ,job_rate
	 FROM JWI_OrderItemDetails 
	 where sp_id=@CSPID 




	 DELETE A FROM JWI_ORDERITEMDETAILS A (nolock) WHERE SP_ID =@CSPID
	 DELETE A FROM jwi_barcode A (nolock) WHERE SP_ID =@CSPID
	
END
