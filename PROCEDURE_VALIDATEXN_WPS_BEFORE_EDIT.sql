CREATE PROC VALIDATEXN_WPS_BEFORE_EDIT 
@CMEMOID VARCHAR(30),
@BCANCELXN BIT,
@CERRORMSG VARCHAR(200) OUTPUT,
@CEXPRERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
	DECLARE @CTEXT VARCHAR(10),@CPRODUCTCODE VARCHAR(50)
	
	SELECT @CPRODUCTCODE=''
	
	SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)
	
	IF EXISTS (SELECT TOP 1 A.PS_ID 
			   FROM WPS_MST A (NOLOCK)
			   WHERE A.PS_ID=@CMEMOID AND A.CANCELLED=1)
	BEGIN	
		SET @CERRORMSG='PACK SLIP IS ALREADY CANCELLED.........CAN NOT '+@CTEXT
		RETURN
	END
	

	IF EXISTS (SELECT TOP 1 A.INV_ID 
			   FROM INM01106 A (NOLOCK)
			   JOIN IND01106 B (NOLOCK) ON A.INV_ID=B.INV_ID 
			   JOIN WPS_MST C (NOLOCK) ON C.PS_ID=B.PS_ID
			   WHERE C.PS_ID=@CMEMOID AND A.CANCELLED=0 AND C.CANCELLED=0)
	BEGIN	
		SET @CERRORMSG='(1)ONE OR MORE REFERENCES OF THIS MEMO IS FOUND INTO WHOLESALE INVOICE.........CAN NOT '+@CTEXT
		RETURN
	END

	IF EXISTS (SELECT TOP 1 A.WSL_INV_ID 
			   FROM WPS_MST A (NOLOCK)  WHERE A.PS_ID=@CMEMOID AND ISNULL(a.WSL_INV_ID,'')<>'')
	BEGIN	
		SET @CERRORMSG='(2)ONE OR MORE REFERENCES OF THIS MEMO IS FOUND INTO WHOLESALE INVOICE.........CAN NOT '+@CTEXT
		RETURN
	END

		
END
