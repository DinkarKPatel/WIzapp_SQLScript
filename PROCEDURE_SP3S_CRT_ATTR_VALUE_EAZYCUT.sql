CREATE PROCEDURE SP3S_CRT_ATTR_VALUE_EAZYCUT
WITH ENCRYPTION
AS
BEGIN
    SET NOCOUNT ON
	DECLARE @CATTRIBUTECODE VARCHAR(7), @CATTRIBUTENAME VARCHAR(50), 
			@NCTR NUMERIC(10), @CALIASC VARCHAR(10), @CALIASD VARCHAR(10),
			@CATTRCOLNAME VARCHAR(MAX), 
			@CATTRJOINSTR VARCHAR(MAX), 
			@CATTRJOINSTRGRP VARCHAR(MAX), 
			@CCMD NVARCHAR(MAX), 
			@CCMD1 NVARCHAR(MAX), 
			@CCMD2 NVARCHAR(MAX), 
			@CCREATEALTER VARCHAR(10),
			@CCMDCRTATTRGRPVIEW NVARCHAR(MAX), 
			@CCMDCRTATTRVALUE NVARCHAR(MAX),
			@CDATABASE VARCHAR(50), 
			@CVALUE VARCHAR(50), 
			@CCMDCRTRFVIEW NVARCHAR(MAX),
			@CCMDALIAS NVARCHAR(MAX), 
			@CATTRCOLNAMEALIAS VARCHAR(MAX), 
			@CCMDCRTATTRALIASVALUE NVARCHAR(MAX),
			@CATTREXPR VARCHAR(MAX),@nAttrMode INT

	DECLARE ABC CURSOR FOR
	SELECT ATTRIBUTE_CODE, ATTRIBUTE_NAME,isnull(attribute_mode,0) as attribute_mode FROM ATTRM WHERE ATTRIBUTE_TYPE = 1 AND attribute_code<>'0000000'
	AND attribute_name<>''

	SET @NCTR = 1
	SET @CCMD = N''
	SET @CCMD1= N''
	SET @CCMD2= N''
	SET @CCMDALIAS = N''
	
	OPEN ABC
	FETCH NEXT FROM ABC INTO @CATTRIBUTECODE, @CATTRIBUTENAME ,@nAttrMode 
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @CALIASC	= 'C' + CONVERT(VARCHAR(10), @NCTR)
		SET @CALIASD	= 'D' + CONVERT(VARCHAR(10), @NCTR)

		SET @CCMD = @CCMD + 
					(CASE WHEN @CCMD<>'' THEN ', '+CHAR(13) ELSE '' END) +
						N'(CASE WHEN  '+ @CALIASC + '.ATTRIBUTE_CODE = ''' + @CATTRIBUTECODE + ''' 
								AND '+ltrim(rtrim(str(@nAttrMode)))+'<>2							
					  THEN ISNULL('+@CALIASD+'.KEY_NAME,'''')
							    WHEN  '+ @CALIASC + '.ATTRIBUTE_CODE = ''' + @CATTRIBUTECODE + ''' 
								AND '+ltrim(rtrim(str(@nAttrMode)))+'=2							
					  THEN ISNULL('+@CALIASC+'.open_KEY_NAME,'''') ELSE '''' END) AS [' + @CATTRIBUTENAME+']'

		SET @CCMDALIAS = @CCMDALIAS + 
					(CASE WHEN @CCMDALIAS<>'' THEN ', '+CHAR(13) ELSE '' END) +
						N'(CASE WHEN  '+ @CALIASC + '.ATTRIBUTE_CODE = ''' + @CATTRIBUTECODE + '''
					  THEN '+ISNULL(@CALIASD,'')+ '.KEY_ALIAS ELSE '''' END ) AS [' + @CATTRIBUTENAME+'_ALIAS]'
					  		

		SET @CCMD1 = @CCMD1 + 
					(CASE WHEN @CCMD1<>'' THEN ' '+CHAR(13) ELSE '' END) +
					   N' LEFT OUTER JOIN ART_ATTR ' + @CALIASC + ' ON A.ARTICLE_CODE = ' 
					   + @CALIASC + '.ARTICLE_CODE AND ' + @CALIASC + '.ATTRIBUTE_CODE = ''' + @CATTRIBUTECODE + ''' 
					   LEFT OUTER JOIN ATTR_KEY ' + @CALIASD + ' ON ' + @CALIASC + '.KEY_CODE = ' + @CALIASD + '.KEY_CODE '

		SET @CCMD2 = @CCMD2 + 
					(CASE WHEN @CCMD2<>'' THEN ' '+CHAR(13) ELSE '' END) +
					 N' LEFT OUTER JOIN ART_GRP_ATTR ' + @CALIASC + ' ON A.ARTICLE_GROUP_CODE = ' + @CALIASC + 
					 '.ARTICLE_GROUP_CODE AND ' + @CALIASC + '.ATTRIBUTE_CODE = ''' + @CATTRIBUTECODE + '''
					 LEFT OUTER JOIN ATTR_KEY ' + @CALIASD + ' ON ' + @CALIASC + '.KEY_CODE = ' + @CALIASD + '.KEY_CODE '
		
		SET @NCTR = @NCTR + 1

		FETCH NEXT FROM ABC INTO @CATTRIBUTECODE, @CATTRIBUTENAME,@nAttrMode 
	END
	CLOSE ABC
	DEALLOCATE ABC
	SET @CATTRCOLNAME		= @CCMD
	SET @CATTRCOLNAMEALIAS	= @CCMDALIAS
	SET @CATTRJOINSTR		= @CCMD1
	SET @CATTRJOINSTRGRP	= @CCMD2
	
	
	
	--********* CREATE VIEW ATTR_VALUE
	PRINT 'CREATING VIEW ATTR_VALUE_EAZYCUT...'

	SET @CCREATEALTER = ''

	IF EXISTS( SELECT NAME FROM SYSOBJECTS WHERE NAME = 'ATTR_VALUE_EAZYCUT' )
		SET @CCREATEALTER = 'ALTER'
	ELSE
		SET @CCREATEALTER = 'CREATE'
	
	SET @CATTREXPR=' SELECT ' + @CATTRCOLNAME + 
				  (CASE WHEN @CATTRCOLNAME<>'' THEN ', ' ELSE '' END) + 
				  '' + @CATTRCOLNAMEALIAS + 
				  (CASE WHEN @CATTRCOLNAMEALIAS<>'' THEN ', ' ELSE '' END) + 
				  ' A.ARTICLE_CODE ' + 
				  ' FROM ARTICLE A '+ @CATTRJOINSTR

	SET @CCMDCRTATTRVALUE = @CCREATEALTER + ' VIEW ATTR_VALUE_EAZYCUT ' + CHAR(13)+
							  ' AS ' + CHAR(13)+ @CATTREXPR
	
	--PRINT @CCMDCRTATTRVALUE
	EXEC SP_EXECUTESQL @CCMDCRTATTRVALUE
	
	DELETE FROM ATTR_VALUE_STR
	
	INSERT ATTR_VALUE_STR (COLUMNS_LIST,JOINSTR) 
	SELECT @CATTRCOLNAME,@CATTRJOINSTR
	
  SET NOCOUNT OFF
END		
--************************ END OF PROCEDURE SP_CRT_ATTR_VALUE