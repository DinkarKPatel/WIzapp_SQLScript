

--  THIS PROCEDURE UPDATES WEIGHTED AVG OF DISOCOUNT DISTRIBUTED  A LIST OF CHALLAN NUMBERS 
--  IN THE SALES DETAIL TABLE GROUPED EITHER ON SCHEME ID OR WHOLE BILL (IF SALES DISCOUNT IS DIABLED)
CREATE PROCEDURE SP_UPDATE_SLSWTDAVGDISC
@CCMID VARCHAR(40)
--WITH ENCRYPTION
AS
BEGIN
	RETURN
	---- NOW THIS PROCEDURE WON'T BE CALLED BECAUSE WEIGHTED AVG WILL BE CALCULATED AT THE TIME OF APPLYING DISCOUNTS
	DECLARE @NGROSSSALE NUMERIC(10,2),@NNETSALE NUMERIC(10,2),@CSLSDETROWID VARCHAR(40),
	@BSLSDISCOUNTDISABLED BIT,@NNETAMOUNT NUMERIC(10,2),@CCMDROWID VARCHAR(40),@NDISCAMT NUMERIC(10,2),
	@NTOTWTDDISC NUMERIC(10,2)

	
	UPDATE CMD01106 SET WEIGHTED_AVG_DISC_PCT=0,WEIGHTED_AVG_DISC_AMT=0 WHERE CM_ID=@CCMID
	
	
	IF NOT EXISTS (SELECT TOP 1 PRODUCT_CODE FROM CMD01106 WHERE CM_ID=@CCMID AND DISCOUNT_PERCENTAGE>0)
		RETURN
	
	IF CURSOR_STATUS('GLOBAL','WTDAVGDISCCUR') IN (0,1)
	BEGIN
		CLOSE WTDAVGDISCCUR
		DEALLOCATE WTDAVGDISCCUR
	END

	DECLARE WTDAVGDISCCUR CURSOR FOR 
	SELECT ROW_ID FROM SLSDET WHERE ROW_ID IN (
				SELECT A.SLSDET_ROW_ID FROM CMD01106 A	
				JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID 
				WHERE A.CM_ID=@CCMID AND B.SCHEME_ID<>'' AND A.DISCOUNT_PERCENTAGE=100)
	OPEN WTDAVGDISCCUR
	FETCH NEXT FROM WTDAVGDISCCUR INTO @CSLSDETROWID
	WHILE @@FETCH_STATUS=0
	BEGIN
		SELECT @NGROSSSALE=0,@NNETSALE=0
		
		SELECT TOP 1 @CCMDROWID=ROW_ID FROM CMD01106 WHERE CM_ID=@CCMID AND
		SLSDET_ROW_ID=@CSLSDETROWID	AND QUANTITY>0 AND DISCOUNT_PERCENTAGE=100
		
		
		SELECT @NDISCAMT=SUM(DISCOUNT_AMOUNT) FROM CMD01106 WHERE CM_ID=@CCMID AND
		SLSDET_ROW_ID=@CSLSDETROWID	AND QUANTITY>0 AND DISCOUNT_PERCENTAGE=100
		
		SELECT @NGROSSSALE=SUM(MRP*QUANTITY),@NNETSALE=SUM(RFNET),@NNETAMOUNT=SUM((MRP*QUANTITY*DISCOUNT_PERCENTAGE)/100) FROM CMD01106 WHERE CM_ID=@CCMID 
		AND SLSDET_ROW_ID=@CSLSDETROWID AND QUANTITY>0
		
		UPDATE CMD01106 SET WEIGHTED_AVG_DISC_PCT=((@NGROSSSALE-@NNETSALE)/@NGROSSSALE)*100
		WHERE CM_ID=@CCMID AND SLSDET_ROW_ID=@CSLSDETROWID AND QUANTITY>0 
		
		UPDATE CMD01106 SET WEIGHTED_AVG_DISC_AMT=(MRP*QUANTITY*WEIGHTED_AVG_DISC_PCT/100) WHERE CM_ID=@CCMID
		AND SLSDET_ROW_ID=@CSLSDETROWID AND QUANTITY>0
		
		
		SELECT @NTOTWTDDISC=SUM(WEIGHTED_AVG_DISC_AMT) FROM CMD01106 WHERE CM_ID=@CCMID	AND
		SLSDET_ROW_ID=@CSLSDETROWID AND QUANTITY>0
		
		IF ABS(@NTOTWTDDISC-@NDISCAMT)>0
		BEGIN
			PRINT 'DIF FOUND'
			UPDATE CMD01106 SET WEIGHTED_AVG_DISC_AMT=WEIGHTED_AVG_DISC_AMT+(@NDISCAMT-@NTOTWTDDISC)
			WHERE ROW_ID=@CCMDROWID
		END	
		FETCH NEXT FROM WTDAVGDISCCUR INTO @CSLSDETROWID
	END

	UPDATE CMD01106 SET WEIGHTED_AVG_DISC_AMT=
	CONVERT(NUMERIC(14,2),((MRP*QUANTITY)-((MRP*QUANTITY) * (((CMD.NET * CMM.DISCOUNT_PERCENTAGE/100)+(CMD.DISCOUNT_AMOUNT))*100)/(MRP*QUANTITY))/100))
	FROM CMD01106 CMD 
	JOIN CMM01106 CMM ON CMD.CM_ID=CMM.CM_ID
	WHERE CMM.CANCELLED=0 AND CMD.QUANTITY>0 
	AND CMM.CM_ID=@CCMID AND WEIGHTED_AVG_DISC_AMT=0


	UPDATE CMD01106 SET WEIGHTED_AVG_DISC_PCT=
	CONVERT(NUMERIC(14,2),((((CMD.NET * CMM.DISCOUNT_PERCENTAGE/100)+(CMD.DISCOUNT_AMOUNT))*100)/(MRP*QUANTITY)))
	FROM CMD01106 CMD 
	JOIN CMM01106 CMM ON CMD.CM_ID=CMM.CM_ID
	WHERE CMM.CANCELLED=0 AND CMD.QUANTITY>0 
	AND CMM.CM_ID=@CCMID AND WEIGHTED_AVG_DISC_PCT=0



	
	CLOSE WTDAVGDISCCUR
	DEALLOCATE WTDAVGDISCCUR
	
END

