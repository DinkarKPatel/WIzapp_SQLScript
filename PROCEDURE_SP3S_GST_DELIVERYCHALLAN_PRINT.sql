CREATE PROCEDURE SP3S_GST_DELIVERYCHALLAN_PRINT
(
  @CXN_TYPE VARCHAR(10)='',
  @NSPID INT=0,
  @CCURSTATE_CODE VARCHAR(2)='',
  @CPARTYSTATE_CODE VARCHAR(2)='',
  @CERRMSG VARCHAR(200) OUTPUT  
)
AS
BEGIN
      
        DECLARE @CSTEP VARCHAR(2)
		BEGIN TRY 		 
						 
				   UPDATE TMP SET HSN_CODE=CASE WHEN ISNULL(TMP.HSN_CODE,'') NOT IN ('','0000000000') THEN TMP.HSN_CODE
				                                WHEN ISNULL(SKU.HSN_CODE,'') NOT IN ('','0000000000') THEN SKU.HSN_CODE  
				                                ELSE HM.HSN_CODE END ,
				                  MRP=CASE WHEN ISNULL(TMP.MRP,0)=0 THEN SKU.MRP ELSE TMP.MRP END
				   FROM GST_TAXINFO_CALC TMP (NOLOCK)
				   JOIN SKU  (NOLOCK) SKU ON TMP.PRODUCT_CODE=SKU.PRODUCT_CODE 
				   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
				   LEFT JOIN HSN_MST  HM (NOLOCK) ON HM.HSN_CODE=ART.HSN_CODE 
				   WHERE TMP.SP_ID=LTRIM(RTRIM(STR(@NSPID))) AND ISNULL(TMP.PRODUCT_CODE,'')<>''
				   
				   UPDATE TMP SET MRP= CASE WHEN ISNULL(GST_CAL_BASIS,1)=1 THEN NET_VALUE ELSE (MRP*QUANTITY) END
				   FROM GST_TAXINFO_CALC TMP
				   JOIN HSN_MST  HM (NOLOCK) ON HM.HSN_CODE=TMP.HSN_CODE 
				   WHERE TMP.SP_ID=LTRIM(RTRIM(STR(@NSPID)))

				     --CALCULATE HSN
				  IF OBJECT_ID('TEMPDB..#TMPHSN','U') IS NOT NULL
					   DROP TABLE #TMPHSN

					;WITH CTE AS
					(
					SELECT B.HSN_CODE,ISNULL(C.TAX_PERCENTAGE,0) AS TAX_PERCENTAGE,ISNULL(C.RATE_CUTOFF,0) AS RATE_CUTOFF,
					       ISNULL(C.RATE_CUTOFF_TAX_PERCENTAGE,0) AS RATE_CUTOFF_TAX_PERCENTAGE,
					      ISNULL(C.WEF,'') AS WEF,ISNULL(B.TAXABLE_ITEM,'') AS TAXABLE_ITEM,ISNULL(B.HSN_TYPE ,'') AS HSN_TYPE  ,
						  SR=ROW_NUMBER() OVER (PARTITION BY A.ROW_ID ORDER BY C.WEF DESC)
					FROM GST_TAXINFO_CALC A (NOLOCK)
					JOIN HSN_MST B (NOLOCK) ON A.HSN_CODE =B.HSN_CODE 
					LEFT JOIN HSN_DET C (NOLOCK) ON B.HSN_CODE =C.HSN_CODE AND C.WEF  <=MEMO_DT 
					WHERE A.SP_ID =LTRIM(RTRIM(STR(@NSPID)))  
					)

				   SELECT * INTO #TMPHSN FROM CTE WHERE SR=1    

                   UPDATE TMP SET  NET_VALUE_WOTAX= ROUND(MRP-(MRP*(CASE WHEN TAX_METHOD=2 THEN (HM.RATE_CUTOFF_TAX_PERCENTAGE/  
												   (100 + HM.RATE_CUTOFF_TAX_PERCENTAGE)) ELSE 0 END)),2)
				   FROM GST_TAXINFO_CALC TMP (NOLOCK)
				   JOIN #TMPHSN HM (NOLOCK) ON HM.HSN_CODE=TMP.HSN_CODE 
				   WHERE TMP.SP_ID=LTRIM(RTRIM(STR(@NSPID))) 
				    
					   
                   UPDATE TMP SET GST_PERCENTAGE=ISNULL(CASE WHEN HM.RATE_CUTOFF<ABS(TMP.NET_VALUE_WOTAX)/ABS(TMP.QUANTITY) THEN HM.TAX_PERCENTAGE ELSE RATE_CUTOFF_TAX_PERCENTAGE END ,0),
				   IGST_AMOUNT=0,
				   SGST_AMOUNT=0
				   FROM GST_TAXINFO_CALC TMP (NOLOCK)
				   JOIN #TMPHSN HM (NOLOCK) ON HM.HSN_CODE=TMP.HSN_CODE 
				   WHERE TMP.SP_ID=LTRIM(RTRIM(STR(@NSPID))) 
	           
	               SET @CSTEP=50

				
				UPDATE TMP SET XN_VALUE_WITHOUT_GST =ROUND(NET_VALUE-(NET_VALUE*(CASE WHEN TAX_METHOD=2 THEN ((ISNULL(TMP.GST_PERCENTAGE,0))/  
				(100 + ISNULL(TMP.GST_PERCENTAGE,0))) ELSE 0 END)),2)
				FROM GST_TAXINFO_CALC TMP
				WHERE TMP.SP_ID=LTRIM(RTRIM(STR(@NSPID)))
				
  
                SET @CSTEP=70  
                UPDATE TMP SET XN_VALUE_WITH_GST = ROUND(NET_VALUE+(NET_VALUE*(CASE WHEN TAX_METHOD=2 THEN 0 
                ELSE ((ISNULL(TMP.GST_PERCENTAGE,0))/100) END)) ,2)	  
				FROM GST_TAXINFO_CALC TMP (NOLOCK)
				WHERE TMP.SP_ID=LTRIM(RTRIM(STR(@NSPID))) 
				  
			    SET @CSTEP=80 
               
                UPDATE TMP SET IGST_AMOUNT =ROUND(CASE WHEN @CCURSTATE_CODE<>@CPARTYSTATE_CODE THEN 
                NET_VALUE*(CASE WHEN TAX_METHOD=2 THEN (TMP.GST_PERCENTAGE/  
		        (100 + TMP.GST_PERCENTAGE)) ELSE (TMP.GST_PERCENTAGE/100) END)
				ELSE 0 END,2) ,
				CGST_AMOUNT=ROUND((CASE WHEN @CCURSTATE_CODE<>@CPARTYSTATE_CODE THEN 0
				ELSE NET_VALUE*(CASE WHEN TAX_METHOD=2 THEN (TMP.GST_PERCENTAGE/  
				(100 + TMP.GST_PERCENTAGE)) ELSE (TMP.GST_PERCENTAGE/100) END) 
				 END)/2,2),
				SGST_AMOUNT=ROUND((CASE WHEN @CCURSTATE_CODE<>@CPARTYSTATE_CODE THEN 0
				ELSE NET_VALUE*(CASE WHEN TAX_METHOD=2 THEN (TMP.GST_PERCENTAGE/  
				(100 + TMP.GST_PERCENTAGE)) ELSE (TMP.GST_PERCENTAGE/100) END) 
				END)/2,2)
				FROM GST_TAXINFO_CALC TMP (NOLOCK)
				WHERE TMP.SP_ID=LTRIM(RTRIM(STR(@NSPID)))
				
       
      
    
  END TRY  
  BEGIN CATCH  
   SELECT @CERRMSG='ERROR MESSAGE IN PROCEDURE SP3S_GST_DELIVERYCHALLAN_PRINT STEP#'+@CSTEP+' '+CAST(ERROR_MESSAGE() AS VARCHAR(MAX))+ '||'+ERROR_PROCEDURE()  
   PRINT 'ENTER CATCH IN SP3S_GST_TAX_CAL'
  END CATCH  
  
END
