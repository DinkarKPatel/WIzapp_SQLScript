
create Proc SP3S_GETSALEDATA_FORMALL
(
 @cStoreCode Varchar(10),
 @cFromDt Varchar(10),
 @cToDt Varchar (10)
)

As
Begin
       
       	-- AS DISCUSS WITH SANJIV SIRTHIS CUSTOMER pROCEDURE CALL FOR KIASSA APPLY BIN FILTER
     IF OBJECT_ID ('SP3S_GETSALEDATA_FORMALL_CUSTOM','p') IS NOT NULL
	 BEGIN
	    EXEC SP3S_GETSALEDATA_FORMALL_CUSTOM
		     @cStoreCode=@cStoreCode,
			 @cFromDt=@cFromDt,
			 @cToDt=@cToDt
	    RETURN 
	 END

	 
	  DECLARE @DTSQL NVARCHAR(MAX),@TaxableAmount varchar(100)
	  set @TaxableAmount=''

	  IF EXISTS (SELECT TOP 1 'U' FROM CONFIG (nolock) WHERE CONFIG_OPTION ='TAXABLE_AMOUNT_IN_MALL_MANAGEMENT' AND VALUE ='1')
	   set @TaxableAmount='b.TAXABLE_AMOUNT as [TAXABLE AMOUNT],'
       
      SET @DTSQL =N'SELECT   CM_NO  AS [RECEIPT NUMBER],CONVERT( VARCHAR(10),CM_DT, 112)  AS [RECEIPT DATE], CONVERT( VARCHAR(5),CM_TIME, 108) AS  [TRANSACTION TIME],
		B.MRP AS [INVOICE AMOUNT],ISNULL(B.DISCOUNT_AMOUNT,0 )+ISNULL(A.DISCOUNT_AMOUNT,0)  AS [DISCOUNT AMOUNT],'+
		@TaxableAmount
		+'B.GST_AMOUNT AS [TAX AMOUNT],
		NET_AMOUNT AS [NET SALE], [CASH],[CREDIT CARDS],[OTHERS],
		case when NET_AMOUNT >0 then   ''Sale'' else ''Return'' end  AS [TRANSACTION STATUS]
		FROM CMM01106 A (NOLOCK)
		JOIN 
		(
		  SELECT CM_ID ,SUM(MRP)  AS MRP,
		          SUM(DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT,
		          SUM(ISNULL(A.xn_value_without_gst ,0)) AS TAXABLE_AMOUNT,
				  SUM((ISNULL(A.IGST_AMOUNT,0))+(ISNULL(A.CGST_AMOUNT,0))+(ISNULL(A.SGST_AMOUNT,0))) AS GST_AMOUNT
		  FROM CMD01106  A(NOLOCK)
		  GROUP BY CM_ID
		) B ON A.CM_ID=B.CM_ID 
		join
		(
		   
					SELECT A.MEMO_ID ,
					      SUM(CASE WHEN A.PAYMODE_CODE =''0000000'' THEN AMOUNT ELSE 0 END) AS [CASH],
					      SUM(CASE WHEN PAYMODE_GRP_CODE =''0000002'' THEN AMOUNT ELSE 0 END) AS [CREDIT CARDS],
						  SUM(CASE WHEN (A.PAYMODE_CODE =''0000000'' OR PAYMODE_GRP_CODE =''0000002'') THEN 0 ELSE AMOUNT END) AS [OTHERS]
					FROM PAYMODE_XN_DET A
					JOIN PAYMODE_MST B ON A.PAYMODE_CODE=B.PAYMODE_CODE
					WHERE XN_TYPE=''SLS''
					GROUP BY MEMO_ID

		) pay on pay.memo_id =a.cm_id 
		WHERE   CM_DT BETWEEN   '''+convert(varchar(10),@CFROMDT,121)+'''  AND   '''+convert(varchar(10),@CTODT ,121)+'''  
		AND ( A.location_Code = '''+ @CSTORECODE+''' OR  '''+ @CSTORECODE+'''='''')'
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL
End

