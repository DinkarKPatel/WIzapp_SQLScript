CREATE PROCEDURE SP3S_GEN_LUCKYDRAW_COUPONS(@CM_ID VARCHAR(40))
AS 
BEGIN
	SET NOCOUNT ON
	DECLARE @BILL_VAL FLOAT,@FILTER FLOAT,@CNT INT,@CTR INT=1
	IF OBJECT_ID('TEMPDB..#LUCKY_DRAW','U') IS NOT NULL
	   DROP TABLE #LUCKY_DRAW
	CREATE TABLE #LUCKY_DRAW(COUPONS VARCHAR(50))  
	SELECT @CM_ID=RTRIM(CM_NO), @BILL_VAL=ISNULL(NET_AMOUNT,0), @FILTER=ISNULL(DRAW.APPLICABLE_AMOUNT,0)
	FROM CMM01106 CMM(NOLOCK), LUCKY_DRAW_LOC LOC, LUCKY_DRAW_SETUP DRAW
	WHERE CMM.CM_ID=@CM_ID 
	AND CMM.CM_DT BETWEEN DRAW.APPLICABLE_FROM_DT AND DRAW.APPLICABLE_TO_DT
	AND CMM.NET_AMOUNT>=DRAW.APPLICABLE_AMOUNT 
	AND LEFT(CMM.CM_ID,2)=LOC.DEPT_ID
	SET @CNT=ISNULL(@BILL_VAL/@FILTER,0)
	WHILE @CTR<=@CNT
	  BEGIN
	    INSERT #LUCKY_DRAW SELECT @CM_ID+'/'+CAST(@CTR AS VARCHAR)
		SET @CTR+=1
	  END
	SELECT * FROM #LUCKY_DRAW
	SET NOCOUNT OFF
END
