CREATE PROC SP_WSLCRNOTE_FILTER    --(LocId 3 digit change by Sanjay:04-11-2024)
(    
 @NINV_MODE NUMERIC(1)= 0,---MODE    
 @DFROMDATE DATETIME='',--CN_DT    
 @DTODATE DATETIME= '',--CN_DT    
 @TAX_METHOD NUMERIC(1)=0,--BILL_LEVEL_TAX_METHOD    
 @TAX_TYPE NUMERIC(1)=0,--TAXFORM_STORAGE_MODE    
 @CAC_CODE VARCHAR(100)= '',--AC_CODE    
 @CFORM_ID VARCHAR(100)= '',--ITEM_FORM_ID --CND01106    
 @CDEPT_ID VARCHAR(100)= '',--PARTY_DEPT_ID    
 @CAC_BRK_ID VARCHAR(100)='',--BROKER_AC_CODE    
 @CSALESPERSON VARCHAR(100)='',--EMP_CODE    
 @DRECFROMDATE DATETIME='',--RECEIPT_DTMN     
 @DRECTODATE DATETIME='',--RECEIPT_DT    
 @DCNFROMDATE DATETIME='',--CN_DT    
 @DCNTODATE DATETIME='',--CN_DT    
 @NCANCELLED NUMERIC(1)=2,--CANCELLED    
 @LOC VARCHAR(4)=''  ,
 @NITEM_TYPE NUMERIC(1)=0,
 @NBILL_LEVEL_DISC_METHOD NUMERIC(1)=0,
 @NPAYMENT_MODE NUMERIC(1)=0,
 @BESTIMATE NUMERIC(1)=1  ,
 @NAC_STATUS NUMERIC(1) =0,      /* @NAC_STATUS:0 FOR ALL,1 FOR PENDING, 2 FOR UPDATE*/      
 @cnTtype  NUMERIC(1)= 0---Cn_Type Regular -1 Financial -2 0 - All   
)    
AS    
BEGIN     
 IF OBJECT_ID('TEMPDB..#FILTER_CNM','U') IS NOT NULL    
  DROP TABLE #FILTER_CNM    
     
	 
	 
 SELECT DISTINCT INM.CN_ID     
 INTO #FILTER_CNM    
 FROM CNM01106 INM(NOLOCK)    
 WHERE  INM.CN_DT BETWEEN  @DFROMDATE AND @DTODATE       
 --AND IND.EMP_CODE = CASE WHEN @CSALESPERSON='' THEN IND.EMP_CODE ELSE @CSALESPERSON END    
     
 --IF OBJECT_ID('TEMPDB..#FILTER_CNM1','U') IS NOT NULL    
 -- DROP TABLE #FILTER_CNM1    
     
 --SELECT CN_ID,EMP_CODE INTO #FILTER_CNM1 FROM #FILTER_CNM    
 --WHERE  EMP_CODE = (CASE WHEN @CSALESPERSON='' THEN EMP_CODE ELSE @CSALESPERSON END)    
     
 --;WITH CTE AS    
 --(    
 --  SELECT CN_ID,EMP_CODE,ROW_NUMBER() OVER(PARTITION BY CN_ID ORDER BY EMP_CODE) AS SLNO FROM #FILTER_CNM1    
 --)    
 --DELETE FROM CTE WHERE SLNO > 1    
     
    SELECT DISTINCT  T1.CN_DT AS  MEMO_DT ,  CONVERT(VARCHAR,T1.CN_DT,106) AS MEMO_DT_OLD    
     ,(CASE WHEN ISNULL(RECEIPT_DT,'')='' AND MODE=2 THEN '' ELSE CONVERT(VARCHAR,T1.RECEIPT_DT,106) END)AS RECEIPT_DT,    
    
           --CONVERT(VARCHAR,T1.RECEIPT_DT,105) AS RECEIPT_DT ,     
     T1.CN_ID AS MEMO_ID,T1.CN_NO AS MEMO_NO,     
     T3.AC_NAME AS CUSTOMER_NAME,    
     T1.DISCOUNT_PERCENTAGE AS DISCOUNT_PERCENTAGE ,     
     (CASE WHEN T1.CANCELLED = 0 THEN T1.DISCOUNT_AMOUNT ELSE 0 END) AS DISCOUNT_AMOUNT ,        
     (CASE WHEN T1.CANCELLED = 0 THEN T1.FREIGHT ELSE 0 END) AS FREIGHT,        
     (CASE WHEN T1.CANCELLED = 0 THEN T1.OTHER_CHARGES ELSE 0 END) AS OTHER_CHARGES,     
     (CASE WHEN T1.CANCELLED = 0 THEN T1.TOTAL_AMOUNT ELSE 0 END) AS NET_RETURN_VALUE,       
     T1.ROUND_OFF,T1.REMARKS , T1.MANUAL_INV_NO,   
      ISNULL(F.AC_NAME,'') AS BROKER_AC_NAME  ,    
     (CASE WHEN T1.CANCELLED = 1 THEN 0 ELSE ISNULL(T1.TOTAL_QUANTITY,0) END) AS TOTAL_QUANTITY,    
      (CASE WHEN T1.CANCELLED = 1 THEN '' ELSE ISNULL(T1.TOTAL_QUANTITY_STR,0) END) AS TOTAL_QUANTITY_STR,    
     (CASE WHEN T1.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END) AS CANCELLED
     ,u.username as USERNAME
     ,u1.username as EDT_USERNAME ,  T1.Total_Gst_Amount,
   T1.SUBTOTAL      , (CASE   WHEN ISNULL(PVL.MEMO_ID,'')<> '' THEN 'POSTED' ELSE 'PENDING'  END)  AS AC_POSTED   ,
    t1.Total_Gst_Cess_Amount   
	,ISNULL(EINV_IRN_NO,'') AS EINV_IRN_NO 
	,(CASE WHEN T1.mode=2 THEN ISNULL(L1.loc_gst_no,'') ELSE ISNULL(T3.Ac_gst_no,'') END) AS [PARTY_GST_NO] 
     --18 NOV 2017    
    ,CAST((CASE WHEN T1.XN_ITEM_TYPE  IN (1,4) THEN ISNULL(L.Enable_EInvoice,0) ELSE 0 END) AS BIT) AS Enable_EInvoice,ISNULL(L.loc_gst_no,'') AS loc_gst_no
	,T3.DISCOUNT_PERCENTAGE AS CD_PERCENTAGE,T1.ACH_NO,T1.ACH_DT,T1.EINV_IRN_NO,t1.chi_entry_ref_no,T1.manual_dn_no,T1.manual_dn_amount
	,(CASE WHEN ISNULL(T1.manual_dn_no,'')<>'' THEN CONVERT(VARCHAR(20),T1.manual_dn_dt,105) ELSE CAST('' AS VARCHAR(20)) END) AS manual_dn_dt
 FROM CNM01106 T1 (NOLOCK)    
 JOIN #FILTER_CNM FT1 (NOLOCK) ON T1.CN_ID=FT1.CN_ID           
 JOIN LMV01106 T3 (NOLOCK) ON T3.AC_CODE = T1.AC_CODE        
 LEFT JOIN LM01106 F(NOLOCK) ON T1.BROKER_AC_CODE= F.AC_CODE  
 LEFT JOIN users U (NOLOCK) ON T1.USER_CODE=U.user_code       --ADDED BY CHANDAN ON 29-06-2019
 LEFT OUTER JOIN COMPANY COM ON 1=1 AND COM.COMPANY_CODE='01'        
 LEFT OUTER JOIN LOCATION L (NOLOCK) ON T1.location_code = L.DEPT_ID  
 LEFT OUTER JOIN LOCATION L1 (NOLOCK) ON T1.party_dept_id = L1.DEPT_ID  
 LEFT OUTER JOIN users u1 (NOLOCK) ON T1.EDT_USER_CODE=u1.user_code 
 --LEFT OUTER JOIN POSTACT_VOUCHER_LINK PVL (NOLOCK) ON PVL.MEMO_ID=T1.CN_ID AND PVL.XN_TYPE='WSR'    
 LEFT OUTER JOIN
 (        
       SELECT PVL.MEMO_ID     
       FROM VM01106 a (NOLOCK)  
	   join POSTACT_VOUCHER_LINK PVL (nolock) on a.VM_ID =PVL.vm_id 
       WHERE a.CANCELLED=0  AND PVL.XN_TYPE IN ('WSR'     ,'WSRCHI')
	   group by  PVL.MEMO_ID 
  ) PVL ON PVL.MEMO_ID=T1.CN_ID           
   -- LEFT OUTER JOIN FORM F ON T2.ITEM_FORM_ID = F.FORM_ID    
     
 WHERE (ISNULL(@NINV_MODE, 0)= 0 OR (T1.MODE=@NINV_MODE))     
     --AND (T1.CN_DT BETWEEN @DFROMDATE AND @DTODATE)    
     --AND (@TAX_METHOD=0 OR T1.BILL_LEVEL_TAX_METHOD=@TAX_METHOD)     
     AND (@TAX_TYPE=0 OR T1.TAXFORM_STORAGE_MODE=@TAX_TYPE)     
     AND (ISNULL(@CAC_CODE,'')='' OR T1.AC_CODE=@CAC_CODE)    
	 AND (ISNULL(@lOC,'')='' OR T1.location_Code=@LOC)    
     AND (ISNULL(@CDEPT_ID,'')='' OR T1.PARTY_DEPT_ID=@CDEPT_ID)    
     AND (ISNULL(@CAC_BRK_ID,'')='' OR T1.BROKER_AC_CODE=@CAC_BRK_ID)     
     AND (ISNULL(@DRECFROMDATE,'')='' OR T1.RECEIPT_DT BETWEEN @DRECFROMDATE AND @DRECTODATE)    
     AND (ISNULL(@DCNFROMDATE,'')='' OR T1.CN_DT BETWEEN @DCNFROMDATE AND @DCNTODATE)   
	 AND (@NCANCELLED=2 OR T1.CANCELLED = CAST(@NCANCELLED as BIT))  	    
     AND (@NITEM_TYPE=0 OR T1.XN_ITEM_TYPE=@NITEM_TYPE)   
	 AND (@NPAYMENT_MODE    =0 OR T1.pay_mode=@NPAYMENT_MODE)
	 AND (ISNULL(@BESTIMATE,0)=0 OR T1.MEMO_TYPE= @BESTIMATE) 
	  AND (ISNULL(@cnTtype,0)=0 OR T1.CN_TYPE= @cnTtype ) 
    
AND (    
     (@NAC_STATUS=0)      
      OR (@NAC_STATUS=1 AND  ISNULL(PVL.MEMO_ID,'')='')       
      OR (@NAC_STATUS=2 AND (ISNULL(PVL.MEMO_ID,'')<>''))    
     )       
END    
---END OF THE PROCEDURES SP_WSLCRNOTE_FILTER 