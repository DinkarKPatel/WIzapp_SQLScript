CREATE PROCEDURE SP_SALEPERSON_TARGET_DETAILS
(
  @NQUERYID INT,
  @CMEMO_ID VARCHAR(50)='',
  @VALUE_TYPE INT=1 -- 1 FOR QUANTITY BASED 2 FOR VALUE BASED 3 FOR ALL
)
--WITH ENCRYPTION 
AS
BEGIN
IF @NQUERYID=1
GOTO LBL_ADDMODE
ELSE IF @NQUERYID=2
GOTO LBL_EDITMODE
ELSE IF @NQUERYID=3
GOTO LBL_CALBASIS
ELSE IF @NQUERYID=4
GOTO LBL_SUBDET
ELSE
GOTO END_PROC

LBL_ADDMODE:
    IF OBJECT_ID ('TEMPDB..#TMPSALEPERSON','U') IS NOT NULL
       DROP TABLE #TMPSALEPERSON
       
    SELECT L.DEPT_ID ,DEPT_NAME,APRIL=CAST(0 AS NUMERIC(18,2)),
           MAY=CAST(0 AS NUMERIC(18,2)),
           JUNE=CAST(0 AS NUMERIC(18,2)),
           JULY=CAST(0 AS NUMERIC(18,2)),
           AUGUST=CAST(0 AS NUMERIC(18,2)),
           SEPTEMBER=CAST(0 AS NUMERIC(18,2)),
           OCTOBER=CAST(0 AS NUMERIC(18,2)),
           NOVEMBER=CAST(0 AS NUMERIC(18,2)),
           DECEMBER=CAST(0 AS NUMERIC(18,2)),
           JANUARY=CAST(0 AS NUMERIC(18,2)),
           FEBRUARY=CAST(0 AS NUMERIC(18,2)),
           MARCH=CAST(0 AS NUMERIC(18,2)),
           TOTAL =CAST(0 AS NUMERIC(18,2)),
           ROW_ID=CAST('' AS VARCHAR(100)),
           MEMO_ID =CAST('' AS VARCHAR(100)),
           LAST_UPDATE=CAST(NULL AS DATETIME),
           FIN_YEAR=CAST('' AS VARCHAR(10))
    INTO #TMPSALEPERSON
    FROM LOCATION L (NOLOCK)  

    IF @VALUE_TYPE=1 OR  @VALUE_TYPE=2
    BEGIN
        SELECT *,VALUE_TYPE=@VALUE_TYPE,
                CASE WHEN  @VALUE_TYPE=1 THEN 'QUANTITY' ELSE 'VALUE' END AS TARGETNAME 
        FROM #TMPSALEPERSON
    END
 
    ELSE 
    BEGIN
    
        SELECT *,VALUE_TYPE=1,
               'QUANTITY'  AS TARGETNAME  
        FROM #TMPSALEPERSON
        UNION ALL
        SELECT *,VALUE_TYPE=2,
               'VALUE'  AS TARGETNAME   
        FROM #TMPSALEPERSON
        ORDER BY DEPT_ID,VALUE_TYPE  
        
    END
    
   
    
GOTO END_PROC

LBL_EDITMODE:
     IF OBJECT_ID('TEMPDB..#TMPDETAIL','U') IS NOT NULL
        DROP TABLE #TMPDETAIL
        
		 SELECT  L.DEPT_ID ,DEPT_NAME,APRIL,
			   MAY,JUNE,JULY,AUGUST,SEPTEMBER,
			   OCTOBER,NOVEMBER,
			   DECEMBER,JANUARY,FEBRUARY,MARCH,TOTAL,
			    ROW_ID=ROW_ID ,
			    MEMO_ID, LAST_UPDATE=DET.LAST_UPDATE,VALUE_TYPE,DET.FIN_YEAR,
			    CASE WHEN  VALUE_TYPE=1 THEN 'QUANTITY' ELSE 'VALUE' END AS TARGETNAME   
		 INTO #TMPDETAIL
		 FROM LOCATION L (NOLOCK)
		 JOIN SALEPERSON_TARGET_DET DET ON L.DEPT_ID =DET.DEPT_ID  
         WHERE DET.MEMO_ID=@CMEMO_ID AND (@VALUE_TYPE=3 OR VALUE_TYPE =@VALUE_TYPE)
     
     
     IF EXISTS (SELECT TOP 1 'U' FROM SALEPERSON_TARGET_MST WHERE MEMO_ID=@CMEMO_ID )
     BEGIN
         IF OBJECT_ID('TEMPDB..#TMPDETAIL_FINAL','U') IS NOT NULL
            DROP TABLE #TMPDETAIL_FINAL
		
		 IF @VALUE_TYPE=1 OR @VALUE_TYPE=2
    BEGIN
         SELECT *   FROM #TMPDETAIL   
		 UNION ALL
		 SELECT L.DEPT_ID ,L.DEPT_NAME,APRIL=CAST(0 AS NUMERIC(18,2)),
			   MAY=CAST(0 AS NUMERIC(18,2)),
			   JUNE=CAST(0 AS NUMERIC(18,2)),
			   JULY=CAST(0 AS NUMERIC(18,2)),
			   AUGUST=CAST(0 AS NUMERIC(18,2)),
			   SEPTEMBER=CAST(0 AS NUMERIC(18,2)),
			   OCTOBER=CAST(0 AS NUMERIC(18,2)),
			   NOVEMBER=CAST(0 AS NUMERIC(18,2)),
			   DECEMBER=CAST(0 AS NUMERIC(18,2)),
			   JANUARY=CAST(0 AS NUMERIC(18,2)),
		       FEBRUARY=CAST(0 AS NUMERIC(18,2)),
		       MARCH=CAST(0 AS NUMERIC(18,2)),
			   TOTAL =CAST(0 AS NUMERIC(18,2)),
			   ROW_ID=CAST('' AS VARCHAR(100)),
			   MEMO_ID, LAST_UPDATE=CAST(NULL AS DATETIME),VALUE_TYPE =@VALUE_TYPE,
			   FIN_YEAR=CAST('' AS VARCHAR(100)),
			   CASE WHEN  @VALUE_TYPE=1 THEN 'QUANTITY' ELSE 'VALUE' END AS TARGETNAME 
		FROM LOCATION L (NOLOCK)
		LEFT JOIN #TMPDETAIL TMP ON L.DEPT_ID =TMP.DEPT_ID AND VALUE_TYPE=@VALUE_TYPE     
		WHERE TMP.DEPT_ID IS NULL

    END
    ELSE
    BEGIN
         SELECT *  INTO #TMPDETAIL_FINAL FROM #TMPDETAIL   
		 UNION ALL
		 SELECT L.DEPT_ID ,L.DEPT_NAME,APRIL=CAST(0 AS NUMERIC(18,2)),
			   MAY=CAST(0 AS NUMERIC(18,2)),
			   JUNE=CAST(0 AS NUMERIC(18,2)),
			   JULY=CAST(0 AS NUMERIC(18,2)),
			   AUGUST=CAST(0 AS NUMERIC(18,2)),
			   SEPTEMBER=CAST(0 AS NUMERIC(18,2)),
			   OCTOBER=CAST(0 AS NUMERIC(18,2)),
			   NOVEMBER=CAST(0 AS NUMERIC(18,2)),
			   DECEMBER=CAST(0 AS NUMERIC(18,2)),
			   JANUARY=CAST(0 AS NUMERIC(18,2)),
		       FEBRUARY=CAST(0 AS NUMERIC(18,2)),
		       MARCH=CAST(0 AS NUMERIC(18,2)),
			   TOTAL =CAST(0 AS NUMERIC(18,2)),
			   ROW_ID=CAST('' AS VARCHAR(100)),
			   MEMO_ID, LAST_UPDATE=CAST(NULL AS DATETIME),VALUE_TYPE =1,
			   FIN_YEAR=CAST('' AS VARCHAR(100)),
			   'QUANTITY'AS TARGETNAME 
		FROM LOCATION L (NOLOCK)
		LEFT JOIN #TMPDETAIL TMP ON L.DEPT_ID =TMP.DEPT_ID AND VALUE_TYPE=1     
		WHERE TMP.DEPT_ID IS NULL
		UNION ALL
		 SELECT L.DEPT_ID ,L.DEPT_NAME,APRIL=CAST(0 AS NUMERIC(18,2)),
			   MAY=CAST(0 AS NUMERIC(18,2)),
			   JUNE=CAST(0 AS NUMERIC(18,2)),
			   JULY=CAST(0 AS NUMERIC(18,2)),
			   AUGUST=CAST(0 AS NUMERIC(18,2)),
			   SEPTEMBER=CAST(0 AS NUMERIC(18,2)),
			   OCTOBER=CAST(0 AS NUMERIC(18,2)),
			   NOVEMBER=CAST(0 AS NUMERIC(18,2)),
			   DECEMBER=CAST(0 AS NUMERIC(18,2)),
			   JANUARY=CAST(0 AS NUMERIC(18,2)),
		       FEBRUARY=CAST(0 AS NUMERIC(18,2)),
		       MARCH=CAST(0 AS NUMERIC(18,2)),
			   TOTAL =CAST(0 AS NUMERIC(18,2)),
			   ROW_ID=CAST('' AS VARCHAR(100)),
			   MEMO_ID, LAST_UPDATE=CAST(NULL AS DATETIME),VALUE_TYPE =2,
			   FIN_YEAR=CAST('' AS VARCHAR(100)),
			  'VALUE'AS TARGETNAME 
		FROM LOCATION L (NOLOCK)
		LEFT JOIN #TMPDETAIL TMP ON L.DEPT_ID =TMP.DEPT_ID AND VALUE_TYPE=2    
		WHERE TMP.DEPT_ID IS NULL
		
		SELECT * FROM #TMPDETAIL_FINAL
		ORDER BY DEPT_ID,VALUE_TYPE  
    END
    END
    
GOTO END_PROC
LBL_CALBASIS:
    SELECT 1 AS CAL_BASIS, '% OF NET REALIZE VALUE' AS VALUE_NAME
    UNION ALL
    SELECT 2 AS CAL_BASIS, 'PER UOM' AS VALUE_NAME
    ORDER BY CAL_BASIS
GOTO END_PROC    
LBL_SUBDET:
    
    SELECT MEMO_ID,FM_PERCENTAGE,TO_PERCENTAGE,CAL_BASIS,CAL_VALUE1,CAL_VALUE2,CAL_VALUE3,LAST_UPDATE,ROW_ID 
    FROM SALEPERSON_TARGET_SUBDET WHERE MEMO_ID=@CMEMO_ID

END_PROC:
END
