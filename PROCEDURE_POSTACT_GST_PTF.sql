CREATE PROCEDURE POSTACT_GST_PTF     
(    
 @DTTO DATETIME,    
 @CDEPTID CHAR(4)='' ,
 @NLOOP NUMERIC(1,0)
)    
AS    
BEGIN    
 PRINT 'ENTER PTCXFR POSTING'    
     
    DECLARE @CSTEP VARCHAR(10),@BPOSTDISCOUNTSEPARATELY BIT,@CDISCACCODE VARCHAR(10),@BPOSTFREIGHTSEPARATELY BIT,    
   @CFREIGHTACCODE VARCHAR(10),@BPOSTOCTROISEPARATELY BIT,@COCTROIACCODE VARCHAR(10),    
   @BPOSTINSURANCESEPARATELY BIT,@CINSURANCEACCODE VARCHAR(10),    
   @BPOSTOTHERCHARGESSEPARATELY BIT,@COTHERCHARGESACCODE VARCHAR(10),@BPOSTROUNDOFFSEPARATELY BIT,    
   @CROUNDOFFACCODE VARCHAR(10),@NCTR NUMERIC(10,0),    
   @NSUBTOTAL NUMERIC(14,2),@NTAXAMOUNT NUMERIC(14,2), @CPURACCODE VARCHAR(50),@CTAXACCODE VARCHAR(100),    
   @LPOSTTAXSEPARATELY NUMERIC(14,2),@CMEMOID VARCHAR(50),@LOUTSTATIONPARTY BIT,@TMPDR NUMERIC(14,2),    
   @TMPCR NUMERIC(14,2),@CCURSTATECODE VARCHAR(10),@CVMID VARCHAR(40),@CLOCATIONID CHAR(2),    
   @CLASTBILLNO VARCHAR(40),@DTMPVENDORBILLDT DATETIME,@CRMLIST VARCHAR(300),@NTMPCREDITDAYS NUMERIC(10),    
   @NTMPCRDISCOUNTPERCENTAGE NUMERIC(14,2),@DLASTINVDT DATETIME,@CVOUCHERCODE VARCHAR(10),    
   @COLDBILLTYPE VARCHAR(10),@CLASTACCODE VARCHAR(10),@CLASTPARTYNAME VARCHAR(100),@NTOTQUANTITY NUMERIC(14,2),    
   @NTOTNETAMOUNT NUMERIC(14,2),@CDEPTNAME VARCHAR(100),@CVOUCHERNO VARCHAR(10),@NSIGN NUMERIC(1),    
   @CMEMONO VARCHAR(100),@CLOCALSTKXFRACCODE CHAR(10),@NTRANSFERMODE INT,@CBANKACCODE CHAR(10),
   @CERRORMSG VARCHAR(MAX),@BBLANKACFOUND BIT    
     
 SET @CSTEP=10    
 DECLARE @CPARTYACCODE VARCHAR(10),@CPARTYSTATECODE VARCHAR(10),@NNETAMOUNT NUMERIC(14,2),    
   @NDISCAMOUNT NUMERIC(14,2),@NFREIGHT NUMERIC(14,2), @NOTHER NUMERIC(14,2),@NROUNDOFF NUMERIC(14,2),    
   @NDRTOTAL NUMERIC(14,2),@NCRTOTAL NUMERIC(14,2),@CCUTOFFDATE VARCHAR(20),@CXNTYPE VARCHAR(10),    
   @CAC_CODE VARCHAR(20),@CVDID VARCHAR(40),@CPOSTXFRBILLDATE CHAR(2) ,@CCASHAC VARCHAR (20)  
        
    SET @CFREIGHTACCODE=''    
    SET @CROUNDOFFACCODE=''    
        
    SET @CSTEP=20    
    --THIS TABLE VARIABLE STORE ERROR OF OF MEMO ID    
    DECLARE @ERRORS TABLE    
 (    
  XN_ID VARCHAR(40),XN_TYPE VARCHAR(30),XN_NO VARCHAR(40),    
  XN_DT DATETIME,XN_AMT NUMERIC(14,2),XN_AC VARCHAR(100),    
  ERR_DESC VARCHAR(500)    
 )       
        
    SET @CSTEP=30    
    DECLARE @VCHC TABLE     
 (    
  AC_CODE CHAR(10),NARRATION VARCHAR(200),XN_NO VARCHAR(30),    
  XN_DT DATETIME,DEPT_ID CHAR(4),AMOUNT NUMERIC(14,4),XN_ID VARCHAR(22),    
  REF_BILL_NO VARCHAR(50),REF_BILL_DATE DATETIME, ENTRY_ID INT    
  ,CRDAYS NUMERIC(5),XN_TYPE VARCHAR(10)    
 )    
     
 SET @CSTEP=40    
 DECLARE @VDC TABLE     
 (    
  VD_ID VARCHAR(50),    VM_ID VARCHAR(40),    AC_CODE CHAR(10),     
  NARRATION VARCHAR(200),   DEBIT_AMOUNT NUMERIC(14,4),  CREDIT_AMOUNT NUMERIC(14,4),    
  X_TYPE CHAR(2),     VS_AC_CODE CHAR(10),    REF_BILL_NO VARCHAR(40),     
  CREDIT_DAYS NUMERIC(10),  CR_DISCOUNT_PERCENTAGE NUMERIC(14,2),      
  VAT_ENTRY BIT,REF_BILL_DATE DATETIME, AC_NAME VARCHAR(100)   
 )    
     
 SET @CSTEP=50    
 DECLARE @VMC TABLE    
 (    
  VM_ID VARCHAR(400),    VOUCHER_NO VARCHAR(400),   VOUCHER_DT DATETIME,     
  VOUCHER_CODE CHAR(10),   DEPT_ID CHAR(4),    BILL_TYPE VARCHAR(300),    
  BILL_NO VARCHAR(200),    BILL_ID VARCHAR(220),    BILL_DT DATETIME,     
  BILL_AC_CODE VARCHAR(100),  DRTOTAL NUMERIC(20,2),   CRTOTAL NUMERIC(20,2),     
  CASH_VOUCHER BIT,     SALE_VOUCHER BIT,     QUANTITY NUMERIC(20,2),     
  ANGADIA_CODE CHAR(70),    LR_NO VARCHAR(500),    LR_DT DATETIME,    
  PARTY_NAME VARCHAR(1000),  NET_AMOUNT NUMERIC(20,2),   BILL_STATUS VARCHAR(1000),    
  RM_LIST VARCHAR(3000),   CANCELLED BIT,     DEPT_NAME VARCHAR(100),    
  VOUCHER_TYPE VARCHAR(100)     
 )    
     
 SET @CSTEP=60    
 DECLARE @VLINK TABLE    
 (    
  VM_ID VARCHAR(100),MEMO_ID VARCHAR(100),XN_TYPE VARCHAR(20),LAST_UPDATE DATETIME    
 )    
     
 DECLARE @TBILL_BY_BILL_REF TABLE(VD_ID VARCHAR(40),REF_NO VARCHAR(40),AMOUNT NUMERIC(18,4),LAST_UPDATE DATETIME    
        ,X_TYPE VARCHAR(20),CR_DAYS NUMERIC(5),REF_TYPE VARCHAR(10),VM_ID VARCHAR(40))    
   
 SELECT TOP 1 @CCUTOFFDATE=CUTOFFDATE FROM GST_ACCOUNTS_CONFIG_MST WHERE XN_TYPE ='PTF'
     
 ---CHANGE ACCOURDING TO CONFIGRATION AC_CODE    

 SELECT TOP 1 @CLOCALSTKXFRACCODE=VALUE  FROM GST_ACCOUNTS_CONFIG_DET_OTHERS WHERE XN_TYPE='PTF' 
 AND  COLUMNNAME='PETTY_CASH_TRANSFER_AC_CODE'
 
 SELECT TOP 1 @CCASHAC=VALUE FROM GST_ACCOUNTS_CONFIG_DET_OTHERS WHERE XN_TYPE ='PTF' AND 
 COLUMNNAME='PETTY_CASH_AC_CODE'
   
 SET @CCUTOFFDATE=ISNULL(@CCUTOFFDATE,'')    
     
 SET @CSTEP=70    
     
    BEGIN TRY    
   SELECT TOP 1  @CPOSTXFRBILLDATE = ISNULL(POSTXFRBILLDATE,0)    
   FROM GST_ACCOUNTS_CONFIG_MST WHERE XN_TYPE='PTF'
       
 
   SET @CPOSTXFRBILLDATE=ISNULL(@CPOSTXFRBILLDATE,0)    
       
   SET @CSTEP=80    
   IF OBJECT_ID('TEMPDB..#POSTS','U') IS NOT NULL    
    DROP TABLE #POSTS     
       
   SET @CSTEP=90    
   --THIS TABLE STORE ALL PENDING MEMO_ID     
   CREATE TABLE #POSTS (MEMO_ID VARCHAR(30),MODE VARCHAR(10))    
       
   
      
   --GETTING LIST OF PETTY CASH OUT FOR VOUCHER POSTING    
   INSERT INTO #POSTS (MEMO_ID,MODE)    
         SELECT A.MEMO_ID,'PTCOUT' AS MODE     
         FROM PCO_MST A    
         JOIN LOCATION SL ON a.location_code=SL.DEPT_ID    
         LEFT JOIN LOCATION TL ON a.target_location_code=TL.DEPT_ID    
		 LEFT JOIN loc_accounting_company lac1 (NOLOCK) ON lac1.pan_no=sl.PAN_NO
		 LEFT JOIN loc_accounting_company lac2 (NOLOCK) ON lac2.pan_no=SUBSTRING(sl.loc_gst_no,3,10)
         LEFT OUTER JOIN     
         (    
			SELECT B.MEMO_ID,B.LAST_UPDATE    
			FROM POSTACT_VOUCHER_LINK B     
			JOIN VM01106 C ON C.VM_ID = B.VM_ID     
			WHERE C.CANCELLED=0 AND B.XN_TYPE = 'PTCOUT'     
         )VM  ON A.MEMO_ID = VM.MEMO_ID      
         WHERE      
         /*MEMO_DT IS LESS THAN THE SPECIFIED DATE.*/    
          A.MEMO_DT <= @DTTO    
         AND (@CCUTOFFDATE='' OR A.MEMO_DT>@CCUTOFFDATE)    
         /*IF ACCOUNTS_DEPT_ID IS FILLED UP APPLY FILTER TO LOCATION.*/    
         AND (ISNULL(@CDEPTID,'')='' OR a.location_code=@CDEPTID)    
         /*TARGET LOCATION*/    
         AND a.target_location_code IS NOT NULL    
         AND (VM.MEMO_ID IS NULL OR VM.LAST_UPDATE <> A.LAST_UPDATE)     
		 AND (lac1.pan_no IS NOT NULL OR lac2.pan_no IS NOT NULL)     
		 AND ((A.CANCELLED=1 AND VM.MEMO_ID IS NOT NULL) OR A.CANCELLED=0)      
		 
		 UNION ALL    
         SELECT A.MEMO_ID,'PTCIN' AS MODE     
         FROM PCI_MST A    
         JOIN LOCATION SL ON a.location_code=SL.DEPT_ID    
		 LEFT JOIN loc_accounting_company lac1 (NOLOCK) ON lac1.pan_no=sl.PAN_NO
		 LEFT JOIN loc_accounting_company lac2 (NOLOCK) ON lac2.pan_no=SUBSTRING(sl.loc_gst_no,3,10)         
		 LEFT OUTER JOIN     
         (    
			SELECT B.MEMO_ID,B.LAST_UPDATE    
			FROM POSTACT_VOUCHER_LINK B     
			JOIN VM01106 C ON C.VM_ID = B.VM_ID     
			WHERE C.CANCELLED=0 AND B.XN_TYPE = 'PTCIN'     
         )VM  ON A.MEMO_ID  = VM.MEMO_ID      
         WHERE      
         /*PETTY CASH IN IS NOT CANCELLED.*/    
         ((A.CANCELLED=1 AND VM.MEMO_ID IS NOT NULL) OR A.CANCELLED=0)      
         /*PETTY CASH  INV_DT IS LESS THAN THE SPECIFIED DATE.*/    
         AND (    
     (A.RECEIPT_DT <= @DTTO AND @CPOSTXFRBILLDATE<>'1' AND A.RECEIPT_DT<>'')     
     OR (A.MEMO_DT <= @DTTO AND   @CPOSTXFRBILLDATE='1')    
    )    
   AND (@CCUTOFFDATE='' OR ((A.RECEIPT_DT>@CCUTOFFDATE AND @CPOSTXFRBILLDATE<>'1')    
          OR (A.MEMO_DT>@CCUTOFFDATE AND   @CPOSTXFRBILLDATE='1')))        
         /*IF ACCOUNTS_DEPT_ID IS FILLED UP APPLY FILTER TO LOCATION.*/    
         AND (ISNULL(@CDEPTID,'')='' OR a.location_code=@CDEPTID)    
         /*GROUP INVOICE IS NOT GROUP/BRANCH GROUP INVOICE*/     
         AND (VM.MEMO_ID IS NULL OR VM.LAST_UPDATE <> A.LAST_UPDATE)     
		AND (lac1.pan_no IS NOT NULL OR lac2.pan_no IS NOT NULL)
      
	  UNION ALL    
      
	  SELECT A.MEMO_ID,'TPTCIN' AS MODE  
         FROM TILL_LIFTS A    
         JOIN LOCATION SL ON a.location_code=SL.DEPT_ID    
		LEFT JOIN loc_accounting_company lac1 (NOLOCK) ON lac1.pan_no=sl.PAN_NO
		LEFT JOIN loc_accounting_company lac2 (NOLOCK) ON lac2.pan_no=SUBSTRING(sl.loc_gst_no,3,10)      
	  LEFT OUTER JOIN     
         (    
    SELECT B.MEMO_ID,B.LAST_UPDATE    
    FROM POSTACT_VOUCHER_LINK B     
    JOIN VM01106 C ON C.VM_ID = B.VM_ID     
    WHERE C.CANCELLED=0 AND B.XN_TYPE = 'TPTCIN'     
         )VM  ON A.MEMO_ID  = VM.MEMO_ID      
         WHERE  A.TRANSFERMODE=2 AND     
         /*PETTY CASH IN IS NOT CANCELLED.*/    
         ((A.CANCELLED=1 AND VM.MEMO_ID IS NOT NULL) OR A.CANCELLED=0)      
         /*PETTY CASH  INV_DT IS LESS THAN THE SPECIFIED DATE.*/    
         AND A.MEMO_DT <= @DTTO 
 AND (@CCUTOFFDATE='' OR A.MEMO_DT>@CCUTOFFDATE )
         /*IF ACCOUNTS_DEPT_ID IS FILLED UP APPLY FILTER TO LOCATION.*/    
         AND (ISNULL(@CDEPTID,'')='' OR a.location_code=@CDEPTID)    
         /*GROUP INVOICE IS NOT GROUP/BRANCH GROUP INVOICE*/     
         AND (VM.MEMO_ID IS NULL OR VM.LAST_UPDATE <> A.LAST_UPDATE)     
        AND (lac1.pan_no IS NOT NULL OR lac2.pan_no IS NOT NULL)          
    
   SET @CSTEP=110    
   CREATE INDEX IX_TEMP_WSLTABLE_RM_ID ON #POSTS(MEMO_ID)    

    IF OBJECT_ID('TEMPDB..#V_PROCESS','U') IS NOT NULL    
		DROP TABLE #V_PROCESS    
       
   SET @CSTEP = 120    
       
        
       
    SELECT  A.MEMO_NO AS MEMO_NO,     
     A.MEMO_ID AS MEMO_ID,     
     A.MEMO_DT AS MEMO_DT,    
     LOCT.DEPT_AC_CODE, ---DEBIT    
     A.REMARKS,     
     A.AMOUNT AS AMOUNT    
     ,A.CANCELLED    
     ,a.location_code AS DEPT_ID    
     ,A.FIN_YEAR    
     ,(CASE WHEN ISNULL(TRANSFER_MODE,0)=2 THEN BANK_AC_CODE ELSE  @CCASHAC END) AS XN_AC_CODE  --CREDIT     
     ,D.AC_NAME AS PARTY_NAME    
     ,'0000000002' AS VOUCHER_TYPE    
     ,A.MEMO_ID AS REF_MEMO_ID    
     ,A.MEMO_DT AS REF_MEMO_DT    
     ,'PTCOUT' AS XN_TYPE
	  ,'PTF' AS POSTING_XN_TYPE
	  ,LEFT('0000000000',10) AS IGST_REVENUE_AC_CODE
	  ,LEFT('0000000000',10) AS IGST_TAX_AC_CODE
	  ,CONVERT(NUMERIC(10,2),0) AS IGST_AMOUNT
	  ,LEFT('0000000000',10) AS LGST_REVENUE_AC_CODE
	  ,LEFT('0000000000',10) AS CGST_TAX_AC_CODE
	  ,LEFT('0000000000',10) AS SGST_TAX_AC_CODE
	   ,LEFT('0000000000',10) AS OTHER_CHARGES_IGST_REVENUE_AC_CODE
	   ,LEFT('0000000000',10) AS OTHER_CHARGES_IGST_TAX_AC_CODE
	  ,LEFT('0000000000',10) AS OTHER_CHARGES_LGST_REVENUE_AC_CODE
	  ,LEFT('0000000000',10) AS OTHER_CHARGES_CGST_TAX_AC_CODE
	  ,LEFT('0000000000',10) AS OTHER_CHARGES_SGST_TAX_AC_CODE 
	  ,NULL AS GST_PERCENTAGE	  
	  ,LEFT('',1) AS SECTION_CODE
	  ,LEFT('',1) AS SUB_SECTION_CODE,0 gst_cess_percentage,convert(varchar(10),'') gst_cess_ac_code
   INTO #V_PROCESS    
   FROM PCO_MST A     
   JOIN #POSTS PS ON A.MEMO_ID=PS.MEMO_ID AND PS.MODE='PTCOUT'    
   JOIN LOCATION LOCT ON LOCT.DEPT_ID=a.target_location_code   
   JOIN LMV01106 D ON LOCT.CONTROL_AC_CODE = D.AC_CODE    
   JOIN AREA ON AREA.AREA_CODE=LOCT.AREA_CODE    
   JOIN CITY ON CITY.CITY_CODE=AREA.CITY_CODE    
   GROUP BY A.MEMO_NO,     
      A.MEMO_ID,     
      A.MEMO_DT ,    
      LOCT.DEPT_AC_CODE,     
      A.REMARKS,    
      A.AMOUNT,     
      a.location_code,     
      A.FIN_YEAR,    
      D.AC_NAME,ISNULL(TRANSFER_MODE,0),BANK_AC_CODE ,a.cancelled    
 
   SET @CSTEP=125
         
   INSERT #V_PROCESS (MEMO_NO,MEMO_ID,MEMO_DT,DEPT_AC_CODE,REMARKS,AMOUNT,CANCELLED,DEPT_ID,FIN_YEAR,XN_AC_CODE,
	  PARTY_NAME,VOUCHER_TYPE,REF_MEMO_ID,REF_MEMO_DT,XN_TYPE,POSTING_XN_TYPE,gst_cess_percentage)
   SELECT  A.MEMO_NO AS MEMO_NO,     
     A.MEMO_ID AS MEMO_ID,     
     A.MEMO_DT AS MEMO_DT,    
     LOCT.DEPT_AC_CODE, ---CREDIT    
     A.REMARKS,     
     A.AMOUNT AS AMOUNT    
     ,0 AS CANCELLED    
     ,a.location_Code AS DEPT_ID    
     ,A.FIN_YEAR    
     ,@CCASHAC AS XN_AC_CODE  --DEBIT     
     ,D.AC_NAME AS PARTY_NAME    
     ,'0000000003' AS VOUCHER_TYPE    
     ,A.MEMO_ID AS REF_MEMO_ID    
     ,A.MEMO_DT AS REF_MEMO_DT    
     ,'PTCIN' AS XN_TYPE
     ,'PTF' AS POSTING_XN_TYPE,0 gst_cess_percentage
   FROM PCI_MST A     
   JOIN #POSTS PS ON A.MEMO_ID=PS.MEMO_ID AND PS.MODE='PTCIN'    
   JOIN LOCATION LOCT ON LOCT.DEPT_ID=a.Location_code     
   JOIN LMV01106 D ON LOCT.CONTROL_AC_CODE = D.AC_CODE    
   JOIN AREA ON AREA.AREA_CODE=LOCT.AREA_CODE    
   JOIN CITY ON CITY.CITY_CODE=AREA.CITY_CODE    
   WHERE ISNULL(REFLIFTID ,'')=''    
   GROUP BY A.MEMO_NO,     
      A.MEMO_ID,     
      A.MEMO_DT ,    
      LOCT.DEPT_AC_CODE,     
      A.REMARKS,    
      A.AMOUNT,     
      a.location_code,     
      A.FIN_YEAR,    
       D.AC_NAME    
  UNION ALL --------TILL PETTY CASH IN    
  SELECT  A.MEMO_NO AS MEMO_NO,     
     A.MEMO_ID AS MEMO_ID,     
     A.MEMO_DT AS MEMO_DT,    
     '0000000001' AS AC_CODE, ---CREDIT    
     A.REMARKS,     
     A.LIFT_AMOUNT AS AMOUNT    
     ,0 AS CANCELLED    
     ,a.location_code AS DEPT_ID    
     ,A.FIN_YEAR    
     ,A.AC_CODE AS XN_AC_CODE  --DEBIT     
     ,D.AC_NAME AS PARTY_NAME    
     ,'0000000003' AS VOUCHER_TYPE    
     ,A.MEMO_ID AS REF_MEMO_ID    
     ,A.MEMO_DT AS REF_MEMO_DT    
     ,'TPTCIN' AS XN_TYPE
     ,'PTF' AS POSTING_XN_TYPE,0 gst_cess_percentage     
   FROM TILL_LIFTS A     
   JOIN #POSTS PS ON A.MEMO_ID=PS.MEMO_ID AND PS.MODE='TPTCIN'    
   JOIN LMV01106 D ON A.AC_CODE = D.AC_CODE    
   JOIN LOCATION LOCT ON LOCT.DEPT_ID=a.location_code  
   JOIN AREA ON AREA.AREA_CODE=LOCT.AREA_CODE    
   JOIN CITY ON CITY.CITY_CODE=AREA.CITY_CODE    
   GROUP BY A.MEMO_NO,     
      A.MEMO_ID,     
      A.MEMO_DT ,    
      A.AC_CODE,     
      A.REMARKS,    
      A.LIFT_AMOUNT,     
      a.location_code,     
  A.FIN_YEAR,    
       D.AC_NAME                
  ORDER BY MEMO_DT,MEMO_ID    
      
  CREATE INDEX IX_V_PROCESS_RM_ID ON #V_PROCESS(MEMO_ID,XN_TYPE)    

	SET @CSTEP=130    
	IF OBJECT_ID('TEMPDB..#V_PROCESS_OTHERS','U') IS NOT NULL
		DROP TABLE #V_PROCESS_OTHERS
		
	SELECT TOP 1 'PTF' AS XN_TYPE,'PETTY_CASH_AC_CODE' AS  COLUMNNAME,'PETTY CASH A/C' AS COLUMNDESC
	INTO #V_PROCESS_OTHERS FROM #V_PROCESS 
	UNION
	SELECT TOP 1 'PTF' AS XN_TYPE,'PETTY_CASH_TRANSFER_AC_CODE' AS  COLUMNNAME,'PETTY CASH TRANSFER A/C' AS COLUMNDESC
	FROM #V_PROCESS 		
	
  SET @CSTEP = 140  
	EXEC SP3S_GET_POSTING_BLANKAC
	@CXNTYPE='PTF',
	@NLOOP=@NLOOP,
	@CERRORMSG=@CERRORMSG OUTPUT,
	@BBLANKACFOUND=@BBLANKACFOUND OUTPUT		

	IF @BBLANKACFOUND=1 OR @CERRORMSG<>'' OR @NLOOP=0
		GOTO END_PROC

        
  SELECT @CMEMOID='',@CXNTYPE='',@CAC_CODE='',@NCTR=1    
  
  SET @CSTEP = 380    
  WHILE EXISTS(SELECT TOP 1 'U' FROM #V_PROCESS)    
  BEGIN    
   SET @CSTEP = 390    
   SELECT TOP 1 @CMEMOID=MEMO_ID,@CMEMONO=MEMO_NO,@CXNTYPE=XN_TYPE,@CAC_CODE=DEPT_AC_CODE
   FROM #V_PROCESS    
       
   IF @CXNTYPE='PTCOUT'    
   SET @CVOUCHERCODE = '0000000002'    
   ELSE    
   SET @CVOUCHERCODE = '0000000003'    
       
   SET @CSTEP = 400    
   -- PARTY ACCOUNT DR WITH  AMOUNT    
   INSERT @VCHC (XN_TYPE, AC_CODE, AMOUNT )    
   SELECT TOP 1 XN_TYPE , DEPT_AC_CODE,AMOUNT    
   FROM #V_PROCESS     
   WHERE MEMO_ID=@CMEMOID AND AMOUNT<>0 AND XN_TYPE=@CXNTYPE    
       
   SET @CSTEP = 410    
   --SALE A/C OR PURCHASE A/C CREDIT WITH SUBTOTAL AMOUNT    
   INSERT @VCHC (XN_TYPE, AC_CODE, AMOUNT )    
   SELECT XN_TYPE ,XN_AC_CODE,-AMOUNT     
   FROM #V_PROCESS     
   WHERE MEMO_ID=@CMEMOID AND AMOUNT<>0 AND XN_TYPE=@CXNTYPE       
         
   SET @CSTEP = 500    
   SET @CVMID = ''    
   SELECT @CVMID = A.VM_ID     
   FROM POSTACT_VOUCHER_LINK A    
   JOIN VM01106 B ON A.VM_ID=B.VM_ID     
   WHERE --B.CANCELLED=0 AND 
   A.MEMO_ID = @CMEMOID AND A.XN_TYPE=@CXNTYPE    
       
   SET @CSTEP = 510    
   IF ISNULL(@CVMID,'') = ''    
   BEGIN    
       SET @CVMID = 'LATERPTF-'+RTRIM(LTRIM(CONVERT(VARCHAR,@NCTR)))    
    SET @NCTR = @NCTR+1    
   END    
       
   SET @CSTEP = 520    
   IF @CXNTYPE='PTCOUT'    
   BEGIN    
    INSERT INTO @VLINK(VM_ID ,MEMO_ID,XN_TYPE,LAST_UPDATE )    
    SELECT @CVMID,@CMEMOID,@CXNTYPE,LAST_UPDATE FROM PCO_MST  WHERE MEMO_ID = @CMEMOID     
   END    
   ELSE IF @CXNTYPE='PTCIN'    
   BEGIN    
    INSERT INTO @VLINK(VM_ID ,MEMO_ID,XN_TYPE,LAST_UPDATE )    
    SELECT @CVMID,@CMEMOID,@CXNTYPE,LAST_UPDATE FROM PCI_MST  WHERE MEMO_ID = @CMEMOID     
   END    
   ELSE IF @CXNTYPE='TPTCIN'    
   BEGIN    
    INSERT INTO @VLINK(VM_ID ,MEMO_ID,XN_TYPE,LAST_UPDATE )    
    SELECT @CVMID,@CMEMOID,@CXNTYPE,LAST_UPDATE FROM TILL_LIFTS  WHERE MEMO_ID = @CMEMOID     
   END    
    
       
   SET @NSIGN=(CASE WHEN @CXNTYPE IN ('PTCOUT') THEN 1 ELSE -1 END)    
       
   SET @CSTEP = 530    
       
   INSERT @VDC (VM_ID, VD_ID, AC_CODE, NARRATION, DEBIT_AMOUNT, CREDIT_AMOUNT, X_TYPE,     
        CREDIT_DAYS, CR_DISCOUNT_PERCENTAGE,AC_NAME)    
   SELECT @CVMID    
    , 'LATERPTF-'+CONVERT(VARCHAR,ROW_NUMBER() OVER(ORDER BY A.AC_CODE)) AS VD_ID    
    , A.AC_CODE    
    , XN_TYPE+' '+@CMEMONO +CASE WHEN XN_TYPE='TPTCIN' THEN ' (TILL TO PETTY CASH)' ELSE '' END AS NARRATION    
    ,(CASE WHEN SUM(AMOUNT)*(@NSIGN)>0 THEN ABS(SUM(AMOUNT)) ELSE 0 END) AS DEBIT_AMOUNT    
    ,(CASE WHEN SUM(AMOUNT)*(@NSIGN)<0 THEN ABS(SUM(AMOUNT)) ELSE 0 END) AS CREDIT_AMOUNT    
    ,(CASE WHEN SUM(AMOUNT)*(@NSIGN)> 0 THEN 'DR' ELSE 'CR' END) AS X_TYPE    
    ,A.CRDAYS    
    ,0    
    ,B.AC_NAME    
         FROM @VCHC A    
         JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE    
         GROUP BY XN_TYPE ,A.AC_CODE,A.XN_NO,B.AC_NAME,A.CRDAYS    
         ORDER BY X_TYPE,ABS(SUM(AMOUNT)) DESC    
       
         SET @CSTEP = 540    
         SELECT @NDRTOTAL =SUM(DEBIT_AMOUNT),@NCRTOTAL=SUM(CREDIT_AMOUNT) FROM @VDC    
      WHERE VM_ID = @CVMID    
          
      SET @CSTEP = 550        
         SET @CVOUCHERNO = ''     
         SELECT TOP 1 @CVOUCHERNO = VOUCHER_NO FROM VM01106 WHERE VM_ID = @CVMID    
         IF ISNULL(@CVOUCHERNO,'') = ''    
    SET @CVOUCHERNO = @CVMID    
             
         SET @CSTEP = 560    
         INSERT @VMC ( VM_ID,VOUCHER_NO,VOUCHER_DT, VOUCHER_CODE, DEPT_ID,     
         BILL_TYPE, BILL_NO, BILL_ID, BILL_DT,     
         PARTY_NAME, QUANTITY, NET_AMOUNT, RM_LIST, CANCELLED,DRTOTAL,CRTOTAL    
      )    
   SELECT @CVMID,@CVOUCHERNO,A.MEMO_DT,A.VOUCHER_TYPE,A.DEPT_ID    
      ,'PTF' AS BILL_TYPE,A.MEMO_NO,A.MEMO_ID,A.MEMO_DT    
      ,A.PARTY_NAME,0 AS QUANTITY,A.AMOUNT,A.MEMO_NO,A.CANCELLED,@NDRTOTAL,@NCRTOTAL    
   FROM #V_PROCESS A    
   WHERE A.MEMO_ID=@CMEMOID AND XN_TYPE=@CXNTYPE     
   GROUP BY A.MEMO_DT,A.VOUCHER_TYPE,A.DEPT_ID    
     ,A.MEMO_NO,A.MEMO_ID    
     ,A.PARTY_NAME,A.AMOUNT,A.CANCELLED    
       
       
   SET @CSTEP = 570    
   DELETE @VCHC    
      DELETE FROM #V_PROCESS WHERE MEMO_ID = @CMEMOID AND XN_TYPE=@CXNTYPE    
  END           
        

	DECLARE @nSpId VARCHAR(40)
	
   
  
   SET @CSTEP=572
   set @nSpId=ltrim(rtrim(str(@@spid)))  

	EXEC SP_CHKXNSAVELOG 'PTFPOST',@cStep,1,@nSpId,'',1	 	
	
	DELETE FROM ACT_VM01106_UPLOAD WHERE SP_ID=@NSPID
	DELETE FROM ACT_VD01106_UPLOAD WHERE SP_ID=@NSPID
	DELETE FROM ACT_BILL_BY_BILL_REF_UPLOAD WHERE SP_ID=@NSPID
	DELETE FROM ACT_POSTACT_VOUCHER_LINK_UPLOAD WHERE SP_ID=@NSPID
	
	SET @CSTEP = 574
	EXEC SP_CHKXNSAVELOG 'PTFPOST',@cStep,1,@nSpId,'',1	 		
	PRINT 'START POSTING PTF:'+@CSTEP+' '+CONVERT(VARCHAR,GETDATE(),113)
    INSERT ACT_VM01106_UPLOAD	( ANGADIA_CODE, APPROVED, APPROVEDLEVELNO, ATTACHMENT_FILE, AUDITED_DT, 
    AUDITED_USER_CODE, BILL_AC_CODE, BILL_DT, BILL_ID, BILL_NO, BILL_TYPE, CANCELLED, CASH_VOUCHER, COMPANY_CODE, 
    CRTOTAL, DEPT_ID, DRTOTAL, EDT_USER_CODE, FIN_YEAR, FREEZE, LAST_UPDATE, LR_DT, LR_NO, MEMO, MRR_LIST, OP_ENTRY,
    QUANTITY, REF_NO, REF_VM_ID, REMINDER_DAYS, SALE_VOUCHER, SENT_FOR_RECON, SENT_TO_HO, SMS_SENT, SR_NO, 
    UPLOADED_TO_ACTIVSTREAM, USER_CODE, VM_ID, VM_NO, VOUCHER_CODE, VOUCHER_DT, VOUCHER_NO, SP_ID,TEMP_VM_ID )  
    SELECT 	  ANGADIA_CODE,0 AS APPROVED,0 AS APPROVEDLEVELNO,'' AS ATTACHMENT_FILE,'' AS AUDITED_DT, 
    '' AS AUDITED_USER_CODE, BILL_AC_CODE,BILL_DT, ISNULL(BILL_ID,'') AS BILL_ID,ISNULL( BILL_NO,'') AS BILL_NO,
     BILL_TYPE,CANCELLED, 
    0 AS CASH_VOUCHER, '01' AS COMPANY_CODE, CRTOTAL, DEPT_ID, DRTOTAL,'' AS EDT_USER_CODE,
	('01'+dbo.FN_GETFINYEAR(voucher_dt)) FIN_YEAR, 
    0 AS FREEZE,GETDATE() AS  LAST_UPDATE,'' AS LR_DT,'' AS LR_NO,0 AS MEMO,'' AS MRR_LIST,0 AS  OP_ENTRY,
    QUANTITY, '' AS REF_NO,'' AS REF_VM_ID,0 AS  REMINDER_DAYS,1 AS SALE_VOUCHER,0 AS  SENT_FOR_RECON,0 AS SENT_TO_HO, 
    0 AS SMS_SENT,0 AS SR_NO,0 AS UPLOADED_TO_ACTIVSTREAM,'0000000' AS USER_CODE,
    VM_ID,'' AS VM_NO, VOUCHER_CODE, VOUCHER_DT,VOUCHER_NO, @NSPID AS SP_ID,'' AS TEMP_VM_ID 
    FROM @vmC A 
    
	
	SET @CSTEP = 576
	EXEC SP_CHKXNSAVELOG 'PTFPOST',@cStep,1,@nSpId,'',1	 		

	PRINT 'START POSTING PTF:'+@CSTEP+' '+CONVERT(VARCHAR,GETDATE(),113)
	INSERT ACT_VD01106_UPLOAD	( AC_CODE, AUTOENTRY, CHK_RECON, COMPANY_CODE, CONTROL_AC, COST_CENTER_AC_CODE, COST_CENTER_DEPT_ID, 
	CREDIT_AMOUNT, DEBIT_AMOUNT, LAST_UPDATE, NARRATION, RECON_DT, SECONDARY_NARRATION, VAT_ENTRY, VD_ID, VM_ID, VS_AC_CODE, X_TYPE, SP_ID,TEMP_VD_ID )
	SELECT AC_CODE,0 AS AUTOENTRY,0 AS CHK_RECON,'01' AS COMPANY_CODE,0 AS CONTROL_AC,'0000000000' AS COST_CENTER_AC_CODE, 
	ISNULL(b.Dept_id,@CDEPTID) AS COST_CENTER_DEPT_ID,CREDIT_AMOUNT, DEBIT_AMOUNT,GETDATE() AS LAST_UPDATE,ISNULL(NARRATION,'') AS NARRATION,'' AS RECON_DT, 
	'' AS SECONDARY_NARRATION, 0 AS VAT_ENTRY,VD_ID,A.VM_ID,ISNULL(VS_AC_CODE,'0000000000') AS VS_AC_CODE,
	X_TYPE, @NSPID AS SP_ID,'' AS TEMP_VD_ID 
	FROM @vdC A
	JOIN @vmC B ON A.VM_ID=B.VM_ID
    WHERE (DEBIT_AMOUNT<>0 OR CREDIT_AMOUNT<>0)

	
	SET @CSTEP = 578
	EXEC SP_CHKXNSAVELOG 'PTFPOST',@cStep,1,@nSpId,'',1	 		
	PRINT 'START POSTING PTF:'+@CSTEP+' '+CONVERT(VARCHAR,GETDATE(),113)
	INSERT ACT_BILL_BY_BILL_REF_UPLOAD	( ADJ_REMARKS, AMOUNT, BB_ROW_ID, CR_DAYS, LAST_UPDATE, PAYMENT_ADJ_REF_NO, 
	REF_NO,  REMARKS, VD_ID, X_TYPE, SP_ID ,VM_ID,cd_percentage,cd_base_amount,ignore_cd_base_amount,
	cd_posted,org_bill_amount,org_bill_dt,org_bill_no)  
	SELECT '' AS ADJ_REMARKS,AMOUNT,'' AS BB_ROW_ID,0 AS CR_DAYS,GETDATE() AS LAST_UPDATE,'' AS PAYMENT_ADJ_REF_NO, 
	a.ref_no, '' AS REMARKS,A.VD_ID,A.X_TYPE,@NSPID AS SP_ID,A.VM_ID,
	0 cd_percentage,0 cd_base_amount,0 ignore_cd_base_amount,0 cd_posted,d.net_amount as org_bill_amount,
	d.inv_DT org_bill_dt,d.inv_no org_bill_no FROM @TBILL_BY_BILL_REF A
    JOIN @vdC B ON A.VD_ID=B.VD_ID AND A.VM_ID=B.VM_ID
    JOIN @vmC C ON B.VM_ID=C.VM_ID
	JOIN @vLink v ON v.VM_ID=c.VM_ID
	LEFT JOIN inm01106 d ON d.inv_id=v.MEMO_ID
    WHERE A.AMOUNT<>0
	
	SET @CSTEP = 580
	EXEC SP_CHKXNSAVELOG 'PTFPOST',@cStep,1,@nSpId,'',1	 		
	
	PRINT 'START POSTING PTF:'+@CSTEP+' '+CONVERT(VARCHAR,GETDATE(),113)
	INSERT ACT_POSTACT_VOUCHER_LINK_UPLOAD	( LAST_UPDATE, MEMO_ID, VM_ID, XN_TYPE, SP_ID )  
	SELECT 	LAST_UPDATE, MEMO_ID, A.VM_ID, A.XN_TYPE, @NSPID AS SP_ID 
	FROM @vlink A
    JOIN @vmC B ON A.VM_ID=B.VM_ID
	
    SET @CSTEP = 582  
	  PRINT 'Running Step#'+@cStep+':'+convert(varchar,getdate(),113)
    SELECT @nSpId sp_id, CONVERT(BIT,1) AS CHK,CONVERT(BIT,1) optimized,*,CONVERT(BIT,0) AS ERROR_FLAG,CONVERT(VARCHAR(500),'') AS ERROR_DESC
    FROM @VMC ORDER BY VM_ID,BILL_DT,BILL_NO    
    
    SELECT * FROM @VDC ORDER BY VM_ID    
    SELECT * FROM @ERRORS WHERE 1=2    
    SELECT * FROM @VLINK ORDER BY VM_ID    

	SELECT B.AC_NAME,A.*,A.REF_NO AS BILL_NO 
	FROM @TBILL_BY_BILL_REF A
	JOIN @VDC B ON A.VD_ID=B.VD_ID AND A.VM_ID=B.VM_ID
	JOIN @VLINK C ON B.VM_ID=C.VM_ID
	LEFT OUTER JOIN @ERRORS D ON C.MEMO_ID=D.XN_ID
	WHERE D.ERR_DESC IS NULL
        
    --POSTACT_PTCXFR '2015-09-20'    
     
	GOTO END_PROC      
END TRY    
BEGIN CATCH    
   SET @CERRORMSG=' ERROR IN POSTACT_GST_PTF  AT STEP#'+@CSTEP+' '+ERROR_MESSAGE()
   GOTO END_PROC
END CATCH    

END_PROC:
    IF ISNULL(@CERRORMSG,'')<>''
		SELECT @CERRORMSG AS ERRMSG         
END   
--END OF PROCEDURE - POSTACT_GST_PTF
