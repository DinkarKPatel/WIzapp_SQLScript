CREATE PROCEDURE SP_PROCESS_IMPORTDATA_ARSPLAN(@nSpId NUMERIC(4,0)=0,@AUTO_CAL BIT=0,@CAL_DAYS INT=0)
AS        
BEGIN        
 SET NOCOUNT ON         
 BEGIN TRY        
 DECLARE @EXL BIT=0,@DAYS INT=0,@CRFDBNAME VARCHAR(100)
 ,@CRFTABLENAME VARCHAR(100)='VW_ARS_RF'
 ,@SQL VARCHAR(MAX),@FIELDS VARCHAR(MAX)
 
 IF OBJECT_ID('tempdb..##ARS_MAPPED_EXCEL_FILEDS') IS NOT NULL DROP TABLE ##ARS_MAPPED_EXCEL_FILEDS      
 CREATE TABLE ##ARS_MAPPED_EXCEL_FILEDS(FIELD VARCHAR(1000))
 SELECT @SQL=COALESCE(@SQL,'')+'IF NOT EXISTS(SELECT TOP 1 '+NAME+' FROM '+OBJECT_NAME(ID)+' WHERE '+NAME+' LIKE ''0000000%'' AND SP_ID='+CAST(@nSPID AS VARCHAR)+')
 INSERT ##ARS_MAPPED_EXCEL_FILEDS SELECT '''+NAME+''';' 
 FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='ARSPLAN_IMPORT_UPLOAD' AND name LIKE '%CODE'
 --PRINT @SQL
 EXEC(@SQL)
 
 
 SET @FIELDS=''
 SELECT @FIELDS=COALESCE(@FIELDS,'')+'ARS.'+FIELD+'=S.'+FIELD+' AND '
 FROM ##ARS_MAPPED_EXCEL_FILEDS
 IF OBJECT_ID('tempdb..##ARS_MAPPED_EXCEL_FILEDS') IS NOT NULL DROP TABLE ##ARS_MAPPED_EXCEL_FILEDS
 SET @FIELDS=ISNULL(@FIELDS,'')+'ARS.DEPT_ID=S.DEPT_ID'
 
 SET @CRFDBNAME=DB_NAME()+'.DBO.'
 
 
 IF OBJECT_ID('tempdb..##GENINDENTS_DATA_ARS') IS NOT NULL       
 BEGIN      
    SET @EXL=1      
    SELECT TOP 1 @DAYS=SEASON_DAYS FROM ##GENINDENTS_DATA_ARS WHERE SPID=@nSpId     
    IF ISNULL(@DAYS,0)=0 SET @DAYS=1      
    UPDATE ARSPLAN_IMPORT_UPLOAD SET TARGET_DAILY_SALE=TARGET_DAILY_SALE/@DAYS WHERE SP_ID=@nSpId
 END      
 ELSE
   BEGIN
      SET @SQL='UPDATE ARS SET ARS.TARGET_DAILY_SALE=ISNULL(S.SLS,0)/'+CAST(@CAL_DAYS AS VARCHAR)+'
		FROM ARSPLAN_IMPORT_UPLOAD ARS
		JOIN (SELECT A.DEPT_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.PARA3_CODE,A.PARA4_CODE,A.PARA5_CODE,A.PARA6_CODE
		,SECTIONM.SECTION_CODE,SECTIOND.SUB_SECTION_CODE,AF.ATTR1_KEY_CODE,AF.ATTR2_KEY_CODE,AF.ATTR3_KEY_CODE,AF.ATTR4_KEY_CODE,AF.ATTR5_KEY_CODE
		,AF.ATTR6_KEY_CODE,AF.ATTR7_KEY_CODE,AF.ATTR8_KEY_CODE,AF.ATTR9_KEY_CODE,AF.ATTR10_KEY_CODE,AF.ATTR11_KEY_CODE,AF.ATTR12_KEY_CODE,AF.ATTR13_KEY_CODE
		,AF.ATTR14_KEY_CODE,AF.ATTR15_KEY_CODE,AF.ATTR16_KEY_CODE,AF.ATTR17_KEY_CODE,AF.ATTR18_KEY_CODE,AF.ATTR19_KEY_CODE,AF.ATTR20_KEY_CODE
		,AF.ATTR21_KEY_CODE,AF.ATTR22_KEY_CODE,AF.ATTR23_KEY_CODE,AF.ATTR24_KEY_CODE,AF.ATTR25_KEY_CODE
		,SUM(ISNULL(A.SLS_QTY,0)-ISNULL(A.SLR_QTY,0)+ISNULL(A.WSL_QTY,0)-ISNULL(A.WSR_QTY,0))SLS
		FROM '+@CRFDBNAME+@CRFTABLENAME+' A (NOLOCK)
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
		JOIN PARA1 (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE AND ISNULL(PARA1.INACTIVE,0)=0
		JOIN PARA2 (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE AND ISNULL(PARA2.INACTIVE,0)=0
		JOIN PARA3 (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE AND ISNULL(PARA3.INACTIVE,0)=0
		JOIN PARA4 (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE AND ISNULL(PARA4.INACTIVE,0)=0
		JOIN PARA5 (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE AND ISNULL(PARA5.INACTIVE,0)=0
		JOIN PARA6 (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE AND ISNULL(PARA6.INACTIVE,0)=0
		JOIN ARTICLE (NOLOCK)
		JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
		JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
		JOIN ARTICLE_FIX_ATTR AF (NOLOCK) ON AF.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
		JOIN ATTR1_MST (NOLOCK) ON ATTR1_MST.ATTR1_KEY_CODE=AF.ATTR1_KEY_CODE
		JOIN ATTR2_MST (NOLOCK) ON ATTR2_MST.ATTR2_KEY_CODE=AF.ATTR2_KEY_CODE
		JOIN ATTR3_MST (NOLOCK) ON ATTR3_MST.ATTR3_KEY_CODE=AF.ATTR3_KEY_CODE
		JOIN ATTR4_MST (NOLOCK) ON ATTR4_MST.ATTR4_KEY_CODE=AF.ATTR4_KEY_CODE
		JOIN ATTR5_MST (NOLOCK) ON ATTR5_MST.ATTR5_KEY_CODE=AF.ATTR5_KEY_CODE
		JOIN ATTR6_MST (NOLOCK) ON ATTR6_MST.ATTR6_KEY_CODE=AF.ATTR6_KEY_CODE
		JOIN ATTR7_MST (NOLOCK) ON ATTR7_MST.ATTR7_KEY_CODE=AF.ATTR7_KEY_CODE
		JOIN ATTR8_MST (NOLOCK) ON ATTR8_MST.ATTR8_KEY_CODE=AF.ATTR8_KEY_CODE
		JOIN ATTR9_MST (NOLOCK) ON ATTR9_MST.ATTR9_KEY_CODE=AF.ATTR9_KEY_CODE
		JOIN ATTR10_MST (NOLOCK) ON ATTR10_MST.ATTR10_KEY_CODE=AF.ATTR10_KEY_CODE
		JOIN ATTR11_MST (NOLOCK) ON ATTR11_MST.ATTR11_KEY_CODE=AF.ATTR11_KEY_CODE
		JOIN ATTR12_MST (NOLOCK) ON ATTR12_MST.ATTR12_KEY_CODE=AF.ATTR12_KEY_CODE
		JOIN ATTR13_MST (NOLOCK) ON ATTR13_MST.ATTR13_KEY_CODE=AF.ATTR13_KEY_CODE
		JOIN ATTR14_MST (NOLOCK) ON ATTR14_MST.ATTR14_KEY_CODE=AF.ATTR14_KEY_CODE
		JOIN ATTR15_MST (NOLOCK) ON ATTR15_MST.ATTR15_KEY_CODE=AF.ATTR15_KEY_CODE
		JOIN ATTR16_MST (NOLOCK) ON ATTR16_MST.ATTR16_KEY_CODE=AF.ATTR16_KEY_CODE
		JOIN ATTR17_MST (NOLOCK) ON ATTR17_MST.ATTR17_KEY_CODE=AF.ATTR17_KEY_CODE
		JOIN ATTR18_MST (NOLOCK) ON ATTR18_MST.ATTR18_KEY_CODE=AF.ATTR18_KEY_CODE
		JOIN ATTR19_MST (NOLOCK) ON ATTR19_MST.ATTR19_KEY_CODE=AF.ATTR19_KEY_CODE
		JOIN ATTR20_MST (NOLOCK) ON ATTR20_MST.ATTR20_KEY_CODE=AF.ATTR20_KEY_CODE
		JOIN ATTR21_MST (NOLOCK) ON ATTR21_MST.ATTR21_KEY_CODE=AF.ATTR21_KEY_CODE
		JOIN ATTR22_MST (NOLOCK) ON ATTR22_MST.ATTR22_KEY_CODE=AF.ATTR22_KEY_CODE
		JOIN ATTR23_MST (NOLOCK) ON ATTR23_MST.ATTR23_KEY_CODE=AF.ATTR23_KEY_CODE
		JOIN ATTR24_MST (NOLOCK) ON ATTR24_MST.ATTR24_KEY_CODE=AF.ATTR24_KEY_CODE
		JOIN ATTR25_MST (NOLOCK) ON ATTR25_MST.ATTR25_KEY_CODE=AF.ATTR25_KEY_CODE
		ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
		WHERE A.XN_DT BETWEEN  REPLACE(CONVERT(VARCHAR,DATEADD(DD,-'+CAST(@CAL_DAYS AS VARCHAR)+',GETDATE()),102),''.'',''-'') AND REPLACE(CONVERT(VARCHAR,GETDATE(),102),''.'',''-'')
		GROUP BY A.DEPT_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.PARA3_CODE,A.PARA4_CODE,A.PARA5_CODE,A.PARA6_CODE
		,SECTIONM.SECTION_CODE,SECTIOND.SUB_SECTION_CODE,AF.ATTR1_KEY_CODE,AF.ATTR2_KEY_CODE,AF.ATTR3_KEY_CODE,AF.ATTR4_KEY_CODE,AF.ATTR5_KEY_CODE
		,AF.ATTR6_KEY_CODE,AF.ATTR7_KEY_CODE,AF.ATTR8_KEY_CODE,AF.ATTR9_KEY_CODE,AF.ATTR10_KEY_CODE,AF.ATTR11_KEY_CODE,AF.ATTR12_KEY_CODE,AF.ATTR13_KEY_CODE
		,AF.ATTR14_KEY_CODE,AF.ATTR15_KEY_CODE,AF.ATTR16_KEY_CODE,AF.ATTR17_KEY_CODE,AF.ATTR18_KEY_CODE,AF.ATTR19_KEY_CODE,AF.ATTR20_KEY_CODE
		,AF.ATTR21_KEY_CODE,AF.ATTR22_KEY_CODE,AF.ATTR23_KEY_CODE,AF.ATTR24_KEY_CODE,AF.ATTR25_KEY_CODE
		)S
		ON '+@FIELDS+'
		WHERE ARS.SP_ID='+CAST(@nSpId AS VARCHAR)
	    --IF @AUTO_CAL=1 PRINT @SQL
	    IF @AUTO_CAL=1 EXEC(@SQL)
   END    
   
 DECLARE @CERRORMSG VARCHAR(MAX)        
 DECLARE @OUTPUT TABLE(TYPE VARCHAR(50),errmsg VARCHAR(200),VALUE VARCHAR(200))         
 DECLARE @TERROR TABLE(SortOrder int,TYPE VARCHAR(50),errmsg VARCHAR(200),VALUE VARCHAR(200))         
 DECLARE @TNUMCOLUM TABLE (NUMERICCOLUMN VARCHAR(100))        
        
 DECLARE @CCMD NVARCHAR(MAX),@NSTEP INT,@CCOLNAME VARCHAR(100),@BPROCEED BIT        
 ,@bDoNotCreateMaster bit,@cPara1Name varchar(50),@cPara2Name varchar(50),@cPara3Name varchar(50)        
 ,@cPara4Name varchar(50),@cPara5Name varchar(50),@cPara6Name varchar(50),@cporowid varchar(max)        
 ,@cSearchBudgetPlan VARCHAR(200),@cPara1 VARCHAR(100),@cPara2 VARCHAR(100),@cPara3 VARCHAR(100)        
 ,@cPara4 VARCHAR(100),@cPara5 VARCHAR(100),@cPara6 VARCHAR(100),@CSOURCETABLE VARCHAR(300)        
          
 SET @CSOURCETABLE='ARSPLAN_IMPORT_UPLOAD'        
 SET @NSTEP=10        
        
 SELECT @CPARA1=ISNULL(VALUE,'PARA1') FROM CONFIG WHERE CONFIG_OPTION='PARA1_caption'         
 SELECT @CPARA2=ISNULL(VALUE,'PARA2') FROM CONFIG WHERE CONFIG_OPTION='PARA2_caption'        
 SELECT @CPARA3=ISNULL(VALUE,'PARA3') FROM CONFIG WHERE CONFIG_OPTION='PARA3_caption'          
 SELECT @CPARA4=ISNULL(VALUE,'PARA4') FROM CONFIG WHERE CONFIG_OPTION='PARA4_caption'        
 SELECT @CPARA5=ISNULL(VALUE,'PARA5') FROM CONFIG WHERE CONFIG_OPTION='PARA5_caption'         
 SELECT @CPARA6=ISNULL(VALUE,'PARA6') FROM CONFIG WHERE CONFIG_OPTION='PARA6_caption'         
         
 INSERT INTO @TNUMCOLUM SELECT 'MINIMUM_DAYS' UNION SELECT 'TARGET_DAYS' UNION SELECT 'MAXIMUM_DAYS'         
          
 SET @NSTEP=20        
  WHILE EXISTS (SELECT TOP 1 * FROM  @TNUMCOLUM)        
  BEGIN        
    SET @CCOLNAME = (SELECT TOP 1 NUMERICCOLUMN FROM @TNUMCOLUM)        
        
    SET @CCMD=N'IF EXISTS(SELECT TOP 1 ''U'' FROM SYSCOLUMNS WHERE ID=OBJECT_ID('''+@CSOURCETABLE+''')        
            AND NAME='''+@CCOLNAME+''')          
       SET @BPROCEED=1        
       ELSE        
       SET @BPROCEED=0'        
    EXEC SP_EXECUTESQL  @CCMD,N'@BPROCEED BIT OUTPUT',@BPROCEED OUTPUT        
            
            
    IF @BPROCEED=1        
    BEGIN        
     SET @NSTEP=30                         
     SET @CCMD = N'SELECT DISTINCT ''ALERT'' AS TYPE, '''+@CCOLNAME+' SHOULD BE NUMERIC AND NOT NEGATIVE'' AS errmsg,'+@CCOLNAME+' AS VALUE        
          FROM '+@CSOURCETABLE+' WHERE  sp_id='''+ltrim(rtrim(str(@nSpId)))+''' AND (ISNUMERIC('+@CCOLNAME+') = 0 OR LEFT(LTRIM('+@CCOLNAME+'),1) = ''-'' OR CHARINDEX('','','+@CCOLNAME+')>0) AND '+@CCOLNAME+' IS NOT NULL'         
     PRINT @CCMD        
     INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
     EXEC SP_EXECUTESQL @CCMD        
            
     SET @NSTEP=35         
     SET @CCMD = N'SELECT DISTINCT ''ALERT'' AS TYPE, '''+@CCOLNAME+' SHOULD BE NON ZERO'' AS errmsg,'+@CCOLNAME+' AS VALUE        
        FROM '+@CSOURCETABLE+' WHERE sp_id='''+ltrim(rtrim(str(@nSpId)))+''' AND CONVERT(NUMERIC(10,2),'+@CCOLNAME+')<=0  AND '+@CCOLNAME+' IS NOT NULL'          
     PRINT @CCMD        
     INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
     EXEC SP_EXECUTESQL @CCMD        
             
    END        
           
    DELETE FROM @TNUMCOLUM WHERE NUMERICCOLUMN= @CCOLNAME        
  END        
           
  SET @NSTEP=40        
  DECLARE @CROWID VARCHAR(200),@CFILTER VARCHAR(200),@NLOOP INT        
          
  --SET @CCMD=N'UPDATE '+@CSOURCETABLE+' SET ROW_ID=''LATER_''+LTRIM(RTRIM(NEWID()))'        
  --PRINT @CCMD        
  --EXEC SP_EXECUTESQL @CCMD        
       
  SET @NSTEP=50        
          
    UPDATE a SET section_code=ISNULL(b.section_code,'') from arsplan_import_upload a        
    LEFT OUTER JOIN sectionM b ON b.section_name=a.section_name        
 WHERE a.sp_id=@nSpId         
          
  INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
  SELECT DISTINCT 'ALERT' AS TYPE,section_name+' not found in Section Masters' AS errmsg,'section_name' AS VALUE        
  FROM arsplan_import_upload WHERE ISNULL(section_code,'')='' AND ISNULL(section_name,'')<>''        
  AND sp_id=@nSpId         
          
  SET @NSTEP=60        
    UPDATE a SET sub_section_code=ISNULL(b.sub_section_code,'') from arsplan_import_upload a        
    LEFT OUTER JOIN sectiond b ON b.sub_section_name=a.sub_section_name        
  WHERE a.sp_id=@nSpId         
          
  INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
  SELECT DISTINCT 'ALERT' AS TYPE,sub_section_name+'('+section_name+') not found in Sub-Section Masters' AS errmsg,'sub_section_name' AS VALUE        
  FROM arsplan_import_upload WHERE ISNULL(sub_section_code,'')='' AND ISNULL(sub_section_name,'')<>''        
  AND sp_id=@nSpId         
          
  SET @NSTEP=70          
    UPDATE a SET article_code=ISNULL(b.article_code,'') from arsplan_import_upload a        
    LEFT OUTER JOIN article b ON b.article_no=a.article_no        
  WHERE a.sp_id=@nSpId         
          
  INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
  SELECT DISTINCT 'ALERT' AS TYPE,article_no+' not found in Article Masters' AS errmsg,'article_no' AS VALUE        
  FROM arsplan_import_upload WHERE ISNULL(article_code,'')='' AND ISNULL(article_no,'')<>''        
  AND sp_id=@nSpId         
          
  SET @NSTEP=80        
    UPDATE a SET para1_code=ISNULL(b.para1_code,'') from arsplan_import_upload a        
    LEFT OUTER JOIN para1 b ON b.para1_name=a.para1_name        
  WHERE a.sp_id=@nSpId         
          
  INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
  SELECT DISTINCT 'ALERT' AS TYPE,para1_name+' not found in '+ISNULL(@cPara1,'PARA1')+' Para Masters' AS errmsg,@cPara1 AS VALUE        
  FROM arsplan_import_upload WHERE ISNULL(para1_code,'')='' AND ISNULL(para1_name,'')<>''   
  AND sp_id=@nSpId         
          
  SET @NSTEP=90        
    UPDATE a SET para2_code=ISNULL(b.para2_code,'') from arsplan_import_upload a        
    LEFT OUTER JOIN para2 b ON b.para2_name=a.para2_name        
  WHERE a.sp_id=@nSpId         
          
  INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
  SELECT DISTINCT 'ALERT' AS TYPE,para2_name+' not found in '+ISNULL(@cPara2,'PARA2')+' Para Masters' AS errmsg,@cPara2 AS VALUE        
  FROM arsplan_import_upload WHERE ISNULL(para2_code,'')='' AND ISNULL(para2_name,'')<>''        
  AND sp_id=@nSpId         
          
  SET @NSTEP=100        
    UPDATE a SET para3_code=ISNULL(b.para3_code,'') from arsplan_import_upload a        
    LEFT OUTER JOIN para3 b ON b.para3_name=a.para3_name        
  WHERE a.sp_id=@nSpId         
          
  INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
  SELECT DISTINCT 'ALERT' AS TYPE,para3_name+' not found in '+ISNULL(@cPara3,'PARA3')+' Para Masters' AS errmsg,@cPara3 AS VALUE        
  FROM arsplan_import_upload WHERE ISNULL(para3_code,'')='' AND ISNULL(para3_name,'')<>''        
  AND sp_id=@nSpId         
          
  SET @NSTEP=110        
    UPDATE a SET para4_code=ISNULL(b.para4_code,'') from arsplan_import_upload a        
    LEFT OUTER JOIN para4 b ON b.para4_name=a.para4_name        
  WHERE a.sp_id=@nSpId         
          
  INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
  SELECT DISTINCT 'ALERT' AS TYPE,para4_name+' not found in '+ISNULL(@cPara4,'PARA4')+' Para Masters' AS errmsg,@cPara4 AS VALUE        
  FROM arsplan_import_upload WHERE ISNULL(para4_code,'')='' AND ISNULL(para4_name,'')<>''        
  AND sp_id=@nSpId         
          
  SET @NSTEP=120        
    UPDATE a SET para5_code=ISNULL(b.para5_code,'') from arsplan_import_upload a        
    LEFT OUTER JOIN para5 b ON b.para5_name=a.para5_name        
  WHERE a.sp_id=@nSpId         
          
  INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
  SELECT DISTINCT 'ALERT' AS TYPE,para5_name+' not found in '+ISNULL(@cPara5,'PARA5')+' Para Masters' AS errmsg,@cPara5 AS VALUE        
  FROM arsplan_import_upload WHERE sp_id=@nSpId AND ISNULL(para5_code,'')='' AND ISNULL(para5_name,'')<>''        
          
          
  SET @NSTEP=130        
    UPDATE a SET para6_code=ISNULL(b.para6_code,'') from arsplan_import_upload a        
    LEFT OUTER JOIN para6 b ON b.para6_name=a.para6_name        
    WHERE a.sp_id=@nSpId         
        
  INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
  SELECT DISTINCT 'ALERT' AS TYPE,para6_name+' not found in '+ISNULL(@cPara6,'PARA6')+' Para Masters' AS errmsg,@cPara6 AS VALUE        
  FROM arsplan_import_upload WHERE sp_id=@nSpId         
  AND ISNULL(para6_code,'')='' AND ISNULL(para6_name,'')<>''        
          
  SET @NSTEP=140        
  INSERT INTO @TERROR(TYPE,errmsg,VALUE)        
  SELECT DISTINCT 'ALERT' AS TYPE,'Location Id :'+ISNULL(a.dept_id,'')+' not found in Location Masters' AS errmsg,'Location name' AS VALUE        
  FROM arsplan_import_upload a        
  left outer join location b on a.dept_id=b.dept_id        
  WHERE a.sp_id=@nSpId AND b.dept_id IS NULL        
        
  DECLARE @ATTR INT=1        
  WHILE @ATTR<=25        
    BEGIN        
       SET @NSTEP=140+@ATTR*10        
       SET @CCMD=N'UPDATE A SET ATTR'+CAST(@ATTR AS VARCHAR)+'_KEY_CODE=ISNULL(B.ATTR'+CAST(@ATTR AS VARCHAR)+'_KEY_CODE,'''')         
       FROM ARSPLAN_IMPORT_UPLOAD A        
       LEFT JOIN ATTR'+CAST(@ATTR AS VARCHAR)+'_MST B ON B.ATTR'+CAST(@ATTR AS VARCHAR)+'_KEY_NAME=A.ATTR'+CAST(@ATTR AS VARCHAR)+'_KEY_NAME        
       WHERE A.SP_ID='+CAST(@nSpId AS VARCHAR)        
    PRINT '--Step '+CAST(@NSTEP AS VARCHAR)+'A - Attr '+CAST(@ATTR AS VARCHAR)+' : '+CHAR(13)+@CCMD    
    EXEC(@CCMD)        
            
    SET @CCMD=N'SELECT DISTINCT ''ALERT'' AS TYPE,A.ATTR'+CAST(@ATTR AS VARCHAR)+'_KEY_NAME+'' not found in ''+B.TABLE_CAPTION+'' Attributes'' AS errmsg,B.TABLE_CAPTION AS VALUE        
    FROM ARSPLAN_IMPORT_UPLOAD A        
    JOIN (SELECT TABLE_CAPTION FROM CONFIG_ATTR WHERE TABLE_NAME=''ATTR'+CAST(@ATTR AS VARCHAR)+'_MST'')B ON 2=2        
    LEFT JOIN ATTR'+CAST(@ATTR AS VARCHAR)+'_MST C ON C.ATTR'+CAST(@ATTR AS VARCHAR)+'_KEY_NAME=A.ATTR'+CAST(@ATTR AS VARCHAR)+'_KEY_NAME        
    WHERE A.SP_ID='+CAST(@nSpId AS VARCHAR)+'         
    AND ISNULL(A.ATTR'+CAST(@ATTR AS VARCHAR)+'_KEY_CODE,'''')=''''         
    AND ISNULL(A.ATTR'+CAST(@ATTR AS VARCHAR)+'_KEY_NAME,'''')<>''''        
    AND ISNULL(C.ATTR'+CAST(@ATTR AS VARCHAR)+'_KEY_NAME,'''')='''';'        
       PRINT CHAR(13)+'--Step '+CAST(@NSTEP AS VARCHAR)+'B - Attr '+CAST(@ATTR AS VARCHAR)+' : '+CHAR(13)+@CCMD+CHAR(13)        
       INSERT INTO @TERROR(TYPE,ERRMSG,VALUE)        
       EXEC(@CCMD)        
       --NEXT TABLE        
       SET @ATTR=@ATTR+1        
    END          
      
  GOTO END_PROC        
          
 END TRY        
         
 BEGIN CATCH        
  SET @CERRORMSG = 'PROCEDURE SP_PROCESS_IMPORTDATA_ARSPLAN : STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()        
  GOTO END_PROC        
 END CATCH        
         
END_PROC:        
        
IF ISNULL (@CERRORMSG,'') = '' AND NOT EXISTS (SELECT TOP 1 * FROM @TERROR)        
BEGIN        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET SECTION_CODE=REPLICATE('0',7) WHERE ISNULL(SECTION_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET SUB_SECTION_CODE=REPLICATE('0',7) WHERE ISNULL(SUB_SECTION_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ARTICLE_CODE=REPLICATE('0',8) WHERE ISNULL(ARTICLE_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET PARA1_CODE=REPLICATE('0',7) WHERE ISNULL(PARA1_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET PARA2_CODE=REPLICATE('0',7) WHERE ISNULL(PARA2_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET PARA3_CODE=REPLICATE('0',7) WHERE ISNULL(PARA3_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET PARA4_CODE=REPLICATE('0',7) WHERE ISNULL(PARA4_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET PARA5_CODE=REPLICATE('0',7) WHERE ISNULL(PARA5_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET PARA6_CODE=REPLICATE('0',7) WHERE ISNULL(PARA6_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR1_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR1_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR2_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR2_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR3_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR3_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR4_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR4_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR5_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR5_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR6_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR6_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR7_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR7_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR8_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR8_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR9_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR9_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR10_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR10_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR11_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR11_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR12_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR12_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR13_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR13_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR14_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR14_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR15_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR15_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR16_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR16_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR17_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR17_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR18_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR18_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR19_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR19_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR20_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR20_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR21_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR21_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR22_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR22_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR23_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR23_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR24_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR24_KEY_CODE,'')='' AND SP_ID=@nSpId        
 UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET ATTR25_KEY_CODE=REPLICATE('0',7) WHERE ISNULL(ATTR25_KEY_CODE,'')='' AND SP_ID=@nSpId        
 --UPDATE ARSPLAN_IMPORT_UPLOAD WITH (ROWLOCK) SET USER_CODE=REPLICATE('0',7) WHERE ISNULL(USER_CODE,'')='' AND SP_ID=@nSpId        
        
 SELECT CONVERT(VARCHAR(2),'') AS ERRMSG    
 ,A.ARTICLE_NO,ARTICLE.ARTICLE_NAME,A.SECTION_NAME,A.SUB_SECTION_NAME    
 ,A.PARA1_NAME,A.PARA2_NAME,A.PARA3_NAME,A.PARA4_NAME,A.PARA5_NAME,A.PARA6_NAME,A.ARTICLE_CODE,A.SECTION_CODE,A.SUB_SECTION_CODE    
 ,A.PARA1_CODE ,A.PARA2_CODE,A.PARA3_CODE,A.PARA4_CODE,A.PARA5_CODE,A.PARA6_CODE,A.SP_ID,A.DEPT_ID,A.LOC_ID    
 ,A.ATTR1_KEY_CODE,A.ATTR1_KEY_NAME,A.ATTR2_KEY_CODE,A.ATTR2_KEY_NAME,A.ATTR3_KEY_CODE,A.ATTR3_KEY_NAME    
 ,A.ATTR4_KEY_CODE,A.ATTR4_KEY_NAME,A.ATTR5_KEY_CODE,A.ATTR5_KEY_NAME,A.ATTR6_KEY_CODE,A.ATTR6_KEY_NAME    
 ,A.ATTR7_KEY_CODE,A.ATTR7_KEY_NAME,A.ATTR8_KEY_CODE,A.ATTR8_KEY_NAME,A.ATTR9_KEY_CODE,A.ATTR9_KEY_NAME    
 ,A.ATTR10_KEY_CODE,A.ATTR10_KEY_NAME,A.ATTR11_KEY_CODE,A.ATTR11_KEY_NAME,A.ATTR12_KEY_CODE,A.ATTR12_KEY_NAME    
 ,A.ATTR13_KEY_CODE,A.ATTR13_KEY_NAME,A.ATTR14_KEY_CODE,A.ATTR14_KEY_NAME,A.ATTR15_KEY_CODE,A.ATTR15_KEY_NAME    
 ,A.ATTR16_KEY_CODE,A.ATTR16_KEY_NAME,A.ATTR17_KEY_CODE,A.ATTR17_KEY_NAME,A.ATTR18_KEY_CODE,A.ATTR18_KEY_NAME    
 ,A.ATTR19_KEY_CODE,A.ATTR19_KEY_NAME,A.ATTR20_KEY_CODE,A.ATTR20_KEY_NAME,A.ATTR21_KEY_CODE,A.ATTR21_KEY_NAME    
 ,A.ATTR22_KEY_CODE,A.ATTR22_KEY_NAME,A.ATTR23_KEY_CODE,A.ATTR23_KEY_NAME,A.ATTR24_KEY_CODE,A.ATTR24_KEY_NAME    
 ,A.ATTR25_KEY_CODE,A.ATTR25_KEY_NAME,A.MINIMUM_DAYS,A.TARGET_DAYS,A.MAXIMUM_DAYS    
 ,CONVERT(NUMERIC(10,4),A.TARGET_DAILY_SALE)TARGET_DAILY_SALE
 ,CEILING(A.TARGET_DAILY_SALE*A.TARGET_DAYS)TARGET_SALE    
 ,A.SAFETY_LEVEL,DEPT_NAME,'LATER' AS ARS_ID,CONVERT(VARCHAR(40),NEWID()) AS ROW_ID        
 ,CEILING(A.TARGET_DAILY_SALE*A.TARGET_DAYS*(1+ISNULL(SAFETY_LEVEL,0)/100.0)) AS Stock_Req_Qty        
 FROM ARSPLAN_IMPORT_UPLOAD A JOIN LOCATION B ON A.DEPT_ID=B.DEPT_ID        
 JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_NO=A.ARTICLE_NO
 WHERE A.SP_ID=@NSPID ORDER BY 2,5,6,7,8,9,10,3,4   
         
END         
ELSE        
BEGIN        
 INSERT @OUTPUT ( TYPE, errmsg,VALUE) VALUES('ERROR',@CERRORMSG,'')        
 IF EXISTS (SELECT TOP 1 * FROM @TERROR)        
    SELECT TYPE,VALUE,errmsg FROM @TERROR ORDER BY SortOrder        
  ELSE         
    SELECT * FROM @OUTPUT        
 END  
DELETE ARSPLAN_IMPORT_UPLOAD WHERE SP_ID=@nSpId                
SET NOCOUNT OFF         
END        
---END OF PROCEDURE - SP_PROCESS_IMPORTDATA_ARSPLAN