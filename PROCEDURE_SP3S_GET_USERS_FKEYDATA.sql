CREATE PROCEDURE SP3S_GET_USERS_FKEYDATA
@CSOURCEDB VARCHAR(200),
@CSOURCETABLE VARCHAR(200),
@CSOURCEKEYFIELD VARCHAR(200),
@CXNTYPE VARCHAR(10),
@CTABLESUFFIX VARCHAR(40),
@CLOCID VARCHAR(5),
@CERRORMSG VARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	BEGIN TRY
		DECLARE @CCMD NVARCHAR(MAX),@CTEMPTABLE VARCHAR(1000),@CTEMPTABLE1 VARCHAR(1000),@CTEMPTABLE2 VARCHAR(1000),
				@CTEMPTABLE3 VARCHAR(1000),@CTEMPTABLE4 VARCHAR(1000),@CTEMPTABLE5 VARCHAR(1000),
				@CKEYFIELDVAL VARCHAR(40),@CDESTDB VARCHAR(200),@CFILTERCONDITION VARCHAR(MAX),@NSTEP INT,
				@CUSERCODE CHAR(7)
		
		SET @CDESTDB='WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.'
		
		SET @NSTEP=10		
		IF @CSOURCETABLE<>'#TMPMISSINGUSERSDATA'
		BEGIN
			IF OBJECT_ID('TEMPDB..#TMPMISSINGUSERSDATA','U') IS NOT NULL
				DROP TABLE #TMPMISSINGUSERSDATA
			
			SELECT USER_CODE INTO #TMPMISSINGUSERSDATA FROM USERS WHERE 1=2
		END
				
		SET @NSTEP=20											
		SET @CTEMPTABLE=(CASE WHEN LEFT(@CSOURCETABLE,1)='#' THEN @CSOURCETABLE ELSE @CSOURCEDB+'TMP_'+@CXNTYPE+'_'+@CSOURCETABLE+'_'+@CTABLESUFFIX END)

		IF @CSOURCETABLE<>'#TMPMISSINGUSERSDATA'
		BEGIN
			SET @CCMD=N'SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.USERS B ON B.USER_CODE=A.'+@CSOURCEKEYFIELD+'
						WHERE B.USER_CODE IS NULL AND A.'+@CSOURCEKEYFIELD+' IS NOT NULL
						UNION
						SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
						JOIN USERS B ON A.'+@CSOURCEKEYFIELD+'=B.USER_CODE
						LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.USERS C ON C.USER_CODE=B.MAJOR_USER_CODE
						WHERE C.USER_CODE IS NULL AND A.'+@CSOURCEKEYFIELD+' IS NOT NULL'

				
			INSERT #TMPMISSINGUSERSDATA
			EXEC SP_EXECUTESQL @CCMD
		END
				
		IF EXISTS (SELECT TOP 1 USER_CODE FROM #TMPMISSINGUSERSDATA)
		BEGIN
			SET @NSTEP=30


			IF CURSOR_STATUS('GLOBAL','CUR_MAJOR_USERS') IN (0,1)
			BEGIN
				CLOSE CUR_MAJOR_USERS
				DEALLOCATE CUR_MAJOR_USERS
			END	
			
			DECLARE CUR_MAJOR_USERS CURSOR FOR SELECT USER_CODE FROM #TMPMISSINGUSERSDATA
			OPEN CUR_MAJOR_USERS
			FETCH NEXT FROM CUR_MAJOR_USERS INTO @CUSERCODE
			WHILE @@FETCH_STATUS=0
			BEGIN
				SET @NSTEP=35
				SET @CFILTERCONDITION= ' (B.USER_CODE IN (SELECT USER_CODE FROM DBO.FNIT_USERHEADS('''+@CUSERCODE+'''))
									     OR B.USER_CODE='''+@CUSERCODE+''')' 
				
				EXEC UPDATEMASTERXN_MIRROR
				@CSOURCEDB='',
				@CSOURCETABLE='USERS',
				@CDESTDB=@CDESTDB,
				@CDESTTABLE='USERS',
				@CKEYFIELD1='USER_CODE',
				@LINSERTONLY=0,
				@CFILTERCONDITION=@CFILTERCONDITION,
				@LUPDATEONLY=0,
				@BALWAYSUPDATE=1
			
				FETCH NEXT FROM CUR_MAJOR_USERS INTO @CUSERCODE
			END
			CLOSE CUR_MAJOR_USERS
			DEALLOCATE CUR_MAJOR_USERS
			
		END
							
		GOTO END_PROC									
	END TRY
	
	BEGIN CATCH
		SELECT @CERRORMSG='PROCEDURE SP3S_GET_USERS_FKEYDATA : '+ISNULL(ERROR_PROCEDURE(),'NULL P')+'STEP :'+STR(ISNULL(@NSTEP,0))+ ' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		GOTO END_PROC
	END CATCH
	
END_PROC:
		
END
----'END OF PROCEDURE SP3S_GET_USERS_FKEYDATA'
