CREATE PROCEDURE SP3S_VALIDATEXN_WSLMERGE
@cSpId VARCHAR(50),
@cMemoId VARCHAR(40),
@cErrormsg VARCHAR(MAX) OUTPUT
AS
BEGIN
	DECLARE @NNETAMOUNT NUMERIC(10,2),@NCMMSUBTOTAL NUMERIC(10,2),@NPAYMODETOTAMT NUMERIC(10,2),
	@NTotWslQty NUMERIC(10,2),@NTotIndQty NUMERIC(10,2),@cStep VARCHAR(4),@nPaymode NUMERIC(1,0)

	SET @CSTEP=10.2
	EXEC SP_CHKXNSAVELOG 'WSLMERGE',@CSTEP,0,@CSPID,'',1

	SELECT @NNETAMOUNT=NET_AMOUNT,@nPaymode=pay_mode FROM inm01106 (NOLOCK)
	WHERE inv_id=@cMemoId
	
	IF @nPaymode<>4
	BEGIN
		SET @CSTEP=10.4
		EXEC SP_CHKXNSAVELOG 'WSLMERGE',@CSTEP,0,@CSPID,'',1

		SELECT @NPAYMODETOTAMT = SUM(AMOUNT) FROM paymode_xn_det (NOLOCK)
		WHERE memo_id=@cMemoId AND xn_type='WSL'

		SET @CSTEP=10.6
		EXEC SP_CHKXNSAVELOG 'WSLMERGE',@CSTEP,0,@CSPID,'',1
		  
		SELECT @NNETAMOUNT=ISNULL(@NNETAMOUNT,0),@NPAYMODETOTAMT = ISNULL(@NPAYMODETOTAMT,0)  
	
		IF @NNETAMOUNT<>@NPAYMODETOTAMT
		BEGIN  
			PRINT 'SP3S_VALIDATEXN_WSLMERGE payment validation FAILED'
			SET @CERRORMSG='NET AMOUNT '+STR(@NNETAMOUNT,14,2)+' SHOULD BE EQUAL TO THE SUM OF ALL PAYMENT MODES '+STR(@NPAYMODETOTAMT,14,2)+'...PLEASE CHECK'  
			GOTO END_PROC
		END
	END

	SET @CSTEP=10.8
	EXEC SP_CHKXNSAVELOG 'WSLMERGE',@CSTEP,0,@CSPID,'',1


	SELECT @NTotWslQty=total_quantity FROM inm01106 (NOLOCK) WHERE inv_id=@cMemoId

	SET @CSTEP=11.2
	EXEC SP_CHKXNSAVELOG 'WSLMERGE',@CSTEP,0,@CSPID,'',1
		
	SELECT @NTotIndQty = SUM(quantity) FROM ind01106 (NOLOCK) WHERE inv_id=@cMemoId 

	SET @CSTEP=11.4
	EXEC SP_CHKXNSAVELOG 'WSLMERGE',@CSTEP,0,@CSPID,'',1		  
	SELECT @NTotWslQty=ISNULL(@NTotWslQty,0),@NTotIndQty = ISNULL(@NTotIndQty,0)  
	
	IF @NTotWslQty<>@NTotIndQty
	BEGIN  
		PRINT 'SP3S_VALIDATEXN_WSLMERGE Quantity match FAILED'
		SET @CERRORMSG='Bill level Total quantity '+STR(@NTotWslQty,14,2)+' SHOULD BE EQUAL TO THE SUM OF Item level quantity '+STR(@NTotIndQty,10,2)+'...PLEASE CHECK'  
		GOTO END_PROC
	END

END_PROC:
	
END