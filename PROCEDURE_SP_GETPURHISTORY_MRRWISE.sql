CREATE PROCEDURE SP_GETPURHISTORY_MRRWISE
(
@CMRR_ID VARCHAR(50),
@BESTIMATE BIT=0,
@BONLYCURSOR	BIT=1
)
--WITH ENCRYPTION
AS
BEGIN
DECLARE @PUR_DETAILS TABLE(	MRR_ID VARCHAR(50) NOT NULL,
							ARTICLE_CODE VARCHAR(50) NOT NULL,
							PARA1_CODE VARCHAR(10) NOT NULL,
							PARA2_CODE VARCHAR(10) NOT NULL,
							PARA3_CODE VARCHAR(10) NOT NULL,
							PARA4_CODE VARCHAR(10) NOT NULL,
							PARA5_CODE VARCHAR(10) NOT NULL,
							PARA6_CODE VARCHAR(10) NOT NULL)
							
INSERT INTO @PUR_DETAILS(MRR_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PARA3_CODE,PARA4_CODE,PARA5_CODE,PARA6_CODE)
SELECT MRR_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PARA3_CODE,PARA4_CODE,PARA5_CODE,PARA6_CODE 
FROM PID01106 
WHERE MRR_ID=@CMRR_ID
GROUP BY MRR_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PARA3_CODE,PARA4_CODE,PARA5_CODE,PARA6_CODE 

--SELECT  LMV.AC_NAME,A.MRR_NO,A.INV_DT, B.PURCHASE_PRICE,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,
--B.PARA3_CODE,B.PARA4_CODE,B.PARA5_CODE,B.PARA6_CODE
--FROM PIM01106 A (NOLOCK)
--JOIN PID01106 B (NOLOCK) ON B.MRR_ID=A.MRR_ID
--JOIN @PUR_DETAILS C ON  C.ARTICLE_CODE=B.ARTICLE_CODE 
--JOIN LMV01106 LMV (NOLOCK) ON A.AC_CODE=LMV.AC_CODE 
--			AND C.PARA1_CODE=B.PARA1_CODE
--			AND C.PARA2_CODE=B.PARA2_CODE
--			AND C.PARA3_CODE=B.PARA3_CODE
--			AND C.PARA4_CODE=B.PARA4_CODE
--			AND C.PARA5_CODE=B.PARA5_CODE
--			AND C.PARA6_CODE=B.PARA6_CODE
--WHERE A.MRR_ID<>@CMRR_ID
--GROUP BY LMV.AC_NAME,A.MRR_NO,A.INV_DT, B.PURCHASE_PRICE,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,
--B.PARA3_CODE,B.PARA4_CODE,B.PARA5_CODE,B.PARA6_CODE
--ORDER BY A.INV_DT DESC

IF @BONLYCURSOR=0
BEGIN
	SELECT  LMV.AC_NAME,A.MRR_NO,A.INV_DT, B.PURCHASE_PRICE,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,
	B.PARA3_CODE,B.PARA4_CODE,B.PARA5_CODE,B.PARA6_CODE,A.DISCOUNT_PERCENTAGE,
	ROW_NUMBER() OVER (PARTITION BY  B.PURCHASE_PRICE,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,
	B.PARA3_CODE,B.PARA4_CODE,B.PARA5_CODE,B.PARA6_CODE ORDER BY  A.INV_DT DESC,A.MRR_NO) AS [ROW_NO]
	FROM PIM01106 A (NOLOCK)
	JOIN PID01106 B (NOLOCK) ON B.MRR_ID=A.MRR_ID
	JOIN LM01106 LMV (NOLOCK) ON A.AC_CODE=LMV.AC_CODE 
	LEFT OUTER JOIN @PUR_DETAILS C ON  C.ARTICLE_CODE=B.ARTICLE_CODE 
				AND C.PARA1_CODE=B.PARA1_CODE
				AND C.PARA2_CODE=B.PARA2_CODE
				AND C.PARA3_CODE=B.PARA3_CODE
				AND C.PARA4_CODE=B.PARA4_CODE
				AND C.PARA5_CODE=B.PARA5_CODE
				AND C.PARA6_CODE=B.PARA6_CODE
				
	WHERE A.MEMO_TYPE=(CASE WHEN @BESTIMATE=1 THEN A.MEMO_TYPE ELSE 0 END)
	AND A.MRR_ID<>@CMRR_ID
	GROUP BY LMV.AC_NAME,A.MRR_NO,A.INV_DT, B.PURCHASE_PRICE,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,
	B.PARA3_CODE,B.PARA4_CODE,B.PARA5_CODE,B.PARA6_CODE,A.DISCOUNT_PERCENTAGE
	ORDER BY A.INV_DT DESC,A.MRR_NO
END
ELSE
BEGIN
	SELECT  LMV.AC_NAME,A.MRR_NO,A.INV_DT, B.PURCHASE_PRICE,B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,
	B.PARA3_CODE,B.PARA4_CODE,B.PARA5_CODE,B.PARA6_CODE,A.DISCOUNT_PERCENTAGE,	0 AS [ROW_NO]
	FROM PIM01106 A (NOLOCK)
	JOIN PID01106 B (NOLOCK) ON B.MRR_ID=A.MRR_ID
	JOIN LM01106 LMV (NOLOCK) ON A.AC_CODE=LMV.AC_CODE 
	WHERE 1=2

END



END
