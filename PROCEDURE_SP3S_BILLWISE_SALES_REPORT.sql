CREATE PROCEDURE SP3S_BILLWISE_SALES_REPORT  --(LocId 3 digit change by Sanjay:04-11-2024)
(  
 @DFM_DT DATETIME,  
 @DTO_DT DATETIME,  
 @CDEPT_ID VARCHAR(4)=''  
)  
--WITH ENCRYPTION  
AS  
BEGIN  
       
  IF OBJECT_ID('TEMPDB..#TMP','U') IS NOT NULL  
     DROP TABLE TEMPDB..#TMP  
  
  SELECT SR=ROW_NUMBER () OVER (ORDER BY A.CM_NO),   
  (A.CM_NO),A.NET_AMOUNT,A.COPIES_PTD ,CASE WHEN ISNULL(A.EDIT_COUNT,0) =0 THEN 0 ELSE 1 END AS MODIFIED  
  INTO #TMP    
  FROM CMM01106 A    
  --LEFT OUTER JOIN   
  --(  
  --SELECT CM_ID FROM CMD01106_AUDIT   
  --GROUP BY CM_ID  
  --)B ON A.CM_ID=B.CM_ID  
     WHERE A.CM_DT BETWEEN @DFM_DT AND @DTO_DT  
  AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)  
  
  
  --SELECT COPIES_PTD,* FROM CMM01106
   
  
  DECLARE @MAXCOL INT,@MINSR INT ,@MAXSR INT,  
    @COLNAME VARCHAR(100),@COLNAME1 VARCHAR(100),@COLNAME2 VARCHAR(100),@COLNAME3 VARCHAR(100),  
    @DTSQL NVARCHAR(MAX),@AUTOSR INT,@GROUPSR INT  
            
  SET @MAXCOL=45  
  
  SET @MINSR =1  
  SET @MAXSR =2  
  SET @GROUPSR=1  
  
  IF OBJECT_ID('TEMPDB..#TMPRESULT','U') IS NOT NULL  
     DROP TABLE #TMPRESULT  
  
  SELECT GROUPSR=@GROUPSR, AUTOSR=SR, SR,CM_NO,NET_AMOUNT,COPIES_PTD,ISNULL(MODIFIED,0) AS MODIFIED  INTO #TMPRESULT FROM #TMP WHERE SR<=@MAXCOL  
  
  DELETE FROM #TMP WHERE SR IN  
  (SELECT AUTOSR FROM #TMPRESULT)  
  
  WHILE @MINSR<=@MAXSR  
  BEGIN  
  
  SET @COLNAME='CM_NO'+LTRIM(STR (@MINSR))  
  SET @COLNAME1='NET_AMOUNT'+LTRIM(STR (@MINSR))  
  SET @COLNAME2='COPIES_PTD'+LTRIM(STR (@MINSR))  
  SET @COLNAME3='MODIFIED'+LTRIM(STR (@MINSR))  
  SET @DTSQL=N'ALTER TABLE #TMPRESULT ADD 
             '+@COLNAME+' VARCHAR(100) , 
             '+@COLNAME1+' NUMERIC(18,2),
             '+@COLNAME2+' INT,
             '+@COLNAME3+' INT'  
  PRINT @DTSQL  
  EXEC SP_EXECUTESQL @DTSQL  
  
  
  SET @DTSQL=N'UPDATE A SET AUTOSR=B.SR,
       '+@COLNAME+'=B.CM_NO,  
       '+@COLNAME1+'=B.NET_AMOUNT,  
       '+@COLNAME2+'=B.COPIES_PTD,  
       '+@COLNAME3+'=B.MODIFIED  
       
  FROM #TMPRESULT A  
  JOIN  
  (  
  SELECT  SR,(CM_NO),NET_AMOUNT,COPIES_PTD,ISNULL(MODIFIED,0) AS MODIFIED, NEWSR=ROW_NUMBER () OVER (ORDER BY SR)  
  FROM #TMP  
  )B ON A.SR=B.NEWSR  
  '  
  
  PRINT @DTSQL  
  EXEC SP_EXECUTESQL @DTSQL  
  
  
  DELETE FROM #TMP WHERE SR IN  
  (SELECT AUTOSR FROM #TMPRESULT)  
  
  
  SET @MINSR=@MINSR+1  
  END  
  
  
  WHILE (SELECT COUNT(*) FROM #TMP)>0  
  BEGIN  
  SET @MINSR =0  
  SET @MAXSR =2  
  SET @AUTOSR=(SELECT MIN(SR) FROM #TMP)  
  SET @GROUPSR=@GROUPSR+1  
  WHILE @MINSR<=@MAXSR  
  BEGIN  
  
  SET @COLNAME='CM_NO'+LTRIM(STR (@MINSR))  
  SET @COLNAME1='NET_AMOUNT'+LTRIM(STR (@MINSR))  
  SET @COLNAME2='COPIES_PTD'+LTRIM(STR (@MINSR))  
  SET @COLNAME3='MODIFIED'+LTRIM(STR (@MINSR))  
   
    
  IF @MINSR=0  
  BEGIN  
  SET @DTSQL=N'INSERT INTO #TMPRESULT(GROUPSR,AUTOSR,CM_NO,NET_AMOUNT,COPIES_PTD,MODIFIED,SR)  
  SELECT '+STR(@GROUPSR)+', SR,CM_NO,NET_AMOUNT,COPIES_PTD,MODIFIED,NEWSR  
  FROM   
  (  
  SELECT  SR,CM_NO,NET_AMOUNT,COPIES_PTD,ISNULL(MODIFIED,0) AS MODIFIED, NEWSR=ROW_NUMBER () OVER (ORDER BY SR)  
  FROM #TMP  
  )B WHERE NEWSR<=52'  
  PRINT @DTSQL  
  EXEC SP_EXECUTESQL @DTSQL  
  END  
  ELSE  
  BEGIN  
  SET @DTSQL=N'UPDATE A SET AUTOSR=B.SR,
       '+@COLNAME+'=B.CM_NO,  
       '+@COLNAME1+'=B.NET_AMOUNT,  
       '+@COLNAME2+'=B.COPIES_PTD,  
       '+@COLNAME3+'=B.MODIFIED  
         
         
  FROM #TMPRESULT A  
  JOIN  
  (  
  SELECT  SR,CM_NO,NET_AMOUNT,COPIES_PTD,ISNULL(MODIFIED,0) AS MODIFIED, NEWSR=ROW_NUMBER () OVER (ORDER BY SR)  
  FROM #TMP  
  )B ON A.SR=B.NEWSR AND A.AUTOSR>='+STR(@AUTOSR)+''  
  PRINT @DTSQL  
  EXEC SP_EXECUTESQL @DTSQL  
  
  
  END  
  
  DELETE FROM #TMP WHERE SR IN  
  (SELECT AUTOSR FROM #TMPRESULT)  
  
  
  SET @MINSR=@MINSR+1  
  END  
  
  END  
  --SET @DTSQL=N'UPDATE A SET '+@COLNAME+'=ISNULL('+@COLNAME+',''''),'+@COLNAME1+'=ISNULL('+@COLNAME1+',0),  '+@COLNAME2+'=ISNULL('+@COLNAME2+',0),  '+@COLNAME3+'=ISNULL('+@COLNAME3+',0)
       
  --FROM #TMPRESULT A  '
  -- PRINT @DTSQL  
  --EXEC SP_EXECUTESQL @DTSQL  
  
  SELECT *  FROM #TMPRESULT A   
 ORDER BY GROUPSR ,SR   
  
           
         SELECT DEPT_ID, DEPT_NAME FROM LOCATION WHERE DEPT_ID=@CDEPT_ID  
           
         SELECT COALESCE(VALUE,0) AS CHKCOPY FROM CONFIG WHERE CONFIG_OPTION ='CHKCOPY'  
           
          SELECT COALESCE(VALUE,0) AS CHKMODIFY FROM CONFIG WHERE CONFIG_OPTION='CHKMODIFY'  
  
  
END  
--END OF PROCEDURE SP3S_BILLWISE_SALES_REPORT  