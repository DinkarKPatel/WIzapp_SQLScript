CREATE PROCEDURE SP3S_PRTPRINT_DYNAMIC
(
@cMemoId VARCHAR(40),
@CWHERE NVARCHAR(50)='',
@cuserCode varchar(10)=''

)
AS
BEGIN
	 SET NOCOUNT ON

	   DECLARE @cCmdCols NVARCHAR(MAX),@cCmd NVARCHAR(MAX),@cCols VARCHAR(MAX),@cCmd1 NVARCHAR(MAX),@cCmd2 NVARCHAR(MAX),
	           @cCmd3 NVARCHAR(MAX),@PARA1 NVARCHAR(10),@PARA2 NVARCHAR(10),@PARA3 NVARCHAR(10),@PARA4 NVARCHAR(10),
			   @PARA5 NVARCHAR(10),@PARA6 NVARCHAR(10),@cnullableCols varchar(max),@cboxfilter varchar(1000),@GSTINVOICE_WITHOUT_STARS varchar(5)
	   
		 
		 set @cboxfilter=''
		 if isnull(@CWHERE,'')<>''
		 SET @cboxfilter= N' AND rmd01106.box_no in ('+@CWHERE+')'

		 SELECT A.PARCEL_MEMO_ID,ANGM.ANGADIA_NAME AS TRANSPORTER_NAME,A.BILTY_NO AS BILTY_NO,                  
			CAST(A.RECEIPT_DT AS DATE) AS BILTY_DATE,SUM(B.BOX_NO) AS BOX_NO,SUM(QTY) AS WGHT,                  
			B.REF_MEMO_ID AS XN_ID,A.VEHICLE_NO,CAST(A.TOT_QTY AS VARCHAR) AS DISP_WEIGHT,  
            CAST(A.TOT_BOXES AS VARCHAR)AS DISP_BOX_NO     
			into #tmpparcel
		   FROM PARCEL_MST A (NOLOCK)                  
		   JOIN PARCEL_DET B (NOLOCK) ON A.PARCEL_MEMO_ID =B.PARCEL_MEMO_ID                             
		   LEFT OUTER JOIN ANGM (NOLOCK) ON ANGM.ANGADIA_CODE =A.ANGADIA_CODE                   
		   WHERE A.XN_TYPE ='PRT' AND B.REF_MEMO_ID=@cMemoId                 
		   GROUP BY ANGM.ANGADIA_NAME ,A.PARCEL_MEMO_ID ,A.BILTY_NO ,B.REF_MEMO_ID,A.VEHICLE_NO,A.RECEIPT_DT,A.TOT_QTY,A.TOT_BOXES


		   IF OBJECT_ID('TEMPDB..#TMPLMV01106','U') IS NOT NULL
		     DROP TABLE #TMPLMV01106

		 DECLARE @NTAXABLEVALUE NUMERIC(14,2),@NIGST_AMOUNT NUMERIC(14,2),@NCGST_AMOUNT NUMERIC(14,2),@NSGST_AMOUNT NUMERIC(14,2)
		
		  SELECT    @NTAXABLEVALUE=ISNULL(RMD.XN_VALUE_WITHOUT_GST,0)+ ISNULL(RMM.OTHER_CHARGES_TAXABLE_VALUE,0)+ ISNULL(RMM.FREIGHT_TAXABLE_VALUE,0),

			    @NIGST_AMOUNT=ISNULL(RMD.IGST_AMOUNT,0)+ISNULL(RMM.OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(RMM.FREIGHT_IGST_AMOUNT,0),
			    @NCGST_AMOUNT=ISNULL(RMD.CGST_AMOUNT,0)+ISNULL(RMM.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(RMM.FREIGHT_CGST_AMOUNT,0),
			    @NSGST_AMOUNT=ISNULL(RMD.SGST_AMOUNT,0)+ ISNULL(RMM.OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(RMM.FREIGHT_SGST_AMOUNT,0)
		FROM RMM01106  RMM (NOLOCK)
		JOIN 
		( 
		   SELECT RM_ID ,
		          SUM(XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST,
				  SUM(IGST_AMOUNT ) AS IGST_AMOUNT,
				  SUM(CGST_AMOUNT ) AS CGST_AMOUNT,
				  SUM(SGST_AMOUNT) AS SGST_AMOUNT
		   FROM RMD01106 RMD (NOLOCK)
		   WHERE RMD.RM_ID=@CMEMOID
		   GROUP BY RM_ID
		 ) RMD ON RMM.RM_ID =RMD.RM_ID 
		 WHERE RMM.RM_ID=@cMemoId 

		
		SELECT TOP 1 @GSTINVOICE_WITHOUT_STARS =VALUE FROM USER_ROLE_DET A(NOLOCK)    
	   JOIN USERS B(NOLOCK) ON A.ROLE_ID=B.ROLE_ID    
	   WHERE USER_CODE=@CUSERCODE    
	   AND FORM_NAME='Miscellaneous'     
	   AND FORM_OPTION='GSTINVOICE_WITHOUT_STARS' 
	   set @GSTINVOICE_WITHOUT_STARS=ISNULL(@GSTINVOICE_WITHOUT_STARS,'')  
	    
		SELECT ISNULL(lm.AC_GST_NO,'') AS  LMV1AC_GST_NO ,ISNULL(lm.AC_GST_NO,'')AS LMVAC_GST_NO,RM_ID,@GSTINVOICE_WITHOUT_STARS as GSTINVOICE_WITHOUT_STARS
		 INTO #TMPLMV01106 
		FROM rmm01106 rmm (NOLOCK)                                                                                 
	    LEFT JOIN LMp01106 LM (NOLOCK) ON LM.AC_CODE=rmm.AC_CODE                                          
		WHERE rmm.rm_id=@cMemoId 

        SELECT TOP 1 @PARA1=VALUE FROM CONFIG WHERE config_option='PARA1_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA2=VALUE FROM CONFIG WHERE config_option='PARA2_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA3=VALUE FROM CONFIG WHERE config_option='PARA3_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA4=VALUE FROM CONFIG WHERE config_option='PARA4_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA5=VALUE FROM CONFIG WHERE config_option='PARA5_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA6=VALUE FROM CONFIG WHERE config_option='PARA6_caption' AND ISNULL(VALUE,'') <>''
	    SET @PARA1=CASE WHEN ISNULL(@PARA1,'')='' THEN 'Para1' ELSE ISNULL(@PARA1,'') END
	    SET @PARA2=CASE WHEN ISNULL(@PARA2,'')='' THEN 'Para2' ELSE ISNULL(@PARA2,'') END
	    SET @PARA3=CASE WHEN ISNULL(@PARA3,'')='' THEN 'Para3' ELSE ISNULL(@PARA3,'') END
	    SET @PARA4=CASE WHEN ISNULL(@PARA4,'')='' THEN 'Para4' ELSE ISNULL(@PARA4,'') END
	    SET @PARA5=CASE WHEN ISNULL(@PARA5,'')='' THEN 'Para5' ELSE ISNULL(@PARA5,'') END
	    SET @PARA6=CASE WHEN ISNULL(@PARA6,'')='' THEN 'Para6' ELSE ISNULL(@PARA6,'') END
	   
	    SELECT @cCols=COALESCE(@cCols+',','')+column_name+' ['+DISPLAY_COLUMN_NAME+']' 
	    FROM dynamic_print_cols	
	    WHERE LTRIM(RTRIM(xn_type))='PRT' AND selected=1
		and column_name<>'SizeQtyString'

		SELECT @cnullableCols=COALESCE(@cnullableCols+',','')+'NULL as '+' ['+DISPLAY_COLUMN_NAME+']' 
		FROM dynamic_print_cols	
	    WHERE LTRIM(RTRIM(xn_type))='PRT' AND selected=0
		and column_name<>'SizeQtyString'


	    SELECT BOX_NO ,CAST(0 AS NUMERIC(14,3)) AS GROSSWEIGHT
		      INTO #TMPXNWEIGHTBOXES
		FROM XNBOXDETAILS A (NOLOCK) WHERE 1=2


		IF CHARINDEX ('GROSSWEIGHT',@CCOLS)>0
		BEGIN
            
			 INSERT INTO #TMPXNWEIGHTBOXES(BOX_NO,GROSSWEIGHT)
			 SELECT A.BOX_NO , ISNULL(XNITEMWEIGHT,0)+ISNULL(EMPTYBOXWEIGHT,0) AS GROSSWEIGHT
			 FROM XNBOXDETAILS A (NOLOCK)
			 WHERE A.REF_MEMO_ID =@CMEMOID AND XN_TYPE ='PRT'
		
	
		END

		SET @cnullableCols=ISNULL(@cnullableCols,'')
		IF ISNULL(@cnullableCols,'')<>''
		   SET @cnullableCols=','+ISNULL(@cnullableCols,'')

	
	   
	   DECLARE @NAME VARCHAR(300)
	   SELECT @NAME=COALESCE(@NAME,'')+ISNULL(M.PAYMODE_NAME,'CREDIT ISSUED')+':'+CONVERT(VARCHAR,ISNULL(P.amount,I.TOTAL_AMOUNT))+'; '
	   FROM RMM01106 I (NOLOCK)
	   LEFT JOIN PAYMODE_XN_DET P (NOLOCK)
	   JOIN PAYMODE_MST M (NOLOCK) ON M.PAYMODE_CODE=ISNULL(P.paymode_code,'0000004') ON I.RM_ID=P.memo_id AND P.xn_type='PRT'
	   WHERE I.RM_ID=@cMemoId
	   SET @NAME=RTRIM(@NAME)
	   IF RIGHT(@NAME,1)=';' SET @NAME=LEFT(@NAME,LEN(@NAME)-1)

	   set @NAME=isnull(@NAME,'')

	 

	     DECLARE @CSPID VARCHAR(50),@CTABLENAME VARCHAR(50)

		SET @CSPID=LTRIM(RTRIM(STR(@@SPID )))
		SET @CTABLENAME  ='##TMPINVPRINT'+@CSPID

		SET @CCMD = N'IF OBJECT_ID(''TEMPDB..'+@CTABLENAME+''',''U'') IS NOT NULL
			DROP TABLE '+@CTABLENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
                

	   SET @cCmdCols=N'
	   SELECT '+@cCols+',
	   '''+@para1 +''' AS PARA1_CONFIG,'''+@PARA2 +''' AS PARA2_CONFIG,'''+@PARA3 +''' AS PARA3_CONFIG,
	   '''+@PARA4 +''' AS PARA4_CONFIG,'''+@PARA5 +''' AS PARA5_CONFIG,'''+@PARA6 +''' AS PARA6_CONFIG,

	   '+RTRIM(LTRIM(STR(@NTAXABLEVALUE ,14,2)))+' as Total_Taxable_value,
	   '+RTRIM(LTRIM(STR(@NIGST_AMOUNT,14,2)))+' as Total_Igst_Amount,
	   '+RTRIM(LTRIM(STR(@NSGST_AMOUNT,14,2)))+' as Total_Sgst_Amount,
	   '+RTRIM(LTRIM(STR(@NCGST_AMOUNT,14,2)))+' as Total_Cgst_amount,

	   DBO.FN_CONVERTAMOUNTINWORDS(rmm.total_amount) AS  NET_AMOUNT_IN_WORDS,
	   DBO.FN_CONVERTAMOUNTINWORDS(rmm.Total_Gst_Amount) GST_AMOUNT_IN_WORDS,
	   cast(NULL AS VARBINARY(MAX)) AS QRCODEIMAGE,
	   dnps.PS_NO,dnps.PS_DT,RMM.location_code,'''+@NAME+''' PAYMENT_DETAILS '+@cnullableCols
	   +' INTO '+@CTABLENAME+' '
	   SET @cCmd=N'  FROM RMD01106  (NOLOCK)  
	   JOIN RMM01106 RMM (NOLOCK) ON RMM.RM_ID=RMD01106.RM_ID       
	   JOIN GST_COMPANY_CONFIG COM(NOLOCK) ON 1=1 AND COM.XN_TYPE=''PRT''
	   LEFT JOIN COMPANY CMP (NOLOCK) ON CMP.COMPANY_CODE=''01''   
	   LEFT JOIN (SELECT PS_ID,PS_NO,PS_DT FROM DNPS_MST (nolock) ) dnps ON dnps.PS_ID=rmd01106.ps_id   
	   LEFT OUTER JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID =CASE WHEN ISNULL(RMM.ACCOUNTS_DEPT_ID ,'''')<>'''' THEN RMM.ACCOUNTS_DEPT_ID ELSE RMM.Location_code END
	   LEFT JOIN AREA SLA (NOLOCK) ON SL.AREA_CODE=SLA.AREA_CODE                  
	   LEFT JOIN CITY SLC (NOLOCK) ON SLA.CITY_CODE=SLC.CITY_CODE                  
	   LEFT JOIN GST_STATE_MST SLS (NOLOCK) ON SLS.GST_STATE_CODE=SL.GST_STATE_CODE
	   LEFT JOIN STATE SLST (nolock) on SL.gst_state_code =SLST.state_code
	   LEFT JOIN REGIONM SLR (NOLOCK) ON SLST.region_code=SLR.region_code  

	   LEFT JOIN LMP01106 PRLMP (NOLOCK) ON PRLMP.AC_CODE=rmm.AC_CODE                  
	   LEFT JOIN GST_STATE_MST PRS (NOLOCK) ON PRS.GST_STATE_CODE=PRLMP.AC_GST_STATE_CODE     
	   LEFT JOIN LM01106 PRLM (NOLOCK) ON PRLM.AC_CODE=PRLMP.AC_CODE                  
	   LEFT JOIN AREA PRA (NOLOCK) ON PRLMP.AREA_CODE=PRA.AREA_CODE                  
	   LEFT JOIN CITY PRC (NOLOCK) ON PRA.CITY_CODE=PRC.CITY_CODE 
	   LEFT JOIN STATE PRST(NOLOCK) ON PRC.state_code=PRST.state_code

	   LEFT JOIN REGIONM PRR(NOLOCK) ON PRST.region_code=PRR.region_code  
	   LEFT OUTER JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID=rmm.PARTY_DEPT_ID                  
	   LEFT JOIN AREA TLA (NOLOCK) ON TL.AREA_CODE=TLA.AREA_CODE                  
	   LEFT JOIN CITY TLC (NOLOCK) ON TLA.CITY_CODE=TLC.CITY_CODE                  
	   LEFT JOIN GST_STATE_MST TLS (NOLOCK) ON TLS.GST_STATE_CODE=TL.GST_STATE_CODE                  
	   left join state TLST (nolock) on TLST.state_code=TL.gst_state_code
	   left join regionm TLR (nolock) on TLR.region_code=TLST.region_code

	   LEFT JOIN LM01106 SHLM (NOLOCK) ON SHLM.AC_CODE=RMM.SHIPPING_AC_CODE 
	   LEFT JOIN #TMPLMV01106 TMP (NOLOCK) ON TMP.RM_ID=RMM.RM_ID 
	   LEFT JOIN LMP01106 SHLMP (NOLOCK) ON SHLMP.AC_CODE=RMM.SHIPPING_AC_CODE 
       LEFT JOIN AREA SHAR (NOLOCK) ON SHLMP.AREA_CODE=SHAR.AREA_CODE                        
       LEFT JOIN CITY SHCT (NOLOCK) ON SHAR.CITY_CODE=SHCT.CITY_CODE  
	   LEFT JOIN GST_STATE_MST SHCS (NOLOCK) ON SHCS.GST_STATE_CODE=SHLMP.AC_GST_STATE_CODE  
	   LEFT JOIN GST_STATE_MST SHST (NOLOCK) ON SHST.GST_STATE_CODE=SHLMP.AC_GST_STATE_CODE     
	   LEFT JOIN USERS U (NOLOCK) ON U.USER_CODE=RMM.USER_CODE
	   LEFT JOIN USERS U1 (NOLOCK) ON U1.USER_CODE=RMM.EDT_USER_CODE
	    LEFT JOIN #TMPXNWEIGHTBOXES XNBOX ON XNBOX.BOX_NO=RMD01106.BOX_NO
	   '
	   SET @cCmd1=N' LEFT OUTER JOIN #tmpparcel TR ON TR.XN_ID=rmm.rm_id                  
	   LEFT OUTER JOIN LM01106 BN (NOLOCK) ON rmm.BROKER_AC_CODE=BN.AC_CODE
	   
	   LEFT OUTER JOIN LM01106 OEMLM (NOLOCK) ON OEMLM.AC_CODE=RMM.OEM_AC_CODE
	   LEFT JOIN LMP01106 OEMLMP (NOLOCK) ON OEMLMP.AC_CODE=RMM.OEM_AC_CODE
       LEFT JOIN AREA OEMA (NOLOCK) ON OEMA.AREA_CODE =OEMLMP.AREA_CODE                       
       LEFT JOIN CITY OEMC (NOLOCK) ON OEMC.CITY_CODE =OEMA.CITY_CODE
	   LEFT JOIN GST_STATE_MST OEMS (NOLOCK) ON OEMS.GST_STATE_CODE=OEMLMP.AC_GST_STATE_CODE 
	   '
               
       SET @cCmd2=N'
       JOIN SKU (NOLOCK) ON sku.product_CODE=rmd01106.product_code     
	   join sku_names (nolock) on sku.product_code=sku_names.product_code   
       JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE '        
       
       SET @cCmd3=N' 
       LEFT JOIN UOM UOM (NOLOCK) ON UOM.UOM_CODE=ARTICLE.UOM_CODE                  
       LEFT OUTER JOIN (SELECT TNC_1,TNC_2,TNC_3,TNC_4,TNC_5,TNC_6,TNC_7,TNC_8 FROM GST_TNC WHERE XN_TYPE=''WSL'')GST_TNC  ON 1=1
	   WHERE RMM.RM_ID='''+@cMemoId+''' '+@cboxfilter
       print @cCmd
       PRINT @ccmd1
       PRINT @ccmd2
       PRINT @ccmd3
     
       EXEC(@cCmdCols+@cCmd+@ccmd1+@ccmd2+@ccmd3)


	   DECLARE  @CERRMSG VARCHAR(100),@CsizeQTY VARCHAR(1000)
	   SET @CsizeQTY=''

	    IF EXISTS (SELECT TOP 1 'U'  FROM dynamic_print_cols	WHERE LTRIM(RTRIM(xn_type))='PRT' AND selected=1 and DISPLAY_COLUMN_NAME='SizeQtyString')
	   BEGIN
	        SET @CsizeQTY=N',(SELECT STUFF((SELECT CASE WHEN ISNULL(para2_name,'''') <> '''' THEN ''  '' ELSE '''' END +para2_name+ ''/''+RTRIM(LTRIM(STR((SUM(QUANTITY)))))  
		     FROM '+@CTABLENAME+'  B  WHERE A.article_no  =B.article_no AND A.para1_name =B.para1_name AND A.RATE=B.RATE
			 GROUP BY ARTICLE_no,PARA1_NAME,RATE,CASE WHEN ISNULL(para2_name,'''') <> '''' THEN ''  '' ELSE '''' END +para2_name	 FOR XML PATH('''')),1,2,''''))  	 as [SIZEQTY]'
		END
	
	   
 END_PROC:

	   IF ISNULL(@CERRMSG,'')<>'' 
	   BEGIN
		   SELECT @CERRMSG AS ERRMSG 
	   END
	   ELSE 
	   BEGIN
	        
		SET @CCMD = N'SELECT * '+@CsizeQTY+' FROM '+@CTABLENAME+' a '
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
	   END
	   --  select *  INTO PRTPRINT from ##TMPINVPRINT

	   SET @CCMD = N'IF OBJECT_ID(''TEMPDB..'+@CTABLENAME+''',''U'') IS NOT NULL
			DROP TABLE '+@CTABLENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

		
END



