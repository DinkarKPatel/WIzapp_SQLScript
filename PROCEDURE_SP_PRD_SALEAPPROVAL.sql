CREATE PROCEDURE SP_PRD_SALEAPPROVAL        
(        
  @IMODE INT ,        
  @CWHERE VARCHAR(4000)='',        
  @CFINYEAR VARCHAR(5)='',        
  @NNAVMODE NUMERIC(2,0)=0,        
  @CWHERECLAUSE VARCHAR(4000)=''        
) 
--WITH ENCRYPTION       
AS 
BEGIN         
         
 IF @IMODE=1 ------GET CUSTOMER-------        
 GOTO LBL1        
         
 ELSE IF @IMODE=2 ------GET PRD_APM01106 MASTER BY MEMOID-------        
 GOTO LBL2        
         
 ELSE IF @IMODE=3 ------GET PRD_APD01106 DETAIL BY MEMOID-------        
 GOTO LBL3        
         
 ELSE IF @IMODE=4 ------FOR LOOKUP-------        
 GOTO LBL4        
         
 ELSE IF @IMODE=5 ------FOR PENDING QUANTITY---------------        
 GOTO LBL5        
         
 ELSE IF @IMODE=6 ------FETCH CUSTOMER INFO BY CUST CODE---------------        
 GOTO LBL6        
         
 ELSE IF @IMODE=7 ------CHECK APPROVAL SETTLEMENT---------------        
 GOTO LBL7        
         
 ELSE IF @IMODE=8 ------CHECK REFERENCE BILL IN CMM01106---------------        
 GOTO LBL8        
      
 ELSE IF @IMODE=9 ------TABLE FOR PENDING APPROVAL & CURRENT YEAR APPROVALS      
 GOTO LBL9        
       
 ELSE IF @IMODE=10       
 GOTO LBL10        
     
 ELSE IF @IMODE=11      
 GOTO LBLPENDING            
 
 ELSE IF @IMODE=12     
 GOTO LBLRETURN 
          
 ELSE        
 GOTO LAST        
         
LBL1:        
         
    SELECT A.CUSTOMER_CODE, ISNULL(A.CUSTOMER_FNAME,'') + '' + ISNULL(A.CUSTOMER_LNAME,'') AS NAME,        
    ISNULL(A.ADDRESS1,'') + '' + ISNULL(A.ADDRESS2,'') + '' +        
    ISNULL(C.CITY,'') + '' + ISNULL(D.STATE,'') AS ADDRESS        
    FROM CUSTDYM A (NOLOCK)        
    LEFT JOIN AREA B (NOLOCK) ON A.AREA_CODE = B.AREA_CODE        
    LEFT JOIN CITY C (NOLOCK) ON B.CITY_CODE = C.CITY_CODE        
    LEFT JOIN STATE D (NOLOCK) ON C.STATE_CODE = D.STATE_CODE        
    WHERE A.CUSTOMER_FNAME <> '' AND A.CUSTOMER_LNAME <> ''        
                  
 GOTO LAST        
         
LBL2:        
             
 SELECT TOP 1 A.*,U.USERNAME,ISNULL(B.USER_CUSTOMER_CODE,'') AS USER_CUSTOMER_CODE,B.CUSTOMER_TITLE
  ,(PRE.PREFIX_NAME +''+ B.CUSTOMER_FNAME) AS CUSTOMER_FNAME ,CUSTOMER_LNAME,B.ADDRESS1,B.ADDRESS2,'' AS ADDRESS,        
 C.AREA_NAME AS AREA,C.PINCODE,D.CITY,E.STATE, A.REF_NO,T4.AC_NAME,B.ADDRESS9, B.CARD_NO ,B1.BIN_NAME       
 FROM PRD_APM01106 A  
 JOIN USERS U (NOLOCK) ON U.USER_CODE=A.USER_CODE          
 LEFT JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE
 LEFT JOIN PREFIX PRE ON PRE.PREFIX_CODE=B.PREFIX_CODE       
 LEFT JOIN LMV01106 T4 ON T4.AC_CODE = A.AC_CODE         
 LEFT JOIN AREA C ON B.AREA_CODE = C.AREA_CODE        
 LEFT JOIN CITY D ON C.CITY_CODE = D.CITY_CODE        
 LEFT JOIN STATE E ON D.STATE_CODE = E.STATE_CODE
 LEFT OUTER JOIN BIN B1 ON B1.BIN_ID=A.BIN_ID        
 WHERE A.MEMO_ID = @CWHERE           
         
 GOTO LAST         
         
LBL3:        
         
         
    SELECT CONVERT(BIT,0) AS CHKITEM,A.MEMO_ID,B.PRODUCT_CODE,B.QUANTITY,B.MRP,B.NET,D.MRP AS TEMPMRP,        
    B.ROW_ID,B.EMP_CODE,B.MRP,B.RFNET,D.DT_CREATED AS SKU_DT_CREATED, E.DT_CREATED AS ART_DT_CREATED,E.ARTICLE_NO,             
    F.PARA1_CODE,F.PARA1_NAME , G.PARA2_CODE , G.PARA2_NAME,H.SUB_SECTION_NAME, I.SECTION_NAME,        
    J.DT_CREATED AS PARA3_DT_CREATED,J.PARA3_NAME,K.PARA4_NAME,L.PARA5_NAME,M.PARA6_NAME,        
    UOM.UOM_TYPE, D.MRP ,'' AS PRODUCT_NAME, UOM.UOM_CODE , UOM.UOM_NAME       
    ,B.EMP_CODE1,B.EMP_CODE2 , B.QUANTITY AS ISSUE_QUANTITY,ISNULL(RET.RET_QTY,0) AS RET_QTY ,  
    D.WS_PRICE,EMP.EMP_NAME,EMP1.EMP_NAME,EMP2.EMP_NAME, B.DISCOUNT_PERCENTAGE,B.DISCOUNT_AMOUNT,B.MANUAL_DISCOUNT,
    ((B.QUANTITY*B.MRP)- B.DISCOUNT_AMOUNT) AS NET_AMOUNT,B.NET ,B.BIN_ID, B1.BIN_NAME,
    E.ALIAS AS ARTICLE_ALIAS,B.PRODUCT_UID ,B.REMARKS      
    FROM PRD_APM01106 A         
    JOIN PRD_APD01106 B ON A.MEMO_ID = B.MEMO_ID         
    JOIN PRD_SKU D ON B.PRODUCT_UID = D.PRODUCT_UID         
    LEFT JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE             
    LEFT JOIN PARA1 F ON D.PARA1_CODE = F.PARA1_CODE             
    LEFT JOIN PARA2 G ON D.PARA2_CODE = G.PARA2_CODE             
    LEFT JOIN SECTIOND H ON E.SUB_SECTION_CODE = H.SUB_SECTION_CODE             
    LEFT JOIN SECTIONM I ON H.SECTION_CODE = I.SECTION_CODE           
    LEFT JOIN PARA3 J ON D.PARA3_CODE = J.PARA3_CODE         
    LEFT JOIN PARA4 K ON D.PARA4_CODE = K.PARA4_CODE        
    LEFT JOIN PARA5 L ON D.PARA5_CODE = L.PARA5_CODE        
    LEFT JOIN PARA6 M ON D.PARA6_CODE = M.PARA6_CODE        
    JOIN UOM ON E.UOM_CODE = UOM.UOM_CODE        
    LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON B.EMP_CODE = EMP.EMP_CODE         
    LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON B.EMP_CODE1 = EMP1.EMP_CODE         
    LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON B.EMP_CODE2 = EMP2.EMP_CODE  
    LEFT OUTER JOIN      
    ( 
		SELECT A.APD_ROW_ID,SUM(A.QUANTITY) AS RET_QTY 
		FROM APPROVAL_RETURN_DET A    
		JOIN PRD_APPROVAL_RETURN_MST C ON C.MEMO_ID=A.MEMO_ID    
		WHERE C.CANCELLED=0    
		GROUP BY A.APD_ROW_ID
	)RET ON RET.APD_ROW_ID=B.ROW_ID  
	 LEFT OUTER JOIN BIN B1 ON B1.BIN_ID=B.BIN_ID        
        
 WHERE A.MEMO_ID = @CWHERE        
        
 GOTO LAST        
         
LBL4:      
   EXECUTE SP_PRD_NAVIGATE 'PRD_APM01106',@NNAVMODE,@CWHERE,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERECLAUSE  
 GOTO LAST        
         
LBL5:        
         
         
 SELECT CONVERT(BIT,0) AS CHKITEM,A.MEMO_ID,B.PRODUCT_CODE,B.QUANTITY-ISNULL(C.RET_QTY,0) AS QUANTITY,        
 B.MRP,D.MRP AS TEMPMRP,B.NET,        
 B.ROW_ID,B.EMP_CODE,B.MRP,B.RFNET,D.DT_CREATED AS SKU_DT_CREATED, E.DT_CREATED AS ART_DT_CREATED,E.ARTICLE_NO,             
 F.PARA1_CODE,F.PARA1_NAME , G.PARA2_CODE , G.PARA2_NAME,H.SUB_SECTION_NAME, I.SECTION_NAME,        
 J.DT_CREATED AS PARA3_DT_CREATED,J.PARA3_NAME, CONVERT(NUMERIC(10,2),0) AS RET_QUANTITY , D.FIX_MRP,D.PRODUCT_NAME,      
 P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME,B.EMP_CODE1,B.EMP_CODE2,EMP.EMP_NAME,EMP1.EMP_NAME,EMP2.EMP_NAME
 ,B.BIN_ID,B1.BIN_NAME,E.ALIAS AS ARTICLE_ALIAS       
 FROM PRD_APM01106 A         
 JOIN PRD_APD01106 B ON A.MEMO_ID = B.MEMO_ID         
 JOIN SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE        
 LEFT OUTER JOIN         
 (SELECT CMD_ROW_ID,SUM(A.QUANTITY) AS RET_QTY FROM PRD_CMA01106 A         
 JOIN PRD_APD01106 B ON A.CMD_ROW_ID=B.ROW_ID        
 WHERE B.MEMO_ID=@CWHERE GROUP BY CMD_ROW_ID) C ON C.CMD_ROW_ID=B.ROW_ID         
 LEFT JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE             
 LEFT JOIN PARA1 F ON D.PARA1_CODE = F.PARA1_CODE             
 LEFT JOIN PARA2 G ON D.PARA2_CODE = G.PARA2_CODE             
 LEFT JOIN SECTIOND H ON E.SUB_SECTION_CODE = H.SUB_SECTION_CODE             
 LEFT JOIN SECTIONM I ON H.SECTION_CODE = I.SECTION_CODE           
 LEFT JOIN PARA3 J ON D.PARA3_CODE = J.PARA3_CODE       
 LEFT JOIN PARA4 P4 ON P4.PARA4_CODE = D.PARA4_CODE       
 LEFT JOIN PARA5 P5 ON P5.PARA5_CODE = D.PARA5_CODE       
 LEFT JOIN PARA6 P6 ON P6.PARA6_CODE = D.PARA6_CODE       
 LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON B.EMP_CODE = EMP.EMP_CODE         
 LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON B.EMP_CODE1 = EMP1.EMP_CODE           
 LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON B.EMP_CODE2 = EMP2.EMP_CODE 
 LEFT OUTER JOIN BIN B1 ON B1.BIN_ID=B.BIN_ID        
      
 --------------------        
 WHERE A.MEMO_ID = @CWHERE AND (B.QUANTITY-ISNULL(C.RET_QTY,0)) > 0        
         
 GOTO LAST         
         
LBL6:        
         
 SELECT CUSTOMER_CODE, USER_CUSTOMER_CODE, CUSTOMER_TITLE, CUSTOMER_FNAME, CUSTOMER_LNAME,         
   ISNULL(ST.STATE,'') AS [STATE],ADDRESS1, ADDRESS2,        
   ISNULL(CI.CITY,'') AS CITY,ISNULL(B.PINCODE,'') AS PINCODE, PHONE1,         
 PHONE2, MOBILE, EMAIL        
 FROM CUSTDYM A         
 LEFT OUTER JOIN AREA B ON A.AREA_CODE = B.AREA_CODE        
 LEFT OUTER JOIN CITY CI ON B.CITY_CODE=CI.CITY_CODE        
 LEFT OUTER JOIN STATE ST ON ST.STATE_CODE=CI.STATE_CODE        
 WHERE A.INACTIVE=0 AND CUSTOMER_CODE=@CWHERE         
         
 GOTO LAST         
        
LBL7:        
    
 SELECT TOP 1 A.ROW_ID FROM PRD_APD01106 A        
    LEFT OUTER JOIN         
    (SELECT APD_ROW_ID,SUM(A.QUANTITY) AS RET_QTY FROM PRD_APPROVAL_RETURN_DET A         
  JOIN PRD_APD01106 B ON A.APD_ROW_ID=B.ROW_ID     
  JOIN PRD_APM01106 C ON C.MEMO_ID=B.MEMO_ID       
  WHERE B.MEMO_ID=@CWHERE AND C.MEMO_TYPE=@NNAVMODE GROUP BY APD_ROW_ID) B ON B.APD_ROW_ID=A.ROW_ID         
 WHERE A.MEMO_ID = @CWHERE AND A.QUANTITY-ISNULL(B.RET_QTY,0) > 0         
         
 SELECT TOP 1 A.ROW_ID FROM PRD_APD01106 A        
 LEFT OUTER JOIN         
 (SELECT APD_ROW_ID,SUM(A.QUANTITY) AS RET_QTY FROM PRD_APPROVAL_RETURN_DET A         
  JOIN PRD_APD01106 B ON A.APD_ROW_ID=B.ROW_ID      
  JOIN PRD_APM01106 C ON C.MEMO_ID=B.MEMO_ID        
  WHERE B.MEMO_ID=@CWHERE AND C.MEMO_TYPE=@NNAVMODE GROUP BY APD_ROW_ID) B ON B.APD_ROW_ID=A.ROW_ID         
 WHERE A.MEMO_ID = @CWHERE AND ISNULL(B.RET_QTY,0) > 0        
    
 GOTO LAST        
         
LBL8:        
      
 SELECT TOP 1 ISNULL( B.CM_ID,'') AS CM_ID,ISNULL( B.CM_NO,'') AS CM_NO, ISNULL(C.INV_ID,'') AS INV_ID,
 ISNULL(C.INV_NO,'') AS INV_NO     
 FROM PRD_APM01106 A         
 LEFT JOIN CMM01106 B ON A.MEMO_ID = B.REF_CM_ID        
 LEFT JOIN INM01106 C ON A.MEMO_ID = C.REF_INV_ID        
 WHERE A.MEMO_ID = @CWHERE         
       
      
LBL9:      
      
 INSERT #TMPAPP (MEMO_ID,MEMO_NO,MEMO_DT,FIN_YEAR)       
 SELECT B.MEMO_ID,B.MEMO_NO,B.MEMO_DT,B.FIN_YEAR  FROM PRD_APD01106 A         
  JOIN PRD_APM01106 B ON B.MEMO_ID=A.MEMO_ID      
  LEFT OUTER JOIN       
  (SELECT CMD_ROW_ID,SUM(A.QUANTITY) AS RETURN_QUANTITY      
   FROM PRD_CMA01106 A JOIN PRD_APD01106 B ON A.CMD_ROW_ID=B.ROW_ID      
   JOIN PRD_APM01106 C ON C.MEMO_ID=B.MEMO_ID       
   WHERE C.MEMO_DT<(DBO.FN_GETFINYEARDATE(@CFINYEAR,1))  GROUP BY CMD_ROW_ID) C ON C.CMD_ROW_ID=A.ROW_ID       
   WHERE B.MEMO_DT<(DBO.FN_GETFINYEARDATE(@CFINYEAR,1)) AND A.QUANTITY-ISNULL(C.RETURN_QUANTITY,0)>0      
   AND B.CANCELLED=0      
 UNION       
 SELECT MEMO_ID,MEMO_NO,MEMO_DT,FIN_YEAR  FROM PRD_APM01106 WHERE FIN_YEAR=@CFINYEAR      
    ORDER BY MEMO_DT,MEMO_NO    
        
      
LBL10:        
         
 SELECT CONVERT(BIT,0) AS CHKITEM,A.MEMO_ID,B.PRODUCT_CODE,CMA.QUANTITY,CONVERT(NVARCHAR(20),CMA.APR_DT,110) AS APR_DT,       
 CMA.QUANTITY AS RET_QUANTITY,B.MRP,B.NET,D.MRP AS TEMPMRP,        
 B.ROW_ID,B.EMP_CODE,B.MRP,B.RFNET,D.DT_CREATED AS SKU_DT_CREATED,       
 E.DT_CREATED AS ART_DT_CREATED,E.ARTICLE_NO,             
    F.PARA1_CODE,F.PARA1_NAME , G.PARA2_CODE ,G.PARA2_NAME,H.SUB_SECTION_NAME, I.SECTION_NAME,        
    J.DT_CREATED AS PARA3_DT_CREATED,J.PARA3_NAME,K.PARA4_NAME,L.PARA5_NAME,M.PARA6_NAME,        
    UOM.UOM_TYPE, D.MRP,'' AS PRODUCT_NAME, UOM.UOM_CODE , UOM.UOM_NAME       
    ,B.EMP_CODE1,B.EMP_CODE2,EMP.EMP_NAME,EMP1.EMP_NAME,EMP2.EMP_NAME,B.BIN_ID,B1.BIN_NAME,
    E.ALIAS AS ARTICLE_ALIAS          
    FROM PRD_APM01106 A         
    JOIN PRD_APD01106 B ON A.MEMO_ID = B.MEMO_ID         
    JOIN PRD_CMA01106 CMA ON B.ROW_ID = CMA.CMD_ROW_ID         
    JOIN PRD_SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE        
    LEFT JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE             
    LEFT JOIN PARA1 F ON D.PARA1_CODE = F.PARA1_CODE             
    LEFT JOIN PARA2 G ON D.PARA2_CODE = G.PARA2_CODE             
    LEFT JOIN SECTIOND H ON E.SUB_SECTION_CODE = H.SUB_SECTION_CODE             
    LEFT JOIN SECTIONM I ON H.SECTION_CODE = I.SECTION_CODE           
    LEFT JOIN PARA3 J ON D.PARA3_CODE = J.PARA3_CODE         
    LEFT JOIN PARA4 K ON D.PARA4_CODE = K.PARA4_CODE        
    LEFT JOIN PARA5 L ON D.PARA5_CODE = L.PARA5_CODE        
    LEFT JOIN PARA6 M ON D.PARA6_CODE = M.PARA6_CODE        
    JOIN UOM ON E.UOM_CODE = UOM.UOM_CODE        
    LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON B.EMP_CODE = EMP.EMP_CODE         
    LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON B.EMP_CODE1 = EMP1.EMP_CODE           
    LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON B.EMP_CODE2 = EMP2.EMP_CODE  
     LEFT OUTER JOIN BIN B1 ON B1.BIN_ID=B.BIN_ID        
     
 WHERE A.MEMO_ID = @CWHERE        
         
LBLPENDING:       
    
SELECT CONVERT(BIT,0) AS CHKITEM,A.MEMO_ID,B.PRODUCT_CODE,B.QUANTITY-ISNULL(C.RET_QTY,0) AS QUANTITY,        
B.MRP,D.MRP AS TEMPMRP,B.NET,A.MEMO_NO,A.MEMO_DT,        
B.ROW_ID,B.EMP_CODE,B.MRP,B.RFNET,D.DT_CREATED AS SKU_DT_CREATED, E.DT_CREATED AS ART_DT_CREATED,E.ARTICLE_NO,             
F.PARA1_CODE,F.PARA1_NAME , G.PARA2_CODE , G.PARA2_NAME,H.SUB_SECTION_NAME, I.SECTION_NAME,        
J.DT_CREATED AS PARA3_DT_CREATED,J.PARA3_NAME, CONVERT(NUMERIC(10,2),0) AS RET_QUANTITY , D.MRP ,'' AS PRODUCT_NAME,      
P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME,D.WS_PRICE        
,B.EMP_CODE1,B.EMP_CODE2,B.ROW_ID AS APD_ROW_ID        
,EMP.EMP_NAME,EMP1.EMP_NAME AS EMP_NAME1,EMP2.EMP_NAME AS EMP_NAME2,UOM.UOM_NAME ,B.BIN_ID,B1.BIN_NAME,
E.ALIAS AS ARTICLE_ALIAS          
FROM PRD_APM01106 A         
JOIN PRD_APD01106 B ON A.MEMO_ID = B.MEMO_ID         
JOIN PRD_SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE        
LEFT OUTER JOIN         
(
	SELECT APD_ROW_ID,SUM(A.QUANTITY) AS RET_QTY FROM PRD_APPROVAL_RETURN_DET A       
	JOIN PRD_APPROVAL_RETURN_MST MST ON A.MEMO_ID=MST.MEMO_ID       
	JOIN PRD_APD01106 B ON A.APD_ROW_ID=B.ROW_ID     
	JOIN PRD_APM01106 C ON C.MEMO_ID=B.MEMO_ID        
	WHERE C.MEMO_TYPE=@NNAVMODE AND C.CANCELLED=0 AND MST.CANCELLED=0    
	GROUP BY APD_ROW_ID
) C ON C.APD_ROW_ID=B.ROW_ID         
LEFT JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE           
LEFT JOIN PARA1 F ON D.PARA1_CODE = F.PARA1_CODE             
LEFT JOIN PARA2 G ON D.PARA2_CODE = G.PARA2_CODE             
LEFT JOIN SECTIOND H ON E.SUB_SECTION_CODE = H.SUB_SECTION_CODE             
LEFT JOIN SECTIONM I ON H.SECTION_CODE = I.SECTION_CODE           
LEFT JOIN PARA3 J ON D.PARA3_CODE = J.PARA3_CODE       
LEFT JOIN PARA4 P4 ON P4.PARA4_CODE = D.PARA4_CODE       
LEFT JOIN PARA5 P5 ON P5.PARA5_CODE = D.PARA5_CODE       
LEFT JOIN PARA6 P6 ON P6.PARA6_CODE = D.PARA6_CODE       
LEFT JOIN UOM ON E.UOM_CODE = UOM.UOM_CODE       
LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON B.EMP_CODE = EMP.EMP_CODE         
LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON B.EMP_CODE1 = EMP1.EMP_CODE           
LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON B.EMP_CODE2 = EMP2.EMP_CODE 
LEFT OUTER JOIN BIN B1 ON B1.BIN_ID=B.BIN_ID           
WHERE ISNULL(A.REF_CM_ID,'')='' AND A.MEMO_TYPE=@NNAVMODE AND A.MEMO_ID=@CWHERE    
AND ((@NNAVMODE=1 AND A.CUSTOMER_CODE = @CWHERECLAUSE) OR (@NNAVMODE=2 AND A.AC_CODE= @CWHERECLAUSE) )    
AND (B.QUANTITY-ISNULL(C.RET_QTY,0)) > 0         
GOTO LAST  

LBLRETURN:   

 SELECT APD_ROW_ID FROM PRD_APPROVAL_RETURN_DET A
 JOIN PRD_APD01106 APD ON A.APD_ROW_ID=APD.ROW_ID
 JOIN PRD_APM01106 APM ON APM.MEMO_ID=APD.MEMO_ID
 WHERE ISNULL(APM.REF_CM_ID,'')='' AND APM.MEMO_TYPE=@NNAVMODE AND APM.MEMO_ID=@CWHERE    
 AND ((@NNAVMODE=1 AND APM.CUSTOMER_CODE = @CWHERECLAUSE) OR (@NNAVMODE=2 AND APM.AC_CODE= @CWHERECLAUSE) )     
        
LAST:  

          
END
