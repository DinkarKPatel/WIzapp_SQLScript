CREATE PROCEDURE SP_EMP_LEAVE_DATA
(
	@CEMPID VARCHAR(20),
	@NYEAR INT, 
	@NMONTH INT
)
--WITH ENCRYPTION
AS
BEGIN
	-- SELECT @NYEAR = 2011, @NMONTH = 2

	DECLARE @NOPSLEAVECR		NUMERIC(10,2),
			@NOPSFL				NUMERIC(10,2),
			@NOPSHL				INT,
			@NOPSSL				INT,
			@NCURDRABS			NUMERIC(10,2),
			@NCURDRFL			NUMERIC(10,2),
			@NCURDRHL			INT,
			@NCURDRSL			INT,
			@NCURCRFL			NUMERIC(10,2),
			@NCURCRHL			INT,
			@NCURCRSL			INT,
			@NTEMPSL			INT,
			@NCURRENTLEAVEDR	NUMERIC(10,2),
			@NCURRENTLEAVECR	NUMERIC(10,2),
			@NCBSLEAVE			NUMERIC(10,2),
			@CLEAVECODE			VARCHAR(20),
			@NLEAVECREDIT		NUMERIC(10,2),
			@NTOTLEAVECREDIT	NUMERIC(10,2),
			@CLCMEMOID			VARCHAR(50),
			@NLWPDAYS			NUMERIC(10,2),
			@CMINPAYSLIPMONTHSTR VARCHAR(20),
			@LSLSETTLEMENT		BIT

	SET @NOPSLEAVECR = 0
	SET @NOPSFL = 0
	SET @NOPSHL = 0
	SET @NOPSSL = 0
	SET @NCURDRABS = 0
	SET @NCURDRFL = 0
	SET @NCURDRHL = 0
	SET @NCURDRSL = 0
	SET @NCURCRFL = 0
	SET @NCURCRHL = 0
	SET @NCURCRSL = 0
	SET @NTOTLEAVECREDIT = 0
	SET @LSLSETTLEMENT = 0

	IF EXISTS ( SELECT [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'SL_SETTLEMENT' AND VALUE = '1'	)
		SET @LSLSETTLEMENT = 1

	SELECT	@CMINPAYSLIPMONTHSTR = 
			MIN(DBO.FN_YEARMONTHTOSTR(PAYSLIP_YEAR, PAYSLIP_MONTH))
	FROM EMP_PAYSLIP_MST
	WHERE CANCELLED = 0
	AND   EMP_ID = @CEMPID
	
	SET @CMINPAYSLIPMONTHSTR = ISNULL(@CMINPAYSLIPMONTHSTR,'')

	IF ISNULL(@CMINPAYSLIPMONTHSTR,'') = ''
		SELECT @CMINPAYSLIPMONTHSTR =  DBO.FN_YEARMONTHTOSTR(@NYEAR, @NMONTH)

	-- GETTING OPENING BALANCE OF LEAVES CREDITED FROM LEAVE CREDIT MODULE
	IF ISNULL(@CMINPAYSLIPMONTHSTR,'') <> ''
	BEGIN
		SELECT  
				-- @NOPSLEAVECR = SUM((FL + (CAST(HL AS NUMERIC(10,2))/2) + (CAST(SL AS NUMERIC(10,2))/4))*(CASE WHEN LEAVE_MODE=2 THEN -1 ELSE 1 END)) -- AS OPS_CR
				@NOPSFL = SUM(FL * (CASE WHEN LEAVE_MODE=1 THEN 1 ELSE -1 END)),
				@NOPSHL = SUM(HL * (CASE WHEN LEAVE_MODE=1 THEN 1 ELSE -1 END)),
				@NOPSSL = SUM(SL * (CASE WHEN LEAVE_MODE=1 THEN 1 ELSE -1 END))
				
		FROM EMP_LEAVE_CREDIT
		WHERE EMP_ID = @CEMPID
		AND   DBO.FN_YEARMONTHTOSTR(YEAR, MONTH) < @CMINPAYSLIPMONTHSTR
	END

	SELECT	@NOPSFL = ISNULL(@NOPSFL,0) + ISNULL(SUM(LEAVE_CR_FL - LEAVE_DR_FL),0), -- AS OPS_FL,
			@NOPSHL = ISNULL(@NOPSHL,0) + ISNULL(SUM(LEAVE_CR_HL - LEAVE_DR_HL),0), -- AS OPS_HL,
			@NOPSSL = ISNULL(@NOPSSL,0) + ISNULL(SUM(LEAVE_CR_SL - LEAVE_DR_SL),0)  -- AS OPS_SL
	FROM EMP_PAYSLIP_MST 
	WHERE CANCELLED = 0
	AND   DBO.FN_YEARMONTHTOSTR(PAYSLIP_YEAR, PAYSLIP_MONTH) < DBO.FN_YEARMONTHTOSTR(@NYEAR, @NMONTH)
	AND   EMP_ID = @CEMPID

	IF @LSLSETTLEMENT = 1
		SET @NOPSLEAVECR = @NOPSFL + CAST(@NOPSHL AS NUMERIC(10,2))/2
	ELSE
		SET @NOPSLEAVECR = @NOPSFL + CAST(@NOPSHL AS NUMERIC(10,2))/2 + CAST(@NOPSSL AS NUMERIC(10,2))/4

	---- DELETING LWP ADJUSTMENT ENTRY FROM EMP_LEAVE_CREDIT
	--SET @CLCMEMOID = 'LA' + @CEMPID + 'LWPADJ' + DBO.FN_YEARMONTHTOSTR(@NYEAR, @NMONTH)	
	--IF EXISTS ( SELECT MEMO_NO FROM EMP_LEAVE_CREDIT WHERE EMP_ID = @CEMPID AND MEMO_NO = @CLCMEMOID )
	--	DELETE FROM EMP_LEAVE_CREDIT WHERE EMP_ID = @CEMPID AND MEMO_NO = @CLCMEMOID

	-- PUTTING DEFAULT CREDIT ENTRY INTO LEAVE CREDIT MODULE FOR THE CURRENT MONTH
	DECLARE LEAVE_CUR CURSOR FOR 
	SELECT LEAVE_CODE, ROUND(CAST(NO_OF_LEAVES AS NUMERIC(10,2))/12,2) LEAVE_CR 
	FROM EMP_LEAVE_MASTER WHERE CALC_METHOD = 2
	
	OPEN LEAVE_CUR 
	
	FETCH NEXT FROM LEAVE_CUR INTO @CLEAVECODE, @NLEAVECREDIT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		--SET @CLCMEMOID = 'LC' + @CEMPID + @CLEAVECODE + DBO.FN_YEARMONTHTOSTR(@NYEAR, @NMONTH)	
	
		--IF NOT EXISTS ( SELECT MEMO_NO FROM EMP_LEAVE_CREDIT WHERE EMP_ID = @CEMPID AND MEMO_NO = @CLCMEMOID )
		--BEGIN
		--	INSERT EMP_LEAVE_CREDIT	( MONTH, YEAR, EMP_ID, SL, HL, FL, MEMO_NO, REMARKS, LEAVE_CODE, 
		--							  LEAVE_MODE, ADJ_METHOD, FROM_PAYSLIP )  
		--					VALUES  ( @NMONTH, @NYEAR, @CEMPID, 0, 0, @NLEAVECREDIT, @CLCMEMOID, 'MONTHLY SETTLEMENT OF LEAVE',
		--							  '0000000', 1, 1, 1 )
		--END

		SET @NTOTLEAVECREDIT = @NTOTLEAVECREDIT + @NLEAVECREDIT

		FETCH NEXT FROM LEAVE_CUR INTO @CLEAVECODE, @NLEAVECREDIT
	END
	CLOSE LEAVE_CUR
	DEALLOCATE LEAVE_CUR

	SELECT	@NCURDRABS = SUM(A),
			@NCURDRFL = SUM(LV),
			@NCURDRHL = SUM(H),
			@NCURDRSL = SUM(E+L)
	FROM VW_ATTSUMMARY
	WHERE EMP_ID = @CEMPID
	AND   DBO.FN_YEARMONTHTOSTR(ATT_YEAR, ATT_MONTH) = DBO.FN_YEARMONTHTOSTR(@NYEAR, @NMONTH)

	IF @LSLSETTLEMENT = 1 AND @NCURDRSL > 0
	BEGIN
		SET @NTEMPSL = (@NCURDRSL/3)
		SET @NCURDRHL = @NCURDRHL + @NTEMPSL
		SET @NCURDRSL = @NCURDRSL - @NTEMPSL
	END

	SELECT	@NCURCRFL = ISNULL(SUM(FL * (CASE WHEN LEAVE_MODE=1 THEN 1 ELSE -1 END)),0),
			@NCURCRHL = ISNULL(SUM(HL * (CASE WHEN LEAVE_MODE=1 THEN 1 ELSE -1 END)),0),
			@NCURCRSL = ISNULL(SUM(SL * (CASE WHEN LEAVE_MODE=1 THEN 1 ELSE -1 END)),0)
	FROM EMP_LEAVE_CREDIT
	WHERE EMP_ID = @CEMPID
	AND   DBO.FN_YEARMONTHTOSTR(YEAR, MONTH) = DBO.FN_YEARMONTHTOSTR(@NYEAR, @NMONTH)
	
	SET @NCURCRFL = ISNULL(@NCURCRFL,0) + @NTOTLEAVECREDIT
	
	IF @LSLSETTLEMENT = 1
	BEGIN
		SET @NCBSLEAVE = @NOPSLEAVECR - 
						( @NCURDRFL + CAST(@NCURDRHL AS NUMERIC(10,2))/2) +
						( @NCURCRFL + CAST(@NCURCRHL AS NUMERIC(10,2))/2)
		
		SET @NCURRENTLEAVEDR = ( @NCURDRFL + CAST(@NCURDRHL AS NUMERIC(10,2))/2)
		SET @NCURRENTLEAVECR = ( @NCURCRFL + CAST(@NCURCRHL AS NUMERIC(10,2))/2)
	END
	ELSE
	BEGIN
		SET @NCBSLEAVE = @NOPSLEAVECR - 
						( @NCURDRFL + CAST(@NCURDRHL AS NUMERIC(10,2))/2 + CAST(@NCURDRSL AS NUMERIC(10,2))/4) +
						( @NCURCRFL + CAST(@NCURCRHL AS NUMERIC(10,2))/2 + CAST(@NCURCRSL AS NUMERIC(10,2))/4)

		SET @NCURRENTLEAVEDR = ( @NCURDRFL + CAST(@NCURDRHL AS NUMERIC(10,2))/2 + CAST(@NCURDRSL AS NUMERIC(10,2))/4) 
		SET @NCURRENTLEAVECR = ( @NCURCRFL + CAST(@NCURCRHL AS NUMERIC(10,2))/2 + CAST(@NCURCRSL AS NUMERIC(10,2))/4)
	END
	
	SET @NLWPDAYS = 0
	
	IF ISNULL(@NCBSLEAVE,0) < 0
	BEGIN
		SET @NLWPDAYS = ABS(ISNULL(@NCBSLEAVE,0))
	
		--SET @CLCMEMOID = 'LA' + @CEMPID + 'LWPADJ' + DBO.FN_YEARMONTHTOSTR(@NYEAR, @NMONTH)	
	
		--IF NOT EXISTS ( SELECT MEMO_NO FROM EMP_LEAVE_CREDIT WHERE EMP_ID = @CEMPID AND MEMO_NO = @CLCMEMOID )
		--BEGIN
		--	INSERT EMP_LEAVE_CREDIT	( MONTH, YEAR, EMP_ID, SL, HL, FL, MEMO_NO, REMARKS, LEAVE_CODE, 
		--							  LEAVE_MODE, ADJ_METHOD, FROM_PAYSLIP )  
		--					VALUES  ( @NMONTH, @NYEAR, @CEMPID, 0, 0, @NLWPDAYS, @CLCMEMOID, 'LWP ADJUSTMENT FROM PAYSLIP',
		--							  '0000000', 1, 1, 1 )
		--END
		
		SET @NCBSLEAVE = 0
		SET @NCURRENTLEAVECR = ISNULL(@NCURRENTLEAVECR,0) + ISNULL(@NLWPDAYS,0)
		SET @NCURCRFL = ISNULL(@NCURCRFL,0) + ISNULL(@NLWPDAYS,0)
	END

	SELECT	ISNULL(@NOPSLEAVECR,0) AS OPS, 
			ISNULL(@NCURDRABS,0) AS ABSENT_DAYS,
			ISNULL(@NCURDRFL,0) AS LEAVE_DR_FL,
			ISNULL(@NCURDRHL,0) AS LEAVE_DR_HL,
			ISNULL(@NCURDRSL,0) AS LEAVE_DR_SL,
			ISNULL(@NCURCRFL,0) - ISNULL(@NLWPDAYS,0) AS LEAVE_CR_FL,
			ISNULL(@NCURCRHL,0) AS LEAVE_CR_HL,
			ISNULL(@NCURCRSL,0) AS LEAVE_CR_SL,
			ISNULL(@NCURRENTLEAVEDR,0) AS LEAVES_TAKEN,
			ISNULL(@NCURRENTLEAVECR,0) AS LEAVES_CREDITED,
			ISNULL(@NCBSLEAVE,0) AS CBS,
			ISNULL(@NLWPDAYS,0) AS LWP_DAYS
END
