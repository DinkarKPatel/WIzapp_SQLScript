CREATE PROCEDURE SP_CREATEPAYMODEVIEW
--WITH ENCRYPTION
AS
BEGIN	
		DECLARE @CPAYMODECODE CHAR(7),
				@CPAYMODENAME VARCHAR(1000),
				@COUTPUT NVARCHAR(MAX),
				@CCMD NVARCHAR(MAX),
				@CPAYMODESTR NVARCHAR(MAX)
				
		SELECT @CCMD='',@COUTPUT=''
		
		---Needed to run this because creation of columns more than 1024 columns resulting in column limit error at Da milano
		-- where lots of wizclip titles are created (Sanjay:19-06-2024)
		DECLARE PMODECUR CURSOR FOR SELECT PAYMODE_CODE,PAYMODE_NAME FROM PAYMODE_MST (NOLOCK) WHERE LEFT(PAYMODE_CODE,2)<>'wc'
				
		OPEN PMODECUR
		FETCH NEXT FROM PMODECUR INTO @CPAYMODECODE,@CPAYMODENAME
		WHILE @@FETCH_STATUS=0
		BEGIN
			SET @COUTPUT=@COUTPUT+N'SUM(CASE WHEN A.PAYMODE_CODE ='''+@CPAYMODECODE+''' THEN AMOUNT ELSE 0 END) AS ['+@CPAYMODENAME+'],'

			FETCH NEXT FROM PMODECUR INTO @CPAYMODECODE,@CPAYMODENAME
		END
		CLOSE PMODECUR
		DEALLOCATE PMODECUR
		
		SET @COUTPUT=@COUTPUT+N'SUM(CASE WHEN PAYMODE_GRP_CODE =''0000002'' THEN AMOUNT ELSE 0 END) AS [CREDIT CARDS],'

		SET @CPAYMODESTR=(CASE WHEN @COUTPUT<>'' THEN ','+SUBSTRING(@COUTPUT,1,LEN(@COUTPUT)-1) ELSE '' END)			
		
		IF OBJECT_ID('VW_PAYMODEXNDET','V') IS NOT NULL
			DROP VIEW VW_PAYMODEXNDET
				
		
		SET @CCMD=N'CREATE VIEW  VW_PAYMODEXNDET AS SELECT MEMO_ID,XN_TYPE'+@CPAYMODESTR+' FROM PAYMODE_XN_DET A
					JOIN PAYMODE_MST B ON A.PAYMODE_CODE=B.PAYMODE_CODE
					GROUP BY MEMO_ID,XN_TYPE'		
						

		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD			
					
					
END