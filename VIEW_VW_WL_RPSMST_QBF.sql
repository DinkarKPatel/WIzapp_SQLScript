create VIEW  VW_WL_RPSMST_QBF    

AS    
SELECT     
 MST.CM_ID AS CM_ID,    
  MST.CM_NO AS MST_CM_NO,   
  MST.CANCELLED AS MST_CANCELLED,   
  MST.CM_DT AS MST_CM_DT,    
  MST.FIN_YEAR AS MST_FIN_YEAR, 
  MST.SUBTOTAL AS MST_SUBTOTAL,  
  MST.NET_AMOUNT AS MST_NET_AMOUNT ,    
  MST.REMARKS AS MST_REMARKS,   
MST.DISCOUNT_PERCENTAGE AS MST_DISCOUNT_PERCENTAGE,
MST.DISCOUNT_AMOUNT AS MST_DISCOUNT_AMOUNT,
  E.USERNAME AS MST_USERNAME,  
  C.*,    
  B.QUANTITY AS QUANTITY,    
  B.DISCOUNT_PERCENTAGE ,    
  B.DISCOUNT_AMOUNT ,    
  EMP1.EMP_NAME AS MST_EMP_NAME,  
  EMP1.EMP_NAME AS EMP_NAME, 
  EMP2.EMP_NAME AS EMP_NAME1, 
  EMP3.EMP_NAME AS EMP_NAME2, 
  EMP1.EMP_ALIAS,    
  'T'+(CASE WHEN B.TAX_PERCENTAGE=0 THEN 'F' WHEN ROUND(B.TAX_PERCENTAGE,0)=B.TAX_PERCENTAGE THEN LTRIM(RTRIM(STR(B.TAX_PERCENTAGE)))
							 ELSE LTRIM(RTRIM(STR(B.TAX_PERCENTAGE,6,2))) END) AS TAX_STATUS,    
  B.TAX_PERCENTAGE ,    
  B.TAX_AMOUNT ,    
  B.NET,  
  B.MRP,
  MST.CM_TIME AS MST_CM_TIME  
  ,COM.COMPANY_CODE AS COMP_COMPANYCODE
,COM.PAN_NO AS COMP_PANNO
,COM.EMAIL_ID AS COMP_EMAILID
,COM.PWD AS COMP_PWD
,COM.STATE AS COMP_STATE 
,COM.COUNTRY AS COMP_CONTRY
,COM.MOBILE AS COMP_MOBILE
,COM.CONTACT_NAME AS COMP_CONTACTNAME
,COM.TDS_AC_NO AS COMP_TDSACNO
,COM.COMPANY_NAME AS COMP_COMPANYNAME
,COM.ALIAS AS COMP_ALIAS
,COM.ADDRESS1 AS COMP_ADDRESS1
,COM.ADDRESS2 AS COMP_ADDRESS2 
,COM.CITY AS COMP_CITY
,COM.TAN_NO AS COMP_TANNO
,COM.PHONES_FAX AS COMP_PHONES_FAX
,COM.CST_DT AS COMP_CST_DT
,COM.SST_NO AS COMP_SSTNO
,COM.SST_DT AS COMP_SSTDT
,COM.GRP_CODE AS COMP_GRPCODE
,COM.ADDRESS9 AS COMP_ADDRESS9
,COM.AREA_CODE AS COMP_AREACODE
,COM.PRINT_ADDRESS AS COMP_PRINTADDRESS
,COM.WORKABLE AS COMP_WORKABLE
,COM.PIN AS COMP_PIN
,COM.LOGO_PATH AS COMP_LOGOPATH
,COM.WEB_ADDRESS AS COMP_WEBADDRESS
,COM.SSPL_FIRST_HDSR AS COMP_SSPLFIRSTHDSR
,COM.POLICY_NO AS COMP_POLICYNO
,COM.GRP_NAME AS COMP_GRPNAME 
,COM.CIN AS COMP_CIN
,CUST.USER_CUSTOMER_CODE,
CUST.CUSTOMER_FNAME,
CUST.CUSTOMER_LNAME,
CUST.ADDRESS0,
CUST.ADDRESS1,
CUST.ADDRESS2
,(CASE WHEN ISNULL(B.ITEM_DESC,'')<>''  THEN B.ITEM_DESC ELSE C.SUB_SECTION_NAME END) AS ITEM_DESC
,b.pcs_quantity,b.mtr_quantity,mst.atd_charges,MST.location_Code
 FROM RPS_MST MST    
 JOIN RPS_DET B ON B.CM_ID=MST.CM_ID    
JOIN   
(  
 SELECT LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE ))) as PRODUCT_CODE_WO_BATCH,  
 A.PRODUCT_CODE, A.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, A.PARA1_CODE,    
 C.PARA1_NAME, A.PARA2_CODE, D.PARA2_NAME, A.PARA3_CODE, F.PARA3_NAME, E.UOM_NAME,       
 B.CODING_SCHEME,  B.INACTIVE, 
 A.PURCHASE_PRICE,  A.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,    
 A.PARA4_CODE,A.PARA5_CODE,A.PARA6_CODE,    
 PARA4_NAME,PARA5_NAME,PARA6_NAME,B.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],    
 B.DT_CREATED AS [ART_DT_CREATED],F.DT_CREATED AS [PARA3_DT_CREATED],A.DT_CREATED AS [SKU_DT_CREATED],    
 B.STOCK_NA,b.ARTICLE_PACK_SIZE
 FROM SKU A --FROM PMTVIEW A --- OPTIMIZATION AFTER REMOVING VIEWS
 JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE      
 JOIN SECTIOND SD ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
 JOIN SECTIONM SM ON SD.SECTION_CODE = SM.SECTION_CODE    
 JOIN PARA1 C ON A.PARA1_CODE = C.PARA1_CODE      
 JOIN PARA2 D ON A.PARA2_CODE = D.PARA2_CODE      
 JOIN PARA3 F ON A.PARA3_CODE = F.PARA3_CODE      
 JOIN PARA4 G ON A.PARA4_CODE = G.PARA4_CODE      
 JOIN PARA5 H ON A.PARA5_CODE = H.PARA5_CODE      
 JOIN PARA6 I ON A.PARA6_CODE = I.PARA6_CODE      
 JOIN UOM E ON B.UOM_CODE = E.UOM_CODE  
)C ON C.PRODUCT_CODE=B.PRODUCT_CODE  
JOIN USERS E ON E.USER_CODE = MST.USER_CODE    
JOIN EMPLOYEE EMP1 ON EMP1.EMP_CODE= B.EMP_CODE 
JOIN EMPLOYEE EMP2 ON EMP2.EMP_CODE= B.EMP_CODE1
JOIN EMPLOYEE EMP3 ON EMP3.EMP_CODE= B.EMP_CODE2 
LEFT OUTER JOIN  CUSTDYM CUST ON CUST.CUSTOMER_CODE=MST.CUSTOMER_CODE
JOIN COMPANY COM ON COM.COMPANY_CODE ='01'
