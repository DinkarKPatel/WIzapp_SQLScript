CREATE PROCEDURE SP3S_DROPCREATE_DATABASE
@NMODE INT=1,
@CDBNAME VARCHAR(500),
@CDBPATH VARCHAR(2000)=''
AS
BEGIN
	IF @NMODE=2 
	BEGIN 
		IF DB_ID(@CDBNAME) IS NOT NULL 
		BEGIN
			---- TEMPORARILY SKIP THIS STEP AFTER DISCUSSION WITH ANIL BECAUSE IT IS CREATING PROBLEM AT JASHN (17-02-16)
			RETURN 
			
			IF @CDBNAME=DB_NAME()+'_TEMP' AND OBJECT_ID('MERGING_XNS_PENDING_MEMOS','U') IS NOT NULL
			BEGIN
				IF EXISTS (SELECT TOP 1 XN_TYPE FROM MERGING_XNS_PENDING_MEMOS)
					RETURN
			END
			
			DECLARE @CCMD NVARCHAR(MAX) 
			
			SELECT @CCMD=COALESCE(@CCMD,'')+ ' KILL '+ CONVERT(VARCHAR,SPID) + ';' 
			FROM MASTER..SYSPROCESSES WHERE DBID=DB_ID(@CDBNAME) AND SPID<>@@SPID 
			EXEC SP_EXECUTESQL @CCMD 
			
			SET @CCMD=N'ALTER DATABASE '+@CDBNAME+' SET SINGLE_USER WITH ROLLBACK IMMEDIATE' 
			EXEC SP_EXECUTESQL @CCMD
			
			SET @CCMD=N'DROP DATABASE '+@CDBNAME
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD 
		END
	END
	
	IF @NMODE=1
	BEGIN
		IF DB_ID(@CDBNAME) IS NULL 
		BEGIN
			SET @CCMD=N'CREATE DATABASE '+@CDBNAME+'
			ON
			( NAME = '+@CDBNAME+'_DAT,
			  FILENAME = '''+@CDBPATH+'\'+@CDBNAME+'.MDF'')
			LOG ON 
			( NAME = '+@CDBNAME+'_LOG,
			 FILENAME = '''+@CDBPATH+'\'+@CDBNAME+'.LDF'')'			

			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD 			 
		END
	END
END	
-- END OF PROCEDURE SP3S_DROPCREATE_DATABASE
