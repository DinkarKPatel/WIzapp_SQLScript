create PROCEDURE DBO.SP_MERGE_MIRROR_DOCMRP_DATA_NEW  
(
@CERRMSG VARCHAR(1000) OUTPUT 
  )  
AS  
 BEGIN  
       DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)  
              ,@CTEMPLOCTABLE VARCHAR(100),@CSTATECODEOUT CHAR(7),@CSTATECODE VARCHAR(10)  
              ,@CCURDEPTID VARCHAR(10),@CHODEPTID VARCHAR(10),@BHOLOC BIT,@NLOCTYPE VARCHAR(50)  
              ,@BPURLOC VARCHAR(10),@CTABLENAME VARCHAR(100),@CTMP_TABLENAME VARCHAR(100)  
              ,@CKEYFIELD1 VARCHAR(100),@CTEMPLOCSSTTABLE VARCHAR(500),@CTEMPTABLE VARCHAR(500)  
              ,@CTEMPLOCSSTMSTTABLE VARCHAR(500),@BPROCEED BIT,@CKEYFIELD2 VARCHAR(500),@CKEYFIELD3 VARCHAR(500)   
              ,@CSOURCETABLE VARCHAR(1000),@NXNSMERGINGORDER INT,@CSOURCEDB VARCHAR(200),@CERRORMSG VARCHAR(MAX)
              ,@XN_TYPE VARCHAR(10)    
BEGIN TRY  
     
   SELECT @CSOURCEDB='',@CERRORMSG=''   
     
   
   SET @XN_TYPE='DOCMRP'  
         
   BEGIN TRANSACTION  
        
     
   SET @CSTEP = 10      
    
	SET @CTABLENAME = 'LOCSKUSP'  
    SET @CSOURCETABLE ='DOCMRP_'+@CTABLENAME+'_UPLOAD'
    SET @CKEYFIELD1='PRODUCT_CODE' 
    SET @CKEYFIELD2 ='DEPT_ID' 
    
    SET @CSTEP = 35  
    SET @DTSQL=N'DELETE A FROM '+@CSOURCETABLE+' A  WITH (ROWLOCK) WHERE A.LAST_UPDATE<>(SELECT TOP 1 LAST_UPDATE FROM 
     '+@CSOURCETABLE+' B WHERE B.PRODUCT_CODE=A.PRODUCT_CODE AND B.DEPT_ID=A.DEPT_ID AND B.FROM_DT=A.FROM_DT
     ORDER BY B.LAST_UPDATE DESC)'
	 print @DTSQL
    EXEC SP_EXECUTESQL @DTSQL 
    
    SET @CSTEP = 40
    
    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3='FROM_DT',@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  
      

     --INSERT DATA INTO CITY TABLE  
    SET @CSTEP = 50  
    SET @CTABLENAME = 'LOCSKUSP_CURRENT'  
    SET @CSOURCETABLE ='DOCMRP_'+@CTABLENAME+'_UPLOAD'
    SET @CKEYFIELD1='PRODUCT_CODE'  
    SET @CKEYFIELD2 ='DEPT_ID' 

    EXEC UPDATEMASTERXN  
    @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,  
    @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,  
    @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3='',@LINSERTONLY=0,  
    @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1  


    GOTO END_PROC  
END TRY  
  
BEGIN CATCH  
	 SET @CERRORMSG='P:SP_MERGE_MIRROR_DOCMRP_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
	 GOTO END_PROC  
END CATCH  
  
END_PROC:  
   
 IF @@TRANCOUNT>0  
 BEGIN  
	  IF ISNULL(@CERRORMSG,'')=''   
	   COMMIT  
	  ELSE  
	   ROLLBACK   
 END  
 
 DELETE FROM DOCMRP_LOCSKUSP_UPLOAD    
 DELETE FROM DOCMRP_LOCSKUSP_CURRENT_UPLOAD
 
END  
--END PROCEDURE SP_MERGE_MIRROR_DOCMRP_DATA_NEW
