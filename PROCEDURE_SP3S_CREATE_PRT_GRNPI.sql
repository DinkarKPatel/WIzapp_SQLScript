CREATE PROCEDURE SP3S_CREATE_PRT_GRNPI
(
 @CMRR_ID VARCHAR(100),
 @CUSER_CODE CHAR(7)='0000000'
)
AS
BEGIN 
 

         
      SELECT DISTINCT CAST('' AS NVARCHAR(10)) AS SRNO, CAST(0 AS BIT) AS BILLCHECK,       
                      A.MRR_ID,A.MRR_NO,A.INV_DT,A.TOTAL_AMOUNT , C.AC_NAME ,A.AC_CODE, A.BILL_NO AS INV_NO,
                      a.ac_code ,
                      a.BROKER_AC_CODE ,
                      @CUSER_CODE as user_code,
                      @CUSER_CODE as edt_user_code,
                      1 AS MEMO_TYPE,
                      A.BIN_ID ,
                      A.BIN_ID AS TARGET_BIN_ID,
                      CONVERT(VARCHAR(10),GETDATE (),121) AS RM_DT,
                      GETDATE () AS RM_TIME,
                      A.mrr_id AS RefMemoID,
                      CAST('LATER' AS VARCHAR(100)) AS RM_ID,
                      CAST('LATER' AS VARCHAR(100)) AS RM_NO,
                      RMM .*,CAST(0 as int) as sp_id
      FROM PIM01106  A (NOLOCK)    
      JOIN PID01106 B (NOLOCK) ON A.MRR_ID=B.MRR_ID     
      JOIN LMV01106 C (NOLOCK) ON A.AC_CODE = C.AC_CODE 
      LEFT OUTER JOIN
      (
        SELECT DISTINCT  A.*,mrr_id  FROM rmm01106 A
        JOIN rmd01106 B ON A.rm_id =B.rm_id 
        WHERE A.CANCELLED =0
        AND ISNULL(mrr_id,'')<>''
      )  RMM ON RMM.mrr_id = A.mrr_id   
      WHERE A.CANCELLED = 0  
      AND A.pim_mode =6 AND B.invoice_quantity-ISNULL(B.GRN_QTY,0)>0
      AND A.mrr_id =@CMRR_ID AND RMM.mrr_id IS NULL
      
     
   
	 SELECT  CAST(0 AS NUMERIC(10)) AS SRNO    
    , CAST(0 AS BIT) AS BILLCHECK    
    ,PIM.MRR_ID AS MRR_ID    
    ,PIM.MRR_NO AS MRR_NO    
    ,PIM.INV_DT AS INV_DT    
    ,PIM.TOTAL_AMOUNT AS TOTAL_AMOUNT     
    , B.AC_NAME AS AC_NAME    
    ,PIM.AC_CODE AS AC_CODE    
    , PIM.INV_NO AS CHALLAN_NO    
    ,PIM.BILL_NO AS BILL_NO    
    ,PIM.INV_DT  AS BILL_DT    
    ,PIM.MEMO_TYPE AS MEMO_TYPE    
    , UOM.UOM_TYPE AS UOM_TYPE    
    , SM.SECTION_NAME AS SECTION_NAME    
    , SD.SUB_SECTION_NAME AS SUB_SECTION_NAME    
    , A.PRODUCT_CODE AS PRODUCT_CODE    
    , A.MRP AS MRP    
    , A.ARTICLE_CODE AS ARTICLE_CODE    
    ,ART.ARTICLE_NO AS ARTICLE_NO    
    , ART.ARTICLE_NAME AS ARTICLE_NAME    
    , ART.ARTICLE_DESC AS ARTICLE_DESC    
    ,P1.PARA1_NAME AS PARA1_NAME    
    ,P2.PARA2_NAME AS PARA2_NAME    
    ,P3.PARA3_NAME AS PARA3_NAME    
    ,P4.PARA4_NAME AS PARA4_NAME    
    ,P5.PARA5_NAME AS PARA5_NAME    
    ,P6.PARA6_NAME AS PARA6_NAME    
    ,UOM.UOM_CODE AS UOM_CODE    
    ,UOM.UOM_NAME AS UOM_NAME    
    ,SO.FREIGHT AS FREIGHT    
    ,SO.OTHER_CHARGES AS OTHER_CHARGES    
    ,0 AS QUANTITY_IN_STOCK    
    ,ISNULL(ART.DT_CREATED,'') AS ART_DT_CREATED    
    ,ISNULL(P3.DT_CREATED,'') AS PARA3_DT_CREATED    
    ,ISNULL(SKU.DT_CREATED,'') AS SKU_DT_CREATED    
    ,SKU.BARCODE_CODING_SCHEME AS CODING_SCHEME    
    ,ART.DISCON AS DISCON    
    ,'' AS CITY    
    ,a.invoice_quantity-ISNULL(a.GRN_QTY,0) AS QUANTITY 
    ,a.invoice_quantity-ISNULL(a.GRN_QTY,0) AS INVOICE_QUANTITY     
    ,(CASE WHEN PIM.DISCOUNT_PERCENTAGE=0 THEN A.PURCHASE_PRICE     
    ELSE (A.PURCHASE_PRICE-(A.PURCHASE_PRICE *PIM.DISCOUNT_PERCENTAGE/100)) END) AS INV_RATE     
    ,(CASE WHEN (a.invoice_quantity-ISNULL(a.GRN_QTY,0))>0 AND PIM.SUBTOTAL<>0 THEN  ((ISNULL(A.PURCHASE_PRICE,0)-(((PIM.DISCOUNT_AMOUNT/PIM.SUBTOTAL)*A.PURCHASE_PRICE))    
    -ISNULL(A.PIMPOSTTAXDISCOUNTAMOUNT/(a.invoice_quantity-ISNULL(a.GRN_QTY,0)),0)-ISNULL(A.PRTAMOUNT/(a.quantity-ISNULL(a.GRN_QTY,0)),0)+  
    ISNULL(A.PRTAMOUNT_CREDITED/(a.invoice_quantity-ISNULL(a.GRN_QTY,0)),0)))  
    ELSE 0 END) AS  RATE     
    ,(CASE WHEN PIM.BILL_LEVEL_TAX_METHOD = 1 THEN 'EXCLUSIVE' ELSE 'INCLUSIVE' END) AS TAX_METHOD_NAME     
    ,PIM.BILL_LEVEL_TAX_METHOD AS BILL_LEVEL_TAX_METHOD    
    ,ART.ALIAS AS ARTICLE_ALIAS    
    ,PIM.BIN_ID AS BIN_ID    
    ,BIN.BIN_NAME AS BIN_NAME    
    ,PIM.TERMS AS TERMS    
    ,A.CASHDISCOUNTAMOUNT     
    ,((ISNULL(A.PURCHASE_PRICE,0)-ISNULL(A.PIMDISCOUNTAMOUNT,0)    
    -ISNULL(A.PIMPOSTTAXDISCOUNTAMOUNT,0)+ISNULL(A.PIMEXCISEDUTYAMOUNT,0)    
    -ISNULL(A.PRTAMOUNT,0)+ISNULL(A.PRTAMOUNT_CREDITED,0)))  AS PURCHASEAMOUNT     
    ,CONVERT(NUMERIC(18,2),0) AS DIFFAMOUNT    
    ,CONVERT(VARCHAR(40),NEWID()) AS ROWID    
    ,(CASE WHEN DN.REFMEMOID IS NULL THEN 0 ELSE ISNULL(A.PRTAMOUNT,0)-ISNULL(A.PRTAMOUNT_CREDITED,0)  END) AS FDN_RATE    
    ,A.ROW_ID AS PID_ROW_ID    
    -------COL ADD FOR EXCISE FOR LAKHSHITA  ON 19/04/2016    
    ,SO.EXCISE_DUTY_AMOUNT AS PARTY_PUR_EXCISE_RATE ,  
    CONVERT(BIT,0) AS LOCALVATFOUND,CONVERT(VARCHAR(40),'') AS LOCSST_ROW_ID
    ,(CASE WHEN (a.invoice_quantity-ISNULL(a.GRN_QTY,0))>0 AND PIM.SUBTOTAL<>0 THEN  ((ISNULL(A.PURCHASE_PRICE,0)-(((PIM.DISCOUNT_AMOUNT/PIM.SUBTOTAL)*A.PURCHASE_PRICE))    
    -ISNULL(A.PIMPOSTTAXDISCOUNTAMOUNT/(a.invoice_quantity-ISNULL(a.GRN_QTY,0)),0)-ISNULL(A.PRTAMOUNT/(a.invoice_quantity-ISNULL(a.GRN_QTY,0)),0)+  
    ISNULL(A.PRTAMOUNT_CREDITED/A.INVOICE_QUANTITY,0)))  
    ELSE 0 END) AS NET_RATE

	   ----- SET OF D/N FINANCIAL COLUMNS
	  ,A.FORM_ID AS ITEM_FORM_ID
	  ,FM.FORM_NAME
	  ,A.GROSS_PURCHASE_PRICE
	  ,CONVERT(NUMERIC(7,3),(CASE WHEN A.DISCOUNT_PERCENTAGE<>0 AND PIM.DISCOUNT_PERCENTAGE<>0 
			 THEN (100-(((A.GROSS_PURCHASE_PRICE-(A.GROSS_PURCHASE_PRICE*ISNULL(A.DISCOUNT_PERCENTAGE,0)/100))-
				 ((A.GROSS_PURCHASE_PRICE-(A.GROSS_PURCHASE_PRICE*ISNULL(A.DISCOUNT_PERCENTAGE,0)/100))
				 *ISNULL(PIM.DISCOUNT_PERCENTAGE,0)/100))/A.GROSS_PURCHASE_PRICE)*100)
			 WHEN PIM.DISCOUNT_PERCENTAGE<>0 THEN PIM.DISCOUNT_PERCENTAGE
			 ELSE A.DISCOUNT_PERCENTAGE END)) AS DN_DISCOUNT_PERCENTAGE   
	  ,CONVERT(NUMERIC(10,2),(A.DISCOUNT_AMOUNT/(a.invoice_quantity-ISNULL(a.GRN_QTY,0)))+
	   (A.PURCHASE_PRICE*PIM.DISCOUNT_PERCENTAGE/100)) AS DN_DISCOUNT_AMOUNT  
	  ,CONVERT(NUMERIC(10,2),(A.PURCHASE_PRICE-(A.PURCHASE_PRICE*PIM.DISCOUNT_PERCENTAGE/100))) AS PURCHASE_PRICE  
	  ,A.TAX_PERCENTAGE AS ITEM_TAX_PERCENTAGE
	  ,CONVERT(NUMERIC(12,4),A.TAX_AMOUNT/(a.invoice_quantity-ISNULL(a.GRN_QTY,0))) AS ITEM_TAX_AMOUNT
	  ,CONVERT(NUMERIC(6,2),(CASE WHEN ISNULL(A.ITEM_EXCISE_DUTY_PERCENTAGE,0)<>0 THEN A.ITEM_EXCISE_DUTY_PERCENTAGE
	   ELSE (PIM.EXCISE_DUTY_AMOUNT/(PIM.SUBTOTAL-PIM.DISCOUNT_AMOUNT))*100 END)) AS ITEM_EXCISE_DUTY_PERCENTAGE 
	  ,CONVERT(NUMERIC(10,2),(CASE WHEN ISNULL(A.ITEM_EXCISE_DUTY_PERCENTAGE,0)<>0 THEN A.ITEM_EXCISE_DUTY_AMOUNT/(a.invoice_quantity-ISNULL(a.GRN_QTY,0))
	   ELSE (PIM.EXCISE_DUTY_AMOUNT/(PIM.SUBTOTAL-PIM.DISCOUNT_AMOUNT))*A.PURCHASE_PRICE*(a.invoice_quantity-ISNULL(a.GRN_QTY,0)) END)) AS EXCISE_DUTY_AMOUNT
	  
	  ----- SET OF PURCHASE FINANCIAL COLUMNS	
	  ,A.FORM_ID AS PUR_FORM_ID
	  ,FM.FORM_NAME AS PUR_FORM_NAME
	  ,A.GROSS_PURCHASE_PRICE AS PUR_GROSS_PURCHASE_PRICE
	  ,A.DISCOUNT_PERCENTAGE AS PUR_ITEM_DISCOUNT_PERCENTAGE   
	  ,CONVERT(NUMERIC(10,2),A.DISCOUNT_PERCENTAGE*A.GROSS_PURCHASE_PRICE/100) AS PUR_ITEM_DISCOUNT_AMOUNT  
	  ,PIM.DISCOUNT_PERCENTAGE AS PUR_DISCOUNT_PERCENTAGE   
	  ,CONVERT(NUMERIC(10,2),A.PURCHASE_PRICE*PIM.DISCOUNT_PERCENTAGE/100) AS PUR_DISCOUNT_AMOUNT  		  
	  ,CONVERT(NUMERIC(10,2),A.PURCHASE_PRICE-(A.PURCHASE_PRICE*PIM.DISCOUNT_PERCENTAGE/100)) AS PUR_PURCHASE_PRICE  
	  ,A.TAX_PERCENTAGE AS PUR_TAX_PERCENTAGE
	  ,CONVERT(NUMERIC(12,4),A.TAX_AMOUNT/(a.invoice_quantity-ISNULL(a.GRN_QTY,0))) AS PUR_TAX_AMOUNT
	  ,CONVERT(NUMERIC(6,2),(CASE WHEN ISNULL(A.ITEM_EXCISE_DUTY_PERCENTAGE,0)<>0 THEN A.ITEM_EXCISE_DUTY_PERCENTAGE
	   ELSE (PIM.EXCISE_DUTY_AMOUNT/(PIM.SUBTOTAL-PIM.DISCOUNT_AMOUNT))*100 END)) AS PUR_EXCISE_DUTY_RATE 
	  ,CONVERT(NUMERIC(10,2),(CASE WHEN ISNULL(A.ITEM_EXCISE_DUTY_PERCENTAGE,0)<>0 THEN A.ITEM_EXCISE_DUTY_AMOUNT/(a.invoice_quantity-ISNULL(a.GRN_QTY,0))
	   ELSE (PIM.EXCISE_DUTY_AMOUNT/(PIM.SUBTOTAL-PIM.DISCOUNT_AMOUNT))*A.PURCHASE_PRICE*(a.invoice_quantity-ISNULL(a.GRN_QTY,0)) END)) AS PUR_EXCISE_DUTY_AMOUNT
      ,CAST(0 as int) as sp_id
      , NEWID () AS ROW_ID
      ,dn.*
      ,0 as lot_no
      ,CONVERT(NUMERIC(10,2),(A.PURCHASE_PRICE-(A.PURCHASE_PRICE*PIM.DISCOUNT_PERCENTAGE/100)))
      *(A.INVOICE_QUANTITY-ISNULL(A.GRN_QTY,0)) AS AMOUNT
        
    FROM PIM01106 PIM(NOLOCK)     
    JOIN PID01106 A(NOLOCK) ON PIM.MRR_ID=A.MRR_ID    
    JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE   
    LEFT JOIN LM01106 B(NOLOCK) ON PIM.AC_CODE=B.AC_CODE    
    JOIN ARTICLE ART(NOLOCK) ON SKU.ARTICLE_CODE=ART.ARTICLE_CODE    
    JOIN PARA1 P1(NOLOCK) ON SKU.PARA1_CODE=P1.PARA1_CODE    
    JOIN PARA2 P2(NOLOCK) ON SKU.PARA2_CODE=P2.PARA2_CODE     
    JOIN PARA3 P3(NOLOCK) ON SKU.PARA3_CODE=P3.PARA3_CODE     
    JOIN PARA4 P4(NOLOCK) ON SKU.PARA4_CODE=P4.PARA4_CODE     
    JOIN PARA5 P5(NOLOCK) ON SKU.PARA5_CODE=P5.PARA5_CODE     
    JOIN PARA6 P6(NOLOCK) ON SKU.PARA6_CODE=P6.PARA6_CODE     
    JOIN UOM (NOLOCK) ON ART.UOM_CODE=UOM.UOM_CODE    
    JOIN SECTIOND SD(NOLOCK) ON ART.SUB_SECTION_CODE=SD.SUB_SECTION_CODE    
    JOIN SECTIONM SM(NOLOCK) ON SD.SECTION_CODE=SM.SECTION_CODE    
       
    LEFT JOIN SKU_OH SO(NOLOCK) ON A.PRODUCT_CODE=SO.PRODUCT_CODE    
    LEFT JOIN FORM FM(NOLOCK) ON A.FORM_ID=FM.FORM_ID    
    LEFT OUTER JOIN   
    (  
     SELECT distinct  REFMEMOID,rmd .* 
     FROM RMM01106 A    
     JOIN  PIM01106  B ON A.REFMEMOID= B.MRR_ID 
     join rmd01106 rmd on a.rm_id =rmd.rm_id 
     WHERE A.CANCELLED=0 
     AND   b.mrr_id =@CMRR_ID  
     ) DN ON DN.REFMEMOID = PIM.MRR_ID   
     JOIN BIN(NOLOCK) ON PIM.BIN_ID=BIN.BIN_ID    
    WHERE  a.mrr_id =@CMRR_ID and pim.CANCELLED =0
    and a.Invoice_quantity-ISNULL(a.GRN_QTY,0)>0
  
     
          
  GOTO LAST    
  
  LAST:   
     
END

