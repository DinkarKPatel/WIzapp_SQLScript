CREATE PROCEDURE SP_PURCHASEBILL
(
	@CQUERYID		NUMERIC(2),
	@CWHERE			VARCHAR(100)='',
	@CFINYEAR		VARCHAR(5)='',
	@CDEPTID		VARCHAR(4)='',
	@NNAVMODE		NUMERIC(2)=1,
	@CWHERECLAUSE	NVARCHAR(MAX)='',
	@CBILLNO	NVARCHAR(MAX)='',
	@DLOGIN_DT DATETIME=''
)
--WITH ENCRYPTION

AS

BEGIN
DECLARE @CCMD NVARCHAR(MAX)
SET @CCMD=''
    IF @CQUERYID=1
		GOTO LBLPOLU
	ELSE IF @CQUERYID=2
		GOTO LBLMST
	ELSE IF @CQUERYID=3
		GOTO LBLDET
	ELSE IF @CQUERYID=4
		GOTO LBLPURMSTLIST
	ELSE IF @CQUERYID=5
       GOTO LBLPURDETLIST
    ELSE IF @CQUERYID=6    
       GOTO LBLPURMSTBILL 
	ELSE 
		GOTO LAST
		
LBLPOLU:

		
	EXECUTE SP_NAVIGATE 'PIM01106',@NNAVMODE,@CWHERE,@CFINYEAR,'MRR_NO','MRR_DT','MRR_ID',@CWHERECLAUSE
		
	GOTO LAST
	
LBLMST:
		DECLARE @POSTED NUMERIC(14,2)
		
		SELECT @POSTED = COUNT(MEMO_ID) FROM VOUCHER_POSTING_REF A JOIN VM01106 B ON A.VM_ID = B.VM_ID 
		WHERE B.CANCELLED = 0 AND A.XN_TYPE = 'PBG' AND A.MEMO_ID = @CWHERE
		
		SELECT D.USERNAME AS 'CREATED_USERNAME', E.USERNAME AS 'MODIFIED_USERNAME',   
		C.AC_NAME AS SUPP_NAME,C.ADDRESS0+' '+ C.ADDRESS1 + ' ' + C.ADDRESS2 + ', ' + C.AREA_NAME +   
		' ' + C.CITY + ' ' + C.STATE AS 'SUPP_ADDRESS', A.* , (CASE WHEN  @POSTED = 0 THEN 0 ELSE 1 END ) AS POSTED,
		'' AS MRR_NO ,RMM.REFMEMOID,RMM.RM_ID,RMM.RM_NO  ,RMM.PARTY_STATE_CODE  
		FROM PIM01106 A  
		JOIN LMV01106 C (NOLOCK) ON A.AC_CODE = C.AC_CODE  
		JOIN USERS D (NOLOCK) ON A.USER_CODE = D.USER_CODE  
		JOIN USERS E (NOLOCK) ON A.EDT_USER_CODE = E.USER_CODE 
		LEFT OUTER JOIN RMM01106 RMM ON RMM.REFMEMOID=A.MRR_ID  AND RMM.PRTSOURCE='PBM' AND RMM.CANCELLED=0
		WHERE A.MRR_ID = @CWHERE 
		AND ISNULL(A.PIM_MODE ,0)=5

		
    GOTO LAST
    
LBLDET:

		SELECT ROW_NUMBER() OVER (ORDER BY PIM.INV_NO) AS SRNO, PIM.INV_NO,PIM.RECEIPT_DT,K.SECTION_NAME
		, J.SUB_SECTION_NAME, I.UOM_NAME,I.UOM_TYPE, C.PARA1_NAME,    
		D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,B.ARTICLE_NO,     
		B.ARTICLE_NAME, B.CODING_SCHEME, A.*,
		--(A.PURCHASE_PRICE * A.QUANTITY) 
		PIM.TOTAL_AMOUNT AS 'AMOUNT',  
		ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],  
		ISNULL(SKU.DT_CREATED,'') AS [SKU_DT_CREATED],  
		A.QUANTITY AS [ORG_QUANTITY],CAST(0 AS NUMERIC(10,2)) AS [STK_QUANTITY],B.STOCK_NA,
		FORM.FORM_NAME,ISNULL(SKU.FIX_MRP,0) AS FIX_MRP,  SKU.PRODUCT_NAME,SKU.MRP,SKU.WS_PRICE,
		SKU.WS_PRICE AS WHOLESALE_PRICE,B.ALIAS AS ARTICLE_ALIAS
		FROM PID01106 A (NOLOCK)
		JOIN PIM01106 PIM (NOLOCK) ON A.MRR_ID  = PIM.MRR_ID 
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE 
		JOIN ARTICLE B (NOLOCK) ON SKU.ARTICLE_CODE = B.ARTICLE_CODE     
		JOIN PARA1 C (NOLOCK) ON SKU.PARA1_CODE = C.PARA1_CODE    
		JOIN PARA2 D (NOLOCK) ON SKU.PARA2_CODE = D.PARA2_CODE    
		JOIN PARA3 E (NOLOCK) ON SKU.PARA3_CODE = E.PARA3_CODE    
		JOIN PARA4 F (NOLOCK) ON SKU.PARA4_CODE = F.PARA4_CODE    
		JOIN PARA5 G (NOLOCK) ON SKU.PARA5_CODE = G.PARA5_CODE    
		JOIN PARA6 H (NOLOCK) ON SKU.PARA6_CODE = H.PARA6_CODE    
		JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE    
		JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE    
		JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE 
		JOIN FORM (NOLOCK) ON FORM.FORM_ID=A.FORM_ID 
		WHERE A.MRR_ID  = @CWHERE   
		ORDER BY PIM.INV_NO  
		    
		
		SELECT ROW_NUMBER() OVER (ORDER BY A.MRR_ID) AS SRNO,
		A.MRR_ID ,A.MRR_NO,A.RECEIPT_DT ,A.INV_NO 
		--,SUM((PBD.PURCHASE_PRICE * PBD.QUANTITY) + (CASE WHEN PBM.BILL_LEVEL_TAX_METHOD = 1 THEN PBD.TAX_AMOUNT ELSE 0 END)) AS TOTAL_AMOUNT 
		,A.TOTAL_AMOUNT AS TOTAL_AMOUNT
		,(PBD.QUANTITY) AS TOTAL_QTY  
		,'' AS FORM_NAME,'0000000' AS FORM_ID ,CAST(0 AS NUMERIC(5,2)) AS DISCOUNT_PERCENTAGE,
		CAST(0 AS NUMERIC(5,2)) AS TAX_PERCENTAGE,
		
	    ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,3),0) AS LEDGER_DISCOUNTPERCENTAGE	 
		,CONVERT(NUMERIC(18,2),0) AS LEDGER_DISCOUNTAMOUNT
		,CONVERT(NUMERIC(18,2),0)		AS LEDGER_EXCISEDUTYAMOUNT
        ,SUM(DBO.FN3SRETURNLEDGERTAX((PID.QUANTITY*PID.MRP),PID.TAX_PERCENTAGE,0,0,A.BILL_LEVEL_TAX_METHOD))			
        AS LEDGER_TAXAMOUNT
		,SUM(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,5),0)=1 THEN PID.TAX_AMOUNT
		ELSE 0 END)				AS LEDGER_POSTTAXDISCOUNTAMOUNT
		,(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,6),0)=0 THEN A.FREIGHT
			ELSE 0 END)		AS LEDGER_FREIGHT
	    ,(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,7),0)=0 THEN A.OTHER_CHARGES
			ELSE 0 END)		AS LEDGER_OTHERCHARGES
		,A.ROUND_OFF				AS LEDGER_ROUNDOFF
		,CONVERT(NUMERIC(18,2),0)		AS LEDGER_NETAMOUNT
		,SUM(PID.QUANTITY*PID.MRP)    AS LEDGER_MRPVALUE
	   ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_PURCHASEVALUE
	   ,ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,1),0)    AS LEDGER_MARKDOWN
	   ,A.OTHER_CHARGES,A.FREIGHT
	    INTO #PURCHASEHEADERDETAILS
		FROM PIM01106 A
		JOIN PID01106 PID (NOLOCK) ON A.MRR_ID =PID.MRR_ID 
		JOIN
		(
		 SELECT PBD.MRR_ID AS  REF_MRR_ID,SUM(QUANTITY) AS QUANTITY 
		 FROM  PID01106  PBD
		 JOIN PIM01106 PBM (NOLOCK) ON PBD.MRR_ID  = PBM.MRR_ID 
		 WHERE PBD.MRR_ID = @CWHERE
		 AND ISNULL(PBM.PIM_MODE,0)=5
		 GROUP BY PBD.MRR_ID
		) PBD  ON PBD.REF_MRR_ID=PID.MRR_ID 
		GROUP BY A.MRR_ID ,A.MRR_NO,A.RECEIPT_DT ,A.INV_NO ,A.TERMS,A.FREIGHT,A.OTHER_CHARGES,A.TOTAL_AMOUNT,A.ROUND_OFF,PBD.QUANTITY
		
		
		

		UPDATE #PURCHASEHEADERDETAILS
			SET LEDGER_PURCHASEVALUE=LEDGER_MRPVALUE-(LEDGER_MRPVALUE*LEDGER_MARKDOWN/100.00)
			  
	     UPDATE #PURCHASEHEADERDETAILS
			SET LEDGER_DISCOUNTAMOUNT=(LEDGER_PURCHASEVALUE*LEDGER_DISCOUNTPERCENTAGE/100)
	
	
		UPDATE #PURCHASEHEADERDETAILS
				SET LEDGER_NETAMOUNT=LEDGER_PURCHASEVALUE-LEDGER_DISCOUNTAMOUNT+LEDGER_EXCISEDUTYAMOUNT
									 +LEDGER_TAXAMOUNT-LEDGER_POSTTAXDISCOUNTAMOUNT+LEDGER_FREIGHT
									 +LEDGER_OTHERCHARGES	
		
		UPDATE #PURCHASEHEADERDETAILS 
				SET  LEDGER_ROUNDOFF =ROUND(LEDGER_NETAMOUNT,0)-LEDGER_NETAMOUNT
					,LEDGER_NETAMOUNT=ROUND(LEDGER_NETAMOUNT,0)
		
		UPDATE #PURCHASEHEADERDETAILS  SET LEDGER_DISCOUNTAMOUNT =(LEDGER_PURCHASEVALUE*LEDGER_DISCOUNTPERCENTAGE )/100 
	    
				
				
		SELECT *,(TOTAL_AMOUNT - LEDGER_NETAMOUNT) AS DIFF_NETAMOUNT FROM #PURCHASEHEADERDETAILS
		
    GOTO LAST
    
LBLPURMSTLIST:
		--CHANGE
		DECLARE @CUTOFDATE DATETIME
		SELECT @CUTOFDATE=ISNULL(VALUE,'') FROM CONFIG WHERE CONFIG_OPTION='PUR_CHALLAN_CUTOFDATE'	

		SET @CUTOFDATE=ISNULL(@CUTOFDATE,'')
					
        IF OBJECT_ID('TEMPDB..#TMPPURCHALLAN','U') IS NOT NULL 
            DROP TABLE #TMPPURCHALLAN
            
        SELECT  CAST(0 AS BIT) AS BILLCHECK, A.MRR_ID AS PS_ID,A.INV_NO AS PS_NO
				,A.RECEIPT_DT AS PS_DT,  SUM(B.INVOICE_QUANTITY) AS TOTAL_QTY,  
				CAST('' AS NVARCHAR(10)) AS SRNO ,A.REMARKS 
				,A.MRR_ID ,A.MRR_NO,A.RECEIPT_DT ,A.TOTAL_AMOUNT ,A.INV_NO 
				,'' AS FORM_NAME,'0000000' AS FORM_ID 
				,A.DISCOUNT_PERCENTAGE,A.DISCOUNT_AMOUNT				
				,CAST(0 AS NUMERIC(5,2)) AS TAX_PERCENTAGE 
				,C.AC_NAME,C.AC_CODE
				
				,ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,3),0) AS LEDGER_DISCOUNTPERCENTAGE	 
		        ,CONVERT(NUMERIC(18,2),0) AS LEDGER_DISCOUNTAMOUNT
		        ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_EXCISEDUTYAMOUNT
                ,SUM(DBO.FN3SRETURNLEDGERTAX((B.QUANTITY*B.MRP),B.TAX_PERCENTAGE,0,0,A.BILL_LEVEL_TAX_METHOD))			
                AS LEDGER_TAXAMOUNT
		        ,SUM(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,5),0)=1 THEN B.TAX_AMOUNT
		  		ELSE 0 END)				AS LEDGER_POSTTAXDISCOUNTAMOUNT
		       ,(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,6),0)=0 THEN A.FREIGHT
						ELSE 0 END)		AS LEDGER_FREIGHT
		       ,(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,7),0)=0 THEN A.OTHER_CHARGES
						ELSE 0 END)		AS LEDGER_OTHERCHARGES
		       ,A.ROUND_OFF				AS LEDGER_ROUNDOFF
		       ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_NETAMOUNT
		       ,SUM(B.QUANTITY*B.MRP)    AS LEDGER_MRPVALUE
		       ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_PURCHASEVALUE
		       ,ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,1),0)    AS LEDGER_MARKDOWN,A.TERMS
		       ,A.OTHER_CHARGES,A.FREIGHT

				INTO #TMPPURCHALLAN
				FROM PIM01106 A (NOLOCK) 
				JOIN PID01106 B (NOLOCK) ON A.MRR_ID = B.MRR_ID 
				JOIN LMV01106 C (NOLOCK) ON A.AC_CODE=C.AC_CODE
				WHERE A.CANCELLED = 0 
				--AND A.AC_CODE = @CWHERE 
				AND (@CWHERE='' OR A.AC_CODE=@CWHERE) 
				AND (@CUTOFDATE='' OR A.RECEIPT_DT>@CUTOFDATE) 
				AND A.RECEIPT_DT>=CONVERT(VARCHAR(10),DATEADD(MONTH,-6,@DLOGIN_DT),121) --ONLY BEFORE SIX MONTH CONVER TO MRRN 
				--AND A.FIN_YEAR = @CFINYEAR 
				AND A.DEPT_ID = @CDEPTID AND A.BILL_CHALLAN_MODE = 1 AND B.PRODUCT_CODE <> ''
				GROUP BY A.MRR_ID,A.INV_NO,A.INV_DT,A.REMARKS,A.MRR_NO,A.RECEIPT_DT,A.TOTAL_AMOUNT,A.DISCOUNT_PERCENTAGE,A.DISCOUNT_AMOUNT
				,C.AC_NAME,C.AC_CODE,A.TERMS,A.FREIGHT ,A.OTHER_CHARGES ,A.ROUND_OFF
        
        
    UPDATE #TMPPURCHALLAN
			SET LEDGER_PURCHASEVALUE=LEDGER_MRPVALUE-(LEDGER_MRPVALUE*LEDGER_MARKDOWN/100.00)
			  
	UPDATE #TMPPURCHALLAN
			SET LEDGER_DISCOUNTAMOUNT=(LEDGER_PURCHASEVALUE*LEDGER_DISCOUNTPERCENTAGE/100)
	
	
	UPDATE #TMPPURCHALLAN
			SET LEDGER_NETAMOUNT=LEDGER_PURCHASEVALUE-LEDGER_DISCOUNTAMOUNT+LEDGER_EXCISEDUTYAMOUNT
								 +LEDGER_TAXAMOUNT-LEDGER_POSTTAXDISCOUNTAMOUNT+LEDGER_FREIGHT
								 +LEDGER_OTHERCHARGES	
	
	UPDATE #TMPPURCHALLAN 
			SET  LEDGER_ROUNDOFF =ROUND(LEDGER_NETAMOUNT,0)-LEDGER_NETAMOUNT
				,LEDGER_NETAMOUNT=ROUND(LEDGER_NETAMOUNT,0)
	
	UPDATE #TMPPURCHALLAN  SET LEDGER_DISCOUNTAMOUNT =(LEDGER_PURCHASEVALUE*LEDGER_DISCOUNTPERCENTAGE )/100 
        
         
        IF OBJECT_ID('TEMPDB..#TMPMRNBILL','U') IS NOT NULL 
			DROP TABLE #TMPMRNBILL
        
        SELECT DISTINCT D.REF_MRR_ID,M.MEMO_ID INTO #TMPMRNBILL
			FROM PBD01106 D (NOLOCK)
			JOIN PBM01106 M (NOLOCK) ON D.MEMO_ID = M.MEMO_ID 
			WHERE M.CANCELLED = 0 
        
		SELECT D.*,(TOTAL_AMOUNT - LEDGER_NETAMOUNT) AS DIFF_NETAMOUNT,C.REF_MRR_ID  
		FROM #TMPPURCHALLAN D 
		JOIN
		(
			SELECT  A.MRR_ID, SUM(B.INVOICE_QUANTITY) AS TOTAL_QTY  
			FROM PIM01106 A (NOLOCK) 
			JOIN PID01106 B (NOLOCK) ON A.MRR_ID = B.MRR_ID 
			WHERE A.CANCELLED = 0 
			--AND A.AC_CODE = @CWHERE 
			AND (@CWHERE='' OR A.AC_CODE = @CWHERE) 
			--AND A.FIN_YEAR = @CFINYEAR 
			AND A.DEPT_ID = @CDEPTID AND A.BILL_CHALLAN_MODE = 1 
			GROUP BY A.MRR_ID
		)B ON D.PS_ID = B.MRR_ID AND D.TOTAL_QTY = B.TOTAL_QTY 
        LEFT OUTER JOIN #TMPMRNBILL C 
		ON D.PS_ID = C.REF_MRR_ID 
		WHERE (ISNULL(C.MEMO_ID,'') = @CWHERECLAUSE OR  C.REF_MRR_ID IS NULL)
		ORDER BY D.AC_NAME
       --------------
             
    GOTO LAST
    
    
LBLPURDETLIST:  
 --   SET @CCMD=N'SELECT CAST(0 AS BIT) AS BILLCHECK  
 --    ,W1.*,W1.MRR_ID AS REF_MRR_ID,W1.MRR_ID AS PS_ID ,W2.INV_NO AS PS_NO  ,W2.INV_NO
	-- ,W2.INV_DT AS PS_DT ,W2.INV_DT,W2.RECEIPT_DT ,W2.VANDOR_BILL_DT
	-- ,A.ARTICLE_CODE ,B.ARTICLE_NO ,B.ARTICLE_NAME  
	-- ,C.PARA1_NAME,D.PARA2_NAME ,F.PARA3_NAME,PARA4_NAME ,PARA5_NAME,PARA6_NAME  
	-- ,E.UOM_NAME,E.UOM_TYPE,B.UOM_CODE
	-- ,B.CODING_SCHEME,A.PURCHASE_PRICE,ISNULL(A.FIX_MRP,0) AS FIX_MRP,A.MRP,A.WS_PRICE,A.WS_PRICE AS WHOLESALE_PRICE
	-- ,SM.SECTION_NAME,SD.SUB_SECTION_NAME,B.STOCK_NA  
	-- ,F1.FORM_NAME,F1.TAX_PERCENTAGE,A.PRODUCT_NAME 
	-- ,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE]  
	-- ,ISNULL(B.DT_CREATED,'''') AS [ART_DT_CREATED]  
	-- ,F.DT_CREATED AS [PARA3_DT_CREATED]  
	-- ,A.DT_CREATED AS [SKU_DT_CREATED],B.ALIAS AS ARTICLE_ALIAS 
	-- --,W2.TOTAL_AMOUNT AS AMOUNT 
	-- ,W1.PURCHASE_PRICE * W1.INVOICE_QUANTITY	AS AMOUNT 
	-- FROM PID01106  W1 (NOLOCK)   
	-- JOIN PIM01106 W2 (NOLOCK) ON W1.MRR_ID= W2.MRR_ID 
	-- JOIN SKU A       (NOLOCK) ON A.PRODUCT_CODE=W1.PRODUCT_CODE        
	-- JOIN ARTICLE B   (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE            
	-- JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE          
	-- JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE          
	-- JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE            
	-- JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE            
	-- JOIN PARA3 F (NOLOCK) ON A.PARA3_CODE = F.PARA3_CODE            
	-- JOIN PARA4 G (NOLOCK) ON A.PARA4_CODE = G.PARA4_CODE            
	-- JOIN PARA5 H (NOLOCK) ON A.PARA5_CODE = H.PARA5_CODE            
	-- JOIN PARA6 I (NOLOCK) ON A.PARA6_CODE = I.PARA6_CODE   
	-- LEFT OUTER JOIN UOM E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE       
	-- JOIN FORM F1 (NOLOCK) ON W1.FORM_ID = F1.FORM_ID    
 --    WHERE W2.MRR_ID IN ('+ @CWHERECLAUSE +')'
	
	--PRINT @CCMD  
	--EXEC SP_EXECUTESQL @CCMD
	
	SET @CCMD=N' IF OBJECT_ID(''TEMPDB..#TMP'',''U'') IS NOT NULL
                  DROP TABLE #TMP
    SELECT CAST(0 AS BIT) AS BILLCHECK  
     ,W1.*,W1.MRR_ID AS REF_MRR_ID,W1.MRR_ID AS PS_ID ,W2.INV_NO AS PS_NO  ,W2.INV_NO
	 ,W2.INV_DT AS PS_DT ,W2.INV_DT,W2.RECEIPT_DT ,W2.INV_DT AS VANDOR_BILL_DT
	 ,A.ARTICLE_CODE AS SKU_ARTICLE_CODE 
	 ,B.ARTICLE_NO ,B.ARTICLE_NAME  
	 ,C.PARA1_NAME,D.PARA2_NAME ,F.PARA3_NAME,PARA4_NAME ,PARA5_NAME,PARA6_NAME  
	 ,E.UOM_NAME,E.UOM_TYPE,B.UOM_CODE
	 ,B.CODING_SCHEME,A.PURCHASE_PRICE AS SKU_PURCHASE_PRICE,ISNULL(A.FIX_MRP,0) AS SKU_FIX_MRP,A.MRP AS SKU_MRP,
	 A.WS_PRICE,A.WS_PRICE AS SKU_WHOLESALE_PRICE
	 ,SM.SECTION_NAME,SD.SUB_SECTION_NAME,B.STOCK_NA  
	 ,F1.FORM_NAME,F1.TAX_PERCENTAGE AS FORM_TAX_PERCENTAGE,A.PRODUCT_NAME 
	 ,ISNULL(E.UOM_TYPE,0) AS [UOM_UOM_TYPE]  
	 ,ISNULL(B.DT_CREATED,'''') AS [ART_DT_CREATED]  
	 ,F.DT_CREATED AS [PARA3_DT_CREATED]  
	 ,A.DT_CREATED AS [SKU_DT_CREATED],B.ALIAS AS ARTICLE_ALIAS 
	 --,W2.TOTAL_AMOUNT AS AMOUNT 
	 ,W1.PURCHASE_PRICE * W1.INVOICE_QUANTITY	AS AMOUNT 
	 ,CONVERT(NUMERIC(10,2),ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)) AS SKU_DISCOUNT_AMOUNT
	 ,((CONVERT(NUMERIC(10,2),ISNULL(SKU_OH.DISCOUNT_AMOUNT,0))* 100)/ A.PURCHASE_PRICE ) AS SKU_DISCOUNT_PERCENTAGE
	 INTO #TMP
	 FROM PID01106  W1 (NOLOCK)   
	 JOIN PIM01106 W2 (NOLOCK) ON W1.MRR_ID= W2.MRR_ID 
	 JOIN SKU A       (NOLOCK) ON A.PRODUCT_CODE=W1.PRODUCT_CODE        
	 JOIN ARTICLE B   (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE            
	 JOIN SECTIOND SD (NOLOCK) ON B.SUB_SECTION_CODE = SD.SUB_SECTION_CODE          
	 JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE          
	 JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE            
	 JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE            
	 JOIN PARA3 F (NOLOCK) ON A.PARA3_CODE = F.PARA3_CODE            
	 JOIN PARA4 G (NOLOCK) ON A.PARA4_CODE = G.PARA4_CODE            
	 JOIN PARA5 H (NOLOCK) ON A.PARA5_CODE = H.PARA5_CODE            
	 JOIN PARA6 I (NOLOCK) ON A.PARA6_CODE = I.PARA6_CODE   
	 LEFT OUTER JOIN UOM E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE       
	 JOIN FORM F1 (NOLOCK) ON W1.FORM_ID = F1.FORM_ID  
	 LEFT OUTER JOIN SKU_OH(NOLOCK) ON SKU_OH.PRODUCT_CODE=A.PRODUCT_CODE  
     WHERE W2.MRR_ID IN ('+ @CWHERECLAUSE +')
     
     
     UPDATE #TMP SET DISCOUNT_AMOUNT=SKU_DISCOUNT_AMOUNT, DISCOUNT_PERCENTAGE=SKU_DISCOUNT_PERCENTAGE,
     PURCHASE_PRICE=GROSS_PURCHASE_PRICE-SKU_DISCOUNT_AMOUNT
     
     SELECT * FROM #TMP'
     
     
	
	PRINT @CCMD  
	EXEC SP_EXECUTESQL @CCMD
GOTO LAST


        
LBLPURMSTBILL:    
    
 IF OBJECT_ID('TEMPDB..#TMPPURCHALLAN1','U') IS NOT NULL     
 DROP TABLE #TMPPURCHALLAN1    
  
 SELECT  CAST(0 AS BIT) AS BILLCHECK, A.MRR_ID AS PS_ID,A.BILL_NO AS PS_NO    
 ,A.RECEIPT_DT AS PS_DT,  SUM(B.INVOICE_QUANTITY) AS TOTAL_QTY,      
 CAST('' AS NVARCHAR(10)) AS SRNO ,A.REMARKS     
 ,A.MRR_ID ,A.MRR_NO,A.RECEIPT_DT ,A.TOTAL_AMOUNT ,A.BILL_NO     
 ,'' AS FORM_NAME,'0000000' AS FORM_ID 
 ,CAST(0 AS NUMERIC(5,2)) AS DISCOUNT_PERCENTAGE    
 ,CAST(0 AS NUMERIC(5,2)) AS TAX_PERCENTAGE,A.CREDIT_DAYS,A.CR_DISCOUNT_PERCENTAGE,
 C.AC_NAME,A.AC_CODE
  --LEDGER DETAILS
 ,ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,3),0) AS LEDGER_DISCOUNTPERCENTAGE	 
 ,CONVERT(NUMERIC(18,2),0) AS LEDGER_DISCOUNTAMOUNT
 ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_EXCISEDUTYAMOUNT
 ,SUM(DBO.FN3SRETURNLEDGERTAX((B.QUANTITY*B.MRP),B.TAX_PERCENTAGE,0,0,A.BILL_LEVEL_TAX_METHOD))			
  AS LEDGER_TAXAMOUNT
 ,SUM(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,5),0)=1 THEN B.TAX_AMOUNT
   ELSE 0 END)				AS LEDGER_POSTTAXDISCOUNTAMOUNT
 ,(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,6),0)=0 THEN A.FREIGHT
   ELSE 0 END)		AS LEDGER_FREIGHT
 ,(CASE WHEN ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,7),0)=0 THEN A.OTHER_CHARGES
  ELSE 0 END)		AS LEDGER_OTHERCHARGES
 ,A.ROUND_OFF				AS LEDGER_ROUNDOFF
 ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_NETAMOUNT
 ,SUM(B.QUANTITY*B.MRP)    AS LEDGER_MRPVALUE
 ,CONVERT(NUMERIC(18,2),0)		AS LEDGER_PURCHASEVALUE
 ,ISNULL(DBO.FN3SREADLEDGERTERMS(A.TERMS,1),0)    AS LEDGER_MARKDOWN  
 INTO #TMPPURCHALLAN1    
 FROM PIM01106 A (NOLOCK)     
 JOIN PID01106 B (NOLOCK)ON A.MRR_ID = B.MRR_ID  
 JOIN LMV01106 C (NOLOCK)ON C.AC_CODE = A.AC_CODE     
 WHERE A.CANCELLED = 0     
 --AND A.FIN_YEAR = @CFINYEAR     
 AND A.DEPT_ID = @CDEPTID AND A.BILL_CHALLAN_MODE = 0 AND B.PRODUCT_CODE <> '' 
 AND  (@CBILLNO='' OR A.BILL_NO= @CBILLNO)   
 GROUP BY A.MRR_ID,A.BILL_NO,A.INV_DT,A.REMARKS,A.MRR_NO,A.RECEIPT_DT,A.TOTAL_AMOUNT,A.CREDIT_DAYS,
 A.CR_DISCOUNT_PERCENTAGE, C.AC_NAME,A.AC_CODE,
 A.TERMS,A.FREIGHT ,A.OTHER_CHARGES,A.ROUND_OFF,A.SUBTOTAL   
 
   UPDATE #TMPPURCHALLAN1
			SET LEDGER_PURCHASEVALUE=LEDGER_MRPVALUE-(LEDGER_MRPVALUE*LEDGER_MARKDOWN/100.00)
			  
	UPDATE #TMPPURCHALLAN1
			SET LEDGER_DISCOUNTAMOUNT=(LEDGER_PURCHASEVALUE*LEDGER_DISCOUNTPERCENTAGE/100)
	
	
	UPDATE #TMPPURCHALLAN1
			SET LEDGER_NETAMOUNT=LEDGER_PURCHASEVALUE-LEDGER_DISCOUNTAMOUNT+LEDGER_EXCISEDUTYAMOUNT
								 +LEDGER_TAXAMOUNT-LEDGER_POSTTAXDISCOUNTAMOUNT+LEDGER_FREIGHT
								 +LEDGER_OTHERCHARGES	
	
	UPDATE #TMPPURCHALLAN1 
			SET  LEDGER_ROUNDOFF =ROUND(LEDGER_NETAMOUNT,0)-LEDGER_NETAMOUNT
				,LEDGER_NETAMOUNT=ROUND(LEDGER_NETAMOUNT,0)
	
	UPDATE #TMPPURCHALLAN1  SET LEDGER_DISCOUNTAMOUNT =(LEDGER_PURCHASEVALUE*LEDGER_DISCOUNTPERCENTAGE )/100 
        
	
 IF OBJECT_ID('TEMPDB..#TMPMRNBILL1','U') IS NOT NULL     
 DROP TABLE #TMPMRNBILL1    
  
 SELECT DISTINCT D.REF_MRR_ID,M.MEMO_ID INTO #TMPMRNBILL1    
 FROM PBD01106 D (NOLOCK)    
 JOIN PBM01106 M (NOLOCK) ON D.MEMO_ID = M.MEMO_ID     
 WHERE M.CANCELLED = 0     
  
 SELECT D.*,C.REF_MRR_ID      
 FROM #TMPPURCHALLAN1 D     
 JOIN    
 (    
 SELECT  A.MRR_ID, SUM(B.INVOICE_QUANTITY) AS TOTAL_QTY      
 FROM PIM01106 A (NOLOCK)     
 JOIN PID01106 B (NOLOCK)ON A.MRR_ID = B.MRR_ID     
 WHERE A.CANCELLED = 0 -- AND A.AC_CODE = @CWHERE     
 --AND A.FIN_YEAR = @CFINYEAR     
 AND A.DEPT_ID = @CDEPTID AND A.BILL_CHALLAN_MODE = 0    
 GROUP BY A.MRR_ID    
 ) B ON D.PS_ID = B.MRR_ID AND D.TOTAL_QTY = B.TOTAL_QTY     
 LEFT OUTER JOIN #TMPMRNBILL1 C     
 ON D.PS_ID = C.REF_MRR_ID     
 WHERE (ISNULL(C.MEMO_ID,'') = @CWHERECLAUSE OR  C.REF_MRR_ID IS NULL)      
 GOTO LAST    

LAST:

END
