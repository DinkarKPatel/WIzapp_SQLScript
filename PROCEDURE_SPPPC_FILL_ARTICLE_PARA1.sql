CREATE PROCEDURE SPPPC_FILL_ARTICLE_PARA1    
(    
 @NQUERYID   INT,      
 @VARTICLECODE  VARCHAR(500),    
 @VPARAMETER  VARCHAR(500) ,
 @CROW_ID VARCHAR(100)=''   
)    
AS        
BEGIN     
 DECLARE @CSTEP INT, @CCMD NVARCHAR(MAX), @ERRMSG_OUT VARCHAR(MAX)    
    
 BEGIN TRY    
  SET NOCOUNT ON;    
      
  SET @ERRMSG_OUT = ''    
      
  IF @NQUERYID = 1    
   -- GET ARTICLE PARA1 LIST    
   GOTO LBLGETPARA1LIST    
       
  ELSE IF @NQUERYID = 2    
   -- GET ARTICLE PARA1 USING LIKE    
   GOTO LBLGETPARA1LIKE    
      
  ELSE IF @NQUERYID = 7    
   -- GET INFO BY PARA1 NAME    
   GOTO LBLGETINFOBYPARA1NAME    
    
  ELSE    
   GOTO LAST    
    
-- GET ARTICLE PARA1 LIST    
LBLGETPARA1LIST:    
  SET @CSTEP = 101    
  IF OBJECT_ID('TEMPDB..#TMPPARA1','U') IS NOT NULL    
   DROP TABLE #TMPPARA1    
   
   SELECT A.ARTICLE_CODE, A.PARA1_CODE, B.PARA1_NAME    
   INTO #TMPPARA1    
   FROM ART_PARA1 A 
   JOIN PARA1 B ON A.PARA1_CODE=B.PARA1_CODE 
   WHERE 1=2
   IF ISNULL(@CROW_ID,'')=''
   BEGIN
       INSERT INTO #TMPPARA1(ARTICLE_CODE,PARA1_CODE,PARA1_NAME)
	   SELECT A.ARTICLE_CODE, A.PARA1_CODE, B.PARA1_NAME        
	   FROM ART_PARA1 A 
	   JOIN PARA1 B ON A.PARA1_CODE=B.PARA1_CODE    
	   WHERE  A.ARTICLE_CODE = @VARTICLECODE AND
		ISNULL(B.PARA1_NAME,'') <> ''    
	   ORDER BY B.PARA1_NAME   
   END
   ELSE
   BEGIN
        INSERT INTO #TMPPARA1(ARTICLE_CODE,PARA1_CODE,PARA1_NAME)
       SELECT A.ARTICLE_CODE, A.PARA1_CODE, B.PARA1_NAME   
       FROM PPC_BUYER_ORDER_DET A
       JOIN PARA1 B ON A.PARA1_CODE=B.PARA1_CODE 
       WHERE ROW_ID=@CROW_ID 
   
   END 
       
   IF NOT EXISTS (SELECT TOP 1 'U' FROM #TMPPARA1 )    
   BEGIN    
    INSERT INTO #TMPPARA1 (ARTICLE_CODE,PARA1_CODE,PARA1_NAME)    
    SELECT @VARTICLECODE AS ARTICLE_CODE, A.PARA1_CODE, A.PARA1_NAME    
    FROM PARA1 A    
    WHERE INACTIVE=0    
   END    
       
   SELECT * FROM #TMPPARA1 ORDER BY PARA1_NAME    
      
  GOTO LAST    
    
    
-- GET ARTICLE PARA1 USING LIKE    
LBLGETPARA1LIKE:    
  SET @CSTEP = 102    
  SELECT  A.ARTICLE_CODE, A.PARA1_CODE, B.PARA1_NAME    
  FROM ART_PARA1 A JOIN PARA1 B ON A.PARA1_CODE=B.PARA1_CODE    
  WHERE A.ARTICLE_CODE = @VARTICLECODE AND ISNULL(B.PARA1_NAME,'') <> ''    
  AND B.PARA1_NAME LIKE '%'+ @VPARAMETER +'%'    
  ORDER BY A.ARTICLE_CODE,B.PARA1_NAME    
      
  GOTO LAST    
    
    
-- GET INFO BY PARA1 NAME    
LBLGETINFOBYPARA1NAME:    
  SET @CSTEP = 107    
  SELECT A.PARA1_CODE, A.PARA1_NAME    
  FROM [PARA1] A (NOLOCK)     
  WHERE A.PARA1_NAME = @VPARAMETER    
      
  GOTO LAST    
  
  
  
      
      
LAST:       
 GOTO END_PROC    
    
  SET NOCOUNT OFF;    
 END TRY      
 BEGIN CATCH      
  SET @ERRMSG_OUT='ERROR: [P]: SPPPC_FILL_ARTICLE_PARA1, [STEP]: '+CAST(@CSTEP AS VARCHAR(5))+', [MESSAGE]: ' + ERROR_MESSAGE()    
  GOTO END_PROC      
 END CATCH       
    
END_PROC:      
 IF  ISNULL(@ERRMSG_OUT,'')<>''     
  SELECT @ERRMSG_OUT AS ERRORMSG    
END
