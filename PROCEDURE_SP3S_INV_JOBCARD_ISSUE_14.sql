create PROCEDURE [DBO].[SP3S_INV_JOBCARD_ISSUE_14]          
(          
  @IMODE INT ,          
  @CWHERE VARCHAR(MAX)='',      
  @CAGENCYCODE VARCHAR(20)='',      
  @FINYEAR VARCHAR(10)=''  ,    
  @DEPTID VARCHAR(10)='' ,
  @NRETURNMODE INT=0
          
)      
----WITH ENCRYPTION
AS          
          
BEGIN        
 DECLARE @CCMD NVARCHAR(MAX) 
 --LBLPENDINGJOBCARD_BOM_SAVED: 14
	;WITH BOM_ISSUE_SUMMARY
	AS
	(
		SELECT A.*,B.MEMO_ID AS ORD_PLAN_MEMO_ID,B.ROW_ID AS ORD_PLAN_DET_ROW_ID,CONVERT(NUMERIC(14,2),((A.AVG_QUANTITY+A.ADD_AVG_QUANTITY) * B.ISSUED_QTY)) AS REQ_QTY
		FROM ORD_PLAN_BOM_DET A (NOLOCK)
		JOIN
		(
			SELECT A.JOB_CODE,D.MEMO_ID,C.ROW_ID,C.ARTICLE_CODE,C.PARA1_CODE,C.PARA2_CODE,SUM(A.QUANTITY) AS ISSUED_QTY
			FROM JOBWORK_ISSUE_DET A (NOLOCK)
			JOIN JOBWORK_ISSUE_MST A1 (NOLOCK) ON A1.ISSUE_ID=A.ISSUE_ID
			JOIN ORD_PLAN_BARCODE_DET B (NOLOCK) ON B.PRODUCT_CODE=A.PRODUCT_CODE
			JOIN ORD_PLAN_DET C (NOLOCK) ON C.ROW_ID=B.REFROW_ID
			JOIN ORD_PLAN_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID
			WHERE D.CANCELLED=0 AND ISNULL(D.SHORT_CLOSE,0)=0 AND A.ISSUE_ID=@CWHERE-- A1.CANCELLED=0 AND 
			GROUP BY D.MEMO_ID,C.ROW_ID, C.ARTICLE_CODE,C.PARA1_CODE,C.PARA2_CODE,A.JOB_CODE
		)B ON B.ROW_ID=A.REF_ROW_ID and a.JOB_CODE =b.job_code 
		--JOIN JOBWORK_ISSUE_BOM C (NOLOCK) ON C.ISSUE_ID=@CWHERE AND C.ARTICLE_CODE=A.ARTICLE_CODE 
		--							AND C.PARA1_CODE=A.PARA1_CODE AND C.PARA2_CODE=A.PARA2_CODE				
	)
	SELECT CAST(1 AS BIT) AS [CHK],T.ARTICLE_CODE,T.PARA1_CODE,T.PARA2_CODE ,C.PARA1_NAME,        
		 D.PARA2_NAME,B.ARTICLE_NO,B.ARTICLE_NAME,
		  SUM(QUANTITY) AS QUANTITY,SUM(REQ_QTY) AS REQ_QTY,
		  ISNULL(SUM(X.ISSUED_QTY),0) AS ISSUED_QTY,
		  CAST(SUM(REQ_QTY)-ISNULL(SUM(X.ISSUED_QTY),0) AS NUMERIC(14,2)) AS PENDING_QTY,
		  CONVERT(NUMERIC(14,2), SUM(CASE WHEN ISNULL(UC.CONVERSION_VALUE,0) =0 THEN REQ_QTY-ISNULL(X.ISSUED_QTY,0)
	         ELSE (REQ_QTY-ISNULL(X.ISSUED_QTY,0))/ISNULL(UC.CONVERSION_VALUE,0) END)  ) AS STOCK_QTY ,
	ISNULL(bu.CONVERSION_UOM_NAME,I.UOM_NAME) as UOM_NAME,
	I.UOM_NAME AS STOCK_UOM
	FROM BOM_ISSUE_SUMMARY T 
	JOIN ARTICLE B (NOLOCK) ON T.ARTICLE_CODE = B.ARTICLE_CODE         
	JOIN PARA1 C (NOLOCK) ON T.PARA1_CODE = C.PARA1_CODE        
	JOIN PARA2 D (NOLOCK) ON T.PARA2_CODE = D.PARA2_CODE        
	JOIN PARA3 E (NOLOCK) ON T.PARA3_CODE = E.PARA3_CODE        
	JOIN PARA4 F (NOLOCK) ON T.PARA4_CODE = F.PARA4_CODE        
	JOIN PARA5 G (NOLOCK) ON T.PARA5_CODE = G.PARA5_CODE        
	JOIN PARA6 H (NOLOCK) ON T.PARA6_CODE = H.PARA6_CODE        
	JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE        
	JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE        
	JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE 
	LEFT OUTER JOIN UOM_CONVERSION UC (NOLOCK) ON UC.UOM_CODE=i.UOM_CODE
    LEFT OUTER JOIN BOM_UOM BU (NOLOCK) ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE
	LEFT OUTER JOIN
	(
		SELECT A1.MEMO_ID, A1.REF_ROW_ID,A1.ARTICLE_CODE,A1.PARA1_CODE,A1.PARA2_CODE,
		SUM(A6.QUANTITY) AS ISSUED_QTY
		FROM BOM_ISSUE_DET A4 (NOLOCK) 
		JOIN BOM_ISSUE_MST A5  (NOLOCK) ON A5.ISSUE_ID=A4.ISSUE_ID
		JOIN BOM_ISSUE_REF A6  (NOLOCK) ON A5.ISSUE_ID=A6.BOM_ISSUE_ID AND A4.ROW_ID=A6.BOM_DET_ROW_ID
		JOIN ORD_PLAN_BOM_DET A1  (NOLOCK) ON A1.ROW_ID=A6.ORD_PLAN_BOM_DET_ROW_ID
		WHERE A5.CANCELLED=0 --AND A1.MEMO_ID='AK0111900000AK00000061'
		GROUP BY A1.MEMO_ID, A1.REF_ROW_ID,A1.ARTICLE_CODE,A1.PARA1_CODE,A1.PARA2_CODE--,A6.ORD_PLAN_BOM_DET_ROW_ID
	)X ON X.REF_ROW_ID=T.ORD_PLAN_DET_ROW_ID	AND X.MEMO_ID=T.ORD_PLAN_MEMO_ID
	AND X.ARTICLE_CODE=T.ARTICLE_CODE AND X.PARA1_CODE=T.PARA1_CODE AND X.PARA2_CODE=T.PARA2_CODE
	GROUP BY T.ARTICLE_CODE,T.PARA1_CODE,T.PARA2_CODE ,C.PARA1_NAME,        
		 D.PARA2_NAME,B.ARTICLE_NO,B.ARTICLE_NAME,I.UOM_NAME,
		 ISNULL(bu.CONVERSION_UOM_NAME,I.UOM_NAME)	
	--;WITH BOM_SUMRRY
	--AS
	--(
	--	--SELECT T.MEMO_ID,T.ROW_ID, T.ARTICLE_CODE,T.PARA1_CODE,T.PARA2_CODE,T.PARA3_CODE,T.PARA4_CODE,T.PARA5_CODE,T.PARA6_CODE
	--	--,T.QUANTITY,ISNULL(X.ISSUED_QTY,0) AS ISSUED_QTY,(T.QUANTITY-ISNULL(X.ISSUED_QTY,0)) AS PENDING_QTY
	--	--FROM ORD_PLAN_BOM_DET T (NOLOCK)    
	--	--JOIN ORD_PLAN_DET T1 (NOLOCK) ON  T.REF_ROW_ID=T1.ROW_ID AND T1.MEMO_ID=T.MEMO_ID
	--	--JOIN ORD_PLAN_MST T2 (NOLOCK) ON  T1.MEMO_ID=T2.MEMO_ID 	
	--	--LEFT OUTER JOIN
	--	--(
	--	--	SELECT A4.ORD_PLAN_BOM_DET_ROW_ID AS ROW_ID,SUM(A4.QUANTITY) AS ISSUED_QTY
	--	--	FROM BOM_ISSUE_DET A4 (NOLOCK) 
	--	--	JOIN BOM_ISSUE_MST A5  (NOLOCK) ON A5.ISSUE_ID=A4.ISSUE_ID
	--	--	JOIN ORD_PLAN_BOM_DET A1  (NOLOCK) ON A1.ROW_ID=A4.ORD_PLAN_BOM_DET_ROW_ID
	--	--	WHERE A5.CANCELLED=0 AND A1.MEMO_ID=@CWHERE 
	--	--	GROUP BY A4.ORD_PLAN_BOM_DET_ROW_ID
	--	--)X ON X.ROW_ID=T.ROW_ID 
	--	--WHERE T.MEMO_ID=@CWHERE 
		
	--	SELECT * FROM JOBWORK_ISSUE_BOM WHERE ISSUE_ID=@CWHERE 
	--)
	--SELECT CAST(1 AS BIT) AS CHK,A.ISSUE_ID AS MEMO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,'' AS PARA3_CODE,'' AS PARA4_CODE,'' AS PARA5_CODE,'' AS PARA6_CODE
	--,B.ARTICLE_NO,C.PARA1_NAME,D.PARA2_NAME,'' AS PARA3_NAME,'' AS PARA4_NAME,'' AS PARA5_NAME,'' AS PARA6_NAME,I.UOM_NAME
	--,CAST(0 AS NUMERIC(14,2)) AS QUANTITY,CAST(0 AS NUMERIC(14,2)) AS ISSUED_QTY,CAST(0 AS NUMERIC(14,2)) AS PENDING_QTY ,A.ISSUE_ID,A.ROW_ID 
	--FROM BOM_SUMRRY A
	--JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE         
	--JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE        
	--JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE        
	----JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE        
	----JOIN PARA4 F (NOLOCK) ON A.PARA4_CODE = F.PARA4_CODE        
	----JOIN PARA5 G (NOLOCK) ON A.PARA5_CODE = G.PARA5_CODE        
	----JOIN PARA6 H (NOLOCK) ON A.PARA6_CODE = H.PARA6_CODE        
	--JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE        
	--JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE        
	--JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE 
	
	
	
	
END
