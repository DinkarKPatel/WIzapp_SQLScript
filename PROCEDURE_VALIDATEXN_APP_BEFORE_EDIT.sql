CREATE PROC VALIDATEXN_APP_BEFORE_EDIT 
@CMEMOID VARCHAR(30),
@BCANCELXN BIT,
@CERRORMSG VARCHAR(200) OUTPUT,
@CEXPRERRORMSG VARCHAR(200) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	
	   
 DECLARE @CTEXT VARCHAR(10)  
   
 SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)  
  
 IF EXISTS(SELECT TOP 1 A.CM_ID FROM CMM01106 A JOIN APM01106 B ON A.REF_CM_ID=B.MEMO_ID  
     WHERE B.MEMO_ID=@CMEMOID AND A.CANCELLED=0 )        
   
 BEGIN  
  SET @CERRORMSG='Retail Bill has been raised against this approval memo.........Cannot '+@CTEXT  
  RETURN  
 END  
 
  IF EXISTS(SELECT TOP 1 A.REF_INV_ID FROM INM01106 A JOIN APM01106 B ON A.REF_INV_ID=B.MEMO_ID  
     WHERE B.MEMO_ID=@CMEMOID AND A.CANCELLED=0 )        
   
 BEGIN  
  SET @CERRORMSG='WSL Bill has been raised against this approval memo.........Cannot '+@CTEXT  
  RETURN  
 END 
 
     
 IF EXISTS(SELECT TOP 1 A.ROW_ID FROM APPROVAL_RETURN_DET A JOIN APD01106 B ON A.APD_ROW_ID=B.ROW_ID
    JOIN approval_return_mst c (NOLOCK) ON c.memo_id=a.memo_id
     WHERE B.MEMO_ID=@CMEMOID AND c.cancelled=0)        
   
 BEGIN  
  SET @CERRORMSG='ITEMS HAVE BEEN TAKEN BACK AGAINST THIS APPROVAL MEMO.........CAN NOT '+@CTEXT  
  RETURN  
 END  

  
 
     
			
END
