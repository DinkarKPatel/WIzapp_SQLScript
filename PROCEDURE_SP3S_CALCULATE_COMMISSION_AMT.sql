CREATE PROCEDURE  SP3S_CALCULATE_COMMISSION_AMT  --(LocId 3 digit change by Sanjay:04-11-2024)
(   
 @UPDATEMODE INT,  
 @CM_ID VARCHAR(40)='',  
 @CFROMDT DATETIME='',  
 @CTODT DATETIME=''  
)     
AS  
BEGIN  
  
   BEGIN TRY   
     
    DECLARE @cSourceLocationCode VARCHAR(4)	
    IF @UPDATEMODE=1 AND ISNULL(@CFROMDT,'')<> '' AND ISNULL(@CTODT,'')<>''  
    BEGIN  
         SELECT DISTINCT CAST(0 AS BIT) AS CHK,CM_NO,A.CM_ID,CM_DT FROM CMM01106  A(NOLOCK) JOIN CMD01106 B(NOLOCK) ON A.CM_ID=B.CM_ID  
         WHERE CANCELLED=0 AND CM_DT BETWEEN @CFROMDT AND @CTODT AND ISNULL(COMMISSION_AMOUNT,0)=0  
         GOTO END_PROC  
           
    END  
    IF @UPDATEMODE=2 AND ISNULL(@CM_ID,'')<>''  
    BEGIN  
     
   DECLARE @CSTEP VARCHAR(10),@DCM_DT DATETIME,@CCCOMM_MEMO_ID VARCHAR(50),@NFILTERMODE INT,  
           @CCOMMMEMO_NO VARCHAR(50),@CFILTER VARCHAR(MAX),@DTSQL NVARCHAR(MAX),@DISC_METHOD INT,  
           @CERRMSG VARCHAR(MAX),@cROW_ID VARCHAR(100)  ,@csls_title varchar(50)
   SET @CSTEP=10  
        
      UPDATE A SET COMMISSION_AMOUNT=0   
      FROM CMD01106 A (NOLOCK)  
      WHERE CM_ID=@CM_ID  
        
      SET @CERRMSG=''  
      SELECT @DCM_DT=CM_DT  FROM CMM01106  (NOLOCK) WHERE CM_ID=@CM_ID  
        
      SELECT TOP 1 @cSourceLocationCode=location_code from  cmm01106 (NOLOCK) WHERE cm_id=@CM_ID  

      IF OBJECT_ID('TEMPDB..#TMPALLMEMO','U') IS NOT NULL  
         DROP TABLE #TMPALLMEMO  
           
       SELECT   FILTER_MODE,A.SLS_MEMO_NO,A.SLS_MEMO_DT,B.SLS_ORDER , SLS_FROM_DT , SLS_TO_DT  ,ROW_ID
      INTO #TMPALLMEMO  
      FROM SLSMST A  
      JOIN SLSDET B ON A.SLS_MEMO_NO=B.SLS_MEMO_NO  
	  JOIN LOCSLSSET LOC (NOLOCK) ON LOC.sls_memo_no =A.sls_memo_no 
      WHERE @DCM_DT BETWEEN SLS_FROM_DT AND SLS_TO_DT 
	  AND LOC.dept_id =@cSourceLocationCode
    
        
--SELECT * FROM    #TMPALLMEMO     
      
      WHILE EXISTS(SELECT TOP 1 'U' FROM #TMPALLMEMO)  
      BEGIN  
        
		--as Discuss with sanjiv sir ordering on slsorder and SLS_MEMO_DT DESC
      SELECT  TOP 1 @NFILTERMODE=FILTER_MODE,@CCOMMMEMO_NO= SLS_MEMO_NO  ,@cROW_ID=row_id
      FROM #TMPALLMEMO  
	  Order by SLS_ORDER,SLS_MEMO_DT DESC, SLS_MEMO_NO  DESC
    --  ORDER BY SLS_MEMO_DT DESC, SLS_MEMO_NO  DESC ,SLS_ORDER  


        
      IF NOT  EXISTS(SELECT TOP 1'U' FROM CMD01106 A (NOLOCK) WHERE ISNULL(COMMISSION_AMOUNT,0)=0  
       AND CM_ID=@CM_ID)  
      GOTO END_PROC  
      --1-FOR FILTER  2-FOR PRODUCT_CODE 3-FOR ARTICLE  
      --SELECT @CCOMMMEMO_NO  
        
      IF ISNULL(@CCOMMMEMO_NO,'')=''  
      GOTO END_PROC  
       
       --SELECT @NFILTERMODE,ISNULL(@CCOMMMEMO_NO,'')
      IF @NFILTERMODE=1  
      BEGIN  
           SET @CSTEP=20   
           DECLARE @D_FILTER VARCHAR(MAX),@NDISCOUNT_PCT NUMERIC(10,2),@NDISCOUNT_AMT NUMERIC(18,2)  
             
           SELECT @D_FILTER=ISNULL(D_FILTER,''),@NDISCOUNT_PCT= ISNULL(DISCOUNT_PERCENTAGE,0),  
           @NDISCOUNT_AMT= ISNULL(NET_PRICE  ,0),  
           @DISC_METHOD =DISC_METHOD ,
		   @csls_title =sls_title
           FROM SLSDET  WHERE D_FILTER<>'' AND SLS_MEMO_NO =@CCOMMMEMO_NO AND ROW_ID=@cROW_ID
                  
                
           IF ISNULL(@D_FILTER,'')=''  
           SET @D_FILTER='1=1'  
             
           SET @DTSQL=N'UPDATE A SET COMMISSION_AMOUNT=(CASE WHEN A.QUANTITY>=0 THEN 1 ELSE -1 END)*  
           CASE WHEN '''+RTRIM(LTRIM(STR(@DISC_METHOD)))+'''=1 THEN ABS(A.NET-A.CMM_DISCOUNT_AMOUNT)*'''+RTRIM(LTRIM(STR(@NDISCOUNT_PCT,10,2)))+''' /100  
                ELSE '''+RTRIM(LTRIM(STR(@NDISCOUNT_AMT ,18,2)))+'''  END  , COMMISSION_TITLE='''+@csls_title+''' 
           FROM CMD01106 A (NOLOCK)  
           JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE  
           JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE  
           JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE=SECTIOND.SUB_SECTION_CODE  
           JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE=SECTIONM.SECTION_CODE  
           JOIN PARA1  (NOLOCK)  ON PARA1.PARA1_CODE=SKU.PARA1_CODE  
           JOIN PARA2  (NOLOCK)  ON PARA2.PARA2_CODE=SKU.PARA2_CODE  
           JOIN PARA3  (NOLOCK)  ON PARA3.PARA3_CODE=SKU.PARA3_CODE  
           JOIN PARA4  (NOLOCK)  ON PARA4.PARA4_CODE=SKU.PARA4_CODE  
           JOIN PARA5  (NOLOCK)  ON PARA5.PARA5_CODE=SKU.PARA5_CODE  
           JOIN PARA6  (NOLOCK)  ON PARA6.PARA6_CODE=SKU.PARA6_CODE  
           WHERE A.CM_ID ='''+RTRIM(LTRIM((@CM_ID))) +'''  
           AND ISNULL(A.COMMISSION_AMOUNT,0)=0 AND '  +@D_FILTER  
           EXEC SP_EXECUTESQL @DTSQL  
           PRINT @DTSQL+'DINKAR'  
   
        
      END  
      ELSE IF @NFILTERMODE=2  
      BEGIN  
          SET @CSTEP=30  
           UPDATE A SET COMMISSION_AMOUNT=(CASE WHEN A.QUANTITY>=0 THEN 1 ELSE -1 END)*  
           CASE WHEN C.DISC_METHOD=1 THEN ABS(A.NET-A.CMM_DISCOUNT_AMOUNT)*B.DISCOUNT_PERCENTAGE /100  
                ELSE B.NET_PRICE  END  ,COMMISSION_TITLE=c.sls_title
           FROM CMD01106 A (NOLOCK)  
           JOIN SLSBC B (NOLOCK) ON LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))=B.PRODUCT_CODE  
           JOIN SLSDET C (NOLOCK) ON B.SLSDET_ROW_ID=C.ROW_ID  
           JOIN SLSMST D (NOLOCK) ON C.SLS_MEMO_NO =D.SLS_MEMO_NO  
           WHERE A.CM_ID =@CM_ID AND D.SLS_MEMO_NO=@CCOMMMEMO_NO  AND C.row_id=@cROW_ID
           AND ISNULL(A.COMMISSION_AMOUNT,0)=0  

		   
    
      END  
      ELSE IF @NFILTERMODE=3  
      BEGIN  
          SET @CSTEP=40  
          UPDATE A SET COMMISSION_AMOUNT=(CASE WHEN A.QUANTITY>=0 THEN 1 ELSE -1 END)*  
           CASE WHEN C.DISC_METHOD=1 THEN ABS(A.NET-A.CMM_DISCOUNT_AMOUNT)*B.DISCOUNT_PERCENTAGE /100  
                ELSE B.NET_PRICE  END   ,COMMISSION_TITLE=c.sls_title
           FROM CMD01106 A (NOLOCK)  
           JOIN SKU  (NOLOCK) ON SKU.PRODUCT_CODE=LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))
           JOIN ARTICLE ART ON ART.ARTICLE_CODE=SKU .ARTICLE_CODE   
           JOIN SLSART B (NOLOCK) ON ART.ARTICLE_CODE=B.ARTICLE_CODE  
           JOIN SLSDET C (NOLOCK) ON B.SLSDET_ROW_ID=C.ROW_ID  
           JOIN SLSMST D (NOLOCK) ON C.SLS_MEMO_NO =D.SLS_MEMO_NO  
           WHERE A.CM_ID =@CM_ID AND D.SLS_MEMO_NO=@CCOMMMEMO_NO  AND C.row_id=@cROW_ID
           AND ISNULL(A.COMMISSION_AMOUNT,0)=0  
  
      END  
        
      DELETE FROM #TMPALLMEMO WHERE SLS_MEMO_NO =@CCOMMMEMO_NO  AND row_id=@cROW_ID
        
        
        
      END  
   END     
        
  END TRY    
  BEGIN CATCH    
   SELECT @CERRMSG='ERROR MESSAGE IN PROCEDURE SP3S_CALCULATE_COMMISSION_AMT STEP#'+@CSTEP+' '+CAST(ERROR_MESSAGE() AS VARCHAR(MAX))+ '||'+ERROR_PROCEDURE()    
   PRINT 'ENTER CATCH IN SP3S_CALCULATE_COMMISSION_AMT '  
  END CATCH    
    
END_PROC:   
  
SELECT ISNULL(@CERRMSG,'') AS ERRMSG   
  
END  