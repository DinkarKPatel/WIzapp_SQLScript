create PROCEDURE SP_WL_GETSALEPERSONWISEREPORT--(LocId 3 digit change by Sanjay:06-11-2024)
(  
 @CDEPTID VARCHAR(4)='',  
 @CEMPCODE CHAR(7)='',  
 @DFROMDT DATETIME,  
 @DTODT DATETIME,  
 @BESTIMATEENABLED BIT = 1,  
 @CUSERCODE VARCHAR(15)='',  
 @CBINID VARCHAR(10)=''  
)  
--WITH ENCRYPTION  
AS  
BEGIN  
 DECLARE @BDSM BIT,@CERRMSGOUT VARCHAR(500)  
      
 /*  
  CALL THIS PROCEDURE TO CHECK IF SOME BILLS ARE PENDING FOR CASHER. EITHER FROM CASH MEMO TO CASHIER OR  
  PACKSLIP TO CASHMEMO.      
   */  
   EXEC SP3S_CHECK_PENDING_BILLS   
     @DFROM_DT=@DFROMDT  
 ,@DTO_DT=@DTODT  
 ,@CDEPT_ID=@CDEPTID  
 ,@BESTIMATEENABLED=@BESTIMATEENABLED  
 ,@CUSERCODE=@CUSERCODE  
 ,@CBINID=@CBINID  
 ,@CERRMSGOUT=@CERRMSGOUT OUTPUT  
  
  
  if object_id ('tempdb..#TMPCMID','u') is not null
     drop table #TMPCMID
   
  
 SELECT A.CM_ID,B.PRODUCT_CODE,A.CM_NO,A.CM_DT,A.BIN_ID,A.CUSTOMER_CODE,A.DISCOUNT_PERCENTAGE, A.DISCOUNT_AMOUNT,A.CM_MODE, a.location_code, 
     B.dept_id ,B.emp_code ,  
     CAST(SUM( B.QUANTITY   ) AS NUMERIC(14,2)) AS QUANTITY     ,  
     CAST(SUM( B.MRP * (B.QUANTITY) ) AS NUMERIC(14,2)) AS MRP     ,  
     CAST(SUM(b.discount_amount +ISNULL(b.cmm_discount_amount,0) ) AS NUMERIC(14,2)) AS CMDDISCAMT     ,  
     --CAST(CASE WHEN ABS(SUM(B.QUANTITY*B.MRP))> 0 THEN (SUM(CASE WHEN A.CM_MODE=1 THEN ROUND((B.QUANTITY*B.MRP)-B.RFNET,2) ELSE 0 END )/SUM(CASE WHEN A.CM_MODE =1 THEN  B.QUANTITY*B.MRP ELSE 1 END ))*100  ELSE 0 END AS NUMERIC(14,2)) AS CMMDISCPCT     ,  
     CAST(SUM( b.net-ISNULL(b.cmm_discount_amount,0) ) AS NUMERIC(14,2)) AS NET      
 INTO #TMPCMID       
 FROM CMM01106 A WITH (NOLOCK)  
 JOIN cmd01106 B WITH (NOLOCK) ON A.CM_ID=B.CM_ID   
 WHERE A.CM_DT BETWEEN @DFROMDT AND @DTODT     
 AND a.location_Code = (CASE WHEN @CDEPTID = '' THEN a.location_Code ELSE @CDEPTID END)    
 AND A.BIN_ID = (CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)    
 AND B.EMP_CODE = (CASE WHEN @CEMPCODE = '' THEN B.EMP_CODE ELSE @CEMPCODE END)    
 AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)   
 AND A.CANCELLED = 0  
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)   
 GROUP BY A.CM_ID,B.PRODUCT_CODE,A.CM_NO,A.CM_DT,A.BIN_ID,A.CUSTOMER_CODE,A.DISCOUNT_PERCENTAGE,  a.location_code,
          A.DISCOUNT_AMOUNT,A.CM_MODE,B.dept_id ,B.emp_code   
       
 CREATE INDEX IX_TMP_PRD ON #TMPCMID(PRODUCT_CODE)  
 INCLUDE (EMP_CODE,CUSTOMER_CODE)  
   
  
 SELECT  C.DEPT_NAME,B1.BIN_NAME, A.CM_DT, A.CM_NO,EC.CATEGORY_NAME ,ISNULL(EG.EMP_GRP_NAME,'') AS EMP_GRP_NAME, H.EMP_NAME, SN.SECTION_NAME,   
   SN.SUB_SECTION_NAME, SN.PARA1_NAME,     SN.PARA2_NAME, A.PRODUCT_CODE, SN.ARTICLE_NAME,     A.DISCOUNT_PERCENTAGE AS CMMDISCPCT,  
   A.DISCOUNT_AMOUNT AS CMMDISCAMT     ,  
   A.QUANTITY AS QUANTITY ,A. MRP,A.CMDDISCAMT ,A. NET  ,    
    CUST.USER_CUSTOMER_CODE AS  CUSTOMER_CODE     ,  
   ISNULL(CUST.CUSTOMER_FNAME,'')+' '+ ISNULL(CUST.CUSTOMER_LNAME,'')  AS CUSTOMER_NAME       
 FROM #TMPCMID A  
 JOIN LOCATION C (NOLOCK) ON a.location_Code=C.DEPT_ID        
 JOIN SKU_NAMES SN (NOLOCK) ON A.PRODUCT_CODE=SN.PRODUCT_CODE       
 JOIN EMPLOYEE H (NOLOCK) ON A.EMP_CODE=H.EMP_CODE      
 JOIN EMPCATEGORY EC ON EC.CATEGORY_CODE =H.CATEGORY_CODE        
 LEFT OUTER JOIN EMP_GRP_LINK EGL   
 JOIN EMPLOYEE_GRP EG ON EG.EMP_GRP_CODE =EGL.EMP_GRP_CODE    
 ON EGL.EMP_CODE=H.EMP_CODE AND EG.DEPT_ID=A.DEPT_ID         
 JOIN BIN B1 ON B1.BIN_ID=ISNULL(A.BIN_ID,'000')    
 JOIN CUSTDYM CUST (NOLOCK) ON CUST.CUSTOMER_CODE=A.CUSTOMER_CODE    
 
 ORDER BY C.DEPT_NAME,B1.BIN_NAME,H.EMP_NAME, A.CM_DT, A.CM_NO,  SN.SECTION_NAME, SN.SUB_SECTION_NAME, SN.PARA1_NAME   
  
 
  SELECT ISNULL(@CERRMSGOUT,'') AS ALERT_MESSAGE  
END  
--********************************************** END OF PROCEDURE SP_WL_GETSALEPERSONWISEREPORT  