

-- FUNCTION TO GET MEMO VALUE BASED ON TRANSACTION TYPE 
-- REQUIRED BY POSTACT PROCEDURE 

CREATE FUNCTION FN_GETMEMOVALUE
(@CXNTYPE VARCHAR(10),
 @CMEMOID VARCHAR(40))
 RETURNS NUMERIC(14,2)
-- WITH ENCRYPTION
 AS
 BEGIN
	DECLARE @CMSTTABLENAME VARCHAR(50),@CDETTABLENAME VARCHAR(50),@CKEYFIELD VARCHAR(30),
	@CCMD NVARCHAR(4000),@NMEMOVAL NUMERIC(14,2),@NLOCTYPE1 INT,@NLOCTYPE2 INT,
	@CPICKFREIGHT CHAR(1),@CPICKOC CHAR(1),@CPICKRO CHAR(1)
	
	DECLARE @TPRODUCTCODES TABLE (PRODUCT_CODE VARCHAR(40),XN_QTY NUMERIC(10,2))
	
	IF @CXNTYPE='CHI'
	BEGIN
		SELECT @NLOCTYPE1=B.LOC_TYPE,@NLOCTYPE2=C.LOC_TYPE FROM CIM01106 A 
		JOIN LOCATION B ON B.DEPT_ID=LEFT(A.CHALLAN_NO,2)
		JOIN LOCATION C ON C.DEPT_ID=SUBSTRING(A.CHALLAN_NO,3,2)
		WHERE CHALLAN_ID=@CMEMOID
		
		IF @NLOCTYPE1=1 AND @NLOCTYPE2=1 
			INSERT @TPRODUCTCODES SELECT PRODUCT_CODE,QUANTITY FROM CID01106 WHERE CHALLAN_ID=@CMEMOID
		ELSE
			SELECT @NMEMOVAL=TOTAL_AMOUNT FROM CIM01106 WHERE CHALLAN_ID=@CMEMOID
	END
		
	ELSE
	IF @CXNTYPE='CHO'	
	BEGIN
		SELECT @NLOCTYPE1=B.LOC_TYPE FROM COM01106 A 
		JOIN LOCATION B ON B.DEPT_ID=SUBSTRING(A.CHALLAN_NO,3,2)
		WHERE CHALLAN_ID=@CMEMOID
		
		IF @NLOCTYPE1=1
			INSERT @TPRODUCTCODES SELECT PRODUCT_CODE,QUANTITY FROM COD01106 WHERE CHALLAN_ID=@CMEMOID
		ELSE
			SELECT @NMEMOVAL=TOTAL_AMOUNT FROM COM01106 WHERE CHALLAN_ID=@CMEMOID	
	END	
	
	ELSE
	IF @CXNTYPE='WSL'
	BEGIN
		SELECT @NLOCTYPE1=1
		
		IF @NLOCTYPE1=1
			INSERT @TPRODUCTCODES SELECT PRODUCT_CODE,QUANTITY FROM IND01106 WHERE INV_ID=@CMEMOID
		ELSE
			SELECT @NMEMOVAL=NET_AMOUNT FROM INM01106 WHERE INV_ID=@CMEMOID	
	END	
	
	ELSE
	IF @CXNTYPE='WSR'
	BEGIN
		SELECT @NLOCTYPE1=B.LOC_TYPE FROM CNM01106 A 
		JOIN LOCATION B ON B.DEPT_ID=A.PARTY_DEPT_ID
		WHERE CN_ID=@CMEMOID
		
		IF @NLOCTYPE1=1
			INSERT @TPRODUCTCODES SELECT PRODUCT_CODE,QUANTITY FROM CND01106 WHERE CN_ID=@CMEMOID
		ELSE
			SELECT @NMEMOVAL=TOTAL_AMOUNT FROM CNM01106 WHERE CN_ID=@CMEMOID			
	END
	
	IF EXISTS ( SELECT TOP 1 PRODUCT_CODE FROM @TPRODUCTCODES)
	BEGIN
		SELECT TOP 1 @CPICKFREIGHT = VALUE FROM CONFIG WHERE CONFIG_OPTION='FIXREPS_PICK_FREIGHT'
		SELECT TOP 1 @CPICKOC = VALUE FROM CONFIG WHERE CONFIG_OPTION='FIXREPS_PICK_OTHER_CHARGES'
		SELECT TOP 1 @CPICKRO = VALUE FROM CONFIG WHERE CONFIG_OPTION='FIXREPS_PICK_ROUND_OFF'

		SELECT @NMEMOVAL=SUM(A.XN_QTY*(B.PURCHASE_PRICE+ISNULL(SKU_OH.VALUE_ADD,0)+ISNULL(SKU_OH.TAX_AMOUNT,0)-
				ISNULL(SKU_OH.DISCOUNT_AMOUNT,0)+
				(CASE WHEN ISNULL(@CPICKFREIGHT,'')='1' THEN  ISNULL(SKU_OH.FREIGHT,0) ELSE 0 END)+
				(CASE WHEN ISNULL(@CPICKOC,'')='1' THEN ISNULL(SKU_OH.OTHER_CHARGES,0) ELSE 0 END)+
				(CASE WHEN ISNULL(@CPICKRO,'')='1' THEN ISNULL(SKU_OH.ROUND_OFF,0) ELSE 0 END))-
				(CASE WHEN POST_TAX_SEPARATELY=0 THEN 0 ELSE ISNULL(SKU_OH.TAX_AMOUNT,0) END))
		FROM 	@TPRODUCTCODES A JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE 
				LEFT OUTER  JOIN SKU_OH ON SKU_OH.PRODUCT_CODE=B.PRODUCT_CODE
				LEFT OUTER JOIN FORM C ON C.FORM_ID=B.FORM_ID
	END
				
	RETURN ISNULL(@NMEMOVAL,0)
END
