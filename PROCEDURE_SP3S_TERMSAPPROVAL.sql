
--EXEC SP3S_TERMSAPPROVAL 1,1,1,'','0001116174',1
--EXEC SP3S_TERMSAPPROVAL 2,'','','1004      ','',0
--EXEC SP3S_TERMSAPPROVAL 3,'','','','0001116170',1
 CREATE PROCEDURE SP3S_TERMSAPPROVAL
 (
	@NMODE	             INT,
	@CSUPPLYERTYPE       INT=0,
	@CTERMSAPPROVEDTYPE  INT=0,
	@CPARTYCODES         VARCHAR (20)='',
	@ROWIDS              VARCHAR (100)='',
	@APPROVESTATUS       INT=0
 )AS
 BEGIN
 PRINT @ROWIDS
 /*
 COMMENTS
 		   
	@CSUPPLYERTYPE 1-CREDITOR,2-DEBITOR	,0-BOTH   
	@CTERMSAPPROVETYPE 2-NONAPPROVED,1-APPROVED,0-BOTH
 */
 
 
   DECLARE @CSUPPLYERTYPE1 VARCHAR(100),@CMD NVARCHAR(MAX),@CAPPROVETYPE1 VARCHAR(10)
	 
 
  IF @CSUPPLYERTYPE =1
    BEGIN
		 SET @CSUPPLYERTYPE1='0000000021'
		 SET @CSUPPLYERTYPE1=DBO.FN_ACT_TRAVTREE(@CSUPPLYERTYPE1)
		 --PRINT @CSUPPLYERTYPE1
	 END
  IF @CSUPPLYERTYPE =2
	BEGIN
	  SET @CSUPPLYERTYPE1='0000000018'
	  SET @CSUPPLYERTYPE1=DBO.FN_ACT_TRAVTREE(@CSUPPLYERTYPE1)
	  
    END
  IF @CSUPPLYERTYPE =0
    BEGIN
		  SET @CSUPPLYERTYPE1=DBO.FN_ACT_TRAVTREE('0000000018')+','+DBO.FN_ACT_TRAVTREE('0000000021')
	 END
  
IF @CTERMSAPPROVEDTYPE=0
	BEGIN
	  SET @CAPPROVETYPE1='0,1'
	END
	ELSE IF  @CTERMSAPPROVEDTYPE=1
	 BEGIN
	   SET @CAPPROVETYPE1=1
	 END
	 ELSE IF @CTERMSAPPROVEDTYPE=2
	 BEGIN
	   SET @CAPPROVETYPE1=0
	 END
 
 IF @NMODE=1
		GOTO SSPL1
	 ELSE IF	@NMODE=2
		GOTO SSPL2
	 ELSE IF	@NMODE=3
		GOTO SSPL3 


SSPL1:	

IF @CSUPPLYERTYPE=0 AND @CTERMSAPPROVEDTYPE=0
BEGIN
	 SET @CMD=N'SELECT  DISTINCT TOP 50 A.AC_CODE,A. AC_NAME
	 FROM HD01106 H 
	 JOIN LM01106 A ON H.HEAD_CODE=A.HEAD_CODE
	 JOIN LMP01106 B ON B.AC_CODE=A.AC_CODE
	 JOIN LM_TERMS C ON C.AC_CODE=A.AC_CODE
	 '
	 PRINT @CMD
	 EXEC SP_EXECUTESQL @CMD
	 GOTO SSPL99
END

ELSE
IF @CSUPPLYERTYPE <>0 AND @CTERMSAPPROVEDTYPE<>0
BEGIN
	 SET @CMD=N'SELECT  DISTINCT TOP 50 A. AC_CODE,A. AC_NAME
	 FROM HD01106 H 
	 JOIN LM01106 A ON H.HEAD_CODE=A.HEAD_CODE
	 JOIN LMP01106 B ON B.AC_CODE=A.AC_CODE
	 JOIN LM_TERMS C ON C.AC_CODE=A.AC_CODE
	 WHERE  H.HEAD_CODE IN ('+@CSUPPLYERTYPE1+') AND C.APPROVED IN ('+@CAPPROVETYPE1+')
	 '
	 PRINT @CMD
	 EXEC SP_EXECUTESQL @CMD
	 GOTO SSPL99
END
ELSE
IF @CSUPPLYERTYPE =0 AND @CTERMSAPPROVEDTYPE<>0
BEGIN
	 SET @CMD=N'SELECT  DISTINCT TOP 50 A. AC_CODE,A. AC_NAME
	 FROM HD01106 H  
	 JOIN LM01106 A ON H.HEAD_CODE=A.HEAD_CODE
	 JOIN LMP01106 B ON B.AC_CODE=A.AC_CODE
	 JOIN LM_TERMS C ON C.AC_CODE=A.AC_CODE
	 WHERE C.APPROVED = '+@CAPPROVETYPE1+'
	 '
	 PRINT @CMD
	 EXEC SP_EXECUTESQL @CMD
	 GOTO SSPL99
END
ELSE
IF @CSUPPLYERTYPE <>0 AND @CTERMSAPPROVEDTYPE=0
BEGIN
	 SET @CMD=N'SELECT  DISTINCT TOP 50 A.AC_CODE,A.AC_NAME
	 FROM HD01106 H 
	 JOIN LM01106 A ON H.HEAD_CODE=A.HEAD_CODE
	 JOIN LMP01106 B ON B.AC_CODE=A.AC_CODE
	 JOIN LM_TERMS C ON C.AC_CODE=A.AC_CODE
	 WHERE  H.HEAD_CODE IN ('+@CSUPPLYERTYPE1+') 
	 '
	 PRINT @CMD
	 EXEC SP_EXECUTESQL @CMD
	 GOTO SSPL99
END

SSPL2:

IF @CPARTYCODES<>'' 
 BEGIN
	SET @CMD=N'SELECT  A. AC_CODE,A.AC_NAME,D.TERMS 
	,C.APPROVED,C.ROW_ID,D.REMARKS
	,D.TERMS_NAME,ISNULL(C.TERMS_CODE,'''') AS TERMS_CODE
	FROM HD01106 H 
	JOIN LM01106 A ON H.HEAD_CODE=A.HEAD_CODE
	LEFT JOIN LMP01106 B ON B.AC_CODE=A.AC_CODE
	JOIN LM_TERMS C ON C.AC_CODE=A.AC_CODE
	JOIN LEDGER_TERMS D ON D.TERMS_CODE=C.TERMS_CODE
	WHERE  H.HEAD_CODE IN ('+@CSUPPLYERTYPE1+') AND C.APPROVED IN ('+@CAPPROVETYPE1+') AND A.AC_CODE IN ('''+@CPARTYCODES+''')
	'
	PRINT @CMD
	EXEC SP_EXECUTESQL @CMD
  END
 ELSE IF @CSUPPLYERTYPE <>0 AND @CTERMSAPPROVEDTYPE<>0
 BEGIN
	SET @CMD=N'SELECT  A. AC_CODE,A.AC_NAME,D.TERMS 
	,C.APPROVED,C.ROW_ID,D.REMARKS
	,D.TERMS_NAME,ISNULL(C.TERMS_CODE,'''') AS TERMS_CODE
	FROM HD01106 H 
	JOIN LM01106 A ON H.HEAD_CODE=A.HEAD_CODE
	LEFT JOIN LMP01106 B ON B.AC_CODE=A.AC_CODE
	JOIN LM_TERMS C ON C.AC_CODE=A.AC_CODE
	JOIN LEDGER_TERMS D ON D.TERMS_CODE=C.TERMS_CODE
	WHERE  H.HEAD_CODE IN ('+@CSUPPLYERTYPE1+') AND C.APPROVED IN ('+@CAPPROVETYPE1+') 
	'
	PRINT @CMD
	EXEC SP_EXECUTESQL @CMD
  END
  
 ELSE IF @CSUPPLYERTYPE ='' AND @CTERMSAPPROVEDTYPE<>0
 BEGIN
	SET @CMD=N'SELECT  A. AC_CODE,A.AC_NAME,D.TERMS 
	,C.APPROVED,C.ROW_ID,D.REMARKS
	,D.TERMS_NAME,ISNULL(C.TERMS_CODE,'''') AS TERMS_CODE
	FROM HD01106 H 
	JOIN LM01106 A ON H.HEAD_CODE=A.HEAD_CODE
	LEFT JOIN LMP01106 B ON B.AC_CODE=A.AC_CODE
	JOIN LM_TERMS C ON C.AC_CODE=A.AC_CODE
	JOIN LEDGER_TERMS D ON D.TERMS_CODE=C.TERMS_CODE
	WHERE C.APPROVED IN ('+@CAPPROVETYPE1+') 
	'
	PRINT @CMD
	EXEC SP_EXECUTESQL @CMD
  END
 ELSE
  BEGIN
	SET @CMD=N'SELECT  A.AC_CODE,A. AC_NAME,D.TERMS 
	,C.APPROVED,C.ROW_ID,D.REMARKS
	,D.TERMS_NAME
	FROM HD01106 H 
	JOIN LM01106 A ON H.HEAD_CODE=A.HEAD_CODE
	LEFT JOIN LMP01106 B ON B.AC_CODE=A.AC_CODE
	JOIN LM_TERMS C ON C.AC_CODE=A.AC_CODE
	JOIN LEDGER_TERMS D ON D.TERMS_CODE=C.TERMS_CODE 
	'
	PRINT @CMD
	EXEC SP_EXECUTESQL @CMD
  END
  
  
	--EXEC (@CMD)

GOTO SSPL99
SSPL3:
SET @CMD =N'UPDATE LM_TERMS SET APPROVED='''+LTRIM(STR(@APPROVESTATUS))+''' WHERE ROW_ID IN ('''+@ROWIDS+''')'
PRINT @CMD

EXEC SP_EXECUTESQL @CMD,N'@APPROVESTATUS INT OUTPUT',@APPROVESTATUS OUTPUT

IF @@ROWCOUNT>0
SELECT 'SUCEESSFULLY UPDATED  ROWIDS : '+@ROWIDS+'' AS STATUS

GOTO SSPL99	
SSPL99:
END
 
