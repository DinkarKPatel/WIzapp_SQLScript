CREATE PROCEDURE SP3S_INV_SUPP_DATAGEN
(
   @NQUERYID INT
  ,@LIST VARCHAR(1000)=''
  ,@CMEMOID	VARCHAR(40) = ''
  ,@CWHERE1	VARCHAR(500) = ''
  ,@NNAVMODE NUMERIC(1,0) = 0  
  ,@CWHERE2	NVARCHAR(MAX)=''
  ,@AC_CODE VARCHAR(100)=''
)
AS
BEGIN
SET NOCOUNT ON
INSERT VSUPP SELECT @NQUERYID,@LIST,@CMEMOID,@CWHERE1,@NNAVMODE,@CWHERE2,@AC_CODE
DECLARE @CMD VARCHAR(MAX),@IS_BLANK BIT=0
IF @NQUERYID=1
   GOTO DISP_PENDING_INV
ELSE IF @NQUERYID=2
   GOTO DISP_PARTIES
ELSE IF @NQUERYID=3
   GOTO BIND_VAL
ELSE IF @NQUERYID=4
   GOTO DISP_INV_MASTER  
ELSE IF @NQUERYID=5
   GOTO DISP_INV_DETAILS
ELSE IF @NQUERYID=6
   GOTO NAVIGATE_SUPP
ELSE  
   GOTO END_PROC  
      
      
NAVIGATE_SUPP:
EXECUTE SP_NAVIGATE 'INMSUPP' ,@NNAVMODE,@CMEMOID,@CWHERE2,'INV_NO','INV_DT','INV_ID',@CWHERE1
GOTO END_PROC

DISP_PENDING_INV:   
SELECT CAST(0 AS BIT) AS CHK,LM.AC_NAME,I.INV_ID,I.INV_NO,I.INV_DT,I.NET_AMOUNT INV_AMT,ISNULL(SUM(D.QUANTITY),0)INV_QTY,NEWID() AS ROW_ID
FROM INM01106 I (NOLOCK) 
JOIN IND01106 D (NOLOCK) ON I.INV_ID=D.INV_ID
JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=I.AC_CODE
LEFT JOIN INM_SUPP_MAPPING M (NOLOCK) ON I.INV_ID=M.INM_INV_ID AND ISNULL(M.CANCELLED,0)=0
WHERE I.CANCELLED=0 AND M.INM_INV_ID IS NULL AND I.INV_MODE=1
GROUP BY LM.AC_NAME,I.INV_ID,I.INV_NO,I.INV_DT,I.NET_AMOUNT
GOTO END_PROC


DISP_PARTIES:
DECLARE @CHEADCODE VARCHAR(MAX)
SET @CHEADCODE=DBO.FN_ACT_TRAVTREE('0000000018') 
SELECT '' AS AC_CODE, '--ALL--' AS AC_NAME,''AC_ADDRESS
UNION
SELECT AC_CODE, AC_NAME ,AC_ADDRESS=LTRIM(ISNULL(LMV.ADDRESS0+CHAR(13),'')+ISNULL(LMV.ADDRESS1+CHAR(13),'')+ISNULL(LMV.ADDRESS2+CHAR(13),'')+ISNULL(LMV.AREA_NAME+CHAR(13),'')+ISNULL(LMV.CITY,'')+ISNULL(LMV.PINCODE,'')+ISNULL(LMV.[STATE],''))
FROM LMV01106 LMV(NOLOCK) 
WHERE ISNULL(INACTIVE,0)=0 
	  AND (CHARINDEX(HEAD_CODE,@CHEADCODE)>0 OR ALLOW_CREDITOR_DEBTOR = 1) 
	  AND LTRIM(RTRIM(ISNULL(AC_NAME,'')))<>''  
ORDER BY AC_NAME

--SELECT LM.AC_CODE,LM.AC_NAME
--,AC_ADDRESS=LTRIM(ISNULL(LMV.ADDRESS0+CHAR(13),'')+ISNULL(LMV.ADDRESS1+CHAR(13),'')+ISNULL(LMV.ADDRESS2+CHAR(13),'')+ISNULL(LMV.AREA_NAME+CHAR(13),'')+ISNULL(LMV.CITY,'')+ISNULL(LMV.PINCODE,'')+ISNULL(LMV.[STATE],''))
--FROM LM01106 LM (NOLOCK) 
--JOIN HD01106 H (NOLOCK) ON LM.HEAD_CODE=H.HEAD_CODE
--JOIN LMV01106 LMV (NOLOCK) ON LM.AC_CODE=LMV.AC_CODE
--WHERE LM.INACTIVE=0 AND H.HEAD_NAME IN ('SUNDRY DEBTORS','SUNDRY CREDITORS')
GOTO END_PROC


BIND_VAL:
SELECT CAST('' AS VARCHAR(1000))AC_NAME,CAST('' AS VARCHAR(1000))AC_CODE,CAST('' AS VARCHAR(1000))AC_ADDRESS,CAST('' AS VARCHAR(1000))SERIES,GETDATE() AS DT
GOTO END_PROC


DISP_INV_MASTER:
IF OBJECT_ID('TEMPDB..#INMSUPP') IS NOT NULL   
   DROP TABLE #INMSUPP
SELECT TOP 0 *,CAST(0 AS NUMERIC(10,2))TAX_AMOUNT,CAST(0 AS NUMERIC(10,2))TOTAL_CUSTOM_DUTY_AMOUNT,CAST('' AS VARCHAR(1000))DT_NAME,CAST('' AS VARCHAR(1000)) AS AC_NAME,CAST('' AS VARCHAR(1000))USERCODE,CAST('' AS VARCHAR(1000)) USERNAME 
INTO #INMSUPP 
FROM INM01106 (NOLOCK)

IF ISNULL(@CMEMOID,'')!=''
   BEGIN 
	 SET @IS_BLANK=0
	 SET @CMD='SELECT INMSUPP.*,ISNULL(LMV.AC_NAME,'''')AC_NAME,ISNULL(LMV.ADDRESS0,'''')ADDRESS0,ISNULL(LMV.ADDRESS1,'''')ADDRESS1,ISNULL(LMV.ADDRESS2,'''')ADDRESS2,ISNULL(LMV.CITY,'''')CITY,ISNULL(LMV.STATE,'''')STATE,ISNULL(LMV.PINCODE,'''')PINCODE,ISNULL(LMV.AREA_NAME,'''')AREA_NAME
	 ,ISNULL(USERS.USERNAME,'''')USERNAME
	 FROM INMSUPP (NOLOCK) 
	 LEFT JOIN USERS (NOLOCK) ON USERS.USER_CODE=INMSUPP.USER_CODE
	 LEFT JOIN LMV01106 LMV(NOLOCK) ON LMV.AC_CODE=INMSUPP.AC_CODE
	 WHERE INV_ID = '''+@CMEMOID+''''
	 PRINT @CMD
	 EXEC(@CMD)
     GOTO END_PROC   
   END
IF ISNULL(@LIST,'')=''
   BEGIN
     SELECT TOP 0 * FROM #INMSUPP
     GOTO END_PROC   
   END

SET @IS_BLANK=0   
IF OBJECT_ID('TEMPDB..#TMPGPMEMO1','U') IS NOT NULL  
   DROP TABLE #TMPGPMEMO1  
CREATE TABLE #TMPGPMEMO1 (INV_ID VARCHAR(100),GP_ISSUE_NO VARCHAR(100),GP_ISSUE_ID VARCHAR(100),MEMO_DT DATETIME,SNO INT,LAST_UPDATE DATETIME)

IF OBJECT_ID('TEMPDB..#TMPGPMEMO','U') IS NOT NULL  
   DROP TABLE #TMPGPMEMO  
CREATE TABLE #TMPGPMEMO (INV_ID VARCHAR(100),GP_ISSUE_NO VARCHAR(100),GP_ISSUE_ID VARCHAR(100),MEMO_DT DATETIME,SNO INT)

IF OBJECT_ID('TEMPDB..#TMPTAXMEMO','U') IS NOT NULL  
   DROP TABLE #TMPTAXMEMO  
CREATE TABLE #TMPTAXMEMO(TAX_AMOUNT NUMERIC(10,2),TOTAL_CUSTOM_DUTY_AMOUNT NUMERIC(10,2),DT_NAME VARCHAR(1000)) 

IF OBJECT_ID('TEMPDB..#TMPDTM','U') IS NOT NULL  
   DROP TABLE #TMPDTM  
CREATE TABLE #TMPDTM (DT_NAME VARCHAR(1000))

SET @CMD='INSERT #TMPGPMEMO1 SELECT B.INV_ID,A.MEMO_NO AS GP_ISSUE_NO ,A.MEMO_ID AS GP_ISSUE_ID,A.MEMO_DT,0,A.LAST_UPDATE
FROM TBL_GP_ISSUE_MST A  
JOIN TBL_GP_ISSUE_DET B ON A.MEMO_ID=B.MEMO_ID  
JOIN INM01106 INM ON INM.INV_ID=B.INV_ID   
WHERE A.CANCELLED =0 AND INM.INV_ID '+@LIST
PRINT @CMD
EXEC(@CMD)
;WITH CTE AS 
(
  SELECT INV_ID,GP_ISSUE_NO ,GP_ISSUE_ID,MEMO_DT
 ,ROW_NUMBER() OVER (PARTITION BY INV_ID ORDER BY LAST_UPDATE DESC) AS SR  
 FROM #TMPGPMEMO1
)
INSERT #TMPGPMEMO SELECT * FROM CTE WHERE SR=1

SET @CMD='SELECT SUM(CONVERT(NUMERIC(10,2), 0 ))AS TAX_AMOUNT, SUM(CONVERT(NUMERIC(10,2),0)) AS TOTAL_CUSTOM_DUTY_AMOUNT
FROM INM01106 T1  (NOLOCK)         
LEFT OUTER JOIN USERS T2 (NOLOCK) ON T1.USER_CODE = T2.USER_CODE    
LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=T1.TARGET_BIN_ID                 
JOIN LMV01106 T4 (NOLOCK) ON T4.AC_CODE = T1.AC_CODE          
LEFT OUTER JOIN EMPLOYEE T5 (NOLOCK) ON T5.EMP_CODE = T1.EMP_CODE          
LEFT OUTER JOIN LOCATION T6 (NOLOCK) ON T6.DEPT_ID = T1.PARTY_DEPT_ID            
LEFT JOIN DTM (NOLOCK) ON DTM.DT_CODE = T1.DT_CODE   
LEFT OUTER JOIN LMV01106 T7 (NOLOCK) ON T7.AC_CODE = T1.BROKER_AC_CODE     
LEFT OUTER JOIN LEDGER_TERMS T ON T.TERMS_CODE=T1.TERMS_CODE    
LEFT OUTER JOIN #TMPGPMEMO GP ON GP.INV_ID=T1.INV_ID       
LEFT OUTER JOIN GST_STATE_MST ST ON T1.PARTY_STATE_CODE=ST.GST_STATE_CODE  
WHERE T1.INV_ID '+@LIST
PRINT @CMD
INSERT #TMPTAXMEMO(TAX_AMOUNT,TOTAL_CUSTOM_DUTY_AMOUNT)
EXEC(@CMD)
     
SET @CMD='SELECT TOP 1 ISNULL(DTM.DT_NAME,'''') AS DT_NAME 
FROM INM01106 T1  (NOLOCK)         
LEFT JOIN DTM (NOLOCK) ON DTM.DT_CODE = T1.DT_CODE 
WHERE T1.INV_ID '+@LIST
INSERT #TMPDTM(DT_NAME) EXEC(@CMD)

UPDATE #TMPTAXMEMO SET #TMPTAXMEMO.DT_NAME=#TMPDTM.DT_NAME FROM #TMPDTM

SET @CMD='INSERT INTO #INMSUPP(UPLOADED_TO_ACTIVSTREAM,BROKER_AC_CODE,ROUTE_FORM1,ROUTE_FORM2,PARTY_DA_NO,PARTY_PO_NO,EMP_CODE,DT_CODE,CREDIT_DAYS,SHIPPING_ADDRESS2,SHIPPING_ADDRESS3,SHIPPING_AREA_CODE,SHIPPING_PIN,TERMS_CODE,APPROVEDLEVELNO,DISCOUNT_PERCENT_MRP,BILL_LEVEL_DISC_METHOD,GENERATED_BY_CHRECON,HOLD_PARTY_CHECK_BYPASSED_BY_USER_CODE,COPIES_PTD,INSURANCE_PERCENTAGE,MANUAL_INSURANCE,GATE_PASS,DO_NOT_CAL_EXCISE,LOTPRICE,WAY_BILL,SHIPPING_AREA_NAME,SHIPPING_CITY_NAME,SHIPPING_STATE_NAME,SHIPPING_SAME_AS_BILLING_ADD,PARTY_STATE_CODE,BILL_LEVEL_TAX_METHOD,INV_ID,AC_CODE,INV_NO,INV_DT,COMPLETED,TAX_INVOICE,BIN_TRANSFER,MEMO_PREFIX,ENTRY_MODE,TAXFORM_STORAGE_MODE,SHIPPING_ADDRESS,REF_INV_ID,SENT_BY,COMPANY_CODE,USER_CODE,LAST_UPDATE,GRLR_NO,GRLR_DATE,PACKING,SENT_FOR_RECON,INV_TYPE,XFER_TYPE,BIN_ID,TARGET_BIN_ID,BUYER_ORDER_NO,FIN_YEAR,BANDALS,THROUGH,FORM_NO,SENT_TO_HO,POSTEDINAC,EDT_USER_CODE,INV_TIME,SMS_SENT,MANUAL_INV_NO,INV_MODE,EXPORTED,DEPT_ID,EXCISE_INVOICE,PARTY_DEPT_ID,APPROVED,EXPORTED_TIME,OTHER_CHARGES_HSN_CODE,FREIGHT_HSN_CODE,INSURANCE_HSN_CODE,PACKING_HSN_CODE,OH_TAX_METHOD,DO_NOT_CALC_GST_OH,CANCELLED,CHECKED_BY,LOTTYPE,RECEIVING_AC_CODE,PAY_MODE,MEMO_TYPE,REMARKS,RECEIVING_PARTY_NAME,RECEIVING_PARTY_ADDRESS,BROKER_COMM_PERCENTAGE,BROKER_COMM_AMOUNT,INSURANCE,SUBTOTAL,DISCOUNT_AMOUNT,FREIGHT,OTHER_CHARGES,NET_AMOUNT,ROUND_OFF,MANUAL_DISCOUNT,MANUAL_ROUNDOFF,MANUAL_OCTROI,OCTROI_PERCENTAGE,OCTROI_AMOUNT,EXCISE_ACCESSIBLE_PERCENTAGE,EXCISE_ACCESSIBLE_AMOUNT,EXCISE_DUTY_PERCENTAGE,EXCISE_DUTY_AMOUNT,EXCISE_EDU_CESS_PERCENTAGE,EXCISE_EDU_CESS_AMOUNT,EXCISE_HEDU_CESS_PERCENTAGE,EXCISE_HEDU_CESS_AMOUNT,MANUAL_BROKER_COMM,TAX_AMOUNT,TOTAL_CUSTOM_DUTY_AMOUNT,DT_NAME)
SELECT TOP 1 UPLOADED_TO_ACTIVSTREAM,BROKER_AC_CODE,ROUTE_FORM1,ROUTE_FORM2,PARTY_DA_NO,PARTY_PO_NO,EMP_CODE,DT_CODE,CREDIT_DAYS,SHIPPING_ADDRESS2,SHIPPING_ADDRESS3,SHIPPING_AREA_CODE,SHIPPING_PIN,TERMS_CODE,APPROVEDLEVELNO,DISCOUNT_PERCENT_MRP,BILL_LEVEL_DISC_METHOD,GENERATED_BY_CHRECON,HOLD_PARTY_CHECK_BYPASSED_BY_USER_CODE,COPIES_PTD,INSURANCE_PERCENTAGE,MANUAL_INSURANCE,GATE_PASS,DO_NOT_CAL_EXCISE,LOTPRICE,WAY_BILL,SHIPPING_AREA_NAME,SHIPPING_CITY_NAME,SHIPPING_STATE_NAME,SHIPPING_SAME_AS_BILLING_ADD,PARTY_STATE_CODE,BILL_LEVEL_TAX_METHOD,INV_ID,AC_CODE,INV_NO,INV_DT,COMPLETED,TAX_INVOICE,BIN_TRANSFER,MEMO_PREFIX,ENTRY_MODE,TAXFORM_STORAGE_MODE,SHIPPING_ADDRESS,REF_INV_ID,SENT_BY,COMPANY_CODE,USER_CODE,LAST_UPDATE,GRLR_NO,GRLR_DATE,PACKING,SENT_FOR_RECON,INV_TYPE,XFER_TYPE,BIN_ID,TARGET_BIN_ID,BUYER_ORDER_NO,FIN_YEAR,BANDALS,THROUGH,FORM_NO,SENT_TO_HO,POSTEDINAC,EDT_USER_CODE,INV_TIME,SMS_SENT,MANUAL_INV_NO,INV_MODE,EXPORTED,DEPT_ID,EXCISE_INVOICE,PARTY_DEPT_ID,APPROVED,EXPORTED_TIME,OTHER_CHARGES_HSN_CODE,FREIGHT_HSN_CODE,INSURANCE_HSN_CODE,PACKING_HSN_CODE,OH_TAX_METHOD,DO_NOT_CALC_GST_OH,CANCELLED,CHECKED_BY,LOTTYPE,RECEIVING_AC_CODE,PAY_MODE,MEMO_TYPE,REMARKS,RECEIVING_PARTY_NAME,RECEIVING_PARTY_ADDRESS,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,MANUAL_BROKER_COMM,0,0,''''
FROM INM01106 (NOLOCK) WHERE INV_ID '+@LIST+''
PRINT 'INSERT RET:'+@CMD
EXEC(@CMD)
UPDATE #INMSUPP SET #INMSUPP.DT_NAME=#TMPTAXMEMO.DT_NAME FROM #TMPTAXMEMO

SET @CMD='UPDATE #INMSUPP SET BROKER_COMM_PERCENTAGE=I.BROKER_COMM_PERCENTAGE ,BROKER_COMM_AMOUNT=I.BROKER_COMM_AMOUNT
,INSURANCE=I.INSURANCE ,SUBTOTAL_MRP=I.SUBTOTAL_MRP ,SUBTOTAL=I.SUBTOTAL ,DISCOUNT_PERCENTAGE=I.DISCOUNT_PERCENTAGE
,DISCOUNT_AMOUNT=I.DISCOUNT_AMOUNT ,FREIGHT=I.FREIGHT ,CUSTOM_DUTY_MARK_DOWN_PCT=I.CUSTOM_DUTY_MARK_DOWN_PCT
,OTHER_CHARGES=I.OTHER_CHARGES ,NET_AMOUNT=I.NET_AMOUNT ,ROUND_OFF=I.ROUND_OFF 
,OCTROI_PERCENTAGE=I.OCTROI_PERCENTAGE ,OCTROI_AMOUNT=I.OCTROI_AMOUNT
,EXCISE_ACCESSIBLE_PERCENTAGE=I.EXCISE_ACCESSIBLE_PERCENTAGE ,EXCISE_ACCESSIBLE_AMOUNT=I.EXCISE_ACCESSIBLE_AMOUNT
,EXCISE_DUTY_PERCENTAGE=I.EXCISE_DUTY_PERCENTAGE ,EXCISE_DUTY_AMOUNT=I.EXCISE_DUTY_AMOUNT
,EXCISE_EDU_CESS_PERCENTAGE=I.EXCISE_EDU_CESS_PERCENTAGE ,EXCISE_EDU_CESS_AMOUNT=I.EXCISE_EDU_CESS_AMOUNT
,EXCISE_HEDU_CESS_PERCENTAGE=I.EXCISE_HEDU_CESS_PERCENTAGE ,EXCISE_HEDU_CESS_AMOUNT=I.EXCISE_HEDU_CESS_AMOUNT
,OTHER_CHARGES_GST_PERCENTAGE=I.OTHER_CHARGES_GST_PERCENTAGE ,OTHER_CHARGES_IGST_AMOUNT=I.OTHER_CHARGES_IGST_AMOUNT
,OTHER_CHARGES_CGST_AMOUNT=I.OTHER_CHARGES_CGST_AMOUNT ,OTHER_CHARGES_SGST_AMOUNT=I.OTHER_CHARGES_SGST_AMOUNT
,FREIGHT_GST_PERCENTAGE=I.FREIGHT_GST_PERCENTAGE ,FREIGHT_IGST_AMOUNT=I.FREIGHT_IGST_AMOUNT
,FREIGHT_CGST_AMOUNT=I.FREIGHT_CGST_AMOUNT ,FREIGHT_SGST_AMOUNT=I.FREIGHT_SGST_AMOUNT
,INSURANCE_GST_PERCENTAGE=I.INSURANCE_GST_PERCENTAGE ,INSURANCE_IGST_AMOUNT=I.INSURANCE_IGST_AMOUNT
,INSURANCE_CGST_AMOUNT=I.INSURANCE_CGST_AMOUNT ,INSURANCE_SGST_AMOUNT=I.INSURANCE_SGST_AMOUNT
,PACKING_GST_PERCENTAGE=I.PACKING_GST_PERCENTAGE ,PACKING_IGST_AMOUNT=I.PACKING_IGST_AMOUNT
,PACKING_CGST_AMOUNT=I.PACKING_CGST_AMOUNT ,PACKING_SGST_AMOUNT=I.PACKING_SGST_AMOUNT
,TOTAL_QUANTITY=I.TOTAL_QUANTITY ,FREIGHT_TAXABLE_VALUE=I.FREIGHT_TAXABLE_VALUE
,OTHER_CHARGES_TAXABLE_VALUE=I.OTHER_CHARGES_TAXABLE_VALUE ,GST_ROUND_OFF=I.GST_ROUND_OFF 
,INSURANCE_TAXABLE_VALUE=I.INSURANCE_TAXABLE_VALUE ,PACKING_TAXABLE_VALUE=I.PACKING_TAXABLE_VALUE
FROM
(
 SELECT AVG(BROKER_COMM_PERCENTAGE)BROKER_COMM_PERCENTAGE ,SUM(BROKER_COMM_AMOUNT)BROKER_COMM_AMOUNT
,SUM(INSURANCE)INSURANCE ,SUM(SUBTOTAL_MRP)SUBTOTAL_MRP ,SUM(SUBTOTAL)SUBTOTAL 
,AVG(DISCOUNT_PERCENTAGE)DISCOUNT_PERCENTAGE ,SUM(DISCOUNT_AMOUNT)DISCOUNT_AMOUNT ,SUM(FREIGHT)FREIGHT 
,AVG(CUSTOM_DUTY_MARK_DOWN_PCT)CUSTOM_DUTY_MARK_DOWN_PCT ,SUM(OTHER_CHARGES)OTHER_CHARGES
,SUM(NET_AMOUNT)NET_AMOUNT ,SUM(ROUND_OFF)ROUND_OFF 
,AVG(OCTROI_PERCENTAGE)OCTROI_PERCENTAGE ,SUM(OCTROI_AMOUNT)OCTROI_AMOUNT
,AVG(EXCISE_ACCESSIBLE_PERCENTAGE)EXCISE_ACCESSIBLE_PERCENTAGE ,SUM(EXCISE_ACCESSIBLE_AMOUNT)EXCISE_ACCESSIBLE_AMOUNT
,AVG(EXCISE_DUTY_PERCENTAGE)EXCISE_DUTY_PERCENTAGE ,SUM(EXCISE_DUTY_AMOUNT)EXCISE_DUTY_AMOUNT
,AVG(EXCISE_EDU_CESS_PERCENTAGE)EXCISE_EDU_CESS_PERCENTAGE ,SUM(EXCISE_EDU_CESS_AMOUNT)EXCISE_EDU_CESS_AMOUNT
,AVG(EXCISE_HEDU_CESS_PERCENTAGE)EXCISE_HEDU_CESS_PERCENTAGE ,SUM(EXCISE_HEDU_CESS_AMOUNT)EXCISE_HEDU_CESS_AMOUNT
,AVG(OTHER_CHARGES_GST_PERCENTAGE)OTHER_CHARGES_GST_PERCENTAGE ,SUM(OTHER_CHARGES_IGST_AMOUNT)OTHER_CHARGES_IGST_AMOUNT
,SUM(OTHER_CHARGES_CGST_AMOUNT)OTHER_CHARGES_CGST_AMOUNT ,SUM(OTHER_CHARGES_SGST_AMOUNT)OTHER_CHARGES_SGST_AMOUNT
,AVG(FREIGHT_GST_PERCENTAGE)FREIGHT_GST_PERCENTAGE ,SUM(FREIGHT_IGST_AMOUNT)FREIGHT_IGST_AMOUNT
,SUM(FREIGHT_CGST_AMOUNT)FREIGHT_CGST_AMOUNT ,SUM(FREIGHT_SGST_AMOUNT)FREIGHT_SGST_AMOUNT ,AVG(INSURANCE_GST_PERCENTAGE)INSURANCE_GST_PERCENTAGE
,SUM(INSURANCE_IGST_AMOUNT)INSURANCE_IGST_AMOUNT ,SUM(INSURANCE_CGST_AMOUNT)INSURANCE_CGST_AMOUNT ,SUM(INSURANCE_SGST_AMOUNT)INSURANCE_SGST_AMOUNT
,AVG(PACKING_GST_PERCENTAGE)PACKING_GST_PERCENTAGE ,SUM(PACKING_IGST_AMOUNT)PACKING_IGST_AMOUNT ,SUM(PACKING_CGST_AMOUNT)PACKING_CGST_AMOUNT
,SUM(PACKING_SGST_AMOUNT)PACKING_SGST_AMOUNT ,SUM(TOTAL_QUANTITY)TOTAL_QUANTITY ,SUM(FREIGHT_TAXABLE_VALUE)FREIGHT_TAXABLE_VALUE
,SUM(OTHER_CHARGES_TAXABLE_VALUE)OTHER_CHARGES_TAXABLE_VALUE  ,SUM(INSURANCE_TAXABLE_VALUE)INSURANCE_TAXABLE_VALUE
,SUM(PACKING_TAXABLE_VALUE)PACKING_TAXABLE_VALUE ,SUM(GST_ROUND_OFF)GST_ROUND_OFF
FROM INM01106 (NOLOCK) WHERE INV_ID '+@LIST+
')I'
PRINT 'UPDATE RET:'+@CMD
EXEC(@CMD)
SELECT * FROM #INMSUPP

IF OBJECT_ID('TEMPDB..#INVDT') IS NOT NULL
   DROP TABLE #INVDT
CREATE TABLE #INVDT(INV_DATE DATETIME)   
SET @CMD='SELECT INV_DT FROM INM01106 (NOLOCK) WHERE INV_ID '+@LIST+''
PRINT @CMD
INSERT #INVDT(INV_DATE) EXEC(@CMD)
DECLARE @DT DATETIME
SELECT @DT=MAX(INV_DATE) FROM #INVDT
SELECT LAST_INV_DT=CASE LEFT(CONVERT(VARCHAR,@DT,101),1) WHEN '0' THEN SUBSTRING(CONVERT(VARCHAR,@DT,101),2,10) ELSE CONVERT(VARCHAR,@DT,101) END
GOTO END_PROC


DISP_INV_DETAILS:
SET @IS_BLANK=0
IF ISNULL(@CMEMOID,'')!=''
   BEGIN 
	 SET @CMD='SELECT INDSUPP.*,E.UOM_CODE,E.UOM_NAME,(INVOICE_QUANTITY*NET_RATE) AMOUNT 
	 FROM INDSUPP (NOLOCK) 
	 JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = INDSUPP.PRODUCT_CODE   
	 JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE 
	 JOIN UOM E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE 
	 JOIN FORM J (NOLOCK)ON INDSUPP.ITEM_FORM_ID= J.FORM_ID	 
	 WHERE INDSUPP.INV_ID = '''+@CMEMOID+''''
	 --EXEC(@CMD)
	 SET @CMD='SELECT INDSUPP.*,E.UOM_CODE,E.UOM_NAME,(INVOICE_QUANTITY*NET_RATE) AMOUNT 	 
	 ,B.ARTICLE_NAME
	 ,B.ARTICLE_NO
	 ,BN.BIN_NAME
	 ,PARA1.PARA1_NAME 
	 ,PARA2.PARA2_NAME
	 ,PARA3.PARA3_NAME
	 ,PARA4.PARA4_NAME
	 ,PARA5.PARA5_NAME
	 ,PARA6.PARA6_NAME
	 ,SECTIONM.SECTION_NAME
	 ,SECTIOND.SUB_SECTION_NAME
	 FROM INDSUPP (NOLOCK) 
	 JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = INDSUPP.PRODUCT_CODE   
	 JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE 
	 JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=B.SUB_SECTION_CODE
	 JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
	 JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=S.PARA1_CODE
	 JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=S.PARA2_CODE
	 JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=S.PARA3_CODE
	 JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=S.PARA4_CODE
	 JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=S.PARA5_CODE
	 JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=S.PARA6_CODE
	 JOIN UOM E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE	 
	 JOIN FORM J (NOLOCK)ON INDSUPP.ITEM_FORM_ID= J.FORM_ID	 
	 JOIN BIN BN (NOLOCK) ON BN.BIN_ID=INDSUPP.BIN_ID
	 WHERE INDSUPP.INV_ID = '''+@CMEMOID+''''
     EXEC(@CMD)
     GOTO END_PROC   
   END
IF ISNULL(@LIST,'')=''
   BEGIN
     SELECT TOP 0 * FROM INDSUPP (NOLOCK)
     GOTO END_PROC   
   END
IF OBJECT_ID('TEMPDB..#IND') IS NOT NULL
   DROP TABLE #IND
SELECT TOP 0 INV_ID,PRODUCT_CODE,QUANTITY,RATE,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,DEPT_ID,ROW_ID,LAST_UPDATE,PRINT_LABEL,RFNET,RFNET_WOTAX,COMPANY_CODE,NET_RATE,EMP_CODE,BOX_NO,MRP,BOX_DT,ITEM_TAX_PERCENTAGE,ITEM_TAX_AMOUNT,ITEM_FORM_ID,PS_ID,EMP_CODE1,EMP_CODE2,INVOICE_QUANTITY,SCHEME_QUANTITY,MANUAL_DISCOUNT,AUTO_SRNO,PARTY_MRP,REMARKS,WS_PRICE,BIN_ID,W8_CHALLAN_ID,CUSTOM_DUTY_AMT,TOTAL_CUSTOM_DUTY_AMT,CVD_AMT,CVD_PER,CUSTOM_DUTY_PER,PICKLIST_ARTICLE_CODE,PICKLIST_PARA1_CODE,PICKLIST_PARA2_CODE,PICK_LIST_ID,MANUAL_RATE,ORDER_ID,REF_WPS_DET_ROWID,ITEM_EXCISE_ACCESSIBLE_PERCENTAGE,ITEM_EXCISE_ACCESSIBLE_AMOUNT,ITEM_EXCISE_DUTY_PERCENTAGE,ITEM_EXCISE_DUTY_AMOUNT,ITEM_EXCISE_EDU_CESS_PERCENTAGE,ITEM_EXCISE_EDU_CESS_AMOUNT,ITEM_EXCISE_HEDU_CESS_PERCENTAGE,ITEM_EXCISE_HEDU_CESS_AMOUNT,ITEM_EXCISE_MRP,ONLINE_PRODUCT_CODE,MANUAL_NET_RATE,GROSS_RATE,MARGIN_PERCENTAGE,MARGIN_AMOUNT,ITEM_ROUND_OFF,HSN_CODE,GST_PERCENTAGE,IGST_AMOUNT,CGST_AMOUNT,SGST_AMOUNT,XN_VALUE_WITHOUT_GST,XN_VALUE_WITH_GST,ORDER_NO,ONLINE_BILL_REF_NO,TAX_ROUND_OFF,BOX_ID,INMDISCOUNTAMOUNT,CAST('' AS VARCHAR(100))UOM_CODE,CAST('' AS VARCHAR(100))UOM_NAME INTO #IND FROM IND01106 (NOLOCK)
SET @CMD='SELECT INV_ID,PRODUCT_CODE,QUANTITY,RATE,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,DEPT_ID,ROW_ID,LAST_UPDATE,PRINT_LABEL,RFNET,RFNET_WOTAX,COMPANY_CODE,NET_RATE,EMP_CODE,BOX_NO,MRP,BOX_DT,ITEM_TAX_PERCENTAGE,ITEM_TAX_AMOUNT,ITEM_FORM_ID,PS_ID,EMP_CODE1,EMP_CODE2,INVOICE_QUANTITY,SCHEME_QUANTITY,MANUAL_DISCOUNT,AUTO_SRNO,PARTY_MRP,REMARKS,WS_PRICE,BIN_ID,W8_CHALLAN_ID,CUSTOM_DUTY_AMT,TOTAL_CUSTOM_DUTY_AMT,CVD_AMT,CVD_PER,CUSTOM_DUTY_PER,PICKLIST_ARTICLE_CODE,PICKLIST_PARA1_CODE,PICKLIST_PARA2_CODE,PICK_LIST_ID,MANUAL_RATE,ORDER_ID,REF_WPS_DET_ROWID,ITEM_EXCISE_ACCESSIBLE_PERCENTAGE,ITEM_EXCISE_ACCESSIBLE_AMOUNT,ITEM_EXCISE_DUTY_PERCENTAGE,ITEM_EXCISE_DUTY_AMOUNT,ITEM_EXCISE_EDU_CESS_PERCENTAGE,ITEM_EXCISE_EDU_CESS_AMOUNT,ITEM_EXCISE_HEDU_CESS_PERCENTAGE,ITEM_EXCISE_HEDU_CESS_AMOUNT,ITEM_EXCISE_MRP,ONLINE_PRODUCT_CODE,MANUAL_NET_RATE,GROSS_RATE,MARGIN_PERCENTAGE,MARGIN_AMOUNT,ITEM_ROUND_OFF,HSN_CODE,GST_PERCENTAGE,IGST_AMOUNT,CGST_AMOUNT,SGST_AMOUNT,XN_VALUE_WITHOUT_GST,XN_VALUE_WITH_GST,ORDER_NO,ONLINE_BILL_REF_NO,TAX_ROUND_OFF,BOX_ID,INMDISCOUNTAMOUNT,'''','''' FROM IND01106 (NOLOCK) WHERE INV_ID '+@LIST+''
INSERT INTO #IND EXEC(@CMD)

IF OBJECT_ID('TEMPDB..##INDINV') IS NOT NULL
   DROP TABLE ##INDINV
SELECT DISTINCT INV_ID INTO ##INDINV FROM #IND

DECLARE @BASE_PRICE VARCHAR(100),@DISC_MODE VARCHAR(100),@DISC_PER FLOAT
,@SHOW_ARTICLE BIT,@SHOW_SUB_SECTION BIT,@SHOW_SECTION BIT,@SHOW_PARA1 BIT,@SHOW_PARA2 BIT,@SHOW_PARA3 BIT,@SHOW_PARA4 BIT,@SHOW_PARA5 BIT,@SHOW_PARA6 BIT,@SHOW_HSN BIT
SELECT TOP 1 @BASE_PRICE=(CASE WHEN MST_BASE_PRICE=1 THEN 'WSP' WHEN MST_BASE_PRICE=2 THEN 'MRP'  WHEN MST_BASE_PRICE=3 THEN 'PURCHASE PRICE'   ELSE 'WSP' END) --AS  MST_BASE_PRICE_NAME
,@DISC_MODE=(CASE WHEN MST_CAL_MODE=1 THEN 'ADD' WHEN MST_CAL_MODE=2 THEN 'LESS' ELSE 'LESS' END) --AS  MST_CAL_MODE_NAME
,@DISC_PER=D.VALUE,@SHOW_ARTICLE=SHOW_ARTICLE,@SHOW_SUB_SECTION=SHOW_SUB_SECTION,@SHOW_SECTION=SHOW_SECTION,@SHOW_PARA1=SHOW_PARA1,@SHOW_PARA2=SHOW_PARA2,@SHOW_PARA3=SHOW_PARA3,@SHOW_PARA4=SHOW_PARA4,@SHOW_PARA5=SHOW_PARA5,@SHOW_PARA6=SHOW_PARA6,@SHOW_HSN=SHOW_HSN
FROM LMP01106 L
JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
WHERE L.AC_CODE=@AC_CODE

UPDATE #IND SET RATE=0,MRP=0,WS_PRICE=0,PARTY_MRP=0,RFNET=0,RFNET_WOTAX=0,DISCOUNT_AMOUNT=0,DISCOUNT_PERCENTAGE=0,NET_RATE=0,GST_PERCENTAGE=0,IGST_AMOUNT=0,CGST_AMOUNT=0,SGST_AMOUNT=0,XN_VALUE_WITHOUT_GST=0,XN_VALUE_WITH_GST=0

UPDATE I SET MRP=S.MRP,WS_PRICE=S.WS_PRICE,PARTY_MRP=S.MRP,RATE=S.PURCHASE_PRICE FROM #IND I JOIN SKU S ON I.PRODUCT_CODE=S.PRODUCT_CODE WHERE S.AC_CODE=@AC_CODE
;WITH CTE AS
(SELECT PRODUCT_CODE,MRP,WS_PRICE,PURCHASE_PRICE,R=ROW_NUMBER()OVER(PARTITION BY PRODUCT_CODE ORDER BY AC_CODE) FROM SKU WHERE AC_CODE<>@AC_CODE) 
UPDATE I SET MRP=C.MRP,WS_PRICE=C.WS_PRICE,PARTY_MRP=C.MRP,RATE=C.PURCHASE_PRICE
FROM #IND I JOIN CTE C ON I.PRODUCT_CODE=C.PRODUCT_CODE WHERE C.R=1

--01 APR 2018
IF @BASE_PRICE='WSP'
   BEGIN
      UPDATE I SET WS_PRICE=MRP FROM #IND I WHERE WS_PRICE=0
      UPDATE I SET WS_PRICE=RATE FROM #IND I WHERE WS_PRICE=0
   END
ELSE IF @BASE_PRICE='MRP'
   BEGIN
      UPDATE I SET MRP=WS_PRICE FROM #IND I WHERE MRP=0
      UPDATE I SET MRP=RATE FROM #IND I WHERE MRP=0
   END   
ELSE IF @BASE_PRICE='PURCHASE PRICE'
   BEGIN
      UPDATE I SET RATE=WS_PRICE FROM #IND I WHERE PURCHASE_PRICE=0
      UPDATE I SET RATE=MRP FROM #IND I WHERE PURCHASE_PRICE=0
   END      
--01 APR 2018
IF @SHOW_ARTICLE=1
UPDATE I SET DISCOUNT_PERCENTAGE=ISNULL(TMP.VALUE,0) 
FROM #IND I
JOIN SKU      (NOLOCK) ON SKU.PRODUCT_CODE=I.PRODUCT_CODE
JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
JOIN (SELECT D.ARTICLE_CODE,D.VALUE FROM LMP01106 L
	  JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
	  JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
	  WHERE L.AC_CODE=@AC_CODE AND ISNULL(D.ARTICLE_CODE,'00000000')<>'00000000')TMP 
ON ARTICLE.ARTICLE_CODE=TMP.ARTICLE_CODE

IF @SHOW_SUB_SECTION=1
UPDATE I SET DISCOUNT_PERCENTAGE=ISNULL(TMP.VALUE,0) 
FROM #IND I
JOIN SKU      (NOLOCK) ON SKU.PRODUCT_CODE=I.PRODUCT_CODE
JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
JOIN (SELECT D.SUB_SECTION_CODE,D.VALUE FROM LMP01106 L
	  JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
	  JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
	  WHERE L.AC_CODE=@AC_CODE AND ISNULL(D.SUB_SECTION_CODE,'00000000')<>'00000000')TMP 
ON SECTIOND.SUB_SECTION_CODE=TMP.SUB_SECTION_CODE

IF @SHOW_SECTION=1
UPDATE I SET DISCOUNT_PERCENTAGE=ISNULL(TMP.VALUE,0) 
FROM #IND I
JOIN SKU      (NOLOCK) ON SKU.PRODUCT_CODE=I.PRODUCT_CODE
JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
JOIN (SELECT D.SECTION_CODE,D.VALUE FROM LMP01106 L
	  JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
	  JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
	  WHERE L.AC_CODE=@AC_CODE AND ISNULL(D.SECTION_CODE,'00000000')<>'00000000')TMP 
ON SECTIONM.SECTION_CODE=TMP.SECTION_CODE

IF @SHOW_PARA1=1
UPDATE I SET DISCOUNT_PERCENTAGE=ISNULL(TMP.VALUE,0) 
FROM #IND I
JOIN SKU      (NOLOCK) ON SKU.PRODUCT_CODE=I.PRODUCT_CODE
JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
JOIN (SELECT D.PARA1_CODE,D.VALUE FROM LMP01106 L
	  JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
	  JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
	  WHERE L.AC_CODE=@AC_CODE AND ISNULL(D.PARA1_CODE,'00000000')<>'00000000')TMP 
ON PARA1.PARA1_CODE=TMP.PARA1_CODE

IF @SHOW_PARA2=1
UPDATE I SET DISCOUNT_PERCENTAGE=ISNULL(TMP.VALUE,0) 
FROM #IND I
JOIN SKU      (NOLOCK) ON SKU.PRODUCT_CODE=I.PRODUCT_CODE
JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
JOIN (SELECT D.PARA2_CODE,D.VALUE FROM LMP01106 L
	  JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
	  JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
	  WHERE L.AC_CODE=@AC_CODE AND ISNULL(D.PARA2_CODE,'00000000')<>'00000000')TMP 
ON PARA2.PARA2_CODE=TMP.PARA2_CODE

IF @SHOW_PARA3=1
UPDATE I SET DISCOUNT_PERCENTAGE=ISNULL(TMP.VALUE,0) 
FROM #IND I
JOIN SKU      (NOLOCK) ON SKU.PRODUCT_CODE=I.PRODUCT_CODE
JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
JOIN (SELECT D.PARA3_CODE,D.VALUE FROM LMP01106 L
	  JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
	  JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
	  WHERE L.AC_CODE=@AC_CODE AND ISNULL(D.PARA3_CODE,'00000000')<>'00000000')TMP 
ON PARA3.PARA3_CODE=TMP.PARA3_CODE

IF @SHOW_PARA4=1
UPDATE I SET DISCOUNT_PERCENTAGE=ISNULL(TMP.VALUE,0) 
FROM #IND I
JOIN SKU      (NOLOCK) ON SKU.PRODUCT_CODE=I.PRODUCT_CODE
JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
JOIN (SELECT D.PARA4_CODE,D.VALUE FROM LMP01106 L
	  JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
	  JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
	  WHERE L.AC_CODE=@AC_CODE AND ISNULL(D.PARA4_CODE,'00000000')<>'00000000')TMP 
ON PARA4.PARA4_CODE=TMP.PARA4_CODE

IF @SHOW_PARA5=1
UPDATE I SET DISCOUNT_PERCENTAGE=ISNULL(TMP.VALUE,0) 
FROM #IND I
JOIN SKU      (NOLOCK) ON SKU.PRODUCT_CODE=I.PRODUCT_CODE
JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
JOIN (SELECT D.PARA5_CODE,D.VALUE FROM LMP01106 L
	  JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
	  JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
	  WHERE L.AC_CODE=@AC_CODE AND ISNULL(D.PARA5_CODE,'00000000')<>'00000000')TMP 
ON PARA5.PARA5_CODE=TMP.PARA5_CODE

IF @SHOW_PARA6=1
UPDATE I SET DISCOUNT_PERCENTAGE=ISNULL(TMP.VALUE,0) 
FROM #IND I
JOIN SKU      (NOLOCK) ON SKU.PRODUCT_CODE=I.PRODUCT_CODE
JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
JOIN (SELECT D.PARA6_CODE,D.VALUE FROM LMP01106 L
	  JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
	  JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
	  WHERE L.AC_CODE=@AC_CODE AND ISNULL(D.PARA6_CODE,'00000000')<>'00000000')TMP 
ON PARA6.PARA6_CODE=TMP.PARA6_CODE

IF @SHOW_HSN=1
UPDATE I SET DISCOUNT_PERCENTAGE=ISNULL(TMP.VALUE,0) 
FROM #IND I
JOIN SKU      (NOLOCK) ON SKU.PRODUCT_CODE=I.PRODUCT_CODE
JOIN ARTICLE  (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
JOIN (SELECT D.HSN_CODE,D.VALUE FROM LMP01106 L
	  JOIN PARTY_RATE_MST A ON A.MEMO_ID=L.PARTY_RATE_SUPP
	  JOIN PARTY_RATE_DET D ON A.MEMO_ID=D.MEMO_ID     	 
	  WHERE L.AC_CODE=@AC_CODE AND ISNULL(D.HSN_CODE,'00000000')<>'00000000')TMP 
ON SKU.HSN_CODE=TMP.HSN_CODE

UPDATE #IND SET DISCOUNT_PERCENTAGE=ISNULL(DISCOUNT_PERCENTAGE,0)*CASE @DISC_MODE WHEN 'ADD' THEN -1 ELSE 1 END

IF @BASE_PRICE='WSP'
BEGIN
	UPDATE #IND SET DISCOUNT_AMOUNT=INVOICE_QUANTITY*WS_PRICE*DISCOUNT_PERCENTAGE/100 WHERE DISCOUNT_PERCENTAGE<>0
	UPDATE #IND SET NET_RATE=WS_PRICE
	UPDATE #IND SET NET_RATE=ROUND(WS_PRICE-(DISCOUNT_AMOUNT/INVOICE_QUANTITY),0) WHERE DISCOUNT_PERCENTAGE<>0
END
ELSE IF @BASE_PRICE='MRP'
BEGIN
	UPDATE #IND SET DISCOUNT_AMOUNT=INVOICE_QUANTITY*MRP*DISCOUNT_PERCENTAGE/100 WHERE DISCOUNT_PERCENTAGE<>0
	UPDATE #IND SET NET_RATE=MRP
	UPDATE #IND SET NET_RATE=ROUND(MRP-(DISCOUNT_AMOUNT/INVOICE_QUANTITY),0) WHERE DISCOUNT_PERCENTAGE<>0
END
ELSE IF @BASE_PRICE='PURCHASE PRICE'
BEGIN
	UPDATE #IND SET DISCOUNT_AMOUNT=INVOICE_QUANTITY*RATE*DISCOUNT_PERCENTAGE/100 WHERE DISCOUNT_PERCENTAGE<>0
	UPDATE #IND SET NET_RATE=RATE
	UPDATE #IND SET NET_RATE=ROUND(RATE-(DISCOUNT_AMOUNT/INVOICE_QUANTITY),0) WHERE DISCOUNT_PERCENTAGE<>0
END
ELSE
BEGIN
	UPDATE #IND SET DISCOUNT_AMOUNT=INVOICE_QUANTITY*WS_PRICE*DISCOUNT_PERCENTAGE/100 WHERE DISCOUNT_PERCENTAGE<>0
	UPDATE #IND SET NET_RATE=WS_PRICE
	UPDATE #IND SET NET_RATE=ROUND(WS_PRICE-(DISCOUNT_AMOUNT/INVOICE_QUANTITY),0) WHERE DISCOUNT_PERCENTAGE<>0
END

SET @CMD='SELECT IND01106.*,E.UOM_CODE,E.UOM_NAME,NEWID()AS ROW_ID 
     ,BN.BIN_NAME
	 ,B.ARTICLE_NAME
	 ,B.ARTICLE_NO
	 ,PARA1.PARA1_NAME 
	 ,PARA2.PARA2_NAME
	 ,PARA3.PARA3_NAME
	 ,PARA4.PARA4_NAME
	 ,PARA5.PARA5_NAME
	 ,PARA6.PARA6_NAME
	 ,SECTIONM.SECTION_NAME
	 ,SECTIOND.SUB_SECTION_NAME
	 FROM #IND IND01106 (NOLOCK) 
	 JOIN SKU S (NOLOCK) ON S.PRODUCT_CODE = IND01106.PRODUCT_CODE   
	 JOIN ARTICLE B (NOLOCK) ON S.ARTICLE_CODE = B.ARTICLE_CODE 
	 JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=B.SUB_SECTION_CODE
	 JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
	 JOIN PARA1    (NOLOCK) ON PARA1.PARA1_CODE=S.PARA1_CODE
	 JOIN PARA2    (NOLOCK) ON PARA2.PARA2_CODE=S.PARA2_CODE
	 JOIN PARA3    (NOLOCK) ON PARA3.PARA3_CODE=S.PARA3_CODE
	 JOIN PARA4    (NOLOCK) ON PARA4.PARA4_CODE=S.PARA4_CODE
	 JOIN PARA5    (NOLOCK) ON PARA5.PARA5_CODE=S.PARA5_CODE
	 JOIN PARA6    (NOLOCK) ON PARA6.PARA6_CODE=S.PARA6_CODE
	 JOIN UOM E (NOLOCK) ON B.UOM_CODE = E.UOM_CODE
	 JOIN BIN BN (NOLOCK) ON BN.BIN_ID=IND01106.BIN_ID'
EXEC(@CMD)

GOTO END_PROC

END_PROC:
SET NOCOUNT OFF
END
