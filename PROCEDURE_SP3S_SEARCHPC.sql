CREATE PROCEDURE SP3S_SEARCHPC
(
@NMODE INT,   --- MODE 1 : STOCK  &  MODE 2 : SALE
@CWHERE VARCHAR(MAX),
@DEPT_ID VARCHAR(5)
)
AS 
BEGIN

         DECLARE @CCMD NVARCHAR(MAX), @CCMD1 NVARCHAR(MAX),@CFILTER VARCHAR(MAX)


    
	   IF @CWHERE <>''
	     BEGIN
	      SET @CFILTER='' 
		    SET @CFILTER='AND '+ @CWHERE +''
	      END
	   IF @CWHERE=''
		  BEGIN
		    SET @CFILTER=''
		  END
	   


		IF @NMODE=1
		 GOTO LBLSTOCK
		ELSE IF @NMODE=2
		 GOTO LBLSALE
		ELSE
		 GOTO ENDPROC


LBLSTOCK:

	SET @CCMD=N'SELECT CONVERT(BIT ,0) AS [CHK],SKU.PRODUCT_CODE ,SKU.MRP,SKU.INV_DT ,SKU.INV_NO, 
		        ISNULL(X.QUANTITY_IN_STOCK,0) AS [QUANTITY_IN_STOCK] , 
				ARTICLE.ARTICLE_CODE, ARTICLE.ARTICLE_NO, ARTICLE.ARTICLE_NAME ,
				SECTIOND.SUB_SECTION_NAME,SECTIONM.SECTION_NAME,
				PARA1.PARA1_NAME, PARA2.PARA2_NAME, PARA3.PARA3_NAME, 
				PARA4.PARA4_NAME, PARA5.PARA5_NAME, PARA6.PARA6_NAME,
				ISNULL(ARTICLE.DT_CREATED,''19000101'') AS ART_DT_CREATED,
				ISNULL(PARA3.DT_CREATED,''19000101'') AS PARA3_DT_CREATED,
				ISNULL(SKU.DT_CREATED,''19000101'') AS SKU_DT_CREATED,CUST.REF_NO,X1.BIN_ID
				 ,AT1.attr1_key_name,AT2.attr2_key_name,AT3.attr3_key_name,AT4.attr4_key_name,AT5.attr5_key_name,AT6.attr6_key_name,
   AT7.attr7_key_name,AT8.attr8_key_name,AT9.attr9_key_name,AT10.attr10_key_name,AT11.attr11_key_name,AT12.attr12_key_name,
   AT13.attr13_key_name,AT14.attr14_key_name,AT15.attr15_key_name,AT16.attr16_key_name,AT17.attr17_key_name,AT18.attr18_key_name,
   AT19.attr19_key_name,AT20.attr20_key_name,AT21.attr21_key_name,AT22.attr22_key_name,AT23.attr23_key_name,AT24.attr24_key_name,
	AT25.attr25_key_name 
		 FROM SKU (NOLOCK) 
		 JOIN 
		( 
		   SELECT PRODUCT_CODE ,DEPT_ID,BIN_ID, SUM(QUANTITY_IN_STOCK) AS [QUANTITY_IN_STOCK] 
		   FROM PMT01106 (NOLOCK) GROUP BY PRODUCT_CODE,DEPT_ID,BIN_ID 
		)X ON SKU.PRODUCT_CODE = X.PRODUCT_CODE  
		 JOIN 
		( 
		   SELECT A.BIN_ID ,COUNT(*) AS [C] FROM BINUSERS A JOIN BIN_LOC B ON B.BIN_ID=A.BIN_ID 
		   WHERE B.DEPT_ID='''+ @DEPT_ID +'''
		   AND A.USER_CODE=(CASE WHEN ''0000000''=''0000000'' THEN A.USER_CODE ELSE ''0000000'' END) 
		 GROUP BY A.BIN_ID 
		)X1 ON ISNULL(X.BIN_ID,''000'') = X1.BIN_ID  

		 JOIN ARTICLE (NOLOCK)  ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE  
		 JOIN PARA1   (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE 
		 JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE 
		 JOIN PARA3  (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE 
		 JOIN PARA4 (NOLOCK)  ON SKU.PARA4_CODE = PARA4.PARA4_CODE 
		 JOIN PARA5 (NOLOCK)  ON SKU.PARA5_CODE = PARA5.PARA5_CODE 
		 JOIN PARA6 (NOLOCK)  ON SKU.PARA6_CODE = PARA6.PARA6_CODE 
		 JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
		 JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
		 LEFT OUTER JOIN ARTICLE_FIX_ATTR ATTR  (NOLOCK) ON article.ARTICLE_CODE = ATTR.ARTICLE_CODE 
		LEFT OUTER JOIN ATTR1_MST AT1 (NOLOCK) ON AT1.ATTR1_KEY_CODE=ATTR.ATTR1_KEY_CODE
		LEFT OUTER JOIN ATTR2_MST AT2 (NOLOCK) ON AT2.ATTR2_KEY_CODE=ATTR.ATTR2_KEY_CODE
		LEFT OUTER JOIN ATTR3_MST AT3 (NOLOCK) ON AT3.ATTR3_KEY_CODE=ATTR.ATTR3_KEY_CODE
		LEFT OUTER JOIN ATTR4_MST AT4 (NOLOCK) ON AT4.ATTR4_KEY_CODE=ATTR.ATTR4_KEY_CODE
		LEFT OUTER JOIN ATTR5_MST AT5 (NOLOCK) ON AT5.ATTR5_KEY_CODE=ATTR.ATTR5_KEY_CODE
		LEFT OUTER JOIN ATTR6_MST AT6 (NOLOCK) ON AT6.ATTR6_KEY_CODE=ATTR.ATTR6_KEY_CODE
		LEFT OUTER JOIN ATTR7_MST AT7 (NOLOCK) ON AT7.ATTR7_KEY_CODE=ATTR.ATTR7_KEY_CODE
		LEFT OUTER JOIN ATTR8_MST AT8 (NOLOCK) ON AT8.ATTR8_KEY_CODE=ATTR.ATTR8_KEY_CODE
		LEFT OUTER JOIN ATTR9_MST AT9 (NOLOCK) ON AT9.ATTR9_KEY_CODE=ATTR.ATTR9_KEY_CODE
		LEFT OUTER JOIN ATTR10_MST AT10 (NOLOCK) ON AT10.ATTR10_KEY_CODE=ATTR.ATTR10_KEY_CODE
		LEFT OUTER JOIN ATTR11_MST AT11 (NOLOCK) ON AT11.ATTR11_KEY_CODE=ATTR.ATTR11_KEY_CODE
		LEFT OUTER JOIN ATTR12_MST AT12 (NOLOCK) ON AT12.ATTR12_KEY_CODE=ATTR.ATTR12_KEY_CODE
		LEFT OUTER JOIN ATTR13_MST AT13 (NOLOCK) ON AT13.ATTR13_KEY_CODE=ATTR.ATTR13_KEY_CODE
		LEFT OUTER JOIN ATTR14_MST AT14 (NOLOCK) ON AT14.ATTR14_KEY_CODE=ATTR.ATTR14_KEY_CODE
		LEFT OUTER JOIN ATTR15_MST AT15 (NOLOCK) ON AT15.ATTR15_KEY_CODE=ATTR.ATTR15_KEY_CODE
		LEFT OUTER JOIN ATTR16_MST AT16 (NOLOCK) ON AT16.ATTR16_KEY_CODE=ATTR.ATTR16_KEY_CODE
		LEFT OUTER JOIN ATTR17_MST AT17 (NOLOCK) ON AT17.ATTR17_KEY_CODE=ATTR.ATTR17_KEY_CODE
		LEFT OUTER JOIN ATTR18_MST AT18 (NOLOCK) ON AT18.ATTR18_KEY_CODE=ATTR.ATTR18_KEY_CODE
		LEFT OUTER JOIN ATTR19_MST AT19 (NOLOCK) ON AT19.ATTR19_KEY_CODE=ATTR.ATTR19_KEY_CODE
		LEFT OUTER JOIN ATTR20_MST AT20 (NOLOCK) ON AT20.ATTR20_KEY_CODE=ATTR.ATTR20_KEY_CODE
		LEFT OUTER JOIN ATTR21_MST AT21 (NOLOCK) ON AT21.ATTR21_KEY_CODE=ATTR.ATTR21_KEY_CODE
		LEFT OUTER JOIN ATTR22_MST AT22 (NOLOCK) ON AT22.ATTR22_KEY_CODE=ATTR.ATTR22_KEY_CODE
		LEFT OUTER JOIN ATTR23_MST AT23 (NOLOCK) ON AT23.ATTR23_KEY_CODE=ATTR.ATTR23_KEY_CODE
		LEFT OUTER JOIN ATTR24_MST AT24 (NOLOCK) ON AT24.ATTR24_KEY_CODE=ATTR.ATTR24_KEY_CODE
		LEFT OUTER JOIN ATTR25_MST AT25(NOLOCK) ON AT25.ATTR25_KEY_CODE=ATTR.ATTR25_KEY_CODE
		LEFT OUTER JOIN 
		( SELECT DISTINCT (CASE WHEN B.CUSTOMER_CODE=''000000000000'' THEN B.AC_CODE ELSE C.CUSTOMER_CODE END ) AS CUSTOMER_CODE,
				 (CASE WHEN ISNULL(A.REF_PRODUCT_CODE,'''')='''' THEN A.PRODUCT_CODE ELSE A.REF_PRODUCT_CODE END) 
				 AS PRODUCT_CODE,B.REF_NO,B.ORDER_ID
		  FROM WSL_ORDER_DET  A (NOLOCK)
		  JOIN WSL_ORDER_MST B  (NOLOCK) ON A.ORDER_ID = B.ORDER_ID 
		  LEFT OUTER JOIN CUSTDYM C (NOLOCK) ON B.CUSTOMER_CODE = C.CUSTOMER_CODE
		  LEFT OUTER JOIN LM01106 D (NOLOCK) ON B.AC_CODE = D.AC_CODE 
		 WHERE B.CANCELLED=0 AND ISNULL(A.CANCELLED,0)=0  )  CUST ON SKU.PRODUCT_CODE= CUST.PRODUCT_CODE
		 ----WHERE SKU.PRODUCT_CODE <> '' AND ISNULL(X.DEPT_ID,''HO'')=''HO'' AND ISNULL(X.QUANTITY_IN_STOCK,0) >0
		 
		 WHERE SKU.PRODUCT_CODE <> '''' AND ISNULL(X.QUANTITY_IN_STOCK,0) >0 '+ @CFILTER +' 
		 ORDER BY SKU.PRODUCT_CODE, ARTICLE.ARTICLE_NO, PARA1.PARA1_NAME, 
						PARA2.PARA2_NAME, PARA3.PARA3_NAME,SECTIOND.SUB_SECTION_NAME,SECTIONM.SECTION_NAME '	
						
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD					
  GOTO ENDPROC

LBLSALE:

	SET @CCMD1=N'SELECT CONVERT(BIT ,0) AS [CHK],SKU.PRODUCT_CODE ,SKU.MRP,SKU.INV_DT ,SKU.INV_NO, 
	           ISNULL(XX.QTY,0) AS [QUANTITY_IN_STOCK] , 
		ARTICLE.ARTICLE_CODE, ARTICLE.ARTICLE_NO, ARTICLE.ARTICLE_NAME ,
		SECTIOND.SUB_SECTION_NAME,SECTIONM.SECTION_NAME , 
		PARA1.PARA1_NAME, PARA2.PARA2_NAME, PARA3.PARA3_NAME, 
		PARA4.PARA4_NAME, PARA5.PARA5_NAME, PARA6.PARA6_NAME,ISNULL(ARTICLE.DT_CREATED,''19000101'') AS ART_DT_CREATED,
		ISNULL(PARA3.DT_CREATED,''19000101'') AS PARA3_DT_CREATED,
		ISNULL(SKU.DT_CREATED,''19000101'') AS SKU_DT_CREATED,CUST.REF_NO,X1.BIN_ID
		 ,AT1.attr1_key_name,AT2.attr2_key_name,AT3.attr3_key_name,AT4.attr4_key_name,AT5.attr5_key_name,AT6.attr6_key_name,
   AT7.attr7_key_name,AT8.attr8_key_name,AT9.attr9_key_name,AT10.attr10_key_name,AT11.attr11_key_name,AT12.attr12_key_name,
   AT13.attr13_key_name,AT14.attr14_key_name,AT15.attr15_key_name,AT16.attr16_key_name,AT17.attr17_key_name,AT18.attr18_key_name,
   AT19.attr19_key_name,AT20.attr20_key_name,AT21.attr21_key_name,AT22.attr22_key_name,AT23.attr23_key_name,AT24.attr24_key_name,
	AT25.attr25_key_name 
		 FROM SKU (NOLOCK) 
		 JOIN 
		( 
		   SELECT PRODUCT_CODE ,DEPT_ID,BIN_ID, SUM(QUANTITY_IN_STOCK) AS [QUANTITY_IN_STOCK] 
		   FROM PMT01106 (NOLOCK) GROUP BY PRODUCT_CODE,DEPT_ID,BIN_ID 
		)X ON SKU.PRODUCT_CODE = X.PRODUCT_CODE  
		 JOIN 
		( 
		   SELECT A.BIN_ID ,COUNT(*) AS [C] FROM BINUSERS A JOIN BIN_LOC B ON B.BIN_ID=A.BIN_ID 
		   WHERE B.DEPT_ID='''+ @DEPT_ID +'''
		   AND A.USER_CODE=(CASE WHEN ''0000000''=''0000000'' THEN A.USER_CODE ELSE ''0000000'' END) 
		 GROUP BY A.BIN_ID 
		)X1 ON ISNULL(X.BIN_ID,''000'') = X1.BIN_ID  
		 JOIN 
		(
		   SELECT PRODUCT_CODE,SUM(QTY) AS [QTY] FROM 
		   (
			   SELECT PRODUCT_CODE ,QUANTITY AS [QTY] FROM CMD01106 A (NOLOCK)  JOIN CMM01106 B (NOLOCK) ON B.CM_ID =A.CM_ID WHERE B.CANCELLED=0  
			   UNION 
			   SELECT PRODUCT_CODE,QUANTITY AS [QTY] FROM IND01106 A (NOLOCK)  JOIN INM01106 B (NOLOCK)   ON B.INV_ID =A.INV_ID WHERE B.CANCELLED=0 AND B.INV_MODE=1 AND B.BIN_TRANSFER=0 
		   )ZZ 
		   GROUP BY PRODUCT_CODE 
		   HAVING SUM(QTY) >=0 
		)XX ON XX.PRODUCT_CODE=SKU.PRODUCT_CODE 
		 JOIN ARTICLE (NOLOCK)  ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE  
		 JOIN PARA1   (NOLOCK) ON SKU.PARA1_CODE = PARA1.PARA1_CODE 
		 JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE = PARA2.PARA2_CODE 
		 JOIN PARA3  (NOLOCK) ON SKU.PARA3_CODE = PARA3.PARA3_CODE 
		 JOIN PARA4 (NOLOCK)  ON SKU.PARA4_CODE = PARA4.PARA4_CODE 
		 JOIN PARA5 (NOLOCK)  ON SKU.PARA5_CODE = PARA5.PARA5_CODE 
		 JOIN PARA6 (NOLOCK)  ON SKU.PARA6_CODE = PARA6.PARA6_CODE
		  JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
		 JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE 
		 LEFT OUTER JOIN ARTICLE_FIX_ATTR ATTR  (NOLOCK) ON ARTICLE.ARTICLE_CODE = ATTR.ARTICLE_CODE 
LEFT OUTER JOIN ATTR1_MST AT1 (NOLOCK) ON AT1.ATTR1_KEY_CODE=ATTR.ATTR1_KEY_CODE
LEFT OUTER JOIN ATTR2_MST AT2 (NOLOCK) ON AT2.ATTR2_KEY_CODE=ATTR.ATTR2_KEY_CODE
LEFT OUTER JOIN ATTR3_MST AT3 (NOLOCK) ON AT3.ATTR3_KEY_CODE=ATTR.ATTR3_KEY_CODE
LEFT OUTER JOIN ATTR4_MST AT4 (NOLOCK) ON AT4.ATTR4_KEY_CODE=ATTR.ATTR4_KEY_CODE
LEFT OUTER JOIN ATTR5_MST AT5 (NOLOCK) ON AT5.ATTR5_KEY_CODE=ATTR.ATTR5_KEY_CODE
LEFT OUTER JOIN ATTR6_MST AT6 (NOLOCK) ON AT6.ATTR6_KEY_CODE=ATTR.ATTR6_KEY_CODE
LEFT OUTER JOIN ATTR7_MST AT7 (NOLOCK) ON AT7.ATTR7_KEY_CODE=ATTR.ATTR7_KEY_CODE
LEFT OUTER JOIN ATTR8_MST AT8 (NOLOCK) ON AT8.ATTR8_KEY_CODE=ATTR.ATTR8_KEY_CODE
LEFT OUTER JOIN ATTR9_MST AT9 (NOLOCK) ON AT9.ATTR9_KEY_CODE=ATTR.ATTR9_KEY_CODE
LEFT OUTER JOIN ATTR10_MST AT10 (NOLOCK) ON AT10.ATTR10_KEY_CODE=ATTR.ATTR10_KEY_CODE
LEFT OUTER JOIN ATTR11_MST AT11 (NOLOCK) ON AT11.ATTR11_KEY_CODE=ATTR.ATTR11_KEY_CODE
LEFT OUTER JOIN ATTR12_MST AT12 (NOLOCK) ON AT12.ATTR12_KEY_CODE=ATTR.ATTR12_KEY_CODE
LEFT OUTER JOIN ATTR13_MST AT13 (NOLOCK) ON AT13.ATTR13_KEY_CODE=ATTR.ATTR13_KEY_CODE
LEFT OUTER JOIN ATTR14_MST AT14 (NOLOCK) ON AT14.ATTR14_KEY_CODE=ATTR.ATTR14_KEY_CODE
LEFT OUTER JOIN ATTR15_MST AT15 (NOLOCK) ON AT15.ATTR15_KEY_CODE=ATTR.ATTR15_KEY_CODE
LEFT OUTER JOIN ATTR16_MST AT16 (NOLOCK) ON AT16.ATTR16_KEY_CODE=ATTR.ATTR16_KEY_CODE
LEFT OUTER JOIN ATTR17_MST AT17 (NOLOCK) ON AT17.ATTR17_KEY_CODE=ATTR.ATTR17_KEY_CODE
LEFT OUTER JOIN ATTR18_MST AT18 (NOLOCK) ON AT18.ATTR18_KEY_CODE=ATTR.ATTR18_KEY_CODE
LEFT OUTER JOIN ATTR19_MST AT19 (NOLOCK) ON AT19.ATTR19_KEY_CODE=ATTR.ATTR19_KEY_CODE
LEFT OUTER JOIN ATTR20_MST AT20 (NOLOCK) ON AT20.ATTR20_KEY_CODE=ATTR.ATTR20_KEY_CODE
LEFT OUTER JOIN ATTR21_MST AT21 (NOLOCK) ON AT21.ATTR21_KEY_CODE=ATTR.ATTR21_KEY_CODE
LEFT OUTER JOIN ATTR22_MST AT22 (NOLOCK) ON AT22.ATTR22_KEY_CODE=ATTR.ATTR22_KEY_CODE
LEFT OUTER JOIN ATTR23_MST AT23 (NOLOCK) ON AT23.ATTR23_KEY_CODE=ATTR.ATTR23_KEY_CODE
LEFT OUTER JOIN ATTR24_MST AT24 (NOLOCK) ON AT24.ATTR24_KEY_CODE=ATTR.ATTR24_KEY_CODE
LEFT OUTER JOIN ATTR25_MST AT25(NOLOCK) ON AT25.ATTR25_KEY_CODE=ATTR.ATTR25_KEY_CODE
		LEFT OUTER JOIN 
		( SELECT (CASE WHEN B.CUSTOMER_CODE=''000000000000'' THEN B.AC_CODE ELSE C.CUSTOMER_CODE END ) AS CUSTOMER_CODE,
				 (CASE WHEN ISNULL(A.REF_PRODUCT_CODE,'''')='''' THEN A.PRODUCT_CODE ELSE A.REF_PRODUCT_CODE END) AS PRODUCT_CODE,B.REF_NO,B.ORDER_ID
		  FROM WSL_ORDER_DET  A (NOLOCK)
		  JOIN WSL_ORDER_MST B  (NOLOCK) ON A.ORDER_ID = B.ORDER_ID 
		  LEFT OUTER JOIN CUSTDYM C (NOLOCK) ON B.CUSTOMER_CODE = C.CUSTOMER_CODE
		  LEFT OUTER JOIN LM01106 D (NOLOCK) ON B.AC_CODE = D.AC_CODE 
		WHERE B.CANCELLED=0 AND ISNULL(A.CANCELLED,0)=0  )  CUST ON SKU.PRODUCT_CODE= CUST.PRODUCT_CODE
		 WHERE 
		---- AND ISNULL(X.QUANTITY_IN_STOCK,0) >0 
		 SKU.PRODUCT_CODE <> ''''  '+ @CFILTER +'  
		 ORDER BY SKU.PRODUCT_CODE, ARTICLE.ARTICLE_NO, PARA1.PARA1_NAME, 
						PARA2.PARA2_NAME, PARA3.PARA3_NAME,SECTIOND.SUB_SECTION_NAME,SECTIONM.SECTION_NAME '
      PRINT @CCMD1
      EXEC SP_EXECUTESQL @CCMD1     						
						


  GOTO ENDPROC
 
   ENDPROC: 
END
