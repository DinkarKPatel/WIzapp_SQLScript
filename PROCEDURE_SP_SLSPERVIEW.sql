CREATE PROCEDURE SP_SLSPERVIEW--(LocId 3 digit change by Sanjay:30-10-2024)
(
	@DFROMDT VARCHAR(20),
	@DTODT VARCHAR(20),
	@NMODE INT = 1,
	@CLOCID VARCHAR(4)='',
	@CEMPCODE VARCHAR(7)=''
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CHODEPTID VARCHAR(4),
			@CLOCDEPTID VARCHAR(4),
			@CDEPTID VARCHAR(4),
			@CCMD NVARCHAR(4000)


	SELECT @CHODEPTID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'
	SELECT @CLOCDEPTID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'LOCATION_ID'

	SET @CDEPTID = (CASE WHEN @CHODEPTID=@CLOCDEPTID 
						 THEN @CHODEPTID 
						 ELSE @CLOCDEPTID
					END )
	IF @CLOCID <> ''
		SET @CLOCID = (CASE WHEN @CHODEPTID=@CLOCDEPTID 
							 THEN @CLOCID 
							 ELSE @CLOCDEPTID
						END )

	IF EXISTS ( SELECT NAME FROM TEMPDB..SYSOBJECTS WHERE NAME = '#SLSC' )
		DROP TABLE #SLSC

	CREATE TABLE #SLSC ( CM_ID VARCHAR(22), CM_NO VARCHAR(12), CM_DT DATETIME, EMP_CODE VARCHAR(10), 
						  SALEAMT1 NUMERIC(14,2), COMMAMT1 NUMERIC(14,2), 
						  SALEAMT2 NUMERIC(14,2), COMMAMT2 NUMERIC(14,2), 
						  SALEAMT3 NUMERIC(14,2), COMMAMT3 NUMERIC(14,2) )

	
		SET @CCMD = N'INSERT #SLSC
		SELECT CMM.CM_ID, CMM.CM_NO, CMM.CM_DT, CMD.EMP_CODE, 
			SUM(NET-NET*CMM.DISCOUNT_PERCENTAGE/100) AS SALEAMT1, 
			SUM(CASE WHEN PMT.COMMNET<>0 THEN PMT.COMMNET ELSE 
				((NET-NET*CMM.DISCOUNT_PERCENTAGE/100) * PMT.COMMPCT/100) END ) AS COMMAMT1, 
			0 AS SALEAMT2, 
			0 AS COMMAMT2, 
			0 AS SALEAMT3,
			0 AS COMMAMT3
			FROM CMD01106 CMD 
			JOIN PMT01106 PMT ON CMD.PRODUCT_CODE = PMT.PRODUCT_CODE AND PMT.DEPT_ID = ''' + @CDEPTID + '''
			JOIN CMM01106 CMM ON CMD.CM_ID=CMM.CM_ID 
			WHERE CMM.CM_DT BETWEEN ''' + @DFROMDT + ''' AND ''' + @DTODT + '''
			AND CANCELLED=0 AND CM_MODE=1 ' +
			(CASE WHEN @CLOCID <> '' THEN N' AND LEFT(CMM.CM_NO,2)= ''' + @CLOCID + '''' ELSE '' END ) +
			(CASE WHEN @NMODE = 2 THEN N' AND ( PMT.COMMPCT + PMT.COMMNET ) <> 0 '
				  WHEN @NMODE = 3 THEN N' AND ( PMT.COMMPCT + PMT.COMMNET ) = 0 '
			      ELSE '' END ) + N'
			GROUP BY CMM.CM_ID, CMM.CM_NO, CMM.CM_DT, CMD.EMP_CODE
		UNION ALL
		SELECT CMM.CM_ID, CMM.CM_NO, CMM.CM_DT, CMD.EMP_CODE2 AS EMP_CODE, 
			0 AS SALEAMT1, 
			0 AS COMMAMT1,
			SUM(NET-NET*CMM.DISCOUNT_PERCENTAGE/100) AS SALEAMT2, 
			SUM(CASE WHEN PMT.COMMNET<>0 THEN PMT.COMMNET ELSE 
				((NET-NET*CMM.DISCOUNT_PERCENTAGE/100) * PMT.COMMPCT/100) END ) AS COMMAMT2, 
			0 AS SALEAMT3,
			0 AS COMMAMT3 
			FROM CMD01106 CMD 
			JOIN PMT01106 PMT ON CMD.PRODUCT_CODE = PMT.PRODUCT_CODE AND PMT.DEPT_ID = ''' + @CDEPTID + '''
			JOIN CMM01106 CMM ON CMD.CM_ID=CMM.CM_ID 
			WHERE CMM.CM_DT BETWEEN ''' + @DFROMDT + ''' AND ''' + @DTODT + '''
			AND CANCELLED=0 AND CM_MODE=1  ' +
			(CASE WHEN @CLOCID <> '' THEN N' AND LEFT(CMM.CM_NO,2)= ''' + @CLOCID + '''' ELSE '' END ) +
			(CASE WHEN @NMODE = 2 THEN N' AND ( PMT.COMMPCT + PMT.COMMNET ) <> 0 '
				  WHEN @NMODE = 3 THEN N' AND ( PMT.COMMPCT + PMT.COMMNET ) = 0 '
			      ELSE '' END ) + N'
			GROUP BY CMM.CM_ID, CMM.CM_NO, CMM.CM_DT, CMD.EMP_CODE2
		UNION ALL
		SELECT CMM.CM_ID, CMM.CM_NO, CMM.CM_DT, CMD.EMP_CODE3 AS EMP_CODE, 
			0 AS SALEAMT1, 
			0 AS COMMAMT1,
			0 AS SALEAMT2,
			0 AS COMMAMT2,
			SUM(NET-NET*CMM.DISCOUNT_PERCENTAGE/100) AS SALEAMT3,
			SUM(CASE WHEN PMT.COMMNET<>0 THEN PMT.COMMNET ELSE 
				((NET-NET*CMM.DISCOUNT_PERCENTAGE/100) * PMT.COMMPCT/100) END ) AS COMMAMT3
			FROM CMD01106 CMD 
			JOIN PMT01106 PMT ON CMD.PRODUCT_CODE = PMT.PRODUCT_CODE AND PMT.DEPT_ID = ''' + @CDEPTID + '''
			JOIN CMM01106 CMM ON CMD.CM_ID=CMM.CM_ID 
			WHERE CMM.CM_DT BETWEEN ''' + @DFROMDT + ''' AND ''' + @DTODT + '''
			AND CANCELLED=0 AND CM_MODE=1  ' +
			(CASE WHEN @CLOCID <> '' THEN N' AND LEFT(CMM.CM_NO,2)= ''' + @CLOCID + '''' ELSE '' END ) +
			(CASE WHEN @NMODE = 2 THEN N' AND ( PMT.COMMPCT + PMT.COMMNET ) <> 0 '
				  WHEN @NMODE = 3 THEN N' AND ( PMT.COMMPCT + PMT.COMMNET ) = 0 '
			      ELSE '' END ) + N'
			GROUP BY CMM.CM_ID, CMM.CM_NO, CMM.CM_DT, CMD.EMP_CODE3
		UNION ALL
		SELECT SOM.ORDER_ID AS CM_ID, SOM.ORDER_NO AS CM_NO, SOM.ORDER_DT AS CM_DT, SOM.EMP_CODE AS EMP_CODE,
			SUM(SOM.NET_AMOUNT) AS SALEAMT1, 
			0 AS COMMAMT1,
			0 AS SALEAMT2,
			0 AS COMMAMT2,
			0 AS SALEAMT3,
			0 AS COMMAMT3
			FROM SOM01106 SOM 
			WHERE SOM.ORDER_DT BETWEEN ''' + @DFROMDT + ''' AND ''' + @DTODT + '''
			AND CANCELLED=0  ' +
			(CASE WHEN @CLOCID <> '' THEN N' AND SOM.DEPT_ID= ''' + @CLOCID + '''' ELSE '' END ) + N'
			GROUP BY SOM.ORDER_ID, SOM.ORDER_NO, SOM.ORDER_DT, SOM.EMP_CODE
		UNION ALL
		SELECT SOM.ORDER_ID AS CM_ID, SOM.ORDER_NO AS CM_NO, SOM.ORDER_DT AS CM_DT, SOM.EMP_CODE2 AS EMP_CODE,
			0 AS SALEAMT1, 
			0 AS COMMAMT1,
			SUM(SOM.NET_AMOUNT) AS SALEAMT2,
			0 AS COMMAMT2,
			0 AS SALEAMT3, 
			0 AS COMMAMT3
			FROM SOM01106 SOM 
			WHERE SOM.ORDER_DT BETWEEN ''' + @DFROMDT + ''' AND ''' + @DTODT + '''
			AND CANCELLED=0 ' +
			(CASE WHEN @CLOCID <> '' THEN N' AND SOM.DEPT_ID= ''' + @CLOCID + '''' ELSE '' END ) + N'
			GROUP BY SOM.ORDER_ID, SOM.ORDER_NO, SOM.ORDER_DT, SOM.EMP_CODE2'

	--PRINT @CCMD

--	INSERT @SLSC
	EXEC SP_EXECUTESQL @CCMD

	SELECT	LOC.DEPT_ID AS DEPT_ID, LOC.DEPT_NAME AS LOCATION, 
			A.CM_NO, A.CM_DT, A.EMP_CODE, 
			( CASE WHEN EMP.EMP_NAME='' THEN 'MISC' ELSE EMP.EMP_NAME END ) AS EMP, 
			SUM(SALEAMT1) AS SALEAMT1, 
			SUM(COMMAMT1) AS COMMAMT1,
			SUM(SALEAMT2) AS SALEAMT2,
			SUM(COMMAMT2) AS COMMAMT2,
			SUM(SALEAMT3) AS SALEAMT3,
			SUM(COMMAMT3) AS COMMAMT3
	FROM #SLSC A
	JOIN EMPLOYEE EMP ON A.EMP_CODE = EMP.EMP_CODE
	JOIN LOCATION LOC ON LEFT(A.CM_NO,2) = LOC.DEPT_ID
	WHERE EMP.EMP_CODE = (CASE WHEN @CEMPCODE <> '' THEN @CEMPCODE ELSE EMP.EMP_CODE END )
	GROUP BY LOC.DEPT_ID, LOC.DEPT_NAME, A.CM_NO, A.CM_DT, A.EMP_CODE, 
			 ( CASE WHEN EMP.EMP_NAME='' THEN 'MISC' ELSE EMP.EMP_NAME END )
	ORDER BY DEPT_ID, A.CM_DT, A.CM_NO, EMP
END
