CREATE PROCEDURE SP3S_PRODUCTION_STATUS_REPORT    
(    
 @DASON AS DATETIME='',    
 @CARTICLE_CODE VARCHAR(MAX)='',    
 @CAC_CODE VARCHAR(MAX)='',    
 @MERCHANT_CODE VARCHAR(MAX)='',    
 @CAC_CODE_NOTIN VARCHAR(10)='',    
 @NSUMMARY INT=0 ,
 @NPENDING_WO INT=0  ,
 @CARTICLE_NO_CONTAINING VARCHAR(MAX)='' 
)    
AS    
BEGIN    
    
DECLARE @DTSQL NVARCHAR(MAX),@CART_STATUS VARCHAR(MAX),@AAC_STATUS VARCHAR(MAX),    
        @CMERCHANTSTATUS VARCHAR(MAX)    
    
    
IF @CARTICLE_CODE=''    
BEGIN    
   SET @CART_STATUS=''    
   SET @CARTICLE_CODE='IN('''')'    
END    
ELSE     
BEGIN    
   SET @CART_STATUS='LATER'    
END    
    
IF @CAC_CODE=''    
BEGIN    
   SET @AAC_STATUS=''    
   SET @CAC_CODE='IN('''')'    
END    
ELSE     
BEGIN    
   SET @AAC_STATUS='LATER'    
END    
    
    
IF @MERCHANT_CODE=''    
BEGIN    
   SET @CMERCHANTSTATUS=''    
   SET @MERCHANT_CODE='IN('''')'    
END    
ELSE     
BEGIN    
   SET @CMERCHANTSTATUS='LATER'    
END    
    
    
--BUYER ORDER AGEAINST WORK ORDER    
IF @CARTICLE_NO_CONTAINING<>''
SET @CARTICLE_NO_CONTAINING=' AND '+ @CARTICLE_NO_CONTAINING  
  
  IF OBJECT_ID('TEMPDB..#TMPALLOCATION','U') IS NOT NULL
     DROP TABLE #TMPALLOCATION
     
   SELECT  CAST('' AS VARCHAR(10))  AS AC_CODE,
   ISNULL(PMT.ORDER_ID ,B.ORDER_ID) AS ORDER_ID,
  PMT.MEMO_ID AS MEMO_ID ,  
  PMT.ARTICLE_CODE,PMT.PARA1_CODE,PMT.PARA2_CODE,
  PMT.PRODUCT_CODE AS PRODUCT_CODE,  
  PMT.QUANTITY_IN_STOCK AS QUANTITY_IN_STOCK,  
  PMT.JOB_CODE AS JOB_CODE  ,
  ISNULL(PMT.WO_QTY,0) AS   QTY,
  ISNULL(BM1.ORDER_NO ,M.ORDER_NO) AS ORDER_NO, ISNULL(BM1.ORDER_DT ,M.ORDER_DT) AS ORDER_DT,    
  ISNULL(BM1.DELIVERY_DT ,M.DELIVERY_DT) AS DELIVERY_DT,
  DATEDIFF(DAY,ISNULL(BM1.DELIVERY_DT ,M.DELIVERY_DT),GETDATE()) AS DTD,
  CONVERT(NUMERIC(10,2),0) AS PMT_STOCK,
  CONVERT(NUMERIC(10,2),0) AS WIP_STOCK, 
  CONVERT(NUMERIC(10,2),0) AS WO_QTY,
  CONVERT(NUMERIC(10,2),0) AS DELEVERED_QTY,
  CONVERT(NUMERIC(10,2),0) AS ISSUE_QTY,
  B.QUANTITY AS BO_QTY
  INTO #TMPALLOCATION   
  FROM BUYER_ORDER_DET B     
  JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID  AND M.CANCELLED=0   
  RIGHT OUTER JOIN    
  (    
	  SELECT B.WOD_ROW_ID,D.ORDER_ID AS ORDER_ID,A.MEMO_ID,
	         B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,
			 C.PRODUCT_CODE ,D.QUANTITY_IN_STOCK,ISNULL(D.JOB_CODE,'') AS JOB_CODE,
			 CONVERT(NUMERIC(10,0),1) AS WO_QTY
	  FROM ORD_PLAN_MST A
	  JOIN ORD_PLAN_DET B ON A.MEMO_ID =B.MEMO_ID 
	  JOIN ORD_PLAN_BARCODE_DET C ON B.ROW_ID =C.REFROW_ID 
	  JOIN JOBWORK_PMT D ON C.PRODUCT_CODE =D.PRODUCT_CODE 
	  WHERE A.CANCELLED =0
	  
  ) PMT ON PMT.WOD_ROW_ID=B.ROW_ID  
   LEFT OUTER JOIN BUYER_ORDER_MST BM1 ON  BM1.ORDER_ID=ISNULL(PMT.ORDER_ID,'')
  WHERE 1=2    
      
     
  SET @DTSQL=N' SELECT  ISNULL(M.AC_CODE,PMT.AC_CODE ) AS AC_CODE,
  ISNULL(PMT.ORDER_ID ,B.ORDER_ID) AS ORDER_ID,PMT.MEMO_ID AS MEMO_ID ,  
  PMT.ARTICLE_CODE,PMT.PARA1_CODE,PMT.PARA2_CODE,PMT.PRODUCT_CODE AS PRODUCT_CODE,  
  PMT.QUANTITY_IN_STOCK AS QUANTITY_IN_STOCK,  
  PMT.JOB_CODE AS JOB_CODE  ,ISNULL(PMT.WO_QTY,0) AS   QTY,
  ISNULL(BM1.ORDER_NO ,M.ORDER_NO) AS ORDER_NO, ISNULL(BM1.ORDER_DT ,M.ORDER_DT) AS ORDER_DT,    
  ISNULL(BM1.DELIVERY_DT ,M.DELIVERY_DT) AS DELIVERY_DT,
  DATEDIFF(DAY,ISNULL(BM1.DELIVERY_DT ,M.DELIVERY_DT),GETDATE()) AS DTD,
  CASE WHEN ISNULL(PMT.QUANTITY_IN_STOCK,0)>0 AND ISNULL(PMT.JOB_CODE,'''')<>'''' THEN ISNULL(PMT.QUANTITY_IN_STOCK,0)
  ELSE 0 END AS WIP_STOCK,
  CASE WHEN ISNULL(PMT.JOB_CODE,'''')='''' THEN ISNULL(PMT.WO_QTY,0) ELSE 0 END AS WO_QTY,
  B.QUANTITY AS BO_QTY
  FROM BUYER_ORDER_DET B     
  JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID  AND M.CANCELLED=0   
  RIGHT OUTER JOIN    
  (    
	  SELECT A.AC_CODE, ISNULL(B.WOD_ROW_ID,'''') AS WOD_ROW_ID,ISNULL(D.ORDER_ID,DET.ORDER_ID) AS ORDER_ID,A.MEMO_ID,
	         B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,
			 C.PRODUCT_CODE ,D.QUANTITY_IN_STOCK,ISNULL(D.JOB_CODE,'''') AS JOB_CODE,
			 CONVERT(NUMERIC(10,0),1) AS WO_QTY
	  FROM ORD_PLAN_MST A
	  JOIN ORD_PLAN_DET B ON A.MEMO_ID =B.MEMO_ID 
	  JOIN ORD_PLAN_BARCODE_DET C ON B.ROW_ID =C.REFROW_ID 
	  JOIN JOBWORK_PMT D ON C.PRODUCT_CODE =D.PRODUCT_CODE 
	  LEFT OUTER JOIN BUYER_ORDER_DET DET ON DET.ROW_ID=B.WOD_ROW_ID
	  WHERE A.CANCELLED =0
	  
  ) PMT ON PMT.WOD_ROW_ID=B.ROW_ID  
  LEFT OUTER JOIN BUYER_ORDER_MST BM1 ON  BM1.ORDER_ID=ISNULL(PMT.ORDER_ID,'''')
  WHERE ISNULL(WO_QTY,0)>0
  AND ('''+RTRIM(LTRIM(@CART_STATUS))+'''='''' OR PMT.ARTICLE_CODE '+@CARTICLE_CODE+')  
  AND ('''+RTRIM(LTRIM(@AAC_STATUS))+'''='''' OR PMT.AC_CODE '+@CAC_CODE+') 
  AND ('''+RTRIM(LTRIM(@CAC_CODE_NOTIN))+'''='''' OR PMT.AC_CODE<>'''+@CAC_CODE_NOTIN+''')'    
  
 -- AND M.ORDER_DT<='''+CONVERT(VARCHAR(11),@DASON,120)+'''
 
  PRINT @DTSQL   
  INSERT INTO #TMPALLOCATION(AC_CODE,ORDER_ID,MEMO_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,PRODUCT_CODE,
  QUANTITY_IN_STOCK,JOB_CODE,QTY,ORDER_NO,ORDER_DT,DELIVERY_DT,DTD,WIP_STOCK,WO_QTY,BO_QTY)
  EXEC SP_EXECUTESQL @DTSQL    
  --AND M.ORDER_DT<='''+CONVERT(VARCHAR(11),@DASON,120)+''' 
      
    --SELECT * FROM #TMPALLOCATION WHERE MEMO_ID='JM0111900000JM00000014'
    --RETURN
     
     UPDATE A SET DELEVERED_QTY =B.QUANTITY  
     FROM 
     #TMPALLOCATION A
     JOIN
     (
   
     SELECT A.PRODUCT_CODE ,A.QUANTITY 
     FROM IND01106 A (NOLOCK)
     JOIN INM01106  B (NOLOCK) ON A.INV_ID =B.INV_ID 
     JOIN #TMPALLOCATION TMP ON TMP.PRODUCT_CODE =A.PRODUCT_CODE 
     WHERE  B.CANCELLED =0
     UNION 
     SELECT A.PRODUCT_CODE ,A.QUANTITY 
     FROM WPS_DET  A (NOLOCK)
     JOIN WPS_MST  B (NOLOCK) ON A.PS_ID  =B.PS_ID 
     JOIN #TMPALLOCATION TMP ON TMP.PRODUCT_CODE =A.PRODUCT_CODE 
     WHERE  B.CANCELLED =0
     ) B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
     
      UPDATE A SET PMT_STOCK  =B.QUANTITY_IN_STOCK  FROM #TMPALLOCATION A
      JOIN PMT01106 B ON A.PRODUCT_CODE =B.PRODUCT_CODE 
      WHERE B.QUANTITY_IN_STOCK >0
 
  --DELIVERED QTY
  
  UPDATE A SET ISSUE_QTY =1
  FROM #TMPALLOCATION A  
 LEFT  JOIN  
 (  
  SELECT PRODUCT_CODE  AS PRODUCT_CODE FROM TRANSFER_TO_TRADING_DET   A  
  JOIN TRANSFER_TO_TRADING_MST  B ON A.MEMO_ID =B.MEMO_ID   
  WHERE B.CANCELLED =0  
 ) B ON A.PRODUCT_CODE=B.PRODUCT_CODE   
 WHERE B.PRODUCT_CODE IS NULL AND  ISNULL(A.JOB_CODE ,'')='' AND ISNULL(QUANTITY_IN_STOCK,0) =0
  
  
 -- --display for jobwork issue
  UPDATE A SET QUANTITY_IN_STOCK  =1
  FROM #TMPALLOCATION A  
 LEFT  JOIN  
 (  
  SELECT PRODUCT_CODE  AS PRODUCT_CODE FROM TRANSFER_TO_TRADING_DET   A  
  JOIN TRANSFER_TO_TRADING_MST  B ON A.MEMO_ID =B.MEMO_ID   
  WHERE B.CANCELLED =0  
 ) B ON A.PRODUCT_CODE=B.PRODUCT_CODE   
 WHERE B.PRODUCT_CODE IS NULL AND  ISNULL(A.JOB_CODE ,'')<>'' AND ISNULL(QUANTITY_IN_STOCK,0) =0
  
  
  
  
 -- DELETE A FROM #TMPALLOCATION A  
 -- JOIN  
 --(  
 -- SELECT PRODUCT_CODE  AS PRODUCT_CODE FROM TRANSFER_TO_TRADING_DET   A  
 -- JOIN TRANSFER_TO_TRADING_MST  B ON A.MEMO_ID =B.MEMO_ID   
 -- WHERE B.CANCELLED =0  
 --) B ON A.PRODUCT_CODE=B.PRODUCT_CODE   
 
  
    IF OBJECT_ID ('TEMPDB..#TMPWO','U') IS NOT NULL
       DROP TABLE #TMPWO
    
    SELECT A.AC_CODE ,A.ORDER_NO,A.ORDER_DT,A.DELIVERY_DT,A.DTD,
           SUM(A.QTY) AS QTY,
           ISNULL(A.ORDER_ID,'') AS ORDER_ID,
           A.MEMO_ID, A.ARTICLE_CODE,A.PARA1_CODE ,A.PARA2_CODE ,
           (ISNULL(BO_QTY,0)) AS BO_QTY,
           ISNULL(A.JOB_CODE,'PENDING') AS JOB_CODE ,
           ISNULL(JOBS.JOB_NAME,'') AS ORG_JOB_NAME,
           CASE WHEN ISNULL(WIP_STOCK,0)>0 AND ISNULL(JOBS.JOB_NAME,'')<>''
           THEN 'WIP_'+ISNULL(JOBS.JOB_NAME,'')
           ELSE ISNULL(JOBS.JOB_NAME,'PENDING') END AS JOB_NAME,
           SUM(CONVERT(NUMERIC(10,2),ISNULL(WO_QTY,0))) AS  WO_QTY,
           SUM(CONVERT(NUMERIC(10,2),ISNULL(WIP_STOCK,0))) AS WIP_STOCK,
           SUM(CONVERT(NUMERIC(10,2),ISNULL(PMT_STOCK,0))) AS QUANTITY_IN_STOCK,
           SUM(CONVERT(NUMERIC(10,2),ISNULL(DELEVERED_QTY,0))) AS DELEVERED_QTY,
           SUM(ISNULL(QUANTITY_IN_STOCK,0)) AS ISSUE_QTY,
           DENSE_RANK() OVER (ORDER BY ISNULL(JOBS.JOB_NAME,'')) AS JOB_SR
    INTO #TMPWO
    FROM #TMPALLOCATION A
    LEFT JOIN JOBS ON A.JOB_CODE =JOBS.JOB_CODE
    GROUP BY ISNULL(A.ORDER_ID,'') ,A.AC_CODE ,A.ORDER_NO,A.ORDER_DT,A.DELIVERY_DT,A.DTD,
     A.ARTICLE_CODE,A.MEMO_ID ,A.PARA1_CODE ,A.PARA2_CODE ,
     ISNULL(A.JOB_CODE,'PENDING') ,
      CASE WHEN ISNULL(WIP_STOCK,0)>0 AND ISNULL(JOBS.JOB_NAME,'')<>''
           THEN 'WIP_'+ISNULL(JOBS.JOB_NAME,'')
           ELSE ISNULL(JOBS.JOB_NAME,'PENDING') END,ISNULL(JOBS.JOB_NAME,''),(ISNULL(BO_QTY,0))
  
  UPDATE #TMPWO SET JOB_SR =99 WHERE JOB_NAME ='PENDING'
  
  UPDATE #TMPWO SET BO_QTY=QTY WHERE ISNULL(BO_QTY,0)=0
  
  SELECT CAST('' AS VARCHAR(100)) AS MERCHANT,
         A.ARTICLE_CODE,ART.ARTICLE_NO,
         P1.PARA1_NAME ,P2.PARA2_NAME ,
         LM.AC_CODE , LM.AC_NAME ,
         ISNULL(A.ORDER_ID,'') AS ORDER_ID,
         ISNULL(A.ORDER_NO,'') AS ORDER_NO,
         ISNULL(A.ORDER_DT,'') AS ORDER_DT,
         ISNULL(A.DELIVERY_DT,'') AS DELIVERY_DT,
         ISNULL(A.DTD,0) AS DTD,
         A.BO_QTY,
         '' AS SALE_EMP_CODE,
         '' AS EMP_NAME,
         A.QTY,
         A.QUANTITY_IN_STOCK,
         A.DELEVERED_QTY AS DLVRD,
         A.QUANTITY_IN_STOCK,
         0 AS TYPE,
         A.MEMO_ID,
         A.WO_QTY,
         ISNULL(MST.REF_NO,'') AS REF_NO ,
         ORD.MEMO_NO AS WO_NO,
         ORD.MEMO_DT AS  WO_DT,
         ISNULL(A.QTY,0)-ISNULL(A.DELEVERED_QTY,0) AS PENDING,
         A.JOB_NAME,
         A.JOB_CODE,
         ISNULL(A.ISSUE_QTY,0) AS ISSUE_QTY,
         A.JOB_SR
  FROM #TMPWO A
  JOIN ARTICLE ART (NOLOCK) ON A.ARTICLE_CODE=ART.ARTICLE_CODE 
  JOIN PARA1 P1 ON P1.PARA1_CODE =A.PARA1_CODE
  JOIN PARA2 P2 ON P2.PARA2_CODE =A.PARA2_CODE
  JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE
  JOIN ORD_PLAN_MST ORD ON ORD.MEMO_ID =A.MEMO_ID
  LEFT OUTER JOIN BUYER_ORDER_MST MST ON MST.ORDER_ID =A.ORDER_ID
  UNION ALL
  SELECT CAST('' AS VARCHAR(100)) AS MERCHANT,
         A.ARTICLE_CODE,ART.ARTICLE_NO,
         P1.PARA1_NAME ,P2.PARA2_NAME ,
         LM.AC_CODE , LM.AC_NAME ,
         ISNULL(A.ORDER_ID,'') AS ORDER_ID,
         ISNULL(A.ORDER_NO,'') AS ORDER_NO,
         ISNULL(A.ORDER_DT,'') AS ORDER_DT,
         ISNULL(A.DELIVERY_DT,'') AS DELIVERY_DT,
         ISNULL(A.DTD,0) AS DTD,
         A.BO_QTY,
         '' AS SALE_EMP_CODE,
         '' AS EMP_NAME,
         A.QTY,
         A.QUANTITY_IN_STOCK,
         A.DELEVERED_QTY AS DLVRD,
         A.QUANTITY_IN_STOCK,
         0 AS TYPE,
         A.MEMO_ID,
         A.WO_QTY,
         ISNULL(MST.REF_NO,'') AS REF_NO ,
         ORD.MEMO_NO AS WO_NO,
         ORD.MEMO_DT AS  WO_DT,
         ISNULL(A.QTY,0)-ISNULL(A.DELEVERED_QTY,0) AS PENDING,
         'DLVRD' AS JOB_NAME,
         A.JOB_CODE,
         ISNULL(A.DELEVERED_QTY,0) AS ISSUE_QTY,
         100 AS JOB_SR
  FROM #TMPWO A
  JOIN ARTICLE ART (NOLOCK) ON A.ARTICLE_CODE=ART.ARTICLE_CODE 
  JOIN PARA1 P1 ON P1.PARA1_CODE =A.PARA1_CODE
  JOIN PARA2 P2 ON P2.PARA2_CODE =A.PARA2_CODE
  JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE
  JOIN ORD_PLAN_MST ORD ON ORD.MEMO_ID =A.MEMO_ID
  LEFT OUTER JOIN BUYER_ORDER_MST MST ON MST.ORDER_ID =A.ORDER_ID
  WHERE A.DELEVERED_QTY>0
   UNION ALL
  SELECT CAST('' AS VARCHAR(100)) AS MERCHANT,
         A.ARTICLE_CODE,ART.ARTICLE_NO,
         P1.PARA1_NAME ,P2.PARA2_NAME ,
         LM.AC_CODE , LM.AC_NAME ,
         ISNULL(A.ORDER_ID,'') AS ORDER_ID,
         ISNULL(A.ORDER_NO,'') AS ORDER_NO,
         ISNULL(A.ORDER_DT,'') AS ORDER_DT,
         ISNULL(A.DELIVERY_DT,'') AS DELIVERY_DT,
         ISNULL(A.DTD,0) AS DTD,
         A.BO_QTY,
         '' AS SALE_EMP_CODE,
         '' AS EMP_NAME,
         A.QTY,
         A.QUANTITY_IN_STOCK,
         A.DELEVERED_QTY AS DLVRD,
         A.QUANTITY_IN_STOCK,
         0 AS TYPE,
         A.MEMO_ID,
         A.WO_QTY,
         ISNULL(MST.REF_NO,'') AS REF_NO ,
         ORD.MEMO_NO AS WO_NO,
         ORD.MEMO_DT AS  WO_DT,
         ISNULL(A.QTY,0)-ISNULL(A.DELEVERED_QTY,0) AS PENDING,
         'STOCK_QTY' AS JOB_NAME,
         A.JOB_CODE,
         ISNULL(A.QUANTITY_IN_STOCK,0) AS ISSUE_QTY,
         101 AS JOB_SR
  FROM #TMPWO A
  JOIN ARTICLE ART (NOLOCK) ON A.ARTICLE_CODE=ART.ARTICLE_CODE 
  JOIN PARA1 P1 ON P1.PARA1_CODE =A.PARA1_CODE
  JOIN PARA2 P2 ON P2.PARA2_CODE =A.PARA2_CODE
  JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE
  JOIN ORD_PLAN_MST ORD ON ORD.MEMO_ID =A.MEMO_ID
  LEFT OUTER JOIN BUYER_ORDER_MST MST ON MST.ORDER_ID =A.ORDER_ID
  WHERE A.QUANTITY_IN_STOCK>0
 UNION ALL
 SELECT CAST('' AS VARCHAR(100)) AS MERCHANT,
         '' AS ARTICLE_CODE,'' AS ARTICLE_NO,
         '' AS PARA1_NAME ,'' AS PARA2_NAME ,
         '' AC_CODE , '' AC_NAME ,
         '' AS ORDER_ID,
         '' AS ORDER_NO,
         '' AS ORDER_DT,
         '' AS DELIVERY_DT,
         '' AS DTD,
         0  BO_QTY,
         '' AS SALE_EMP_CODE,
         '' AS EMP_NAME,
         0 AS QTY,
         0 AS QUANTITY_IN_STOCK,
          0 AS  DLVRD,
         0 AS QUANTITY_IN_STOCK,
         0 AS TYPE,
         '' AS MEMO_ID,
         0 AS WO_QTY,
         ''  AS REF_NO ,
         '' AS WO_NO,
         '' AS  WO_DT,
         0 AS PENDING,
         A.ORG_JOB_NAME JOB_NAME,
         '' JOB_CODE,
         0  ISSUE_QTY,
         A.JOB_SR AS JOB_SR 
 FROM 
 (
 SELECT DISTINCT ORG_JOB_NAME ,JOB_SR
 FROM #TMPWO A
 WHERE ORG_JOB_NAME<>''
 UNION ALL
 SELECT DISTINCT 'WIP_'+ORG_JOB_NAME ,JOB_SR
 FROM #TMPWO A
 WHERE ORG_JOB_NAME<>''
  ) A
  LEFT JOIN #TMPWO B ON A.ORG_JOB_NAME=B.JOB_NAME 
  WHERE B.JOB_NAME IS NULL
 ORDER BY A.MEMO_ID ,ART.ARTICLE_NO ,P1.PARA1_NAME ,P2.PARA2_NAME  
    --SELECT * INTO TMPWO   FROM #TMPWO
    --RETURN
     
     --DROP TABLE TMPWO
--SP3S_PRODUCTION_STATUS_REPORT


END
