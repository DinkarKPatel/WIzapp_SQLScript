CREATE PROCEDURE DBKPI_SALE_CHART(@SetupID varchar(100),@DT VARCHAR(10),@SortingID int=0)  
AS  
BEGIN  
SET NOCOUNT ON  
IF @SortingID NOT IN (0,1,2,3) RETURN
IF OBJECT_ID('tempdb..#TMP') IS NOT NULL DROP TABLE #TMP  
/*  
CREATE NONCLUSTERED INDEX IX_IDNDT_pos_dynamic_dbdata
ON [dbo].[pos_dynamic_dbdata] ([setup_id],[db_dt])
INCLUDE ([kpi_name],[cy_mtd_value],[cy_ytd_value],[ly_mtd_value],[ly_ytd_value],[para_name],[rank_no])
*/  
DECLARE @CCMD VARCHAR(MAX)

--16 Oct 2019: Handling NO Data in POS_DYNAMIC_DBDATA_SUMMARY
IF NOT EXISTS(SELECT TOP 1 * FROM POS_DYNAMIC_DBDATA_SUMMARY (NOLOCK) WHERE setup_id=@SetupID AND db_dt=@DT)
   BEGIN
		PRINT 'Data Prepared for Summary'
		INSERT POS_DYNAMIC_DBDATA_SUMMARY(KPI_NAME,setup_id,db_dt,min_value,max_value,avg_value,TOTAL_VALUE,total_records)
		SELECT KPI_NAME,setup_id,db_dt,min(ytd_value)mn,max(ytd_value)mx,avg(ytd_value)av,sum(ytd_value)tt,COUNT(*)
		FROM POS_DYNAMIC_DBDATA (NOLOCK)
		WHERE Setup_ID=@SetupID AND db_dt=@DT and KPI_NAME IN ('Sale','PROFIT AMOUNT','GMROI')
		GROUP BY KPI_NAME,setup_id,db_dt
   END
--16 Oct 2019: Handling NO Data in POS_DYNAMIC_DBDATA_SUMMARY

SELECT DISTINCT D.SETUP_ID,D.PARA_NAME
,(SELECT T.MIN_VALUE FROM POS_DYNAMIC_DBDATA_SUMMARY T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.KPI_NAME='Sale' and DB_DT=@DT)MIN_VAL_NRV
,(SELECT T.MAX_VALUE FROM POS_DYNAMIC_DBDATA_SUMMARY T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.KPI_NAME='Sale' and DB_DT=@DT)MAX_VAL_NRV
,(SELECT T.AVG_VALUE FROM POS_DYNAMIC_DBDATA_SUMMARY T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.KPI_NAME='Sale' and DB_DT=@DT)AVG_VAL_NRV
,(SELECT T.ytd_value FROM POS_DYNAMIC_DBDATA T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.DB_DT=@DT AND T.KPI_NAME='Sale' AND T.PARA_NAME=D.PARA_NAME)ACTUAL_VALUE_NRV
,5 SZN_NRV,0 SZG_NRV,20 SZX_NRV,0 SZA_NRV
--
,(SELECT T.MIN_VALUE FROM POS_DYNAMIC_DBDATA_SUMMARY T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.KPI_NAME='PROFIT AMOUNT' and DB_DT=@DT )MIN_VAL_PROFIT
,(SELECT T.MAX_VALUE FROM POS_DYNAMIC_DBDATA_SUMMARY T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.KPI_NAME='PROFIT AMOUNT' and DB_DT=@DT )MAX_VAL_PROFIT
,(SELECT T.AVG_VALUE FROM POS_DYNAMIC_DBDATA_SUMMARY T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.KPI_NAME='PROFIT AMOUNT' and DB_DT=@DT )AVG_VAL_PROFIT
,(SELECT T.ytd_value FROM POS_DYNAMIC_DBDATA T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.DB_DT=@DT AND T.KPI_NAME='PROFIT AMOUNT' AND T.PARA_NAME=D.PARA_NAME)ACTUAL_VALUE_PROFIT
,5 SZN_PROFIT,0 SZG_PROFIT,20 SZX_PROFIT,0 SZA_PROFIT
--
,(SELECT T.MIN_VALUE FROM POS_DYNAMIC_DBDATA_SUMMARY T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.KPI_NAME='GMROI' and DB_DT=@DT )MIN_VAL_GMROI
,(SELECT T.MAX_VALUE FROM POS_DYNAMIC_DBDATA_SUMMARY T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.KPI_NAME='GMROI' and DB_DT=@DT )MAX_VAL_GMROI
,(SELECT T.AVG_VALUE FROM POS_DYNAMIC_DBDATA_SUMMARY T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.KPI_NAME='GMROI' and DB_DT=@DT )AVG_VAL_GMROI
,(SELECT T.ytd_value FROM POS_DYNAMIC_DBDATA T (NOLOCK) WHERE T.setup_id=D.setup_id AND T.DB_DT=@DT AND T.KPI_NAME='GMROI' AND T.PARA_NAME=D.PARA_NAME)ACTUAL_VALUE_GMROI
,5 SZN_GMROI,0 SZG_GMROI,20 SZX_GMROI,0 SZA_GMROI
,CAST(0 AS INT)SortingNo
INTO #TMP
FROM POS_DYNAMIC_DBDATA D (NOLOCK)
LEFT JOIN POS_DYNAMIC_DBDATA_SUMMARY S (NOLOCK) ON D.setup_id=S.setup_id AND S.KPI_NAME=D.KPI_NAME
WHERE D.setup_id=@SetupID AND D.db_dt=@DT
ORDER BY D.para_name

UPDATE #TMP SET 
 ACTUAL_VALUE_NRV=ISNULL(ACTUAL_VALUE_NRV,0),ACTUAL_VALUE_PROFIT=ISNULL(ACTUAL_VALUE_PROFIT,0),ACTUAL_VALUE_GMROI=ISNULL(ACTUAL_VALUE_GMROI,0)
,MIN_VAL_NRV=ISNULL(MIN_VAL_NRV,0),MAX_VAL_NRV=ISNULL(MAX_VAL_NRV,0),AVG_VAL_NRV=ISNULL(AVG_VAL_NRV,0)
,MIN_VAL_PROFIT=ISNULL(MIN_VAL_PROFIT,0),MAX_VAL_PROFIT=ISNULL(MAX_VAL_PROFIT,0),AVG_VAL_PROFIT=ISNULL(AVG_VAL_PROFIT,0)
,MIN_VAL_GMROI=ISNULL(MIN_VAL_GMROI,0),MAX_VAL_GMROI=ISNULL(MAX_VAL_GMROI,0),AVG_VAL_GMROI=ISNULL(AVG_VAL_GMROI,0)
,SZN_NRV=ISNULL(SZN_NRV,0),SZG_NRV=ISNULL(SZG_NRV,0),SZX_NRV=ISNULL(SZX_NRV,0),SZA_NRV=ISNULL(SZA_NRV,0)
,SZN_PROFIT=ISNULL(SZN_PROFIT,0),SZG_PROFIT=ISNULL(SZG_PROFIT,0),SZX_PROFIT=ISNULL(SZX_PROFIT,0),SZA_PROFIT=ISNULL(SZA_PROFIT,0)
,SZN_GMROI=ISNULL(SZN_GMROI,0),SZG_GMROI=ISNULL(SZG_GMROI,0),SZX_GMROI=ISNULL(SZX_GMROI,0),SZA_GMROI=ISNULL(SZA_GMROI,0)

--Sorting Done here
SET @CCMD=';WITH CTE AS(SELECT *,R=ROW_NUMBER()OVER(ORDER BY '+CASE @SortingID WHEN 0 THEN '' WHEN 1 THEN 'ACTUAL_VALUE_NRV' WHEN 2 THEN 'ACTUAL_VALUE_PROFIT' WHEN 3 THEN 'ACTUAL_VALUE_GMROI' END+' DESC,PARA_NAME) FROM #TMP)
   UPDATE T SET SortingNo=C.R FROM #TMP T JOIN CTE C ON T.para_name=C.para_name'
PRINT @CCMD   
IF @SortingID<>0 EXEC(@CCMD)

--AVERAGE
UPDATE #TMP SET 

	   SZG_NRV   =CASE	WHEN ISNULL(AVG_VAL_NRV,0)=0 THEN 0
						WHEN AVG_VAL_NRV=MIN_VAL_NRV THEN ISNULL(SZN_NRV,0)
						WHEN AVG_VAL_NRV>MIN_VAL_NRV AND AVG_VAL_NRV<MAX_VAL_NRV THEN ROUND((ISNULL(SZN_NRV,0)+ISNULL(SZX_NRV,0))/2,0)  
						WHEN AVG_VAL_NRV=MAX_VAL_NRV THEN ISNULL(SZX_NRV,0)  
				  END  

	  ,SZG_PROFIT=CASE	WHEN ISNULL(AVG_VAL_PROFIT,0)=0 THEN 0
						WHEN AVG_VAL_PROFIT=MIN_VAL_PROFIT THEN ISNULL(SZN_PROFIT,0) 
						WHEN AVG_VAL_PROFIT>MIN_VAL_PROFIT AND AVG_VAL_PROFIT<MAX_VAL_PROFIT THEN ROUND((ISNULL(SZN_PROFIT,0)+ISNULL(SZX_PROFIT,0))/2,0)  
						WHEN AVG_VAL_PROFIT=MAX_VAL_PROFIT THEN ISNULL(SZX_PROFIT,0)  
				  END  

      ,SZG_GMROI =CASE	WHEN ISNULL(AVG_VAL_GMROI,0)=0 THEN 0
						WHEN AVG_VAL_GMROI=MIN_VAL_GMROI THEN ISNULL(SZN_GMROI,0)  
						WHEN AVG_VAL_GMROI>MIN_VAL_GMROI AND AVG_VAL_GMROI<MAX_VAL_GMROI THEN ROUND((ISNULL(SZN_GMROI,0)+ISNULL(SZX_GMROI,0))/2,0)  
						WHEN AVG_VAL_GMROI=MAX_VAL_GMROI THEN ISNULL(SZX_GMROI,0)  
				  END  
				  
--ACTUAL
UPDATE #TMP SET 
	   
	   SZA_NRV   =CASE	WHEN ISNULL(ACTUAL_VALUE_NRV,0)=0 THEN 0
						WHEN ACTUAL_VALUE_NRV>=MAX_VAL_NRV THEN ISNULL(SZX_NRV,0)  
						WHEN ACTUAL_VALUE_NRV BETWEEN AVG_VAL_NRV AND MAX_VAL_NRV THEN ROUND((ISNULL(SZG_NRV,0)+ISNULL(SZX_NRV,0))/2,0)  
						WHEN ACTUAL_VALUE_NRV BETWEEN MIN_VAL_NRV AND AVG_VAL_NRV THEN ROUND((ISNULL(SZN_NRV,0)+ISNULL(SZG_NRV,0))/2,0)  
						WHEN ACTUAL_VALUE_NRV<MIN_VAL_NRV THEN ISNULL(SZN_NRV,0)
				  END  
      
      ,SZA_PROFIT=CASE	WHEN ISNULL(ACTUAL_VALUE_PROFIT,0)=0 THEN 0
						WHEN ACTUAL_VALUE_PROFIT>=MAX_VAL_PROFIT THEN ISNULL(SZX_PROFIT,0)  
						WHEN ACTUAL_VALUE_PROFIT BETWEEN AVG_VAL_PROFIT AND MAX_VAL_PROFIT THEN ROUND((ISNULL(SZG_PROFIT,0)+ISNULL(SZX_PROFIT,0))/2,0)  
						WHEN ACTUAL_VALUE_PROFIT BETWEEN MIN_VAL_PROFIT AND AVG_VAL_PROFIT THEN ROUND((ISNULL(SZN_PROFIT,0)+ISNULL(SZG_PROFIT,0))/2,0)  
						WHEN ACTUAL_VALUE_PROFIT<MIN_VAL_PROFIT THEN ISNULL(SZN_PROFIT,0)  
				  END  
      ,SZA_GMROI =CASE	WHEN ISNULL(ACTUAL_VALUE_GMROI,0)=0 THEN 0
						WHEN ACTUAL_VALUE_GMROI>=MAX_VAL_GMROI THEN ISNULL(SZX_GMROI,0)  
      					WHEN ACTUAL_VALUE_GMROI BETWEEN AVG_VAL_GMROI AND MAX_VAL_GMROI THEN ROUND((ISNULL(SZG_GMROI,0)+ISNULL(SZX_GMROI,0))/2,0)  
						WHEN ACTUAL_VALUE_GMROI BETWEEN MIN_VAL_GMROI AND AVG_VAL_GMROI THEN ROUND((ISNULL(SZN_GMROI,0)+ISNULL(SZG_GMROI,0))/2,0)  
						WHEN ACTUAL_VALUE_GMROI<MIN_VAL_GMROI THEN ISNULL(SZN_GMROI,0)
				  END  
--
UPDATE #TMP SET SZN_NRV=0 WHERE ISNULL(MIN_VAL_NRV,0)=0
UPDATE #TMP SET SZX_NRV=0 WHERE ISNULL(MAX_VAL_NRV,0)=0
UPDATE #TMP SET SZG_NRV=0,SZA_NRV=0 WHERE SZN_NRV=0 AND SZX_NRV=0

UPDATE #TMP SET SZN_PROFIT=0 WHERE ISNULL(MIN_VAL_PROFIT,0)=0
UPDATE #TMP SET SZX_PROFIT=0 WHERE ISNULL(MAX_VAL_PROFIT,0)=0
UPDATE #TMP SET SZG_PROFIT=0,SZA_PROFIT=0 WHERE SZN_PROFIT=0 AND SZX_PROFIT=0

UPDATE #TMP SET SZN_GMROI=0 WHERE ISNULL(MIN_VAL_GMROI,0)=0
UPDATE #TMP SET SZX_GMROI=0 WHERE ISNULL(MAX_VAL_GMROI,0)=0
UPDATE #TMP SET SZG_GMROI=0,SZA_GMROI=0 WHERE SZN_GMROI=0 AND SZX_GMROI=0

UPDATE #TMP SET   
 MIN_VAL_NRV=ISNULL(MIN_VAL_NRV,0)  
,MAX_VAL_NRV=ISNULL(MAX_VAL_NRV,0)  
,AVG_VAL_NRV=ISNULL(AVG_VAL_NRV,0)  
,ACTUAL_VALUE_NRV=ISNULL(ACTUAL_VALUE_NRV,0)  
,SZN_NRV=ISNULL(SZN_NRV,0)  
,SZG_NRV=ISNULL(SZG_NRV,0)  
,SZX_NRV=ISNULL(SZX_NRV,0)  
,SZA_NRV=ISNULL(SZA_NRV,0)  
,MIN_VAL_PROFIT=ISNULL(MIN_VAL_PROFIT,0)  
,MAX_VAL_PROFIT=ISNULL(MAX_VAL_PROFIT,0)  
,AVG_VAL_PROFIT=ISNULL(AVG_VAL_PROFIT,0)  
,ACTUAL_VALUE_PROFIT=ISNULL(ACTUAL_VALUE_PROFIT,0)  
,SZN_PROFIT=ISNULL(SZN_PROFIT,0)  
,SZG_PROFIT=ISNULL(SZG_PROFIT,0)  
,SZX_PROFIT=ISNULL(SZX_PROFIT,0)  
,SZA_PROFIT=ISNULL(SZA_PROFIT,0)  
,MIN_VAL_GMROI=ISNULL(MIN_VAL_GMROI,0)  
,MAX_VAL_GMROI=ISNULL(MAX_VAL_GMROI,0)  
,AVG_VAL_GMROI=ISNULL(AVG_VAL_GMROI,0)  
,ACTUAL_VALUE_GMROI=ISNULL(ACTUAL_VALUE_GMROI,0)  
,SZN_GMROI=ISNULL(SZN_GMROI,0)  
,SZG_GMROI=ISNULL(SZG_GMROI,0)  
,SZX_GMROI=ISNULL(SZX_GMROI,0)  
,SZA_GMROI=ISNULL(SZA_GMROI,0)  
  
SELECT SETUP_ID,PARA_NAME
,MIN_VAL_NRV,MAX_VAL_NRV,AVG_VAL_NRV,ACTUAL_VALUE_NRV,SZN_NRV,SZG_NRV,SZX_NRV,SZA_NRV
,MIN_VAL_PROFIT,MAX_VAL_PROFIT,AVG_VAL_PROFIT,ACTUAL_VALUE_PROFIT,SZN_PROFIT,SZG_PROFIT,SZX_PROFIT,SZA_PROFIT
,MIN_VAL_GMROI,MAX_VAL_GMROI,AVG_VAL_GMROI,ACTUAL_VALUE_GMROI,SZN_GMROI,SZG_GMROI,SZX_GMROI,SZA_GMROI
,ISNULL((SELECT DBO.DBKPI_SLAB(0,0,D.YTD_VALUE,0) FROM POS_DYNAMIC_DBDATA D (NOLOCK) WHERE D.Setup_ID=@SetupID AND D.DB_DT=@DT AND D.PARA_NAME=T.PARA_NAME AND D.KPI_NAME='NRV_COLOR_CODE')   ,'#FFFFFF')CLR_NRV
,ISNULL((SELECT DBO.DBKPI_SLAB(0,0,D.YTD_VALUE,0) FROM POS_DYNAMIC_DBDATA D (NOLOCK) WHERE D.Setup_ID=@SetupID AND D.DB_DT=@DT AND D.PARA_NAME=T.PARA_NAME AND D.KPI_NAME='PROFIT_COLOR_CODE'),'#FFFFFF')CLR_PROFIT
,ISNULL((SELECT DBO.DBKPI_SLAB(0,0,D.YTD_VALUE,0) FROM POS_DYNAMIC_DBDATA D (NOLOCK) WHERE D.Setup_ID=@SetupID AND D.DB_DT=@DT AND D.PARA_NAME=T.PARA_NAME AND D.KPI_NAME='GMROI_COLOR_CODE') ,'#FFFFFF')CLR_GMROI
,ISNULL((SELECT DBO.DBKPI_SLAB(0,0,D.YTD_VALUE,1) FROM POS_DYNAMIC_DBDATA D (NOLOCK) WHERE D.Setup_ID=@SetupID AND D.DB_DT=@DT AND D.PARA_NAME=T.PARA_NAME AND D.KPI_NAME='NRV_COLOR_CODE')   ,'WHITE'  )COLOR_NRV
,ISNULL((SELECT DBO.DBKPI_SLAB(0,0,D.YTD_VALUE,1) FROM POS_DYNAMIC_DBDATA D (NOLOCK) WHERE D.Setup_ID=@SetupID AND D.DB_DT=@DT AND D.PARA_NAME=T.PARA_NAME AND D.KPI_NAME='PROFIT_COLOR_CODE'),'WHITE'  )COLOR_PROFIT
,ISNULL((SELECT DBO.DBKPI_SLAB(0,0,D.YTD_VALUE,1) FROM POS_DYNAMIC_DBDATA D (NOLOCK) WHERE D.Setup_ID=@SetupID AND D.DB_DT=@DT AND D.PARA_NAME=T.PARA_NAME AND D.KPI_NAME='GMROI_COLOR_CODE') ,'WHITE'  )COLOR_GMROI
FROM #TMP T  
ORDER BY SortingNo
SET NOCOUNT OFF  
END