CREATE PROCEDURE SP3S_PENDING_PICKLIST
(
	 @DFROMDATE DATETIME	  /*PICKLIST CONSIDERATION FROM DATE */
	,@DTODATE DATETIME		  /*PICKLIST TO BE CONSIDERED TILL DATE*/
	,@CAC_CODE VARCHAR(10)='' /*GET DETAILS FOR A SINGLE CUSTOMER OR ALL CUSTOMER*/
	,@CARTICLE_CODE VARCHAR(10)='' /*GET DETAILS FOR AN ARTICLE OR ALL ARTICLES*/
	,@BSUMMARY BIT=0		  /*GET SUMMARY REPORT (1) OR DETAIL REPORT (0)*/
)
--WITH ENCRYPTION
AS
BEGIN
	IF OBJECT_ID('TEMPDB..#WSLORDERS','U') IS NOT NULL
		DROP TABLE #WSLORDERS

	---GETTING WHOLESALE ORDER DETAILS AND ITS CORRESPONDING PICLLIST DETAILS
	SELECT BOM.AC_CODE,BOM.ORDER_NO,BOM.ORDER_DT,BOD.ARTICLE_CODE,BOD.PARA1_CODE,BOD.PARA2_CODE
		  ,CAST(BOD.QUANTITY AS NUMERIC(18,2)) AS ORDER_QTY,CAST(ISNULL(PKL.PICK_LIST_QTY,0) AS NUMERIC(18,2)) AS PICK_LIST_QTY
		  ,CAST(ISNULL(PKL.PICK_LIST_ADD_QTY,0) AS NUMERIC(18,2)) AS PICK_LIST_ADD_QTY
		  ,CAST((BOD.QUANTITY-ISNULL(PKL.PICK_LIST_QTY,0)) AS NUMERIC(18,2)) AS PENDING_PICK_LIST_QTY
		  ,PL_NO,PL_DT,DELIVERY_DT 
	INTO #WSLORDERS	  
	FROM BUYER_ORDER_MST BOM(NOLOCK)
	JOIN BUYER_ORDER_DET BOD(NOLOCK) ON BOM.ORDER_ID=BOD.ORDER_ID
	LEFT JOIN 
	(
		SELECT AC_CODE,ORDER_ID,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,SUM(A.PICK_LIST_QTY) AS PICK_LIST_QTY 
			   ,SUM(ISNULL(A.ADD_QTY,0)) AS PICK_LIST_ADD_QTY
			   ,PICK_LIST_NO AS PL_NO,PICK_LIST_DT AS PL_DT
		FROM WSL_PICKLIST_DET A (NOLOCK)
		JOIN WSL_PICKLIST_MST B (NOLOCK) ON A.PICK_LIST_ID = B.PICK_LIST_ID
		WHERE B.CANCELLED=0 AND (@CAC_CODE='' OR B.AC_CODE=@CAC_CODE)
		GROUP BY AC_CODE,ARTICLE_CODE,PARA1_CODE,PARA2_CODE,ORDER_ID
		         ,PICK_LIST_NO ,PICK_LIST_DT 
	)PKL ON PKL.AC_CODE=BOM.AC_CODE AND PKL.ARTICLE_CODE = BOD.ARTICLE_CODE AND PKL.PARA1_CODE = BOD.PARA1_CODE 
			AND PKL.PARA2_CODE = BOD.PARA2_CODE AND PKL.ORDER_ID   = BOD.ORDER_ID
	WHERE BOM.CANCELLED=0 AND BOM.MEMO_TYPE=2 AND (@CAC_CODE='' OR BOM.AC_CODE=@CAC_CODE)
	AND (@CARTICLE_CODE='' OR BOD.ARTICLE_CODE=@CARTICLE_CODE)
	AND BOM.ORDER_DT BETWEEN @DFROMDATE AND @DTODATE
	
	IF @BSUMMARY=0
	BEGIN
		--GET THE DETAILED REPORT
		SELECT LM.AC_NAME AS CUSTOMER_NAME,A.ORDER_NO,CONVERT(VARCHAR(10),A.ORDER_DT,105) AS ORDER_DT,ART.ARTICLE_NO,P1.PARA1_NAME AS COLOR
			  ,P2.PARA2_NAME AS SIZE,A.ORDER_QTY,A.PICK_LIST_QTY,A.PICK_LIST_ADD_QTY,
			  CAST(ISNULL(A.PICK_LIST_QTY,0)+ISNULL(A.PICK_LIST_ADD_QTY,0) AS NUMERIC(18,2)) AS PICK_LIST_TOTAL_QTY,
			  A.PENDING_PICK_LIST_QTY,
			  ISNULL(PL_NO,'') AS PL_NO
			  ,CASE WHEN PL_DT IS NULL THEN '' ELSE CONVERT(VARCHAR,PL_DT ,105) END  AS PL_DT 
			  ,CONVERT(VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT
		FROM #WSLORDERS A
		JOIN ARTICLE ART (NOLOCK) ON A.ARTICLE_CODE=ART.ARTICLE_CODE
		JOIN PARA1 P1(NOLOCK) ON A.PARA1_CODE=P1.PARA1_CODE
		JOIN PARA2 P2(NOLOCK) ON A.PARA2_CODE=P2.PARA2_CODE
		JOIN LM01106 LM(NOLOCK) ON A.AC_CODE=LM.AC_CODE
		WHERE PENDING_PICK_LIST_QTY>0
		ORDER BY CUSTOMER_NAME,ORDER_DT,ORDER_NO,ARTICLE_NO,COLOR,SIZE
	END
	
	--DROPPING TEMP TABLE AFTER RETURNING THE RESULTSET
	IF OBJECT_ID('TEMPDB..#WSLORDERS','U') IS NOT NULL
		DROP TABLE #WSLORDERS
END
--END OF PROCEDURE - SP3S_PENDING_PICKLIST
