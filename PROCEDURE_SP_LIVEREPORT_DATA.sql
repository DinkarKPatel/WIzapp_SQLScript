create PROCEDURE SP_LIVEREPORT_DATA
(
 @CWHERE NVARCHAR(MAX),
 @CDEPTID CHAR(4)='',
 @IMODE INT =1,
 @QUERYID INT=1,
 @TABLE_NAME VARCHAR(100)=''
)
AS
BEGIN
SET NOCOUNT ON
--(dinkar) Replace  left(memoid,2) to Location_code 
--DROP TABLE TMP
--select @CWHERE w,@CDEPTID d,@IMODE i,@QUERYID Q,@TABLE_NAME T
--INTO TMP

--IF OBJECT_ID('SP_LIVEREPORT_DATA_CUSTOM','P') IS NOT NULL
--   BEGIN
--      EXEC SP_LIVEREPORT_DATA_CUSTOM @CWHERE,@CDEPTID,@IMODE
--      RETURN
--END
--IF @QUERYID<>3
--BEGIN

SET @QUERYID =2
--ELSE
--SET @QUERYID=1
--END


DECLARE @MYSQL VARCHAR(MAX)
IF OBJECT_ID('TEMPDB..#LIVE_REPORT_DATA') IS NOT NULL DROP TABLE #LIVE_REPORT_DATA
CREATE TABLE #LIVE_REPORT_DATA(PRODUCT_CODE VARCHAR(50),BIN_ID VARCHAR(7),DEPT_ID VARCHAR(4),CBS_QTY numeric(10,3))

IF @QUERYID=1--VIEW
   INSERT INTO #LIVE_REPORT_DATA(PRODUCT_CODE,BIN_ID,DEPT_ID,CBS_QTY)
   SELECT PRODUCT_CODE,BIN_ID,DEPT_ID
   ,SUM(XN_QTY*CASE WHEN XN_TYPE IN ('MIR','PFI','SCF','WPR','DNPR','GRNPSIN','TTM','PUR','CHI','SLR','UNC','APR','WSR','DCI','JWR') THEN 1
                    WHEN XN_TYPE IN ('SCC','WPI','DNPI','GRNPSOUT','PRT','CHO','SLS','CNC','APP','WSL','DCO','JWI','CIP','MIS')  THEN -1
                    ELSE 0 END)CBS_QTY
   FROM VW_XNSREPS              
   GROUP BY PRODUCT_CODE,BIN_ID,DEPT_ID
ELSE IF @QUERYID=2--PMT
BEGIN
   --SET @MYSQL=' IF OBJECT_ID('''+RTRIM(LTRIM(DB_NAME()))+'_PMT.DBO.PMTLOCS_'+CONVERT(VARCHAR,GETDATE(),112)+''',''U'') IS NOT NULL
		 --  SELECT PRODUCT_CODE,BIN_ID,A.DEPT_ID,CBS_QTY FROM '+RTRIM(LTRIM(DB_NAME()))+'_PMT.DBO.PMTLOCS_'+
		 --  CONVERT(VARCHAR,GETDATE(),112)+' A  (NOLOCK) JOIN LOCATION  B (NOLOCK)  ON  B.DEPT_ID= A.DEPT_ID  WHERE ISNULL(B.SERVER_LOC,0)=0
		 --  and CBS_QTY<>0
		 --  UNION ALL  '

   --SET @MYSQL=ISNULL(@MYSQL,'')+ ' SELECT PRODUCT_CODE,BIN_ID,A.DEPT_ID,A.Quantity_in_stock AS CBS_QTY FROM PMT01106 A  (NOLOCK) JOIN LOCATION  B (NOLOCK)  ON  B.DEPT_ID= A.DEPT_ID  
   --WHERE ISNULL(B.SERVER_LOC,1)=1 and A.Quantity_in_stock<>0' 

     SET @MYSQL= ' SELECT PRODUCT_CODE,BIN_ID,A.DEPT_ID,A.Quantity_in_stock AS CBS_QTY FROM PMT01106 A  (NOLOCK) JOIN LOCATION  B (NOLOCK)  ON  B.DEPT_ID= A.DEPT_ID  
                 WHERE   A.Quantity_in_stock<>0 and bin_id<>''999'' and 1=2 '  --remove due to large amount of time taken



END
ELSE IF @QUERYID=3--##TABLE
   SET @MYSQL='SELECT PRODUCT_CODE,BIN_ID,DEPT_ID,CBS_QTY FROM '+@TABLE_NAME
   
IF @QUERYID<>1 
   INSERT INTO #LIVE_REPORT_DATA(PRODUCT_CODE,BIN_ID,DEPT_ID,CBS_QTY)
   EXEC(@MYSQL) 
   PRINT @MYSQL

    

DECLARE @CCMDCOLUMN NVARCHAR(MAX),@CCMDJOIN NVARCHAR(MAX),@CCMDGROUPBY NVARCHAR(MAX),@CCOLNAME VARCHAR(100),
	@CTABLENAME VARCHAR(100),@CCALLHEADER VARCHAR(100),
	@BFIRST BIT,@CCBS VARCHAR(MAX),@CCBS1 VARCHAR(MAX),
	@CCMD1 NVARCHAR(MAX),
	@CCMD2 NVARCHAR(MAX),
	@COUTERCOLUMN NVARCHAR(MAX),
	@CCMDOUTERGROUPBY NVARCHAR(MAX),
	@CCCMDFINAL VARCHAR(MAX),
	@CERRMSG VARCHAR(1000),
	@JOINSTR VARCHAR(MAX),
	@CFILTER NVARCHAR(MAX),
	@CTOTALCMDCOLUMN VARCHAR(MAX),
	@CCMDJOIN1 NVARCHAR(MAX)
	
	
BEGIN TRY
	IF OBJECT_ID('TEMPDB..#LIVERPT','U') IS NOT NULL DROP TABLE #LIVERPT
	SELECT * INTO #LIVERPT FROM LIVE_REPORT
	
	DELETE FROM #LIVERPT WHERE (CALL_EXP IN ('DEPT_ID','AREA_NAME') AND @IMODE=3) OR (CALL_EXP IN ('DEPT_NAME') AND @IMODE=2)
	
	SELECT @CFILTER='',@JOINSTR=''
	
	--- don't comment the dept_id expression (sumit mishra) for layallpur 
	IF @CDEPTID<>'' AND EXISTS (SELECT TOP 1 'U' FROM  WIZAPPLIVELOC_GROUP WHERE MAJOR_DEPT_ID =@CDEPTID)
	   SELECT @JOINSTR='JOIN WIZAPPLIVELOC_GROUP (NOLOCK) ON (WIZAPPLIVELOC_GROUP.DEPT_ID=LOC_VIEW.DEPT_ID )' 
	         ,@CFILTER=' AND WIZAPPLIVELOC_GROUP.MAJOR_DEPT_ID='''+@CDEPTID+''' '

	SELECT @CCMDCOLUMN='SELECT ',@COUTERCOLUMN='SELECT ',@CCMDGROUPBY='GROUP BY ',@CCMDOUTERGROUPBY='',@CCBS='SUM(CBS_QTY) AS CBS'


	--'FROM '+RTRIM(LTRIM(DB_NAME()))+'_RFOPT.DBO.RF_OPT A  (NOLOCK)
	SET @CCMDJOIN = ' FROM (
	
					   SELECT PRODUCT_CODE,BIN_ID,A.DEPT_ID,A.Quantity_in_stock AS CBS_QTY 
					   FROM PMT01106 A  (NOLOCK) JOIN LOCATION  B (NOLOCK)  ON  B.DEPT_ID= A.DEPT_ID  
					   WHERE   A.Quantity_in_stock<>0 and bin_id<>''999''
	               ) A  
	               JOIN SKU_NAMES (NOLOCK) ON A.PRODUCT_CODE = SKU_NAMES.PRODUCT_CODE 
	             
	               LEFT JOIN LOC_VIEW  (NOLOCK) ON A.DEPT_ID = LOC_VIEW.DEPT_ID
	               LEFT JOIN BIN  (NOLOCK) ON A.BIN_ID = BIN.BIN_ID
	           
				   '+ @JOINSTR +
				   +ISNULL(@CWHERE,'')+@CFILTER
				   
	SET @BFIRST = 1
	WHILE EXISTS(SELECT TOP 1 * FROM #LIVERPT)
	BEGIN
	    SELECT TOP 1 @CCOLNAME = CALL_EXP, @CTABLENAME=TABLENAME,@CCALLHEADER=CALL_HEADER FROM #LIVERPT ORDER BY SHOW_ORDER 
	    IF ISNULL(@CTABLENAME,'') <> ''
	       BEGIN

	    	
			  SET @CCMDCOLUMN = @CCMDCOLUMN+(CASE WHEN @BFIRST = 1 THEN '' ELSE ',' END )+@CTABLENAME+'.'+@CCOLNAME 
			  IF (@CCOLNAME='PARA2_NAME' AND @IMODE=2) OR (@CCOLNAME='DEPT_NAME' AND @IMODE=3)
				  SET @CTOTALCMDCOLUMN=ISNULL(@CTOTALCMDCOLUMN,'')
			  ELSE 
				  SET @CTOTALCMDCOLUMN=ISNULL(@CTOTALCMDCOLUMN,'')+(CASE WHEN @BFIRST = 1 THEN '' ELSE ',' END )+' NULL AS '+@CCOLNAME 
			  SET @CCMDGROUPBY = @CCMDGROUPBY+(CASE WHEN @BFIRST = 1 THEN '' ELSE ',' END )+@CTABLENAME+'.'+@CCOLNAME
			  SET @COUTERCOLUMN= @COUTERCOLUMN+(CASE WHEN @BFIRST = 1 THEN '' ELSE ',' END )+@CCOLNAME+ ' AS ['+@CCALLHEADER+']'
			  SET @CCMDOUTERGROUPBY = @CCMDOUTERGROUPBY + (CASE WHEN @BFIRST = 1 THEN '' ELSE ',' END )+@CCOLNAME 
		   END	
	     SET @BFIRST = 0
		 DELETE FROM #LIVERPT WHERE CALL_EXP=@CCOLNAME AND TABLENAME=@CTABLENAME AND CALL_HEADER = @CCALLHEADER
	END

	SET @CCMD1 =@CCMDCOLUMN+','+@CCBS+CHAR(13)+@CCMDJOIN+CHAR(13)+@CCMDGROUPBY
	
	IF OBJECT_ID ('TEMPDB..##TMPLIVEDATA','U') IS NOT NULL DROP TABLE ##TMPLIVEDATA
	
	
	
	IF @IMODE=1
		BEGIN
			SET @CCCMDFINAL = 
			@COUTERCOLUMN + ',SUM(ISNULL(CBS,0)) AS [CBS QTY] 
			FROM (' +@CCMD1+CHAR(13)+' ) B1
			GROUP BY ' +@CCMDOUTERGROUPBY+'
			HAVING NOT(SUM(ISNULL(CBS,0))= 0)' 
			PRINT 'ORDER '+@CCMDOUTERGROUPBY 
		END
	ELSE
		BEGIN
			SET @CCCMDFINAL = @COUTERCOLUMN + ',SUM(ISNULL(CBS , 0)) AS [CBS QTY]
			INTO ##TMPLIVEDATA 
			FROM 
			(' 
			+@CCMD1+
			') B1 
			GROUP BY ' +@CCMDOUTERGROUPBY+'
			HAVING SUM(ISNULL(CBS,0))!=0'
		END	

	
    PRINT '@'+@CCCMDFINAL
    EXEC ( @CCCMDFINAL)
    --SET ORDER BY '+@CCMDOUTERGROUPBY 
    
    --NOW DATA IN CROSS TAB
    DECLARE @SIZENAME VARCHAR(MAX),@DTSQL NVARCHAR(MAX),
    @CLOCATIONNAME VARCHAR(MAX), @CSIZETOTAL VARCHAR(MAX),
    @CSIZESUBTOTAL VARCHAR(MAX), @CLOCATIONTOTAL VARCHAR(MAX),
    @CLOCATIONSUBTOTAL VARCHAR(MAX)
      
    IF @IMODE=2
    BEGIN
		--2A
		SELECT @SIZENAME=ISNULL(@SIZENAME+',','')+QUOTENAME( SIZE)
		FROM
		(
		  SELECT SIZE, max(PARA2_ORDER) as PARA2_ORDER  
		  FROM ##TMPLIVEDATA A
		  JOIN PARA2 ON A.SIZE=PARA2.PARA2_NAME 
		  GROUP BY SIZE
		)A
		WHERE SIZE<>''
		ORDER BY PARA2_ORDER   
		--2B 
		SELECT @CSIZETOTAL=ISNULL(@CSIZETOTAL+'+','')+'ISNULL('+QUOTENAME(SIZE) +',0)'
		FROM
		(
		  SELECT SIZE, max(PARA2_ORDER) as PARA2_ORDER  
		  FROM ##TMPLIVEDATA A
		  JOIN PARA2 ON A.SIZE=PARA2.PARA2_NAME 
		  GROUP BY SIZE
		)A
		WHERE SIZE<>''
		ORDER BY PARA2_ORDER 
		--2C 
		SELECT @CSIZESUBTOTAL=ISNULL(@CSIZESUBTOTAL+',','')+'SUM(ISNULL('+QUOTENAME(SIZE) +',0)) AS '+QUOTENAME(SIZE)
		FROM
		(
		  SELECT SIZE, max(PARA2_ORDER ) as  PARA2_ORDER
		  FROM ##TMPLIVEDATA A
		  JOIN PARA2 ON A.SIZE=PARA2.PARA2_NAME 
		  GROUP BY SIZE
		)A
		WHERE SIZE<>''
		ORDER BY PARA2_ORDER 
		--2D 
		IF ISNULL(@SIZENAME,'')<>''
		BEGIN
			SET @DTSQL=N';
			WITH CTE AS
			(
			SELECT *,'+@CSIZETOTAL+' AS TOTAL
			FROM ##TMPLIVEDATA 
			PIVOT (SUM([CBS QTY]) FOR SIZE IN ('+@SIZENAME+')) AS PTABLE
			)
			SELECT * FROM CTE
			UNION ALL
			SELECT '+@CTOTALCMDCOLUMN+', '+@CSIZESUBTOTAL+',SUM(ISNULL(TOTAL,0) ) AS TOTAL
			FROM CTE'
			PRINT @DTSQL
			EXEC SP_EXECUTESQL @DTSQL
		END
		else
		begin
		     
		  SET @DTSQL=N' SELECT *
			FROM ##TMPLIVEDATA 
			'
			PRINT @DTSQL
			EXEC SP_EXECUTESQL @DTSQL

		end
	END--@IMODE=2
	ELSE IF @IMODE=3
	BEGIN
	   --3A
	   SELECT @CLOCATIONNAME=ISNULL(@CLOCATIONNAME+',','')+QUOTENAME([LOCATION NAME])
	   FROM
	   (
		 SELECT [LOCATION NAME] 
		 FROM ##TMPLIVEDATA
		 GROUP BY [LOCATION NAME]
	   ) A
	   WHERE [LOCATION NAME]<>''
	   ORDER BY [LOCATION NAME] ASC  
	   --3B	 
	   SELECT @CLOCATIONTOTAL=ISNULL(@CLOCATIONTOTAL+'+','')+'ISNULL('+QUOTENAME([LOCATION NAME]) +',0)'
	   FROM
	   (
		 SELECT [LOCATION NAME] 
		 FROM ##TMPLIVEDATA
		 GROUP BY [LOCATION NAME]
	   ) A
	   WHERE [LOCATION NAME]<>''
	   ORDER BY [LOCATION NAME] ASC 
	   --3C 	 
	   SELECT @CLOCATIONSUBTOTAL=  ISNULL(@CLOCATIONSUBTOTAL+',','')+'SUM(ISNULL('+QUOTENAME([LOCATION NAME]) +',0)) AS '+QUOTENAME([LOCATION NAME])
	   FROM
	   (
		SELECT [LOCATION NAME] 
		FROM ##TMPLIVEDATA
		GROUP BY [LOCATION NAME]
	   )A
	   WHERE [LOCATION NAME]<>''
	   ORDER BY [LOCATION NAME] ASC 
	   --3D	 
	   IF ISNULL(@CLOCATIONNAME,'')<>''
		  BEGIN
		   	 SET @DTSQL=N';
			 WITH CTE AS
			 (
				SELECT  *,'+@CLOCATIONTOTAL+' AS TOTAL
				FROM ##TMPLIVEDATA 
				PIVOT (SUM([CBS QTY]) FOR [LOCATION NAME] IN ('+@CLOCATIONNAME+')) AS PTABLE
			 )
			 SELECT * FROM CTE
			 UNION ALL
			 SELECT '+@CTOTALCMDCOLUMN+', '+@CLOCATIONSUBTOTAL+',SUM(ISNULL(TOTAL,0) ) AS TOTAL
			 FROM CTE'
	         PRINT @DTSQL
			 EXEC SP_EXECUTESQL @DTSQL
		 END
	   ELSE
		BEGIN
		     
		  SET @DTSQL=N' SELECT *
			FROM ##TMPLIVEDATA 
			'
			PRINT @DTSQL
			EXEC SP_EXECUTESQL @DTSQL

		END
	END--@IMODE=3
  END TRY

  BEGIN CATCH
	 SET @CERRMSG = ERROR_MESSAGE() 
	 SELECT ISNULL(@CERRMSG,'') AS ERRMSG
  END CATCH  
  
  IF OBJECT_ID('TEMPDB..##TMPLIVEDATA','U') IS NOT NULL
     DROP TABLE ##TMPLIVEDATA
  SET NOCOUNT OFF
END





