CREATE PROCEDURE SP_MERGEDOCSKUREQDATA  
(  
 @CMEMOID VARCHAR(40)
)  
--WITH ENCRYPTION
AS  
BEGIN    
	  DECLARE @CERRORMSG VARCHAR(1000),@CCURDEPTID CHAR(2),@CHODEPTID CHAR(2),@CCMD NVARCHAR(MAX),
			  @NSTEP INT,@BPROCEED BIT,@BLOCDATAEXISTS BIT,@CTABLEPREFIX VARCHAR(100),@CXNTYPE VARCHAR(15),
			  @CSOURCETABLENAME VARCHAR(200)	
		
	    
	  BEGIN TRANSACTION  
	    
	  SET @NSTEP = 10  
	  DECLARE @TRETMSG TABLE  (MEMO_ID VARCHAR(40),ERRMSG VARCHAR(MAX))  
	   
	  BEGIN TRY  
	       
	  SELECT @CERRORMSG='',@BPROCEED=1,@CXNTYPE='DOCSKUREQ'
	    	  
	  	  
	  SET @CSOURCETABLENAME= 'TMP_DOCSKUREQ_SKU_REQ_'+@CMEMOID
	  
	  IF OBJECT_ID(@CSOURCETABLENAME,'U') IS NULL
	  BEGIN
		SET @CERRORMSG='SOURCE TABLE NOT FOUND ...PLEASE CHECK'
		GOTO LBLLAST
	  END

	  SELECT TOP 1 @CCURDEPTID = [VALUE] FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'  
	  SELECT TOP 1 @CHODEPTID = [VALUE] FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'  
	
	  IF @CCURDEPTID<>@CHODEPTID
		GOTO LBLLAST
	  
	  			
	  SET @NSTEP = 20  
	  	
	  EXEC UPDATEMASTERXN
		@CSOURCEDB = '', 
		@CDESTDB = '',
		@CSOURCETABLE = @CSOURCETABLENAME, 
		@CDESTTABLE = 'SKU_REQ',
		@CKEYFIELD1 = 'MEMO_ID',
		@BALWAYSUPDATE = 1
	  		  
	  
	  GOTO LBLLAST
	    
	 END TRY  
	  
	 BEGIN CATCH  
		  
		  PRINT 'UNTRAPPED ERROR'    
		       
		  DECLARE @CERRORPROCNAME VARCHAR(100),@CLINENO VARCHAR(5),@CERRTEXT VARCHAR(MAX)  
		    
		  SELECT @CERRORPROCNAME=ISNULL(ERROR_PROCEDURE(),'NULL P'),@CLINENO=ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE'),  
		  @CERRTEXT='STEP : '+LTRIM(RTRIM(STR(@NSTEP)))+' '+ISNULL(ERROR_MESSAGE(),'NULL MSG')  
		    
		  SELECT @CERRORMSG=@CERRTEXT  
		  
		  GOTO LBLLAST  
     END CATCH  

LBLLAST:  	 
	 
	      
	IF @@TRANCOUNT>0  
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			COMMIT TRANSACTION  
		 ELSE
			ROLLBACK
	END	
	 
 	INSERT @TRETMSG
	SELECT @CMEMOID,@CERRORMSG
			
	SELECT * FROM @TRETMSG

	EXEC SP_DROPTEMPTABLES_XNS 'DOCSKUREQ',0,@CMEMOID,'TMP_DOCSKUREQ'  

END  
--- 'END OF CREATING PROCEDURE SP_MERGEDOCSKUREQ'
