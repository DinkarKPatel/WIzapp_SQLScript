CREATE PROCEDURE SP3S_UPDATERFNET_PUR
@CMRRID VARCHAR(40)
AS
BEGIN
	DECLARE @CROWID VARCHAR(50),@NTAX NUMERIC(20,2),@NINCLTAX NUMERIC(20,2),@NSUMRFNET NUMERIC(20,2),@NSUBTOTAL NUMERIC(20,2),
			@NSUMRFNETWT NUMERIC(20,2),@NOH_AMOUNT NUMERIC(20,2),@NTOTALQTY NUMERIC(20,3),@NOH_TAXABLE_VALUE NUMERIC(20,2),@DRECEIPT_DT DATETIME

	SELECT TOP 1 @CROWID = ROW_ID FROM PID01106 A WITH (ROWLOCK) WHERE MRR_ID=@CMRRID

	PRINT 'UPDRFNET-4'
			
	SELECT @NTAX=0,@NINCLTAX=0

	UPDATE A SET RFNET =0,RFNET_WOTAX =0 FROM pid01106 A WITH (ROWLOCK) WHERE MRR_ID=@CMRRID

	SELECT   @NOH_AMOUNT= ISNULL(B.FREIGHT_TAXABLE_VALUE,0) + 
		ISNULL(B.FREIGHT_IGST_AMOUNT ,0)+ISNULL(B.FREIGHT_CGST_AMOUNT ,0)+ISNULL(B.FREIGHT_SGST_AMOUNT ,0)+
		ISNULL(B.OTHER_CHARGES_TAXABLE_VALUE,0) + 
		ISNULL(B.OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_CGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_SGST_AMOUNT ,0),  --B.ROUND_OFF
		
		@NTOTALQTY=B.TOTAL_QUANTITY,
		@NOH_TAXABLE_VALUE= ISNULL(B.FREIGHT_TAXABLE_VALUE,0) + ISNULL(B.OTHER_CHARGES_TAXABLE_VALUE,0) ,
		@DRECEIPT_DT=B.receipt_dt  
	FROM pim01106 B  WITH (ROWLOCK) WHERE MRR_ID =@CMRRID

	IF @DRECEIPT_DT<'2017-07-01'
	   RETURN
			
     IF ISNULL(@NOH_AMOUNT,0)=0
	 BEGIN
	      
		  UPDATE A SET RFNET=A.XN_VALUE_WITH_GST+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0) ,RFNET_WOTAX =A.XN_VALUE_WITHOUT_GST+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0)   
		  FROM  pid01106 A WITH (ROWLOCK) WHERE mrr_id=@CMRRID
		  

	 END
	 ELSE
	 BEGIN
	     
		  UPDATE A SET RFNET=A.XN_VALUE_WITH_GST+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0)+ ((@NOH_AMOUNT/CASE WHEN ISNULL(@NTOTALQTY,0)=0 THEN 1 ELSE @NTOTALQTY END )*A.invoice_quantity ) ,
		               RFNET_WOTAX =A.XN_VALUE_WITHOUT_GST+ISNULL (GST_CESS_AMOUNT,0)+ISNULL (CESS_AMOUNT,0) + ((@NOH_TAXABLE_VALUE/CASE WHEN ISNULL(@NTOTALQTY,0)=0 THEN 1 ELSE @NTOTALQTY END )*A.invoice_quantity )  
		  FROM  pid01106 A WITH (ROWLOCK) WHERE mrr_id=@CMRRID
		  


	 END




	SELECT @NSUBTOTAL= total_amount FROM pim01106  (NOLOCK) WHERE  mrr_id  = @CMRRID

	SELECT @NSUMRFNET = SUM(RFNET) FROM pid01106 (NOLOCK)  WHERE mrr_id  = @CMRRID
				
	IF @NSUMRFNET <> @NSUBTOTAL
	BEGIN
		PRINT 'UPDRFNET-6'
		UPDATE pid01106  SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
		WHERE mrr_id = @CMRRID AND ROW_ID = @CROWID
	END
 update pim01106 WITH (ROWLOCK) SET HO_SYNCH_LAST_UPDATE='' WHERE mrr_id=@CMRRID
END			
