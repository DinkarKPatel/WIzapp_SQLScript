create PROCEDURE DBO.SP_SEND_MIRROR_MSTLBR_NEW 
(  
 @CTARGETLOCID VARCHAR(5)  
)  
AS  
 BEGIN  
   DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION NVARCHAR(MAX)  
           ,@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPLMTABLE VARCHAR(100)  
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CCURDEPTID VARCHAR(5)  
           ,@CHODEPTID VARCHAR(5),@CERRORMSG VARCHAR(MAX),@CREPLOCTABLE VARCHAR(500),@NLOCTYPE INT  
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(2),@JOINMASTERTABLE VARCHAR(200),@JOINTEMPTABLE VARCHAR(200)  
  
    DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),ERRMSG VARCHAR(MAX))   
      
    BEGIN TRY  
      
 SET @CSTEP=0  
  
 SET @CTEMPDBNAME =''
   
 SET @CSTEP=10  
   
 PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)  
 SET @CFILTERCONDITION=''  
    
 SET @CSTEP=20  
  
 SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'  
 SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'    
   
 SELECT @NLOCTYPE=LOC_TYPE FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID  
   
 PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)  
   
 IF @CCURDEPTID<>@CHODEPTID  
 BEGIN  
  SELECT '' AS LAST_UPDATE,'' AS ERRMSG  
    
  GOTO END_PROC  
 END    
    SET @CSTEP=30  
   
   
 --INSERT DATA FROM MAIN TABLE TO TEMP TABLE  
    SET @CSTEP=40  
    ---SELECT DATA FROM LOC_BILLING_RULES TABLE  
 SET @CTABLENAME = 'LOC_BILLING_RULES'  
 SELECT DISTINCT  'MSTLBR_LOC_BILLING_RULES_MIRROR' AS TARGET_TABLENAME,LOC_BILLING_RULES.*,1 AS PICK_FROM_CURRENT_DB FROM LOC_BILLING_RULES (NOLOCK)
   
  SET @CSTEP=45  
    ---SELECT DATA FROM LOC_BILLING_RULES_ALLLOC TABLE  
 SET @CTABLENAME = 'LOC_BILLING_RULES_ALLLOC'  
 SELECT DISTINCT  'MSTLBR_LOC_BILLING_RULES_ALLLOC_MIRROR' AS TARGET_TABLENAME,LOC_BILLING_RULES_ALLLOC.*,1 AS PICK_FROM_CURRENT_DB FROM LOC_BILLING_RULES_ALLLOC (NOLOCK) where source_dept_id =@CTARGETLOCID
   

    
 --INSERT DATA FROM MAIN TABLE TO TEMP TABLE  
    SET @CSTEP=50
    ---SELECT DATA FROM LOC_BILLING_RULES TABLE  
 SET @CTABLENAME = 'LOC_BILLING_RULES_FORM'  

 SELECT DISTINCT  'MSTLBR_LOC_BILLING_RULES_FORM_MIRROR' AS TARGET_TABLENAME,LOC_BILLING_RULES_FORM.*,1 AS PICK_FROM_CURRENT_DB FROM LOC_BILLING_RULES_FORM (NOLOCK)

   
  --INSERT DATA FROM MAIN TABLE TO TEMP TABLE  
    SET @CSTEP=60
    ---SELECT DATA FROM LOC_BILLING_RULES TABLE  
 SET @CTABLENAME = 'LOC_BILLING_RULES_SERIES'  
 
 SELECT DISTINCT  'MSTLBR_LOC_BILLING_RULES_SERIES_MIRROR' AS TARGET_TABLENAME,LOC_BILLING_RULES_SERIES.*,1 AS PICK_FROM_CURRENT_DB FROM LOC_BILLING_RULES_SERIES (NOLOCK)

   
   
 END TRY  
   
 BEGIN CATCH  
     SET @CERRORMSG='P: SP_SEND_MIRROR_MSTLBR, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()+ 'ERROR QUERY || '+@DTSQL  
     GOTO END_PROC  
    END CATCH   
      
    END_PROC:  
      
   SELECT ISNULL(@CERRORMSG,'')  AS ERRMSG
 END
