CREATE PROCEDURE SP_MBQ_DET_FORMAT1  
(   
  @CDTFROM VARCHAR(15),  
  @CDTTO VARCHAR(15),
   @CWHERE VARCHAR(50) = '',  
  @CDEPTID VARCHAR(10) = '',  
  @INTMONTH INT = 0,  
  @INTYEAR INT = 0,  
  @CARTICLE VARCHAR(50) = '',  
  @CPRODUCT VARCHAR(50) = '',
  @CSECTION VARCHAR(50) = '',
  @CSUBSECTION VARCHAR(50) = ''  
)
  
AS  
BEGIN  
	DECLARE @DTSQL NVARCHAR(MAX),@RFOPT VARCHAR(100),@CFILTER VARCHAR(MAX),@CADDJOINSTR VARCHAR(MAX)

	SET @RFOPT=DB_NAME()+'_RFOPT.DBO.RF_OPT'

	IF OBJECT_ID('TEMPDB..#SQ1','U') IS NOT NULL
		DROP TABLE #SQ1  
	SELECT DEPT_ID,MST.PRODUCT_CODE,SUM(MBQ) AS MBQ,SUM(ISNULL(MST,0)) AS MST   
	INTO #SQ1 FROM  MBQ_DET MST  (NOLOCK)  
	JOIN SKU B (NOLOCK) ON MST.PRODUCT_CODE = B.PRODUCT_CODE 
	JOIN ARTICLE D (NOLOCK) ON D.ARTICLE_CODE=B.ARTICLE_CODE   
	JOIN SECTIOND E (NOLOCK) ON D.SUB_SECTION_CODE = E.SUB_SECTION_CODE     
	WHERE MST.MONTH = @INTMONTH  AND MST.YEAR =@INTYEAR  
	AND (@CSECTION='' OR E.SECTION_CODE = @CSECTION )  
	AND (@CSUBSECTION='' OR E.SUB_SECTION_CODE = @CSUBSECTION ) 
	AND (@CDEPTID ='' OR MST.DEPT_ID =@CDEPTID )   
	AND (@CARTICLE='' OR B.ARTICLE_CODE = @CARTICLE )
	AND (@CPRODUCT='' OR B.PRODUCT_CODE  = @CPRODUCT )   
	GROUP BY DEPT_ID,MST.PRODUCT_CODE   

	SET @CFILTER='1=1'

	SET @CFILTER=@CFILTER+(CASE WHEN @CDEPTID<>'' THEN ' AND LO.DEPT_ID ='''+@CDEPTID+'''' ELSE '' END)+ 
			(CASE WHEN @CSECTION<>'' THEN ' AND E.SECTION_CODE = '''+@CSECTION+'''' ELSE '' END)+ 
			(CASE WHEN @CSUBSECTION<>'' THEN ' AND E.SUB_SECTION_CODE = '''+@CSUBSECTION+'''' ELSE '' END)+ 
			(CASE WHEN @CARTICLE<>'' THEN ' AND D.ARTICLE_CODE = '''+@CARTICLE+'''' ELSE '' END)+ 
			(CASE WHEN @CPRODUCT<>'' THEN ' AND B.PRODUCT_CODE  = '''+@CPRODUCT+'''' ELSE '' END)

	SELECT @CADDJOINSTR=(CASE WHEN @CSUBSECTION<>'' OR @CSECTION<>'' THEN ' JOIN SECTIOND E (NOLOCK) ON D.SUB_SECTION_CODE = E.SUB_SECTION_CODE 
						 JOIN SECTIONM F (NOLOCK) ON E.SECTION_CODE = F.SECTION_CODE'  ELSE '' END)      
	  
	SET @DTSQL=N'SELECT LO.DEPT_ID,LO.DEPT_NAME,D.ARTICLE_NO,B.PRODUCT_CODE,B.PRODUCT_NAME,LOCSP.LOC_MRP AS MRP,  
	ISNULL(MST.MBQ,0) AS MBQ_QTY, ISNULL(MST.MST,0) AS MST_QTY,SUM( CASE WHEN A.XN_TYPE=''SLS'' AND XN_DT BETWEEN '''+@CDTFROM+''' AND '''+@CDTTO+'''   
	  THEN XN_QTY  WHEN A.XN_TYPE=''SLR'' AND XN_DT BETWEEN '''+@CDTFROM+''' AND '''+@CDTTO+'''    
	 THEN - (ABS(XN_QTY)) ELSE 0 END) AS SLS_QTY,
	 SUM( (CASE WHEN A.XN_TYPE=''OPS'' OR (A.XN_TYPE IN (''OPS'', ''PUR'', ''CHI'', ''SLR'',''UNC'',''APR'', ''WSR'', ''PFI'',     
	''PFG'', ''BCG'',''MRP'',''DCI'',''PSB'',''JWR'') AND XN_DT <= '''+@CDTTO+'''  )     
	THEN 1 WHEN A.XN_TYPE IN (''PRT'',''CHO'',''SLS'',''CNC'',''APP'',''WSL'',''CIP'', ''CRM'', ''DCO'',''MIP'',''CSB'',    
	''JWI'',''DLM'') AND XN_DT <= '''+@CDTTO+'''  THEN -1 ELSE 0 END)* XN_QTY) AS STOCK_QTY,    
	SUM( CASE WHEN A.XN_TYPE=''SLS'' AND XN_DT BETWEEN '''+@CDTFROM+''' AND '''+@CDTTO+'''        
	THEN (XN_QTY)  WHEN A.XN_TYPE=''SLR'' AND XN_DT BETWEEN '''+@CDTFROM+''' AND '''+@CDTTO+'''  
	  THEN - (ABS(XN_QTY)) ELSE 0 END) * LOCSP.LOC_MRP AS SLS_VAL    
	 FROM '+@RFOPT+' A  (NOLOCK) 
	JOIN LOCATION LO (NOLOCK) ON LO.DEPT_ID = A.DEPT_ID    
	JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE = B.PRODUCT_CODE     
	JOIN ARTICLE D (NOLOCK) ON D.ARTICLE_CODE=B.ARTICLE_CODE  
	LEFT OUTER JOIN  #SQ1   MST  ON MST.PRODUCT_CODE= B.PRODUCT_CODE  AND MST.DEPT_ID= LO.DEPT_ID  
	LEFT OUTER JOIN LOCSKUSP_CURRENT LOCSP ON LOCSP.PRODUCT_CODE=B.PRODUCT_CODE AND LOCSP.DEPT_ID=LO.DEPT_ID '+@CADDJOINSTR+
	' WHERE '+@CFILTER+' AND LO.INACTIVE = 0   
	GROUP BY LO.DEPT_ID,LO.DEPT_NAME,D.ARTICLE_NO,B.PRODUCT_CODE,B.PRODUCT_NAME ,LOCSP.LOC_MRP,
	ISNULL(MST.MBQ,0),ISNULL(MST.MST,0)   
	HAVING ( SUM( CASE WHEN A.XN_TYPE=''SLS'' AND XN_DT BETWEEN '''+@CDTFROM+''' AND '''+@CDTTO+'''   
	  THEN XN_QTY  WHEN A.XN_TYPE=''SLR'' AND XN_DT BETWEEN '''+@CDTFROM+''' AND '''+@CDTTO+'''    
	 THEN - (ABS(XN_QTY)) ELSE 0 END) <> 0  
	OR  SUM( (CASE WHEN A.XN_TYPE=''OPS'' OR (A.XN_TYPE IN (''OPS'', ''PUR'', ''CHI'', ''SLR'',''UNC'',''APR'', ''WSR'', ''PFI'',     
	''PFG'', ''BCG'',''MRP'',''DCI'',''PSB'',''JWR'') AND XN_DT <= '''+@CDTTO+'''  )     
	THEN 1 WHEN A.XN_TYPE IN (''PRT'',''CHO'',''SLS'',''CNC'',''APP'',''WSL'',''CIP'', ''CRM'', ''DCO'',''MIP'',''CSB'',    
	''JWI'',''DLM'') AND XN_DT <= '''+@CDTTO+'''  THEN -1 ELSE 0 END) * (XN_QTY)) <> 0  
	OR ISNULL(MST.MBQ,0) > 0  OR ISNULL(MST.MST,0)  > 0  
	)  
	ORDER BY LO.DEPT_ID' 
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL  

END
