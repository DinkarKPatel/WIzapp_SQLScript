CREATE PROCEDURE SP_WO_COMPONENT_DETAILS
(
 @CAC_CODE VARCHAR(10)='',
 @NCLOSING_BALANCE INT=0
)
AS
BEGIN
  
  IF OBJECT_ID ('TEMPDB..#TMPISSUE','U')  IS NOT NULL
     DROP TABLE #TMPISSUE
     
  SELECT 'ISSUE' AS XN_TYPE,ARTCOM.ARTICLE_NO AS COMPONENT, 
  D.REF_PRD_WORKORDER_MEMOID AS ORDER_ID,
  SUM(D.QUANTITY) AS ISSU_QTY,
  BOM.[AVG_QTY] AS [AVG_QTY],
  CONVERT(NUMERIC(12,3),CASE WHEN BOM.[AVG_QTY] <>0 THEN SUM(D.QUANTITY)/ BOM.[AVG_QTY]  ELSE 0 END )  AS COMP_ISS_QUANTITY,
  'PCS' AS ORDER_PCS,
  SD.SUB_SECTION_NAME AS ITEM_NAME,
  AG.AGENCY_NAME
  INTO #TMPISSUE
  FROM PRD_AGENCY_ISSUE_MATERIAL_DET D            
  JOIN PRD_SKU SKU ON SKU.PRODUCT_UID=D.PRODUCT_UID            
  JOIN ARTICLE B ON SKU.ARTICLE_CODE  = B.ARTICLE_CODE                 
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST IM ON IM.MEMO_ID=D.MEMO_ID 
  JOIN ARTICLE ARTCOM ON D.REF_COMPONENT_ARTICLE_CODE = ARTCOM.ARTICLE_CODE 
  JOIN
  (
	 SELECT AR1.ARTICLE_CODE, AR1.ARTICLE_NO, B.MEMO_ID AS ORDER_ID,SUM(AVG_QTY) AS AVG_QTY       
	 FROM PRD_WO_ART_BOM A (NOLOCK)      
	 JOIN  PRD_WO_DET B (NOLOCK) ON A.REF_ROW_ID = B.ROW_ID      
	 JOIN ARTICLE AR1 ON AR1.ARTICLE_CODE =B.ARTICLE_CODE                 
	 --WHERE --B.MEMO_ID = 'HO0111700000HO00000006'  
	 GROUP BY AR1.ARTICLE_CODE, AR1.ARTICLE_NO, B.MEMO_ID
  ) BOM ON BOM.ORDER_ID=D.REF_PRD_WORKORDER_MEMOID AND ARTCOM.ARTICLE_CODE=BOM.ARTICLE_CODE
  JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE =IM.REF_AGENCY_CODE            
  JOIN UOM C ON B.UOM_CODE = C.UOM_CODE             
  JOIN PARA1 ON PARA1.PARA1_CODE = SKU.PARA1_CODE                
  JOIN PARA2 ON PARA2.PARA2_CODE = SKU.PARA2_CODE                 
  JOIN PRD_PMT P ON P.PRODUCT_UID = D.PRODUCT_UID AND P.DEPARTMENT_ID = IM.DEPARTMENT_ID            
  JOIN SECTIOND SD ON SD.SUB_SECTION_CODE =ARTCOM.SUB_SECTION_CODE                                                     
  WHERE (@CAC_CODE='' OR AG.AC_CODE=@CAC_CODE) AND
  IM.CANCELLED=0
  --AND REF_PRD_WORKORDER_MEMOID='HO0111700000HO00000006'
  GROUP BY ARTCOM.ARTICLE_NO,D.REF_PRD_WORKORDER_MEMOID,BOM.[AVG_QTY],
  SD.SUB_SECTION_NAME,AG.AGENCY_NAME
  
  --EXEC  SP_WO_COMPONENT_DETAILS 'HO0111700000HO00000253'
  IF OBJECT_ID ('TEMPDB..#TMPREC','U')  IS NOT NULL
     DROP TABLE #TMPREC
     
  SELECT 'RECEIVE' AS XN_TYPE,
  T3.ARTICLE_NO AS COMPONENT,
  T1.REF_PRD_WORKORDER_MEMOID AS ORDER_ID,
  SUM(T4.QUANTITY) AS REC_QTY,
  BOM.[AVG_QTY] AS REC_AVG_QTY,
  CONVERT(NUMERIC(12,3),CASE WHEN BOM.[AVG_QTY]<>0 THEN SUM(T4.QUANTITY)/ BOM.[AVG_QTY] ELSE 0 END )  AS COMP_REC_QUANTITY
  ,'PCS' AS ORDER_PCS,
  SD.SUB_SECTION_NAME  AS ITEM_NAME,
  AG.AGENCY_NAME  AS AGENCY_NAME
  INTO #TMPREC
  FROM PRD_AGENCY_ISSUE_MATERIAL_DET T1                 
  JOIN ARTICLE T2 ON T1.ARTICLE_CODE = T2.ARTICLE_CODE                
  JOIN UOM ON T2.UOM_CODE = UOM.UOM_CODE                
  JOIN PRD_SKU SKU ON SKU.PRODUCT_UID=T1.PRODUCT_UID             
  JOIN PARA1 ON SKU.PARA1_CODE = PARA1.PARA1_CODE                 
  JOIN PARA2 ON SKU.PARA2_CODE = PARA2.PARA2_CODE                 
  JOIN ARTICLE T3 ON T1.REF_COMPONENT_ARTICLE_CODE = T3.ARTICLE_CODE  
  JOIN SECTIOND SD ON SD.SUB_SECTION_CODE =T3.SUB_SECTION_CODE                
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST T5 ON T5.MEMO_ID=T1.MEMO_ID 
  JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE =T5.REF_AGENCY_CODE 
  JOIN
  (
	 SELECT AR1.ARTICLE_CODE, AR1.ARTICLE_NO, B.MEMO_ID AS ORDER_ID,SUM(AVG_QTY) AS AVG_QTY       
	 FROM PRD_WO_ART_BOM A (NOLOCK)      
	 JOIN  PRD_WO_DET B (NOLOCK) ON A.REF_ROW_ID = B.ROW_ID      
	 JOIN ARTICLE AR1 ON AR1.ARTICLE_CODE =B.ARTICLE_CODE                 
	 --WHERE B.MEMO_ID = 'HO0111700000HO00000006'  
	 GROUP BY AR1.ARTICLE_CODE, AR1.ARTICLE_NO, B.MEMO_ID
  ) BOM ON BOM.ORDER_ID=T1.REF_PRD_WORKORDER_MEMOID AND T3.ARTICLE_CODE=BOM.ARTICLE_CODE 
  LEFT JOIN           
  (           
   SELECT DT.PCS,DT.AVERAGE,DT.DEFAULT_BASIS ,DT.XN_PRODUCT_UID,DT.MEMO_ID, 
   DT.REF_ROW_ID,SUM(ISNULL(DT.QUANTITY,0)) AS QUANTITY           
   ,ISNULL(DT.[RATE],0) AS RATE            
   ,ISNULL(DT.[AMOUNT],0) AS AMOUNT,ISNULL(DT.[DISCOUNT_PER],0) AS DISCOUNT_PER          
   ,ISNULL(DT.[DISCOUNT_AMOUNT],0) AS DISCOUNT_AMOUNT,ISNULL(DT.[NET_AMOUNT],0) AS NET_AMOUNT, DT.CHALLAN_NO 
   ,DT.MANUAL_AMOUNT
   ,DT.MANUAL_RATE         
   FROM PRD_AGENCY_MATERIAL_RECEIPT_DET DT          
   LEFT OUTER JOIN PRD_AGENCY_ISSUE_MATERIAL_DET T11 ON DT.REF_ROW_ID=T11.ROW_ID             
   GROUP BY DT.PCS,DT.AVERAGE,DT.DEFAULT_BASIS, DT.XN_PRODUCT_UID,DT.REF_ROW_ID,DT.MEMO_ID ,DT.RATE, DT.AMOUNT , DT.DISCOUNT_PER,DT.DISCOUNT_AMOUNT,DT.NET_AMOUNT, DT.CHALLAN_NO
    ,DT.MANUAL_AMOUNT,DT.MANUAL_RATE 
  ) T4 ON T4.REF_ROW_ID=T1.ROW_ID  
  LEFT JOIN DEFAULT_BASIS_MASTER DM (NOLOCK) ON DM.DEFAULT_BASIS_VALUE =T4.DEFAULT_BASIS        
  WHERE (@CAC_CODE='' OR AG.AC_CODE=@CAC_CODE) AND
   T5.CANCELLED=0
  GROUP BY T3.ARTICLE_NO ,
  T1.REF_PRD_WORKORDER_MEMOID,
  BOM.[AVG_QTY],
  SD.SUB_SECTION_NAME ,AG.AGENCY_NAME
  
  SELECT A.AGENCY_NAME ,A.ITEM_NAME, A.COMPONENT,A.ORDER_ID ,RIGHT(A.ORDER_ID,10) AS ORDER_NO ,
  A.ISSU_QTY,
  A.AVG_QTY,
  B.REC_QTY,
  B.REC_AVG_QTY,
  COMP_ISS_QUANTITY,
  COMP_REC_QUANTITY,
  COMP_ISS_QUANTITY-ISNULL(COMP_REC_QUANTITY,0) AS BAL_QTY
  FROM #TMPISSUE A
  LEFT OUTER JOIN #TMPREC B ON A.AGENCY_NAME=B.AGENCY_NAME AND A.ITEM_NAME=B.ITEM_NAME AND A.COMPONENT=B.COMPONENT AND A.ORDER_ID=B.ORDER_ID
  WHERE (@NCLOSING_BALANCE=0 OR COMP_ISS_QUANTITY-ISNULL(COMP_REC_QUANTITY,0)>0)
  ORDER BY A.AGENCY_NAME,A.COMPONENT
  
  END
