CREATE PROCEDURE SP_EMP_CALCSALARYDAYS
@CEMPID VARCHAR(20)='',
@CREFID VARCHAR(20)='',
@DFROMDT DATETIME,
@DTODT DATETIME,
@NHALFDAYCNT INT='',
@NSALARYDAYS NUMERIC(10,2) OUTPUT,
@NOPSLEAVECR NUMERIC(10,2) OUTPUT
AS
BEGIN
	DECLARE @NABSENTDAYS NUMERIC(10,2),@DJOININGDATE DATETIME,@DLEAVINGDATE DATETIME,@NMONTHDAYS INT,@NOPSLEAVECR1 NUMERIC(6,2),
	@NOPSLEAVECR2 NUMERIC(6,2),@CWEEKLYOFF VARCHAR(20),@NFESTIVALOFF INT,@NWEEKLYOFF INT,
	@CEMPLOCID VARCHAR(5),@DPAYSLIPDT DATETIME,@NABSENTMARKDAYS NUMERIC(10,2),@NWEEKLYOFFLESS INT,@NFULLDAYMARKED NUMERIC(10,2)

	DECLARE @TDAYS TABLE (MONTH_DT DATETIME)  
	
	IF @CEMPID='' AND @CREFID<>''
		SELECT @CEMPID=EMP_ID FROM EMP_MST (NOLOCK) WHERE REF_ID=@CREFID
			                    	
	SELECT @DJOININGDATE=DATE_OF_JOINING,@DLEAVINGDATE=LEAVING_DATE,@CWEEKLYOFF=WEEKLY_OFF1,@CEMPLOCID=DEPT_ID FROM EMP_MST 
    WHERE EMP_ID=@CEMPID       
	

	IF @DJOININGDATE>@DFROMDT                      
		  SET @DFROMDT=@DJOININGDATE
	 
	IF @DLEAVINGDATE<@DTODT AND @DLEAVINGDATE<>''
		SET @DTODT=@DLEAVINGDATE-1

	SELECT @NMONTHDAYS=DATEDIFF(DD,@DFROMDT,@DTODT)+1
	

	SELECT @DPAYSLIPDT=@DFROMDT
	                       
	WHILE @DPAYSLIPDT <= @DTODT                      
	BEGIN                      
		  INSERT @TDAYS                      
		  SELECT @DPAYSLIPDT                      
		                        
		  SET @DPAYSLIPDT=@DPAYSLIPDT+1                      
	END                       


     IF OBJECT_ID('TEMPDB..#TMPATTENDANCE','U') IS  NULL
		SELECT * INTO #TMPATTENDANCE FROM  EMP_ATTENDANCE WHERE EMP_ID=@CEMPID	AND ATTENDANCE_DT BETWEEN @DFROMDT AND @DTODT 
     
	 
	SELECT @NABSENTDAYS=COUNT(*) FROM  @TDAYS WHERE MONTH_DT NOT IN (SELECT ATTENDANCE_DT FROM #TMPATTENDANCE WHERE EMP_ID=@CEMPID
	AND ATTENDANCE_DT BETWEEN @DFROMDT AND @DTODT  AND ( TIME_IN<>'' AND TIME_OUT<>''))

	--SELECT @NABSENTDAYS

	SELECT @NABSENTMARKDAYS=COUNT(DISTINCT ATTENDANCE_DT) FROM  #TMPATTENDANCE WHERE EMP_ID=@CEMPID
	AND ATTENDANCE_DT BETWEEN @DFROMDT AND @DTODT  AND TIME_IN='' AND TIME_OUT='' AND LOG_ABSENT_STATUS=2
	
	SELECT @NFULLDAYMARKED=COUNT(*) FROM #TMPATTENDANCE A (NOLOCK)  JOIN EMP_SHIFTS B (NOLOCK) ON A.SHIFT_ID=B.SHIFT_ID                      
	WHERE EMP_ID=@CEMPID AND ATTENDANCE_DT BETWEEN @DFROMDT AND @DTODT AND (A.TIME_IN > B.HALFDAY_CUTOFF 
	OR A.TIME_OUT < B.HALFDAY_CUTOFF) AND TIME_IN<>'' AND TIME_OUT<>''
	
--SELECT @NABSENTDAYS,@NABSENTMARKDAYS,@NFULLDAYMARKED

	SET @NABSENTDAYS=@NABSENTDAYS-@NABSENTMARKDAYS+(@NHALFDAYCNT/2.00)+ISNULL(@NFULLDAYMARKED,0)
	

	IF @NABSENTDAYS>0
	BEGIN
		SELECT @NWEEKLYOFF=COUNT(*) FROM   #TMPATTENDANCE WHERE EMP_ID=@CEMPID
		AND ATTENDANCE_DT BETWEEN @DFROMDT AND @DTODT AND DATENAME(W,ATTENDANCE_DT)=@CWEEKLYOFF
		
		SELECT @NWEEKLYOFFLESS=COUNT(*) FROM   #TMPATTENDANCE WHERE EMP_ID=@CEMPID
		AND ATTENDANCE_DT BETWEEN @DFROMDT AND @DTODT AND
		(DATENAME(W,ATTENDANCE_DT)=@CWEEKLYOFF OR ATTENDANCE_DT IN 
		(SELECT LEAVE_DT FROM FESTIVAL_LEAVES WHERE LOCATION_ID=@CEMPLOCID))
		AND (TIME_IN='' OR TIME_OUT='') AND DATEADD(DD,-1,ATTENDANCE_DT)  IN 
		(SELECT A.ATTENDANCE_DT FROM #TMPATTENDANCE A LEFT OUTER JOIN 
		 FESTIVAL_LEAVES B ON B.LEAVE_DT=A.ATTENDANCE_DT AND B.LOCATION_ID=@CEMPLOCID                   
		 WHERE EMP_ID=@CEMPID AND ATTENDANCE_DT BETWEEN @DFROMDT AND @DTODT AND (TIME_IN='' OR TIME_OUT='')
		 AND B.LEAVE_DT IS NULL )
		AND DATEADD(DD,1,ATTENDANCE_DT)  IN 
		(SELECT A.ATTENDANCE_DT FROM #TMPATTENDANCE A LEFT OUTER JOIN 
		 FESTIVAL_LEAVES B ON B.LEAVE_DT=A.ATTENDANCE_DT AND B.LOCATION_ID=@CEMPLOCID                   
		 WHERE EMP_ID=@CEMPID AND ATTENDANCE_DT BETWEEN @DFROMDT AND @DTODT AND (TIME_IN='' OR TIME_OUT='')
		 AND B.LEAVE_DT IS NULL)		
		
		--SELECT @NWEEKLYOFF,@NWEEKLYOFFLES

		SET @NABSENTDAYS=@NABSENTDAYS-@NWEEKLYOFF+@NWEEKLYOFFLESS

	END

	IF @NABSENTDAYS>0
	BEGIN
		SELECT @NFESTIVALOFF=COUNT(*) FROM FESTIVAL_LEAVES                       
		WHERE LOCATION_ID=@CEMPLOCID AND LEAVE_DT BETWEEN @DFROMDT AND @DTODT

		SET @NABSENTDAYS=@NABSENTDAYS-@NFESTIVALOFF

	END

	SELECT @NOPSLEAVECR1 = OB+CURRENT_MONTH_LEAVES_CR-FULL_LEAVES_DR-CONVERT(NUMERIC(10,2),(HALF_LEAVES_DR/2))-                      
			 CONVERT(NUMERIC(10,2),(SHORT_LEAVES_DR/4))                      
	FROM EMP_LEAVES_SUMMARY WHERE EMP_ID = @CEMPID AND XN_DT=DATEADD(M,-1,@DFROMDT)                      
	 		 
	SELECT @NOPSLEAVECR2 = CF_MONTH_LEAVES_CR FROM EMP_LEAVES_SUMMARY WHERE EMP_ID = @CEMPID                      
	AND XN_DT=DATEADD(M,-1,@DFROMDT)                      
	                       
	SET @NOPSLEAVECR=(CASE WHEN ISNULL(@NOPSLEAVECR1,0)<0 THEN 0 ELSE ISNULL(@NOPSLEAVECR1,0) END)+                      
		  ISNULL(@NOPSLEAVECR2,0)         
	                  
	SET @NOPSLEAVECR=(CASE WHEN ISNULL(@NOPSLEAVECR,0)<0 THEN 0 ELSE ISNULL(@NOPSLEAVECR,0) END)                     

	
	IF @NABSENTDAYS>0
		 SET @NABSENTDAYS=@NABSENTDAYS-@NOPSLEAVECR
	
--SELECT @NABSENTDAYS AS FINAL_ABSENT_DAYS,@NMONTHDAYS
	SET @NSALARYDAYS=@NMONTHDAYS-(CASE WHEN @NABSENTDAYS>0 THEN @NABSENTDAYS ELSE 0 END)-@NABSENTMARKDAYS 
	 
END
