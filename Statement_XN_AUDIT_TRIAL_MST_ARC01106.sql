
DELETE FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='ARC'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='ARC' AND TABLE_NAME='ARC01106' AND FIELD_NAME='customer_code') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'ARC','ARC01106','','customer_code','','UPDATE','AC customer_code'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='ARC' AND TABLE_NAME='ARC01106' AND FIELD_NAME='DISCOUNT_PERCENTAGE') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'ARC','ARC01106','','DISCOUNT_PERCENTAGE','','UPDATE','DISC %'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='ARC' AND TABLE_NAME='ARC01106' AND FIELD_NAME='DISCOUNT_AMOUNT') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'ARC','ARC01106','','DISCOUNT_AMOUNT','','UPDATE','DISC AMT'

IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='ARC' AND TABLE_NAME='ARC01106' AND FIELD_NAME='AMOUNT') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'ARC','ARC01106','','AMOUNT','','UPDATE','AMOUNT'

IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='ARC' AND TABLE_NAME='ARC01106' AND FIELD_NAME='NET_AMOUNT') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'ARC','ARC01106','','NET_AMOUNT','','UPDATE','NET AMOUNT'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='ARC' AND TABLE_NAME='ARC01106' AND FIELD_NAME='CANCELLED') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'ARC','ARC01106','','CANCELLED','','UPDATE','CANCELLED'
IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='ARC' AND TABLE_NAME='ARC01106' AND FIELD_NAME='ADV_REC_DT') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'ARC','ARC01106','','ADV_REC_DT','','UPDATE','ADV_REC_DT'

 IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='ARC' AND TABLE_NAME='ARC01106' AND FIELD_NAME='CARD_NO') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'ARC','ARC01106','','CARD_NO','','UPDATE','ADV_REC_DT'

IF NOT EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE XN_TYPE='ARC' AND TABLE_NAME='ARC01106' AND FIELD_NAME='card_issue_dt') 
   INSERT INTO XN_AUDIT_TRIAL_MST (XN_TYPE,TABLE_NAME,KEY_FIELDS,FIELD_NAME,DATA_TYPE,TRIG,FRIENDLY_COL) SELECT 'ARC','ARC01106','','card_issue_dt','','UPDATE','ADV_REC_DT'
   
   
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=1 WHERE TABLE_NAME='ARC01106' AND FIELD_NAME='NET_AMOUNT'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=2 WHERE TABLE_NAME='ARC01106' AND FIELD_NAME='CUSTOMER_CODE'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=3 WHERE TABLE_NAME='ARC01106' AND FIELD_NAME LIKE 'DISC%'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=4 WHERE TABLE_NAME='ARC01106' AND FIELD_NAME='CANCELLED'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=5 WHERE TABLE_NAME='ARC01106' AND FIELD_NAME='ADV_REC_DT'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=6 WHERE TABLE_NAME='ARC01106' AND FIELD_NAME='Amount'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=9 WHERE TABLE_NAME='ARC01106' AND FIELD_NAME='CARD_NO'
UPDATE XN_AUDIT_TRIAL_MST SET ORDER_ID=10 WHERE TABLE_NAME='ARC01106' AND FIELD_NAME='card_issue_dt'


UPDATE XN_AUDIT_TRIAL_MST SET TRIG=UPPER(TRIG) where XN_TYPE='ARC'

UPDATE X SET X.DATA_TYPE=C.DATA_TYPE
FROM XN_AUDIT_TRIAL_MST X 
JOIN INFORMATION_SCHEMA.COLUMNS C ON C.TABLE_NAME=X.TABLE_NAME AND C.COLUMN_NAME=X.FIELD_NAME
WHERE TRIG='UPDATE' and XN_TYPE='ARC'


IF OBJECT_ID('TEMPDB..#PKEY','U') IS NOT NULL
   DROP TABLE #PKEY
SELECT DISTINCT X.TABLE_NAME,COL.COLUMN_NAME,COL.ORDINAL_POSITION
INTO #PKEY
FROM XN_AUDIT_TRIAL_MST X (ROWLOCK) 
JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS PK
JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE COL ON PK.TABLE_NAME=COL.TABLE_NAME AND PK.CONSTRAINT_NAME=COL.CONSTRAINT_NAME AND PK.CONSTRAINT_TYPE='PRIMARY KEY'
ON X.TABLE_NAME=PK.TABLE_NAME
WHERE XN_TYPE ='ARC'
DECLARE @TAB VARCHAR(100),@KEY VARCHAR(1000)
IF CURSOR_STATUS('GLOBAL','PKEY') IN (0,1)
   BEGIN
     CLOSE PKEY
	 DEALLOCATE PKEY
   END
DECLARE PKEY CURSOR FOR SELECT DISTINCT TABLE_NAME FROM #PKEY
OPEN PKEY
FETCH NEXT FROM PKEY INTO @TAB
WHILE @@FETCH_STATUS=0
  BEGIN
    SET @KEY='' 
    SELECT @KEY=COALESCE('',@KEY)+COLUMN_NAME+'+' FROM #PKEY WHERE TABLE_NAME=@TAB ORDER BY ORDINAL_POSITION
    UPDATE XN_AUDIT_TRIAL_MST SET KEY_FIELDS=UPPER(@KEY) WHERE TABLE_NAME=@TAB
    FETCH NEXT FROM PKEY INTO @TAB
  END
CLOSE PKEY
DEALLOCATE PKEY


IF EXISTS(SELECT * FROM XN_AUDIT_TRIAL_MST WHERE TABLE_NAME='ARC01106' AND XN_TYPE='ARC' AND KEY_FIELDS='' AND TRIG='UPDATE')
   UPDATE XN_AUDIT_TRIAL_MST SET KEY_FIELDS='ADV_REC_ID+' WHERE TABLE_NAME='ARC01106' AND XN_TYPE='ARC' AND TRIG='UPDATE'




   