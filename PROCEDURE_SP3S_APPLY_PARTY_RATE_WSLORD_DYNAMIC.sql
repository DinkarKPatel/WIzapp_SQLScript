CREATE PROCEDURE SP3S_APPLY_PARTY_RATE_WSLORD_DYNAMIC--(LocId 3 digit change by Sanjay:06-11-2024)
(
   @NSPID INT,
   @cAcCode CHAR(10)='',
   @cSourceLocId VARCHAR(5)='',
   @cTargetLocId VARCHAR(5)='',
   @bExcelImport BIT=0,
   @bCalledFromAro BIT=0
 )   
----WITH ENCRYPTION
AS
BEGIN
	PRINT 'ENTER PARTY RATE NEW WITH buyer order'
    DECLARE @CERRMSG VARCHAR(MAX),@CARTICLE_CODE VARCHAR(100),@CPARA1_CODE VARCHAR(100),@CPARA2_CODE VARCHAR(100),
    @CPARA3_CODE VARCHAR(100),@CPARA4_CODE VARCHAR(100),@CPARA5_CODE VARCHAR(100),@CPARA6_CODE VARCHAR(100),
    @CPARTYRATEMEMOID VARCHAR(100),@CCMD NVARCHAR(MAX),@NBASE_PRICE NUMERIC(18,2),@NCAL_MODE INT,
    @NDISCOUNT_PERCENTAGE NUMERIC(18,2),@NRATE NUMERIC(18,2),@NDISCOUNT_AMOUNT NUMERIC(18,2),
    @NNETRATE NUMERIC(18,2),@GIVE_CREDIT_VAT INT,@VAT_PER NUMERIC(18,2),@CMEMO_DT DATETIME,@bPartyRateFound BIT,
    @VAT_AMOUNT NUMERIC(18,2),@PARTY_FINAL_MARGIN NUMERIC(18,2),@GROSS_SALE NUMERIC(18,2),@BMRPRANGEBASEDMEMO BIT,
    @VAT_EX_AMOUNT NUMERIC(18,2),@CFILTER_EXP VARCHAR(2000),@bDynamicPartyRateFound BIT,@CROWID VARCHAR(40),
	@CSTEP VARCHAR(5)
    
     DECLARE @CPARTYRATEFILTER VARCHAR(1000),@CTERMSCODE VARCHAR(20),@NCUSTOMRATETYPE INT,
      @NDEFAULTRATETYPE INT,@BENABLEEXCISDUTY BIT,@nPartyRateMode NUMERIC(1,0),
      @BCUSTOMPROCEXISTS BIT,@CUTERRORMSG VARCHAR(MAX),@CTERRMSG VARCHAR(MAX),
      @CERRPC VARCHAR(50),@NINVTYPE INT,@NBILLLEVELTAXMETHOD INT,@NRATEPICKINGMETHOD INT,
      @NPARTYDISCPCT NUMERIC(7,3),@CPRODUCTCODE VARCHAR(50),@BPARTYRATEFILTERAPPLICABLE BIT,@BDONOTCALEXCISE BIT,
      @NCALMODE INT,@NLOTPRICE NUMERIC(10,2),@NXFERTYPE INT,@CROUNDNETRATE VARCHAR(4),
      @CCURLOCID VARCHAR(5),@BGSTBILL BIT,@DINVDT DATETIME,@CPARTYSTATECODE CHAR(7),@BGROUPINV BIT,
      @XN_ITEM_TYPE NUMERIC(2,0),@cuser_code varchar(10),@cDynamicColList VARCHAR(2000),
	  @CERRORMSG VARCHAR(MAX) ,@bPartyRateDetNotFound BIT
	  
	  
    
BEGIN TRY              
    SET @CSTEP='10'           
	SET @CERRMSG=''
	SET @bPartyRateDetNotFound=0

	IF @cTargetLocId=''
		SELECT TOP 1 @nPartyRateMode=ISNULL(party_rate_mode,2),@CPARTYRATEMEMOID=MEMO_ID,@CMEMO_DT=MEMO_DT,@BMRPRANGEBASEDMEMO=ISNULL(MRP_RANGE_BASED_MEMO,0) 
		FROM PARTY_RATE_MST A
		JOIN LMP01106 B (nolock) ON a.MEMO_ID=b.PARTY_RATE_MEMO_ID
		WHERE B.ac_code=@cAcCode
	ELSE
		SELECT TOP 1 @nPartyRateMode=ISNULL(party_rate_mode,2),@CPARTYRATEMEMOID=MEMO_ID,@CMEMO_DT=MEMO_DT,@BMRPRANGEBASEDMEMO=ISNULL(MRP_RANGE_BASED_MEMO,0) 
		FROM PARTY_RATE_MST A
		JOIN loc_billing_rules b ON A.MEMO_ID=b.PARTY_RATE_MEMO_ID
		WHERE b.source_dept_id=@cSourceLocId and target_dept_id=@cTargetLocId
	
	IF @cPartyRateMemoId IS NOT NULL
		SET @bPartyRateFound=1
	ELSE
		SET @bPartyRateFound=0

	SET @CSTEP=15
	SELECT * INTO #TMPPRATEDET FROM PARTY_RATE_DET WHERE MEMO_ID=@CPARTYRATEMEMOID
	SELECT * INTO #TMPPRATEMST FROM PARTY_RATE_MST WHERE MEMO_ID=@CPARTYRATEMEMOID

	SET @CSTEP=20
	--IF @bExcelImport=1(need to chnage front end )
	--	UPDATE wsl_item_details WITH (ROWLOCK) SET manual_rate=1 WHERE sp_id=@nSpId AND ISNULL(rate,0)<>0
		
	IF NOT EXISTS (SELECT TOP 1 'U' FROM #TMPPRATEDET)
	BEGIN
		SET @CSTEP='30'           		
		IF @cTargetLocId=''
			SELECT TOP 1 @NDEFAULTRATETYPE=COALESCE(c.MST_BASE_PRICE,1),
			 @NPARTYDISCPCT=(CASE WHEN ISNULL(DISCOUNT_PICKING_MODE,0)=2 THEN 0 ELSE ISNULL(c.mst_value,0) END),
			 @NCALMODE=ISNULL(MST_CAL_MODE,0)
			  FROM lmp01106 A (NOLOCK)
			  LEFT OUTER JOIN 
			  (SELECT MEMO_ID,MST_BASE_PRICE,DISCOUNT_PICKING_MODE,MST_CAL_MODE,mst_value 
			   FROM PARTY_RATE_MST WHERE MEMO_ID=@CPARTYRATEMEMOID) C ON C.MEMO_ID=A.PARTY_RATE_MEMO_ID
			  WHERE A.AC_CODE=@cAcCode
		ELSE
			SELECT TOP 1 @NDEFAULTRATETYPE=COALESCE(c.MST_BASE_PRICE,1),
			 @NPARTYDISCPCT=(CASE WHEN ISNULL(DISCOUNT_PICKING_MODE,0)=2 THEN 0 ELSE ISNULL(c.mst_value,0) END),
			 @NCALMODE=ISNULL(MST_CAL_MODE,0)
			  FROM location A (NOLOCK)
			  LEFT OUTER JOIN 
			  (SELECT MEMO_ID,MST_BASE_PRICE,DISCOUNT_PICKING_MODE,MST_CAL_MODE,mst_value 
			   FROM PARTY_RATE_MST WHERE MEMO_ID=@CPARTYRATEMEMOID) C ON 1=1
			  WHERE A.dept_id=@cTargetLocId
		
		SET @CSTEP='40'           
		  print 'update base rate-1'

		 
	     UPDATE A SET  PARTY_RATE_BASE_PRICE=@NDEFAULTRATETYPE,
		  DISCOUNT_AMOUNT=0,DISCOUNT_PERCENTAGE=ISNULL(@NPARTYDISCPCT,0)*
		  (CASE WHEN ISNULL(@NCALMODE,3)=1 THEN -1 ELSE 1 END)
			  ,HSN_CODE=ARTICLE.HSN_CODE
		  FROM WSL_ITEM_DETAILS A 	  
		  LEFT JOIN ARTICLE  (NOLOCK) ON A.ARTICLE_CODE =ARTICLE.ARTICLE_CODE	
		  WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 
		 
	      
	END

	print 'check party ratemode:'+str(isnull(@nPartyRateMode,0))

	SET @CFILTER_EXP=''
	IF @nPartyRateMode IN (1,3)
	BEGIN
		SET @CSTEP=50				
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEMST WHERE SHOW_ARTICLE=1)
			SET @CFILTER_EXP=@CFILTER_EXP+' ARTICLE.ARTICLE_CODE=PR.ARTICLE_CODE'	
		
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEMST WHERE SHOW_PARA1=1)
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA1_CODE=PR.PARA1_CODE' 
		
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEMST WHERE SHOW_PARA2=1)
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA2_CODE=PR.PARA2_CODE' 
		
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEMST WHERE SHOW_PARA3=1)
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA3_CODE=PR.PARA3_CODE' 
		
		SET @CSTEP=55
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEMST WHERE SHOW_PARA4=1)
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA4_CODE=PR.PARA4_CODE' 
							 
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEMST WHERE SHOW_PARA5=1)
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA5_CODE=PR.PARA5_CODE' 
							 
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEMST WHERE SHOW_PARA6=1)
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.PARA6_CODE=PR.PARA6_CODE' 
		
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEMST WHERE SHOW_SECTION=1)
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' SECTIONM.SECTION_CODE=PR.SECTION_CODE'			

		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEMST WHERE SHOW_SUB_SECTION=1)
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' SECTIOND.SUB_SECTION_CODE=PR.SUB_SECTION_CODE'						
		
		IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEMST WHERE SHOW_hsn=1)
			SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' ARTICLE.HSN_CODE=PR.HSN_CODE'						
	END		
	
	IF EXISTS (SELECT TOP 1 * FROM #TMPPRATEDET) AND @nPartyRateMode IN (1,3)
	BEGIN
		
		SET @bDynamicPartyRateFound=1
		SET @CSTEP=60
		IF @CFILTER_EXP=''
			SET @CFILTER_EXP='1=1'

		SET @CCMD=N'UPDATE A SET PARTY_RATE_BASE_PRICE=PR.BASE_PRICE,PARTY_RATE_CAL_MODE=PR.CAL_MODE,
					DISCOUNT_PERCENTAGE=(CASE WHEN ISNULL(PR.CAL_MODE,3)=1 THEN PR.VALUE*-1 WHEN ISNULL(PR.CAL_MODE,3)=2 THEN PR.VALUE
					 ELSE 0 END),RATE=(CASE WHEN ISNULL(PR.CAL_MODE,3)=3 THEN PR.VALUE ELSE 0 END)
					FROM WSL_ITEM_DETAILS A 
					JOIN ARTICLE  (NOLOCK) ON A.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
					JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
					JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
					JOIN #TMPPRATEDET PR (NOLOCK) ON '+@CFILTER_EXP+
					' WHERE A.SP_ID='+LTRIM(RTRIM(STR(@NSPID)))+' AND MEMO_ID='''+@CPARTYRATEMEMOID+''''+
					(CASE WHEN @BMRPRANGEBASEDMEMO=1 THEN ' AND ARTICLE.MRP BETWEEN PR.FROM_MRP AND PR.TO_MRP ' ELSE '' END)+
					' AND ISNULL(MANUAL_RATE,0)=0'
		
		PRINT ISNULL(@CCMD,'NULL PARTYRATE EXPR ')							
		EXEC SP_EXECUTESQL @CCMD

	END
	
	IF @bDynamicPartyRateFound=1
	BEGIN
		SET @CSTEP='70' 
	
		SELECT @cDynamicColList=ISNULL(@cDynamicColList,'')+
			(CASE WHEN charindex('product_code',@CFILTER_EXP)>0 THEN  ',a.product_code' ELSE '' END)+
			(CASE WHEN charindex('SECTION_CODE',@CFILTER_EXP)>0 THEN  ',SECTIONM.section_name' ELSE '' END)+
			(CASE WHEN charindex('SUB_SECTION_CODE',@CFILTER_EXP)>0 THEN  ',SECTIOND.sub_section_name ' ELSE '' END)+
			(CASE WHEN charindex('ARTICLE_CODE',@CFILTER_EXP)>0 THEN  ',ARTICLE.article_no ' ELSE '' END)+
			(CASE WHEN charindex('ARTICLE_CODE',@CFILTER_EXP)>0 THEN  ',ARTICLE.article_name ' ELSE '' END)+
			(CASE WHEN charindex('PARA1_CODE',@CFILTER_EXP)>0 THEN  ',a.para1_name ' ELSE '' END)+
			(CASE WHEN charindex('PARA2_CODE',@CFILTER_EXP)>0 THEN  ',a.para2_name ' ELSE '' END)+
			(CASE WHEN charindex('PARA3_CODE',@CFILTER_EXP)>0 THEN  ',a.para3_name ' ELSE '' END)+
			(CASE WHEN charindex('PARA4_CODE',@CFILTER_EXP)>0 THEN  ',a.para4_name ' ELSE '' END)+
			(CASE WHEN charindex('PARA5_CODE',@CFILTER_EXP)>0 THEN  ',a.para5_name ' ELSE '' END)+
			(CASE WHEN charindex('PARA6_CODE',@CFILTER_EXP)>0 THEN  ',a.para6_name ' ELSE '' END)



		

		IF EXISTS (SELECT TOP 1 product_code FROM WSL_ITEM_DETAILS (NOLOCK) WHERE sp_id=@nSpId AND party_rate_BASE_PRICE IS NULL)
			AND @nPartyRateMode=1 AND @bCalledFromAro=0
		BEGIN
		   
			if left(@cDynamicColList,1)=','
			   set @cDynamicColList=substring(@cDynamicColList,2,len(@cDynamicColList))

			SET @CERRORMSG='Party Rate details not found for following paras:'	
			SET @cCmd=N'SELECT DISTINCT '+@cDynamicColList+','''+@CERRORMSG+''' errmsg
						FROM  wsl_item_details a (NOLOCK)
						JOIN ARTICLE  (NOLOCK) ON A.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
					    JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
					    JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
						LEFT JOIN #TMPPRATEDET PR (NOLOCK) ON '+@CFILTER_EXP+ ' WHERE sp_id='''+ltrim(rtrim(str(@nSpId)))+'''
						AND party_rate_BASE_PRICE IS NULL '
			SET @bPartyRateDetNotFound=1
			EXEC SP_EXECUTESQL @cCmd
			print @cCmd

			
		END
	END

	SET @CSTEP=75

	

	print 'update base rate-0'		  
	UPDATE A SET  RATE=(CASE WHEN PARTY_RATE_BASE_PRICE=1 AND ISNULL(b.PRODUCT_CODE,'') NOT IN ('0000000','') 
							AND COALESCE(b.ws_price,0)>0 
							THEN COALESCE(b.ws_price,0)

							WHEN PARTY_RATE_BASE_PRICE=2  AND COALESCE(b.mrp,AD.mrp,Article.mrp, 0)>0
							THEN COALESCE(b.mrp,AD.mrp,Article.mrp,0)

					        WHEN PARTY_RATE_BASE_PRICE=3  AND COALESCE(b.pp,AD.purchase_price,Article.Purchase_price,0)>0 
							THEN COALESCE(b.pp,AD.purchase_price,Article.Purchase_price,0)

							WHEN PARTY_RATE_BASE_PRICE=1 AND COALESCE(AD.ws_price,ARTICLE.WHOLESALE_PRICE,0)>0 
							THEN COALESCE(AD.ws_price,ARTICLE.WHOLESALE_PRICE)

							ELSE ARTICLE.MRP END)
	FROM WSL_ITEM_DETAILS A 	  
	LEFT JOIN  sku_names b (NOLOCK) ON b.product_code=a.PRODUCT_CODE and b.product_Code <>''
	LEFT JOIN ARTICLE  (NOLOCK) ON A.ARTICLE_CODE =ARTICLE.ARTICLE_CODE	
	LEFT JOIN art_det ad (NOLOCK) ON ad.article_code=a.article_code AND ad.para2_code=a.para2_code
	WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0
	
	--if @@spid=81
	--	select 'check wsl item details',manual_rate, @cPartyRateMemoId ,@bPartyRateFound PartyRateFound,product_code,article_Code,para2_code,rate, ws_price,PARTY_RATE_BASE_PRICE,@bPartyRateFound, * from wsl_item_details where sp_id=@nSpId

	SET @CSTEP=80
	print 'update base rate-2'		  
	UPDATE WSL_ITEM_DETAILS SET DISCOUNT_AMOUNT=(RATE * INVOICE_QUANTITY * DISCOUNT_PERCENTAGE) / 100
	WHERE SP_ID=@NSPID

	
	SET @CSTEP=90
	print 'update base rate-5'
	UPDATE WSL_ITEM_DETAILS SET NET_RATE=RATE-(RATE * DISCOUNT_PERCENTAGE/ 100) WHERE SP_ID=@NSPID
	
	
	GOTO END_PROC
END TRY

BEGIN CATCH
	
	SET @CERRORMSG='PROCEDURE SP3S_APPLY_PARTY_RATE_WSLORD_DYNAMIC STEP#'+@CSTEP+':'+ERROR_MESSAGE()
	print 'Enter catch of SP3S_APPLY_PARTY_RATE_WSLORD_DYNAMIC'+@cErrormsg
	GOTO END_PROC
END CATCH

END_PROC:
	IF @bPartyRateDetNotFound=0
		SELECT ISNULL(@cErrormsg,'') errmsg
END
--END OF PROCEDURE - SP3S_APPLY_PARTY_RATE_WSLORD_DYNAMIC
