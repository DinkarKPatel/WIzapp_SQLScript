CREATE PROCEDURE SP3S_GETINVRATE_TERMS_GST                  
	@NSPID INT,
	@CXNTYPE VARCHAR(10)='',
	@CERRORMSG VARCHAR(MAX) OUTPUT
AS                  
BEGIN                  
  
	DECLARE @BCREDITOUTPUTVAT BIT,@NINVTYPE INT,@BCREDITPURCHASETAX BIT,@NINVMODE INT,@CTARGETLOCID VARCHAR(5),@CSTEP VARCHAR(5),
			@CREIMBURSEBASE CHAR(1),@DMEMODT DATETIME

BEGIN TRY	
	PRINT 'ENTER LEDGER TERMS PROC'
	
	SET @CSTEP=10
	IF @CXNTYPE='WSR'	
	BEGIN
		UPDATE WSL_INV_SETTINGS SET INV_TYPE=(CASE WHEN LOCAL_STATE_CODE=PARTY_STATE_CODE THEN 2 ELSE 1 END)
		WHERE SP_ID=@NSPID
	END
	
	SELECT TOP 1 @CREIMBURSEBASE=VALUE FROM CONFIG WHERE CONFIG_OPTION='LM_TERMS_REIMBURSE_BASIS'
	
	SET @CREIMBURSEBASE=ISNULL(@CREIMBURSEBASE,'')
	IF @CREIMBURSEBASE=''
		SET @CREIMBURSEBASE='1'
			
	SET @CSTEP=20
	UPDATE A SET	RATE=(CASE WHEN @CREIMBURSEBASE='2' THEN B.WS_PRICE ELSE B.MRP END) FROM 
	WSL_ITEM_DETAILS A JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE WHERE SP_ID=@NSPID	
	AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	
	SELECT TOP 1 @BCREDITOUTPUTVAT=REIMUBURSE_OUTPUT_VAT,@NINVTYPE=INV_TYPE,@BCREDITPURCHASETAX=REIMUBURSE_PURCHASE_TAX,@CTARGETLOCID=TARGET_LOCATION_ID,
	@DMEMODT=INV_DT
	FROM WSL_INV_SETTINGS WHERE SP_ID=@NSPID
	

	IF @BCREDITPURCHASETAX=1 
	BEGIN
		SET @CSTEP=30
		--- DESCARDED THIS BECAUSE OF PROBLEM COMING AT JASHN WS LOCATION FOR MAKING INVOICE FOR SIS LOCATION G8
		--- HAVING PROBLEM  IN INVOICE NO.: WSG8-16010
		--UPDATE WSL_ITEM_DETAILS SET CREDIT_CENTRAL_TAX_PCT=(CASE WHEN @NINVTYPE=2 THEN CREDIT_VAT_PERCENTAGE ELSE  
		--CHARGE_TAX_PCT END)	WHERE SP_ID=@NSPID
		
		PRINT 'ENTER CREDIT PURCHASE TAX CALC'
		IF @CREIMBURSEBASE='2'
			UPDATE A SET CREDIT_CENTRAL_TAX_PCT=(CASE WHEN (SKU.WS_PRICE-(SKU.WS_PRICE*HSN.RATE_CUTOFF_TAX_PERCENTAGE/(100+RATE_CUTOFF_TAX_PERCENTAGE)))<HSN.RATE_CUTOFF
			THEN HSN.RATE_CUTOFF_TAX_PERCENTAGE ELSE HSN.TAX_PERCENTAGE END) FROM WSL_ITEM_DETAILS A 
			JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
			JOIN ARTICLE B ON B.ARTICLE_CODE=SKU.ARTICLE_CODE
			--JOIN SECTIOND SD ON SD.SUB_SECTION_CODE=B.SUB_SECTION_CODE
			JOIN WSL_INV_SETTINGS C ON A.SP_ID=C.SP_ID
			LEFT JOIN HSN_DET HSN ON B.HSN_CODE=HSN.HSN_CODE
			WHERE A.SP_ID=@NSPID 
			AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
			AND HSN.WEF=(SELECT TOP 1 D.WEF FROM HSN_DET D  WHERE D.HSN_CODE=HSN.HSN_CODE 
						 AND D.WEF<=@DMEMODT ORDER BY WEF DESC)	
						
		ELSE
			UPDATE A SET CREDIT_CENTRAL_TAX_PCT=(CASE WHEN (A.MRP-(A.MRP*HSN.RATE_CUTOFF_TAX_PERCENTAGE/(100+RATE_CUTOFF_TAX_PERCENTAGE)))<HSN.RATE_CUTOFF
			THEN HSN.RATE_CUTOFF_TAX_PERCENTAGE ELSE HSN.TAX_PERCENTAGE END) FROM WSL_ITEM_DETAILS A 
			JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
			JOIN ARTICLE B ON B.ARTICLE_CODE=SKU.ARTICLE_CODE
			
			LEFT JOIN HSN_DET HSN ON HSN.HSN_CODE=B.HSN_CODE
			JOIN WSL_INV_SETTINGS C ON A.SP_ID=C.SP_ID
			WHERE A.SP_ID=@NSPID 
			AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
			AND HSN.WEF=(SELECT TOP 1 D.WEF FROM HSN_DET D WHERE D.HSN_CODE=HSN.HSN_CODE 
						 AND D.WEF<=@DMEMODT ORDER BY WEF DESC)					
						 
		UPDATE A SET CREDIT_PURCHASE_TAX_PCT=CREDIT_CENTRAL_TAX_PCT 
		FROM WSL_ITEM_DETAILS A
		JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
		WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	END	
	ELSE
	BEGIN
		SET @CSTEP=40
		UPDATE WSL_ITEM_DETAILS SET CREDIT_PURCHASE_TAX_PCT=0 WHERE SP_ID=@NSPID
		AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	END	
	

	SET @CSTEP=45
	IF @CREIMBURSEBASE='2'
		UPDATE A SET PARTY_FINAL_MARGIN=WS_PRICE-((WS_PRICE*TERMS_DISC_PCT/100)+(WS_PRICE*CREDIT_PURCHASE_TAX_PCT/(100+CREDIT_PURCHASE_TAX_PCT)))
		FROM WSL_ITEM_DETAILS A
		JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
		WHERE A.SP_ID=@NSPID 
	ELSE
		UPDATE A SET PARTY_FINAL_MARGIN=MRP-((MRP*TERMS_DISC_PCT/100)+(MRP*CREDIT_PURCHASE_TAX_PCT/(100+CREDIT_PURCHASE_TAX_PCT)))
		FROM WSL_ITEM_DETAILS A
		JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
		WHERE A.SP_ID=@NSPID 

	
	IF @BCREDITOUTPUTVAT=1
	BEGIN
	
		SET @CSTEP=50
		UPDATE A SET CREDIT_VAT_PERCENTAGE=(CASE WHEN (A.PARTY_FINAL_MARGIN-(A.PARTY_FINAL_MARGIN*HSN.RATE_CUTOFF_TAX_PERCENTAGE/(100+RATE_CUTOFF_TAX_PERCENTAGE)))<HSN.RATE_CUTOFF
		THEN HSN.RATE_CUTOFF_TAX_PERCENTAGE ELSE HSN.TAX_PERCENTAGE END) FROM WSL_ITEM_DETAILS A
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE
		JOIN ARTICLE B ON B.ARTICLE_CODE=SKU.ARTICLE_CODE
		
		LEFT JOIN HSN_DET HSN ON HSN.HSN_CODE=B.HSN_CODE
		JOIN WSL_INV_SETTINGS C ON A.SP_ID=C.SP_ID
		WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
		AND HSN.WEF=(SELECT TOP 1 D.WEF FROM HSN_DET D  WHERE D.HSN_CODE=HSN.HSN_CODE 
					 AND D.WEF<=@DMEMODT ORDER BY WEF DESC)			
		SET @CSTEP=60
		UPDATE A SET CREDIT_VAT_AMOUNT=PARTY_FINAL_MARGIN*CREDIT_VAT_PERCENTAGE/(100+CREDIT_VAT_PERCENTAGE)	
		FROM WSL_ITEM_DETAILS A JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
		WHERE A.SP_ID=@NSPID 
		AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	END
	
	SET @CSTEP=70
	
	UPDATE A SET PARTY_FINAL_MARGIN=PARTY_FINAL_MARGIN-ISNULL(CREDIT_VAT_AMOUNT,0)
	FROM WSL_ITEM_DETAILS A
	JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
	WHERE A.SP_ID=@NSPID 
	
	SET @CSTEP=80
	IF @CREIMBURSEBASE='2'
		UPDATE A SET DISCOUNT_PERCENTAGE=100-CASE ISNULL(WS_PRICE,0) WHEN 0 THEN 0 ELSE (ROUND((PARTY_FINAL_MARGIN/WS_PRICE)*100,2)) END
		FROM WSL_ITEM_DETAILS A
		JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
		WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	ELSE
		UPDATE A SET DISCOUNT_PERCENTAGE=100-CASE ISNULL(MRP,0) WHEN 0 THEN 0 ELSE (ROUND((PARTY_FINAL_MARGIN/MRP)*100,2)) END
		FROM WSL_ITEM_DETAILS A
		JOIN WSL_INV_SETTINGS B ON A.SP_ID=B.SP_ID
		WHERE A.SP_ID=@NSPID AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	

	SET @CSTEP=85
	UPDATE WSL_ITEM_DETAILS SET DISCOUNT_AMOUNT=MRP*DISCOUNT_PERCENTAGE/100
	WHERE SP_ID=@NSPID	AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0
	
	SET @CSTEP=90
	UPDATE WSL_ITEM_DETAILS SET NET_RATE=RATE-(RATE* DISCOUNT_PERCENTAGE/ 100)
	WHERE SP_ID=@NSPID	AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0

END TRY

BEGIN CATCH
	SET @CERRORMSG='PROCEDURE SP3S_GETINVRATE_TERMS_GST STEP#'+@CSTEP+':'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:

END
