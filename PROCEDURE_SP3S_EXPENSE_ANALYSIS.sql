CREATE PROCEDURE SP3S_EXPENSE_ANALYSIS
(
	 @DPROCESS DATETIME
	,@BREPROCESS BIT=0
	,@CEXID VARCHAR(50) OUTPUT
	,@CERRMSG VARCHAR(500) OUTPUT
)	
AS
BEGIN
DECLARE @CALERT VARCHAR(500),@CSTEP VARCHAR(5),@CCURFINYEAR VARCHAR(10),@CPREFINYEAR VARCHAR(10),@DPREPROCESS DATETIME
		,@BXNS_EXISTS BIT,@BDEPT_EXISTS BIT,@BAC_EXISTS BIT,@BMONTH_EXISTS BIT

BEGIN TRY
	SET @CSTEP=00
	SET @CCURFINYEAR='01'+DBO.FN_GETFINYEAR(@DPROCESS)
	SET @CPREFINYEAR='0'+@CCURFINYEAR-1  
	SET @CPREFINYEAR='0'+@CPREFINYEAR
	SET @DPREPROCESS=DATEADD(YY,-1,@DPROCESS)
	--CHECK POINT 1
	--SELECT 	@DPROCESS,@CCURFINYEAR,@CPREFINYEAR,@DPREPROCESS
	SET @CSTEP=10
	IF ISNULL(@DPROCESS,'')=''
	BEGIN
		SET @CERRMSG='P:SP3S_EXPENSE_ANALYSIS,STEP:'+@CSTEP+',MESSAGE: PROCESS DATE CANNOT BE BLANK....'
		GOTO EXIT_PROC
	END
	
	SET @CSTEP=15
	SELECT TOP 1 @CEXID=PROCESS_ID FROM EXPENSE_MST WHERE PROCESS_DT=@DPROCESS
	
	IF @BREPROCESS=1 AND ISNULL(@CEXID,'')<>''
	BEGIN
		DELETE EXPENSE_DET WHERE PROCESS_ID=@CEXID
		DELETE EXPENSE_MST WHERE PROCESS_ID=@CEXID
	END
	ELSE IF @BREPROCESS=0 AND ISNULL(@CEXID,'')=''
	BEGIN
		SET @CALERT='EXPENSE ANALYSIS IS NOT BUILT FOR THIS DATE!! WOULD YOU LIKE TO PROCESS IT NOW?'
		GOTO EXIT_PROC
	END
	ELSE IF @BREPROCESS=0 AND ISNULL(@CEXID,'')<>''
		RETURN
	
	
	SET @CSTEP=20
	IF OBJECT_ID('TEMPDB..#EXPENSES','U') IS NOT NULL
		DROP TABLE #EXPENSES
	SET @CSTEP=30
	SELECT 
		   'CUR' AS XN_TYPE
		  ,LOC.MAJOR_DEPT_ID AS DEPT_ID
		  ,VD.AC_CODE
		  ,LM.AC_NAME
		  ,VM.FIN_YEAR
		  ,MONTH(VM.VOUCHER_DT) AS MONTH
		  ,DATENAME(MONTH,VM.VOUCHER_DT) AS MONTH_NAME
		  ,SUM(DEBIT_AMOUNT)-SUM(CREDIT_AMOUNT) AS EXPENSE_AMOUNT
	INTO #EXPENSES	  
	FROM VM01106 VM (NOLOCK)
	JOIN VD01106 VD (NOLOCK) ON VM.VM_ID=VD.VM_ID
	JOIN LM01106 LM (NOLOCK) ON VD.AC_CODE=LM.AC_CODE
	JOIN LOCATION LOC (NOLOCK) ON VM.DEPT_ID=LOC.DEPT_ID
	WHERE VM.CANCELLED=0 AND VM.FIN_YEAR=@CCURFINYEAR AND VM.VOUCHER_DT<=@DPROCESS
	AND LM.HEAD_CODE IN 
	(SELECT * FROM DBO.FN3S_EXPENSEHEADS())
	GROUP BY LOC.MAJOR_DEPT_ID
		  ,VD.AC_CODE
		  ,VM.FIN_YEAR
		  ,MONTH(VM.VOUCHER_DT) 
		  ,DATENAME(MONTH,VM.VOUCHER_DT)
		  ,LM.AC_NAME
	UNION ALL	  
	SELECT 
		   'PRE' AS XN_TYPE
		  ,LOC.MAJOR_DEPT_ID AS DEPT_ID
		  ,VD.AC_CODE
		  ,LM.AC_NAME
		  ,VM.FIN_YEAR
		  ,MONTH(VM.VOUCHER_DT) AS MONTH
		  ,DATENAME(MONTH,VM.VOUCHER_DT) AS MONTH_NAME
		  ,SUM(DEBIT_AMOUNT)-SUM(CREDIT_AMOUNT) AS EXPENSE_AMOUNT
	FROM VM01106 VM (NOLOCK)
	JOIN VD01106 VD (NOLOCK) ON VM.VM_ID=VD.VM_ID
	JOIN LM01106 LM (NOLOCK) ON VD.AC_CODE=LM.AC_CODE
	JOIN LOCATION LOC (NOLOCK) ON VM.DEPT_ID=LOC.DEPT_ID
	WHERE VM.CANCELLED=0 AND VM.FIN_YEAR=@CPREFINYEAR AND VM.VOUCHER_DT<=@DPREPROCESS
	AND LM.HEAD_CODE IN 
	(SELECT * FROM DBO.FN3S_EXPENSEHEADS())
	GROUP BY LOC.MAJOR_DEPT_ID
		  ,VD.AC_CODE
		  ,VM.FIN_YEAR
		  ,MONTH(VM.VOUCHER_DT) 
		  ,DATENAME(MONTH,VM.VOUCHER_DT)
		  ,LM.AC_NAME
	ORDER BY DEPT_ID,AC_CODE,MONTH DESC
	
	SET @CEXID='EP'+CONVERT(VARCHAR(40),NEWID())	
	IF EXISTS(SELECT TOP 1 'U' FROM #EXPENSES)
	BEGIN
		 INSERT EXPENSE_MST	( PROCESS_ID, PROCESS_DT)  
		 SELECT @CEXID AS PROCESSID,@DPROCESS AS PROCESSDT 
		 
		 INSERT EXPENSE_DET	( PROCESS_ID, XN_TYPE, FIN_YEAR, AC_CODE, AC_NAME, DEPT_ID, MONTH, MONTH_NAME, EXPENSE_AMOUNT)  
		 SELECT @CEXID AS PROCESSID,XN_TYPE,FIN_YEAR,AC_CODE,AC_NAME,DEPT_ID,MONTH,MONTH_NAME,EXPENSE_AMOUNT
		 FROM #EXPENSES
		 WHERE EXPENSE_AMOUNT<>0
	END	
	
END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP3S_EXPENSE_ANALYSIS,STEP:'+@CSTEP+',MESSAGE:'+ERROR_MESSAGE()
	GOTO EXIT_PROC
END CATCH

EXIT_PROC:
	
END
---END OF PROCEDURE - SP3S_EXPENSE_ANALYSIS
