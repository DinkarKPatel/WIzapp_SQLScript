CREATE PROCEDURE SP_DEBITNOTERECON
	@NQUERYID NUMERIC (2,0),  
	@CMEMOID VARCHAR(40),  
	@CWHERE VARCHAR(500), 
	@NNAVMODE NUMERIC(2,0),
	@VCHPRODCODE VARCHAR(50)='',
	@VCHRMID VARCHAR(1000)='',
	@CFINYEAR VARCHAR(5)='',
	@CRMNO CHAR(10)='',
	@CACCODE CHAR(10)='',
	@DFROMDT DATETIME ='',
	@DTODT DATETIME ='',
	@CWHERECLAUSE VARCHAR(500)=''
--WITH ENCRYPTION

AS
BEGIN

 		DECLARE @CCMD NVARCHAR(MAX)

		IF @NQUERYID = 1  
		GOTO LBLSUPPLIER  

		ELSE IF   
		@NQUERYID = 2 
		GOTO LBLDEBITNOTEMST 

		ELSE IF   
		@NQUERYID = 4  
		GOTO LBLTOTALQUANTITY  

		ELSE IF   
		@NQUERYID = 6  
		GOTO LBLDEBITNOTERECONMASTERINFO  

		ELSE IF   
		@NQUERYID = 7  
		GOTO LBLDEBITNOTERECONDET  

		ELSE IF   
		@NQUERYID = 8  
		GOTO LBLDEBITNOTERECONHEADER  

		ELSE IF   
		@NQUERYID = 11  
		GOTO LBLITEMBYRMID

		ELSE IF   
		@NQUERYID = 12  
		GOTO LBLDEBITNOTERECONREPORT  
		
		ELSE IF   
		@NQUERYID = 13  
		GOTO LBLVALIDATEBARCODE
		
		ELSE IF   
		@NQUERYID = 14  
		GOTO LBLNAVIGATE

		ELSE IF 
		@NQUERYID =15
		GOTO LBLRMMINFO -----TO GET RMM INFO BY RM_NO-------

		LBLNAVIGATE:
		EXEC SP_NAVIGATE  'DEBIT_NOTE_RECON_MST',@NNAVMODE,@CMEMOID,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERECLAUSE
		GOTO LAST
		
		LBLSUPPLIER:
			DECLARE @CHEADCODE VARCHAR(MAX)
			SET @CHEADCODE=DBO.FN_ACT_TRAVTREE('0000000021')
		  SELECT AC_CODE , AC_NAME, ADDRESS0 + ' ' +     
		  ADDRESS1 + ' ' + ADDRESS2 AS ADDRESS,AREA_NAME, CITY ,       
		  STATE,PINCODE   FROM LMV01106 WHERE INACTIVE = 0 AND  CHARINDEX(HEAD_CODE,@CHEADCODE) <> 0 AND AC_NAME <> ''

		GOTO LAST
		 
		LBLTOTALQUANTITY:

		 SELECT SUM(QUANTITY) AS QUANTITY FROM RMD01106 WHERE RM_ID = @CWHERE

		 GOTO LAST
		 
		LBLDEBITNOTEMST:
		
	    SELECT SUM(B.QUANTITY) AS QUANTITY ,A.RM_NO,CONVERT(VARCHAR(20),
	    A.RM_DT,105)AS RM_DT,A.RM_ID,A.TOTAL_AMOUNT,CAST(1 AS BIT) AS CHKTYPE FROM RMM01106 A 
		JOIN RMD01106 B ON A.RM_ID= B.RM_ID 
		WHERE A.AC_CODE = @CACCODE AND 
		A.RM_DT BETWEEN @DFROMDT AND @DTODT  GROUP BY A.RM_NO,A.RM_DT,A.RM_ID,A.TOTAL_AMOUNT

		 
		GOTO LAST
		 
		LBLDEBITNOTERECONMASTERINFO:

		   SELECT A.*,CONVERT(VARCHAR(15),MEMO_DT,105) AS MEMODATE,B.AC_NAME, U.USERNAME AS CREATEDBY,  
		   V.USERNAME AS CANCELLEDBY FROM DEBIT_NOTE_RECON_MST A      
		   JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE   
		   LEFT JOIN USERS U ON A.USER_CODE = U.USER_CODE   
		   LEFT JOIN USERS V ON A.EDT_USER_CODE = V.USER_CODE   
		   WHERE MEMO_ID  = @CMEMOID   
			
		   GOTO LAST  
		 
		LBLDEBITNOTERECONDET:

		   SELECT A.MEMO_ID , A.PRODUCT_CODE, A.RM_ID,A.ROW_ID ,A.LAST_UPDATE , A.QUANTITY ,  
		   B.RM_NO,B.TOTAL_AMOUNT,(A.QUANTITY*C.PURCHASE_PRICE) AS AMOUNT,D.DT_CREATED AS SKU_DT_CREATED, E.DT_CREATED AS ART_DT_CREATED,E.ARTICLE_NO,   
		   F.PARA1_CODE,F.PARA1_NAME , G.PARA2_CODE , G.PARA2_NAME,H.SUB_SECTION_NAME, I.SECTION_NAME,J.DT_CREATED AS PARA3_DT_CREATED,J.PARA3_NAME,
		   E.ALIAS AS ARTICLE_ALIAS   
		   FROM DEBIT_NOTE_RECON_DET A   
		   JOIN RMM01106 B ON A.RM_ID = B.RM_ID   
		   JOIN RMD01106 C ON C.PRODUCT_CODE=A.PRODUCT_CODE AND A.RM_ID = C.RM_ID
		   JOIN SKU D ON A.PRODUCT_CODE = D.PRODUCT_CODE   
		   JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE   
		   JOIN PARA1 F ON D.PARA1_CODE = F.PARA1_CODE   
		   JOIN PARA2 G ON D.PARA2_CODE = G.PARA2_CODE   
		   JOIN SECTIOND H ON E.SUB_SECTION_CODE = H.SUB_SECTION_CODE   
		   JOIN SECTIONM I ON H.SECTION_CODE = I.SECTION_CODE 
		   JOIN PARA3 J ON D.PARA3_CODE = J.PARA3_CODE   
		   WHERE A.MEMO_ID = @CMEMOID ORDER BY A.LAST_UPDATE ASC  		 
		 GOTO LAST  
		 
		LBLDEBITNOTERECONHEADER:

		 SELECT A.RM_ID , B.RM_NO,B.TOTAL_AMOUNT,SUM(C.QUANTITY) AS QUANTITY,'' ROW_ID,
		 CONVERT(VARCHAR(20),B.RM_DT,105) AS RM_DT 
		 FROM DEBIT_NOTE_RECON_DET A 
		 JOIN RMM01106 B ON A.RM_ID = B.RM_ID 
		 JOIN RMD01106 C ON A.RM_ID = C.RM_ID AND A.PRODUCT_CODE = C.PRODUCT_CODE 
		 WHERE A.MEMO_ID = @CMEMOID
		 GROUP BY A.RM_ID , B.RM_NO,B.TOTAL_AMOUNT,B.RM_DT
		 
		 GOTO LAST  
		 
		LBLVALIDATEBARCODE:
		  
		  SET @CCMD=N'SELECT TOP 1 PRODUCT_CODE FROM RMD01106  WHERE RM_ID IN(' + @VCHRMID + ') AND
					  PRODUCT_CODE='''+@VCHPRODCODE+''''
		  
		  PRINT(@CCMD)
		   
		  EXEC SP_EXECUTESQL @CCMD
		   	         
		 GOTO LAST
		 
		LBLITEMBYRMID:
		  
		  SET @CCMD=N'SELECT TOP 1 A.PRODUCT_CODE,A.RM_ID,A.PURCHASE_PRICE,B.DT_CREATED AS SKU_DT_CREATED,A.QUANTITY,
				 C.ARTICLE_NO,C.DT_CREATED AS ART_DT_CREATED,D.PARA1_NAME,E.PARA2_NAME,F.SUB_SECTION_NAME,
				 G.SECTION_NAME,H.DT_CREATED AS PARA3_DT_CREATED FROM RMD01106 A JOIN SKU B  ON A.PRODUCT_CODE = B.PRODUCT_CODE   
				 JOIN ARTICLE C ON B.ARTICLE_CODE = C.ARTICLE_CODE JOIN PARA1 D ON B.PARA1_CODE = D.PARA1_CODE   
				 JOIN PARA2 E ON B.PARA2_CODE = E.PARA2_CODE 
				 JOIN SECTIOND F ON C.SUB_SECTION_CODE = F.SUB_SECTION_CODE 
				 JOIN SECTIONM G ON F.SECTION_CODE = G.SECTION_CODE
				 JOIN PARA3 H ON B.PARA3_CODE = H.PARA3_CODE
				 WHERE RM_ID IN(' + @VCHRMID + ') AND A.PRODUCT_CODE='''+@VCHPRODCODE+''''
		   
		   PRINT(@CCMD)
		   
		  EXEC SP_EXECUTESQL @CCMD
		   	         
		 GOTO LAST
		 
		LBLDEBITNOTERECONREPORT:

		 SELECT A.*, B.*, C.RM_NO, E.ARTICLE_NO, F.PARA1_NAME, G.PARA2_NAME, 
		 H.SUB_SECTION_NAME, I.SECTION_NAME, E.ALIAS AS ARTICLE_ALIAS   FROM DEBIT_NOTE_RECON_MST A 
		 JOIN DEBIT_NOTE_RECON_DET B ON A.MEMO_ID = B.MEMO_ID 
		 JOIN RMM01106 C ON B.RM_ID = C.RM_ID 
		 JOIN SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE 
		 JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE 
		 JOIN PARA1 F ON D.PARA1_CODE = F.PARA1_CODE 
		 JOIN PARA2 G ON D.PARA2_CODE = G.PARA2_CODE 
		 JOIN SECTIOND H ON E.SUB_SECTION_CODE = H.SUB_SECTION_CODE 
		 JOIN SECTIONM I ON H.SECTION_CODE = I.SECTION_CODE WHERE MEMO_NO = @CWHERE
		 
		 GOTO LAST

	   LBLRMMINFO:
	   
		 SELECT RM_NO,CONVERT(VARCHAR(20),RM_DT,105)AS RM_DT,RM_ID,TOTAL_AMOUNT FROM RMM01106 WHERE RM_NO = @CWHERE
		 GOTO LAST
	   
	LAST:

END
