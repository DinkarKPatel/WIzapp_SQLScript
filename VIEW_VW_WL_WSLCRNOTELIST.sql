CREATE  VIEW VW_WL_WSLCRNOTELIST    

AS     
SELECT DISTINCT T1.CN_DT AS MEMO_DT,    
T1.CN_ID AS MEMO_ID,T1.CN_NO AS MEMO_NO,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.SUBTOTAL ELSE 0 END) AS GROSS_RETURN_VALUE,    
T1.DISCOUNT_PERCENTAGE AS DISCOUNT_PERCENTAGE ,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.DISCOUNT_AMOUNT ELSE 0 END) AS DISCOUNT_AMOUNT ,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.FREIGHT ELSE 0 END) AS FREIGHT,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.OTHER_CHARGES ELSE 0 END) AS OTHER_CHARGES,    
(CASE WHEN T1.CANCELLED = 0 THEN T1.TOTAL_AMOUNT ELSE 0 END) AS NET_RETURN_VALUE,    
T1.ROUND_OFF,    
T1.REMARKS ,    
T1.GRLR_DATE,    
T1.GRLR_NO,    
T1.BANDALS ,    
T1.THROUGH , 
T1.RECEIPT_DT,   
(CASE WHEN ISNULL(VM.BILL_ID,'')<> '' THEN 'POSTED' ELSE 'PENDING' END) AS AC_POSTED,      
T1.MANUAL_INV_NO,    
(CASE WHEN T1.CANCELLED = 1 THEN 0 ELSE ISNULL(T2.TOTAL_QUANTITY,0) END) AS TOTAL_QUANTITY,    
(CASE WHEN T1.CANCELLED = 1 THEN 0 ELSE ISNULL(T2.ITEM_DISCOUNT_AMOUNT,0) END) AS ITEM_DISCOUNT_AMOUNT,    
(CASE WHEN T1.CANCELLED = 1 THEN 0 ELSE ISNULL(T2.ITEM_GROSS_RETURN_VALUE,0) END) AS ITEM_GROSS_RETURN_VALUE,    
T3.AC_NAME AS CUSTOMER_NAME,    
(CASE WHEN T1.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END) AS CANCELLED,T1.FIN_YEAR ,COM.COMPANY_CODE  ,    
T1.MEMO_TYPE ,L.DEPT_ID  AS LOC_ID,L.DEPT_NAME AS LOC_NAME ,
F.FORM_NAME AS TAX_TYPE,T2.TAX_PERCENTAGE ,T2.TAX_AMOUNT     
FROM CNM01106 T1    
JOIN LMV01106 T3 ON T3.AC_CODE = T1.AC_CODE    
    
LEFT OUTER JOIN     
(
  SELECT CN_ID, ITEM_FORM_ID,ITEM_TAX_PERCENTAGE AS TAX_PERCENTAGE,
         SUM(QUANTITY) AS TOTAL_QUANTITY,SUM(DISCOUNT_AMOUNT) AS ITEM_DISCOUNT_AMOUNT,    
         SUM(QUANTITY*RATE) AS ITEM_GROSS_RETURN_VALUE , SUM(ITEM_TAX_AMOUNT) AS TAX_AMOUNT   
  FROM CND01106 GROUP BY CN_ID,ITEM_FORM_ID,ITEM_TAX_PERCENTAGE
 ) T2 ON T2.CN_ID=T1.CN_ID     
 LEFT OUTER JOIN COMPANY COM ON 1=1 AND COM.COMPANY_CODE='01'    
 LEFT OUTER JOIN LOCATION  L (NOLOCK) ON T1.location_code/*LEFT(T1.CN_ID,2)*//*Rohit 05-11-2024*/ = L.DEPT_ID     
 LEFT OUTER JOIN     
 (    
   SELECT BILL_ID FROM VM01106 WHERE CANCELLED=0    
 ) VM ON VM.BILL_ID=T1.CN_ID       
   
LEFT OUTER JOIN FORM F ON T2.ITEM_FORM_ID = F.FORM_ID
