CREATE PROCEDURE SP3S_VALIDATE_COUPON_REDEMPTION
@CECOUPONID VARCHAR(50)='',
@NSPID INT=0,
@CCMID VARCHAR(40)=''
AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@CREFBILLNO VARCHAR(20),@DREFBILLDATE DATETIME
	
	IF OBJECT_ID('TEMPDB..#TMPCOUPONS','U') IS NOT NULL
		DROP TABLE #TMPCOUPONS
	
	SELECT ECOUPON_ID,CONVERT(VARCHAR(1000),'') AS ERRMSG INTO #TMPCOUPONS	FROM COUPON_REDEMPTION_INFO (NOLOCK) WHERE 1=2
	
	
	IF @CECOUPONID<>''
	BEGIN
		INSERT #TMPCOUPONS 
		SELECT @CECOUPONID,'' AS ERRMSG
	END	
	ELSE
	BEGIN
		SET @CCMD=N'SELECT ECOUPON_ID,'''' AS ERRMSG FROM TMP_COUPON_REDEEM_'+LTRIM(RTRIM(STR(@NSPID)))
		
		INSERT #TMPCOUPONS 
		EXEC SP_EXECUTESQL @CCMD
	END	

	---- Discarded this as per discussion with Sir on 24-06-2019 ...it is not required
	---- as this is validated on Wizclip already
	GOTO END_PROC

	
	UPDATE A SET ERRMSG='THIS ECOUPON HAS BEEN REDEEMED AGAINST BILL NO.#'+C.CM_NO+' DATED:'+CONVERT(VARCHAR,C.CM_DT,105)+'....CANNOT REDEEM AGAIN'
	FROM #TMPCOUPONS A 
	JOIN COUPON_REDEMPTION_INFO B (NOLOCK) ON A.ECOUPON_ID=B.ECOUPON_ID
	JOIN CMM01106 C (NOLOCK) ON B.CM_ID=C.CM_ID
	WHERE B.CM_ID<>@CCMID AND C.CANCELLED=0

END_PROC:	
	SELECT * FROM #TMPCOUPONS	
END
