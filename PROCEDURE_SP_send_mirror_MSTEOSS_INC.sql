CREATE PROCEDURE SP_SEND_MIRROR_MSTEOSS_INC --(LocId 3 digit change by Sanjay:30-10-2024)
(
	@CTARGETLOCID VARCHAR(5)='',
	@NMODE NUMERIC(1,0)=1,    -----  1. SEND THE LIST OF ALL SCHEME SETUP MEMOS ONLY RELATED TO TARGET LOCATION
							  ----   2. SEND THE LIST OF ALL ACTIVE SCHEME SETUP TITLES ONLY RELATED TO TARGET LOCATION
							  ----   3. SEND ALL TABLES INFO RELATED TO A GIVEN TITLE TO TARGET LOCATION
							  ----   4. ACK FOR LOCATION ID	
	@CSCHEMEROWID VARCHAR(50)=''
)
--WITH ENCRYPTION
AS
BEGIN
	
	BEGIN TRY
		
		DECLARE @CERRORMSG VARCHAR(1000),@CCMD NVARCHAR(MAX),
				@CXNMASTERTABLENAME VARCHAR(100),@BPROCEED BIT,@CTABLENAME VARCHAR(100),@CMASTERKEYFIELD VARCHAR(100),
				@CKEYFIELD VARCHAR(100),@CPARENTTABLENAME VARCHAR(100),@CPARENTPARANAME VARCHAR(100),@CCHILDPARANAME VARCHAR(100),
				@CWHERECLAUSE VARCHAR(100),@CJOINSTR VARCHAR(MAX),@CMEMOID VARCHAR(100),@CFINYEAR VARCHAR(100),
				@NGRPCHARS INT,@NSERIESCHARS INT,@BSERIESBROKEN BIT,@CPREVMEMOID VARCHAR(40),@CMERGETABLENAME VARCHAR(50),
				@CFIRSTMEMOID VARCHAR(40),@NPREVMEMOID INT,@NMEMONOLEN INT,@CRETCMD NVARCHAR(MAX),
				@CDELCHILDTABLENAME VARCHAR(100),@CDELCHILDPARANAME VARCHAR(100),@CDELPARENTPARANAME VARCHAR(100),
				@CORIGINALTABLENAME VARCHAR(100),@NLOCTYPE INT,@BDONOTMERGE BIT,@CRFXNTYPE VARCHAR(10),@BHOLOC BIT,
				@BINSERTONLY BIT,@BLINKEDMASTER BIT,@BPURLOC BIT,@CSOURCELOCID CHAR(2),@BSOURCEPURLOC BIT,
				@CMISSINGMEMOID VARCHAR(40),@CGRPCODE VARCHAR(20),@BRETVAL BIT,@NPREVNO INT,@CPREVNO VARCHAR(20),
				@BEMPHEADSUPDATED BIT,@CFILTERCONDITION VARCHAR(1000),@CTABLEPREFIX VARCHAR(100),@CXNTYPE VARCHAR(10),
				@NXNSMERGINGORDER INT,@NSTEP INT,@CKEYFIELD2 VARCHAR(100),@CTMP_TABLENAME VARCHAR(500),
				@CSOURCEDB VARCHAR(200),@CHOSCHMSTLASTUPDATE VARCHAR(50),@CTEMPDBNAME VARCHAR(500),
				@CSLSSETLUPD VARCHAR(50),@CEOSSMERGINGTHRUWIZCOM VARCHAR(2),@CSPID VARCHAR(5),
				@CTEMPTABLENAME VARCHAR(500),@DTSQL NVARCHAR(MAX),@CSCHROWID VARCHAR(40),@bdonot_merge_eoss BIT
		
		
		SET @NSTEP=10	
		
		
		
		SET @CSPID=@CTARGETLOCID
		
		SET @CSOURCEDB=''
		
		SET @NSTEP=15
		DECLARE @TRETMSG TABLE  (MEMO_ID VARCHAR(40),ERRMSG VARCHAR(MAX))
	
		
		SELECT TOP 1 @bdonot_merge_eoss=ISNULL(donot_merge_eoss,0) FROM location WHERE dept_id=@CTARGETLOCID
			
		IF @bdonot_merge_eoss=1
		BEGIN
			SET @CERRORMSG='EOSS Merging cannot be done for this Location'
			GOTO END_PROC
		END
		ELSE
		IF @NMODE IN (1,2,4)
		BEGIN
			IF @NMODE=1 ---- GET THE LIST OF ALL SCHEME SETUP MEMOS RELATED TO TARGET LOCATION
			BEGIN
				SET @NSTEP=20
				SELECT 'MSTEOSS_SCHEME_SETUP_MST_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_MST A  (NOLOCK)
				LEFT OUTER JOIN SCHEME_SETUP_LOC B (NOLOCK) ON A.MEMO_NO=B.MEMO_NO AND B.DEPT_ID=@CTARGETLOCID
				WHERE (LOC_APPLICABLE_MODE=1 OR B.MEMO_NO IS NOT NULL)
				
				SET @NSTEP=25
				SELECT 'MSTEOSS_SCHEME_SETUP_HAPPYHOURS_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_HAPPYHOURS A  (NOLOCK)
				JOIN SCHEME_SETUP_MST B  (NOLOCK) ON A.MEMO_NO=B.MEMO_NO
				LEFT OUTER JOIN SCHEME_SETUP_LOC C  (NOLOCK) ON A.MEMO_NO=C.MEMO_NO AND C.DEPT_ID=@CTARGETLOCID
				WHERE (LOC_APPLICABLE_MODE=1 OR C.MEMO_NO IS NOT NULL)
				
				SET @NSTEP=30
				SELECT 'MSTEOSS_CONFIG_MIRROR' AS TARGET_TABLENAME,*
				FROM CONFIG (NOLOCK) WHERE 1=2 --- Thse config will now onwards be sent from Location master only (Discussed on 07/05-2020 in Zoom meeting)
			END
			ELSE
			IF @NMODE=2 ---- GET THE LIST OF ALL ACTIVE SCHEME SETUP TITLES RELATED TO TARGET LOCATION
			BEGIN
				SET @NSTEP=35
				SELECT 'MSTEOSS_SCHEMESINFO_MIRROR' AS TARGET_TABLENAME,A.ROW_ID AS SCHEME_SETUP_DET_ROW_ID,
				A.LAST_UPDATE,CONVERT(BIT,0) AS DELETED_TITLE,A.SCHEME_NAME
				FROM SCHEME_SETUP_DET A
				JOIN SCHEME_SETUP_MST B ON A.MEMO_NO=B.MEMO_NO
				LEFT OUTER JOIN SCHEME_SETUP_LOC C ON C.MEMO_NO=B.MEMO_NO AND C.DEPT_ID=@CTARGETLOCID
				WHERE (LOC_APPLICABLE_MODE=1 OR C.MEMO_NO IS NOT NULL)
			--	AND CONVERT(DATE,GETDATE()) BETWEEN APPLICABLE_FROM_DT AND APPLICABLE_TO_DT
		    	AND APPLICABLE_TO_DT >=  CONVERT(DATE,GETDATE()) 	
				AND INACTIVE=0
			END
			
			IF @NMODE=4 ---- ACK FOR LOCATION ID
			BEGIN

				IF EXISTS (SELECT TOP 1 'U' FROM SCHEME_SETUP_ACK_LOG WHERE DEPT_ID=@CTARGETLOCID)
				   UPDATE SCHEME_SETUP_ACK_LOG SET LAST_UPDATE=GETDATE() WHERE DEPT_ID =@CTARGETLOCID
				ELSE
				BEGIN
				   INSERT INTO SCHEME_SETUP_ACK_LOG (DEPT_ID,LAST_UPDATE)
					SELECT @CTARGETLOCID,GETDATE()
				END
				
			
			END	

			GOTO END_PROC
		END	
		
		
		
		SELECT @CERRORMSG='',@BPROCEED=1,@NMEMONOLEN=10,@CRETCMD='',@CMEMOID='',@CXNTYPE='MSTEOSS',@BEMPHEADSUPDATED=0
		
		SET @NSTEP=40
								
	
LBLSEND:
				
		DECLARE @CTMPLOCUSERSTABLENAME VARCHAR(500),@CTMPUSERTABLENAME VARCHAR(500),@CTMPUSERROLETABLENAME VARCHAR(500),
				@CTMPBINUSERTABLENAME VARCHAR(500)
		
		---- RETURN THE DETAILS RELATED TO A GIVEN TITLE FOR TARGET LOCATION
		SET @NSTEP=50				
		SELECT 'MSTEOSS_SCHEME_SETUP_DET_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_DET A (NOLOCK)		
		WHERE ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=55
		SELECT 'MSTEOSS_REP_MST_MIRROR' AS TARGET_TABLENAME,A.* FROM REP_MST A (NOLOCK)		
		JOIN SCHEME_SETUP_DET B (NOLOCK) ON A.REP_ID=B.REPID
		WHERE B.ROW_ID=@CSCHEMEROWID
				
		
		SET @NSTEP=60				
		SELECT 'MSTEOSS_REP_FILTER_MIRROR' AS TARGET_TABLENAME,A.* FROM REP_FILTER A (NOLOCK)	
		JOIN REP_MST B (NOLOCK) ON A.REP_ID=B.REP_ID	
		JOIN SCHEME_SETUP_DET C (NOLOCK) ON B.REP_ID=C.REPID
		WHERE C.ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=70				
		SELECT 'MSTEOSS_REP_FILTER_DET_MIRROR' AS TARGET_TABLENAME,A.* FROM REP_FILTER_DET A (NOLOCK)	
		JOIN REP_MST B (NOLOCK) ON A.REP_ID=B.REP_ID	
		JOIN SCHEME_SETUP_DET C (NOLOCK) ON B.REP_ID=C.REPID
		WHERE C.ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=90		
		SELECT 'MSTEOSS_REP_FILTER_DET_MIRROR' AS TARGET_TABLENAME,A.* FROM REP_FILTER_DET A (NOLOCK)	
		JOIN REP_MST B (NOLOCK) ON A.REP_ID=B.REP_ID	
		JOIN SCHEME_SETUP_DET C (NOLOCK) ON B.REP_ID=C.REPID
		WHERE C.ROW_ID=@CSCHEMEROWID
				
		SET @NSTEP=100		
		SELECT 'MSTEOSS_SCHEME_SETUP_SLSBC_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SLSBC A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID AND ISNULL(ITEM_DEPT_ID,'') IN ('',@CTARGETLOCID)
						
		SET @NSTEP=110				
		SELECT 'MSTEOSS_SCHEME_SETUP_SLSBC_GET_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SLSBC_GET A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID AND ISNULL(ITEM_DEPT_ID,'') IN ('',@CTARGETLOCID)

		SET @NSTEP=120		
		SELECT 'MSTEOSS_SCHEME_SETUP_SLSART_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SLSART A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=130		
		SELECT 'MSTEOSS_SCHEME_SETUP_SLSART_GET_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SLSART_GET A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=140		
		SELECT 'MSTEOSS_SCHEME_SETUP_SLSPARA_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SLSPARA A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=150
		SELECT 'MSTEOSS_SCHEME_SETUP_SLSPARA_GET_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SLSPARA_GET A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=160		
		SELECT 'MSTEOSS_SCHEME_SETUP_SCH0002_1_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SCH0002_1 A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=170		
		SELECT 'MSTEOSS_SCHEME_SETUP_SCH0006_1_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SCH0006_1 A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=180		
		SELECT 'MSTEOSS_SCHEME_SETUP_SCH0007_1_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SCH0007_1 A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=185		
		SELECT 'MSTEOSS_SCHEME_SETUP_SCH0012_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SCH0012 A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=190		
		SELECT 'MSTEOSS_SCHEME_SETUP_SCHB001_1_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SCHB001_1 A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID

		SET @NSTEP=195		
		SELECT 'MSTEOSS_SCHEME_SETUP_SCHB002_1_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SCHB002_1 A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
						
		SET @NSTEP=210		
		SELECT 'MSTEOSS_SCHEME_SETUP_ALLMASTERS_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_ALLMASTERS A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
		
		SET @NSTEP=220		
		SELECT 'MSTEOSS_SCHEME_SETUP_ALLMASTERS_CONFIG_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_ALLMASTERS_CONFIG A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID

		SET @NSTEP=230		
		SELECT 'MSTEOSS_SCHEME_SETUP_SCH0014_1_MIRROR' AS TARGET_TABLENAME,A.* FROM SCHEME_SETUP_SCH0014_1 A (NOLOCK)	
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEROWID
			
		GOTO END_PROC
		
	END TRY

	BEGIN CATCH
		
		PRINT 'UNTRAPPED ERROR'		
		SELECT @CERRORMSG='PROCEDURE SP_SEND_MIRROR_MSTEOSS_INC : STEP: '+STR(@NSTEP)+' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		GOTO END_PROC
	END CATCH

END_PROC:
	
	
	
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			COMMIT
		ELSE
			ROLLBACK	
	END
	
	IF ISNULL(@CERRORMSG,'')<>'' OR @NMODE=4
		SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
    
    
		
END
--- 'END OF CREATING PROCEDURE SP_SEND_MIRROR_MSTEOSS_INC
