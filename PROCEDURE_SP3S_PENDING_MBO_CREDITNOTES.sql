CREATE PROCEDURE SP3S_PENDING_MBO_CREDITNOTES
(
    @NMODE NUMERIC(1) /*@NMODE: 1 FOR ADD MODE,2 FOR EDIT MODE AND 3 FOR VIEW MODE*/
   ,@CMEMO_ID VARCHAR(30)=''
   ,@CBIN_ID VARCHAR(3) /*MBO BIN FOR WHOM THE CREDIT NOTE IS TO BE CONSIDERED.*/
)
--WITH ENCRYPTION
AS 
BEGIN
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @NMODE=1 /*CASE OF ADD*/
BEGIN
	--MASTER CURSOR
	SELECT CONVERT(BIT,0) AS CHK,A.CN_ID,A.CN_NO,A.CN_DT,A.AC_CODE,A.TOTAL_AMOUNT,SUM(B.QUANTITY) AS QUANTITY
		   ,A.REMARKS	
	FROM CNM01106 A
	JOIN CND01106 B ON A.CN_ID=B.CN_ID
	LEFT JOIN MBO_WSR_WSL_LINK C ON A.CN_ID=C.CN_ID
	WHERE A.CANCELLED=0 AND A.CN_TYPE=1 AND A.MODE=3 AND C.CN_ID IS NULL	
	AND A.SOURCE_BIN_ID=@CBIN_ID
	GROUP BY A.CN_ID,A.CN_NO,A.CN_DT,A.AC_CODE,A.TOTAL_AMOUNT,A.REMARKS
	ORDER BY A.CN_DT,A.CN_ID

	--DETAIL CURSOR
	SELECT A.CN_ID,A.CN_NO,A.BIN_ID,BIN.BIN_NAME,B.PRODUCT_CODE,E.ARTICLE_NO,
	F.SUB_SECTION_NAME,G.SECTION_NAME,H.UOM_NAME,B.QUANTITY,B.RATE,D.MRP
		  ,D.PURCHASE_PRICE,D.WS_PRICE
	FROM CNM01106 A
	JOIN CND01106 B ON A.CN_ID=B.CN_ID
	JOIN BIN ON A.BIN_ID=BIN.BIN_ID
	LEFT JOIN MBO_WSR_WSL_LINK C ON A.CN_ID=C.CN_ID
	JOIN SKU D ON B.PRODUCT_CODE=D.PRODUCT_CODE
	JOIN ARTICLE E ON D.ARTICLE_CODE=E.ARTICLE_CODE
	JOIN SECTIOND F ON E.SUB_SECTION_CODE=F.SUB_SECTION_CODE
	JOIN SECTIONM G ON F.SECTION_CODE=G.SECTION_CODE
	JOIN UOM H ON E.UOM_CODE=H.UOM_CODE
	WHERE A.CANCELLED=0 AND A.CN_TYPE=1 AND A.MODE=3 AND C.CN_ID IS NULL	
	AND A.SOURCE_BIN_ID=@CBIN_ID
	ORDER BY A.CN_DT
END	
ELSE IF @NMODE=2 /*CASE OF EDIT*/
BEGIN
	--MASTER CURSOR
	SELECT (CASE WHEN D.CN_ID IS NOT NULL THEN 1 ELSE 0 END) AS CHK,A.CN_ID,A.CN_NO,A.CN_DT,
	A.AC_CODE,A.TOTAL_AMOUNT,SUM(B.QUANTITY) AS QUANTITY   ,A.REMARKS	
	FROM CNM01106 A
	JOIN CND01106 B ON A.CN_ID=B.CN_ID
	LEFT JOIN MBO_WSR_WSL_LINK C ON A.CN_ID=C.CN_ID AND C.INV_ID<>@CMEMO_ID
	LEFT JOIN MBO_WSR_WSL_LINK D ON A.CN_ID=D.CN_ID 
	WHERE A.CANCELLED=0 AND A.CN_TYPE=1 AND A.MODE=3 AND C.CN_ID IS NULL	
	AND A.SOURCE_BIN_ID=@CBIN_ID
	GROUP BY (CASE WHEN D.CN_ID IS NOT NULL THEN 1 ELSE 0 END),A.CN_ID,A.CN_NO,A.CN_DT,
	A.AC_CODE,A.TOTAL_AMOUNT,A.REMARKS
	ORDER BY A.CN_DT,A.CN_ID

	--DETAIL CURSOR
	SELECT A.CN_ID,A.CN_NO,A.BIN_ID,BIN.BIN_NAME,B.PRODUCT_CODE,E.ARTICLE_NO,
	F.SUB_SECTION_NAME,G.SECTION_NAME,H.UOM_NAME,B.QUANTITY,B.RATE,D.MRP
		  ,D.PURCHASE_PRICE,D.WS_PRICE
	FROM CNM01106 A
	JOIN CND01106 B ON A.CN_ID=B.CN_ID
	JOIN BIN ON A.BIN_ID=BIN.BIN_ID
	LEFT JOIN MBO_WSR_WSL_LINK C ON A.CN_ID=C.CN_ID AND C.INV_ID<>@CMEMO_ID
	JOIN SKU D ON B.PRODUCT_CODE=D.PRODUCT_CODE
	JOIN ARTICLE E ON D.ARTICLE_CODE=E.ARTICLE_CODE
	JOIN SECTIOND F ON E.SUB_SECTION_CODE=F.SUB_SECTION_CODE
	JOIN SECTIONM G ON F.SECTION_CODE=G.SECTION_CODE
	JOIN UOM H ON E.UOM_CODE=H.UOM_CODE
	WHERE A.CANCELLED=0 AND A.CN_TYPE=1 AND A.MODE=3 AND C.CN_ID IS NULL	
	AND A.SOURCE_BIN_ID=@CBIN_ID
	ORDER BY A.CN_DT
END
ELSE IF @NMODE=3 /*VIEW MODE*/
BEGIN
	--MASTER CURSOR
	SELECT 1 AS CHK,A.CN_ID,A.CN_NO,A.CN_DT,A.AC_CODE,A.TOTAL_AMOUNT,SUM(B.QUANTITY) AS QUANTITY
		   ,A.REMARKS	
	FROM CNM01106 A
	JOIN CND01106 B ON A.CN_ID=B.CN_ID
	JOIN MBO_WSR_WSL_LINK D ON A.CN_ID=D.CN_ID 
	WHERE A.CANCELLED=0 AND A.CN_TYPE=1 AND A.MODE=3 
	AND A.SOURCE_BIN_ID=@CBIN_ID AND D.INV_ID=@CMEMO_ID
	GROUP BY A.CN_ID,A.CN_NO,A.CN_DT,A.AC_CODE,A.TOTAL_AMOUNT,A.REMARKS
	ORDER BY A.CN_DT,A.CN_ID

	--DETAIL CURSOR
	SELECT A.CN_ID,A.CN_NO,A.BIN_ID,BIN.BIN_NAME,B.PRODUCT_CODE,E.ARTICLE_NO,
	F.SUB_SECTION_NAME,G.SECTION_NAME,H.UOM_NAME,B.QUANTITY,B.RATE,D.MRP
		  ,D.PURCHASE_PRICE,D.WS_PRICE
	FROM CNM01106 A
	JOIN CND01106 B ON A.CN_ID=B.CN_ID
	JOIN MBO_WSR_WSL_LINK MD ON A.CN_ID=MD.CN_ID 
	JOIN BIN ON A.BIN_ID=BIN.BIN_ID
	JOIN SKU D ON B.PRODUCT_CODE=D.PRODUCT_CODE
	JOIN ARTICLE E ON D.ARTICLE_CODE=E.ARTICLE_CODE
	JOIN SECTIOND F ON E.SUB_SECTION_CODE=F.SUB_SECTION_CODE
	JOIN SECTIONM G ON F.SECTION_CODE=G.SECTION_CODE
	JOIN UOM H ON E.UOM_CODE=H.UOM_CODE
	WHERE A.CANCELLED=0 AND A.CN_TYPE=1 AND A.MODE=3 
	AND A.SOURCE_BIN_ID=@CBIN_ID AND MD.INV_ID=@CMEMO_ID
	ORDER BY A.CN_DT 
END
END
--END OF PROCEDURE - SP3S_PENDING_MBO_CREDITNOTES
