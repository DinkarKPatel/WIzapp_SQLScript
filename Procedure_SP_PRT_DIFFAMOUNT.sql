CREATE PROCEDURE SP_PRT_DIFFAMOUNT
(
  @CRMID VARCHAR(50)=''
)
AS
BEGIN	
	
	

	IF OBJECT_ID ('TEMPDB..#TMPDBNDIFF','U') IS NOT NULL
	   DROP TABLE #TMPDBNDIFF


	SELECT 	A.PRODUCT_CODE,A.QUANTITY AS DN_QTY,
	        COALESCE(PID.PURCHASE_PRICE,S.PURCHASE_PRICE) AS PUR_RATE,
			COALESCE(PID.HSN_CODE,S.HSN_CODE) AS PUR_HSN,
			COALESCE(PID.GST_PERCENTAGE,S.GST_PERCENTAGE) AS PUR_GST_PERCENTAGE,
	        A.PURCHASE_PRICE AS DN_RATE,
			A.HSN_CODE AS DN_HSN,
			A.GST_PERCENTAGE AS DN_GST_PERCENTAGE,
			CAST (0 AS NUMERIC(10,2)) AS HSN_MST_GST_PERCENTAGE,
	
		CONVERT(NUMERIC(18,2)
		,((A.XN_VALUE_WITHOUT_GST+A.IGST_AMOUNT+A.CGST_AMOUNT+A.SGST_AMOUNT+A.EXCISE_DUTY_AMOUNT)
		 -  COALESCE(((PID.XN_VALUE_WITHOUT_GST+PID.IGST_AMOUNT+PID.CGST_AMOUNT+PID.SGST_AMOUNT-PID.PIMPOSTTAXDISCOUNTAMOUNT
			       +PID.PIMEXCISEDUTYAMOUNT)/PID.QUANTITY)*A.QUANTITY,A.QUANTITY*(S.PURCHASE_PRICE+ISNULL(F.EXCISE_DUTY_AMOUNT,0)
					+ ISNULL(F.TAX_AMOUNT ,0) 
					)))
		) AS DIFFAMOUNT,
	    A.AUTO_SRNO ,A.bill_dt ,RMM.RM_DT ,A.hsn_code ,A.XN_VALUE_WITHOUT_GST ,A.ROW_ID 
		INTO #TMPDBNDIFF
		FROM RMD01106 A (NOLOCK)       
		JOIN RMM01106 RMM  (NOLOCK) ON A.RM_ID = RMM.RM_ID  
		LEFT JOIN PID01106 PID(NOLOCK) ON  A.MRR_ID=PID.MRR_ID AND PID.ROW_ID=A.PID_ROW_ID
		LEFT OUTER JOIN PIM01106 PIM (NOLOCK) ON PIM.MRR_ID =PID.MRR_ID 
		JOIN SKU S (NOLOCK) ON A.PRODUCT_CODE = S.PRODUCT_CODE   
		LEFT OUTER JOIN SKU_OH F(NOLOCK) ON S.PRODUCT_CODE = F.PRODUCT_CODE    
		WHERE A.RM_ID=@CRMID  
	    
		;WITH CTE AS
		(
			SELECT  ISNULL(C.TAX_PERCENTAGE,0) AS TAX_PERCENTAGE,ISNULL(C.RATE_CUTOFF,0) AS RATE_CUTOFF,
				   ISNULL(C.RATE_CUTOFF_TAX_PERCENTAGE,0) AS RATE_CUTOFF_TAX_PERCENTAGE,
				  ISNULL(C.WEF,'') AS WEF,ISNULL(B.TAXABLE_ITEM,'') AS TAXABLE_ITEM,ISNULL(B.HSN_TYPE ,'') AS HSN_TYPE  ,
				  SR=ROW_NUMBER() OVER (PARTITION BY A.ROW_ID ORDER BY C.WEF DESC),
				  ISNULL(C.GST_CAL_BASIS,1) AS GST_CAL_BASIS,
				  isnull(c.Rate_CutOff_Gst_Cess_Percentage,0) as Rate_CutOff_Gst_Cess_Percentage,
				  isnull(c.Gst_Cess_Percentage,0) as Gst_Cess_Percentage,A.*
			 FROM #TMPDBNDIFF A (NOLOCK)
			 JOIN HSN_MST B (NOLOCK) ON A.HSN_CODE =B.HSN_CODE 
			 LEFT JOIN HSN_DET C (NOLOCK) ON B.HSN_CODE =C.HSN_CODE AND C.WEF  <=RM_DT AND ISNULL(C.DEPT_ID,'')=''
		)
		

		 UPDATE A SET HSN_MST_GST_PERCENTAGE= ISNULL(CASE WHEN RATE_CUTOFF<ABS(A.XN_VALUE_WITHOUT_GST)/ABS(A.DN_QTY ) 
         THEN A.TAX_PERCENTAGE ELSE RATE_CUTOFF_TAX_PERCENTAGE END ,0)
	     FROM CTE  A where sr=1


		 SELECT A.PRODUCT_CODE,A.DN_QTY,A.PUR_RATE,A.PUR_HSN,A.PUR_GST_PERCENTAGE,
	        A.DN_RATE,A.DN_HSN,A.DN_GST_PERCENTAGE,
			A.HSN_MST_GST_PERCENTAGE,A.DIFFAMOUNT 
		 FROM #TMPDBNDIFF A (NOLOCK)
		 WHERE A.DIFFAMOUNT <>0
		 ORDER BY A.AUTO_SRNO 
				

END


