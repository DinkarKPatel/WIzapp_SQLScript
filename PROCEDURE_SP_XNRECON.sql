create PROCEDURE SP_XNRECON--(LocId 3 digit change by Sanjay:04-11-2024)
@NQUERYID	NUMERIC(3,0),
@CMEMOID	VARCHAR(MAX),
@CWHERE		VARCHAR(200),
@CFINYEAR	VARCHAR(10),
@CDEPTID	VARCHAR(5),
@NNAVMODE	NUMERIC(2,0),
@CXNTYPE	VARCHAR(20) = '',
@DFROM		DATETIME = '',
@DTO		DATETIME = ''
--WITH ENCRYPTION

AS
BEGIN

--SET @DFROM=DATEADD(MM,-6,@DFROM)

DECLARE @CCMD NVARCHAR(4000)
DECLARE @CCMD2 NVARCHAR(4000)


IF @NQUERYID = 1
GOTO LBLNAVIGATE

ELSE 
IF @NQUERYID = 2
GOTO LBLGETMASTER

ELSE 
IF @NQUERYID = 3
GOTO LBLGETPDETAILS

ELSE 
IF @NQUERYID = 4
GOTO LBLCHALLANNO

ELSE 
IF @NQUERYID = 5
GOTO LBLGETSKUITEMS

ELSE 
IF @NQUERYID = 6
GOTO LBLGETCDETAILS

ELSE 
IF @NQUERYID = 7
GOTO LBLGETMEMODETAILS

ELSE
IF @NQUERYID = 8
GOTO LBLGETBOXNO

ELSE
IF @NQUERYID = 9
GOTO LBLCHALLANCDETAILS

ELSE
IF @NQUERYID = 10
GOTO LBLBOXNO_LIST

ELSE
IF @NQUERYID = 11
GOTO LBLGETBOXNO_NEXT


LBLNAVIGATE:
	SET @CCMD=	N'SELECT TOP 1 RECON_NO, RECON_ID FROM XNRECONM (NOLOCK) '+(CASE WHEN @NNAVMODE IN(0,2,3)THEN 
			' WHERE FIN_YEAR = '+@CFINYEAR+' AND RECON_NO '+(CASE WHEN @NNAVMODE=2 THEN '<' WHEN @NNAVMODE=3 
			THEN '>'  ELSE '=' END)+''''+@CMEMOID+'''' ELSE '' END)
			+(CASE WHEN @NNAVMODE IN (0,2,3) AND ISNULL(@CWHERE,'')<>'' THEN ' AND ' +@CWHERE
				WHEN ISNULL(@CWHERE,'')<>'' THEN ' WHERE '+@CWHERE 
				ELSE '' END)
			+' ORDER BY RECON_NO '+(CASE WHEN 
			@NNAVMODE IN (1,3) THEN ' ASC ' ELSE ' DESC ' END)               
	PRINT 	@CCMD    
	EXEC SP_EXECUTESQL @CCMD   

GOTO LAST

LBLGETMASTER:

	SELECT T1.*,USERS.USERNAME,EDTUSERS.USERNAME AS EDT_USERNAME  
	FROM XNRECONM (NOLOCK) T1 
	JOIN USERS (NOLOCK) ON T1.USER_CODE =  USERS.USER_CODE 
	JOIN USERS (NOLOCK) EDTUSERS ON T1.EDT_USER_CODE =  EDTUSERS.USER_CODE 
	WHERE RECON_ID = @CMEMOID 

GOTO LAST

LBLGETPDETAILS:
	
		SELECT T1.*,T4.ARTICLE_NAME ,T4.ARTICLE_NO ,A.MRP,A.PURCHASE_PRICE,T4.WHOLESALE_PRICE,C.PARA1_NAME,
		D.PARA2_NAME,F.PARA3_NAME,G.PARA4_NAME,H.PARA5_NAME,I.PARA6_NAME,SM.SECTION_NAME,SD.SUB_SECTION_NAME,
		C.PARA1_CODE,D.PARA2_CODE,F.PARA3_CODE,G.PARA4_CODE,H.PARA5_CODE,I.PARA6_CODE,T1.RECON_ID ,
		T2.UOM_NAME,T4.CODING_SCHEME,
		ISNULL(T4.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(F.DT_CREATED,'') AS [PARA3_DT_CREATED],  
		ISNULL(A.DT_CREATED,'') AS [SKU_DT_CREATED]
		FROM XNRECONP (NOLOCK) T1 
		LEFT OUTER  JOIN SKU (NOLOCK) A ON A.PRODUCT_CODE = T1.PRODUCT_CODE
		LEFT OUTER JOIN ARTICLE (NOLOCK) T4 ON A.ARTICLE_CODE = T4.ARTICLE_CODE
		LEFT OUTER JOIN SECTIOND (NOLOCK) SD ON T4.SUB_SECTION_CODE = SD.SUB_SECTION_CODE
		LEFT OUTER JOIN SECTIONM (NOLOCK) SM ON SD.SECTION_CODE = SM.SECTION_CODE
		LEFT OUTER JOIN PARA1 (NOLOCK) C ON A.PARA1_CODE = C.PARA1_CODE  
		LEFT OUTER JOIN PARA2 (NOLOCK) D ON A.PARA2_CODE = D.PARA2_CODE  
		LEFT OUTER JOIN PARA3 (NOLOCK) F ON A.PARA3_CODE = F.PARA3_CODE  
		LEFT OUTER JOIN PARA4 (NOLOCK) G ON A.PARA4_CODE = G.PARA4_CODE  
		LEFT OUTER JOIN PARA5 (NOLOCK) H ON A.PARA5_CODE = H.PARA5_CODE  
		LEFT OUTER JOIN PARA6 (NOLOCK) I ON A.PARA6_CODE = I.PARA6_CODE  
		LEFT OUTER JOIN UOM (NOLOCK) T2 ON T2.UOM_CODE = T4.UOM_CODE 
		WHERE  T1.RECON_ID = @CMEMOID 
		ORDER BY T1.BOX_NO,T1.TS 
	
	
GOTO LAST

LBLCHALLANNO:

  
IF @CXNTYPE ='PUR'  
 BEGIN  
  SELECT CAST((CASE WHEN ISNULL(@CMEMOID,'')='' THEN 0 ELSE 1 END) AS BIT) AS CHK,(CASE WHEN T1.INV_MODE=2 THEN T1.BILL_NO ELSE T1.MRR_NO END) AS CHALLAN_NO,  
  T1.INV_DT AS CHALLAN_DT,T1.MRR_ID AS CHALLAN_ID,
  T1.TOTAL_QUANTITY AS CHALLAN_QUANTITY, T1.TOTAL_AMOUNT AS [AMOUNT],T1.REMARKS,T1.receipt_dt
  FROM PIM01106 (NOLOCK) T1   
  --JOIN PID01106 (NOLOCK) T2 ON T1.MRR_ID = T2.MRR_ID 
  LEFT OUTER JOIN 
  (
	SELECT C.XN_ID FROM XNRECONMEMO (NOLOCK) C
	JOIN XNRECONM (NOLOCK) B ON C.RECON_ID=B.RECON_ID
	WHERE B.XN_TYPE='PUR'
  )X ON X.XN_ID=T1.MRR_ID  
  WHERE X.XN_ID IS NULL AND (CAST(T1.INV_DT AS DATE) BETWEEN @DFROM AND @DTO)  AND t1.dept_id= @CDEPTID
  AND    T1.MRR_ID=(CASE WHEN ISNULL(@CMEMOID,'')='' THEN T1.MRR_ID ELSE ISNULL(@CMEMOID,'') END)
  AND T1.CANCELLED =0
  AND ISNULL(T1.XN_ITEM_TYPE,0) IN(0,1)
  AND T1.INV_MODE=2
  --GROUP BY T1.MRR_NO,T1.INV_DT,T1.MRR_ID ,T1.TOTAL_AMOUNT ,T1.INV_MODE ,T1.BILL_NO,T1.REMARKS,T1.receipt_dt
 END  
ELSE   IF @CXNTYPE ='PUR_PARTY'  
 BEGIN  
  SELECT CAST((CASE WHEN ISNULL(@CMEMOID,'')='' THEN 0 ELSE 1 END) AS BIT) AS CHK,(CASE WHEN T1.INV_MODE=2 THEN T1.BILL_NO ELSE T1.MRR_NO END) AS CHALLAN_NO,  
  T1.INV_DT AS CHALLAN_DT,T1.MRR_ID AS CHALLAN_ID,
  T1.TOTAL_QUANTITY AS CHALLAN_QUANTITY, T1.TOTAL_AMOUNT AS [AMOUNT],T1.REMARKS,T1.receipt_dt
  FROM PIM01106 (NOLOCK) T1   
  --JOIN PID01106 (NOLOCK) T2 ON T1.MRR_ID = T2.MRR_ID 
  LEFT OUTER JOIN 
  (
	SELECT C.XN_ID FROM XNRECONMEMO (NOLOCK) C
	JOIN XNRECONM (NOLOCK) B ON C.RECON_ID=B.RECON_ID
	WHERE B.XN_TYPE IN ('PUR','PUR_PARTY')
  )X ON X.XN_ID=T1.MRR_ID  
  WHERE X.XN_ID IS NULL AND (CAST(T1.INV_DT AS DATE) BETWEEN @DFROM AND @DTO)  AND t1.dept_id= @CDEPTID
  AND    T1.MRR_ID=(CASE WHEN ISNULL(@CMEMOID,'')='' THEN T1.MRR_ID ELSE ISNULL(@CMEMOID,'') END)
  AND T1.CANCELLED =0
  AND ISNULL(T1.XN_ITEM_TYPE,0) IN(0,1)
  AND T1.INV_MODE=1
  --GROUP BY T1.MRR_NO,T1.INV_DT,T1.MRR_ID ,T1.TOTAL_AMOUNT ,T1.INV_MODE ,T1.BILL_NO,T1.REMARKS,T1.receipt_dt
 END  
ELSE 

IF @CXNTYPE ='PRT'  
 BEGIN  
  SELECT CAST(0 AS BIT) AS CHK, T1.RM_NO AS CHALLAN_NO,  
  T1.RM_DT AS CHALLAN_DT,T1.RM_ID AS CHALLAN_ID,
  SUM(T2.QUANTITY) AS CHALLAN_QUANTITY  , T1.TOTAL_AMOUNT AS [AMOUNT],T1.REMARKS
  FROM RMM01106 (NOLOCK) T1   
  JOIN RMD01106 (NOLOCK) T2 ON T1.RM_ID = T2.RM_ID 
  LEFT OUTER JOIN 
  (
	SELECT C.XN_ID FROM XNRECONMEMO (NOLOCK) C
	JOIN XNRECONM (NOLOCK) B ON C.RECON_ID=B.RECON_ID
	WHERE B.XN_TYPE='PRT'
  )X ON X.XN_ID=T1.RM_ID  
  WHERE X.XN_ID IS NULL AND (T1.RM_DT BETWEEN @DFROM AND @DTO) 
  AND T1.CANCELLED =0
  AND  T1.RM_ID=(CASE WHEN ISNULL(@CMEMOID,'')='' THEN T1.RM_ID ELSE ISNULL(@CMEMOID,'') END)
   AND t1.location_code= @CDEPTID
   AND ISNULL(T1.XN_ITEM_TYPE,0) IN(0,1)
  GROUP BY T1.RM_NO,T1.RM_DT,T1.RM_ID   ,T1.TOTAL_AMOUNT ,T1.REMARKS
 END  
ELSE   
IF @CXNTYPE ='WSI'  
 BEGIN  
  SELECT CAST(0 AS BIT) AS CHK, T1.INV_NO AS CHALLAN_NO,  
  T1.INV_DT AS CHALLAN_DT,T1.INV_ID AS CHALLAN_ID,
  SUM(T2.QUANTITY) AS CHALLAN_QUANTITY  , T1.NET_AMOUNT AS [AMOUNT],T1.REMARKS
  FROM INM01106 (NOLOCK) T1   
  JOIN IND01106 (NOLOCK) T2 ON T1.INV_ID = T2.INV_ID   
  LEFT OUTER JOIN 
  (
	SELECT C.XN_ID FROM XNRECONMEMO (NOLOCK) C
	JOIN XNRECONM (NOLOCK) B ON C.RECON_ID=B.RECON_ID
	WHERE B.XN_TYPE='WSI'
  )X ON X.XN_ID=T1.INV_ID  
  WHERE X.XN_ID IS NULL AND ( T1.INV_DT BETWEEN @DFROM AND @DTO )   
  AND T1.CANCELLED =0 AND t1.location_Code= @CDEPTID
  AND ISNULL(T1.XN_ITEM_TYPE,0) IN(0,1)
  AND  T1.INV_ID=(CASE WHEN ISNULL(@CMEMOID,'')='' THEN T1.INV_ID ELSE ISNULL(@CMEMOID,'') END) 
  GROUP BY T1.INV_NO,T1.INV_DT,T1.INV_ID   ,T1.NET_AMOUNT ,T1.REMARKS
 END  
ELSE   
IF @CXNTYPE ='WSR'  
 BEGIN  

  SELECT CAST(0 AS BIT) AS CHK,
  (CASE WHEN T1.MODE=2 THEN  isnull(NULLIF(T1.MANUAL_INV_NO,''),T1.manual_dn_no)  ELSE T1.CN_NO END) AS CHALLAN_NO,  
  T1.CN_DT AS CHALLAN_DT,T1.CN_ID AS CHALLAN_ID,
  SUM(T2.QUANTITY) AS CHALLAN_QUANTITY  , T1.TOTAL_AMOUNT AS [AMOUNT],T1.REMARKS
  FROM CNM01106 (NOLOCK) T1   
  JOIN CND01106 (NOLOCK) T2 ON T1.CN_ID = T2.CN_ID   
  LEFT OUTER JOIN 
  (
	SELECT C.XN_ID FROM XNRECONMEMO (NOLOCK) C
	JOIN XNRECONM (NOLOCK) B ON C.RECON_ID=B.RECON_ID
	WHERE B.XN_TYPE='WSR'
  )X ON X.XN_ID=T1.CN_ID  
  WHERE X.XN_ID IS NULL 
  AND (@CMEMOID<> '' or  T1.manual_dn_dt BETWEEN @DFROM AND @DTO)   --changes Required Problem In Lakshita(2-08-2022)
  AND T1.CANCELLED =0 AND t1.location_Code= @CDEPTID
  AND ISNULL(T1.XN_ITEM_TYPE,0) IN(0,1)
  AND T1.CN_ID=(CASE WHEN ISNULL(@CMEMOID,'')='' THEN T1.CN_ID ELSE ISNULL(@CMEMOID,'') END)    
  GROUP BY T1.CN_NO,T1.CN_DT,T1.CN_ID   ,T1.TOTAL_AMOUNT ,T1.MODE ,  isnull(NULLIF(T1.MANUAL_INV_NO,''),T1.manual_dn_no),T1.REMARKS



 END   
ELSE 
 IF @CXNTYPE ='DCO'  
 BEGIN  
  SELECT CAST(0 AS BIT) AS CHK,T1.MEMO_NO  AS CHALLAN_NO,  
  T1.MEMO_DT AS CHALLAN_DT,T1.MEMO_ID  AS CHALLAN_ID,
  SUM(T2.QUANTITY) AS CHALLAN_QUANTITY  , 0 AS [AMOUNT],T1.REMARKS
  FROM FLOOR_ST_MST t1 (NOLOCK)    
  JOIN FLOOR_ST_DET t2 (NOLOCK)  ON T1.MEMO_ID  = T2.MEMO_ID   
  
  LEFT OUTER JOIN 
  (
	SELECT C.XN_ID FROM XNRECONMEMO (NOLOCK) C
	JOIN XNRECONM (NOLOCK) B ON C.RECON_ID=B.RECON_ID
	WHERE B.XN_TYPE='DCO'
  )X ON X.XN_ID=T1.MEMO_ID   
  WHERE X.XN_ID IS NULL AND ( T1.MEMO_DT  BETWEEN @DFROM AND @DTO) 
  AND T1.CANCELLED =0 AND t1.location_Code= @CDEPTID
  AND T1.MEMO_ID=(CASE WHEN ISNULL(@CMEMOID,'')='' THEN T1.MEMO_ID ELSE ISNULL(@CMEMOID,'') END)    
  GROUP BY T1.MEMO_NO ,T1.MEMO_DT ,T1.MEMO_ID   , T1.MEMO_ID ,T1.REMARKS
 END
 
ELSE
  
IF @CXNTYPE =''  
 BEGIN  
  SELECT CAST(0 AS BIT) AS CHK, CONVERT(VARCHAR(50),'') AS CHALLAN_NO,  
  CONVERT(DATETIME,'') AS CHALLAN_DT,CONVERT(VARCHAR(50),'') AS CHALLAN_ID,
  CONVERT(NUMERIC(14,2),0) AS CHALLAN_QUANTITY  ,CONVERT(NUMERIC(14,2),0) AS [AMOUNT],CAST('' AS VARCHAR) AS REMARKS
  
 END   

GOTO LAST

LBLGETSKUITEMS:
	
--SELECT A.*,T4.*,CAST(1 AS NUMERIC(10,2)) AS QUANTITY,C.PARA1_NAME,
SELECT A.PRODUCT_CODE,T4.ARTICLE_CODE,ARTICLE_NO,T4.ARTICLE_NAME,CAST(1 AS NUMERIC(10,2)) AS QUANTITY,C.PARA1_NAME,
D.PARA2_NAME,F.PARA3_NAME,G.PARA4_NAME,H.PARA5_NAME,I.PARA6_NAME,SM.SECTION_NAME,SD.SUB_SECTION_NAME,
C.PARA1_CODE,D.PARA2_CODE,F.PARA3_CODE,G.PARA4_CODE,H.PARA5_CODE,I.PARA6_CODE,
UOM.UOM_NAME,T4.CODING_SCHEME,
ISNULL(T4.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(F.DT_CREATED,'') AS [PARA3_DT_CREATED],  
ISNULL(A.DT_CREATED,'') AS [SKU_DT_CREATED],A.MRP --ADD A.MRP COLUMN BY JAI RAM KUMAR ON 14-APRIL-2017
FROM SKU (NOLOCK) A 
JOIN ARTICLE (NOLOCK)  T4 ON A.ARTICLE_CODE = T4.ARTICLE_CODE 
JOIN SECTIOND (NOLOCK) SD ON T4.SUB_SECTION_CODE = SD.SUB_SECTION_CODE
JOIN SECTIONM (NOLOCK) SM ON SD.SECTION_CODE = SM.SECTION_CODE
JOIN PARA1 (NOLOCK) C ON A.PARA1_CODE = C.PARA1_CODE  
JOIN PARA2 (NOLOCK) D ON A.PARA2_CODE = D.PARA2_CODE  
JOIN PARA3 (NOLOCK) F ON A.PARA3_CODE = F.PARA3_CODE  
JOIN PARA4 (NOLOCK) G ON A.PARA4_CODE = G.PARA4_CODE  
JOIN PARA5 (NOLOCK) H ON A.PARA5_CODE = H.PARA5_CODE  
JOIN PARA6 (NOLOCK) I ON A.PARA6_CODE = I.PARA6_CODE  
JOIN UOM (NOLOCK) ON T4.UOM_CODE = UOM.UOM_CODE AND A.PRODUCT_CODE <> '' 
--WHERE A.PRODUCT_CODE = @CWHERE-- OR A.PRODUCT_CODE LIKE @CWHERE+'@%'
where ( A.product_code=@CWHERE)--  OR  CHARINDEX(@CWHERE+'@',A.PRODUCT_CODE)>0)
	
GOTO LAST

LBLGETCDETAILS:
	
	SELECT T1.*,T4.ARTICLE_NAME ,T4.ARTICLE_NO,A.MRP,A.PURCHASE_PRICE,T4.WHOLESALE_PRICE ,C.PARA1_NAME,
	D.PARA2_NAME,F.PARA3_NAME,G.PARA4_NAME,H.PARA5_NAME,I.PARA6_NAME,SM.SECTION_NAME,SD.SUB_SECTION_NAME,
	C.PARA1_CODE,D.PARA2_CODE,F.PARA3_CODE,G.PARA4_CODE,H.PARA5_CODE,I.PARA6_CODE,
	T2.UOM_NAME,T4.CODING_SCHEME,'' AS USER_CODE,
	ISNULL(T4.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(F.DT_CREATED,'') AS [PARA3_DT_CREATED],  
    ISNULL(A.DT_CREATED,'') AS [SKU_DT_CREATED]
	FROM XNRECONC (NOLOCK) T1 
	LEFT OUTER JOIN SKU (NOLOCK) A ON A.PRODUCT_CODE = T1.PRODUCT_CODE
	LEFT OUTER  JOIN ARTICLE (NOLOCK) T4 ON A.ARTICLE_CODE = T4.ARTICLE_CODE
	LEFT OUTER  JOIN SECTIOND (NOLOCK) SD ON T4.SUB_SECTION_CODE = SD.SUB_SECTION_CODE
	LEFT OUTER  JOIN SECTIONM (NOLOCK) SM ON SD.SECTION_CODE = SM.SECTION_CODE
	LEFT OUTER  JOIN PARA1 (NOLOCK) C ON A.PARA1_CODE = C.PARA1_CODE  
	LEFT OUTER  JOIN PARA2 (NOLOCK) D ON A.PARA2_CODE = D.PARA2_CODE  
	LEFT OUTER  JOIN PARA3 (NOLOCK) F ON A.PARA3_CODE = F.PARA3_CODE  
	LEFT OUTER  JOIN PARA4 (NOLOCK) G ON A.PARA4_CODE = G.PARA4_CODE  
	LEFT OUTER  JOIN PARA5 (NOLOCK) H ON A.PARA5_CODE = H.PARA5_CODE  
	LEFT OUTER  JOIN PARA6 (NOLOCK) I ON A.PARA6_CODE = I.PARA6_CODE  
	LEFT OUTER  JOIN UOM (NOLOCK) T2 ON T2.UOM_CODE = T4.UOM_CODE
	WHERE T1.RECON_ID = @CMEMOID  
	

GOTO LAST

LBLGETMEMODETAILS:

IF @CXNTYPE IN ('PUR','PUR_PARTY')
	BEGIN
		SELECT T1.*,T1.XN_ID AS CHALLAN_ID,CAST(1 AS BIT) AS CHK,T2.MRR_NO AS CHALLAN_NO,
		T2.INV_DT AS CHALLAN_DT,M.CHALLAN_QUANTITY  ,T2.TOTAL_AMOUNT AS [AMOUNT], T2.BILL_NO AS SOURCE_MEMO_NO,T2.REMARKS,T2.RECEIPT_DT
		,ISNULL(Z.TOTAL_BOX,0) AS Total_Box
		FROM XNRECONMEMO (NOLOCK) T1
		JOIN PIM01106 (NOLOCK) T2 ON T2.MRR_ID = T1.XN_ID 
		JOIN
		(
			SELECT T1.MRR_ID AS CHALLAN_ID,T1.TOTAL_QUANTITY AS CHALLAN_QUANTITY,TOTAL_BOX_NO AS Total_Box
			FROM PIM01106 (NOLOCK) T1 
			--JOIN PID01106 (NOLOCK) T2 ON T1.MRR_ID = T2.MRR_ID 
 			--GROUP BY T1.MRR_ID
		) M ON T2.MRR_ID = M.CHALLAN_ID  
		LEFT OUTER JOIN
		(
			SELECT MRR_ID,COUNT(BOX) AS TOTAL_BOX FROM PUR_BOX(NOLOCK) GROUP BY MRR_ID
		)Z ON Z.MRR_ID=T2.MRR_ID
		WHERE T1.RECON_ID = @CMEMOID
	END
ELSE 
IF @CXNTYPE ='PRT'
	BEGIN
		SELECT T1.*,T1.XN_ID AS CHALLAN_ID,CAST(1 AS BIT) AS CHK, T2.RM_NO AS CHALLAN_NO,T2.RM_DT AS CHALLAN_DT
		,M.CHALLAN_QUANTITY  ,T2.TOTAL_AMOUNT AS [AMOUNT],T2.REMARKS,M.Total_Box
		FROM XNRECONMEMO (NOLOCK) T1
		JOIN RMM01106 (NOLOCK) T2 ON T2.RM_ID = T1.XN_ID 
		JOIN
		(
			SELECT T1.RM_ID AS CHALLAN_ID,SUM(T2.QUANTITY) AS CHALLAN_QUANTITY,COUNT(DISTINCT T2.box_no) AS Total_Box
			FROM RMM01106 (NOLOCK) T1 
			JOIN RMD01106 (NOLOCK) T2 ON T1.RM_ID = T2.RM_ID  
			GROUP BY T1.RM_ID
		) M ON T2.RM_ID = M.CHALLAN_ID 
		WHERE T1.RECON_ID = @CMEMOID

		
	END
ELSE 
IF @CXNTYPE ='WSI'
	BEGIN
		SELECT T1.*,T1.XN_ID AS CHALLAN_ID,CAST(1 AS BIT) AS CHK, T2.INV_NO AS CHALLAN_NO,T2.INV_DT AS CHALLAN_DT
		,M.CHALLAN_QUANTITY  ,T2.NET_AMOUNT AS [AMOUNT],T2.REMARKS,M.Total_Box
		FROM XNRECONMEMO (NOLOCK) T1
		JOIN INM01106 (NOLOCK) T2 ON T2.INV_ID = T1.XN_ID 
		JOIN
		(
			SELECT T1.INV_ID AS CHALLAN_ID,SUM(T2.QUANTITY) AS CHALLAN_QUANTITY,COUNT(DISTINCT T2.box_no) AS Total_Box
			FROM INM01106 (NOLOCK) T1 
			JOIN IND01106 (NOLOCK) T2 ON T1.INV_ID = T2.INV_ID 
			GROUP BY T1.INV_ID
		) M ON T2.INV_ID = M.CHALLAN_ID 
		WHERE T1.RECON_ID = @CMEMOID
		
	END
ELSE 
IF @CXNTYPE ='WSR'
	BEGIN
		SELECT T1.*,T1.XN_ID AS CHALLAN_ID,CAST(1 AS BIT) AS CHK,T2.CN_NO
		AS CHALLAN_NO,T2.CN_DT AS CHALLAN_DT,M.CHALLAN_QUANTITY  ,T2.TOTAL_AMOUNT AS [AMOUNT],
		(CASE WHEN T2.MODE=2 THEN RIGHT(T2.RM_ID,10) ELSE T2.CN_NO END) AS SOURCE_MEMO_NO,T2.REMARKS,M.Total_Box
		FROM XNRECONMEMO (NOLOCK) T1
		JOIN CNM01106 (NOLOCK) T2 ON T2.CN_ID = T1.XN_ID 
		JOIN
		(
			SELECT T1.CN_ID AS CHALLAN_ID,SUM(T2.QUANTITY) AS CHALLAN_QUANTITY,CAST(0 AS INT) AS Total_Box
			FROM CNM01106 (NOLOCK) T1 
			JOIN CND01106 (NOLOCK) T2 ON T1.CN_ID = T2.CN_ID 
			GROUP BY T1.CN_ID
		) M ON T2.CN_ID = M.CHALLAN_ID  
		WHERE T1.RECON_ID = @CMEMOID
		
	END	
ELSE 

IF @CXNTYPE ='DCO'
	BEGIN
		SELECT T1.*,T1.XN_ID AS CHALLAN_ID,CAST(1 AS BIT) AS CHK,T2.MEMO_NO 
		AS CHALLAN_NO,T2.MEMO_DT  AS CHALLAN_DT,M.CHALLAN_QUANTITY  ,0 AS [AMOUNT],
		T2.MEMO_NO  AS SOURCE_MEMO_NO,T2.REMARKS,M.Total_Box
		FROM XNRECONMEMO (NOLOCK) T1
		JOIN FLOOR_ST_MST (NOLOCK) T2 ON T2.MEMO_ID = T1.XN_ID 
		JOIN
		(
			SELECT T1.MEMO_ID  AS CHALLAN_ID,SUM(T2.QUANTITY) AS CHALLAN_QUANTITY,COUNT(DISTINCT T2.box_no) AS Total_Box
			FROM FLOOR_ST_MST (NOLOCK) T1 
			JOIN FLOOR_ST_DET (NOLOCK) T2 ON T1.MEMO_ID  = T2.MEMO_ID 
			GROUP BY T1.MEMO_ID 
		) M ON T2.MEMO_ID  = M.CHALLAN_ID  
		WHERE T1.RECON_ID = @CMEMOID
		
	END	
ELSE

IF @CXNTYPE =''
	BEGIN
		SELECT T1.*,T1.XN_ID AS CHALLAN_ID,CAST(1 AS BIT) AS CHK, T2.CN_NO AS CHALLAN_NO,T2.CN_DT AS CHALLAN_DT
		,0 AS CHALLAN_QUANTITY  ,0 AS [AMOUNT],T2.REMARKS,CAST(0 AS INT) AS Total_Box
		FROM XNRECONMEMO (NOLOCK) T1
		JOIN CNM01106 (NOLOCK) T2 ON T2.CN_ID = T1.XN_ID 
		WHERE 1 = 2
	END	
	

GOTO LAST

LBLGETBOXNO:

	SELECT DISTINCT ISNULL(BOX_NO,1) AS BOX_NO,RECON_ID 
	FROM XNRECONP (NOLOCK)
	WHERE RECON_ID = @CMEMOID

GOTO LAST



LBLCHALLANCDETAILS:
	
IF @CXNTYPE ='PUR'  
 BEGIN  
  SET @CCMD2 = N'SELECT T1.PRODUCT_CODE,SUM(T1.QUANTITY) AS QUANTITY   
  FROM PID01106 (NOLOCK) T1    
  JOIN XNRECONMEMO (NOLOCK)  O ON O.XN_ID = T1.MRR_ID 
  JOIN XNRECONM (NOLOCK) M ON O.RECON_ID = M.RECON_ID  
  WHERE M.XN_TYPE = ''PUR'' AND M.RECON_ID =  ''' +@CMEMOID+ '''  
  GROUP BY T1.PRODUCT_CODE'  
 END  
ELSE   
IF @CXNTYPE ='PRT'  
 BEGIN  
  SET @CCMD2 = N'SELECT T1.PRODUCT_CODE,SUM(T1.QUANTITY) AS QUANTITY   
  FROM RMD01106 (NOLOCK) T1    
  JOIN XNRECONMEMO (NOLOCK) O  ON O.XN_ID = T1.RM_ID
  JOIN XNRECONM (NOLOCK) M ON O.RECON_ID = M.RECON_ID    
  WHERE M.XN_TYPE = ''PRT'' AND M.RECON_ID =  ''' +@CMEMOID+ '''  
  GROUP BY T1.PRODUCT_CODE'  
 END  
ELSE   
IF @CXNTYPE ='WSI'  
 BEGIN  
  SET @CCMD2 = N'SELECT T1.PRODUCT_CODE,SUM(T1.QUANTITY) AS QUANTITY   
  FROM IND01106 (NOLOCK) T1    
  JOIN XNRECONMEMO (NOLOCK)  O  ON O.XN_ID = T1.INV_ID 
  JOIN XNRECONM (NOLOCK) M ON O.RECON_ID = M.RECON_ID    
  WHERE M.XN_TYPE = ''WSI'' AND M.RECON_ID =  ''' +@CMEMOID+ '''  
  GROUP BY T1.PRODUCT_CODE'  
 END  
ELSE   
IF @CXNTYPE ='WSR'  
 BEGIN  
  SET @CCMD2 = N'SELECT T1.PRODUCT_CODE,SUM(T1.QUANTITY) AS QUANTITY  
  FROM CND01106 (NOLOCK) T1    
  JOIN XNRECONMEMO (NOLOCK)  O ON O.XN_ID = T1.CN_ID  
  JOIN XNRECONM (NOLOCK) M ON O.RECON_ID = M.RECON_ID    
  WHERE M.XN_TYPE = ''WSR'' AND M.RECON_ID =  ''' +@CMEMOID+ '''  
  GROUP BY T1.PRODUCT_CODE'  
 END   
ELSE  

IF @CXNTYPE ='DCO'  
 BEGIN  
  SET @CCMD2 = N'SELECT T1.PRODUCT_CODE,SUM(T1.QUANTITY) AS QUANTITY  
  FROM FLOOR_ST_DET (NOLOCK) T1    
  JOIN XNRECONMEMO (NOLOCK)  O ON O.XN_ID = T1.MEMO_ID  
  JOIN XNRECONM (NOLOCK) M ON O.RECON_ID = M.RECON_ID    
  WHERE M.XN_TYPE = ''DCO'' AND M.RECON_ID =  ''' +@CMEMOID+ '''  
  GROUP BY T1.PRODUCT_CODE'  
 END    
ELSE 
 
IF @CXNTYPE =''  
 BEGIN  
  SET @CCMD2 = N'SELECT T1.PRODUCT_CODE,T1.QUANTITY FROM CND01106 (NOLOCK) T1 WHERE 1 = 2'  
 END 
	


SET @CCMD = N'SELECT A.PRODUCT_CODE,A.QUANTITY,T7.MRP,T7.PURCHASE_PRICE,T7.WHOLESALE_PRICE,
		T7.ARTICLE_NAME ,T7.ARTICLE_NO ,C1.PARA1_NAME ,
		D1.PARA2_NAME ,F1.PARA3_NAME ,G1.PARA4_NAME ,
		H1.PARA5_NAME ,I1.PARA6_NAME ,SM1.SECTION_NAME ,
		SD1.SUB_SECTION_NAME ,T8.UOM_NAME ,'''+@CMEMOID+''' AS RECON_ID ,
		ISNULL(T7.DT_CREATED,'''') AS [ART_DT_CREATED],ISNULL(F1.DT_CREATED,'''') AS [PARA3_DT_CREATED],  
        ISNULL(T6.DT_CREATED,'''') AS [SKU_DT_CREATED]
		FROM 
		('+@CCMD2+') A 
		JOIN SKU (NOLOCK) T6 ON T6.PRODUCT_CODE = A.PRODUCT_CODE
		JOIN ARTICLE (NOLOCK) T7 ON T6.ARTICLE_CODE = T7.ARTICLE_CODE
		JOIN SECTIOND (NOLOCK) SD1 ON T7.SUB_SECTION_CODE = SD1.SUB_SECTION_CODE
		JOIN SECTIONM (NOLOCK) SM1 ON SD1.SECTION_CODE = SM1.SECTION_CODE
		JOIN PARA1 (NOLOCK) C1 ON T6.PARA1_CODE = C1.PARA1_CODE  
		JOIN PARA2 (NOLOCK) D1 ON T6.PARA2_CODE = D1.PARA2_CODE  
		JOIN PARA3 (NOLOCK) F1 ON T6.PARA3_CODE = F1.PARA3_CODE  
		JOIN PARA4 (NOLOCK) G1 ON T6.PARA4_CODE = G1.PARA4_CODE  
		JOIN PARA5 (NOLOCK) H1 ON T6.PARA5_CODE = H1.PARA5_CODE  
		JOIN PARA6 (NOLOCK) I1 ON T6.PARA6_CODE = I1.PARA6_CODE  
		JOIN UOM (NOLOCK) T8 ON T8.UOM_CODE = T7.UOM_CODE'
		
PRINT @CCMD	
EXEC SP_EXECUTESQL @CCMD


GOTO LAST
LBLBOXNO_LIST:

IF OBJECT_ID('TEMP..#BOXLIST','U') IS NOT NULL
	DROP TABLE #BOXLIST
	
SELECT CAST('' AS VARCHAR(100)) AS XN_ID,CAST('' AS VARCHAR(100)) AS BOX_NO
INTO #BOXLIST
WHERE 1=2

IF @CXNTYPE ='PUR'  
 BEGIN  
  SET @CMEMOID = REPLACE(@CMEMOID,' ','')
  SET @CCMD2 = N'SELECT T1.MRR_ID,T1.BOX AS BOX_NO   
  FROM PUR_BOX  T1  (NOLOCK)  
  WHERE T1.MRR_ID IN  (''' +REPLACE(@CMEMOID,',',''',''') + '''  )
  GROUP BY T1.MRR_ID,T1.BOX'  
 END
 
 
 PRINT @CCMD2	
 INSERT INTO #BOXLIST(XN_ID,BOX_NO)
	EXEC SP_EXECUTESQL @CCMD2
SELECT * FROM #BOXLIST
GOTO LAST
LBLGETBOXNO_NEXT:

	DECLARE @nMaxBoxNo NUMERIC(15)
	
	SELECT @nMaxBoxNo =MAX(ISNULL(CAST(BOX_NO AS NUMERIC(15)),0))-- AS BOX_NO,RECON_ID 
	FROM XNRECONP (NOLOCK)
	WHERE RECON_ID = @CMEMOID 
	AND ISNUMERIC(BOX_NO)=1
	GROUP BY RECON_ID
	
	SELECT ISNULL(@nMaxBoxNo ,0)+1 AS BOX_NO
	
GOTO LAST
LAST:
END



