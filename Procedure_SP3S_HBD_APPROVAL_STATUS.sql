CREATE PROCEDURE SP3S_HBD_APPROVAL_STATUS
(
  @DASONDATE DATETIME='2020-05-06',
  @cLocId VARCHAR(5)='',
  @bShowAll		INT=0,
  @cUserCode		VARCHAR(10)
)
AS
BEGIN
      
	  DECLARE @CDEPT_ID VARCHAR(5),@CHO_DEPT_ID VARCHAR(5)

	  SELECT @CHO_DEPT_ID=value FROM CONFIG WHERE config_option='HO_LOCATION_ID'
   	IF @cLocId=''
		SELECT @CDEPT_ID = DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
    ELSE
		SET @CDEPT_ID=@cLocId
	  --Item Code	Section	Sub Section	Location Id / Name	Memo No.	Date	Ageing Days	Customer Name	Mobile	E-Mail	Status (Combo)	Process (Auto Fill)

	  CREATE TABLE #Locusers(Dept_ID VARCHAR(5))

	  IF ISNULL(@cUserCode,'')<>''
	  BEGIN
		  INSERT INTO #Locusers(Dept_ID)
		  SELECT dept_id FROM LOCUSERS WHERE user_code=@cUserCode
	  END
	  ELSE
	  BEGIN
		  INSERT INTO #Locusers(Dept_ID)
		  SELECT dept_id FROM LOCATION
	  END


	  SELECT CASt(0 AS BIT) AS CHK,A.PRODUCT_CODE  , A.REMARKS AS ITEM_REMARKS,	
	           B.REMARKS AS MEMO_REMARKS,
	           SN.SECTION_NAME ,
	           SN.SUB_SECTION_NAME,
			   L.DEPT_ID+'-'+L.DEPT_NAME AS DEPT_NAME,
			   B.MEMO_NO,B.MEMO_DT ,
			   DATEDIFF(DD,B.MEMO_DT,GETDATE ()) AS AGEING_DAYS,
			   CUST.CUSTOMER_FNAME +' '+CUST.CUSTOMER_LNAME AS CUSTOMER_NAME,
			   CUST.MOBILE ,CUST.EMAIL,
			   CASE WHEN ISNULL(A.HBD_STATUS,0)=1 THEN 'APPROVED & ISSUE CREDIT NOTE' 
			        WHEN ISNULL(A.HBD_STATUS,0)=2 THEN 'FREE REPAIR & RETURN' 
					WHEN ISNULL(A.HBD_STATUS,0)=3 THEN 'CHARGED REPAIR & RETURN' 
					WHEN ISNULL(A.HBD_STATUS,0)=4 THEN 'DISAPPROVED & RETURN'
			    ELSE '' END AS HBD_STATUS_NAME,
			    CASE WHEN ISNULL(A.PROCESS,0)=1 THEN 'RETURN TO CUSTOMER' 
			        WHEN ISNULL(A.PROCESS,0)=2 THEN 'JOBWORK ISSUE' 
			    ELSE '' END AS PROCESS_NAME,
			   A.ROW_ID,A.MEMO_ID,ISNULL(A.PROCESS,0) AS PROCESS,ISNULL(A.HBD_STATUS,0) AS HBD_STATUS
			   ,L.DEPT_ID ,A.job_rate,CAST('' AS VARCHAR(MAX)) AS REMARKS,j.job_name,
			   CASE WHEN ISNULL(A.Additional_job,'')='' THEN 'Select Jobs...' ELSE A.Additional_job END AS Additional_job,
			   A.Additional_job_HO
			   ,PMT.QUANTITY_IN_STOCK AS QUANTITY,ISNULL(A.CN_PRODUCT_CODE,'') AS CN_PRODUCT_CODE
			   ,ISNULL(A.CN_REF_BILL_NO,'') AS CN_REF_BILL_NO,ISNULL(A.CN_REF_BILL_DT,'') AS CN_REF_BILL_DT
			   ,SN.article_no,SN.para1_name,sn.para2_name,sn.para3_name,sn.para4_name,sn.para5_name,sn.para6_name,
			   (CASE WHEN ISNULL(A.SOLD_PRODUCT_CODE,'')='' THEN cmd.PRODUCT_CODE ELSE A.SOLD_PRODUCT_CODE END) SOLD_PRODUCT_CODE,
			   (CASE WHEN ISNULL(A.SOLD_PRODUCT_CODE,'')='' THEN (cmd.NET-CMD.cmm_discount_amount) ELSE A.SOLD_NET_AMOUNT END)  as SOLD_NET_AMOUNT,
			   ISNULL(A.SOLD_BILL_NO,'') as SOLD_BILL_NO, ISNULL(A.SOLD_BILL_DT,'')  as SOLD_BILL_DT
	  FROM HOLD_BACK_DELIVER_DET A (NOLOCK)
	  JOIN HOLD_BACK_DELIVER_MST B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
	  JOIN #Locusers loc ON loc.Dept_ID=B.location_Code
	  LEFT OUTER JOIN ITEM_STATUS ITEM (NOLOCK) ON ITEM.HBD_ROW_ID=A.ROW_ID
	  LEFT OUTER JOIN cmd01106 cmd (NOLOCK) ON cmd.ROW_ID=A.ref_cmd_row_id
	  JOIN SKU_NAMES SN (NOLOCK) ON A.PRODUCT_CODE=SN.PRODUCT_CODE
	  JOIN LOCATION  L (NOLOCK) ON L.DEPT_ID=B.location_Code
	  JOIN CUSTDYM CUST (NOLOCK) ON CUST.CUSTOMER_CODE=B.CUSTOMER_CODE
	  JOIN PMT01106 PMT (NOLOCK) ON A.PRODUCT_CODE=PMT.PRODUCT_CODE and pmt.BIN_ID='999' and pmt.DEPT_ID=@CHO_DEPT_ID
	  JOIN jobs j (NOLOCK) ON  j.job_code=A.job_code
	  WHERE B.CANCELLED=0
	  and a.delivered=0
	  and ISNULL(item.DELIVER_MEMO_ID,'') ='' 
	  AND (ISNULL(item.ISSUE_ID,'')='' OR ISNULL(item.RECEIPT_ID,'')<>'')
	  --AND MEMO_DT <=@DASONDATE
	  AND isnull(@DASONDATE,'')<>''
	  AND @CHO_DEPT_ID=@CDEPT_ID
	  --AND PMT.QUANTITY_IN_STOCK>0
	  --and isnull(A.HBD_STATUS,0)=0
	  AND (@bShowAll=0 OR (@bShowAll=1 AND  ISNULL(A.HBD_STATUS,0)=0 AND PMT.QUANTITY_IN_STOCK>0) OR 	  (@bShowAll=2 AND  ISNULL(A.HBD_STATUS,0)>0))
	  ORDER BY DATEDIFF(DD,B.MEMO_DT,GETDATE ()) DESC


END

