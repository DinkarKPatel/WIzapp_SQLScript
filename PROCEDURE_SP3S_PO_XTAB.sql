
create PROCEDURE SP3S_PO_XTAB  
@CWHERE VARCHAR(500)=''  
   
AS      
BEGIN   
     
     
  
IF OBJECT_ID ('TEMPDB..#TMPDETAILS','U') IS NOT NULL                          
         DROP TABLE #TMPDETAILS    
  
SELECT  T1.po_DT,T1.po_NO,T2.AC_NAME,T1.TOTAL_AMOUNT,   
     T1.OTHER_CHARGES AS OTHER_CHARGES,T1.DISCOUNT_AMOUNT AS MST_DISCOUNT_AMOUNT,        
     T1.SUBTOTAL AS AMOUNT_WO_TAX,PARA1.PARA1_NAME,  
	SECTIOND.SUB_SECTION_NAME,SECTIONM.SECTION_NAME,ARTICLE.ARTICLE_NO,    
     SUM(T3.QUANTITY) AS QTY  ,COM.COMPANY_CODE ,COM.LOGO_PATH,  
     COM.COMPANY_NAME  AS COMPANY_NAME ,  
     L.ADDRESS1 AS LOC_ADDRESS1,  
     L.ADDRESS2 AS LOC_ADDRESS2,  
     LCT.CITY AS LOC_CITY,  
     L.PHONE LOC_PHONES_FAX  ,
	 L.LOC_GST_NO AS LOC_GST_NO
	 ,T2.ADDRESS0,T2.ADDRESS1,T2.ADDRESS2,T2.AREA_NAME,
	 T2.CITY,T2.STATE,T2.PINCODE,  
	  ARTICLE.DT_CREATED,
	  T1.REF_NO,T3.MRP,t3.PURCHASE_PRICE,  
	  ARTICLE.ALIAS AS ARTICLE_ALIAS,ARTICLE.ARTICLE_NAME,T2.TIN_NO,T1.REMARKS AS MST_REMARKS,  
	  SR_NO=ROW_NUMBER() OVER (ORDER BY T1.po_DT) ,  
	  SUM(T3.QUANTITY*T3.PURCHASE_PRICE) AS AMOUNT,  
	  T1.CHECKED_BY,  
	  T1.SENT_BY,  
	  L.dept_name  AS PO_FOR_DEPT_NAME--,  
    ,CAST(0 AS INT)SIZE1,CAST(0 AS INT)SIZE2,CAST(0 AS INT)SIZE3,CAST(0 AS INT)SIZE4,CAST(0 AS INT)SIZE5,CAST(0 AS INT)SIZE6                
    ,CAST(0 AS INT)SIZE7,CAST(0 AS INT)SIZE8,CAST(0 AS INT)SIZE9,CAST(0 AS INT)SIZE10,CAST(0 AS INT)SIZE11,CAST(0 AS INT)SIZE12    
   ,t3.para1_code    ,PARA3.PARA3_NAME ,PARA4.PARA4_NAME ,PARA5.PARA5_NAME ,PARA6.PARA6_NAME 
		,ISNULL(A1.ATTR1_KEY_NAME,'') as ATTR1_KEY_NAME   ,ISNULL(A2.ATTR2_KEY_NAME,'')  as ATTR2_KEY_NAME
		,ISNULL(A3.ATTR3_KEY_NAME,'') as ATTR3_KEY_NAME  ,ISNULL(A4.ATTR4_KEY_NAME,'') as ATTR4_KEY_NAME
		,ISNULL(A5.ATTR5_KEY_NAME,'') as ATTR5_KEY_NAME,ISNULL(A6.ATTR6_KEY_NAME,'') as ATTR6_KEY_NAME
		,ISNULL(A7.ATTR7_KEY_NAME,'')  ATTR7_KEY_NAME ,ISNULL(A8.ATTR8_KEY_NAME,'')  ATTR8_KEY_NAME
		,ISNULL(A9.ATTR9_KEY_NAME,'')  ATTR9_KEY_NAME ,ISNULL(A10.ATTR10_KEY_NAME,'') ATTR10_KEY_NAME
		,ISNULL(A11.ATTR11_KEY_NAME,'') ATTR11_KEY_NAME,ISNULL(A12.ATTR12_KEY_NAME,'') ATTR12_KEY_NAME
		,ISNULL(A13.ATTR13_KEY_NAME,'') ATTR13_KEY_NAME ,ISNULL(A14.ATTR14_KEY_NAME,'') ATTR14_KEY_NAME
		,ISNULL(A15.ATTR15_KEY_NAME,'') ATTR15_KEY_NAME     
		,ISNULL(A16.ATTR16_KEY_NAME,'') ATTR16_KEY_NAME,ISNULL(A17.ATTR17_KEY_NAME,'') ATTR17_KEY_NAME
		,ISNULL(A18.ATTR18_KEY_NAME,'') ATTR18_KEY_NAME,ISNULL(A19.ATTR19_KEY_NAME,'') ATTR19_KEY_NAME
		,ISNULL(A20.ATTR20_KEY_NAME,'')  ATTR20_KEY_NAME  ,ISNULL(A21.ATTR21_KEY_NAME,'') ATTR21_KEY_NAME
		 ,ISNULL(A22.ATTR22_KEY_NAME,'') as ATTR22_KEY_NAME,ISNULL(A23.ATTR23_KEY_NAME,'') as ATTR23_KEY_NAME
		 ,ISNULL(A24.ATTR24_KEY_NAME,'') ATTR24_KEY_NAME,ISNULL(A25.ATTR25_KEY_NAME,'')  ATTR25_KEY_NAME  ,
		 t3.tolerance_percentage
  into #TMPDETAILS  
  FROM pom01106 T1        
  JOIN LMV01106 T2 ON T1.AC_CODE = T2.AC_CODE     
  JOIN pod01106  T3 ON T3.po_ID = T1.po_ID        
  JOIN ARTICLE ON ARTICLE.ARTICLE_CODE = T3.ARTICLE_CODE        
  JOIN SECTIOND ON SECTIOND.SUB_SECTION_CODE= ARTICLE.SUB_SECTION_CODE        
  JOIN SECTIONM ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE        
  JOIN PARA1 ON PARA1.PARA1_CODE = T3.PARA1_CODE     
  JOIN PARA3 ON PARA3.PARA3_CODE = T3.PARA3_CODE  
  JOIN PARA4 ON PARA4.PARA4_CODE = T3.PARA4_CODE   
  JOIN PARA5 ON PARA5.PARA5_CODE = T3.PARA5_CODE   
JOIN PARA6 ON PARA6.PARA6_CODE = T3.PARA6_CODE      
  LEFT OUTER JOIN COMPANY COM ON 1=1 AND COM.COMPANY_CODE='01'      
  JOIN location L ON CASE WHEN T1.po_for_dept_id<>'' THEN T1.po_for_dept_id ELSE T1.DEPT_ID END =L.dept_id  
  LEFT JOIN AREA LAR(NOLOCK) ON LAR.AREA_CODE=L.AREA_CODE  
  LEFT JOIN CITY LCT (NOLOCK) ON LCT.CITY_CODE=LAR.CITY_CODE   
   LEFT JOIN ARTICLE_FIX_ATTR  AF (NOLOCK) ON AF.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
	LEFT JOIN ATTR1_MST A1 (NOLOCK) ON A1.ATTR1_KEY_CODE=af.attr1_KEY_CODE      
	LEFT JOIN ATTR2_MST A2 (NOLOCK) ON A2.ATTR2_KEY_CODE=af.attr2_KEY_CODE      
	LEFT JOIN ATTR3_MST A3 (NOLOCK) ON A3.ATTR3_KEY_CODE=af.attr3_KEY_CODE      
	LEFT JOIN ATTR4_MST A4 (NOLOCK) ON A4.ATTR4_KEY_CODE=af.attr4_KEY_CODE      
	LEFT JOIN ATTR5_MST A5 (NOLOCK) ON A5.ATTR5_KEY_CODE=af.attr5_KEY_CODE      
	LEFT JOIN ATTR6_MST A6 (NOLOCK) ON A6.ATTR6_KEY_CODE=af.attr6_KEY_CODE      
	LEFT JOIN ATTR7_MST A7 (NOLOCK) ON A7.ATTR7_KEY_CODE=af.attr7_KEY_CODE      
	LEFT JOIN ATTR8_MST A8 (NOLOCK) ON A8.ATTR8_KEY_CODE=af.attr8_KEY_CODE      
	LEFT JOIN ATTR9_MST A9 (NOLOCK) ON A9.ATTR9_KEY_CODE=af.attr9_KEY_CODE      
	LEFT JOIN ATTR10_MST A10 (NOLOCK) ON A10.ATTR10_KEY_CODE=af.attr10_KEY_CODE      
	LEFT JOIN ATTR11_MST A11 (NOLOCK) ON A11.ATTR11_KEY_CODE=af.attr11_KEY_CODE      
	LEFT JOIN ATTR12_MST A12 (NOLOCK) ON A12.ATTR12_KEY_CODE=af.attr12_KEY_CODE      
	LEFT JOIN ATTR13_MST A13 (NOLOCK) ON A13.ATTR13_KEY_CODE=af.attr13_KEY_CODE      
	LEFT JOIN ATTR14_MST A14 (NOLOCK) ON A14.ATTR14_KEY_CODE=af.attr14_KEY_CODE      
	LEFT JOIN ATTR15_MST A15 (NOLOCK) ON A15.ATTR15_KEY_CODE=af.attr15_KEY_CODE      
	LEFT JOIN ATTR16_MST A16 (NOLOCK) ON A16.ATTR16_KEY_CODE=af.attr16_KEY_CODE      
	LEFT JOIN ATTR17_MST A17 (NOLOCK) ON A17.ATTR17_KEY_CODE=af.attr17_KEY_CODE      
	LEFT JOIN ATTR18_MST A18 (NOLOCK) ON A18.ATTR18_KEY_CODE=af.attr18_KEY_CODE      
	LEFT JOIN ATTR19_MST A19 (NOLOCK) ON A19.ATTR19_KEY_CODE=af.attr19_KEY_CODE      
	LEFT JOIN ATTR20_MST A20 (NOLOCK) ON A20.ATTR20_KEY_CODE=af.attr20_KEY_CODE      
	LEFT JOIN ATTR21_MST A21 (NOLOCK) ON A21.ATTR21_KEY_CODE=af.attr21_KEY_CODE      
	LEFT JOIN ATTR22_MST A22 (NOLOCK) ON A22.ATTR22_KEY_CODE=af.attr22_KEY_CODE      
	LEFT JOIN ATTR23_MST A23 (NOLOCK) ON A23.ATTR23_KEY_CODE=af.attr23_KEY_CODE      
	LEFT JOIN ATTR24_MST A24 (NOLOCK) ON A24.ATTR24_KEY_CODE=af.attr24_KEY_CODE      
	LEFT JOIN ATTR25_MST A25 (NOLOCK) ON A25.ATTR25_KEY_CODE=Af.ATTR25_KEY_CODE 
       
  WHERE T1.po_ID=@CWHERE  
  group by T1.po_DT,T1.po_NO,T2.AC_NAME,T1.TOTAL_AMOUNT,   
     T1.OTHER_CHARGES ,T1.DISCOUNT_AMOUNT ,        
     T1.SUBTOTAL,PARA1.PARA1_NAME,  
	 SECTIOND.SUB_SECTION_NAME,SECTIONM.SECTION_NAME,ARTICLE.ARTICLE_NO,    
     COM.COMPANY_CODE ,COM.LOGO_PATH,  COM.COMPANY_NAME  ,  
     L.ADDRESS1, L.ADDRESS2,LCT.CITY ,L.PHONE   
     ,T1.DELIVERY_DT  ,T2.ADDRESS0,T2.ADDRESS1,T2.ADDRESS2,T2.AREA_NAME,T2.CITY,T2.STATE,T2.PINCODE,  
  ARTICLE.DT_CREATED,T1.REF_NO,T3.MRP,t3.PURCHASE_PRICE,  
  ARTICLE.ALIAS,ARTICLE.ARTICLE_NAME,T2.TIN_NO,T1.REMARKS ,  
  T1.CHECKED_BY,  T1.SENT_BY,L.dept_name ,t3.para1_code,L.LOC_GST_NO,
   PARA3.PARA3_NAME ,PARA4.PARA4_NAME ,PARA5.PARA5_NAME ,PARA6.PARA6_NAME ,ISNULL(A1.ATTR1_KEY_NAME,'')  ,ISNULL(A2.ATTR2_KEY_NAME,'')  
		,ISNULL(A3.ATTR3_KEY_NAME,'')   ,ISNULL(A4.ATTR4_KEY_NAME,'')  ,ISNULL(A5.ATTR5_KEY_NAME,'') ,ISNULL(A6.ATTR6_KEY_NAME,'')  
		,ISNULL(A7.ATTR7_KEY_NAME,'')  ,ISNULL(A8.ATTR8_KEY_NAME,'')  ,ISNULL(A9.ATTR9_KEY_NAME,'')   ,ISNULL(A10.ATTR10_KEY_NAME,'') 
		,ISNULL(A11.ATTR11_KEY_NAME,'') ,ISNULL(A12.ATTR12_KEY_NAME,'') ,ISNULL(A13.ATTR13_KEY_NAME,'')  ,ISNULL(A14.ATTR14_KEY_NAME,'') 
		,ISNULL(A15.ATTR15_KEY_NAME,'')      ,ISNULL(A16.ATTR16_KEY_NAME,'') ,ISNULL(A17.ATTR17_KEY_NAME,'') ,ISNULL(A18.ATTR18_KEY_NAME,'') ,ISNULL(A19.ATTR19_KEY_NAME,'') 
		,ISNULL(A20.ATTR20_KEY_NAME,'')    ,ISNULL(A21.ATTR21_KEY_NAME,'') ,ISNULL(A22.ATTR22_KEY_NAME,'')  ,ISNULL(A23.ATTR23_KEY_NAME,'')  
		 ,ISNULL(A24.ATTR24_KEY_NAME,'') ,ISNULL(A25.ATTR25_KEY_NAME,'')    ,t3.tolerance_percentage
   
  

  
  DECLARE @DTSQL NVARCHAR(MAX)  
           
    IF OBJECT_ID('TEMPDB..#TMPSIZESET','U') IS NOT NULL                        
  DROP TABLE  #TMPSIZESET                        
                            
  SELECT  P2.PARA2_SET ,ISNULL(PRINTCOLUMNNO,0) AS PRINTCOLUMNNO,                         
  P2.PARA2_NAME,P2.PARA2_CODE,                        
  CAST(SUM(QUANTITY) AS VARCHAR(100)) AS PARA2_QTY,                        
  ROW_NUMBER()  OVER (ORDER BY   P2.PARA2_NAME) AS SNO                           
  INTO #TMPSIZESET                        
  FROM pod01106  A                                            
  JOIN PARA2 P2 ON P2.PARA2_CODE =a.PARA2_CODE                         
  WHERE po_id  =@CWHERE                        
  GROUP BY P2.PARA2_SET ,ISNULL(PRINTCOLUMNNO,0),                        
  P2.PARA2_NAME ,P2.PARA2_CODE    
                   
  IF OBJECT_ID('TEMPDB..#TMPALLSIZE','U') IS NOT NULL                        
  DROP TABLE  #TMPALLSIZE                        
                         
   SELECT  A.PARA2_SET ,ISNULL(A.PRINTCOLUMNNO,0) AS PRINTCOLUMNNO, A.PARA2_NAME ,          
   SNO =ROW_NUMBER () OVER (ORDER BY A.PARA2_SET,ISNULL(A.PRINTCOLUMNNO,0),A.PARA2_NAME)                  
   INTO #TMPALLSIZE                        
   FROM PARA2 A                        
   JOIN #TMPSIZESET B ON A.PARA2_SET =B.PARA2_SET                         
   GROUP BY A.PARA2_SET ,ISNULL(A.PRINTCOLUMNNO,0) , A.PARA2_NAME                         
                        
    DECLARE @CUPDATECOLNAME VARCHAR(10),@NSRNO INT                        
                         
    SET @NSRNO=1                        
    WHILE @NSRNO <=36                        
    BEGIN                        
	   SET @DTSQL=' ALTER TABLE #TMPDETAILS ADD HEADER'+RTRIM(LTRIM(STR(@NSRNO)))+' VARCHAR(100) '                        
	   PRINT @DTSQL                        
	   EXEC(@DTSQL)                         
                             
	   SET @DTSQL=' IF EXISTS(SELECT TOP 1 ''U'' FROM #TMPALLSIZE WHERE SNO='+RTRIM(LTRIM(STR(@NSRNO)))+')                        
	   BEGIN                        
		  UPDATE #TMPDETAILS SET HEADER'+RTRIM(LTRIM(STR(@NSRNO)))+                        
		' =(SELECT TOP 1  PARA2_NAME FROM #TMPALLSIZE WHERE SNO='+RTRIM(LTRIM(STR(@NSRNO)))+')                        
		END '                        
	   PRINT @DTSQL                        
	   EXEC(@DTSQL)                         
       SET @NSRNO=@NSRNO+1                        
    END                         
                    
  DECLARE @CALLPARA2_NAME VARCHAR(MAX)                         
                        
  SELECT  @CALLPARA2_NAME=ISNULL(@CALLPARA2_NAME+'','')+                        
  CASE WHEN LEN(A.PARA2_NAME) =1 THEN ' '                        
    WHEN LEN(A.PARA2_NAME) =2 THEN ' '                        
     ELSE ' ' END+                        
   LEFT((A.PARA2_NAME ),3)                      
  FROM                        
  (                        
   SELECT  A.PARA2_SET ,ISNULL(A.PRINTCOLUMNNO,0) AS PRINTCOLUMNNO, A.PARA2_NAME                         
   FROM PARA2 A                      
   JOIN #TMPSIZESET B ON A.PARA2_SET =B.PARA2_SET                         
   GROUP BY A.PARA2_SET ,ISNULL(A.PRINTCOLUMNNO,0) , A.PARA2_NAME                         
                        
  ) A                        
                            
   
IF OBJECT_ID('TEMPDB..#TMPPARTICULAR','U') IS NOT NULL                        
    DROP TABLE  #TMPPARTICULAR                        
                           
   SELECT A.SR_NO, A.ARTICLE_NO  ,A.PARA1_CODE,                        
    CAST('' AS VARCHAR(1000)) AS PARA2_NAME,                        
    CAST('' AS VARCHAR(1000)) AS PARA2_CODE,                        
    CAST('' AS NUMERIC(10,0)) AS PARA2_QTY,                        
    CAST(0 AS INT ) AS SNO,                        
    CAST(0 AS INT ) AS PRINTCOLUMNNO ,  
    A.PURCHASE_price  
   INTO #TMPPARTICULAR                  
   FROM #TMPDETAILS A                        
   WHERE 1=2                        
                      
  SET @DTSQL=' SELECT  ARTICLE_NO,A.PARA1_CODE               
     ,A.PARA2_CODE                 
     ,PARA2_NAME                        
     ,SUM(QUANTITY) AS PARA2_QTY                        
     ,0 AS SNO                         
     ,ISNULL(PRINTCOLUMNNO,0) AS PRINTCOLUMNNO  ,  
      a.PURCHASE_price  
     FROM pod01106 A  
  JOIN ARTICLE ON ARTICLE.ARTICLE_CODE = A.ARTICLE_CODE   
  JOIN PARA1 ON PARA1.PARA1_CODE = A.PARA1_CODE   
  JOIN PARA2 ON PARA2.PARA2_CODE = A.PARA2_CODE  
  WHERE po_id ='''+@CWHERE+''' 
  GROUP BY ARTICLE_NO,A.PARA1_CODE               
     ,A.PARA2_CODE                 
     ,PARA2_NAME,a.PURCHASE_price ,ISNULL(PRINTCOLUMNNO,0) '                    
                             
   INSERT INTO #TMPPARTICULAR(ARTICLE_NO,PARA1_CODE,PARA2_CODE,PARA2_NAME,PARA2_QTY,SNO,PRINTCOLUMNNO, purchase_price )        
   EXEC(@DTSQL)     
   
  
          
                           
  DECLARE @CARTICLENO varchar(40),@CPARA1_CODE varchar(10),@nPP numeric(10,2),  
  @NPARA2_QTY numeric(10,3),@PRINTCOLUMNNO int,@CPARA2_CODE VARCHAR(10)  
                        
  WHILE EXISTS (SELECT TOP 1 'U' FROM  #TMPPARTICULAR)                        
   BEGIN                        
                             
	  SELECT TOP 1 @CARTICLENO=article_no ,@CPARA1_CODE=para1_code ,@NPP=PURCHASE_price ,                              
	  @PRINTCOLUMNNO=PRINTCOLUMNNO,@NPARA2_QTY=PARA2_QTY ,@CPARA2_CODE=PARA2_CODE        
	  FROM #TMPPARTICULAR    
	  

    
                              
        IF @PRINTCOLUMNNO BETWEEN 1 AND 12                        
        BEGIN                        
         

		  SET @DTSQL=' UPDATE #TMPDETAILS SET SIZE'+RTRIM(LTRIM(STR(@PRINTCOLUMNNO)))+'                        
		  = '+RTRIM(LTRIM(STR(@NPARA2_QTY)))+'                        
		  WHERE                         
		  article_no='''+@CARTICLENO+'''               
		  AND para1_code='''+@CPARA1_CODE+'''                                           
		  AND PURCHASE_PRICE='+STR(@nPP,10,2)+'                        
		  '                        
		  PRINT @DTSQL                        
		  EXEC(@DTSQL)                        
                             
        END                        
                                
    DELETE FROM #TMPPARTICULAR                        
    WHERE ARTICLE_NO=@CARTICLENO                        
    AND PARA1_CODE=@CPARA1_CODE                        
    AND purchase_price =@nPP       
    AND PARA2_CODE =@CPARA2_CODE  
   
   END                        
                          
   --DATASET 2                      
   SELECT   A.*,         
       @CALLPARA2_NAME AS ALLPARA2_NAME   
   FROM #TMPDETAILS A                        
   ORDER BY A.SR_NO                           
     
  
  
END  
  



