create PROCEDURE SP_MERGE_MIRROR_MSTUSR
(
	@NMODE INT=1 -- 1. CLEAR PREVIOUS TEMP ENTRIES , 2. MERGE THE NEW DATA
)
--WITH ENCRYPTION
AS
BEGIN
	
	BEGIN TRY
		
		DECLARE @CERRORMSG VARCHAR(1000),@CCURDEPTID VARCHAR(4),@CHODEPTID VARCHAR(4),@CCMD NVARCHAR(MAX),
				@CXNMASTERTABLENAME VARCHAR(100),@BPROCEED BIT,@CTABLENAME VARCHAR(100),@CMASTERKEYFIELD VARCHAR(100),
				@CKEYFIELD VARCHAR(100),@CPARENTTABLENAME VARCHAR(100),@CPARENTPARANAME VARCHAR(100),@CCHILDPARANAME VARCHAR(100),
				@CWHERECLAUSE VARCHAR(100),@CJOINSTR VARCHAR(1000),@CMEMOID VARCHAR(100),@CFINYEAR VARCHAR(100),
				@NGRPCHARS INT,@NSERIESCHARS INT,@BSERIESBROKEN BIT,@CPREVMEMOID VARCHAR(40),@CMERGETABLENAME VARCHAR(50),
				@CFIRSTMEMOID VARCHAR(40),@NPREVMEMOID INT,@NMEMONOLEN INT,@CRETCMD NVARCHAR(MAX),
				@CDELCHILDTABLENAME VARCHAR(100),@CDELCHILDPARANAME VARCHAR(100),@CDELPARENTPARANAME VARCHAR(100),
				@CORIGINALTABLENAME VARCHAR(100),@NLOCTYPE INT,@BDONOTMERGE BIT,@CRFXNTYPE VARCHAR(10),@BHOLOC BIT,
				@BINSERTONLY BIT,@BLINKEDMASTER BIT,@BPURLOC BIT,@CSOURCELOCID CHAR(2),@BSOURCEPURLOC BIT,
				@CMISSINGMEMOID VARCHAR(40),@CGRPCODE VARCHAR(20),@BRETVAL BIT,@NPREVNO INT,@CPREVNO VARCHAR(20),
				@BEMPHEADSUPDATED BIT,@CFILTERCONDITION VARCHAR(100),@CTABLEPREFIX VARCHAR(100),@CXNTYPE VARCHAR(10),
				@NXNSMERGINGORDER INT,@NSTEP INT,@CKEYFIELD2 VARCHAR(100),@CTMP_TABLENAME VARCHAR(500),@CSOURCEDB VARCHAR(200)
		
		
		SET @NSTEP=10	
		
		SET @CSOURCEDB=''
		
		DECLARE @TRETMSG TABLE  (MEMO_ID VARCHAR(40),ERRMSG VARCHAR(MAX))

		BEGIN TRANSACTION
		
		IF @NMODE=1
			GOTO END_PROC
					
		SELECT @CERRORMSG='',@BPROCEED=1,@NMEMONOLEN=10,@CRETCMD='',@CMEMOID='',@CXNTYPE='MSTUSRROLE',@BEMPHEADSUPDATED=0,
		@CFILTERCONDITION=''
		
		SET @NSTEP=20
		
		SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
		SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
		
		IF @CCURDEPTID=@CHODEPTID
		BEGIN
				SET @CERRORMSG='P:SP_MERGE_MIRROR_MSTUSR, CANNOT CALL MERGING PROC AT HEAD OFFICE'
				GOTO END_PROC
  		END					
				
		SELECT @NLOCTYPE=LOC_TYPE,@BPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID
		
		SET @NSTEP=30		
		
		SET @CMEMOID='MSTUSRROLE'
		
		SET @NSTEP=40
		
		LBLMERGEBEFORE:
		
		IF @CERRORMSG = ''
		BEGIN
		
		  SET @NSTEP=45
		   
		   --ADDED THIS LINE BY JAI RAM KUMAR FOR DELETE USER WHICH ARE NOT EXIST FOR CURRENT LOCATION
		   ---DELETE RECORDS WHICH ARE NO RELATED TO CURRENT LOCATION
		   DELETE FROM MSTUSRROLE_LOCUSERS_MIRROR WHERE DEPT_ID <> @CCURDEPTID
		   DELETE FROM MSTUSRROLE_CONFIG_MIRROR   WHERE DEPT_ID <> @CCURDEPTID
		   
		   DELETE FROM MSTUSRROLE_USERS_MIRROR  WHERE USER_CODE NOT IN (SELECT USER_CODE FROM MSTUSRROLE_LOCUSERS_MIRROR WITH(NOLOCK))    
		   DELETE FROM MSTUSRROLE_BINUSERS_MIRROR WHERE USER_CODE NOT IN (SELECT USER_CODE FROM MSTUSRROLE_LOCUSERS_MIRROR WITH(NOLOCK))
		   DELETE FROM MSTUSRROLE_FIXEDFREEZE_MIRROR  WHERE USER_CODE NOT IN (SELECT USER_CODE FROM MSTUSRROLE_LOCUSERS_MIRROR WITH(NOLOCK))
		   
		   SET @NSTEP=47
		   
		   IF NOT EXISTS (SELECT TOP 1 USER_CODE FROM MSTUSRROLE_USERS_MIRROR) OR
		   	  NOT EXISTS (SELECT TOP 1 USER_CODE FROM MSTUSRROLE_BINUSERS_MIRROR) OR
		   	  NOT EXISTS (SELECT TOP 1 ROLE_ID FROM MSTUSRROLE_USER_ROLE_DET_MIRROR) OR
		   	  NOT EXISTS (SELECT TOP 1 DEPT_ID FROM MSTUSRROLE_LOCUSERS_MIRROR)
		   BEGIN
				SET @CERRORMSG='INCOMPLETE DATA FOUND IN THE TEMP TABLES....CANNOT MERGE'
				GOTO END_PROC	
		   END
		   
		   SET @NSTEP=50
		   SET @CCMD=N'UPDATE A SET USER_ALIAS=(CASE WHEN USER_ALIAS='''' THEN  '''+@CCURDEPTID+''' ELSE USER_ALIAS END)
						FROM MSTUSRROLE_USERS_MIRROR A  WITH (ROWLOCK) '

		   PRINT @CCMD				
		   EXEC SP_EXECUTESQL @CCMD

		   SET @NSTEP=95
		   SET @CCMD=N'UPDATE A SET USER_ALIAS=B.USER_ALIAS
						FROM MSTUSRROLE_USERS_MIRROR A  WITH (ROWLOCK) JOIN USERS B (NOLOCK) ON A.USER_CODE=B.USER_CODE'
			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD
			
			SET @NSTEP=100
			SET @CCMD=N'UPDATE A SET USER_CODE = C.USER_CODE FROM MSTUSRROLE_LOCUSERS_MIRROR A WITH (ROWLOCK) 
						JOIN MSTUSRROLE_USERS_MIRROR B (NOLOCK) ON A.USER_CODE=B.USER_CODE 
						JOIN USERS C (NOLOCK) ON C.USERNAME=B.USERNAME '

			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD			

			SET @NSTEP=102
			SET @CCMD=N'UPDATE A SET USER_CODE = C.USER_CODE FROM MSTUSRROLE_REPLOCS_MIRROR A WITH (ROWLOCK) 
						JOIN MSTUSRROLE_USERS_MIRROR B (NOLOCK) ON A.USER_CODE=B.USER_CODE 
						JOIN USERS C (NOLOCK) ON C.USERNAME=B.USERNAME '

			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD			

			SET @NSTEP=105
			
			SET @CCMD=N'UPDATE A SET USER_CODE = C.USER_CODE FROM MSTUSRROLE_BINUSERS_MIRROR A WITH (ROWLOCK) 
						JOIN MSTUSRROLE_USERS_MIRROR B (NOLOCK) ON A.USER_CODE=B.USER_CODE 
						JOIN USERS C (NOLOCK) ON C.USERNAME=B.USERNAME '

			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD			

			SET @NSTEP=110
			--SELECT * FROM MSTUSRROLE_MODULES_70 WHERE USER_CODE='0100042' AND VALUE=1
			
			SET @CCMD=N'UPDATE MSTUSRROLE_LOCUSERS_MIRROR WITH (ROWLOCK) SET LAST_UPDATE=GETDATE()'
			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD
	
			
			IF @BPURLOC=0
			BEGIN
				SET @NSTEP=130
				
				SET @CCMD=N' UPDATE MSTUSRROLE_USERS_MIRROR WITH (ROWLOCK)  SET PASSWD =
							 (CASE WHEN LOC_PASSWD<>'''' THEN LOC_PASSWD ELSE PASSWD END)
							 WHERE USER_CODE =''0000000'''
				PRINT @CCMD				
				EXEC SP_EXECUTESQL @CCMD
			END

			SET @NSTEP=140
			
			SET @CCMD=N' UPDATE A SET USER_CODE = B.USER_CODE FROM MSTUSRROLE_USERS_MIRROR
					     A WITH (ROWLOCK) JOIN USERS B (NOLOCK) ON B.USERNAME=A.USERNAME WHERE ISNULL(B.PASSWD,'''')<>'''' AND A.USER_CODE <>''0000000'''

			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD

			SET @NSTEP=150
						
			SET @CCMD=N'UPDATE A SET PASSWD=B.PASSWD FROM MSTUSRROLE_USERS_MIRROR A WITH (ROWLOCK)  
					    JOIN USERS B (NOLOCK) ON B.USER_CODE=A.USER_CODE
					    JOIN MSTUSRROLE_USER_ROLE_DET_MIRROR C (NOLOCK) ON C.ROLE_ID=B.ROLE_ID
					    WHERE C.FORM_NAME=''FRMUSERS'' AND FORM_OPTION=''CHANGE_PASSWORD'' AND C.VALUE=''1'' 
					    AND A.USER_CODE <>''0000000'''

			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD
			
			SET @NSTEP=160
			SET @CCMD=N' UPDATE A SET RESET_PWD_DUE_DATE = B.RESET_PWD_DUE_DATE FROM MSTUSRROLE_USERS_MIRROR
					     A WITH (ROWLOCK) JOIN USERS B (NOLOCK) ON B.USER_CODE=A.USER_CODE'

			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD
														
			SET @NSTEP=180
			
			SET @CCMD=N'DELETE FROM MSTUSRROLE_LOCUSERS_MIRROR WITH (ROWLOCK)  WHERE 
						USER_CODE NOT IN (SELECT USER_CODE FROM MSTUSRROLE_USERS_MIRROR)'
			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD			
			
			SET @NSTEP=190
			
			SET @CCMD=N'DELETE FROM MSTUSRROLE_LOCUSERS_MIRROR WITH (ROWLOCK)  WHERE TS<> 
						(SELECT TOP 1 TS FROM MSTUSRROLE_LOCUSERS_MIRROR A (NOLOCK)WHERE
						 USER_CODE=MSTUSRROLE_LOCUSERS_MIRROR.USER_CODE AND
						 DEPT_ID=MSTUSRROLE_LOCUSERS_MIRROR.DEPT_ID)'
			PRINT @CCMD				
			EXEC SP_EXECUTESQL @CCMD
						
						
           SET @NSTEP=195
           UPDATE MSTUSRROLE_USERS_MIRROR SET MAJOR_USER_CODE=USER_CODE						
		END
				
		LBLDELENTRIES:
		
		--- FIRSTLY, DELETE OLDER ENTRIES FROM THE TRANSACTIONS
		SET @NSTEP=200
		
		
		DELETE FROM LOCUSERS
		
		


		DELETE FROM BINUSERS
		DELETE FROM USER_ROLE_DET
		
		DELETE FROM ROLLINGFREEZE
		DELETE FROM FIXEDFREEZE
		DELETE FROM USER_XTREAM_LAYOUT_SETUP
		
		 SELECT REP_ID into #TMPREPMST FROM REP_MST A (NOLOCK) WHERE left(rep_id,2)  =@CHODEPTID AND REP_CODE IN ('X001','C001','G001')
		 AND REP_CODE NOT IN (SELECT REP_CODE FROM REP_CRM)
		 UNION ALL
		 SELECT FILTER_REP_ID AS REP_ID FROM WOW_XPERT_REP_MST A (NOLOCK)
		 WHERE FILTER_REP_ID <>''
		 AND a.Location_code=@CHODEPTID AND XPERT_REP_CODE IN('R1','R2','R3','R4','R5','R6')

        DELETE A FROM REP_FILTER A JOIN #TMPREPMST B ON A.REP_ID=B.REP_ID 
        DELETE A FROM REP_FILTER_DET A JOIN #TMPREPMST B ON A.REP_ID=B.REP_ID 

		DELETE A FROM REP_DET_XNTYPES A 
		JOIN #TMPREPMST B ON A.REP_ID=B.REP_ID 

        DELETE A FROM REP_DET A (nolock)
        JOIN #TMPREPMST B ON A.REP_ID=B.REP_ID 
        WHERE  REP_CODE IN ('X001','C001','G001')
        
 
	   DELETE FROM REPLOCS


		Delete a from wow_xpert_rep_mst_linked_filter A (nolock) 
		JOIN wow_xpert_rep_mst B (NOLOCK) ON A.rep_id =B.REP_ID 
		WHERE b.location_code =@CHODEPTID and XPERT_REP_CODE in('R1','R2','R3','R4','R5','R6')

		Delete a from wow_xpert_rep_det A (nolock) 
		JOIN wow_xpert_rep_mst B (NOLOCK) ON A.rep_id =B.REP_ID 
		WHERE b.location_code =@CHODEPTID and XPERT_REP_CODE in('R1','R2','R3','R4','R5','R6')

		Delete a from Xpert_filter_Mst A (nolock)  	
		join rep_mst b (nolock) on a.rep_id =b.rep_id 
		WHERE left(b.rep_id,2) =@CHODEPTID

		Delete a from Rep_Adv_Filter A (nolock) 
		JOIN wow_xpert_rep_mst B (NOLOCK) ON A.rep_id =B.REP_ID 
		WHERE b.location_code =@CHODEPTID and XPERT_REP_CODE in('R1','R2','R3','R4','R5','R6')

		Delete a from REP_ADVFILTER_LIST A (nolock) 
		JOIN wow_xpert_rep_mst B (NOLOCK) ON A.rep_id =B.REP_ID 
		WHERE b.location_code=@CHODEPTID and XPERT_REP_CODE in('R1','R2','R3','R4','R5','R6')


		Delete a from wow_xpert_rep_mst A (nolock) WHERE a.location_code=@CHODEPTID and XPERT_REP_CODE in('R1','R2','R3','R4','R5','R6')

        
        DELETE A FROM REP_MST A
        JOIN #TMPREPMST B ON A.REP_ID =B.REP_ID 
        
		
		
LBLMERGE:
       
					
		SET @NSTEP=210
		SET @CTABLENAME='USER_ROLE_MST'
		SET @CTMP_TABLENAME='MSTUSRROLE_USER_ROLE_MST_MIRROR'
		SET @CKEYFIELD='ROLE_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
		
         --if user does not have access to current location
  
		SET @NSTEP=220
		SET @CTABLENAME='USERS'
		SET @CTMP_TABLENAME='MSTUSRROLE_USERS_MIRROR'
		SET @CKEYFIELD='USER_CODE'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1

		Update a set  viewLoginLocationMode=2  from USERS A (nolock)
		left join MSTUSRROLE_USERS_MIRROR b on a.user_code =b.user_code
		where b.user_code is null 
    
		SET @NSTEP=230
		SET @CTABLENAME='USER_ROLE_DET'
		SET @CTMP_TABLENAME='MSTUSRROLE_USER_ROLE_DET_MIRROR'
		SET @CKEYFIELD='ROW_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1

		
		SET @NSTEP=240
		SET @CTABLENAME='LOCUSERS'
		SET @CTMP_TABLENAME='MSTUSRROLE_LOCUSERS_MIRROR'
		SET @CKEYFIELD='USER_CODE'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='DEPT_ID',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
								  
		
      
		SET @NSTEP=245
		SET @CTABLENAME='USER_XTREAM_LAYOUT_SETUP'
		SET @CTMP_TABLENAME='MSTUSRROLE_USER_XTREAM_LAYOUT_SETUP_MIRROR'
		SET @CKEYFIELD='ROLE_ID'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1								  


		SET @NSTEP=250
		SET @CTABLENAME='BIN'
		SET @CTMP_TABLENAME='MSTUSRROLE_BIN_MIRROR'
		SET @CKEYFIELD='BIN_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1									  

		
		SET @NSTEP=260
		SET @CTABLENAME='BINUSERS'
		SET @CTMP_TABLENAME='MSTUSRROLE_BINUSERS_MIRROR'
		SET @CKEYFIELD='USER_CODE'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='BIN_ID',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1									  

		SET @NSTEP=270
		
		SET @CTABLENAME='CONFIG'
		SET @CTMP_TABLENAME='MSTUSRROLE_CONFIG_MIRROR'
		SET @CKEYFIELD='CONFIG_OPTION'

		SET @CCMD=N'UPDATE CONFIG SET VALUE=B.VALUE FROM MSTUSRROLE_CONFIG_MIRROR B
					WHERE B.CONFIG_OPTION=CONFIG.CONFIG_OPTION'
		EXEC SP_EXECUTESQL @CCMD
		
		SET @NSTEP=275
		SET @CCMD=N'INSERT CONFIG	(  CONFIG_OPTION, VALUE, ROW_ID, LAST_UPDATE, REMARKS )
		SELECT  A.CONFIG_OPTION, A.VALUE,'''' AS ROW_ID,A.LAST_UPDATE,'''' AS REMARKS 
		FROM MSTUSRROLE_CONFIG_MIRROR A
		LEFT OUTER JOIN CONFIG B ON A.CONFIG_OPTION=B.CONFIG_OPTION
		WHERE B.CONFIG_OPTION IS NULL'
		
		EXEC SP_EXECUTESQL @CCMD


									  


		SET @NSTEP=290
		SET @CTABLENAME='FIXEDFREEZE'
		SET @CTMP_TABLENAME='MSTUSRROLE_FIXEDFREEZE_MIRROR'
		SET @CKEYFIELD='USER_CODE'

		UPDATE MSTUSRROLE_FIXEDFREEZE_MIRROR SET user_code='0000000'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1									  


		SET @NSTEP=295
		SET @CTABLENAME='ROLLINGFREEZE'
		SET @CTMP_TABLENAME='MSTUSRROLE_ROLLINGFREEZE_MIRROR'
		SET @CKEYFIELD='ROLE_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='XN_TYPE',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1									  


		SET @NSTEP=300
		SET @CTABLENAME='REPLOCS'
		SET @CTMP_TABLENAME='MSTUSRROLE_REPLOCS_MIRROR'
		SET @CKEYFIELD='REP_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0									  


		SET @NSTEP=305
		SET @CTABLENAME='REP_MST'
		SET @CTMP_TABLENAME='MSTUSRROLE_REP_MST_MIRROR'
		SET @CKEYFIELD='REP_ID'

		UPDATE MSTUSRROLE_REP_MST_MIRROR SET user_code='0000000'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0									  

		SET @NSTEP=310
		SET @CTABLENAME='REP_DET'
		SET @CTMP_TABLENAME='MSTUSRROLE_REP_DET_MIRROR'
		SET @CKEYFIELD='REP_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0									  

		SET @NSTEP=315
		SET @CTABLENAME='REP_FILTER'
		SET @CTMP_TABLENAME='MSTUSRROLE_REP_FILTER_MIRROR'
		SET @CKEYFIELD='REP_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0									  

		SET @NSTEP=320
		SET @CTABLENAME='REP_FILTER_DET'
		SET @CTMP_TABLENAME='MSTUSRROLE_REP_FILTER_DET_MIRROR'
		SET @CKEYFIELD='REP_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0									  

		SET @NSTEP=322
		SET @CTABLENAME='REP_DET_XNTYPES'
		SET @CTMP_TABLENAME='MSTUSRROLE_REP_DET_XNTYPES_MIRROR'
		SET @CKEYFIELD='REP_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0									  

		SET @NSTEP=325

							
		SET @CCMD=N'ALTER TABLE USERS ENABLE TRIGGER TRG_USERS_CHKPWD'
		PRINT @CCMD				
		EXEC SP_EXECUTESQL @CCMD



		--Xpert Reporting tables 

		SET @NSTEP=340
		SET @CTABLENAME='wow_xpert_rep_mst'
		SET @CTMP_TABLENAME='MSTUSRROLE_wow_xpert_rep_mst_MIRROR'
		SET @CKEYFIELD='REP_ID'

		UPDATE MSTUSRROLE_wow_xpert_rep_mst_MIRROR SET user_code='0000000'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0									  

		SET @NSTEP=350
		SET @CTABLENAME='wow_xpert_rep_det'
		SET @CTMP_TABLENAME='MSTUSRROLE_wow_xpert_rep_det_MIRROR'
		SET @CKEYFIELD='REP_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0									  

		SET @NSTEP=360
		SET @CTABLENAME='wow_xpert_rep_mst_linked_filter'
		SET @CTMP_TABLENAME='MSTUSRROLE_wow_xpert_rep_mst_linked_filter_MIRROR'
		SET @CKEYFIELD='REP_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0									  

		

		SET @NSTEP=370
		SET @CTABLENAME='Xpert_filter_Mst'
		SET @CTMP_TABLENAME='MSTUSRROLE_Xpert_filter_Mst_MIRROR'
		SET @CKEYFIELD='REP_ID'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0			
		



		SET @NSTEP=380
		SET @CTABLENAME='Rep_Adv_Filter'
		SET @CTMP_TABLENAME='MSTUSRROLE_Rep_Adv_Filter_MIRROR'
		SET @CKEYFIELD='Adv_Filter_id'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0			
		


		SET @NSTEP=390
		SET @CTABLENAME='REP_ADVFILTER_LIST'
		SET @CTMP_TABLENAME='MSTUSRROLE_REP_ADVFILTER_LIST_MIRROR'
		SET @CKEYFIELD='Adv_Filter_id'


		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=0			
		


		GOTO END_PROC
		
	END TRY

	BEGIN CATCH
		
		PRINT 'UNTRAPPED ERROR'		
		SELECT @CERRORMSG='PROCEDURE : '+ISNULL(ERROR_PROCEDURE(),'NULL P')+'STEP: '+STR(@NSTEP)+' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		GOTO END_PROC
		
	END CATCH

END_PROC:
	IF ISNULL(@CERRORMSG,'')='' 
	BEGIN
		PRINT 'CHK'
		DELETE FROM MSTUSRROLE_USERS_MIRROR
		DELETE FROM MSTUSRROLE_LOCUSERS_MIRROR
		DELETE FROM MSTUSRROLE_BIN_MIRROR
		DELETE FROM MSTUSRROLE_BINUSERS_MIRROR
		DELETE FROM MSTUSRROLE_USER_ROLE_MST_MIRROR
		DELETE FROM MSTUSRROLE_USER_ROLE_DET_MIRROR
		DELETE FROM MSTUSRROLE_CONFIG_MIRROR
		DELETE FROM MSTUSRROLE_FIXEDFREEZE_MIRROR
		DELETE FROM MSTUSRROLE_ROLLINGFREEZE_MIRROR
		DELETE FROM MSTUSRROLE_REPLOCS_MIRROR
		DELETE FROM MSTUSRROLE_REP_MST_MIRROR
		DELETE FROM MSTUSRROLE_REP_DET_MIRROR
		DELETE FROM MSTUSRROLE_REP_FILTER_MIRROR
		DELETE FROM MSTUSRROLE_REP_FILTER_DET_MIRROR
		DELETE FROM MSTUSRROLE_USER_XTREAM_LAYOUT_SETUP_MIRROR		

		DELETE FROM MSTUSRROLE_wow_xpert_rep_mst_linked_filter_mirror
		DELETE FROM MSTUSRROLE_wow_xpert_rep_det_mirror
		DELETE FROM MSTUSRROLE_wow_xpert_rep_mst_mirror
		DELETE FROM MSTUSRROLE_Xpert_filter_Mst_MIRROR

		DELETE FROM MSTUSRROLE_Rep_Adv_Filter_MIRROR
		DELETE FROM MSTUSRROLE_REP_ADVFILTER_LIST_MIRROR


	END

	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			commit TRANSACTION
		ELSE
			ROLLBACK 	
	END	
	
	SELECT 'MSTUSRROLE' AS MEMO_ID,ISNULL(@CERRORMSG,'') AS ERRMSG
	
END
--- 'END OF CREATING PROCEDURE SP_MERGE_MIRROR_MSTUSR


