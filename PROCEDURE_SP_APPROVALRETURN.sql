CREATE PROCEDURE SP_APPROVALRETURN		     
      
@NQUERYID NUMERIC(2,0),           
@CWHERE  NVARCHAR(MAX),      
@CWHERE1 VARCHAR(100)='' ,    
@CMODE NUMERIC(1)=0  
,@NXN_ITEM_TYPE NUMERIC(1)=0     
--WITH ENCRYPTION
AS      
BEGIN      
        
IF @NQUERYID = 1      
GOTO LBLGETMST      
      
ELSE IF @NQUERYID = 2      
GOTO LBLGETDETAILS   

ELSE IF @NQUERYID = 3      
GOTO LBLPENDING   
                 
ELSE      
GOTO LAST      

LBLGETMST:     
    
       
 SELECT A.*, ISNULL(B.USER_CUSTOMER_CODE,'') AS USER_CUSTOMER_CODE,    
 B.CUSTOMER_TITLE,B.CUSTOMER_FNAME,CUSTOMER_LNAME,B.ADDRESS1,B.ADDRESS2,'' AS ADDRESS,    
 C.AREA_NAME AS AREA,C.PINCODE,D.CITY,E.STATE, U.USERNAME,  
 T4.AC_NAME,CONVERT(NUMERIC(10,2), 0) AS NET_AMOUNT ,   
 B.ADDRESS9, B.CARD_NO    ,B1.BIN_NAME,cast('' as  varchar(50)) as sp_id
 FROM APPROVAL_RETURN_MST A (NOLOCK)    
 LEFT JOIN CUSTDYM B (NOLOCK)     ON A.CUSTOMER_CODE = B.CUSTOMER_CODE   
 LEFT JOIN LM01106 T4 (NOLOCK)     ON T4.AC_CODE = A.AC_CODE     
 LEFT JOIN AREA C (NOLOCK)     ON B.AREA_CODE = C.AREA_CODE    
 LEFT JOIN CITY D (NOLOCK)     ON C.CITY_CODE = D.CITY_CODE    
 LEFT JOIN STATE E (NOLOCK)     ON D.STATE_CODE = E.STATE_CODE    
LEFT JOIN USERS U (NOLOCK)     ON U.USER_CODE = A.USER_CODE 
LEFT OUTER JOIN BIN B1 (NOLOCK)  ON B1.BIN_ID=A.BIN_ID
 WHERE A.MEMO_ID = @CWHERE           
 GOTO LAST      
      
LBLGETDETAILS:      
	SELECT A.*,C.PRODUCT_CODE,C.QUANTITY AS ISSUE_QUANTITY,C.MRP,(A.QUANTITY*A.MRP) as NET,
	((C.QUANTITY- RET.RET_QTY)+A.QUANTITY) AS BALANCE_QUANTITY, 
	A.QUANTITY AS RET_QUANTITY, 
	APM.MEMO_NO AS APM_MEMO_NO, APM.MEMO_DT AS APM_MEMO_DT,
	D.DT_CREATED AS SKU_DT_CREATED, E.DT_CREATED AS ART_DT_CREATED,E.ARTICLE_NO,         
	F.PARA1_CODE,F.PARA1_NAME , G.PARA2_CODE , G.PARA2_NAME,H.SUB_SECTION_NAME, I.SECTION_NAME,    
	J.DT_CREATED AS PARA3_DT_CREATED,J.PARA3_NAME,K.PARA4_NAME,L.PARA5_NAME,M.PARA6_NAME,    
	UOM.UOM_TYPE, D.FIX_MRP,UOM.UOM_CODE,UOM.UOM_NAME       
	,EMP.EMP_NAME,(CASE WHEN CMM.REF_CM_ID IS NOT NULL OR INM.REF_INV_ID IS NOT NULL THEN 1 ELSE 0 END) AS FREEZED
	,B1.BIN_NAME,E.ALIAS AS ARTICLE_ALIAS,C.ITEM_REMARKS,
	 C.PRODUCT_CODE AS ORG_PRODUCT_CODE, 
    CAST(CASE WHEN CHARINDEX('@',C.PRODUCT_CODE)=0 THEN '' ELSE 
    (SUBSTRING(C.PRODUCT_CODE,CHARINDEX('@',C.PRODUCT_CODE)+1,15)) END AS VARCHAR(100))  AS BATCH_LOT_NO,
     D.BATCH_NO,D.EXPIRY_DT     ,cast('' as  varchar(50)) as sp_id
	FROM APPROVAL_RETURN_DET A  (NOLOCK)    
    JOIN APPROVAL_RETURN_MST B (NOLOCK)     ON A.MEMO_ID = B.MEMO_ID    
	JOIN APD01106 C (NOLOCK)     ON C.ROW_ID = A.APD_ROW_ID  
	JOIN APM01106 APM (NOLOCK)     ON APM.MEMO_ID = C.MEMO_ID     
	JOIN SKU D (NOLOCK)     ON C.PRODUCT_CODE = D.PRODUCT_CODE    
	JOIN ARTICLE E (NOLOCK)     ON D.ARTICLE_CODE = E.ARTICLE_CODE         
	JOIN PARA1 F (NOLOCK)    ON D.PARA1_CODE = F.PARA1_CODE         
	JOIN PARA2 G (NOLOCK)     ON D.PARA2_CODE = G.PARA2_CODE         
	JOIN SECTIOND H (NOLOCK)     ON E.SUB_SECTION_CODE = H.SUB_SECTION_CODE         
    JOIN SECTIONM I (NOLOCK)     ON H.SECTION_CODE = I.SECTION_CODE       
	JOIN PARA3 J (NOLOCK)     ON D.PARA3_CODE = J.PARA3_CODE     
	JOIN PARA4 K (NOLOCK)    ON D.PARA4_CODE = K.PARA4_CODE    
	JOIN PARA5 L (NOLOCK)    ON D.PARA5_CODE = L.PARA5_CODE    
	JOIN PARA6 M (NOLOCK)    ON D.PARA6_CODE = M.PARA6_CODE    
	JOIN UOM (NOLOCK)    ON E.UOM_CODE = UOM.UOM_CODE    
	JOIN BIN B1 (NOLOCK)    ON B1.BIN_ID=A.BIN_ID
	LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON A.EMP_CODE = EMP.EMP_CODE 
    LEFT OUTER JOIN CMM01106  CMM (NOLOCK)     ON CMM.REF_CM_ID=APM.MEMO_ID
    LEFT OUTER JOIN INM01106  INM (NOLOCK)     ON INM.REF_INV_ID=APM.MEMO_ID 
    LEFT OUTER JOIN  
    (SELECT A.APD_ROW_ID,SUM(A.QUANTITY) AS RET_QTY 
     FROM APPROVAL_RETURN_DET A (NOLOCK)    
     JOIN APPROVAL_RETURN_MST C (NOLOCK)    ON C.MEMO_ID=A.MEMO_ID
     WHERE CANCELLED=0 AND A.MEMO_ID=@CWHERE
     GROUP BY A.APD_ROW_ID) RET ON RET.APD_ROW_ID=C.ROW_ID 
	WHERE A.MEMO_ID = @CWHERE     
	ORDER BY AUTO_SRNO DESC   
          
 GOTO LAST                
   
LBLPENDING:    
    DECLARE @cMobile VARCHAR(50),@cUserCustCode VARCHAR(50)

	SELECT TOP 1 @cMobile=mobile,@cUserCustCode=user_customer_code FROM custdym (NOLOCK)
	WHERE customer_code=@CWHERE

	SELECT memo_id INTO #tmpAppmemos FROM APM01106 a (NOLOCK)
	JOIN custdym cus (NOLOCK) ON cus.customer_code=a.CUSTOMER_CODE
	WHERE ISNULL(REF_CM_ID,'')='' AND A.MEMO_TYPE=@CMODE   AND A.CANCELLED=0  
	AND ((@CMODE IN  (0,1) AND (A.CUSTOMER_CODE = @CWHERE OR (ISNULL(cus.mobile,'')=@cMobile AND @cMobile<>'')
						 OR (ISNULL(cus.user_customer_code,'')=@cUserCustCode AND @cUserCustCode<>''))) 
	  OR (@CMODE=2 AND A.AC_CODE= @CWHERE))
	AND A.DEPT_ID= @CWHERE1

	IF ISNULL(@NXN_ITEM_TYPE,0)=0
	SET @NXN_ITEM_TYPE=1

	SELECT CONVERT(BIT,0) AS CHKITEM,A.MEMO_ID,B.PRODUCT_CODE,B.QUANTITY AS ISSUE_QUANTITY,
	B.QUANTITY-ISNULL(C.RET_QTY,0) AS BALANCE_QUANTITY,    
	B.MRP,D.MRP AS TEMPMRP,B.NET,A.MEMO_NO,A.MEMO_DT,    
	B.ROW_ID,B.EMP_CODE,B.MRP,B.RFNET,D.DT_CREATED AS SKU_DT_CREATED, E.DT_CREATED AS ART_DT_CREATED,E.ARTICLE_NO,         
	F.PARA1_CODE,F.PARA1_NAME , G.PARA2_CODE , G.PARA2_NAME,H.SUB_SECTION_NAME, I.SECTION_NAME,    
	J.DT_CREATED AS PARA3_DT_CREATED,J.PARA3_NAME, CONVERT(NUMERIC(10,2),0) AS RET_QUANTITY , D.FIX_MRP,D.PRODUCT_NAME,  
	P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME,UOM.UOM_TYPE   
	,B.EMP_CODE1,B.EMP_CODE2,B.ROW_ID AS APD_ROW_ID    
	,EMP.EMP_NAME,UOM.UOM_NAME,CONVERT(BIT,0) AS FREEZED,B.BIN_ID ,B1.BIN_NAME ,
	E.ALIAS AS ARTICLE_ALIAS,B.ITEM_REMARKS ,
	B.PRODUCT_CODE AS APD_PRODUCT_CODE  ,d.barcode_coding_scheme ,b.discount_percentage,b.discount_amount,B.FIX_MRP
	FROM APM01106 A     
	JOIN APD01106 B ON A.MEMO_ID = B.MEMO_ID     
	JOIN #tmpAppmemos p ON p.memo_id=b.memo_id
	JOIN SKU D ON B.PRODUCT_CODE = D.PRODUCT_CODE
	JOIN BIN B1 ON B1.BIN_ID=B.BIN_ID    
	LEFT OUTER JOIN     
	(
	SELECT APD_ROW_ID,SUM(A.QUANTITY) AS RET_QTY FROM APPROVAL_RETURN_DET A   
	JOIN APPROVAL_RETURN_MST MST ON A.MEMO_ID=MST.MEMO_ID   
	JOIN APD01106 B ON A.APD_ROW_ID=B.ROW_ID 
	JOIN APM01106 C ON C.MEMO_ID=B.MEMO_ID    
	JOIN #tmpAppmemos p ON p.memo_id=c.memo_id
	WHERE C.MEMO_TYPE=@CMODE AND C.CANCELLED=0 AND MST.CANCELLED=0
	GROUP BY APD_ROW_ID
	) C ON C.APD_ROW_ID=B.ROW_ID     
	LEFT JOIN  custdym cus (NOLOCK) ON cus.customer_code=a.customer_code
	LEFT JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE         
	LEFT JOIN PARA1 F ON D.PARA1_CODE = F.PARA1_CODE         
	LEFT JOIN PARA2 G ON D.PARA2_CODE = G.PARA2_CODE         
	LEFT JOIN SECTIOND H ON E.SUB_SECTION_CODE = H.SUB_SECTION_CODE         
	LEFT JOIN SECTIONM I ON H.SECTION_CODE = I.SECTION_CODE       
	LEFT JOIN PARA3 J ON D.PARA3_CODE = J.PARA3_CODE   
	LEFT JOIN PARA4 P4 ON P4.PARA4_CODE = D.PARA4_CODE   
	LEFT JOIN PARA5 P5 ON P5.PARA5_CODE = D.PARA5_CODE   
	LEFT JOIN PARA6 P6 ON P6.PARA6_CODE = D.PARA6_CODE   
	LEFT JOIN UOM ON E.UOM_CODE = UOM.UOM_CODE   
	LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON B.EMP_CODE = EMP.EMP_CODE       
	WHERE ISNULL(REF_CM_ID,'')='' AND A.MEMO_TYPE=@CMODE   AND A.CANCELLED=0  
	AND ((@CMODE IN  (0,1) AND (A.CUSTOMER_CODE = @CWHERE OR (ISNULL(cus.mobile,'')=@cMobile AND @cMobile<>'')
						 OR (ISNULL(cus.user_customer_code,'')=@cUserCustCode AND @cUserCustCode<>''))) 
	  OR (@CMODE=2 AND A.AC_CODE= @CWHERE))
	AND A.DEPT_ID= @CWHERE1 AND (B.QUANTITY-ISNULL(C.RET_QTY,0)) > 0   
	AND CASE WHEN ISNULL(A.XN_ITEM_TYPE,0) IN(0,1) THEN 1 ELSE A.XN_ITEM_TYPE END  =@NXN_ITEM_TYPE 


GOTO LAST     
              
LAST:   
    	
END