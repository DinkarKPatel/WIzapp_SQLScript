CREATE PROCEDURE SP3S_VALIDATEXN_BEFORESAVE_PO
@nSpId VARCHAR(40),
@CERRORMSG VARCHAR(MAX) OUTPUT
AS
BEGIN
		DECLARE @cBuyPlanItemRowId VARCHAR(40),@cSTEP VARCHAR(10),@HSN_CODE VARCHAR(200)

		SET @cSTEP = 2.6		-- GETTING ID INFO FROM TEMP TABLE			
		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

		IF OBJECT_ID ('TEMPDB..#TMPEXPIRY_CHECK','U') IS NOT NULL
			DROP TABLE #TMPEXPIRY_CHECK
		
		SELECT TOP 1 @cBuyPlanItemRowId=buy_plan_row_id FROM PO_POD01106_UPLOAD (NOLOCK)
		WHERE sp_id=@nSpId

		IF ISNULL(@cBuyPlanItemRowId,'')<>''
		BEGIN

			SET @cSTEP = 2.8		-- GETTING ID INFO FROM TEMP TABLE			
			EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

			SELECT DISTINCT  A.po_dt ,A.po_id, C.MEMO_NO,C.EXPIRY_DT
			INTO #TMPEXPIRY_CHECK
			FROM PO_POM01106_UPLOAD A (NOLOCK)
			JOIN PO_POD01106_UPLOAD B (NOLOCK) ON A.sp_id =B.sp_id 
			JOIN (
				SELECT A.ROW_ID ,BM.expiry_dt ,BM.memo_no 
				FROM buy_plan_det A (NOLOCK)
				JOIN buy_plan_mst B (NOLOCK) ON A.memo_no =B.memo_no 
				JOIN budget_plan_mst BM (NOLOCK) ON BM.MEMO_NO =B.budget_plan_memo_no
				JOIN PO_POD01106_UPLOAD pod (NOLOCK) ON pod.buy_plan_row_id=a.row_id
				WHERE B.cancelled =0 AND BM.cancelled =0 AND pod.sp_id=@nSpId
			) C ON B.buy_plan_row_id =C.ROW_ID 
			WHERE A.sp_id=@nSpId
			AND ISNULL(buy_plan_row_id,'') <>''
			AND A.po_dt>C.EXPIRY_DT

			SET @cSTEP = 3.1		-- GETTING ID INFO FROM TEMP TABLE			
			EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

			IF EXISTS(SELECT TOP 1 'U' FROM #TMPEXPIRY_CHECK)
			BEGIN
				     
					DECLARE @CBUDGET VARCHAR(100)
					SELECT TOP 1 @CBUDGET=MEMO_NO FROM #TMPEXPIRY_CHECK
				     
					SET @CERRORMSG = 'BUDGET PLAN HAN BEEN EXPIRED PLEASE CHECK = '''+ISNULL(@CBUDGET,'')+''''	
					GOTO END_PROC  
			END
		END	

		SET @cSTEP = 3.3		-- GETTING ID INFO FROM TEMP TABLE			
		EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1
			
		IF EXISTS ( SELECT TOP 1 A.HSN_CODE FROM PO_POD01106_UPLOAD A (NOLOCK)
			        LEFT JOIN HSN_MST B(NOLOCK) ON
			        A.HSN_CODE=B.HSN_CODE WHERE B.HSN_CODE IS NULL AND A.SP_ID=@NSPID)
			SELECT TOP 1 @HSN_CODE=A.HSN_CODE FROM PO_POD01106_UPLOAD A (NOLOCK) 
			LEFT JOIN HSN_MST B(NOLOCK) ON
			A.HSN_CODE=B.HSN_CODE WHERE B.HSN_CODE IS NULL AND A.SP_ID=@NSPID
		               
		
		IF ISNULL(@HSN_CODE,'')<>''
		BEGIN
				SET @CERRORMSG = 'HSN CODE SHOULD BE IN HSN MASTER = '''+@HSN_CODE+''''	
				GOTO END_PROC  		
		END

END_PROC:

END