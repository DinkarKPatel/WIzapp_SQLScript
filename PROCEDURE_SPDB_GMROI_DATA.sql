CREATE PROCEDURE SPDB_GMROI_DATA
@DTODATE DATETIME
AS
BEGIN
	IF OBJECT_ID('TEMPDB..#TMPSALEDAYS','U') IS NOT NULL
		DROP TABLE #TMPSALEDAYS
	
	DECLARE @CSETUPCODE CHAR(5),@CPARANAME VARCHAR(200),@CFILTERCRITERIA VARCHAR(MAX),@BFLAG BIT,
			@CCMD NVARCHAR(MAX),@CFINYEAR VARCHAR(10),@DFROMDT DATETIME

	SELECT @CFINYEAR='01'+DBO.FN_GETFINYEAR(@DTODATE)
	
	SET @DFROMDT=DBO.FN_GETFINYEARDATE(@CFINYEAR,1)
	
	IF NOT EXISTS (SELECT TOP 1 SETUP_CODE FROM DB_SALE_CONTR_SETUP WHERE MODE=3)
		RETURN
			
	EXEC SPDB_PROFIT_CONTRIBUTION_DATA @DTODATE,1

	IF OBJECT_ID('TEMPDB..#TMPSETUP','U') IS NOT NULL
		DROP TABLE #TMPSETUP
	
	SELECT * INTO #TMPSETUP	FROM DB_SALE_CONTR_SETUP  WHERE MODE=3
	
	SET @BFLAG=0
	
	WHILE @BFLAG=0
	BEGIN
		SET @CSETUPCODE=''
		
		SELECT TOP 1 @CSETUPCODE=SETUP_CODE,@CPARANAME=PARA_NAME,@CFILTERCRITERIA=FILTER_CRITERIA FROM #TMPSETUP
		
		
		IF ISNULL(@CSETUPCODE,'')=''
			BREAK
		
		EXEC SPDB_CALCULATE_ADI 
		@DFROMDT=@DFROMDT,
		@DTODT=@DTODATE,
		@CFILTERCOLS=@CFILTERCRITERIA,
		@CLAYOUTCOLS=@CPARANAME,
		@CSETUPCODE=@CSETUPCODE
		
		
		DELETE FROM #TMPSETUP WHERE SETUP_CODE=@CSETUPCODE	
	END
	
	SELECT LEFT(CM_ID,2) AS DEPT_ID,MAX(CM_DT) AS MAX_CM_DT 
	INTO #TMPSALEDAYS FROM CMM01106 (NOLOCK) 
	WHERE CM_DT BETWEEN @DFROMDT AND @DTODATE AND CANCELLED=0
	GROUP BY LEFT(CM_ID,2)
	
	UPDATE DB_GMROI_SUMMARY SET NO_OF_DAYS=DATEDIFF(DD,@DFROMDT,B.MAX_CM_DT)+1
	FROM #TMPSALEDAYS B WHERE B.DEPT_ID=DB_GMROI_SUMMARY.DEPT_ID
	
	UPDATE DB_GMROI_SUMMARY SET NO_OF_DAYS=DATEDIFF(DD,@DFROMDT,B.MAX_CM_DT)+1
	FROM (SELECT MAX(MAX_CM_DT) AS MAX_CM_DT FROM #TMPSALEDAYS) B
	WHERE DEPT_ID=''	
	
	UPDATE DB_GMROI_SUMMARY SET GMROI=(CASE WHEN ISNULL(NO_OF_DAYS,0)<>0 AND ISNULL(ADI,0)<>0 THEN 
	ISNULL(ROUND((PROFIT_AMOUNT/NO_OF_DAYS*365)/ADI*100,2),0) ELSE 0 END) WHERE ADI>=1000
END
----------- END OF SPDB_GMROI_DATA
