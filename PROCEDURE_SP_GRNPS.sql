create PROCEDURE SP_GRNPS    

@NQUERYID NUMERIC(2,0),    
@CFROMDATE NVARCHAR(50),    
@CTODATE NVARCHAR(50),    
@CWHERE  NVARCHAR(MAX),    
@CWHERE1 VARCHAR(100)='',
@CMODE INT=1,
@SPID VARCHAR(40)='',
@BOX_NO NUMERIC(10,2)=0,
@cLocId CHAR(4)=''
     
AS    
BEGIN    
 --(dinkar) Replace  left(memoid,2) to Location_code 
DECLARE @CCMD NVARCHAR(MAX),@CERRMSG NVARCHAR(MAX),@CCURLOCID CHAR(4), @IMAXLEVEL INT ,@CXN_TYPE VARCHAR(100),
@AC_CODE VARCHAR(15),@cPOId VARCHAR(50)

	SET @CCURLOCID=@cLocId	



    SET @CXN_TYPE=''
    SET @AC_CODE=''
    
	SELECT @CXN_TYPE=XN_TYPE FROM PARCEL_MST a (NOLOCK)
	JOIN parcel_det b (NOLOCK) ON b.parcel_memo_id=a.parcel_memo_id
	WHERE b.row_id=@CWHERE


IF @CXN_TYPE='DIR'
BEGIN
   SET @CMODE=1
     SELECT @AC_CODE =a.AC_CODE   FROM PARCEL_DET A(NOLOCK) 
     JOIN PARCEL_MST B(NOLOCK) ON A.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID
     WHERE A.PARCEL_MEMO_ID=@CWHERE 
     
END

IF @CXN_TYPE='PO'
BEGIN
     SET @CMODE=2
     
	 SELECT TOP 1 @cPoId=REF_MEMO_ID FROM parcel_det WHERE row_id=@CWHERE 
     SELECT @CWHERE=REF_MEMO_ID,@AC_CODE =a.AC_CODE   FROM PARCEL_DET A(NOLOCK) 
     JOIN PARCEL_MST B(NOLOCK) ON A.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID
     WHERE A.row_ID=@CWHERE 
     
END



IF @CXN_TYPE IN('ASN','GRN')
BEGIN
    SET @CMODE=3
    DECLARE @CREF_GRN_MODE VARCHAR(10)
     SELECT TOP 1 @cPoId=REF_MEMO_ID FROM parcel_det WHERE row_id=@CWHERE 
     SELECT @CWHERE=REF_MEMO_ID,@AC_CODE =a.AC_CODE ,@CREF_GRN_MODE=REF_GRN_MODE  FROM parcel_det  A(NOLOCK) 
     JOIN PARCEL_MST B(NOLOCK) ON A.PARCEL_MEMO_ID=B.PARCEL_MEMO_ID
     WHERE A.row_ID=@CWHERE
     
    IF @CREF_GRN_MODE='1' --AGAINST ASN
     SET @CMODE=3
     ELSE IF @CREF_GRN_MODE=2--AGAINST PO
     SET @CMODE=2
     
   
     
END




IF @NQUERYID = 1    
GOTO LBLSUPPLIERSLOV    

ELSE IF @NQUERYID = 2    
GOTO LBLGETMST    

ELSE IF @NQUERYID = 3    
GOTO LBLGETDETAILS 

ELSE IF @NQUERYID=4 
GOTO LBLPENDINGPO  

ELSE IF @NQUERYID=7
GOTO LBLPENDINGASN  

ELSE IF @NQUERYID=6 
GOTO LBLPENDINGPRODUCTCODE

ELSE IF @NQUERYID=7 
GOTO LBLPENDINGASNBOXWISE

ELSE IF @NQUERYID=8 
GOTO LABLE8
  
ELSE    
GOTO LAST    


LBLSUPPLIERSLOV:    
DECLARE @CHEADCODE VARCHAR(MAX),@CHEADCODE1 VARCHAR(MAX),@CHEADCODE2 VARCHAR(4000),@CHEADCODE3 VARCHAR(4000) 
SET @CHEADCODE=DBO.FN_ACT_TRAVTREE(@CWHERE)
SELECT  A.AC_CODE, A.AC_NAME, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,       
ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE,      
A.ADDRESS1 + ' ' + A.ADDRESS2 + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +       
A.STATE AS 'SUPP_ADDRESS', AC_NAME AS REPCOLNAME ,  A.FORM_ID ,ISNULL(A.ON_HOLD,0) AS ON_HOLD     
FROM LMV01106 A(NOLOCK)       
WHERE ( CHARINDEX ( HEAD_CODE,@CHEADCODE ) > 0  OR ALLOW_CREDITOR_DEBTOR = 1 )       
AND INACTIVE = 0 AND A.AC_NAME <> ''     
UNION ALL      
SELECT A.AC_CODE, ALIAS, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,       
ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE,       
A.ADDRESS1 + ' ' + A.ADDRESS2 + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +       
A.STATE AS 'SUPP_ADDRESS', AC_NAME AS REPCOLNAME ,  A.FORM_ID  ,ISNULL(A.ON_HOLD,0) AS ON_HOLD     
FROM LMV01106 A(NOLOCK)       
WHERE ( CHARINDEX ( HEAD_CODE, @CHEADCODE ) > 0  OR ALLOW_CREDITOR_DEBTOR = 1 )       
AND INACTIVE = 0 AND A.ALIAS <> ''     
ORDER BY A.AC_NAME       

GOTO LAST    

LBLGETMST:   


SELECT  USERS.USERNAME,  C.AC_NAME AS SUPP_NAME,     
C.ADDRESS1 + ' ' + C.ADDRESS2 + ', ' + C.AREA_NAME + ' ' + C.CITY + ' ' + C.STATE AS 'SUPP_ADDRESS',    
MST.*, CONVERT(CHAR(10),CASE WHEN MST.MEMO_DT='' THEN NULL ELSE MST.MEMO_DT END ,105)  AS RM_DT1,BIN_NAME,
PO_NO,ASN_MST.MEMO_NO AS ASN_NO,CAST( '' AS VARCHAR(50)) SP_ID ,
ISNULL(pm.parcel_memo_no,PARCEL_MST.PARCEL_MEMO_NO) as parcel_memo_no,CONVERT(BIT,0) AS parcel_closed,
'' as ref_parcel_memo_id,1 as mode 
FROM GRN_PS_MST MST (NOLOCK)        
JOIN USERS (NOLOCK)  ON MST.USER_CODE = USERS.USER_CODE     
JOIN LMV01106 C(NOLOCK) ON MST.AC_CODE = C.AC_CODE  
JOIN BIN (NOLOCK) ON BIN.BIN_ID=MST.BIN_ID
LEFT JOIN POM01106(NOLOCK) ON POM01106.PO_ID=MST.PO_ID
LEFT JOIN ASN_MST(NOLOCK) ON ASN_MST.MEMO_ID=MST.ASN_MEMO_ID
LEFT JOIN PARCEL_DET pd (NOLOCK) ON pd.row_id=MST.REF_PARCEL_ROW_ID
LEFT JOIN PARCEL_MST (NOLOCK) ON PARCEL_MST.PARCEL_MEMO_ID =pd.PARCEL_MEMO_ID 
LEFT JOIN PARCEL_mst pm (NOLOCK) ON pm.parcel_memo_id= pd.parcel_memo_id
WHERE MST.MEMO_ID  =@CWHERE    

GOTO LAST    

LBLGETDETAILS:    

SELECT  A.*, B.UOM_CODE,       
RMM.CANCELLED,B.DISCON,E.UOM_TYPE,  B.ARTICLE_CODE,       
B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC, C.PARA1_CODE,       
C.PARA1_NAME, D.PARA2_CODE, D.PARA2_ORDER, D.PARA2_NAME, E.UOM_NAME, I.AC_CODE,    
E.UOM_TYPE,  
G.SUB_SECTION_NAME, H.PARA3_CODE,S.PURCHASE_PRICE,     
H.PARA3_NAME, I.AC_NAME, J.SECTION_NAME, S.MRP,S.WS_PRICE AS WSP, B.CODING_SCHEME, '' AS BRAND_NAME,     
X.PARA4_NAME, X.PARA4_CODE, Y.PARA5_NAME, Y.PARA5_CODE,     
Z.PARA6_NAME, Z.PARA6_CODE, A.QUANTITY ,CAST( '' AS VARCHAR(50)) SP_ID,
ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(H.DT_CREATED,'') AS [PARA3_DT_CREATED],    
ISNULL(S.DT_CREATED,'') AS [SKU_DT_CREATED],I.CITY  ,S.PRODUCT_NAME,S.FIX_MRP,  
S.ER_FLAG,S.MRP,S.WS_PRICE ,B.STOCK_NA,B.ALIAS AS ARTICLE_ALIAS,
A.PRODUCT_CODE AS ORG_PRODUCT_CODE, 
 CAST(CASE WHEN CHARINDEX('@',A.PRODUCT_CODE)=0 THEN '' ELSE 
(SUBSTRING(A.PRODUCT_CODE,CHARINDEX('@',A.PRODUCT_CODE)+1,15)) END  AS VARCHAR(100)) AS BATCH_LOT_NO,
   S.BATCH_NO,S.EXPIRY_DT ,CAST (0 AS BIT) AS CHK,CAST( 0 AS NUMERIC(10,2)) AS PENDING_QTY,ISNULL(BIN.BIN_NAME,'') AS BIN_NAME
FROM GRN_PS_DET A (NOLOCK)        
JOIN GRN_PS_MST RMM (NOLOCK) ON A.MEMO_ID  = RMM.MEMO_ID         
JOIN SKU S (NOLOCK)  ON A.PRODUCT_CODE = S.PRODUCT_CODE      
LEFT OUTER JOIN SKU_OH F(NOLOCK) ON S.PRODUCT_CODE = F.PRODUCT_CODE      
JOIN ARTICLE B (NOLOCK)  ON S.ARTICLE_CODE = B.ARTICLE_CODE        
JOIN PARA1 C (NOLOCK) ON S.PARA1_CODE = C.PARA1_CODE        
JOIN PARA2 D (NOLOCK)  ON S.PARA2_CODE = D.PARA2_CODE       
JOIN PARA3 H (NOLOCK)  ON S.PARA3_CODE = H.PARA3_CODE        
JOIN PARA4 X (NOLOCK)  ON S.PARA4_CODE = X.PARA4_CODE        
JOIN PARA5 Y (NOLOCK)  ON S.PARA5_CODE = Y.PARA5_CODE        
JOIN PARA6 Z (NOLOCK)  ON S.PARA6_CODE = Z.PARA6_CODE       
JOIN UOM E  (NOLOCK)  ON B.UOM_CODE = E.UOM_CODE       
JOIN SECTIOND G (NOLOCK)  ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE        
JOIN LMV01106 I (NOLOCK)  ON S.AC_CODE = I.AC_CODE    
JOIN SECTIONM J (NOLOCK) ON G.SECTION_CODE = J.SECTION_CODE  
LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID          
WHERE A.MEMO_ID =@CWHERE          
GOTO LAST 



LBLPENDINGPO:
 
SELECT @IMAXLEVEL=MAX(LEVEL_NO) 
			FROM XN_APPROVAL_CHECKLIST_LEVELS(NOLOCK) 
			WHERE XN_TYPE='PO' AND INACTIVE=0 
		SET @IMAXLEVEL=ISNULL(@IMAXLEVEL,0)	
		
 
        
SELECT DISTINCT  POD01106.PO_ID,PO_NO,CONVERT(VARCHAR, PO_DT ,105) AS PO_DT
FROM POD01106 (NOLOCK)
JOIN POM01106(NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
LEFT JOIN
(
SELECT PO_ROW_ID,ISNULL(SUM(QUANTITY),0) GRN_PS_DET_QUANTITY FROM GRN_PS_DET(NOLOCK) 
JOIN GRN_PS_MST(NOLOCK)  ON GRN_PS_MST.MEMO_ID=GRN_PS_DET.MEMO_ID
AND GRN_PS_MST.CANCELLED=0
WHERE AC_CODE=@AC_CODE 
GROUP BY PO_ROW_ID
)Z ON Z.PO_ROW_ID=POD01106.ROW_ID 
WHERE  ( POD01106.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) > 0
AND  PO_RECEIVING_MODE=3  AND @CCURLOCID=POM01106.DEPT_ID
AND POM01106.AC_CODE=@AC_CODE  AND (@IMAXLEVEL=0 OR POM01106.APPROVEDLEVELNO=99) 


GOTO LAST

LBLPENDINGASN:

IF OBJECT_ID('TEMPDB..##TMPPENDINGASN','U') IS NULL
BEGIN
   CREATE TABLE ##TMPPENDINGASN
   (
    MEMO_ID VARCHAR(50),
    MEMO_NO VARCHAR(30),
    MEMO_DT DATETIME,
    PO_ROW_ID VARCHAR(50),
    BOX_NO NUMERIC(4,0),
    SP_ID VARCHAR(40),
    PENDING_QTY NUMERIC(14,2),
    ASN_ROW_ID VARCHAR(40)
    )
END
DELETE FROM ##TMPPENDINGASN WHERE SP_ID=@SPID
IF NOT EXISTS(SELECT TOP 1 'U'FROM ##TMPPENDINGASN WHERE SP_ID=@SPID)
BEGIN
   
SELECT @IMAXLEVEL=MAX(LEVEL_NO) 
FROM XN_APPROVAL_CHECKLIST_LEVELS(NOLOCK)
WHERE XN_TYPE='ASN' AND INACTIVE=0

SET @IMAXLEVEL=ISNULL(@IMAXLEVEL,0)


INSERT INTO ##TMPPENDINGASN (MEMO_ID,MEMO_NO,MEMO_DT,PO_ROW_ID,BOX_NO,SP_ID,PENDING_QTY,ASN_ROW_ID)
SELECT DISTINCT ASN_DET.MEMO_ID,MEMO_NO,MEMO_DT,PO_ROW_ID,ASN_DET.BOX_NO,@SPID,
( ASN_DET.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) AS PENDING_QTY,ASN_DET.ROW_ID AS ASN_ROW_ID
FROM ASN_DET (NOLOCK)
JOIN ASN_MST(NOLOCK) ON ASN_MST.MEMO_ID=ASN_DET.MEMO_ID
JOIN POD01106 (NOLOCK) ON POD01106.ROW_ID=ASN_DET.PO_ROW_ID
JOIN POM01106(NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
LEFT JOIN
(
SELECT ASN_ROW_ID,ISNULL(SUM(QUANTITY),0) GRN_PS_DET_QUANTITY FROM GRN_PS_DET A(NOLOCK)
JOIN GRN_PS_MST B(NOLOCK) ON A.MEMO_ID=B.MEMO_ID
WHERE AC_CODE=@AC_CODE AND B.CANCELLED=0

GROUP BY ASN_ROW_ID
)Z ON Z.ASN_ROW_ID=ASN_DET.ROW_ID 
WHERE  ( ASN_DET.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) > 0
AND  PO_RECEIVING_MODE=2 AND @CCURLOCID=POM01106.DEPT_ID
AND POM01106.AC_CODE=@AC_CODE
AND (@IMAXLEVEL=0 OR ASN_MST.APPROVEDLEVELNO=99)




GOTO LBLPENDINGASNBOXWISE

END

 

GOTO LAST       


LBLPENDINGPRODUCTCODE:



IF @CMODE=1
BEGIN
   IF NOT EXISTS(SELECT TOP 1'U' FROM SKU(NOLOCK) WHERE PRODUCT_CODE=@CWHERE1)
		 SET @CERRMSG='PRODUCT CODE NOT FOUND'

    SELECT ISNULL(@CERRMSG,'') AS ERRMSG
 
   IF ISNULL(@CERRMSG,'')=''
	   BEGIN
			SELECT DISTINCT TOP 1 SECTION_NAME,SUB_SECTION_NAME,ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,
			PARA5_NAME,PARA6_NAME,PRODUCT_CODE,BARCODE_CODING_SCHEME,CODING_SCHEME,UOM_NAME,UOM_TYPE 
			 FROM SKU(NOLOCK)
			JOIN ARTICLE(NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
			JOIN PARA1(NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
			JOIN PARA2(NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
			JOIN PARA3(NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
			JOIN PARA4(NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
			JOIN PARA5(NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
			JOIN PARA6(NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
			JOIN SECTIOND(NOLOCK)ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
			JOIN SECTIONM(NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
			JOIN UOM(NOLOCK) ON ARTICLE.UOM_CODE=UOM.UOM_CODE
			WHERE PRODUCT_CODE=@CWHERE1
	   END	
GOTO LAST    
END

IF @CMODE=2
BEGIN

   IF NOT EXISTS(SELECT TOP 1'U' FROM POD01106(NOLOCK) WHERE PRODUCT_CODE=@CWHERE1)
      SET @CERRMSG='ITEM CODE NOT FOUND'
      
	
	
	
    IF ISNULL(@CERRMSG,'')=''
	BEGIN 
		IF NOT EXISTS( SELECT DISTINCT TOP 1 POD01106.PRODUCT_CODE FROM POD01106 (NOLOCK)
				       JOIN POM01106(NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
		LEFT JOIN
		(
		SELECT PO_ROW_ID,ISNULL(SUM(GRN_PS_DET.QUANTITY),0) GRN_PS_DET_QUANTITY FROM GRN_PS_DET (NOLOCK) 
		JOIN GRN_PS_MST (NOLOCK) ON GRN_PS_MST.MEMO_ID=GRN_PS_DET.MEMO_ID 
		JOIN POD01106 (NOLOCK) ON POD01106.ROW_ID=GRN_PS_DET.PO_ROW_ID
		JOIN POM01106 (NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
		WHERE POD01106.PRODUCT_CODE=@CWHERE1 AND POD01106.PO_ID=@cPoId 
		AND  GRN_PS_MST.CANCELLED=0 AND @CCURLOCID=POM01106.DEPT_ID
		AND PO_RECEIVING_MODE=3
		GROUP BY PO_ROW_ID
		)Z ON Z.PO_ROW_ID=POD01106.ROW_ID 
		WHERE  ( POD01106.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) > 0
		AND  PO_RECEIVING_MODE=3 AND POD01106.PO_ID=@cPoId 
		AND POD01106.PRODUCT_CODE=@CWHERE1 AND @CCURLOCID=POM01106.DEPT_ID
		)
		BEGIN
			SET @CERRMSG='1.ITEM CODE IS NOT PENDING FOR GRN'
		END
	END
	
	
	
SELECT ISNULL(@CERRMSG,'') AS ERRMSG

	IF ISNULL(@CERRMSG,'')=''
	BEGIN
		SELECT DISTINCT TOP 1 POD01106.PO_ID,PO_NO,CONVERT(VARCHAR, PO_DT ,105) AS PO_DT,SECTION_NAME,SUB_SECTION_NAME,ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,
		PARA5_NAME,PARA6_NAME,POD01106.PRODUCT_CODE,BARCODE_CODING_SCHEME,CODING_SCHEME,UOM_NAME,UOM_TYPE,POD01106.ROW_ID AS PO_ROW_ID ,
		 ( POD01106.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) AS PENDING_QTY
		FROM POD01106 (NOLOCK)
		JOIN POM01106(NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=POD01106.PRODUCT_CODE
		JOIN ARTICLE(NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
		JOIN PARA1(NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
		JOIN PARA2(NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
		JOIN PARA3(NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
		JOIN PARA4(NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
		JOIN PARA5(NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
		JOIN PARA6(NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
		JOIN SECTIOND(NOLOCK)ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
		JOIN SECTIONM(NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
		JOIN UOM(NOLOCK) ON ARTICLE.UOM_CODE=UOM.UOM_CODE

		LEFT JOIN
		(
		SELECT PO_ROW_ID,ISNULL(SUM(GRN_PS_DET.QUANTITY),0) GRN_PS_DET_QUANTITY FROM GRN_PS_DET(NOLOCK) 
		JOIN GRN_PS_MST(NOLOCK)  ON GRN_PS_MST.MEMO_ID=GRN_PS_DET.MEMO_ID 
		JOIN POD01106(NOLOCK) ON POD01106.ROW_ID=GRN_PS_DET.PO_ROW_ID
		JOIN POM01106 (NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
		WHERE POD01106.PRODUCT_CODE=@CWHERE1 AND POD01106.PO_ID=@CWHERE 
		AND  GRN_PS_MST.CANCELLED=0 AND @CCURLOCID=POM01106.DEPT_ID
		AND PO_RECEIVING_MODE=3
		GROUP BY PO_ROW_ID
		)Z ON Z.PO_ROW_ID=POD01106.ROW_ID 
		WHERE  ( POD01106.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) > 0
		AND  PO_RECEIVING_MODE=3 AND POD01106.PO_ID=@cPOId
		AND POD01106.PRODUCT_CODE=@CWHERE1 AND @CCURLOCID=POM01106.DEPT_ID
	END
END

IF @CMODE=3
BEGIN
 IF NOT EXISTS(SELECT TOP 1'U' FROM POD01106(NOLOCK) WHERE PRODUCT_CODE=@CWHERE1)
		  SET @CERRMSG='ITEM CODE NOT FOUND'
	
	   
  IF ISNULL(@CERRMSG,'')=''
	   BEGIN
		IF NOT EXISTS(SELECT DISTINCT POD01106.PRODUCT_CODE
			FROM ASN_DET (NOLOCK)
			JOIN ASN_MST(NOLOCK) ON ASN_MST.MEMO_ID=ASN_DET.MEMO_ID
			JOIN POD01106 (NOLOCK) ON POD01106.ROW_ID=ASN_DET.PO_ROW_ID
			JOIN POM01106(NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
			LEFT JOIN
			(
			SELECT ASN_ROW_ID,ISNULL(SUM(A.QUANTITY),0) GRN_PS_DET_QUANTITY FROM GRN_PS_DET A(NOLOCK)
			JOIN GRN_PS_MST B(NOLOCK) ON A.MEMO_ID=B.MEMO_ID
			JOIN ASN_DET (NOLOCK) ON ASN_DET.ROW_ID=A.ASN_ROW_ID
			JOIN POD01106(NOLOCK) ON POD01106.ROW_ID=ASN_DET.PO_ROW_ID
			JOIN POM01106 (NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
			WHERE POD01106.PRODUCT_CODE=@CWHERE1 AND ASN_DET.MEMO_ID=@CWHERE
			AND B.CANCELLED=0 AND PO_RECEIVING_MODE=2 AND @CCURLOCID=POM01106.DEPT_ID
			GROUP BY ASN_ROW_ID
			)Z ON Z.ASN_ROW_ID=ASN_DET.ROW_ID 
			WHERE  ( ASN_DET.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) > 0
			AND  PO_RECEIVING_MODE=2  AND ASN_MST.MEMO_ID=@CWHERE
			AND  POD01106.PRODUCT_CODE=@CWHERE1 AND @CCURLOCID=POM01106.DEPT_ID) 
			BEGIN
				SET @CERRMSG='2.ITEM CODE IS NOT PENDING FOR GRN'

			END
		END
    SELECT ISNULL(@CERRMSG,'') AS ERRMSG
    
IF ISNULL(@CERRMSG,'') =''
		BEGIN
				SELECT DISTINCT TOP 1 ASN_DET.MEMO_ID,MEMO_NO,CONVERT(VARCHAR, MEMO_DT ,105) AS MEMO_DT,SECTION_NAME,
				SUB_SECTION_NAME,ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,
				PARA5_NAME,PARA6_NAME,POD01106.PRODUCT_CODE,BARCODE_CODING_SCHEME,CODING_SCHEME,UOM_NAME,UOM_TYPE 
				,ASN_DET.ROW_ID AS ASN_ROW_ID, ( ASN_DET.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) AS PENDING_QTY
				FROM ASN_DET (NOLOCK)
				JOIN ASN_MST(NOLOCK) ON ASN_MST.MEMO_ID=ASN_DET.MEMO_ID
				JOIN POD01106 (NOLOCK) ON POD01106.ROW_ID=ASN_DET.PO_ROW_ID
				JOIN POM01106(NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
				JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=POD01106.PRODUCT_CODE
				JOIN ARTICLE(NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
				JOIN PARA1(NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
				JOIN PARA2(NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
				JOIN PARA3(NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
				JOIN PARA4(NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
				JOIN PARA5(NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
				JOIN PARA6(NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
				JOIN SECTIOND(NOLOCK)ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
				JOIN SECTIONM(NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
				JOIN UOM(NOLOCK) ON ARTICLE.UOM_CODE=UOM.UOM_CODE
				LEFT JOIN
				(
				SELECT ASN_ROW_ID,ISNULL(SUM(A.QUANTITY),0) GRN_PS_DET_QUANTITY FROM GRN_PS_DET A(NOLOCK)
				JOIN GRN_PS_MST B(NOLOCK) ON A.MEMO_ID=B.MEMO_ID
				JOIN ASN_DET (NOLOCK) ON ASN_DET.ROW_ID=A.ASN_ROW_ID
				JOIN POD01106(NOLOCK) ON POD01106.ROW_ID=ASN_DET.PO_ROW_ID
				JOIN POM01106 (NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
				WHERE    PO_RECEIVING_MODE=2
				AND POD01106.PRODUCT_CODE=@CWHERE1 AND ASN_DET.MEMO_ID=@CWHERE
				AND B.CANCELLED=0 AND @CCURLOCID=POM01106.DEPT_ID
				
				GROUP BY ASN_ROW_ID
				)Z ON Z.ASN_ROW_ID=ASN_DET.ROW_ID 
				WHERE  ( ASN_DET.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) > 0
				AND  PO_RECEIVING_MODE=2  AND ASN_MST.MEMO_ID=@CWHERE
				AND  POD01106.PRODUCT_CODE=@CWHERE1  AND @CCURLOCID=POM01106.DEPT_ID
		 END     
END
GOTO LAST

LBLPENDINGASNBOXWISE:

IF ISNULL(@CWHERE,'')<>'' AND ISNULL(@BOX_NO,0)=0
SELECT DISTINCT BOX_NO FROM ##TMPPENDINGASN WHERE MEMO_ID=@CWHERE AND SP_ID=@SPID

IF ISNULL(@CWHERE,'')<>'' AND ISNULL(@BOX_NO,0)>0
BEGIN
   SELECT DISTINCT SECTION_NAME,
		SUB_SECTION_NAME,ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,
		PARA5_NAME,PARA6_NAME,POD01106.PRODUCT_CODE,BARCODE_CODING_SCHEME,CODING_SCHEME,UOM_NAME,UOM_TYPE,
		PENDING_QTY,CAST( 0 AS NUMERIC(10,2)) AS QUANTITY ,ASN_ROW_ID
		
		FROM ##TMPPENDINGASN A
		JOIN POD01106 (NOLOCK) ON POD01106.ROW_ID=A.PO_ROW_ID
		JOIN POM01106(NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
		JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=POD01106.PRODUCT_CODE
		JOIN ARTICLE(NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
		JOIN PARA1(NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
		JOIN PARA2(NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
		JOIN PARA3(NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
		JOIN PARA4(NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
		JOIN PARA5(NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
		JOIN PARA6(NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
		JOIN SECTIOND(NOLOCK)ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
		JOIN SECTIONM(NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
		JOIN UOM(NOLOCK) ON ARTICLE.UOM_CODE=UOM.UOM_CODE
		WHERE MEMO_ID=@CWHERE AND SP_ID=@SPID AND A.BOX_NO=@BOX_NO
		
	
		
END
GOTO LAST

LABLE8:

       IF ISNULL(@CWHERE,'') NOT IN ('','LATER') AND ISNULL(@CWHERE1,'')<>'' AND @BOX_NO > 0
       BEGIN
             IF EXISTS(SELECT TOP 1 'U' FROM GRN_PS_DET A(NOLOCK) JOIN GRN_PS_MST B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID
                      WHERE CANCELLED=0 AND ASN_MEMO_ID=@CWHERE AND PRODUCT_CODE=@CWHERE1 
                       AND BOX_NO<>@BOX_NO)
             BEGIN
                   
					 SELECT DISTINCT ASN_DET.MEMO_ID,MEMO_NO,CONVERT(VARCHAR, MEMO_DT ,105) AS MEMO_DT,
					 SECTION_NAME,
					SUB_SECTION_NAME,ARTICLE_NO,PARA1_NAME,PARA2_NAME,PARA3_NAME,PARA4_NAME,
					PARA5_NAME,PARA6_NAME,POD01106.PRODUCT_CODE,BARCODE_CODING_SCHEME,CODING_SCHEME,UOM_NAME,UOM_TYPE 
					,ASN_DET.ROW_ID AS ASN_ROW_ID, ( ASN_DET.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) AS PENDING_QTY
					FROM ASN_DET (NOLOCK)
					JOIN ASN_MST(NOLOCK) ON ASN_MST.MEMO_ID=ASN_DET.MEMO_ID
					JOIN POD01106 (NOLOCK) ON POD01106.ROW_ID=ASN_DET.PO_ROW_ID
				    JOIN POM01106(NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
					JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=POD01106.PRODUCT_CODE
					JOIN ARTICLE(NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
					JOIN PARA1(NOLOCK) ON PARA1.PARA1_CODE=SKU.PARA1_CODE
					JOIN PARA2(NOLOCK) ON PARA2.PARA2_CODE=SKU.PARA2_CODE
					JOIN PARA3(NOLOCK) ON PARA3.PARA3_CODE=SKU.PARA3_CODE
					JOIN PARA4(NOLOCK) ON PARA4.PARA4_CODE=SKU.PARA4_CODE
					JOIN PARA5(NOLOCK) ON PARA5.PARA5_CODE=SKU.PARA5_CODE
					JOIN PARA6(NOLOCK) ON PARA6.PARA6_CODE=SKU.PARA6_CODE
					JOIN SECTIOND(NOLOCK)ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
					JOIN SECTIONM(NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
					JOIN UOM(NOLOCK) ON ARTICLE.UOM_CODE=UOM.UOM_CODE
					LEFT JOIN
					(
					SELECT ASN_MEMO_ID,ASN_ROW_ID,ISNULL(SUM(A.QUANTITY),0) GRN_PS_DET_QUANTITY 
					FROM GRN_PS_DET A(NOLOCK)
					JOIN GRN_PS_MST B(NOLOCK) ON A.MEMO_ID=B.MEMO_ID
					JOIN ASN_DET (NOLOCK) ON ASN_DET.ROW_ID=A.ASN_ROW_ID
					JOIN POD01106 (NOLOCK) ON POD01106.ROW_ID=ASN_DET.PO_ROW_ID
					JOIN POM01106 (NOLOCK) ON POM01106.PO_ID=POD01106.PO_ID
					WHERE    PO_RECEIVING_MODE=2
					AND POD01106.PRODUCT_CODE=@CWHERE1 AND B.ASN_MEMO_ID=@CWHERE
					AND B.CANCELLED=0 AND @CCURLOCID=POM01106.DEPT_ID
					AND POM01106.CANCELLED=0 
					
					GROUP BY ASN_ROW_ID,ASN_MEMO_ID
					)Z ON Z.ASN_ROW_ID=ASN_DET.ROW_ID 
					WHERE  ( ASN_DET.QUANTITY-ISNULL(Z.GRN_PS_DET_QUANTITY,0)) > 0
					AND  PO_RECEIVING_MODE=2  AND Z.ASN_MEMO_ID=@CWHERE
					AND  POD01106.PRODUCT_CODE=@CWHERE1  AND @CCURLOCID=POM01106.DEPT_ID
					AND ASN_DET.BOX_NO<>@BOX_NO AND ASN_MST.CANCELLED=0
			                   
                   
             END
             ELSE
             BEGIN
                  SELECT '' MEMO_ID,''MEMO_NO,'' MEMO_DT,
					'' SECTION_NAME,
					''SUB_SECTION_NAME,''ARTICLE_NO,''PARA1_NAME,''PARA2_NAME,''PARA3_NAME,''PARA4_NAME,
					''PARA5_NAME,''PARA6_NAME,''PRODUCT_CODE,''BARCODE_CODING_SCHEME,'' CODING_SCHEME,''UOM_NAME,''UOM_TYPE 
					,''ASN_ROW_ID, '' PENDING_QTY WHERE 1=2
             END
       END
       ELSE
             BEGIN
                  SELECT '' MEMO_ID,''MEMO_NO,'' MEMO_DT,
					'' SECTION_NAME,
					''SUB_SECTION_NAME,''ARTICLE_NO,''PARA1_NAME,''PARA2_NAME,''PARA3_NAME,''PARA4_NAME,
					''PARA5_NAME,''PARA6_NAME,''PRODUCT_CODE,''BARCODE_CODING_SCHEME,'' CODING_SCHEME,''UOM_NAME,''UOM_TYPE 
					,''ASN_ROW_ID, '' PENDING_QTY WHERE 1=2
             END

GOTO LAST

LAST:    
END

/*
EXEC SP_GRNPS 6,'','','PP4AB8A7D0-DCCC-433C-B99A-A9434E2E3775','8960254400028 ',2,'222',0

select po_no, PO_RECEIVING_MODE, a.* from pod01106 a join pom01106 b on a.po_id=b.po_id
WHERE a.po_id='PP01119PP/PO/1819-000004' and product_code='8960254400028'

*/

