CREATE PROCEDURE SP_PRD_GIT
@NQUERYID NUMERIC(4,0),
@CDEPARTMENTID VARCHAR(10),
@CMEMOID VARCHAR(500)
--WITH ENCRYPTION
AS
BEGIN

IF @NQUERYID = 1
GOTO LBLGETMASTER

ELSE IF @NQUERYID = 2
GOTO LBLGETDETAILS

ELSE IF @NQUERYID = 3
GOTO LBLGETMASTERCURSOR

ELSE IF @NQUERYID = 4
GOTO LBLGETDETAILCURSOR

LBLGETMASTER:

	SELECT DISTINCT  @CMEMOID AS DEPT_ID,T1.*,T2.DEPARTMENT_NAME AS  TARGET_DEPTNAME,T3.DEPARTMENT_NAME AS SOURCE_DEPTNAME,
	ISNULL(T4.MEMO_NO,'') AS WORKORDERNO,CAST(0 AS BIT) AS CHECKED,CAST('' AS DATETIME) AS RECEIPT_DT,
	''AS RECEIPT_DATE,
	JOBS.JOB_NAME
	FROM PRD_ISSUE_MATERIAL_MST T1
	JOIN PRD_ISSUE_MATERIAL_DET DET ON T1.MEMO_ID=DET.MEMO_ID 
	JOIN PRD_DEPARTMENT_MST T2 ON T1.TARGET_DEPARTMENT_ID = T2.DEPARTMENT_ID
	JOIN PRD_DEPARTMENT_MST T3 ON T1.SOURCE_DEPARTMENT_ID = T3.DEPARTMENT_ID
	JOIN JOBS ON JOBS.JOB_CODE = DET.JOB_CODE 
	LEFT OUTER JOIN PRD_WO_MST T4 ON DET.REF_PRD_WORKORDER_MEMOID = T4.MEMO_ID
	LEFT OUTER JOIN 
	(SELECT REF_PRD_MATERIAL_ISSUE_MEMOID FROM  PRD_MATERIAL_RECEIPT_MST WHERE DEPARTMENT_ID = @CDEPARTMENTID
	 AND CANCELLED=0)  T5 ON T1.MEMO_ID = T5.REF_PRD_MATERIAL_ISSUE_MEMOID 
	WHERE T1.TARGET_DEPARTMENT_ID = @CDEPARTMENTID AND T5.REF_PRD_MATERIAL_ISSUE_MEMOID IS NULL
	AND T1.CANCELLED =0
GOTO LAST

LBLGETDETAILS:

	SELECT T1.*,T2.ARTICLE_NO,T2.ARTICLE_NAME,T2.ARTICLE_DESC,UOM.UOM_NAME,T1.MEMO_ID 
	,PARA1.PARA1_NAME,PARA2.PARA2_NAME,T3.ARTICLE_NO AS COMP_ARTICLE_NO
	FROM PRD_ISSUE_MATERIAL_DET T1	
	JOIN ARTICLE T2 ON T1.ARTICLE_CODE = T2.ARTICLE_CODE
	JOIN UOM ON T2.UOM_CODE = UOM.UOM_CODE
	JOIN PARA1 ON T1.PARA1_CODE = PARA1.PARA1_CODE 
	JOIN PARA2 ON T1.PARA2_CODE = PARA2.PARA2_CODE 
	JOIN ARTICLE T3 ON T1.REF_COMPONENT_ARTICLE_CODE = T3.ARTICLE_CODE
	GOTO LAST


LBLGETDETAILCURSOR:

	SELECT T1.*
	FROM PRD_MATERIAL_RECEIPT_DET T1
	WHERE T1.MEMO_ID = ''
	
GOTO LAST

LBLGETMASTERCURSOR:

	SELECT T1.*
	FROM PRD_MATERIAL_RECEIPT_MST T1
	WHERE T1.MEMO_ID = ''
	
GOTO LAST

LAST:
END
