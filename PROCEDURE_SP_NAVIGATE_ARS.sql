CREATE PROCEDURE SP_NAVIGATE_ARS 
@CTABLENAME VARCHAR(MAX)='ARS_MST',
@NNAVMODE INT,
@CMEMONO VARCHAR(MAX),
@CFINYEAR VARCHAR(MAX),
@CMEMODTCOL VARCHAR(MAX)='LAST_UPDATE',
@CMEMOIDCOL VARCHAR(MAX)='ARS_ID',
@CWHERECLAUSE VARCHAR(MAX)='',
@BINCLUDEESTIMATE BIT=1
--WITH ENCRYPTION
AS
BEGIN
    SET NOCOUNT ON
    IF @CTABLENAME='' SET @CTABLENAME='ARS_MST'
    IF @CTABLENAME='ARS_MST' SELECT @CMEMODTCOL='LAST_UPDATE',@CMEMOIDCOL='ARS_ID'
    IF @NNAVMODE=0 SET @NNAVMODE=1
	IF LEFT(REPLACE(@CWHERECLAUSE,' ',''),3)='AND'
	   BEGIN
	      IF LEFT (@CWHERECLAUSE,3)='AND'
	         SET @CWHERECLAUSE=SUBSTRING(@CWHERECLAUSE,4,LEN(@CWHERECLAUSE))
	      IF LEFT (@CWHERECLAUSE,4)=' AND'
	         SET @CWHERECLAUSE=SUBSTRING(@CWHERECLAUSE,5,LEN(@CWHERECLAUSE))
       END
    
	DECLARE @DMEMODT DATETIME,@CCMD NVARCHAR(MAX)
	
	DECLARE @TNAVIGATE TABLE (MEMO_ID VARCHAR(40))
		
	SET @CCMD=N'SELECT @DMEMODTOUT=CONVERT(DATE,'+@CMEMODTCOL+') FROM '+@CTABLENAME+' WHERE   '+@CMEMOIDCOL+'='''+@CMEMONO+''''
	PRINT '29'+ISNULL(@CCMD,'CMDNULL29')
	EXEC SP_EXECUTESQL @CCMD,N'@DMEMODTOUT DATETIME OUTPUT',@DMEMODTOUT=@DMEMODT OUTPUT
	
	--SELECT @CMEMONOCOL,@CMEMOIDCOL,@CTABLENAME,@BINCLUDEESTIMATE,@CWHERECLAUSE	,@NNAVMODE,@CMEMODTCOL,@DMEMODT 
	SET @CCMD = N'SELECT TOP 1 '+@CMEMOIDCOL+' FROM '+@CTABLENAME+' WHERE 1=1 '+
	(CASE WHEN @BINCLUDEESTIMATE=1 THEN '' ELSE ' AND MEMO_TYPE<>2 ' END)+
				   (CASE WHEN @CWHERECLAUSE<>'' THEN ' AND '+@CWHERECLAUSE ELSE '' END)+
				   (CASE WHEN @NNAVMODE IN(0,2,3) THEN ' AND CONVERT(VARCHAR,'+@CMEMODTCOL+',110)='''+CONVERT(VARCHAR,@DMEMODT,110)+'''
				  AND '+@CMEMOIDCOL+(CASE WHEN @NNAVMODE=2 THEN '<' WHEN @NNAVMODE=3 THEN '>' ELSE '=' END)+''''+@CMEMONO+'''' ELSE '' END)+
				 ' ORDER BY '+@CMEMODTCOL
				 +(CASE WHEN @NNAVMODE IN (1,3) THEN ' DESC ' ELSE ' ASC ' END)
				 +' ,'
				 +@CMEMOIDCOL
				 +(CASE WHEN @NNAVMODE IN (1,3) THEN ' DESC ' ELSE ' ASC ' END)
	PRINT '39'+CHAR(13)+ISNULL(@CCMD,'CMDNULL')		
	
	INSERT @TNAVIGATE			 
	EXEC SP_EXECUTESQL @CCMD                           
	
	IF NOT EXISTS (SELECT TOP 1 MEMO_ID FROM @TNAVIGATE)
	BEGIN
		SET @CCMD = N'SELECT TOP 1 '+@CMEMOIDCOL+' FROM '+@CTABLENAME+' WHERE 1=1 '+
						(CASE WHEN @BINCLUDEESTIMATE=1 THEN '' ELSE ' AND MEMO_TYPE<>2 ' END)+
					  (CASE WHEN @CWHERECLAUSE<>'' THEN ' AND '+@CWHERECLAUSE ELSE '' END)+
					  (CASE WHEN @NNAVMODE IN(0,2,3) THEN ' AND '+@CMEMODTCOL+ 
					  (CASE WHEN @NNAVMODE=2 THEN '<' WHEN @NNAVMODE=3 THEN '>' ELSE '=' END)+
					  ''''+CONVERT(VARCHAR,@DMEMODT,110)+''' AND '+@CMEMOIDCOL+'<>'''+@CMEMONO+'''' ELSE '' END)+
					  ' ORDER BY '+@CMEMODTCOL+(CASE WHEN @NNAVMODE IN (1,3) THEN ' ASC ' ELSE ' DESC ' END)+
					 ' ,'+@CMEMOIDCOL+(CASE WHEN @NNAVMODE IN (1,3) THEN ' ASC ' ELSE ' DESC ' END)
		PRINT @CCMD	
		INSERT @TNAVIGATE				 
		EXEC SP_EXECUTESQL @CCMD	
	END
	
	IF NOT EXISTS (SELECT TOP 1 MEMO_ID FROM @TNAVIGATE)
	BEGIN
		SET @CCMD=N'SELECT '+@CMEMOIDCOL+' FROM '+@CTABLENAME+' WHERE  
					 '+@CMEMOIDCOL+'='''+@CMEMONO+''''
		PRINT @CCMD	
		
		INSERT @TNAVIGATE				 
		EXEC SP_EXECUTESQL @CCMD	
	END
	
	IF OBJECT_ID('TEMPDB..#TMPNAV','U') IS NOT NULL
		DROP TABLE #TMPNAV
DECLARE @DO_NAV	BIT=1
	IF @NNAVMODE=2--PREV
	   BEGIN
	        IF (SELECT MIN(ARS_ID) FROM ARS_MST)=@CMEMONO
	           SET @DO_NAV=0
	        IF @DO_NAV=1   
			   SELECT TOP 1 ARS_ID FROM ARS_MST WHERE ARS_ID<@CMEMONO ORDER BY ARS_ID DESC	
			ELSE
			   SELECT TOP 1 ARS_ID FROM ARS_MST WHERE ARS_ID=@CMEMONO
			--SELECT TOP 1 ARS_ID FROM ARS_MST WHERE LAST_UPDATE<(SELECT LAST_UPDATE FROM ARS_MST WHERE ARS_ID=@CMEMONO) ORDER BY LAST_UPDATE DESC
	   END
	ELSE IF @NNAVMODE=3--NEXT
	   BEGIN
	       IF (SELECT MAX(ARS_ID) FROM ARS_MST)=@CMEMONO
	          SET @DO_NAV=0
	       IF @DO_NAV=1
	          SELECT TOP 1 ARS_ID FROM ARS_MST WHERE ARS_ID>@CMEMONO ORDER BY ARS_ID ASC
	       ELSE   
	          SELECT TOP 1 ARS_ID FROM ARS_MST WHERE ARS_ID=@CMEMONO
		   --SELECT TOP 1 ARS_ID FROM ARS_MST WHERE LAST_UPDATE>(SELECT LAST_UPDATE FROM ARS_MST WHERE ARS_ID=@CMEMONO) ORDER BY LAST_UPDATE ASC
	   END
	ELSE IF @NNAVMODE=4--BOTTOM
	   SELECT TOP 1 ARS_ID FROM ARS_MST ORDER BY ARS_ID DESC
	ELSE IF @NNAVMODE=1--TOP	   
	   SELECT TOP 1 ARS_ID FROM ARS_MST ORDER BY ARS_ID ASC
	ELSE
	   BEGIN
			SELECT MEMO_ID INTO #TMPNAV FROM @TNAVIGATE
			SET @CCMD=N'SELECT MEMO_ID AS '+@CMEMOIDCOL+' FROM #TMPNAV'
			--EXEC SP_EXECUTESQL @CCMD	
	   END
	SET NOCOUNT OFF
	/*
	SP_NAVIGATE_ARS @CTABLENAME='ARS_MST',@CMEMONO='',@CFINYEAR='01119',@CMEMOIDCOL='',@NNAVMODE=1--TOP/LATEST
	SP_NAVIGATE_ARS @CTABLENAME='ARS_MST',@CMEMONO='LY00001',@CFINYEAR='01119',@CMEMOIDCOL='',@NNAVMODE=2--PREV
	SP_NAVIGATE_ARS @CTABLENAME='ARS_MST',@CMEMONO='LU00007',@CFINYEAR='01119',@CMEMOIDCOL='',@NNAVMODE=3--NEXT
	SP_NAVIGATE_ARS @CTABLENAME='ARS_MST',@CMEMONO='',@CFINYEAR='01119',@CMEMOIDCOL='',@NNAVMODE=4--BOTTOM/OLDEST	
   */
END