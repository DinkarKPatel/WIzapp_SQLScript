CREATE PROCEDURE SP3S_DROPTEMPTABLES_MIRRORDATA
@CXNTYPE VARCHAR(10),
@CTABLESUFFIX VARCHAR(100),
@CTABLESSTR VARCHAR(2000)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CTABLENAME VARCHAR(200),@CSTEP VARCHAR(5),@CTMP_TABLENAME VARCHAR(200),
	@CCMD NVARCHAR(MAX),@NLOOP INT,@NCNTR INT,@CSOURCEDB VARCHAR(200),@CTMPTABLEREF VARCHAR(1500)
	
	SET @NCNTR = 0
	SET @NLOOP=LEN(@CTABLESSTR)-LEN(REPLACE(@CTABLESSTR,',',''))
	
	SET @CSOURCEDB=DB_NAME()+'_TEMP.DBO.'
	
	IF @NLOOP=0
		SET @NLOOP=1	
	
	PRINT STR(@NLOOP)
	WHILE @NCNTR<=@NLOOP
	BEGIN
		IF CHARINDEX(',',@CTABLESSTR)>0
		BEGIN
			IF @NCNTR<@NLOOP
				SET @CTABLENAME=SUBSTRING(@CTABLESSTR,DBO.FN3S_NTHINDEX(@CTABLESSTR,',',@NCNTR)+1,
												DBO.FN3S_NTHINDEX(@CTABLESSTR,',',@NCNTR+1)-
												DBO.FN3S_NTHINDEX(@CTABLESSTR,',',@NCNTR)-1)	
			ELSE
				SET @CTABLENAME=SUBSTRING(@CTABLESSTR,DBO.FN3S_NTHINDEX(@CTABLESSTR,',',@NCNTR)+1,LEN(@CTABLESSTR))
		END	
		ELSE
			SET @CTABLENAME=@CTABLESSTR	
		
		PRINT STR(@NCNTR)+'-'+@CTABLENAME		
		SET @CSTEP='460 - '+@CTABLENAME
		SET @CTMP_TABLENAME='TMP_'+@CXNTYPE+'_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLESUFFIX))
		
		SET @CTMPTABLEREF=@CSOURCEDB+@CTMP_TABLENAME

			--SET @CCMD=N'IF EXISTS (SELECT NAME FROM '+@CDBNAME+'SYSOBJECTS (NOLOCK) WHERE NAME=''' +@CTABLEPREFIX + '_' + @CTABLENAME + '_' + @CTABLESUFFIX+''')		
		IF OBJECT_ID(@CTMPTABLEREF,'U') IS NOT NULL
		BEGIN
			SET @CSTEP='470 - '+@CTABLENAME
			SET @CCMD=N' DROP TABLE '+@CSOURCEDB+'['+@CTMP_TABLENAME+'] '						
			PRINT ISNULL(@CCMD,'NULL COMMAND')
			EXEC SP_EXECUTESQL @CCMD
		END
				
		SET @NCNTR=@NCNTR+1
	END
END
