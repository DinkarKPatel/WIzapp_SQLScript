CREATE PROCEDURE SP3S_KPI_COLOR_SCHEME(@nMode int,@SCHEME VARCHAR(40),@PARAM VARCHAR(MAX)='')
AS
BEGIN
SET NOCOUNT ON
IF @nMode=2
   BEGIN
      SELECT SETUP_ID,COLOR_CODE,RangeFrom,RangeTo FROM DBKPI_COLOR_SCHEMA WHERE SETUP_ID=@SCHEME
      GOTO LST
   END
DECLARE @ROW VARCHAR(MAX),@FIELD VARCHAR(MAX),@ID VARCHAR(100),@COLOR VARCHAR(100),@RFROM INT,@RTO INT,@ERR VARCHAR(1000),@RET VARCHAR(MAX)
SET @ID=@SCHEME
IF OBJECT_ID('tempdb..#COLOR_SCHEMA') IS NOT NULL DROP TABLE #COLOR_SCHEMA
SELECT TOP 0 * INTO #COLOR_SCHEMA FROM DBKPI_COLOR_SCHEMA
SET @PARAM=RTRIM(LTRIM(@PARAM))
IF RIGHT(@PARAM,1)!=';' SET @PARAM+=';'
SET @RET=@PARAM
BEGIN TRY
BEGIN TRAN
WHILE CHARINDEX(';',@PARAM)>0
  BEGIN
     SET @ROW=LEFT(@PARAM,CHARINDEX(';',@PARAM))
     SET @ROW=RTRIM(LTRIM(@ROW))
	 IF RIGHT(@ROW,1)=';' SET @ROW=LEFT(@ROW,LEN(@ROW)-1)
	 
	 IF RIGHT(@ROW,1)=',' SET @ROW=LEFT(@ROW,LEN(@ROW)-1)
	 INSERT #COLOR_SCHEMA
	 SELECT @ID SETUP
			,LEFT(@ROW,CHARINDEX(',',@ROW)-1) COLOR
			,SUBSTRING(@ROW
					   ,CHARINDEX(',',@ROW)+1
					   ,CHARINDEX(',',@ROW,CHARINDEX(',',@ROW)+1)-(CHARINDEX(',',@ROW)+1)
					  )RangeFrom
			/*
			,SUBSTRING(@ROW
					   ,CHARINDEX(',',@ROW,CHARINDEX(',',@ROW)+1)+1
					   ,CHARINDEX(',',@ROW,CHARINDEX(',',@ROW,CHARINDEX(',',@ROW)+1)+1)-(CHARINDEX(',',@ROW,CHARINDEX(',',@ROW)+1)+1)
					  )RangeFrom
			*/
			,REVERSE(LEFT(REVERSE(@ROW),CHARINDEX(',',REVERSE(@ROW))-1))RangeTo
			,@RET
	 SET @PARAM=SUBSTRING(@PARAM,CHARINDEX(';',@PARAM)+1,4000)
  END   
DELETE D FROM DBKPI_COLOR_SCHEMA D JOIN #COLOR_SCHEMA S ON D.SETUP_ID=S.SETUP_ID
												  /*AND (D.COLOR_CODE=S.COLOR_CODE 
												         OR (D.RangeFrom=S.RangeFrom AND D.RangeTo=S.RangeTo))*/
INSERT DBKPI_COLOR_SCHEMA SELECT * FROM #COLOR_SCHEMA
IF OBJECT_ID('tempdb..#COLOR_SCHEMA') IS NOT NULL DROP TABLE #COLOR_SCHEMA
END TRY
BEGIN CATCH
   SET @ERR=ERROR_MESSAGE()
END CATCH
IF ISNULL(@ERR,'')=''
   COMMIT
ELSE
   ROLLBACK
LST:
SELECT ISNULL(@ERR,'')ERROR_MSG
SET NOCOUNT OFF
END