CREATE PROCEDURE SP_MONTHLY_BUDGET
(
 @NQUERYID  NUMERIC(3,0),            
 @CWHERE VARCHAR(200)='' 
)
AS
BEGIN
 IF @NQUERYID=1            
  GOTO LBLLOC_VIEW
IF @NQUERYID=10            
  GOTO LBLLOC_EDIT
 ELSE IF @NQUERYID=2            
  GOTO LBLLIST1
  ELSE IF @NQUERYID=3            
  GOTO LBLLIST2
  
  LBLLOC_VIEW:
  	--SELECT DEPT_ID,DEPT_NAME,AREA_NAME,CITY,STATE,A.BUDGET_AT_EXPENSE_HEADS ,
	--(CASE WHEN BUDGET_AT_EXPENSE_HEADS=1 THEN 'HEAD WISE' ELSE 'LOCATION LEVEL'  END) AS MODE 
	--FROM LOCATION  A
	--JOIN AREA B ON A.AREA_CODE= B.AREA_CODE
	--JOIN CITY C ON B.CITY_CODE= C.CITY_CODE
	--JOIN STATE D ON C.STATE_CODE= D.STATE_CODE
	--WHERE ALLOW_MONTHLY_BUDGET_PC=1 
	SELECT lm.ac_code,AC_NAME,LOC.dept_id,LOC.dept_name,LOC.dept_alias,AREA_NAME,CITY,STATE,BB.* 
	,LOC.BUDGET_AT_EXPENSE_HEADS ,(CASE WHEN LOC.BUDGET_AT_EXPENSE_HEADS=1 THEN 'HEAD WISE' ELSE 'LOCATION LEVEL'  END) AS MODE 
	FROM MONTHLYBUDGET_HEAD BB
	JOIN  LOCATION LOC ON BB.DEPT_ID = LOC.DEPT_ID 
	JOIN lm01106 lm (NOLOCK) on BB.AC_CODE=lm.AC_CODE
	JOIN AREA B ON LOC.AREA_CODE= B.AREA_CODE
	JOIN CITY C ON B.CITY_CODE= C.CITY_CODE
	JOIN STATE D ON C.STATE_CODE= D.STATE_CODE	
	where ALLOW_MONTHLY_BUDGET_PC=1
	AND BB.FIN_YEAR=@CWHERE
	order BY loc.dept_id,dept_name,ac_name
	 GOTO LAST  
  LBLLOC_EDIT:
	;WITH LM
	AS
	(
		select ac_code,AC_NAME 
		from PETTY_CASH_AC a (NOLOCK)
		join lm01106 b (NOLOCK) ON b.head_code=a.HEAD_CODE
	)
	SELECT lm.ac_code,AC_NAME,LOC.dept_id,LOC.dept_name,LOC.dept_alias,AREA_NAME,CITY,STATE,BB.* 
	,LOC.BUDGET_AT_EXPENSE_HEADS ,(CASE WHEN LOC.BUDGET_AT_EXPENSE_HEADS=1 THEN 'HEAD WISE' ELSE 'LOCATION WISE'  END) AS MODE 
	FROM LOCATION LOC
	JOIN AREA B ON LOC.AREA_CODE= B.AREA_CODE
	JOIN CITY C ON B.CITY_CODE= C.CITY_CODE
	JOIN STATE D ON C.STATE_CODE= D.STATE_CODE
	JOIN LM on 1=LOC.BUDGET_AT_EXPENSE_HEADS
	LEFT OUTER JOIN MONTHLYBUDGET_HEAD BB ON BB.DEPT_ID = LOC.DEPT_ID AND BB.AC_CODE=lm.AC_CODE
	where ALLOW_MONTHLY_BUDGET_PC=1 AND LOC.BUDGET_AT_EXPENSE_HEADS=1
	AND ISNULL(BB.FIN_YEAR,@CWHERE)=@CWHERE
	UNION ALL 
	SELECT lm.ac_code,AC_NAME,LOC.dept_id,LOC.dept_name,LOC.dept_alias,AREA_NAME,CITY,STATE,BB.* 
	,LOC.BUDGET_AT_EXPENSE_HEADS ,(CASE WHEN LOC.BUDGET_AT_EXPENSE_HEADS=1 THEN 'HEAD WISE' ELSE 'LOCATION WISE'  END) AS MODE 
	FROM LOCATION LOC
	JOIN AREA B ON LOC.AREA_CODE= B.AREA_CODE
	JOIN CITY C ON B.CITY_CODE= C.CITY_CODE
	JOIN STATE D ON C.STATE_CODE= D.STATE_CODE
	JOIN LM01106 LM on LM.AC_CODE='0000000000'
	LEFT OUTER JOIN MONTHLYBUDGET_HEAD BB ON BB.DEPT_ID = LOC.DEPT_ID AND BB.AC_CODE=lm.AC_CODE AND BB.FIN_YEAR=@CWHERE
	where ALLOW_MONTHLY_BUDGET_PC=1 AND LOC.BUDGET_AT_EXPENSE_HEADS<>1
	AND ISNULL(BB.FIN_YEAR,@CWHERE)=@CWHERE
	order BY loc.dept_id,dept_name,ac_name
	 GOTO LAST
   LBLLIST1: 
	 
	 SELECT LOC.DEPT_ID, LOC.DEPT_NAME,B.*,'' AS AC_CODE,'' AS AC_NAME 
     FROM LOCATION LOC 
     LEFT JOIN MONTHLYBUDGET B ON B.DEPT_ID = LOC.DEPT_ID 
     WHERE ALLOW_MONTHLY_BUDGET_PC=1 AND ISNULL(BUDGET_AT_EXPENSE_HEADS,0)=0
     AND B.FIN_YEAR = @CWHERE
     GOTO LAST  
	  
   LBLLIST2: 
	 
	SELECT LOC.DEPT_NAME,B.*,LMV.AC_NAME 
    FROM LOCATION LOC 
    JOIN MONTHLYBUDGET_HEAD B ON B.DEPT_ID = LOC.DEPT_ID 
    JOIN LMV01106 LMV ON LMV.AC_CODE = B.AC_CODE 
    WHERE ALLOW_MONTHLY_BUDGET_PC=1 AND ISNULL(BUDGET_AT_EXPENSE_HEADS,0)=1
    AND B.FIN_YEAR = @CWHERE                 
     
    GOTO LAST  
  LAST: 
  
END
