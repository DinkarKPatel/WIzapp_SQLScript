create PROC SPOLAP_DATASENDING_MEMO
(
 @CDEPTID VARCHAR(2)='',
 @NNEWMETHOD INT=0
)
AS   
BEGIN  

	
		
		DECLARE @DCUTOFFDATE DATETIME,@cdept_id varchar(4),@cHoDeptId VARCHAR(4)

		SELECT @cdept_id=value  FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
		SELECT @cHoDeptId=value FROM config (NOLOCK) WHERE config_option='ho_location_id'

		  IF @cdept_id<>@CHODEPTID
		  RETURN

		Delete From xntype_merging_errors where ABS(datediff(minute,last_update,getdate()))>60
		IF @NNEWMETHOD=0
		    GOTO LBLDATA

		SET @DCUTOFFDATE=''

		DECLARE @TBLXNDETAILS TABLE (XN_TYPE VARCHAR(30),XN_ID VARCHAR(50),TABLENAME VARCHAR(100),
		LASTUPDATE DATETIME,SEND_ORDER numeric(5,0) ,COLUMNNAME VARCHAR(50))

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'PUR' AS XN_TYPE,MRR_ID AS XN_ID,'PIM01106' AS TABLENAME,a.LAST_UPDATE ,40 AS  SEND_ORDER ,'MRR_ID' AS COLUMNNAME FROM PIM01106 a (NOLOCK)  
		WHERE RECEIPT_DT >=@DCUTOFFDATE  and isnull(OLAP_SYNCH_LAST_UPDATE,'')<>a.last_update 
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)  
		SELECT 'SNC' AS XN_TYPE,MEMO_ID AS XN_ID,'SNC_MST' AS TABLENAME,LAST_UPDATE ,45 AS  SEND_ORDER,'MEMO_ID' AS COLUMNNAME  FROM SNC_MST (NOLOCK)  
		WHERE RECEIPT_DT  >=@DCUTOFFDATE  AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'SCF'AS XN_TYPE,MEMO_ID AS XN_ID,'SCM01106' AS TABLENAME,LAST_UPDATE ,60 AS  SEND_ORDER,'MEMO_ID' AS COLUMNNAME    FROM SCM01106 (NOLOCK)  
		WHERE memo_dt  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'IRR'AS XN_TYPE,irm_memo_id AS XN_ID,'IRM01106' AS TABLENAME,LAST_UPDATE ,70 AS  SEND_ORDER,
		'irm_memo_id' AS COLUMNNAME   FROM IRM01106 (NOLOCK)  WHERE IRM_memo_dt  >=@DCUTOFFDATE 
		AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE


		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME) 
		SELECT 'APP'AS XN_TYPE,MEMO_ID AS XN_ID,'APM01106' AS TABLENAME,LAST_UPDATE ,80 AS  SEND_ORDER,'MEMO_ID' AS COLUMNNAME    FROM APM01106 (NOLOCK)  
		WHERE memo_dt  >=@DCUTOFFDATE  AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'APR'AS XN_TYPE,MEMO_ID AS XN_ID,'APPROVAL_RETURN_MST' AS TABLENAME,LAST_UPDATE ,90 AS  SEND_ORDER ,'MEMO_ID' AS COLUMNNAME FROM APPROVAL_RETURN_MST (NOLOCK)  
		WHERE memo_dt  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		


		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'RPS'AS XN_TYPE,CM_ID AS XN_ID,'RPS_MST' AS TABLENAME,LAST_UPDATE ,110 AS  SEND_ORDER ,'CM_ID' AS COLUMNNAME   FROM RPS_MST (NOLOCK)  
		WHERE CM_DT  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)  
		SELECT 'WPS'AS XN_TYPE,PS_ID AS XN_ID,'WPS_MST' AS TABLENAME,LAST_UPDATE ,112 AS  SEND_ORDER ,'PS_ID' AS COLUMNNAME   FROM WPS_MST (NOLOCK)  
		WHERE PS_DT  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'WSL'AS XN_TYPE,INV_ID AS XN_ID,'INM01106' AS TABLENAME,LAST_UPDATE ,115 AS  SEND_ORDER,'INV_ID' AS COLUMNNAME    FROM INM01106 (NOLOCK)  
		WHERE INV_DT  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		


		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'SLS'AS XN_TYPE,CM_ID AS XN_ID,'CMM01106' AS TABLENAME,LAST_UPDATE ,120 AS  SEND_ORDER ,'CM_ID' AS COLUMNNAME   
		FROM CMM01106 (NOLOCK)  WHERE CM_DT  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME) 
		SELECT 'DNPS',PS_ID  AS XN_ID,'DNPS_MST' AS TABLENAME,LAST_UPDATE ,180 AS  SEND_ORDER,'PS_ID' AS COLUMNNAME    FROM DNPS_MST (NOLOCK)  
		WHERE PS_DT  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE  
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'PRT'AS XN_TYPE,RM_ID  AS XN_ID,'RMM01106' AS TABLENAME,LAST_UPDATE ,185 AS  SEND_ORDER,'RM_ID' AS COLUMNNAME    FROM RMM01106 (NOLOCK)  
		WHERE RM_DT  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE  
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'WSR'AS XN_TYPE,CN_ID  AS XN_ID,'CNM01106' AS TABLENAME,LAST_UPDATE ,190 AS  SEND_ORDER,'CN_ID' AS COLUMNNAME    
		FROM CNM01106 (NOLOCK)  WHERE RECEIPT_DT  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE  
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'BCO'AS XN_TYPE,MEMO_ID  AS XN_ID,'FLOOR_ST_MST' AS TABLENAME,LAST_UPDATE ,195 AS  SEND_ORDER,'MEMO_ID' AS COLUMNNAME    FROM FLOOR_ST_MST (NOLOCK) 
		WHERE MEMO_DT  >=@DCUTOFFDATE AND  isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		 

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'JWI'AS XN_TYPE,ISSUE_ID   AS XN_ID,'JOBWORK_ISSUE_MST' AS TABLENAME,LAST_UPDATE ,200 AS  SEND_ORDER ,'ISSUE_ID' AS COLUMNNAME   FROM JOBWORK_ISSUE_MST (NOLOCK)  
		WHERE ISSUE_DT  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE  
		 

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'JWR'AS XN_TYPE,receipt_id   AS XN_ID,'JOBWORK_RECEIPT_MST' AS TABLENAME,LAST_UPDATE ,210 AS  SEND_ORDER,'receipt_id' AS COLUMNNAME    FROM JOBWORK_RECEIPT_MST (NOLOCK)  
		WHERE RECEIPT_DT  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		
 

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'CNC'AS XN_TYPE,cnc_memo_ID   AS XN_ID,'ICM01106' AS TABLENAME,LAST_UPDATE ,240 AS  SEND_ORDER ,'cnc_memo_ID' AS COLUMNNAME   FROM ICM01106 (NOLOCK)  
		WHERE  cnc_memo_dt  >=@DCUTOFFDATE AND isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		  

	
		--INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		--SELECT 'PFI' AS XN_TYPE,MEMO_ID  AS XN_ID,'ORD_PLAN_MST' AS TABLENAME,LAST_UPDATE ,590 AS  SEND_ORDER ,'MEMO_ID' AS COLUMNNAME    
		--FROM ORD_PLAN_MST (NOLOCK)  WHERE MEMO_DT>=@DCUTOFFDATE AND    isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'MIS' AS XN_TYPE,ISSUE_ID  AS XN_ID,'BOM_ISSUE_MST' AS TABLENAME,LAST_UPDATE ,600 AS  SEND_ORDER ,'ISSUE_ID' AS COLUMNNAME    FROM BOM_ISSUE_MST (NOLOCK)  
		WHERE ISSUE_DT>=@DCUTOFFDATE AND   isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE 
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'TTM' AS XN_TYPE,MEMO_ID   AS XN_ID,'TRANSFER_TO_TRADING_MST' AS TABLENAME,LAST_UPDATE ,610 AS  SEND_ORDER,'MEMO_ID' AS COLUMNNAME     FROM TRANSFER_TO_TRADING_MST (NOLOCK) 
		WHERE MEMO_DT >=@DCUTOFFDATE AND   isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE  
		

		INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'GRNPS'AS XN_TYPE,MEMO_ID   AS XN_ID,'GRN_PS_MST' AS TABLENAME,LAST_UPDATE ,
		640 AS  SEND_ORDER ,'MEMO_ID' AS COLUMNNAME    FROM GRN_PS_MST (NOLOCK)  
		WHERE MEMO_DT >=@DCUTOFFDATE AND    isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE  
		

		
	    INSERT INTO @TBLXNDETAILS(XN_TYPE,XN_ID,TABLENAME,LASTUPDATE,SEND_ORDER,COLUMNNAME)
		SELECT 'REP'AS XN_TYPE,rep_id   AS XN_ID,'rep_mst' AS TABLENAME,LAST_UPDATE ,
		660 AS  SEND_ORDER ,'REP_ID' AS COLUMNNAME 		from rep_mst  where  rep_code in (        select rep_code from reporttype where rep_code  not like '%MSC%')
		and isnull(OLAP_SYNCH_LAST_UPDATE,'')<>LAST_UPDATE  

	
	lbldata:

		SELECT A.XN_TYPE,XN_ID,TABLENAME,convert(varchar,LASTUPDATE,121) as lastupdate,SEND_ORDER,COLUMNNAME 
		FROM @TBLXNDETAILS A
		WHERE  DATEDIFF (SS,LASTUPDATE,GETDATE())>15
		ORDER BY SEND_ORDER,a.LASTUPDATE

END  



