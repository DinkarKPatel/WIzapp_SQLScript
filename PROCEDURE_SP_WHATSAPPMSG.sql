CREATE PROCEDURE SP_WHATSAPPMSG--(LocId 3 digit change by Sanjay:30-10-2024)
(      
@CREPCODE VARCHAR(10),  
@CDT VARCHAR(200)='',  
@CWHERE VARCHAR(200)=''  
)  

AS   
BEGIN  
  
IF @CREPCODE='MSC02'    
GOTO MSC02  
ELSE IF @CREPCODE='MSC03'    
GOTO MSC03  
ELSE IF @CREPCODE='MSC08'    
GOTO MSC08  
ELSE IF @CREPCODE='MSC55'      
GOTO MSC55 
ELSE IF @CREPCODE='MSC99'      
GOTO MSC99 
ELSE IF @CREPCODE='MSC35'      
GOTO MSC35   
ELSE 
GOTO LAST


MSC55:   

	
IF OBJECT_ID('TEMPDB..#TEMPCM','U') IS NOT NULL    
DROP TABLE #TEMPCM   


DECLARE @IMIN INT,@dServerDt DATETIME      

SELECT @dServerDt=VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SERVER_DT'

		
SELECT 'SALE' AS XN_TYPE, A.CM_ID AS UNQ_ID, A.CUSTOMER_CODE , B.USER_CUSTOMER_CODE,      
( B.CUSTOMER_FNAME + ''+ B.CUSTOMER_LNAME) AS NAME,  
(CASE WHEN B.MOBILE='' THEN '91'+ B.USER_CUSTOMER_CODE ELSE '91'+B.MOBILE END) AS  MOBILE, B.EMAIL ,      
GETDATE() AS SENT_ON,ar.AREA_NAME AS AREA_NAME,ct.CITY AS CITY_NAME,st.STATE AS STATE_NAME,  
A.CM_NO,A.CM_DT ,a.location_Code AS LOC_ID,A.NET_AMOUNT AS AMOUNT,A.DISCOUNT_AMOUNT  AS DISCOUNT, 
ISNULL(X.CASH_RCVD,0.00) AS CASH_RCVD,
ISNULL(X.CN_ADJUSTED,0.00) AS CN_ADJUSTED,
ISNULL(X.ADVANCE_ADJUSTED,0.00) AS ADVANCE_ADJUSTED,
'' AS BANK_CHQ,
ISNULL(X.CREDIT_ISSUED,0.00) AS CREDIT_ISSUED,
ISNULL(X.CC_AMOUNT,0.00) AS CC_AMOUNT,
ISNULL(Y.ORDER_REF_NO,'') AS ORDER_REF_NO ,ISNULL(Y.ORDER_NO,'') AS ORDER_NO,
A.EBILLS_TINYURL ,A.CM_NO AS XN_NO
INTO #TEMPCM
FROM CMM01106 A   (NOLOCK)   
JOIN custdym B (NOLOCK) ON A.CUSTOMER_CODE = B.CUSTOMER_CODE  
JOIN AREA ar (NOLOCK) ON Ar.AREA_CODE = B.AREA_CODE   
JOIN CITY Ct (NOLOCK) ON ct.CITY_CODE = ar.CITY_CODE   
JOIN STATE st (NOLOCK) ON st.STATE_CODE = ct.STATE_CODE 
LEFT OUTER JOIN 
(
SELECT memo_id cm_id,sum(case when a.paymode_code='0000001' THEN amount ELSE 0 END) CN_ADJUSTED,
sum(case when a.paymode_code='0000004' THEN amount ELSE 0 END) CREDIT_ISSUED,
sum(case when a.paymode_code='0000002' THEN amount ELSE 0 END) ADVANCE_ADJUSTED,
sum(case when paymode_grp_code='0000001' THEN amount ELSE 0 END) CASH_RCVD,
sum(case when paymode_grp_code='0000002' THEN amount ELSE 0 END) CC_AMOUNT
FROM paymode_xn_det a (NOLOCK)
JOIN cmm01106 b (NOLOCK) ON a.memo_id=b.cm_id
JOIN paymode_mst c (NOLOCK) ON c.paymode_code=a.paymode_code
WHERE cm_id=@CWHERE AND xn_type='SLS'
group by memo_id
)  X  ON A.CM_ID= X.cm_id

LEFT OUTER JOIN 
(
SELECT TOP 1  D.CM_ID,B.CUSTOMER_CODE, B.REF_NO AS ORDER_REF_NO ,B.ORDER_NO 
FROM  WSL_ORDER_MST B (NOLOCK)  
JOIN CMD01106 C (NOLOCK) ON B.ORDER_ID = C.REF_ORDER_ID 
JOIN CMM01106 D (NOLOCK) ON C.CM_ID = D.CM_ID 
WHERE D.CANCELLED=0 AND isnull(D.whatsapp_sent,0) =0	AND B.CANCELLED=0 
) Y  ON  A.CM_ID= Y.CM_ID	  
 
WHERE A.CUSTOMER_CODE <> '000000000000'  AND  A.Cm_id  =@CWHERE
AND isnull(A.whatsapp_sent,0) = 0  AND (B.MOBILE<>''  OR B.USER_CUSTOMER_CODE <> '')    

SELECT  XN_TYPE, UNQ_ID,CUSTOMER_CODE, USER_CUSTOMER_CODE, NAME,
MOBILE, EMAIL,SENT_ON, AREA_NAME, CITY_NAME, STATE_NAME, CM_NO, CM_DT, LOC_ID, AMOUNT, DISCOUNT,
CASH_RCVD, CN_ADJUSTED, CREDIT_ISSUED, CC_AMOUNT, ADVANCE_ADJUSTED, BANK_CHQ, ORDER_REF_NO,ORDER_NO,EBILLS_TINYURL,CM_NO AS XN_NO
FROM #TEMPCM    
UNION ALL    
SELECT  XN_TYPE, UNQ_ID,'' AS CUSTOMER_CODE, '' AS USER_CUSTOMER_CODE ,B.CONTACT_NAME AS NAME
,B.MOBILE,B.EMAIL,SENT_ON, '' AS AREA_NAME, '' AS CITY_NAME,'' AS STATE_NAME,CM_NO, CM_DT, 
LOC_ID, AMOUNT, DISCOUNT,
CASH_RCVD, CN_ADJUSTED, CREDIT_ISSUED, CC_AMOUNT, ADVANCE_ADJUSTED, BANK_CHQ, ORDER_REF_NO,ORDER_NO,EBILLS_TINYURL,CM_NO AS XN_NO
FROM #TEMPCM A,RECEIPIANT_MST B WHERE B.REP_ID= 'MSCFIX0055'  
  

GOTO LAST  

MSC02:                   
	
	
	       
SELECT 'PRT' AS XN_TYPE, A.RM_ID AS UNQ_ID,   
A.RM_NO, A.RM_DT AS RM_DATE, A.RM_ID, A.TOTAL_AMOUNT AS RM_AMOUNT,   
C.QUANTITY,   A.EBILLS_TINYURL,A.rm_no  AS XN_NO,
B.AC_NAME AS NAME, B.E_MAIL AS EMAIL, B.MOBILE,B.WhatsApp_no ,
B.AREA_NAME ,B.CITY AS CITY_NAME ,B.STATE AS STATE_NAME  ,
PM.BILTY_NO  AS LR_NO, PM.RECEIPT_DT AS LR_DATE, L.ANGADIA_NAME AS TRANSPORTER  ,B.AC_NAME 
FROM RMM01106 A (NOLOCK)    
JOIN LMV01106 B (NOLOCK)  ON A.AC_CODE = B.AC_CODE   
JOIN PARCEL_DET PB (NOLOCK) ON A.RM_ID = PB.REF_MEMO_ID
JOIN  PARCEL_MST PM (NOLOCK) ON PB.PARCEL_MEMO_ID = PM.PARCEL_MEMO_ID   AND PM.XN_TYPE= 'PRT'  
JOIN ANGM L ON PM.ANGADIA_CODE = L.ANGADIA_CODE 
JOIN   
(   
SELECT RM_ID, SUM(QUANTITY) AS QUANTITY FROM RMD01106 (NOLOCK)  GROUP BY RM_ID   
) C ON A.RM_ID = C.RM_ID   

LEFT OUTER JOIN
( 		
SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SERVER_DT'
) D ON 1=1
		
WHERE ISNULL(A.whatsapp_sent , 0) = 0 AND  A.RM_DT >= ISNULL(D.VALUE,GETDATE())
AND  (B.MOBILE <>''  or B.WhatsApp_no  <> '')
	
GOTO LAST  



 
   
MSC08:         

IF OBJECT_ID('TEMPDB..#TEMP','U') IS NOT NULL  
DROP TABLE #TEMP                                 


SELECT 'WSL' AS XN_TYPE, A.INV_ID AS UNQ_ID,    
A.INV_NO, A.INV_DT, A.NET_AMOUNT AS INV_AMOUNT,   
C.QUANTITY,   
PM.BILTY_NO  AS LR_NO, PM.RECEIPT_DT AS LR_DATE, A.THROUGH AS TRANSPORTER, 
B.AC_NAME AS NAME, B.E_MAIL AS EMAIL, B.MOBILE,B.whatsApp_no,
B.AREA_NAME ,B.CITY AS CITY_NAME ,B.STATE AS STATE_NAME ,A.EBILLS_TINYURL,A.inv_no  AS XN_NO
INTO #TEMP
FROM INM01106 A   (NOLOCK)  
JOIN LOCATION L ON a.location_Code= L.Dept_id
JOIN LMV01106 B  (NOLOCK) ON A.AC_CODE = B.AC_CODE 
JOIN PARCEL_DET PB (NOLOCK) ON A.INV_ID = PB.REF_MEMO_ID
JOIN  PARCEL_MST PM (NOLOCK) ON PB.PARCEL_MEMO_ID = PM.PARCEL_MEMO_ID   AND PM.XN_TYPE= 'WSL'   
JOIN    
(   
SELECT INV_ID, SUM(QUANTITY) AS QUANTITY FROM IND01106  (NOLOCK) GROUP BY INV_ID   
) C ON A.INV_ID = C.INV_ID   
LEFT OUTER JOIN
( 
SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SERVER_DT'
) D ON 1=1

WHERE  ISNULL(A.whatsapp_sent,0) = 0   AND  A.INV_DT >= ISNULL(D.VALUE,GETDATE())
and (ISNULL(A.ACH_NO,'') <> '' or L.Enable_EInvoice =0) AND  (B.MOBILE <>''  or B.WhatsApp_no  <> '')


SELECT  XN_TYPE,UNQ_ID, INV_NO,  INV_DT, INV_AMOUNT,QUANTITY,   
LR_NO, LR_DATE, TRANSPORTER, NAME,  EMAIL, MOBILE,
AREA_NAME, CITY_NAME,STATE_NAME ,EBILLS_TINYURL,inv_no  AS XN_NO,whatsApp_no  
FROM #TEMP  
UNION ALL  
SELECT XN_TYPE,UNQ_ID, INV_NO,  INV_DT, INV_AMOUNT,QUANTITY,   
LR_NO, LR_DATE, TRANSPORTER, B.CONTACT_NAME AS NAME,  B.EMAIL, B.MOBILE,
'' AS AREA_NAME,'' AS  CITY_NAME,'' AS STATE_NAME ,EBILLS_TINYURL,inv_no  AS XN_NO  ,whatsApp_no
FROM #TEMP A,RECEIPIANT_MST B WHERE B.REP_ID= 'MSCFIX0008'   


GOTO LAST 

MSC99: 

SELECT 'WSL' AS XN_TYPE, A.INV_ID AS UNQ_ID,    
A.INV_NO, A.INV_DT, A.NET_AMOUNT AS INV_AMOUNT,   
C.QUANTITY,   
PM.BILTY_NO  AS LR_NO, PM.RECEIPT_DT AS LR_DATE, A.THROUGH AS TRANSPORTER, 
B.AC_NAME AS NAME, B.E_MAIL AS EMAIL, B.MOBILE,B.whatsApp_no,
B.AREA_NAME ,B.CITY AS CITY_NAME ,B.STATE AS STATE_NAME ,A.EBILLS_TINYURL,A.inv_no  AS XN_NO	
FROM INM01106 A   (NOLOCK)  
JOIN LOCATION L ON a.location_Code= L.Dept_id
JOIN LMV01106 B  (NOLOCK) ON A.AC_CODE = B.AC_CODE 
LEFT OUTER JOIN PARCEL_DET PB (NOLOCK) ON A.INV_ID = PB.REF_MEMO_ID
LEFT OUTER JOIN  PARCEL_MST PM (NOLOCK) ON PB.PARCEL_MEMO_ID = PM.PARCEL_MEMO_ID   AND PM.XN_TYPE= 'WSL'   
JOIN    
(   
SELECT INV_ID, SUM(QUANTITY) AS QUANTITY FROM IND01106  (NOLOCK) GROUP BY INV_ID   
) C ON A.INV_ID = C.INV_ID   
Where A.INV_ID=@cWhere  AND  (B.MOBILE <>''  or B.WhatsApp_no  <> '')
	
GOTO LAST 

MSC03: 
select vm_id into #tmpVm from vm01106  c (NOLOCK)
LEFT OUTER JOIN ANGM ANGM (NOLOCK)  ON C.ANGADIA_CODE = ANGM.ANGADIA_CODE 
WHERE C.VOUCHER_CODE = '0000000002'  AND ANGM.ANGADIA_CODE <> '0000000' AND 
C.CANCELLED = 0  AND ISNULL(C.whatsapp_sent,0)=0 
and c.VOUCHER_DT > ='2021-06-01'

SELECT DISTINCT 'ACT' AS XN_TYPE, VM.VM_ID AS UNQ_ID, X.NARRATION, X.CHQ_NO, X.CHQ_DT, X.CHQ_AMOUNT, X.BANK_NAME,   
VM.LR_NO AS LR_NO, VM.LR_DT AS LR_DATE, ISNULL(ANGM.ANGADIA_NAME,'') AS TRANSPORTER,   
LM.AC_NAME AS AC_NAME, ISNULL(LM.E_MAIL,'') AS EMAIL, ISNULL(LM.MOBILE,'') AS MOBILE,
LM.AREA_NAME ,LM.CITY AS CITY_NAME ,LM.STATE AS STATE_NAME ,LM.AC_NAME AS NAME ,
VM.EBILLS_TINYURL ,LM.WhatsApp_no ,VM.VOUCHER_NO AS XN_NO
FROM   
VM01106 VM (NOLOCK)  
left join
(   
SELECT A.VM_ID, A.NARRATION,  DBO.FN_ACT_GETREVERSEVD(A.VD_ID) AS REVERSE_VD_ID,
B.CHQ_LEAF_NO AS CHQ_NO, C.VOUCHER_DT AS CHQ_DT, E.AC_NAME AS BANK_NAME,    
(A.DEBIT_AMOUNT + A.CREDIT_AMOUNT) AS CHQ_AMOUNT   
FROM VD01106 A (NOLOCK)    
JOIN VD_CHQBOOK D (NOLOCK) ON D.VD_ID=a.vd_id
JOIN CHQBOOK_D B (NOLOCK)  ON D.CHQBOOK_ROW_ID = B.ROW_ID   
join VM01106 C (NOLOCK)  ON A.VM_ID = C.VM_ID   
JOIN LM01106 E (NOLOCK)  ON B.BANK_AC_CODE = E.AC_CODE 
JOIN #tmpVm vm (NOLOCK) ON vm.vm_id=c.vm_id
where isnull(B.chq_leaf_no,'')   <> ''
) X   ON X.VM_ID = VM.VM_ID   
JOIN VD01106 VD (NOLOCK)  ON VM.VM_ID = VD.VM_ID 
JOIN LMV01106 LM (NOLOCK)  ON VD.AC_CODE = LM.AC_CODE   
JOIN ANGM ANGM (NOLOCK)  ON VM.ANGADIA_CODE = ANGM.ANGADIA_CODE   
	
JOIN #tmpVm tmpvm (NOLOCK) ON tmpvm.vm_id=vm.vm_id
WHERE  (LM.MOBILE <>''  or LM.WhatsApp_no  <> '') and vd.debit_amount<>0

GOTO LAST  

MSC35: 

SELECT 'WSR' AS XN_TYPE, A.AC_CODE, A.AC_NAME,A.AC_NAME AS NAME, A.ADDRESS0, A.ADDRESS1, 
A.ADDRESS2, A.AREA_NAME, CN_ID AS UNQ_ID,
A.PINCODE, A.CITY AS CITY_NAME, B.CN_DT,	STATE AS STATE_NAME, A.PAN_NO,  A.PHONES_R, 
A.PHONES_O, A.PHONES_FAX,A.E_MAIL AS EMAIL,B.TOTAL_QUANTITY AS QUANTITY ,b.TOTAL_AMOUNT ,
A.MOBILE ,A.WhatsApp_no ,B.CN_NO  
FROM CNM01106 B (NOLOCK)  
LEFT OUTER JOIN LMV01106  A (NOLOCK) ON A.ac_code  = B.AC_CODE 	
LEFT OUTER JOIN
( 
SELECT VALUE  FROM CONFIG WHERE CONFIG_OPTION ='SERVER_DT'
) D ON 1=1
	
WHERE  ISNULL(B.SMS_SENT,0) = 0   AND  B.CN_DT = D.VALUE
AND   (a.MOBILE <>''  or a.WhatsApp_no  <> '') 
and ISNULL(B.whatsapp_sent,0)=0 
	
GOTO LAST 
 
  
LAST:  
   
     
END  
