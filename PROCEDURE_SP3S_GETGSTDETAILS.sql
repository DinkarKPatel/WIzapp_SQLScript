create PROCEDURE SP3S_GETGSTDETAILS
(
	@cTable		NVARCHAR(MAX)='',
	@cColumn	NVARCHAR(MAX)='',
	@cId		NVARCHAR(MAX)=''
)
AS
BEGIN

DECLARE @cCMD NVARCHAR(MAX),@CCMDFORX NVARCHAR(MAX)

DECLARE @cMasterCol NVARCHAR(MAX)= '',  @cMasterColdt NVARCHAR(MAX)= '',   @cMasterTable NVARCHAR(MAX)= '',@bPatchup_run BIT=0

DECLARE @DTGSTDETAILS TABLE (GST_MODE NVARCHAR(100),[HSN CODE] NVARCHAR(100),[GST %] NUMERIC(14,3),[TAXABLE VALUE] NUMERIC(14,2)
							,[IGST AMT] NUMERIC(14,2),[CGST AMT] NUMERIC(14,2),[SGST AMT] NUMERIC(14,2),[STATE CESS AMT]  NUMERIC(14,2),
							[GST CESS %] NUMERIC(14,3),[GST CESS AMT]  NUMERIC(14,2))


SET @CCMDFORX=''
if @cTable='CMD01106'
BEGIN
	SELECT @bPatchup_run=ISNULL(patchup_run,0) FROM CMM01106 WHERE CM_ID=@cId
END

if @cTable='pid01106'
begin
     
	 if exists (select Top 1 'u' from pid01106 (nolock) where mrr_id=@cId and Forex_xn_value_without_gst<>0)
	 begin

	     
		SET @CCMDFORX=N'SELECT ''Inventory_Forex'' AS GST_MODE, Forex_GST_PERCENTAGE AS [GST %],
					SUM(Forex_xn_value_without_gst) AS [TAXABLE VALUE],
					SUM(Forex_IGST_AMOUNT) AS [IGST AMT],
					cast(0 as numeric(14,2)) AS [CGST AMT], 
					cast(0 as numeric(14,2)) AS [SGST AMT] ,
					cast(0 as numeric(14,2)) AS [GST Cess %],
					cast(0 as numeric(14,2)) AS [GST CESS AMOUNT] ,
					cast(0 as numeric(14,2)) AS [STATE CESS AMT] 
					FROM ' + @cTable + ' (NOLOCK) 
					WHERE  ' + @cColumn + '= ''' + @cId + '''
					GROUP BY Forex_GST_PERCENTAGE 
					union all '+char(13)


	 end

end

SET @cCMD=@CCMDFORX+N'SELECT ''Inventory'' AS GST_MODE, GST_PERCENTAGE AS [GST %],
            SUM(xn_value_without_gst) AS [TAXABLE VALUE],
            SUM(IGST_AMOUNT) AS [IGST AMT],
            SUM(CGST_AMOUNT) AS [CGST AMT], 
            SUM(SGST_AMOUNT) AS [SGST AMT] ,
            GST_Cess_PERCENTAGE AS [GST Cess %],
			SUM(GST_CESS_AMOUNT) AS [GST CESS AMOUNT] 
            ,'+(CASE WHEN @cTable IN ('PBD01106','POD01106','PURCHASE_QUOTATION_detail') THEN 'CAST(0 AS NUMERIC(14,2))' ELSE 'SUM(CESS_AMOUNT)' END)+' AS [STATE CESS AMT] 
            FROM ' + @cTable + ' (NOLOCK) 
            WHERE  ' + @cColumn + '= ''' + @cId + '''
            GROUP BY GST_PERCENTAGE ,GST_Cess_PERCENTAGE
            ORDER BY 1, 2'


if ISNULL(@bpatchup_run,0)=1
BEGIN

	
SET @cCMD=N'SELECT ''Inventory'' AS GST_MODE, GST_PERCENTAGE AS [GST %],
            SUM(old_xn_value_without_gst) AS [TAXABLE VALUE],
            SUM(old_IGST_AMOUNT) AS [IGST AMT],
            SUM(old_CGST_AMOUNT) AS [CGST AMT], 
            SUM(old_SGST_AMOUNT) AS [SGST AMT] ,
            GST_Cess_PERCENTAGE AS [GST Cess %],
			SUM(GST_CESS_AMOUNT) AS [GST CESS AMOUNT] 
            ,'+(CASE WHEN @cTable IN ('PBD01106','POD01106','PURCHASE_QUOTATION_detail') THEN 'CAST(0 AS NUMERIC(14,2))' ELSE 'SUM(CESS_AMOUNT)' END)+' AS [STATE CESS AMT] 
            FROM ' + @cTable + ' (NOLOCK) 
            WHERE  ' + @cColumn + '= ''' + @cId + '''
            GROUP BY GST_PERCENTAGE ,GST_Cess_PERCENTAGE
            ORDER BY GST_PERCENTAGE'
END
PRINT @cCMD
IF ISNULL(@cCMD,'')<>''
BEGIN
	INSERT INTO @DTGSTDETAILS(GST_MODE ,[GST %] ,[TAXABLE VALUE] ,[IGST AMT] ,[CGST AMT] ,[SGST AMT] ,[GST CESS %],[GST CESS AMT],[STATE CESS AMT])
	EXEC SP_EXECUTESQL @cCMD
END
SET @cCMD=''

IF (@cTable = 'IND01106')
BEGIN
    SET @cCMD =N'SELECT * FROM  
            ( 
            SELECT ''FREIGHT'' AS [OH NAME], FREIGHT_HSN_CODE AS [HSN CODE],
            FREIGHT_GST_PERCENTAGE  AS [GST %],FREIGHT_IGST_AMOUNT  AS [IGST AMT],FREIGHT_CGST_AMOUNT AS [CGST AMT], 
            FREIGHT_SGST_AMOUNT AS [SGST AMT] ,FREIGHT_TAXABLE_VALUE  AS [TAXABLE VALUE]
            FROM INM01106 WHERE ' + @cColumn + '= ''' + @cId + '''
            UNION ALL 
            SELECT ''PACKING'' AS [OH NAME], PACKING_HSN_CODE AS [HSN CODE], 
            PACKING_GST_PERCENTAGE  AS [GST %],PACKING_IGST_AMOUNT  AS [IGST AMT],PACKING_CGST_AMOUNT AS [CGST AMT], 
            PACKING_SGST_AMOUNT AS [SGST AMT], PACKING_TAXABLE_VALUE  AS [TAXABLE VALUE]
            FROM INM01106 WHERE ' + @cColumn + '= ''' + @cId + '''
            UNION ALL 
            SELECT ''INSURANCE'' AS [OH NAME], INSURANCE_HSN_CODE AS [HSN CODE], 
            INSURANCE_GST_PERCENTAGE  AS [GST %],INSURANCE_IGST_AMOUNT  AS [IGST AMT],INSURANCE_CGST_AMOUNT AS [CGST AMT], 
            INSURANCE_SGST_AMOUNT AS [SGST AMT]  ,INSURANCE_TAXABLE_VALUE AS [TAXABLE VALUE]
			FROM INM01106 WHERE ' + @cColumn + '= ''' + @cId + '''
            UNION ALL  
			SELECT ''OTHER CHARGES'' AS [OH NAME], OTHER_CHARGES_HSN_CODE AS [HSN CODE], 
			OTHER_CHARGES_GST_PERCENTAGE  AS [GST %],OTHER_CHARGES_IGST_AMOUNT  AS [IGST AMT],OTHER_CHARGES_CGST_AMOUNT AS [CGST AMT], 
			OTHER_CHARGES_SGST_AMOUNT AS [SGST AMT] ,OTHER_CHARGES_TAXABLE_VALUE AS [TAXABLE VALUE]
            FROM INM01106 WHERE ' + @cColumn + '= ''' + @cId + ''' ) A  Where [GST %] >0 '

  SELECT @cMasterCol = 'INV_NO',@cMasterColdt = 'INV_DT',@cMasterTable = 'INM01106';


END

else if (@cTable = 'CND01106')
BEGIN


    SET @cCMD =N'SELECT * FROM  
            ( 
             SELECT ''FREIGHT'' AS [OH NAME], FREIGHT_HSN_CODE AS [HSN CODE],
            FREIGHT_GST_PERCENTAGE  AS [GST %],FREIGHT_IGST_AMOUNT  AS [IGST AMT],FREIGHT_CGST_AMOUNT AS [CGST AMT], 
            FREIGHT_SGST_AMOUNT AS [SGST AMT] ,FREIGHT_TAXABLE_VALUE  AS [TAXABLE VALUE]
            FROM CNM01106 WHERE ' + @cColumn + '= ''' + @cId + '''
            UNION ALL 
			SELECT ''INSURANCE'' AS [OH NAME], INSURANCE_HSN_CODE AS [HSN CODE], ' +
            'INSURANCE_GST_PERCENTAGE  AS [GST %],INSURANCE_IGST_AMOUNT  AS [IGST AMT],INSURANCE_CGST_AMOUNT AS [CGST AMT], ' +
            'INSURANCE_SGST_AMOUNT AS [SGST AMT] , INSURANCE_TAXABLE_VALUE  AS [TAXABLE VALUE] ' +
            'FROM CNM01106 WHERE ' + @cColumn + '= ''' + @cId + '''
            UNION ALL  ' +
            'SELECT ''OTHER CHARGES'' AS [OH NAME], OTHER_CHARGES_HSN_CODE AS [HSN CODE], ' +
            'OTHER_CHARGES_GST_PERCENTAGE  AS [GST %],OTHER_CHARGES_IGST_AMOUNT  AS [IGST AMT],OTHER_CHARGES_CGST_AMOUNT AS [CGST AMT], ' +
            'OTHER_CHARGES_SGST_AMOUNT AS [SGST AMT] ,OTHER_CHARGES_TAXABLE_VALUE  AS [TAXABLE VALUE] ' +
            'FROM CNM01106 WHERE ' + @cColumn + '= ''' + @cId + ''' ) A  Where [GST %] >0 '



    SELECT @cMasterCol = 'CN_NO',@cMasterColdt = 'CN_DT',@cMasterTable = 'CNM01106'


END

else if (@cTable = 'CMD01106')
BEGIN
    SET @cCMD =N'SELECT ''OTHER CHARGES'' AS [OH NAME], OTHER_CHARGES_HSN_CODE AS [HSN CODE], ' +
            'OTHER_CHARGES_GST_PERCENTAGE  AS [GST %],OTHER_CHARGES_IGST_AMOUNT  AS [IGST AMT],OTHER_CHARGES_CGST_AMOUNT AS [CGST AMT], ' +
            'OTHER_CHARGES_SGST_AMOUNT AS [SGST AMT] ,OTHER_CHARGES_TAXABLE_VALUE  AS [TAXABLE VALUE] ' +
            'FROM CMM01106 WHERE ' + @cColumn + '= ''' + @cId + ''' AND OTHER_CHARGES_GST_PERCENTAGE >0'
	SELECT @cMasterCol = 'CM_NO',@cMasterColdt = 'CM_DT',@cMasterTable = 'CMM01106'

END
else if (@cTable = 'PID01106')
BEGIN
    SET @cCMD =N'SELECT ''FREIGHT'' AS [OH NAME], FREIGHT_HSN_CODE AS [HSN CODE],
            FREIGHT_GST_PERCENTAGE  AS [GST %],FREIGHT_IGST_AMOUNT  AS [IGST AMT],FREIGHT_CGST_AMOUNT AS [CGST AMT], 
            FREIGHT_SGST_AMOUNT AS [SGST AMT] ,FREIGHT_TAXABLE_VALUE  AS [TAXABLE VALUE]
            FROM PIM01106 WHERE ' + @cColumn + '= ''' + @cId + ''' AND FREIGHT_GST_PERCENTAGE >0 
            UNION ALL ' +
            'SELECT ''OTHER CHARGES'' AS [OH NAME], OTHER_CHARGES_HSN_CODE AS [HSN CODE], ' +
            'OTHER_CHARGES_GST_PERCENTAGE  AS [GST %],OTHER_CHARGES_IGST_AMOUNT  AS [IGST AMT],OTHER_CHARGES_CGST_AMOUNT AS [CGST AMT], ' +
            'OTHER_CHARGES_SGST_AMOUNT AS [SGST AMT],OTHER_CHARGES_TAXABLE_VALUE  AS [TAXABLE VALUE] ' +
            'FROM PIM01106 WHERE ' + @cColumn + '= ''' + @cId + ''' AND OTHER_CHARGES_GST_PERCENTAGE >0'

SELECT @cMasterCol = 'MRR_NO',@cMasterColdt = 'MRR_DT',@cMasterTable = 'PIM01106'

END


else if (@cTable = 'PBD01106')
BEGIN
    SET @cCMD =N'SELECT ''FREIGHT'' AS [OH NAME], FREIGHT_HSN_CODE AS [HSN CODE],
            FREIGHT_GST_PERCENTAGE  AS [GST %],FREIGHT_IGST_AMOUNT  AS [IGST AMT],FREIGHT_CGST_AMOUNT AS [CGST AMT], 
            FREIGHT_SGST_AMOUNT AS [SGST AMT], FREIGHT_TAXABLE_VALUE  AS [TAXABLE VALUE] 
            FROM PBM01106 WHERE ' + @cColumn + '= ''' + @cId + ''' AND FREIGHT_GST_PERCENTAGE >0 
            UNION ALL ' +
            'SELECT ''OTHER CHARGES'' AS [OH NAME], OTHER_CHARGES_HSN_CODE AS [HSN CODE], ' +
            'OTHER_CHARGES_GST_PERCENTAGE  AS [GST %],OTHER_CHARGES_IGST_AMOUNT  AS [IGST AMT],OTHER_CHARGES_CGST_AMOUNT AS [CGST AMT], ' +
            'OTHER_CHARGES_SGST_AMOUNT AS [SGST AMT] ,OTHER_CHARGES_TAXABLE_VALUE  AS [TAXABLE VALUE] ' +
            'FROM PBM01106 WHERE ' + @cColumn + '= ''' + @cId + ''' AND OTHER_CHARGES_GST_PERCENTAGE >0'
	SELECT @cMasterCol = 'BILL_NO',@cMasterColdt = 'BILL_DT',@cMasterTable = 'PBM01106'

END


else if (@cTable = 'RMD01106')
BEGIN
    SET @cCMD =N'SELECT ''FREIGHT'' AS [OH NAME], FREIGHT_HSN_CODE AS [HSN CODE],
            FREIGHT_GST_PERCENTAGE  AS [GST %],FREIGHT_IGST_AMOUNT  AS [IGST AMT],FREIGHT_CGST_AMOUNT AS [CGST AMT], 
            FREIGHT_SGST_AMOUNT AS [SGST AMT] , FREIGHT_TAXABLE_VALUE  AS [TAXABLE VALUE] 
            FROM RMM01106 WHERE ' + @cColumn + '= ''' + @cId + ''' AND  FREIGHT_GST_PERCENTAGE >0 
            UNION ALL ' +
            'SELECT ''OTHER CHARGES'' AS [OH NAME], OTHER_CHARGES_HSN_CODE AS [HSN CODE], ' +
            'OTHER_CHARGES_GST_PERCENTAGE  AS [GST %],OTHER_CHARGES_IGST_AMOUNT  AS [IGST AMT],OTHER_CHARGES_CGST_AMOUNT AS [CGST AMT], ' +
            'OTHER_CHARGES_SGST_AMOUNT AS [SGST AMT],OTHER_CHARGES_TAXABLE_VALUE  AS [TAXABLE VALUE]  ' +
            'FROM RMM01106 WHERE ' + @cColumn + '= ''' + @cId + ''' AND OTHER_CHARGES_GST_PERCENTAGE >0 '
	SELECT     @cMasterCol = 'RM_NO',    @cMasterColdt = 'RM_DT',    @cMasterTable = 'RMM01106'

END
PRINT @cCMD
IF ISNULL(@cCMD,'')<>''
BEGIN
	INSERT INTO @DTGSTDETAILS(GST_MODE,[HSN CODE] ,[GST %] ,[IGST AMT] ,[CGST AMT] ,[SGST AMT],[TAXABLE VALUE])
	EXEC SP_EXECUTESQL @ccmd
END

SELECT * FROM @DTGSTDETAILS
END