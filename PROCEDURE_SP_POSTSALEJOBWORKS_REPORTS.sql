CREATE PROCEDURE SP_POSTSALEJOBWORKS_REPORTS
(
   @CFM_MEMO_DT DATETIME='',
   @CTO_MEMO_DT DATETIME='',
   @NHOLD BIT=0,
   @NISSUE BIT=0,
   @NRECEIVED  BIT =0,
   @NDELIVERED BIT=0,
   @NUNDELIVERED BIT=0,
   @NCANCELLED BIT=0 ,
   @CAGENCY_CODE VARCHAR(100)='',
   @CCUST_CODE VARCHAR(100)='',
   @CPRODUCT_CODE VARCHAR(100)=''
)
AS
BEGIN
      
     IF @NHOLD=1
     BEGIN
      SELECT     CMM.CM_NO
                ,CONVERT (VARCHAR,CMM.CM_DT ,105) AS CM_DT
				,ISNULL(C.CUSTOMER_FNAME,'') + '' +ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
				,ART.ARTICLE_NO
				,ART.ARTICLE_NAME
				,HLDS.JOB_NAME
				,1.00 AS QUANTITY
				,HLDS.MEMO_NO
				,CONVERT(VARCHAR,HLDS.MEMO_DT,105) AS MEMO_DT
				,CONVERT( VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT
				,SKU.PRODUCT_CODE
				,P1.PARA1_NAME
				,P2.PARA2_NAME
				,STATUS='HOLD' 
        FROM CMM01106 CMM (NOLOCK)
        JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID =CMD.CM_ID 
        JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
        JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE
        JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
        JOIN
       (  
		SELECT M.MEMO_ID,M.MEMO_NO,M.MEMO_DT,ROW_ID,
		DELIVERY_POINT,DELIVERY_DEPT_ID,REF_CMD_ROW_ID ,JOB_NAME,DELIVERY_DT  
		FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		JOIN JOBS J (NOLOCK) ON J.JOB_CODE =D.JOB_CODE 
		WHERE M.CANCELLED =0 AND D.DELIVERED =0
		) HLDS ON HLDS. REF_CMD_ROW_ID=CMD.ROW_ID 
		WHERE CMM.CANCELLED=0 --AND DEL.REF_HBD_ROW_ID IS NULL AND   ISSUE.REF_HBD_ROW_ID IS NULL
		AND  (@CFM_MEMO_DT ='' OR CMM.CM_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
        AND (@CCUST_CODE ='' OR CMM .CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR CMD.PRODUCT_CODE =@CPRODUCT_CODE )
        --AND (@CAGENCY_CODE='' OR ISSUE.AGENCY_CODE =@CAGENCY_CODE)
        UNION ALL
        SELECT     '' AS CM_NO
                ,CONVERT (VARCHAR,'' ,105) AS CM_DT
				,ISNULL(C.CUSTOMER_FNAME,'') + '' +ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
				,ART.ARTICLE_NO
				,ART.ARTICLE_NAME
				,J.JOB_NAME
				,1.00 AS QUANTITY
				,M.MEMO_NO
				,CONVERT(VARCHAR,M.MEMO_DT,105) AS MEMO_DT
				,CONVERT( VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT
				,SKU.PRODUCT_CODE
				,'' AS PARA1_NAME
				,'' AS PARA2_NAME
				,STATUS='HOLD' 
        FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		JOIN JOBS J (NOLOCK) ON J.JOB_CODE =D.JOB_CODE 
		JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=M.CUSTOMER_CODE
		JOIN SKU_REPAIR (NOLOCK) SKU ON SKU.PRODUCT_CODE =D.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
		WHERE M.CANCELLED =0 AND D.DELIVERED =0
		AND  (@CFM_MEMO_DT ='' OR M.MEMO_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
        AND (@CCUST_CODE ='' OR M .CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR D.PRODUCT_CODE =@CPRODUCT_CODE )
        
        
     END
     ELSE
     BEGIN
        
      SELECT     CMM.CM_NO
                ,CONVERT (VARCHAR,CMM.CM_DT ,105) AS CM_DT
				,ISNULL(C.CUSTOMER_FNAME,'') + '' +ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
				,ART.ARTICLE_NO
				,ART.ARTICLE_NAME
				,HLDS.JOB_NAME
				,1.00 AS QUANTITY
				,HLDS.MEMO_NO
				,CONVERT(VARCHAR,HLDS.MEMO_DT,105) AS MEMO_DT
				,CONVERT( VARCHAR,DELIVERY_DT,105) AS DELIVERY_DT
				,SKU.PRODUCT_CODE
				,P1.PARA1_NAME
				,P2.PARA2_NAME
				,STATUS='HOLD' 
        FROM CMM01106 CMM (NOLOCK)
        JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID =CMD.CM_ID 
        JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
        JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE
        JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
        JOIN
       (  
		SELECT M.MEMO_ID,M.MEMO_NO,M.MEMO_DT,ROW_ID,
		DELIVERY_POINT,DELIVERY_DEPT_ID,REF_CMD_ROW_ID ,JOB_NAME,DELIVERY_DT  
		FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		JOIN JOBS J (NOLOCK) ON J.JOB_CODE =D.JOB_CODE 
		WHERE M.CANCELLED =0 AND D.DELIVERED =0
		) HLDS ON HLDS. REF_CMD_ROW_ID=CMD.ROW_ID 
		WHERE 1>2

		
     END
     
     IF @NISSUE=1
     BEGIN
          SELECT ISSUE.ISSUE_NO AS JWISSUENO
            ,CONVERT(VARCHAR,ISSUE.ISSUE_DT,105) AS JWISSUEDT
            ,ISSUE.AGENCY_CODE
			,ISSUE.AGENCY_NAME AS AGENCYNAME
			,CMM.CM_NO AS BILLNUMBER
			,CONVERT(VARCHAR,CMM.CM_DT,105) AS CM_DT
			,ART.ARTICLE_NO
			,ART.ARTICLE_NAME
			,SKU.PRODUCT_CODE
			,P1.PARA1_NAME
			,P2.PARA2_NAME
			,ISSUE.JOB_NAME
			,ISSUE.JOB_RATE
			,1.00 AS QUANTITY
			,CONVERT(VARCHAR,HLDS.DELIVERY_DT ,105) AS DUE_DT
		    ,STATUS='ISSUE'
		    ,CMM.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
        FROM CMM01106 CMM (NOLOCK)
        JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID =CMD.CM_ID 
        JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
        JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE
        JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
        JOIN
       (  
		SELECT M.MEMO_ID,M.MEMO_NO,M.MEMO_DT,ROW_ID,
		DELIVERY_POINT,DELIVERY_DEPT_ID,REF_CMD_ROW_ID,DELIVERY_DT  
		FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		WHERE M.CANCELLED =0
		) HLDS ON HLDS. REF_CMD_ROW_ID=CMD.ROW_ID 
	    JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,JOB_NAME,
		          DUE_DT,JOB_RATE,M.AGENCY_CODE,AGENCY_NAME 
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =D.JOB_CODE 
		   JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		   WHERE M.CANCELLED =0
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=HLDS.ROW_ID
		--LEFT JOIN
		--(
		--   SELECT D.REF_ROW_ID FROM POST_SALES_JOBWORK_RECEIPT_MST  M
		--   JOIN POST_SALES_JOBWORK_RECEIPT_DET D ON M.RECEIPT_ID =D.RECEIPT_ID
		--   WHERE M.CANCELLED =0
		--) REC ON REC.REF_ROW_ID=ISSUE.ROW_ID
		WHERE CMM.CANCELLED=0 --AND REC.REF_ROW_ID IS NULL 
		AND  (@CFM_MEMO_DT ='' OR CMM.CM_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
	    AND (@CCUST_CODE ='' OR CMM .CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR CMD.PRODUCT_CODE =@CPRODUCT_CODE )
        AND (@CAGENCY_CODE='' OR ISSUE.AGENCY_CODE =@CAGENCY_CODE)
        
        UNION ALL
        
        SELECT ISSUE.ISSUE_NO AS JWISSUENO
            ,CONVERT(VARCHAR,ISSUE.ISSUE_DT,105) AS JWISSUEDT
            ,ISSUE.AGENCY_CODE
			,ISSUE.AGENCY_NAME AS AGENCYNAME
			,'' AS BILLNUMBER
			,CONVERT(VARCHAR,'',105) AS CM_DT
			,ART.ARTICLE_NO
			,ART.ARTICLE_NAME
			,SKU.PRODUCT_CODE
			,'' AS PARA1_NAME
			,'' AS PARA2_NAME
			,ISSUE.JOB_NAME
			,ISSUE.JOB_RATE
			,1.00 AS QUANTITY
			,CONVERT(VARCHAR,D.DELIVERY_DT ,105) AS DUE_DT
		    ,STATUS='ISSUE'
		    ,C.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
        FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		JOIN JOBS J (NOLOCK) ON J.JOB_CODE =D.JOB_CODE 
		JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=M.CUSTOMER_CODE
		JOIN SKU_REPAIR (NOLOCK) SKU ON SKU.PRODUCT_CODE =D.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,JOB_NAME,
		          DUE_DT,JOB_RATE,M.AGENCY_CODE,AGENCY_NAME 
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =D.JOB_CODE 
		   JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		   WHERE M.CANCELLED =0
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=D.ROW_ID
		WHERE M.CANCELLED =0 AND D.DELIVERED =0
		AND  (@CFM_MEMO_DT ='' OR ISSUE.ISSUE_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
        AND (@CCUST_CODE ='' OR M .CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR D.PRODUCT_CODE =@CPRODUCT_CODE )
        
     END
     ELSE
     BEGIN
        SELECT ISSUE.ISSUE_NO AS JWISSUENO
            ,CONVERT(VARCHAR,ISSUE.ISSUE_DT,105) AS JWISSUEDT
            ,ISSUE.AGENCY_CODE
			,ISSUE.AGENCY_NAME AS AGENCYNAME
			,CMM.CM_NO AS BILLNUMBER
			,CONVERT(VARCHAR,CMM.CM_DT,105) AS CM_DT
			,ART.ARTICLE_NO
			,ART.ARTICLE_NAME
			,SKU.PRODUCT_CODE
			,P1.PARA1_NAME
			,P2.PARA2_NAME
			,ISSUE.JOB_NAME
			,ISSUE.JOB_RATE
			,1.00 AS QUANTITY
			,CONVERT(VARCHAR,HLDS.DELIVERY_DT ,105) AS DUE_DT
		    ,STATUS='ISSUE'
		    ,CMM.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
        FROM CMM01106 CMM (NOLOCK)
        JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID =CMD.CM_ID 
        JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
        JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE
        JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
        JOIN
       (  
		SELECT M.MEMO_ID,M.MEMO_NO,M.MEMO_DT,ROW_ID,
		DELIVERY_POINT,DELIVERY_DEPT_ID,REF_CMD_ROW_ID,DELIVERY_DT  
		FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		WHERE M.CANCELLED =0
		) HLDS ON HLDS. REF_CMD_ROW_ID=CMD.ROW_ID 
	    JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,JOB_NAME,
		          DUE_DT,JOB_RATE,M.AGENCY_CODE,AGENCY_NAME 
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =D.JOB_CODE 
		   JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		   WHERE M.CANCELLED =0
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=HLDS.ROW_ID
		--LEFT JOIN
		--(
		--   SELECT D.REF_ROW_ID FROM POST_SALES_JOBWORK_RECEIPT_MST  M
		--   JOIN POST_SALES_JOBWORK_RECEIPT_DET D ON M.RECEIPT_ID =D.RECEIPT_ID
		--   WHERE M.CANCELLED =0
		--) REC ON REC.REF_ROW_ID=ISSUE.ROW_ID
		WHERE 1>2
     
     END
     
     
     IF @NRECEIVED =1  
     BEGIN
          
           SELECT ISNULL(RCPT.RECEIPT_NO,'') AS RECEIPT_NO
			,CONVERT(VARCHAR,RCPT.RECEIPT_DT,105) AS RECEIPT_DT
			 ,ISSUE.AGENCY_CODE
			,ISNULL(ISSUE.AGENCY_NAME,'') AS AGENCY_NAME
			,ISNULL(CMM.CM_NO,'') AS CM_NO
			,CONVERT(VARCHAR,CMM.CM_DT,105) AS CM_DT
			,ISNULL(ART.ARTICLE_NO,'') AS ARTICLE_NO
			,ISNULL(ART.ARTICLE_NAME,'') AS ARTICLE_NAME
			,ISNULL(SKU.PRODUCT_CODE,'') AS PRODUCT_CODE
			,ISNULL(P1.PARA1_NAME,'') AS  PARA1_NAME
			,ISNULL(P2.PARA2_NAME,'') AS PARA2_NAME
			,ISNULL(RCPT.JOB_NAME,'') AS JOB_NAME
			,ISNULL(RCPT.JOB_RATE,'0') AS JOB_RATE
			,ISNULL(CONVERT(NUMERIC(10,2),RCPT.QUANTITY),'0') AS QUANTITY
			,CONVERT(VARCHAR,HLDS.DELIVERY_DT,105) AS DUE_DT
		    ,STATUS='RECEIVED' 
		    ,CMM.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
        FROM CMM01106 CMM (NOLOCK)
        JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID =CMD.CM_ID 
        JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
        JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE
        JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
        JOIN
       (  
		SELECT M.MEMO_ID,M.MEMO_NO,M.MEMO_DT,ROW_ID,
		DELIVERY_POINT,DELIVERY_DEPT_ID,REF_CMD_ROW_ID,DELIVERY_DT   
		FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		WHERE M.CANCELLED =0
		) HLDS ON HLDS. REF_CMD_ROW_ID=CMD.ROW_ID 
	    JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,
		          DUE_DT,JOB_RATE,AGENCY_NAME ,M.AGENCY_CODE 
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		    JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		   WHERE M.CANCELLED =0
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=HLDS.ROW_ID
		JOIN
		(
		   SELECT M.RECEIPT_NO,M.RECEIPT_DT,M.AGENCY_CODE,M.JOB_CODE,REF_ROW_ID
		          ,JOB_NAME,QUANTITY,JOB_RATE
		   FROM POST_SALES_JOBWORK_RECEIPT_MST  M
		   JOIN POST_SALES_JOBWORK_RECEIPT_DET D ON M.RECEIPT_ID =D.RECEIPT_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =M.JOB_CODE 
		   WHERE M.CANCELLED =0
		) RCPT ON RCPT.REF_ROW_ID=ISSUE.ROW_ID
		
		WHERE CMM.CANCELLED=0 --AND DEL.REF_HBD_ROW_ID IS NULL 
		AND  (@CFM_MEMO_DT ='' OR CMM.CM_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
		AND (@CCUST_CODE ='' OR CMM .CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR CMD.PRODUCT_CODE =@CPRODUCT_CODE )
        AND (@CAGENCY_CODE='' OR ISSUE.AGENCY_CODE =@CAGENCY_CODE)
        
        UNION ALL
        
         SELECT RCPT.RECEIPT_NO AS RECEIPT_NO
            ,CONVERT(VARCHAR,RCPT.RECEIPT_DT,105) AS RECEIPT_DT
            ,RCPT.AGENCY_CODE
			,RCPT.AGENCY_NAME AS AGENCYNAME
			,'' AS BILLNUMBER
			,CONVERT(VARCHAR,'',105) AS CM_DT
			,ART.ARTICLE_NO
			,ART.ARTICLE_NAME
			,SKU.PRODUCT_CODE
			,'' AS PARA1_NAME
			,'' AS PARA2_NAME
			,RCPT.JOB_NAME
			,RCPT.JOB_RATE
			,1.00 AS QUANTITY
			,CONVERT(VARCHAR,D.DELIVERY_DT ,105) AS DUE_DT
		    ,STATUS='RECEIVED'
		    ,C.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
        FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		JOIN JOBS J (NOLOCK) ON J.JOB_CODE =D.JOB_CODE 
		JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=M.CUSTOMER_CODE
		JOIN SKU_REPAIR (NOLOCK) SKU ON SKU.PRODUCT_CODE =D.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,JOB_NAME,
		          DUE_DT,JOB_RATE,M.AGENCY_CODE,AGENCY_NAME 
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =D.JOB_CODE 
		   JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		   WHERE M.CANCELLED =0
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=D.ROW_ID
		JOIN
		(
		   SELECT M.RECEIPT_NO,M.RECEIPT_DT,M.AGENCY_CODE,M.JOB_CODE,REF_ROW_ID
		          ,JOB_NAME,QUANTITY,JOB_RATE,AGENCY_NAME 
		   FROM POST_SALES_JOBWORK_RECEIPT_MST  M
		   JOIN POST_SALES_JOBWORK_RECEIPT_DET D ON M.RECEIPT_ID =D.RECEIPT_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =M.JOB_CODE 
		   JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE 
		   WHERE M.CANCELLED =0
		) RCPT ON RCPT.REF_ROW_ID=ISSUE.ROW_ID
		WHERE M.CANCELLED =0 
		--AND D.DELIVERED =0
		AND  (@CFM_MEMO_DT ='' OR RCPT .RECEIPT_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
        AND (@CCUST_CODE ='' OR M .CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR D.PRODUCT_CODE =@CPRODUCT_CODE )
        
        

     END
     ELSE
     BEGIN
         
            SELECT ISNULL(RCPT.RECEIPT_NO,'') AS RECEIPT_NO
			,CONVERT(VARCHAR,RCPT.RECEIPT_DT,105) AS RECEIPT_DT
			 ,ISSUE.AGENCY_CODE
			,ISNULL(ISSUE.AGENCY_NAME,'') AS AGENCY_NAME
			,ISNULL(CMM.CM_NO,'') AS CM_NO
			,CONVERT(VARCHAR,CMM.CM_DT,105) AS CM_DT
			,ISNULL(ART.ARTICLE_NO,'') AS ARTICLE_NO
			,ISNULL(ART.ARTICLE_NAME,'') AS ARTICLE_NAME
			,ISNULL(SKU.PRODUCT_CODE,'') AS PRODUCT_CODE
			,ISNULL(P1.PARA1_NAME,'') AS  PARA1_NAME
			,ISNULL(P2.PARA2_NAME,'') AS PARA2_NAME
			,ISNULL(RCPT.JOB_NAME,'') AS JOB_NAME
			,ISNULL(RCPT.JOB_RATE,'0') AS JOB_RATE
			,ISNULL(CONVERT(NUMERIC(10,2),RCPT.QUANTITY),'0') AS QUANTITY
			,CONVERT(VARCHAR,HLDS.DELIVERY_DT,105) AS DUE_DT
		    ,STATUS='RECEIVED' 
		    ,CMM.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
        FROM CMM01106 CMM (NOLOCK)
        JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID =CMD.CM_ID 
        JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
        JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE
        JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
        JOIN
       (  
		SELECT M.MEMO_ID,M.MEMO_NO,M.MEMO_DT,ROW_ID,
		DELIVERY_POINT,DELIVERY_DEPT_ID,REF_CMD_ROW_ID,DELIVERY_DT   
		FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		WHERE M.CANCELLED =0
		) HLDS ON HLDS. REF_CMD_ROW_ID=CMD.ROW_ID 
	    JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,
		          DUE_DT,JOB_RATE,AGENCY_NAME ,M.AGENCY_CODE 
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		    JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		   WHERE M.CANCELLED =0
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=HLDS.ROW_ID
		JOIN
		(
		   SELECT M.RECEIPT_NO,M.RECEIPT_DT,M.AGENCY_CODE,M.JOB_CODE,REF_ROW_ID
		          ,JOB_NAME,QUANTITY,JOB_RATE
		   FROM POST_SALES_JOBWORK_RECEIPT_MST  M
		   JOIN POST_SALES_JOBWORK_RECEIPT_DET D ON M.RECEIPT_ID =D.RECEIPT_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =M.JOB_CODE 
		   WHERE M.CANCELLED =0
		) RCPT ON RCPT.REF_ROW_ID=ISSUE.ROW_ID
		--LEFT JOIN
		--(
		--   SELECT D.REF_HBD_ROW_ID FROM SLS_DELIVERY_MST  M
		--   JOIN SLS_DELIVERY_DET D ON M.MEMO_ID=D.MEMO_ID
		--   WHERE M.CANCELLED =0
		--) DEL ON DEL.REF_HBD_ROW_ID=HLDS.ROW_ID
		
		WHERE   1>2
     
     END -------
     
     IF @NDELIVERED=1
     BEGIN
     
     SELECT DISTINCT
             DLVY.CUSTOMER_CODE
			,DLVY.CUSTOMER_NAME
			,DLVY.CM_NO 
			,CONVERT(VARCHAR,DLVY.CM_DT ,105) AS CM_DT
			,CONVERT(VARCHAR,DLVY.MEMO_DT,105) AS MEMO_DT
			,DLVY.DELIVERED_TO
			,DLVY.JOB_NAME
			,DLVY.ARTICLE_NO 
			,DLVY.PARA1_NAME
			,DLVY.PARA2_NAME
			,DLVY.ARTICLE_NAME 
			,DLVY.MEMO_NO 
			,1.00 AS QUANTITY
			,DLVY.PRODUCT_CODE 
			,'DELIEVERED' STATUS
		FROM VW_POSTSALES_SLS_DELIVERYPRINT DLVY
		JOIN VW_POSTSALES_HBDPRINT HLDS ON DLVY.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE  (@CFM_MEMO_DT ='' OR DLVY.MEMO_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
		AND (@CCUST_CODE ='' OR DLVY.CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR DLVY.PRODUCT_CODE =@CPRODUCT_CODE )
		AND DLVY.CANCELLED =0
		
		UNION ALL
		
		SELECT DISTINCT 
		
		 A.CUSTOMER_CODE,
		ISNULL(H.CUSTOMER_FNAME,'')+' '+ISNULL(H.CUSTOMER_LNAME,'') AS CUSTOMER_NAME ,
		 '' AS CM_NO,
		 '' AS CM_DT,
		 CONVERT(VARCHAR,A.MEMO_DT,105) AS MEMO_DT,
		 A.DELIVERED_TO,
		 F.JOB_NAME,
		 ART.ARTICLE_NO,
		 ''AS PARA1_NAME,
		 '' AS PARA2_NAME,
		 ART.ARTICLE_NAME,
		 A.MEMO_NO,
		 1.00 AS QUANTITY,
		 SKU.PRODUCT_CODE,
		 'DELIEVERED' STATUS
		
		 FROM SLS_DELIVERY_MST A (NOLOCK)   
		 JOIN SLS_DELIVERY_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID   
		 JOIN HOLD_BACK_DELIVER_DET M (NOLOCK) ON B.REF_HBD_ROW_ID = M.ROW_ID   
		 JOIN HOLD_BACK_DELIVER_MST N (NOLOCK) ON M.MEMO_ID = N.MEMO_ID
		 LEFT OUTER JOIN CUSTDYM H ON N.CUSTOMER_CODE = H.CUSTOMER_CODE
		 LEFT OUTER JOIN POST_SALES_JOBWORK_ISSUE_DET P (NOLOCK) ON P.REF_HBD_ROW_ID = M.ROW_ID
		 JOIN JOBS F (NOLOCK) ON F.JOB_CODE = ISNULL(P.JOB_CODE ,M.JOB_CODE)
		  JOIN SKU_REPAIR SKU (NOLOCK) ON SKU.PRODUCT_CODE=M.PRODUCT_CODE  
          JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE 
         WHERE  (@CFM_MEMO_DT ='' OR A.MEMO_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
		AND (@CCUST_CODE ='' OR A.CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR SKU.PRODUCT_CODE =@CPRODUCT_CODE )
		AND N.CANCELLED =0

				
		
        END
        ELSE
        BEGIN
          SELECT DISTINCT
             DLVY.CUSTOMER_CODE
			,DLVY.CUSTOMER_NAME
			,DLVY.CM_NO 
			,CONVERT(VARCHAR,DLVY.CM_DT ,105) AS CM_DT
			,CONVERT(VARCHAR,DLVY.MEMO_DT,105) AS MEMO_DT
			,DLVY.DELIVERED_TO
			,DLVY.JOB_NAME
			,DLVY.ARTICLE_NO 
			,DLVY.PARA1_NAME
			,DLVY.PARA2_NAME
			,DLVY.ARTICLE_NAME 
			,DLVY.MEMO_NO 
			,1.00 AS QUANTITY
			,DLVY.PRODUCT_CODE 
			,'DELIEVERED' STATUS
		FROM VW_POSTSALES_SLS_DELIVERYPRINT DLVY
		JOIN VW_POSTSALES_HBDPRINT HLDS ON DLVY.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE   1>2
        END
        
     IF @NUNDELIVERED=1
     BEGIN
        SELECT ISNULL(RCPT.RECEIPT_NO,'') AS RECEIPT_NO
            ,CONVERT(VARCHAR,RCPT.RECEIPT_DT,105) AS RECEIPT_DT
            ,ISNULL(ISSUE.AGENCY_CODE,'') AS AGENCY_CODE
			,ISNULL(ISSUE.AGENCY_NAME,'') AS AGENCY_NAME
			,ISNULL(CMM.CM_NO,'') AS CM_NO
			,CONVERT(VARCHAR,CMM.CM_DT,105) AS CM_DT
			,ISNULL(ART.ARTICLE_NO,'') AS ARTICLE_NO
			,ISNULL(ART.ARTICLE_NAME,'') AS ARTICLE_NAME
			,ISNULL(SKU.PRODUCT_CODE,'') AS PRODUCT_CODE
			,ISNULL(P1.PARA1_NAME,'') AS  PARA1_NAME
			,ISNULL(P2.PARA2_NAME,'') AS PARA2_NAME
			,ISNULL(RCPT.JOB_NAME,'') AS JOB_NAME
			,ISNULL(RCPT.JOB_RATE,'0') AS JOB_RATE
			,ISNULL(CONVERT(NUMERIC(10,2),RCPT.QUANTITY),'0') AS QUANTITY
			,CONVERT(VARCHAR,HLDS .DELIVERY_DT,105) AS DUE_DT
		    ,STATUS='UN-DELIVERED'
		    ,CMM.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
        FROM CMM01106 CMM (NOLOCK)
        JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID =CMD.CM_ID 
        JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
        JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE
        JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
        JOIN
       (  
		SELECT M.MEMO_ID,M.MEMO_NO,M.MEMO_DT,ROW_ID,
		DELIVERY_POINT,DELIVERY_DEPT_ID,REF_CMD_ROW_ID,DELIVERY_DT   
		FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		WHERE M.CANCELLED =0
		) HLDS ON HLDS. REF_CMD_ROW_ID=CMD.ROW_ID 
	    JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,
		          DUE_DT,JOB_RATE,AGENCY_NAME ,M.AGENCY_CODE
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		    JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		   WHERE M.CANCELLED =0
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=HLDS.ROW_ID
		JOIN
		(
		   SELECT M.RECEIPT_NO,M.RECEIPT_DT,M.AGENCY_CODE,M.JOB_CODE,REF_ROW_ID
		          ,JOB_NAME,QUANTITY,JOB_RATE
		   FROM POST_SALES_JOBWORK_RECEIPT_MST  M
		   JOIN POST_SALES_JOBWORK_RECEIPT_DET D ON M.RECEIPT_ID =D.RECEIPT_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =M.JOB_CODE 
		   WHERE M.CANCELLED =0
		) RCPT ON RCPT.REF_ROW_ID=ISSUE.ROW_ID
		LEFT JOIN
		(
		   SELECT D.REF_HBD_ROW_ID FROM SLS_DELIVERY_MST  M
		   JOIN SLS_DELIVERY_DET D ON M.MEMO_ID=D.MEMO_ID
		   WHERE M.CANCELLED =0
		) DEL ON DEL.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE CMM.CANCELLED=0 AND DEL.REF_HBD_ROW_ID IS NULL 
		AND  (@CFM_MEMO_DT ='' OR CMM.CM_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
		AND (@CCUST_CODE ='' OR CMM .CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR CMD.PRODUCT_CODE =@CPRODUCT_CODE )
        AND (@CAGENCY_CODE='' OR ISSUE.AGENCY_CODE =@CAGENCY_CODE)
        
        
        UNION ALL
        
         SELECT ISNULL(RCPT.RECEIPT_NO,'') AS RECEIPT_NO
            ,CONVERT(VARCHAR,RCPT.RECEIPT_DT,105) AS RECEIPT_DT
            ,ISNULL(ISSUE.AGENCY_CODE,'') AS AGENCY_CODE
			,ISNULL(ISSUE.AGENCY_NAME,'') AS AGENCY_NAME
			,'' AS CM_NO
			,CONVERT(VARCHAR,'',105) AS CM_DT
			,ISNULL(ART.ARTICLE_NO,'') AS ARTICLE_NO
			,ISNULL(ART.ARTICLE_NAME,'') AS ARTICLE_NAME
			,ISNULL(SKU.PRODUCT_CODE,'') AS PRODUCT_CODE
			,'' AS  PARA1_NAME
			,'' AS PARA2_NAME
			,ISNULL(RCPT.JOB_NAME,'') AS JOB_NAME
			,ISNULL(RCPT.JOB_RATE,'0') AS JOB_RATE
			,ISNULL(CONVERT(NUMERIC(10,2),RCPT.QUANTITY),'0') AS QUANTITY
			,CONVERT(VARCHAR,D.DELIVERY_DT,105) AS DUE_DT
		    ,STATUS='UN-DELIVERED'
		    ,M.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
			
			
        FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID  
		JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=M.CUSTOMER_CODE
        JOIN SKU_REPAIR SKU (NOLOCK) ON SKU.PRODUCT_CODE =D.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        
        
        
        JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,
		          DUE_DT,JOB_RATE,AGENCY_NAME ,M.AGENCY_CODE
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		    JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		   WHERE M.CANCELLED =0
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=D.ROW_ID
		JOIN
		(
		   SELECT M.RECEIPT_NO,M.RECEIPT_DT,M.AGENCY_CODE,M.JOB_CODE,REF_ROW_ID
		          ,JOB_NAME,QUANTITY,JOB_RATE
		   FROM POST_SALES_JOBWORK_RECEIPT_MST  M
		   JOIN POST_SALES_JOBWORK_RECEIPT_DET D ON M.RECEIPT_ID =D.RECEIPT_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =M.JOB_CODE 
		   WHERE M.CANCELLED =0
		) RCPT ON RCPT.REF_ROW_ID=ISSUE.ROW_ID
		LEFT JOIN
		(
		   SELECT D.REF_HBD_ROW_ID FROM SLS_DELIVERY_MST  M
		   JOIN SLS_DELIVERY_DET D ON M.MEMO_ID=D.MEMO_ID
		   WHERE M.CANCELLED =0
		) DEL ON DEL.REF_HBD_ROW_ID=D.ROW_ID
		WHERE M.CANCELLED=0 AND DEL.REF_HBD_ROW_ID IS NULL 
		AND  (@CFM_MEMO_DT ='' OR M.MEMO_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
		AND (@CCUST_CODE ='' OR M.CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR D.PRODUCT_CODE =@CPRODUCT_CODE )
        AND (@CAGENCY_CODE='' OR ISSUE.AGENCY_CODE =@CAGENCY_CODE)
        
        

     END
     ELSE
     BEGIN
           SELECT ISNULL(RCPT.RECEIPT_NO,'') AS RECEIPT_NO
            ,CONVERT(VARCHAR,RCPT.RECEIPT_DT,105) AS RECEIPT_DT
            ,ISNULL(ISSUE.AGENCY_CODE,'') AS AGENCY_CODE
			,ISNULL(ISSUE.AGENCY_NAME,'') AS AGENCY_NAME
			,ISNULL(CMM.CM_NO,'') AS CM_NO
			,CONVERT(VARCHAR,CMM.CM_DT,105) AS CM_DT
			,ISNULL(ART.ARTICLE_NO,'') AS ARTICLE_NO
			,ISNULL(ART.ARTICLE_NAME,'') AS ARTICLE_NAME
			,ISNULL(SKU.PRODUCT_CODE,'') AS PRODUCT_CODE
			,ISNULL(P1.PARA1_NAME,'') AS  PARA1_NAME
			,ISNULL(P2.PARA2_NAME,'') AS PARA2_NAME
			,ISNULL(RCPT.JOB_NAME,'') AS JOB_NAME
			,ISNULL(RCPT.JOB_RATE,'0') AS JOB_RATE
			,ISNULL(CONVERT(NUMERIC(10,2),RCPT.QUANTITY),'0') AS QUANTITY
			,CONVERT(VARCHAR,ISSUE.DUE_DT,105) AS DUE_DT
		    ,STATUS='UN-DELIVERED'
		    ,CMM.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME
        FROM CMM01106 CMM (NOLOCK)
        JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID =CMD.CM_ID 
        JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
        JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE
        JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
        JOIN
       (  
		SELECT M.MEMO_ID,M.MEMO_NO,M.MEMO_DT,ROW_ID,
		DELIVERY_POINT,DELIVERY_DEPT_ID,REF_CMD_ROW_ID   
		FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		WHERE M.CANCELLED =0
		) HLDS ON HLDS. REF_CMD_ROW_ID=CMD.ROW_ID 
	    JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,
		          DUE_DT,JOB_RATE,AGENCY_NAME ,M.AGENCY_CODE
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		    JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		   WHERE M.CANCELLED =0
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=HLDS.ROW_ID
		JOIN
		(
		   SELECT M.RECEIPT_NO,M.RECEIPT_DT,M.AGENCY_CODE,M.JOB_CODE,REF_ROW_ID
		          ,JOB_NAME,QUANTITY,JOB_RATE
		   FROM POST_SALES_JOBWORK_RECEIPT_MST  M
		   JOIN POST_SALES_JOBWORK_RECEIPT_DET D ON M.RECEIPT_ID =D.RECEIPT_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =M.JOB_CODE 
		   WHERE M.CANCELLED =0
		) RCPT ON RCPT.REF_ROW_ID=ISSUE.ROW_ID
		LEFT JOIN
		(
		   SELECT D.REF_HBD_ROW_ID FROM SLS_DELIVERY_MST  M
		   JOIN SLS_DELIVERY_DET D ON M.MEMO_ID=D.MEMO_ID
		   WHERE M.CANCELLED =0
		) DEL ON DEL.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE 1>2
     
     END
     
    
     
     IF @NCANCELLED =1
     BEGIN
       
        SELECT ISNULL(CMM.CM_NO,'') AS CM_NO
            ,CONVERT(VARCHAR,CMM.CM_DT ,105) AS CM_DT
            ,HLDS.MEMO_NO AS HBD_MEMO_NO
            ,ISSUE.ISSUE_NO 
            ,ISNULL(RCPT.RECEIPT_NO,'') AS RECEIPT_NO
            ,ISNULL(DEL.MEMO_NO,'') AS DEL_MEMO_NO
            ,CASE WHEN ISNULL(HBD_CANCELLED,0) =1 THEN  'HOLD_BACK'  
             WHEN ISNULL(ISSUE_CANCELLED,0)=1 THEN  'ISSUED' 
             WHEN ISNULL(REC_CANCELLED,0)=1 THEN  'RECEIVED' 
             WHEN ISNULL(DEL_CANCELLED,0)=1 THEN  'DELIVERED' END AS CANCELLED_ON
            ,ISNULL(ISSUE.AGENCY_CODE,'') AS AGENCY_CODE
			,ISNULL(ISSUE.AGENCY_NAME,'') AS AGENCY_NAME
			,ISNULL(ART.ARTICLE_NO,'') AS ARTICLE_NO
			,ISNULL(ART.ARTICLE_NAME,'') AS ARTICLE_NAME
			,ISNULL(SKU.PRODUCT_CODE,'') AS PRODUCT_CODE
			,ISNULL(P1.PARA1_NAME,'') AS  PARA1_NAME
			,ISNULL(P2.PARA2_NAME,'') AS PARA2_NAME
			,ISNULL(RCPT.JOB_NAME,'') AS JOB_NAME
			,ISNULL(RCPT.JOB_RATE,'0') AS JOB_RATE
			,ISNULL(CONVERT(NUMERIC(10,2),RCPT.QUANTITY),'0') AS QUANTITY
			,CASE WHEN ISNULL(HLDS.DELIVERY_DT,'') ='1900-01-01' THEN '' ELSE CONVERT(VARCHAR,HLDS.DELIVERY_DT,105) END AS DUE_DT
			,CASE WHEN ISNULL(RCPT.RECEIPT_DT,'') ='1900-01-01' THEN '' ELSE CONVERT(VARCHAR,RCPT.RECEIPT_DT,105) END AS RECEIPT_DT
		    ,STATUS='CANCELLED'
		    ,CMM.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME 
        FROM CMM01106 CMM (NOLOCK)
        JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID =CMD.CM_ID 
        JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
        JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE
        JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
        JOIN
       (  
		SELECT M.MEMO_ID,M.MEMO_NO,M.MEMO_DT,ROW_ID,
		DELIVERY_POINT,DELIVERY_DEPT_ID,REF_CMD_ROW_ID,M.CANCELLED AS HBD_CANCELLED,DELIVERY_DT   
		FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		) HLDS ON HLDS. REF_CMD_ROW_ID=CMD.ROW_ID 
	  LEFT  JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,
		          DUE_DT,JOB_RATE,AGENCY_NAME,M.CANCELLED AS ISSUE_CANCELLED ,M.AGENCY_CODE
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		    JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=HLDS.ROW_ID
		LEFT JOIN
		(
		   SELECT M.RECEIPT_NO,M.RECEIPT_DT,M.AGENCY_CODE,M.JOB_CODE,REF_ROW_ID
		          ,JOB_NAME,QUANTITY,JOB_RATE,M.CANCELLED AS REC_CANCELLED
		   FROM POST_SALES_JOBWORK_RECEIPT_MST  M
		   JOIN POST_SALES_JOBWORK_RECEIPT_DET D ON M.RECEIPT_ID =D.RECEIPT_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =M.JOB_CODE 
		) RCPT ON RCPT.REF_ROW_ID=ISSUE.ROW_ID
		LEFT JOIN
		(
		   SELECT D.REF_HBD_ROW_ID,MEMO_NO ,M.CANCELLED AS DEL_CANCELLED,MEMO_DT 
		   FROM SLS_DELIVERY_MST  M
		   JOIN SLS_DELIVERY_DET D ON M.MEMO_ID=D.MEMO_ID
		) DEL ON DEL.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE CMM.CANCELLED =0
		AND  (CMM.CM_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT OR HLDS .MEMO_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT
		      OR ISSUE .ISSUE_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT OR RCPT.RECEIPT_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT
		      OR DEL.MEMO_DT BETWEEN @CFM_MEMO_DT AND @CTO_MEMO_DT)
		AND (@CCUST_CODE ='' OR CMM .CUSTOMER_CODE =@CCUST_CODE )
		AND (@CPRODUCT_CODE ='' OR CMD.PRODUCT_CODE =@CPRODUCT_CODE )
        AND (@CAGENCY_CODE='' OR ISSUE.AGENCY_CODE =@CAGENCY_CODE)
		AND (ISNULL(HBD_CANCELLED,0)=1 OR ISNULL(ISSUE_CANCELLED,0)=1 OR ISNULL(REC_CANCELLED,0)=1 
		OR ISNULL(DEL_CANCELLED,0)=1) 
		
     END   
     ELSE
     BEGIN
        
           SELECT ISNULL(CMM.CM_NO,'') AS CM_NO
            ,CONVERT(VARCHAR,CMM.CM_DT ,105) AS CM_DT
            ,HLDS.MEMO_NO AS HBD_MEMO_NO
            ,ISSUE.ISSUE_NO 
            ,ISNULL(RCPT.RECEIPT_NO,'') AS RECEIPT_NO
            ,ISNULL(DEL.MEMO_NO,'') AS DEL_MEMO_NO
            ,CASE WHEN ISNULL(HBD_CANCELLED,0) =1 THEN  'HOLD_BACK'  
             WHEN ISNULL(ISSUE_CANCELLED,0)=1 THEN  'ISSUED' 
             WHEN ISNULL(REC_CANCELLED,0)=1 THEN  'RECEIVED' 
             WHEN ISNULL(DEL_CANCELLED,0)=1 THEN  'DELIVERED' END AS CANCELLED_ON
            ,ISNULL(ISSUE.AGENCY_CODE,'') AS AGENCY_CODE
			,ISNULL(ISSUE.AGENCY_NAME,'') AS AGENCY_NAME
			,ISNULL(ART.ARTICLE_NO,'') AS ARTICLE_NO
			,ISNULL(ART.ARTICLE_NAME,'') AS ARTICLE_NAME
			,ISNULL(SKU.PRODUCT_CODE,'') AS PRODUCT_CODE
			,ISNULL(P1.PARA1_NAME,'') AS  PARA1_NAME
			,ISNULL(P2.PARA2_NAME,'') AS PARA2_NAME
			,ISNULL(RCPT.JOB_NAME,'') AS JOB_NAME
			,ISNULL(RCPT.JOB_RATE,'0') AS JOB_RATE
			,ISNULL(CONVERT(NUMERIC(10,2),RCPT.QUANTITY),'0') AS QUANTITY
			,CASE WHEN ISNULL(RCPT.RECEIPT_DT,'') ='1900-01-01' THEN '' ELSE CONVERT(VARCHAR,ISSUE.DUE_DT,105) END AS DUE_DT
			,CASE WHEN ISNULL(RCPT.RECEIPT_DT,'') ='1900-01-01' THEN '' ELSE CONVERT(VARCHAR,RCPT.RECEIPT_DT,105) END AS RECEIPT_DT
		    ,STATUS='CANCELLED'
		    ,CMM.CUSTOMER_CODE 
		    ,ISNULL(C.CUSTOMER_FNAME,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS CUSTOMER_NAME 
        FROM CMM01106 CMM (NOLOCK)
        JOIN CMD01106 CMD (NOLOCK) ON CMM.CM_ID =CMD.CM_ID 
        JOIN CUSTDYM C (NOLOCK)  ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
        JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =CMD.PRODUCT_CODE 
        JOIN ARTICLE ART (NOLOCK)  ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE 
        JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =SKU.PARA1_CODE
        JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE
        JOIN
       (  
		SELECT M.MEMO_ID,M.MEMO_NO,M.MEMO_DT,ROW_ID,
		DELIVERY_POINT,DELIVERY_DEPT_ID,REF_CMD_ROW_ID,M.CANCELLED AS HBD_CANCELLED   
		FROM HOLD_BACK_DELIVER_MST (NOLOCK) M
		JOIN HOLD_BACK_DELIVER_DET (NOLOCK) D ON M.MEMO_ID=D.MEMO_ID 
		) HLDS ON HLDS. REF_CMD_ROW_ID=CMD.ROW_ID 
	  LEFT  JOIN
		(
		   SELECT M.ISSUE_ID ,M.ISSUE_NO ,M.ISSUE_DT , D.ROW_ID , D.REF_HBD_ROW_ID ,
		          DUE_DT,JOB_RATE,AGENCY_NAME,M.CANCELLED AS ISSUE_CANCELLED ,M.AGENCY_CODE
		   FROM POST_SALES_JOBWORK_ISSUE_MST M (NOLOCK)
		   JOIN POST_SALES_JOBWORK_ISSUE_DET D (NOLOCK) ON M.ISSUE_ID=D.ISSUE_ID
		    JOIN PRD_AGENCY_MST AG (NOLOCK) ON AG.AGENCY_CODE = M.AGENCY_CODE  
		) ISSUE ON  ISSUE.REF_HBD_ROW_ID=HLDS.ROW_ID
		LEFT JOIN
		(
		   SELECT M.RECEIPT_NO,M.RECEIPT_DT,M.AGENCY_CODE,M.JOB_CODE,REF_ROW_ID
		          ,JOB_NAME,QUANTITY,JOB_RATE,M.CANCELLED AS REC_CANCELLED
		   FROM POST_SALES_JOBWORK_RECEIPT_MST  M
		   JOIN POST_SALES_JOBWORK_RECEIPT_DET D ON M.RECEIPT_ID =D.RECEIPT_ID
		   JOIN JOBS J (NOLOCK) ON J.JOB_CODE =M.JOB_CODE 
		) RCPT ON RCPT.REF_ROW_ID=ISSUE.ROW_ID
		LEFT JOIN
		(
		   SELECT D.REF_HBD_ROW_ID,MEMO_NO ,M.CANCELLED AS DEL_CANCELLED 
		   FROM SLS_DELIVERY_MST  M
		   JOIN SLS_DELIVERY_DET D ON M.MEMO_ID=D.MEMO_ID
		) DEL ON DEL.REF_HBD_ROW_ID=HLDS.ROW_ID
		WHERE 1>2
     END    
        
END
--END OF PROCEDURE - SP_POSTSALEJOBWORKS_REPORTS
