CREATE PROCEDURE SP3S_EOSS_SCHEMES_9
(
	@CSCHEMEDETROWID VARCHAR(50),
	@CSLSTITLE VARCHAR(500),
	@CROUNDITEMLEVEL VARCHAR(5),
	@CJOINSTRBUY VARCHAR(MAX),
	@CJOINSTRGET VARCHAR(MAX),
	@CPICKSLRDISCMODE VARCHAR(5),
	@CERRMSG VARCHAR(MAX) OUTPUT
)
AS 
BEGIN
	PRINT 'ENTER SP3S_EOSS_SCHEMES_9 FOR TITLE:'+@CSLSTITLE
	
	DECLARE @NORGBUYAMT NUMERIC(10,2),@NBUYAMT NUMERIC(10,2),@NGETAMT NUMERIC(10,2),@NREQGETAMT NUMERIC(10,2),
			@CPRODUCTCODE VARCHAR(50),@NMRP NUMERIC(10,2),@NQTY NUMERIC(10,2),
			@CCMDROWID VARCHAR(50),@NLOOPCNT INT,@NMODE INT,@BQUALIFIED BIT,
			@CROWID VARCHAR(100),@NSTEP INT,@NAMT NUMERIC(10,2),
			@CMRPORDER VARCHAR(10),@NREQBUYAMT NUMERIC(10,2),@BRETRY2NDCASE BIT,
			@CCMD NVARCHAR(MAX),@CBUYFILTER VARCHAR(MAX),@CGETFILTER VARCHAR(MAX),
			@CADDFILTER VARCHAR(MAX),@CORGADDFILTER VARCHAR(MAX),@NDISCMODE INT,@BLOOP BIT,
			@NFILTERMODE INT,@BPROCESSSLRENTRY BIT,@NGETFILTERMODE INT,@NTRIAL INT,@NAPPLYMODE NUMERIC(1,0),
			@NDISCAMT NUMERIC(10,2),@BDONOTAPPLYSCHEMEONDISCITEMS BIT,@NTRIALCNT NUMERIC(1,0),
			@NADDBUYFILTERMODE NUMERIC(1,0),@CADDBUYFILTER VARCHAR(MAX),@BAPPLYADDBUYFILTERRESTRICTION BIT,
			@NADDBUYQUANTITY NUMERIC(3,0),@NREQBUY2QTY NUMERIC(4,0),@BBUYCHECKED BIT,@NPCCNT INT,@BGETCHECKED BIT
	
	SELECT @BPROCESSSLRENTRY=0,@NTRIAL=1,@BBUYCHECKED=0,@BGETCHECKED=0
	
	DECLARE @CENABLEOPTIMIZEDSCHEMES VARCHAR(2)
	SELECT TOP 1 @CENABLEOPTIMIZEDSCHEMES=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_OPTIMIZED_EOSS_SCHEMES'		
	
	SET @CENABLEOPTIMIZEDSCHEMES=ISNULL(@CENABLEOPTIMIZEDSCHEMES,'')
       

START_PROC:
				
	SELECT @NORGBUYAMT=0,@CPRODUCTCODE='',@NBUYAMT=0,@NGETAMT=0,@NMRP=0,@NQTY=0,
		   @CCMDROWID='',@NLOOPCNT=0,@NREQGETAMT=0,@NMODE=0,@BQUALIFIED=0,@CROWID='',
		   @NSTEP=0,@NAMT=0,@CMRPORDER='',@NREQBUYAMT=0,@BRETRY2NDCASE=0,@CCMD='',
		   @NDISCMODE=0,@CBUYFILTER='',@CGETFILTER='',@CADDFILTER='',@NFILTERMODE=0,
		   @CADDFILTER='',@CORGADDFILTER='',@NGETFILTERMODE=0,@NREQBUY2QTY=0
			

	SELECT @BDONOTAPPLYSCHEMEONDISCITEMS=ISNULL(DONOT_APPLY_SCHEME_ON_DISCOUNTED_ITEMS,0) FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
	
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMD A WHERE (@BDONOTAPPLYSCHEMEONDISCITEMS=1 AND (ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 
				   AND A.SCHEME_SETUP_DET_ROW_ID='')) OR 
				   (@BDONOTAPPLYSCHEMEONDISCITEMS=0 AND ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0))
		GOTO END_PROC
		

	IF @BPROCESSSLRENTRY=1
		SET @CORGADDFILTER='A.QUANTITY<0'
	ELSE
		SET @CORGADDFILTER='A.QUANTITY>0'
			
	IF CURSOR_STATUS('GLOBAL','SCHEMECUR') IN (0,1)
	BEGIN
		CLOSE SCHEMECUR
		DEALLOCATE SCHEMECUR
	END
	
		
	SET @NSTEP=10
	
	PRINT 'CHECK SCHEME SP3S_EOSS_SCHEMES_9'	
	SELECT @CMRPORDER='',@BQUALIFIED=0,@BRETRY2NDCASE=0
		
	IF OBJECT_ID('TEMPDB..#TMPCMDSCHEMES','U') IS NOT NULL
		DROP TABLE #TMPCMDSCHEMES

	SELECT @CBUYFILTER=(CASE WHEN FILTER_MODE IN (0,1) AND @CENABLEOPTIMIZEDSCHEMES<>'1'  THEN  BUY_FILTER_CRITERIA ELSE '1=1' END),
		   @CGETFILTER=(CASE WHEN GET_FILTER_MODE IN (0,1) AND @CENABLEOPTIMIZEDSCHEMES<>'1'  THEN  GET_FILTER_CRITERIA ELSE '1=1' END),
		   @CADDBUYFILTER=ISNULL(ADDITIONAL_BUY_FILTER_CRITERIA,0),@NADDBUYQUANTITY=ISNULL(BUY2_QUANTITY,0),
		   @NDISCMODE=DISC_METHOD,@NFILTERMODE=FILTER_MODE,@NGETFILTERMODE=GET_FILTER_MODE,
		   @BAPPLYADDBUYFILTERRESTRICTION=ISNULL(APPLYADDBUYFILTERRESTRICTION,0) 
	FROM SCHEME_SETUP_DET
	WHERE ROW_ID=@CSCHEMEDETROWID

	--SELECT 'CHECK #TMPCMD FOR EOSS_SCHEMES_9',* FROM #TMPCMD

	IF @NFILTERMODE NOT IN (0,1)
		SELECT @CADDFILTER=@CORGADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''''
	ELSE
		SELECT @CADDFILTER=@CORGADDFILTER+' AND 1=1'			

	IF @BDONOTAPPLYSCHEMEONDISCITEMS=1
		SELECT @CADDFILTER=@CADDFILTER+' AND A.SCHEME_SETUP_DET_ROW_ID='''''
					
	SET @NSTEP=15
	SELECT PRODUCT_CODE,MRP,QUANTITY,CMD_ROW_ID AS ROW_ID,CONVERT(INT,0) AS MODE,
	CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT,QUANTITY AS SCHEME_APPLIED_QTY,MRP AS SCHEME_APPLIED_AMOUNT,CONVERT(NUMERIC(1,0),0) AS CODING_SCHEME,
	CONVERT(BIT,0) PROCESSED
	INTO #TMPCMDSCHEMES
	FROM #TMPCMD WHERE 1=2 
		
	SET @CCMD=N' SELECT A.PRODUCT_CODE,(A.NET-A.SCHEME_APPLIED_AMOUNT),ABS(A.QUANTITY)*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END),
				 A.CMD_ROW_ID AS ROW_ID,1 AS MODE,
				 0 AS DISCOUNT_AMOUNT,0,0 FROM #TMPCMD A
				 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTRBUY+'
				 WHERE '+@CBUYFILTER+' AND A.SCHEME_APPLIED_QTY=0 AND A.SCHEME_APPLIED_AMOUNT=0 AND '+@CADDFILTER
	
	PRINT 'CHECK BUY FILTER OF BNGNAMT2'
	PRINT @CCMD				 
	INSERT #TMPCMDSCHEMES (PRODUCT_CODE,MRP,QUANTITY,ROW_ID,MODE,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,SCHEME_APPLIED_AMOUNT)
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=20


	IF @NGETFILTERMODE NOT IN (0,1)
		SELECT @CADDFILTER=@CORGADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''''
	ELSE
		SELECT @CADDFILTER=@CORGADDFILTER+' AND 1=1'			

	IF @BDONOTAPPLYSCHEMEONDISCITEMS=1
		SELECT @CADDFILTER=@CADDFILTER+' AND A.SCHEME_SETUP_DET_ROW_ID='''''
	
	SET @CCMD=N' SELECT A.PRODUCT_CODE,(A.NET-A.SCHEME_APPLIED_AMOUNT),(ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY)*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END),
				 A.CMD_ROW_ID AS ROW_ID,2 AS MODE,
				 0 AS DISCOUNT_AMOUNT,0,0 FROM #TMPCMD A
				 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTRGET+'
				 WHERE A.SCHEME_APPLIED_QTY=0 AND A.SCHEME_APPLIED_AMOUNT=0  AND '+@CGETFILTER+' AND '+@CADDFILTER
	
	PRINT @CCMD			 
	INSERT #TMPCMDSCHEMES (PRODUCT_CODE,MRP,QUANTITY,ROW_ID,MODE,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,SCHEME_APPLIED_AMOUNT)
	EXEC SP_EXECUTESQL @CCMD
	
	
	SET @NSTEP=25
	
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMDSCHEMES WHERE MODE=1)
	OR NOT EXISTS (SELECT TOP 1 * FROM #TMPCMDSCHEMES WHERE MODE=2)
		GOTO END_PROC
		
	SELECT @NORGBUYAMT= BUY_AMOUNT,@NBUYAMT=BUY_AMOUNT,@NGETAMT=DISCOUNT_AMOUNT,@NAPPLYMODE=VALUE_BASED_SCHEME_MODE
	FROM SCHEME_SETUP_DET
	WHERE ROW_ID=@CSCHEMEDETROWID


BEGIN TRY 					
	
	SELECT @NREQGETAMT=0,@NREQBUYAMT=0

		
	SET @NSTEP=30


	PRINT 'TRIAL#'+STR(@NTRIAL)	
	
	DECLARE @NPROCESSAMOUNT NUMERIC(10,2),@NAMOUNT NUMERIC(10,2)
LBLCHKBUY:
	SELECT @BQUALIFIED	= 0,@NREQBUYAMT=0
	
	SET @NPROCESSAMOUNT = @NORGBUYAMT

	IF @NTRIAL=3 AND @BGETCHECKED=0
		GOTO LBLCHKGET

	--IF @@SPID=53
	--	SELECT 'CHECK MTPCMDSCHEMES BEFORE BUY',@NTRIAL TRIAL_NO, @BQUALIFIED QUALIFIED,@NPROCESSAMOUNT PROCESSAMOUNT,* FROM #TMPCMDSCHEMES 

	SET @BLOOP=0		
	WHILE @BLOOP=0
	BEGIN
		
		SET @NLOOPCNT=1
		WHILE @NLOOPCNT<=2
		BEGIN
			SET @CCMDROWID=''
			IF @NLOOPCNT=1
				SELECT TOP 1 @NMRP=MRP,@CCMDROWID=ROW_ID FROM #TMPCMDSCHEMES WHERE MODE=1 AND MRP>=@NPROCESSAMOUNT AND ISNULL(PROCESSED,0)=0 ORDER BY MRP DESC
			ELSE
			IF @NTRIAL=1
				SELECT TOP 1 @NMRP=MRP,@CCMDROWID=ROW_ID FROM #TMPCMDSCHEMES WHERE MODE=1 AND  MRP<@NPROCESSAMOUNT AND ISNULL(PROCESSED,0)=0 ORDER BY MRP 
			ELSE
				SELECT TOP 1 @NMRP=MRP,@CCMDROWID=ROW_ID FROM #TMPCMDSCHEMES WHERE MODE=1 AND  MRP<@NPROCESSAMOUNT AND ISNULL(PROCESSED,0)=0 ORDER BY MRP DESC 

			IF ISNULL(@CCMDROWID,'')<>''
			BEGIN
				SET @NAMOUNT=(CASE WHEN @NREQBUYAMT+@NMRP>@NORGBUYAMT THEN @NORGBUYAMT-@NREQBUYAMT ELSE @NMRP END)
				SET @NREQBUYAMT=@NREQBUYAMT+@NAMOUNT									
				
				SET @NPROCESSAMOUNT=@NPROCESSAMOUNT-@NAMOUNT
				SET @NSTEP=50
				UPDATE #TMPCMDSCHEMES SET 
				SCHEME_APPLIED_AMOUNT=SCHEME_APPLIED_AMOUNT+@NAMOUNT,PROCESSED=1
				WHERE ROW_ID=@CCMDROWID 
		    
				PRINT '2:'+ STR(@NREQGETAMT)+STR(@NGETAMT)
		
				BREAK
			END
			
			SET @NLOOPCNT=@NLOOPCNT+1
		END										
		
						    
		IF @NREQBUYAMT>=@NORGBUYAMT
			SET @BQUALIFIED=1				

		IF @BQUALIFIED=1 OR ISNULL(@CCMDROWID,'')=''
			BREAK
		
		
	END


	
	--IF @@SPID=53
	--	SELECT 'CHECK MTPCMDSCHEMES AFTER BUY',@NTRIAL TRIAL_NO, @BQUALIFIED QUALIFIED,* FROM #TMPCMDSCHEMES 


	IF @BQUALIFIED=0 
	BEGIN
		IF @NTRIAL=1
		BEGIN
			SET @NTRIAL=@NTRIAL+1
			GOTO START_PROC
		END
		ELSE
			GOTO EXIT_PROC
	END
	
	--IF @@SPID=89 AND @CSLSTITLE='BUY 7999 GET 2000 OFF'
	--BEGIN
	--	SELECT @NTRIAL AS NTRIALCNT, @BQUALIFIED,'AFTER BUY #TMPCMDSCHEMES',@NBUYAMT AS NBUYAMT,@NORGBUYAMT AS NORGBUYAMT,@NREQBUYAMT AS NREQBUYAMT, * FROM #TMPCMDSCHEMES
	--	SELECT 'AFTER BUY PENDING #TMPCMDSCHEMES',PRODUCT_CODE,((MRP-SCHEME_APPLIED_AMOUNT)/QUANTITY),QUANTITY,ROW_ID,MODE FROM
	--	#TMPCMDSCHEMES WHERE MODE=2 AND (MRP-SCHEME_APPLIED_AMOUNT)<>0
	--END
	
LBLCHKGET:			

	IF @NTRIAL=3 AND @BGETCHECKED=1
	BEGIN
		GOTO EXIT_PROC
	END
	
	SELECT @BQUALIFIED=0,@NREQGETAMT=0
	
	UPDATE #TMPCMDSCHEMES SET PROCESSED=0 WHERE SCHEME_APPLIED_AMOUNT=0

	SET @NPROCESSAMOUNT = @NGETAMT

	SET @BLOOP=0		
	WHILE @BLOOP=0
	BEGIN
		
		SET @NLOOPCNT=1
		WHILE @NLOOPCNT<=2
		BEGIN
			SET @CCMDROWID=''
			IF @NLOOPCNT=1
				SELECT TOP 1 @NMRP=MRP,@CCMDROWID=ROW_ID FROM #TMPCMDSCHEMES WHERE MODE=2 AND  MRP>=@NPROCESSAMOUNT AND ISNULL(PROCESSED,0)=0 ORDER BY MRP DESC
			ELSE
				SELECT TOP 1 @NMRP=MRP,@CCMDROWID=ROW_ID FROM #TMPCMDSCHEMES WHERE MODE=2 AND  MRP<@NPROCESSAMOUNT AND ISNULL(PROCESSED,0)=0 ORDER BY MRP DESC
			
			IF ISNULL(@CCMDROWID,'')<>''
			BEGIN
				SET @BQUALIFIED=1

				SET @NAMOUNT=(CASE WHEN @NREQGETAMT+@NMRP>@NGETAMT THEN @NGETAMT-@NREQGETAMT ELSE @NMRP END)
				SET @NREQGETAMT=@NREQGETAMT+@NAMOUNT									
				
				SET @NPROCESSAMOUNT=@NPROCESSAMOUNT-@NAMOUNT
				SET @NSTEP=50
				UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=DISCOUNT_AMOUNT+@NAMOUNT
				WHERE ROW_ID=@CCMDROWID AND MODE=2

				UPDATE #TMPCMDSCHEMES SET 
				SCHEME_APPLIED_AMOUNT=SCHEME_APPLIED_AMOUNT+@NAMOUNT,PROCESSED=1
				WHERE ROW_ID=@CCMDROWID 
		    
				PRINT '2:'+ STR(@NREQGETAMT)+STR(@NGETAMT)

				BREAK
			END

			SET @NLOOPCNT=@NLOOPCNT+1
		END										
		
		IF @NREQGETAMT>=@NGETAMT OR ISNULL(@CCMDROWID,'')=''
			BREAK		
				
	END

	--IF @@SPID=53
	--	SELECT 'CHECK MTPCMDSCHEMES AFTER GET',@NTRIAL TRIAL_NO,@BQUALIFIED QUALIFIED,@BGETCHECKED GETCHECKED,* FROM #TMPCMDSCHEMES 

	IF @BQUALIFIED=0 
	BEGIN
		IF @NTRIAL<3
		BEGIN
			SET @NTRIAL=@NTRIAL+1
			GOTO START_PROC
		END
	END

	IF @NTRIAL=3 AND @BGETCHECKED=0
	BEGIN
		SET @BGETCHECKED=1
		GOTO LBLCHKBUY
	END
	
	--IF @@SPID=425
	--	SELECT @BQUALIFIED,@NTRIAL

	--IF @@SPID=89 AND @NTRIAL=1 AND @CSLSTITLE='BUY 7999 GET 2000 OFF'
	--BEGIN
	--	SELECT @NTRIAL AS TRIALCNT,@BQUALIFIED,'AFTER GET STATUS #TMPCMDSCHEMES',@NBUYAMT AS NBUYAMT,@NORGBUYAMT AS NORGBUYAMT,@NREQBUYAMT AS NREQBUYAMT, * FROM #TMPCMDSCHEMES
	--END
		
END TRY

BEGIN CATCH
  PRINT 'CATCH IN SP3S_EOSS_SCHEMES_9'       
  SET @CERRMSG='P:SP3S_EOSS_SCHEMES_9, STEP:'+LTRIM(RTRIM(STR(@NSTEP)))+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
END CATCH

EXIT_PROC:
		
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
		--IF @@SPID=89 AND @CSLSTITLE='BUY 7999 GET 2000 OFF'
		--BEGIN
		--	SELECT @BQUALIFIED AS QUALIFIED,'FINAL #TMPCMDSCHEMES',@BPROCESSSLRENTRY AS BPROCESSSLRENTRY,* FROM #TMPCMDSCHEMES
		--	SELECT @BQUALIFIED AS QUALIFIED, 'EOSS_SCHEME9 QUALIFY-4',@NREQBUYAMT AS NREQBUYAMT,@NORGBUYAMT AS	 NORGBUYAMT
		--END	
		
		IF @BQUALIFIED=0
		BEGIN
			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=0

		END	
		ELSE
		BEGIN
			SET @NSTEP=115
			
			DECLARE @CBNGNROWID VARCHAR(50)
			SET @CBNGNROWID=NEWID()
			
			DECLARE @NSUBTOTAL NUMERIC(10,2)
			
			--SELECT 'CHECK FINAL UPDATION',B.ROW_ID, DISCOUNT_AMOUNT=#TMPCMD.DISCOUNT_AMOUNT+(B.DISCOUNT_AMOUNT)*(CASE WHEN @BPROCESSSLRENTRY=1 THEN -1 ELSE 1 END),
			--SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSLSTITLE,SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
			--SCHEME_APPLIED_QTY=#TMPCMD.SCHEME_APPLIED_QTY+B.SCHEME_APPLIED_QTY,
			--BNGN_ROW_ID=@CBNGNROWID
			--FROM #TMPCMDSCHEMES B JOIN #TMPCMD ON #TMPCMD.CMD_ROW_ID=B.ROW_ID
			-- WHERE LTRIM(RTRIM(B.ROW_ID))=LTRIM(RTRIM(#TMPCMD.CMD_ROW_ID ))
			--AND ((MODE=2 AND B.DISCOUNT_AMOUNT<>0) OR B.SCHEME_APPLIED_QTY<>0)
			
			PRINT 'UPDATE FINAL DISCONT OF TOWEL-1'
			UPDATE #TMPCMD SET DISCOUNT_AMOUNT=#TMPCMD.DISCOUNT_AMOUNT+(B.DISCOUNT_AMOUNT)*
			(CASE WHEN @BPROCESSSLRENTRY=1 THEN -1 ELSE 1 END)
			FROM #TMPCMDSCHEMES B WHERE LTRIM(RTRIM(B.ROW_ID))=LTRIM(RTRIM(#TMPCMD.CMD_ROW_ID ))
			AND (MODE=2  AND B.DISCOUNT_AMOUNT<>0)
			
			PRINT 'UPDATE FINAL DISCONT OF TOWEL-2'
			UPDATE #TMPCMD SET BNGN_ROW_ID=@CBNGNROWID,SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
			SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSLSTITLE,
			SCHEME_APPLIED_AMOUNT=#TMPCMD.SCHEME_APPLIED_AMOUNT+B.SCHEME_APPLIED_AMOUNT FROM #TMPCMDSCHEMES B 
			WHERE LTRIM(RTRIM(B.ROW_ID))=LTRIM(RTRIM(#TMPCMD.CMD_ROW_ID ))
			AND B.SCHEME_APPLIED_AMOUNT<>0
							
			PRINT 'UPDATE FINAL DISCONT OF TOWEL-3'
			UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ABS(ROUND((DISCOUNT_AMOUNT/(MRP*QUANTITY))*100,3)),
			NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT
			
		
			--IF @@SPID=1519
			--	SELECT 'FINAL #TMPCMD2',@BQUALIFIED,* FROM #TMPCMD			
			
		END		

		IF @BPROCESSSLRENTRY=0 AND @CPICKSLRDISCMODE<>'3'
		BEGIN
			SET @BPROCESSSLRENTRY=1
			GOTO START_PROC
		END	
		ELSE
			GOTO END_PROC

	END	

END_PROC:
	PRINT 'FINISH SP3S_EOSS_SCHEMES_9'
END
----- END OF PROCEDURE SP3S_EOSS_SCHEMES_9
