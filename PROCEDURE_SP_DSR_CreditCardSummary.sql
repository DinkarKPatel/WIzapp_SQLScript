create PROCEDURE SP_DSR_CREDITCARDSUMMARY
(
	@DFROMDT DATETIME='', 
	@DTODT DATETIME='',
	@NVIEWMODE INT=1,
	@LPRINTDETAILS BIT=0,
	@BESTIMATEENABLED BIT = 1,
	@CDEPTID VARCHAR(5)='',
	@CUSERCODE VARCHAR(12)='',
	@CBINID		VARCHAR(10)=''
	
)
--WITH ENCRYPTION

AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 
/*
MODIFICATION HISTORY:
MODIFIED BY			: BABAN
MODIFICATION DATE	: 15 SEP 2014
DESCRIPTION			: BASED ON CONFIG SETTING, CASH MEMOS COULD BE FILTERED(VALID CASH MEMO (VALIDATED BY CASHIER)
					  AND INVALID CASH MEMO).
*/
	DECLARE @CMAJORDEPTID VARCHAR(5),@BDSM BIT
	SELECT TOP 1 @BDSM=VALUE FROM CONFIG WHERE CONFIG_OPTION='OPEN_CASHIER_FOR_CASHMEMOS'
	SET @BDSM=ISNULL(@BDSM,0)	
	SELECT @CMAJORDEPTID=MAJOR_DEPT_ID FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CDEPTID

	SET @CMAJORDEPTID=ISNULL(@CMAJORDEPTID,'')


	PRINT @DFROMDT
	PRINT @DTODT
	--@DTODT  SET @NVIEWMODE = 3		-- 1- CLUBBED, 2- LOCATION WISE, 3- USER WISE

	--****** SUMMARIZED VIEW
	DECLARE @REP_SUMMARY TABLE ( DEPT_ID VARCHAR(4), USER_CODE VARCHAR(10), 
								 PRINT_GROUP INT, PRINT_ORDER INT,CC_NAME VARCHAR(50), PRINT_DETAIL VARCHAR(50),
								 AMOUNT NUMERIC(10,2) )
	 
	-- SLS SUMMARY
	INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER,CC_NAME , PRINT_DETAIL, AMOUNT )
	SELECT	a.location_Code  AS DEPT_ID, 
			A.USER_CODE,
			1 AS PRINT_GROUP,
			1 AS PRINT_ORDER,
			PAY1.PAYMODE_NAME AS CC_NAME,
			'FROM SALES' AS PRINT_DETAIL,
			PAY.AMOUNT AS AMOUNT
	FROM CMM01106 A  
	JOIN PAYMODE_XN_DET PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'SLS'
	JOIN PAYMODE_MST PAY1 ON PAY1.PAYMODE_CODE = PAY.PAYMODE_CODE
	JOIN PAYMODE_GRP_MST PAY2 ON PAY2.PAYMODE_GRP_CODE=PAY1.PAYMODE_GRP_CODE
	LEFT JOIN 
	(
		SELECT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON A.CM_ID=DSD.CM_ID
	WHERE A.CANCELLED = 0 AND PAY2.PAYMODE_GRP_CODE='0000002'
	AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)    
	AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)
	AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE
	AND A.CM_DT BETWEEN @DFROMDT AND @DTODT 
	AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END) 
	AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	

	-- RECEIPTS / PAYMENTS SUMMARY
	INSERT @REP_SUMMARY ( DEPT_ID, USER_CODE, PRINT_GROUP, PRINT_ORDER,CC_NAME , PRINT_DETAIL, AMOUNT )
	SELECT	a.location_Code  AS DEPT_ID,
			A.USER_CODE,
			1 AS PRINT_GROUP,
			2 AS PRINT_ORDER,
			PAY1.PAYMODE_NAME AS CC_NAME,
			(CASE WHEN A.ARC_TYPE = 1 AND A.ARCT = 1 THEN 'FROM O/S RECEIPTS'
				  WHEN A.ARC_TYPE = 1 AND A.ARCT = 2 THEN 'FROM ADVANCES'
				  WHEN A.ARC_TYPE = 1 AND A.ARCT = 3 THEN 'FROM CHARGES/FEES'
				  WHEN A.ARC_TYPE = 2 THEN 'PAYMENT TO CUSTOMERS'
			 ELSE '' END) AS PRINT_DETAIL,
			(ISNULL(PAY.AMOUNT,0)*(CASE WHEN A.ARC_TYPE = 2 THEN -1 ELSE 1 END)) AS AMOUNT
	FROM ARC01106 A  
	--LEFT OUTER JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.ADV_REC_ID AND PAY.XN_TYPE = 'ARC'
	JOIN PAYMODE_XN_DET PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'ARC'
	JOIN PAYMODE_MST PAY1 ON PAY1.PAYMODE_CODE = PAY.PAYMODE_CODE
	JOIN PAYMODE_GRP_MST PAY2 ON PAY2.PAYMODE_GRP_CODE=PAY1.PAYMODE_GRP_CODE
	WHERE A.CANCELLED = 0 AND PAY2.PAYMODE_GRP_CODE='0000002'
	AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)    
	AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)
	AND A.ADV_REC_DT BETWEEN @DFROMDT AND @DTODT 
	AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END) 




	DECLARE @REP_DETAILS TABLE (PRINT_ORDER INT, PRINT_DETAIL VARCHAR(100), 
								DEPT_ID VARCHAR(4), USER_CODE VARCHAR(10), MEMO_NO VARCHAR(50), 
								MEMO_DT DATETIME, ADJ_MEMO_NO VARCHAR(50), ADJ_MEMO_DT DATETIME, 
								AMOUNT NUMERIC(10,2), CUSTOMER_NAME VARCHAR(200), 
								BILL_AMOUNT NUMERIC(10,2),CC_NAME VARCHAR(50) )

	IF @LPRINTDETAILS = 1
	BEGIN
		-- LIST OF CREDIT BILLS
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_NAME, BILL_AMOUNT,CC_NAME )
		SELECT	1 AS PRINT_ORDER, '' AS PRINT_DETAIL,
				a.location_Code  AS DEPT_ID, A.USER_CODE,
				A.CM_NO AS MEMO_NO, A.CM_DT AS MEMO_DT,
				'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,
				PAY.AMOUNT AS AMOUNT,
				C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,
				A.NET_AMOUNT AS BILL_AMOUNT,PAY1.PAYMODE_NAME AS [CC_NAME]
		FROM CMM01106 A
		JOIN PAYMODE_XN_DET PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'SLS'
		JOIN PAYMODE_MST PAY1 ON PAY1.PAYMODE_CODE = PAY.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PAY2 ON PAY2.PAYMODE_GRP_CODE=PAY1.PAYMODE_GRP_CODE
		JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		LEFT JOIN 
		(
			SELECT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
			WHERE DSM.CANCELLED=0
		)DSD ON A.CM_ID=DSD.CM_ID
		WHERE A.CANCELLED = 0 AND PAY2.PAYMODE_GRP_CODE='0000002'
		AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)         
		AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)
		AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE
		AND   A.CM_DT BETWEEN @DFROMDT AND @DTODT 
		AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END) 
		AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	
		ORDER BY A.CM_DT, A.CM_NO

		-- LIST OF CREDIT NOTES ADJUSTED IN RECEIPT
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_NAME, BILL_AMOUNT,CC_NAME )
		SELECT	7 AS PRINT_ORDER, 'LIST OF CN ADJUSTED IN RECEIPT' AS PRINT_DETAIL,
				a.location_Code  AS DEPT_ID, A.USER_CODE,
				A.ADV_REC_NO AS MEMO_NO, A.ADV_REC_DT AS MEMO_DT,  
				'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,
				PAY.AMOUNT, 
				C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,
				A.NET_AMOUNT AS BILL_AMOUNT,PAY1.PAYMODE_NAME AS [CC_NAME]
		FROM ARC01106 A
		JOIN PAYMODE_XN_DET PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'ARC'
		JOIN PAYMODE_MST PAY1 ON PAY1.PAYMODE_CODE = PAY.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PAY2 ON PAY2.PAYMODE_GRP_CODE=PAY1.PAYMODE_GRP_CODE
		JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		WHERE A.CANCELLED = 0 AND PAY2.PAYMODE_GRP_CODE='0000002'
		AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)         
		AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)
		AND   A.ADV_REC_DT BETWEEN @DFROMDT AND @DTODT 
		AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END) 
		-- LIST OF ADVANCES IN RECEIPT  
		--BY MANISH TO CONSIDER ADVANCES AND OUTSTANDINGS
--		
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_NAME, BILL_AMOUNT,CC_NAME )
		SELECT	 8 AS PRINT_ORDER, 'LIST OF ADVANCES IN RECEIPT' AS PRINT_DETAIL,
				ISNULL(A.BIN_ID, a.location_Code ) AS DEPT_ID, A.USER_CODE,
				 A.ADV_REC_NO AS MEMO_NO,A.ADV_REC_DT AS MEMO_DT  ,
				'' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,
				PAY.AMOUNT, 
				C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,
				A.NET_AMOUNT AS BILL_AMOUNT,PAY1.PAYMODE_NAME AS [CC_NAME]
		FROM ARC01106 A
		JOIN PAYMODE_XN_DET PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'ARC'
		JOIN PAYMODE_MST PAY1 ON PAY1.PAYMODE_CODE = PAY.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PAY2 ON PAY2.PAYMODE_GRP_CODE=PAY1.PAYMODE_GRP_CODE
		JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		WHERE A.CANCELLED = 0 AND PAY2.PAYMODE_GRP_CODE='0000002'
		AND ISNULL(A.ADV_REC_DT,'') BETWEEN @DFROMDT AND @DTODT
		AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)         
		AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)
		AND A.ARCT = 2 
		AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END) 
		
		INSERT @REP_DETAILS (PRINT_ORDER, PRINT_DETAIL, DEPT_ID, USER_CODE, 
							 MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
							 AMOUNT, CUSTOMER_NAME, BILL_AMOUNT,CC_NAME )
		SELECT	 9 AS PRINT_ORDER, 'LIST OF OUTSTANDING IN RECEIPT' AS PRINT_DETAIL,
				ISNULL(A.BIN_ID, a.location_Code ) AS DEPT_ID, A.USER_CODE,
				 A.ADV_REC_NO AS MEMO_NO,A.ADV_REC_DT AS MEMO_DT  ,
				DBO.FN_GETAGAINSTBILL(A.ADV_REC_ID) AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT,
				PAY.AMOUNT, 
				C.CUSTOMER_FNAME + ' ' + C.CUSTOMER_LNAME AS CUSTOMER_NAME,
				A.NET_AMOUNT AS BILL_AMOUNT,PAY1.PAYMODE_NAME AS [CC_NAME]
		FROM ARC01106 A
		JOIN PAYMODE_XN_DET PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'ARC'
		JOIN PAYMODE_MST PAY1 ON PAY1.PAYMODE_CODE = PAY.PAYMODE_CODE
		JOIN PAYMODE_GRP_MST PAY2 ON PAY2.PAYMODE_GRP_CODE=PAY1.PAYMODE_GRP_CODE
		JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE
		WHERE A.CANCELLED = 0 AND PAY2.PAYMODE_GRP_CODE='0000002'
		AND ISNULL(A.ADV_REC_DT,'') BETWEEN @DFROMDT AND @DTODT 
		AND a.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN a.location_Code  ELSE @CMAJORDEPTID END)         
		AND A.BIN_ID=(CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)
		AND A.ARC_TYPE=1 AND A.ARCT = 1 AND A.CANCELLED = 0
		AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END) 
	    
	END
	--SELECT * FROM @REP_DETAILS A
	IF @NVIEWMODE = 1			-- CLUBBED
		SELECT	'' AS DEPT_ID, '' AS DEPT_NAME, '' AS USER_CODE, '' AS USERNAME, 
				1 AS MAJOR_PRINT_GROUP, A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL,
				'' AS MEMO_NO, '' AS MEMO_DT, '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT, 
				SUM(AMOUNT) AS AMOUNT, '' AS CUSTOMER_NAME, 0 AS BILL_AMOUNT,A.CC_NAME
		FROM @REP_SUMMARY A
		JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID
		--WHERE B.INACTIVE = 0
		GROUP BY A.PRINT_GROUP, A.PRINT_ORDER,A.CC_NAME, A.PRINT_DETAIL
		UNION ALL 
		SELECT	'' DEPT_ID, ''  AS DEPT_NAME, '' AS USER_CODE, '' AS USERNAME, 
				2 AS MAJOR_PRINT_GROUP, PRINT_ORDER AS PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, 
				MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
				AMOUNT, CUSTOMER_NAME, BILL_AMOUNT,CC_NAME
		FROM @REP_DETAILS A
		JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID
		--WHERE B.INACTIVE = 0 
		ORDER BY  MAJOR_PRINT_GROUP, PRINT_GROUP, PRINT_ORDER, MEMO_DT, MEMO_NO

	IF @NVIEWMODE = 2			-- LOCATION WISE
		SELECT	A.DEPT_ID, B.DEPT_NAME AS DEPT_NAME, '' AS USER_CODE, '' AS USERNAME, 
				1 AS MAJOR_PRINT_GROUP, A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL, 
				'' AS MEMO_NO, '' AS MEMO_DT, '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT, 
				SUM(AMOUNT) AS AMOUNT, '' AS CUSTOMER_NAME, 0 AS BILL_AMOUNT,A.CC_NAME
		FROM @REP_SUMMARY A
		JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID
		--WHERE B.INACTIVE = 0
		GROUP BY  A.DEPT_ID, B.DEPT_NAME,A.PRINT_GROUP, A.PRINT_ORDER,A.CC_NAME, A.PRINT_DETAIL
		UNION ALL

		SELECT	A.DEPT_ID, B.DEPT_NAME  AS DEPT_NAME, '' AS USER_CODE, '' AS USERNAME, 
				2 AS MAJOR_PRINT_GROUP, PRINT_ORDER AS PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, 
				MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
				AMOUNT, CUSTOMER_NAME, BILL_AMOUNT,CC_NAME
		FROM @REP_DETAILS A
		JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID
		--WHERE B.INACTIVE = 0
		ORDER BY DEPT_ID, USERNAME, MAJOR_PRINT_GROUP, PRINT_GROUP, PRINT_ORDER, MEMO_DT, MEMO_NO

	IF @NVIEWMODE = 3			-- USER WISE
		SELECT	A.DEPT_ID, B.DEPT_NAME AS DEPT_NAME, A.USER_CODE, C.USERNAME AS USERNAME, 
				1 AS MAJOR_PRINT_GROUP, A.PRINT_GROUP, A.PRINT_ORDER, A.PRINT_DETAIL, 
				'' AS MEMO_NO, '' AS MEMO_DT, '' AS ADJ_MEMO_NO, '' AS ADJ_MEMO_DT, 
				SUM(AMOUNT) AS AMOUNT, '' AS CUSTOMER_NAME, 0 AS BILL_AMOUNT,A.CC_NAME
		FROM @REP_SUMMARY A
		JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID
		JOIN USERS C ON A.USER_CODE = C.USER_CODE
		--WHERE B.INACTIVE = 0
		GROUP BY A.DEPT_ID, B.DEPT_NAME,A.USER_CODE, C.USERNAME, A.PRINT_GROUP, A.PRINT_ORDER,A.CC_NAME, A.PRINT_DETAIL
		UNION ALL
		SELECT	A.DEPT_ID, B.DEPT_NAME AS DEPT_NAME, A.USER_CODE, C.USERNAME, 
				2 AS MAJOR_PRINT_GROUP, PRINT_ORDER AS PRINT_GROUP, PRINT_ORDER, PRINT_DETAIL, 
				MEMO_NO, MEMO_DT, ADJ_MEMO_NO, ADJ_MEMO_DT, 
				AMOUNT, CUSTOMER_NAME, BILL_AMOUNT,CC_NAME
		FROM @REP_DETAILS A
		JOIN LOCATION B ON A.DEPT_ID = B.DEPT_ID
		JOIN USERS C ON A.USER_CODE = C.USER_CODE
		--WHERE B.INACTIVE = 0
		ORDER BY DEPT_ID, USERNAME, MAJOR_PRINT_GROUP, PRINT_GROUP, PRINT_ORDER, MEMO_DT, MEMO_NO


END
--**************************************** END OF PROCEDURE SP_DSR_CREDITCARDSUMMARY
