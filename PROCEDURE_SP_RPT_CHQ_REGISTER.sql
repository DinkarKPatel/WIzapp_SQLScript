CREATE PROC SP_RPT_CHQ_REGISTER
(
	@CAC_CODE	VARCHAR(20),
	@DTFROM		DATETIME,
	@DTTO		DATETIME
)
AS
BEGIN

	SELECT E.AC_NAME AS BANK_NAME, A.CHQ_BOOK_ID,D.CHQ_SR_NO,D.REMARKS AS REMARKS_M, BANK_AC_CODE,CHQ_LEAF_NO,
	(CASE WHEN V.VOUCHER_DT ='' THEN '' ELSE ISNULL(CONVERT(VARCHAR(10),V.VOUCHER_DT,105),'') END) AS ISSUE_DT, 
	(CASE WHEN B.RECON_DT ='' THEN '' ELSE ISNULL(CONVERT(VARCHAR(10),B.RECON_DT,105),'') END) AS  CLG_DT, 
	CAST((ISNULL(B.CREDIT_AMOUNT,0)+ISNULL(B.DEBIT_AMOUNT,0)) AS NUMERIC(14,2)) AS CHQ_AMOUNT, 
	(CASE WHEN A.CANCELLED=0 THEN A.REMARKS ELSE 'CANCELLED' END ) AS [REMARKS], VD.VD_ID, A.CANCELLED, 
	A.ROW_ID, A.LAST_UPDATE, 
	A.COMPANY_CODE,CAST(0 AS BIT) AS CHKCANCEL,ISNULL(B.NARRATION,'') AS NARRATION,
	ISNULL(PR.PRINT_NAME,ISNULL(C.AC_NAME,'')) AS AC_NAME
	FROM CHQBOOK_D A (NOLOCK)
	LEFT OUTER JOIN VD_CHQBOOK VD ON VD.CHQBOOK_ROW_ID=A.ROW_ID 
	JOIN CHQBOOK_M D (NOLOCK) ON D.CHQ_BOOK_ID=A.CHQ_BOOK_ID
	JOIN LM01106 E (NOLOCK) ON E.AC_CODE=A.BANK_AC_CODE
	JOIN 
	(
		SELECT CHQ_BOOK_ID, MIN(CHQ_LEAF_NO) AS [MIN_CHQ_LEAF_NO],MAX(CHQ_LEAF_NO) AS [MAX_CHQ_LEAF_NO]
		FROM CHQBOOK_D A (NOLOCK)
		LEFT OUTER JOIN VD_CHQBOOK D ON D.CHQBOOK_ROW_ID=A.ROW_ID 
		LEFT OUTER JOIN VD01106 B  (NOLOCK) ON B.VD_ID=D.VD_ID
		LEFT OUTER JOIN VM01106 V  (NOLOCK) ON B.VM_ID=V.VM_ID
		WHERE V.VOUCHER_DT BETWEEN @DTFROM AND @DTTO
		AND A.BANK_AC_CODE= @CAC_CODE
		GROUP BY CHQ_BOOK_ID
	)X ON X.CHQ_BOOK_ID=A.CHQ_BOOK_ID
	LEFT OUTER JOIN VD01106 B (NOLOCK) ON B.VD_ID=VD.VD_ID
	LEFT OUTER JOIN VM01106 V  (NOLOCK) ON B.VM_ID=V.VM_ID 
	LEFT OUTER JOIN LM01106 C (NOLOCK) ON C.AC_CODE=B.VS_AC_CODE
	LEFT OUTER JOIN LM_PRINTNAME PR (NOLOCK) ON PR.ROW_ID=VD.REF_ROW_ID
	WHERE A.CHQ_LEAF_NO BETWEEN X.MIN_CHQ_LEAF_NO AND X.MAX_CHQ_LEAF_NO
	AND ((V.VOUCHER_DT='' OR  V.VOUCHER_DT BETWEEN @DTFROM AND @DTTO)
	 OR A.CANCELLED=1) 
	ORDER BY BANK_AC_CODE,A.CHQ_BOOK_ID, CHQ_LEAF_NO,V.VOUCHER_DT
END
