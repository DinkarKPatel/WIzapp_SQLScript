CREATE PROCEDURE UPDATERFNET
		@CXNTYPE VARCHAR(10),
		@CXNID VARCHAR(40) = '',
		@NSPID INT = 0,
		@BCALLEDFROMSAVEBILL BIT=0
--WITH ENCRYPTION
		--*** PARAMETERS :
		--*** @CXNTYPE	- TRANSACTION TYPE (MODULE SPECIFIC)
		--*** @CXNID	- TRANSACTION ID ( MEMO ID OF MASTER TABLE )
AS
BEGIN
	DECLARE @CCMD NVARCHAR(4000), 
			@CMEMOID VARCHAR(40), 
			@NSUBTOTAL NUMERIC(14,2),
			@NSUMRFNET NUMERIC(14,2),
			@NSUMRFNETWT NUMERIC(14,2),
			@NTAX NUMERIC(14,2),
			@NINCLTAX NUMERIC(10,2),
			@CROWID VARCHAR(40),
			@NEXCLTAX NUMERIC(10,2),
			@NROUNDOFF NUMERIC(10,2)
	
	--*** UPDATION OF RFNET FOR PUR
	IF @CXNTYPE IN ('PUR')		-- PURCHASE INVOICE
	BEGIN
		IF @CXNID <> ''
		    BEGIN
		        --ADD BELOW LINE ON 1-APRIL-2017
				UPDATE PID01106 SET RFNET = 0  WHERE MRR_ID = @CXNID 
				DECLARE ABC CURSOR FOR SELECT MRR_ID, (TOTAL_AMOUNT) FROM PIM01106 WHERE MRR_ID = @CXNID 
			END
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR SELECT MRR_ID, (TOTAL_AMOUNT) FROM PIM01106
				WHERE MRR_ID IN ( SELECT XN_ID FROM XNNOS WHERE XN_TYPE = 'PUR' AND SP_ID = @NSPID )
			ELSE
				DECLARE ABC CURSOR FOR SELECT DISTINCT A.MRR_ID, (B.TOTAL_AMOUNT) FROM PID01106 A
				JOIN PIM01106 B ON A.MRR_ID=B.MRR_ID WHERE A.PURCHASE_PRICE<>0 AND ( A.RFNET IS NULL OR A.RFNET = 0 OR A.RFNET_WOTAX IS NULL OR A.RFNET_WOTAX=0) 
		END

		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		WHILE @@FETCH_STATUS = 0
		BEGIN
			PRINT 'UPDATING RFNET FOR MRR ID : '+@CMEMOID
			
			SELECT TOP 1 @CROWID = ROW_ID FROM PID01106 WHERE MRR_ID = @CMEMOID
           --IN BELOW QUERY ADD POSTTAXDISCOUNTAMOUNT COLUMN ON 1 APRIL - 2017 
			UPDATE PID01106 SET RFNET =
			DBO.FN_GETRFNETVALUE( A.PURCHASE_PRICE+
			CASE WHEN B.BILL_LEVEL_TAX_METHOD=1 THEN  (A.TAX_AMOUNT/A.INVOICE_QUANTITY)
			+(ISNULL(A.IGST_AMOUNT,0)/A.INVOICE_QUANTITY)+(ISNULL(A.CGST_AMOUNT,0)/A.INVOICE_QUANTITY)+(ISNULL(A.SGST_AMOUNT,0)/A.INVOICE_QUANTITY)
			+(ISNULL(A.Gst_Cess_Amount ,0)/A.INVOICE_QUANTITY) 
			ELSE 0 END
			, A.INVOICE_QUANTITY, B.SUBTOTAL,
			( 
			--D.TAX_AMOUNT + 
			B.FREIGHT + 
			ISNULL(B.FREIGHT_IGST_AMOUNT ,0)+ISNULL(B.FREIGHT_CGST_AMOUNT ,0)+ISNULL(B.FREIGHT_SGST_AMOUNT ,0)+
			B.OTHER_CHARGES + 
			ISNULL(B.OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_CGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_SGST_AMOUNT ,0)+
			B.ROUND_OFF - B.DISCOUNT_AMOUNT- ISNULL(B.POSTTAXDISCOUNTAMOUNT,0)+B.EXCISE_DUTY_AMOUNT))
			FROM PID01106 A
			JOIN PIM01106 B ON A.MRR_ID = B.MRR_ID
			JOIN SKU C ON C.PRODUCT_CODE=A.PRODUCT_CODE
			--JOIN (SELECT SUM(TAX_AMOUNT) AS TAX_AMOUNT FROM PID01106 WHERE MRR_ID = @CMEMOID) D ON 1=1			
			WHERE B.MRR_ID = @CMEMOID AND A.INVOICE_QUANTITY<>0

			SELECT @NSUMRFNET = SUM(RFNET), @NSUMRFNETWT = SUM(RFNET_WOTAX)
			FROM PID01106 A WHERE A.MRR_ID = @CMEMOID
			
			
			IF @NSUMRFNET <> @NSUBTOTAL
				UPDATE PID01106 SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE MRR_ID = @CMEMOID AND ROW_ID = @CROWID

			--IF @NSUMRFNETWT <> ( @NSUBTOTAL - @NTAX )
			--BEGIN
			--	UPDATE PID01106 SET RFNET_WOTAX = RFNET_WOTAX + ( @NSUBTOTAL - @NTAX - @NSUMRFNETWT ) 
			--	WHERE MRR_ID = @CMEMOID AND ROW_ID = @CROWID
			--END

			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		END
		CLOSE ABC
		DEALLOCATE ABC
	END				-- END OF PUR
	
	ELSE
	--*** UPDATION OF RFNET FOR RETAIL SALES
	IF @CXNTYPE IN ('SLS')
	BEGIN
	    --OTHER CHARGES GST WAS ADDING TO RFNET OF ANY OF ONE ITEM IN DETAIL TABLE HANCE
		IF @CXNID <> ''
			DECLARE ABC CURSOR FOR 
			--SELECT CM_ID, (NET_AMOUNT-ATD_CHARGES-ROUND_OFF ) FROM CMM01106 WHERE CM_ID = @CXNID 
			SELECT CM_ID, (NET_AMOUNT-(ISNULL(OTHER_CHARGES_TAXABLE_VALUE,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_IGST_AMOUNT,0))-ROUND_OFF ) 
			FROM CMM01106 WHERE CM_ID = @CXNID
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR 
				--SELECT CM_ID, (NET_AMOUNT-(ATD_CHARGES)-ROUND_OFF ) FROM CMM01106
				SELECT CM_ID, (NET_AMOUNT-(ISNULL(OTHER_CHARGES_TAXABLE_VALUE,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_IGST_AMOUNT,0))-ROUND_OFF ) 
				FROM CMM01106
				WHERE CM_ID IN ( SELECT XN_ID FROM XNNOS WHERE XN_TYPE = 'SLS' AND SP_ID = @NSPID )
			ELSE
				DECLARE ABC CURSOR FOR 
				--SELECT DISTINCT A.CM_ID, (B.NET_AMOUNT-B.ATD_CHARGES-B.ROUND_OFF) FROM CMD01106 A
				SELECT DISTINCT A.CM_ID, (B.NET_AMOUNT-(ISNULL(B.OTHER_CHARGES_TAXABLE_VALUE,0)+ISNULL(B.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(B.OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(B.OTHER_CHARGES_IGST_AMOUNT,0))-B.ROUND_OFF) FROM CMD01106 A
				JOIN CMM01106 B ON A.CM_ID=B.CM_ID WHERE A.NET<>0 AND ( A.RFNET IS NULL OR A.RFNET = 0 ) 
		END

		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SELECT TOP 1 @CROWID = ROW_ID FROM CMD01106 WHERE CM_ID = @CMEMOID
			
			IF @BCALLEDFROMSAVEBILL=0
				UPDATE CMD01106 SET RFNET = NET-CMM_DISCOUNT_AMOUNT+(CASE WHEN TAX_METHOD=2 THEN TAX_AMOUNT+
				ISNULL(IGST_AMOUNT,0)+ISNULL(CGST_AMOUNT,0)+ISNULL(SGST_AMOUNT,0)+ISNULL(Gst_Cess_Amount ,0)  ELSE 0 END)
				WHERE CM_ID = @CMEMOID
					
			SELECT @NSUMRFNET = SUM(RFNET)	 			
			FROM CMD01106 WHERE CM_ID = @CMEMOID
			
			IF @NSUMRFNET <> @NSUBTOTAL
				UPDATE CMD01106 SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE CM_ID = @CMEMOID AND ROW_ID = @CROWID

			UPDATE CMD01106 SET REALIZE_SALE = (CASE WHEN (REALIZE_SALE=0 OR  MRP = OLD_MRP) THEN  ISNULL(RFNET,0) ELSE REALIZE_SALE END)
			WHERE CM_ID = @CMEMOID

			UPDATE CMD01106 SET OLD_MRP = (CASE WHEN OLD_MRP=0 THEN MRP ELSE OLD_MRP END)
			WHERE CM_ID = @CMEMOID

			

			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		END
		CLOSE ABC
		DEALLOCATE ABC
	END				-- END OF RETAIL SALES
	ELSE
	--*** UPDATION OF RFNET FOR APPROVAL ISSUE
	IF @CXNTYPE IN ('APP')
	BEGIN
		
		IF @CXNID <> ''
			DECLARE ABC CURSOR FOR SELECT MEMO_ID, (NET_AMOUNT-ATD_CHARGES ) FROM APM01106 WHERE MEMO_ID = @CXNID 
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR SELECT MEMO_ID, (NET_AMOUNT-(ATD_CHARGES) ) FROM APM01106
				WHERE MEMO_ID IN ( SELECT XN_ID FROM XNNOS WHERE XN_TYPE = 'APP' AND SP_ID = @NSPID )
			ELSE
				DECLARE ABC CURSOR FOR SELECT DISTINCT A.MEMO_ID, (B.NET_AMOUNT-B.ATD_CHARGES) FROM APD01106 A
				JOIN APM01106 B ON A.MEMO_ID=B.MEMO_ID WHERE A.NET<>0 AND ( A.RFNET IS NULL OR A.RFNET = 0 ) 
		END

		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SELECT TOP 1 @CROWID = ROW_ID FROM APD01106 WHERE MEMO_ID = @CMEMOID

			SELECT @NEXCLTAX=0
			
			SET @NEXCLTAX=ISNULL(@NEXCLTAX,0)
			
			UPDATE APD01106 SET RFNET =
			DBO.FN_GETRFNETVALUE( A.NET ,1,B.SUBTOTAL,- B.DISCOUNT_AMOUNT+B.ROUND_OFF)
			FROM APD01106 A
			JOIN APM01106 B ON A.MEMO_ID = B.MEMO_ID 
			WHERE B.MEMO_ID  = @CMEMOID

			SELECT @NSUMRFNET = SUM(RFNET)	 			
			FROM APD01106 WHERE MEMO_ID = @CMEMOID
			
			IF @NSUMRFNET <> @NSUBTOTAL
				UPDATE APD01106 SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE MEMO_ID = @CMEMOID AND ROW_ID = @CROWID

			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		END
		CLOSE ABC
		DEALLOCATE ABC
	END				-- END OF APPROVAL ISSUE
	ELSE
	--*** UPDATION OF RFNET FOR PURCHASE RETURN
	IF @CXNTYPE IN ('PRT')	
	BEGIN
		IF @CXNID <> ''
			DECLARE ABC CURSOR FOR SELECT RM_ID, (TOTAL_AMOUNT) FROM RMM01106 WHERE RM_ID = @CXNID 
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR SELECT RM_ID, (TOTAL_AMOUNT) FROM RMM01106
				WHERE RM_ID IN ( SELECT XN_ID FROM XNNOS WHERE XN_TYPE = 'PRT' AND SP_ID = @NSPID )
			ELSE
				DECLARE ABC CURSOR 
				FOR 
				SELECT DISTINCT A.RM_ID, (B.TOTAL_AMOUNT) 
				FROM RMD01106 A
				JOIN RMM01106 B ON A.RM_ID=B.RM_ID 
				WHERE A.PURCHASE_PRICE<>0 
				AND ( A.RFNET IS NULL OR A.RFNET = 0 )--OR A.RFNET_WOTAX IS NULL OR A.RFNET_WOTAX=0) 
		END

		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SELECT TOP 1 @CROWID = ROW_ID FROM RMD01106 WHERE RM_ID = @CMEMOID
			
			--SELECT @NTAX=SUM(ITEM_TAX_AMOUNT) FROM RMD01106 WHERE RM_ID=@CMEMOID

			UPDATE RMD01106 SET RFNET =
			DBO.FN_GETRFNETVALUE( A.PURCHASE_PRICE-ISNULL(PRTAMOUNT,0)+
			CASE WHEN A.BILL_LEVEL_TAX_METHOD=1 THEN  (A.ITEM_TAX_AMOUNT/A.INVOICE_QUANTITY)
			+(ISNULL(A.IGST_AMOUNT,0)/A.INVOICE_QUANTITY)+(ISNULL(A.CGST_AMOUNT,0)/A.INVOICE_QUANTITY)+(ISNULL(A.SGST_AMOUNT,0)/A.INVOICE_QUANTITY) 
			+(ISNULL(A.Gst_Cess_Amount ,0)/A.INVOICE_QUANTITY)
			ELSE 0 END
			, A.QUANTITY, B.SUBTOTAL,
			( 
			--ISNULL(@NTAX,0) + 
			B.FREIGHT + 
			ISNULL(B.FREIGHT_IGST_AMOUNT ,0)+ISNULL(B.FREIGHT_CGST_AMOUNT ,0)+ISNULL(B.FREIGHT_SGST_AMOUNT ,0)+
			B.OTHER_CHARGES + 
			ISNULL(B.OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_CGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_SGST_AMOUNT ,0)+
			B.ROUND_OFF - B.DISCOUNT_AMOUNT ))
			--,
			--RFNET_WOTAX = DBO.FN_GETRFNETVALUE( A.PURCHASE_PRICE, A.QUANTITY, B.SUBTOTAL,
			--( B.FREIGHT + B.OTHER_CHARGES + B.ROUND_OFF - B.DISCOUNT_AMOUNT ))  
			FROM RMD01106 A
			JOIN RMM01106 B ON A.RM_ID = B.RM_ID
			JOIN SKU C ON C.PRODUCT_CODE=A.PRODUCT_CODE
			JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE
			JOIN UOM D ON D.UOM_CODE=ART.UOM_CODE
			WHERE B.RM_ID = @CMEMOID

			SELECT @NSUMRFNET = SUM(RFNET) FROM RMD01106 WHERE RM_ID = @CMEMOID
				--, @NSUMRFNETWT = SUM(RFNET_WOTAX)
			IF @NSUMRFNET <> @NSUBTOTAL
				UPDATE RMD01106 SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE RM_ID = @CMEMOID AND ROW_ID = @CROWID

			--IF @NSUMRFNETWT <> ( @NSUBTOTAL - @NTAX )
			--	UPDATE RMD01106 SET RFNET_WOTAX = RFNET_WOTAX + ( @NSUBTOTAL - @NTAX - @NSUMRFNETWT ) 
			--	WHERE RM_ID = @CMEMOID AND ROW_ID = @CROWID


			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		END
		CLOSE ABC
		DEALLOCATE ABC  -- END OF PURCHASE RETURN
	END					

	ELSE
	--*** UPDATION OF RFNET FOR WHOLESALE CUSTOMER ORDER
	IF @CXNTYPE IN ('WOD')		
	BEGIN
		IF @CXNID <> ''
			DECLARE ABC CURSOR FOR SELECT A.ORDER_ID, TOTAL_AMOUNT,TAX_AMOUNT
			FROM WSL_ORDER_DET A JOIN WSL_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID 
			WHERE A.ORDER_ID = @CXNID 
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR SELECT A.ORDER_ID, TOTAL_AMOUNT,TAX_AMOUNT
				FROM WSL_ORDER_DET A JOIN WSL_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID 
				WHERE A.ORDER_ID IN ( SELECT XN_ID FROM XNNOS WHERE XN_TYPE = 'WSL' AND SP_ID = @NSPID ) 
			ELSE
				DECLARE ABC CURSOR FOR SELECT A.ORDER_ID, TOTAL_AMOUNT,TAX_AMOUNT
				FROM WSL_ORDER_DET A JOIN WSL_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
				WHERE A.WS_PRICE<>0 AND ( A.RFNET IS NULL OR A.RFNET = 0) 
		END
		
		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL, @NTAX
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SELECT TOP 1 @CROWID = ROW_ID FROM WSL_ORDER_DET WHERE ORDER_ID = @CMEMOID AND CANCELLED=0

			UPDATE A SET RFNET =
				DBO.FN_GETRFNETVALUE( A.WS_PRICE, A.QUANTITY, B.SUBTOTAL,( ISNULL(@NTAX,0) + B.FREIGHT + B.OTHER_CHARGES + 
									  B.ROUND_OFF - B.DISCOUNT_AMOUNT ))
			FROM WSL_ORDER_DET A
			JOIN WSL_ORDER_MST B ON A.ORDER_ID = B.ORDER_ID
			WHERE B.ORDER_ID = @CMEMOID AND A.CANCELLED=0
		
			SELECT @NSUMRFNET = SUM(RFNET), @NSUMRFNETWT = 0 FROM WSL_ORDER_DET WHERE ORDER_ID = @CMEMOID AND CANCELLED=0
				
			IF @NSUMRFNET <> @NSUBTOTAL
				UPDATE WSL_ORDER_DET SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE ORDER_ID = @CMEMOID AND ROW_ID = @CROWID

			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL, @NTAX
		END
		CLOSE ABC
		DEALLOCATE ABC
	END					-- END OF WHOLESALE CUSTOMER ORDER
	
	ELSE
	--*** UPDATION OF RFNET FOR WHOLESALE INVOICE
	--*** UPDATION OF RFNET FOR WHOLESALE INVOICE
	IF @CXNTYPE IN ('WSL')	
	BEGIN
		PRINT 'UPDRFNET-1'
		IF @CXNID <> ''
			DECLARE ABC CURSOR FOR SELECT A.INV_ID, NET_AMOUNT 
			FROM INM01106 A WHERE A.INV_ID = @CXNID 
			
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR SELECT A.INV_ID, NET_AMOUNT  FROM INM01106 A
				JOIN xnnos b ON a.inv_id=b.xn_id WHERE sp_id=@nSpId
			ELSE
				DECLARE ABC CURSOR FOR SELECT DISTINCT A.INV_ID,NET_AMOUNT
				FROM INM01106 A
				WHERE INV_ID IN (SELECT INV_ID FROM IND01106 A WHERE A.RATE<>0 AND ( A.RFNET IS NULL 
								 OR A.RFNET = 0 OR A.RFNET_WOTAX IS NULL OR A.RFNET_WOTAX=0))
		END
		
		PRINT 'UPDRFNET-2'
		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		WHILE @@FETCH_STATUS = 0
		BEGIN
			PRINT 'UPDRFNET-3'
			SELECT TOP 1 @CROWID = ROW_ID FROM IND01106 WHERE INV_ID = @CMEMOID

			PRINT 'UPDRFNET-4'
			
			SELECT @NTAX=0,@NINCLTAX=0
			
			--SELECT @NTAX=SUM(ITEM_TAX_AMOUNT) FROM IND01106 A (NOLOCK) 
			--JOIN INM01106 B (NOLOCK) ON A.INV_ID=B.INV_ID WHERE B.INV_ID=@CMEMOID 
			--AND BILL_LEVEL_TAX_METHOD IN (0,1)

			--SELECT @NINCLTAX=SUM(ITEM_TAX_AMOUNT) FROM IND01106 A (NOLOCK) 
			--JOIN INM01106 B (NOLOCK) ON A.INV_ID=B.INV_ID WHERE B.INV_ID=@CMEMOID 
			--AND BILL_LEVEL_TAX_METHOD=2
			UPDATE IND01106 SET RFNET =0,RFNET_WOTAX =0 WHERE INV_ID = @CMEMOID						
			
			UPDATE IND01106 SET RFNET =
				DBO.FN_GETRFNETVALUE( (A.xn_value_without_gst+(CASE WHEN B.BILL_LEVEL_TAX_METHOD=2 THEN 0 ELSE (A.ITEM_TAX_AMOUNT) 
				+(ISNULL(A.IGST_AMOUNT,0))+(ISNULL(A.CGST_AMOUNT,0))+(ISNULL(A.SGST_AMOUNT,0))+(ISNULL(A.Gst_Cess_Amount ,0))
				END))/invoice_quantity
				, A.QUANTITY, B.SUBTOTAL, ( 
				isnull(B.FREIGHT_TAXABLE_VALUE,0) + 
				ISNULL(B.FREIGHT_IGST_AMOUNT ,0)+ISNULL(B.FREIGHT_CGST_AMOUNT ,0)+ISNULL(B.FREIGHT_SGST_AMOUNT ,0)+
				isnull(B.OTHER_CHARGES_TAXABLE_VALUE,0) + 
				ISNULL(B.OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_CGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_SGST_AMOUNT ,0)+
				B.ROUND_OFF+B.OCTROI_AMOUNT+
				isnull(B.INSURANCE_TAXABLE_VALUE,0)+
				ISNULL(B.INSURANCE_IGST_AMOUNT ,0)+ISNULL(B.INSURANCE_CGST_AMOUNT ,0)+ISNULL(B.INSURANCE_SGST_AMOUNT ,0)+
				B.EXCISE_DUTY_AMOUNT+
				B.EXCISE_EDU_CESS_AMOUNT+B.EXCISE_HEDU_CESS_AMOUNT )),
				RFNET_WOTAX =
				DBO.FN_GETRFNETVALUE( A.NET_RATE-(CASE WHEN B.BILL_LEVEL_TAX_METHOD=2 THEN 
				(A.ITEM_TAX_AMOUNT/A.QUANTITY) 
				+(ISNULL(A.IGST_AMOUNT,0)/A.INVOICE_QUANTITY)+(ISNULL(A.CGST_AMOUNT,0)/A.INVOICE_QUANTITY)+(ISNULL(A.SGST_AMOUNT,0)/A.INVOICE_QUANTITY)
				+(ISNULL(A.Gst_Cess_Amount ,0)/A.INVOICE_QUANTITY)
				ELSE 0 END)
				, A.QUANTITY, B.SUBTOTAL
				---ISNULL(@NINCLTAX,0) 
				,
				 (B.FREIGHT + 
				 ISNULL(B.FREIGHT_IGST_AMOUNT ,0)+ISNULL(B.FREIGHT_CGST_AMOUNT ,0)+ISNULL(B.FREIGHT_SGST_AMOUNT ,0)+
				 B.OTHER_CHARGES + 
				 ISNULL(B.OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_CGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_SGST_AMOUNT ,0)+
				 B.ROUND_OFF - B.DISCOUNT_AMOUNT+B.OCTROI_AMOUNT+
				 B.INSURANCE 
				 +ISNULL(B.INSURANCE_IGST_AMOUNT ,0)+ISNULL(B.INSURANCE_CGST_AMOUNT ,0)+ISNULL(B.INSURANCE_SGST_AMOUNT ,0)
				 ))				
			FROM IND01106 A
			JOIN INM01106 B ON A.INV_ID = B.INV_ID
			WHERE B.INV_ID = @CMEMOID
			AND invoice_quantity<>0

			PRINT 'UPDRFNET-5'
			
			--SELECT SUM(RFNET),  SUM(RFNET_WOTAX) FROM IND01106 WHERE INV_ID = @CMEMOID
			SELECT @NSUMRFNET = SUM(RFNET), @NSUMRFNETWT = SUM(RFNET_WOTAX) FROM IND01106 WHERE INV_ID = @CMEMOID
				
			IF @NSUMRFNET <> @NSUBTOTAL
			BEGIN
				PRINT 'UPDRFNET-6'
				UPDATE IND01106 SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE INV_ID = @CMEMOID AND ROW_ID = @CROWID
			END
			IF @NSUMRFNETWT <> ( @NSUBTOTAL - @NTAX )
			BEGIN
				PRINT 'UPDRFNET-7'
				UPDATE IND01106 SET RFNET_WOTAX = RFNET_WOTAX + ( @NSUBTOTAL - @NTAX - @NSUMRFNETWT ) 
				WHERE INV_ID = @CMEMOID AND ROW_ID = @CROWID
			END
			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		END
		CLOSE ABC
		DEALLOCATE ABC
	END					-- END OF WHOLESALE INVOICE

	ELSE
	--*** UPDATION OF RFNET FOR WHOLESALE RETURN (CREDIT NOTE)
	IF @CXNTYPE IN ('WSR')
	BEGIN
		IF @CXNID <> ''
			DECLARE ABC CURSOR FOR SELECT CN_ID, TOTAL_AMOUNT FROM CNM01106 WHERE CN_ID = @CXNID 
		ELSE 
		BEGIN
			IF @NSPID <> 0
				DECLARE ABC CURSOR FOR SELECT CN_ID, TOTAL_AMOUNT FROM CNM01106
				WHERE CN_ID IN ( SELECT XN_ID FROM XNNOS WHERE XN_TYPE = 'WSR' AND SP_ID = @NSPID )
			ELSE
				DECLARE ABC CURSOR FOR SELECT DISTINCT A.CN_ID, B.TOTAL_AMOUNT FROM CND01106 A
				JOIN CNM01106 B ON A.CN_ID=B.CN_ID WHERE A.RATE<>0 AND ( A.RFNET IS NULL OR A.RFNET = 0 OR A.RFNET_WOTAX IS NULL OR A.RFNET_WOTAX=0) 
		END
		
		OPEN ABC
		FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SELECT TOP 1 @CROWID = ROW_ID FROM CND01106 WHERE CN_ID = @CMEMOID
			
			
			SELECT @NTAX=0,@NINCLTAX=0
			
			--SELECT @NTAX=SUM(ITEM_TAX_AMOUNT) FROM CND01106 A (NOLOCK) 
			--JOIN CNM01106 B (NOLOCK) ON A.CN_ID=B.CN_ID WHERE B.CN_ID=@CMEMOID 
			--AND BILL_LEVEL_TAX_METHOD IN (0,1)

			--SELECT @NINCLTAX=SUM(ITEM_TAX_AMOUNT) FROM CND01106 A (NOLOCK) 
			--JOIN CNM01106 B (NOLOCK) ON A.CN_ID=B.CN_ID WHERE B.CN_ID=@CMEMOID 
			--AND BILL_LEVEL_TAX_METHOD=2
			
			UPDATE CND01106 SET RFNET =
			DBO.FN_GETRFNETVALUE( A.NET_RATE+(CASE WHEN A.BILL_LEVEL_TAX_METHOD=2 THEN 0 ELSE (A.ITEM_TAX_AMOUNT/A.QUANTITY)
			+(ISNULL(A.IGST_AMOUNT,0)/A.INVOICE_QUANTITY)+(ISNULL(A.CGST_AMOUNT,0)/A.INVOICE_QUANTITY)+(ISNULL(A.SGST_AMOUNT,0)/A.INVOICE_QUANTITY)
			+(ISNULL(A.Gst_Cess_Amount ,0)/A.INVOICE_QUANTITY)
			 END)
			, A.QUANTITY, B.SUBTOTAL, ( 
			--ISNULL(@NTAX,0) + 
			B.FREIGHT + 
			ISNULL(B.FREIGHT_IGST_AMOUNT ,0)+ISNULL(B.FREIGHT_CGST_AMOUNT ,0)+ISNULL(B.FREIGHT_SGST_AMOUNT ,0)+
			B.OTHER_CHARGES + 
			ISNULL(B.OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_CGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_SGST_AMOUNT ,0)+
			B.ROUND_OFF )) ,
			RFNET_WOTAX = DBO.FN_GETRFNETVALUE( A.NET_RATE-(CASE WHEN A.BILL_LEVEL_TAX_METHOD=2 THEN 
			(A.ITEM_TAX_AMOUNT/A.QUANTITY) 
			+(ISNULL(A.IGST_AMOUNT,0)/A.INVOICE_QUANTITY)+(ISNULL(A.CGST_AMOUNT,0)/A.INVOICE_QUANTITY)+(ISNULL(A.SGST_AMOUNT,0)/A.INVOICE_QUANTITY)
			+(ISNULL(A.Gst_Cess_Amount ,0)/A.INVOICE_QUANTITY)
			ELSE 0 END)
			, A.QUANTITY, B.SUBTOTAL
			---ISNULL(@NINCLTAX,0)
			, ( B.FREIGHT + 
			ISNULL(B.FREIGHT_IGST_AMOUNT ,0)+ISNULL(B.FREIGHT_CGST_AMOUNT ,0)+ISNULL(B.FREIGHT_SGST_AMOUNT ,0)+
			B.OTHER_CHARGES + 
			ISNULL(B.OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_CGST_AMOUNT ,0)+ISNULL(B.OTHER_CHARGES_SGST_AMOUNT ,0)+
			B.ROUND_OFF - B.DISCOUNT_AMOUNT )) 
			FROM CND01106 A
			JOIN CNM01106 B ON A.CN_ID = B.CN_ID
			JOIN SKU C ON C.PRODUCT_CODE=A.PRODUCT_CODE
			WHERE B.CN_ID = @CMEMOID
		
			SELECT @NSUMRFNET = SUM	(RFNET), @NSUMRFNETWT = SUM(RFNET_WOTAX) 
			FROM CND01106 WHERE CN_ID = @CMEMOID

			IF @NSUMRFNET <> @NSUBTOTAL
				UPDATE CND01106 SET RFNET = RFNET + ( @NSUBTOTAL - @NSUMRFNET ) 
				WHERE CN_ID = @CMEMOID AND ROW_ID = @CROWID

			IF @NSUMRFNETWT <> ( @NSUBTOTAL - @NTAX )
				UPDATE CND01106 SET RFNET_WOTAX = RFNET_WOTAX + ( @NSUBTOTAL - @NTAX - @NSUMRFNETWT ) 
				WHERE CN_ID = @CMEMOID AND ROW_ID = @CROWID

			FETCH NEXT FROM ABC INTO @CMEMOID, @NSUBTOTAL
		END
		CLOSE ABC
		DEALLOCATE ABC
	END					-- END OF WHOLESALE RETURN (CREDIT NOTE)
	
END