CREATE PROCEDURE [DBO].[SPPPC_FILTER_PPC_BUYER_ORDER]      
(        
 @NMODE     INT, --(1) - VIEW FILTER DATA (2) - VIEW MST USING ID (3) - VIEW DTL USING ID       
 @ORDER_ID    VARCHAR(22)='',        
 @AC_NAME    VARCHAR(300)='',        
 @BILL_NO     VARCHAR(10)='',        
 @ORDER_NO    VARCHAR(10)='',      
 @ORDER_DTYN   VARCHAR(1)='',        
 @ORDER_DTFROM DATETIME='',      
 @ORDER_DTTO   DATETIME='',      
 @CANCELLED    VARCHAR(5)='',        
 @ERRMSG_OUT   VARCHAR(MAX) OUT,
 @CFIN_YEAR VARCHAR(5) ='' ,
 @NAPPROVED  INT=2
)        
AS        
BEGIN        
 DECLARE @CSTEP INT, @CCMD NVARCHAR(MAX)        
      
 BEGIN TRY        
  SET @ERRMSG_OUT = ''        
  
  IF @ORDER_DTFROM<>''
  SET @ORDER_DTYN='Y'
  
  -- VIEW FILTER DATA      
  SET @CSTEP = 10        
  IF (@NMODE=1)        
  BEGIN        
       
	       
	  IF OBJECT_ID ('TEMPDB..#TMPBCGGEN','U') IS NOT NULL
		 DROP TABLE #TMPBCGGEN
	  
	  SELECT A.ORDER_ID ,
	  CASE WHEN SUM(A.QUANTITY)=SUM(ISNULL(BCG_GEN,0)) THEN 1 
	       WHEN SUM(ISNULL(BCG_GEN,0))=0 THEN 0
	  ELSE 2 END AS BCG_GEN
	  INTO #TMPBCGGEN
	  FROM 
	  (			
	  SELECT A.ORDER_ID , A.ROW_ID,A.QUANTITY ,ISNULL(BCG_GEN,0) AS BCG_GEN
	  FROM PPC_BUYER_ORDER_DET A
	  JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
	  LEFT JOIN
	  (
	   SELECT B.BO_DET_ROW_ID,COUNT(*) AS BCG_GEN
	   FROM PPC_FGBCG_MST A
	   JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID 
	   JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID 
	   WHERE A.CANCELLED=0
	   GROUP BY B.BO_DET_ROW_ID
	  ) SKU ON A.ROW_ID =SKU.BO_DET_ROW_ID
	  WHERE B.CANCELLED=0
	  ) A
	  GROUP BY A.ORDER_ID
  
   SET @CCMD=N' SELECT VBOM.ORDER_ID, AC_CODE, AC_NAME, REF_NO, BILL_NO, ORDER_NO, ORDER_DT, TOTAL_QTY, 
                TOTAL_AMOUNT, CANCELLED ,APPROVED,APPROVED_BY,ISNULL(BCG.BCG_GEN,0) AS BCG_GEN
             FROM (      
				   SELECT BOM.FIN_YEAR, BOM.ORDER_ID, BOM.AC_CODE, LMV.AC_NAME, BOM.REF_NO, BOM.BILL_NO, BOM.ORDER_NO, BOM.ORDER_DT, BOD.TOTAL_QTY,       
					  BOM.TOTAL_AMOUNT, CASE WHEN ISNULL(BOM.CANCELLED, 0) = 0 THEN ''NO'' ELSE ''YES'' END AS CANCELLED ,
					  ISNULL(BOM.APPROVED,0) AS APPROVED,
					  ISNULL(U.USERNAME,'''') AS APPROVED_BY
				   FROM PPC_BUYER_ORDER_MST BOM      
				   JOIN (SELECT ORDER_ID, SUM(QUANTITY) AS TOTAL_QTY FROM PPC_BUYER_ORDER_DET GROUP BY ORDER_ID) BOD ON BOM.ORDER_ID = BOD.ORDER_ID      
				   JOIN LMV01106 LMV ON BOM.AC_CODE =LMV.AC_CODE
				   LEFT JOIN USERS U ON U.USER_CODE=ISNULL(BOM.APPROVED_BY,'''')
				   ) AS VBOM 
		   LEFT JOIN #TMPBCGGEN BCG ON VBOM.ORDER_ID=BCG.ORDER_ID     
          WHERE AC_NAME LIKE ''%' + @AC_NAME + '%''       
         ---- AND ORDER_NO LIKE ''%' + @ORDER_NO + '%''      
          AND BILL_NO LIKE ''%' + @ORDER_NO + '%'' 
          AND VBOM.FIN_YEAR='''+@CFIN_YEAR+'''
          AND ('''+RTRIM(LTRIM(STR(@NAPPROVED)))+'''=''2'' OR APPROVED='''+RTRIM(LTRIM(STR(@NAPPROVED)))+''')
          '        
         
   IF @CANCELLED != ''        
   BEGIN        
    SET @CCMD+=N' AND CANCELLED=''' + @CANCELLED + ''' '        
   END        
   IF @ORDER_DTYN = 'Y'        
   BEGIN        
    SET @CCMD+=N' AND ORDER_DT BETWEEN ''' +  CONVERT(VARCHAR(10),@ORDER_DTFROM,126) + ''' AND ''' + CONVERT(VARCHAR(10),@ORDER_DTTO,126) + ''' '      
   END        
   SET @CCMD+=N' ORDER BY ORDER_DT DESC, ORDER_ID DESC,AC_NAME '        
      
   PRINT @CCMD        
   EXEC SP_EXECUTESQL @CCMD        
  END        
      
  -- VIEW MST USING ID      
  SET @CSTEP = 20        
  IF (@NMODE=2)        
  BEGIN        
   SET @CCMD=N' SELECT  BOM.MEMO_TYPE, BOM.AC_CODE, LMV.AC_NAME AS CUSTOMER_NAME,       
              ISNULL(LMV.ADDRESS0, '''') + '' '' + ISNULL(LMV.ADDRESS1, '''') + '' '' + ISNULL(LMV.ADDRESS2, '''') + '' '' + ISNULL(LMV.AREA_NAME, '''')       
              + '' '' + ISNULL(LMV.CITY, '''') + '' '' + ISNULL(LMV.[STATE], '''') + '' '' + ISNULL(LMV.MOBILE, '''') + '' '' AS CUSTOMER_ADDRESS,        
              BOM.REF_NO, BOM.BILL_NO, BOM.ORDER_NO, CONVERT(VARCHAR, BOM.ORDER_DT, 103) AS ORDER_DT,      
              BOM.ORDER_TIME, BOM.ORDER_ID, BOM.REMARKS, BOD.TOTAL_QTY, CAST(BOM.SUBTOTAL AS NUMERIC(10,0)) AS SUBTOTAL, BOM.DISCOUNT_PERCENTAGE,       
              BOM.DISCOUNT_AMOUNT, BOM.OTHER_CHARGES, BOM.ROUND_OFF, BOM.TOTAL_AMOUNT,       
              BOM.USER_CODE, UR1.USERNAME AS USERNAME, BOM.EDT_USER_CODE, UR2.USERNAME AS EDIT_USERNAME,      
              BOM.LAST_UPDATE, CASE WHEN ISNULL(BOM.CANCELLED, 0) = 0 THEN ''NO'' ELSE ''YES'' END AS CANCELLED, BOM.FIN_YEAR, BOM.DEPT_ID ,
              ISNULL(BOM.APPROVED,0) AS APPROVED
          FROM PPC_BUYER_ORDER_MST BOM      
          JOIN (SELECT ORDER_ID, CAST(SUM(QUANTITY) AS NUMERIC(10,0)) AS TOTAL_QTY FROM PPC_BUYER_ORDER_DET GROUP BY ORDER_ID) BOD ON BOM.ORDER_ID = BOD.ORDER_ID      
          JOIN LMV01106 LMV ON BOM.AC_CODE =LMV.AC_CODE      
          LEFT JOIN USERS UR1 ON BOM.USER_CODE = UR1.USER_CODE      
          LEFT JOIN USERS UR2 ON BOM.EDT_USER_CODE = UR2.USER_CODE      
          WHERE BOM.ORDER_ID = ''' + @ORDER_ID + ''' 
          AND BOM.FIN_YEAR='''+@CFIN_YEAR+''''        
   PRINT @CCMD        
   EXEC SP_EXECUTESQL @CCMD        
  END        
        
  -- VIEW DTL USING ID       
  SET @CSTEP = 30        
  IF (@NMODE=3)        
  BEGIN        
   SET @CCMD=N' SELECT  BOD.ORDER_ID, BOD.PARA3_CODE, ISNULL(P3.PARA3_NAME, '''') AS PARA3_NAME,      
              BOD.ARTICLE_CODE, ISNULL(AR.ARTICLE_NO, '''') AS ARTICLE_NO, ISNULL(AR.ARTICLE_DESC, '''') AS ARTICLE_DESC,       
              ISNULL(AR.UOM_CODE, '''') AS UOM_CODE, ISNULL(AR.UOM_NAME, '''') AS UOM_NAME,      
              BOD.PARA1_CODE, ISNULL(P1.PARA1_NAME, '''') AS PARA1_NAME, BOD.SIZEGROUP_CODE, ISNULL(SG.SIZEGROUP_NAME, '''') AS SIZEGROUP_NAME,      
              CAST(BOD.QUANTITY AS NUMERIC(10,0)) AS QUANTITY,
              CAST( BOD.RATE AS NUMERIC(10,2)) AS RATE,
               CAST( (ISNULL(BOD.QUANTITY, 0) * ISNULL(BOD.RATE,0)) AS NUMERIC(18,2) )  AS RATE_HF,       
              CAST(BOD.DISCOUNT_PERCENTAGE AS NUMERIC(10,0)) AS DISCOUNT_PERCENTAGE, 
              CAST(BOD.DISCOUNT_AMOUNT AS NUMERIC(10,0)) AS DISCOUNT_AMOUNT, 
              BOD.NET_RATE, 
              CAST(BOD.AMOUNT AS NUMERIC(10,0)) AS AMOUNT, 
              BOD.ITEM_REMARKS,       
              BOD.SHIPPING_MODE, ISNULL(PSD.SHIPPING_NAME, '''') AS SHIPPING_NAME,       
              CONVERT(VARCHAR, BOD.DELIVERY_DT, 103) AS DELIVERY_DT, BOD.MERCHANT_CODE, BOD.EMP_CODE, BOD.ROW_ID,      
              ROW_NUMBER() OVER(ORDER BY BOD.PARA3_CODE, BOD.ARTICLE_CODE, BOD.PARA1_CODE, BOD.SIZEGROUP_CODE) AS ROWNUMBER,      
              ISNULL(BOD.ARTICLE_CODE, '''') + ISNULL(BOD.PARA1_CODE, '''') + ISNULL(BOD.SIZEGROUP_CODE, '''') AS COMBARTPARA1SG
              ,'''' AS IMAGE_1 
              ,BOD.CURRENCY_CODE, 
              CM.CURRENCY_NAME  
               
          FROM PPC_BUYER_ORDER_DET BOD      
          LEFT JOIN PARA3 P3 ON BOD.PARA3_CODE = P3.PARA3_CODE     
          LEFT OUTER JOIN PPC_CURRENCY_MST CM ON CM.CURRENCY_CODE=BOD.CURRENCY_CODE 
          LEFT JOIN ( SELECT A.ARTICLE_CODE, A.ARTICLE_NO, A.ARTICLE_DESC, A.UOM_CODE, U.UOM_NAME      
               FROM ARTICLE A LEFT JOIN UOM U ON A.UOM_CODE = U.UOM_CODE) AR ON BOD.ARTICLE_CODE = AR.ARTICLE_CODE      
          LEFT JOIN PARA1 P1 ON BOD.PARA1_CODE = P1.PARA1_CODE      
          LEFT JOIN PPC_SIZEGROUP SG ON BOD.SIZEGROUP_CODE = SG.SIZEGROUP_CODE      
          LEFT JOIN PPC_SHIPPING_DETAILS PSD ON BOD.SHIPPING_MODE = PSD.SHIPPING_MODE      
          WHERE BOD.ORDER_ID = ''' + @ORDER_ID + ''' '        
   PRINT @CCMD        
   EXEC SP_EXECUTESQL @CCMD        
  END        
   
  
        
 END TRY          
 BEGIN CATCH          
  SET @ERRMSG_OUT='ERROR: [P]: SPPPC_FILTER_BUYER_ORDER, [STEP]: '+CAST(@CSTEP AS VARCHAR(5))+', [MESSAGE]: ' + ERROR_MESSAGE()        
  PRINT @ERRMSG_OUT        
       
  GOTO END_PROC          
 END CATCH           
      
END_PROC:          
 IF  ISNULL(@ERRMSG_OUT,'')=''         
  SET @ERRMSG_OUT = ''        
END
