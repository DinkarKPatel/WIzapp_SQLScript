CREATE PROCEDURE SP3S_GET_UDRF
(
	@NMODE NUMERIC(1)
   ,@CXN_TYPE VARCHAR(10)='WSL'
	/*MODES : 1 - RETURN ALL THE REPORT FORMATS TO FILL THE TREE.
			  2 - RETURN ALL THE DETAILS FOR THE REPORT	*/
   ,@CREPORT_ID VARCHAR(40)='',
   @CDEPT_ID VARCHAR(5)=''
)
--WITH ENCRYPTION 
AS
BEGIN
DECLARE @CSEPARTOR VARCHAR(20)

IF @NMODE=1 
	GOTO LBL_REPORTFORMATS
IF @NMODE=2 AND @CXN_TYPE='WSL'
	GOTO LBLWSL_REPORTDETAILS
IF @NMODE=3 AND @CXN_TYPE='WSL'
	GOTO LBLWSL_DETAILEXP
IF @NMODE=4 AND @CXN_TYPE='WSL'
	GOTO LBLWSL_DETAILCOMPEXP	
ELSE 
	GOTO END_PROC			

LBL_REPORTFORMATS:	
		
	SELECT REPORT_ID,XN_TYPE,XN_TYPE_FORMAT,ISDEFAULT,REF_REPORT_ID 
	FROM UDRF_MST WHERE INACTIVE=0 AND (@CXN_TYPE='' OR XN_TYPE=@CXN_TYPE)
	ORDER BY XN_TYPE ASC,ISDEFAULT DESC,XN_TYPE_FORMAT ASC
		
GOTO END_PROC

LBLWSL_REPORTDETAILS:

	SELECT * FROM UDRF_MST WHERE REPORT_ID=@CREPORT_ID
	
	SELECT * FROM UDRF_DET WHERE REPORT_ID=@CREPORT_ID AND FLAG='H'
	ORDER BY HEADER_ORG ASC
	
	SELECT * FROM UDRF_DET WHERE REPORT_ID=@CREPORT_ID AND FLAG='D'
	ORDER BY HEADER_ORG ASC
	
	SELECT * FROM UDRF_DET WHERE REPORT_ID=@CREPORT_ID AND FLAG='F'
	--ORDER BY HEADER_ORG ASC
GOTO END_PROC

LBLWSL_DETAILEXP:

SELECT TOP 1 @CSEPARTOR=SEPARATOR FROM UDRF_EXP A WHERE REPORT_ID=@CREPORT_ID

IF @CDEPT_ID=''
SELECT TOP 1 @CDEPT_ID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 


SELECT @CREPORT_ID AS REPORT_ID,'DESCRIPTION' AS REPORT_VALUE,ISNULL(A.ROW_ID,'LATER') AS ROW_ID
	   ,ISNULL(A.COLUMN_NAME,B.COLUMN_NAME) AS COLUMN_NAME,ISNULL(A.COLUMN_EXPRESSION,B.COLUMN_EXPRESSION) AS COLUMN_EXPRESSION
	   ,ISNULL(A.COLUMN_ORDER,0) AS COLUMN_ORDER,ISNULL(A.VAL_LEN,0) AS VAL_LEN,ISNULL(@CSEPARTOR,'') AS SEPARATOR,ISNULL(A.LAST_UPDATE,GETDATE()) AS LAST_UPDATE
	   ,ISNULL(A.ISENABLED,0) AS ISENABLED
FROM 
(
	SELECT * 
	FROM UDRF_EXP 
	WHERE REPORT_ID=@CREPORT_ID
)A
FULL OUTER JOIN 
(
	SELECT 'SECTION_NAME' AS COLUMN_NAME,'SECTION NAME' AS COLUMN_EXPRESSION 
	UNION ALL
	SELECT 'SUB_SECTION_NAME' AS COLUMN_NAME,'SUB SECTION NAME' AS COLUMN_EXPRESSION 
	UNION ALL
	SELECT 'PRODUCT_CODE' AS COLUMN_NAME,'ITEM CODE' AS COLUMN_EXPRESSION 
	UNION ALL
	SELECT 'ARTICLE_NO' AS COLUMN_NAME,'ARTICLE NO' AS COLUMN_EXPRESSION 
	UNION ALL
	SELECT 'ARTICLE_NAME' AS COLUMN_NAME,'ARTICLE NAME' AS COLUMN_EXPRESSION 
	UNION ALL
	SELECT CONFIG_OPTION+'_NAME' AS COLUMN_NAME,VALUE AS COLUMN_EXPRESSION 
	FROM CONFIG WHERE CONFIG_OPTION LIKE 'PARA%' AND  LEN(CONFIG_OPTION)=13 
	UNION ALL
	SELECT ATTRIBUTE_NAME AS COLUMN_NAME ,ATTRIBUTE_NAME AS COLUMN_EXPRESSION 
	FROM ATTRM WHERE ATTRIBUTE_TYPE=1
)B ON A.COLUMN_NAME=B.COLUMN_NAME


GOTO END_PROC

LBLWSL_DETAILCOMPEXP:
SELECT TOP 1 @CDEPT_ID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 

SELECT @CREPORT_ID AS REPORT_ID,'DESCRIPTION' AS REPORT_VALUE,ISNULL(A.ROW_ID,'LATER') AS ROW_ID
	   ,ISNULL(A.COLUMN_NAME,'') AS COLUMN_NAME,ISNULL(A.COLUMN_EXPRESSION,'') AS COLUMN_EXPRESSION,ISNULL(A.COLUMN_EXPRESSION_NEW,'') AS COLUMN_EXPRESSION_NEW
	   ,ISNULL(A.COLUMN_ORDER,0) AS COLUMN_ORDER,ISNULL(A.LAST_UPDATE,GETDATE()) AS LAST_UPDATE
	   ,ISNULL(A.ISENABLED,0) AS ISENABLED
FROM 
(
	SELECT * 
	FROM UDRF_EXP_COMP 
	WHERE REPORT_ID=@CREPORT_ID
)A

GOTO END_PROC
END_PROC:
END
--END OF PROCEDURE - SP3S_GET_UDRF
