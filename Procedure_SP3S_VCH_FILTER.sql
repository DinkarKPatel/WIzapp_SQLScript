CREATE PROCEDURE SP3S_VCH_FILTER
(
	@dtVOUCHER_DT_FROM		DATETIME ='',
	@dtVOUCHER_DT_TO		DATETIME='',
	@dtPOSTDATE_FROM		DATETIME ='',
	@dtPOSTDATE_TO			DATETIME='',
	@nCANCELLED				INT=0,
	@cVOUCHER_TYPE			VARCHAR(10)='',
	@cAC_NAME				VARCHAR(100)='',
	@cVOUCHER_NO			VARCHAR(20)='',
	@cREF_NO				VARCHAR(100)=''
)
AS
BEGIN
	
	IF @nCANCELLED=99
	BEGIN
		SET @nCANCELLED=0
		SET @cAC_NAME='1=2'
	END

	 IF OBJECT_ID('TEMPDB..#FILTER_VM','U') IS NOT NULL        
		DROP TABLE #FILTER_VM        

	CREATE TABLE 	  #FILTER_VM (     VM_ID VARCHAR(50) )
	--SELECT @dtVOUCHER_DT_FROM, @dtPOSTDATE_FROM
	IF @dtVOUCHER_DT_FROM<>'' AND @dtPOSTDATE_FROM<>''
	BEGIN
		INSERT INTO #FILTER_VM (VM_ID)        
		SELECT  VM.VM_ID      
		 FROM VM01106 VM(NOLOCK)        
		 WHERE   (VM.VOUCHER_DT BETWEEN @dtVOUCHER_DT_FROM AND @dtVOUCHER_DT_TO )
		 AND (CAST(CONVERT(VARCHAR(20),VM.LAST_UPDATE,111) AS DATETIME) BETWEEN @dtPOSTDATE_FROM AND @dtPOSTDATE_TO )
	END
	ELSE IF @dtVOUCHER_DT_FROM<>'' 
	BEGIN
		INSERT INTO #FILTER_VM (VM_ID)        
		SELECT  VM.VM_ID      
		 FROM VM01106 VM(NOLOCK)        
		 WHERE   VM.VOUCHER_DT BETWEEN @dtVOUCHER_DT_FROM AND @dtVOUCHER_DT_TO 
	END
	ELSE IF @dtPOSTDATE_FROM<>''
	BEGIN
		INSERT INTO #FILTER_VM (VM_ID)        
		SELECT  VM.VM_ID      
		FROM VM01106 VM(NOLOCK)        
		WHERE   CAST(CONVERT(VARCHAR(20),VM.LAST_UPDATE,111) AS DATETIME) BETWEEN @dtPOSTDATE_FROM AND @dtPOSTDATE_TO 
	END
	--select * from #FILTER_VM
	--IF NOT EXISTS (SELECT TOP 1 'U' FROM #FILTER_VM)
	--BEGIN
	--	INSERT INTO #FILTER_VM (VM_ID)        
	--	SELECT  VM.VM_ID      
	--	FROM VM01106 VM(NOLOCK)  
	--END
	--SELECT * FROM #FILTER_VM
	IF @cAC_NAME<>''
	BEGIN
		DELETE FROM #FILTER_VM WHERE VM_ID NOT IN (SELECT VM_ID FROM VD01106 (NOLOCK) WHERE AC_CODE=@cAC_NAME)
	END

	IF @cVOUCHER_TYPE<>'' 
	BEGIN
		DELETE FROM #FILTER_VM WHERE VM_ID NOT IN (SELECT VM_ID FROM VM01106 (NOLOCK) WHERE VOUCHER_CODE=@cVOUCHER_TYPE)
	END

	IF @nCANCELLED<>2
	BEGIN
		DELETE FROM #FILTER_VM WHERE VM_ID NOT IN (SELECT VM_ID FROM VM01106 (NOLOCK) WHERE cancelled=@nCANCELLED)
	END

	IF @cVOUCHER_NO<>''
	BEGIN
		DELETE FROM #FILTER_VM WHERE VM_ID NOT IN (SELECT VM_ID FROM VM01106 (NOLOCK) WHERE VOUCHER_NO=@cVOUCHER_NO)
	END

	IF @cREF_NO<>''
	BEGIN
		DELETE FROM #FILTER_VM WHERE VM_ID NOT IN (SELECT VM_ID FROM VM01106 (NOLOCK) WHERE REF_NO=@cREF_NO)
	END

	SELECT DISTINCT CAST(0 AS BIT) AS PRINT_LBL,VTYP.VOUCHER_TYPE,M.VOUCHER_NO,M.VOUCHER_DT,DRTOTAL,CRTOTAL,M.LAST_UPDATE POSTDATE
	,REF_NO
	,[CANCELLED]=CASE M.CANCELLED WHEN 0 THEN 'FALSE' ELSE 'TRUE' END   
	,M.VM_ID MEMO_ID
	,'' AS AC_NAME
	,'' AS NARRATION
	,(CASE WHEN ISNULL(EDIT_COUNT,0)>0 THEN 'EDITED (' + RTRIM(LTRIM(STR(EDIT_COUNT)))+ ')' ELSE '' END ) AS EDIT_COUNT
	FROM VM01106 M(NOLOCK)  
	JOIN #FILTER_VM VM (NOLOCK) ON VM.VM_ID =M.VM_ID
	JOIN VCHTYPE VTYP (NOLOCK) ON VTYP.VOUCHER_CODE=M.VOUCHER_CODE

END