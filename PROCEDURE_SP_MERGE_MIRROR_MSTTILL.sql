create PROCEDURE DBO.SP_MERGE_MIRROR_MSTTILL
 (
   @NMODE INT
  ,@XN_TYPE VARCHAR(50) ='MSTTILL'
 )
AS
 BEGIN
       DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
              ,@CTEMPLOCTABLE VARCHAR(100),@CSTATECODEOUT CHAR(7),@CSTATECODE VARCHAR(10)
              ,@CCURDEPTID VARCHAR(10),@CHODEPTID VARCHAR(10),@BHOLOC BIT,@NLOCTYPE VARCHAR(50)
              ,@BPURLOC VARCHAR(10),@CTABLENAME VARCHAR(100),@CTMP_TABLENAME VARCHAR(100)
              ,@CKEYFIELD1 VARCHAR(100),@CTEMPLOCSSTTABLE VARCHAR(500),@CTEMPTABLE VARCHAR(500)
              ,@CTEMPLOCSSTMSTTABLE VARCHAR(500),@BPROCEED BIT,@CKEYFIELD2 VARCHAR(500),@CKEYFIELD3 VARCHAR(500) 
	          ,@CSOURCETABLE VARCHAR(1000),@NXNSMERGINGORDER INT,@CSOURCEDB VARCHAR(200),@CERRORMSG VARCHAR(MAX)	
BEGIN TRY
	  SELECT @CSOURCEDB=''	
	  
	  --VALIDATE DATE 
	  IF ISNULL(@XN_TYPE,'')  = ''
	     BEGIN
	       SET @CERRORMSG ='XN_TYPE IS NOT NULL. PLEASE PASS XN TYPE INTO PARAMATER'
	       GOTO END_PROC;
	     END
	  
	  IF ISNULL(@NMODE,0) = 1
         GOTO END_PROC;	
	  
	  BEGIN TRANSACTION
      
      SET @CSTEP = 00  
               
	  SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'  
	  SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'  
	  
	  IF @CCURDEPTID=@CHODEPTID
	  BEGIN
			SET @CERRORMSG='P:SP_MERGE_MIRROR_MSTTILL, CANNOT CALL MERGING PROC AT HEAD OFFICE'
			GOTO END_PROC
  	  END					

	  SET @CSTEP = 05    
	    
	  SELECT @NLOCTYPE=LOC_TYPE,@BPURLOC=PUR_LOC FROM LOCATION WHERE DEPT_ID=@CCURDEPTID  
	       
           
	  SET @CSTEP = 10   

	  --DELETE ALREADY EXISTING RECORDS FOR [MASTER TABLE
	   	 DELETE FROM TILL_SMS_REC_LOC
         DELETE FROM TILL_SMS_REC
	  
	  
	  SET @CSTEP = 20
	  
	  SET @CTEMPTABLE='MSTTILL_LM01106_MIRROR'
	  SET @DTSQL=N'UPDATE '+@CTEMPTABLE+'  WITH (ROWLOCK) SET COMPANY_CODE=''01'''
	  EXEC SP_EXECUTESQL @DTSQL
	 
	  SET @CTEMPTABLE='MSTTILL_LMP01106_MIRROR'
	
	  SET @DTSQL=N'UPDATE '+@CTEMPTABLE+' WITH (ROWLOCK)  SET COMPANY_CODE=''01'''
	  EXEC SP_EXECUTESQL @DTSQL
	 
	 
	
	   SET @CKEYFIELD2 =''
	   SET @CKEYFIELD3 =''
	 --INSERT DATA INTO LOCATION TABLE
	 
	 
	   --INSERT DATA INTO CITY TABLE
	   SET @CSTEP = 40
	   SET @CTABLENAME = 'REGIONM'
	   SET @CSOURCETABLE ='MSTTILL_REGIONM_MIRROR'
	   SET @CKEYFIELD1='REGION_CODE'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	   --INSERT DATA INTO CITY TABLE
	   SET @CSTEP = 50
	   SET @CTABLENAME = 'STATE'
	   SET @CSOURCETABLE ='MSTTILL_STATE_MIRROR'
	   SET @CKEYFIELD1='STATE_CODE'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1

	   --INSERT DATA INTO CITY TABLE
	   SET @CSTEP = 60
	   SET @CTABLENAME = 'CITY'
	   SET @CSOURCETABLE ='MSTTILL_CITY_MIRROR'
	   SET @CKEYFIELD1='CITY_CODE'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	   --INSERT DATA INTO AREA TABLE
	   SET @CSTEP = 70
	   SET @CTABLENAME = 'AREA'
	   SET @CSOURCETABLE ='MSTTILL_AREA_MIRROR'
	   SET @CKEYFIELD1='AREA_CODE'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	   
	    --INSERT AND UPDATE DATA INTO TILL_MST TABLE
	   SET @CSTEP = 90
	   SET @CTABLENAME = 'TILL_MST'
	   SET @CSOURCETABLE ='MSTTILL_TILL_MST_MIRROR'
	   SET @CKEYFIELD1 ='TILL_ID'
	   SET @CKEYFIELD2=''
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1

       
       --INSERT AND UPDATE DATA INTO TILL_LOCS TABLE
	   SET @CSTEP = 80
	   SET @CTABLENAME = 'TILL_LOCS'
	   SET @CSOURCETABLE ='MSTTILL_TILL_LOCS_MIRROR'
	   SET @CKEYFIELD1 ='TILL_ID'
	   SET @CKEYFIELD2='DEPT_ID'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1


	   	Declare @CCMD nvarchar(max)			

		SET @CCMD=N'UPDATE A SET PASSWD=B.PASSWD FROM MSTTILL_USERS_MIRROR A WITH (ROWLOCK)  
					JOIN USERS B (NOLOCK) ON B.USER_CODE=A.USER_CODE
					JOIN USER_ROLE_DET C (NOLOCK) ON C.ROLE_ID=B.ROLE_ID
					WHERE C.FORM_NAME=''FRMUSERS'' AND FORM_OPTION=''CHANGE_PASSWORD'' AND C.VALUE=''1'' 
					AND A.USER_CODE <>''0000000'''

	    PRINT @CCMD				
		EXEC SP_EXECUTESQL @CCMD
	 
	   
	   --INSERT AND UPDATE DATA INTO TILL_USERS TABLE
	   SET @CSTEP = 100
	   SET @CTABLENAME = 'USERS'
	   SET @CSOURCETABLE ='MSTTILL_USERS_MIRROR'
	   SET @CKEYFIELD1 ='USER_CODE'
	   SET @CKEYFIELD2=''
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	   
	   

	   --INSERT AND UPDATE DATA INTO TILL_USERS TABLE
	   SET @CSTEP = 110
	   SET @CTABLENAME = 'TILL_USERS'
	   SET @CSOURCETABLE ='MSTTILL_TILL_USERS_MIRROR'
	   SET @CKEYFIELD1 ='TILL_ID'
	   SET @CKEYFIELD2='USER_CODE'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	   
	   --INSERT AND UPDATE DATA INTO TILL_DENO_MST TABLE
	   SET @CSTEP = 120
	   SET @CTABLENAME = 'TILL_DENO_MST'
	   SET @CSOURCETABLE ='MSTTILL_TILL_DENO_MST_MIRROR'
	   SET @CKEYFIELD1 ='DENO_ID'
	   SET @CKEYFIELD2=''
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1

	   

	   --INSERT AND UPDATE DATA INTO TILL_SMS_REC TABLE
	   SET @CSTEP = 130
	   SET @CTABLENAME = 'TILL_SMS_REC'
	   SET @CSOURCETABLE ='MSTTILL_TILL_SMS_REC_MIRROR'
	   SET @CKEYFIELD1 ='REC_ID'
	   SET @CKEYFIELD2=''
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	   --INSERT AND UPDATE DATA INTO TILL_SMS_REC_LOC TABLE
	   SET @CSTEP = 140
	   SET @CTABLENAME = 'TILL_SMS_REC_LOC'
	   SET @CSOURCETABLE ='MSTTILL_TILL_SMS_REC_LOC_MIRROR'
	   SET @CKEYFIELD1 ='REC_ID'
	   SET @CKEYFIELD2=''
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1

	   
	   
	   --INSERT AND UPDATE DATA INTO TILL_SMS_VAR TABLE
	   SET @CSTEP = 150
	   SET @CTABLENAME = 'TILL_SMS_VAR'
	   SET @CSOURCETABLE ='MSTTILL_TILL_SMS_VAR_MIRROR'
	   SET @CKEYFIELD1 ='VARIABLE_CODE'
	   SET @CKEYFIELD2=''
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	   --INSERT AND UPDATE DATA INTO TILL_SMS_TMPLT TABLE
	   SET @CSTEP = 160
	   SET @CTABLENAME = 'TILL_SMS_TMPLT'
	   SET @CSOURCETABLE ='MSTTILL_TILL_SMS_TMPLT_MIRROR'
	   SET @CKEYFIELD1 ='TMPLT_TYPE'
	   SET @CKEYFIELD2=''
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	   
	   --INSERT DATA INTO LM01106 TABLE
	   SET @CSTEP = 170
	   SET @CTABLENAME = 'LM01106'
	   SET @CSOURCETABLE ='MSTTILL_LM01106_MIRROR'
	   SET @CKEYFIELD1='AC_CODE'

	   SET @CSTEP = 171  
		EXEC SP3S_INACTIVE_MASTERS @CTEMPTABLE=@CSOURCETABLE,@CTABLENAME=@CTABLENAME,@CCOLNAME='AC_NAME',@CCOLKEYNAME=@CKEYFIELD1

	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	   --INSERT DATA INTO LMP01106 TABLE
	   SET @CSTEP = 180
	   SET @CTABLENAME = 'LMP01106'
	   SET @CSOURCETABLE ='MSTTILL_LMP01106_MIRROR'
	   SET @CKEYFIELD1='AC_CODE'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
	    --INSERT DATA INTO HD01106 TABLE
	   SET @CSTEP = 190
	   SET @CTABLENAME = 'HD01106'
	   SET @CSOURCETABLE ='MSTTILL_HD01106_MIRROR'
	   SET @CKEYFIELD1='HEAD_CODE'
	   EXEC UPDATEMASTERXN
	   @CSOURCEDB=@CSOURCEDB, @CSOURCETABLE=@CSOURCETABLE,
	   @CDESTDB='',@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD1,
	   @CKEYFIELD2=@CKEYFIELD2,@CKEYFIELD3=@CKEYFIELD3,@LINSERTONLY=0,
	   @CFILTERCONDITION='',@LUPDATEONLY=0,@BALWAYSUPDATE=1
	   
    
    GOTO END_PROC
END TRY

BEGIN CATCH
	SET @CERRORMSG='P:SP_MERGE_MIRROR_MSTTILL, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:
	
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')='' 
			COMMIT
		ELSE
			ROLLBACK	
	END
	
	IF ISNULL(@CERRORMSG,'')='' 
	BEGIN   
		--DROP TEMP TABLE RELATED TO TILL_MST
	 
	 DELETE FROM MSTTILL_REGIONM_MIRROR
	 DELETE FROM MSTTILL_STATE_MIRROR
	 DELETE FROM MSTTILL_CITY_MIRROR
	 DELETE FROM MSTTILL_AREA_MIRROR
	 DELETE FROM MSTTILL_LM01106_MIRROR
	 DELETE FROM MSTTILL_LMP01106_MIRROR
	 DELETE FROM MSTTILL_HD01106_MIRROR
	 DELETE FROM  MSTTILL_TILL_MST_MIRROR
	 DELETE FROM MSTTILL_TILL_LOCS_MIRROR
	 DELETE FROM  MSTTILL_USERS_MIRROR
	 DELETE FROM  MSTTILL_TILL_USERS_MIRROR
	 DELETE FROM  MSTTILL_TILL_DENO_MST_MIRROR
	 DELETE FROM  MSTTILL_TILL_SMS_REC_MIRROR
	 DELETE FROM  MSTTILL_TILL_SMS_REC_LOC_MIRROR
	 DELETE FROM  MSTTILL_TILL_SMS_VAR_MIRROR
	 DELETE FROM  MSTTILL_TILL_SMS_TMPLT_MIRROR
	   
	END
		
	SELECT @XN_TYPE AS MEMO_ID,@CERRORMSG AS ERRMSG   	  
END
--END PROCEDURE SP_MERGE_MIRROR_MSTTILL
