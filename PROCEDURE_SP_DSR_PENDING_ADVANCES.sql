CREATE PROCEDURE SP_DSR_PENDING_ADVANCES
(	
	@DTODT DATETIME,
	@CCUSTOMERCODE VARCHAR(20)='',
	@BESTIMATEENABLED BIT = 1,
	@BSHOW BIT,
	@LOC_ID VARCHAR(10)='',
	@BCALLEDFROMAPI BIT=0,
	@NAGEING INT =0,
	@NSUMMARY INT=0,
	@BIN_ID VARCHAR(10)=''
)
--WITH ENCRYPTION
AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 

      DECLARE @CUTOFF_DATE DATETIME 
	  SElect @CUTOFF_DATE=ISNULL(value,'') from config where config_option='CUTOFF_DATE_FOR_PENDING_ADV_CN_CR'
	
	   IF ISNULL(@DTODT,'') = ''
	   BEGIN
			SELECT 'CAN NOT ACCEPT A BLANK DATE.' AS ERRMSG
			GOTO END_PROC
	   END  
	   
	IF @BCALLEDFROMAPI=0
	 BEGIN
	 
		   		   
	   SELECT ADV_REC_NO AS MEMO_NO,ADV_REC_DT AS MEMO_DT,B.USER_CUSTOMER_CODE AS CUSTOMER_ID ,B.CUSTOMER_FNAME+' '+B.CUSTOMER_LNAME AS CUSTOMER_NAME,  
	   A.AMOUNT,ISNULL(C.ADJ_AMOUNT,0) AS ADJ_AMOUNT,A.AMOUNT-(ISNULL(C.ADJ_AMOUNT,0)) AS PENDING_AMOUNT, 
	   DATEDIFF(DD,A.ADV_REC_DT,@DTODT) AS AGEING  
	   FROM ARC01106 A     
	   JOIN CUSTDYM B ON A.CUSTOMER_CODE=B.CUSTOMER_CODE    
	   LEFT OUTER JOIN     
	  (
	   SELECT ADJ_MEMO_ID,SUM(A.AMOUNT) AS ADJ_AMOUNT  
	   FROM PAYMODE_XN_DET A     
	   JOIN CMM01106 B ON A.MEMO_ID=B.CM_ID  WHERE XN_TYPE='SLS'    
	   AND PAYMODE_CODE='0000002' AND B.CANCELLED=0 
	   AND (B.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)
	   GROUP BY ADJ_MEMO_ID
	   
	   UNION ALL
	       
	   SELECT A.ADJ_MEMO_ID,SUM(A.AMOUNT) AS ADJ_AMOUNT  
	   FROM PAYMODE_XN_DET A     
	   JOIN ARC01106 B ON A.MEMO_ID=B.ADV_REC_ID
	   WHERE PAYMODE_CODE='0000002' AND B.CANCELLED=0 AND XN_TYPE='ARC' GROUP BY A.ADJ_MEMO_ID
	   ) C    ON A.ADV_REC_ID=C.ADJ_MEMO_ID 
	   WHERE A.CANCELLED=0 AND A.ARC_TYPE=1 
	   AND ((@CUTOFF_DATE='' AND A.ADV_REC_DT<=@DTODT) OR (ISNULL(@CUTOFF_DATE,'')<>'' AND 
	   A.ADV_REC_DT BETWEEN @CUTOFF_DATE AND @DTODT))
	   AND A.AMOUNT-ISNULL(C.ADJ_AMOUNT,0)<>0
	   AND (@LOC_ID='' OR A.location_Code  =@LOC_ID)
	   AND A.AMOUNT-(ISNULL(C.ADJ_AMOUNT,0)) > 0 AND (B.CUSTOMER_CODE = @CCUSTOMERCODE OR @CCUSTOMERCODE='') 
	   AND @BSHOW = 1 AND A.ARCT=2
	 END
	 
	ELSE 
	 BEGIN
	   
	   IF OBJECT_ID ('TEMPDB..#TMP_PENDING_ADVANCES','U') IS NOT NULL
	      DROP TABLE #TMP_PENDING_ADVANCES
	      		   
	      		   
	    SELECT ADV_REC_NO AS MEMO_NO,ADV_REC_DT AS MEMO_DT,B.USER_CUSTOMER_CODE AS CUSTOMER_ID ,B.CUSTOMER_FNAME+' '+B.CUSTOMER_LNAME AS CUSTOMER_NAME,  
	   A.AMOUNT,ISNULL(C.ADJ_AMOUNT,0) AS ADJ_AMOUNT,A.AMOUNT-(ISNULL(C.ADJ_AMOUNT,0)) AS PENDING_AMOUNT, 
	   DATEDIFF(DD,A.ADV_REC_DT,@DTODT) AS AGEING  
	   INTO #TMP_PENDING_ADVANCES
	   FROM ARC01106 A     
	   JOIN CUSTDYM B ON A.CUSTOMER_CODE=B.CUSTOMER_CODE    
	   LEFT OUTER JOIN     
	  (
	   SELECT ADJ_MEMO_ID,SUM(A.AMOUNT) AS ADJ_AMOUNT  
	   FROM PAYMODE_XN_DET A     
	   JOIN CMM01106 B ON A.MEMO_ID=B.CM_ID  WHERE XN_TYPE='SLS'    
	   AND PAYMODE_CODE='0000002' AND B.CANCELLED=0 
	   AND B.MEMO_TYPE = 1 
	   GROUP BY ADJ_MEMO_ID
	   UNION ALL    
	   SELECT A.ADJ_MEMO_ID,SUM(A.AMOUNT) AS ADJ_AMOUNT  
	   FROM PAYMODE_XN_DET A     
	   JOIN ARC01106 B ON A.MEMO_ID=B.ADV_REC_ID
	   WHERE PAYMODE_CODE='0000002' AND B.CANCELLED=0 AND XN_TYPE='ARC' GROUP BY A.ADJ_MEMO_ID
	   ) C    ON A.ADV_REC_ID=C.ADJ_MEMO_ID 
	   WHERE A.CANCELLED=0 AND A.ARC_TYPE=1 
	   AND ((@CUTOFF_DATE='' AND A.ADV_REC_DT<=@DTODT) OR (ISNULL(@CUTOFF_DATE,'')<>'' AND 
	   A.ADV_REC_DT BETWEEN @CUTOFF_DATE AND @DTODT))
	    AND A.AMOUNT-ISNULL(C.ADJ_AMOUNT,0)<>0
	   AND (@LOC_ID='' OR A.location_Code  =@LOC_ID)
	   AND A.AMOUNT-(ISNULL(C.ADJ_AMOUNT,0)) > 0 AND (B.CUSTOMER_CODE = @CCUSTOMERCODE OR @CCUSTOMERCODE='') 
	   AND A.ARCT=2
	   
	   IF @NSUMMARY=1
	   BEGIN
	        
			 SELECT 'ADVANCES' AS TYPE,COUNT(*) AS TOTAL_MEMOES,
			 ISNULL(SUM(ISNULL(PENDING_AMOUNT,0)),0) AS AMOUNT,
			 0 AS QUANTITY 
			 FROM #TMP_PENDING_ADVANCES
			 WHERE AGEING>=@NAGEING
	   
	   END
	   ELSE
	   BEGIN
	       
	     SELECT TOP 100 * 
		 FROM #TMP_PENDING_ADVANCES
		 WHERE AGEING>=@NAGEING
		 ORDER BY AGEING DESC
	   
	   END
		 
	 END

END_PROC:
     
 END    
     
--********************************* END OF PROCEDURE SP_DSR_PENDING_ADVANCES
