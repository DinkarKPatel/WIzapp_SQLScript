CREATE PROCEDURE [DBO].[SAVETRAN_SECTIOND]       
(      
 @SUBSECTIONCODE   VARCHAR(7) = '',        
 @SECTIONCODE    VARCHAR(7) = '',      
 @SUBSECTIONNAME   VARCHAR(300) = '',      
 @ALIAS       VARCHAR(50) = '',      
 @ISACTIVE      BIT = 0 ,      
 @REMARKS      VARCHAR(50) = '',      
 @MFG_CATEGORY   INT = 0,        
 @EXCISABLE     BIT = 0,      
 @ERRMSG_OUT    VARCHAR(MAX) OUT,
 @BDELETE BIT=0       
)      
AS      
BEGIN      
 DECLARE @CSTEP INT  ,@ERRMSG VARCHAR(1000)    
 DECLARE @TEMP_SUBSECTIONCODE VARCHAR(7) = ''      
       
 BEGIN TRY   
 BEGIN TRANSACTION    
 SET @ERRMSG_OUT = ''      
 SET @ERRMSG=''
 SET @CSTEP='' 
  
  IF @BDELETE=1
    BEGIN
     IF @SUBSECTIONCODE='0000000'
	   BEGIN
		   SET @ERRMSG='DEFAULT SUB SECTION CAN NOT BE DELETED'
		   GOTO END_PROC
	   END
	   DELETE FROM SECTIOND WHERE SUB_SECTION_CODE  =@SUBSECTIONCODE
	   GOTO END_PROC
    END
          
  IF (RTRIM(LTRIM(@SUBSECTIONCODE)) = '')      
  BEGIN      
   IF EXISTS(SELECT TOP 1 'U'  FROM [SECTIOND]  WHERE [SUB_SECTION_NAME] = @SUBSECTIONNAME  AND SECTION_CODE =@SECTIONCODE)
   BEGIN      
    SET @CSTEP=5      
    SET @ERRMSG_OUT = 'SUBSECTION NAME: '+@SUBSECTIONNAME + ' ALREADY EXIST1.'      
    PRINT @ERRMSG_OUT     
    SET @ERRMSG= @ERRMSG_OUT
   END      
   ELSE      
   BEGIN      
    SET @CSTEP=10      
    EXEC DBO.GETNEXTKEY 'SECTIOND', 'SUB_SECTION_CODE', 7, '00', 1, '', 2, @TEMP_SUBSECTIONCODE OUTPUT       
          
    PRINT 'SUBSECTION CODE: ' + @TEMP_SUBSECTIONCODE      
          
    SET @CSTEP=15      
    INSERT SECTIOND (SUB_SECTION_CODE, SECTION_CODE, SUB_SECTION_NAME, LAST_UPDATE, ALIAS, INACTIVE, REMARKS,MFG_CATEGORY, EXCISABLE, LAST_MODIFIED_ON)      
    VALUES (@TEMP_SUBSECTIONCODE, @SECTIONCODE, @SUBSECTIONNAME, GETDATE(), @ALIAS, @ISACTIVE, @REMARKS, @MFG_CATEGORY, @EXCISABLE, GETDATE())      
          
    SET @ERRMSG_OUT = 'SECTION DETAIL: '+ @SUBSECTIONNAME +' CREATED SUCCESSFULLY.'      
    PRINT @ERRMSG_OUT      
   END      
  END      
  ELSE      
  BEGIN      
   SET @TEMP_SUBSECTIONCODE = @SUBSECTIONCODE      
   IF NOT EXISTS(SELECT [SUB_SECTION_CODE] FROM [SECTIOND] WHERE [SUB_SECTION_CODE] = @SUBSECTIONCODE)      
   BEGIN      
    IF EXISTS(SELECT [SUB_SECTION_NAME] FROM [SECTIOND] WHERE [SUB_SECTION_NAME] = @SUBSECTIONNAME)      
    BEGIN      
     SET @CSTEP=20      
     SET @ERRMSG_OUT = 'SUBSECTION NAME: '+@SUBSECTIONNAME + ' ALREADY EXIST.'      
     PRINT @ERRMSG_OUT 
      SET @ERRMSG= @ERRMSG_OUT     
    END      
    ELSE      
    BEGIN      
     SET @CSTEP=25      
     EXEC DBO.GETNEXTKEY 'SECTIOND', 'SUB_SECTION_CODE', 7, '00', 1, '', 2, @TEMP_SUBSECTIONCODE OUTPUT       
           
     PRINT 'SUBSECTION CODE: ' + @TEMP_SUBSECTIONCODE      
           
     SET @CSTEP=30      
     INSERT SECTIOND (SUB_SECTION_CODE, SECTION_CODE, SUB_SECTION_NAME, LAST_UPDATE, ALIAS, INACTIVE, REMARKS,MFG_CATEGORY, EXCISABLE, LAST_MODIFIED_ON)      
     VALUES (@TEMP_SUBSECTIONCODE, @SECTIONCODE, @SUBSECTIONNAME, GETDATE(), @ALIAS, @ISACTIVE, @REMARKS, @MFG_CATEGORY, @EXCISABLE, GETDATE())      
           
     SET @ERRMSG_OUT = 'SECTION DETAIL: '+ @SUBSECTIONNAME +' CREATED SUCCESSFULLY.'      
     PRINT @ERRMSG_OUT      
    END      
   END      
   ELSE      
   BEGIN      
    SET @CSTEP=30      
    PRINT 'SUB SECTION CODE: ' + @TEMP_SUBSECTIONCODE      
    
  
    IF EXISTS (SELECT TOP 1 'U' FROM [SECTIOND] WHERE [SUB_SECTION_NAME] = @SUBSECTIONNAME  AND SECTION_CODE =@SECTIONCODE AND SUB_SECTION_CODE <> @TEMP_SUBSECTIONCODE    )
	BEGIN
		SET @CSTEP=20
		SET @ERRMSG_OUT = 'SECTION NAME: '+@SUBSECTIONNAME + ' ALREADY EXIST.'
		PRINT @ERRMSG_OUT
		SET @ERRMSG=@ERRMSG_OUT
	END
	ELSE
	BEGIN     
    UPDATE [SECTIOND]      
    SET SECTION_CODE = @SECTIONCODE,       
      SUB_SECTION_NAME = @SUBSECTIONNAME,       
      LAST_UPDATE = GETDATE(),       
      ALIAS = @ALIAS,       
      INACTIVE = @ISACTIVE,       
      REMARKS = @REMARKS,       
      MFG_CATEGORY = @MFG_CATEGORY,       
      EXCISABLE=@EXCISABLE,       
      LAST_MODIFIED_ON = GETDATE()      
    WHERE SUB_SECTION_CODE = @TEMP_SUBSECTIONCODE      
          
    SET @ERRMSG_OUT = 'SECTION DETAIL: '+ @SUBSECTIONNAME +' UPDATED SUCCESSFULLY.'      
    PRINT @ERRMSG_OUT      
   END 
   
   
   END     
  END      
 END TRY        
 BEGIN CATCH        
  SET @ERRMSG_OUT='ERROR: [P]: SAVETRAN_SECTIOND, [STEP]: '+CAST(@CSTEP AS VARCHAR(5))+', [MESSAGE]: ' + ERROR_MESSAGE()      
  PRINT @ERRMSG_OUT      
  SET @ERRMSG=@ERRMSG_OUT      
  GOTO END_PROC        
 END CATCH         
      
END_PROC:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL( @ERRMSG,'')='' 
			COMMIT TRANSACTION
			
		ELSE
			ROLLBACK
	END

	SELECT @ERRMSG AS ERRMSG    
       
END
