create PROCEDURE SPSIS_INSERTSKUBARCODE
(
 @nSpId VARCHAR(50)='',
 @CXNTYPE VARCHAR(10),
 @cErrmsg VARCHAR(MAX) output

)
AS
BEGIN

BEGIN TRY

        DECLARE @CUPLOADTABLE_DET VARCHAR(100),@CDEPT_ID VARCHAR(100)




		IF @CXNTYPE='OPS'
		BEGIN

		     SET @CUPLOADTABLE_DET='OPS_SIS_OPS_UPLOAD'
			/* SET @CDEPT_ID='DEPT_ID'*//*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=DEPT_ID FROM OPS_SIS_OPS_UPLOAD WHERE SP_ID=@nSpId

		END
		ELSE IF @CXNTYPE='PUR'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='PUR_PID01106_UPLOAD'
			  /*SET @CDEPT_ID='LEFT(A.MRR_ID,2)'*//*Rohit 01-11-2024*/
			  SELECT @CDEPT_ID=LOCATION_CODE FROM PUR_PIM01106_UPLOAD WHERE SP_ID=@nSpId
			

		END
		ELSE IF @CXNTYPE='PRT'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='PRT_RMD01106_UPLOAD'
			 --SET @CDEPT_ID='LEFT(A.RM_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM PRT_RMM01106_UPLOAD WHERE SP_ID=@nSpId

		END
		ELSE IF @CXNTYPE='WSL'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='WSL_IND01106_UPLOAD'
			 --SET @CDEPT_ID='LEFT(A.INV_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM WSL_INM01106_UPLOAD WHERE SP_ID=@nSpId
		END
		ELSE IF @CXNTYPE='SLS'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='SLS_CMD01106_UPLOAD'
			 --SET @CDEPT_ID='LEFT(A.CM_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM SLS_CMM01106_UPLOAD WHERE SP_ID=@nSpId

		END
        ELSE IF @CXNTYPE='APP'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='APP_APD01106_UPLOAD'
			 --SET @CDEPT_ID='LEFT(A.MEMO_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM APP_APM01106_UPLOAD WHERE SP_ID=@nSpId

		END
        ELSE IF @CXNTYPE='APR'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='APR_APPROVAL_RETURN_DET_UPLOAD'
			 --SET @CDEPT_ID='LEFT(A.MEMO_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM APR_APPROVAL_RETURN_MST_UPLOAD WHERE SP_ID=@nSpId
		END
		ELSE IF @CXNTYPE='GRNPS'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='GRNPS_GRN_PS_DET_UPLOAD'
			 --SET @CDEPT_ID='LEFT(A.MEMO_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM GRNPS_GRN_PS_MST_UPLOAD WHERE SP_ID=@nSpId

		END
		ELSE IF @CXNTYPE='JWI'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='JWI_JOBWORK_ISSUE_DET_UPLOAD'
			 --SET @CDEPT_ID='LEFT(A.ISSUE_ID,2)'/*Rohit 01-11-2024*/
			  SELECT @CDEPT_ID=LOCATION_CODE FROM JWI_JOBWORK_ISSUE_MST_UPLOAD WHERE SP_ID=@nSpId

		END
		ELSE IF @CXNTYPE='JWR'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='JWR_JOBWORK_RECEIPT_DET_UPLOAD'
			 --SET @CDEPT_ID='LEFT(A.RECEIPT_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM JWR_JOBWORK_RECEIPT_MST_UPLOAD WHERE SP_ID=@nSpId
		END
		ELSE IF @CXNTYPE='DNPS'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='DNPS_DNPS_DET_UPLOAD'
			  --SET @CDEPT_ID='LEFT(A.PS_ID,2)'/*Rohit 01-11-2024*/
			  SELECT @CDEPT_ID=LOCATION_CODE FROM DNPS_DNPS_MST_UPLOAD WHERE SP_ID=@nSpId
		END
        ELSE IF @CXNTYPE='WPS'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='WPS_WPS_DET_UPLOAD'
			 --SET @CDEPT_ID='LEFT(A.PS_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM WPS_WPS_MST_UPLOAD WHERE SP_ID=@nSpId
		END
		ELSE IF @CXNTYPE='RPS'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='RPS_RPS_DET_UPLOAD'
			-- SET @CDEPT_ID='LEFT(A.CM_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM RPS_RPS_MST_UPLOAD WHERE SP_ID=@nSpId

		END
		ELSE IF @CXNTYPE='CNC'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='CNC_ICD01106_UPLOAD'
			 --SET @CDEPT_ID='LEFT(A.CNC_MEMO_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM CNC_ICM01106_UPLOAD WHERE SP_ID=@nSpId
		END
		ELSE IF @CXNTYPE='WSR'
		BEGIN
		    
		     SET @CUPLOADTABLE_DET='WSR_CND01106_upload'
			 --SET @CDEPT_ID='LEFT(A.CN_ID,2)'/*Rohit 01-11-2024*/
			 SELECT @CDEPT_ID=LOCATION_CODE FROM WSR_CNM01106_upload WHERE SP_ID=@nSpId

		END

		

		DECLARE @DTSQL NVARCHAR(MAX),@NQTYNAME VARCHAR(100),@CROW_ID VARCHAR(100)
		IF @CXNTYPE='OPS'
		BEGIN
		   SET @NQTYNAME='XN_QTY'
		   SET @CROW_ID='A.PRODUCT_CODE'
		END
		ELSE
		BEGIN
		   SET @NQTYNAME='QUANTITY'
		     SET @CROW_ID='ROW_ID'
		END
		
		      SELECT A.Product_code,A.Article_no,A.Para2_name,A.Para3_name ,
			         CAST('' AS varchar (100)) AS NEW_PRODUCT_CODE
			  INTO #TMPMISSINBARCODE
			  FROM SIS_SKUNAMES_UPLOAD A  WITH (NOLOCK)
			  LEFT JOIN SKU B WITH (NOLOCK) ON A.product_code=B.product_code 
			  WHERE A.SP_ID =@nSpId AND B.product_code IS NULL

			  UPDATE A SET NEW_PRODUCT_CODE=B.product_Code FROM #TMPMISSINBARCODE A
			  JOIN sku_names B ON A.Article_no =B.article_no AND A.Para2_name =B.para2_name 
			  WHERE B.product_Code<>''

			   UPDATE A SET NEW_PRODUCT_CODE=B.product_Code 
			   FROM #TMPMISSINBARCODE A
			  JOIN sku_names B ON A.Para3_name =B.article_no AND A.Para2_name =B.para2_name 
			  WHERE B.product_Code<>''

			  insert into MISSING_BARCODE(product_code,xn_type,QUANTITY,DEPT_ID,ROW_ID)
			  select NEW_PRODUCT_CODE ,@CXNTYPE,1 as qty ,'' as dept_id ,product_code as row_id
			  from #TMPMISSINBARCODE
			  WHERE NEW_PRODUCT_CODE<>''

			

	
		IF @CXNTYPE<>'APR'
		BEGIN

		    SET @DTSQL= N' update  A set PRODUCT_CODE=TMP.NEW_PRODUCT_CODE FROM '+@CUPLOADTABLE_DET+' A WITH (NOLOCK)
			               JOIN #TMPMISSINBARCODE TMP ON A.PRODUCT_CODE=TMP.PRODUCT_CODe
						   LEFT JOIN SKU B WITH (NOLOCK) ON A.product_code=B.product_code 
	            		   WHERE A.SP_ID='''+@nSpId+''' AND B.product_code IS NULL  AND TMP.NEW_PRODUCT_CODE<>'''' '
			 PRINT @DTSQL
			 EXEC SP_EXECUTESQL @DTSQL
		    

		    SET @DTSQL= N' INSERT INTO MISSING_BARCODE(DEPT_ID,PRODUCT_CODE,XN_TYPE,QUANTITY,ROW_ID)
							select '''+@CDEPT_ID+''' AS DEPT_ID, A.PRODUCT_CODE,'''+@CXNTYPE+'''  ,
								  '+@NQTYNAME+'  AS QUANTITY,'+@CROW_ID+' AS ROW_ID
							FROM '+@CUPLOADTABLE_DET+' A WITH (NOLOCK)
						   LEFT JOIN SKU B WITH (NOLOCK) ON A.product_code=B.product_code 
	            		   WHERE A.SP_ID='''+@nSpId+''' AND B.product_code IS NULL '
			 PRINT @DTSQL
			 EXEC SP_EXECUTESQL @DTSQL

			


			SET @DTSQL= N' update  A set PRODUCT_CODE=''PUMA-001'' FROM '+@CUPLOADTABLE_DET+' A WITH (NOLOCK)
						   LEFT JOIN SKU B WITH (NOLOCK) ON A.product_code=B.product_code 
	            		   WHERE A.SP_ID='''+@nSpId+''' AND B.product_code IS NULL '
			 PRINT @DTSQL
			 EXEC SP_EXECUTESQL @DTSQL



			


		 END
		 ELSE
		 BEGIN

		    SET @DTSQL= N' update  A set APD_PRODUCT_CODE=TMP.NEW_PRODUCT_CODE FROM '+@CUPLOADTABLE_DET+' A WITH (NOLOCK)
			               JOIN #TMPMISSINBARCODE TMP ON A.APD_PRODUCT_CODE=TMP.PRODUCT_CODe
						   LEFT JOIN SKU B WITH (NOLOCK) ON A.APD_PRODUCT_CODE=B.product_code 
	            		   WHERE A.SP_ID='''+@nSpId+''' AND B.product_code IS NULL AND TMP.NEW_PRODUCT_CODE <>'''' '
			 PRINT @DTSQL
			 EXEC SP_EXECUTESQL @DTSQL

		   
		    SET @DTSQL= N' INSERT INTO MISSING_BARCODE(DEPT_ID,PRODUCT_CODE,XN_TYPE,QUANTITY,ROW_ID)
							select '''+@CDEPT_ID+''' AS DEPT_ID, A.APD_PRODUCT_CODE,'''+@CXNTYPE+'''  ,
								  '+@NQTYNAME+'  AS QUANTITY,'+@CROW_ID+' AS ROW_ID
							FROM '+@CUPLOADTABLE_DET+' A WITH (NOLOCK)
						   LEFT JOIN SKU B WITH (NOLOCK) ON A.APD_PRODUCT_CODE=B.product_code 
	            		   WHERE A.SP_ID='''+@nSpId+''' AND B.product_code IS NULL '
			 PRINT @DTSQL
			 EXEC SP_EXECUTESQL @DTSQL

		   	SET @DTSQL= N' update  A set APD_PRODUCT_CODE=''PUMA-001'' FROM '+@CUPLOADTABLE_DET+' A WITH (NOLOCK)
						   LEFT JOIN SKU B WITH (NOLOCK) ON A.APD_PRODUCT_CODE=B.product_code 
	            		   WHERE A.SP_ID='''+@nSpId+''' AND B.product_code IS NULL '
			 PRINT @DTSQL
			 EXEC SP_EXECUTESQL @DTSQL



			

		 END


END TRY

BEGIN CATCH
	SELECT @CERRMSG='P:SPSIS_INSERTSKUBARCODE  Id:'+ERROR_MESSAGE()
	GOTO EXIT_PROC
END CATCH

EXIT_PROC:


END