CREATE PROCEDURE SP_GETDATASENTINFO
@CXNTYPE VARCHAR(20),
@CTABLEPREFIX VARCHAR(100),
@CTABLESUFFIX VARCHAR(100),
@CMEMOID VARCHAR(100),
@CTARGETDEPTID VARCHAR(10)
--WITH ENCRYPTION
AS
BEGIN
	PRINT 'ENTER SP_GETDATASENTINFO-1' 
	DECLARE @CCMD NVARCHAR(MAX),@CTEMPDATASENTINFONAME VARCHAR(100),@CTABLENAME VARCHAR(100),
			@CSENDTABLENAME VARCHAR(100),@NSTEP INT,@BPROCEED BIT,@NSOURCETABLERECCOUNT INT,@NRECCOUNT INT
	
	SET @CTEMPDATASENTINFONAME='TMP_'+@CXNTYPE+'_DATASENTINFO'
	
	SET @NSTEP=10
						
	PRINT 'ENTER SP_GETDATASENTINFO-2'
	IF OBJECT_ID(@CTEMPDATASENTINFONAME,'U') IS NOT NULL
	BEGIN
		SET @CCMD=N'DROP TABLE '+@CTEMPDATASENTINFONAME
		EXEC SP_EXECUTESQL @CCMD
	END
	
	SET @NSTEP=20
	PRINT 'ENTER SP_GETDATASENTINFO-3'
	SET @CCMD=N'SELECT TABLENAME,XNS_MERGING_ORDER AS RECCOUNT INTO '+@CTEMPDATASENTINFONAME+' FROM XNSINFO WHERE 1=2'
	EXEC SP_EXECUTESQL @CCMD
	
	IF CURSOR_STATUS('GLOBAL','DATASENTCUR') IN (0,1)  
	BEGIN
		CLOSE DATASENTCUR
		DEALLOCATE DATASENTCUR
	END
	
	SET @NSTEP=30
	DECLARE DATASENTCUR CURSOR FOR SELECT DISTINCT TABLENAME FROM XNSINFO WHERE XN_TYPE=@CXNTYPE
	OPEN DATASENTCUR
	
	FETCH NEXT FROM DATASENTCUR INTO @CTABLENAME
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @NSTEP=40
		SET @CSENDTABLENAME=@CTABLEPREFIX+@CTABLENAME+@CTABLESUFFIX
		
		PRINT 'ENTER SP_GETDATASENTINFO-4'+@CTABLENAME
		IF OBJECT_ID(@CSENDTABLENAME,'U') IS NOT NULL
		BEGIN
			SET @NSTEP=50
			SET @CCMD=' IF EXISTS (SELECT TOP 1 * FROM '+@CSENDTABLENAME+')
						INSERT '+@CTEMPDATASENTINFONAME+
					  ' SELECT '''+@CTABLENAME+''',COUNT(*) FROM '+@CSENDTABLENAME
			EXEC SP_EXECUTESQL @CCMD
		END
		
					
		IF @CTABLENAME='EMPLOYEE'
		BEGIN
			SET @CSENDTABLENAME=@CTABLEPREFIX+'EMPLOYEE_HEAD'+@CTABLESUFFIX
			IF OBJECT_ID(@CSENDTABLENAME,'U') IS NOT NULL
			BEGIN
				SET @NSTEP=55
				SET @CCMD=' IF EXISTS (SELECT TOP 1 * FROM '+@CSENDTABLENAME+')
								UPDATE A SET RECCOUNT=RECCOUNT+B.CNT
								FROM '+@CTEMPDATASENTINFONAME+' A JOIN (SELECT COUNT(*) AS CNT FROM '+@CSENDTABLENAME+') B
								ON 1=1 WHERE A.TABLENAME=''EMPLOYEE'''
				EXEC SP_EXECUTESQL @CCMD
			END
		END
		
		FETCH NEXT FROM DATASENTCUR INTO @CTABLENAME
	END

	CLOSE DATASENTCUR
	DEALLOCATE DATASENTCUR
	
	SET @NSTEP=60	
	PRINT 'ENTER SP_GETDATASENTINFO-5'
	
	SELECT 'DATASENTINFO',@CTEMPDATASENTINFONAME,@CMEMOID,@CTARGETDEPTID,''

END_PROC:		

END
--- 'END OF CREATING PROCEDURE SP_GETDATASENTINFO'
