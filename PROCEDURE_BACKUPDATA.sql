--*** PROCEDURE TO TAKE BACKUP OF SPECIFIED DATABASE TO A GIVEN PATH
CREATE PROCEDURE BACKUPDATA
		@CDB VARCHAR(40),
		@CBACKUPPATH VARCHAR(1000),
		@CPASSWORD VARCHAR(100)='',
		@cErrormsg VARCHAR(MAX) OUTPUT
--		WITH ENCRYPTION
AS
BEGIN	
	
BEGIN TRY
	DECLARE @CCMD NVARCHAR(MAX),
			@CDBDEVICE VARCHAR(40),
			@CBACKUPFILE VARCHAR(254),
			@CPASSWORDSTR VARCHAR(200),@cStep VARCHAR(4),
			@CROWID VARCHAR(50)
	
	SET @cStep='10'
	SELECT @CROWID=NEWID()
	
	INSERT BACKUPLOG(START_TIME, END_TIME, ROW_ID,BKP_TYPE)
	SELECT GETDATE() AS START_TIME,'' AS END_TIME,@CROWID AS ROW_ID,1 AS BKP_TYPE

	SET @cStep='20'
	/*
	BACKUP DATABASE [JMHO] TO  DISK = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.MSSQLSERVER\MSSQL\Backup\jmho,bak' WITH NOFORMAT
    , INIT---Overwrite / , NOINIT--Append
	, NAME = N'JMHO-Full Database Backup'
	, SKIP
	, NOREWIND
	, NOUNLOAD
	,  STATS = 10
	*/
	IF @CPASSWORD <> ''
		SET @CPASSWORDSTR = ' WITH PASSWORD = ''' + @CPASSWORD + ''''
	ELSE
		SET @CPASSWORDSTR = ''
	
	SET @CDBDEVICE = @CDB + '_DATA'

	IF UPPER(RIGHT(@CBACKUPPATH,4)) <> '.BAK'
		SET @CBACKUPFILE = @CBACKUPPATH + @CDBDEVICE + '.BAK'
	ELSE 
		SET @CBACKUPFILE = @CBACKUPPATH
	
	SET @cStep='30'
	print 'Start backup step#3 of :'+@cDb
	--SET @CCMD = N' BACKUP DATABASE ' + @CDB + ' TO ' + @CDBDEVICE + @CPASSWORDSTR+' WITH INIT'
	SET @CCMD = N' BACKUP DATABASE ' + @CDB + ' TO DISK = N''' + @CBACKUPFILE + @CPASSWORDSTR+''' WITH INIT'--OverWrite
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD

	
	SET @cStep='40'
	UPDATE BACKUPLOG SET END_TIME=GETDATE() WHERE ROW_ID=@CROWID
	
	GOTO END_PROC
END TRY

BEGIN CATCH
	SET @cErrormsg='Error in BackupData at Step#'+@cStep+' '+error_message()
	GOTO END_PROC
END CATCH

END_PROC:	
	
END