create PROC SP_PC_EXPENSE_FILTER(@FILTER NVARCHAR(MAX),@MODE INT,@SPID INT)
AS
DECLARE @QUERY NVARCHAR(MAX)
DECLARE @CTABLE NVARCHAR(100)
--(dinkar) Replace  left(memoid,2) to Location_code 
IF @MODE = 1 
	BEGIN
		IF @FILTER = ''
			SELECT 'ENTER FILTER VALUE' AS ERROR
		ELSE
			SET @QUERY = N'	SELECT DISTINCT A.PEM_MEMO_ID AS MEMO_ID ,PEM_MEMO_NO AS MEMO_NO,
							CONVERT(VARCHAR,PEM_MEMO_DT,106) AS MEMO_DT,
							--SUM(CASE WHEN XN_TYPE = ''DR'' THEN XN_AMOUNT ELSE -1 * XN_AMOUNT END)   AS XN_AMOUNT,
							SUM(XN_AMOUNT) AS XN_AMOUNT,
							--XN_TYPE AS DISPLAY_XN_TYPE ,
							CASE WHEN CANCELLED=0 THEN '''' ELSE ''CANCELLED'' END AS CANCELLED,
							SUM(CASE WHEN XN_TYPE=''DR'' THEN XN_AMOUNT ELSE 0 END) AS DEBIT_AMOUNT,
                            SUM(CASE WHEN XN_TYPE=''CR'' THEN XN_AMOUNT ELSE 0 END) AS CREDIT_AMOUNT,
							U.USERNAME
							FROM PEM01106  A (NOLOCK)
							JOIN PED01106  B (NOLOCK) ON A.PEM_MEMO_ID= B.PEM_MEMO_ID 
							JOIN LMV01106 L (NOLOCK) ON B.AC_CODE = L.AC_CODE 
							JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=a.location_code
							JOIN USERS U (NOLOCK) ON U.USER_CODE = A.USER_CODE
							WHERE '+ @FILTER + ' 
							GROUP BY 
							A.PEM_MEMO_ID,PEM_MEMO_NO,PEM_MEMO_DT,CANCELLED,U.USERNAME '
							
			--PRINT 'FILTER = ' + @FILTER + ' QUERY = ' + @QUERY
			EXEC SP_EXECUTESQL @QUERY
	END
ELSE
	BEGIN
		SET @CTABLE = 'MASTER..TEMP_PC_EXPENSE_' + RTRIM(LTRIM(STR(@SPID)))--CONVERT(VARCHAR,@SPID,0)
		IF OBJECT_ID(@CTABLE,'U') IS NOT NULL
			BEGIN
				SET @QUERY = N'DROP TABLE ' + @CTABLE
				--PRINT @QUERY
				EXEC SP_EXECUTESQL @QUERY
			END	
			
		SET @QUERY = N'	SELECT DISTINCT A.PEM_MEMO_ID AS MEMO_ID ,PEM_MEMO_NO AS MEMO_NO,
						CONVERT(VARCHAR,PEM_MEMO_DT,106) AS MEMO_DT,
						--SUM(CASE WHEN XN_TYPE = ''DR'' THEN XN_AMOUNT ELSE -1 * XN_AMOUNT END)   AS XN_AMOUNT,
						SUM(XN_AMOUNT) AS XN_AMOUNT,
						--XN_TYPE AS DISPLAY_XN_TYPE  ,
						CASE WHEN CANCELLED=0 THEN '''' ELSE ''CANCELLED'' END AS CANCELLED,
						SUM(CASE WHEN XN_TYPE=''DR'' THEN XN_AMOUNT ELSE 0 END) AS DEBIT_AMOUNT,
						SUM(CASE WHEN XN_TYPE=''CR'' THEN XN_AMOUNT ELSE 0 END) AS CREDIT_AMOUNT
						,U.USERNAME
						INTO '+@CTABLE+' 
						FROM PEM01106  A 
						JOIN PED01106  B ON A.PEM_MEMO_ID= B.PEM_MEMO_ID 
						JOIN LMV01106 L ON B.AC_CODE = L.AC_CODE 
						JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=a.location_code
						JOIN USERS U (NOLOCK) ON U.USER_CODE = A.USER_CODE
						WHERE '+ @FILTER + ' 
						GROUP BY 
						A.PEM_MEMO_ID,PEM_MEMO_NO,PEM_MEMO_DT,CANCELLED,U.USERNAME	'
		
		--PRINT 'FILTER = ' + @FILTER + ' QUERY = ' + @QUERY
		EXEC SP_EXECUTESQL @QUERY
		
		--SET @CTABLE = N'SELECT * FROM '+@CTABLE
		PRINT @CTABLE
		--EXEC SP_EXECUTESQL @CTABLE
		
END
