CREATE PROC SP3S_CREATE_PMTDB
@cDbPara VARCHAR(200)='',
@cPmtDbPara VARCHAR(200)='',
@cFilenameSuffix VARCHAR(10)=''
AS 
BEGIN
SET NOCOUNT ON
DECLARE @cMainDB VARCHAR(100),@cPmtDB VARCHAR(200),@PATH VARCHAR(100),@CCMD NVARCHAR(MAX),@ERR INT=0,@ERR_MSG VARCHAR(100)='',
@cFileName VARCHAR(200)

IF @cDbPara=''
	SELECT @cPmtDB=DB_NAME()+'_PMT',@cMainDb=DB_NAME()
ELSE
	SELECT @cPmtDB=@cPmtDbPara,@cMainDb=@cDbPara

SET @cFileName=@cPmtDB+@cFilenameSuffix

SELECT @PATH=REVERSE(SUBSTRING(REVERSE(FILENAME),CHARINDEX('\',REVERSE(FILENAME),1),1000)) FROM MASTER..SYSDATABASES WHERE NAME=@cMainDB
PRINT @PATH
SET @CCMD=N'CREATE DATABASE ['+@cPmtDB+'] ON  PRIMARY 
(NAME = N'''+@cPmtDB+''', FILENAME = N'''+@PATH+@cFileName+'.MDF'')
LOG ON 
(NAME = N'''+@cPmtDB+'_LOG'', FILENAME = N'''+@PATH+@cFileName+'_log.LDF'')'
IF NOT EXISTS(SELECT * FROM SYS.DATABASES WHERE NAME=@cPmtDB)
   BEGIN
     EXEC(@CCMD)
     SET @ERR=CAST(@@ERROR AS INT)
     IF @ERR!=0
        SET @ERR_MSG='ERROR WHILE CREATING DATABASE'
   END  

   IF ISNULL(@ERR_MSG,'')=''
	   EXEC SP3S_CRT_CUSTOMER_CRM 
	   @cPmtDbPara=@cPmtDb,
	   @cErrmsg=@ERR_MSG OUTPUT

  

IF @ERR!=0
   GOTO FINISH

  
FINISH:
SELECT @ERR_MSG ERROR_MSG
SET NOCOUNT OFF
END
