CREATE PROCEDURE SP3S_CALC_GST_PO--(LocId 3 digit change by Sanjay:04-11-2024)
@nSpId VARCHAR(40),
@CERRORMSG VARCHAR(MAX) OUTPUT,
@CLOCID varchar(4)=''
AS
BEGIN
	DECLARE @cSTEP VARCHAR(10),@CPARTYSTATECODE VARCHAR(20),@DPODT DATETIME

	SET @cSTEP = 67.8
	EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

	DECLARE @NFREIGHT NUMERIC(10,2),@NPACKING NUMERIC(10,2),@NINSURANCE NUMERIC(10,2),@NOC NUMERIC(10,2)
		
	INSERT GST_TAXINFO_CALC	WITH (ROWLOCK) ( PRODUCT_CODE, SP_ID ,NET_VALUE,TAX_METHOD,ROW_ID,QUANTITY,TARGET_DEPT_ID,SOURCE_DEPT_ID,MRP,HSN_CODE)  
	SELECT PRODUCT_CODE,@NSPID AS SP_ID,
	ROUND(((A.PURCHASE_PRICE*A.INVOICE_QUANTITY)-(A.PURCHASE_PRICE*A.INVOICE_QUANTITY*ISNULL(B.DISCOUNT_PERCENTAGE,0)/100)),2) AS NET_VALUE
	,B.BILL_LEVEL_TAX_METHOD AS TAX_METHOD,
	ROW_ID,INVOICE_QUANTITY,'' AS PARTY_DEPT_ID,
	CASE WHEN ISNULL(B.PO_FOR_DEPT_ID,'')<>'' THEN B.PO_FOR_DEPT_ID ELSE  B.location_Code END as DEPT_ID,
	A.MRP,(CASE WHEN ISNULL(A.HSN_CODE,'') IN ('','0000000000')
	THEN C.HSN_CODE ELSE A.HSN_CODE END) AS HSN_CODE FROM PO_POD01106_UPLOAD A(NOLOCK)
	JOIN PO_POM01106_UPLOAD B(NOLOCK) ON A.SP_ID=B.SP_ID
	JOIN ARTICLE C(NOLOCK) ON C.ARTICLE_CODE=A.ARTICLE_CODE
	WHERE A.SP_ID=@nSPId and isnull(A.INVOICE_QUANTITY,0)<>0
		
	SET @cSTEP = 68
	EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1
		
		UPDATE A SET OH_TAX_METHOD=BILL_LEVEL_TAX_METHOD
		FROM  PO_POM01106_UPLOAD A
	    WHERE SP_ID=@NSPID
		
	INSERT GST_TAXINFO_CALC_OH	( SP_ID, FREIGHT, OTHER_CHARGES, FREIGHT_HSN_CODE, OTHER_CHARGES_HSN_CODE, OH_TAX_METHOD, DO_NOT_CALC_GST_OH )  
	SELECT @NSPID AS SP_ID, FREIGHT, OTHER_CHARGES, FREIGHT_HSN_CODE, OTHER_CHARGES_HSN_CODE,  
	1 AS  OH_TAX_METHOD, 0 AS  DO_NOT_CALC_GST_OH 
	FROM PO_POM01106_UPLOAD A(NOLOCK)
	WHERE A.SP_ID=@nSPId
	AND (ISNULL(FREIGHT,0)+ISNULL(OTHER_CHARGES,0))<>0
	

	DECLARE @CPARTY_GSTN_NO VARCHAR(20),@BREGISTERED int
		
	SET @cSTEP = 68.2	
	EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1

	SELECT TOP 1 @CPARTY_GSTN_NO=AC_GST_NO,@CPARTYSTATECODE=B.AC_GST_STATE_CODE,@DPODT=PO_DT
	FROM PO_POM01106_UPLOAD A(NOLOCK) JOIN LMP01106 B(NOLOCK) ON A.AC_CODE=B.AC_CODE WHERE SP_ID=@nSpId
				
	SELECT @BREGISTERED=ISNULL(REGISTERED_GST_DEALER,0) FROM LMP01106 A WITH (NOLOCK) 
	JOIN PO_POM01106_UPLOAD B (nolock) ON A.AC_CODE=B.AC_CODE
	WHERE SP_ID=@nSPId
		
	
	SET @cSTEP = 68.4
	EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1
	    
	EXEC SP3S_GST_TAX_CAL
	@CXN_TYPE='PO',
	@CMEMO_ID='',
	@DMEMO_DT=@DPODT,
	@NSPID=@NSPID,
	@CPARTYSTATE_CODE=@CPARTYSTATECODE,
	@BPARTYREGISTERED=@BREGISTERED,
	@CPARTY_GSTN_NO=@CPARTY_GSTN_NO,
	@CERRMSG=@CERRORMSG OUTPUT,
	@cLocationId=@CLOCID
	  
	IF ISNULL(@CERRORMSG,'')<>''
		GOTO END_PROC
		  
	SET @cSTEP = 68.6

	EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1
		
	UPDATE A  SET HSN_CODE=B.HSN_CODE,GST_PERCENTAGE=B.GST_PERCENTAGE,
	IGST_AMOUNT=B.IGST_AMOUNT,CGST_AMOUNT=B.CGST_AMOUNT,SGST_AMOUNT=B.SGST_AMOUNT,
	XN_VALUE_WITHOUT_GST=B.XN_VALUE_WITHOUT_GST,XN_VALUE_WITH_GST=B.XN_VALUE_WITH_GST,
	Gst_Cess_Percentage =ISNULL(B.Gst_Cess_Percentage,0),
	Gst_Cess_aMOUNT =ISNULL(B.Gst_Cess_aMOUNT,0)
	FROM GST_TAXINFO_CALC B (NOLOCK)
	JOIN PO_POD01106_UPLOAD A WITH (ROWLOCK) ON B.ROW_ID=A.ROW_ID  AND a.SP_ID=b.sp_id
	WHERE A.SP_ID=@nSpId
	

	SET @cSTEP = 68.8

	EXEC SP_CHKXNSAVELOG 'PO',@cSTEP,0,@NSPID,'',1		
			
	UPDATE A SET  FREIGHT_HSN_CODE=ISNULL(B.FREIGHT_HSN_CODE,'0000000000'),
	OTHER_CHARGES_HSN_CODE=ISNULL(B.OTHER_CHARGES_HSN_CODE,'0000000000'),
    FREIGHT_GST_PERCENTAGE=ISNULL(B.FREIGHT_GST_PERCENTAGE,0),
    OTHER_CHARGES_GST_PERCENTAGE=ISNULL(B.OTHER_CHARGES_GST_PERCENTAGE,0),
	FREIGHT_TAXABLE_VALUE=B.FREIGHT_TAXABLE_VALUE,
	FREIGHT_IGST_AMOUNT=(CASE WHEN ISNULL(ISIGST,0)=1 THEN B.FREIGHT_GST_AMOUNT ELSE 0 END),
	FREIGHT_CGST_AMOUNT=(CASE WHEN ISNULL(ISIGST,0)=0 THEN B.FREIGHT_GST_AMOUNT/2 ELSE 0 END),
	FREIGHT_SGST_AMOUNT=(CASE WHEN ISNULL(ISIGST,0)=0 THEN B.FREIGHT_GST_AMOUNT/2 ELSE 0 END),
				
	OTHER_CHARGES_TAXABLE_VALUE=B.OTHER_CHARGES_TAXABLE_VALUE,
	OTHER_CHARGES_IGST_AMOUNT=(CASE WHEN ISNULL(ISIGST,0)=1 THEN B.OTHER_CHARGES_GST_AMOUNT ELSE 0 END),
	OTHER_CHARGES_CGST_AMOUNT=(CASE WHEN ISNULL(ISIGST,0)=0 THEN B.OTHER_CHARGES_GST_AMOUNT/2 ELSE 0 END),
	OTHER_CHARGES_SGST_AMOUNT=(CASE WHEN ISNULL(ISIGST,0)=0 THEN B.OTHER_CHARGES_GST_AMOUNT/2 ELSE 0 END)								
				
	FROM PO_POM01106_UPLOAD  A WITH (rowlock)
	LEFT OUTER JOIN
	(SELECT * FROM  GST_TAXINFO_CALC_OH (NOLOCK) 
		WHERE SP_ID=RTRIM(LTRIM((@NSPID)))) B ON A.SP_ID =B.SP_ID
	WHERE A.SP_ID = @nSpId
			
END_PROC:

END