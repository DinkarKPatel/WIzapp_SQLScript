CREATE PROCEDURE SP_INSERTSKUFROMSKUMASTER
@CPRODUCTCODE VARCHAR(100),
@CERRORMSG VARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CTABLEDETAILS TABLE (SRCTABLENAME VARCHAR(100), TRGTABLENAME VARCHAR(100), KEYCOLNAME VARCHAR(100),
			INSORDER NUMERIC(2,0))
	
	DECLARE @SRCTABLENAME VARCHAR(100), @TRGTABLENAME VARCHAR(100), @KEYCOLNAME VARCHAR(100),@NSTEP INT,
			@CCMD NVARCHAR(MAX)	
		
	BEGIN TRY
		
		BEGIN TRANSACTION
		
		SET @CERRORMSG	=''
		
		SET @NSTEP=10
		
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'SECTIONM', 'SECTION_CODE', 1)
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'SECTIOND', 'SUB_SECTION_CODE', 2)
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'ARTICLE', 'ARTICLE_CODE', 3)
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'UOM', 'UOM_CODE', 4)
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'PARA1', 'PARA1_CODE', 5)
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'PARA2', 'PARA2_CODE', 6)
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'PARA3', 'PARA3_CODE', 7)
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'PARA4', 'PARA4_CODE', 8)
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'PARA5', 'PARA5_CODE', 9)
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'PARA6', 'PARA6_CODE', 10)
		INSERT @CTABLEDETAILS VALUES ('TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE, 'SKU', 'PRODUCT_CODE', 11)
		
		SET @NSTEP=20
		
		SET @CCMD=N'UPDATE A SET AC_CODE=ISNULL(B.AC_CODE,''0000000000'') FROM TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE+' A
					LEFT OUTER JOIN LM01106 B ON A.AC_CODE=B.AC_CODE'
		EXEC SP_EXECUTESQL @CCMD
		
		IF CURSOR_STATUS('GLOBAL', 'CURTABLESLIST') IN (0, 1)
		BEGIN
			CLOSE CURTABLESLIST
			DEALLOCATE CURTABLESLIST
		END
		
		SET @NSTEP=30
		
		DECLARE CURTABLESLIST CURSOR FOR
		SELECT SRCTABLENAME, TRGTABLENAME, KEYCOLNAME FROM  @CTABLEDETAILS ORDER BY INSORDER
		
		OPEN CURTABLESLIST
		FETCH NEXT FROM CURTABLESLIST INTO @SRCTABLENAME, @TRGTABLENAME, @KEYCOLNAME
		
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @NSTEP=40
			
			EXEC UPDATEMASTERXN
			@CSOURCEDB = '', 
			@CDESTDB = '',
			@CSOURCETABLE = @SRCTABLENAME, 
			@CDESTTABLE = @TRGTABLENAME,
			@CKEYFIELD1 = @KEYCOLNAME,
			@BALWAYSUPDATE = 1
		
			FETCH NEXT FROM CURTABLESLIST INTO @SRCTABLENAME, @TRGTABLENAME, @KEYCOLNAME
		END
		
		SET @NSTEP=50
		SET @CCMD=N'UPDATE GR_HISTORY SET STATUS=1,DISCOUNT_PERCENTAGE=B.DISC_PER
					FROM TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE+' B  WHERE B.PRODUCT_CODE=GR_HISTORY.PRODUCT_CODE'
		EXEC SP_EXECUTESQL @CCMD
		
		SET @NSTEP=60		
		SET @CCMD=N'DROP TABLE TMP_DOCSKU_SKUMASTER_'+@CPRODUCTCODE
		EXEC SP_EXECUTESQL @CCMD
				
		SET @NSTEP=70
		IF @@TRANCOUNT>0
			COMMIT TRANSACTION
		
	END TRY
	
	BEGIN CATCH
		
		PRINT 'UNTRAPPED ERROR'		
		SELECT @CERRORMSG='PROCEDURE : SP_INSERTSKUFROMSKUMASTER STEP: '+STR(@NSTEP)+' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		IF @@TRANCOUNT>0
			ROLLBACK		
		
		BEGIN TRANSACTION
		UPDATE GR_HISTORY SET STATUS=0,ERRMSG=@CERRORMSG WHERE PRODUCT_CODE=@CPRODUCTCODE	
		COMMIT TRANSACTION
	END CATCH

		
END
--********************************************** END OF PROCEDURE SP_INSERTSKUFROMSKUMASTER
