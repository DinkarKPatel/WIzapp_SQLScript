CREATE PROCEDURE COPYPROCEDURES
(
 @NAME VARCHAR(100)
)
AS
BEGIN
DECLARE @SQL AS NVARCHAR(MAX),@DTSQL NVARCHAR(MAX),@DBNAME VARCHAR(100)



	

       IF OBJECT_ID ('TEMPDB..#TMPUSEOBJECT','U') IS NOT NULL
		   DROP TABLE #TMPUSEOBJECT
		   
		SELECT NAME =CAST('' AS VARCHAR(MAX))
		INTO #TMPUSEOBJECT WHERE 1=2

		SET @DTSQL=N' SELECT NAME FROM '+@NAME+'.SYS .OBJECTS'
		PRINT @DTSQL
		INSERT INTO #TMPUSEOBJECT
		EXEC SP_EXECUTESQL @DTSQL

   DECLARE C CURSOR FOR 
	  
	SELECT  DEFINITION
	FROM
	(
	SELECT  B.OBJECT_ID,SR=2,NAME AS OBJECTNAME  FROM INFORMATION_SCHEMA .ROUTINES A 
	JOIN SYS.OBJECTS B ON A.SPECIFIC_NAME= B.NAME
	 WHERE  (ROUTINE_TYPE  ='FUNCTION' OR ROUTINE_NAME LIKE 'SP_RPT%')
	 ) P
	 INNER JOIN SYS.SQL_MODULES M ON P.OBJECT_ID = M.OBJECT_ID
	 LEFT JOIN  #TMPUSEOBJECT C ON P.OBJECTNAME=C.NAME 
	 WHERE C.NAME IS NULL
    ORDER BY SR
  
  
OPEN C
FETCH NEXT FROM C INTO @SQL
WHILE @@FETCH_STATUS = 0 
BEGIN
   SET @SQL = REPLACE(@SQL,'''','''''')
   SET @SQL = 'USE [' + @NAME + ']; EXEC(''' + @SQL + ''')'
   PRINT @SQL
   EXEC(@SQL)

   FETCH NEXT FROM C INTO @SQL
END             

CLOSE C
DEALLOCATE C
END
