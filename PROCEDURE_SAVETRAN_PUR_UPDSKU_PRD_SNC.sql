

-- PROCEDURE TO UPDATE PUR INFO IN SKU AND SKU_OH TABLES
CREATE PROCEDURE SAVETRAN_PUR_UPDSKU_PRD_SNC
(
	@CMEMOID VARCHAR(40),
	@NMODE INT=1,
	@BCANCELBILL BIT=0,
	@CERRORMSG VARCHAR(MAX) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
    BEGIN TRY
    
	DECLARE @CCMD NVARCHAR(MAX),@CDETAILTABLE VARCHAR(100),@CMASTERTABLE VARCHAR(100),@CMEMOIDCOL VARCHAR(100) ,
	@CQTYCOL VARCHAR(100),@NSTEP INT
	
	SET @CERRORMSG=''
	
	SET @NSTEP=10
	SELECT @CDETAILTABLE='PRD_SNC_DET',@CMASTERTABLE='PRD_SNC_MST',@CMEMOIDCOL='MEMO_ID',@CQTYCOL='QUANTITY'	
	
	SET @NSTEP=20	
	PRINT 'UPDSKUOH-1'
	
	
	SET @NSTEP=30
	SET @NSTEP=70
	-- UPDATING MASTER INFORMATION AND OTHER DETAILS IN SKU TABLE
	UPDATE A SET  	
		ARTICLE_CODE = B.ARTICLE_CODE,  	
		PARA1_CODE = B.PARA1_CODE,  	
		PARA2_CODE = B.PARA2_CODE,  	
		PARA3_CODE = B.PARA3_CODE,  	
		PARA4_CODE = B.PARA4_CODE,  	
		PARA5_CODE = B.PARA5_CODE,  	
		PARA6_CODE = B.PARA6_CODE,  	
		AC_CODE		= C1.AC_CODE, 	
		FORM_ID		= B.FORM_ID, 	
		INV_NO		= C1.MEMO_NO, 
		INV_DT		= C1.RECEIPT_DT,  	
		RECEIPT_DT	= C1.RECEIPT_DT, 
		PURCHASE_PRICE = B.PURCHASE_PRICE
		
	FROM PRD_SKU A WITH (ROWLOCK) 
	JOIN PRD_SNC_BARCODE_DET B1 (NOLOCK) ON A.PRODUCT_UID  = B1.PRODUCT_UID
	JOIN PRD_SNC_DET B (NOLOCK) ON B1.REFROW_ID = B.ROW_ID  
	JOIN PRD_SNC_MST C1 (NOLOCK) ON C1.MEMO_ID = B.MEMO_ID  
	WHERE C1.WIP=0 AND C1.MEMO_ID = @CMEMOID
	
	
	SET @NSTEP=80	 
	---UPDATING MRP IN SKU TABLE 
	IF @BCANCELBILL=0
	BEGIN
		UPDATE  A SET A.MRP = B.MRP ,A.WS_PRICE = B.WHOLESALE_PRICE 
		FROM PRD_SKU A WITH (ROWLOCK) 
		JOIN PRD_SNC_BARCODE_DET A1 (NOLOCK) ON A1.PRODUCT_CODE=A.PRODUCT_CODE
		JOIN PRD_SNC_DET B (NOLOCK) ON A1.REFROW_ID=B.ROW_ID
		JOIN PRD_SNC_MST C1 (NOLOCK) ON C1.MEMO_ID=B.MEMO_ID
		JOIN ARTICLE C (NOLOCK) ON B.ARTICLE_CODE=C.ARTICLE_CODE 
		LEFT OUTER JOIN 
		(
			SELECT DISTINCT PRODUCT_CODE FROM PRD_IRD01106(NOLOCK)
		) IRD ON A1.PRODUCT_CODE = IRD.PRODUCT_CODE
		WHERE C1.WIP=0 AND B.MEMO_ID=@CMEMOID 
		--AND   A.BARCODE_CODING_SCHEME<>1 
		AND   IRD.PRODUCT_CODE IS NULL
	END
	
	END TRY
	
	BEGIN CATCH
		SET @CERRORMSG = 'PROCEDURE SAVETRAN_UPDPUR_SKU_SNC: STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		-- SET @CRETCMD= N'SELECT '''+@CERRORMSG+''' AS ERRMSG, '''' AS MEMO_ID'
			
		GOTO END_PROC
	END CATCH
	
END_PROC:

END
--************************************************** END OF PROCEDURE SAVETRAN_PUR_UPDSKU
