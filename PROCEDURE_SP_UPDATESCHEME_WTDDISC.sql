
-----DISTRIBUTE WEIGHTED AVG DISCOUNT AMONG THE ITEMS CONTRIBUTING TO BUY N GET N SCHEMES
CREATE PROCEDURE SP_UPDATESCHEME_WTDDISC
@CBUNDLEID VARCHAR(10)
--WITH ENCRYPTION
AS
BEGIN
	
	IF NOT EXISTS (SELECT TOP 1 CMD_ROW_ID FROM #TMPCMD A 
				   JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID
				   JOIN BUNDLEM C ON C.BUNDLE_ID=B.SCHEME_ID
				   WHERE  (C.BUY_DISC_APP_MODE=2 OR C.DISC_APP_MODE=2) AND C.BUNDLE_ID=@CBUNDLEID AND QUANTITY>0)
		GOTO END_PROC
		
	DECLARE @NGROSSSALE NUMERIC(10,2),@NNETSALE NUMERIC(10,2),@CSLSDETROWID VARCHAR(40),
	@BSLSDISCOUNTDISABLED BIT,@NNETAMOUNT NUMERIC(10,2),@CROWID VARCHAR(40),@NDISCAMT NUMERIC(10,2),
	@NTOTWTDDISC NUMERIC(10,2),@NDISCPCT NUMERIC(7,3),@CCURDEPTID VARCHAR(5),@CDISTRIBUTEWEIGHTEDDISC VARCHAR(5),
	@BAPPLYEXCLTAXONDISCITEMS BIT
	
	SELECT TOP 1 @CCURDEPTID=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'
	
	SELECT TOP 1 @BAPPLYEXCLTAXONDISCITEMS=ISNULL(EXCLUSIVE_VAT,0) FROM LOCATION WHERE DEPT_ID=@CCURDEPTID
	
	IF @BAPPLYEXCLTAXONDISCITEMS=1
		SELECT TOP 1 @CDISTRIBUTEWEIGHTEDDISC=VALUE FROM CONFIG WHERE CONFIG_OPTION='DISTRIBUTE_WTDAVGDISC_FOR_EXCLTAX'
	
	SET @CDISTRIBUTEWEIGHTEDDISC=ISNULL(@CDISTRIBUTEWEIGHTEDDISC,'')
	
	SELECT TOP 1 @CROWID=CMD_ROW_ID FROM #TMPCMD A 
	JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID
	JOIN BUNDLEM C ON C.BUNDLE_ID=B.SCHEME_ID
	WHERE C.BUNDLE_ID=@CBUNDLEID AND A.QUANTITY>0 AND A.DISCOUNT_AMOUNT<>0
	
	SELECT @NDISCAMT=SUM(A.DISCOUNT_AMOUNT) FROM #TMPCMD A
	JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID
	JOIN BUNDLEM C ON C.BUNDLE_ID=B.SCHEME_ID
	WHERE C.BUNDLE_ID=@CBUNDLEID AND A.QUANTITY>0
	
	SELECT @NGROSSSALE=SUM(MRP*QUANTITY),@NNETSALE=SUM((MRP*QUANTITY)-A.DISCOUNT_AMOUNT)
	FROM #TMPCMD A JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID
	JOIN BUNDLEM C ON C.BUNDLE_ID=B.SCHEME_ID
    WHERE C.BUNDLE_ID=@CBUNDLEID  AND A.QUANTITY>0
	
	SELECT @NDISCPCT=((@NGROSSSALE-@NNETSALE)/@NGROSSSALE)*100
	
	UPDATE A SET WEIGHTED_AVG_DISC_AMT=(MRP*QUANTITY*@NDISCPCT/100)
	FROM #TMPCMD A
	JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID
	JOIN BUNDLEM C ON C.BUNDLE_ID=B.SCHEME_ID
	WHERE C.BUNDLE_ID=@CBUNDLEID AND A.QUANTITY>0
	
	SELECT @NTOTWTDDISC=SUM(WEIGHTED_AVG_DISC_AMT) FROM #TMPCMD A
	JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID
	JOIN BUNDLEM C ON C.BUNDLE_ID=B.SCHEME_ID
	WHERE C.BUNDLE_ID=@CBUNDLEID AND A.QUANTITY>0
	
	IF ABS(@NTOTWTDDISC-@NDISCAMT)>0
	BEGIN
		PRINT 'DIF FOUND'
		UPDATE #TMPCMD SET WEIGHTED_AVG_DISC_AMT=WEIGHTED_AVG_DISC_AMT+(@NDISCAMT-@NTOTWTDDISC)
		WHERE CMD_ROW_ID=@CROWID
	END	
	
	UPDATE A SET WEIGHTED_AVG_DISC_PCT=ROUND((WEIGHTED_AVG_DISC_AMT/(MRP*QUANTITY))*100,2)
	FROM #TMPCMD A
	JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID
	JOIN BUNDLEM C ON C.BUNDLE_ID=B.SCHEME_ID
	WHERE C.BUNDLE_ID=@CBUNDLEID AND A.QUANTITY>0
	
	
END_PROC:
	
	UPDATE #TMPCMD SET WEIGHTED_AVG_DISC_PCT=DISCOUNT_PERCENTAGE,WEIGHTED_AVG_DISC_AMT=DISCOUNT_AMOUNT
	WHERE WEIGHTED_AVG_DISC_PCT=0
	

	IF @CDISTRIBUTEWEIGHTEDDISC='1'
	BEGIN
		UPDATE A SET DISCOUNT_AMOUNT=WEIGHTED_AVG_DISC_AMT FROM #TMPCMD A
		JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID
		JOIN BUNDLEM C ON C.BUNDLE_ID=B.SCHEME_ID
		WHERE C.BUNDLE_ID=@CBUNDLEID AND A.QUANTITY>0

		UPDATE A SET DISCOUNT_PERCENTAGE=ROUND((A.DISCOUNT_AMOUNT/(MRP*QUANTITY))*100,2),		
				    NET=(MRP*QUANTITY)-A.DISCOUNT_AMOUNT
		FROM #TMPCMD A
		JOIN SLSDET B ON A.SLSDET_ROW_ID=B.ROW_ID
		JOIN BUNDLEM C ON C.BUNDLE_ID=B.SCHEME_ID
		WHERE C.BUNDLE_ID=@CBUNDLEID AND A.QUANTITY>0
	END	
	
END
---- 'END OF CREATING PROCEDURE SP_UPDATESCHEME_WTDDISC'
