create PROCEDURE EMP_UPDATEATD
(
	@CROWID VARCHAR(40)
)
--WITH ENCRYPTION
AS
BEGIN

		DECLARE @CDAY VARCHAR(2),
				@CMONTH VARCHAR(2),
				@CYEAR VARCHAR(5),
				@CNEWROWID VARCHAR(40),
				@CEMPID VARCHAR(15)
				
		
		SELECT @CDAY = DAY(IST_TIME), @CMONTH = MONTH(IST_TIME), @CYEAR = YEAR(IST_TIME) , @CEMPID = EMP_ID 
		FROM EMP_WPAYATT 
		WHERE ROW_ID =@CROWID 
		
		-- DELETING BLANK ENTRIES
		DELETE FROM EMP_ATTENDANCE   WHERE EMP_ID =@CEMPID  AND  DAY(ATTENDANCE_DT)=@CDAY 
			  AND MONTH(ATTENDANCE_DT)=@CMONTH 
			  AND YEAR(ATTENDANCE_DT)=@CYEAR  AND TIME_IN = '' AND TIME_OUT=''
		
		-- CHECKING IF ANY ROW EXISTS WITH SAME DATE AND TIME OUT IS BLANK
		SELECT @CNEWROWID = ROW_ID 
		FROM EMP_ATTENDANCE 
		WHERE EMP_ID =@CEMPID  AND  DAY(ATTENDANCE_DT)=@CDAY 
			  AND MONTH(ATTENDANCE_DT)=@CMONTH 
			  AND YEAR(ATTENDANCE_DT)=@CYEAR  AND TIME_OUT=''
			  
			  
			  -- IF ROW EXISTS THEN UPDATE ELSE INSERT AS TIME IN
		 IF (ISNULL(@CNEWROWID,'')<>'')
		   BEGIN
					UPDATE A SET TIME_OUT =  CAST('1900-01-01 ' + CONVERT(VARCHAR(20),B.IST_TIME,108) AS DATETIME) , A.LOG_ABSENT_STATUS =B.LOG_ABSENT_STATUS,
						   A.REMARKS_OUT = B.REMARKS,A.EMPIMAGE_OUT=B.EMPIMAGE
					FROM EMP_ATTENDANCE A						
					JOIN EMP_WPAYATT B ON A.EMP_ID = B.EMP_ID
					WHERE  B.ROW_ID =  @CROWID 
					AND A.ROW_ID = @CNEWROWID    
					AND A.TIME_OUT  =''	
										
										
		   END 
		   ELSE
		   BEGIN
		           
					DECLARE @CSHIFTID VARCHAR(20),
					@DSHIFTTIMEIN DATETIME,
					@DSHIFTTIMEOUT DATETIME,
					@DSHIFTHALFDAYCUTOFF DATETIME,
					@CEMPDEPTID VARCHAR(4)



					SELECT	@CSHIFTID = A.SHIFT_ID, 
					@DSHIFTTIMEIN = B.SHIFT_TIME_IN,
					@DSHIFTTIMEOUT = B.SHIFT_TIME_OUT,
					@DSHIFTHALFDAYCUTOFF = B.HALFDAY_CUTOFF,
					@CEMPDEPTID = A.DEPT_ID
					FROM EMP_MST A
					JOIN EMP_SHIFTS B ON A.SHIFT_ID = B.SHIFT_ID
					WHERE A.EMP_ID =@CEMPID 

					     
					        
					INSERT EMP_ATTENDANCE( ATTENDANCE_DT, EMP_ID, TIME_IN, TIME_OUT, ENTRY_MODE, ROW_ID, SHIFT_ID,
					 SHIFT_TIME_IN, SHIFT_TIME_OUT, HALFDAY_CUTOFF, EMPIMAGE, DEPT_ID, EMPIMAGE_OUT, 
					 MODIFIED, LOG_ABSENT_STATUS, LAST_UPDATE, ATT_REMARKS, REMARKS_IN, REMARKS_OUT, SYNC ) 
					SELECT 	  CONVERT(VARCHAR(10), IST_TIME,111) AS ATTENDANCE_DT, EMP_ID, CAST('1900-01-01 ' + CONVERT(VARCHAR(20),IST_TIME,108) AS DATETIME) AS TIME_IN, '' AS TIME_OUT, 2 AS  ENTRY_MODE, 
					NEWID() AS ROW_ID, @CSHIFTID AS  SHIFT_ID, @DSHIFTTIMEIN  AS  SHIFT_TIME_IN, 
					@DSHIFTTIMEOUT AS  SHIFT_TIME_OUT,@DSHIFTHALFDAYCUTOFF AS  HALFDAY_CUTOFF, EMPIMAGE, @CEMPDEPTID AS DEPT_ID,
					'' AS  EMPIMAGE_OUT, 0 AS MODIFIED, LOG_ABSENT_STATUS,
					GETDATE() AS LAST_UPDATE ,'' AS ATT_REMARKS, REMARKS, '' AS REMARKS_OUT, 0 AS SYNC 
					FROM EMP_WPAYATT 
					WHERE ROW_ID =@CROWID 
		   END
   

			  
		
END
