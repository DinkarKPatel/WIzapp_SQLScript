CREATE PROCEDURE SP_CHECK_OTHERXN_PC
(
 @CMRR_ID VARCHAR(100)
)
--WITH ENCRYPTION

AS
BEGIN
	DECLARE @CSTEP VARCHAR(100),@CERRMSG VARCHAR(100)
	DECLARE @CLOCID CHAR(2),@CHOID CHAR(2)
	
	SELECT TOP 1 @CHOID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'
	SELECT TOP 1 @CLOCID = DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
	
	DECLARE @PC_RESULT TABLE (XN_TYPE VARCHAR(100), PRODUCT_CODE VARCHAR(100))  
	IF ISNULL(@CMRR_ID,'')=''
	BEGIN
		SET @CERRMSG = 'CAN NOT ACCEPT A BLANK MEMO_ID.'
		GOTO END_PROC
	END
	SET @CSTEP = 00 
	INSERT INTO @PC_RESULT(XN_TYPE,PRODUCT_CODE)
	SELECT 'OPS' AS XN_TYPE,A.PRODUCT_CODE  FROM OPS01106 A JOIN PID01106 B ON A.PRODUCT_CODE = B.PRODUCT_CODE 
	WHERE B.MRR_ID = @CMRR_ID
	UNION ALL 
	SELECT 'PRD' AS XN_TYPE,A.PRODUCT_CODE FROM PRD_STK_TRANSFER_DTM_DET A JOIN PRD_STK_TRANSFER_DTM_MST B ON A.MEMO_ID = B.MEMO_ID JOIN PID01106 C ON A.PRODUCT_CODE = C.PRODUCT_CODE 
	WHERE C.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'DCO' AS XN_TYPE,A.PRODUCT_CODE FROM FLOOR_ST_DET  A (NOLOCK) JOIN FLOOR_ST_MST B (NOLOCK) ON A.MEMO_ID  = B.MEMO_ID  JOIN PID01106 C ON A.PRODUCT_CODE = C.PRODUCT_CODE  
	WHERE  B.CANCELLED = 0 AND   C.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'DCI' AS XN_TYPE,A.PRODUCT_CODE FROM FLOOR_ST_DET  A (NOLOCK) JOIN FLOOR_ST_MST B (NOLOCK) ON A.MEMO_ID  = B.MEMO_ID  JOIN PID01106 C ON A.PRODUCT_CODE = C.PRODUCT_CODE   
			WHERE  B.CANCELLED = 0 AND ISNULL(B.RECEIPT_DT,'')<>''   AND  C.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT (CASE WHEN  B.INV_MODE IN (0,1) THEN 'PUR' ELSE 'CHI' END) AS XN_TYPE,A.PRODUCT_CODE FROM PID01106 A (NOLOCK)  
			JOIN PIM01106 B (NOLOCK) ON A.MRR_ID = B.MRR_ID  
			WHERE  B.CANCELLED = 0 AND A.PRODUCT_CODE<>'' AND B.RECEIPT_DT<>''  
			AND 
			--(LEFT(B.MRR_ID,2)=CNF1.VALUE OR CNF1.VALUE<>CNF2.VALUE 
			(LEFT(B.MRR_ID,2)=@CHOID  OR @CHOID<>@CLOCID OR B.INV_MODE<>2)
			AND  B.MRR_ID = @CMRR_ID AND B.INV_MODE NOT IN (0,1)
	UNION ALL
	SELECT 'CHI' AS XN_TYPE, A.PRODUCT_CODE FROM IND01106 A WITH (NOLOCK,INDEX=IND_IND01106_PC)  
			JOIN INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID  
			JOIN PIM01106 C (NOLOCK) ON C.INV_ID = B.INV_ID  
			JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID  
			--JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID') CNF ON 1=1  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE B.CANCELLED = 0 AND LEFT(C.MRR_ID,2)<>@CHOID
			AND C.RECEIPT_DT<>'' AND  E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'CHI' AS XN_TYPE,A.PRODUCT_CODE	
			FROM RMD01106 A WITH (NOLOCK,INDEX=IND_RMD01106_PC)  
			JOIN RMM01106 B (NOLOCK) ON A.RM_ID = B.RM_ID  
			JOIN CNM01106 C (NOLOCK) ON C.RM_ID = B.RM_ID  
			JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID  
			--JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID') CNF ON 1=1  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE B.CANCELLED = 0 AND LEFT(C.CN_ID,2) <> @CHOID
			AND C.RECEIPT_DT<>''  AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'TRI' AS XN_TYPE,A.PRODUCT_CODE			
				FROM IND01106 A WITH (NOLOCK,INDEX=IND_IND01106_PC)  
				JOIN INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID  
				JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID 
				JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE 
				WHERE B.CANCELLED = 0 AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'TRI' AS XN_TYPE,A.PRODUCT_CODE 
			FROM RMD01106 A  WITH (NOLOCK,INDEX=IND_RMD01106_PC)    
			JOIN RMM01106 B (NOLOCK) ON A.RM_ID = B.RM_ID  
			JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID 
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE  
			WHERE B.CANCELLED = 0 AND B.DN_TYPE IN (0,1) AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'TRO' AS XN_TYPE,A.PRODUCT_CODE  
			FROM IND01106 A  WITH (NOLOCK,INDEX=IND_IND01106_PC)    
			JOIN INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID  
			JOIN PIM01106 C (NOLOCK) ON C.INV_ID = B.INV_ID  
			JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE  
			WHERE B.CANCELLED = 0 AND C.RECEIPT_DT<>'' AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'TRO' AS XN_TYPE,A.PRODUCT_CODE   
			FROM RMD01106 A  WITH (NOLOCK,INDEX=IND_RMD01106_PC)    
			JOIN RMM01106 B (NOLOCK) ON A.RM_ID = B.RM_ID  
			JOIN CNM01106 C (NOLOCK) ON C.RM_ID = B.RM_ID  
			JOIN LOCATION D (NOLOCK) ON D.DEPT_ID=B.PARTY_DEPT_ID  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE  
			WHERE B.CANCELLED = 0 AND C.RECEIPT_DT<>'' AND B.DN_TYPE IN (0,1) AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT (CASE WHEN MODE=2 THEN 'CHO' ELSE 'PRT' END) AS XN_TYPE,A.PRODUCT_CODE  
			FROM RMD01106 A  WITH (NOLOCK,INDEX=IND_RMD01106_PC)  
			JOIN RMM01106 B (NOLOCK) ON A.RM_ID = B.RM_ID  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE  
			WHERE B.CANCELLED = 0 AND B.DN_TYPE IN (0,1)  AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT (CASE WHEN A.QUANTITY > 0 THEN 'SLS' ELSE 'SLR' END) AS XN_TYPE,A.PRODUCT_CODE
			FROM CMD01106 A WITH (NOLOCK,INDEX=IXCMD_PRODUCT_CODE)  
			JOIN CMM01106 B (NOLOCK) ON A.CM_ID = B.CM_ID 
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE 
			WHERE B.CANCELLED = 0  AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT ( CASE WHEN A.QUANTITY > 0 THEN 'SLS' ELSE 'SLR' END) AS XN_TYPE,A.PRODUCT_CODE
			FROM RPS_DET A WITH (NOLOCK,INDEX=IX_RPS_DET_PRODUCT_CODE)  
			JOIN RPS_MST B (NOLOCK) ON A.CM_ID = B.CM_ID
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE B.CANCELLED = 0  
			AND ISNULL(B.REF_CM_ID,'')=''  AND E.MRR_ID = @CMRR_ID	
	UNION ALL
	SELECT 	'APP' AS XN_TYPE,A.PRODUCT_CODE 
			FROM APD01106 A   
			JOIN APM01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE B.CANCELLED = 0   AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT	'APR' AS XN_TYPE,B.PRODUCT_CODE 
			FROM APPROVAL_RETURN_DET A   
			JOIN APD01106 B (NOLOCK)ON A.APD_ROW_ID = B.ROW_ID  
			JOIN APPROVAL_RETURN_MST C (NOLOCK) ON C.MEMO_ID = A.MEMO_ID  
			JOIN PID01106 E ON B.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE  C.CANCELLED = 0 AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT (CASE WHEN B.CNC_TYPE=1 AND STOCK_ADJ_NOTE=0 THEN 'CNC'  
			WHEN B.CNC_TYPE=2 AND STOCK_ADJ_NOTE=0 THEN 'UNC'  
			WHEN B.CNC_TYPE=1 AND STOCK_ADJ_NOTE=1 THEN 'SAC' ELSE 'SAU' END) AS XN_TYPE,A.PRODUCT_CODE  
			FROM ICD01106 A (NOLOCK)  
			JOIN ICM01106 B (NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID 
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE B.CANCELLED = 0 AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT (CASE WHEN B.INV_MODE=2 THEN 'CHO' ELSE 'WSL' END)  AS XN_TYPE, A.PRODUCT_CODE
			FROM IND01106 A (NOLOCK)  
			JOIN INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE B.CANCELLED = 0 AND B.ENTRY_MODE IN (0,1)  AND E.MRR_ID = @CMRR_ID
	UNION ALL								 								
	SELECT (CASE WHEN B.PS_MODE=1 THEN 'WSL' ELSE 'CHO' END) AS XN_TYPE,A.PRODUCT_CODE  
			FROM WPS_DET A (NOLOCK)  
			JOIN WPS_MST B (NOLOCK) ON A.PS_ID = B.PS_ID  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE B.CANCELLED = 0 AND E.MRR_ID = @CMRR_ID			
	UNION ALL
	SELECT (CASE WHEN MODE=2 THEN 'CHI' ELSE 'WSR' END) AS XN_TYPE,	A.PRODUCT_CODE  
			FROM CND01106 A (NOLOCK)  
			JOIN CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE B.CANCELLED = 0 AND (MODE<>2 OR B.RECEIPT_DT<>'')   
			AND (LEFT(B.CN_ID,2)=@CHOID OR @CHOID<>@CLOCID OR B.MODE<>2 )  
			AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'PFI' AS XN_TYPE,A.NEW_PRODUCT_CODE 
			FROM IRD01106 A (NOLOCK)  
			JOIN IRM01106 B (NOLOCK) ON A.IRM_MEMO_ID = B.IRM_MEMO_ID  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE A.NEW_PRODUCT_CODE<>''  AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'PFI' AS XN_TYPE,A.PRODUCT_CODE  
			FROM SCF01106 A (NOLOCK)  
			JOIN SCM01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID 
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE B.CANCELLED=0 AND A.PRODUCT_CODE<>'' AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'CIP' AS XN_TYPE,A.PRODUCT_CODE
			FROM IRD01106 A (NOLOCK)  
			JOIN IRM01106 B (NOLOCK) ON A.IRM_MEMO_ID = B.IRM_MEMO_ID  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE  A.NEW_PRODUCT_CODE<>'' AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'CIP' AS XN_TYPE,A.PRODUCT_CODE  
			FROM SCC01106 A (NOLOCK)  
			JOIN SCM01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE B.CANCELLED=0 AND A.PRODUCT_CODE<>'' AND E.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'JWI' AS XN_TYPE, A.PRODUCT_CODE		
			FROM JOBWORK_ISSUE_DET A (NOLOCK)  
			JOIN JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID  
			JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE  
			JOIN SKU C (NOLOCK) ON C.PRODUCT_CODE=A.PRODUCT_CODE  
			JOIN PID01106 E ON A.PRODUCT_CODE = E.PRODUCT_CODE
			WHERE  B.CANCELLED=0 AND B.ISSUE_TYPE=1 AND E.MRR_ID = @CMRR_ID 				 		
	UNION ALL
	SELECT  'JWR' AS XN_TYPE,A.PRODUCT_CODE 
			FROM JOBWORK_RECEIPT_DET A (NOLOCK)  
			JOIN JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID  
			JOIN SKU C (NOLOCK) ON C.PRODUCT_CODE=A.PRODUCT_CODE  
			JOIN JOBWORK_ISSUE_DET D (NOLOCK) ON D.ROW_ID=A.REF_ROW_ID  
			JOIN JOBWORK_ISSUE_MST E (NOLOCK) ON E.ISSUE_ID = D.ISSUE_ID  
			JOIN PID01106 F ON A.PRODUCT_CODE = F.PRODUCT_CODE
			WHERE  B.CANCELLED=0 AND E.ISSUE_TYPE=1 AND F.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 	'BOC' AS XN_TYPE,E.PRODUCT_CODE   
			FROM WSL_ORDER_BOM E(NOLOCK)   
			LEFT OUTER JOIN WSL_ORDER_DET C (NOLOCK) ON E.REF_ROW_ID=C.ROW_ID  
			LEFT OUTER JOIN WSL_ORDER_MST D (NOLOCK) ON C.ORDER_ID=D.ORDER_ID  
			JOIN POD01106 P ON C.ROW_ID = P.WOD_ROW_ID   
			JOIN POM01106 PM ON P.PO_ID = PM.PO_ID    
			LEFT OUTER JOIN SKU ON E.PRODUCT_CODE=SKU.PRODUCT_CODE  
			LEFT OUTER JOIN LMV01106 LM (NOLOCK) ON D.AC_CODE = LM.AC_CODE  
			JOIN PID01106 F ON E.PRODUCT_CODE = F.PRODUCT_CODE
			WHERE  PM.CANCELLED = 0  AND F.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'SCF' AS XN_TYPE,B2.PRODUCT_CODE  
			FROM SNC_DET A (NOLOCK)  
			JOIN SNC_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID  
			JOIN
			(
			SELECT REFROW_ID AS [ROW_ID],SNC_BARCODE_DET.PRODUCT_CODE FROM SNC_BARCODE_DET (NOLOCK) JOIN PID01106 F ON SNC_BARCODE_DET.PRODUCT_CODE = F.PRODUCT_CODE
			WHERE  F.MRR_ID = @CMRR_ID
			GROUP BY REFROW_ID,SNC_BARCODE_DET.PRODUCT_CODE
			)B2 ON A.ROW_ID = B2.ROW_ID
			JOIN ARTICLE A1 ON A1.ARTICLE_CODE=A.ARTICLE_CODE
			WHERE  B.WIP=0 AND B.CANCELLED=0 AND B2.PRODUCT_CODE<>''
	UNION ALL
	SELECT 'SCC' AS XN_TYPE, A.PRODUCT_CODE  
			FROM SNC_CONSUMABLE_DET A (NOLOCK)  
			JOIN SNC_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID 
			JOIN PID01106 F ON A.PRODUCT_CODE = F.PRODUCT_CODE
			WHERE A.WIP=0 AND B.CANCELLED=0 AND A.PRODUCT_CODE<>'' AND  F.MRR_ID = @CMRR_ID
    UNION ALL
    SELECT 'WIP-SCF' AS XN_TYPE,B2.PRODUCT_CODE  
    FROM SNC_DET A (NOLOCK)  
	JOIN SNC_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID  
	JOIN
	(
		SELECT REFROW_ID AS [ROW_ID],SNC_BARCODE_DET.PRODUCT_CODE FROM SNC_BARCODE_DET (NOLOCK) JOIN PID01106 F ON SNC_BARCODE_DET.PRODUCT_CODE = F.PRODUCT_CODE
		WHERE F.MRR_ID = @CMRR_ID
		GROUP BY REFROW_ID,SNC_BARCODE_DET.PRODUCT_CODE
	)B2 ON A.ROW_ID = B2.ROW_ID
	JOIN ARTICLE A1 ON A1.ARTICLE_CODE=A.ARTICLE_CODE
	WHERE  B.WIP=1 AND B.CANCELLED=0 AND B2.PRODUCT_CODE<>''
    UNION ALL
    SELECT 'WIP-SCC' AS XN_TYPE,A.PRODUCT_CODE  
	FROM SNC_CONSUMABLE_DET A (NOLOCK)  
	JOIN SNC_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID  
	JOIN PID01106 F ON A.PRODUCT_CODE = F.PRODUCT_CODE
	WHERE A.WIP=1 AND B.CANCELLED=0 AND A.PRODUCT_CODE<>'' AND F.MRR_ID = @CMRR_ID
	UNION ALL
	SELECT 'WIP-JWI' AS XN_TYPE,A.PRODUCT_CODE  
	FROM JOBWORK_ISSUE_DET A (NOLOCK)  
	JOIN JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID  
	JOIN PRD_AGENCY_MST D (NOLOCK) ON D.AGENCY_CODE=B.AGENCY_CODE  
	JOIN SKU C (NOLOCK) ON C.PRODUCT_CODE=A.PRODUCT_CODE  
	JOIN PID01106 F ON A.PRODUCT_CODE = F.PRODUCT_CODE
    WHERE  B.CANCELLED=0 AND B.ISSUE_TYPE=1 AND B.WIP=1 AND F.MRR_ID = @CMRR_ID
    UNION ALL
    SELECT 'WIP-JWR' AS XN_TYPE,A.PRODUCT_CODE 
	FROM JOBWORK_RECEIPT_DET A (NOLOCK)  
	JOIN JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID  
	JOIN SKU C (NOLOCK) ON C.PRODUCT_CODE=A.PRODUCT_CODE  
	JOIN JOBWORK_ISSUE_DET D (NOLOCK) ON D.ROW_ID=A.REF_ROW_ID  
	JOIN JOBWORK_ISSUE_MST E (NOLOCK) ON E.ISSUE_ID = D.ISSUE_ID  
	JOIN PID01106 F ON A.PRODUCT_CODE = F.PRODUCT_CODE
	WHERE  B.CANCELLED=0 AND E.ISSUE_TYPE=1 AND B.WIP=1  AND F.MRR_ID = @CMRR_ID;
	
    SELECT A.PRODUCT_CODE,(CASE WHEN ISNULL(B.PRODUCT_CODE,'')='' THEN 0 ELSE 1 END) AS USED_PRODUCT_CODE 
    FROM PID01106  A 
	LEFT OUTER JOIN (SELECT DISTINCT  PRODUCT_CODE FROM @PC_RESULT) B ON A.PRODUCT_CODE = B.PRODUCT_CODE 
	WHERE MRR_ID = @CMRR_ID ORDER BY A.PRODUCT_CODE
   
    END_PROC:
    IF ISNULL(@CERRMSG,'') <> ''
		SELECT 	@CERRMSG AS ERRMSG	   					 		
END
