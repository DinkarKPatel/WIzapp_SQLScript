CREATE PROCEDURE SPPPC_USER_ROLE  
(  
 @CUSER_CODE VARCHAR(10),  
 @NMODE INT=1  
)  
AS  
BEGIN  
  
   IF  @NMODE=1  
      GOTO LBL_MST  
   ELSE IF @NMODE=2  
      GOTO LBL_MST_ACCESS  
   --VISHAL 30 MAR 2018   
   ELSE IF @NMODE=3
      GOTO LBL_RETURN
   --VISHAL 30 MAR 2018   
   ELSE  
   GOTO END_PROC  
   
   --VISHAL 30 MAR 2018
   LBL_RETURN:
   DECLARE @USER_MENU BIT=0,@INV_MENU BIT=0,@AC_MENU BIT=0,@CR_JOB BIT=0,@JOB_REC BIT
   
   IF EXISTS(SELECT A.USER_CODE,GROUP_NAME,VALUE     
   FROM USERS A   
   JOIN USER_ROLE_MST AS B ON B.ROLE_ID =A.ROLE_ID   
   JOIN USER_ROLE_DET AS C ON C.ROLE_ID =A.ROLE_ID   
   WHERE (@CUSER_CODE='' OR A.USER_CODE=@CUSER_CODE)  
   AND DISPLAY_FORM_NAME IN ('USERMASTER','ROLEMASTER','MODULEPERMISSIONNEW') AND DISPLAY_NAME='ACCESS' AND VALUE=1)
      SET @USER_MENU=1
   
   IF EXISTS(SELECT A.USER_CODE,GROUP_NAME,VALUE     
   FROM USERS A   
   JOIN USER_ROLE_MST AS B ON B.ROLE_ID =A.ROLE_ID   
   JOIN USER_ROLE_DET AS C ON C.ROLE_ID =A.ROLE_ID   
   WHERE (@CUSER_CODE='' OR A.USER_CODE=@CUSER_CODE)  
   AND GROUP_NAME='MASTERS'
   AND DISPLAY_FORM_NAME IN ('HSNMASTER','LABELMANAGER','CURRENCYMASTER','SHIPPINGMASTER','TERMSCONDITION','PARAS','SECTIONM','SECTIOND','STOCKUOM','BOMUOM','JOBWORK','SIZEGROUP','RMARTICLE','FGARTICLE') AND DISPLAY_NAME='ACCESS' AND VALUE=1)
      SET @INV_MENU=1
      
   IF EXISTS(SELECT A.USER_CODE,GROUP_NAME,VALUE     
   FROM USERS A   
   JOIN USER_ROLE_MST AS B ON B.ROLE_ID =A.ROLE_ID   
   JOIN USER_ROLE_DET AS C ON C.ROLE_ID =A.ROLE_ID   
   WHERE (@CUSER_CODE='' OR A.USER_CODE=@CUSER_CODE)  
   AND DISPLAY_FORM_NAME IN ('HEADCREATION','LEDGERCREATION') AND DISPLAY_NAME='ACCESS' AND VALUE=1)
      SET @AC_MENU=1
   
   IF EXISTS(SELECT A.USER_CODE,GROUP_NAME,VALUE     
   FROM USERS A   
   JOIN USER_ROLE_MST AS B ON B.ROLE_ID =A.ROLE_ID   
   JOIN USER_ROLE_DET AS C ON C.ROLE_ID =A.ROLE_ID   
   WHERE (@CUSER_CODE='' OR A.USER_CODE=@CUSER_CODE)  
   AND DISPLAY_FORM_NAME IN ('FIRSTJOBORDER','SECONDONWARDJOBORDERNEW','SECONDONWARDJOBORDERNEWWITHOUTSCAN') AND DISPLAY_NAME='ACCESS' AND VALUE=1)
      SET @CR_JOB=1

   IF EXISTS(SELECT A.USER_CODE,GROUP_NAME,VALUE     
   FROM USERS A   
   JOIN USER_ROLE_MST AS B ON B.ROLE_ID =A.ROLE_ID   
   JOIN USER_ROLE_DET AS C ON C.ROLE_ID =A.ROLE_ID   
   WHERE (@CUSER_CODE='' OR A.USER_CODE=@CUSER_CODE)  
   AND DISPLAY_FORM_NAME IN ('RECEIVEFGSTOCKNEW','RECEIVEWITHOUTSCANNING') AND DISPLAY_NAME='ACCESS' AND VALUE=1)
      SET @JOB_REC=1

   --SELECT DISTINCT DISPLAY_FORM_NAME FROM USER_ROLE_DET WHERE FORM_NAME IN ('RECEIVEFGSTOCKNEW.ASPX','RECEIVEWITHOUTSCANNING.ASPX')
   --UPDATE USER_ROLE_DET SET DISPLAY_FORM_NAME='FGARTICLE' WHERE GROUP_NAME='MASTERS' AND DISPLAY_FORM_NAME='ARTICLENEW'

   SELECT ISNULL(@USER_MENU,0) USER_MENU ,ISNULL(@INV_MENU,0) INVENTORY_MENU,ISNULL(@AC_MENU,0) ACCOUNT_MENU
   ,ISNULL(@CR_JOB,0) CREATE_JOB ,ISNULL(@JOB_REC,0) JOB_WORK_RECEIVE 
   GOTO END_PROC  
   --VISHAL 30 MAR 2018
   
   LBL_MST:  
     
  SELECT C.* FROM USERS A   
  JOIN USER_ROLE_MST AS B ON B.ROLE_ID =A.ROLE_ID   
  JOIN USER_ROLE_DET AS C ON C.ROLE_ID =A.ROLE_ID   
  WHERE (@CUSER_CODE='' OR MAJOR_USER_CODE=@CUSER_CODE)  
SELECT * FROM USER_ROLE_DET WHERE DISPLAY_FORM_NAME='PARAS'    
   GOTO END_PROC  
     
   LBL_MST_ACCESS:  
     
  SELECT A.USER_CODE,GROUP_NAME,MAX(ISNULL(VALUE,0)) AS VALUE
  FROM USERS A   
  JOIN USER_ROLE_MST AS B ON B.ROLE_ID =A.ROLE_ID   
  JOIN USER_ROLE_DET AS C ON C.ROLE_ID =A.ROLE_ID   
  --WHERE ISNULL(VALUE,0) =1  
  WHERE  (@CUSER_CODE='' OR A.USER_CODE=@CUSER_CODE)  
  GROUP BY A.USER_CODE,GROUP_NAME   
   
    GOTO END_PROC  
   
   SELECT * FROM USER_ROLE_DET  
   
 END_PROC:  
END
