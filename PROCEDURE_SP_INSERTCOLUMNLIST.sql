CREATE PROCEDURE SP_INSERTCOLUMNLIST  
		@CTABLENAME VARCHAR(50),
		@LDONOTREPLNULLS BIT=0, 
		@CUSERID VARCHAR(30)='',
		@CRETFIELDS NVARCHAR(MAX) OUTPUT, 
		@CRETFIELDSVALUE NVARCHAR(MAX) OUTPUT,
		@CTABLEALIAS VARCHAR(10)=''
--WITH ENCRYPTION		
AS
BEGIN
	DECLARE @CCOLNAME VARCHAR(50),
			@CSOURCECOLNAME VARCHAR(50),
			@CCOLTYPE VARCHAR(50),
			@CCOLVALUE VARCHAR(100),
			@CCMD NVARCHAR(1000),
			@CTARGETCOLNAME VARCHAR(50),
			@CISNULLVALUE VARCHAR(10),
			@LEXCLUSIONS BIT,@BISNULLABLE BIT,
			@CDEFAULTVALUE VARCHAR(100),@CUSERIDPREFIX VARCHAR(30)


	SET @CUSERIDPREFIX=(CASE WHEN @CUSERID<>'' THEN @CUSERID+'.' ELSE '' END)

	SET @CRETFIELDS = N''
	SET @CRETFIELDSVALUE = N''
	SET @LEXCLUSIONS = 0

	IF EXISTS ( SELECT NAME FROM SYSOBJECTS WHERE NAME = '__EXCLUSIONS' )
	BEGIN
		IF EXISTS ( SELECT TABLE_NAME FROM __EXCLUSIONS WHERE TABLE_NAME = @CTABLENAME )
			SET @LEXCLUSIONS = 1
	END
	
	IF @CTABLEALIAS <> ''
		SET @CTABLEALIAS = @CTABLEALIAS + '.'
	
	

	DECLARE ABC CURSOR FOR 
	SELECT COLNAME, COLTYPE,SOURCECOLNAME,ISNULLABLE FROM #TTARGETCOL

	OPEN ABC
	FETCH NEXT FROM ABC INTO @CCOLNAME, @CCOLTYPE ,@CSOURCECOLNAME,@BISNULLABLE
	WHILE @@FETCH_STATUS = 0
	BEGIN

		IF @CCOLTYPE IN ( 'INT', 'SMALLINT', 'NUMERIC', 'BIT' ,'TINYINT')
			SET @CISNULLVALUE = '0'
		ELSE 
			SET @CISNULLVALUE = ''''''

		IF @LEXCLUSIONS=1 
			SELECT @CDEFAULTVALUE = DEFAULT_VALUE FROM __EXCLUSIONS 
			WHERE TABLE_NAME = @CTABLENAME
			AND COLUMN_NAME = @CCOLNAME

		IF @CDEFAULTVALUE IS NULL OR @CSOURCECOLNAME IS NULL
		BEGIN
--			SET @CCOLVALUE = (CASE WHEN @CSOURCECOLNAME IS NOT  NULL THEN 
--							 (CASE WHEN @LDONOTREPLNULLS=0 THEN 'ISNULL( ' ELSE '' END) + @CSOURCECOLNAME +
--							 (CASE WHEN @LDONOTREPLNULLS=0 THEN  ', '+@CISNULLVALUE+')' END) ELSE  @CISNULLVALUE END)
			SET @CCOLVALUE = (CASE WHEN @BISNULLABLE=1 AND @CSOURCECOLNAME IS NOT  NULL THEN @CTABLEALIAS + @CCOLNAME
								   WHEN @CSOURCECOLNAME IS NOT  NULL THEN 
								    'ISNULL( ' + @CTABLEALIAS + @CCOLNAME + ', '+@CISNULLVALUE+')' 
							 	   ELSE  @CISNULLVALUE END)

			-- PRINT @CCOLNAME+ISNULL(@CCOLVALUE,'NULLCOLVALUE')
		END
		ELSE
		BEGIN
			IF @CCOLTYPE IN ( 'INT', 'SMALLINT', 'NUMERIC', 'BIT','TINYINT' )
				SET @CCOLVALUE = @CDEFAULTVALUE
			ELSE 
				SET @CCOLVALUE = '''' + @CDEFAULTVALUE + ''''
		END
		
		SET @CRETFIELDS = @CRETFIELDS + ( CASE WHEN @CRETFIELDS<>'' THEN ',' ELSE '' END ) + @CCOLNAME

		SET @CRETFIELDSVALUE =  @CRETFIELDSVALUE + ( CASE WHEN @CRETFIELDSVALUE<>'' THEN ',' ELSE '' END ) + @CCOLVALUE


		IF @LEXCLUSIONS = 1
			SET @CDEFAULTVALUE = NULL

		FETCH NEXT FROM ABC INTO @CCOLNAME, @CCOLTYPE ,@CSOURCECOLNAME,@BISNULLABLE
	END
	CLOSE ABC
	DEALLOCATE ABC

END
