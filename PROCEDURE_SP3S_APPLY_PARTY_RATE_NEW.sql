create PROCEDURE SP3S_APPLY_PARTY_RATE_NEW --(LocId 3 digit change by Sanjay:04-11-2024)  
(  
   @NSPID INT,  
   @CERRORMSG VARCHAR(MAX) OUTPUT,  
   @CXNTYPE VARCHAR(10)=''  ,  
   @cLOCID VARCHAR(4)='',  
   @BGrouoInvoice bit=0  
 )     
--WITH ENCRYPTION9  
AS  
BEGIN  
 PRINT 'ENTER PARTY RATE NEW WITH MRP'  
    DECLARE @CERRMSG VARCHAR(MAX),@CARTICLE_CODE VARCHAR(100),@CPARA1_CODE VARCHAR(100),@CPARA2_CODE VARCHAR(100),  
    @CPARA3_CODE VARCHAR(100),@CPARA4_CODE VARCHAR(100),@CPARA5_CODE VARCHAR(100),@CPARA6_CODE VARCHAR(100),  
    @CPARTYRATEMEMOID VARCHAR(100),@CCMD NVARCHAR(MAX),@NBASE_PRICE NUMERIC(18,2),@NCAL_MODE INT,  
    @NDISCOUNT_PERCENTAGE NUMERIC(18,2),@NRATE NUMERIC(18,2),@NDISCOUNT_AMOUNT NUMERIC(18,2),  
    @NNETRATE NUMERIC(18,2),@GIVE_CREDIT_VAT INT,@VAT_PER NUMERIC(18,2),@CMEMO_DT DATETIME,  
    @VAT_AMOUNT NUMERIC(18,2),@PARTY_FINAL_MARGIN NUMERIC(18,2),@GROSS_SALE NUMERIC(18,2),@BMRPRANGEBASEDMEMO BIT,  
    @VAT_EX_AMOUNT NUMERIC(18,2),@CFILTER_EXP VARCHAR(2000),@BFOUND BIT,@CROWID VARCHAR(40),@CSTEP VARCHAR(5),  
    @bshow_gstper bit,@nTAX_METHOD int ,@NdefaultrateType  int
      
BEGIN TRY                
    SET @CSTEP=10             
 SET @CERRMSG=''  
  
  
 UPDATE A SET PARA1_CODE=SKU.PARA1_CODE  
 ,PARA2_CODE=SKU.PARA2_CODE  
 ,PARA3_CODE=SKU.PARA3_CODE  
 ,PARA4_CODE=SKU.PARA4_CODE  
 ,PARA5_CODE=SKU.PARA5_CODE  
 ,PARA6_CODE=SKU.PARA6_CODE  
 FROM [WSL_ITEM_DETAILS] A  
 JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
 WHERE A.sp_id=@NSPID  
   
 SELECT TOP 1 @CPARTYRATEMEMOID=MEMO_ID,@CMEMO_DT=MEMO_DT,@BMRPRANGEBASEDMEMO=ISNULL(MRP_RANGE_BASED_MEMO,0) ,  
              @bshow_gstper=isnull(a.show_gstper ,0),@NTAX_METHOD=A.TAX_METHOD ,@NdefaultrateType=a.MST_BASE_PRICE 
 FROM PARTY_RATE_MST A  
 JOIN WSL_INV_SETTINGS B ON  A.MEMO_ID=B.PARTY_RATE_MEMO_ID  
 WHERE B.SP_ID=@NSPID  
   
   
 IF OBJECT_ID('TEMPDB..#TMPPRATEDET','U') IS NOT NULL  
  DROP TABLE #TMPPRATEDET  
   
 SET @CSTEP=20  
   
   
   
 --changes required one party rate memo has baeen more than 100 records (Problem occured at Amartex 28-02-19 : Dinkar)  
 ---SELECT * INTO #TMPPRATEDET FROM PARTY_RATE_DET WHERE MEMO_ID=@CPARTYRATEMEMOID  
   
 SELECT distinct  A.* INTO #TMPPRATEDET   
 FROM PARTY_RATE_DET A (NOLOCK)  
    JOIN PARTY_RATE_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID   
    JOIN wsl_item_details WSL (NOLOCK) ON WSL.sp_id=@NSPID   
    WHERE A.MEMO_ID=@CPARTYRATEMEMOID  
    AND (ISNULL(B.SHOW_ARTICLE,0)=0 OR WSL.ARTICLE_CODE =A.ARTICLE_CODE )  
    AND (ISNULL(B.SHOW_SUB_SECTION,0)=0 OR WSL.sub_section_code  =A.SUB_SECTION_CODE  )  
    AND (ISNULL(B.SHOW_SECTION,0)=0 OR WSL.section_code  =A.SECTION_CODE  )  
    AND (ISNULL(B.show_hsn,0)=0 OR WSL.hsn_code   =A.hsn_code   )  
    AND (ISNULL(B.SHOW_PARA1,0)=0 OR WSL.PARA1_CODE    =A.PARA1_CODE    )  
    AND (ISNULL(B.SHOW_PARA2,0)=0 OR WSL.PARA2_CODE    =A.PARA2_CODE    )  
    AND (ISNULL(B.SHOW_PARA3,0)=0 OR WSL.PARA3_CODE    =A.PARA3_CODE    )  
    AND (ISNULL(B.SHOW_PARA4,0)=0 OR WSL.PARA4_CODE    =A.PARA4_CODE    )  
    AND (ISNULL(B.SHOW_PARA5,0)=0 OR WSL.PARA5_CODE    =A.PARA5_CODE    )  
    AND (ISNULL(B.SHOW_PARA6,0)=0 OR WSL.PARA6_CODE    =A.PARA6_CODE    )  
  
   
    --Process for Gst Percentage if Party rate applicable for gst Percentage  
  IF  @bshow_gstper=1   
  begin  
    
     if ISNULL(@NTAX_METHOD,0)=0  
        set @NTAX_METHOD=2  
       
    ;WITH CTE AS  
   (  
   SELECT B.HSN_CODE,ISNULL(C.TAX_PERCENTAGE,0)  AS TAX_PERCENTAGE,ISNULL(C.RATE_CUTOFF,0) AS RATE_CUTOFF,  
       ISNULL(C.RATE_CUTOFF_TAX_PERCENTAGE,0) AS RATE_CUTOFF_TAX_PERCENTAGE,  
      ISNULL(C.WEF,'') AS WEF,ISNULL(B.TAXABLE_ITEM,'') AS TAXABLE_ITEM,ISNULL(B.HSN_TYPE ,'') AS HSN_TYPE  ,  
      SR=ROW_NUMBER() OVER (PARTITION BY A.ROW_ID ORDER BY C.WEF DESC),  
      ISNULL(C.GST_CAL_BASIS,1) AS GST_CAL_BASIS,a.row_id   
   FROM wsl_item_details  A (NOLOCK)  
   JOIN HSN_MST B (NOLOCK) ON A.HSN_CODE =B.HSN_CODE   
   LEFT JOIN HSN_DET C (NOLOCK) ON B.HSN_CODE =C.HSN_CODE AND C.WEF  <=a.INV_DT    
   WHERE A.SP_ID =@NSPID   
   )  
   SELECT * INTO #TMPGst FROM CTE WHERE SR=1  
   
   if @CXNTYPE <>'WSL'
   begin
       
        Update tmp set gross_rate =(case when @NdefaultrateType=2 then mrp else ws_price end )
        FROM wsl_item_details TMP (NOLOCK)  
        WHERE TMP.SP_ID=@NSPID  
   
   end
     
	 --single pcs taxable value and gst percentage pick single pcs
   
     UPDATE TMP SET GST_PERCENTAGE=ISNULL(CASE WHEN HM.RATE_CUTOFF<ABS(TMP.gross_rate)   
     THEN HM.TAX_PERCENTAGE ELSE RATE_CUTOFF_TAX_PERCENTAGE END ,0)  
     FROM wsl_item_details TMP (NOLOCK)  
     JOIN #TMPGst HM (NOLOCK) ON HM.HSN_CODE=TMP.HSN_CODE and tmp.row_id =hm.row_id   
     WHERE TMP.SP_ID=@NSPID  
     
     
    
  
    
  end  
  
 IF  @CPARTYRATEMEMOID <>'' AND    EXISTS (SELECT * FROM CONFIG WHERE CONFIG_OPTION ='DO_NOT_PICK_WSP_MRP_IF_PARTY_RATE_SETUP' AND VALUE=1 )  
 BEGIN  
  
  UPDATE A SET RATE =0  FROM WSL_ITEM_DETAILS A  
  WHERE A.SP_ID=@NSPID   
  AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0  
  
 END  
  
  
 SET @BFOUND=1  
 WHILE @BFOUND=1  
 BEGIN  
    
  SET @CSTEP=30  
  SELECT @CFILTER_EXP='',@CROWID=''  
    
  SELECT TOP 1 @CROWID=ROW_ID FROM #TMPPRATEDET  
    
  IF ISNULL(@CROWID,'')=''  
   BREAK  
    
  SET @CSTEP=40      
  IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND ARTICLE_CODE NOT IN ('','00000000'))  
   SET @CFILTER_EXP=@CFILTER_EXP+' SKU.ARTICLE_CODE=PR.ARTICLE_CODE'   
    
  IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA1_CODE NOT IN ('','0000000'))   
   SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' SKU.PARA1_CODE=PR.PARA1_CODE'   
    
  IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA2_CODE NOT IN ('','0000000'))  
   SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' SKU.PARA2_CODE=PR.PARA2_CODE'   
    
  IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA3_CODE NOT IN ('','0000000'))  
   SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' SKU.PARA3_CODE=PR.PARA3_CODE'   
    
  SET @CSTEP=70  
  IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA4_CODE NOT IN ('','0000000'))  
   SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' SKU.PARA4_CODE=PR.PARA4_CODE'   
          
  IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA5_CODE NOT IN ('','0000000'))  
   SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' SKU.PARA5_CODE=PR.PARA5_CODE'   
          
  IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND PARA6_CODE NOT IN ('','0000000'))  
   SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' SKU.PARA6_CODE=PR.PARA6_CODE'   
    
  IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND SECTION_CODE NOT IN ('','0000000'))  
   SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.SECTION_CODE=PR.SECTION_CODE'     
  
  IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND SUB_SECTION_CODE NOT IN ('','0000000'))  
   SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.SUB_SECTION_CODE=PR.SUB_SECTION_CODE'        
    
  IF EXISTS(SELECT TOP 1 MEMO_ID FROM #TMPPRATEDET WHERE ROW_ID=@CROWID AND ISNULL(HSN_CODE,'') NOT IN ('','0000000000'))  
   SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.HSN_CODE=PR.HSN_CODE'   
   
     --Process for Gst Percentage if Party rate applicable for gst Percentage  
  IF  @bshow_gstper=1   
     SET @CFILTER_EXP=@CFILTER_EXP+(CASE WHEN @CFILTER_EXP<>'' THEN ' AND ' ELSE '' END)+' A.GST_PERCENTAGE=PR.gst_percentage '   
    
       
           
  IF @CFILTER_EXP=''  
  SET @CFILTER_EXP='1=1'  
  
  
     
  SET @CSTEP=50    
  SET @CCMD=N'UPDATE A SET PARTY_RATE_BASE_PRICE=PR.BASE_PRICE,PARTY_RATE_CAL_MODE=PR.CAL_MODE,  
     DISCOUNT_PERCENTAGE=(CASE WHEN ISNULL(PR.CAL_MODE,3)=1 THEN 0  
                               WHEN ISNULL(PR.CAL_MODE,3)=2 THEN PR.VALUE ELSE 0 END),  
      RATE=(CASE WHEN ISNULL(PR.CAL_MODE,3)=3 THEN PR.VALUE ELSE 0 END),  
     PARTY_RATE_GIVE_CREDIT_VAT=PR.GIVE_CREDIT_VAT,  
     WSL_ADD_DISCOUNT=PR.VALUE,  
     DISCOUNT_amount=0  
     FROM WSL_ITEM_DETAILS A   
     JOIN SKU  (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE  
     JOIN #TMPPRATEDET PR (NOLOCK) ON '+@CFILTER_EXP+  
     ' WHERE A.SP_ID='+LTRIM(RTRIM(STR(@NSPID)))+' AND MEMO_ID='''+@CPARTYRATEMEMOID+''''+  
     (CASE WHEN @BMRPRANGEBASEDMEMO=1 THEN ' AND SKU.MRP BETWEEN PR.FROM_MRP AND PR.TO_MRP ' ELSE '' END)+  
     ' AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0'  
    
  PRINT ISNULL(@CCMD,'NULL PARTYRATE EXPR')         
  EXEC SP_EXECUTESQL @CCMD  
  
   
  DELETE FROM #TMPPRATEDET WHERE ROW_ID=@CROWID  
 END  
  
   
  
 DECLARE @CHODEPT_ID VARCHAR(4)  
 SELECT @CHODEPT_ID=VALUE  FROM config WHERE config_option='HO_LOCATION_ID'  
  
 --CHANGE FORT SIYARAM AS dISCUSS WITH SIR AND PANKAJ JI(pick pp for xfer price) (23052023) in wsl invoice(20230523)  
  SET @CSTEP=55   
  UPDATE A SET RATE=(CASE WHEN ISNULL(PARTY_RATE_CAL_MODE,0)=3 AND ISNULL(RATE,0)<>0 THEN RATE    
   WHEN ISNULL(PARTY_RATE_BASE_PRICE,0)=1 THEN SKU.WS_PRICE    
   WHEN ISNULL(PARTY_RATE_BASE_PRICE,0)=2 THEN SKU.MRP     
   ELSE (CASE WHEN @BGROUOINVOICE=1 AND @CXNTYPE ='WSL' and  isnull(SKU.PURCHASE_PRICE,0)=0 THEN XFP.xfer_price ELSE SKU.PURCHASE_PRICE END)   END)    
   FROM WSL_ITEM_DETAILS A    
   JOIN SKU ON SKU.PRODUCT_CODE=A.PRODUCT_CODE    
   LEFT OUTER JOIN SKU_OH ON SKU_OH.PRODUCT_CODE=A.PRODUCT_CODE    
   LEFT OUTER JOIN sku_xfp xfp (nolock) ON xfp.PRODUCT_CODE=A.PRODUCT_CODE and a.DEPT_ID =xfp.dept_id     
   WHERE A.SP_ID=@NSPID AND PARTY_RATE_CAL_MODE IS NOT NULL    
   AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0    
     
  UPDATE A SET RATE=(CASE WHEN ISNULL(PARTY_RATE_CAL_MODE,0)=1 THEN ISNULL(RATE,0) + (ISNULL(RATE,0)*WSL_ADD_DISCOUNT/100) ELSE RATE END)  
  FROM WSL_ITEM_DETAILS A   
  JOIN SKU ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
  LEFT OUTER JOIN SKU_OH ON SKU_OH.PRODUCT_CODE=A.PRODUCT_CODE  
  WHERE A.SP_ID=@NSPID AND PARTY_RATE_CAL_MODE IS NOT NULL  
  AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0  
  
   
 IF ISNULL(@CPARTYRATEMEMOID,'')<>'' and   exists (select * from config where config_option ='DO_NOT_PICK_WSP_MRP_IF_PARTY_RATE_SETUP' and value=1 )  
 BEGIN  
       
  IF EXISTS (SELECT TOP 1 'U'  FROM WSL_ITEM_DETAILS A  
  WHERE A.SP_ID=@NSPID   
      AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0  
   AND ISNULL(A.RATE,0) =0)  
   begin  
          
       SET @CERRORMSG='PARTY RATE NOT DEFINE OF THIS ITEM'  
    UPDATE A SET ERRMSG='PARTY RATE NOT DEFINE OF THIS ITEM '+PRODUCT_CODE  
    FROM WSL_ITEM_DETAILS A  
    WHERE A.SP_ID=@NSPID   
    AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0  
    AND ISNULL(A.RATE,0) =0  
    GOTO END_PROC  
  
        
   end  
  
  
 END  
  
 --SELECT RATE,* FROM WSL_ITEM_DETAILS WHERE sp_id=@NSPID  
    
   
 SET @CSTEP=60  
 SELECT TOP 1 @GIVE_CREDIT_VAT=GIVE_CREDIT_VAT FROM WSL_ITEM_DETAILS WHERE SP_ID=@NSPID  
    
 IF ISNULL(@GIVE_CREDIT_VAT,0)=1  
 BEGIN  
  SET @CSTEP=70  
  UPDATE A SET CREDIT_VAT_PERCENTAGE=(CASE WHEN A.MRP BETWEEN ISNULL(LSADD.MIN_MRP,0) AND ISNULL(LSADD.MAX_MRP,0)  
  THEN LSADD.TAX_PERCENTAGE ELSE LS.TAX_PERCENTAGE END) FROM WSL_ITEM_DETAILS A  
  JOIN ARTICLE B ON B.ARTICLE_CODE=A.ARTICLE_CODE  
  JOIN LOCSST LS ON LS.SUB_SECTION_CODE=B.SUB_SECTION_CODE  
  JOIN WSL_INV_SETTINGS C ON C.SP_ID=A.SP_ID  
  LEFT OUTER JOIN LOCSSTADD LSADD ON LSADD.LOCSST_ROW_ID=LS.ROW_ID  
  WHERE  LS.MEMO_ID=C.LOCSST_MEMO_ID AND ISNULL(GIVE_CREDIT_VAT,0)=1   
   
  SET @CSTEP=90  
  UPDATE WSL_ITEM_DETAILS SET VATPAIDONMRP=0,DISCOUNT_AMOUNT=(RATE*DISCOUNT_PERCENTAGE*INVOICE_QUANTITY)/100,  
  NET_RATE=RATE+(RATE*DISCOUNT_PERCENTAGE/100),PARTY_FINAL_MARGIN=0   
  WHERE SP_ID=@NSPID AND ISNULL(PARTY_RATE_CAL_MODE,0)=1  
  AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0  
    
  SET @CSTEP=100  
  UPDATE WSL_ITEM_DETAILS SET NET_RATE=RATE-(DISCOUNT_AMOUNT/INVOICE_QUANTITY)  
  WHERE SP_ID=@NSPID AND ISNULL(PARTY_RATE_CAL_MODE,0)=1  
  AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0  
    
  SET @CSTEP=110  
  UPDATE WSL_ITEM_DETAILS SET VATPAIDONMRP=(RATE*ISNULL(CREDIT_VAT_PERCENTAGE,0))/(100+ISNULL(CREDIT_VAT_PERCENTAGE,0)),  
  PARTY_FINAL_MARGIN=(RATE*ISNULL(CREDIT_VAT_PERCENTAGE,0))/(100+ISNULL(CREDIT_VAT_PERCENTAGE,0))+(RATE*DISCOUNT_PERCENTAGE/100)  
  WHERE SP_ID=@NSPID AND ISNULL(PARTY_RATE_CAL_MODE,0)=2  
  AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0  
    
  SET @CSTEP=120  
  UPDATE WSL_ITEM_DETAILS SET NET_RATE=RATE-ISNULL(PARTY_FINAL_MARGIN,0)  
  WHERE SP_ID=@NSPID AND ISNULL(PARTY_RATE_CAL_MODE,0)=2  
  AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0  
    
  SET @CSTEP=130  
  UPDATE WSL_ITEM_DETAILS SET DISCOUNT_PERCENTAGE=((RATE-NET_RATE)/RATE)*100  
  WHERE SP_ID=@NSPID AND ISNULL(PARTY_RATE_CAL_MODE,0)=2  
  AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0  
  AND RATE<>0  
 END  
    
 SET @CSTEP=140  
 UPDATE WSL_ITEM_DETAILS SET DISCOUNT_AMOUNT=RATE*DISCOUNT_PERCENTAGE*INVOICE_QUANTITY/100  
 WHERE SP_ID=@NSPID AND ISNULL(PARTY_RATE_CAL_MODE,0)=2  
 AND ISNULL(MANUAL_RATE,0)=0 AND ISNULL(MANUAL_NET_RATE,0)=0 AND ISNULL(MANUAL_DISCOUNT,0)=0  
   
 GOTO END_PROC  
END TRY  
  
BEGIN CATCH  
 SET @CERRORMSG='PROCEDURE SP3S_APPLY_PARTY_RATE_NEW STEP#'+@CSTEP+':'+ERROR_MESSAGE()  
 GOTO END_PROC  
END CATCH  
  
END_PROC:  
  
  
  
  
  
     
END  
--END OF PROCEDURE - SP3S_APPLY_PARTY_RATE_NEW  