create PROCEDURE UPDATEPMT_JOBCARD  
  @CXNTYPE			VARCHAR(10),  
  @CXNNO			VARCHAR(40),  
  @CXNID			VARCHAR(40),  
  @NREVERTFLAG		BIT = 0,  
  @NALLOWNEGSTOCK	BIT = 0,  
  @NCHKDELBARCODES	BIT = 0,  
  @NUPDATEMODE		INT=0,   
  @CCMD				NVARCHAR(4000) OUTPUT ,
  @BDONOT_UPDATE_SET_STOCK BIT=0
  
  --*** PARAMETERS :  
  --*** @CXNTYPE -		TRANSACTION TYPE (MODULE SPECIFIC)  
  --*** @CXNNO -		TRANSACTION NO ( MEMO NO OF MASTER TABLE )  
  --*** @CXNID -		TRANSACTION ID ( MEMO ID OF MASTER TABLE )  
  --*** @NREVERTFLAG -	A FLAG TO INDICATE WHETHER THIS PROCEDURE IS CALLED TO REVERT STOCK  
  --*** @NALLOWNEGSTOCK - FLAG TO INDICATE WHETHER OR NOT ALLOW NEGATIVE STOCK  
  --*** @NRETVAL - OUTPUT PARAMETER RETURNED BY THIS PROCEDURE (BIT 1-SUCCESS, 0-UNSUCCESS)  
----WITH ENCRYPTION
 --SET @CMASTERTABLENAME = 'ORD_PLAN_MST'  
 --SET @CDETAILTABLENAME = 'ORD_PLAN_DET'  
 --SET @CDETAILTABLENAME2 = 'ORD_PLAN_BOM_DET'  
 --SET @CDETAILTABLENAME3 = 'ORD_PLAN_BARCODE_DET'
AS  
BEGIN  
	 DECLARE @NOUTFLAG INT, @NRETVAL BIT,@CXNTABLE VARCHAR(50),@CEXPR NVARCHAR(500),@CXNIDPARA VARCHAR(50),  
	   @BCANCELLED BIT  
	 RAISERROR('UPDATEPMT_JOB',0,1)  
	 SET @NRETVAL = 0  
	 SET @CCMD = ''  
	    
	 IF @NREVERTFLAG = 1  
	  SET @NOUTFLAG = -1  
	 ELSE  
	  SET @NOUTFLAG = 1  
	PRINT 'UPDATEPMT_JOBCARD STEP 0' 
	 
	 IF NOT EXISTS ( SELECT TOP 1 A.PRODUCT_CODE FROM ORD_PLAN_BARCODE_DET A JOIN ORD_PLAN_DET B ON A.REFROW_ID=B.ROW_ID
					 WHERE B.MEMO_ID=@CXNID) 
		   GOTO END_PROC
	PRINT 'UPDATEPMT_JOBCARD STEP 1'
	
	DECLARE @ORG_WIP_UID VARCHAR(40)
	SET @ORG_WIP_UID=CONVERT(VARCHAR(40),NEWID()) 
	
	--INSERT PMT01106 (PRODUCT_CODE,  QUANTITY_IN_STOCK, DEPT_ID,BIN_ID, LAST_UPDATE )   
	INSERT JOBWORK_PMT (PRODUCT_CODE,  QUANTITY_IN_STOCK, DEPT_ID,BIN_ID, LAST_UPDATE ,Trading_Product_code)     
	SELECT A1.PRODUCT_CODE,0 AS QUANTITY_IN_STOCK,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ DEPT_ID,C.BIN_ID,GETDATE() AS LAST_UPDATE,b.Trading_Product_code
    FROM ORD_PLAN_BARCODE_DET A1
    JOIN ORD_PLAN_DET B ON A1.REFROW_ID=B.ROW_ID   
    JOIN ORD_PLAN_MST C ON C.MEMO_ID=B.MEMO_ID    
    JOIN SKU D ON A1.PRODUCT_CODE = D.PRODUCT_CODE   
    LEFT OUTER JOIN JOBWORK_PMT PMT ON PMT.PRODUCT_CODE = A1.PRODUCT_CODE AND PMT.DEPT_ID = C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=C.BIN_ID    
	WHERE C.MEMO_ID = @CXNID AND PMT.PRODUCT_CODE IS NULL  
	
	
	 PRINT 'UPDATEPMT_JOBCARD STEP 3'
	
	 --*** UPDATING THE QUANTITY IN STOCK INTO PMT01106 FOR THE GIVEN MEMO  
	 UPDATE A SET QUANTITY_IN_STOCK = QUANTITY_IN_STOCK + ( @NOUTFLAG * X.QUANTITY )  
	 FROM  JOBWORK_PMT A  
	 JOIN   
	 ( 
		SELECT A.PRODUCT_CODE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ DEPT_ID,C.BIN_ID,1 AS QUANTITY   
		FROM ORD_PLAN_DET B  
		JOIN ORD_PLAN_BARCODE_DET A ON A.REFROW_ID=B.ROW_ID
		JOIN ORD_PLAN_MST C ON C.MEMO_ID=B.MEMO_ID  
		JOIN SKU D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
		JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
		WHERE B.MEMO_ID = @CXNID AND E.STOCK_NA=0  
		AND E.ARTICLE_PRD_MODE <>2
		--AND (@BDONOT_UPDATE_SET_STOCK=0 OR  E.ARTICLE_SET_TYPE <>1)
		GROUP BY A.PRODUCT_CODE,C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/ , C.BIN_ID  
	 )X ON A.PRODUCT_CODE = X.PRODUCT_CODE AND A.BIN_ID = X.BIN_ID AND A.DEPT_ID = X.DEPT_ID  

	 
	
	  
     SET @NRETVAL = 1  --*** SUCCESS  
	 PRINT 'UPDATEPMT_JOBCARD STEP 5'
	 SELECT @BCANCELLED=CANCELLED FROM ORD_PLAN_MST WHERE MEMO_ID=@CXNID  

	 --*** CHECKING FOR NEGATIVE STOCK  
	 --*** IF USER OPTED NOT TO ALLOW NEGATIVE STOCK AND STOCK IS GOING OUT  
	 PRINT 'UPDATEPMT_JOBCARD STEP 6'
	 IF @NALLOWNEGSTOCK = 0 OR @BCANCELLED=1   
	 BEGIN  
	  IF EXISTS (	SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM JOBWORK_PMT PMT
					JOIN ORD_PLAN_BARCODE_DET A ON A.PRODUCT_CODE=PMT.PRODUCT_CODE 
					JOIN ORD_PLAN_DET B  ON B.ROW_ID=A.REFROW_ID
					JOIN ORD_PLAN_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN SKU D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE B.MEMO_ID = @CXNID AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=C.BIN_ID
					AND E.ARTICLE_PRD_MODE <>2
					--27 APR 2018
					AND C.CANCELLED=0
					--27 APR 2018
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0
			)  
	  BEGIN  
	   SET @NRETVAL = 0  --*** UNSUCCESS  
			SET @CCMD='SELECT PMT.PRODUCT_CODE,SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0)) AS QUANTITY   
					FROM JOBWORK_PMT PMT
					JOIN ORD_PLAN_BARCODE_DET A ON A.PRODUCT_CODE=PMT.PRODUCT_CODE 
					JOIN ORD_PLAN_DET B  ON B.ROW_ID=A.REFROW_ID
					JOIN ORD_PLAN_MST C ON C.MEMO_ID=B.MEMO_ID  
					JOIN SKU D ON A.PRODUCT_CODE = D.PRODUCT_CODE  
					JOIN ARTICLE E ON D.ARTICLE_CODE = E.ARTICLE_CODE  
					WHERE B.MEMO_ID = '''+@CXNID+''' AND E.STOCK_NA=0  
					AND PMT.DEPT_ID=C.Location_code/*C.DEPT_ID*//*Rohit 06-11-2024*/  AND PMT.BIN_ID=C.BIN_ID
					AND C.CANCELLED=0
					AND E.ARTICLE_PRD_MODE <>2
					GROUP BY PMT.PRODUCT_CODE
					HAVING SUM(ISNULL(PMT.QUANTITY_IN_STOCK,0))<0'		
	  END  
	   PRINT @CCMD  
   END   
	  
END_PROC:  
	PRINT 'UPDATEPMT_JOBCARD STEP OUT'  
END  
--***************************** END OF PROCEDURE UPDATEPMT_JOBCARD
