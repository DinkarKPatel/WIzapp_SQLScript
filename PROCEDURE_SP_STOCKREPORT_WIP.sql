CREATE PROCEDURE SP_STOCKREPORT_WIP--(LocId 3 digit change by Sanjay:30-10-2024)
	@CFROMDATE		DATETIME='',
	@CTODATE		DATETIME,
	@CPRODUCT_CODE	VARCHAR(100)='',
	@CAGENCY		VARCHAR(100)='',
	@bCalledfromBuildPendingDocs BIT=0,
	@tTable VARCHAR(200)='',
	@cFilterCriteria VARCHAR(2000)='',
	@bFirstDt BIT=0,
	@tPrevDtTable VARCHAR(200)=''
AS
BEGIN
/*
SP_STOCKREPORT_WIP '2014-10-14','2014-09-30','IP-013014'
SP_STOCKREPORT_WIP '2014-10-14','2014-10-30','IP-013014'
*/
	DECLARE @cDtFilter VARCHAR(100)

	SET @cDtFilter=(CASE WHEN @bCalledfromBuildPendingDocs=0 OR @bFirstDt=1  THEN '<' ELSE '' END)+
	'='''+CONVERT(VARCHAR,@CTODATE,110)+''''

	--GET THE STOCK VALUE OF NOT ISSUED ITEMS AT ANY DATE 
	IF OBJECT_ID('TEMPDB..#CBSWIP','U') IS NOT NULL
		DROP TABLE #CBSWIP

	DECLARE @cCmd nvarchar(max)

	
	SELECT SM.location_Code as dept_id,wp.bin_id,'WIP' AS XN_TYPE,SCI.PRODUCT_CODE,wp.quantity_in_stock AS QUANTITY,
			wp.BASE_PRICE RATE,WP.WIP_UID
	INTO #CBSWIP	  
	FROM SNC_MST SM(NOLOCK)
	JOIN SNC_DET SD(NOLOCK) ON SM.MEMO_ID=SD.MEMO_ID
	JOIN snc_barcode_det sci (NOLOCK) ON SCI.REFROW_ID=SD.ROW_ID
	JOIN WIP_PMT WP(NOLOCK) ON SD.ROW_ID=WP.XN_ROW_ID
	WHERE 1=2

	
	SET @cCmd=N'SELECT SM.location_Code as dept_id,sm.bin_id,''WIP'' AS XN_TYPE,WP.PRODUCT_CODE,
			SUM(QUANTITY) AS QUANTITY,sd.PURCHASE_PRICE AS RATE,WP.WIP_UID 
		FROM SNC_MST SM(NOLOCK)
		JOIN SNC_DET SD(NOLOCK) ON SM.MEMO_ID=SD.MEMO_ID
		JOIN WIP_PMT WP(NOLOCK) ON SD.ROW_ID=WP.XN_ROW_ID
		WHERE SM.CANCELLED=0 AND WIP=1 AND SM.RECEIPT_DT'+@cDtFilter+'
		AND '+(CASE WHEN @CPRODUCT_CODE='' THEN ' 1=1 ' ELSE ' WP.PRODUCT_CODE='''+@CPRODUCT_CODE+'''' END)+'
		GROUP BY SM.location_Code,sm.bin_id,wp.PRODUCT_CODE,wp.wip_uid,sd.PURCHASE_PRICE'
	
	PRINT @cCmd	
	INSERT #CBSWIP (dept_id,bin_id,xn_type,product_code,quantity,rate,wip_uid)
	EXEC SP_EXECUTESQL @cCmd
		
	SET @cCmd=N'SELECT jim.location_Code DEPT_ID,jid.bin_id,''WIP'' AS XN_TYPE
			  ,JID.PRODUCT_CODE,-SUM(JID.QUANTITY)
			  ,JID.PREV_JOB_RATE AS RATE,JID.WIP_UID
		FROM JOBWORK_ISSUE_MST JIM(NOLOCK)
		JOIN JOBWORK_ISSUE_DET JID(NOLOCK) ON JIM.ISSUE_ID=JID.ISSUE_ID
		JOIN WIP_PMT WP(NOLOCK) ON WP.WIP_UID=JID.WIP_UID
		WHERE JIM.WIP=1 AND JIM.CANCELLED=0 AND WP.JOB_CODE=''0000000'' AND JIM.ISSUE_DT'+@cDtFilter+'
		AND '+(CASE WHEN @CPRODUCT_CODE='' THEN ' 1=1 ' ELSE ' JID.PRODUCT_CODE='''+@CPRODUCT_CODE+'''' END)+'
		GROUP BY jim.location_Code,jid.bin_id,JID.PRODUCT_CODE,JID.PREV_JOB_RATE,JID.WIP_UID'
	
	PRINT @cCmd
	INSERT #CBSWIP (dept_id,bin_id,xn_type,product_code,quantity,rate,wip_uid)
	EXEC SP_EXECUTESQL @cCmd

		--GETTING LIST OF BARCODES THAT HAVE BEEN ISSUED TO TRADING WITHOUT ANY JOBWORK
	SET @cCmd=N'SELECT SM.location_Code dept_id,scd.bin_id,''WIP'' AS XN_TYPE,SCD.PRODUCT_CODE,-SUM(SCD.QUANTITY) quantity
			  ,WP.BASE_PRICE AS RATE,WP.WIP_UID
		FROM SNC_MST SM(NOLOCK)
		JOIN SNC_CONSUMABLE_DET SCD(NOLOCK) ON SCD.MEMO_ID=SM.MEMO_ID
		JOIN WIP_PMT WP(NOLOCK) ON SCD.WIP_UID=WP.WIP_UID
		WHERE SM.CANCELLED=0 AND SCD.WIP=1 AND SM.RECEIPT_DT'+@cDtFilter+' AND '+
		(CASE WHEN @CPRODUCT_CODE='' THEN ' 1=1 ' ELSE ' SCD.PRODUCT_CODE='''+@CPRODUCT_CODE+'''' END)+
		' AND WP.JOB_CODE=''0000000''
		GROUP BY SM.location_Code,scd.bin_id,SCD.PRODUCT_CODE,WP.BASE_PRICE,WP.WIP_UID'
	
	PRINT @cCmd
	INSERT #CBSWIP (dept_id,bin_id,xn_type,product_code,quantity,rate,wip_uid)
	EXEC SP_EXECUTESQL @cCmd


	
	---GETTING LIST OF BARCODES THAT HAVE BEEN ISSUED BUT NOT YET RECEIVED
	SET @cCmd=N'SELECT jim.location_Code AS DEPT_ID,jid.bin_id ,''JWI'' AS XN_TYPE,JID.PRODUCT_CODE
		  ,SUM(JID.QUANTITY-ISNULL(JRD.QUANTITY,0)) AS QUANTITY
		  ,JID.PREV_JOB_RATE AS RATE,JID.WIP_UID
	FROM JOBWORK_ISSUE_MST JIM(NOLOCK)
	JOIN JOBWORK_ISSUE_DET JID(NOLOCK) ON JIM.ISSUE_ID=JID.ISSUE_ID
	LEFT JOIN 
	(	SELECT JRD.REF_ROW_ID,SUM(JRD.QUANTITY) AS QUANTITY
		FROM JOBWORK_RECEIPT_DET JRD(NOLOCK) 
		JOIN JOBWORK_RECEIPT_MST JRM(NOLOCK) ON JRD.RECEIPT_ID=JRM.RECEIPT_ID 
		WHERE JRM.RECEIPT_DT'+@cDtFilter+' AND '+
		(CASE WHEN @CPRODUCT_CODE='' THEN ' 1=1 ' ELSE ' JRD.PRODUCT_CODE='''+@CPRODUCT_CODE+'''' END)+'
		 AND ISNULL(JRM.CANCELLED,0)=0
		GROUP BY JRD.REF_ROW_ID
	)JRD ON JRD.REF_ROW_ID=JID.ROW_ID
	WHERE JIM.WIP=1 AND JIM.CANCELLED=0  AND JID.QUANTITY-ISNULL(JRD.QUANTITY,0)>0
	AND JIM.ISSUE_DT'+@cDtFilter+' AND '+
		(CASE WHEN @CPRODUCT_CODE='' THEN ' 1=1 ' ELSE ' JID.PRODUCT_CODE='''+@CPRODUCT_CODE+'''' END)+
		'GROUP BY jim.location_Code,jid.bin_id,jid.PRODUCT_CODE,JID.PREV_JOB_RATE,jid.WIP_UID'
	
	PRINT @cCmd

	INSERT #CBSWIP (dept_id,bin_id,xn_type,product_code,quantity,rate,wip_uid)
	EXEC SP_EXECUTESQL @cCmd
		
	
	---GETTING LIST OF RECEIVED BARCODES WHICH IS IN WIP STOCK AT THE GIVEN DATE
	--SELECT dept_id,'WIP' AS XN_TYPE,bin_id,JWR.PRODUCT_CODE,SUM(JWR.QUANTITY) AS QUANTITY,JWR.RATE,SUM(JWR.QUANTITY)*JWR.RATE AS VALUE
	--	  ,JWR.WIP_UID AS WIP_UID 
	--FROM 
	--(
	SET @cCmd=N'SELECT jrm.location_Code AS DEPT_ID,jrm.bin_id,''WIP'' AS XN_TYPE,JRD.PRODUCT_CODE,
				SUM(JRD.QUANTITY-ISNULL(JID.QUANTITY,0)) AS QUANTITY
			   ,(WP.BASE_PRICE+WP.VALUE_ADDITION) AS RATE
			   ,WP.WIP_UID
		FROM JOBWORK_RECEIPT_MST JRM(NOLOCK)
		JOIN JOBWORK_RECEIPT_DET JRD(NOLOCK) ON JRM.RECEIPT_ID=JRD.RECEIPT_ID
		JOIN WIP_PMT WP(NOLOCK) ON JRD.ROW_ID=WP.XN_ROW_ID
		LEFT JOIN 
		(		SELECT JID.WIP_UID,SUM(JID.QUANTITY) AS QUANTITY
				FROM JOBWORK_ISSUE_DET JID(NOLOCK) 
				JOIN JOBWORK_ISSUE_MST JIM(NOLOCK) ON JIM.ISSUE_ID=JID.ISSUE_ID
				JOIN JOBWORK_RECEIPT_DET JRD (NOLOCK) ON jrd.wip_uid=jid.wip_uid
				JOIN JOBWORK_RECEIPT_MST JRM (NOLOCK) ON jrd.receipt_id=jrm.receipt_id
				WHERE jim.wip=1 AND JRM.RECEIPT_DT'+@cDtFilter+' AND '+---Dinkar need to check this condition of jim.wip=1 put by me 
																	   --- Becasue P&l when calling this procedure hanging at thhis step (Sanjay:04-03-2021)	
		(CASE WHEN @CPRODUCT_CODE='' THEN ' 1=1 ' ELSE ' JID.PRODUCT_CODE='''+@CPRODUCT_CODE+'''' END)+
		' AND ISNULL(JIM.CANCELLED,0)=0 GROUP BY JID.WIP_UID
		)JID ON JID.WIP_UID=WP.WIP_UID			
		WHERE JRM.WIP=1 AND JRM.CANCELLED=0 AND 
		JRM.RECEIPT_DT'+@cDtFilter+' AND '+
		(CASE WHEN @CPRODUCT_CODE='' THEN ' 1=1 ' ELSE ' JRD.PRODUCT_CODE='''+@CPRODUCT_CODE+'''' END)+
		'  AND JRD.QUANTITY-ISNULL(JID.QUANTITY,0)>0
		GROUP BY jrm.location_Code,jrm.bin_id,jrD.PRODUCT_CODE,(WP.BASE_PRICE+WP.VALUE_ADDITION),WP.WIP_UID'
	
	PRINT @cCmd

	INSERT #CBSWIP (dept_id,bin_id,xn_type,product_code,quantity,rate,wip_uid)
	EXEC SP_EXECUTESQL @cCmd

		
		--GETTING LIST OF BARCODES THAT HAVE BEEN ISSUED TO TRADING
	SET @cCmd=N'SELECT SM.location_Code AS DEPT_ID,sm.bin_id,''WIP'' AS XN_TYPE,SCD.PRODUCT_CODE,-SUM(SCD.QUANTITY) quantity
			  ,(WP.BASE_PRICE+WP.VALUE_ADDITION) AS RATE
			  ,WP.WIP_UID
		FROM SNC_MST SM(NOLOCK)
		JOIN SNC_CONSUMABLE_DET SCD(NOLOCK) ON SCD.MEMO_ID=SM.MEMO_ID
		JOIN WIP_PMT WP(NOLOCK) ON SCD.WIP_UID=WP.WIP_UID
		WHERE SM.CANCELLED=0 AND scd.WIP=1 AND SM.RECEIPT_DT'+@cDtFilter+' AND '+
		(CASE WHEN @CPRODUCT_CODE='' THEN ' 1=1 ' ELSE ' SCD.PRODUCT_CODE='''+@CPRODUCT_CODE+'''' END)+
		' AND WP.JOB_CODE<>''0000000''
		GROUP BY SM.location_Code,sm.bin_id,SCD.PRODUCT_CODE,(WP.BASE_PRICE+WP.VALUE_ADDITION),WP.WIP_UID'
	
	PRINT @cCmd

	INSERT #CBSWIP (dept_id,bin_id,xn_type,product_code,quantity,rate,wip_uid)
	EXEC SP_EXECUTESQL @cCmd
		
	--THIS TABLE WOULD BE CREATED BY PROCEDURE - SP_GETCBSSTK_FOR_PL
	IF @bCalledfromBuildPendingDocs=1
	BEGIN
		SET @cCmd=N'INSERT '+@ttable+'(dept_id,bin_id,product_code,quantity,value) '+
			(CASE WHEN @bFirstDt=0 THEN ' SELECT dept_id,bin_id,product_code,sum(quantity),sum(value) FROM ('
				  ELSE '' END)+'	
			SELECT dept_id,bin_id,product_code,SUM(CW.QUANTITY) quantity,SUM(CW.quantity*rate) value
			FROM #CBSWIP CW GROUP BY dept_id,bin_id,product_code
			HAVING SUM(CW.QUANTITY)<>0'+(CASE WHEN @bFirstDt=0 THEN '
			UNION 
			SELECT dept_id,bin_id,product_code,QUANTITY,value
			FROM '+@tPrevDtTable+') a GROUP BY dept_id,bin_id,product_code HAVING SUM(quantity)<>0'
			ELSE '' END)
		PRINT @cCmd
		EXEC SP_EXECUTESQL @cCmd
	END
	ELSE
	SELECT CW.XN_TYPE,CW.PRODUCT_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME
		  ,SUM(CW.QUANTITY) AS CLOSING_STOCK,CONVERT(NUMERIC(18,2),CW.RATE) AS UNIT_COST
		  ,CONVERT(NUMERIC(18,2),SUM(CW.quantity*cw.rate)) AS CLOSING_STOCK_VALUE,CW.WIP_UID
	FROM #CBSWIP CW
	JOIN SKU S(NOLOCK) ON S.PRODUCT_CODE=CW.PRODUCT_CODE
	JOIN ARTICLE ART(NOLOCK) ON S.ARTICLE_CODE=ART.ARTICLE_CODE
	GROUP BY CW.XN_TYPE,CW.PRODUCT_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME
		     ,CW.RATE,CW.WIP_UID
	ORDER BY PRODUCT_CODE,XN_TYPE		     
END	
--END OF PROCEDURE - SP_STOCKREPORT_WIP