CREATE PROCEDURE SP_PRD_PENDING_CUTTING_DETAILS
(
 @NQUERYID INT=0
)
AS
BEGIN
	IF OBJECT_ID('TEMPDB..#TMPORDER','U') IS NOT NULL
	   DROP TABLE #TMPORDER

	SELECT   MST.MEMO_ID AS ORDER_ID
			,MST.MEMO_NO AS ORDER_NO
			,MST.MEMO_DT  AS ORDER_DT
			,MST.ARTICLE_SET_CODE
			,C.ARTICLE_NO AS BM_ARTICLE_NO
			,C.ARTICLE_NAME AS BM_ARTICLE_NAME
			,C.ARTICLE_CODE  AS BM_ARTICLE_CODE
			,AR.ARTICLE_CODE AS COMP_CODE
			,AR.ARTICLE_NO AS ARTICLE_NO
			,AR.ARTICLE_NAME AS FG_ARTICLE_NAME
			,DET1.QUANTITY AS WO_QTY
			,PARA1.PARA1_CODE
			,PARA1.PARA1_NAME
			,PARA2.PARA2_CODE
			,PARA2.PARA2_NAME
			,UOM.UOM_NAME
			,DET.QUANTITY
		   ,AVG_QTY AS AVG_QTY
		   ,CONVERT(NUMERIC(12,2),AVG_QTY * DET.QUANTITY) AS REQUIRED_QTY 
	INTO #TMPORDER  
	FROM PRD_WO_ART_BOM A (NOLOCK)      
	JOIN PRD_WO_DET B (NOLOCK) ON A.REF_ROW_ID = B.ROW_ID
	JOIN PRD_WO_MST MST (NOLOCK) ON B.MEMO_ID=MST.MEMO_ID
	JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE =B.ARTICLE_CODE     
	JOIN PARA1 P1 (NOLOCK) ON A.PARA1_CODE=P1.PARA1_CODE
	JOIN PARA2 P2 (NOLOCK) ON A.PARA2_CODE=P2.PARA2_CODE
	JOIN
	(
	 SELECT PARA1_CODE,PARA2_CODE,REF_ROW_ID,SUM(QUANTITY) AS QUANTITY 
	 FROM PRD_WO_SUB_DET C
	 GROUP BY REF_ROW_ID,PARA1_CODE,PARA2_CODE
	) DET ON B.ROW_ID=DET.REF_ROW_ID
	JOIN ARTICLE C (NOLOCK) ON A.BOM_ARTICLE_CODE = C.ARTICLE_CODE 
	JOIN UOM ON UOM.UOM_CODE=C.UOM_CODE
	JOIN
	(
	 SELECT  REF_ROW_ID,SUM(QUANTITY) AS QUANTITY 
	 FROM PRD_WO_SUB_DET C
	 GROUP BY REF_ROW_ID
	) DET1 ON B.ROW_ID=DET1.REF_ROW_ID
	JOIN PARA1  (NOLOCK) ON DET.PARA1_CODE=PARA1.PARA1_CODE
	JOIN PARA2  (NOLOCK) ON DET.PARA2_CODE=PARA2.PARA2_CODE
	--WHERE B.MEMO_ID='HO0111700000HO00000543'
	

   SELECT * FROM #TMPPENDINGFG

	 IF OBJECT_ID ('TEMPDB..#TMPPENDINGFG','U') IS NOT NULL
		DROP TABLE #TMPPENDINGFG        
	         
	 SELECT A.* ,ISSUE_QTY AS QTY_PCS,
	 ISNULL(CONVERT(NUMERIC(12,2),A.AVG_QTY*ISSUE_QTY),0) AS REQUIRED_FOR_CUTTING,
	 ISNULL(B.QUANTITY,0) AS CUTTING_QTY,
	 ISNULL(CONVERT(NUMERIC(12,2),A.AVG_QTY*ISSUE_QTY),0)-ISNULL(B.QUANTITY,0) AS PENDING_QTY
	 INTO #TMPPENDINGFG
	 FROM #TMPORDER A
	 JOIN
	 (
	   SELECT A.ARTICLE_CODE, REF_WO_ID,A.PARA1_CODE,A.PARA2_CODE,ISSUE_QTY AS ISSUE_QTY
	   FROM PRD_STK_TRANSFER_MATERIAL_DET A
	   JOIN 
	   (
	    SELECT MEMO_ID, REF_ROW_ID,REF_WO_ID FROM PRD_STK_TRANSFER_DET 
	    GROUP BY  MEMO_ID, REF_ROW_ID,REF_WO_ID
	   ) B ON A.MEMO_ID=B.MEMO_ID AND A.ROW_ID =B.REF_ROW_ID 
	  ) C ON A.ORDER_ID=C.REF_WO_ID 
	        AND A.ARTICLE_SET_CODE=C.ARTICLE_CODE
	  AND A.PARA1_CODE=C.PARA1_CODE AND A.PARA2_CODE=C.PARA2_CODE
	 LEFT JOIN
	 (
	  SELECT AR.ARTICLE_CODE,  REF_WO_ID,UOM_NAME,A.MEMO_ID,B.COMPONENT_CODE,B.COM_PARA1_CODE,B.COM_PARA2_CODE,
		  SUM(QUANTITY) AS QUANTITY
	  FROM PRD_STK_TRANSFER_MST A
	  JOIN PRD_STK_TRANSFER_DET B ON A.MEMO_ID=B.MEMO_ID
	  JOIN PRD_SKU S ON B.PRODUCT_UID = S.PRODUCT_UID           
	  JOIN ARTICLE AR ON S.ARTICLE_CODE = AR.ARTICLE_CODE  
	  JOIN UOM ON UOM.UOM_CODE=AR.UOM_CODE
	  WHERE 
	  --B.REF_WO_ID='HO0111700000HO00000538' AND
	  A.TARGET_DEPARTMENT_ID='DEF0001'
	  AND A.CANCELLED=0
	  GROUP BY AR.ARTICLE_CODE, UOM_NAME,REF_WO_ID,A.MEMO_ID,B.COMPONENT_CODE,B.COM_PARA1_CODE,B.COM_PARA2_CODE
	 
	 ) B  ON B.REF_WO_ID=A.ORDER_ID AND 
	         B.ARTICLE_CODE=BM_ARTICLE_CODE AND
			B.COMPONENT_CODE=A.COMP_CODE
			AND B.COM_PARA1_CODE=A.PARA1_CODE
			AND B.COM_PARA2_CODE=A.PARA2_CODE
			AND A.UOM_NAME=B.UOM_NAME
	-- WHERE ISNULL(CONVERT(NUMERIC(12,2),A.AVG_QTY*ISSUE_QTY),0)-ISNULL(B.QUANTITY,0)>0
	ORDER BY ARTICLE_NO
	 
	   
IF @NQUERYID=1
GOTO LBLFEBRICPENDING

LBLFEBRICPENDING:
       
       
   
       SELECT A.ARTICLE_SET_CODE,B.ARTICLE_NO ,B.ARTICLE_NAME  
       FROM #TMPPENDINGFG A
       JOIN ARTICLE B ON A.ARTICLE_SET_CODE=B.ARTICLE_CODE
       GROUP BY A.ARTICLE_SET_CODE,B.ARTICLE_NO ,B.ARTICLE_NAME

GOTO END_PROC

END_PROC:
END
