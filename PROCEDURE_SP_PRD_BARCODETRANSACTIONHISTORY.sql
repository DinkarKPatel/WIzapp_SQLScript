CREATE PROCEDURE SP_PRD_BARCODETRANSACTIONHISTORY              
(              
 @CPRODUCTCODE VARCHAR(100),      
 @CDEPARTMENTID VARCHAR(10)='',      
 @FROMDATE DATETIME = '',      
 @TODATE DATETIME = '',      
 @CLOGIN_USER VARCHAR(10)      
)            
      
AS              
BEGIN        
 SET NOCOUNT ON            
 DECLARE @CCURLOCID VARCHAR(2), @CHOLOCID VARCHAR(2),       
   @CCMD NVARCHAR(MAX), @CFILTER VARCHAR(MAX), @CWSLFILTER VARCHAR(MAX)         
         
 SELECT TOP 1 @CCURLOCID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'LOCATION_ID'              
 SELECT TOP 1 @CHOLOCID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'              
       
 DECLARE @OUTPUTC TABLE ( DEPT_ID VARCHAR(2), DEPARTMENT VARCHAR(100), XN_TYPE VARCHAR(30), XN_DT DATETIME,               
        XN_NO VARCHAR(40), PRODUCT_CODE VARCHAR(50), ARTICLE_NO VARCHAR(500),       
        ARTICLE_NAME VARCHAR(500), XN_PARTY_NAME VARCHAR(500), XN_IN_QTY NUMERIC(10,3),      
        XN_OUT_QTY NUMERIC(10,3), XN_EMP_NAME VARCHAR(500))              
      
 --PRD-OPS      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND B.XN_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 PRINT 'STEP 0'      
 SET @CCMD =N' SELECT B.DEPT_ID, D.DEPARTMENT_NAME AS DEPARTMENT,      
     ''OPS-PRD'' AS XN_TYPE,         
     B.XN_DT AS XN_DT,        
     ''PRD-OPS'' AS XN_NO,       
     SK.PRODUCT_CODE,      
     AR.ARTICLE_NO,      
     AR.ARTICLE_NAME,      
     LM.AC_NAME,      
     B.QUANTITY_OB AS XN_IN_QTY,       
     0 AS  XN_OUT_QTY,      
     '''' AS EMP_NAME      
    FROM PRD_OPS01106 B (NOLOCK)      
    JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID      
    JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=B.PRODUCT_UID      
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE       
    JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =SK.AC_CODE          
    WHERE B.PRODUCT_UID<>'''' AND AR.STOCK_NA=0         
    AND SK.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR D.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
               
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD              
      
      
 PRINT 'STEP 1' ---PURCHASE INVOICE      
       
 IF ISNULL(@FROMDATE,'')<>''      
 SET @CFILTER=' AND B.RECEIPT_DT BETWEEN '''+CONVERT(VARCHAR(11),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(11),@TODATE,120)+''' '      
             
SET @CCMD =N'SELECT LEFT (A.MRR_ID,2) AS DEPT_ID, D.DEPARTMENT_NAME AS DEPARTMENT,      
           ''PUR'' AS XN_TYPE,         
           B.RECEIPT_DT AS XN_DT,        
           B.MRR_NO AS XN_NO,       
           A.PRODUCT_CODE,      
           AR.ARTICLE_NO,      
           AR.ARTICLE_NAME,      
           LM.AC_NAME,      
           A.QUANTITY AS XN_IN_QTY,       
           0 AS  XN_OUT_QTY,      
           '''' AS EMP_NAME                        
  FROM PRD_PID01106 A (NOLOCK)                
  JOIN PRD_PIM01106 B (NOLOCK) ON A.MRR_ID = B.MRR_ID                
  JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID              
  JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID            
  JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE       
  JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =B.AC_CODE           
  WHERE  B.CANCELLED = 0 AND A.PRODUCT_UID<>'''' AND AR.STOCK_NA=0         
  AND A.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
 -- AND B.USER_CODE='''+@CLOGIN_USER+'''      
         AND ('''+@CDEPARTMENTID+'''='''' OR D.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
PRINT @CCMD      
INSERT @OUTPUTC        
EXEC SP_EXECUTESQL @CCMD       
       
PRINT 'STEP 2' ---TRANSFER TO MAIN      
      
      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND B.MEMO_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
       
 SET @CCMD =N' SELECT LEFT (A.MEMO_ID,2) AS DEPT_ID, D.DEPARTMENT_NAME AS DEPARTMENT,      
     ''CON-TTM'' AS XN_TYPE,         
     B.MEMO_DT AS XN_DT,        
     B.MEMO_NO AS XN_NO,       
     SK.PRODUCT_CODE,      
     AR.ARTICLE_NO,      
     AR.ARTICLE_NAME,      
     LM.AC_NAME,      
     0 AS XN_IN_QTY,       
     A.QUANTITY AS  XN_OUT_QTY,      
     '''' AS EMP_NAME      
    FROM PRD_TRANSFER_MAIN_SUB_DET A (NOLOCK)                
    JOIN PRD_TRANSFER_MAIN_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID      
    JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.SOURCE_DEPARTMENT_ID              
    JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID            
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE       
    JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =SK.AC_CODE          
    WHERE B.CANCELLED = 0 AND A.PRODUCT_UID<>'''' AND AR.STOCK_NA=0         
    AND SK.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    --AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR D.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD              
      
 PRINT 'STEP 2' ---DEBIT NOTE      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND B.RM_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD =N'SELECT LEFT (A.RM_ID,2) AS DEPT_ID, D.DEPARTMENT_NAME AS DEPARTMENT,      
       ''PRT'' AS XN_TYPE,         
       B.RM_DT AS XN_DT,        
       B.RM_NO AS XN_NO,       
       A.PRODUCT_CODE,      
       AR.ARTICLE_NO,      
       AR.ARTICLE_NAME,      
       LM.AC_NAME,      
       0 AS XN_IN_QTY,       
       A.QUANTITY AS  XN_OUT_QTY,      
       '''' AS EMP_NAME                        
    FROM PRD_RMD01106 A (NOLOCK)              
    JOIN PRD_RMM01106 B (NOLOCK) ON A.RM_ID = B.RM_ID              
    JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID            
    JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID            
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
    JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=B.AC_CODE          
    WHERE B.CANCELLED = 0  AND A.PRODUCT_UID<>'''' AND AR.STOCK_NA=0        
    AND A.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
  --  AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR D.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
          
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD        
      
 PRINT 'STEP 3' ---WSL INVOICE      
 IF ISNULL(@FROMDATE,'')<>''      
 BEGIN      
  SET @CFILTER=' AND B.PS_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
  SET @CWSLFILTER=' AND B.INV_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
 END      
      
 SET @CCMD=N'SELECT LEFT(B.PS_ID,2) AS DEPT_ID,      
     D.DEPARTMENT_NAME AS DEPARTMENT,      
     ''WSL'' AS XN_TYPE,      
     B.PS_DT AS XN_DT,      
     B.PS_NO AS XN_NO,      
     SK.PRODUCT_CODE AS PRODUCT_CODE,      
     AR.ARTICLE_NO,             
     AR.ARTICLE_NAME,      
     LM.AC_NAME,      
     0 AS XN_IN_QTY,       
     A.QUANTITY AS  XN_OUT_QTY,      
     '''' AS EMP_NAME       
    FROM PRD_PS_DET A (NOLOCK)              
    JOIN PRD_PS_MST B (NOLOCK) ON A.PS_ID = B.PS_ID              
    JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID            
    JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID            
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE            
    JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=B.AC_CODE      
    WHERE B.CANCELLED = 0  AND AR.STOCK_NA=0        
    AND SK.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
   -- AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR D.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER +              
    'UNION ALL        
    SELECT LEFT(B.INV_ID,2) AS DEPT_ID,      
     D.DEPARTMENT_NAME AS DEPARTMENT,           ''WSL'' AS XN_TYPE,      
     B.INV_DT AS XN_DT,      
     B.INV_NO AS XN_NO,      
     SK.PRODUCT_CODE AS PRODUCT_CODE,      
     AR.ARTICLE_NO,             
     AR.ARTICLE_NAME,      
     LM.AC_NAME,      
     0 AS XN_IN_QTY,       
     A.QUANTITY AS  XN_OUT_QTY,      
     '''' AS EMP_NAME      
    FROM PRD_IND01106 A (NOLOCK)              
    JOIN PRD_INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID              
    JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID            
    JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID            
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE       
    JOIN LM01106 LM ON LM.AC_CODE=B.AC_CODE            
    WHERE B.CANCELLED = 0 AND B.ENTRY_MODE=0 AND AR.STOCK_NA=0         
    AND SK.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
   -- AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR D.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CWSLFILTER       
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
 PRINT 'STEP 4' ---WSR CREDIT NOTE       
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND B.CN_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD =N'SELECT LEFT (A.CN_ID,2) AS DEPT_ID, D.DEPARTMENT_NAME AS DEPARTMENT,      
     ''WSR'' AS XN_TYPE,         
     B.CN_DT AS XN_DT,        
     B.CN_NO AS XN_NO,       
     SK.PRODUCT_CODE,      
     AR.ARTICLE_NO,      
     AR.ARTICLE_NAME,      
     LM.AC_NAME,      
     A.QUANTITY  AS XN_IN_QTY,       
     0 AS  XN_OUT_QTY,      
     E.EMP_NAME AS EMP_NAME                        
    FROM PRD_CND01106 A (NOLOCK)              
    JOIN PRD_CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID              
    JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID            
    JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID            
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE       
    JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE=A.EMP_CODE        
    JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=B.AC_CODE          
    WHERE B.CANCELLED = 0  AND AR.STOCK_NA=0      
    AND SK.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    --AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR D.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD       
      
 PRINT 'STEP 5' ---STK TRANSFER      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND B.MEMO_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
       
 SET @CCMD=N'SELECT DISTINCT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''STK-OUT'' AS XN_TYPE,              
     B.MEMO_DT AS XN_DT,                      
     B.MEMO_NO  AS XN_NO,              
     A.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     L.DEPT_NAME AS XN_PARTY_NAME,        
     0 AS XN_IN_QTY,             
     A.QUANTITY AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_STK_TRANSFER_DET A (NOLOCK)              
    JOIN PRD_STK_TRANSFER_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.SOURCE_DEPARTMENT_ID           
    JOIN LOCATION L (NOLOCK) ON LEFT(B.MEMO_ID,2)  = L.DEPT_ID          
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.NEW_PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND A.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
      
  SET @CCMD=N'SELECT DISTINCT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''STK-OUT'' AS XN_TYPE,              
     B.MEMO_DT AS XN_DT,                      
     B.MEMO_NO  AS XN_NO,              
     A.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     L.DEPT_NAME AS XN_PARTY_NAME,        
     0 AS XN_IN_QTY,             
     A.QUANTITY AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_STK_TRANSFER_DET_PENDING A (NOLOCK)              
    JOIN PRD_STK_TRANSFER_MST_PENDING B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.SOURCE_DEPARTMENT_ID           
    JOIN LOCATION L (NOLOCK) ON LEFT(B.MEMO_ID,2)  = L.DEPT_ID          
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.NEW_PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND A.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
     
 SET @CCMD=N' SELECT DISTINCT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''STK-IN'' AS XN_TYPE,              
     B.MEMO_DT AS XN_DT,                      
     B.MEMO_NO  AS XN_NO,              
     A.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     L.DEPT_NAME AS XN_PARTY_NAME,        
     A.QUANTITY AS XN_IN_QTY,             
     0 AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_STK_TRANSFER_DET A (NOLOCK)              
    JOIN PRD_STK_TRANSFER_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.TARGET_DEPARTMENT_ID           
    JOIN LOCATION L (NOLOCK) ON LEFT(B.MEMO_ID,2)  = L.DEPT_ID          
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.NEW_PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND A.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
     
     
     
 SET @CCMD=N' SELECT DISTINCT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''STK-IN'' AS XN_TYPE,              
     B.MEMO_DT AS XN_DT,                      
     B.MEMO_NO  AS XN_NO,              
     A.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     L.DEPT_NAME AS XN_PARTY_NAME,        
     A.QUANTITY AS XN_IN_QTY,             
     0 AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_STK_TRANSFER_DET_PENDING A (NOLOCK)              
    JOIN PRD_STK_TRANSFER_MST_PENDING B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.TARGET_DEPARTMENT_ID           
    JOIN LOCATION L (NOLOCK) ON LEFT(B.MEMO_ID,2)  = L.DEPT_ID          
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.NEW_PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND A.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD  
 
 --
    SET @CCMD=N'SELECT DISTINCT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''STK-OUT'' AS XN_TYPE,              
     B.MEMO_DT AS XN_DT,                      
     B.MEMO_NO  AS XN_NO,              
     SKU.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     L.DEPT_NAME AS XN_PARTY_NAME,        
     0 AS XN_IN_QTY,             
     A.QUANTITY AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_STK_RECEIVE_DET A (NOLOCK)              
    JOIN PRD_STK_RECEIVE_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.SOURCE_DEPARTMENT_ID           
    JOIN LOCATION L (NOLOCK) ON LEFT(B.MEMO_ID,2)  = L.DEPT_ID          
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD    
 
 
 SET @CCMD=N' SELECT DISTINCT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''STK-IN'' AS XN_TYPE,              
     B.MEMO_DT AS XN_DT,                      
     B.MEMO_NO  AS XN_NO,              
     SKU.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     L.DEPT_NAME AS XN_PARTY_NAME,        
     A.QUANTITY AS XN_IN_QTY,             
     0 AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_STK_RECEIVE_DET A (NOLOCK)              
    JOIN PRD_STK_RECEIVE_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.TARGET_DEPARTMENT_ID          
    JOIN LOCATION L (NOLOCK) ON LEFT(B.MEMO_ID,2)  = L.DEPT_ID          
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD  
 
 
 SET @CCMD=N' SELECT DISTINCT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''AMR'' AS XN_TYPE,              
     B.MEMO_DT AS XN_DT,                      
     B.MEMO_NO  AS XN_NO,              
     SKU.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     L.DEPT_NAME AS XN_PARTY_NAME,        
     A.QUANTITY AS XN_IN_QTY,             
     0 AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_AGENCY_RM_RETURN_DET A (NOLOCK)              
    JOIN PRD_AGENCY_RM_RETURN_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.DEPARTMENT_ID          
    JOIN LOCATION L (NOLOCK) ON LEFT(B.MEMO_ID,2)  = L.DEPT_ID          
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD    
 
 --
     
      
 PRINT 'STEP 6' ---STK TRANSFER OUT      
 SET @CCMD=N'SELECT DISTINCT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''ISS-MAT-OUT'' AS XN_TYPE,              
     B.MEMO_DT AS XN_DT,                      
     B.MEMO_NO  AS XN_NO,              
     SKU.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     '''' AS XN_PARTY_NAME,        
     0 AS XN_IN_QTY,             
     A.QUANTITY AS XN_OUT_QTY,              
     '''' AS EMP_NAME       
    FROM PRD_ISSUE_MATERIAL_DET A (NOLOCK)              
    JOIN PRD_ISSUE_MATERIAL_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.SOURCE_DEPARTMENT_ID           
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
  --  AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
 PRINT 'STEP 7' ---ISSUE MATERIAL IN HOUSING      
 SET @CCMD=N' SELECT DISTINCT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''ISS-MAT-IN'' AS XN_TYPE,              
     B.MEMO_DT AS XN_DT,                      
     B.MEMO_NO  AS XN_NO,              
     SKU.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     '''' AS XN_PARTY_NAME,        
     A.QUANTITY AS XN_IN_QTY,             
     0 AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_ISSUE_MATERIAL_DET A (NOLOCK)              
    JOIN PRD_ISSUE_MATERIAL_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.TARGET_DEPARTMENT_ID           
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
   -- AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
 PRINT 'STEP 6' ---JOB WORK ISSUE WITHOUT ORDER      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND B.ISSUE_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD=N' SELECT DISTINCT LEFT(B.ISSUE_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''JWI'' AS XN_TYPE,              
     B.ISSUE_DT AS XN_DT,                      
     B.ISSUE_NO  AS XN_NO,              
     SKU.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     '''' AS XN_PARTY_NAME,        
     0 AS XN_IN_QTY,             
     A.QUANTITY AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_JOBWORK_ISSUE_DET A (NOLOCK)              
    JOIN PRD_JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.DEPARTMENT_ID           
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
   -- AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
 PRINT 'STEP 6' ---JOB WORK ISSUE WITHOUT ORDER      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND D.ISSUE_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD=N' SELECT DISTINCT LEFT(A.RECEIPT_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''JWR'' AS XN_TYPE,              
     B.RECEIPT_DT AS XN_DT,                      
     B.RECEIPT_NO  AS XN_NO,              
     SKU.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     '''' AS XN_PARTY_NAME,        
     A.QUANTITY AS XN_IN_QTY,             
     0 AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_JOBWORK_RECEIPT_DET A (NOLOCK)              
    JOIN PRD_JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID      
    JOIN PRD_JOBWORK_ISSUE_DET C (NOLOCK) ON C.ROW_ID=A.REF_ROW_ID              
    JOIN PRD_JOBWORK_ISSUE_MST D (NOLOCK) ON C.ISSUE_ID = D.ISSUE_ID          
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.DEPARTMENT_ID           
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=C.PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
   -- AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
      
 PRINT 'STEP 6' ---JOB WORK RECEIPT      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND B.RECEIPT_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD=N' SELECT DISTINCT LEFT(A.RECEIPT_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''JWR-CON'' AS XN_TYPE,              
     B.RECEIPT_DT AS XN_DT,                      
     B.RECEIPT_NO  AS XN_NO,              
     SKU.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     '''' AS XN_PARTY_NAME,        
     0 AS XN_IN_QTY,             
     A.QUANTITY  AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_JOBWORK_RECEIPT_DET A (NOLOCK)              
    JOIN PRD_JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID      
    JOIN PRD_JOBWORK_ISSUE_DET C (NOLOCK) ON C.ROW_ID=A.REF_ROW_ID              
    JOIN PRD_JOBWORK_ISSUE_MST D (NOLOCK) ON C.ISSUE_ID = D.ISSUE_ID          
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.DEPARTMENT_ID           
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=C.PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
   -- AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
      
 PRINT 'STEP 6' ---JOB WORK RECEIPT      
 SET @CCMD=N' SELECT DISTINCT LEFT(A.RECEIPT_ID,2) AS DEPT_ID,      
     DEPT.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''JWR-FIN'' AS XN_TYPE,              
     B.RECEIPT_DT AS XN_DT,                      
     B.RECEIPT_NO  AS XN_NO,              
     SKU.PRODUCT_CODE,             
     ARTICLE.ARTICLE_NO,      
     ARTICLE.ARTICLE_NAME,             
     '''' AS XN_PARTY_NAME,        
     A.QUANTITY AS XN_IN_QTY,             
     0 AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_JOBWORK_RECEIPT_DET A (NOLOCK)              
    JOIN PRD_JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID      
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.DEPARTMENT_ID           
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.PRODUCT_UID           
    JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE           
    WHERE B.CANCELLED = 0 AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
   -- AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
 PRINT 'STEP 8' ---REC MATERIAL       
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND D.MEMO_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD=N' SELECT DISTINCT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     DP.DEPARTMENT_NAME AS DEPARTMENT_NAME,      
     ''REC-MAT-IN'' AS XN_TYPE,              
     D.MEMO_DT AS XN_DT,                      
     D.MEMO_NO  AS XN_NO,              
     SKU.PRODUCT_CODE,             
     AR.ARTICLE_NO,      
     AR.ARTICLE_NAME,             
     LM.AC_NAME AS XN_PARTY_NAME,        
     C.QUANTITY AS XN_IN_QTY,             
     0 AS XN_OUT_QTY,              
     '''' AS EMP_NAME         
    FROM PRD_MATERIAL_RECEIPT_DET  C (NOLOCK)              
    JOIN PRD_MATERIAL_RECEIPT_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                        
    JOIN PRD_ISSUE_MATERIAL_DET B (NOLOCK) ON B.ROW_ID=C.REF_ROW_ID                       
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=B.PRODUCT_UID            
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SKU.ARTICLE_CODE            
    JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=D.DEPARTMENT_ID         
    JOIN LM01106 LM ON LM.AC_CODE=D.AC_CODE         
    WHERE D.CANCELLED=0 AND AR.STOCK_NA=0  AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
   -- AND D.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DP.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
      
 PRINT 'STEP 9' --AGENCY ISSUE MATERIAL   1    
 SET @CCMD=N'SELECT LEFT (D.MEMO_ID,2) AS DEPT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT,      
      ''AMI'' AS XN_TYPE ,      
      D.MEMO_DT AS XN_DT,      
      D.MEMO_NO AS XN_NO,      
      SKU.PRODUCT_CODE AS PRODUCT_CODE,      
      AR.ARTICLE_NO,      
      AR.ARTICLE_NAME,             
      AJ.AGENCY_NAME AS XN_PARTY_NAME,        
      0 AS XN_IN_QTY,             
      C.QUANTITY  AS XN_OUT_QTY,              
      '''' AS EMP_NAME                 
    FROM PRD_AGENCY_ISSUE_MATERIAL_DET  C (NOLOCK)               
    JOIN PRD_AGENCY_ISSUE_MATERIAL_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                        
    JOIN PRD_AGENCY_MST AJ (NOLOCK) ON AJ.AGENCY_CODE=D.REF_AGENCY_CODE            
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=C.PRODUCT_UID            
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SKU.ARTICLE_CODE        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.DEPARTMENT_ID       
    WHERE       
    D.CANCELLED=0 AND AR.STOCK_NA=0    AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
 --   AND D.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
     
     
     
      
 PRINT 'STEP 9' --AGENCY ISSUE MATERIAL PENDING       
 SET @CCMD=N'SELECT LEFT (D.MEMO_ID,2) AS DEPT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT,      
      ''AMI'' AS XN_TYPE ,      
      D.MEMO_DT AS XN_DT,      
      D.MEMO_NO AS XN_NO,      
      SKU.PRODUCT_CODE AS PRODUCT_CODE,      
      AR.ARTICLE_NO,      
      AR.ARTICLE_NAME,             
      AJ.AGENCY_NAME AS XN_PARTY_NAME,        
      0 AS XN_IN_QTY,             
      C.QUANTITY  AS XN_OUT_QTY,              
      '''' AS EMP_NAME                 
    FROM PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING  C (NOLOCK)               
    JOIN PRD_AGENCY_ISSUE_MATERIAL_MST_PENDING D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                        
    JOIN PRD_AGENCY_MST AJ (NOLOCK) ON AJ.AGENCY_CODE=D.REF_AGENCY_CODE            
    JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=C.PRODUCT_UID            
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SKU.ARTICLE_CODE        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.DEPARTMENT_ID       
    WHERE       
    D.CANCELLED=0 AND AR.STOCK_NA=0    AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
   -- AND D.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
       
 PRINT 'STEP 10' --AGENCY RECEIVE MATERIAL       
 SET @CCMD=N' SELECT LEFT (D.MEMO_ID,2) AS DEPT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT,      
     ''AMR'' AS XN_TYPE ,      
     D.MEMO_DT AS XN_DT,      
     D.MEMO_NO AS XN_NO,      
     SKU.PRODUCT_CODE AS PRODUCT_CODE,      
     AR.ARTICLE_NO,      
     AR.ARTICLE_NAME,             
     AJ.AGENCY_NAME AS XN_PARTY_NAME,               
     C.QUANTITY AS XN_IN_QTY,         
     0 AS XN_OUT_QTY,              
     '''' AS EMP_NAME      
    FROM PRD_AGENCY_MATERIAL_RECEIPT_DET C               
    JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST D ON D.MEMO_ID=C.MEMO_ID                        
    JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B ON B.ROW_ID=C.REF_ROW_ID                      
    JOIN ARTICLE ART ON ART.ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE                
    JOIN PRD_AGENCY_MST AJ ON AJ.AGENCY_CODE=D.AGENCY_CODE            
    JOIN PRD_SKU SKU ON SKU.PRODUCT_UID=C.XN_PRODUCT_UID            
    JOIN ARTICLE AR ON AR.ARTICLE_CODE=SKU.ARTICLE_CODE        
    JOIN PRD_DEPARTMENT_MST DEP ON DEP.DEPARTMENT_ID=D.DEPARTMENT_ID         
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.DEPARTMENT_ID       
    WHERE D.CANCELLED=0 AND AR.STOCK_NA=0      AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
   -- AND D.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
        
     
 PRINT 'STEP 10' --AGENCY RECEIVE MATERIAL FROM PENDING ISSUE       
 SET @CCMD=N' SELECT LEFT (D.MEMO_ID,2) AS DEPT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT,      
     ''AMR'' AS XN_TYPE ,      
     D.MEMO_DT AS XN_DT,      
     D.MEMO_NO AS XN_NO,      
     SKU.PRODUCT_CODE AS PRODUCT_CODE,      
     AR.ARTICLE_NO,      
     AR.ARTICLE_NAME,             
     AJ.AGENCY_NAME AS XN_PARTY_NAME,               
     C.QUANTITY AS XN_IN_QTY,         
     0 AS XN_OUT_QTY,              
     '''' AS EMP_NAME      
    FROM PRD_AGENCY_MATERIAL_RECEIPT_DET C               
    JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST D ON D.MEMO_ID=C.MEMO_ID                        
    JOIN PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING B ON B.ROW_ID=C.REF_ROW_ID                      
    JOIN ARTICLE ART ON ART.ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE                
    JOIN PRD_AGENCY_MST AJ ON AJ.AGENCY_CODE=D.AGENCY_CODE            
    JOIN PRD_SKU SKU ON SKU.PRODUCT_UID=C.XN_PRODUCT_UID            
    JOIN ARTICLE AR ON AR.ARTICLE_CODE=SKU.ARTICLE_CODE        
    JOIN PRD_DEPARTMENT_MST DEP ON DEP.DEPARTMENT_ID=D.DEPARTMENT_ID         
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.DEPARTMENT_ID       
    WHERE D.CANCELLED=0 AND AR.STOCK_NA=0      AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
  --  AND D.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD       
      
 -----CODE CONVERSION      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND B.MEMO_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD=N'SELECT LEFT (A.MEMO_ID,2) AS DEPT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT,      
     ''CODE-CON'' AS XN_TYPE ,      
     B.MEMO_DT AS XN_DT,      
     B.MEMO_NO AS XN_NO,      
     SKU.PRODUCT_CODE AS PRODUCT_CODE,      
     AR.ARTICLE_NO,      
     AR.ARTICLE_NAME,             
     '''' AS XN_PARTY_NAME,               
     0 AS XN_IN_QTY,         
     A.QUANTITY AS XN_OUT_QTY,              
     '''' AS EMP_NAME      
    FROM PRD_DEPARTMENT_RMCONSUMPTION_DET A               
    JOIN PRD_DEPARTMENT_OUTPUT_MST B ON A.MEMO_ID=B.MEMO_ID                                   
    JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE                
    -- JOIN PRD_AGENCY_MST AJ ON AJ.AGENCY_CODE=D.AGENCY_CODE            
    JOIN PRD_SKU SKU ON SKU.PRODUCT_UID=A.PRODUCT_UID            
    JOIN ARTICLE AR ON AR.ARTICLE_CODE=SKU.ARTICLE_CODE        
    JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.DEPARTMENT_ID       
    WHERE  AR.STOCK_NA=0      AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    --AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
------      
      
      
--PRINT 'STEP 11' -- ISSUE MATERIAL       
      
--SET @CCMD=N'SELECT LEFT (D.MEMO_ID,2) AS DEPT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT,      
--          ''JWI'' AS XN_TYPE ,      
--          D.MEMO_DT AS XN_DT,      
--          D.MEMO_NO AS XN_NO,      
--          SKU.PRODUCT_CODE AS PRODUCT_CODE,      
--          AR.ARTICLE_NO,         
--          AR.ARTICLE_NAME,          
--          AJ.AGENCY_NAME AS XN_PARTY_NAME,        
--          0 AS XN_IN_QTY,                       
--          C.QUANTITY AS XN_OUT_QTY,              
--         '''' AS XN_EMP_NAME       
--         FROM PRD_ISSUE_MATERIAL_DET  C (NOLOCK)               
--   JOIN PRD_ISSUE_MATERIAL_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                        
--   JOIN PRD_AGENCY_MST AJ (NOLOCK) ON AJ.AGENCY_CODE=D.REF_AGENCY_CODE            
--   JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=C.PRODUCT_UID            
--   JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SKU.ARTICLE_CODE         
--   JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.SOURCE_DEPARTMENT_ID       
--  WHERE       
--  D.CANCELLED=0 AND AR.STOCK_NA=0    AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
--  AND D.USER_CODE='''+@CLOGIN_USER+'''      
--        AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
--PRINT @CCMD      
--INSERT @OUTPUTC        
--EXEC SP_EXECUTESQL @CCMD      
      
--PRINT 'STEP 12' -- ISSUE MATERIAL       
      
--SET @CCMD=N'SELECT LEFT (D.MEMO_ID,2) AS DEPT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT,      
--          ''JWI'' AS XN_TYPE ,      
--          D.MEMO_DT AS XN_DT,      
--          D.MEMO_NO AS XN_NO,      
--          SKU.PRODUCT_CODE AS PRODUCT_CODE,      
--          AR.ARTICLE_NO,         
--          AR.ARTICLE_NAME,          
--          AJ.AGENCY_NAME AS XN_PARTY_NAME,        
--          C.QUANTITY AS XN_IN_QTY,                       
--          0 AS XN_OUT_QTY,              
--         '''' AS XN_EMP_NAME       
--         FROM PRD_ISSUE_MATERIAL_DET  C (NOLOCK)               
--   JOIN PRD_ISSUE_MATERIAL_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                        
--   JOIN PRD_AGENCY_MST AJ (NOLOCK) ON AJ.AGENCY_CODE=D.REF_AGENCY_CODE            
--   JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=C.PRODUCT_UID            
--   JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SKU.ARTICLE_CODE         
--   JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.TARGET_DEPARTMENT_ID       
--  WHERE       
--  D.CANCELLED=0 AND AR.STOCK_NA=0    AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
--  AND D.USER_CODE='''+@CLOGIN_USER+'''      
--        AND ('''+@CDEPARTMENTID+'''='''' OR DEPT.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
--PRINT @CCMD      
--INSERT @OUTPUTC        
--EXEC SP_EXECUTESQL @CCMD      
      
      
 PRINT 'STEP 13' --JOB WORK RECEIVE       
      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND D.RECEIPT_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD=N' SELECT LEFT (D.RECEIPT_ID,2) AS DEPT_ID,DEP.DEPARTMENT_NAME AS DEPARTMENT,      
     ''REC'' AS XN_TYPE ,      
     D.RECEIPT_DT AS XN_DT,      
     D.RECEIPT_ID AS XN_ID,      
     D.RECEIPT_NO AS XN_NO,      
     SK.PRODUCT_CODE AS PRODUCT_CODE,      
     AR.ARTICLE_NO,             
     LM.AC_NAME AS XN_PARTY_NAME,               
     C.QUANTITY AS XN_IN_QTY,                       
     0 AS XN_OUT_QTY,         
     ''PRODUCTION'' AS XN_EMP_NAME       
    FROM PRD_JOBWORK_RECEIPT_DET C               
    JOIN PRD_JOBWORK_RECEIPT_MST D ON D.RECEIPT_ID=C.RECEIPT_ID                        
    JOIN PRD_ISSUE_MATERIAL_DET B ON B.ROW_ID=C.REF_ROW_ID                               
    JOIN PRD_SKU SK ON SK.PRODUCT_UID=C.PRODUCT_UID      
    JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
    JOIN PRD_DEPARTMENT_MST DEP ON DEP.DEPARTMENT_ID=D.DEPARTMENT_ID         
    JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=D.AC_CODE      
    WHERE D.CANCELLED=0 AND AR.STOCK_NA=0     AND SK.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    --AND D.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR DEP.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
 PRINT 'STEP 14' --CANCELLETION  UN CANCELLETION      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND B.CNC_MEMO_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD=N' SELECT LEFT(B.CNC_MEMO_ID,2) AS DEPT_ID,      
     D.DEPARTMENT_NAME AS DEPARTMENT,      
     (CASE WHEN B.CNC_TYPE=1 THEN ''CNC'' ELSE ''UNC'' END) AS XN_TYPE,      
     B.CNC_MEMO_DT AS XN_DT,      
     B.CNC_MEMO_NO AS XN_NO,      
     SK.PRODUCT_CODE AS PRODUCT_CODE,      
     AR.ARTICLE_NO,       
     AR.ARTICLE_NAME,            
     '''' AS XN_PARTY_NAME,      
     (CASE WHEN B.CNC_TYPE<>1 THEN A.QUANTITY ELSE 0 END) AS XN_IN_QTY,      
     (CASE WHEN B.CNC_TYPE=1 THEN A.QUANTITY ELSE 0 END) AS  XN_OUT_QTY,                        
     ''PRODUCTION'' AS XN_EMP_NAME               
    FROM PRD_ICD01106 A (NOLOCK)              
    JOIN PRD_ICM01106 B (NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID              
    JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID            
    JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID            
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE            
    WHERE B.CANCELLED = 0  AND AR.STOCK_NA=0          
    AND SK.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    --AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR D.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
      
      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND B.MEMO_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD=N'SELECT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     D.DEPARTMENT_NAME AS DEPARTMENT  ,      
     ''APP'' AS XN_TYPE,        
     B.MEMO_DT AS XN_DT,      
     B.MEMO_NO AS XN_NO,      
     SK.PRODUCT_CODE AS PRODUCT_CODE,      
     AR.ARTICLE_NO,       
     AR.ARTICLE_NAME,             
     LM.AC_NAME AS XN_PARTY_NAME,               
     0 AS XN_IN_QTY,                   
     A.QUANTITY AS XN_OUT_QTY,               
     ''PRODUCTION'' AS XN_EMP_NAME       
    FROM PRD_APD01106 A         
    JOIN PRD_APM01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
    JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID            
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE       
    JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID     
    JOIN LM01106 LM ON LM.AC_CODE=B.AC_CODE    
    WHERE B.CANCELLED = 0 AND SK.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    --AND B.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR D.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
   
   
   
  --INSERT @OUTPUTC          
   
      
 PRINT 'STEP 7' --APPROVAL RETURN      
 IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND C.MEMO_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
 SET @CCMD=N'SELECT LEFT(B.MEMO_ID,2) AS DEPT_ID,      
     D.DEPARTMENT_NAME AS DEPARTMENT,      
     ''APR'' AS XN_TYPE,        
     C.MEMO_DT AS XN_DT,      
     C.MEMO_NO AS XN_NO,      
     SK.PRODUCT_CODE AS PRODUCT_CODE,      
     AR.ARTICLE_NO,      
     AR.ARTICLE_NAME,      
     '''' AS XN_PARTY_NAME,       
     A.QUANTITY AS XN_IN_QTY,                   
     0 AS XN_OUT_QTY,                   
     ''PRODUCTION'' AS XN_EMP_NAME              
    FROM PRD_APPROVAL_RETURN_DET A         
    JOIN PRD_APD01106 B (NOLOCK)ON A.APD_ROW_ID = B.ROW_ID        
    JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID         
    JOIN PRD_APPROVAL_RETURN_MST C (NOLOCK) ON C.MEMO_ID = A.MEMO_ID             
    JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE       
    JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=C.DEPARTMENT_ID       
    WHERE C.CANCELLED = 0 AND SK.PRODUCT_CODE='''+@CPRODUCTCODE +'''      
    --AND C.USER_CODE='''+@CLOGIN_USER+'''      
    AND ('''+@CDEPARTMENTID+'''='''' OR D.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER      
      
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD      
  
  IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND C.RECEIPT_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
   
   
   --LEFT(C.MEMO_ID,2) AS DEPT_ID,         
   --''SCF'' AS XN_TYPE,         
   --C.RECEIPT_DT AS XN_DT,         
   --C.MEMO_ID AS XN_ID,         
   --C.MEMO_NO AS XN_NO,        
   --A.PRODUCT_CODE,    
   --E.ARTICLE_NO,    
   --PARA3.PARA3_NAME,           
   --LM.AC_NAME AS XN_PARTY_NAME,         
   --(CASE WHEN E.CODING_SCHEME=3 THEN B2.TOTAL_QTY ELSE B.QUANTITY END) AS XN_QTY,'''' AS XN_EMP_NAME,      
   --1 AS XN_MODE  ,CONVERT(NUMERIC(10,2) ,ISNULL(A.WS_PRICE,0)) AS WS_PRICE ,      
   --A.MRP AS XN_PRICE,CONVERT(NUMERIC(10,2) ,0) AS MP_PERCENTAGE   
   --,B1.BIN_ID,B1.BIN_NAME,'''' AS SOURCE_XN_TYPE 
   
 SET @CCMD=N'SELECT LEFT(C.MEMO_ID,2) AS DEPT_ID,   
     DM.DEPARTMENT_NAME AS DEPARTMENT,          
   ''PRD_SCF'' AS XN_TYPE,           
   C.RECEIPT_DT AS XN_DT,                 
   C.MEMO_NO AS XN_NO,          
   SKU.PRODUCT_CODE,      
   E.ARTICLE_NO,      
   E.ARTICLE_NAME,            
   '''' AS XN_PARTY_NAME,           
   (CASE WHEN E.CODING_SCHEME=3 THEN B2.TOTAL_QTY ELSE B.QUANTITY END)  AS XN_IN_QTY,  
   0 AS XN_OUT_QTY,   
   '''' AS XN_EMP_NAME                          
  FROM PRD_SKU SKU  (NOLOCK)       
 JOIN ARTICLE E (NOLOCK) ON E.ARTICLE_CODE = SKU.ARTICLE_CODE 
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN
 (
	SELECT REFROW_ID AS [ROW_ID],PRODUCT_CODE,COUNT(*) AS [TOTAL_QTY]
	FROM PRD_SNC_BARCODE_DET (NOLOCK)
	GROUP BY REFROW_ID,PRODUCT_CODE
 )B2 ON SKU.PRODUCT_CODE = B2.PRODUCT_CODE
 JOIN PRD_SNC_DET B (NOLOCK) ON B.ROW_ID = B2.ROW_ID     
 JOIN PRD_SNC_MST C (NOLOCK) ON B.MEMO_ID = C.MEMO_ID   
 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE=C.AC_CODE   
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=C.BIN_ID 
 JOIN PRD_DEPARTMENT_MST DM  ON DM.DEPARTMENT_ID=C.DEPARTMENT_ID     
 WHERE C.CANCELLED=0 AND SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''       
 AND ('''+@CDEPARTMENTID+'''='''' OR C.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER     
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD   
   
   
  IF ISNULL(@FROMDATE,'')<>''      
  SET @CFILTER=' AND C.IRM_MEMO_DT BETWEEN '''+CONVERT(VARCHAR(10),@FROMDATE,120)+''' AND '''+CONVERT(VARCHAR(10),@TODATE,120)+''' '      
      
      
 SET @CCMD=N'SELECT LEFT(C.IRM_MEMO_NO,2) AS DEPT_ID,   
     D.DEPARTMENT_NAME AS DEPARTMENT,          
   ''PFI'' AS XN_TYPE,           
   C.IRM_MEMO_DT AS XN_DT,                 
   C.IRM_MEMO_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   ARTICLE.ARTICLE_NAME,            
   '''' AS XN_PARTY_NAME,           
   B.QUANTITY AS XN_IN_QTY,  
   0 AS XN_OUT_QTY,   
   '''' AS XN_EMP_NAME                          
 FROM PRD_SKU A (NOLOCK)          
 JOIN ARTICLE E (NOLOCK) ON E.ARTICLE_CODE = A.ARTICLE_CODE          
 JOIN PRD_IRD01106 B (NOLOCK) ON A.PRODUCT_UID = B.NEW_PRODUCT_UID          
 JOIN PRD_IRM01106 C (NOLOCK) ON B.IRM_MEMO_ID = C.IRM_MEMO_ID       
 JOIN PRD_SKU SKU (NOLOCK) ON A.PRODUCT_UID=SKU.PRODUCT_UID        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=B.BIN_ID    
 JOIN PRD_DEPARTMENT_MST D ON D.DEPARTMENT_ID=B.DEPARTMENT_ID          
 WHERE  SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''       
 AND ('''+@CDEPARTMENTID+'''='''' OR B.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER     
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD   
   
   
 SET @CCMD=N'SELECT LEFT(C.IRM_MEMO_NO,2) AS DEPT_ID,   
     D.DEPARTMENT_NAME AS DEPARTMENT,          
   ''CIP'' AS XN_TYPE,           
   C.IRM_MEMO_DT AS XN_DT,                 
   C.IRM_MEMO_NO AS XN_NO,          
   A.PRODUCT_CODE,      
   ARTICLE.ARTICLE_NO,      
   ARTICLE.ARTICLE_NAME,            
   '''' AS XN_PARTY_NAME,           
   0 AS XN_IN_QTY,  
   B.QUANTITY AS XN_OUT_QTY,   
   '''' AS XN_EMP_NAME                          
 FROM PRD_SKU A (NOLOCK)          
 JOIN ARTICLE E (NOLOCK) ON E.ARTICLE_CODE = A.ARTICLE_CODE          
 JOIN PRD_IRD01106 B (NOLOCK) ON A.PRODUCT_UID = B.PRODUCT_UID          
 JOIN PRD_IRM01106 C (NOLOCK) ON B.IRM_MEMO_ID = C.IRM_MEMO_ID       
 JOIN PRD_SKU SKU (NOLOCK) ON A.PRODUCT_UID=SKU.PRODUCT_UID        
 JOIN ARTICLE   (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE      
 JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE    
 JOIN BIN B1 (NOLOCK) ON B1.BIN_ID=B.BIN_ID    
 JOIN PRD_DEPARTMENT_MST D ON D.DEPARTMENT_ID=B.DEPARTMENT_ID          
 WHERE  SKU.PRODUCT_CODE='''+@CPRODUCTCODE +'''       
 AND ('''+@CDEPARTMENTID+'''='''' OR B.DEPARTMENT_ID='''+@CDEPARTMENTID+''' )'+@CFILTER     
 PRINT @CCMD      
 INSERT @OUTPUTC        
 EXEC SP_EXECUTESQL @CCMD   
   
   --NC BARCODE DET
  
 SELECT * FROM @OUTPUTC  
 ORDER BY DEPT_ID ,PRODUCT_CODE,XN_DT ,XN_NO   
      
RETURN         
      
--SP_PRD_BARCODETRANSACTIONHISTORY 'HORASE-96','','2016-04-01','2016-06-07','0000000'      
            
END          
--********************************************** END OF PROCEDURE SP_BARCODETRANSACTIONHISTORY_NEW
