CREATE PROCEDURE SP3S_GETBROKER_DETAILS
(
	@nMode INT=1,
	@cAC_CODE VARCHAR(15)
)
AS
BEGIN
	DECLARE @cHead_code VARCHAR(100),@CHEADCODELIST VARCHAR(MAX),@cACNAME VARCHAR(MAX)
	SELECT @cHead_code=VALUE FROM config WHERE CONFIG_OPTION IN ('ACCOUNTS_BROKER_HEAD_CODE','BROKER_HEAD_CODE')
	SET @cHead_code=ISNULL(@cHead_code,'')
	--SET @cHead_code='0000000021'
	SET @CHEADCODELIST=DBO.FN_ACT_TRAVTREE(@cHead_code) 
	;WITH ALLBROKERS
	AS
	(
		select ac_name AS BROKER_AC_NAME,ac_code AS BROKER_AC_CODE 
		from lm01106 (NOLOCK) 
		where (CHARINDEX(HEAD_CODE,@CHEADCODELIST)>0) 
		and ISNULL(inactive,0)=0 
		AND ac_code<>'0000000000' AND @nMODE=0
	)
	,EXISTING_BROKER
	AS
	(
		SELECT b.AC_CODE,b.BROKER_AC_CODE,a.ac_name  AS BROKER_AC_NAME,ISNULL(b.BROKER_COMM_PERCENT,0) AS BROKER_COMM_PERCENT 
		from LM_BROKER_DETAILS b(NOLOCK) 
		JOIN lm01106 a(NOLOCK) ON b.BROKER_AC_CODE=a.AC_CODE 
		AND b.ac_code=@cAC_CODE--'JM00000052'
	)
	SELECT CAST(1 AS BIT) AS CHK, a.ac_code,a.broker_ac_code,a.BROKER_AC_NAME,a.BROKER_COMM_PERCENT 
	FROM EXISTING_BROKER a
	UNION ALL
	SELECT CAST(0 AS BIT) AS CHK, NULL ac_code,a.broker_ac_code,a.BROKER_AC_NAME,CAST(0 AS NUMERIC(5,2)) AS BROKER_COMM_PERCENT 
	FROM ALLBROKERS a
	LEFT OUTER JOIN EXISTING_BROKER b ON b.BROKER_AC_CODE=a.BROKER_AC_CODE
	WHERE b.BROKER_AC_CODE IS NULL

	--SELECT CAST((CASE WHEN B.AC_CODE IS NULL THEN 0 ELSE 1 END) AS BIT) AS CHK ,b.AC_CODE,a.ac_code as BROKER_AC_CODE,
	--ISNULL(b.BROKER_COMM_PERCENT,0) AS BROKER_COMM_PERCENT,ISNULL(b.LAST_UPDATE,GETDATE()) AS LAST_UPDATE,
	--a.AC_NAME AS BROKER_AC_NAME,@cACNAME AS AC_NAME
	--FROM ALLBROKERS a
	--LEFT OUTER JOIN LM_BROKER_DETAILS b(NOLOCK) ON b.BROKER_AC_CODE=a.AC_CODE AND b.ac_code=@cAC_CODE--'JM00000052'
	--WHERE (@nMode=0 OR b.ac_code=@cAC_CODE)
END