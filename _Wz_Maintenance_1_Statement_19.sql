IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='REUPDATE_BLANK_LASTSALEDET_1' AND VALUE=1)
BEGIN
	PRINT 'REUPDATING LAST SALE DETAILS IN GST BILLS FOR BLANK VALUES.....PLEASE STANDBY '
	/*Rohit 30-10-2024
	UPDATE A SET REF_SLS_MEMO_NO=D.CM_NO,REF_SLS_MEMO_DT=D.CM_DT  
	FROM CMD01106 A 
	JOIN CMM01106 B ON A.CM_ID=B.CM_ID 
	JOIN CMD01106 C ON C.PRODUCT_CODE=A.PRODUCT_CODE
	JOIN CMM01106 D ON D.CM_ID=C.CM_ID 
	WHERE LEFT(A.CM_ID,2)=LEFT(D.CM_ID,2) AND A.QUANTITY<0 AND B.CM_DT>='2017-07-01'
	AND (ISNULL(A.REF_SLS_MEMO_DT,'')='' OR A.REF_SLS_MEMO_DT>B.CM_DT)
	AND C.ROW_ID=(
		SELECT TOP 1 E.ROW_ID 
		FROM CMD01106 E 
		JOIN CMM01106 F ON F.CM_ID=E.CM_ID 
		WHERE E.PRODUCT_CODE=A.PRODUCT_CODE AND LEFT(F.CM_ID,2)=LEFT(B.CM_ID,2) AND QUANTITY>0
		AND CANCELLED=0 AND F.CM_DT<=B.CM_DT
		ORDER BY F.LAST_UPDATE DESC
	)
	*/
	UPDATE A SET REF_SLS_MEMO_NO=D.CM_NO,REF_SLS_MEMO_DT=D.CM_DT  
	FROM CMD01106 A 
	JOIN CMM01106 B ON A.CM_ID=B.CM_ID 
	JOIN CMD01106 C ON C.PRODUCT_CODE=A.PRODUCT_CODE
	JOIN CMM01106 D ON D.CM_ID=C.CM_ID 
	WHERE B.LOCATION_CODE=D.LOCATION_CODE AND A.QUANTITY<0 AND B.CM_DT>='2017-07-01'
	AND (ISNULL(A.REF_SLS_MEMO_DT,'')='' OR A.REF_SLS_MEMO_DT>B.CM_DT)
	AND C.ROW_ID=(
		SELECT TOP 1 E.ROW_ID 
		FROM CMD01106 E 
		JOIN CMM01106 F ON F.CM_ID=E.CM_ID 
		WHERE E.PRODUCT_CODE=A.PRODUCT_CODE AND F.LOCATION_CODE=B.LOCATION_CODE AND QUANTITY>0
		AND CANCELLED=0 AND F.CM_DT<=B.CM_DT
		ORDER BY F.LAST_UPDATE DESC
	)

	IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='REUPDATE_BLANK_LASTSALEDET_1')
		INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
			   VALUES ('REUPDATE_BLANK_LASTSALEDET_1',1,'',GETDATE())	
	ELSE
		UPDATE CONFIG SET VALUE=1 WHERE CONFIG_OPTION='REUPDATE_BLANK_LASTSALEDET_1'
END
