CREATE VIEW VW_WPS_MST  

AS  
SELECT T1.PS_ID,T1.PS_NO,T1.PS_DT,
ISNULL(T4.AC_NAME,'') AS AC_NAME,
T4.ADDRESS0+' '+T4.ADDRESS1+' '+T4.ADDRESS2 +' '+ T4.AREA_NAME AS [ADDRESS],T4.CITY,T4.[STATE],T4.PINCODE,
T2.USERNAME,ISNULL(T6.DEPT_NAME,'') AS DEPT_NAME ,T6.DEPT_ID,T7.QUANTITY AS [TOTAL_QTY] ,T7.TAX_AMOUNT ,T1.USER_CODE,
(CASE WHEN T1.CANCELLED =1 THEN 'CANCELLED' ELSE '' END) AS  CANCELLED,
(CASE WHEN T1.PS_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END) AS  INVOICE_TYPE, 
T1.REMARKS,'' AS AMOUNT_IN_WORDS,T1.SUBTOTAL,
(T1.SUBTOTAL+T7.TAX_AMOUNT) AS NET_AMOUNT ,
(CASE WHEN T3.PS_ID IS NOT NULL  THEN 'SETTLED' ELSE 'PENDING' END) AS [STATUS] 
   ,T1.FIN_YEAR  ,COM.COMPANY_CODE ,L.DEPT_ID  AS LOC_ID,L.DEPT_NAME AS LOC_NAME   
   ,T1.location_Code
 FROM WPS_MST T1     
 JOIN USERS T2  ON T1.USER_CODE = T2.USER_CODE    
 LEFT OUTER JOIN 
 (SELECT A.PS_ID FROM IND01106 A JOIN INM01106 B ON A.INV_ID=B.INV_ID
  JOIN WPS_MST C ON C.PS_ID=A.PS_ID
  WHERE B.CANCELLED=0 GROUP BY A.PS_ID) T3 ON T3.PS_ID=T1.PS_ID
 JOIN LMV01106 T4 ON T4.AC_CODE = T1.AC_CODE    
 LEFT OUTER JOIN LOCATION T6 ON T6.DEPT_ID = T1.PARTY_DEPT_ID     
 LEFT OUTER JOIN 
 (
	SELECT PS_ID, SUM(ISNULL(QUANTITY,0)) AS QUANTITY,SUM(ISNULL(TAX_AMOUNT,0)) AS [TAX_AMOUNT] 
	FROM WPS_DET GROUP BY PS_ID
  ) T7 ON T7.PS_ID=T1.PS_ID 
 LEFT OUTER JOIN COMPANY COM ON 1=1 AND COM.COMPANY_CODE='01'
 LEFT OUTER JOIN LOCATION  L (NOLOCK) ON T1.location_code/*LEFT(T1.PS_ID,2)*//*Rohit 05-11-2024*/ = L.DEPT_ID
