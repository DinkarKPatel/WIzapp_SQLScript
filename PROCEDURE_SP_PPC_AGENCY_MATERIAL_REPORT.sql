CREATE PROCEDURE SP_PPC_AGENCY_MATERIAL_REPORT
(
 @CSECTION_CODE VARCHAR(MAX)='',
 @CSUBSECTION_CODE VARCHAR(MAX)='',
 @CARTICLE_CODE VARCHAR(MAX)='',
 @CPRODUCT_CODE  VARCHAR(MAX)='',
 @NCBS INT=0
)
AS
BEGIN
    DECLARE @DTSQL NVARCHAR(MAX) ,@CFILTER VARCHAR(MAX)
    SET @CFILTER=''

IF @CSECTION_CODE<>''
   SET @CFILTER =@CFILTER+' AND SM.SECTION_CODE '+@CSECTION_CODE+''
IF @CSUBSECTION_CODE<>''
   SET @CFILTER =@CFILTER+' AND SD.SUB_SECTION_CODE '+@CSUBSECTION_CODE+''
IF @CARTICLE_CODE<>''
   SET @CFILTER =@CFILTER+' AND ART.ARTICLE_CODE '+@CARTICLE_CODE+''
IF @CPRODUCT_CODE<>''
   SET @CFILTER =@CFILTER+' AND A.PRODUCT_CODE '+@CPRODUCT_CODE+''   
       
  
    IF OBJECT_ID('TEMPDB..#TMPSTK','U') IS NOT NULL
       DROP TABLE #TMPSTK
 
    SELECT B.ARTICLE_CODE , 
           C.PRODUCT_CODE ,C.PRODUCT_UID ,
           C.QUANTITY AS IN_QTY 
    INTO #TMPSTK
    FROM PPC_PIM01106 A
    JOIN PPC_PID01106 B ON A.MRR_ID =B.MRR_ID 
    JOIN PPC_PID01106_BARCODE C ON B.ROW_ID =C.PID_ROW_ID 
    WHERE A.CANCELLED =0
    
     IF OBJECT_ID('TEMPDB..#TMPOUTSTK','U') IS NOT NULL
       DROP TABLE #TMPOUTSTK
    
    
    SELECT A.PRODUCT_UID ,C.PRODUCT_CODE ,C.ARTICLE_CODE,A.QUANTITY AS OUT_QTY  
    INTO #TMPOUTSTK
    FROM PPC_AGENCY_ISSUE_MATERIAL_DET  A
    JOIN PPC_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID 
    JOIN PPC_SKU C ON A.PRODUCT_UID =C.PRODUCT_UID 
    WHERE B.CANCELLED =0 
   
   
  SET @DTSQL=N'SELECT SM.SECTION_NAME ,SD.SUB_SECTION_NAME , ART.ARTICLE_NO ,
          ART.ARTICLE_NAME,
          A.PRODUCT_CODE , SUM(A.IN_QTY ) AS IN_QTY ,
          SUM(A.OUT_QTY ) AS OUT_QTY,
          BAL_QTY= SUM(A.IN_QTY )-SUM(A.OUT_QTY )
   FROM 
   (
    SELECT A.ARTICLE_CODE,A.PRODUCT_CODE ,SUM(IN_QTY ) AS IN_QTY ,
           CAST(0 AS NUMERIC(10,3)) AS OUT_QTY 
    FROM #TMPSTK A
    GROUP BY A.ARTICLE_CODE,A.PRODUCT_CODE 
    UNION ALL
    SELECT A.ARTICLE_CODE ,A.PRODUCT_CODE ,0 AS IN_QTY ,
           SUM(A.OUT_QTY) AS OUT_QTY
    FROM #TMPOUTSTK A
    GROUP BY A.ARTICLE_CODE ,A.PRODUCT_CODE
    ) A
    JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE 
    JOIN SECTIOND SD ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE 
    JOIN SECTIONM SM ON SM.SECTION_CODE =SD.SECTION_CODE 
    WHERE 1=1  
    '+@CFILTER
    +' GROUP BY SM.SECTION_NAME ,SD.SUB_SECTION_NAME , ART.ARTICLE_NO ,
    ART.ARTICLE_NAME,A.PRODUCT_CODE 
    HAVING ('''+RTRIM(LTRIM(STR(@NCBS)))+'''=''0'' OR SUM(A.IN_QTY )-SUM(A.OUT_QTY )>0) 
    ORDER BY SM.SECTION_NAME ,SD.SUB_SECTION_NAME ,ART.ARTICLE_NO ,A.PRODUCT_CODE '
    
    PRINT @DTSQL
    EXEC SP_EXECUTESQL @DTSQL
    
    
END
