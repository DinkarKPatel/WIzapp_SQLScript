CREATE PROCEDURE SP_GENSALSHEET    
(    
  @CFROMDT VARCHAR(10),    
  @CTODT VARCHAR(10),    
  @CWHERE VARCHAR(MAX) ,
  @CWHERE_1 VARCHAR(MAX)='1'   
)    
    
AS    
BEGIN    
 DECLARE @CCMD NVARCHAR(MAX)   
 
	IF OBJECT_ID('TEMPDB..#TMPSALARYSHEET','U') IS NOT NULL
		DROP TABLE #TMPSALARYSHEET
		
	SELECT E.PAY_NAME,E.PAY_TYPE,DEPARTMENT_NAME,A.EMP_ID,B.REF_ID ,B.EMP_FNAME+' '+B.EMP_LNAME AS EMPNAME,A.NET_SALARY AS PAYAMOUNT,        
	A.MONTH_DAYS,A.SALARY_DAYS,A.BASIC_SALARY,A.NET_SALARY AS INHAND_SALARY
    INTO #TMPSALARYSHEET FROM EMP_PAYSLIP_MST A JOIN EMP_MST B ON A.EMP_ID=B.EMP_ID
    JOIN EMP_DEPARTMENT D ON D.DEPARTMENT_ID=B.DEPARTMENT_ID
    JOIN EMP_PAY E ON 1=2
    WHERE 1=2
         
	SET @CCMD=N'SELECT E.PAY_NAME,E.PAY_TYPE,DEPARTMENT_NAME,A.EMP_ID,B.REF_ID ,B.EMP_FNAME+'' ''+B.EMP_LNAME AS EMPNAME,ROUND(SUM(E.AMOUNT),0)  AS PAYAMOUNT,        
	 0 AS MONTH_DAYS,0 AS SALARY_DAYS,0 AS BASIC_SALARY,0 AS NET_SALARY
	 
	 --FROM VW_PAYSLIP_REP A        
	 --JOIN VW_SALSHEET B ON A.PAYSLIP_ID = B.PAYSLIP_ID          
	 FROM EMP_PAYSLIP_MST A
	 JOIN EMP_MST B ON A.EMP_ID=B.EMP_ID
	 JOIN EMP_DEPARTMENT D ON D.DEPARTMENT_ID=B.DEPARTMENT_ID

	 JOIN (SELECT A.PAY_ID,PAY_NAME,PAYSLIP_ID,A.PAY_TYPE,SUM(AMOUNT) AS AMOUNT
		   FROM EMP_PAYSLIP_DET A JOIN EMP_PAY B ON A.PAY_ID=B.PAY_ID 
		   GROUP BY A.PAY_ID,PAY_NAME,PAYSLIP_ID,A.PAY_TYPE) E ON E.PAYSLIP_ID=A.PAYSLIP_ID	
	 
	 WHERE DBO.FN_GETPAYSLIPDATE(A.PAYSLIP_ID) BETWEEN '''+@CFROMDT+''' AND '''+@CTODT+'''    
	 AND A.CANCELLED = 0 '+REPLACE(REPLACE(@CWHERE,'AND DEPT_ID','AND B.DEPT_ID'),'AND DEPARTMENT_ID IN','AND B.DEPARTMENT_ID IN')+'       
	 GROUP BY DEPARTMENT_NAME,B.REF_ID,A.EMP_ID,B.EMP_FNAME,B.EMP_LNAME,PAY_NAME,PAY_TYPE
	 ORDER BY DEPARTMENT_NAME,B.REF_ID'
	 
	 INSERT #TMPSALARYSHEET     
	 EXEC SP_EXECUTESQL @CCMD    
	 
	 UPDATE #TMPSALARYSHEET SET BASIC_SALARY=B.BASIC_SALARY,INHAND_SALARY=B.NET_SALARY,MONTH_DAYS=B.MONTH_DAYS,SALARY_DAYS=B.SALARY_DAYS FROM 
	 (SELECT EMP_ID,SUM(BASIC_SALARY) AS BASIC_SALARY,SUM(NET_SALARY) AS NET_SALARY,SUM(A.MONTH_DAYS) AS MONTH_DAYS,SUM(A.SALARY_DAYS) AS SALARY_DAYS
	  FROM EMP_PAYSLIP_MST A
	  WHERE DBO.FN_GETPAYSLIPDATE(A.PAYSLIP_ID)  BETWEEN @CFROMDT AND @CTODT AND CANCELLED=0 GROUP BY EMP_ID) B WHERE B.EMP_ID=#TMPSALARYSHEET.EMP_ID    
	  
	  SELECT * FROM #TMPSALARYSHEET
END
