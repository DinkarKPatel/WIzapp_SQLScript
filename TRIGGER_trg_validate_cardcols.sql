CREATE TRIGGER TRG_VALIDATE_CARDCOLS ON CUSTDYM FOR UPDATE
AS
BEGIN
	IF EXISTS (SELECT TOP 1 A.CUSTOMER_CODE FROM INSERTED A
			   JOIN DELETED B ON A.CUSTOMER_CODE=B.CUSTOMER_CODE
	WHERE ((ISNULL(A.CARD_CODE,'')='' AND ISNULL(B.CARD_CODE,'')<>'') OR
		   (A.DT_CARD_ISSUE='' AND B.DT_CARD_ISSUE<>'') OR
		   (A.DT_CARD_EXPIRY='' AND B.DT_CARD_EXPIRY<>'') OR
		   (A.CARD_NO='' AND B.CARD_NO<>''))) 
	BEGIN	
		DECLARE @NLEVEL INT
		
		SELECT @NLEVEL=TRIGGER_NESTLEVEL()
		
		IF  @NLEVEL=1
		UPDATE A SET CARD_CODE=(CASE WHEN ISNULL(A.CARD_CODE,'')='' AND ISNULL(B.CARD_CODE,'')<>'' 
								THEN B.CARD_CODE ELSE A.CARD_CODE END),
					 DT_CARD_ISSUE=(CASE WHEN A.DT_CARD_ISSUE='' AND B.DT_CARD_ISSUE<>'' 
								THEN B.DT_CARD_ISSUE ELSE A.DT_CARD_ISSUE END),	
	
					 DT_CARD_EXPIRY=(CASE WHEN A.DT_CARD_EXPIRY='' AND B.DT_CARD_EXPIRY<>'' 
								THEN B.DT_CARD_EXPIRY ELSE A.DT_CARD_EXPIRY END),	
					 CARD_NO=(CASE WHEN A.CARD_NO='' AND B.CARD_NO<>'' 
								THEN B.CARD_NO ELSE A.CARD_NO END)
		FROM CUSTDYM A
		JOIN DELETED B ON A.CUSTOMER_CODE=B.CUSTOMER_CODE								
		WHERE ((ISNULL(A.CARD_CODE,'')='' AND ISNULL(B.CARD_CODE,'')<>'') OR
		   (A.DT_CARD_ISSUE='' AND B.DT_CARD_ISSUE<>'') OR
		   (A.DT_CARD_EXPIRY='' AND B.DT_CARD_EXPIRY<>'') OR
		   (A.CARD_NO='' AND B.CARD_NO<>''))	
	END	   
END
