create VIEW CUSTDBXN
----WITH ENCRYPTION
AS  
/*
AUTHOR				: 
CREATION DATE		:
DESCRIPTION			: 

MODIFIED BY			: BABAN
MODIFICATION DATE	: 11 SEP 2014
DESCRIPTION			: INCLUDED OTHER_CHARGES AMOUNT IN THE AMOUNT BEING CREDITED FOR DELIEVERY OF 
					  BUYER ORDER IN CASH MEMO TRANSACTION.	
*/
SELECT  A.CUSTOMER_CODE, A.USER_CUSTOMER_CODE, A.CUSTOMER_TITLE, A.CUSTOMER_FNAME, A.CUSTOMER_LNAME,  
  'OPS' AS XN_TYPE,   
  '' AS XN_NO, '' AS XN_ID, '' AS XN_DT,   
  ( CASE WHEN A.OPENING_BALANCE > 0 THEN A.OPENING_BALANCE ELSE 0 END ) AS DR_AMOUNT,   
  ( CASE WHEN A.OPENING_BALANCE < 0 THEN ABS(A.OPENING_BALANCE) ELSE 0 END ) AS CR_AMOUNT,   
  /*LEFT(A.CUSTOMER_CODE,2)*//*Rohit 01-11-2024*/ A.location_id  AS DEPT_ID,   
  '' AS ADJ_BILL_NO,   
  'OPENING BALANCE ' + CAST( ABS(A.OPENING_BALANCE) AS VARCHAR(20) ) AS NARRATION,0 AS MEMO_TYPE 
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,CONVERT(VARCHAR(50),'') AS SALESPERSON,CONVERT(NUMERIC(18,2),0) AS BILLAMT
,CONVERT(NUMERIC(18,4),0) AS RECAMT  
FROM CUSTDYM A  
WHERE A.OPENING_BALANCE <> 0  
AND A.CUSTOMER_CODE <> '000000000000'  
  
-- SALE ON CREDIT  
UNION ALL  
SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,  
  ( CASE WHEN PAY.CREDIT_AMOUNT>0 THEN 'SLS' ELSE   
      ( CASE WHEN /*SUBSTRING(A.CM_NO,5,1)*//*Rohit 01-11-2024*/SUBSTRING(A.CM_NO,LEN(A.location_Code)+3,1) ='N' THEN 'CNI' ELSE 'SLR' END ) END ) AS XN_TYPE,   
  A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT,   
  ( CASE WHEN (PAY.CREDIT_AMOUNT) > 0 THEN (PAY.CREDIT_AMOUNT) ELSE 0 END ) AS DR_AMOUNT,   
  ( CASE WHEN (PAY.CREDIT_AMOUNT) < 0 OR PAY.CREDIT_REFUND_AMOUNT<>0 THEN 
  ABS((PAY.CREDIT_AMOUNT+PAY.CREDIT_REFUND_AMOUNT)) ELSE 0 END ) AS CR_AMOUNT,   
  /*LEFT(A.CM_NO,2)*//*Rohit 01-11-2024*/ A.location_Code AS DEPT_ID,   
  '' AS ADJ_BILL_NO,   
   'BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.NET_AMOUNT AS VARCHAR(20) ) AS NARRATION,
  A.MEMO_TYPE  --CHANGE
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,DBO.FN_GETSALEPERSON(A.CM_ID,0) AS SALESPERSON,A.NET_AMOUNT AS BILLAMT
,ISNULL(CASH_AMOUNT,0)+ISNULL(CC_AMOUNT,0)+ISNULL(CN_AMOUNT,0)+ISNULL(ADVANCE_AMOUNT_ADJUSTED,0)
+ISNULL(OTHER_DOC_AMOUNT,0)+ISNULL(BANK_CHARGES,0)+ISNULL(MISC_AMOUNT,0) AS RECAMT
FROM CMM01106 A  
JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE
JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'SLS'

LEFT OUTER JOIN
(SELECT DISTINCT A.CM_ID FROM  CMD01106 A 
 JOIN SKU_BO B ON A.PRODUCT_CODE=B.PRODUCT_CODE
 JOIN CMM01106 C ON C.CM_ID=A.CM_ID WHERE CANCELLED=0) C ON C.CM_ID=A.CM_ID

WHERE (PAY.CREDIT_AMOUNT <> 0 OR PAY.CREDIT_REFUND_AMOUNT<>0) AND A.CM_MODE = 1 --AND A.REF_CM_ID = ''  
AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000'  AND C.CM_ID IS NULL
  
-- ADVANCE ADJUSTMENT  
UNION ALL  
SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,  
  'ADJ' AS XN_TYPE,   
  A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT,   
  PAY.ADVANCE_AMOUNT_ADJUSTED AS DR_AMOUNT,   
  0 AS CR_AMOUNT,   
  /*LEFT(A.CM_NO,2)*//*Rohit 01-11-2024*/A.location_Code AS DEPT_ID,   
  '' AS ADJ_BILL_NO,   
  'ADVANCE ADJ IN BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' + CAST( PAY.ADVANCE_AMOUNT_ADJUSTED AS VARCHAR(20) ) AS NARRATION,
  A.MEMO_TYPE  --CHANGE
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,DBO.FN_GETSALEPERSON(A.CM_ID,0) AS SALESPERSON,A.NET_AMOUNT AS BILLAMT
,ISNULL(CASH_AMOUNT,0)+ISNULL(CC_AMOUNT,0)+ISNULL(CN_AMOUNT,0)+ISNULL(ADVANCE_AMOUNT_ADJUSTED,0)
+ISNULL(OTHER_DOC_AMOUNT,0)+ISNULL(BANK_CHARGES,0)+ISNULL(MISC_AMOUNT,0) AS RECAMT  
FROM CMM01106 A  
JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE  
JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'SLS'
LEFT OUTER JOIN
(SELECT DISTINCT A.CM_ID FROM  CMD01106 A 
 JOIN SKU_BO B ON A.PRODUCT_CODE=B.PRODUCT_CODE
 JOIN CMM01106 C ON C.CM_ID=A.CM_ID WHERE CANCELLED=0) C ON C.CM_ID=A.CM_ID
WHERE PAY.ADVANCE_AMOUNT_ADJUSTED > 0 AND A.CM_MODE = 1 --AND A.REF_CM_ID = ''  
AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000'  AND C.CM_ID IS NULL
  
-- CREDIT NOTE ADJUSTMENT  
UNION ALL  
SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,  
  'CNA' AS XN_TYPE,   
  A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT,   
  PAY.CN_AMOUNT AS DR_AMOUNT,   
  0 AS CR_AMOUNT,   
  /*LEFT(A.CM_NO,2)*//*Rohit 01-11-2024*/A.location_Code AS DEPT_ID,   
  '' AS ADJ_BILL_NO,   
  'CN ADJ IN BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' + CAST( PAY.CN_AMOUNT AS VARCHAR(20) ) AS NARRATION,
  A.MEMO_TYPE    --CHANGE
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,DBO.FN_GETSALEPERSON(A.CM_ID,0) AS SALESPERSON,A.NET_AMOUNT AS BILLAMT
,ISNULL(CASH_AMOUNT,0)+ISNULL(CC_AMOUNT,0)+ISNULL(CN_AMOUNT,0)+ISNULL(ADVANCE_AMOUNT_ADJUSTED,0)
+ISNULL(OTHER_DOC_AMOUNT,0)+ISNULL(BANK_CHARGES,0)+ISNULL(MISC_AMOUNT,0) AS RECAMT  
FROM CMM01106 A  
JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE  
JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'SLS'

LEFT OUTER JOIN
(SELECT DISTINCT A.CM_ID FROM  CMD01106 A 
 JOIN SKU_BO B ON A.PRODUCT_CODE=B.PRODUCT_CODE
 JOIN CMM01106 C ON C.CM_ID=A.CM_ID WHERE CANCELLED=0) C ON C.CM_ID=A.CM_ID
 
WHERE PAY.CN_AMOUNT > 0 AND A.CM_MODE = 1 --AND A.REF_CM_ID = ''  
AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000'  AND C.CM_ID IS NULL

UNION ALL  

SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,  
  'REC' AS XN_TYPE,   
  A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,  
  0 AS DR_AMOUNT,   
  A.AMOUNT AS CR_AMOUNT,   
  /*LEFT(A.ADV_REC_NO,2)*//*Rohit 01-11-2024*/A.location_Code AS DEPT_ID,   
  --A.ADJ_BILL_NO AS ADJ_BILL_NO,   
  '' AS ADJ_BILL_NO,
  'RECEIPT# ' + A.ADV_REC_NO + ' DATED: ' + CAST(A.ADV_REC_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.AMOUNT AS VARCHAR(20) ) AS NARRATION
  ,0 AS MEMO_TYPE   --CHANGE
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,E.EMP_NAME AS SALESPERSON,CONVERT(NUMERIC(18,2),0) AS BILLAMT
,0 AS RECAMT    
FROM ARC01106 A
JOIN EMPLOYEE E ON A.EMP_CODE=E.EMP_CODE  
JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE 
LEFT OUTER JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.ADV_REC_ID AND PAY.XN_TYPE = 'ARC'
WHERE A.AMOUNT <> 0   
AND A.ARC_TYPE =1 AND A.ARCT IN (1,2)  
AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000'  
-- AND A.ARCT<>3   -- ( A.ARCT=2 OR ( A.ARCT=1 AND A.ADJ_BILL_ID <> '') )  
--AND ISNULL(A.REF_XN_TYPE,'') <> 'SOM'  
UNION ALL  
SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,  
  'CNA' AS XN_TYPE,   
  A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,  
  (CASE WHEN A.ARC_TYPE=1 THEN PAY.CN_AMOUNT ELSE 0 END) AS DR_AMOUNT,   
  (CASE WHEN A.ARC_TYPE=2 THEN PAY.CN_AMOUNT ELSE 0 END) AS CR_AMOUNT,   
  /*LEFT(A.ADV_REC_NO,2)*//*Rohit 01-11-2024*/ A.location_Code AS DEPT_ID,   
  --A.ADJ_BILL_NO AS ADJ_BILL_NO,  
  '' AS ADJ_BILL_NO, 
  'C/N ADJ IN RECEIPT# ' + A.ADV_REC_NO + ' DATED: ' + CAST(A.ADV_REC_DT AS VARCHAR(50)) + ' AMT: ' + CAST( PAY.CN_AMOUNT AS VARCHAR(20) ) AS NARRATION  
  ,0 AS MEMO_TYPE  --CHANGE
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,E.EMP_NAME AS SALESPERSON,CONVERT(NUMERIC(18,2),0) AS BILLAMT
,0 AS RECAMT      
FROM ARC01106 A  
JOIN EMPLOYEE E ON A.EMP_CODE=E.EMP_CODE  
JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE 
JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.ADV_REC_ID AND PAY.XN_TYPE = 'ARC' 
WHERE PAY.CN_AMOUNT <> 0   
AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000'  
-- AND A.ARCT<>3   -- ( A.ARCT=2 OR ( A.ARCT=1 AND A.ADJ_BILL_ID <> '') )  
AND ISNULL(A.REF_XN_TYPE,'') <> 'SOM'  
AND (A.ARCT=1 OR A.ARCT=2)
AND ARC_TYPE<>2
union
--advance adjust in receipt
SELECT A.CUSTOMER_CODE, cus.USER_CUSTOMER_CODE, cus.CUSTOMER_TITLE, cus.CUSTOMER_FNAME, cus.CUSTOMER_LNAME, 
	   'ARC' AS XN_TYPE,A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,  
	   PAY.ADVANCE_AMOUNT_ADJUSTED AS DR_AMOUNT,0 AS CR_AMOUNT ,  
	   /*LEFT(A.ADV_REC_NO,2)*//*Rohit 01-11-2024*/A.location_Code AS DEPT_ID,'' AS ADJ_BILL_NO, 
	  'ADV ADJ IN O/S REC' + A.ADV_REC_NO + ' DATED: ' + CAST(A.ADV_REC_DT AS VARCHAR(50)) + ' AMT: ' + CAST( PAY.CN_AMOUNT AS VARCHAR(20) ) AS NARRATION  
	 ,0 AS MEMO_TYPE,E.EMP_NAME AS SALESPERSON,CONVERT(NUMERIC(18,2),0) AS BILLAMT,0 AS RECAMT
	FROM ARC01106 A (NOLOCK) 
	JOIN VW_BILL_PAYMODE PAY (NOLOCK) ON PAY.MEMO_ID = A.ADV_REC_ID AND PAY.XN_TYPE = 'ARC' 
	JOIN custdym cus (NOLOCK) ON cus.customer_code=A.CUSTOMER_CODE
	JOIN EMPLOYEE E ON A.EMP_CODE=E.EMP_CODE  
	WHERE PAY.ADVANCE_AMOUNT_ADJUSTED <> 0  AND A.ARC_TYPE=1 AND A.ARCT=1 
	--AND (A.ARCT=1 OR A.ARCT=2)
	AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000'  
	AND ARC_TYPE<>2 
	--and a.adv_rec_id ='H10112200000H1RV1-0059'


UNION ALL  
SELECT A.CUSTOMER_CODE, B.USER_CUSTOMER_CODE, B.CUSTOMER_TITLE, B.CUSTOMER_FNAME, B.CUSTOMER_LNAME,  
  'PAY' AS XN_TYPE,   
  A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,  
  A.NET_AMOUNT AS DR_AMOUNT,   
  0 AS CR_AMOUNT,   
  /*LEFT(A.ADV_REC_NO,2)*//*Rohit 01-11-2024*/A.location_Code AS DEPT_ID,   
  --A.ADJ_BILL_NO AS ADJ_BILL_NO,   
  '' AS ADJ_BILL_NO,
  'PAYMENT# ' + A.ADV_REC_NO + ' DATED: ' + CAST(A.ADV_REC_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.AMOUNT AS VARCHAR(20) ) AS NARRATION  
  ,0 AS MEMO_TYPE  --CHANGE
  ---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,E.EMP_NAME AS SALESPERSON,CONVERT(NUMERIC(18,2),0) AS BILLAMT
,0 AS RECAMT    
FROM ARC01106 A  
JOIN EMPLOYEE E ON A.EMP_CODE=E.EMP_CODE  
JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE  
WHERE A.AMOUNT <> 0   
AND A.ARC_TYPE =2   
AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000'  

-- WHOLESALE
UNION ALL  
SELECT A.AC_CODE AS CUSTOMER_CODE, A.AC_CODE AS USER_CUSTOMER_CODE, '' AS CUSTOMER_TITLE, 
  B.AC_NAME AS CUSTOMER_FNAME, '' AS CUSTOMER_LNAME,  
  'WSL' AS XN_TYPE, A.INV_NO AS XN_NO, A.INV_ID AS XN_ID, A.INV_DT AS XN_DT,   
  ( CASE WHEN (PAY.CREDIT_AMOUNT) > 0 THEN (PAY.CREDIT_AMOUNT) ELSE 0 END ) AS DR_AMOUNT,   
  0 AS CR_AMOUNT,   
  /*LEFT(A.INV_ID,2)*//*Rohit 01-11-2024*/A.location_Code AS DEPT_ID,   
  '' AS ADJ_BILL_NO,   
  'BILL# ' + A.INV_NO + ' DATED: ' + CAST(A.INV_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.NET_AMOUNT AS VARCHAR(20) ) AS NARRATION,
  A.MEMO_TYPE  --CHANGE
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,DBO.FN_GETSALEPERSON(A.INV_ID,1) AS SALESPERSON,A.NET_AMOUNT AS BILLAMT
,ISNULL(CASH_AMOUNT,0)+ISNULL(CC_AMOUNT,0)+ISNULL(CN_AMOUNT,0)+ISNULL(ADVANCE_AMOUNT_ADJUSTED,0)
+ISNULL(OTHER_DOC_AMOUNT,0)+ISNULL(BANK_CHARGES,0)+ISNULL(MISC_AMOUNT,0) AS RECAMT  
FROM INM01106 A  
JOIN LM01106 B ON A.AC_CODE = B.AC_CODE
JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.INV_ID AND PAY.XN_TYPE = 'WSL'
WHERE INV_MODE=1 AND PAY.XN_TYPE='WSL' AND A.CANCELLED=0

-- WHOLE SALE RETURN
UNION ALL
SELECT A.AC_CODE AS CUSTOMER_CODE, A.AC_CODE AS USER_CUSTOMER_CODE, '' AS CUSTOMER_TITLE, 
  B.AC_NAME AS CUSTOMER_FNAME, '' AS CUSTOMER_LNAME,  
  'WSR' AS XN_TYPE, A.CN_NO AS XN_NO, A.CN_ID AS XN_ID, A.CN_DT AS XN_DT,   
  0 AS DR_AMOUNT,   
  A.TOTAL_AMOUNT AS CR_AMOUNT,   
  /*LEFT(A.CN_ID,2)*//*Rohit 01-11-2024*/A.location_Code AS DEPT_ID,   
  '' AS ADJ_BILL_NO,   
  'BILL# ' + A.CN_NO + ' DATED: ' + CAST(A.CN_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.TOTAL_AMOUNT AS VARCHAR(20) ) AS NARRATION,
  A.MEMO_TYPE  --CHANGE
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,DBO.FN_GETSALEPERSON(A.CN_ID,2) AS SALESPERSON,A.TOTAL_AMOUNT AS BILLAMT
,0 AS RECAMT   
FROM CNM01106 A  
JOIN LM01106 B ON A.AC_CODE = B.AC_CODE
WHERE A.MODE=1 AND A.CANCELLED=0

-------RECEIPT AGAINST WSL 

UNION ALL
SELECT A.AC_CODE AS CUSTOMER_CODE, A.AC_CODE AS USER_CUSTOMER_CODE, '' AS CUSTOMER_TITLE, 
B.AC_NAME AS CUSTOMER_FNAME, '' AS CUSTOMER_LNAME,  
  'REC' AS XN_TYPE,   
  A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,  
  0 AS DR_AMOUNT,   
  A.AMOUNT AS CR_AMOUNT,   
  /*LEFT(A.ADV_REC_NO,2)*//*Rohit 01-11-2024*/A.location_Code AS DEPT_ID,   
  --A.ADJ_BILL_NO AS ADJ_BILL_NO,   
  '' AS ADJ_BILL_NO,
  'RECEIPT# ' + A.ADV_REC_NO + ' DATED: ' + CAST(A.ADV_REC_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.AMOUNT AS VARCHAR(20) ) AS NARRATION,
  0 AS MEMO_TYPE   --CHANGE
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,E.EMP_NAME AS SALESPERSON,CONVERT(NUMERIC(18,2),0) AS BILLAMT
,0 AS RECAMT      
FROM ARC01106 A  
JOIN EMPLOYEE E ON A.EMP_CODE=E.EMP_CODE  
JOIN LM01106 B ON A.AC_CODE = B.AC_CODE 
LEFT OUTER JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID = A.ADV_REC_ID AND PAY.XN_TYPE = 'ARC'
WHERE A.PARTY_TYPE=2 AND A.CANCELLED =0 

UNION ALL
SELECT (CASE WHEN A.CUSTOMER_CODE= '000000000000' THEN A.AC_CODE ELSE A.CUSTOMER_CODE END) AS CUSTOMER_CODE, 
C.USER_CUSTOMER_CODE, 
C.CUSTOMER_TITLE, 
C.CUSTOMER_FNAME, 
(CASE WHEN A.CUSTOMER_CODE= '000000000000' THEN D.AC_NAME ELSE C.CUSTOMER_LNAME  END) AS CUSTOMER_LNAME  ,
  'WOD' AS XN_TYPE,   
  A.ORDER_NO AS XN_NO, A.ORDER_ID AS XN_ID, A.ORDER_DT AS XN_DT,   
  A.TOTAL_AMOUNT AS DR_AMOUNT,   
  0 AS CR_AMOUNT,   
 /* LEFT(A.ORDER_NO,2)*//*Rohit 01-11-2024*/A.location_Code AS DEPT_ID,   
   '' AS ADJ_BILL_NO,   
  'BUYER ORDER # ' + A.ORDER_NO + ' DATED: ' + CAST(A.ORDER_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.TOTAL_AMOUNT AS VARCHAR(20) ) AS NARRATION,  
   0 AS MEMO_TYPE  
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,E.EMP_NAME AS SALESPERSON,A.TOTAL_AMOUNT AS BILLAMT
,0 AS RECAMT           
FROM WSL_ORDER_MST A  
LEFT OUTER JOIN EMPLOYEE E ON A.EMP_CODE=E.EMP_CODE  
JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE 
LEFT OUTER JOIN LMV01106 D ON A.AC_CODE = D.AC_CODE   
WHERE A.TOTAL_AMOUNT <> 0  
AND A.CANCELLED = 0  AND A.APPROVED=1  AND (A.CUSTOMER_CODE <> '000000000000' OR A.AC_CODE <> '0000000000')

-- DELIVERY OF TAILORING ITEMS IN CASHMEMO
UNION ALL
SELECT A.CUSTOMER_CODE, D.USER_CUSTOMER_CODE, D.CUSTOMER_TITLE, D.CUSTOMER_FNAME, 
(CASE WHEN A.CUSTOMER_CODE= '000000000000' THEN E.AC_NAME ELSE D.CUSTOMER_LNAME  END) AS CUSTOMER_LNAME  ,
		'TLD' AS XN_TYPE,
		A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT, 
		0 AS DR_AMOUNT,
		ABS(B.TLR_NET) AS CR_AMOUNT,
		/*LEFT(A.CM_NO,2)*//*Rohit 01-11-2024*/A.location_Code  AS DEPT_ID, 
		'' AS ADJ_BILL_NO, 
		'BUYER ORDER DELIVERY IN BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' +
		 CAST(A.NET_AMOUNT AS VARCHAR(20) ) AS NARRATION,
		 0 AS MEMO_TYPE,DBO.FN_GETSALEPERSON(A.CM_ID,0) AS SALESPERSON,A.NET_AMOUNT AS BILLAMT,
		 0 AS RECAMT		 
		 
FROM CMM01106 A
JOIN 
(SELECT  DISTINCT A.CM_ID,A.NET_AMOUNT AS TLR_NET FROM CMM01106 A JOIN  CMD01106 B (NOLOCK) ON A.CM_ID = B.CM_ID
JOIN SKU_BO C  (NOLOCK) ON B.PRODUCT_CODE = C.PRODUCT_CODE
WHERE A.CANCELLED = 0 GROUP BY A.CM_ID,A.NET_AMOUNT) B ON A.CM_ID=B.CM_ID
JOIN CUSTDYM D  (NOLOCK) ON A.CUSTOMER_CODE = D.CUSTOMER_CODE
LEFT OUTER JOIN LMV01106 E ON A.AC_CODE = E.AC_CODE   
WHERE A.CANCELLED = 0

UNION ALL
SELECT A.CUSTOMER_CODE, D.USER_CUSTOMER_CODE, D.CUSTOMER_TITLE, D.CUSTOMER_FNAME,
(CASE WHEN A.CUSTOMER_CODE= '000000000000' THEN F.AC_NAME ELSE D.CUSTOMER_LNAME  END) AS CUSTOMER_LNAME ,
		'TLD' AS XN_TYPE,
		A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT, 
		0 AS DR_AMOUNT,
		SUM(CASE WHEN E.PAYMODE_GRP_CODE IN ('0000001','0000002') OR 
			(E.PAYMODE_GRP_CODE = '0000003' AND C.PAYMODE_CODE NOT IN ( '0000001', '0000002' )) 
			THEN AMOUNT ELSE 0 END) AS CR_AMOUNT,
		/*LEFT(A.CM_NO,2)*//*Rohit 01-11-2024*/A.location_Code  AS DEPT_ID, 
		 '' AS ADJ_BILL_NO, 
		'BUYER ORDER DELIVERY IN BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' +
		 CAST(A.NET_AMOUNT AS VARCHAR(20) ) AS NARRATION,
	   0 AS MEMO_TYPE,DBO.FN_GETSALEPERSON(A.CM_ID,0) AS SALESPERSON,
	   A.NET_AMOUNT AS BILLAMT,0 AS RECAMT
		 
FROM CMM01106 A
JOIN 
(SELECT DISTINCT A.CM_ID  FROM CMM01106 A 
 JOIN  CMD01106 B (NOLOCK) ON A.CM_ID = B.CM_ID
 JOIN SKU_BO C  (NOLOCK) ON B.PRODUCT_CODE = C.PRODUCT_CODE
 WHERE A.CANCELLED = 0) B ON A.CM_ID=B.CM_ID
JOIN PAYMODE_XN_DET C (NOLOCK) ON C.MEMO_ID=A.CM_ID
JOIN PAYMODE_MST E (NOLOCK) ON E.PAYMODE_CODE=C.PAYMODE_CODE
JOIN CUSTDYM D  (NOLOCK) ON A.CUSTOMER_CODE = D.CUSTOMER_CODE
LEFT OUTER JOIN LMV01106 F ON A.AC_CODE = F.AC_CODE   
WHERE A.CANCELLED = 0 
GROUP BY A.CUSTOMER_CODE, D.USER_CUSTOMER_CODE, D.CUSTOMER_TITLE, D.CUSTOMER_FNAME, D.CUSTOMER_LNAME,
		 A.CM_NO, A.CM_ID, A.CM_DT, /*LEFT(A.CM_NO,2)*//*Rohit 01-11-2024*/A.location_Code ,A.NET_AMOUNT,F.AC_NAME
HAVING SUM(CASE WHEN E.PAYMODE_GRP_CODE IN ('0000001','0000002') OR 
		  (E.PAYMODE_GRP_CODE = '0000003' AND C.PAYMODE_CODE NOT IN ( '0000001', '0000002' )) 
		   THEN AMOUNT ELSE 0 END) <>0

UNION ALL
SELECT A.CUSTOMER_CODE, D.USER_CUSTOMER_CODE, D.CUSTOMER_TITLE, D.CUSTOMER_FNAME, D.CUSTOMER_LNAME,
		'SLS' AS XN_TYPE,
		A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT, 
		A.NET_AMOUNT AS DR_AMOUNT,
		0 AS CR_AMOUNT,
		/*LEFT(A.CM_NO,2)*//*Rohit 01-11-2024*/A.location_Code  AS DEPT_ID, 
		'' AS ADJ_BILL_NO, 
		'BUYER ORDER DELIVERY IN BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' +
		 CAST(A.NET_AMOUNT AS VARCHAR(20) ) AS NARRATION,
		0 AS MEMO_TYPE ,DBO.FN_GETSALEPERSON(A.CM_ID,0) AS SALESPERSON,A.NET_AMOUNT AS BILLAMT,
		0 AS RECAMT
		 
FROM CMM01106 A
JOIN 
(SELECT DISTINCT A.CM_ID FROM CMM01106 A JOIN  CMD01106 B (NOLOCK) ON A.CM_ID = B.CM_ID
JOIN SKU_BO C  (NOLOCK) ON B.PRODUCT_CODE = C.PRODUCT_CODE
WHERE A.CANCELLED = 0) B ON A.CM_ID=B.CM_ID
JOIN CUSTDYM D  (NOLOCK) ON A.CUSTOMER_CODE = D.CUSTOMER_CODE
LEFT OUTER JOIN EMPLOYEE EMP ON DBO.FN_GETSALEPERSON(A.CM_ID,0) = EMP.EMP_CODE
LEFT OUTER JOIN LMV01106 E ON A.AC_CODE = E.AC_CODE   
WHERE A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000' AND A.NET_AMOUNT>0
GROUP BY A.CUSTOMER_CODE,EMP.EMP_NAME, D.USER_CUSTOMER_CODE, D.CUSTOMER_TITLE, D.CUSTOMER_FNAME, D.CUSTOMER_LNAME,
		 A.CM_NO, A.CM_ID, A.CM_DT, /*LEFT(A.CM_NO,2)*//*Rohit 01-11-2024*/A.location_Code ,A.NET_AMOUNT

--DEBIT BALANCE FROM CUSTOMER RECEIPT MODULE (HOLD BACK)
UNION ALL
SELECT A.CUSTOMER_CODE AS CUSTOMER_CODE, 
C.USER_CUSTOMER_CODE, 
C.CUSTOMER_TITLE, 
C.CUSTOMER_FNAME, 
C.CUSTOMER_LNAME AS CUSTOMER_LNAME  ,
  'HBD' AS XN_TYPE,   
  A.memo_no AS XN_NO, A.MEMO_ID AS XN_ID, A.MEMO_DT AS XN_DT,   
  A.TOTAL_AMOUNT AS DR_AMOUNT,   
  0 AS CR_AMOUNT,   
  /*LEFT(A.MEMO_ID,2)*//*Rohit 01-11-2024*/A.location_Code  AS DEPT_ID,   
   '' AS ADJ_BILL_NO,   
  'Customer Receipt # ' + A.memo_no + ' DATED: ' + CAST(A.MEMO_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.TOTAL_AMOUNT AS VARCHAR(20) ) AS NARRATION,  
   0 AS MEMO_TYPE  
---ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
,'' AS SALESPERSON,A.TOTAL_AMOUNT AS BILLAMT
,0 AS RECAMT           
FROM HOLD_BACK_DELIVER_MST A  
JOIN CUSTDYM C ON A.CUSTOMER_CODE = C.CUSTOMER_CODE 
WHERE A.TOTAL_AMOUNT <> 0  
and a.entry_mode =2
AND A.CANCELLED = 0  
AND (A.CUSTOMER_CODE <> '000000000000' )
Union all

SELECT A.CUSTOMER_CODE AS CUSTOMER_CODE, 
	b.USER_CUSTOMER_CODE, 
	b.CUSTOMER_TITLE, 
	b.CUSTOMER_FNAME, 
	b.CUSTOMER_LNAME AS CUSTOMER_LNAME ,
  'OC' AS XN_TYPE,   
  A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,  
  0 AS DR_AMOUNT,   
  A.AMOUNT AS CR_AMOUNT,   
  /*LEFT(A.ADV_REC_NO,2)*//*Rohit 01-11-2024*/A.location_Code  AS DEPT_ID,   
  '' AS ADJ_BILL_NO,
  'RECEIPT# ' + A.ADV_REC_NO + ' DATED: ' + CAST(A.ADV_REC_DT AS VARCHAR(50)) + ' AMT: ' + CAST( A.AMOUNT AS VARCHAR(20) ) AS NARRATION,
  0 AS MEMO_TYPE   
,E.EMP_NAME AS SALESPERSON,CONVERT(NUMERIC(18,2),0) AS BILLAMT
,0 AS RECAMT      
FROM ARC01106 A  
JOIN EMPLOYEE E ON A.EMP_CODE=E.EMP_CODE  
JOIN CUSTDYM b ON A.CUSTOMER_CODE = b.CUSTOMER_CODE 
JOIN HBD_RECEIPT HR (NOLOCK) ON HR.ADV_REC_ID =A.ADV_REC_ID 
WHERE A.arc_type =1 and arct=3  AND A.CANCELLED =0 




UNION ALL

SELECT A.CUSTOMER_CODE, D.USER_CUSTOMER_CODE, D.CUSTOMER_TITLE, D.CUSTOMER_FNAME, D.CUSTOMER_LNAME,
		'SLS' AS XN_TYPE,
		A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT, 
		0 AS DR_AMOUNT,
		A.NET_AMOUNT AS CR_AMOUNT,
		/*LEFT(A.CM_NO,2)*//*Rohit 01-11-2024*/A.location_Code  AS DEPT_ID, 
		'' AS ADJ_BILL_NO, 
		'BUYER ORDER DELIVERY IN BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' +
		 CAST(A.NET_AMOUNT AS VARCHAR(20) ) AS NARRATION,
		0 AS MEMO_TYPE ,DBO.FN_GETSALEPERSON(A.CM_ID,0) AS SALESPERSON,A.NET_AMOUNT AS BILLAMT,
		0 AS RECAMT
		 
FROM CMM01106 A
JOIN 
(
	SELECT A.CM_ID,
		SR=ROW_NUMBER() OVER(PARTITION BY A.CM_ID ORDER BY B.ROW_ID)
	FROM CMM01106 A (NOLOCK) 
	JOIN CMD01106 B (NOLOCK) ON A.CM_ID=B.CM_ID
	JOIN VW_BILL_PAYMODE PAY (NOLOCK) ON PAY.MEMO_ID = A.CM_ID AND PAY.XN_TYPE = 'SLS' 
	JOIN WSL_ORDER_DET C (NOLOCK) ON B.rbo_PRODUCT_CODE=C.PRODUCT_CODE --(CASE WHEN C.ORDER_TYPE=0 THEN C.PRODUCT_CODE ELSE C.REF_PRODUCT_CODE END)
	JOIN WSL_ORDER_MST D (NOLOCK) ON D.ORDER_ID=C.ORDER_ID AND A.CUSTOMER_CODE=D.CUSTOMER_CODE
	WHERE A.CANCELLED=0 AND D.CANCELLED=0 AND A.CM_ID<>''
	--AND (ISNULL(cn_amount,0)+ISNULL(ADVANCE_AMOUNT_ADJUSTED,0)+ISNULL(CREDIT_AMOUNT,0)+ISNULL(CREDIT_REFUND_AMOUNT,0))<>0
) B ON A.CM_ID=B.CM_ID AND SR=1
JOIN CUSTDYM D  (NOLOCK) ON A.CUSTOMER_CODE = D.CUSTOMER_CODE
WHERE A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000' AND A.NET_AMOUNT>0


  
---- DELIVERY OF BUYERS ITEMS IN CASHMEMO  
--UNION ALL  
--SELECT (CASE WHEN A.CUSTOMER_CODE= '000000000000' THEN A.AC_CODE ELSE A.CUSTOMER_CODE END) AS CUSTOMER_CODE, 
-- D.USER_CUSTOMER_CODE, D.CUSTOMER_TITLE, D.CUSTOMER_FNAME, 
--(CASE WHEN A.CUSTOMER_CODE= '000000000000' THEN E.AC_NAME ELSE D.CUSTOMER_LNAME  END) AS CUSTOMER_LNAME  ,  
--  'WLD' AS XN_TYPE,  
--  A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT,   
--  0 AS DR_AMOUNT,  
--  (A.CASH_AMOUNT+A.CC_AMOUNT+A.CHQ_AMOUNT) AS CR_AMOUNT, AS CR_AMOUNT,  
--  LEFT(A.CM_NO,2) AS DEPT_ID,   
--   '' AS ADJ_BILL_NO,   
--  '' AS EMP_NAME,  
--  'WLD DELIVERY IN BILL# ' + A.CM_NO + ' DATED: ' + CAST(A.CM_DT AS VARCHAR(50)) + ' AMT: ' + CAST( SUM(B.MRP*B.QUANTITY) AS VARCHAR(20) ) AS NARRATION,  
--   0 AS MEMO_TYPE  
-----ADDED SALES PERSON NAME, BILL AMOUNT FOR CUSTOMER TRANSACTION REPORT
--,DBO.FN_GETSALEPERSON(A.CM_ID,0) AS SALESPERSON,A.NET_AMOUNT AS BILLAMT
--,0 AS RECAMT   
--FROM CMM01106 A  
--JOIN CMD01106 B (NOLOCK) ON A.CM_ID = B.CM_ID  
--JOIN SKU_BO C  (NOLOCK) ON B.PRODUCT_CODE = C.PRODUCT_CODE  
--JOIN CUSTDYM D  (NOLOCK) ON A.CUSTOMER_CODE = D.CUSTOMER_CODE  
--LEFT OUTER JOIN LMV01106 E ON A.AC_CODE = E.AC_CODE 
--WHERE A.CM_MODE = 1   
--AND A.CANCELLED = 0   
--AND (A.CUSTOMER_CODE <> '000000000000' OR A.AC_CODE <> '0000000000')
--GROUP BY (CASE WHEN A.CUSTOMER_CODE= '000000000000' THEN A.AC_CODE ELSE A.CUSTOMER_CODE END) , 
--D.USER_CUSTOMER_CODE, D.CUSTOMER_TITLE, D.CUSTOMER_FNAME,
-- (CASE WHEN A.CUSTOMER_CODE= '000000000000' THEN E.AC_NAME ELSE D.CUSTOMER_LNAME  END),  
--A.CM_NO, A.CM_ID, A.CM_DT, LEFT(A.CM_NO,2)  
--,DBO.FN_GETSALEPERSON(A.CM_ID,0),A.NET_AMOUNT,A.ATD_CHARGES
