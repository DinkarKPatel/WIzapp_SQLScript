create PROCEDURE SP3S_B2C_GSTR--(LocId 3 digit change by Sanjay:06-11-2024)
(
  @DFMDATE DATETIME='',
  @DTODATE DATETIME='',
  @CGSTN_NO VARCHAR(100)='',
  @CLOC_TYPE INT=0,--0 FOR ALL 1 FOR ONLY COMPANY OWNED,
  @CDEPT_ID VARCHAR(4)='',
  @BCALLEDFORGSTR9 BIT=0
  
)
AS
BEGIN
        IF OBJECT_ID ('TEMPDB..#TMP_DO_NOT_CONSIDER_FOR_GSTRREPS','U') is  null
	 SELECT A.user_code INTO #TMP_DO_NOT_CONSIDER_FOR_GSTRREPS FROM USERS A
	 WHERE ISNULL(DO_NOT_CONSIDER_FOR_GSTRREPS,0)=1
     

	   IF OBJECT_ID ('TEMPDB..#TMPSLSCDNUR','U') IS  NULL
          SELECT  CM_ID 
          INTO #TMPSLSCDNUR
          FROM  CMM01106 A (NOLOCK)
          JOIN CUSTDYM B (NOLOCK) ON A.CUSTOMER_CODE =B.CUSTOMER_CODE 
          JOIN LOCATION SL ON SL.DEPT_ID =a.location_code
		  LEFT JOIN #TMP_DO_NOT_CONSIDER_FOR_GSTRREPS U ON A.USER_CODE =U.user_code
          WHERE CANCELLED=0 AND ISNULL(A.Party_Gst_No,'')='' 
          AND NET_AMOUNT <0
          AND ABS(NET_AMOUNT)>=(CASE WHEN A.CM_DT >='2024-09-01' THEN 100000 ELSE  250000 END)
          AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
          AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
          AND (@CGSTN_NO='' OR SL.LOC_GST_NO=@CGSTN_NO)
          AND (@CLOC_TYPE=0 OR ISNULL(SL.LOC_TYPE,0) =@CLOC_TYPE)
		  AND ISNULL(A.Party_Gst_No,'')=''
		  AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID)
          and a.party_state_code <>sl.gst_state_code 
		  AND U.user_code IS NULL

	  DECLARE @TBLB2BCMM TABLE (MEMO_ID VARCHAR(100),XN_TYPE VARCHAR(20),PLACE_OF_SUPPLY VARCHAR(1000))
	
      INSERT INTO @TBLB2BCMM(MEMO_ID,XN_TYPE,PLACE_OF_SUPPLY)
       SELECT A.CM_ID,'SLS' AS XN_TYPE,
            CS.GST_STATE_CODE+'-'+CS.GST_STATE_NAME  AS PLACE_OF_SUPPLY
     FROM CMM01106 A (NOLOCK)
     LEFT OUTER JOIN #TMPSLSCDNUR TMP ON TMP.CM_ID =A.CM_ID 
     JOIN CUSTDYM CUST (NOLOCK) ON A.CUSTOMER_CODE =CUST.CUSTOMER_CODE
     JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_Code
     JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE
     LEFT JOIN GST_STATE_MST CS (NOLOCK)  ON A.PARTY_STATE_CODE =CS.GST_STATE_CODE
	 LEFT JOIN #TMP_DO_NOT_CONSIDER_FOR_GSTRREPS U ON A.USER_CODE =U.user_code
     WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
     AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
     AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
     AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
     AND TMP.CM_ID IS NULL
	 AND ISNULL(A.Party_Gst_No,'')=''
	 AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID)
	 AND U.user_code IS NULL
     AND A.SUPPLY_TYPE_CODE NOT IN('EXPWP','EXPWOP')  
  
	 DECLARE @TBLB2CL TABLE (MEMO_ID VARCHAR(100),SR INT,RTYPE VARCHAR(10),XN_TYPE VARCHAR(100),INVOICE_NO VARCHAR(60),
                          INVOICE_DT VARCHAR(15),INVOICE_VALUE NUMERIC(12,2),PLACE_OF_SUPPLY VARCHAR(200),
						  E_COMMERCE_GSTIN VARCHAR(100),RATE NUMERIC(8,2),TAXABLE_VALUE NUMERIC(12,2),
						  CESS_AMOUNT NUMERIC(8,2),location_code varchar(4),
						  CGST_AMOUNT NUMERIC(12,2),SGST_AMOUNT NUMERIC(12,2),IGST_AMOUNT NUMERIC(12,2))
      
     
    INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,CGST_AMOUNT,SGST_AMOUNT,IGST_AMOUNT ) 
     SELECT A.CM_ID,a.location_code,
            SR=CAST(1 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'SLS' AS XN_TYPE,
            CAST(A.CM_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.CM_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            B.PLACE_OF_SUPPLY,
            A.OTHER_CHARGES_GST_PERCENTAGE AS RATE,
            ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE  ,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            0 AS CESS_AMOUNT ,
			A.OTHER_CHARGES_CGST_AMOUNT,A.OTHER_CHARGES_SGST_AMOUNT,A.OTHER_CHARGES_IGST_AMOUNT
     FROM CMM01106 A (NOLOCK)
     JOIN @TBLB2BCMM B ON A.cm_id =B.MEMO_ID 
     WHERE  ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
     
	  INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,CGST_AMOUNT,SGST_AMOUNT,IGST_AMOUNT ) 
     SELECT A.CM_ID,a.location_code,
            SR=CAST(1 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'SLS' AS XN_TYPE,
            CAST(A.CM_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.CM_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            B.PLACE_OF_SUPPLY,
            CMD.gst_percentage  AS RATE,
            ISNULL(CMD.XN_VALUE_WITHOUT_GST,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            cmd.Gst_cess_amount AS CESS_AMOUNT ,
			CMD.CGST_AMOUNT,CMD.SGST_AMOUNT,CMD.IGST_AMOUNT
     FROM CMM01106 A (NOLOCK)
	 JOIN @TBLB2BCMM B ON A.cm_id =B.MEMO_ID 
     JOIN CMD01106  CMD (NOLOCK) ON A.CM_ID =CMD.CM_ID 
   
   
      DECLARE @TBLB2BMEMO TABLE (MEMO_ID VARCHAR(100),XN_TYPE VARCHAR(20),PLACE_OF_SUPPLY VARCHAR(100))
     
      INSERT INTO @TBLB2BMEMO(MEMO_ID,XN_TYPE,PLACE_OF_SUPPLY)
       SELECT A.INV_ID,
           'WSL' AS XN_TYPE,
            C.GST_STATE_CODE+'-'+C.GST_STATE_NAME  AS PLACE_OF_SUPPLY
      FROM INM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_Code
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 
      JOIN GST_STATE_MST C (NOLOCK)  ON A.PARTY_STATE_CODE  =C.GST_STATE_CODE
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND ISNULL(LMP.AC_GST_NO,'')=''
      AND ISNULL(LMP.AC_GST_NO,'')<>ISNULL(B.LOC_GST_NO,'')
      AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID) and a.XN_ITEM_TYPE <>5
	  AND A.SUPPLY_TYPE_CODE NOT IN('EXPWP','EXPWOP')
	  AND A.INV_MODE =1
	  
	  INSERT INTO @TBLB2BMEMO(MEMO_ID,XN_TYPE,PLACE_OF_SUPPLY)
	  select  a.INV_ID ,
	          'WSL' XN_TYPE,
	           C.GST_STATE_CODE+'-'+C.GST_STATE_NAME AS PLACE_OF_SUPPLY
	   FROM INM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_Code
      JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      JOIN GST_STATE_MST C (NOLOCK)  ON A.PARTY_STATE_CODE  =C.GST_STATE_CODE
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND ISNULL(TL.LOC_GST_NO,'')=''
      AND ISNULL(TL.LOC_GST_NO,'')<>ISNULL(B.LOC_GST_NO,'')
	  AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID) and a.XN_ITEM_TYPE <>5
	  AND A.SUPPLY_TYPE_CODE NOT IN('EXPWP','EXPWOP')
	  AND A.INV_MODE <>1
    
     
     ---WSL UN REGISTER DELER---
     
    INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,
				   CGST_AMOUNT,SGST_AMOUNT,IGST_AMOUNT) 
       SELECT A.INV_ID,a.location_code,
            SR=CAST(3 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'WSL' AS XN_TYPE,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,
            A.OTHER_CHARGES_GST_PERCENTAGE AS RATE,
            ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE  ,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            0 AS CESS_AMOUNT  ,
			A.OTHER_CHARGES_CGST_AMOUNT,A.OTHER_CHARGES_SGST_AMOUNT,A.OTHER_CHARGES_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN @TBLB2BMEMO B  ON  a.inv_id =b.memo_id
      WHERE  ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE ,0)<>0
	 
      
      INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,
				   CGST_AMOUNT,SGST_AMOUNT,IGST_AMOUNT) 
      
       SELECT A.INV_ID,a.location_code,
            SR=CAST(3 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'WSL' AS XN_TYPE,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,
            A.FREIGHT_GST_PERCENTAGE AS RATE,
            ISNULL(A.FREIGHT_TAXABLE_VALUE   ,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            0 AS CESS_AMOUNT  ,
			A.FREIGHT_CGST_AMOUNT,A.FREIGHT_SGST_AMOUNT,A.FREIGHT_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN @TBLB2BMEMO B  ON  a.inv_id =b.memo_id
      WHERE  ISNULL(A.FREIGHT_TAXABLE_VALUE,0)<>0
    
	 
      
       INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,
				   CGST_AMOUNT,SGST_AMOUNT,IGST_AMOUNT) 
      SELECT A.INV_ID,a.location_code,
            SR=CAST(3 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'WSL' AS XN_TYPE,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,
            A.INSURANCE_GST_PERCENTAGE AS RATE,
            ISNULL(A.INSURANCE_TAXABLE_VALUE  ,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            0 AS CESS_AMOUNT,
			A.INSURANCE_CGST_AMOUNT,A.INSURANCE_SGST_AMOUNT,A.INSURANCE_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN @TBLB2BMEMO B  ON  a.inv_id =b.memo_id
      WHERE  ISNULL(A.INSURANCE_TAXABLE_VALUE,0)<>0
    
       
       INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,
				   CGST_AMOUNT,SGST_AMOUNT,IGST_AMOUNT) 

      SELECT A.INV_ID,a.location_code,
      SR=CAST(3 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'WSL' AS XN_TYPE,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,
            A.PACKING_GST_PERCENTAGE AS RATE,
            ISNULL(A.PACKING_TAXABLE_VALUE   ,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            0 AS CESS_AMOUNT ,
			A.PACKING_CGST_AMOUNT,A.PACKING_SGST_AMOUNT,A.PACKING_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN @TBLB2BMEMO B  ON  a.inv_id =b.memo_id
      WHERE ISNULL(A.PACKING_TAXABLE_VALUE,0)<>0
     
      
        INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,
				   CGST_AMOUNT,SGST_AMOUNT,IGST_AMOUNT) 
      SELECT A.INV_ID,a.location_code,
            SR=CAST(3 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'WSL' AS XN_TYPE,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,
            IND.gst_percentage  AS RATE,
            ISNULL(IND.XN_VALUE_WITHOUT_GST,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            IND.Gst_cess_amount AS CESS_AMOUNT,
			IND.CGST_AMOUNT,IND.SGST_AMOUNT,IND.IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
	  JOIN @TBLB2BMEMO B  ON  a.inv_id =b.memo_id
      JOIN ind01106 IND (nolock) ON A.INV_ID =IND.INV_ID 
    

	
	  --B2CS WHOSALE CREDIT NOTE

	  DECLARE @TBLB2BCNM TABLE (MEMO_ID VARCHAR(100),XN_TYPE VARCHAR(20),PLACE_OF_SUPPLY VARCHAR(100))
	
      INSERT INTO @TBLB2BCNM(MEMO_ID,XN_TYPE,PLACE_OF_SUPPLY)
	   SELECT A.CN_ID,'WSR' AS XN_TYPE ,
            CASE WHEN A.MODE=1 THEN LMPS.GST_STATE_CODE+'-'+LMPS.GST_STATE_NAME ELSE  RMLS.GST_STATE_CODE+'-'+RMLS.GST_STATE_NAME END AS PLACE_OF_SUPPLY      
	   FROM CNM01106 A (NOLOCK)
       JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_Code
	   JOIN GST_STATE_MST LS (NOLOCK)  ON LS.GST_STATE_CODE  =B.GST_STATE_CODE
	   LEFT OUTER JOIN LMP01106 LMP (NOLOCK)  ON LMP.AC_CODE =A.AC_CODE
       LEFT JOIN GST_STATE_MST LMPS (NOLOCK)  ON LMPS.GST_STATE_CODE  =A.PARTY_STATE_CODE
	   LEFT OUTER JOIN LOCATION RML (NOLOCK) ON RML.DEPT_ID =A.PARTY_DEPT_ID 
	   LEFT JOIN GST_STATE_MST RMLS (NOLOCK)  ON RMLS.GST_STATE_CODE  =RML.GST_STATE_CODE
       WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
	   AND A.RECEIPT_DT BETWEEN @DFMDATE AND @DTODATE
	   AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
	   AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
	    AND  ISNULL(CASE WHEN A.MODE=1 THEN  LMP.AC_GST_NO ELSE  ISNULL(RML.LOC_GST_NO,'') END,'') =''
       AND ISNULL(CASE WHEN A.MODE=1 THEN  LMP.AC_GST_NO ELSE ISNULL(RML.LOC_GST_NO,'') END,'')<> B.LOC_GST_NO
	   AND (A.TOTAL_AMOUNT<(CASE WHEN A.receipt_dt  >='2024-09-01' THEN 100000 ELSE  250000 END) or 
	   (A.TOTAL_AMOUNT>=(CASE WHEN A.receipt_dt  >='2024-09-01' THEN 100000 ELSE  250000 END) and a.party_state_code =b.gst_state_code ))
	   AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID)


	  
    INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,
				    CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT) 
	     SELECT 
             A.CN_ID,a.location_code,
             SR=CAST(4 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'WSR' AS XN_TYPE ,
            CAST(A.CN_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.CN_DT,106),' ','-')  AS INVOICE_DATE,
            A.TOTAL_AMOUNT   AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,
            ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0) AS RATE,
            -(1)*ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            0 AS CESS_AMOUNT  ,
			A.OTHER_CHARGES_CGST_AMOUNT,A.OTHER_CHARGES_SGST_AMOUNT,A.OTHER_CHARGES_IGST_AMOUNT
       FROM CNM01106 A (NOLOCK)
       JOIN @TBLB2BCNM B  on a.cn_id =B.MEMO_ID 
	   where ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0) <>0
    
     INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,
				    CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT) 
       SELECT 
             A.CN_ID,a.location_code,
             SR=CAST(4 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'WSR' AS XN_TYPE ,
            CAST(A.CN_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.CN_DT,106),' ','-')  AS INVOICE_DATE,
            A.TOTAL_AMOUNT   AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,
            ISNULL(A.FREIGHT_GST_PERCENTAGE,0) AS RATE,
            -(1)*ISNULL(A.FREIGHT_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            0 AS CESS_AMOUNT,
			A.FREIGHT_CGST_AMOUNT,A.FREIGHT_SGST_AMOUNT,A.FREIGHT_IGST_AMOUNT
       FROM CNM01106 A (NOLOCK)
       JOIN @TBLB2BCNM B  on a.cn_id =B.MEMO_ID 
       WHERE ISNULL(A.FREIGHT_TAXABLE_VALUE,0)>0
   
       INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,
				    CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT) 
       SELECT 
              A.CN_ID,a.location_code,
             SR=CAST(4 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'WSR' AS XN_TYPE ,
            CAST(A.CN_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.CN_DT,106),' ','-')  AS INVOICE_DATE,
            A.TOTAL_AMOUNT   AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,
            ISNULL(A.INSURANCE_GST_PERCENTAGE,0) AS RATE,
            -(1)*ISNULL(A.INSURANCE_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            0 AS CESS_AMOUNT,
			A.INSURANCE_CGST_AMOUNT,A.INSURANCE_SGST_AMOUNT,A.INSURANCE_IGST_AMOUNT
       FROM CNM01106 A (NOLOCK)
       JOIN @TBLB2BCNM B  on a.cn_id =B.MEMO_ID 
      WHERE  ISNULL(A.INSURANCE_TAXABLE_VALUE,0)<>0

      INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,
				    CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT) 
      SELECT 
             A.CN_ID,a.location_code,
             SR=CAST(4 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'WSR' AS XN_TYPE ,
            CAST(A.CN_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.CN_DT,106),' ','-')  AS INVOICE_DATE,
            A.TOTAL_AMOUNT   AS INVOICE_VALUE,
            b.PLACE_OF_SUPPLY,
            CND.RATE AS RATE,
            -(1)*ISNULL(CND.XN_VALUE_WITHOUT_GST,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            CND.Gst_cess_amount AS CESS_AMOUNT,
			CND.CGST_AMOUNT,CND.SGST_AMOUNT,CND.IGST_AMOUNT
       FROM CNM01106 A (NOLOCK)
       JOIN @TBLB2BCNM B  on a.cn_id =B.MEMO_ID 
       JOIN cnd01106 CND (nolock) ON A.CN_ID =CND.CN_ID 
	  

	  INSERT INTO @TBLB2CL(MEMO_ID,location_code,SR ,RTYPE,XN_TYPE  ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                   RATE,TAXABLE_VALUE, E_COMMERCE_GSTIN   ,CESS_AMOUNT,
				   CGST_AMOUNT,SGST_AMOUNT,IGST_AMOUNT)  
	  SELECT  b.ADV_REC_ID,b.location_code,
             SR=CAST(4 AS INT),
            CAST('B2CL' AS VARCHAR(100)) AS RTYPE,
            'ARC' AS XN_TYPE ,
            CAST(b.adv_rec_no   AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),b.adv_rec_dt,106),' ','-')  AS INVOICE_DATE,
            b.net_amount   AS INVOICE_VALUE,
             CusGST.GST_STATE_CODE+'-'+CusGST.GST_STATE_NAME  AS PLACE_OF_SUPPLY,
            b.gst_percentage  AS RATE,
            ISNULL(b.TAXABLE_VALUE,0) AS TAXABLE_VALUE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            0 AS CESS_AMOUNT,
			b.CGST_AMOUNT,b.SGST_AMOUNT,b.IGST_AMOUNT
      FROM ARC01106   B (NOLOCK) 
	  JOIN LOCATION C (NOLOCK) ON C.DEPT_ID =b.location_Code
      JOIN CUSTDYM CUST (NOLOCK) ON CUST.CUSTOMER_CODE =B.CUSTOMER_CODE 
      LEFT JOIN GST_STATE_MST CusGST (NOLOCK) ON CusGST.GST_STATE_CODE =B.PARTY_STATE_CODE  
      WHERE B.CANCELLED =0  AND B.arc_type =1 AND B.arct =3
      AND b.adv_rec_dt   BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR C.LOC_GST_NO=@CGSTN_NO)
      AND (@CLOC_TYPE=0 OR ISNULL(C.LOC_TYPE,0) =@CLOC_TYPE)
      AND (ISNULL(B.CGST_AMOUNT ,0)+ ISNULL(B.SGST_AMOUNT ,0)+ ISNULL(B.IGST_AMOUNT ,0))<>0
      AND (@CDEPT_ID='' OR b.location_code=@CDEPT_ID)


	
      

	  IF ISNULL(@BCALLEDFORGSTR9,0)=1
	  BEGIN
	       IF OBJECT_ID ('TEMPDB..##B2C','U') IS NOT NULL 
		   DROP TABLE ##B2C

		 SELECT * INTO ##B2C FROM @TBLB2CL
		 RETURN
	  END
	  
	 
     
     SELECT RTYPE, INVOICE_NO AS [INVOICE NUMBER],
            INVOICE_DT AS [INVOICE DATE],
            INVOICE_VALUE AS [INVOICE VALUE] ,
            PLACE_OF_SUPPLY AS [PLACE OF SUPPLY] ,
            CAST('' AS VARCHAR(100)) as [Applicable % of Tax Rate],
            RATE AS RATE, 
            SUM(TAXABLE_VALUE) AS [TAXABLE VALUE] ,
            SUM(CESS_AMOUNT) AS [CESS AMOUNT],
            E_COMMERCE_GSTIN AS [E-COMMERCE GSTIN]
     FROM @TBLB2CL A
     JOIN LOCATION L (NOLOCK) ON L.DEPT_ID =a.location_code
     WHERE ABS(INVOICE_VALUE)>=(CASE WHEN cast(A.INVOICE_DT as dateTime)   >='2024-09-01' THEN 100000 ELSE  250000 END)
     AND LEFT(PLACE_OF_SUPPLY,2)<>L.GST_STATE_CODE 
     GROUP BY RTYPE, INVOICE_NO ,
     INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY  ,
     RATE ,E_COMMERCE_GSTIN
     ORDER BY  INVOICE_DT,INVOICE_NO 
     
      SELECT 'B2CL' AS RTYPE,
             0 AS [NO. OF INVOICES],
             0 AS [TOTAL INV VALUE] ,
             0 AS [TOTAL TAXABLE VALUE] ,
             0 AS [TOTAL CESS] 
     
    --  SELECT * INTO TBLB2CL FROM @TBLB2CL
     
     SELECT  'B2CS' AS RTYPE,'OE' AS TYPE,
              PLACE_OF_SUPPLY AS [PLACE OF SUPPLY],
              CAST('' AS VARCHAR(100)) as [Applicable % of Tax Rate],
              RATE AS RATE,
              SUM(TAXABLE_VALUE) AS [TAXABLE VALUE] ,
              SUM(CESS_AMOUNT) AS [CESS AMOUNT],
              E_COMMERCE_GSTIN AS [E-COMMERCE GSTIN]
     FROM @TBLB2CL A
     JOIN LOCATION L (NOLOCK) ON L.DEPT_ID =a.location_code
     WHERE 
     ( ABS(INVOICE_VALUE)<(CASE WHEN cast(A.INVOICE_DT as dateTime) >='2024-09-01' THEN 100000 ELSE  250000 END) or (  LEFT(PLACE_OF_SUPPLY,2)=L.GST_STATE_CODE ))
     GROUP BY PLACE_OF_SUPPLY ,RATE ,  E_COMMERCE_GSTIN 
     ORDER BY  PLACE_OF_SUPPLY ,RATE
      SELECT 'B2CS' AS RTYPE,
             0 AS [NO. OF INVOICES],
             0 AS [TOTAL INV VALUE] ,
             0 AS [TOTAL TAXABLE VALUE] ,
             0 AS [TOTAL CESS] 
    

END

