CREATE PROCEDURE SP_SEND_MIRROR_MSTUSR_OPTIMIZED --(LocId 3 digit change by Sanjay:30-10-2024)
(
	@CTARGETLOCID VARCHAR(5)='',
	@CLOCUSRMSTLASTUPDATE VARCHAR(50)=''
)
--WITH ENCRYPTION
AS
BEGIN
  DECLARE @CCMD NVARCHAR(MAX)=''

  BEGIN TRY
		--INSERT CALL_WC (SP_NAME, CUSTOMER_CODE,PARA_EXPR, LAST_UPDATE) SELECT 'SP_SEND_MIRROR_MSTUSR' AS SP_NAME,'',STR(@NAPIVERSION) ,GETDATE()
		DECLARE @CERRORMSG VARCHAR(1000),@CCURDEPTID VARCHAR(4),@CHODEPTID VARCHAR(4),
				@CXNMASTERTABLENAME VARCHAR(100),@BPROCEED BIT,@CTABLENAME VARCHAR(100),@CMASTERKEYFIELD VARCHAR(100),
				@CKEYFIELD VARCHAR(100),@CPARENTTABLENAME VARCHAR(100),@CPARENTPARANAME VARCHAR(100),@CCHILDPARANAME VARCHAR(100),
				@CWHERECLAUSE VARCHAR(100),@CJOINSTR VARCHAR(1000),@CMEMOID VARCHAR(100),@CFINYEAR VARCHAR(100),
				@NGRPCHARS INT,@NSERIESCHARS INT,@BSERIESBROKEN BIT,@CPREVMEMOID VARCHAR(40),@CMERGETABLENAME VARCHAR(50),
				@CFIRSTMEMOID VARCHAR(40),@NPREVMEMOID INT,@NMEMONOLEN INT,@CRETCMD NVARCHAR(MAX),
				@CDELCHILDTABLENAME VARCHAR(100),@CDELCHILDPARANAME VARCHAR(100),@CDELPARENTPARANAME VARCHAR(100),
				@CORIGINALTABLENAME VARCHAR(100),@NLOCTYPE INT,@BDONOTMERGE BIT,@CRFXNTYPE VARCHAR(10),@BHOLOC BIT,
				@BINSERTONLY BIT,@BLINKEDMASTER BIT,@BPURLOC BIT,@CSOURCELOCID VARCHAR(4),@BSOURCEPURLOC BIT,
				@CMISSINGMEMOID VARCHAR(40),@CGRPCODE VARCHAR(20),@BRETVAL BIT,@NPREVNO INT,@CPREVNO VARCHAR(20),
				@BEMPHEADSUPDATED BIT,@CFILTERCONDITION VARCHAR(100),@CTABLEPREFIX VARCHAR(100),@CXNTYPE VARCHAR(10),
				@NXNSMERGINGORDER INT,@NSTEP INT,@CKEYFIELD2 VARCHAR(100),@CTMP_TABLENAME VARCHAR(500),
				@CSOURCEDB VARCHAR(200),@CHOUSRMSTLASTUPDATE VARCHAR(50),@CTEMPDBNAME VARCHAR(500),
				@CSLSSETLUPD VARCHAR(50),@CTEMPTABLENAME VARCHAR(500),@NSPID INT,@CSPID VARCHAR(5),@DTSQL NVARCHAR(MAX)
				,@CDEPTID VARCHAR(5)--01 FEB 2018
		
		SET @CDEPTID=@CTARGETLOCID--01 FEB 2018
		SET @CCMD=''
		SET @NSTEP=10	
		
		SET @NSPID=@@SPID
		
		SET @CSPID=LTRIM(RTRIM(LTRIM(RTRIM(STR(@NSPID)))))
				
		SET @CSOURCEDB=''
		
		DECLARE @TRETMSG TABLE (MEMO_ID VARCHAR(40),ERRMSG VARCHAR(MAX))

		SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
		SELECT @CHODEPTID  = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
		
		IF @CCURDEPTID<>@CHODEPTID
		   BEGIN
			  SELECT TOP 1 @CSLSSETLUPD=VALUE FROM CONFIG WHERE CONFIG_OPTION='MSTUSRROLE_LAST_UPDATE' 

			  SET @CSLSSETLUPD=ISNULL(@CSLSSETLUPD,'')
			  SELECT @CSLSSETLUPD AS LAST_UPDATE,'' AS ERRMSG
			  GOTO END_PROC
		   END	
		ELSE
		   BEGIN
			  IF @CHODEPTID=@CTARGETLOCID
					SET @CTARGETLOCID=''
			  		
			  SET @CSPID=(CASE WHEN @CTARGETLOCID='' THEN LTRIM(RTRIM(STR(@@SPID))) ELSE @CTARGETLOCID END) 
			  
			  PRINT '@CSPID - '+@CSPID
			  
			  SELECT @CHOUSRMSTLASTUPDATE=CONVERT(VARCHAR(20),MAX(LAST_UPDATE)) 
			  FROM 
			  (
			    SELECT MAX(LAST_UPDATE) AS LAST_UPDATE,'' AS ERRMSG FROM USER_ROLE_DET WITH (NOLOCK)
			    UNION
			    SELECT MAX(LAST_UPDATE) AS LAST_UPDATE,'' AS ERRMSG FROM USERS WITH (NOLOCK)
			    UNION
			    SELECT MAX(LAST_UPDATE) AS LAST_UPDATE,'' AS ERRMSG FROM EMPLOYEE WITH (NOLOCK)			
			  ) A

			  IF ISNULL(@CLOCUSRMSTLASTUPDATE,'')=ISNULL(@CHOUSRMSTLASTUPDATE,'')
			     BEGIN
				   SET @CERRORMSG='NO NEW USERS & PERMISSION DATA FOUND FOR THE LOCATION ID :'+@CTARGETLOCID
				   PRINT 'END_PROC'
				   GOTO END_PROC		
			     END	
		   END	
							
		SELECT @CERRORMSG='',@BPROCEED=1,@NMEMONOLEN=10,@CRETCMD='',@CMEMOID='',@CXNTYPE='MSTUSRROLE',@BEMPHEADSUPDATED=0
		
		SET @NSTEP=20
		
		IF @CCURDEPTID=@CHODEPTID
			SET @BHOLOC=1
				
		SELECT @NLOCTYPE=LOC_TYPE,@BPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID
		
		SET @NSTEP=30		
								
	
LBLMERGE:
		IF ISNULL(@CTARGETLOCID,'')<>''
		BEGIN
			IF NOT EXISTS(SELECT TOP 1 'U' FROM LOCUSERS WHERE DEPT_ID=@CTARGETLOCID)
			BEGIN
				SET @CERRORMSG='NO USER ATTACH WITH THIS LOCATION ID :'+@CTARGETLOCID
				PRINT 'END_PROC'
				GOTO END_PROC	
			END
		END
		
		DECLARE @CTMPLOCUSERSTABLENAME VARCHAR(500),@CTMPUSERTABLENAME VARCHAR(500),@CTMPUSERROLETABLENAME VARCHAR(500),
				@CTMPBINUSERTABLENAME VARCHAR(500)
				
		
		SET @NSTEP=42		
		SET @CTABLENAME='LOCUSERS'
		IF ISNULL(@CTARGETLOCID,'') <> ''
			SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD',@CKEYFIELD='USER_CODE',@CJOINSTR = ''
			,@CFILTERCONDITION=' DEPT_ID='''+@CTARGETLOCID+'''' 
	    ELSE
	       SELECT @CTEMPTABLENAME='MSTUSRROLE_'+@CTABLENAME+'_UPLOAD' ,@CKEYFIELD='USER_CODE',@CJOINSTR = '',@CFILTERCONDITION = ''
	    
		SET @NSTEP=45		
		SELECT 'MSTUSRROLE_LOCUSERS_MIRROR'  as TARGET_TABLENAME ,* FROM locusers (NOLOCK)
		WHERE dept_id=@CTARGETLOCID
		
		SET @NSTEP=50		
		SELECT 'MSTUSRROLE_USERS_MIRROR'  as TARGET_TABLENAME ,a.* FROM users a (NOLOCK)
		JOIN locusers b (NOLOCK) ON a.user_code=b.user_code	WHERE dept_id=@CTARGETLOCID

		SET @NSTEP=55
		SELECT 'MSTUSRROLE_USER_ROLE_MST_MIRROR'  as TARGET_TABLENAME ,a.* FROM USER_ROLE_MST a (NOLOCK)
		JOIN users b (NOLOCK) ON a.ROLE_ID=b.ROLE_ID
		JOIN locusers c (NOLOCK) ON c.user_code=b.user_code	
		WHERE dept_id=@CTARGETLOCID
		
		SET @NSTEP=70						
		SELECT 'MSTUSRROLE_USER_ROLE_DET_MIRROR'  as TARGET_TABLENAME ,a.* FROM USER_ROLE_DET a (NOLOCK)
		JOIN 
		(SELECT distinct role_id from users b (NOLOCK) 
		JOIN locusers c (NOLOCK) ON c.user_code=b.user_code	
		WHERE dept_id=@CTARGETLOCID
		) b ON a.ROLE_ID=b.ROLE_ID

		SET @NSTEP=75
		SELECT 'MSTUSRROLE_BINUSERS_MIRROR'  as TARGET_TABLENAME ,a.* FROM BINUSERS a (NOLOCK)
		JOIN locusers c (NOLOCK) ON c.user_code=a.user_code	
		WHERE dept_id=@CTARGETLOCID
				
		SET @NSTEP=80
		SELECT 'MSTUSRROLE_EMPLOYEE_GRP_MIRROR'  as TARGET_TABLENAME ,a.* FROM EMPLOYEE_GRP a (NOLOCK)
		WHERE dept_id=@CTARGETLOCID
		
		SET @NSTEP=85
		SELECT 'MSTUSRROLE_EMP_GRP_LINK_MIRROR'  as TARGET_TABLENAME ,a.* FROM EMP_GRP_LINK a (NOLOCK)
		JOIN EMPLOYEE_GRP c (NOLOCK) ON c.EMP_GRP_CODE=a.EMP_GRP_CODE	
		WHERE dept_id=@CTARGETLOCID

		SET @NSTEP=85
		SELECT 'MSTUSRROLE_EMPLOYEE_MIRROR'  as TARGET_TABLENAME ,a.* FROM EMPLOYEE a (NOLOCK)
		JOIN EMP_GRP_LINK b (NOLOCK) ON b.EMP_CODE=a.emp_code
		JOIN EMPLOYEE_GRP c (NOLOCK) ON c.EMP_GRP_CODE=b.EMP_GRP_CODE	
		WHERE dept_id=@CTARGETLOCID

		SET @NSTEP=90
		SELECT 'MSTUSRROLE_EMPCATEGORY_MIRROR'  as TARGET_TABLENAME ,a.* FROM EMPCATEGORY a (NOLOCK)
		JOIN EMPLOYEE b (NOLOCK) ON b.CATEGORY_CODE=a.CATEGORY_CODE
		JOIN EMP_GRP_LINK c (NOLOCK) ON b.EMP_CODE=c.emp_code
		JOIN EMPLOYEE_GRP d (NOLOCK) ON d.EMP_GRP_CODE=c.EMP_GRP_CODE	
		WHERE dept_id=@CTARGETLOCID

		SET @NSTEP=95
		SELECT 'MSTUSRROLE_BIN_MIRROR'  as TARGET_TABLENAME ,a.* FROM BIN a (NOLOCK)
		JOIN binusers b (NOLOCK) ON b.BIN_ID=a.bin_id
		JOIN locusers c (NOLOCK) ON c.user_code=b.user_code	
		WHERE dept_id=@CTARGETLOCID

		SET @NSTEP=100
		SELECT 'MSTUSRROLE_FIXEDFREEZE_MIRROR'  as TARGET_TABLENAME ,a.* FROM FIXEDFREEZE a (NOLOCK)

		SET @NSTEP=105
		SELECT 'MSTUSRROLE_ROLLINGFREEZE_MIRROR'  as TARGET_TABLENAME ,a.* FROM ROLLINGFREEZE a (NOLOCK)
		JOIN users b (NOLOCK) ON b.role_ID=a.role_id
		JOIN locusers c (NOLOCK) ON c.user_code=b.user_code	
		WHERE dept_id=@CTARGETLOCID

		SET @NSTEP=110
		SELECT 'MSTUSRROLE_REPLOCS_MIRROR'  as TARGET_TABLENAME ,a.* FROM REPLOCS a (NOLOCK)
		WHERE dept_id=@CTARGETLOCID


		-- for new transaction History tables 
		if object_id ('tempdb..#tmpRepmst','u') is not null
		   drop table #tmpRepmst
		
			SELECT Rep_id into #tmpRepmst FROM REP_MST where xn_history=1
			Group by Rep_id
		-- end 

		--for sending Xpert_filter_Mst related repmst ,repdet

			SELECT Rep_id ,dept_id
			into #tmpREPLOCS
			FROM REPLOCS (NOLOCK)
			WHERE dept_id=@CTARGETLOCID
			union 
			select a.rep_id ,@CTARGETLOCID as dept_id
			from Xpert_filter_Mst a (nolock)
			join WOW_Xpert_Rep_Mst_Linked_Filter b (nolock) on a.Filter_id =b.Filter_id 
            union 
			select filter_rep_id,b.dept_id as dept_id from WOW_Xpert_Rep_Mst A
			join REPLOCS b (NOLOCK) on a.rep_id =b.rep_id 
			where filter_rep_id <>'' and b.dept_id =@CTARGETLOCID
		--end


		SET @NSTEP=115
		SELECT distinct  'MSTUSRROLE_REP_MST_MIRROR'  as TARGET_TABLENAME ,a.* FROM REP_mst a (NOLOCK)
		JOIN #tmpREPLOCS b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID
		union 
		SELECT distinct  'MSTUSRROLE_REP_MST_MIRROR'  as TARGET_TABLENAME ,a.* FROM REP_mst a (NOLOCK)
		join #tmpRepmst tmp on a.rep_id =tmp.rep_id
	
		SET @NSTEP=120
		SELECT distinct 'MSTUSRROLE_REP_DET_MIRROR'  as TARGET_TABLENAME ,a.* FROM REP_det a (NOLOCK)
		JOIN #tmpREPLOCS b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID
		union 
		SELECT distinct 'MSTUSRROLE_REP_DET_MIRROR'  as TARGET_TABLENAME ,a.* FROM REP_det a (NOLOCK)
		join #tmpRepmst tmp on a.rep_id =tmp.rep_id

		SET @NSTEP=122
		SELECT distinct 'MSTUSRROLE_REP_DET_XNTYPES_MIRROR'  as TARGET_TABLENAME ,a.* FROM REP_DET_XNTYPES a (NOLOCK)
		JOIN #tmpREPLOCS b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID


		SET @NSTEP=125
		SELECT distinct 'MSTUSRROLE_REP_FILTER_MIRROR'  as TARGET_TABLENAME ,a.* FROM REP_FILTER a (NOLOCK)
		JOIN #tmpREPLOCS b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID
		union
		SELECT distinct 'MSTUSRROLE_REP_FILTER_MIRROR'  as TARGET_TABLENAME ,a.* FROM REP_FILTER a (NOLOCK)
		join #tmpRepmst tmp on a.rep_id =tmp.rep_id


		SET @NSTEP=130
		SELECT distinct 'MSTUSRROLE_REP_FILTER_DET_MIRROR'  as TARGET_TABLENAME ,a.* FROM REP_FILTER_DET a (NOLOCK)
		JOIN #tmpREPLOCS b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID
		union 
		SELECT distinct 'MSTUSRROLE_REP_FILTER_DET_MIRROR'  as TARGET_TABLENAME ,a.* FROM REP_FILTER_DET a (NOLOCK)
		join #tmpRepmst tmp on a.rep_id =tmp.rep_id



		
		SET @NSTEP=135
		SELECT 'MSTUSRROLE_USER_XTREAM_LAYOUT_SETUP_MIRROR'  as TARGET_TABLENAME ,a.* FROM USER_XTREAM_LAYOUT_SETUP a (NOLOCK)


		SET @NSTEP=140

		SELECT distinct  'MSTUSRROLE_wow_xpert_rep_mst_mirror'  as TARGET_TABLENAME ,a.* FROM wow_xpert_rep_mst a (NOLOCK)
		JOIN replocs b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID
		union 
		SELECT distinct  'MSTUSRROLE_wow_xpert_rep_mst_mirror'  as TARGET_TABLENAME ,a.* FROM wow_xpert_rep_mst a (NOLOCK)
		join #tmpRepmst tmp on a.rep_id =tmp.rep_id

	
		SET @NSTEP=150

		SELECT distinct 'MSTUSRROLE_wow_xpert_rep_det_mirror'  as TARGET_TABLENAME ,a.* FROM wow_xpert_rep_det a (NOLOCK)
		JOIN replocs b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID
		union 
		SELECT distinct 'MSTUSRROLE_wow_xpert_rep_det_mirror'  as TARGET_TABLENAME ,a.* FROM wow_xpert_rep_det a (NOLOCK)
		join #tmpRepmst tmp on a.rep_id =tmp.rep_id

		SET @NSTEP=160

		
		SELECT distinct 'MSTUSRROLE_wow_xpert_rep_mst_linked_filter_mirror'  as TARGET_TABLENAME ,a.* FROM wow_xpert_rep_mst_linked_filter a (NOLOCK)
		JOIN replocs b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID
		union 
		SELECT distinct 'MSTUSRROLE_wow_xpert_rep_mst_linked_filter_mirror'  as TARGET_TABLENAME ,a.* FROM wow_xpert_rep_mst_linked_filter a (NOLOCK)
		join #tmpRepmst tmp on a.rep_id =tmp.rep_id

		SET @NSTEP=170

		SELECT distinct 'MSTUSRROLE_Xpert_filter_Mst_mirror'  as TARGET_TABLENAME ,a.* FROM Xpert_filter_Mst a (NOLOCK)
		JOIN replocs b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID
		union 
		SELECT distinct 'MSTUSRROLE_Xpert_filter_Mst_mirror'  as TARGET_TABLENAME ,a.* FROM Xpert_filter_Mst a (NOLOCK)
		JOIN wow_xpert_rep_mst_linked_filter b (nolock) on a.Filter_id = b.Filter_id 
		

		SET @NSTEP=180

		SELECT distinct 'MSTUSRROLE_Rep_Adv_Filter_mirror'  as TARGET_TABLENAME ,a.* FROM Rep_Adv_Filter a (NOLOCK)
		JOIN replocs b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID


		SELECT distinct 'MSTUSRROLE_REP_ADVFILTER_LIST_mirror'  as TARGET_TABLENAME ,a.* FROM REP_ADVFILTER_LIST a (NOLOCK)
		JOIN replocs b (NOLOCK) ON b.rep_ID=a.rep_id
		WHERE dept_id=@CTARGETLOCID
		
		GOTO END_PROC
		
	END TRY

	BEGIN CATCH
		PRINT 'UNTRAPPED ERROR'		
		SELECT @CERRORMSG='PROCEDURE SP_SEND_MIRROR_MSTUSR_OPTIMIZED : STEP: '+STR(@NSTEP)+' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		GOTO END_PROC
	END CATCH

END_PROC:

	SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
END
--- 'END OF CREATING PROCEDURE SP_SEND_MIRROR_MSTUSR_OPTIMIZED
