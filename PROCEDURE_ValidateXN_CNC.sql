CREATE PROCEDURE VALIDATEXN_CNC
(
		@CXNID VARCHAR(40),
		@NUPDATEMODE INT,					
		@CERRORMSG VARCHAR(1000) OUTPUT
		--*** PARAMETERS :
		--*** @CXNID - TRANSACTION ID ( MEMO ID OF MASTER TABLE )
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CITEMNAME NVARCHAR(4000), @NSUMICDNET NUMERIC(10,2), @NSUBTOTAL NUMERIC(10,2)

	DECLARE @CICMTABLE TABLE ( CNC_MEMO_ID VARCHAR(22), CNC_MEMO_NO VARCHAR(10), CNC_MEMO_DT DATETIME, 
							   CNC_TYPE NUMERIC(1), FIN_YEAR VARCHAR(10), CANCELLED BIT, TOTAL_AMOUNT NUMERIC(14,2),LOCATION_CODE VARCHAR(5) )
	
	DECLARE @CICDTABLE TABLE ( CNC_MEMO_ID VARCHAR(22), PRODUCT_CODE VARCHAR(50) , QUANTITY NUMERIC(10,3), PURCHASE_PRICE NUMERIC(10,2))
	
	INSERT @CICMTABLE
	SELECT CNC_MEMO_ID, CNC_MEMO_NO, CNC_MEMO_DT, CNC_TYPE, FIN_YEAR, CANCELLED, TOTAL_AMOUNT,LOCATION_CODE
	FROM ICM01106 WHERE CNC_MEMO_ID = @CXNID

	INSERT @CICDTABLE 
	SELECT A.CNC_MEMO_ID, A.PRODUCT_CODE, A.QUANTITY , B.PURCHASE_PRICE
	FROM ICD01106 A
	LEFT OUTER JOIN SKU B ON A.PRODUCT_CODE = ISNULL(B.PRODUCT_CODE,'')
	WHERE  CNC_MEMO_ID = @CXNID

	SET @CERRORMSG = ''
	
	

	IF EXISTS (SELECT CNC_MEMO_ID FROM @CICMTABLE WHERE FIN_YEAR<>'01'+DBO.FN_GETFINYEAR(CNC_MEMO_DT))
	BEGIN
		SET @CERRORMSG='MISMATCH BETWEEN MEMO DATE & FIN YEAR .....PLEASE CHECK'
		RETURN
	END
	
		
	
END_PROC:
END
--****************************************** END OF PROCEDURE VALIDATEXN_CNC
