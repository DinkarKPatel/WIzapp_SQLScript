create PROCEDURE SP3S_SYNCH_UPLOADDATA_XNRECON_OPT
(
    @nSpId VARCHAR(50)
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
SET NOCOUNT ON
BEGIN
	

DECLARE @CSTEP VARCHAR(100),@CMEMO_ID VARCHAR(100),@CFILTERCONDITION VARCHAR(1000),
        @CTABLENAME VARCHAR(100),@CTMP_TABLENAME VARCHAR(100),
		@CKEYFIELD VARCHAR(50),@CSOURCEDB VARCHAR(10),@CMERGEDB VARCHAR(10),@CTABLE_SUFFIX varchar(10),
		@CCMD nvarchar(max),@BCHALLANRECEIVEDPREV BIT,@CCMDOUTPUT VARCHAR(MAX)
	


BEGIN TRY
	BEGIN TRANSACTION	

	SELECT @CMEMO_ID=RECON_ID FROM XNRECON_XNRECON_HIST_MST_UPLOAD WHERE SP_ID=@nSpId

	IF ISNULL(@CMEMO_ID,'')=''
	   GOTO EXIT_PROC

    SET @CTABLE_SUFFIX='upload'
	
	select @CSOURCEDB ='',@cMergedb=''                                           
										    
   
    SET @CSTEP = 50       
 

    SET @CTABLENAME='XNRECON_HIST_MST'        
    SET @CTMP_TABLENAME='XNRECON_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
    			

	     
	SET @CKEYFIELD='recon_id'        
    SET @CSTEP= 70   
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='Memo_id',@CKEYFIELD3=''        
         ,@LINSERTONLY=0,@LUPDATEONLY=0,@BALWAYSUPDATE=1 


      
   DELETE FROM XNRECON_HIST_DET WITH (ROWLOCK) WHERE recon_id = @CMEMO_ID
  
    SET @CSTEP = 80      
    SET @CTABLENAME='XNRECON_HIST_DET'        
    SET @CTMP_TABLENAME='XNRECON_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
    SET @CKEYFIELD='row_id'        
    SET @CSTEP= 90
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=1,@LUPDATEONLY=0,@BALWAYSUPDATE=0 



	
   
   

END TRY
BEGIN CATCH
	SET @CERRMSG='P:SP3S_SYNCH_UPLOADDATA_XNRECON_OPT for MemoId: STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO EXIT_PROC
END CATCH

EXIT_PROC:


	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')=''
			COMMIT
		ELSE
			ROLLBACK
    END
	
	DELETE FROM XNRECON_XNRECON_HIST_MST_UPLOAD WHERE memo_id=@CMEMO_ID
	DELETE FROM XNRECON_XNRECON_HIST_det_UPLOAD WHERE memo_id=@CMEMO_ID		
	
END	
