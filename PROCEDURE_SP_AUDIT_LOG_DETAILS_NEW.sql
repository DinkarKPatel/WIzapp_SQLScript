create PROCEDURE SP_AUDIT_LOG_DETAILS_NEW
(  
 @NQUERYID INT=0,  
 @CFMDT DATETIME='',  
 @CTODT DATETIME='',  
 @LOC_ID VARCHAR(100)='',  
 @NMODE INT=0,  
 @CMEMO_ID VARCHAR(100)='' ,
 @UserCodeID VARCHAR(100)=''   
)   
AS  
BEGIN  
--(dinkar) Replace  left(memoid,2) to Location_code 

	  DECLARE @CXN_TYPE VARCHAR(100) =(CASE	  WHEN @NQUERYID=1  THEN 'SLS' 
											  WHEN @NQUERYID=2  THEN 'PUR'
											  WHEN @NQUERYID=3  THEN 'VCH' 
											  WHEN @NQUERYID=4  THEN 'WSL' 
											  WHEN @NQUERYID=5  THEN 'PRT'
											  WHEN @NQUERYID=6  THEN 'WSR' 
											  WHEN @NQUERYID=7  THEN 'PO'	
											  WHEN @NQUERYID=8  THEN 'BO'
											  WHEN @NQUERYID=9  THEN 'ARC' ELSE '' END)
	IF (@NMODE=1)
		BEGIN									  
			DECLARE @DT TABLE(XN_ID INT,XN_TYPE VARCHAR(10),XN_DESC VARCHAR(50))									  
			
			INSERT INTO @DT(XN_ID ,XN_TYPE ,XN_DESC)
			SELECT 1,'SLS','Cash Memo'
			UNION
			SELECT 2,'PUR','Purchase Invoice'
			UNION
			SELECT 3,'VCH','Voucher Entry'
			UNION
			SELECT 4,'WSL','WholeSale Invoice'
			UNION
			SELECT 5,'PRT','Debit Note'
			UNION
			SELECT 6,'WSR','Credit Note'	
			UNION
			SELECT 7,'PO','Purchase Order'
			UNION
			SELECT 8,'BO','Buyer Order'	 
			UNION
			SELECT 9,'ARC','Customer Receipt'	
			
			SELECT * FROM @DT
		END
	ELSE IF (@NMODE=2)
	BEGIN
		EXEC SP3S_AUDIT_XN_FILTER @XN_TYPE=@CXN_TYPE,@FROM=@CFMDT,@TILL=@CTODT,@LOC=@LOC_ID,@UserCode=@UserCodeID
	END
	ELSE IF (@NMODE=3)	
	BEGIN
	PRINT @CXN_TYPE
	PRINT @CMEMO_ID
	  EXEC SP3S_XN_AUDIT_TRAIL_DETAILS @CXN_TYPE =@CXN_TYPE,@CXN_ID =@CMEMO_ID, @CFMDT=@CFMDT, @CTODT =@CTODT 
	END 
	ELSE IF (@NMODE=4)
	BEGIN
		SELECT A.*,X.XN_NO,X.XN_DT 
		FROM XN_AUDIT_TRIAL_DET A
		JOIN
		(
			SELECT CM_ID AS XN_ID,CM_NO AS XN_NO,CM_DT AS XN_DT FROM CMM01106
			WHERE (location_Code =@LOC_ID OR ISNULL(@LOC_ID,'')='')
			AND (CM_DT BETWEEN @CFMDT AND @CTODT) AND @NQUERYID=1
			UNION ALL
			SELECT MRR_ID AS XN_ID,MRR_NO AS XN_NO,MRR_DT AS XN_DT  FROM PIM01106
			WHERE (location_Code=@LOC_ID OR ISNULL(@LOC_ID,'')='')
			AND (MRR_DT BETWEEN @CFMDT AND @CTODT) AND @NQUERYID=2
			UNION ALL
			SELECT VM_ID AS XN_ID,VOUCHER_NO AS XN_NO,VOUCHER_DT AS XN_DT  FROM VM01106
			WHERE (location_Code=@LOC_ID OR ISNULL(@LOC_ID,'')='')
			AND (VOUCHER_DT BETWEEN @CFMDT AND @CTODT) AND @NQUERYID=3
			UNION ALL
			SELECT INV_ID AS XN_ID,INV_NO AS XN_NO,INV_DT AS XN_DT  FROM INM01106
			WHERE (location_Code=@LOC_ID OR ISNULL(@LOC_ID,'')='')
			AND (INV_DT BETWEEN @CFMDT AND @CTODT) AND @NQUERYID=4
			UNION ALL
			SELECT RM_ID AS XN_ID,RM_NO AS XN_NO,rm_dt AS XN_DT  FROM RMM01106
			WHERE (location_Code=@LOC_ID OR ISNULL(@LOC_ID,'')='')
			AND (RM_DT BETWEEN @CFMDT AND @CTODT) AND @NQUERYID=5
			UNION ALL
			SELECT PO_ID AS XN_ID,PO_NO AS XN_NO,PO_dt AS XN_DT  FROM POM01106
			WHERE (location_Code=@LOC_ID OR ISNULL(@LOC_ID,'')='')
			AND (PO_DT BETWEEN @CFMDT AND @CTODT) AND @NQUERYID=7
			UNION ALL
			SELECT order_id AS XN_ID,order_no AS XN_NO,order_dt AS XN_DT  FROM BUYER_ORDER_MST
			WHERE (location_Code=@LOC_ID OR ISNULL(@LOC_ID,'')='')
			AND (order_dt BETWEEN @CFMDT AND @CTODT) AND @NQUERYID=8
		)X ON X.XN_ID=A.XN_ID
		WHERE XN_TYPE=@CXN_TYPE
		AND (location_code=@LOC_ID OR ISNULL(@LOC_ID,'')='')
		AND AUDITED_ON BETWEEN @CFMDT AND @CTODT AND ( A.CWIZUSERCODE = @UserCodeID OR isnull(@UserCodeID,'')='')
	END
	
	
	
END  
