CREATE PROCEDURE SP_CUSTOMER_PURCHASE_HISTORY
@CCUSTOMERCODE VARCHAR(MAX),
@NNOOFENTRIES INT=5,
@cDEPT_ID VARCHAR(4)=''
AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 
	DECLARE @CFINYEAR VARCHAR(5),@CCMD NVARCHAR(MAX)
	
	DECLARE @CLOCID VARCHAR(5),@CCUTOFDATE VARCHAR(50)
	
	
	IF @cDEPT_ID='' 	
	  SELECT @CLOCID =DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID   
    ELSE
     SELECT @CLOCID = @cDEPT_ID
	
	--IF @NQUERYID=1
	--	GOTO LBLGETPACKSLIPDATA
	--ELSE
	--	GOTO LAST

LBLGETPACKSLIPDATA:
	
	PRINT 'STEP : 1'+CONVERT(VARCHAR,GETDATE(),109)
	
	IF OBJECT_ID('TEMPDB..#TMPRPS','U') IS NOT NULL
		DROP TABLE #TMPRPS
		
	SELECT CM_ID,patchup_run INTO #TMPRPS FROM CMM01106 WHERE 1=2

	IF OBJECT_ID('TEMPDB..#TMPCMM_PATCH','U') IS NOT NULL
		DROP TABLE #TMPCMM_PATCH
	SELECT CM_ID,subtotal ,subtotal_r,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,NET_AMOUNT,round_off 
	INTO #TMPCMM_PATCH FROM CMM01106 WHERE 1=2

	IF OBJECT_ID('TEMPDB..#TMPCMD_PATCH','U') IS NOT NULL
		DROP TABLE #TMPCMD_PATCH
	SELECT CM_ID,ROW_ID,mrp,NET,discount_percentage,discount_amount,cmm_discount_amount,gst_percentage,CAST(0 AS NUMERIC(14,2)) AS gst_Amount,xn_value_without_gst,
	xn_value_with_gst ,igst_amount,cgst_amount,sgst_amount 
	INTO #TMPCMD_PATCH FROM CMD01106 WHERE 1=2

	IF OBJECT_ID('TEMPDB..#TMPPYMT_PATCH','U') IS NOT NULL
		DROP TABLE #TMPPYMT_PATCH
	SELECT MEMO_ID AS CM_ID,ROW_ID,AMOUNT 
	INTO #TMPPYMT_PATCH FROM paymode_xn_det WHERE 1=2

	SET @CCMD=N'INSERT INTO #TMPRPS (CM_ID,patchup_run) 
	SELECT TOP ' + CAST(@NNOOFENTRIES AS VARCHAR) + ' A.CM_ID ,ISNULL(A.PATCHUP_RUN,0) PATCHUP_RUN
	FROM  CMM01106  A (NOLOCK) 
	WHERE A.CANCELLED = 0   AND A.CUSTOMER_CODE='''+@CCUSTOMERCODE+'''
	ORDER BY A.CM_DT DESC' 
	
	PRINT @CCMD
	EXEC SP_EXECUTESQL @CCMD
	
	--SELECT * FROM #TMPRPS

	INSERT INTO #TMPCMM_PATCH(CM_ID,subtotal ,subtotal_r,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,NET_AMOUNT,round_off )
	SELECT A.CM_ID,subtotal ,subtotal_r,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,NET_AMOUNT,round_off 
	FROM CMM01106 A
	JOIN #TMPRPS B ON B.cm_id=A.cm_id
	WHERE ISNULL(b.patchup_run,0)=0

	INSERT INTO #TMPCMM_PATCH(CM_ID,subtotal ,subtotal_r,DISCOUNT_PERCENTAGE,DISCOUNT_AMOUNT,NET_AMOUNT,round_off )
	SELECT A.CM_ID,ISNULL(A.old_subtotal ,0),ISNULL(A.old_subtotal_r,0),ISNULL(A.old_DISCOUNT_PERCENTAGE,0),ISNULL(A.old_DISCOUNT_AMOUNT,0),ISNULL(A.old_NET_AMOUNT,0),ISNULL(A.old_round_off ,0)
	FROM CMM01106 A
	JOIN #TMPRPS B ON B.cm_id=A.cm_id
	WHERE b.patchup_run=1

	INSERT INTO #TMPCMD_PATCH(CM_ID,ROW_ID,mrp,NET,discount_percentage,discount_amount,cmm_discount_amount,gst_percentage,gst_Amount,xn_value_without_gst,xn_value_with_gst,igst_amount,cgst_amount,sgst_amount  )
	SELECT A.CM_ID,ROW_ID,mrp,NET,discount_percentage,discount_amount,cmm_discount_amount,gst_percentage,0 gst_Amount,xn_value_without_gst,xn_value_with_gst ,igst_amount,cgst_amount,sgst_amount 
	FROM CMD01106 A
	JOIN #TMPRPS B ON B.cm_id=A.cm_id
	WHERE b.patchup_run=0

	INSERT INTO #TMPCMD_PATCH(CM_ID,ROW_ID,mrp,NET,discount_percentage,discount_amount,cmm_discount_amount,gst_percentage,gst_Amount,xn_value_without_gst,xn_value_with_gst,igst_amount,cgst_amount,sgst_amount  )
	SELECT A.CM_ID,ROW_ID,ISNULL(old_mrp,0),ISNULL(OLD_NET,0),ISNULL(old_discount_percentage,0),ISNULL(old_discount_amount,0),ISNULL(old_cmm_discount_amount,0),ISNULL(old_gst_percentage,0),ISNULL(old_gst_Amount,0),ISNULL(old_xn_value_without_gst,0),
	ISNULL(A.old_xn_value_with_gst,0),ISNULL(A.OLD_igst_amount,0),ISNULL(A.OLD_cgst_amount,0),ISNULL(A.OLD_sgst_amount ,0)
	FROM CMD01106 A
	JOIN #TMPRPS B ON B.cm_id=A.cm_id
	WHERE b.patchup_run=1

	INSERT INTO #TMPPYMT_PATCH(CM_ID,ROW_ID,AMOUNT)
	SELECT A.MEMO_ID,ROW_ID,A.AMOUNT
	FROM paymode_xn_det  A
	JOIN #TMPRPS B ON B.cm_id=A.memo_id
	WHERE A.XN_TYPE ='SLS' AND b.patchup_run=0

	INSERT INTO #TMPPYMT_PATCH(CM_ID,ROW_ID,AMOUNT)
	SELECT A.MEMO_ID,ROW_ID,ISNULL(A.OLD_AMOUNT,0)
	FROM paymode_xn_det  A
	JOIN #TMPRPS B ON B.cm_id=A.memo_id
	WHERE A.XN_TYPE ='SLS' AND b.patchup_run=1 



	
	PRINT 'STEP : 2'+CONVERT(VARCHAR,GETDATE(),109)
	
	SELECT C2.subtotal ,C2.subtotal_r,C2.DISCOUNT_PERCENTAGE,C2.DISCOUNT_AMOUNT,C2.NET_AMOUNT,C2.round_off , A.*, B.*, B.USER_CUSTOMER_CODE+'['+ B.CUSTOMER_TITLE+' '+B.CUSTOMER_FNAME+' '+B.CUSTOMER_LNAME +']' AS CUSTOMER_NAME, '' AS CREDIT_CARD_NAME , C.USERNAME, '' AS ADDRESS,  
	ISNULL(ST.STATE,'') AS [STATE],ISNULL(AR.AREA_NAME,'') AS  AREA,  
	ISNULL(CI.CITY,'') AS CITY,ISNULL(AR.PINCODE,'') AS PINCODE,  
	CAST((CASE WHEN ISNULL(CMR.CM_ID,'')<>'' THEN 1 ELSE 0 END) AS BIT) AS CREDIT_REFUND,  
	'' AS HOLD_ID,'' AS LOGIN_ID,'' AS SESSION_ID,CAST(ISNULL(TAX,0) AS NUMERIC(14,2)) AS [TOTAL_TAX]  ,ISNULL(D.USERNAME,'') AS [EDT_USERNAME],
	ISNULL(X.EMP_CODE,'0000000') AS [EMP_CODE],ISNULL(X.EMP_CODE1,'0000000')  AS [EMP_CODE1],
	ISNULL(X.EMP_CODE2,'0000000') AS [EMP_CODE2],DBO.FN_GETSALEPERSON(A.CM_ID,0) AS [EMP_NAME],
	ISNULL(X.EMP_NAME1,'') AS [EMP_NAME1],ISNULL(X.EMP_NAME2,'') AS [EMP_NAME2],DTM.DT_NAME,
	B1.AC_NAME,ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],
	CONVERT(NUMERIC(14,2),A.SUBTOTAL+A.SUBTOTAL_R) AS [SUBTOTAL_T],
	CONVERT(NUMERIC(14,3),(CASE WHEN (A.SUBTOTAL+A.SUBTOTAL_R)<>0 THEN (A.DISCOUNT_AMOUNT*100)/ (A.SUBTOTAL+A.SUBTOTAL_R) ELSE 0 END)) AS [DISCOUNT_PERCENTAGE_CALC]
	,ISNULL(PAY.CASH_AMOUNT,0) AS CASH_AMOUNT,ISNULL(PAY.CC_AMOUNT,0) AS CC_AMOUNT,ISNULL(PAY.CREDIT_AMOUNT,0) AS CREDIT_AMOUNT,ISNULL(PAY.CN_AMOUNT,0) AS CN_AMOUNT,
	ISNULL(PAY.ADVANCE_AMOUNT_ADJUSTED,0)+ISNULL(PAY.OTHER_DOC_AMOUNT,0)+ISNULL(PAY.BANK_CHARGES,0)+ISNULL(PAY.MISC_AMOUNT,0) AS [OTHER_AMOUNT]
	,A.TOTAL_QUANTITY_STR
	FROM CMM01106 A  (NOLOCK)
	JOIN #TMPCMM_PATCH C2 (NOLOCK) ON A.CM_ID=C2.CM_ID  
	JOIN CUSTDYM B  (NOLOCK) ON B.CUSTOMER_CODE=A.CUSTOMER_CODE   
	JOIN LM01106 B1  (NOLOCK) ON B1.AC_CODE=A.AC_CODE 
	JOIN DTM  (NOLOCK) ON DTM.DT_CODE=A.DT_CODE
	LEFT OUTER JOIN BIN  (NOLOCK) ON BIN.BIN_ID=ISNULL(A.BIN_ID,'000')  
	LEFT OUTER JOIN AREA AR  (NOLOCK) ON AR.AREA_CODE=B.AREA_CODE  
	LEFT OUTER JOIN CITY CI  (NOLOCK) ON CI.CITY_CODE=AR.CITY_CODE  
	LEFT OUTER JOIN STATE ST  (NOLOCK) ON ST.STATE_CODE=CI.STATE_CODE  
	LEFT OUTER JOIN CMR01106 CMR  (NOLOCK) ON CMR.CM_ID=A.CM_ID    
	JOIN USERS C  (NOLOCK) ON C.USER_CODE=A.USER_CODE  
	LEFT OUTER JOIN USERS D  (NOLOCK) ON D.USER_CODE=A.EDT_USER_CODE
	LEFT OUTER JOIN
	(
		SELECT SUM(TAX_AMOUNT) AS [TAX] ,A.CM_ID	
		FROM CMD01106 A (NOLOCK)
		JOIN #TMPRPS B (NOLOCK) ON A.CM_ID=B.CM_ID  
		WHERE TAX_METHOD=2 --AND CM_ID=@CWHERE 
		GROUP BY A.CM_ID
	)X1 ON X1.CM_ID=A.CM_ID  
	LEFT OUTER JOIN
	(
		SELECT TOP 1 A.CM_ID,E1.EMP_CODE,E2.EMP_CODE  AS [EMP_CODE1],E3.EMP_CODE AS [EMP_CODE2],E1.EMP_NAME AS [EMP_NAME]
		,E2.EMP_NAME AS [EMP_NAME1],E3.EMP_NAME AS [EMP_NAME2]
		FROM CMD01106 A (NOLOCK)
		JOIN EMPLOYEE E1 (NOLOCK) ON E1.EMP_CODE=A.EMP_CODE
		JOIN EMPLOYEE E2 (NOLOCK) ON E2.EMP_CODE=A.EMP_CODE1
		JOIN EMPLOYEE E3 (NOLOCK) ON E3.EMP_CODE=A.EMP_CODE2
		WHERE 1=2
	)X ON X.CM_ID=A.CM_ID
	LEFT OUTER JOIN VW_BILL_PAYMODE PAY ON PAY.MEMO_ID=A.CM_ID AND PAY.XN_TYPE='SLS'
	--WHERE ABS(CASH_AMOUNT) <> 0
	--WHERE (A.SUBTOTAL+A.SUBTOTAL_R)>0
	ORDER BY A.CM_DT DESC,A.CM_NO
	
	
	PRINT 'STEP : 3'+CONVERT(VARCHAR,GETDATE(),109)
	
	--IF OBJECT_ID('TEMPDB..#TMPCMD','U') IS NOT NULL
	--	DROP TABLE #TMPCMD
	
	
	--SELECT A.* INTO #TMPCMD FROM CMD01106 A  WITH (NOLOCK,INDEX=IND_CMD01106_CMID)  
	--JOIN #TMPRPS B1 ON A.CM_ID=B1.CM_ID  
	--select * from #TMPCMD_PATCH
	PRINT 'STEP : 3.1'+CONVERT(VARCHAR,GETDATE(),109)
		
	SELECT R1.mrp,R1.NET,R1.discount_percentage,R1.discount_amount,R1.cmm_discount_amount,R1.gst_percentage,R1.gst_Amount,R1.xn_value_without_gst,
	R1.xn_value_with_gst ,R1.igst_amount,R1.cgst_amount,R1.sgst_amount , A.*,A.SR_NO AS SRNO,  
	EMP.EMP_NAME, A.PRODUCT_CODE, '' as ARTICLE_CODE, ARTICLE_NO, ARTICLE_NAME, '' as  PARA1_CODE,    
	PARA1_NAME, '' as PARA2_CODE, PARA2_NAME, '' as PARA3_CODE, PARA3_NAME, '' as UOM_NAME,       
	A.DEPT_ID, 0 AS CODING_SCHEME,  0 as INACTIVE,0 AS QUANTITY_IN_STOCK ,   
	SKU.pp as PURCHASE_PRICE,  a.MRP,sku.WS_PRICE,   SECTION_NAME, SUB_SECTION_NAME,    
	'' as PARA4_CODE,'' as PARA5_CODE,'' as PARA6_CODE,    
	PARA4_NAME,PARA5_NAME,PARA6_NAME,'' as UOM_CODE,1 AS [UOM_TYPE],    
	'' AS [ART_DT_CREATED],'' AS [PARA3_DT_CREATED],'' AS [SKU_DT_CREATED],STOCK_NA,
	CONVERT (BIT,(CASE WHEN A.QUANTITY <0 THEN 1 ELSE 0 END)) AS SALERETURN ,
	CAST(0 AS BIT) AS CREDIT_REFUND,'' AS HOLD_ID,'' AS CMD_HOLD_ROW_ID, A.MRP AS [LOCSKU_MRP],sub_Section_name as PRODUCT_NAME,  
	EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2,
	SKU.MRP AS [FIX_MRP],
	(CASE WHEN ISNULL(A.HOLD_FOR_ALTER,0)=0 THEN 'N' ELSE 'Y' END) AS [HOLD_FOR_ALTER_TXT],
	(CASE WHEN ISNULL(A.PACK_SLIP_ID,'')='' THEN '' ELSE RIGHT(A.PACK_SLIP_ID,10 ) END) AS [PACK_SLIP_NO],
	ISNULL(BIN.BIN_NAME,'') AS [BIN_NAME],'' as ARTICLE_ALIAS ,'' as SUB_SECTION_CODE,'' as SECTION_CODE,
	CONVERT(BIT,0 ) AS [BRANDWISE_DISC],ISNULL(scheme_name,'') AS SLS_TITLE,
	ISNULL(N.NARRATION,'') AS [NARRATION],CONVERT(VARCHAR(10),'') AS [BUYER_ORDER_NO]
	FROM  CMD01106  A  WITH (NOLOCK,INDEX=IND_CMD01106_CMID)  
	JOIN #TMPCMD_PATCH R1 ON R1.CM_ID=A.CM_ID AND R1.ROW_ID=A.ROW_ID
	JOIN SKU_names  sku (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE  
	LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID  
	LEFT OUTER JOIN NRM N (NOLOCK) ON N.NRM_ID=ISNULL(A.NRM_ID  ,'0000000')
	LEFT OUTER JOIN EMPLOYEE EMP  (NOLOCK) ON A.EMP_CODE = EMP.EMP_CODE   
	LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON A.EMP_CODE1 = EMP1.EMP_CODE     
	LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON A.EMP_CODE2 = EMP2.EMP_CODE    
	ORDER BY  A.SR_NO

	PRINT 'STEP : 4'+CONVERT(VARCHAR,GETDATE(),109)

	SELECT D1.AMOUNT,A.*,B.PAYMODE_NAME,C.* ,CAST(0 AS BIT ) AS DELETED,      
	(CASE WHEN A.CURRENCY_CONVERSION_RATE> 0 THEN     
	CAST(A.AMOUNT/A.CURRENCY_CONVERSION_RATE AS NUMERIC(10,2)) ELSE A.AMOUNT END ) AS BASIC_AMOUNT,
	ISNULL(S.CM_DT,ISNULL(R.ADV_REC_DT,'')) AS ADJ_MEMO_DT  ,CONVERT(VARCHAR(100),'') AS SP_ID  
	FROM PAYMODE_XN_DET A  (NOLOCK)   
	JOIN PAYMODE_MST B (NOLOCK) ON B.PAYMODE_CODE=A.PAYMODE_CODE      
	JOIN PAYMODE_GRP_MST C (NOLOCK) ON C.PAYMODE_GRP_CODE=B.PAYMODE_GRP_CODE      
	
	LEFT OUTER JOIN
	(
		SELECT  A.CM_NO,A.CM_DT,A.CM_ID FROM  CMM01106 A (NOLOCK) 
		JOIN PAYMODE_XN_DET B (NOLOCK) ON B.ADJ_MEMO_ID=A.CM_ID
		JOIN #TMPPYMT_PATCH C ON C.CM_ID=B.MEMO_ID
		WHERE  B.XN_TYPE='SLS' AND PAYMODE_CODE='0000001' AND SUBSTRING(A.CM_NO,LEN(A.LOCATION_CODE)+3,1)='N'
	)S ON S.CM_ID=A.ADJ_MEMO_ID
	LEFT OUTER JOIN
	(
		SELECT  A.ADV_REC_NO,A.ADV_REC_DT,A.ADV_REC_ID FROM ARC01106 A (NOLOCK) 
		JOIN PAYMODE_XN_DET B (NOLOCK) ON B.ADJ_MEMO_ID=A.ADV_REC_ID
		JOIN #TMPPYMT_PATCH C ON C.CM_ID=B.MEMO_ID
		WHERE ARC_TYPE=2 AND  B.XN_TYPE='SLS' AND PAYMODE_CODE='0000002'
	 )R ON R.ADV_REC_ID=A.ADJ_MEMO_ID   
	 
	--JOIN #TMPRPS D ON D.CM_ID=A.MEMO_ID
	JOIN #TMPPYMT_PATCH D1 ON D1.CM_ID=A.MEMO_ID AND D1.row_id=A.row_id
	WHERE A.XN_TYPE ='SLS' 

	PRINT 'STEP : 5'+CONVERT(VARCHAR,GETDATE(),109)
	
	GOTO LAST  
	
LAST:

END
--END OF PROCEDURE - SP_CUSTOMER_PURCHASE_HISTORY
/*
--EXEC SP_UPTOSALE_NEW 1,'0000004','2019-08-29','01',0 --Running fast

EXEC SP_CUSTOMER_PURCHASE_HISTORY_chk @cDEPT_ID = '07', @cCustomerCode='9991341321',@nNoOfEntries=5
EXEC SP_CUSTOMER_PURCHASE_HISTORY @cDEPT_ID = '07', @cCustomerCode='9991341321',@nNoOfEntries=5
*/