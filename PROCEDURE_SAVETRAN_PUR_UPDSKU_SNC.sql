-- PROCEDURE TO UPDATE PUR INFO IN SKU AND SKU_OH TABLES
create PROCEDURE SAVETRAN_PUR_UPDSKU_SNC
(
	@CMEMOID VARCHAR(40),
	@NMODE INT=1,
	@BCANCELBILL BIT=0,
	@CERRORMSG VARCHAR(MAX) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
    BEGIN TRY

	
    
	DECLARE @CCMD NVARCHAR(MAX),@CDETAILTABLE VARCHAR(100),@CMASTERTABLE VARCHAR(100),@CMEMOIDCOL VARCHAR(100) ,
	@CQTYCOL VARCHAR(100),@NSTEP INT,@nSncmstmode NUMERIC(1,0)
	
	SET @CERRORMSG=''
	
	SET @NSTEP=10
	SELECT @CDETAILTABLE='SNC_DET',@CMASTERTABLE='SNC_MST',@CMEMOIDCOL='MEMO_ID',@CQTYCOL='QUANTITY'	
	
	SELECT TOP 1 @nSncmstmode=snc_mst_mode FROM  snc_mst (NOLOCK) WHERE memo_id=@cMemoId
		
	SET @NSTEP=20	
	PRINT 'UPDSKUOH-1'

	IF @nSncMstmode=2
	BEGIN
		-- UPDATING OVERHEADS IN SKU_OH TABLE
		UPDATE a with (rowlock) SET  	
			DISCOUNT_AMOUNT	= 0,  	
			TAX_AMOUNT 		= ROUND(d.total_tax/c.QUANTITY,2),  	
			FREIGHT			= 0,  	
			OTHER_CHARGES 	= 0,  	
			ROUND_OFF		= 0,
			EXCISE_DUTY_AMOUNT=	0	  
		FROM sku_oh  a
		JOIN SNC_BARCODE_DET b WITH (ROWLOCK) ON a.product_code=b.product_code
		JOIN  snc_det c (NOLOCK) ON b.REFROW_ID=c.row_id
		JOIN 
		(SELECT ref_row_id,sum(tax_amount*quantity) total_tax FROM sku_oh a (NOLOCK)
			JOIN SNC_CONSUMABLE_DET b (NOLOCK) ON a.product_code=b.PRODUCT_CODE
			WHERE memo_id=@CMEMOID
			GROUP BY ref_row_id
		) d ON d.REF_ROW_ID=c.ROW_ID
		JOIN snc_mst e (NOLOCK) ON e.MEMO_ID=c.MEMO_ID
		WHERE c.MEMO_ID=@CMEMOID AND WIP=0 
	END
	ELSE
	BEGIN
		-- UPDATING OVERHEADS IN SKU_OH TABLE
		UPDATE a with (rowlock) SET  	
			DISCOUNT_AMOUNT	= 0,  	
			TAX_AMOUNT 		= ROUND(d.avg_tax*c.PURCHASE_PRICE,2),  	
			FREIGHT			= 0,  	
			OTHER_CHARGES 	= 0,  	
			ROUND_OFF		= 0,
			EXCISE_DUTY_AMOUNT=	0	  
		FROM sku_oh  a
		JOIN SNC_BARCODE_DET b WITH (ROWLOCK) ON a.product_code=b.product_code
		JOIN  snc_det c (NOLOCK) ON b.REFROW_ID=c.row_id
		JOIN 
		(SELECT case when SUM(b.PURCHASE_PRICE*quantity)=0 then 0 else  sum(tax_amount*quantity)/SUM(b.PURCHASE_PRICE*quantity) end avg_tax FROM sku_oh a (NOLOCK)
			JOIN SNC_CONSUMABLE_DET b (NOLOCK) ON a.product_code=b.PRODUCT_CODE
			WHERE memo_id=@CMEMOID
			GROUP BY ref_row_id
		) d ON 1=1
		JOIN snc_mst e (NOLOCK) ON e.MEMO_ID=c.MEMO_ID
		WHERE c.MEMO_ID=@CMEMOID AND WIP=0 
	END
	
	SET @NSTEP=25
	UPDATE a SET tax_amount=b.tax_amount*(CASE WHEN coding_scheme<>3 THEN a.quantity ELSE 1 END) 
	FROM snc_det a WITH (ROWLOCK)
	JOIN 
	(SELECT refrow_id,sum(b.tax_amount) tax_amount
	 FROM snc_barcode_det a (NOLOCK)
	 JOIN sku_oh b (NOLOCK) ON b.product_code=a.PRODUCT_CODE
	 JOIN  snc_det c (NOLOCK) ON c.ROW_ID=a.REFROW_ID
	 WHERE memo_id=@CMEMOID
	 GROUP BY REFROW_ID) b ON a.ROW_ID=b.REFROW_ID
	 JOIN article d (NOLOCK) ON d.article_code=a.article_code
	 WHERE memo_id=@CMEMOID
				
	SET @NSTEP=30
	-- UPDATING MASTER INFORMATION AND OTHER DETAILS IN SKU TABLE
	UPDATE A SET  	
		ARTICLE_CODE = B.ARTICLE_CODE,  	
		PARA1_CODE = B.PARA1_CODE,  	
		PARA2_CODE = B.PARA2_CODE,  	
		PARA3_CODE = B.PARA3_CODE,  	
		PARA4_CODE = B.PARA4_CODE,  	
		PARA5_CODE = B.PARA5_CODE,  	
		PARA6_CODE = B.PARA6_CODE,  	
		AC_CODE		= C1.AC_CODE, 	
		FORM_ID		= B.FORM_ID, 	
		INV_NO		= C1.MEMO_NO, 
		INV_DT		= C1.RECEIPT_DT,  	
		RECEIPT_DT	= C1.RECEIPT_DT, 
		PURCHASE_PRICE = B.PURCHASE_PRICE,
		FIX_MRP = B.FIX_MRP,
		EMP_CODE= '0000000',
		HSN_CODE=B.HSN_CODE
	FROM SKU A
	JOIN SNC_BARCODE_DET B1 ON A.PRODUCT_CODE = B1.PRODUCT_CODE
	JOIN SNC_DET B ON B1.REFROW_ID = B.ROW_ID  
	JOIN SNC_MST C1 ON C1.MEMO_ID = B.MEMO_ID  
	LEFT OUTER JOIN SKU_OH D ON A.PRODUCT_CODE = D.PRODUCT_CODE
	WHERE C1.WIP=0 AND C1.MEMO_ID = @CMEMOID
	
	
	SET @NSTEP=80	 
	---UPDATING MRP IN SKU TABLE 
	IF @BCANCELBILL=0
	BEGIN
		UPDATE  A SET A.MRP = B.MRP ,A.WS_PRICE = B.WHOLESALE_PRICE 
		FROM SKU A (NOLOCK)
		JOIN SNC_BARCODE_DET A1 (NOLOCK) ON A1.PRODUCT_CODE=A.PRODUCT_CODE
		JOIN SNC_DET B (NOLOCK) ON A1.REFROW_ID=B.ROW_ID
		JOIN SNC_MST C1 (NOLOCK) ON C1.MEMO_ID=B.MEMO_ID
		JOIN ARTICLE C (NOLOCK) ON B.ARTICLE_CODE=C.ARTICLE_CODE 
		LEFT OUTER JOIN 
		(
			SELECT DISTINCT PRODUCT_CODE FROM IRD01106 A (NOLOCK)
			JOIN irm01106 B (NOLOCK) ON A.irm_memo_id =B.irm_memo_id 
			WHERE B.type <>2 
		) IRD ON A1.PRODUCT_CODE = IRD.PRODUCT_CODE
		WHERE C1.WIP=0 AND B.MEMO_ID=@CMEMOID 
		--AND   A.BARCODE_CODING_SCHEME<>1 
		AND   IRD.PRODUCT_CODE IS NULL
	END
	
	END TRY
	
	BEGIN CATCH
		SET @CERRORMSG = 'PROCEDURE SAVETRAN_UPDPUR_SKU_SNC: STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		-- SET @CRETCMD= N'SELECT '''+@CERRORMSG+''' AS ERRMSG, '''' AS MEMO_ID'
			
		GOTO END_PROC
	END CATCH
	
END_PROC:

END
--************************************************** END OF PROCEDURE SAVETRAN_PUR_UPDSKU
