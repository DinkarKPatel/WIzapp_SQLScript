CREATE PROCEDURE SP_BUYERSORDER_WSL_31
@CMEMOID VARCHAR(40),  
@CWHERE VARCHAR(500),  
@CFINYEAR VARCHAR(10),  
@NNAVMODE NUMERIC(2,0),
@CARTICLECODE CHAR(9)='',  
@CPARA2CODE CHAR(7)='',
@DTWHERE DATETIME ='',
@cLocId VARCHAR(5)=''
--WITH ENCRYPTION
 
AS    
BEGIN 
DECLARE @nWsPrice NUMERIC(10,2)    

 SELECT TOP 1 @nWsPrice=sfp.fc_rate 
 FROM sku_fc_prices sfp (NOLOCK)
 JOIN location loc (NOLOCK) ON 1=1
 JOIN sku (NOLOCK) ON sku.product_code=sfp.product_code
 WHERE sku.PRODUCT_CODE = @CWHERE and loc.dept_id= @CLOCID AND sfp.fc_code=loc.fc_code      
 ORDER BY sfp.last_update DESC
 
SELECT A.ARTICLE_CODE, A.ARTICLE_DESC, A.ARTICLE_NAME,   
A.ARTICLE_NO, A.CODING_SCHEME,    
A.PURCHASE_PRICE, (CASE WHEN ISNULL(@nWsPrice,0)<>0 THEN @nWsPrice ELSE A.MRP END) AS MRP, 
(CASE WHEN ISNULL(@nWsPrice,0)<>0 THEN @nWsPrice ELSE A.WHOLESALE_PRICE END) AS WS_PRICE, A.CREATED_ON,   
A.PARA1_SET, A.PARA2_SET, B.UOM_CODE,B.UOM_NAME, B.UOM_TYPE,A.DT_CREATED,
A.ALIAS AS ARTICLE_ALIAS   ,A.HSN_CODE ,S.product_code,P.para1_code ,P2.para2_code ,p.para1_name ,p2.para2_name  ,
S.para3_code,S.para4_code,S.Para5_code,S.para6_code
FROM  SKU S  (NOLOCK)
JOIN  ARTICLE A (NOLOCK)   ON S.Article_code= A.Article_code  
JOIN SECTIOND sd (NOLOCK) ON A.SUB_SECTION_CODE = sd.SUB_SECTION_CODE      
JOIN SECTIONM SM (NOLOCK)  ON sd.SECTION_CODE = SM.SECTION_CODE  
JOIN PARA1 P (NOLOCK) on S.para1_code = P.para1_code  
JOIN PARA2 P2 (NOLOCK) on S.para2_code = P2.para2_code  
JOIN UOM B (NOLOCK)  ON A.UOM_CODE = B.UOM_CODE    
WHERE A.ARTICLE_TYPE =1 AND ARTICLE_PRD_MODE <> 3 AND  
ISNULL(SM.ITEM_TYPE,1)=@NNAVMODE   AND S.PRODUCT_CODE = @CWHERE  

END