CREATE PROCEDURE SP_TILLSHIFTOPEN  
AS  
BEGIN  
  
IF OBJECT_ID ('TEMPDB..#SHIFTOPEN','U') IS NOT NULL  
   DROP TABLE #SHIFTOPEN  
      
    SELECT DISTINCT  SHIFT_ID  
    INTO  #SHIFTOPEN  
 FROM TILL_SHIFT_MST WHERE CONVERT(VARCHAR,CLOSE_DATE,105)='01-01-1900'  
  
;WITH CTE ( SHIFT_ID ,RECEIPTS)  
AS  
       
    (  
   --CASH RECEIVED THRU TILL EXPENSES  
   SELECT A.SHIFT_ID,SUM(A.RECEIPTS) AS RECEIPTS  
   FROM  
   (  
   SELECT  A.SHIFT_ID,SUM(B.AMOUNT) AS RECEIPTS  
   FROM TILL_EXPENSE_MST A  
   JOIN TILL_EXPENSE_DET B ON A.MEMO_ID=B.MEMO_ID  
   JOIN #SHIFTOPEN C ON A.SHIFT_ID=C.SHIFT_ID  
   WHERE  B.XN_TYPE='CR'  
   GROUP BY A.SHIFT_ID  
   UNION ALL  
   --CASH RECEIVED THRU ADVANCES/OS RECEIPTS  
   SELECT A.SHIFT_ID,SUM(B.AMOUNT)   
   FROM ARC01106 A  
   JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID=B.MEMO_ID AND B.XN_TYPE='ARC'  
   JOIN #SHIFTOPEN C ON A.SHIFT_ID=C.SHIFT_ID  
   WHERE  A.ARC_TYPE=1 AND B.PAYMODE_CODE='0000000'  
   AND A.CANCELLED=0  
   GROUP BY A.SHIFT_ID  
   UNION ALL  
   --NET CASH RECEIVED AGAINST SALES  
   SELECT A.SHIFT_ID,SUM(B.AMOUNT)   
   FROM CMM01106 A  
   JOIN PAYMODE_XN_DET B ON A.CM_ID=B.MEMO_ID AND B.XN_TYPE='SLS'  
   JOIN #SHIFTOPEN C ON A.SHIFT_ID=C.SHIFT_ID  
   WHERE  B.PAYMODE_CODE='0000000'  
   AND A.CANCELLED=0  
   GROUP BY A.SHIFT_ID  
   UNION ALL  
   --NET CASH RECEIVED AGAINST SALES THRU CASHIER  
   SELECT A.SHIFT_ID,SUM(B.AMOUNT)   
   FROM DSM01106 A  
   JOIN DSD01106 AD ON A.DS_ID=AD.DS_ID  
   JOIN PAYMODE_XN_DET B ON AD.CM_ID=B.MEMO_ID AND B.XN_TYPE='SLS'  
   JOIN #SHIFTOPEN C ON A.SHIFT_ID=C.SHIFT_ID  
   WHERE B.PAYMODE_CODE='0000000'  
   AND A.CANCELLED=0  
   GROUP BY A.SHIFT_ID  
   ) A  
   GROUP BY A.SHIFT_ID  
    )  
      
  
      
   ,CTE2 ( SHIFT_ID,ISSUES)  
     AS   
     (  
   --AMOUNT ISSUED THRU TILL EXPENSES  
   SELECT SHIFT_ID,SUM(ISSUES) AS ISSUES  
   FROM  
   (  
   SELECT A.SHIFT_ID, SUM(B.AMOUNT) AS ISSUES   
   FROM TILL_EXPENSE_MST A  
   JOIN TILL_EXPENSE_DET B ON A.MEMO_ID=B.MEMO_ID  
   JOIN #SHIFTOPEN C ON A.SHIFT_ID=C.SHIFT_ID  
   WHERE B.XN_TYPE='DR'  
   GROUP BY A.SHIFT_ID  
   UNION ALL  
   --CASH ISSUED AGAINST PAYMENTS  
   SELECT A.SHIFT_ID,SUM(B.AMOUNT) AS ISSUES   
   FROM ARC01106 A  
   JOIN PAYMODE_XN_DET B ON A.ADV_REC_ID=B.MEMO_ID AND B.XN_TYPE='ARC'  
   JOIN #SHIFTOPEN C ON A.SHIFT_ID=C.SHIFT_ID  
   WHERE  A.ARC_TYPE=2 AND B.PAYMODE_CODE='0000000'  
   AND A.CANCELLED=0  
   GROUP BY A.SHIFT_ID  
   UNION ALL  
   --CASH ISSUES AGAINST TILL LIFTS  
   SELECT A.SHIFT_ID,SUM(A.LIFT_AMOUNT) AS ISSUES  
   FROM TILL_LIFTS A  
   JOIN #SHIFTOPEN C ON A.SHIFT_ID=C.SHIFT_ID  
   WHERE A.CANCELLED=0  
   GROUP BY A.SHIFT_ID  
   ) A  
   GROUP BY SHIFT_ID  
     
     )  
       
       
      
    SELECT E.DEPT_NAME,E.DEPT_ALIAS AS LOC,ISNULL(A.SHIFT_ID,B.SHIFT_ID) AS SHIFT_ID  
    ,CONVERT(VARCHAR(5),C.OPEN_TIME ,108) AS TIME  
    ,CAST(CAST(DATEDIFF(MI,C.OPEN_TIME,GETDATE())AS DECIMAL)/60 AS NUMERIC(18,1)) AS AGEING  
    ,CAST(SUM( CAST(ISNULL(D.TILL_LIMIT,0) AS NUMERIC(18,2)))/100000  AS NUMERIC(18,1)) AS LIMIT --  
    ,CAST(CAST(SUM(ISNULL(A.RECEIPTS,0)-ISNULL(B.ISSUES,0))AS NUMERIC(18,2))/100000 AS NUMERIC(18,1)) AS COLLECT --/100000   
    ,CAST((SUM(ISNULL(A.RECEIPTS,0)-ISNULL(B.ISSUES,0)))/100000-(SUM( CAST(ISNULL(D.TILL_LIMIT,0) AS NUMERIC(18,2))))/100000 AS NUMERIC(18,1)) AS OVERLIMIT  
    --,CAST(CAST(SUM(ISNULL(A.RECEIPTS,0)-ISNULL(B.ISSUES,0))- ISNULL(D.TILL_LIMIT,0) AS NUMERIC(18,2)) AS NUMERIC(18,2)) AS OVERLIMIT--/100000  
    FROM CTE A   
    FULL JOIN CTE2 B ON A.SHIFT_ID=B.SHIFT_ID  
    JOIN TILL_SHIFT_MST C ON C.SHIFT_ID=ISNULL(A.SHIFT_ID,B.SHIFT_ID)  
    JOIN TILL_LOCS D ON D.TILL_ID=C.TILL_ID  
    JOIN LOCATION E ON E.DEPT_ID=D.DEPT_ID  
    --WHERE A.SHIFT_ID IS NOT NULL  
      
    GROUP BY  E.DEPT_NAME ,E.DEPT_ALIAS ,ISNULL(A.SHIFT_ID,B.SHIFT_ID),D.TILL_LIMIT,CONVERT(VARCHAR(5),C.OPEN_TIME ,108)  
   ,DATEDIFF(MI,C.OPEN_TIME,GETDATE())  
    ORDER BY E.DEPT_NAME,ISNULL(A.SHIFT_ID,B.SHIFT_ID)  
       
 END  
  --END OF PROCEDURE SP_TILLSHIFTOPEN
