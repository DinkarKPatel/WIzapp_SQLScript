CREATE PROCEDURE SP_PRODUCT_DETAIL          --(LocId 3 digit change by Sanjay:06-11-2024)
(            
 @CPRODUCTCODE VARCHAR(50),          
 @MEMOTYPE NUMERIC(1),          
 @NMODE INT=1  ,          
 @CDEPTID VARCHAR(4)=''          
 ,@TARGETDEPTID VARCHAR(4)=''      
 ,@INCLUDE_BRULE BIT=0      
 ,@CBIN_ID VARCHAR(MAX)=''          
)            
AS             
BEGIN       
     
	 DECLARE @CHKPURDETILAS BIT 
	 SET @CHKPURDETILAS=0
	 IF EXISTS (SELECT TOP 1 'U' FROM LOCATION WHERE DEPT_ID=@CDEPTID AND ISNULL(CHKPURDETAILS_IN_DN,0)=1)
		SET @CHKPURDETILAS=1
	
	 
	 --ALTER TABLE LOCATION ADD CHKPURDETAILS_IN_DN BIT
	  
 IF  @INCLUDE_BRULE =0     
 BEGIN    
   
  SELECT TOP 1 ISNULL(X.AC_CODE, A.AC_CODE) AS [AC_CODE], F.UOM_TYPE, H.SECTION_NAME, G.SUB_SECTION_NAME,             
  A.PRODUCT_CODE,              
  --CONVERT(VARCHAR, A.INV_DT, 105) AS INV_DT
  A.INV_DT, A.INV_NO,ISNULL(X.AC_NAME,LM.AC_NAME) AS [AC_NAME],                
  ISNULL(X.GROSS_PURCHASE_PRICE,(CASE WHEN LBR.DEFAULT_RATE_TYPE IS NULL THEN (CASE WHEN @NMODE=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1             
  THEN  A.MRP ELSE A.WS_PRICE END) WHEN @NMODE=2 THEN (CASE WHEN LBR.DEFAULT_RATE_TYPE=1 THEN  A.MRP WHEN LBR.DEFAULT_RATE_TYPE=2 THEN A.WS_PRICE ELSE A.PURCHASE_PRICE END )      
  ELSE (CASE WHEN @NMODE=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1             
  THEN  A.MRP ELSE A.WS_PRICE END) END)) AS GROSS_PURCHASE_PRICE,           
  ISNULL(X.MRP, A.MRP) AS MRP,           
  ISNULL(X.WHOLESALE_PRICE, A.WS_PRICE) AS WS_PRICE,           
  B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC, C.PARA1_NAME, D.PARA2_NAME,                   
  E.PARA3_NAME, P4.PARA4_NAME, P5.PARA5_NAME , P6.PARA6_NAME, F.UOM_CODE, F.UOM_NAME,  ISNULL(X.FORM_ID, I.FORM_ID) AS FORM_ID, PMT.DEPT_ID,              
  ISNULL(X.FORM_NAME,I.FORM_NAME) AS FORM_NAME, ISNULL(X.TAX_PERCENTAGE, I.TAX_PERCENTAGE) AS TAX_PERCENTAGE, ISNULL(PMT.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,              
  ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],ISNULL(A.DT_CREATED,'') AS [SKU_DT_CREATED],            
  X.MRR_NO,X.MRR_ID ,X.ROW_ID AS PID_ROW_ID,  
  A.BARCODE_CODING_SCHEME AS CODING_SCHEME,B.DISCON,            
  ISNULL(X.INACTIVE, LM.INACTIVE) AS [INACTIVE] ,ISNULL(X.ON_HOLD, LMP.ON_HOLD) AS [ON_HOLD],            
  0 AS DISCOUNT_PERCENTAGE,--ISNULL(X.DISCOUNT_PERCENTAGE,0) AS  [DISCOUNT_PERCENTAGE],(COMMEDNTED DUE TO PROBLEM COMING IN GROUP DEBIT NOTE PICKING DOUBLE DISCOUNT : 21-12-2016)        
  0 AS DISCOUNT_AMOUNT,--ISNULL(X.DISCOUNT_AMOUNT,0) AS  [DISCOUNT_AMOUNT],       
  0 AS  [DN_DISCOUNT_PERCENTAGE],       
  (CASE WHEN A.ER_FLAG=0 THEN 1 ELSE A.ER_FLAG END )AS ER_FLAG,ISNULL(X.INV_NO,A.CHALLAN_NO) AS CHALLAN_NO,ISNULL(X.BILL_NO,A.INV_NO) AS BILL_NO,  
  ISNULL(X.INV_DT,A.INV_DT) AS BILL_DT             
  --,ISNULL(X.EXCISE_DUTY_AMOUNT,AOH.EXCISE_DUTY_AMOUNT) AS EXCISE_DUTY_AMOUNT,            
  ,ISNULL(X.EXCISE_DUTY_AMOUNT,0) AS EXCISE_DUTY_AMOUNT,            
  ISNULL(X.EXCISE_DUTY_AMOUNT,0) AS PARTY_PUR_EXCISE_RATE,            
  ISNULL(AOH.FREIGHT,0) AS FREIGHT, ISNULL(AOH.OTHER_CHARGES,0) AS OTHER_CHARGES,            
  0 AS [PUR_DISCOUNT_PERCENTAGE],         
  0 AS [PUR_DISCOUNT_AMOUNT] ,        
  CONVERT(NUMERIC(14,2), (CASE WHEN ISNULL(X.INV_RATE, 0)=0 THEN ISNULL(X.PURCHASE_PRICE,(CASE WHEN @NMODE=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1             
  THEN  A.MRP ELSE A.WS_PRICE END)) ELSE  ISNULL(X.INV_RATE, 0) END  )) AS INV_RATE        
  ,ISNULL(X.GROSS_PURCHASE_PRICE,(CASE WHEN LBR.DEFAULT_RATE_TYPE IS NULL THEN (CASE WHEN @NMODE=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1             
  THEN  A.MRP ELSE A.WS_PRICE END) WHEN @NMODE=2 THEN (CASE WHEN LBR.DEFAULT_RATE_TYPE=1 THEN  A.MRP WHEN LBR.DEFAULT_RATE_TYPE=2 THEN A.WS_PRICE ELSE A.PURCHASE_PRICE END )      
  ELSE (CASE WHEN @NMODE=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1             
  THEN  A.MRP ELSE A.WS_PRICE END) END)) AS [PURCHASE_PRICE] ,         
  ISNULL(X.BILL_LEVEL_TAX_METHOD,1) AS BILL_LEVEL_TAX_METHOD ,        
  ISNULL( X.TAX_METHOD_NAME,'EXCLUSIVE') AS TAX_METHOD_NAME          
  ,BL.BIN_ID,BI.BIN_NAME,B.STOCK_NA,B.ALIAS AS ARTICLE_ALIAS,B.STOCK_NA  ,
  CASE WHEN ISNULL(@CHKPURDETILAS,0)=1 AND X.MRR_ID IS NULL THEN 'PURCHASE DETILS NOT FOUND PLEASE CREATE INVOICE FOR THIS BARCODE'  
  ELSE '' END AS ERRMSG
  FROM SKU A (NOLOCK)        
  LEFT JOIN SKU_OH AOH (NOLOCK) ON A.PRODUCT_CODE=AOH.PRODUCT_CODE            
  JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE                    
  JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE                    
  JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE                   
  JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE                    
  JOIN PARA4 P4 (NOLOCK) ON A.PARA4_CODE = P4.PARA4_CODE                    
  JOIN PARA5 P5 (NOLOCK) ON A.PARA5_CODE = P5.PARA5_CODE                    
  JOIN PARA6 P6 (NOLOCK) ON A.PARA6_CODE = P6.PARA6_CODE            
  JOIN UOM F (NOLOCK) ON B.UOM_CODE = F.UOM_CODE                   
  JOIN SECTIOND G (NOLOCK) ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE                    
  JOIN SECTIONM H (NOLOCK) ON G.SECTION_CODE = H.SECTION_CODE                   
  left JOIN FORM I (NOLOCK) ON A.FORM_ID = I.FORM_ID                           
  LEFT OUTER JOIN PMT01106 PMT (NOLOCK) ON PMT.PRODUCT_CODE=A.PRODUCT_CODE AND PMT.BIN_ID=@CBIN_ID   and pmt.dept_id= @CDEPTID
  LEFT OUTER JOIN             
  (            
  SELECT TOP 1 A.MRR_ID, A.MRR_NO,B.PRODUCT_CODE, B.ROW_ID , INV_DT,            
  B.GROSS_PURCHASE_PRICE,B.PURCHASE_PRICE,B.MRP,B.WHOLESALE_PRICE,             
  B.DISCOUNT_PERCENTAGE AS [PUR_DISCOUNT_PERCENTAGE],(CASE WHEN B.INVOICE_QUANTITY>0 THEN       
  CAST(B.DISCOUNT_AMOUNT/B.INVOICE_QUANTITY AS NUMERIC(14,2)) ELSE 0 END) AS [PUR_DISCOUNT_AMOUNT],            
  A.DISCOUNT_PERCENTAGE AS [DISCOUNT_PERCENTAGE],            
  A.AC_CODE ,LM1.AC_NAME,LM1.INACTIVE,LMP1.ON_HOLD,FRM.FORM_ID,FRM.TAX_PERCENTAGE,FRM.FORM_NAME            
  ,A.MEMO_TYPE,A.BILL_NO,A.INV_NO,A.FREIGHT ,B.ITEM_EXCISE_DUTY_AMOUNT AS EXCISE_DUTY_AMOUNT,        
  A.BILL_LEVEL_TAX_METHOD,        
  (CASE WHEN A.DISCOUNT_PERCENTAGE=0 THEN B.PURCHASE_PRICE ELSE (B.PURCHASE_PRICE-(B.PURCHASE_PRICE *A.DISCOUNT_PERCENTAGE/100)) END) AS INV_RATE ,      
  CAST((B.PURCHASE_PRICE *A.DISCOUNT_PERCENTAGE/100) AS NUMERIC(14,2)) AS [DISCOUNT_AMOUNT],      
  (CASE WHEN A.BILL_LEVEL_TAX_METHOD = 1 THEN 'EXCLUSIVE' ELSE 'INCLUSIVE' END) AS TAX_METHOD_NAME             
  FROM PIM01106 A (NOLOCK)            
  JOIN PID01106 B (NOLOCK) ON B.MRR_ID=A.MRR_ID            
  JOIN LM01106 LM1 (NOLOCK) ON LM1.AC_CODE=A.AC_CODE              
  LEFT OUTER JOIN LMP01106 LMP1 (NOLOCK) ON LMP1.AC_CODE=LM1.AC_CODE            
  JOIN FORM FRM (NOLOCK) ON FRM.FORM_ID=B.FORM_ID         
  WHERE B.PRODUCT_CODE = @CPRODUCTCODE  AND A.CANCELLED=0          
  --AND A.INV_MODE=@NMODE        
  AND a.location_Code=@CDEPTID          
  ORDER BY A.INV_DT DESC            
  )X ON X.PRODUCT_CODE=A.PRODUCT_CODE       
  JOIN LM01106 LM (NOLOCK) ON A.AC_CODE = LM.AC_CODE            
  LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LM.AC_CODE=LMP.AC_CODE        
  JOIN BIN_LOC BL (NOLOCK) ON BL.DEPT_ID =@CDEPTID         
  JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=BL.DEPT_ID      
  JOIN BIN BI (NOLOCK) ON BI.BIN_ID=BL.BIN_ID          
  LEFT JOIN LOC_BILLING_RULES LBR (NOLOCK) ON LBR.SOURCE_DEPT_ID=LOC.DEPT_ID AND LBR.TARGET_DEPT_ID=@TARGETDEPTID AND @INCLUDE_BRULE=1      
  WHERE BL.BIN_ID=@CBIN_ID AND A.PRODUCT_CODE = @CPRODUCTCODE            
  AND A.ER_FLAG=(CASE WHEN @MEMOTYPE=1 OR A.BARCODE_CODING_SCHEME=1 THEN A.ER_FLAG ELSE @MEMOTYPE END)             
  END    
  ELSE    
  BEGIN    
      
	   DECLARE @CMRR_ID VARCHAR(50)
	   SELECT TOP 1 @CMRR_ID=A.MRR_ID  FROM PID01106 A (NOLOCK) 
	   JOIN pim01106 B (NOLOCK)  ON A.MRR_ID =B.MRR_ID 
	   WHERE B.CANCELLED=0 AND A.product_code=@CPRODUCTCODE
	   AND b.location_Code=@CDEPTID    

  SELECT TOP 1 A.AC_CODE AS [AC_CODE], F.UOM_TYPE, H.SECTION_NAME, G.SUB_SECTION_NAME,             
   A.PRODUCT_CODE,              
   --CONVERT(VARCHAR, A.INV_DT, 105) AS INV_DT
   A.INV_DT, A.INV_NO,LM.AC_NAME AS [AC_NAME],                
   (CASE WHEN LBR.DEFAULT_RATE_TYPE IS NULL THEN     
   (CASE WHEN @NMODE=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1             
   THEN  A.MRP ELSE A.WS_PRICE END) WHEN @NMODE=2 THEN     
   (CASE WHEN LBR.DEFAULT_RATE_TYPE=1 THEN  A.MRP WHEN LBR.DEFAULT_RATE_TYPE=2 THEN A.WS_PRICE     
   ELSE A.PURCHASE_PRICE END )  ELSE (CASE WHEN @NMODE=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE     
   WHEN LOC.XFER_ACT=1             
   THEN  A.MRP ELSE A.WS_PRICE END) END) AS GROSS_PURCHASE_PRICE,     
   A.MRP AS MRP,           
   A.WS_PRICE AS WS_PRICE,           
   B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC, C.PARA1_NAME, D.PARA2_NAME,                   
   E.PARA3_NAME, P4.PARA4_NAME, P5.PARA5_NAME , P6.PARA6_NAME, F.UOM_CODE, F.UOM_NAME,  I.FORM_ID AS FORM_ID, PMT.DEPT_ID,              
   I.FORM_NAME AS FORM_NAME, I.TAX_PERCENTAGE AS TAX_PERCENTAGE, ISNULL(PMT.QUANTITY_IN_STOCK,0) AS QUANTITY_IN_STOCK,              
   ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],ISNULL(A.DT_CREATED,'') AS [SKU_DT_CREATED],            
   '' MRR_NO ,A.BARCODE_CODING_SCHEME AS CODING_SCHEME,B.DISCON,            
   LM.INACTIVE AS [INACTIVE] ,LMP.ON_HOLD AS [ON_HOLD],            
   0 AS  [DISCOUNT_PERCENTAGE],       
   0 AS  [DISCOUNT_AMOUNT],       
   0 AS  [DN_DISCOUNT_PERCENTAGE],       
   (CASE WHEN A.ER_FLAG=0 THEN 1 ELSE A.ER_FLAG END )AS ER_FLAG,A.CHALLAN_NO AS CHALLAN_NO,A.INV_NO AS BILL_NO,  
    A.INV_DT AS BILL_DT            
   --,ISNULL(X.EXCISE_DUTY_AMOUNT,AOH.EXCISE_DUTY_AMOUNT) AS EXCISE_DUTY_AMOUNT,            
   ,ISNULL(AOH.EXCISE_DUTY_AMOUNT,0) AS EXCISE_DUTY_AMOUNT,            
   ISNULL(AOH.EXCISE_DUTY_AMOUNT,0) AS PARTY_PUR_EXCISE_RATE,  
   ISNULL(AOH.FREIGHT,0) AS FREIGHT, ISNULL(AOH.OTHER_CHARGES,0) AS OTHER_CHARGES,            
   0 AS [PUR_DISCOUNT_PERCENTAGE],         
   0 AS [PUR_DISCOUNT_AMOUNT] ,        
       
   CONVERT(NUMERIC(14,2),(CASE WHEN @NMODE=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1             
   THEN  A.MRP ELSE A.WS_PRICE END)) AS INV_RATE        
   ,    
       
   (CASE WHEN LBR.DEFAULT_RATE_TYPE IS NULL THEN (CASE WHEN @NMODE=1 OR     
   LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1             
  THEN  A.MRP ELSE A.WS_PRICE END) WHEN @NMODE=2 THEN (CASE WHEN LBR.DEFAULT_RATE_TYPE=1 THEN  A.MRP     
  WHEN LBR.DEFAULT_RATE_TYPE=2 THEN A.WS_PRICE ELSE A.PURCHASE_PRICE END )      
  ELSE (CASE WHEN @NMODE=1 OR LOC.XFER_ACT=3 THEN A.PURCHASE_PRICE WHEN LOC.XFER_ACT=1             
  THEN  A.MRP ELSE A.WS_PRICE END) END) AS [PURCHASE_PRICE] ,         
   1 AS BILL_LEVEL_TAX_METHOD ,        
       
   'EXCLUSIVE'   AS TAX_METHOD_NAME          
   ,BL.BIN_ID,BI.BIN_NAME,B.STOCK_NA,B.ALIAS AS ARTICLE_ALIAS ,
    CASE WHEN ISNULL(@CHKPURDETILAS,0)=1 AND ISNULL(@CMRR_ID,'')='' THEN 'PURCHASE DETILS NOT FOUND PLEASE CREATE INVOICE FOR THIS BARCODE'  
  ELSE '' END AS ERRMSG   
   FROM SKU A (NOLOCK)                  
   LEFT JOIN SKU_OH AOH (NOLOCK) ON A.PRODUCT_CODE=AOH.PRODUCT_CODE            
   JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE                    
   JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE                    
   JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE                   
   JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE                    
   JOIN PARA4 P4 (NOLOCK) ON A.PARA4_CODE = P4.PARA4_CODE                    
   JOIN PARA5 P5 (NOLOCK) ON A.PARA5_CODE = P5.PARA5_CODE                    
   JOIN PARA6 P6 (NOLOCK) ON A.PARA6_CODE = P6.PARA6_CODE            
   JOIN UOM F (NOLOCK) ON B.UOM_CODE = F.UOM_CODE                   
   JOIN SECTIOND G (NOLOCK) ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE                    
   JOIN SECTIONM H (NOLOCK) ON G.SECTION_CODE = H.SECTION_CODE                   
   JOIN FORM I (NOLOCK) ON A.FORM_ID = I.FORM_ID                           
   LEFT OUTER JOIN PMT01106 PMT (NOLOCK) ON PMT.PRODUCT_CODE=A.PRODUCT_CODE 
    AND PMT.BIN_ID=@CBIN_ID AND  PMT.DEPT_ID = @CDEPTID       
  JOIN LM01106 LM (NOLOCK) ON A.AC_CODE = LM.AC_CODE            
  LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LM.AC_CODE=LMP.AC_CODE        
  JOIN BIN_LOC BL (NOLOCK) ON BL.DEPT_ID =@CDEPTID         
  JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=BL.DEPT_ID      
  JOIN BIN BI (NOLOCK) ON BI.BIN_ID=BL.BIN_ID          
  LEFT JOIN LOC_BILLING_RULES LBR (NOLOCK) ON LBR.SOURCE_DEPT_ID=LOC.DEPT_ID AND LBR.TARGET_DEPT_ID=@TARGETDEPTID AND @INCLUDE_BRULE=1      
  WHERE BL.BIN_ID=@CBIN_ID AND A.PRODUCT_CODE = @CPRODUCTCODE            
  AND A.ER_FLAG=(CASE WHEN @MEMOTYPE=1 OR A.BARCODE_CODING_SCHEME=1 THEN A.ER_FLAG ELSE @MEMOTYPE END)     
  END    
END   
----****  END OF PROCEDURE SP_PRODUCT_DETAIL  