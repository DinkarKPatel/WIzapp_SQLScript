CREATE PROCEDURE DBO.SP_SEND_MIRROR_MSTTILL_NEW
(
 @CTARGETLOCID VARCHAR(5)
)
AS
 BEGIN
   DECLARE @DTSQL NVARCHAR(MAX),@CSTEP VARCHAR(10),@CFILTERCONDITION NVARCHAR(MAX)
           ,@CTABLENAME VARCHAR(100),@CTEMPTABLE VARCHAR(100),@CTEMPLMTABLE VARCHAR(100)
           ,@CTEMPLMPTABLE VARCHAR(100),@CTEMPDBNAME VARCHAR(200),@CCURDEPTID VARCHAR(5)
           ,@CHODEPTID VARCHAR(5),@CERRORMSG VARCHAR(MAX),@CREPLOCTABLE VARCHAR(500),@NLOCTYPE INT
           ,@CLOCMERGINGTHRUWIZCOM VARCHAR(2),@JOINMASTERTABLE VARCHAR(200),@JOINTEMPTABLE VARCHAR(200)

    DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(100),TMP_TABLENAME VARCHAR(100),ERRMSG VARCHAR(MAX)) 
    
    BEGIN TRY
    
	SET @CSTEP=0

	SET @CTEMPDBNAME = ''
	 
	SET @CSTEP=00
	 
	SET @CSTEP=10
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	SET @CFILTERCONDITION=''
	 
	SET @CSTEP=20

	SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
	SELECT @CHODEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'		
	
	SELECT @NLOCTYPE=LOC_TYPE FROM LOCATION WHERE DEPT_ID=@CTARGETLOCID
	
	PRINT @CSTEP+':'+CONVERT(VARCHAR,GETDATE(),113)
	
	IF @CCURDEPTID<>@CHODEPTID
	BEGIN
		SELECT '' AS LAST_UPDATE,'' AS ERRMSG
		
		GOTO END_PROC
	END		
    SET @CSTEP=30
	
	
	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=40
    ---SELECT DATA FROM TILL_LOCS TABLE
	SET @CTABLENAME = 'TILL_LOCS'

	SELECT DISTINCT  'MSTTILL_TILL_LOCS_MIRROR' AS TARGET_TABLENAME,TILL_LOCS.*,1 AS PICK_FROM_CURRENT_DB FROM TILL_LOCS (NOLOCK)
	WHERE DEPT_ID=@CTARGETLOCID

	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=50
    ---SELECT DATA FROM TILL_MST TABLE
	SET @CTABLENAME = 'TILL_MST'

	SELECT DISTINCT  'MSTTILL_TILL_MST_MIRROR' AS TARGET_TABLENAME,TILL_MST.*,1 AS PICK_FROM_CURRENT_DB FROM TILL_MST (NOLOCK)
	JOIN TILL_LOCS (NOLOCK) ON TILL_MST.TILL_ID = TILL_LOCS.TILL_ID
	WHERE DEPT_ID=@CTARGETLOCID

	
	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=60
    ---SELECT DATA FROM TILL_USERS TABLE
	SET @CTABLENAME = 'TILL_USERS'

	SELECT DISTINCT  'MSTTILL_TILL_USERS_MIRROR' AS TARGET_TABLENAME,TILL_USERS.*,1 AS PICK_FROM_CURRENT_DB FROM TILL_USERS (NOLOCK)
	JOIN TILL_LOCS (NOLOCK) ON TILL_USERS.TILL_ID = TILL_LOCS.TILL_ID
	JOIN LOCUSERS C ON C.DEPT_ID=TILL_LOCS.DEPT_ID AND C.USER_CODE=TILL_USERS.USER_CODE
	WHERE TILL_LOCS.DEPT_ID=@CTARGETLOCID


	 SET @CSTEP=70
	---SELECT DATA FROM USERS TABLE
	SET @CTABLENAME = 'USERS'

	SELECT DISTINCT  'MSTTILL_USERS_MIRROR' AS TARGET_TABLENAME,USERS.*,1 AS PICK_FROM_CURRENT_DB FROM USERS (NOLOCK)
	JOIN  TILL_USERS (NOLOCK) ON TILL_USERS.user_code =USERS .user_code 
	JOIN TILL_LOCS (NOLOCK) ON TILL_USERS.TILL_ID = TILL_LOCS.TILL_ID
	JOIN LOCUSERS C ON C.DEPT_ID=TILL_LOCS.DEPT_ID AND C.USER_CODE=TILL_USERS.USER_CODE
	WHERE TILL_LOCS.DEPT_ID=@CTARGETLOCID

	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=80
    ---SELECT DATA FROM TILL_DEMO_MST TABLE
	SET @CTABLENAME = 'TILL_DENO_MST'

	SELECT DISTINCT  'MSTTILL_TILL_DENO_MST_MIRROR' AS TARGET_TABLENAME,TILL_DENO_MST.*,1 AS PICK_FROM_CURRENT_DB FROM TILL_DENO_MST (NOLOCK)
	
	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=90
    ---SELECT DATA FROM TILL_SMS_REC TABLE
	SET @CTABLENAME = 'TILL_SMS_REC_LOC'

	SELECT DISTINCT  'MSTTILL_TILL_SMS_REC_LOC_MIRROR' AS TARGET_TABLENAME,TILL_SMS_REC_LOC.*,1 AS PICK_FROM_CURRENT_DB FROM TILL_SMS_REC_LOC (NOLOCK)
	WHERE DEPT_ID=@CTARGETLOCID

	
	
	
	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=100
    ---SELECT DATA FROM TILL_SMS_REC TABLE
	SET @CTABLENAME = 'TILL_SMS_REC'
    
	SELECT DISTINCT  'MSTTILL_TILL_SMS_REC_MIRROR' AS TARGET_TABLENAME,TILL_SMS_REC.*,1 AS PICK_FROM_CURRENT_DB FROM TILL_SMS_REC (NOLOCK)


	
	
	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=110
    ---SELECT DATA FROM TILL_SMS_REC TABLE
	SET @CTABLENAME = 'TILL_SMS_VAR'
	SELECT DISTINCT  'MSTTILL_TILL_SMS_VAR_MIRROR' AS TARGET_TABLENAME,TILL_SMS_VAR.*,1 AS PICK_FROM_CURRENT_DB FROM TILL_SMS_VAR (NOLOCK)

	
	--INSERT DATA FROM MAIN TABLE TO TEMP TABLE
    SET @CSTEP=120
    ---SELECT DATA FROM TILL_SMS_REC TABLE
	SET @CTABLENAME = 'TILL_SMS_TMPLT'

	SELECT DISTINCT  'MSTTILL_TILL_SMS_TMPLT_MIRROR' AS TARGET_TABLENAME,TILL_SMS_TMPLT.*,1 AS PICK_FROM_CURRENT_DB FROM TILL_SMS_TMPLT (NOLOCK)

	
	SET @CSTEP=130
	 ---SELECT DATA FROM HD01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106  
	SET @CTABLENAME = 'LM01106'

	SELECT DISTINCT  'MSTTILL_LM01106_MIRROR' AS TARGET_TABLENAME,LM01106.*,1 AS PICK_FROM_CURRENT_DB FROM LM01106 (NOLOCK)
	JOIN DBO.TILL_MST B WITH(NOLOCK) ON LM01106.AC_CODE = B.AC_CODE



	SET @CSTEP=140
	 ---SELECT DATA FROM LMP01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106  
	SET @CTABLENAME = 'LMP01106'

	SELECT DISTINCT  'MSTTILL_LMP01106_MIRROR' AS TARGET_TABLENAME,LMP01106.*,1 AS PICK_FROM_CURRENT_DB FROM LMP01106 (NOLOCK)
	JOIN DBO.TILL_MST B WITH(NOLOCK) ON LMP01106.AC_CODE = B.AC_CODE



	
	SET @CSTEP=150
	 ---SELECT DATA FROM HD01106 TABLE AND ALSO JOIN ON TEMP TABLE OF LM01106  
	SET @CTABLENAME = 'HD01106'

	SELECT DISTINCT  'MSTTILL_HD01106_MIRROR' AS TARGET_TABLENAME,HD01106.*,1 AS PICK_FROM_CURRENT_DB FROM HD01106 (NOLOCK)
	JOIN LM01106 (NOLOCK) ON HD01106.HEAD_CODE=LM01106.HEAD_CODE 
	JOIN DBO.TILL_MST B WITH(NOLOCK) ON LM01106.AC_CODE = B.AC_CODE


	 
	 SET @CSTEP=160
	--SELECT DATA FROM AREA TABLE 
	SET @CTABLENAME = 'AREA'

	SELECT DISTINCT  'MSTTILL_AREA_MIRROR' AS TARGET_TABLENAME,AREA.*,1 AS PICK_FROM_CURRENT_DB FROM AREA (NOLOCK)
	JOIN LMP01106 (NOLOCK) ON AREA.area_code =LMP01106.area_code
	JOIN DBO.TILL_MST B WITH(NOLOCK) ON LMP01106.AC_CODE = B.AC_CODE


    SET @CSTEP=170
   --SELECT DATA FROM AREA TABLE 
	SET @CTABLENAME = 'CITY'

   SELECT DISTINCT  'MSTTILL_CITY_MIRROR' AS TARGET_TABLENAME,CITY.*,1 AS PICK_FROM_CURRENT_DB FROM CITY (NOLOCK)
   JOIN AREA (NOLOCK) ON area .city_code =CITY .CITY_CODE 
   JOIN LMP01106 (NOLOCK) ON AREA.area_code =LMP01106.area_code
   JOIN DBO.TILL_MST B WITH(NOLOCK) ON LMP01106.AC_CODE = B.AC_CODE


    SET @CSTEP=180
 --SELECT DATA FROM STATE TABLE 
	SET @CTABLENAME = 'STATE'

	SELECT DISTINCT  'MSTTILL_STATE_MIRROR' AS TARGET_TABLENAME,STATE.*,1 AS PICK_FROM_CURRENT_DB FROM STATE (NOLOCK)
	JOIN CITY (NOLOCK) ON CITY.STATE_CODE=STATE .state_code 
   JOIN AREA (NOLOCK) ON area .city_code =CITY .CITY_CODE 
   JOIN LMP01106 (NOLOCK) ON AREA.area_code =LMP01106.area_code
   JOIN DBO.TILL_MST B WITH(NOLOCK) ON LMP01106.AC_CODE = B.AC_CODE


    SET @CSTEP=190
   --SELECT DATA FROM STATE TABLE 
	SET @CTABLENAME = 'REGIONM'
    
	SELECT DISTINCT  'MSTTILL_REGIONM_MIRROR' AS TARGET_TABLENAME,REGIONM.*,1 AS PICK_FROM_CURRENT_DB FROM REGIONM (NOLOCK)
	JOIN STATE (NOLOCK) ON state .region_code =regionM .region_code 
	JOIN CITY (NOLOCK) ON CITY.STATE_CODE=STATE .state_code 
   JOIN AREA (NOLOCK) ON area .city_code =CITY .CITY_CODE 
   JOIN LMP01106 (NOLOCK) ON AREA.area_code =LMP01106.area_code
   JOIN DBO.TILL_MST B WITH(NOLOCK) ON LMP01106.AC_CODE = B.AC_CODE


	
	END TRY
	
	BEGIN CATCH
	    SET @CERRORMSG='P: SP_SEND_MIRROR_MSTTILL, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()+ 'ERROR QUERY || '+@DTSQL
	    GOTO END_PROC
    END CATCH 
    
    END_PROC:
    
   SELECT ISNULL(@CERRORMSG,'') AS [ERRMSG]
 END
