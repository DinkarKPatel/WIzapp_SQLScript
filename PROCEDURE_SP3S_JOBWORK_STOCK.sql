CREATE PROCEDURE SP3S_JOBWORK_STOCK
	@CFROMDATE		DATETIME,
	@CTODATE		DATETIME,
	@CPRODUCT_CODE	VARCHAR(100)='',
	@CAGENCY		VARCHAR(100)=''
AS
BEGIN
/*
SP3S_JOBWORK_STOCK '2014-10-14','2014-09-30','IP186-13'
*/	
	IF OBJECT_ID('TEMPDB..#JOBSTOCK','U') IS NOT NULL
		DROP TABLE #JOBSTOCK
	
	---GETTING LIST OF BARCODES THAT HAVE BEEN ISSUED BUT NOT YET RECEIVED
	SELECT 'JWI' AS XN_TYPE,JID.PRODUCT_CODE,JID.QUANTITY-ISNULL(JRD.QUANTITY,0) AS QUANTITY
	INTO #JOBSTOCK
	FROM JOBWORK_ISSUE_MST JIM(NOLOCK)
	JOIN JOBWORK_ISSUE_DET JID(NOLOCK) ON JIM.ISSUE_ID=JID.ISSUE_ID
	LEFT JOIN 
	(	
		SELECT JRD.REF_ROW_ID,SUM(JRD.QUANTITY) AS QUANTITY
		FROM JOBWORK_RECEIPT_DET JRD(NOLOCK) 
		JOIN JOBWORK_RECEIPT_MST JRM(NOLOCK) ON JRD.RECEIPT_ID=JRM.RECEIPT_ID 
		WHERE ISNULL(JRM.RECEIPT_DT,'')<=@CTODATE AND ISNULL(JRM.CANCELLED,0)=0
		AND JRM.WIP=0 AND (ISNULL(@CPRODUCT_CODE,'')='' OR JRD.PRODUCT_CODE=@CPRODUCT_CODE)
		GROUP BY JRD.REF_ROW_ID
	)JRD ON JRD.REF_ROW_ID=JID.ROW_ID
	WHERE JIM.WIP=0 AND JIM.CANCELLED=0  AND JID.QUANTITY-ISNULL(JRD.QUANTITY,0)>0
	AND JIM.ISSUE_DT<=@CTODATE 
	AND (ISNULL(@CPRODUCT_CODE,'')='' OR JID.PRODUCT_CODE=@CPRODUCT_CODE)
	
	
	--SELECT * FROM #JOBSTOCK
	
	SELECT JS.XN_TYPE,JS.PRODUCT_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME
	,JS.QUANTITY,CONVERT(NUMERIC(18,2),S.PURCHASE_PRICE) AS RATE,CONVERT(NUMERIC(18,2),(JS.QUANTITY*S.PURCHASE_PRICE)) AS VALUE
	FROM #JOBSTOCK JS
	JOIN SKU S(NOLOCK) ON JS.PRODUCT_CODE=S.PRODUCT_CODE
	JOIN ARTICLE ART(NOLOCK) ON ART.ARTICLE_CODE=S.ARTICLE_CODE
	WHERE ART.STOCK_NA=0
	ORDER BY JS.PRODUCT_CODE
END
--END OF PROCEDURE - SP3S_JOBWORK_STOCK
