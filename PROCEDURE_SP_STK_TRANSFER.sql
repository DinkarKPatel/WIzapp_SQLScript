CREATE PROCEDURE SP_STK_TRANSFER          
@NQUERYID NUMERIC (2,0),          
@CMEMOID NVARCHAR(40),          
@CWHERE NVARCHAR(500),          
@CPRODUCTCODE NVARCHAR(500),          
@CFINYEAR NVARCHAR(5),          
@NNAVMODE NUMERIC(2,0),  
@CPARA2_CODE VARCHAR(1000)='',  
@NQTY INT=0  
-- --WITH ENCRYPTION  
         
AS          
BEGIN          
  DECLARE @CCMD NVARCHAR(MAX)  
          
IF           
@NQUERYID = 1          
GOTO LBLNAVIGATE          
          
ELSE IF           
@NQUERYID = 2          
GOTO LBLGETMASTERS          
          
ELSE IF           
@NQUERYID = 3          
GOTO LBLGETDETAILS          
          
ELSE IF           
@NQUERYID = 4          
GOTO LBLGETDEPARTMENT          
          
ELSE IF          
@NQUERYID = 5           
GOTO LBLGETPRODUCTLIST          
          
ELSE IF          
@NQUERYID = 6          
GOTO LBLGETWORKORDERMASTER          
          
ELSE IF          
@NQUERYID = 7          
GOTO LBLGETWODET          
        
ELSE IF          
@NQUERYID = 8         
GOTO LBLGETWODETPROD        
        
  ELSE IF           
@NQUERYID = 9          
GOTO LBLGETDETAILSPROD          
          
ELSE IF          
@NQUERYID = 10         
GOTO LBLGETWODETPROD_RET        
  
ELSE IF          
@NQUERYID = 11         
GOTO LBLGETCOMP_DET     
  
ELSE IF   
@NQUERYID = 12         
GOTO LBLARTBOM_DET  
ELSE IF   
@NQUERYID = 13         
GOTO LBLCOMP_DET   
ELSE IF   
@NQUERYID = 14         
GOTO LBL_MATERIAL_DET  
ELSE IF   
@NQUERYID = 18         
GOTO LBL_PENDING_DET  
ELSE IF   
@NQUERYID = 19         
GOTO LBLNAVIGATE_PENDING  
ELSE IF   
@NQUERYID = 20         
GOTO LBLGETMASTERS_PENDING  
  
-------------PENDIN CUTTING MATERIAL-----------  
--------ALWAYS LAST STEP --------PENDING CUTTING MATERIAL  
  
IF OBJECT_ID('TEMPDB..#TMPORDER','U') IS NOT NULL  
    DROP TABLE #TMPORDER  
  
 SELECT   MST.MEMO_ID AS ORDER_ID  
   ,MST.MEMO_NO AS ORDER_NO  
   ,MST.MEMO_DT  AS ORDER_DT  
   ,MST.ARTICLE_SET_CODE  
   ,C.ARTICLE_NO AS BM_ARTICLE_NO  
   ,C.ARTICLE_NAME AS BM_ARTICLE_NAME  
   ,C.ARTICLE_CODE  AS BM_ARTICLE_CODE  
   ,AR.ARTICLE_CODE AS COMP_CODE  
   ,AR.ARTICLE_NO AS ARTICLE_NO  
   ,AR1.ARTICLE_NAME AS FG_ARTICLE_NAME  
   ,AR1.ARTICLE_NO AS FG_ARTICLE_NO  
   ,AR1.ARTICLE_CODE AS FG_ARTICLE_CODE  
   ,DET1.QUANTITY AS WO_QTY  
   ,PARA1.PARA1_CODE  
   ,PARA1.PARA1_NAME  
   ,PARA2.PARA2_CODE  
   ,PARA2.PARA2_NAME  
   ,UOM.UOM_NAME  
   ,DET.QUANTITY  
     ,AVG_QTY AS AVG_QTY  
     ,ADD_AVG_QTY  
     ,CONVERT(NUMERIC(12,2),(AVG_QTY+ISNULL(ADD_AVG_QTY,0)) * DET.QUANTITY) AS REQUIRED_QTY   
 INTO #TMPORDER    
 FROM PRD_WO_ART_BOM A (NOLOCK)        
 JOIN PRD_WO_DET B (NOLOCK) ON A.REF_ROW_ID = B.ROW_ID  
 JOIN PRD_WO_MST MST (NOLOCK) ON B.MEMO_ID=MST.MEMO_ID  
 JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE =B.ARTICLE_CODE  
 JOIN ARTICLE AR1 (NOLOCK) ON AR1.ARTICLE_CODE =MST.ARTICLE_SET_CODE       
 JOIN PARA1 P1 (NOLOCK) ON A.PARA1_CODE=P1.PARA1_CODE  
 JOIN PARA2 P2 (NOLOCK) ON A.PARA2_CODE=P2.PARA2_CODE  
 JOIN  
 (  
  SELECT PARA1_CODE,PARA2_CODE,REF_ROW_ID,SUM(QUANTITY) AS QUANTITY   
  FROM PRD_WO_SUB_DET C  
  GROUP BY REF_ROW_ID,PARA1_CODE,PARA2_CODE  
 ) DET ON B.ROW_ID=DET.REF_ROW_ID  
 JOIN ARTICLE C (NOLOCK) ON A.BOM_ARTICLE_CODE = C.ARTICLE_CODE   
 JOIN UOM ON UOM.UOM_CODE=C.UOM_CODE  
 JOIN  
 (  
  SELECT  REF_ROW_ID,SUM(QUANTITY) AS QUANTITY   
  FROM PRD_WO_SUB_DET C  
  GROUP BY REF_ROW_ID  
 ) DET1 ON B.ROW_ID=DET1.REF_ROW_ID  
 JOIN PARA1  (NOLOCK) ON DET.PARA1_CODE=PARA1.PARA1_CODE  
 JOIN PARA2  (NOLOCK) ON DET.PARA2_CODE=PARA2.PARA2_CODE  
 WHERE  (@CMEMOID='' OR MST.MEMO_ID =@CMEMOID)  
 AND MARK_AS_COMPLETED=1  
 --WHERE B.MEMO_ID='HO0111700000HO00000543'  
   
  
 IF OBJECT_ID ('TEMPDB..#TMPPENDINGFG1','U') IS NOT NULL  
  DROP TABLE #TMPPENDINGFG1   
    
  IF OBJECT_ID ('TEMPDB..#TMPPENDINGFG2','U') IS NOT NULL  
  DROP TABLE #TMPPENDINGFG2    
    
  IF OBJECT_ID ('TEMPDB..#TMPPENDINGFG3','U') IS NOT NULL  
  DROP TABLE #TMPPENDINGFG3   
    
  
--SELECT * FROM #TMPORDER WHERE ORDER_ID='HO0111700000HO00000549'  
--AND PENDING_QTY >0  
  
  
    
   SELECT AR.ARTICLE_CODE,  REF_WO_ID,UOM_NAME,A.MEMO_ID,B.COMPONENT_CODE,B.COM_PARA1_CODE,B.COM_PARA2_CODE,  
    SUM(QUANTITY) AS QUANTITY  
    INTO #TMPPENDINGFG1  
   FROM PRD_STK_TRANSFER_MST A  
   JOIN PRD_STK_TRANSFER_DET B ON A.MEMO_ID=B.MEMO_ID  
   JOIN PRD_SKU S ON B.NEW_PRODUCT_UID = S.PRODUCT_UID      
   JOIN PRD_PMT PMT ON PMT.PRODUCT_UID=S.PRODUCT_UID         
   JOIN ARTICLE AR ON S.ARTICLE_CODE = AR.ARTICLE_CODE    
   JOIN UOM ON UOM.UOM_CODE=AR.UOM_CODE  
   WHERE (@CMEMOID='' OR B.REF_WO_ID =@CMEMOID)  
   --REF_WO_ID='HO0111700000HO00000549' AND  
   AND A.SOURCE_DEPARTMENT_ID=@CWHERE  AND A.CANCELLED=0  
   GROUP BY AR.ARTICLE_CODE, UOM_NAME,REF_WO_ID,A.MEMO_ID,B.COMPONENT_CODE,B.COM_PARA1_CODE,  
   B.COM_PARA2_CODE  
  
       
   
   SELECT AR.ARTICLE_CODE,  REF_WO_ID,UOM_NAME,B.COMPONENT_CODE,B.COM_PARA1_CODE,B.COM_PARA2_CODE,  
          REF_CUTTING_ID AS MEMO_ID,  
    SUM(QUANTITY) AS QUANTITY  
     INTO #TMPPENDINGFG2  
   FROM PRD_STK_TRANSFER_MST_PENDING A  
   JOIN PRD_STK_TRANSFER_DET_PENDING B ON A.MEMO_ID=B.MEMO_ID  
   JOIN PRD_SKU S ON B.NEW_PRODUCT_UID = S.PRODUCT_UID      
   JOIN PRD_PMT PMT ON PMT.PRODUCT_UID=S.PRODUCT_UID         
   JOIN ARTICLE AR ON S.ARTICLE_CODE = AR.ARTICLE_CODE    
   JOIN UOM ON UOM.UOM_CODE=AR.UOM_CODE  
   WHERE   
   A.SOURCE_DEPARTMENT_ID=@CWHERE   
   AND (@CMEMOID='' OR B.REF_WO_ID =@CMEMOID)
   AND A.CANCELLED=0  
   GROUP BY AR.ARTICLE_CODE, UOM_NAME,REF_WO_ID,B.COMPONENT_CODE,B.COM_PARA1_CODE,REF_CUTTING_ID,B.COM_PARA2_CODE  
    
      
  SELECT A.* ,ISSUE_QTY AS QTY_PCS,C.MEMO_ID,  
  ISNULL(CONVERT(NUMERIC(12,2),(A.AVG_QTY+ISNULL(ADD_AVG_QTY,0))*ISSUE_QTY),0) AS REQUIRED_FOR_CUTTING,  
  (ISNULL(B.QUANTITY,0)+ISNULL(PN.QUANTITY,0)-ISNULL(REC.QUANTITY,0)) AS CUTTING_QTY,  
  ISNULL(CONVERT(NUMERIC(12,2),(A.AVG_QTY+ISNULL(ADD_AVG_QTY,0))*ISSUE_QTY),0)-(ISNULL(B.QUANTITY,0)+ISNULL(PN.QUANTITY,0)-ISNULL(REC.QUANTITY,0)) AS PENDING_QTY  
  INTO #TMPPENDINGFG3  
  FROM #TMPORDER A  
  JOIN  
  (  
    SELECT A.MEMO_ID, A.ARTICLE_CODE, REF_WO_ID,A.PARA1_CODE,A.PARA2_CODE,ISSUE_QTY AS ISSUE_QTY  
    FROM PRD_STK_TRANSFER_MATERIAL_DET A  
    JOIN   
    (  
     SELECT A.MEMO_ID, REF_ROW_ID,REF_WO_ID   
     FROM PRD_STK_TRANSFER_DET A  
     JOIN PRD_STK_TRANSFER_MST B ON A.MEMO_ID=B.MEMO_ID  
     WHERE B.CANCELLED=0  
     GROUP BY  A.MEMO_ID, REF_ROW_ID,REF_WO_ID  
    ) B ON A.MEMO_ID=B.MEMO_ID AND A.ROW_ID =B.REF_ROW_ID   
   ) C ON A.ORDER_ID=C.REF_WO_ID   
         AND A.ARTICLE_SET_CODE=C.ARTICLE_CODE  
   AND A.PARA1_CODE=C.PARA1_CODE AND A.PARA2_CODE=C.PARA2_CODE  
   LEFT OUTER JOIN  
   (  
    SELECT  A.ARTICLE_CODE,A.REF_WO_ID,A.UOM_NAME,A.MEMO_ID,A.COMPONENT_CODE,A.COM_PARA1_CODE,A.COM_PARA2_CODE,  
    SUM(QUANTITY) AS QUANTITY  
    FROM #TMPPENDINGFG1 A  
    GROUP BY A.ARTICLE_CODE,A.REF_WO_ID,A.UOM_NAME,A.MEMO_ID,A.COMPONENT_CODE,A.COM_PARA1_CODE,A.COM_PARA2_CODE  
   )B ON  B.REF_WO_ID=A.ORDER_ID AND   
          B.ARTICLE_CODE=BM_ARTICLE_CODE AND  
   B.COMPONENT_CODE=A.COMP_CODE  
   AND B.COM_PARA1_CODE=A.PARA1_CODE  
   AND B.COM_PARA2_CODE=A.PARA2_CODE  
   AND A.UOM_NAME=B.UOM_NAME  
   AND C.MEMO_ID=B.MEMO_ID  
   LEFT OUTER JOIN  
   (  
    SELECT  A.ARTICLE_CODE,A.REF_WO_ID,A.UOM_NAME,A.MEMO_ID,A.COMPONENT_CODE,A.COM_PARA1_CODE,A.COM_PARA2_CODE,  
    SUM(QUANTITY) AS QUANTITY  
    FROM #TMPPENDINGFG2 A  
    GROUP BY A.ARTICLE_CODE,A.REF_WO_ID,A.UOM_NAME,A.MEMO_ID,A.COMPONENT_CODE,A.COM_PARA1_CODE,A.COM_PARA2_CODE  
   )PN ON  PN.REF_WO_ID=A.ORDER_ID AND   
          PN.ARTICLE_CODE=BM_ARTICLE_CODE AND  
   PN.COMPONENT_CODE=A.COMP_CODE  
   AND PN.COM_PARA1_CODE=A.PARA1_CODE  
   AND PN.COM_PARA2_CODE=A.PARA2_CODE  
   AND A.UOM_NAME=PN.UOM_NAME  
   AND C.MEMO_ID=PN.MEMO_ID  
    LEFT OUTER JOIN
   (
      SELECT A.REF_WO_ID ,A.COMPONENT_CODE ,A.COM_PARA1_CODE , 
           A.COM_PARA2_CODE,C.ARTICLE_CODE ,SUM(QUANTITY) AS QUANTITY 
    FROM PRD_STK_RECEIVE_DET A
    JOIN PRD_STK_RECEIVE_MST B ON A.MEMO_ID =B.MEMO_ID 
    JOIN PRD_SKU C ON A.PRODUCT_UID=C.PRODUCT_UID
    WHERE B.CANCELLED =0 
    GROUP BY  A.REF_WO_ID ,A.COMPONENT_CODE ,A.COM_PARA1_CODE , 
           A.COM_PARA2_CODE,C.ARTICLE_CODE
   ) REC ON REC.REF_WO_ID=A.ORDER_ID AND   
          REC.ARTICLE_CODE=BM_ARTICLE_CODE AND  
   REC.COMPONENT_CODE=A.COMP_CODE  
   AND REC.COM_PARA1_CODE=A.PARA1_CODE  
   AND REC.COM_PARA2_CODE=A.PARA2_CODE  
 WHERE ISNULL(CONVERT(NUMERIC(12,2),(A.AVG_QTY+ISNULL(ADD_AVG_QTY,0))*ISSUE_QTY),0)-(ISNULL(B.QUANTITY,0)+ISNULL(PN.QUANTITY,0)-ISNULL(REC.QUANTITY,0))>0  
  
------------*--------------PENDING CUTTING--------  
   
IF   
@NQUERYID = 15         
GOTO LBL_PENDING_SET   
ELSE IF   
@NQUERYID = 16        
GOTO LBL_PENDING_ROW_MATERIAL   
ELSE IF   
@NQUERYID = 17        
GOTO LBL_PENDING_DETAILS  
ELSE IF   
@NQUERYID = 21       
GOTO LBL_PENDING_PCS   
ELSE  
GOTO LAST  
  
LBL_PENDING_PCS:  
      
 SELECT DISTINCT  ORDER_NO,ORDER_ID,  
 ORDER_DT,FG_ARTICLE_NO,WO_QTY,RIGHT(MEMO_ID,10) AS MEMO_NO,  
 MEMO_ID,  
 PARA1_NAME,PARA2_NAME,  
 QTY_PCS ,
 CAST(0 AS BIT) AS CHK 
 FROM #TMPPENDINGFG3 A  
      
GOTO LAST   
   
LBL_PENDING_SET:  
         
    SELECT DISTINCT T1.*,CONVERT(CHAR(10),ISNULL(T1.MEMO_DT,''),105) AS MEMO_DATE,ART.ARTICLE_NO             
    FROM PRD_WO_MST T1            
    JOIN PRD_WO_DET T2 ON T2.MEMO_ID = T1.MEMO_ID            
    JOIN ARTICLE ART ON T1.ARTICLE_SET_CODE = ART.ARTICLE_CODE       
    JOIN #TMPPENDINGFG3 A ON T1.MEMO_ID=A.ORDER_ID  
      
  
  
GOTO LAST   
  
LBL_PENDING_ROW_MATERIAL:  
        
        
      --SP_STK_TRANSFER 16 ,'','DEF0000','HO0000978','',0,'',0  --HO0000978  
  
      SELECT CAST(0 AS BIT) AS CHCK,  
             ORDER_ID,  
             ORDER_NO,  
             ORDER_DT,  
             FG_ARTICLE_NAME ,  
             FG_ARTICLE_NO AS ARTICLE_NO,  
             MEMO_ID,  
             RIGHT(MEMO_ID,10) AS MEMO_NO,  
             BM_ARTICLE_NO,  
             BM_ARTICLE_CODE,  
             COMP_CODE,  
             ARTICLE_NO AS COMP_NO,  
             SUM(PENDING_QTY) AS PENDING_QTY  
      FROM #TMPPENDINGFG3  
      GROUP BY  ORDER_NO,  
       ORDER_ID,  
             ORDER_DT,  
             FG_ARTICLE_NAME ,  
             FG_ARTICLE_NO ,  
             MEMO_ID,  
             COMP_CODE,  
             ARTICLE_NO,  
             RIGHT(MEMO_ID,10) ,  
             BM_ARTICLE_NO,  
             BM_ARTICLE_CODE  
      ORDER BY ORDER_NO,  
       ORDER_DT,MEMO_ID  
               
             
  
GOTO LAST   
  
LBL_PENDING_DETAILS:  
        
      SET @CCMD= N' SELECT CAST(0 AS BIT)CHCK,ARTCOM.ARTICLE_NO AS COMPONENT ,C.ARTICLE_CODE AS COMPONENT_CODE,  
   K.PARA1_CODE AS COM_PARA1_CODE,K.PARA2_CODE AS COM_PARA2_CODE, COMP1.PARA1_NAME AS COM_PARA1_NAME,  
   COMP2.PARA2_NAME AS COM_PARA2_NAME  , B.ARTICLE_NO,B.ARTICLE_NAME,B.ARTICLE_DESC,C.MEMO_ID,          
   D.UOM_NAME ,S.PARA1_CODE, PARA1.PARA1_NAME,S.PARA2_CODE ,PARA2.PARA2_NAME,SM.SECTION_NAME,  
   SD.SUB_SECTION_NAME, P.QUANTITY_IN_STOCK,P.QUANTITY_IN_STOCK AS ORG_STOCK_QTY,P.DEPARTMENT_ID,  
   PENDING_QTY AS REQUIRED_QTY  ,A.BOM_ARTICLE_CODE AS ARTICLE_CODE,S.PRODUCT_UID , --K.QUANTITY  
   S.PURCHASE_PRICE ,CAST(0 AS NUMERIC(10,2)) AS QUANTITY , S.PRODUCT_CODE,NEWID() AS ROW_ID,  
   PARA3.PARA3_NAME,PARA4.PARA4_NAME,MST.MEMO_ID  AS REF_WO_ID ,MST.MEMO_NO AS REF_WO_NO ,  
   CAST('''' AS VARCHAR(40)) AS REF_ROW_ID ,  
   CAST('''' AS VARCHAR(50)) AS REF_CUTTING_ID     
   FROM PRD_WO_ART_BOM A           
   JOIN ARTICLE B ON A.BOM_ARTICLE_CODE = B.ARTICLE_CODE           
   JOIN SECTIOND SD ON B.SUB_SECTION_CODE=SD.SUB_SECTION_CODE          
   JOIN SECTIONM SM ON SD.SECTION_CODE=SM.SECTION_CODE          
   JOIN PRD_WO_DET C ON A.REF_ROW_ID = C.ROW_ID   
   JOIN PRD_WO_MST MST ON MST.MEMO_ID=C.MEMO_ID           
   JOIN           
   (          
   SELECT A.ARTICLE_CODE,C.PARA1_CODE,C.PARA2_CODE,SUM(C.QUANTITY) AS QUANTITY ,A.ROW_ID           
   FROM PRD_WO_DET A         
   JOIN PRD_WO_MST B ON A.MEMO_ID=B.MEMO_ID    
   JOIN PRD_WO_SUB_DET C ON A.ROW_ID = C.REF_ROW_ID           
   WHERE  ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR B.MEMO_ID = '''+@CMEMOID+''')  
   GROUP BY A.ARTICLE_CODE,A.ROW_ID ,C.PARA1_CODE,C.PARA2_CODE         
   ) K  ON K.ROW_ID = C.ROW_ID     
   JOIN  
   (  
     SELECT ORDER_ID, BM_ARTICLE_CODE,COMP_CODE,PARA1_CODE,PARA2_CODE ,PENDING_QTY  
     FROM #TMPPENDINGFG3  
   ) P1 ON P1.ORDER_ID=MST.MEMO_ID   
     AND A.BOM_ARTICLE_CODE=P1.BM_ARTICLE_CODE  
     AND K.PARA1_CODE=P1.PARA1_CODE             
     AND K.PARA2_CODE=P1.PARA2_CODE  
     AND MST.MEMO_ID=P1.ORDER_ID  
     AND C.ARTICLE_CODE=P1.COMP_CODE  
   JOIN PARA1 COMP1 ON COMP1.PARA1_CODE = K.PARA1_CODE           
   JOIN PARA2 COMP2 ON COMP2.PARA2_CODE = K.PARA2_CODE          
   JOIN UOM D ON B.UOM_CODE = D.UOM_CODE           
   JOIN ARTICLE ARTCOM ON C.ARTICLE_CODE = ARTCOM.ARTICLE_CODE           
   JOIN PRD_SKU S ON A.BOM_ARTICLE_CODE = S.ARTICLE_CODE   
   JOIN PARA1 ON PARA1.PARA1_CODE = S.PARA1_CODE           
   JOIN PARA2 ON PARA2.PARA2_CODE = S.PARA2_CODE   
   JOIN PARA3 ON PARA3.PARA3_CODE = S.PARA3_CODE           
   JOIN PARA4 ON PARA4.PARA4_CODE = S.PARA4_CODE   
   --AND A.PARA1_CODE= S.PARA1_CODE  AND A.PARA2_CODE=S.PARA2_CODE   
   '  
  IF @CWHERE<>'DEF0000'  
   SET @CCMD=@CCMD+ ' AND ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR WORK_ORDER_ID='''+@CMEMOID+''') '   --AND ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR WORK_ORDER_ID='''+@CMEMOID+''')   
  ELSE         
   SET @CCMD=@CCMD+ ' AND WORK_ORDER_ID='''' '  
     
   SET @CCMD=@CCMD+ ' JOIN PRD_PMT P ON S.PRODUCT_UID = P.PRODUCT_UID           
   WHERE  P.DEPARTMENT_ID ='''+@CWHERE+''' AND P.QUANTITY_IN_STOCK>0   
   AND ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR MST.MEMO_ID ='''+@CMEMOID+''')  '  
   SET @CCMD=@CCMD+ ' GROUP BY ARTCOM.ARTICLE_NO ,C.ARTICLE_CODE ,K.PARA1_CODE,K.PARA2_CODE, COMP1.PARA1_NAME ,COMP2.PARA2_NAME ,    
   B.ARTICLE_NO,B.ARTICLE_NAME,B.ARTICLE_DESC,C.MEMO_ID,          
   D.UOM_NAME ,S.PARA1_CODE, PARA1.PARA1_NAME,S.PARA2_CODE ,PARA2.PARA2_NAME,SM.SECTION_NAME,          
   SD.SUB_SECTION_NAME,P.QUANTITY_IN_STOCK,P.DEPARTMENT_ID,A.BOM_ARTICLE_CODE ,S.PRODUCT_UID  ,S.PURCHASE_PRICE , S.PRODUCT_CODE         
   ,PARA3.PARA3_NAME,PARA4.PARA4_NAME,MST.MEMO_ID,MST.MEMO_NO,PENDING_QTY  '       
   PRINT @CCMD  
 EXEC SP_EXECUTESQL  @CCMD  
   
   
  
GOTO LAST   
  
  
  
  
  
LBL_PENDING_DET:  
     
 SELECT CAST(1 AS BIT)CHCK,D.*,RIGHT(D.REF_WO_ID,10) AS REF_WO_NO, ARTCOM.ARTICLE_NO AS COMPONENT,COMP1.PARA1_NAME AS COM_PARA1_NAME,COMP2.PARA2_NAME AS COM_PARA2_NAME    
  ,A.ARTICLE_NO,A.ARTICLE_NAME,A.ARTICLE_DESC,SM.SECTION_NAME,SD.SUB_SECTION_NAME,          
  P.QUANTITY_IN_STOCK ,P.QUANTITY_IN_STOCK AS ORG_STOCK_QTY,M.DEPT_ID ,P1.PARA1_NAME ,P2.PARA2_NAME,UOM.UOM_NAME ,S.PURCHASE_PRICE ,CAST(0 AS NUMERIC(10,2)) AS REQUIRED_QTY         
  FROM PRD_STK_TRANSFER_DET_PENDING D          
  JOIN PRD_STK_TRANSFER_MST_PENDING M ON D.MEMO_ID = M.MEMO_ID           
  JOIN PRD_SKU S ON D.PRODUCT_UID = S.PRODUCT_UID      
  JOIN PRD_PMT P ON D.PRODUCT_UID = P.PRODUCT_UID AND M.SOURCE_DEPARTMENT_ID = P.DEPARTMENT_ID           
  JOIN ARTICLE A ON S.ARTICLE_CODE = A.ARTICLE_CODE          
  JOIN SECTIOND SD ON SD.SUB_SECTION_CODE = A.SUB_SECTION_CODE          
  JOIN SECTIONM SM ON SM.SECTION_CODE = SD.SECTION_CODE          
  JOIN PARA1 P1 ON S.PARA1_CODE = P1.PARA1_CODE           
  JOIN PARA2 P2 ON S.PARA2_CODE = P2.PARA2_CODE           
  JOIN UOM ON UOM.UOM_CODE = A.UOM_CODE           
  LEFT OUTER JOIN PARA1 COMP1 ON COMP1.PARA1_CODE = D.COM_PARA1_CODE           
  LEFT OUTER JOIN PARA2 COMP2 ON COMP2.PARA2_CODE = D.COM_PARA2_CODE          
  LEFT OUTER JOIN ARTICLE ARTCOM  ON ARTCOM.ARTICLE_CODE = D.COMPONENT_CODE          
  WHERE M.MEMO_ID = @CMEMOID          
  ORDER BY ARTCOM.ARTICLE_NO,A.ARTICLE_NO DESC      
      
       
  SELECT '' AS ARTICLE_NO,'' AS ARTICLE_NAME,CAST(0 AS NUMERIC(10,2)) AS QUANTITY_IN_STOCK,    
  '' AS PARA1_NAME ,'' AS PARA2_NAME,'' AS UOM_NAME ,CAST(0 AS NUMERIC(10,2)) AS PURCHASE_PRICE    
   ,CAST(0 AS NUMERIC(10,2)) AS QUANTITY         
  WHERE  1=2    
      
         
GOTO LAST         
  
   
  
  
  
  
LBL_MATERIAL_DET:  
        
        
    SELECT CAST(0 AS BIT) AS CHCK, CAST('' AS VARCHAR(100)) AS MEMO_ID,  
 CAST('LATER'+ CAST(NEWID() AS VARCHAR(100)) AS VARCHAR(40)) AS ROW_ID,  
 AR.ARTICLE_CODE ,  
 AR.ARTICLE_NO,AR.ARTICLE_NAME,A.MEMO_ID AS WO_ID,  
 PARA1.PARA1_NAME COM_COLOR,PARA2.PARA2_NAME COM_SIZE,  
 CONVERT(NUMERIC(10,2),SUM(K.QUANTITY)/COUNT(A.ARTICLE_CODE)) AS WO_QTY,  
 ((ISNULL(STK.ISSUE_QTY,0))) AS PROCESS_QTY,  
 CONVERT(NUMERIC(10,2),SUM(K.QUANTITY)/COUNT(A.ARTICLE_CODE)-((ISNULL(STK.ISSUE_QTY,0))) ) AS PENDING_QTY,  
 ISSUE_QTY   AS ISSUE_QTY,  
 K.PARA1_CODE,K.PARA2_CODE  
 FROM PRD_WO_DET (NOLOCK) A    
 JOIN PRD_WO_MST MST ON MST.MEMO_ID=A.MEMO_ID  
 JOIN PRD_WO_SUB_DET K ON A.ROW_ID = K.REF_ROW_ID     
 JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE           
 JOIN UOM D ON B.UOM_CODE = D.UOM_CODE           
 JOIN PARA1 ON PARA1.PARA1_CODE = K.PARA1_CODE           
 JOIN PARA2 ON PARA2.PARA2_CODE = K.PARA2_CODE   
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=MST.ARTICLE_SET_CODE  
 JOIN  
 (  
   SELECT A.* ,REF_WO_ID    
   FROM PRD_STK_TRANSFER_MATERIAL_DET A  
   JOIN PRD_STK_TRANSFER_MST B ON A.MEMO_ID =B.MEMO_ID   
   JOIN   
   (  
     SELECT C.MEMO_ID,C.REF_ROW_ID,C.REF_WO_ID  
     FROM PRD_STK_TRANSFER_DET C  
     GROUP BY C.MEMO_ID,C.REF_ROW_ID,C.REF_WO_ID  
   ) C ON A.MEMO_ID=C.MEMO_ID AND A.ROW_ID=C.REF_ROW_ID  
   WHERE SOURCE_DEPARTMENT_ID=@CWHERE  
   AND A.MEMO_ID =@CMEMOID  
 ) STK    
 ON STK.REF_WO_ID=MST.MEMO_ID   
 AND PARA1.PARA1_CODE=STK.PARA1_CODE   
 AND PARA2.PARA2_CODE=STK.PARA2_CODE  
 WHERE   
 --A.MEMO_ID=@CMEMOID AND  
 --AND @CWHERE='DEF0000'  
  MST.CANCELLED=0  
 GROUP BY AR.ARTICLE_NO,AR.ARTICLE_CODE ,AR.ARTICLE_NAME,A.MEMO_ID ,  
 PARA1.PARA1_NAME ,PARA2.PARA2_NAME,K.PARA1_CODE,K.PARA2_CODE ,STK.ISSUE_QTY  
   
  
GOTO LAST    
  
LBLGETCOMP_DET:  
   
   
 DECLARE @WORKORDER_ID VARCHAR(100)  
 IF @CWHERE='DEF0000'  
 SET @WORKORDER_ID=''  
 ELSE   
 SELECT TOP 1 @WORKORDER_ID=REF_WO_ID FROM PRD_STK_TRANSFER_DET WHERE MEMO_ID=@CMEMOID  
   
   
 SELECT  CAST(0 AS BIT) AS CHCK, CAST('' AS VARCHAR(100)) AS MEMO_ID,  
 CAST('LATER'+ CAST(NEWID() AS VARCHAR(100)) AS VARCHAR(40)) AS ROW_ID,  
 AR.ARTICLE_CODE ,  
 AR.ARTICLE_NO,AR.ARTICLE_NAME,A.MEMO_ID AS WO_ID,  
 PARA1.PARA1_NAME COM_COLOR,PARA2.PARA2_NAME COM_SIZE,  
 CONVERT(NUMERIC(10,2),SUM(K.QUANTITY)/COUNT(A.ARTICLE_CODE))-(ISNULL(CNC_QTY,0)) AS WO_QTY,  
 (ISNULL(STK.ISSUE_QTY,0)) AS PROCESS_QTY,  
 CONVERT(NUMERIC(10,2),SUM(K.QUANTITY)/COUNT(A.ARTICLE_CODE)-(ISNULL(STK.ISSUE_QTY,0))) AS PENDING_QTY,  
 CAST(0 AS NUMERIC(10,2)) AS ISSUE_QTY,  
 K.PARA1_CODE,K.PARA2_CODE  
 FROM PRD_WO_MST MST (NOLOCK)
 JOIN PRD_WO_DET (NOLOCK) A ON MST.MEMO_ID =A.MEMO_ID 
 JOIN
	(
	 SELECT PARA1_CODE,PARA2_CODE,REF_ROW_ID,SUM(QUANTITY) AS QUANTITY 
	 FROM PRD_WO_SUB_DET C
	 GROUP BY REF_ROW_ID,PARA1_CODE,PARA2_CODE
 ) K ON A.ROW_ID=K.REF_ROW_ID    
 JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE           
 JOIN UOM D ON B.UOM_CODE = D.UOM_CODE           
 JOIN PARA1 ON PARA1.PARA1_CODE = K.PARA1_CODE           
 JOIN PARA2 ON PARA2.PARA2_CODE = K.PARA2_CODE   
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=MST.ARTICLE_SET_CODE  
 JOIN  
 (  
  SELECT DET.MEMO_ID   
  FROM PRD_WO_ART_BOM A  
  JOIN PRD_WO_DET DET ON A.REF_ROW_ID=DET.ROW_ID  
  JOIN PRD_SKU B ON A.BOM_ARTICLE_CODE=B.ARTICLE_CODE  
  JOIN PRD_PMT C ON B.PRODUCT_UID=C.PRODUCT_UID   
  WHERE QUANTITY_IN_STOCK>0   
  AND DET.MEMO_ID=@CMEMOID   
  AND B.WORK_ORDER_ID=@WORKORDER_ID  
  AND C.DEPARTMENT_ID=@CWHERE  
  GROUP BY DET.MEMO_ID   
 )PMT ON PMT.MEMO_ID=A.MEMO_ID  
 LEFT OUTER JOIN  
 (  
   SELECT ARTICLE_CODE,PARA1_CODE,PARA2_CODE,B.REF_WO_ID ,  
   SUM(QUANTITY) AS CNC_QTY   
   FROM PRD_WO_CNC_MST A  
   JOIN PRD_WO_CNC_DET B ON A.MEMO_ID =B.MEMO_ID  
   WHERE A.CANCELLED=0  
   GROUP BY ARTICLE_CODE,PARA1_CODE,PARA2_CODE,B.REF_WO_ID   
 ) CNC ON CNC.REF_WO_ID=A.MEMO_ID  
   AND CNC.PARA1_CODE=PARA1.PARA1_CODE  
   AND CNC.PARA2_CODE=PARA2.PARA2_CODE  
 LEFT OUTER JOIN  
 (  
   SELECT C.REF_WO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,  
   SUM(A.ISSUE_QTY) AS ISSUE_QTY   
   FROM PRD_STK_TRANSFER_MATERIAL_DET A  
   JOIN PRD_STK_TRANSFER_MST B ON A.MEMO_ID =B.MEMO_ID  
   JOIN   
   (  
     SELECT C.MEMO_ID,C.REF_ROW_ID,REF_WO_ID  
     FROM PRD_STK_TRANSFER_DET C  
     GROUP BY C.MEMO_ID,C.REF_ROW_ID,REF_WO_ID  
   ) C ON A.MEMO_ID=C.MEMO_ID   
   AND A.ROW_ID=C.REF_ROW_ID  
   WHERE   
   CANCELLED=0   
   AND REF_WO_ID=@CMEMOID  
   GROUP BY  C.REF_WO_ID,A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE  
     
 ) STK ON STK.REF_WO_ID=MST.MEMO_ID   
 AND PARA1.PARA1_CODE=STK.PARA1_CODE   
 AND PARA2.PARA2_CODE=STK.PARA2_CODE  
 WHERE A.MEMO_ID=@CMEMOID   
 AND MST.CANCELLED=0  
 AND MST.MARK_AS_COMPLETED=1  
 GROUP BY AR.ARTICLE_NO,AR.ARTICLE_CODE ,AR.ARTICLE_NAME,A.MEMO_ID ,  
 PARA1.PARA1_NAME ,PARA2.PARA2_NAME,K.PARA1_CODE,K.PARA2_CODE,STK.ISSUE_QTY,CNC_QTY   
 HAVING CONVERT(NUMERIC(10,2),SUM(K.QUANTITY)/COUNT(A.ARTICLE_CODE)-  (ISNULL(STK.ISSUE_QTY,0)+ISNULL(CNC_QTY,0)))>0  
   
  
  
GOTO LAST  
  
LBLARTBOM_DET:  
         
       IF @CPRODUCTCODE<>''  
        SET @CPRODUCTCODE='  WHERE C.PARA1_CODE '+@CPRODUCTCODE  
       IF @CPARA2_CODE<>''  
       SET @CPRODUCTCODE=@CPRODUCTCODE+'  AND C.PARA2_CODE '+@CPARA2_CODE  
         
         
SET @CCMD= N'SELECT CHCK,ARTICLE_NO,REF_WO_ID,REF_WO_NO,  
             SUM(A.AVG_QTY) AS AVG_QTY,  
             SUM(A.REQUIRED_QTY) AS REQUIRED_QTY,  
             QUANTITY_IN_STOCK,  
            CAST(0 AS NUMERIC(10,2)) AS ISSUE_QTY  
            FROM  
           (  
    SELECT CAST(0 AS BIT) AS CHCK, C.ARTICLE_NO,C.ARTICLE_CODE,  
    B.MEMO_ID AS REF_WO_ID,  
    RIGHT(B.MEMO_ID,10) AS REF_WO_NO  
    ,AVG_QTY  
    ,QUANTITY_IN_STOCK  
    ,CONVERT(NUMERIC(12,2),AVG_QTY * DET.QUANTITY) AS REQUIRED_QTY          
    FROM PRD_WO_ART_BOM A (NOLOCK)        
    JOIN  PRD_WO_DET B (NOLOCK) ON A.REF_ROW_ID = B.ROW_ID      
    JOIN  
    (  
     SELECT REF_ROW_ID,SUM(QUANTITY) AS QUANTITY   
     FROM PRD_WO_SUB_DET C  
     '+@CPRODUCTCODE+'   
     GROUP BY REF_ROW_ID  
    ) DET ON B.ROW_ID=DET.REF_ROW_ID  
    JOIN ARTICLE C (NOLOCK) ON A.BOM_ARTICLE_CODE = C.ARTICLE_CODE   
    JOIN  
    (  
     SELECT A.ARTICLE_CODE,SUM(QUANTITY_IN_STOCK) AS QUANTITY_IN_STOCK   
     FROM PRD_SKU A  
     JOIN PRD_PMT B ON A.PRODUCT_UID=B.PRODUCT_UID  
     WHERE  B.DEPARTMENT_ID ='''+@CWHERE+'''  '--AND B.QUANTITY_IN_STOCK>0  
    IF @CWHERE<>'DEF0000'  
    SET @CCMD=@CCMD+ ' AND ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR WORK_ORDER_ID='''+@CMEMOID+''') '     
    ELSE         
    SET @CCMD=@CCMD+ ' AND WORK_ORDER_ID='''' '  
    +'  
      
     GROUP BY A.ARTICLE_CODE  
    )  PMT ON PMT.ARTICLE_CODE  =C.ARTICLE_CODE                 
    WHERE   
    ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR B.MEMO_ID='''+@CMEMOID+''')       
               
   ) A            
   GROUP BY CHCK,ARTICLE_NO,REF_WO_ID,REF_WO_NO,QUANTITY_IN_STOCK'  
    
 PRINT @CCMD  
 EXEC SP_EXECUTESQL @CCMD   
  
GOTO LAST  
  
LBLCOMP_DET:  
       
                
SET @CCMD= N'SELECT CHCK,ARTICLE_NO,REF_WO_ID,REF_WO_NO,  
             SUM(A.AVG_QTY) AS AVG_QTY,  
             SUM(A.REQUIRED_QTY) AS REQUIRED_QTY,  
            CAST(0 AS NUMERIC(10,2)) AS ISSUE_QTY  
            FROM  
           (  
    SELECT CAST(0 AS BIT) AS CHCK, C.ARTICLE_NO,B.ARTICLE_CODE,  
    B.MEMO_ID AS REF_WO_ID,  
    RIGHT(B.MEMO_ID,10) AS REF_WO_NO  
    ,AVG_QTY  
    ,CONVERT(NUMERIC(12,2),AVG_QTY * '+STR(@NQTY)+') AS REQUIRED_QTY   --CHANGES BY DET QUANTITYT       
    FROM PRD_WO_ART_BOM A (NOLOCK)        
    JOIN  PRD_WO_DET B (NOLOCK) ON A.REF_ROW_ID = B.ROW_ID      
    JOIN  
    (  
     SELECT REF_ROW_ID,SUM(QUANTITY) AS QUANTITY   
     FROM PRD_WO_SUB_DET C  
     WHERE C.PARA1_CODE='''+@CPRODUCTCODE+'''  
     AND C.PARA2_CODE='''+@CPARA2_CODE+'''  
     GROUP BY REF_ROW_ID  
    ) DET ON B.ROW_ID=DET.REF_ROW_ID  
    JOIN ARTICLE C (NOLOCK) ON B.ARTICLE_CODE = C.ARTICLE_CODE                
    WHERE   
    ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR B.MEMO_ID='''+@CMEMOID+''')       
               
   ) A            
   GROUP BY CHCK,ARTICLE_NO,REF_WO_ID,REF_WO_NO'  
    
 PRINT @CCMD  
 EXEC SP_EXECUTESQL @CCMD   
   
GOTO LAST  
  
  
LBLNAVIGATE:          
 EXECUTE SP_NAVIGATE 'PRD_STK_TRANSFER_MST',@NNAVMODE,@CMEMOID,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERE          
GOTO LAST   
  
  
LBLNAVIGATE_PENDING:          
 EXECUTE SP_NAVIGATE 'PRD_STK_TRANSFER_MST_PENDING',@NNAVMODE,@CMEMOID,@CFINYEAR,'MEMO_NO','MEMO_DT','MEMO_ID',@CWHERE          
GOTO LAST   
  
       
LBLGETMASTERS_PENDING:          
  SELECT T1.*, T3.DEPARTMENT_NAME AS TARGET_DEPARTMENT_NAME, T4.DEPARTMENT_NAME AS SOURCE_DEPARTMENT_NAME  
  FROM PRD_STK_TRANSFER_MST_PENDING T1          
  JOIN PRD_DEPARTMENT_MST T3 ON T3.DEPARTMENT_ID = T1.TARGET_DEPARTMENT_ID          
  JOIN PRD_DEPARTMENT_MST T4 ON T4.DEPARTMENT_ID = T1.SOURCE_DEPARTMENT_ID         
  WHERE T1.MEMO_ID = @CMEMOID          
           
GOTO LAST          
                 
          
LBLGETMASTERS:          
  SELECT T1.*, T3.DEPARTMENT_NAME AS TARGET_DEPARTMENT_NAME, T4.DEPARTMENT_NAME AS SOURCE_DEPARTMENT_NAME  
  FROM PRD_STK_TRANSFER_MST T1          
  JOIN PRD_DEPARTMENT_MST T3 ON T3.DEPARTMENT_ID = T1.TARGET_DEPARTMENT_ID          
  JOIN PRD_DEPARTMENT_MST T4 ON T4.DEPARTMENT_ID = T1.SOURCE_DEPARTMENT_ID         
  WHERE T1.MEMO_ID = @CMEMOID          
           
GOTO LAST          
          
LBLGETDETAILS:          
            
  SELECT CAST(1 AS BIT)CHCK,D.*,RIGHT(D.REF_WO_ID,10) AS REF_WO_NO , A.ARTICLE_NO,A.ARTICLE_NAME,A.ARTICLE_DESC,SM.SECTION_NAME,SD.SUB_SECTION_NAME,          
  P.QUANTITY_IN_STOCK,M.DEPT_ID ,P1.PARA1_NAME ,P2.PARA2_NAME,UOM.UOM_NAME ,  
  CAST('' AS VARCHAR(100)) AS REF_CUTTING_ID          
  FROM PRD_STK_TRANSFER_DET D          
  JOIN PRD_STK_TRANSFER_MST M ON D.MEMO_ID = M.MEMO_ID           
  JOIN SKU S ON D.PRODUCT_CODE = S.PRODUCT_CODE           
  JOIN PMT01106 P ON D.PRODUCT_CODE = P.PRODUCT_CODE AND M.DEPT_ID = P.DEPT_ID           
  JOIN ARTICLE A ON S.ARTICLE_CODE = A.ARTICLE_CODE          
  JOIN SECTIOND SD ON SD.SUB_SECTION_CODE = A.SUB_SECTION_CODE          
  JOIN SECTIONM SM ON SM.SECTION_CODE = SD.SECTION_CODE          
  JOIN PARA1 P1 ON S.PARA1_CODE = P1.PARA1_CODE           
  JOIN PARA2 P2 ON S.PARA2_CODE = P2.PARA2_CODE           
  JOIN UOM ON UOM.UOM_CODE = A.UOM_CODE        
      
  WHERE M.MEMO_ID = @CMEMOID          
  ORDER BY D.TS DESC          
            
 GOTO LAST          
          
          
          
LBLGETDEPARTMENT:          
  SELECT * FROM PRD_DEPARTMENT_MST           
  WHERE (DEPARTMENT_ID <> @CWHERE) AND INACTIVE = 0          
  ORDER BY DEPARTMENT_NAME           
GOTO LAST          
          
LBLGETPRODUCTLIST:          
  SELECT DISTINCT S.PRODUCT_CODE, A.ARTICLE_NO,A.ARTICLE_NAME,A.ARTICLE_DESC,SM.SECTION_NAME,SD.SUB_SECTION_NAME,          
  P1.PARA1_NAME ,P2.PARA2_NAME ,UOM.UOM_NAME    
  FROM SKU S           
  JOIN ARTICLE A ON S.ARTICLE_CODE = A.ARTICLE_CODE          
  JOIN SECTIOND SD ON SD.SUB_SECTION_CODE = A.SUB_SECTION_CODE          
  JOIN SECTIONM SM ON SM.SECTION_CODE = SD.SECTION_CODE          
  JOIN PARA1 P1 ON S.PARA1_CODE = P1.PARA1_CODE           
  JOIN PARA2 P2 ON S.PARA2_CODE = P2.PARA2_CODE           
  JOIN UOM ON UOM.UOM_CODE = A.UOM_CODE           
  WHERE  S.PRODUCT_CODE <> ''AND A.CODING_SCHEME IN(1,2)          
GOTO LAST          
          
          
LBLGETWORKORDERMASTER:   
IF @CWHERE <>'DEF0000'  
SELECT DISTINCT T1.*,CONVERT(CHAR(10),ISNULL(T1.MEMO_DT,''),105) AS MEMO_DATE,ART.ARTICLE_NO             
    FROM PRD_WO_MST T1            
    JOIN PRD_WO_DET T2 ON T2.MEMO_ID = T1.MEMO_ID            
    JOIN ARTICLE ART ON T1.ARTICLE_SET_CODE = ART.ARTICLE_CODE        
 JOIN   
  (  
  SELECT DISTINCT S.WORK_ORDER_ID AS [WO_ID]   
  FROM PRD_PMT A (NOLOCK)   
  JOIN PRD_SKU S ON A.PRODUCT_UID= S.PRODUCT_UID   
  WHERE  DEPARTMENT_ID=@CWHERE   
  AND (WIP > 0 OR QUANTITY_IN_STOCK > 0)  
  )SUB ON SUB.WO_ID=T1.MEMO_ID       
    WHERE T1.CANCELLED = 0 AND T1.MARK_AS_COMPLETED =1            
  
ELSE      
 SELECT DISTINCT T1.*,CONVERT(CHAR(10),ISNULL(T1.MEMO_DT,''),105) AS MEMO_DATE,ART.ARTICLE_NO             
    FROM PRD_WO_MST T1            
    JOIN PRD_WO_DET T2 ON T2.MEMO_ID = T1.MEMO_ID            
    JOIN ARTICLE ART ON T1.ARTICLE_SET_CODE = ART.ARTICLE_CODE        
    WHERE T1.CANCELLED = 0 AND T1.MARK_AS_COMPLETED =1    
             
 --SELECT DISTINCT T1.*,CONVERT(CHAR(10),ISNULL(T1.MEMO_DT,''),105) AS MEMO_DATE,ART.ARTICLE_NO           
 --   FROM PRD_WO_MST T1          
 --   JOIN PRD_WO_DET T2 ON T2.MEMO_ID = T1.MEMO_ID          
 --   JOIN ARTICLE ART ON T1.ARTICLE_SET_CODE = ART.ARTICLE_CODE           
 --   WHERE T1.CANCELLED = 0 AND T1.MARK_AS_COMPLETED =1          
GOTO LAST          
          
LBLGETWODET:          
  SELECT CAST(1 AS BIT)CHCK, B.ARTICLE_NO,B.ARTICLE_NAME,B.ARTICLE_DESC,C.MEMO_ID,          
  D.UOM_NAME ,A.PARA1_CODE, PARA1.PARA1_NAME,B.PARA2_CODE ,PARA2.PARA2_NAME,SM.SECTION_NAME,SD.SUB_SECTION_NAME,          
  P.QUANTITY_IN_STOCK,P.DEPT_ID,SUM(A.AVG_QTY * K.QUANTITY) AS QUANTITY          
  ,A.BOM_ARTICLE_CODE AS ARTICLE_CODE,S.PRODUCT_CODE           
  FROM PRD_WO_ART_BOM A    
  JOIN ARTICLE B ON A.BOM_ARTICLE_CODE = B.ARTICLE_CODE          
  JOIN SECTIOND SD ON B.SUB_SECTION_CODE=SD.SUB_SECTION_CODE          
  JOIN SECTIONM SM ON SD.SECTION_CODE=SM.SECTION_CODE          
  JOIN PRD_WO_DET C ON A.REF_ROW_ID = C.ROW_ID           
  JOIN           
  (          
    SELECT A.ARTICLE_CODE,SUM(C.QUANTITY) AS QUANTITY ,A.ROW_ID           
    FROM PRD_WO_DET A           
    JOIN PRD_WO_SUB_DET C ON A.ROW_ID = C.REF_ROW_ID         
    WHERE A.MEMO_ID = @CMEMOID           
    GROUP BY A.ARTICLE_CODE,A.ROW_ID          
  ) K  ON K.ROW_ID = C.ROW_ID           
  JOIN PARA1 ON PARA1.PARA1_CODE = A.PARA1_CODE           
  JOIN PARA2 ON PARA2.PARA2_CODE = B.PARA2_CODE          
  JOIN UOM D ON B.UOM_CODE = D.UOM_CODE           
  JOIN ARTICLE ARTCOM ON C.ARTICLE_CODE = ARTCOM.ARTICLE_CODE           
  JOIN SKU S ON A.BOM_ARTICLE_CODE = S.ARTICLE_CODE  AND A.PARA1_CODE= S.PARA1_CODE           
  AND A.PARA2_CODE= S.PARA2_CODE          
  JOIN PMT01106 P ON S.PRODUCT_CODE = P.PRODUCT_CODE           
  WHERE  P.DEPT_ID =@CWHERE  AND C.MEMO_ID =@CMEMOID          
  GROUP BY B.ARTICLE_NO,B.ARTICLE_NAME,B.ARTICLE_DESC,C.MEMO_ID,          
  D.UOM_NAME ,A.PARA1_CODE, PARA1.PARA1_NAME,B.PARA2_CODE ,PARA2.PARA2_NAME,SM.SECTION_NAME,          
  SD.SUB_SECTION_NAME,P.QUANTITY_IN_STOCK,P.DEPT_ID,A.BOM_ARTICLE_CODE ,S.PRODUCT_CODE        
           
 GOTO LAST          
        
        
        
LBLGETWODETPROD:     
 
SET @CCMD= N' SELECT CAST(0 AS BIT)CHCK,ARTCOM.ARTICLE_NO AS COMPONENT ,C.ARTICLE_CODE AS COMPONENT_CODE,  
   K.PARA1_CODE AS COM_PARA1_CODE,K.PARA2_CODE AS COM_PARA2_CODE, COMP1.PARA1_NAME AS COM_PARA1_NAME,  
   COMP2.PARA2_NAME AS COM_PARA2_NAME  , B.ARTICLE_NO,B.ARTICLE_NAME,B.ARTICLE_DESC,C.MEMO_ID,          
   D.UOM_NAME ,S.PARA1_CODE, PARA1.PARA1_NAME,S.PARA2_CODE ,PARA2.PARA2_NAME,SM.SECTION_NAME,  
   SD.SUB_SECTION_NAME, P.QUANTITY_IN_STOCK,P.QUANTITY_IN_STOCK AS ORG_STOCK_QTY,P.DEPARTMENT_ID,  
   SUM(A.AVG_QTY * '+STR(@NQTY)+') AS REQUIRED_QTY  ,A.BOM_ARTICLE_CODE AS ARTICLE_CODE,S.PRODUCT_UID , --K.QUANTITY  
   S.PURCHASE_PRICE ,CAST(0 AS NUMERIC(10,2)) AS QUANTITY , S.PRODUCT_CODE,NEWID() AS ROW_ID,  
   PARA3.PARA3_NAME,PARA4.PARA4_NAME,MST.MEMO_ID  AS REF_WO_ID ,MST.MEMO_NO AS REF_WO_NO ,  
   CAST('''' AS VARCHAR(40)) AS REF_ROW_ID     
   FROM PRD_WO_ART_BOM A           
   JOIN ARTICLE B ON A.BOM_ARTICLE_CODE = B.ARTICLE_CODE           
   JOIN SECTIOND SD ON B.SUB_SECTION_CODE=SD.SUB_SECTION_CODE          
   JOIN SECTIONM SM ON SD.SECTION_CODE=SM.SECTION_CODE          
   JOIN PRD_WO_DET C ON A.REF_ROW_ID = C.ROW_ID   
   JOIN PRD_WO_MST MST ON MST.MEMO_ID=C.MEMO_ID           
   JOIN           
   (          
   SELECT A.ARTICLE_CODE,C.PARA1_CODE,C.PARA2_CODE,SUM(C.QUANTITY) AS QUANTITY ,A.ROW_ID           
   FROM PRD_WO_DET A           
   JOIN PRD_WO_SUB_DET C ON A.ROW_ID = C.REF_ROW_ID           
   WHERE  ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR A.MEMO_ID = '''+@CMEMOID+''')  
   AND C.PARA1_CODE='''+@CPRODUCTCODE+'''  
   AND C.PARA2_CODE='''+@CPARA2_CODE+'''  
   GROUP BY A.ARTICLE_CODE,A.ROW_ID ,C.PARA1_CODE,C.PARA2_CODE         
   ) K  ON K.ROW_ID = C.ROW_ID                  
   JOIN PARA1 COMP1 ON COMP1.PARA1_CODE = K.PARA1_CODE           
   JOIN PARA2 COMP2 ON COMP2.PARA2_CODE = K.PARA2_CODE          
   JOIN UOM D ON B.UOM_CODE = D.UOM_CODE           
   JOIN ARTICLE ARTCOM ON C.ARTICLE_CODE = ARTCOM.ARTICLE_CODE           
   JOIN PRD_SKU S ON A.BOM_ARTICLE_CODE = S.ARTICLE_CODE    
   JOIN PARA1 ON PARA1.PARA1_CODE = S.PARA1_CODE           
   JOIN PARA2 ON PARA2.PARA2_CODE = S.PARA2_CODE   
   JOIN PARA3 ON PARA3.PARA3_CODE = S.PARA3_CODE           
   JOIN PARA4 ON PARA4.PARA4_CODE = S.PARA4_CODE   
   --AND A.PARA1_CODE= S.PARA1_CODE  AND A.PARA2_CODE=S.PARA2_CODE   
   '  
  IF @CWHERE<>'DEF0000'  
   SET @CCMD=@CCMD+ ' AND ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR WORK_ORDER_ID='''+@CMEMOID+''') '     
  ELSE         
   SET @CCMD=@CCMD+ ' AND WORK_ORDER_ID='''' '  
     
   SET @CCMD=@CCMD+ ' JOIN PRD_PMT P ON S.PRODUCT_UID = P.PRODUCT_UID           
   WHERE  P.DEPARTMENT_ID ='''+@CWHERE+''' AND P.QUANTITY_IN_STOCK>0   
   AND ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR C.MEMO_ID ='''+@CMEMOID+''')  '  
  IF @CWHERE<>'DEF0000'  
   SET @CCMD=@CCMD+ ' AND ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR ISNULL(S.WORK_ORDER_ID,'''')='''+@CMEMOID+''') '     
  ELSE         
   SET @CCMD=@CCMD+ ' AND ('''+RTRIM(LTRIM(@CMEMOID))+'''='''' OR ISNULL(S.WORK_ORDER_ID,'''')='''') '  
    
   SET @CCMD=@CCMD+ ' GROUP BY ARTCOM.ARTICLE_NO ,C.ARTICLE_CODE ,K.PARA1_CODE,K.PARA2_CODE, COMP1.PARA1_NAME ,COMP2.PARA2_NAME ,    
   B.ARTICLE_NO,B.ARTICLE_NAME,B.ARTICLE_DESC,C.MEMO_ID,          
   D.UOM_NAME ,S.PARA1_CODE, PARA1.PARA1_NAME,S.PARA2_CODE ,PARA2.PARA2_NAME,SM.SECTION_NAME,          
   SD.SUB_SECTION_NAME,P.QUANTITY_IN_STOCK,P.DEPARTMENT_ID,A.BOM_ARTICLE_CODE ,S.PRODUCT_UID  ,S.PURCHASE_PRICE , S.PRODUCT_CODE         
   ,PARA3.PARA3_NAME,PARA4.PARA4_NAME,MST.MEMO_ID,MST.MEMO_NO  '       
   PRINT @CCMD  
 EXEC SP_EXECUTESQL  @CCMD  
   
GOTO LAST        
        
LBLGETDETAILSPROD:      
 SELECT CAST(1 AS BIT)CHCK,D.*,RIGHT(D.REF_WO_ID,10) AS REF_WO_NO, ARTCOM.ARTICLE_NO AS COMPONENT,COMP1.PARA1_NAME AS COM_PARA1_NAME,COMP2.PARA2_NAME AS COM_PARA2_NAME    
  ,A.ARTICLE_NO,A.ARTICLE_NAME,A.ARTICLE_DESC,SM.SECTION_NAME,SD.SUB_SECTION_NAME,          
  P.QUANTITY_IN_STOCK ,P.QUANTITY_IN_STOCK AS ORG_STOCK_QTY,M.DEPT_ID ,P1.PARA1_NAME ,P2.PARA2_NAME,UOM.UOM_NAME ,S.PURCHASE_PRICE ,CAST(0 AS NUMERIC(10,2)) AS REQUIRED_QTY         
  FROM PRD_STK_TRANSFER_DET D          
  JOIN PRD_STK_TRANSFER_MST M ON D.MEMO_ID = M.MEMO_ID           
  JOIN PRD_SKU S ON D.PRODUCT_UID = S.PRODUCT_UID      
  JOIN PRD_PMT P ON D.PRODUCT_UID = P.PRODUCT_UID AND M.SOURCE_DEPARTMENT_ID = P.DEPARTMENT_ID           
  JOIN ARTICLE A ON S.ARTICLE_CODE = A.ARTICLE_CODE          
  JOIN SECTIOND SD ON SD.SUB_SECTION_CODE = A.SUB_SECTION_CODE          
  JOIN SECTIONM SM ON SM.SECTION_CODE = SD.SECTION_CODE          
  JOIN PARA1 P1 ON S.PARA1_CODE = P1.PARA1_CODE           
  JOIN PARA2 P2 ON S.PARA2_CODE = P2.PARA2_CODE           
  JOIN UOM ON UOM.UOM_CODE = A.UOM_CODE           
  LEFT OUTER JOIN PARA1 COMP1 ON COMP1.PARA1_CODE = D.COM_PARA1_CODE           
  LEFT OUTER JOIN PARA2 COMP2 ON COMP2.PARA2_CODE = D.COM_PARA2_CODE          
  LEFT OUTER JOIN ARTICLE ARTCOM  ON ARTCOM.ARTICLE_CODE = D.COMPONENT_CODE          
  WHERE M.MEMO_ID = @CMEMOID          
  ORDER BY ARTCOM.ARTICLE_NO,A.ARTICLE_NO DESC      
      
       
  SELECT '' AS ARTICLE_NO,'' AS ARTICLE_NAME,CAST(0 AS NUMERIC(10,2)) AS QUANTITY_IN_STOCK,    
  '' AS PARA1_NAME ,'' AS PARA2_NAME,'' AS UOM_NAME ,CAST(0 AS NUMERIC(10,2)) AS PURCHASE_PRICE    
   ,CAST(0 AS NUMERIC(10,2)) AS QUANTITY         
  WHERE  1=2    
      
         
GOTO LAST      
  
  
LBLGETWODETPROD_RET:      
SELECT CAST(0 AS BIT)CHCK,ARTCOM.ARTICLE_NO AS COMPONENT ,A.COMPONENT_CODE AS COMPONENT_CODE,  
   A.COM_PARA1_CODE ,A.COM_PARA2_CODE , COMP1.PARA1_NAME AS COM_PARA1_NAME,  
   COMP2.PARA2_NAME AS COM_PARA2_NAME  , B.ARTICLE_NO,B.ARTICLE_NAME,B.ARTICLE_DESC,  
   A.WORK_ORDER_ID AS MEMO_ID,    
   A.WORK_ORDER_ID REF_WO_ID,  
   MST.MEMO_NO AS REF_WO_NO,        
   D.UOM_NAME ,A.PARA1_CODE, PARA1.PARA1_NAME,B.PARA2_CODE ,PARA2.PARA2_NAME,SM.SECTION_NAME,  
   SD.SUB_SECTION_NAME, P.QUANTITY_IN_STOCK,P.QUANTITY_IN_STOCK AS ORG_STOCK_QTY,P.DEPARTMENT_ID,  
   CAST(0 AS NUMERIC) AS REQUIRED_QTY  ,A.ARTICLE_CODE,A.PRODUCT_UID ,  
   A.PURCHASE_PRICE ,P.QUANTITY_IN_STOCK AS QUANTITY  
   ,A.PRODUCT_CODE           
   FROM PRD_SKU A     
   JOIN PRD_WO_MST MST (NOLOCK) ON A.WORK_ORDER_ID=MST.MEMO_ID        
   JOIN ARTICLE ARTCOM ON A.COMPONENT_CODE = ARTCOM.ARTICLE_CODE           
   JOIN ARTICLE B ON A.ARTICLE_CODE = B.ARTICLE_CODE           
   JOIN PARA1 COMP1 ON COMP1.PARA1_CODE = A.COM_PARA1_CODE           
   JOIN PARA2 COMP2 ON COMP2.PARA2_CODE = A.COM_PARA2_CODE          
   JOIN UOM D ON B.UOM_CODE = D.UOM_CODE           
   JOIN PARA1 ON PARA1.PARA1_CODE = A.PARA1_CODE           
   JOIN PARA2 ON PARA2.PARA2_CODE = A.PARA2_CODE          
   JOIN SECTIOND SD ON B.SUB_SECTION_CODE=SD.SUB_SECTION_CODE          
   JOIN SECTIONM SM ON SD.SECTION_CODE=SM.SECTION_CODE          
   JOIN PRD_PMT P ON A.PRODUCT_UID = P.PRODUCT_UID           
  WHERE P.DEPARTMENT_ID=@CWHERE AND P.QUANTITY_IN_STOCK>0  
  --AND (@CMEMOID='' OR MST.MEMO_ID=@CMEMOID)  
  --AND (  
     
  --SELECT DISTINCT A.MEMO_ID AS WORK_ORDER_ID, A.REF_NO,A.MEMO_NO AS WORK_ORDER_NO   
  --FROM PRD_WO_MST A  
  --LEFT OUTER JOIN PRD_SKU SK ON SK.WORK_ORDER_ID=A.MEMO_ID     
  --WHERE ISNULL(SK.WORK_ORDER_ID,'')<>''  
 SELECT DISTINCT A.MEMO_ID AS WORK_ORDER_ID, A.REF_NO,A.MEMO_NO AS WORK_ORDER_NO,  
        A.MEMO_ID AS REF_WO_ID,A.MEMO_NO AS REF_WO_NO     
  FROM PRD_WO_MST A    
  LEFT OUTER JOIN PRD_SKU SK ON SK.WORK_ORDER_ID=A.MEMO_ID      
  JOIN   
  (  
  SELECT DISTINCT S.WORK_ORDER_ID AS [WO_ID]   
  FROM PRD_PMT A (NOLOCK)   
  JOIN PRD_SKU S ON A.PRODUCT_UID= S.PRODUCT_UID   
  WHERE  DEPARTMENT_ID=@CWHERE   
  AND (WIP > 0 OR QUANTITY_IN_STOCK > 0)  
  )SUB ON SUB.WO_ID=A.MEMO_ID      
  WHERE ISNULL(SK.WORK_ORDER_ID,'')<>''  AND A.CANCELLED=0  
 -- AND (@CMEMOID='' OR A.MEMO_ID=@CMEMOID)  
    
GOTO LAST        
  
       
LAST:          
END
