create PROCEDURE SP3S_REP_GST_DETAILS
(
 @NMODE INT=1,-- 1 FOR WITH GST% 2 FOR WITHOUT GST%
 @DFM_DT DATETIME='',
 @DTO_DT DATETIME='',
 @CDEPT_ID VARCHAR(5)='',
 @CCOLNAME VARCHAR(MAX)='',
 @NPAYMENT INT=1,
 @bdonotShowGst bit =0,
 @BfromtoBillNO bit=0
)
AS
BEGIN 

        DECLARE @DONOT_CAL_GST_ADV_RECE VARCHAR(10)
		SELECT TOP 1 @DONOT_CAL_GST_ADV_RECE=VALUE  FROM CONFIG WHERE CONFIG_OPTION='DONOT_CALCULATE_GST_ADV_RECEIPT'
 

        IF @DFM_DT<='2017-06-30'
        RETURN
        
      DECLARE @TBLDETAILS TABLE (ORD_SR INT,DEPT_ID VARCHAR(5),TRANSACTIONS_TYPE VARCHAR(50),
      TRANSACTIONS VARCHAR(50),BILL_NO VARCHAR(100),BILL_DT DATETIME,NET_AMOUNT NUMERIC(14,2),ROUND_OFF NUMERIC(14,2),
	  GST_ROUND_OFF NUMERIC(14,2),CUSTOMER_CODE VARCHAR(100),
      TYP VARCHAR(100),MODE INT,TAXABLE_VALUE NUMERIC(14,2),GST_AMOUNT NUMERIC(14,2),PARTY_TYPE INT,ORD VARCHAR(500),TRANSACTION_MODE VARCHAR(100),
      MRR_NO VARCHAR(50),MRR_DT VARCHAR(10),REF_NO VARCHAR(100),Party_gst_no VARCHAR(25),TARGET_DEPT_ALIAS varchar(100),
	  Gst_cess_amount numeric(14,2),user_Code varchar(20))
      
      --1.RETAIL SALE
      INSERT INTO @TBLDETAILS(ORD_SR,DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,TAXABLE_VALUE ,GST_AMOUNT,PARTY_TYPE,TRANSACTION_MODE,MRR_NO,MRR_DT,REF_NO,Party_gst_no,Gst_cess_amount,user_Code  )
       SELECT 1, DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,
              NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,
              SUM(TAXABLE_VALUE) AS TAXABLE_VALUE ,SUM(GST_AMOUNT) AS GST_AMOUNT,
              1 AS PARTY_TYPE,
              TRANSACTION_MODE ,
              CAST('' AS VARCHAR(100)) AS MRR_NO,
              CAST('' AS VARCHAR(100)) AS MRR_DT
			  ,REF_NO,isnull(Party_gst_no,'') as Party_gst_no
			  ,sum(isnull(Gst_cess_amount,0)) as Gst_cess_amount
			  ,user_Code
       FROM
       (
       SELECT a.location_code AS DEPT_ID ,
			   'GST PAYABLE' AS TRANSACTIONS_TYPE,
			   'RETAIL SALE' AS TRANSACTIONS,
			   A.CM_NO AS BILL_NO,
			   A.CM_DT AS BILL_DT,
			   A.NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(OTHER_CHARGES_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)) AS GST_AMOUNT,
			   CAST(CASE WHEN  A.PARTY_STATE_CODE <>L.GST_STATE_CODE  THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE,
			   A.REF_NO ,A.PARTY_GST_NO ,
			   0 as Gst_cess_amount,a.USER_CODE
		FROM CMM01106 A (NOLOCK)
		JOIN LOCATION L (NOLOCK) ON A.location_code=L.DEPT_ID 
		JOIN CUSTDYM CUST (NOLOCK) ON CUST.CUSTOMER_CODE =A.CUSTOMER_CODE
		WHERE A.CANCELLED=0 AND 
	    A.CM_DT BETWEEN @DFM_DT AND @DTO_DT
		AND A.OTHER_CHARGES_TAXABLE_VALUE<>0
		AND A.MEMO_TYPE IN(0,1)
		UNION ALL
		SELECT a.location_code AS DEPT_ID ,
			    'GST PAYABLE' AS TRANSACTIONS_TYPE,
			   'RETAIL SALE' AS TRANSACTIONS,
			   A.CM_NO AS BILL_NO,
			   A.CM_DT AS BILL_DT,
			   A.NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.CUSTOMER_CODE,
			   REPLACE(CASE WHEN B.TAX_PERCENTAGE>0 THEN 'VAT_'+CAST(TAX_PERCENTAGE AS VARCHAR(10)) ELSE 'GST_'+CAST(GST_PERCENTAGE AS VARCHAR(10)) END  ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(B.TAXABLE_VALUE,0)+ISNULL(B.TAXABLE_VALUE1,0) AS TAXABLE_VALUE,
			   GST_AMOUNT,
			   CAST(CASE WHEN  A.PARTY_STATE_CODE <>L.GST_STATE_CODE  THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE,
			   A.REF_NO ,A.PARTY_GST_NO ,
			   b.Gst_cess_amount,a.USER_CODE
		FROM CMM01106 A (NOLOCK)
		JOIN LOCATION L (NOLOCK) ON A.location_code=L.DEPT_ID 
		JOIN CUSTDYM CUST (NOLOCK) ON CUST.CUSTOMER_CODE =A.CUSTOMER_CODE
		JOIN
		(
		 SELECT CM_ID,GST_PERCENTAGE,TAX_PERCENTAGE,
				SUM(CASE WHEN XN_VALUE_WITHOUT_GST<0 THEN XN_VALUE_WITHOUT_GST ELSE 0 END ) AS TAXABLE_VALUE,
				SUM(CASE WHEN XN_VALUE_WITHOUT_GST>=0 THEN XN_VALUE_WITHOUT_GST ELSE 0 END ) AS TAXABLE_VALUE1,
				SUM(ISNULL(CGST_AMOUNT,0)+ISNULL(SGST_AMOUNT,0)+ISNULL(IGST_AMOUNT,0)) AS GST_AMOUNT,
				sum(isnull(Gst_cess_amount,0)) as Gst_cess_amount
		 FROM CMD01106 (NOLOCK)
		 --WHERE XN_VALUE_WITHOUT_GST<>0
		 GROUP BY CM_ID,GST_PERCENTAGE,TAX_PERCENTAGE
		) B ON A.CM_ID=B.CM_ID
	    WHERE A.CANCELLED=0 AND 
	    A.CM_DT BETWEEN @DFM_DT AND @DTO_DT
		AND A.MEMO_TYPE IN(0,1)
		) A
		GROUP BY DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,
        NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE,TRANSACTION_MODE ,A.REF_NO ,A.PARTY_GST_NO,USER_CODE
	    UNION ALL
	    
	     SELECT 1 AS ORDSR, A.location_Code  AS DEPT_ID ,
			    'GST PAYABLE' AS TRANSACTIONS_TYPE,
			   'RETAIL SALE' AS TRANSACTIONS,
			   A.CM_NO AS BILL_NO,
			   A.CM_DT AS BILL_DT,
			   A.NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.CUSTOMER_CODE,
			  (CASE WHEN  ISNULL(B.EDCPAYMENTMODE,'')<>'' THEN B.EDCPAYMENTMODE
			        WHEN D.PAYMODE_GRP_CODE='WCGV001' THEN D.PAYMODE_GRP_NAME ELSE   C.PAYMODE_NAME END)   TYP, 
			  -- CASE WHEN SUBSTRING(CM_NO,5,1)='N' THEN 'CREDIT NOTES' ELSE C.PAYMODE_NAME  END  AS TYP,
			   CAST(2 AS INT) AS MODE,
			   SUM(ISNULL(B.AMOUNT,0)) AS TAXABLE_VALUE,
			   0 AS GST_AMOUNT,
			   1 AS PARTY_TYPE,
			   CAST(CASE WHEN  A.PARTY_STATE_CODE <>L.GST_STATE_CODE  THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE,
			   CAST('' AS VARCHAR(100)) AS MRR_NO,
              CAST('' AS VARCHAR(100)) AS MRR_DT,
			  A.REF_NO ,isnull(A.PARTY_GST_NO,'') as  PARTY_GST_NO,
			  0 as Gst_cess_amount,a.USER_CODE
	     FROM CMM01106 A (NOLOCK)
	     JOIN LOCATION L (NOLOCK) ON A.location_code=L.DEPT_ID 
		 JOIN CUSTDYM CUST (NOLOCK) ON CUST.CUSTOMER_CODE =A.CUSTOMER_CODE
	     JOIN PAYMODE_XN_DET B (NOLOCK) ON A.CM_ID=B.MEMO_ID
	     JOIN PAYMODE_MST C (NOLOCK) ON B.PAYMODE_CODE=C.PAYMODE_CODE
	     JOIN PAYMODE_GRP_MST D (NOLOCK) ON c.PAYMODE_GRP_CODE = d.PAYMODE_GRP_CODE  
		 WHERE A.CANCELLED=0 AND A.CM_DT BETWEEN @DFM_DT AND @DTO_DT   
		 AND B.XN_TYPE='SLS'
		 AND A.MEMO_TYPE IN(0,1)
		 GROUP BY  A.location_code ,A.CM_NO,A.CM_DT,A.NET_AMOUNT,A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) , A.CUSTOMER_CODE,
		 (CASE  WHEN  ISNULL(B.EDCPAYMENTMODE,'')<>'' THEN B.EDCPAYMENTMODE
		        WHEN D.PAYMODE_GRP_CODE='WCGV001' THEN D.PAYMODE_GRP_NAME ELSE   C.PAYMODE_NAME END),
		-- CASE WHEN SUBSTRING(CM_NO,5,1)='N' THEN 'CREDIT NOTES' ELSE C.PAYMODE_NAME  END  ,
		 CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END,A.REF_NO ,A.PARTY_GST_NO,a.USER_CODE
		 
	
		--2 WHOSALE INVOICE
		
		
		 INSERT INTO @TBLDETAILS(ORD_SR,DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,TAXABLE_VALUE ,GST_AMOUNT,PARTY_TYPE ,TRANSACTION_MODE ,MRR_NO,MRR_DT,REF_NO ,PARTY_GST_NO ,TARGET_DEPT_ALIAS,a.USER_CODE )
         SELECT 2, DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,
              NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,
              SUM(TAXABLE_VALUE) AS TAXABLE_VALUE ,SUM(GST_AMOUNT) AS GST_AMOUNT,
              2 AS PARTY_TYPE,
              TRANSACTION_MODE ,
              CAST('' AS VARCHAR(100)) AS MRR_NO,
              CAST('' AS VARCHAR(100)) AS MRR_DT,
			   REF_NO , isnull(Party_gst_no,'') as Party_gst_no ,TARGET_DEPT_ALIAS,
			  a.USER_CODE
         FROM 
		(
		 SELECT 2 AS ORDSR, a.location_code AS DEPT_ID ,		   
               CASE WHEN ISNULL(CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END,'')=ISNULL(B.LOC_GST_NO ,'')
               THEN 'BILL OF SUPPLY' ELSE 'GST PAYABLE' END  AS TRANSACTIONS_TYPE,
			   CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS TRANSACTIONS,
			   A.INV_NO AS BILL_NO,
			   A.INV_DT AS BILL_DT,
			   A.NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(OTHER_CHARGES_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)) AS GST_AMOUNT,
			   2 AS PARTY_TYPE,
			   CAST(CASE WHEN  A.PARTY_STATE_CODE <>ISNULL(B.GST_STATE_CODE,'')  THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE,
			   '' as REF_NO ,
			   CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE TL.LOC_GST_NO END PARTY_GST_NO,
			   CASE WHEN A.INV_MODE =1 THEN '' ELSE TL.dept_alias END TARGET_DEPT_ALIAS,a.USER_CODE
			   --CAST(CASE WHEN  ISNULL(A.OTHER_CHARGES_IGST_AMOUNT ,0)>0 THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE
      FROM INM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_code
      LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      WHERE A.CANCELLED =0 AND A.OTHER_CHARGES>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0)>0
      AND A.INV_DT BETWEEN @DFM_DT AND @DTO_DT  
      UNION ALL
      
     SELECT 2 AS ORDSR, a.location_code AS DEPT_ID ,
			    CASE WHEN ISNULL(CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END,'')=ISNULL(B.LOC_GST_NO ,'')
               THEN 'BILL OF SUPPLY' ELSE 'GST PAYABLE' END  AS TRANSACTIONS_TYPE,
			   CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS TRANSACTIONS,
			   A.INV_NO AS BILL_NO,
			   A.INV_DT AS BILL_DT,
			   A.NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE ,
			   REPLACE('GST_'+CAST(ISNULL(FREIGHT_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.FREIGHT_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(FREIGHT_IGST_AMOUNT,0)+ISNULL(FREIGHT_CGST_AMOUNT,0)+ISNULL(FREIGHT_SGST_AMOUNT,0)) AS GST_AMOUNT,
			    2 AS PARTY_TYPE,
			    CAST(CASE WHEN  A.PARTY_STATE_CODE <>ISNULL(B.GST_STATE_CODE,'')  THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE,
				 '' as REF_NO ,
			   CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE TL.LOC_GST_NO END PARTY_GST_NO,
			    CASE WHEN A.INV_MODE =1 THEN '' ELSE TL.dept_alias END TARGET_DEPT_ALIAS,a.USER_CODE
      FROM INM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_code
      LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      WHERE A.CANCELLED =0 AND A.FREIGHT>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.FREIGHT_TAXABLE_VALUE,0)>0
      AND A.INV_DT BETWEEN @DFM_DT AND @DTO_DT  
      UNION ALL
      
      SELECT 2 AS ORDSR, a.location_code AS DEPT_ID ,
			    CASE WHEN ISNULL(CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END,'')=ISNULL(B.LOC_GST_NO ,'')
               THEN 'BILL OF SUPPLY' ELSE 'GST PAYABLE' END AS TRANSACTIONS_TYPE,
			   CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS TRANSACTIONS,
			   A.INV_NO AS BILL_NO,
			   A.INV_DT AS BILL_DT,
			   A.NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE ,
			   REPLACE('GST_'+CAST(ISNULL(INSURANCE_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.INSURANCE_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(INSURANCE_IGST_AMOUNT,0)+ISNULL(INSURANCE_CGST_AMOUNT,0)+ISNULL(INSURANCE_SGST_AMOUNT,0)) AS GST_AMOUNT,
			    2 AS PARTY_TYPE,
			    CAST(CASE WHEN  A.PARTY_STATE_CODE <>ISNULL(B.GST_STATE_CODE,'')   THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE,
				 '' as REF_NO ,
			   CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE TL.LOC_GST_NO END PARTY_GST_NO,
			    CASE WHEN A.INV_MODE =1 THEN '' ELSE TL.dept_alias END TARGET_DEPT_ALIAS,a.USER_CODE
      FROM INM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_code
      LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      WHERE A.CANCELLED =0 AND A.FREIGHT>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.INSURANCE_TAXABLE_VALUE,0)>0
      AND A.INV_DT BETWEEN @DFM_DT AND @DTO_DT  
      UNION ALL
      
      SELECT 2 AS ORDSR, a.location_code AS DEPT_ID ,
			    CASE WHEN ISNULL(CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END,'')=ISNULL(B.LOC_GST_NO ,'')
               THEN 'BILL OF SUPPLY' ELSE 'GST PAYABLE' END AS TRANSACTIONS_TYPE,
			   CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS TRANSACTIONS,
			   A.INV_NO AS BILL_NO,
			   A.INV_DT AS BILL_DT,
			   A.NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE ,
			   REPLACE('GST_'+CAST(ISNULL(PACKING_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.PACKING_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(PACKING_IGST_AMOUNT,0)+ISNULL(PACKING_CGST_AMOUNT,0)+ISNULL(PACKING_SGST_AMOUNT,0)) AS GST_AMOUNT,
			    2 AS PARTY_TYPE,
			   CAST(CASE WHEN  A.PARTY_STATE_CODE <>ISNULL(B.GST_STATE_CODE,'')   THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE,
			    '' as REF_NO ,
			   CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE TL.LOC_GST_NO END PARTY_GST_NO,
			    CASE WHEN A.INV_MODE =1 THEN '' ELSE TL.dept_alias END TARGET_DEPT_ALIAS,a.USER_CODE
      FROM INM01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_code
      LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      WHERE A.CANCELLED =0 AND A.FREIGHT>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.PACKING_TAXABLE_VALUE,0)>0
      AND A.INV_DT BETWEEN @DFM_DT AND @DTO_DT  
      UNION ALL
      
       SELECT 2 AS ORDSR, a.location_code AS DEPT_ID ,
			    CASE WHEN ISNULL(CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END,'')=ISNULL(LOC.LOC_GST_NO ,'')
               THEN 'BILL OF SUPPLY' ELSE 'GST PAYABLE' END AS TRANSACTIONS_TYPE,
			   CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS TRANSACTIONS,
			   A.INV_NO AS BILL_NO,
			   A.INV_DT AS BILL_DT,
			   A.NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE ,
			   REPLACE('GST_'+CAST(ISNULL(B.GST_PERCENTAGE ,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   SUM(ISNULL(B.XN_VALUE_WITHOUT_GST ,0)) AS TAXABLE_VALUE,
			   SUM((ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0))) AS GST_AMOUNT,
			   2 AS PARTY_TYPE,
			   CAST(CASE WHEN  A.PARTY_STATE_CODE <>ISNULL(LOC.GST_STATE_CODE,'')   THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE,
			    '' as REF_NO ,
			   CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE TL.LOC_GST_NO END PARTY_GST_NO,
			    CASE WHEN A.INV_MODE =1 THEN '' ELSE TL.dept_alias END TARGET_DEPT_ALIAS,a.USER_CODE
      FROM INM01106 A (NOLOCK) 
      JOIN IND01106 B (NOLOCK) ON A.INV_ID =B.INV_ID 
      JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID =a.location_code
      LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      WHERE A.CANCELLED =0  AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.INV_DT BETWEEN @DFM_DT AND @DTO_DT  
      GROUP BY a.location_code   ,
       CASE WHEN ISNULL(CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END,'')=ISNULL(LOC.LOC_GST_NO ,'')
               THEN 'BILL OF SUPPLY' ELSE 'GST PAYABLE' END,
	  CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END ,A.INV_NO ,
	  A.INV_DT ,A.NET_AMOUNT,A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) , A.AC_CODE ,
      REPLACE('GST_'+CAST(ISNULL(B.GST_PERCENTAGE ,0) AS VARCHAR(10)) ,'.00','') ,
      CAST(CASE WHEN  A.PARTY_STATE_CODE <>ISNULL(LOC.GST_STATE_CODE,'')   THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)),
	  CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE TL.LOC_GST_NO END ,
	   CASE WHEN A.INV_MODE =1 THEN '' ELSE TL.dept_alias END ,a.USER_CODE
	  UNION ALL
	  
	   SELECT 1 AS ORDSR, a.location_Code  AS DEPT_ID ,
			   CASE WHEN ISNULL(CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END,'')=ISNULL(LOC.LOC_GST_NO ,'')
               THEN 'BILL OF SUPPLY' ELSE 'GST PAYABLE' END AS TRANSACTIONS_TYPE,
			    CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS TRANSACTIONS,
			   A.INV_NO AS BILL_NO,
			   A.INV_DT AS BILL_DT,
			   A.NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE ,
			   (CASE WHEN D.PAYMODE_GRP_CODE='WCGV001' THEN D.PAYMODE_GRP_NAME ELSE   C.PAYMODE_NAME END) AS TYP,
			   CAST(2 AS INT) AS MODE,
			   SUM(ISNULL(B.AMOUNT,0)) AS TAXABLE_VALUE,
			   0 AS GST_AMOUNT,
			   2 AS PARTY_TYPE,
			   CAST(CASE WHEN  A.PARTY_STATE_CODE <>ISNULL(LOC.GST_STATE_CODE,'')   THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE,
			    '' as REF_NO ,
			   CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE TL.LOC_GST_NO END PARTY_GST_NO,
			   CASE WHEN A.INV_MODE =1 THEN '' ELSE TL.dept_alias END TARGET_DEPT_ALIAS,a.USER_CODE
	     FROM INM01106  A (NOLOCK)
	     JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID =a.location_Code 
         LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
         LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
         LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
	     JOIN PAYMODE_XN_DET B (NOLOCK) ON A.INV_ID =B.MEMO_ID 
	     JOIN PAYMODE_MST C (NOLOCK) ON B.PAYMODE_CODE=C.PAYMODE_CODE
	     JOIN PAYMODE_GRP_MST D (NOLOCK) ON c.PAYMODE_GRP_CODE = d.PAYMODE_GRP_CODE  
		 WHERE A.CANCELLED=0 AND A.INV_DT  BETWEEN @DFM_DT AND @DTO_DT   
		 AND B.XN_TYPE='WSL'
		 AND A.MEMO_TYPE IN(0,1)
		 AND A.INV_DT BETWEEN @DFM_DT AND @DTO_DT  
		 GROUP BY  a.location_Code  ,A.INV_NO,A.INV_DT,A.NET_AMOUNT,A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) , A.AC_CODE ,
		 (CASE WHEN D.PAYMODE_GRP_CODE='WCGV001' THEN D.PAYMODE_GRP_NAME ELSE   C.PAYMODE_NAME END),
		  CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END ,
		  CASE WHEN ISNULL(CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END,'')=ISNULL(LOC.LOC_GST_NO ,'')
               THEN 'BILL OF SUPPLY' ELSE 'GST PAYABLE' END	,
              CAST(CASE WHEN  A.PARTY_STATE_CODE <>ISNULL(LOC.GST_STATE_CODE,'')   THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)),
			  CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE TL.LOC_GST_NO END,
			   CASE WHEN A.INV_MODE =1 THEN '' ELSE TL.dept_alias END ,a.USER_CODE
		) A
		GROUP BY DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,
        NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE,TRANSACTION_MODE , REF_NO , isnull(PARTY_GST_NO,'') ,
		TARGET_DEPT_ALIAS,a.USER_CODE
        
        
       
        --4 ADVANCES
        --@DONOT_CAL_GST_ADV_RECE
        
       INSERT INTO @TBLDETAILS(ORD_SR,DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,TAXABLE_VALUE ,GST_AMOUNT,PARTY_TYPE ,TRANSACTION_MODE,MRR_NO ,MRR_DT,REF_NO ,PARTY_GST_NO ,USER_CODE   )
       SELECT 3, A.location_code AS  DEPT_ID ,
              CASE WHEN A.ARCT =1 THEN  'GST NOT AFFECTED' 
                   WHEN A.ARCT =2 AND ISNULL(@DONOT_CAL_GST_ADV_RECE,'')='1' THEN 'GST NOT AFFECTED'
                        ELSE 'GST PAYABLE' END AS TRANSACTIONS_TYPE ,
                   CASE WHEN A.ARCT =1 THEN  'OUT STANDING RECEIPT' 
                   ELSE 'ADVANCE / OTHER RECEIPTS' END   AS TRANSACTIONS , 
              ADV_REC_NO AS BILL_NO , ADV_REC_DT AS BILL_DT ,
              NET_AMOUNT ,0 AS ROUND_OFF,0 as GST_ROUND_OFF ,CUSTOMER_CODE ,
              REPLACE('GST_'+CAST(ISNULL(A.GST_PERCENTAGE ,0) AS VARCHAR(10)) ,'.00','') TYP,
			  CAST(1 AS INT) AS MODE,
              A.TAXABLE_VALUE AS TAXABLE_VALUE ,
              ((ISNULL(A.IGST_AMOUNT,0)+ISNULL(A.CGST_AMOUNT,0)+ISNULL(A.SGST_AMOUNT,0))) AS GST_AMOUNT,
              1 AS PARTY_TYPE ,
               CAST(CASE WHEN  ISNULL(A.IGST_AMOUNT ,0)>0 THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE    ,
              CAST('' AS VARCHAR(100)) AS MRR_NO,
              CAST('' AS VARCHAR(100)) AS MRR_DT,
			  '' AS REF_NO ,'' AS PARTY_GST_NO ,a.USER_CODE
      FROM ARC01106   A (NOLOCK) 
      WHERE A.CANCELLED =0
      AND ARC_TYPE =1 AND ARCT IN(2,3,4,5)
      AND A.ADV_REC_DT  BETWEEN @DFM_DT AND @DTO_DT  
      UNION ALL
       SELECT 3 AS ORDSR, a.location_Code  AS DEPT_ID ,
			   CASE WHEN A.ARCT =1 THEN  'GST NOT AFFECTED' 
                    WHEN A.ARCT =2 AND ISNULL(@DONOT_CAL_GST_ADV_RECE,'')='1' THEN 'GST NOT AFFECTED'
                     ELSE 'GST PAYABLE' END AS  TRANSACTIONS_TYPE ,
              CASE WHEN A.ARCT =1 THEN  'OUT STANDING RECEIPT' 
              ELSE 'ADVANCE / OTHER RECEIPTS' END   AS TRANSACTIONS , 
			   A.ADV_REC_NO AS BILL_NO,
			   A.ADV_REC_DT AS BILL_DT,
			   A.NET_AMOUNT,
			   0 AS ROUND_OFF,0 as GST_ROUND_OFF,
			   CASE WHEN ISNULL(A.CUSTOMER_CODE ,'000000000000') ='000000000000' THEN A.AC_CODE  ELSE A.CUSTOMER_CODE  END AS CUSTOMER_CODE ,
			   (CASE WHEN D.PAYMODE_GRP_CODE='WCGV001' THEN D.PAYMODE_GRP_NAME ELSE   C.PAYMODE_NAME END) AS TYP,
			   CAST(2 AS INT) AS MODE,
			   SUM(ISNULL(B.AMOUNT,0)) AS TAXABLE_VALUE,
			   0 AS GST_AMOUNT,
			   CASE WHEN ISNULL(A.CUSTOMER_CODE ,'000000000000') ='000000000000' THEN 2  ELSE 1 END AS PARTY_TYPE,
			   CAST(CASE WHEN  ISNULL(A.IGST_AMOUNT ,0)>0 THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) AS TRANSACTION_MODE   ,
			   CAST('' AS VARCHAR(100)) AS MRR_NO,
              CAST('' AS VARCHAR(100)) AS MRR_DT,
			   '' AS REF_NO ,'' AS PARTY_GST_NO ,a.USER_CODE
	     FROM ARC01106   A (NOLOCK)
	     JOIN PAYMODE_XN_DET B (NOLOCK) ON A.ADV_REC_ID  =B.MEMO_ID 
	     JOIN PAYMODE_MST C (NOLOCK) ON B.PAYMODE_CODE=C.PAYMODE_CODE
	     JOIN PAYMODE_GRP_MST D (NOLOCK) ON c.PAYMODE_GRP_CODE = d.PAYMODE_GRP_CODE 
		 WHERE A.CANCELLED=0 AND A.ADV_REC_DT   BETWEEN @DFM_DT AND @DTO_DT   
		 AND B.XN_TYPE='ARC'
		 AND A.ADV_REC_DT BETWEEN @DFM_DT AND @DTO_DT  
		  AND ARC_TYPE =1 AND  ARCT IN(2,3,4,5)
		 GROUP BY  a.location_Code  ,
		 CASE WHEN A.ARCT =1 THEN  'GST NOT AFFECTED' 
                    WHEN A.ARCT =2 AND ISNULL(@DONOT_CAL_GST_ADV_RECE,'')='1' THEN 'GST NOT AFFECTED'
                     ELSE 'GST PAYABLE' END   ,
              CASE WHEN A.ARCT =1 THEN  'OUT STANDING RECEIPT' 
              ELSE 'ADVANCE / OTHER RECEIPTS' END  ,A.ADV_REC_NO ,
		A.ADV_REC_DT , A.NET_AMOUNT,CASE WHEN ISNULL(A.CUSTOMER_CODE ,'000000000000') ='000000000000' THEN A.AC_CODE  ELSE A.CUSTOMER_CODE  END
		 ,(CASE WHEN D.PAYMODE_GRP_CODE='WCGV001' THEN D.PAYMODE_GRP_NAME ELSE   C.PAYMODE_NAME END), 
		 CASE WHEN ISNULL(A.CUSTOMER_CODE ,'000000000000') ='000000000000' THEN 2  ELSE 1 END ,
		 CAST(CASE WHEN  ISNULL(A.IGST_AMOUNT ,0)>0 THEN 'INTER STATE' ELSE 'LOCAL' END AS VARCHAR(100)) ,a.USER_CODE
       
       
       --4 WHOSALE RETURN
		
		
		 INSERT INTO @TBLDETAILS(ORD_SR,DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,TAXABLE_VALUE ,GST_AMOUNT,PARTY_TYPE,TRANSACTION_MODE,MRR_NO,MRR_DT , REF_NO ,PARTY_GST_NO,USER_CODE   )
         SELECT 4, DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,
             (-1)* NET_AMOUNT  AS NET_AMOUNT,(-1)*ROUND_OFF AS ROUND_OFF,(-1)*GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,
              (-1)*SUM(TAXABLE_VALUE) AS TAXABLE_VALUE ,(-1)*SUM(GST_AMOUNT) AS GST_AMOUNT,
              2 AS PARTY_TYPE,
              TRANSACTION_MODE ,
              CAST('' AS VARCHAR(100)) AS MRR_NO,
              CAST('' AS VARCHAR(100)) AS MRR_DT,
			  REF_NO ,isnull(Party_gst_no,'') as Party_gst_no ,a.USER_CODE
         FROM 
		(
		 SELECT 2 AS ORDSR, A.location_Code AS DEPT_ID ,
			   'GST RECEIVABLE' AS TRANSACTIONS_TYPE,
			   CASE WHEN A.MODE =1 THEN 'PARTY CREDIT NOTE' ELSE 'GROUP CREDIT NOTE' END AS TRANSACTIONS,
			   CASE WHEN A.MODE =1 THEN CN_NO   ELSE isnull(NULLIF(MANUAL_INV_NO,''),CN_NO)   END   AS BILL_NO,
			   A.CN_DT AS BILL_DT,
			   A.TOTAL_AMOUNT AS NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(OTHER_CHARGES_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)) AS GST_AMOUNT,
			   2 AS PARTY_TYPE,
			   CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END AS TRANSACTION_MODE ,
			   '' AS REF_NO,
			   CASE WHEN A.MODE =1 THEN LMP.AC_GST_NO ELSE SL.LOC_GST_NO END     AS PARTY_GST_NO,a.USER_CODE
      FROM CNM01106 A (NOLOCK)
      JOIN LOCATION L (NOLOCK) ON A.location_code=L.DEPT_ID 
	  LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 
	  
	  LEFT JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID  =A.challan_source_location_code 
      WHERE A.CANCELLED =0 AND A.OTHER_CHARGES>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0)>0
      AND A.CN_DT BETWEEN @DFM_DT AND @DTO_DT  
      UNION ALL
      
     SELECT 2 AS ORDSR, A.location_Code AS DEPT_ID ,
			   'GST RECEIVABLE' AS TRANSACTIONS_TYPE,
			   CASE WHEN A.MODE =1 THEN 'PARTY CREDIT NOTE' ELSE 'GROUP CREDIT NOTE' END AS TRANSACTIONS,
			   CASE WHEN A.MODE =1 THEN a.CN_NO   ELSE isnull(NULLIF(MANUAL_INV_NO,''),a.CN_NO)   END    AS BILL_NO,
			   A.CN_DT AS BILL_DT,
			   A.TOTAL_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(FREIGHT_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.FREIGHT_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(FREIGHT_IGST_AMOUNT,0)+ISNULL(FREIGHT_CGST_AMOUNT,0)+ISNULL(FREIGHT_SGST_AMOUNT,0)) AS GST_AMOUNT,
			    2 AS PARTY_TYPE,
			    CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END AS TRANSACTION_MODE   ,
				 '' AS REF_NO,
			   CASE WHEN A.MODE =1 THEN LMP.AC_GST_NO ELSE SL.LOC_GST_NO END     AS PARTY_GST_NO,a.USER_CODE  
      FROM CNM01106 A (NOLOCK)
      JOIN LOCATION L (NOLOCK) ON A.location_Code =L.DEPT_ID 
	  LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 	  
	  LEFT JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID  =A.challan_source_location_code 
      WHERE A.CANCELLED =0 AND A.FREIGHT>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.FREIGHT_TAXABLE_VALUE,0)>0
      AND A.CN_DT BETWEEN @DFM_DT AND @DTO_DT  
      UNION ALL
      
      SELECT 2 AS ORDSR, A.location_Code  AS DEPT_ID ,
			   'GST RECEIVABLE' AS TRANSACTIONS_TYPE,
			   CASE WHEN A.MODE =1 THEN 'PARTY CREDIT NOTE' ELSE 'GROUP CREDIT NOTE' END AS TRANSACTIONS,
			   CASE WHEN A.MODE =1 THEN a.CN_NO   ELSE isnull(NULLIF(MANUAL_INV_NO,''),a.CN_NO)   END  AS BILL_NO,
			   A.CN_DT AS BILL_DT,
			   A.TOTAL_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(INSURANCE_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.INSURANCE_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(INSURANCE_IGST_AMOUNT,0)+ISNULL(INSURANCE_CGST_AMOUNT,0)+ISNULL(INSURANCE_SGST_AMOUNT,0)) AS GST_AMOUNT,
			    2 AS PARTY_TYPE,
			    CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END AS TRANSACTION_MODE,
				 '' AS REF_NO,
			   CASE WHEN A.MODE =1 THEN LMP.AC_GST_NO ELSE SL.LOC_GST_NO END     AS PARTY_GST_NO,a.USER_CODE
      FROM CNM01106 A (NOLOCK)
      JOIN LOCATION L (NOLOCK) ON A.location_Code =L.DEPT_ID 
	  LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 	 
	  LEFT JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID  =A.challan_source_location_code  	  
      WHERE A.CANCELLED =0 AND A.FREIGHT>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.INSURANCE_TAXABLE_VALUE,0)>0
      AND A.CN_DT BETWEEN @DFM_DT AND @DTO_DT  

      UNION ALL
      
       SELECT 2 AS ORDSR, A.location_Code AS DEPT_ID ,
			   'GST RECEIVABLE' AS TRANSACTIONS_TYPE,
			   CASE WHEN A.MODE =1 THEN 'PARTY CREDIT NOTE' ELSE 'GROUP CREDIT NOTE' END AS TRANSACTIONS,
			   CASE WHEN A.MODE =1 THEN a.CN_NO   ELSE isnull(NULLIF(MANUAL_INV_NO,''),a.CN_NO)   END  AS BILL_NO,
			   A.CN_DT AS BILL_DT,
			   A.TOTAL_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(B.GST_PERCENTAGE ,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   SUM(ISNULL(B.XN_VALUE_WITHOUT_GST ,0)) AS TAXABLE_VALUE,
			   SUM((ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0))) AS GST_AMOUNT,
			    2 AS PARTY_TYPE,
			    CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END AS TRANSACTION_MODE,
				 '' AS REF_NO,
			   CASE WHEN A.MODE =1 THEN LMP.AC_GST_NO ELSE SL.LOC_GST_NO END     AS PARTY_GST_NO,a.USER_CODE
      FROM CNM01106 A (NOLOCK) 
      JOIN CND01106 B (NOLOCK) ON A.CN_ID =B.CN_ID 
      JOIN LOCATION L (NOLOCK) ON A.location_Code =L.DEPT_ID 
	  LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 
	  LEFT JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID  =A.challan_source_location_code 	  
      WHERE A.CANCELLED =0  AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.CN_DT BETWEEN @DFM_DT AND @DTO_DT  
      GROUP BY A.location_Code  ,
	  CASE WHEN A.MODE =1 THEN 'PARTY CREDIT NOTE' ELSE 'GROUP CREDIT NOTE' END ,
	  CASE WHEN A.MODE =1 THEN a.CN_NO   ELSE isnull(NULLIF(MANUAL_INV_NO,''),a.CN_NO)   END  ,A.CN_DT , A.TOTAL_AMOUNT,
	  A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0),A.AC_CODE ,
      REPLACE('GST_'+CAST(ISNULL(B.GST_PERCENTAGE ,0) AS VARCHAR(10)) ,'.00','') ,
      CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END ,
	   CASE WHEN A.MODE =1 THEN LMP.AC_GST_NO ELSE SL.LOC_GST_NO END ,a.USER_CODE
	 
		) A
		GROUP BY DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,
        NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE,TRANSACTION_MODE , REF_NO , 
		isnull(Party_gst_no,'')  ,a.USER_CODE
    
    
    --PURCHASE
        INSERT INTO @TBLDETAILS(ORD_SR,DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,TAXABLE_VALUE ,GST_AMOUNT,PARTY_TYPE ,TRANSACTION_MODE,MRR_NO,MRR_DT , REF_NO ,PARTY_GST_NO,USER_CODE  )
         SELECT 2, DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,
              NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,
              SUM(TAXABLE_VALUE) AS TAXABLE_VALUE ,SUM(GST_AMOUNT) AS GST_AMOUNT,
              2 AS PARTY_TYPE,
              TRANSACTION_MODE ,
              A.MRR_NO,
              A.MRR_DT,
			   REF_NO ,isnull(PARTY_GST_NO ,'') as PARTY_GST_NO ,a.USER_CODE
         FROM 
		(
		 SELECT 2 AS ORDSR, A.location_Code  AS DEPT_ID ,		   
               'GST RECEIVABLE' AS TRANSACTIONS_TYPE,
			   CASE WHEN A.INV_MODE =1 THEN 'PARTY PURCHASE' ELSE 'GROUP PURCHASE' END AS TRANSACTIONS,
			   A.BILL_NO AS BILL_NO,
			   A.BILL_DT   AS BILL_DT,
			   A.TOTAL_AMOUNT AS  NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(OTHER_CHARGES_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)) AS GST_AMOUNT,
			   2 AS PARTY_TYPE,
			   CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END AS TRANSACTION_MODE,
			   A.MRR_NO,
               CONVERT(VARCHAR,A.MRR_DT,105) AS MRR_DT,
			    '' AS REF_NO,
			   CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE SL.LOC_GST_NO END     AS PARTY_GST_NO,a.USER_CODE
      FROM PIM01106 A (NOLOCK)
      JOIN LOCATION L (NOLOCK) ON A.location_Code =L.DEPT_ID 
	  LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 
	  LEFT JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID  =A.challan_source_location_code 
      WHERE A.CANCELLED =0 AND A.OTHER_CHARGES>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0)>0
      AND  ISNULL(A.PIM_MODE,0)<>5 
      AND (ISNULL(A.BILL_CHALLAN_MODE,0)=0  )
      AND  A.BILL_DT   BETWEEN @DFM_DT AND @DTO_DT  
      UNION ALL
      
     SELECT 2 AS ORDSR, A.location_Code  AS DEPT_ID ,		   
               'GST RECEIVABLE' AS TRANSACTIONS_TYPE,
			   CASE WHEN A.INV_MODE =1 THEN 'PARTY PURCHASE' ELSE 'GROUP PURCHASE' END AS TRANSACTIONS,
			   A.BILL_NO AS BILL_NO,
			   A.BILL_DT AS BILL_DT,
			   A.TOTAL_AMOUNT AS  NET_AMOUNT,A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(FREIGHT_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.FREIGHT_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(FREIGHT_IGST_AMOUNT,0)+ISNULL(FREIGHT_CGST_AMOUNT,0)+ISNULL(FREIGHT_SGST_AMOUNT,0)) AS GST_AMOUNT,
			    2 AS PARTY_TYPE,
			    CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END AS TRANSACTION_MODE,
			     A.MRR_NO,
                 CONVERT(VARCHAR,A.MRR_DT,105) AS MRR_DT,
				 '' AS REF_NO,
			   CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE SL.LOC_GST_NO END     AS PARTY_GST_NO,a.USER_CODE
      FROM PIM01106 A (NOLOCK)
      JOIN LOCATION L (NOLOCK) ON A.location_Code =L.DEPT_ID 
	  LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 
	  LEFT JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID  =A.challan_source_location_code 
      WHERE A.CANCELLED =0 AND A.FREIGHT>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.FREIGHT_TAXABLE_VALUE,0)>0
      AND  ISNULL(A.PIM_MODE,0)<>5
      AND (ISNULL(A.BILL_CHALLAN_MODE,0)=0  )
      AND  BILL_DT BETWEEN @DFM_DT AND @DTO_DT  
     
      UNION ALL
      
       SELECT  2 AS ORDSR, A.location_Code  AS DEPT_ID ,		   
               'GST RECEIVABLE' AS TRANSACTIONS_TYPE,
			   CASE WHEN A.INV_MODE =1 THEN 'PARTY PURCHASE' ELSE 'GROUP PURCHASE' END AS TRANSACTIONS,
			   A.BILL_NO  AS BILL_NO,
			   a.bill_dt  AS BILL_DT,
			   A.TOTAL_AMOUNT AS  NET_AMOUNT,
			   A.ROUND_OFF AS ROUND_OFF,a.GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(B.GST_PERCENTAGE ,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   SUM(ISNULL(B.XN_VALUE_WITHOUT_GST ,0)) AS TAXABLE_VALUE,
			   SUM((ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0))) AS GST_AMOUNT,
			    2 AS PARTY_TYPE,
			    CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END AS TRANSACTION_MODE,
			    A.MRR_NO,
                CONVERT(VARCHAR,A.MRR_DT,105) AS MRR_DT,
				'' AS REF_NO,
			   CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE SL.LOC_GST_NO END     AS PARTY_GST_NO,a.USER_CODE
      FROM PIM01106 A (NOLOCK) 
      JOIN PID01106 B (NOLOCK) ON A.MRR_ID =B.MRR_ID 
      JOIN LOCATION L (NOLOCK) ON A.location_Code =L.DEPT_ID 
	  LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 
	  LEFT JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID  =A.challan_source_location_code 
  
      WHERE A.CANCELLED =0  AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND  ISNULL(A.BILL_DT,A.RECEIPT_DT )  BETWEEN @DFM_DT AND @DTO_DT  
      AND (ISNULL(A.BILL_CHALLAN_MODE,0)=0  )
      GROUP BY  A.location_Code   ,
	  CASE WHEN A.INV_MODE =1 THEN 'PARTY PURCHASE' ELSE 'GROUP PURCHASE' END ,
	  A.BILL_NO ,a.BILL_DT ,A.TOTAL_AMOUNT ,A.ROUND_OFF,a.GST_ROUND_OFF,
	  A.AC_CODE  ,REPLACE('GST_'+CAST(ISNULL(B.GST_PERCENTAGE ,0) AS VARCHAR(10)) ,'.00',''),
	   CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END,
	   A.MRR_NO, CONVERT(VARCHAR,A.MRR_DT,105) ,CASE WHEN A.INV_MODE =1 THEN LMP.AC_GST_NO ELSE SL.LOC_GST_NO END  ,a.USER_CODE
	  
		) A
		GROUP BY DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,
        NET_AMOUNT ,ROUND_OFF,a.GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE,
       TRANSACTION_MODE , A.MRR_NO,A.MRR_DT, REF_NO , isnull(Party_gst_no,'') ,a.USER_CODE 
        
       
       
       INSERT INTO @TBLDETAILS(ORD_SR,DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,TAXABLE_VALUE ,GST_AMOUNT,PARTY_TYPE ,TRANSACTION_MODE,MRR_NO,MRR_DT, REF_NO ,PARTY_GST_NO,TARGET_DEPT_ALIAS,USER_CODE   )
         SELECT 2, DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,
              NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE ,
              SUM(TAXABLE_VALUE) AS TAXABLE_VALUE ,SUM(GST_AMOUNT) AS GST_AMOUNT,
              3 AS PARTY_TYPE,
              TRANSACTION_MODE,
              CAST('' AS VARCHAR(100)) AS MRR_NO,
              CAST('' AS VARCHAR(100)) AS MRR_DT ,
			   REF_NO ,isnull(PARTY_GST_NO ,'') as PARTY_GST_NO ,TARGET_DEPT_ALIAS,a.USER_CODE
         FROM 
		(
		 SELECT 3 AS ORDSR,A.location_Code  AS DEPT_ID ,		   
               'GST PAYABLE' AS TRANSACTIONS_TYPE,
			   CASE WHEN A.MODE =1 THEN 'PARTY DEBIT NOTE' ELSE 'GROUP DEBIT NOTE' END AS TRANSACTIONS,
			   A.RM_NO AS BILL_NO,
			   A.RM_DT AS BILL_DT,
			   A.TOTAL_AMOUNT AS  NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(OTHER_CHARGES_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)) AS GST_AMOUNT,
			   2 AS PARTY_TYPE,
			   CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END AS TRANSACTION_MODE,
			   '' AS REF_NO,
			   CASE WHEN A.mode =1 THEN LMP.AC_GST_NO ELSE tl.LOC_GST_NO END     AS PARTY_GST_NO,
			   CASE WHEN A.mode =1 THEN '' ELSE TL.dept_alias END TARGET_DEPT_ALIAS,a.USER_CODE
      FROM RMM01106 A (NOLOCK)
      JOIN LOCATION L (NOLOCK) ON A.location_Code =L.DEPT_ID 
	  LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 
	  LEFT JOIN LOCATION tl (NOLOCK) ON tl.DEPT_ID  =a.party_dept_id
      WHERE A.CANCELLED =0 AND A.OTHER_CHARGES>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0)>0
      AND A.RM_DT   BETWEEN @DFM_DT AND @DTO_DT  
      UNION ALL
      
     SELECT  3 AS ORDSR, A.location_Code  AS DEPT_ID ,		   
               'GST PAYABLE' AS TRANSACTIONS_TYPE,
			   CASE WHEN A.MODE =1 THEN 'PARTY DEBIT NOTE' ELSE 'GROUP DEBIT NOTE' END AS TRANSACTIONS,
			   A.RM_NO AS BILL_NO,
			   A.RM_DT AS BILL_DT,
			   A.TOTAL_AMOUNT AS  NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(FREIGHT_GST_PERCENTAGE,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   ISNULL(A.FREIGHT_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
			   (ISNULL(FREIGHT_IGST_AMOUNT,0)+ISNULL(FREIGHT_CGST_AMOUNT,0)+ISNULL(FREIGHT_SGST_AMOUNT,0)) AS GST_AMOUNT,
			    2 AS PARTY_TYPE,
			    CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END AS TRANSACTION_MODE,
				'' AS REF_NO,
			   CASE WHEN A.mode =1 THEN LMP.AC_GST_NO ELSE tl.LOC_GST_NO END     AS PARTY_GST_NO,
			    CASE WHEN A.mode =1 THEN '' ELSE TL.dept_alias END TARGET_DEPT_ALIAS,a.USER_CODE
      FROM RMM01106 A (NOLOCK)
      JOIN LOCATION L (NOLOCK) ON A.location_Code =L.DEPT_ID 
	  LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 
	  LEFT JOIN LOCATION tl (NOLOCK) ON tl.DEPT_ID  =a.party_dept_id
      WHERE A.CANCELLED =0 AND A.FREIGHT>0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.FREIGHT_TAXABLE_VALUE,0)>0
      AND A.RM_DT  BETWEEN @DFM_DT AND @DTO_DT  
     
      UNION ALL
      
       SELECT  3 AS ORDSR, A.location_Code  AS DEPT_ID ,		   
               'GST PAYABLE' AS TRANSACTIONS_TYPE,
			   CASE WHEN A.MODE =1 THEN 'PARTY DEBIT NOTE' ELSE 'GROUP DEBIT NOTE' END AS TRANSACTIONS,
			   A.RM_NO AS BILL_NO,
			   A.RM_DT AS BILL_DT,
			   A.TOTAL_AMOUNT AS  NET_AMOUNT,
			   A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0) AS GST_ROUND_OFF,
			   A.AC_CODE  AS CUSTOMER_CODE,
			   REPLACE('GST_'+CAST(ISNULL(B.GST_PERCENTAGE ,0) AS VARCHAR(10)) ,'.00','') TYP,
			   CAST(1 AS INT) AS MODE,
			   SUM(ISNULL(B.XN_VALUE_WITHOUT_GST ,0)) AS TAXABLE_VALUE,
			   SUM((ISNULL(B.IGST_AMOUNT,0)+ISNULL(B.CGST_AMOUNT,0)+ISNULL(B.SGST_AMOUNT,0))) AS GST_AMOUNT,
			    2 AS PARTY_TYPE,
			     CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END AS TRANSACTION_MODE,
				 '' AS REF_NO,
			   CASE WHEN A.mode =1 THEN LMP.AC_GST_NO ELSE tl.LOC_GST_NO END     AS PARTY_GST_NO,
			    CASE WHEN A.mode =1 THEN '' ELSE TL.dept_alias END TARGET_DEPT_ALIAS,a.USER_CODE
      FROM RMM01106 A (NOLOCK) 
      JOIN RMD01106 B (NOLOCK) ON A.RM_ID =B.RM_ID 
      JOIN LOCATION L (NOLOCK) ON A.location_Code =L.DEPT_ID 
	  LEFT JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =A.AC_CODE 
	  LEFT JOIN LOCATION tl (NOLOCK) ON tl.DEPT_ID  =a.party_dept_id
      WHERE A.CANCELLED =0  AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.RM_DT  BETWEEN @DFM_DT AND @DTO_DT  
      GROUP BY  A.location_Code   ,
	  CASE WHEN A.MODE =1 THEN 'PARTY DEBIT NOTE' ELSE 'GROUP DEBIT NOTE' END ,
	  A.RM_NO ,A.RM_DT,A.TOTAL_AMOUNT ,A.ROUND_OFF,ISNULL(A.GST_ROUND_OFF,0),
	  A.AC_CODE  ,REPLACE('GST_'+CAST(ISNULL(B.GST_PERCENTAGE ,0) AS VARCHAR(10)) ,'.00',''),
	  CASE WHEN A.PARTY_STATE_CODE <>L.GST_STATE_CODE THEN 'INTER STATE' ELSE 'LOCAL' END,
	   CASE WHEN A.mode =1 THEN LMP.AC_GST_NO ELSE tl.LOC_GST_NO END  ,
	    CASE WHEN A.mode =1 THEN '' ELSE TL.dept_alias END ,a.USER_CODE
	  
		) A
		GROUP BY DEPT_ID ,TRANSACTIONS_TYPE ,TRANSACTIONS ,BILL_NO ,BILL_DT ,
        NET_AMOUNT ,ROUND_OFF,GST_ROUND_OFF ,CUSTOMER_CODE ,TYP ,MODE,TRANSACTION_MODE , REF_NO , isnull(Party_gst_no,'')  ,TARGET_DEPT_ALIAS,a.USER_CODE
   
       --update  @TBLDETAILS set typ= REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
       --REPLACE(REPLACE(REPLACE(REPLACE(typ,
       -- '!',''),'@',''),'#',''),'$',''),'%',''),
       -- '^',''),'&',''),'*',''),' ','') where mode=2
  
       --  update  @TBLDETAILS set typ=replace(replace( REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
       --REPLACE(REPLACE(REPLACE(REPLACE(typ,
       -- '!',''),'@',''),'#',''),'$',''),'%',''),
       -- '^',''),'&',''),'*',''),' ',''),'_',''),'-','')  where mode=2

	    if object_id ('tempdb..#tmppaymode','u') is not null
            drop table #tmppaymode
            
            select distinct typ,typ as newtyp into #tmppaymode from @TBLDETAILS
            where mode=2  
            and typ like '%[^a-Z0-9, ]%'
            
            update  #tmppaymode set newtyp= dbo.fn_RemoveSpecialChars(typ) 
        
			update a set typ=newtyp from @TBLDETAILS a
			join #tmppaymode b on a.typ=b.typ
	        
       

        IF OBJECT_ID ('TEMPDB..#TMPSUMMARY','U') IS NOT NULL
		  DROP TABLE #TMPSUMMARY
	      
		;WITH CTE AS
		(
		 SELECT *,SR=ROW_NUMBER () OVER(PARTITION BY CUSTOMER_CODE,BILL_NO,BILL_DT,TRANSACTIONS ORDER BY CUSTOMER_CODE,BILL_NO,BILL_DT) 
		 FROM @TBLDETAILS
		 WHERE (@CDEPT_ID='' OR DEPT_ID =@CDEPT_ID)
		)
		SELECT A.* ,
		COLDESC1=REPLACE(REPLACE(TYP,'GST','TAXABLE_VALUE'),'VAT','TAXABLE_VALUE'),
		--CASE WHEN MODE=1 THEN REPLACE(REPLACE(TYP,'GST','TAXABLE_VALUE'),'VAT','TAXABLE_VALUE')
		--         ELSE 'PYMT_'+TYP END ,
		COLDESC2=CASE WHEN MODE=1 THEN REPLACE(REPLACE(TYP,'GST','GST_AMT'),'VAT','GST_AMT') ELSE '' END,
		CASE WHEN PARTY_TYPE=1 THEN ISNULL(CUST.CUSTOMER_FNAME,'')+' '+ ISNULL(CUST.CUSTOMER_LNAME,'')  
		ELSE LM.AC_NAME END AS PARTY ,
		 CASE WHEN PARTY_TYPE=1 THEN ISNULL(CUST.USER_CUSTOMER_CODE,'')  ELSE '' END AS CUSTOMER_ID,
		
		L.DEPT_NAME,L.DEPT_ALIAS ,u.username 
		INTO #TMPSUMMARY FROM CTE A
		JOIN LOCATION L ON L.DEPT_ID=A.DEPT_ID
		LEFT JOIN CUSTDYM CUST (NOLOCK) ON CUST.CUSTOMER_CODE =A.CUSTOMER_CODE
		LEFT JOIN LM01106  LM (NOLOCK) ON LM.AC_CODE  =A.CUSTOMER_CODE
		left join users u (nolock) on u.user_code =a.user_Code 
	    
		UPDATE #TMPSUMMARY SET NET_AMOUNT =0 ,ROUND_OFF =0,GST_ROUND_OFF =0 WHERE SR>1     
	    
	    UPDATE #TMPSUMMARY SET ORD=CASE WHEN REPLACE(RIGHT(COLDESC1, CHARINDEX ('_', REVERSE(COLDESC1))),'_','') ='' THEN '1000.00' ELSE 
        REPLACE(RIGHT(COLDESC1, CHARINDEX ('_', REVERSE(COLDESC1))),'_','') END,
        COLDESC1=CASE WHEN MODE =2 THEN 'PYMT_'+COLDESC1 ELSE COLDESC1 END 
       

	
		IF ISNULL(@CCOLNAME,'')=''   
		SET @CCOLNAME='DEPT_ID,TRANSACTIONS_TYPE,ROUND_OFF,GST_ROUND_OFF,TRANSACTIONS,BILL_NO,BILL_DT,NET_AMOUNT'	
		

		DECLARE @DTSQL NVARCHAR(MAX),@CTYPE VARCHAR(MAX),
				@COLUMN1 VARCHAR(MAX),@COLUMN2 VARCHAR(MAX),@COLDESC1 VARCHAR(MAX),@COLDESC2 VARCHAR(MAX),
				@CGROUPCOLNAME VARCHAR(MAX)
		        
		SELECT   @COLUMN1=ISNULL(@COLUMN1+',','')+QUOTENAME(COLDESC1)
				FROM #TMPSUMMARY WHERE COLDESC1<>''
				AND  (@NPAYMENT=0 OR MODE=@NPAYMENT)
				GROUP BY COLDESC1
				


		SELECT   @COLUMN2=ISNULL(@COLUMN2+',','')+QUOTENAME(COLDESC2)
				FROM #TMPSUMMARY WHERE COLDESC2<>''
				AND  (@NPAYMENT=0 OR MODE=@NPAYMENT)
				GROUP BY COLDESC2
				

				


			
		
		SELECT   @COLDESC1=ISNULL(@COLDESC1+',','')+'SUM('+QUOTENAME(COLDESC1)+') AS'+  REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(QUOTENAME(COLDESC1),'(',''),')',''),'/',''),'\',''),'%','')
		+CASE WHEN MODE=1 THEN 
		','+ISNULL(@COLDESC2+',','')+'SUM('+QUOTENAME(COLDESC2)+') AS'+   REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(QUOTENAME(COLDESC2),'(',''),')',''),'/',''),'\',''),'%','') ELSE '' END
				FROM #TMPSUMMARY 
				WHERE  (@NPAYMENT=0 OR MODE=@NPAYMENT)
				and(@bdonotShowGst=0 or COLDESC1 not like  'TAXABLE_VALUE%')
				GROUP BY COLDESC1,MODE,COLDESC2,ORD
				ORDER BY MODE,ORD 
					
		   IF ISNULL(@COLDESC1,'')=''
		    SELECT @COLDESC1='''*'' AS P'
			
			
		SET @CGROUPCOLNAME=@CCOLNAME
		SET @CCOLNAME=REPLACE(@CCOLNAME,'NET_AMOUNT',' SUM(NET_AMOUNT) AS NET_AMOUNT')
		--SET @CCOLNAME=REPLACE(@CCOLNAME,'ROUND_OFF',' SUM(ROUND_OFF) AS ROUND_OFF')
		SET @CCOLNAME=REPLACE(@CCOLNAME,'Gst_ROUND_OFF',' SUM(Gst_ROUND_OFF) AS Gst_ROUND_OFF')
		SET @CCOLNAME=REPLACE(@CCOLNAME,',ROUND_OFF',' ,SUM(ROUND_OFF) AS ROUND_OFF')

		SET @CGROUPCOLNAME=REPLACE(@CGROUPCOLNAME,',NET_AMOUNT','')
		SET @CGROUPCOLNAME=REPLACE(@CGROUPCOLNAME,',ROUND_OFF','')
		SET @CGROUPCOLNAME=REPLACE(@CGROUPCOLNAME,',Gst_ROUND_OFF','')
        
        if @BfromtoBillNO=1
		begin
		    set @CGROUPCOLNAME=@CGROUPCOLNAME+',(CASE WHEN CHARINDEX(''-'',BILL_NO)>0 THEN  LEFT(BILL_NO, CHARINDEX(''-'',BILL_NO)-1) ELSE BILL_NO END  )'
		    set @CCOLNAME=@CCOLNAME+',MIN(BILL_NO) AS [FROM_BILL],MAX(BILL_NO) AS [TO_BILL] '
		end
			


      IF ISNULL(@CCOLNAME,'')<>''
      BEGIN
        
		        
		--SET @DTSQL=N'SELECT Ref_no,Party_gst_no, '+@CCOLNAME+' ,'+@COLDESC1+'
		--FROM #TMPSUMMARY A 
		--PIVOT (SUM(TAXABLE_VALUE) FOR COLDESC1 IN('+@COLUMN1+')) AS P
		--PIVOT (SUM(GST_AMOUNT) FOR COLDESC2 IN('+@COLUMN2 +')) AS P
		--GROUP BY Ref_no,Party_gst_no,'+@CGROUPCOLNAME+' '
		--PRINT @DTSQL
		--EXEC SP_EXECUTESQL @DTSQL

		SET @DTSQL=N'SELECT  '+@CCOLNAME+' ,'+@COLDESC1+'
		FROM #TMPSUMMARY A 
		PIVOT (SUM(TAXABLE_VALUE) FOR COLDESC1 IN('+@COLUMN1+')) AS P
		PIVOT (SUM(GST_AMOUNT) FOR COLDESC2 IN('+@COLUMN2 +')) AS P
		GROUP BY '+@CGROUPCOLNAME+' '
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL
		
      END
      
    END
