CREATE PROCEDURE SP_ATTRIBUTE_SEARCH
(
@NPAGE INT=1,
@NMODE INT,
@USERCOLNAME VARCHAR(50),
@USERVALUE NVARCHAR(50)
)
AS 
BEGIN
    
       DECLARE @CCMD NVARCHAR(MAX),@CCOLNAME VARCHAR(50),@TABLENAME VARCHAR(50),@CERRMSG NVARCHAR(MAX),
       @CSTEP INT,@COUNT VARCHAR(10)
       
BEGIN TRY
  
     SET @CSTEP=10
        IF @NMODE=''
        BEGIN
            SET @CERRMSG='MODE SHOULD NOT BE EMPTY'
            GOTO END_PROC
        END
     SET @CSTEP=20
        IF @USERCOLNAME=''
        BEGIN
            SET @CERRMSG='USER COL NAME CAN NOT BE BLANK'
            GOTO END_PROC
        END
     SET @CSTEP=30
        IF @USERVALUE=''
        BEGIN
            SET @CERRMSG='USER SEARCH VALUE CAN NOT BE BLANK'
            GOTO END_PROC
        END 
        
    SET @COUNT = 50
    SET @COUNT= @NPAGE * @COUNT     
  
   SELECT @CCOLNAME= COLNAME FROM ATTRIBUTE_DETAILS WHERE USERDISPLAY=''+ @USERCOLNAME +''
   SELECT @TABLENAME= TABLENAME FROM ATTRIBUTE_DETAILS WHERE COLNAME=''+ @CCOLNAME +''

  IF @NMODE=1
  BEGIN
  SET @CCMD=N'SELECT DISTINCT TOP 50 '+@CCOLNAME+' FROM 
       (
       SELECT  TOP  '+@COUNT +' ROW_NUMBER()OVER ( ORDER BY '+@CCOLNAME+' DESC ) AS SRNO, '+@CCOLNAME+' FROM '+@TABLENAME+' 
       WHERE '+@CCOLNAME+' LIKE ''%'+@USERVALUE+''' ORDER BY SRNO DESC
       )TMP GROUP BY '+@CCOLNAME+'' 
  
       --SET @CCMD=N'SELECT '+@CCOLNAME+' FROM '+@TABLENAME+' WHERE '+@CCOLNAME+' LIKE ''%'+@USERVALUE+''''
       PRINT @CCMD
       EXEC SP_EXECUTESQL @CCMD
  END
  
  IF @NMODE=2
  BEGIN
  SET @CCMD=N'SELECT DISTINCT TOP 50 '+@CCOLNAME+' FROM 
       (
       SELECT  TOP  '+@COUNT +' ROW_NUMBER()OVER ( ORDER BY '+@CCOLNAME+' DESC ) AS SRNO, '+@CCOLNAME+' FROM '+@TABLENAME+' 
       WHERE '+@CCOLNAME+' LIKE '''+@USERVALUE+'%'' ORDER BY SRNO DESC
       )TMP GROUP BY '+@CCOLNAME+' ' 
       
  
  
       --SET @CCMD=N'SELECT '+@CCOLNAME+' FROM '+@TABLENAME+' WHERE '+@CCOLNAME+' LIKE '''+@USERVALUE+'%'''
       PRINT @CCMD
       EXEC SP_EXECUTESQL @CCMD
  END
  
  IF @NMODE=3
  BEGIN
  PRINT @COUNT
  SET @CCMD=N'SELECT  TOP 50 '+@CCOLNAME+' FROM 
       (
       SELECT  TOP  '+@COUNT +' ROW_NUMBER()OVER ( ORDER BY '+@CCOLNAME+' DESC ) AS SRNO, '+@CCOLNAME+' FROM '+@TABLENAME+' 
       WHERE '+@CCOLNAME+' LIKE ''%'+@USERVALUE+'%'' ORDER BY SRNO DESC
       )TMP GROUP BY '+@CCOLNAME+' ' 

       --SET @CCMD=N'SELECT TOP 2  FROM 
       --( SELECT '+@CCOLNAME+' FROM '+@TABLENAME+' WHERE '+@CCOLNAME+' LIKE ''%'+@USERVALUE+'%''
       --) ORDER BY '+@CCOLNAME+' DESC'
       PRINT @CCMD
       EXEC SP_EXECUTESQL @CCMD
  END
  

   END TRY
   BEGIN CATCH
   SET @CERRMSG='P: SP_ATTRIBUTE_SEARCH, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
   GOTO END_PROC
END CATCH
		
END_PROC:

SELECT @CERRMSG AS ERRMSG

END
