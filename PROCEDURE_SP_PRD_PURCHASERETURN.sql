CREATE PROCEDURE SP_PRD_PURCHASERETURN      
      
@NQUERYID NUMERIC(2,0),      
@CFROMDATE NVARCHAR(50),      
@CTODATE NVARCHAR(50),      
@CWHERE  NVARCHAR(MAX),      
@CWHERE1 VARCHAR(100)=''      
-- WITH ENCRYPTION
     
AS      
BEGIN      
      
DECLARE @CCMD NVARCHAR(MAX),@cHeadCode VARCHAR(MAX)
      
IF @NQUERYID = 1      
GOTO LBLRMMLIST      
      
ELSE IF @NQUERYID = 2      
GOTO LBLREPORT      
      
ELSE IF @NQUERYID = 3      
GOTO LBLSUPPLIERSLOV      
      
ELSE IF @NQUERYID = 4      
GOTO LBLGETMST      
      
ELSE IF @NQUERYID = 5      
GOTO LBLGETDETAILS      
      
ELSE IF @NQUERYID = 6      
GOTO LBLGETBILL      
      
ELSE IF @NQUERYID = 7      
GOTO LBLGETBILLMASTER      
      
ELSE IF @NQUERYID = 8      
GOTO LBLGETBILLDET      
  
ELSE IF @NQUERYID = 9      
GOTO LBLARTICLE_CODE   

ELSE IF @NQUERYID = 10      
GOTO LBLWORDERLIST     
      
ELSE      
GOTO LAST      
      
      
LBLRMMLIST:      
      
 SET @CCMD = N'SELECT CAST( 0 AS BIT) AS [CHECK], FORM.FORM_NAME , USERS.USERNAME,  C.AC_NAME AS SUPP_NAME,      
 PRD_RMM01106.RM_NO, (CASE WHEN PRD_RMM01106.CANCELLED = 0 THEN SUM(PRD_RMD01106.QUANTITY) ELSE 0 END) AS QUANTITY,      
 (CASE WHEN PRD_RMM01106.CANCELLED = 0 THEN PRD_RMM01106.TOTAL_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT,      
 CONVERT(CHAR(10),CASE WHEN RM_DT='''' THEN '''' ELSE RM_DT END ,105)  AS RM_DT,      
 (CASE WHEN PRD_RMM01106.CANCELLED = 1 THEN ''CANCELLED'' ELSE '''' END) AS [STATUS],      
 (CASE WHEN PRD_RMM01106.CANCELLED = 1 THEN 0 WHEN FORM.POST_TAX_SEPARATELY = 1      
 THEN (PRD_RMM01106.TOTAL_AMOUNT- PRD_RMM01106.TAX_AMOUNT) ELSE PRD_RMM01106.TOTAL_AMOUNT END ) AS TOTAL_AMT_WO,      
  PRD_RMM01106.RM_ID,PRD_RMM01106.BATCH_NO,      
 (CASE WHEN PRD_RMM01106.DN_TYPE =1 THEN ''REGULAR'' ELSE ''FINIANCIAL'' END) AS DN_TYPE,PRD_RMM01106.AC_CODE      
 FROM PRD_RMM01106      
 JOIN FORM ON PRD_RMM01106.FORM_ID = FORM.FORM_ID      
 JOIN USERS ON PRD_RMM01106.USER_CODE = USERS.USER_CODE      
 JOIN LMV01106 C ON PRD_RMM01106.AC_CODE = C.AC_CODE      
 JOIN PRD_RMD01106 ON PRD_RMD01106.RM_ID = PRD_RMM01106.RM_ID      
 JOIN PRD_SKU SKU ON SKU.PRODUCT_UID = PRD_RMD01106.PRODUCT_UID      
 WHERE (PRD_RMM01106.RM_DT BETWEEN '''+@CFROMDATE +''' AND '''+@CTODATE +''') '+@CWHERE+'      
 GROUP BY FORM.FORM_NAME , USERS.USERNAME,  C.AC_NAME , PRD_RMM01106.RM_NO,RM_DT,PRD_RMM01106.TOTAL_AMOUNT,      
 PRD_RMM01106.CANCELLED,FORM.POST_TAX_SEPARATELY,PRD_RMM01106.TAX_AMOUNT,SKU.INV_NO,PRD_RMM01106.RM_ID,      
 PRD_RMM01106.BATCH_NO,PRD_RMM01106.DN_TYPE,PRD_RMM01106.AC_CODE      
 ORDER BY PRD_RMM01106.RM_NO'      
       
 PRINT @CCMD      
 EXECUTE SP_EXECUTESQL @CCMD      
       
 GOTO LAST      
       
 LBLREPORT:      
       
      
 SET @CCMD =N'SELECT C.AC_NAME AS SUPP_NAME, T0.RM_NO, PRD_RMD01106.QUANTITY,T0.TOTAL_AMOUNT,      
 CONVERT(CHAR(10),CASE WHEN RM_DT='''' THEN NULL ELSE RM_DT END ,105)AS RM_DT,      
 FORM.FORM_NAME,USERS.USERNAME,ISNULL(BATCH_NO,'''') AS BATCH_NO,       
 (CASE WHEN T0.CANCELLED = 1 THEN ''CANCELLED'' ELSE '''' END) AS [STATUS],      
 (CASE WHEN FORM.POST_TAX_SEPARATELY = 1 THEN (T0.TOTAL_AMOUNT- T0.TAX_AMOUNT) ELSE T0.TOTAL_AMOUNT END ) AS TOTAL_AMT_WO ,      
 ARTICLE.ARTICLE_DESC,ARTICLE.ARTICLE_NO,SKU.INV_DT,SKU.INV_NO,PRD_RMD01106.PURCHASE_PRICE,PRD_RMD01106.PRODUCT_UID,      
 (PRD_RMD01106.QUANTITY*PRD_RMD01106.PURCHASE_PRICE) AS NETRATE,      
 (PRD_RMD01106.QUANTITY*PRD_RMD01106.PURCHASE_PRICE) AS AMOUNT,       
 T0.AC_CODE,C.ADDRESS0+'' ''+C.ADDRESS1+'' ''+C.ADDRESS2 +'' ''+AREA.AREA_NAME+'' ''+CITY.CITY+'' ''+STATE.STATE+''-''+C.PINCODE AS [ADDRESS],      
 T0.DISCOUNT_AMOUNT AS MST_DISCOUNT_AMOUNT,T0.DISCOUNT_PERCENTAGE,T0.OTHER_CHARGES,T0.FREIGHT,      
 T0.TAX_PERCENTAGE,T0.ROUND_OFF,T0.EXCISE_EDU_CESS_AMOUNT,T0.EXCISE_HEDU_CESS_AMOUNT,      
 T0.EXCISE_DUTY_AMOUNT,PARA1.PARA1_NAME,PARA2.PARA2_NAME,PARA3.PARA3_NAME,T0.TAX_AMOUNT AS TOTAL_TAX_AMOUNT,      
 PRD_RMD01106.RFNET,SECD.SUB_SECTION_NAME,SECM.SECTION_NAME,C.PHONES_R+(CASE WHEN PHONES_R<>'''' AND PHONES_O<>''''       
 THEN '','' ELSE '''' END)+PHONES_O+(CASE WHEN (PHONES_R<>'''' OR PHONES_O<>'''') AND PHONES_FAX<>''''       
 THEN '','' ELSE '''' END)+PHONES_FAX AS PHONES,PRD_RMD01106.SRNO,      
 PARA4.PARA4_NAME,PARA5.PARA5_NAME,PARA6.PARA6_NAME      
       
 FROM PRD_RMM01106 T0     
 JOIN PRD_RMD01106 ON PRD_RMD01106.RM_ID = T0.RM_ID      
 JOIN FORM ON PRD_RMD01106.ITEM_FORM_ID = FORM.FORM_ID        
 JOIN USERS ON T0.USER_CODE = USERS.USER_CODE       
 JOIN LMV01106 C ON T0.AC_CODE = C.AC_CODE      
 JOIN PRD_SKU SKU ON SKU.PRODUCT_UID = PRD_RMD01106.PRODUCT_UID     
 JOIN ARTICLE ON SKU.ARTICLE_CODE= ARTICLE.ARTICLE_CODE       
 LEFT OUTER JOIN AREA ON C.AREA_CODE = AREA.AREA_CODE       
 JOIN PARA1 ON SKU.PARA1_CODE = PARA1.PARA1_CODE       
 JOIN PARA2 ON SKU.PARA2_CODE = PARA2.PARA2_CODE       
 JOIN PARA3 ON SKU.PARA3_CODE = PARA3.PARA3_CODE       
 JOIN PARA4 ON SKU.PARA4_CODE = PARA4.PARA4_CODE       
 JOIN PARA5 ON SKU.PARA5_CODE = PARA5.PARA5_CODE       
 JOIN PARA6 ON SKU.PARA6_CODE = PARA6.PARA6_CODE       
 LEFT OUTER JOIN CITY ON C.CITY_CODE = CITY.CITY_CODE       
 LEFT OUTER JOIN STATE ON CITY.STATE_CODE = STATE.STATE_CODE       
 JOIN SECTIOND SECD ON SECD.SUB_SECTION_CODE = ARTICLE.SUB_SECTION_CODE      
 JOIN SECTIONM SECM ON SECM.SECTION_CODE = SECD.SECTION_CODE      
 '+@CWHERE+'      
 ORDER BY C.AC_NAME, T0.RM_NO'      
       
 PRINT @CCMD      
 EXECUTE SP_EXECUTESQL @CCMD      
        
 GOTO LAST      
      
LBLSUPPLIERSLOV:      
  SET @cHeadCode = DBO.FN_ACT_TRAVTREE ('0000000018')	----ADD VARIABLE BY GAURI ON 17/4/2019	
  
      
 SELECT  A.AC_CODE, A.AC_NAME, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,         
    ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE,        
    A.ADDRESS1 + ' ' + A.ADDRESS2 + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +         
    A.STATE AS 'SUPP_ADDRESS', AC_NAME AS REPCOLNAME         
    FROM LMV01106 A         
    WHERE ( CHARINDEX ( HEAD_CODE, DBO.FN_ACT_TRAVTREE (@CWHERE) ) > 0  OR ALLOW_CREDITOR_DEBTOR = 1   
            OR CHARINDEX ( HEAD_CODE, @cHeadCode ) > 0 )  ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019       
            AND INACTIVE = 0 AND A.AC_NAME <> ''       
    UNION ALL        
    SELECT A.AC_CODE, ALIAS, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,         
    ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE,         
    A.ADDRESS1 + ' ' + A.ADDRESS2 + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +         
    A.STATE AS 'SUPP_ADDRESS', AC_NAME AS REPCOLNAME          
    FROM LMV01106 A         
    WHERE ( CHARINDEX ( HEAD_CODE, DBO.FN_ACT_TRAVTREE (@CWHERE) ) > 0  OR ALLOW_CREDITOR_DEBTOR = 1  
     OR CHARINDEX ( HEAD_CODE, @cHeadCode ) > 0 ) ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019        
    AND INACTIVE = 0 AND A.ALIAS <> ''       
    ORDER BY A.AC_NAME         
          
    GOTO LAST      
      
LBLGETMST:     
    
    
       
    SELECT FORM.FORM_NAME , USERS.USERNAME,  C.AC_NAME AS SUPP_NAME,       
           C.ADDRESS1 + ' ' + C.ADDRESS2 + ', ' + C.AREA_NAME + ' ' + C.CITY + ' ' + C.STATE AS 'SUPP_ADDRESS',      
           PRD_RMM01106.*, CONVERT(CHAR(10),CASE WHEN RM_DT='' THEN NULL ELSE RM_DT END ,105)  AS RM_DT1 
           ,LOCATION.DEPT_NAME,ISNULL(WO_MST.MEMO_NO,'') AS REF_WO_MEMO_NO 
    FROM PRD_RMM01106        
    JOIN FORM ON PRD_RMM01106.FORM_ID = FORM.FORM_ID        
    JOIN USERS ON PRD_RMM01106.USER_CODE = USERS.USER_CODE       
    JOIN LMV01106 C ON PRD_RMM01106.AC_CODE = C.AC_CODE     
    LEFT OUTER JOIN LOCATION ON PRD_RMM01106.PARTY_DEPT_ID = LOCATION.DEPT_ID     
    LEFT OUTER JOIN PRD_WO_MST WO_MST ON PRD_RMM01106.REF_WO_MEMO_ID = WO_MST.MEMO_ID
    WHERE PRD_RMM01106.RM_ID =@CWHERE      
          
     GOTO LAST      
      
LBLGETDETAILS:      
      
 SELECT  DISTINCT A.*, RMM.FORM_ID, B.UOM_CODE, (A.PURCHASE_PRICE*A.QUANTITY) AS AMOUNT,      
 RMM.CANCELLED, A.PURCHASE_PRICE  AS 'RATE',B.DISCON,E.UOM_TYPE, RMM.RM_NO,  B.ARTICLE_CODE,       
 B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC, C.PARA1_CODE,       
    C.PARA1_NAME, D.PARA2_CODE, D.PARA2_ORDER, D.PARA2_NAME, E.UOM_CODE, E.UOM_NAME, I.AC_CODE,        
 CONVERT(VARCHAR, S.INV_DT, 105) AS 'INV_DT', S.RECEIPT_DT, S.INV_NO, G.SUB_SECTION_NAME, H.PARA3_CODE,       
 H.PARA3_NAME, I.AC_NAME, J.SECTION_NAME, S.MRP, B.CODING_SCHEME, '' AS BRAND_NAME,       
 '' AS GROUP_NAME, Q.DEPT_NAME, X.PARA4_NAME, X.PARA4_CODE, Y.PARA5_NAME, Y.PARA5_CODE,       
 Z.PARA6_NAME, Z.PARA6_CODE, 0 AS FREIGHT_PERCENTAGE, 0 AS OC_PERCENTAGE, R.FORM_NAME,       
  A.QUANTITY AS 'OLD_QUANTITY',      
  ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(H.DT_CREATED,'') AS [PARA3_DT_CREATED],      
  ISNULL(S.DT_CREATED,'') AS [SKU_DT_CREATED],I.CITY  ,    
  CAST(0 AS NUMERIC(10,2)) AS FREIGHT,CAST(0 AS NUMERIC(10,2)) AS OTHER_CHARGES,    
  CAST(0 AS NUMERIC(10,2)) AS DISCOUNT_AMOUNT,CAST(0 AS NUMERIC(10,2)) AS EXCISE_DUTY_AMOUNT,    
  CAST(0 AS NUMERIC(10,2)) AS ROUND_OFF,CAST(0 AS NUMERIC(10,2)) AS VALUE_ADD    
    FROM PRD_RMD01106 A          
    JOIN PRD_RMM01106 RMM ON A.RM_ID = RMM.RM_ID          
    JOIN PRD_SKU S ON A.PRODUCT_UID = S.PRODUCT_UID        
    JOIN ARTICLE B ON S.ARTICLE_CODE = B.ARTICLE_CODE          
    JOIN PARA1 C ON S.PARA1_CODE = C.PARA1_CODE          
    JOIN PARA2 D ON S.PARA2_CODE = D.PARA2_CODE         
    JOIN PARA3 H ON S.PARA3_CODE = H.PARA3_CODE          
    JOIN PARA4 X ON S.PARA4_CODE = X.PARA4_CODE          
    JOIN PARA5 Y ON S.PARA5_CODE = Y.PARA5_CODE          
    JOIN PARA6 Z ON S.PARA6_CODE = Z.PARA6_CODE         
    JOIN UOM E ON B.UOM_CODE = E.UOM_CODE         
    JOIN SECTIOND G ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE          
    JOIN LMV01106 I ON S.AC_CODE = I.AC_CODE      
    JOIN SECTIONM J ON G.SECTION_CODE = J.SECTION_CODE         
    JOIN LOCATION Q ON Q.DEPT_ID = LEFT(RMM.RM_NO,2)         
    JOIN FORM R ON A.ITEM_FORM_ID = R.FORM_ID      
    WHERE A.RM_ID =@CWHERE      
    ORDER BY A.TS      
          
     GOTO LAST      
          
         
              
    LBLGETBILL:      
           
      SELECT A.MRR_ID,COUNT(B.MRR_NO) AS ITEMCOUNT        
      FROM PRD_PID01106 A (NOLOCK)        
      JOIN PRD_PIM01106 B (NOLOCK) ON A.MRR_ID = B.MRR_ID         
      JOIN ARTICLE C ON A.ARTICLE_CODE = C.ARTICLE_CODE    
      WHERE A.PRODUCT_UID =@CWHERE1  AND C.CODING_SCHEME =1  AND B.AC_CODE= @CWHERE       
      GROUP BY  A.MRR_ID   
           
           
     GOTO LAST      
           
           
     LBLGETBILLMASTER:      
           
   
      DECLARE @CQUERY NVARCHAR(MAX)  
      SET @CQUERY =
       N'SELECT DISTINCT CAST('''' AS NVARCHAR(10)) AS SRNO, CAST(0 AS BIT) AS BILLCHECK,           
       A.MRR_ID,A.MRR_NO,A.INV_DT,A.TOTAL_AMOUNT , C.AC_NAME ,A.AC_CODE, A.BILL_NO          
       FROM PRD_PIM01106  A (NOLOCK)        
       JOIN PRD_PID01106 B (NOLOCK) ON A.MRR_ID=B.MRR_ID         
       JOIN LMV01106 C (NOLOCK) ON A.AC_CODE = C.AC_CODE     
       JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID = B.PRODUCT_UID      
       --LEFT OUTER JOIN PRD_STK_TRANSFER_DET D ON D.PRODUCT_UID=B.PRODUCT_UID
       WHERE A.CANCELLED = 0  AND B.QUANTITY > 0            
       AND 
       B.PRODUCT_UID='''+@CWHERE1+''' ' 
 IF @CWHERE<>''  
  SET @CQUERY=@CQUERY+' AND A.AC_CODE='''+@CWHERE+''''  
    
    PRINT @CQUERY
  EXEC SP_EXECUTESQL @CQUERY  
        GOTO LAST      
           
     LBLGETBILLDET:      
           
           
 SELECT  PM.AC_CODE, F.UOM_TYPE, H.SECTION_NAME, G.SUB_SECTION_NAME, PD.PRODUCT_UID,          
            CONVERT(VARCHAR, PM.INV_DT, 105) AS INV_DT, PM.BILL_NO ,LM.AC_NAME,            
            PD.PURCHASE_PRICE, PD.MRP, B.ARTICLE_CODE, B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC,       
            C.PARA1_NAME, D.PARA2_NAME,  E.PARA3_NAME, P4.PARA4_NAME, P5.PARA5_NAME , P6.PARA6_NAME,       
            F.UOM_CODE, F.UOM_NAME, PM.FREIGHT, PM.DISCOUNT_AMOUNT, PD.TAX_AMOUNT, PD.FORM_ID,           
            I.FORM_NAME, PM.OTHER_CHARGES, PD.TAX_PERCENTAGE, 0 AS QUANTITY_IN_STOCK,          
            PD.PURCHASE_PRICE AS RATE , ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],      
            ISNULL(B.DT_CREATED,'') AS [SKU_DT_CREATED], PM.MRR_NO ,B.CODING_SCHEME,B.DISCON,'' AS CITY,PM.MRR_ID,      
            CAST( 0  AS BIT) AS BILLCHECK,PD.QUANTITY          
  FROM PRD_PID01106 PD        
  JOIN PRD_PIM01106 PM ON PD.MRR_ID = PM.MRR_ID             
  JOIN ARTICLE B (NOLOCK) ON PD.ARTICLE_CODE = B.ARTICLE_CODE                
  JOIN PARA1 C (NOLOCK) ON PD.PARA1_CODE = C.PARA1_CODE                
  JOIN PARA2 D (NOLOCK) ON PD.PARA2_CODE = D.PARA2_CODE               
  JOIN PARA3 E (NOLOCK) ON PD.PARA3_CODE = E.PARA3_CODE                
  JOIN PARA4 P4 (NOLOCK) ON PD.PARA4_CODE = P4.PARA4_CODE                
  JOIN PARA5 P5 (NOLOCK) ON PD.PARA5_CODE = P5.PARA5_CODE                
  JOIN PARA6 P6 (NOLOCK) ON PD.PARA6_CODE = P6.PARA6_CODE                 
  JOIN UOM F (NOLOCK) ON B.UOM_CODE = F.UOM_CODE               
  JOIN SECTIOND G (NOLOCK) ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE                
  JOIN SECTIONM H (NOLOCK) ON G.SECTION_CODE = H.SECTION_CODE               
  JOIN FORM I (NOLOCK) ON PD.FORM_ID = I.FORM_ID               
  JOIN LM01106 LM (NOLOCK) ON PM.AC_CODE = LM.AC_CODE  
  JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID = PD.PRODUCT_UID       
  --LEFT OUTER JOIN PRD_STK_TRANSFER_DET D1 ON D1.PRODUCT_UID=PD.PRODUCT_UID
  WHERE PM.CANCELLED = 0   AND PD.QUANTITY > 0              
  AND PD.PRODUCT_UID=@CWHERE1 
      
            
 GOTO LAST      
          
 LBLARTICLE_CODE:  
  SELECT DISTINCT T1.PRODUCT_UID,T1.ARTICLE_CODE,T2.ARTICLE_NO, P1.PARA1_NAME,P2.PARA2_NAME ,T1.PURCHASE_PRICE AS RATE,
                  T1.PRODUCT_CODE,PMT.QUANTITY_IN_STOCK
  FROM PRD_SKU T1  
  JOIN ARTICLE T2 ON T1.ARTICLE_CODE=T2.ARTICLE_CODE  
  JOIN PARA1 P1 ON P1.PARA1_CODE=T1.PARA1_CODE  
  JOIN PARA2 P2 ON P2.PARA2_CODE=T1.PARA2_CODE  
  JOIN PRD_PMT PMT ON PMT.PRODUCT_UID=T1.PRODUCT_UID  
  WHERE T1.WORK_ORDER_ID=@CWHERE  AND PMT.QUANTITY_IN_STOCK>0 AND PMT.DEPARTMENT_ID=  @CWHERE1
    
GOTO LAST  

LBLWORDERLIST:
	SELECT DISTINCT A.MEMO_ID,A.MEMO_NO,A.REF_NO,ART.ARTICLE_NO
    FROM PRD_WO_MST A 
    JOIN ARTICLE ART ON A.ARTICLE_SET_CODE=ART.ARTICLE_CODE 
    WHERE A.CANCELLED=0 AND A.MARK_AS_COMPLETED <>2
GOTO LAST
 LAST:      
END
