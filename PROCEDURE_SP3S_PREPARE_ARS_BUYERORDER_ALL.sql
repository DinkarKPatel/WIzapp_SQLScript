CREATE PROCEDURE SP3S_PREPARE_ARS_BUYERORDER_ALL
@NQUERYID INT,
@SPID INT,
@DEPTID VARCHAR(40) =''
----WITH ENCRYPTION
AS    
BEGIN    
SET NOCOUNT ON
DECLARE @SQL VARCHAR(MAX),@COL VARCHAR(MAX),@CATTR VARCHAR(MAX)    

IF @NQUERYID = 1
   GOTO LBLGETMASTER
  
ELSE IF @NQUERYID = 2--ADDED WHILE WORKING FOR ARS
   GOTO LBLGETDETAILS

ELSE    
   GOTO LAST    

LBLGETMASTER:

		SELECT  A.*, 0.00 AS TOTAL_QTY, CAST(0 AS NUMERIC(10,2)) AS TAX_PERCENTAGE, CAST(0 AS NUMERIC(10,2)) AS TAX_AMOUNT,   
		B.AC_NAME, C.DEPT_NAME,C.DEPT_ID , B.ADDRESS0,      
		B.ADDRESS1, B.ADDRESS2, B.AREA_NAME, B.CITY, B.PINCODE, B.STATE, B.SST_NO, 
		B.CITY, B.ADDRESS0 + ' ' + B.ADDRESS1 + ' ' + B.ADDRESS2 + ' ' + B.AREA_NAME + ' ' + B.CITY + ' ' + B.STATE + ' ' + B.MOBILE + ' ' AS SUPP_ADDRESS,     
		B.CREDIT_DAYS,B.DISCOUNT_PERCENTAGE AS LM_DISC_PER,
		B.SST_DT, B.TIN_NO, B.TIN_DT,D.USERNAME,E.USERNAME AS EDT_USERNAME,
		ISNULL(T4.EMP_NAME,'') AS EMP_NAME,
		ISNULL(T5.EMP_NAME,'') AS SALE_EMP_NAME,
		A.SALE_EMP_CODE AS SALE_EMP_CODE,
		T6.EMP_CODE AS MERCHANT_CODE, 
		T6.EMP_NAME AS MERCHANT_NAME,
        AG.ANGADIA_NAME,AG.INSURANCE_PERCENTAGE,
        LMB.AC_NAME AS BROKER_AC_NAME,CAST(0 AS INT) AS SP_ID,LF.DEPT_NAME AS WBO_FOR_DEPT_NAME
        FROM BUYER_ORDER_MST A  (NOLOCK)     
		JOIN LMV01106 B (NOLOCK)  ON A.AC_CODE = B.AC_CODE       
		JOIN USERS D  (NOLOCK)  ON A.USER_CODE = D.USER_CODE       
		JOIN USERS E (NOLOCK)  ON A.EDT_USER_CODE = E.USER_CODE       
		JOIN LOCATION C (NOLOCK)  ON A.DEPT_ID = C.DEPT_ID       
		LEFT OUTER JOIN EMPLOYEE T4 ON A.EMP_CODE= T4.EMP_CODE  
		LEFT OUTER JOIN EMPLOYEE T5 ON A.SALE_EMP_CODE= T5.EMP_CODE  
		LEFT OUTER JOIN EMPLOYEE T6 ON A.MERCHANT_CODE= T6.EMP_CODE 
        LEFT JOIN ANGM AG ON AG.ANGADIA_CODE=A.ANGADIA_CODE 
        LEFT OUTER JOIN LMV01106 LMB ON A.BROKER_AC_CODE= LMB.AC_CODE 
        LEFT OUTER JOIN LOCATION LF (NOLOCK)  ON A.WBO_FOR_DEPT_ID = LF.DEPT_ID                
GOTO LAST


LBLGETDETAILS:
   IF OBJECT_ID('tempdb..##ART_WSLBO') IS NOT NULL DROP TABLE ##ART_WSLBO
   CREATE TABLE ##ART_WSLBO(COL VARCHAR(100))

   SET @SQL='DELETE FROM ##ART_WSLBO;'+CHAR(13)
   SELECT @SQL=COALESCE(@SQL,'')+'IF EXISTS(SELECT TOP 1 '+COLUMN_NAME+' FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID='+CAST(@SPID AS VARCHAR)+' AND REORDER_QTY>0 AND '+COLUMN_NAME+' NOT LIKE ''0000000%'')'+CHAR(13)+'   INSERT ##ART_WSLBO SELECT '''+COLUMN_NAME+''';'+CHAR(13) 
   FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='ARS_ARS_PLAN_DETAIL_UPLOAD' AND COLUMN_NAME LIKE '%CODE' AND COLUMN_NAME<>'USER_CODE'
   EXEC(@SQL)
   
   ALTER TABLE ##ART_WSLBO ADD TAB VARCHAR(1000)
   ALTER TABLE ##ART_WSLBO ADD FIELD VARCHAR(1000)
  
   UPDATE ##ART_WSLBO SET TAB='ARTICLE',FIELD='ARTICLE_NO' WHERE COL LIKE '%ARTICLE%'
   UPDATE ##ART_WSLBO SET TAB='SECTIONM',FIELD='SECTION_NAME' WHERE COL LIKE 'SECTION_CODE'
   UPDATE ##ART_WSLBO SET TAB='SECTIOND',FIELD='SUB_SECTION_NAME' WHERE COL LIKE 'SUB_SECTION_CODE'
   UPDATE ##ART_WSLBO SET TAB=LEFT(COL,5),FIELD=REPLACE(COL,'_CODE','_NAME') WHERE COL LIKE 'PARA%CODE'
   UPDATE ##ART_WSLBO SET TAB=LEFT(COL,5)+'_MST',FIELD=REPLACE(COL,'_CODE','_NAME') WHERE COL LIKE 'ATTR%KEY_CODE'
   
   IF NOT EXISTS(SELECT TOP 1 ARTICLE_NO FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ARTICLE_NO<>'')
       DELETE ##ART_WSLBO WHERE COL='ARTICLE_CODE'
   IF NOT EXISTS(SELECT TOP 1 SECTION_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND SECTION_NAME<>'') 
       DELETE ##ART_WSLBO WHERE COL='SECTION_CODE'   
   IF NOT EXISTS(SELECT TOP 1 SUB_SECTION_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND SUB_SECTION_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='SUB_SECTION_CODE'   
   IF NOT EXISTS(SELECT TOP 1 PARA1_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND PARA1_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='PARA1_CODE'   
   IF NOT EXISTS(SELECT TOP 1 PARA2_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND PARA2_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='PARA2_CODE'      
   IF NOT EXISTS(SELECT TOP 1 PARA3_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND PARA3_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='PARA3_CODE'      
   IF NOT EXISTS(SELECT TOP 1 PARA4_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND PARA4_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='PARA4_CODE'      
   IF NOT EXISTS(SELECT TOP 1 PARA5_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND PARA5_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='PARA5_CODE'      
   IF NOT EXISTS(SELECT TOP 1 PARA6_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND PARA6_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='PARA6_CODE'      
   IF NOT EXISTS(SELECT TOP 1 ATTR1_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR1_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR1_KEY_CODE'      
   IF NOT EXISTS(SELECT TOP 1 ATTR2_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR2_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR2_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR3_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR3_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR3_KEY_CODE'      
   IF NOT EXISTS(SELECT TOP 1 ATTR4_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR4_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR4_KEY_CODE'      
   IF NOT EXISTS(SELECT TOP 1 ATTR5_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR5_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR5_KEY_CODE'          
   IF NOT EXISTS(SELECT TOP 1 ATTR6_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR6_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR6_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR7_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR7_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR7_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR8_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR8_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR8_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR9_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR9_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR9_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR10_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR10_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR10_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR11_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR11_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR11_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR12_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR12_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR12_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR13_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR13_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR13_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR14_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR14_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR14_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR15_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR15_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR15_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR16_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR16_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR16_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR17_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR17_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR17_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR18_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR18_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR18_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR19_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR19_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR19_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR20_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR20_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR20_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR21_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR21_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR21_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR22_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR22_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR22_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR23_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR23_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR23_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR24_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR24_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR24_KEY_CODE'         
   IF NOT EXISTS(SELECT TOP 1 ATTR25_KEY_NAME FROM ARS_ARS_PLAN_DETAIL_UPLOAD WHERE SP_ID=@SPID AND ATTR25_KEY_NAME<>'')
       DELETE ##ART_WSLBO WHERE COL='ATTR25_KEY_CODE'         

   SET @SQL=''
   SELECT @SQL=COALESCE(@SQL,'')+TAB+'.'+FIELD+'=ARS.'+FIELD+' AND ' FROM ##ART_WSLBO WHERE COL NOT LIKE 'ATTR%'
   SET @SQL=RTRIM(@SQL)
   IF RIGHT(@SQL,3)='AND' SET @SQL=LEFT(@SQL,LEN(@SQL)-3)
   
   SET @CATTR=''
   SELECT @CATTR=COALESCE(@CATTR,'')+TAB+'.'+FIELD+'=ARS.'+FIELD+' AND ' FROM ##ART_WSLBO WHERE COL LIKE 'ATTR%'
   SET @CATTR=RTRIM(@CATTR)
   IF RIGHT(@CATTR,3)='AND' SET @CATTR=LEFT(@CATTR,LEN(@CATTR)-3)
   
   IF ISNULL(@SQL,'')='' SET @SQL='1=1'
   
   SET @SQL='SELECT '+CASE @DEPTID WHEN '' THEN 'TOP 0 'ELSE '' END+'SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PARA3_CODE,SKU.PARA4_CODE,SKU.PARA5_CODE,SKU.PARA6_CODE
   ,0 WHOLESALE_PRICE,0 GROSS_PURCHASE_PRICE,0 GST_PERCENTAGE,''0000000000'' HSN_CODE
   ,RNO=ROW_NUMBER()OVER(PARTITION BY SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PARA3_CODE,SKU.PARA4_CODE,SKU.PARA5_CODE,SKU.PARA6_CODE ORDER BY SKU.ARTICLE_CODE,SKU.PARA1_CODE,SKU.PARA2_CODE,SKU.PARA3_CODE,SKU.PARA4_CODE,SKU.PARA5_CODE,SKU.PARA6_CODE)
   FROM ARS_ARS_PLAN_DETAIL_UPLOAD ARS (NOLOCK)'
   +CHAR(13)+' JOIN SKU (NOLOCK)'
   +CHAR(13)+' JOIN PARA1 (NOLOCK) ON SKU.PARA1_CODE=PARA1.PARA1_CODE'
   +CHAR(13)+' JOIN PARA2 (NOLOCK) ON SKU.PARA2_CODE=PARA2.PARA2_CODE'
   +CHAR(13)+' JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE'
   +CHAR(13)+' JOIN PARA4 (NOLOCK) ON SKU.PARA4_CODE=PARA4.PARA4_CODE'
   +CHAR(13)+' JOIN PARA5 (NOLOCK) ON SKU.PARA5_CODE=PARA5.PARA5_CODE'
   +CHAR(13)+' JOIN PARA6 (NOLOCK) ON SKU.PARA6_CODE=PARA6.PARA6_CODE'
   +CHAR(13)+' JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE'
   +CHAR(13)+' JOIN SECTIOND (NOLOCK) ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE'
   +CHAR(13)+' JOIN SECTIONM (NOLOCK) ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE'
   +CHAR(13)+' JOIN ARTICLE_FIX_ATTR AF (NOLOCK) ON AF.ARTICLE_CODE=ARTICLE.ARTICLE_CODE'
   +CHAR(13)+' JOIN ATTR1_MST (NOLOCK) ON ATTR1_MST.ATTR1_KEY_CODE=AF.ATTR1_KEY_CODE'
   +CHAR(13)+' JOIN ATTR2_MST (NOLOCK) ON ATTR2_MST.ATTR2_KEY_CODE=AF.ATTR2_KEY_CODE'
   +CHAR(13)+' JOIN ATTR3_MST (NOLOCK) ON ATTR3_MST.ATTR3_KEY_CODE=AF.ATTR3_KEY_CODE'
   +CHAR(13)+' JOIN ATTR4_MST (NOLOCK) ON ATTR4_MST.ATTR4_KEY_CODE=AF.ATTR4_KEY_CODE'
   +CHAR(13)+' JOIN ATTR5_MST (NOLOCK) ON ATTR5_MST.ATTR5_KEY_CODE=AF.ATTR5_KEY_CODE'
   +CHAR(13)+' JOIN ATTR6_MST (NOLOCK) ON ATTR6_MST.ATTR6_KEY_CODE=AF.ATTR6_KEY_CODE'
   +CHAR(13)+' JOIN ATTR7_MST (NOLOCK) ON ATTR7_MST.ATTR7_KEY_CODE=AF.ATTR7_KEY_CODE'
   +CHAR(13)+' JOIN ATTR8_MST (NOLOCK) ON ATTR8_MST.ATTR8_KEY_CODE=AF.ATTR8_KEY_CODE'
   +CHAR(13)+' JOIN ATTR9_MST (NOLOCK) ON ATTR9_MST.ATTR9_KEY_CODE=AF.ATTR9_KEY_CODE'
   +CHAR(13)+' JOIN ATTR10_MST (NOLOCK) ON ATTR10_MST.ATTR10_KEY_CODE=AF.ATTR10_KEY_CODE'
   +CHAR(13)+' JOIN ATTR11_MST (NOLOCK) ON ATTR11_MST.ATTR11_KEY_CODE=AF.ATTR11_KEY_CODE'
   +CHAR(13)+' JOIN ATTR12_MST (NOLOCK) ON ATTR12_MST.ATTR12_KEY_CODE=AF.ATTR12_KEY_CODE'
   +CHAR(13)+' JOIN ATTR13_MST (NOLOCK) ON ATTR13_MST.ATTR13_KEY_CODE=AF.ATTR13_KEY_CODE'
   +CHAR(13)+' JOIN ATTR14_MST (NOLOCK) ON ATTR14_MST.ATTR14_KEY_CODE=AF.ATTR14_KEY_CODE'
   +CHAR(13)+' JOIN ATTR15_MST (NOLOCK) ON ATTR15_MST.ATTR15_KEY_CODE=AF.ATTR15_KEY_CODE'
   +CHAR(13)+' JOIN ATTR16_MST (NOLOCK) ON ATTR16_MST.ATTR16_KEY_CODE=AF.ATTR16_KEY_CODE'
   +CHAR(13)+' JOIN ATTR17_MST (NOLOCK) ON ATTR17_MST.ATTR17_KEY_CODE=AF.ATTR17_KEY_CODE'
   +CHAR(13)+' JOIN ATTR18_MST (NOLOCK) ON ATTR18_MST.ATTR18_KEY_CODE=AF.ATTR18_KEY_CODE'
   +CHAR(13)+' JOIN ATTR19_MST (NOLOCK) ON ATTR19_MST.ATTR19_KEY_CODE=AF.ATTR19_KEY_CODE'
   +CHAR(13)+' JOIN ATTR20_MST (NOLOCK) ON ATTR20_MST.ATTR20_KEY_CODE=AF.ATTR20_KEY_CODE'
   +CHAR(13)+' JOIN ATTR21_MST (NOLOCK) ON ATTR21_MST.ATTR21_KEY_CODE=AF.ATTR21_KEY_CODE'
   +CHAR(13)+' JOIN ATTR22_MST (NOLOCK) ON ATTR22_MST.ATTR22_KEY_CODE=AF.ATTR22_KEY_CODE'
   +CHAR(13)+' JOIN ATTR23_MST (NOLOCK) ON ATTR23_MST.ATTR23_KEY_CODE=AF.ATTR23_KEY_CODE'
   +CHAR(13)+' JOIN ATTR24_MST (NOLOCK) ON ATTR24_MST.ATTR24_KEY_CODE=AF.ATTR24_KEY_CODE'
   +CHAR(13)+' JOIN ATTR25_MST (NOLOCK) ON ATTR25_MST.ATTR25_KEY_CODE=AF.ATTR25_KEY_CODE'
   +CHAR(13)+'ON '+REPLACE(REPLACE(@SQL,'D.SECTION_CODE','SECTIONM.SECTION_CODE'),'D.SUB_SECTION_CODE','SECTIOND.SUB_SECTION_CODE')+CASE WHEN ISNULL(@CATTR,'')='' THEN '' ELSE ' AND '+@CATTR END
   +CHAR(13)+'WHERE ARS.SP_ID='+CAST(@SPID AS VARCHAR)+' AND ARS.REORDER_QTY>0'
   --+CHAR(13)+'AND M.CANCELLED=0 AND (D.WHOLESALE_PRICE>0 AND D.GROSS_PURCHASE_PRICE>0)' 
   
   IF OBJECT_ID('tempdb..#PRICE') IS NOT NULL DROP TABLE #PRICE
   CREATE TABLE #PRICE(ARTICLE_CODE VARCHAR(10),PARA1_CODE VARCHAR(10),PARA2_CODE VARCHAR(10),PARA3_CODE VARCHAR(10),PARA4_CODE VARCHAR(10),PARA5_CODE VARCHAR(10),PARA6_CODE VARCHAR(10),WHOLESALE_PRICE FLOAT,GROSS_PURCHASE_PRICE FLOAT,GST_PERCENTAGE FLOAT,HSN_CODE VARCHAR(50),RNO INT)
   PRINT @SQL
   
   INSERT #PRICE EXEC(@SQL)
   
   DELETE #PRICE WHERE RNO>1
   SELECT 200,* FROM #PRICE
   
   IF OBJECT_ID('tempdb..##ART_WSLBO') IS NOT NULL DROP TABLE ##ART_WSLBO
   IF @DEPTID=''
		SELECT A.ARTICLE_NAME,CAST('LATER' AS VARCHAR(22))ORDER_ID,ARS.PARA1_CODE,ARS.PARA2_CODE,CAST(ARS.REORDER_QTY AS NUMERIC(14,4))QUANTITY,ARS.DEPT_ID+LEFT(NEWID(),40)ROW_ID,GETDATE()LAST_UPDATE
		,ISNULL(P.GROSS_PURCHASE_PRICE,100) WS_PRICE
		,ISNULL(P.GROSS_PURCHASE_PRICE,100)*ARS.REORDER_QTY RFNET
		,A.ARTICLE_CODE
		,ISNULL(P.GROSS_PURCHASE_PRICE,100) GROSS_WSP
		,CAST(0 AS FLOAT)DISCOUNT_PERCENTAGE,CAST(0 AS FLOAT)DISCOUNT_AMOUNT
		,CAST('' AS VARCHAR(MAX))REMARKS,CAST('0000000' AS VARCHAR(50))PRODUCT_CODE
		,CAST(0 AS FLOAT)MANUAL_DISCOUNT,ARS.PARA3_CODE,CAST('' AS VARCHAR(50))ONLINE_PRODUCT_CODE
		,CAST('0000000' AS VARCHAR(10))ITEM_EMP_CODE
		,CAST('0000000' AS VARCHAR(10))ITEM_MERCHANT_CODE
		,ROW_NUMBER()OVER(ORDER BY ARS.ARTICLE_NO DESC)SERIAL_NO
		,ARS.ARTICLE_NO
		,ARS.PARA1_NAME
		,ARS.PARA2_NAME
		,P2.PARA2_ORDER
		,P1.PARA1_ORDER
		,ARS.PARA3_NAME
		,ISNULL(P.GROSS_PURCHASE_PRICE,100)*ARS.REORDER_QTY AMOUNT
		,UOM.UOM_CODE
		,UOM.UOM_NAME
		,UOM.UOM_TYPE
		,CAST('' AS TIMESTAMP) DT_CREATED
		,A.CODING_SCHEME
		,P1.PARA1_SET,P2.PARA2_SET,A.ALIAS ARTICLE_ALIAS,EMP.EMP_NAME ITEM_EMP_NAME,EMP1.EMP_NAME ITEM_MERCHANT_NAME
		,CAST(0 AS NUMERIC(10,2))ADJ_QTY
		,ROW_NUMBER()OVER(ORDER BY ARS.ARTICLE_NO DESC) SR_NO
		,ISNULL(P.HSN_CODE,'0000000000')HSN_CODE
		,ISNULL(P.GST_PERCENTAGE,0)GST_PERCENTAGE
		,CAST(0 AS NUMERIC(10,2))XN_VALUE_WITHOUT_GST
		,CAST(0 AS NUMERIC(10,2))XN_VALUE_WITH_GST
		,CAST(0 AS NUMERIC(10,2))IGST_AMOUNT
		,CAST(0 AS NUMERIC(10,2))CGST_AMOUNT
		,CAST(0 AS NUMERIC(10,2))SGST_AMOUNT
		,ROW_NUMBER()OVER(ORDER BY ARS.ARTICLE_NO DESC) SR
		,CAST(0 AS NUMERIC(14,2))CUMM_SUM
		,CAST(0 AS NUMERIC(14,2))WPS_QTY
		,CAST(0 AS NUMERIC(14,2))PEND_QTY
		,0 [TYPE]
		,ARS.SP_ID
		,CAST('' AS TIMESTAMP)TS
		FROM ARS_ARS_PLAN_DETAIL_UPLOAD ARS (NOLOCK)
		JOIN LOCATION L ON ARS.DEPT_ID=L.DEPT_ID
		LEFT JOIN ARTICLE A (NOLOCK) JOIN UOM (NOLOCK) ON UOM.UOM_CODE=A.UOM_CODE         
		ON A.ARTICLE_CODE=ARS.ARTICLE_CODE
		LEFT JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=ARS.PARA1_CODE
		LEFT JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=ARS.PARA2_CODE
		LEFT JOIN EMPLOYEE EMP (NOLOCK) ON EMP.EMP_CODE='0000000'
		LEFT JOIN EMPLOYEE EMP1 (NOLOCK) ON EMP1.EMP_CODE='0000000'
		LEFT JOIN #PRICE P ON P.ARTICLE_CODE=ARS.ARTICLE_CODE AND P.PARA1_CODE=ARS.PARA1_CODE AND P.PARA2_CODE=ARS.PARA2_CODE
							AND P.PARA3_CODE=ARS.PARA3_CODE AND P.PARA4_CODE=ARS.PARA4_CODE AND P.PARA5_CODE=ARS.PARA5_CODE AND P.PARA6_CODE=ARS.PARA6_CODE
		WHERE ARS.SP_ID=@SPID AND ARS.REORDER_QTY>0
	ELSE
		SELECT A.ARTICLE_NAME,CAST('LATER' AS VARCHAR(22))ORDER_ID,ARS.PARA1_CODE,ARS.PARA2_CODE,CAST(ARS.REORDER_QTY AS NUMERIC(14,4))QUANTITY,ARS.DEPT_ID+LEFT(NEWID(),40)ROW_ID,GETDATE()LAST_UPDATE
		,ISNULL(P.GROSS_PURCHASE_PRICE,100) WS_PRICE
		,ISNULL(P.GROSS_PURCHASE_PRICE,100)*ARS.REORDER_QTY RFNET
		,A.ARTICLE_CODE
		,ISNULL(P.GROSS_PURCHASE_PRICE,100) GROSS_WSP
		,CAST(0 AS FLOAT)DISCOUNT_PERCENTAGE,CAST(0 AS FLOAT)DISCOUNT_AMOUNT
		,CAST('' AS VARCHAR(MAX))REMARKS,CAST('0000000' AS VARCHAR(50))PRODUCT_CODE
		,CAST(0 AS FLOAT)MANUAL_DISCOUNT,ARS.PARA3_CODE,CAST('' AS VARCHAR(50))ONLINE_PRODUCT_CODE
		,CAST('0000000' AS VARCHAR(10))ITEM_EMP_CODE
		,CAST('0000000' AS VARCHAR(10))ITEM_MERCHANT_CODE
		,ROW_NUMBER()OVER(ORDER BY ARS.ARTICLE_NO DESC)SERIAL_NO
		,ARS.ARTICLE_NO
		,ARS.PARA1_NAME
		,ARS.PARA2_NAME
		,P2.PARA2_ORDER
		,P1.PARA1_ORDER
		,ARS.PARA3_NAME
		,ISNULL(P.GROSS_PURCHASE_PRICE,100)*ARS.REORDER_QTY AMOUNT
		,UOM.UOM_CODE
		,UOM.UOM_NAME
		,UOM.UOM_TYPE
		,CAST('' AS TIMESTAMP) DT_CREATED
		,A.CODING_SCHEME
		,P1.PARA1_SET,P2.PARA2_SET,A.ALIAS ARTICLE_ALIAS,EMP.EMP_NAME ITEM_EMP_NAME,EMP1.EMP_NAME ITEM_MERCHANT_NAME
		,CAST(0 AS NUMERIC(10,2))ADJ_QTY
		,ROW_NUMBER()OVER(ORDER BY ARS.ARTICLE_NO DESC) SR_NO
		,ISNULL(P.HSN_CODE,'0000000000')HSN_CODE
		,ISNULL(P.GST_PERCENTAGE,0)GST_PERCENTAGE
		,CAST(0 AS NUMERIC(10,2))XN_VALUE_WITHOUT_GST
		,CAST(0 AS NUMERIC(10,2))XN_VALUE_WITH_GST
		,CAST(0 AS NUMERIC(10,2))IGST_AMOUNT
		,CAST(0 AS NUMERIC(10,2))CGST_AMOUNT
		,CAST(0 AS NUMERIC(10,2))SGST_AMOUNT
		,ROW_NUMBER()OVER(ORDER BY ARS.ARTICLE_NO DESC) SR
		,CAST(0 AS NUMERIC(14,2))CUMM_SUM
		,CAST(0 AS NUMERIC(14,2))WPS_QTY
		,CAST(0 AS NUMERIC(14,2))PEND_QTY
		,0 [TYPE]
		,ARS.SP_ID
		,CAST('' AS TIMESTAMP)TS
		FROM ARS_ARS_PLAN_DETAIL_UPLOAD ARS (NOLOCK)
		JOIN LOCATION L ON ARS.DEPT_ID=L.DEPT_ID
		LEFT JOIN ARTICLE A (NOLOCK) JOIN UOM (NOLOCK) ON UOM.UOM_CODE=A.UOM_CODE         
		ON A.ARTICLE_CODE=ARS.ARTICLE_CODE
		LEFT JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE=ARS.PARA1_CODE
		LEFT JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE=ARS.PARA2_CODE
		LEFT JOIN EMPLOYEE EMP (NOLOCK) ON EMP.EMP_CODE='0000000'
		LEFT JOIN EMPLOYEE EMP1 (NOLOCK) ON EMP1.EMP_CODE='0000000'
		LEFT JOIN #PRICE P ON P.ARTICLE_CODE=ARS.ARTICLE_CODE AND P.PARA1_CODE=ARS.PARA1_CODE AND P.PARA2_CODE=ARS.PARA2_CODE
							AND P.PARA3_CODE=ARS.PARA3_CODE AND P.PARA4_CODE=ARS.PARA4_CODE AND P.PARA5_CODE=ARS.PARA5_CODE AND P.PARA6_CODE=ARS.PARA6_CODE
		WHERE ARS.SP_ID=@SPID AND ARS.REORDER_QTY>0 AND ARS.DEPT_ID=@DEPTID
			
	IF OBJECT_ID('tempdb..#PRICE') IS NOT NULL DROP TABLE #PRICE
	GOTO LAST

LAST:   
SET NOCOUNT OFF
END
