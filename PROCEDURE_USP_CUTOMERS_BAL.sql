CREATE PROCEDURE USP_CUTOMERS_BAL
AS
BEGIN
SET NOCOUNT ON
IF OBJECT_ID('tempdb..#CUS_BAL') IS NOT NULL DROP TABLE #CUS_BAL
CREATE TABLE #CUS_BAL(CUS_CODE VARCHAR(50),BAL FLOAT)

INSERT #CUS_BAL
SELECT CUSTOMER_CODE,SUM(ISNULL(OPENING_BALANCE,0)) OPENING_BALANCE 
FROM CUSTDYM (NOLOCK)
GROUP BY CUSTOMER_CODE

INSERT #CUS_BAL
SELECT CUSTOMER_CODE,ABS(ISNULL(SUM(B.AMOUNT),0))CREDIT_ISSUE_AMT
FROM CMM01106 A (NOLOCK) JOIN PAYMODE_XN_DET B (NOLOCK)ON A.CM_ID=B.MEMO_ID
WHERE CANCELLED=0 AND PAYMODE_CODE='0000004' AND XN_TYPE='SLS' AND SUBSTRING(A.CM_NO,5,1)<>'N'  
GROUP BY CUSTOMER_CODE

INSERT #CUS_BAL
SELECT CUSTOMER_CODE,ABS(ISNULL(SUM(B.AMOUNT),0))CREDIT_NOTE_AMT_ADJ
FROM CMM01106 A (NOLOCK) 
JOIN PAYMODE_XN_DET B (NOLOCK) ON A.CM_ID=B.MEMO_ID  
WHERE CANCELLED=0 AND PAYMODE_CODE='0000001'AND XN_TYPE='SLS' AND A.CM_ID<>''
GROUP BY CUSTOMER_CODE

INSERT #CUS_BAL
SELECT CUSTOMER_CODE,ABS(ISNULL(SUM(B.AMOUNT),0))CREDIT_NOTE_AMT_ADJ_ARC 
FROM ARC01106 A (NOLOCK) JOIN PAYMODE_XN_DET B (NOLOCK) ON A.ADV_REC_ID=B.MEMO_ID  
WHERE CANCELLED=0 AND PAYMODE_CODE='0000001'AND XN_TYPE ='ARC' AND ARC_TYPE<>2   
GROUP BY CUSTOMER_CODE

INSERT #CUS_BAL
SELECT CUSTOMER_CODE,ABS(SUM(ISNULL(B.AMOUNT,0)))ADAVANCE_AMT_ADJ1
FROM CMM01106 A (NOLOCK) JOIN PAYMODE_XN_DET B (NOLOCK) ON A.CM_ID=B.MEMO_ID  
WHERE CANCELLED=0 AND PAYMODE_CODE='0000002' AND XN_TYPE='SLS' AND A.CM_ID<>''
GROUP BY CUSTOMER_CODE

INSERT #CUS_BAL
SELECT CUSTOMER_CODE,ABS(SUM(ISNULL(B.AMOUNT*(CASE WHEN ARC_TYPE=2 THEN -1 ELSE 1 END),0))) ADAVANCE_AMT_ADJ2
FROM ARC01106 A (NOLOCK) JOIN PAYMODE_XN_DET B (NOLOCK) ON A.ADV_REC_ID=B.MEMO_ID
WHERE CANCELLED=0 AND PAYMODE_CODE='0000002' AND XN_TYPE='ARC' AND ARC_TYPE<>2
GROUP BY CUSTOMER_CODE

INSERT #CUS_BAL
SELECT CUSTOMER_CODE,ABS(ISNULL(SUM(AMOUNT),0))PAYMENT_AMT
FROM ARC01106 (NOLOCK) 
WHERE CANCELLED=0 AND ARC_TYPE=2
GROUP BY CUSTOMER_CODE
             
INSERT #CUS_BAL
SELECT CUSTOMER_CODE,SUM(RFNET)NORDERAMT
FROM WSL_ORDER_DET A (NOLOCK) JOIN WSL_ORDER_MST B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID
WHERE B.CANCELLED=0
GROUP BY CUSTOMER_CODE

--CREDIT AMOUNT
INSERT #CUS_BAL
SELECT CUSTOMER_CODE,-1*ABS(ISNULL(SUM(B.AMOUNT),0))CREDIT_NOTE_ISSUE_AMT
FROM CMM01106 A (NOLOCK)  
JOIN PAYMODE_XN_DET B (NOLOCK) ON A.CM_ID=B.MEMO_ID  
WHERE CANCELLED=0 AND PAYMODE_CODE='0000004' AND XN_TYPE='SLS' 
AND SUBSTRING(A.CM_NO,5,1)='N'  AND A.CM_ID<>''
GROUP BY CUSTOMER_CODE

INSERT #CUS_BAL
SELECT CUSTOMER_CODE,-1*ABS(ISNULL(SUM(B.AMOUNT),0))CREDIT_REFUND_AMT
FROM CMM01106 A (NOLOCK) JOIN PAYMODE_XN_DET B (NOLOCK) ON A.CM_ID=B.MEMO_ID
WHERE CANCELLED=0 AND PAYMODE_CODE='CMR0001'AND XN_TYPE='SLS' AND A.CM_ID<>''
GROUP BY CUSTOMER_CODE

INSERT #CUS_BAL
SELECT CUSTOMER_CODE,-1*ABS(ISNULL(SUM(AMOUNT),0))RECEIPT_AMT
FROM ARC01106 (NOLOCK) 
WHERE CANCELLED=0 AND  ARC_TYPE=1 AND ARCT IN(1,2)
GROUP BY CUSTOMER_CODE

IF OBJECT_ID('tempdb..#CTE') IS NOT NULL DROP TABLE #CTE
;WITH CTE AS (SELECT CM_ID,ROW_ID,RNO=ROW_NUMBER()OVER(PARTITION BY CM_ID ORDER BY ROW_ID) FROM CMD01106 (NOLOCK))
SELECT CM_ID,ROW_ID INTO #CTE FROM CTE WHERE RNO=1
INSERT #CUS_BAL
SELECT A.CUSTOMER_CODE,-1*SUM(NET_AMOUNT)NORDDLVAMT 
FROM CMM01106 A (NOLOCK) 
JOIN CMD01106 B (NOLOCK) ON A.CM_ID=B.CM_ID
JOIN #CTE CTE (NOLOCK) ON CTE.CM_ID=B.CM_ID AND CTE.ROW_ID=B.ROW_ID 
JOIN WSL_ORDER_DET C (NOLOCK) ON B.PRODUCT_CODE=(CASE WHEN C.ORDER_TYPE=0 THEN C.PRODUCT_CODE ELSE C.REF_PRODUCT_CODE END)
JOIN WSL_ORDER_MST D (NOLOCK) ON D.ORDER_ID=C.ORDER_ID AND A.CUSTOMER_CODE=D.CUSTOMER_CODE
WHERE A.CANCELLED=0 AND D.CANCELLED=0 AND A.CM_ID<>''
GROUP BY A.CUSTOMER_CODE

SELECT CUS_CODE,SUM(BAL)BAL FROM #CUS_BAL GROUP BY CUS_CODE
SET NOCOUNT OFF
END
