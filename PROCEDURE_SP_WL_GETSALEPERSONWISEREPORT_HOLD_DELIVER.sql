CREATE PROCEDURE SP_WL_GETSALEPERSONWISEREPORT_HOLD_DELIVER--(LocId 3 digit change by Sanjay:30-10-2024)
(
	@CDEPTID VARCHAR(4)='',
	@CEMPCODE CHAR(7)='',
	@DFROMDT DATETIME,
	@DTODT DATETIME,
	@BESTIMATEENABLED BIT = 1,
	@CUSERCODE VARCHAR(15)='',
	@CBINID	VARCHAR(10)=''
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @BDSM BIT,@CERRMSGOUT VARCHAR(500)
   EXEC SP3S_CHECK_PENDING_BILLS 
     @DFROM_DT=@DFROMDT
	,@DTO_DT=@DTODT
	,@CDEPT_ID=@CDEPTID
	,@BESTIMATEENABLED=@BESTIMATEENABLED
	,@CUSERCODE=@CUSERCODE
	,@CBINID=@CBINID
	,@CERRMSGOUT=@CERRMSGOUT OUTPUT

	SELECT C.DEPT_NAME,B1.BIN_NAME, A.CM_DT, A.CM_NO, H.EMP_NAME, G.SECTION_NAME, F.SUB_SECTION_NAME, P1.PARA1_NAME,
			P2.PARA2_NAME, B.PRODUCT_CODE, E.ARTICLE_NAME,
			A.DISCOUNT_PERCENTAGE AS CMMDISCPCT, A.DISCOUNT_AMOUNT AS CMMDISCAMT
			,CAST(SUM( CASE WHEN A.CM_MODE =1 THEN B.QUANTITY   ELSE 0 END) AS NUMERIC(14,2)) AS QUANTITY
			,CAST(SUM(CASE WHEN A.CM_MODE =1 THEN B.MRP * (B.QUANTITY) ELSE 0 END ) AS NUMERIC(14,2)) AS MRP
			,CAST(SUM(CASE WHEN A.CM_MODE=1 THEN ROUND((B.QUANTITY*B.MRP)-B.RFNET,2) ELSE 0 END ) AS NUMERIC(14,2)) AS CMDDISCAMT
			,CAST(CASE WHEN ABS(SUM(B.QUANTITY*B.MRP))> 0 THEN (SUM(CASE WHEN A.CM_MODE=1 THEN ROUND((B.QUANTITY*B.MRP)-B.RFNET,2) ELSE 0 END )/SUM(CASE WHEN A.CM_MODE =1 THEN  B.QUANTITY*B.MRP ELSE 1 END ))*100  ELSE 0 END AS NUMERIC(14,2)) AS CMMDISCPCT
			,CAST(SUM( CASE WHEN A.CM_MODE =1 THEN B.RFNET ELSE 0 END ) AS NUMERIC(14,2)) AS NET
			,SUM(ISNULL(HBD.HBD_QTY,0)) AS HBD_QTY,SUM(ISNULL(HBD.HBD_QTY,0)*B.MRP) AS HBD_AMT
			,(CASE WHEN SUM(ISNULL(HBD.HBD_QTY,0))=0 THEN SUM(B.QUANTITY) ELSE SUM(ISNULL(DEL.DEL_QTY,0)) END) AS DEL_QTY
			,((CASE WHEN SUM(ISNULL(HBD.HBD_QTY,0)*B.MRP)=0 THEN SUM(B.QUANTITY*B.MRP) ELSE SUM(ISNULL(DEL.DEL_QTY,0)*B.MRP) END)) AS DEL_AMT  
	 FROM CMM01106 A (NOLOCK)   
	 JOIN CMD01106 B (NOLOCK) ON A.CM_ID=B.CM_ID 
	 LEFT JOIN
	 (
	  SELECT REF_CMD_ROW_ID,1 AS  HBD_QTY,D.ROW_ID   FROM 
	  HOLD_BACK_DELIVER_MST M (NOLOCK)
	  JOIN HOLD_BACK_DELIVER_DET D (NOLOCK) ON M.MEMO_ID =D.MEMO_ID 
	  WHERE M.CANCELLED =0 AND D.DELIVERED=0
	 ) 	HBD ON HBD.REF_CMD_ROW_ID =B.ROW_ID	
	 LEFT JOIN
	(
	  SELECT REF_HBD_ROW_ID,1 AS DEL_QTY 
	  FROM SLS_DELIVERY_DET SDET
	  JOIN SLS_DELIVERY_MST SMST ON SDET.MEMO_ID=SMST.MEMO_ID
	  WHERE SMST.CANCELLED=0
	) DEL ON DEL.REF_HBD_ROW_ID=HBD.ROW_ID
	 JOIN LOCATION C (NOLOCK) ON a.location_code=C.DEPT_ID  
	 JOIN SKU D (NOLOCK) ON B.PRODUCT_CODE=D.PRODUCT_CODE  
	 JOIN ARTICLE E (NOLOCK) ON D.ARTICLE_CODE=E.ARTICLE_CODE  
	 JOIN SECTIOND F (NOLOCK) ON E.SUB_SECTION_CODE=F.SUB_SECTION_CODE  
	 JOIN SECTIONM G (NOLOCK) ON F.SECTION_CODE=G.SECTION_CODE  
	 JOIN PARA1 P1 (NOLOCK) ON D.PARA1_CODE=P1.PARA1_CODE  
	 JOIN PARA2 P2 (NOLOCK) ON D.PARA2_CODE=P2.PARA2_CODE  
	 JOIN EMPLOYEE H (NOLOCK) ON B.EMP_CODE=H.EMP_CODE  
	 JOIN BIN B1 ON B1.BIN_ID=ISNULL(A.BIN_ID,'000')
	 WHERE A.CM_DT BETWEEN @DFROMDT AND @DTODT  --AND A.CM_MODE = 1 --CHANGE 
	 AND C.DEPT_ID = (CASE WHEN @CDEPTID = '' THEN C.DEPT_ID ELSE @CDEPTID END)  
	 AND A.BIN_ID = (CASE WHEN @CBINID = '' THEN A.BIN_ID ELSE @CBINID END)  
	 AND H.EMP_CODE = (CASE WHEN @CEMPCODE = '' THEN H.EMP_CODE ELSE @CEMPCODE END)  
	 AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1) AND A.CANCELLED = 0--CHANGE
	 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)
	 --AND ((@BDSM=1 AND (DSD.CM_ID IS NOT NULL OR CB.CM_ID IS NOT NULL)) OR (@BDSM=0))	
	 GROUP BY C.DEPT_NAME,B1.BIN_NAME, A.CM_DT, A.CM_NO, H.EMP_NAME, G.SECTION_NAME, F.SUB_SECTION_NAME, P1.PARA1_NAME,
			P2.PARA2_NAME, B.PRODUCT_CODE,A.DISCOUNT_PERCENTAGE,  A.DISCOUNT_AMOUNT , E.ARTICLE_NAME
	 ORDER BY C.DEPT_NAME,B1.BIN_NAME,H.EMP_NAME, A.CM_DT, A.CM_NO,  G.SECTION_NAME, F.SUB_SECTION_NAME, P1.PARA1_NAME 
	 
	 SELECT ISNULL(@CERRMSGOUT,'') AS ALERT_MESSAGE
END
--********************************************** END OF PROCEDURE SP_WL_GETSALEPERSONWISEREPORT_HOLD_DELIVER
