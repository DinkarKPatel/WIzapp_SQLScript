CREATE PROCEDURE SP_DSR_DETAILSALE_INV  
(          --PARAMETERS  
 @DFROMDT DATETIME,    --REPORT FROM DT  
 @DTODT  DATETIME,    --REPORT TO DT  
 @CDEPTID CHAR(4)='',    --DEPT ID (IF BLANK THIS PARAMETER THEN RUN THIS REPORT FOR ALL LOCATION  
 @NMODE  INT,      --@NMODE=1- BILL NO WISE; 2- DATE WISE
 @BESTIMATEENABLED BIT = 1 ,
 @CUSERCODE VARCHAR(15),
 @CBINID VARCHAR(10)
)  
--WITH ENCRYPTION
AS  
BEGIN  
--(dinkar) Replace  left(memoid,2) to Location_code 

/*
MODIFICATION HISTORY:
MODIFIED BY			: BABAN
MODIFICATION DATE	: 15 SEP 2014
DESCRIPTION			: BASED ON CONFIG SETTING, CASH MEMOS COULD BE FILTERED(VALID CASH MEMO (VALIDATED BY CASHIER)
					  AND INVALID CASH MEMO).
*/  
	DECLARE @CMAJORDEPTID VARCHAR(5),@BDSM BIT
	SELECT TOP 1 @BDSM=VALUE FROM CONFIG WHERE CONFIG_OPTION='OPEN_CASHIER_FOR_CASHMEMOS'
	SET @BDSM=ISNULL(@BDSM,0)	
    
    SELECT @CMAJORDEPTID=MAJOR_DEPT_ID FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CDEPTID
   
    SET @CMAJORDEPTID=ISNULL(@CMAJORDEPTID,'')
 
	DECLARE @OUTPUTC TABLE ( DEPT_ID VARCHAR(4), DEPT_NAME VARCHAR(200),
	BIN_ID VARCHAR(10), BIN_NAME VARCHAR(200),
	CM_DT DATETIME, CM_NO VARCHAR(100),   
	QUANTITY NUMERIC(10,3), SLS_AT_MRP NUMERIC(12,2), SLR_AT_MRP NUMERIC(12,2),   
	NET_SLS_AT_MRP NUMERIC(12,2), DISCOUNT_AMOUNT NUMERIC(12,2), ITEM_DISCOUNT_AMOUNT NUMERIC(12,2),   
	DISCOUNT_PERCENTAGE NUMERIC(12,2), NET_AMOUNT NUMERIC(12,2),  
	ATD_CHARGES NUMERIC(12,2), CASH_AMOUNT NUMERIC(12,2), CC_AMOUNT NUMERIC(12,2),   
	CN_AMOUNT NUMERIC(12,2), ADVANCE_AMOUNT_ADJUSTED NUMERIC(12,2),  
	OTHER_DOC_AMOUNT NUMERIC(12,2), CREDIT_AMOUNT NUMERIC(12,2),   
	BANK_CHARGES NUMERIC(12,2), MISC_AMOUNT NUMERIC(12,2), CANCELLED BIT, ROUND_OFF NUMERIC(12,2),
	SUB_SECTION_NAME VARCHAR(100),TAX_PERCENTAGE NUMERIC(10,3), TAX_AMOUNT NUMERIC(10,2),
	CUST_NAME VARCHAR(200),SUBTOTAL NUMERIC(12,2))  

	DECLARE @BDONOTSHOWITEMDISC BIT 

	SELECT @BDONOTSHOWITEMDISC=ISNULL(VALUE,0) FROM CONFIG 
	WHERE CONFIG_OPTION='DO_NOT_SHOW_ITEM_DISC'
	SET @BDONOTSHOWITEMDISC=ISNULL(@BDONOTSHOWITEMDISC,0) 

  
 INSERT @OUTPUTC ( DEPT_ID, DEPT_NAME,BIN_ID , BIN_NAME, CM_DT, CM_NO, QUANTITY, SLS_AT_MRP, SLR_AT_MRP,   
       NET_SLS_AT_MRP, DISCOUNT_AMOUNT,ITEM_DISCOUNT_AMOUNT, DISCOUNT_PERCENTAGE, NET_AMOUNT,  
       ATD_CHARGES, CASH_AMOUNT, CC_AMOUNT, CN_AMOUNT, ADVANCE_AMOUNT_ADJUSTED,  
       OTHER_DOC_AMOUNT, CREDIT_AMOUNT, BANK_CHARGES, MISC_AMOUNT, CANCELLED, ROUND_OFF,SUB_SECTION_NAME,
       TAX_PERCENTAGE,TAX_AMOUNT ,CUST_NAME,SUBTOTAL)  
  
	SELECT C.DEPT_ID, C.DEPT_ID + ' ' + C.DEPT_NAME AS DEPT_NAME,
	B1.BIN_ID , B1.BIN_NAME ,  A.CM_DT,   
   A.CM_NO + (CASE WHEN A.CANCELLED=1 THEN ': CANCELLED' ELSE '' END) AS CM_NO,   
   (CASE WHEN A.CANCELLED=0 THEN B.QUANTITY ELSE 0 END) AS QUANTITY,   
   (CASE WHEN A.CANCELLED=0 THEN B.SLS_AT_MRP ELSE 0 END) AS SLS_AT_MRP,   
   (CASE WHEN A.CANCELLED=0 THEN B.SLR_AT_MRP ELSE 0 END) AS SLR_AT_MRP,   
   (CASE WHEN A.CANCELLED=0 THEN (B.SLS_AT_MRP - B.SLR_AT_MRP) ELSE 0 END) AS NET_SLS_AT_MRP,  
   (CASE WHEN A.CANCELLED=0 THEN (A.DISCOUNT_AMOUNT) ELSE 0 END) AS DISCOUNT_AMOUNT,  
   (CASE WHEN A.CANCELLED=0 THEN ( B.ITEM_DISCOUNT_AMOUNT) ELSE 0 END) AS ITEM_DISCOUNT_AMOUNT,  
   (CASE WHEN A.CANCELLED=0 AND (B.SLS_AT_MRP - B.SLR_AT_MRP) <> 0 THEN  
    ((A.DISCOUNT_AMOUNT + B.ITEM_DISCOUNT_AMOUNT)*100)/(B.SLS_AT_MRP - B.SLR_AT_MRP)  
    ELSE 0 END) DISCOUNT_PERCENTAGE,  
   (CASE WHEN A.CANCELLED=0 THEN A.NET_AMOUNT ELSE 0 END) AS NET_AMOUNT,   
   (CASE WHEN A.CANCELLED=0 THEN A.ATD_CHARGES ELSE 0 END) AS ATD_CHARGES,  
   (CASE WHEN A.CANCELLED=0 THEN D.CASH_AMOUNT ELSE 0 END) AS CASH_AMOUNT,   
   (CASE WHEN A.CANCELLED=0 THEN D.CC_AMOUNT ELSE 0 END) AS CC_AMOUNT,   
   (CASE WHEN A.CANCELLED=0 THEN D.CN_AMOUNT ELSE 0 END) AS CN_AMOUNT,   
   (CASE WHEN A.CANCELLED=0 THEN D.ADVANCE_AMOUNT_ADJUSTED ELSE 0 END) AS ADVANCE_AMOUNT_ADJUSTED,   
   (CASE WHEN A.CANCELLED=0 THEN D.OTHER_DOC_AMOUNT ELSE 0 END) AS OTHER_DOC_AMOUNT,  
   (CASE WHEN A.CANCELLED=0 THEN D.CREDIT_AMOUNT+D.CREDIT_REFUND_AMOUNT ELSE 0 END) AS CREDIT_AMOUNT,   
   (CASE WHEN A.CANCELLED=0 THEN D.BANK_CHARGES ELSE 0 END) AS BANK_CHARGES,   
   (CASE WHEN A.CANCELLED=0 THEN D.MISC_AMOUNT ELSE 0 END) AS MISC_AMOUNT,  
   A.CANCELLED  ,
   (CASE WHEN A.CANCELLED=0 THEN A.ROUND_OFF ELSE 0 END) AS  [ROUND_OFF],
   SUB_SECTION_NAME,
   (CASE WHEN A.CANCELLED=0 THEN B.TAX_PERCENTAGE ELSE 0 END) AS TAX_PERCENTAGE ,
   (CASE WHEN A.CANCELLED=0 THEN B.TAX_AMOUNT ELSE 0 END) AS TAX_AMOUNT,
   CUST.CUSTOMER_TITLE+' '+ CUST.CUSTOMER_FNAME+' '+CUST.CUSTOMER_LNAME AS [CUST_NAME],
   (A.SUBTOTAL+A.SUBTOTAL_R) AS [SUBTOTAL]
 FROM CMM01106 A
 JOIN BIN B1 ON B1.BIN_ID=ISNULL(A.BIN_ID,'000')    
 JOIN   
 (  
	SELECT CM_ID,SECTIOND.SUB_SECTION_NAME,CMD01106.TAX_PERCENTAGE, SUM(QUANTITY) AS QUANTITY, SUM(CMD01106.TAX_AMOUNT) AS TAX_AMOUNT,
	       SUM(CASE WHEN @BDONOTSHOWITEMDISC=0 THEN CMD01106.DISCOUNT_AMOUNT ELSE 0 END) AS ITEM_DISCOUNT_AMOUNT,  
	SUM(CASE WHEN QUANTITY>0 THEN (QUANTITY*(CASE WHEN @BDONOTSHOWITEMDISC=0 THEN CMD01106.MRP ELSE NET END)) ELSE 0 END) AS SLS_AT_MRP,  
	SUM(CASE WHEN QUANTITY<0 THEN ABS(QUANTITY*(CASE WHEN @BDONOTSHOWITEMDISC=0 THEN CMD01106.MRP ELSE NET END)) ELSE 0 END)  AS SLR_AT_MRP  
	FROM CMD01106 (NOLOCK)
	JOIN SKU (NOLOCK) ON CMD01106.PRODUCT_CODE = SKU.PRODUCT_CODE 
	JOIN ARTICLE (NOLOCK) ON SKU.ARTICLE_CODE = ARTICLE.ARTICLE_CODE
	JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE   
	GROUP BY CM_ID,SECTIOND.SUB_SECTION_NAME,CMD01106.TAX_PERCENTAGE 
 ) B ON A.CM_ID = B.CM_ID    
 JOIN LOCATION C ON A.location_Code  = C.DEPT_ID    
 JOIN CUSTDYM CUST ON CUST.CUSTOMER_CODE=A.CUSTOMER_CODE
 LEFT OUTER JOIN VW_BILL_PAYMODE D ON A.CM_ID = D.MEMO_ID AND D.XN_TYPE = 'SLS'  
 LEFT JOIN 
	(
		SELECT DISTINCT CM_ID FROM DSD01106 DSD(NOLOCK) JOIN DSM01106 DSM(NOLOCK) ON DSD.DS_ID=DSM.DS_ID
		WHERE DSM.CANCELLED=0
	)DSD ON A.CM_ID=DSD.CM_ID
 
 WHERE  A.CM_DT BETWEEN @DFROMDT AND @DTODT   AND (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE
 AND A.location_Code  =(CASE WHEN @CMAJORDEPTID='' THEN A.location_Code  ELSE @CMAJORDEPTID END)  
 AND ISNULL(A.BIN_ID,'000') =(CASE WHEN (@CBINID = '')  THEN ISNULL(A.BIN_ID,'000') ELSE @CBINID END)    
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)
 AND ((@BDSM=1 AND DSD.CM_ID IS NOT NULL) OR (@BDSM=0))	
 
 IF @NMODE = 1
 BEGIN
  IF OBJECT_ID('TEMPDB..#SP_DSR_DETAILSALE_INV') IS NOT NULL
	DROP TABLE TEMPDB..#SP_DSR_DETAILSALE_INV
	SELECT ROW_NUMBER() OVER (PARTITION BY CM_NO ORDER BY CM_NO) AS SRNO,* 
  INTO #SP_DSR_DETAILSALE_INV FROM @OUTPUTC ORDER BY DEPT_ID, CM_DT, CM_NO 
  
 UPDATE #SP_DSR_DETAILSALE_INV SET SUBTOTAL=0,DISCOUNT_AMOUNT=0,NET_AMOUNT=0,
  ATD_CHARGES=0,CASH_AMOUNT=0,CC_AMOUNT=0,CN_AMOUNT=0,ADVANCE_AMOUNT_ADJUSTED=0,OTHER_DOC_AMOUNT=0,
  CREDIT_AMOUNT=0,BANK_CHARGES=0,MISC_AMOUNT=0,ROUND_OFF=0
  WHERE SRNO>1
  
  SELECT * 
  FROM #SP_DSR_DETAILSALE_INV 
  ORDER BY DEPT_ID, CM_DT, CM_NO
   
 END
 ELSE  
  SELECT DEPT_ID, DEPT_NAME,BIN_ID, BIN_NAME,  CM_DT, SUB_SECTION_NAME,TAX_PERCENTAGE,  
    SUM(QUANTITY) AS QUANTITY, SUM(SLS_AT_MRP) AS SLS_AT_MRP, SUM(SLR_AT_MRP) AS SLR_AT_MRP,   
    SUM(NET_SLS_AT_MRP) AS NET_SLS_AT_MRP, SUM(DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT, SUM(ITEM_DISCOUNT_AMOUNT) AS ITEM_DISCOUNT_AMOUNT,   
    SUM(NET_AMOUNT) AS NET_AMOUNT, SUM(ATD_CHARGES) AS ATD_CHARGES, SUM(CASH_AMOUNT) AS CASH_AMOUNT,   
    SUM(CC_AMOUNT) AS CC_AMOUNT, SUM(CN_AMOUNT) AS CN_AMOUNT, SUM(ADVANCE_AMOUNT_ADJUSTED) AS ADVANCE_AMOUNT_ADJUSTED,  
    SUM(OTHER_DOC_AMOUNT) AS OTHER_DOC_AMOUNT, SUM(CREDIT_AMOUNT) AS CREDIT_AMOUNT,   
    SUM(BANK_CHARGES) AS BANK_CHARGES, SUM(MISC_AMOUNT) AS MISC_AMOUNT  , SUM(ROUND_OFF) AS [ROUND_OFF],
    SUM(TAX_AMOUNT) AS TAX_AMOUNT ,SUM(SUBTOTAL) AS [SUBTOTAL]
  FROM @OUTPUTC  
  GROUP BY DEPT_ID, DEPT_NAME,BIN_ID, BIN_NAME,  CM_DT ,SUB_SECTION_NAME,TAX_PERCENTAGE 
  ORDER BY DEPT_ID, DEPT_NAME,BIN_ID, BIN_NAME,  CM_DT ,SUB_SECTION_NAME,TAX_PERCENTAGE 
END
