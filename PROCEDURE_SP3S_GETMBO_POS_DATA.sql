CREATE PROCEDURE SP3S_GETMBO_POS_DATA
(
@DELEAR_CODE VARCHAR(50)
)
AS
BEGIN
     
 BEGIN TRY
           DECLARE @MBO_ID VARCHAR(5),@MBO_EAN_SERIES VARCHAR(MAX),@CCMD NVARCHAR(MAX),@DATE DATETIME,@STRING VARCHAR(MAX),
           @CLOCID VARCHAR(5),@CURRENTDATE DATETIME,@CERRMSG VARCHAR(MAX),@CSTEP INT
           
           DECLARE @TABLE TABLE(XN_TYPE VARCHAR(50),XN_STATEMENT VARCHAR(MAX),TABLE_NAME VARCHAR(50),MBO_DATA_UPLOAD_DATE DATETIME,DEPT_ID VARCHAR(5))
           
           SET @CURRENTDATE=''
           SET @MBO_ID=''
           SET @CLOCID =''
          
			SET @CSTEP=10
			SELECT @MBO_EAN_SERIES=ISNULL(@MBO_EAN_SERIES + ',',  '') + ''''+VENDOR_EAN_NO+'''' FROM MBO_EAN_SERIES

		
			SELECT @MBO_ID=MBO_ID FROM MBO_DELEAR_MST WHERE DELEAR_CODE=@DELEAR_CODE 
			SELECT @CLOCID=DEPT_ID FROM MBO_DELEAR_MST WHERE DELEAR_CODE=@DELEAR_CODE 
			SELECT @DATE= MBO_DATA_UPLOAD_DATE  FROM MBO_DELEAR_MST WHERE DELEAR_CODE=@DELEAR_CODE 
			SET @CURRENTDATE=CONVERT(VARCHAR(10),GETDATE(),121)
			
			
			
			SET @DATE=DATEADD(DAY,1,@DATE)
			
			--SET @DATE='2018-05-24'
	
			SET @CSTEP=20
			IF @CURRENTDATE=@DATE
			BEGIN
			   SET @CERRMSG='NO DATA FOUND'
			   GOTO END_PROC
			END
			
              
           
        SET @CSTEP=40
        SET @CCMD=N'SELECT DISTINCT ''LATER'' CNC_MEMO_NO, MRR_DT CNC_MEMO_DT, CANCELLED, 2 CNC_TYPE, TOTAL_AMOUNT,'''+@CLOCID+''' DEPT_ID, A.LAST_UPDATE, USER_CODE,
		0 APPROVED,0 SENT_TO_HO, ''LATER'' CNC_MEMO_ID, FIN_YEAR, 0 UPLOADED_TO_ACTIVSTREAM,A.MRR_ID REF_MEMO_ID, ''PUR'' REF_XN_TYPE, 
		'''' FROM_STOCKAUDIT, A.EDT_USER_CODE, CAST('''' AS DATE) CNC_TIME, 0 STOCK_ADJ_NOTE, CAST('''' AS DATE) CNC_DT,0 RFOPT_UPDATED,A.REMARKS, SENT_FOR_RECON,
		A.BIN_ID 
		FROM PIM01106 A(NOLOCK) JOIN PID01106 B(NOLOCK) ON A.MRR_ID=B.MRR_ID
		WHERE LEFT(PRODUCT_CODE,7) IN  ('+@MBO_EAN_SERIES+') AND A.location_code ='''+@MBO_ID+''' 
		AND MRR_DT='''+CONVERT(VARCHAR(10),@DATE,121)+''' OR CONVERT(VARCHAR(10),A.LAST_UPDATE,121)='''+CONVERT(VARCHAR(10),@DATE,121)+''' 


		UNION ALL
		
		SELECT DISTINCT  ''LATER'' CNC_MEMO_NO,RM_DT  CNC_MEMO_DT, CANCELLED,1 CNC_TYPE, A.TOTAL_AMOUNT,'''+@CLOCID+''' DEPT_ID, A.LAST_UPDATE, USER_CODE,
		0 APPROVED, 0 SENT_TO_HO,''LATER'' CNC_MEMO_ID, FIN_YEAR,0 UPLOADED_TO_ACTIVSTREAM,A.RM_ID REF_MEMO_ID,''PRT'' REF_XN_TYPE, 
		0 FROM_STOCKAUDIT, EDT_USER_CODE, CAST('''' AS DATE) CNC_TIME, 0 STOCK_ADJ_NOTE, CAST('''' AS DATE) CNC_DT,0 RFOPT_UPDATED,A.REMARKS,0 SENT_FOR_RECON,
		A.BIN_ID 
		FROM RMM01106 A(NOLOCK) JOIN  RMD01106 B(NOLOCK) ON A.RM_ID=B.RM_ID
		WHERE LEFT(PRODUCT_CODE,7) IN  ('+@MBO_EAN_SERIES+') AND A.location_code ='''+@MBO_ID+'''
		AND RM_DT='''+CONVERT(VARCHAR(10),@DATE,121)+''' OR CONVERT(VARCHAR(10),A.LAST_UPDATE,121)='''+CONVERT(VARCHAR(10),@DATE,121)+''' 

		
		UNION ALL
		
		SELECT DISTINCT 	 ''LATER'' CNC_MEMO_NO,INV_DT  CNC_MEMO_DT, CANCELLED,2 CNC_TYPE, A.NET_AMOUNT,'''+@CLOCID+''' DEPT_ID, A.LAST_UPDATE, USER_CODE,
		0 APPROVED, 0 SENT_TO_HO,''LATER'' CNC_MEMO_ID, FIN_YEAR,0 UPLOADED_TO_ACTIVSTREAM,A.INV_ID REF_MEMO_ID,''WSL'' REF_XN_TYPE, 
		0 FROM_STOCKAUDIT, EDT_USER_CODE, CAST('''' AS DATE) CNC_TIME, 0 STOCK_ADJ_NOTE, CAST('''' AS DATE) CNC_DT,0 RFOPT_UPDATED,A.REMARKS,0 SENT_FOR_RECON,
		A.BIN_ID 
		FROM INM01106 A(NOLOCK) JOIN  IND01106 B(NOLOCK) ON A.INV_ID=B.INV_ID
		WHERE LEFT(PRODUCT_CODE,7) IN  ('+@MBO_EAN_SERIES+') AND A.location_code='''+@MBO_ID+'''
		AND INV_DT='''+CONVERT(VARCHAR(10),@DATE,121)+''' OR CONVERT(VARCHAR(10),A.LAST_UPDATE,121)='''+CONVERT(VARCHAR(10),@DATE,121)+''' 

		
		UNION ALL
		
		SELECT DISTINCT 	 ''LATER'' CNC_MEMO_NO,CN_DT  CNC_MEMO_DT, CANCELLED,1 CNC_TYPE, A.TOTAL_AMOUNT,'''+@CLOCID+''' DEPT_ID, A.LAST_UPDATE, USER_CODE,
		0 APPROVED, 0 SENT_TO_HO,''LATER'' CNC_MEMO_ID, FIN_YEAR,0 UPLOADED_TO_ACTIVSTREAM,A.CN_ID REF_MEMO_ID,''WSR'' REF_XN_TYPE, 
		0 FROM_STOCKAUDIT, EDT_USER_CODE, CAST('''' AS DATE) CNC_TIME, 0 STOCK_ADJ_NOTE, CAST('''' AS DATE) CNC_DT,0 RFOPT_UPDATED,A.REMARKS,0 SENT_FOR_RECON,
		A.BIN_ID 
		FROM CNM01106 A(NOLOCK) JOIN  CND01106 B(NOLOCK) ON A.CN_ID=B.CN_ID
		WHERE LEFT(PRODUCT_CODE,7) IN  ('+@MBO_EAN_SERIES+') AND A.location_code ='''+@MBO_ID+''' 
		AND CN_DT='''+CONVERT(VARCHAR(10),@DATE,121)+''' OR CONVERT(VARCHAR(10),A.LAST_UPDATE,121)='''+CONVERT(VARCHAR(10),@DATE,121)+''''

		
		
		INSERT INTO @TABLE (XN_TYPE,XN_STATEMENT,TABLE_NAME,MBO_DATA_UPLOAD_DATE,DEPT_ID) VALUES
		 ('ICM',@CCMD,'ICM01106',CONVERT(VARCHAR(10),@DATE,121),@CLOCID)

		
		
		SET @CSTEP=50
		SET @CCMD=N'SELECT DISTINCT  A.MRR_ID AS REF_MEMO_ID,	''LATER''  CNC_MEMO_NO, PRODUCT_CODE, 
		QUANTITY, '''+@CLOCID+''' DEPT_ID, ROW_ID, B.LAST_UPDATE,''LATER'' CNC_MEMO_ID,'''' FIN_YEAR,
		0 RATE,0 ADJ_PERCENTAGE, B.BIN_ID 
		FROM PIM01106 A(NOLOCK) JOIN PID01106 B(NOLOCK) ON A.MRR_ID=B.MRR_ID
		WHERE LEFT(PRODUCT_CODE,7) IN  ('+@MBO_EAN_SERIES+') AND A.location_code='''+@MBO_ID+''' 
		AND MRR_DT='''+CONVERT(VARCHAR(10),@DATE,121)+''' OR CONVERT(VARCHAR(10),A.LAST_UPDATE,121)='''+CONVERT(VARCHAR(10),@DATE,121)+''' 
				
		UNION ALL
		
		SELECT DISTINCT A.RM_ID AS REF_MEMO_ID,	''LATER''  CNC_MEMO_NO, PRODUCT_CODE, QUANTITY,
		'''+@CLOCID+''' DEPT_ID, ROW_ID, B.LAST_UPDATE,	''LATER'' CNC_MEMO_ID, '''' FIN_YEAR,
		0 RATE,0 ADJ_PERCENTAGE, B.BIN_ID 
		FROM RMM01106 A(NOLOCK) JOIN  RMD01106 B(NOLOCK) ON A.RM_ID=B.RM_ID
		WHERE LEFT(PRODUCT_CODE,7) IN  ('+@MBO_EAN_SERIES+') AND A.location_code='''+@MBO_ID+'''
		AND RM_DT='''+CONVERT(VARCHAR(10),@DATE,121)+''' OR CONVERT(VARCHAR(10),A.LAST_UPDATE,121)='''+CONVERT(VARCHAR(10),@DATE,121)+''' 

		
		UNION ALL
		
	    SELECT DISTINCT  A.INV_ID AS REF_MEMO_ID,	''LATER''  CNC_MEMO_NO, PRODUCT_CODE, QUANTITY,
	    '''+@CLOCID+''' DEPT_ID, ROW_ID, B.LAST_UPDATE,	''LATER'' CNC_MEMO_ID, '''' FIN_YEAR,
		0 RATE,0 ADJ_PERCENTAGE, B.BIN_ID 
		FROM INM01106 A(NOLOCK) JOIN  IND01106 B(NOLOCK) ON A.INV_ID=B.INV_ID
		WHERE LEFT(PRODUCT_CODE,7) IN  ('+@MBO_EAN_SERIES+') AND A.location_code ='''+@MBO_ID+'''
		AND INV_DT='''+CONVERT(VARCHAR(10),@DATE,121)+''' OR CONVERT(VARCHAR(10),A.LAST_UPDATE,121)='''+CONVERT(VARCHAR(10),@DATE,121)+''' 

		 
		UNION ALL
		
	    SELECT DISTINCT A.CN_ID AS REF_MEMO_ID,	''LATER''  CNC_MEMO_NO, PRODUCT_CODE, QUANTITY,
	    '''+@CLOCID+''' DEPT_ID, ROW_ID, B.LAST_UPDATE,	''LATER'' CNC_MEMO_ID,'''' FIN_YEAR,
		0 RATE,0 ADJ_PERCENTAGE, B.BIN_ID 
		FROM CNM01106 A(NOLOCK) JOIN  CND01106 B(NOLOCK) ON A.CN_ID=B.CN_ID
		WHERE LEFT(PRODUCT_CODE,7) IN  ('+@MBO_EAN_SERIES+') AND A.location_code='''+@MBO_ID+''' 
		AND CN_DT='''+CONVERT(VARCHAR(10),@DATE,121)+''' OR CONVERT(VARCHAR(10),A.LAST_UPDATE,121)='''+CONVERT(VARCHAR(10),@DATE,121)+''''
		 	
         INSERT INTO @TABLE (XN_TYPE,XN_STATEMENT,TABLE_NAME,MBO_DATA_UPLOAD_DATE,DEPT_ID) VALUES
		 ('ICD',@CCMD,'ICD01106',CONVERT(VARCHAR(10),@DATE,121),@CLOCID)
        
        SET @CSTEP=60
        SET @CCMD=N'SELECT DISTINCT  '''+@CLOCID+''' DEPT_ID,''SLS'' AS XN_TYPE,CM_NO AS MEMO_NO,CM_DT MEMO_DT,PRODUCT_CODE,QUANTITY,
				NET,CANCELLED,NET CASH,0 CC_AMOUNT,''''CC_NAME,
				MRP,(B.DISCOUNT_AMOUNT + B.CMM_DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT,A.BIN_ID,'''' ERRORMSG,0 PENDING_QTY,0 PROCESSED,NEWID()ROW_ID
				FROM CMM01106 A(NOLOCK) 
				JOIN CMD01106 B (NOLOCK) ON A.CM_ID=B.CM_ID
				AND LEFT(PRODUCT_CODE,7)  IN ('+@MBO_EAN_SERIES+') AND A.location_code ='''+@MBO_ID+'''
				AND CM_DT='''+CONVERT(VARCHAR(10),@DATE,121)+''' OR CONVERT(VARCHAR(10),A.LAST_UPDATE,121)='''+CONVERT(VARCHAR(10),@DATE,121)+''''
					
         INSERT INTO @TABLE (XN_TYPE,XN_STATEMENT,TABLE_NAME,MBO_DATA_UPLOAD_DATE,DEPT_ID) VALUES
		 ('SLS',@CCMD,'SLS_MBODATA',CONVERT(VARCHAR(10),@DATE,121),@CLOCID)					
        
        
END TRY
BEGIN CATCH
   
       SET @CERRMSG='ERROR IN SP3S_GETMBO_POS_DATA ,STEP:' +LTRIM(STR(@CSTEP)) +',SQL ERROR # : '+LTRIM(STR(ERROR_NUMBER()))+ '' + ERROR_MESSAGE()
       GOTO END_PROC
             
END CATCH 

END_PROC: 

 IF ISNULL(@CERRMSG,'')<>''
  SELECT @CERRMSG AS ERRMSG
 ELSE
  SELECT * FROM @TABLE   					
            
            
END
