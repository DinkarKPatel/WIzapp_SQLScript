create PROCEDURE SAVETRAN_ART_PARA1_BUYER_ORDER_DET  
(  
 @cSPID VARCHAR(50),  
 @CMACHINENAME  VARCHAR(100)='',  
 @CWINDOWUSERNAME VARCHAR(100)='',  
 @CWIZAPPUSERCODE VARCHAR(10)='0000000'  
)  
AS  
BEGIN  
  
  
 DECLARE @cArticleCode VARCHAR(20),@cPara1Code VARCHAR(20),@cPara1CodeNew VARCHAR(20),  
 @cErrMsg VARCHAR(MAX)  
  
 --SELECT @cArticleCode ='',@cPara1Code ='',@cPara1CodeNew =''  

 IF EXISTS(SELECT TOP 1 A.PRODUCT_CODE
  FROM SKU A
  JOIN ART_ART_PARA1_BUYER_ORDER_DET_UPLOAD B ON B.ARTICLE_CODE=A.article_code AND B.PARA1_CODE_NEW=A.para1_code
  WHERE  B.SP_ID=@cSPID AND ISNULL(B.PARA1_CODE_NEW,'')<>''  
  AND A.barcode_coding_scheme=1)
  BEGIN 
	SET @cErrMsg=N'Barcode Already Exists with given color. Select other color...'
	GOTO ENDPROC
  END

 BEGIN TRAN  
 BEGIN TRY  

 CREATE TABLE #BUYER_ORDER_DET_PRODUCT_CODE(PRODUCT_CODE VARCHAR(100),PARA1_CODE VARCHAR(100), PARA1_NAME VARCHAR(100))

	

	INSERT INTO #BUYER_ORDER_DET_PRODUCT_CODE(PRODUCT_CODE,PARA1_CODE)
	SELECT A.PRODUCT_CODE,B.PARA1_CODE_NEW 
	FROM BUYER_ORDER_DET A  
	JOIN ART_ART_PARA1_BUYER_ORDER_DET_UPLOAD B ON B.ARTICLE_CODE=A.article_code AND B.replaceable_para1_code=A.replaceable_para1_code
	WHERE B.SP_ID=@cSPID AND ISNULL(B.PARA1_CODE_NEW,'')<>'' 
	
	INSERT INTO #BUYER_ORDER_DET_PRODUCT_CODE(PRODUCT_CODE,PARA1_CODE)
	SELECT A.PRODUCT_CODE,B.PARA1_CODE_NEW 
	FROM SKU A  
	JOIN ART_ART_PARA1_BUYER_ORDER_DET_UPLOAD B ON B.ARTICLE_CODE=A.article_code AND B.para1_code=A.para1_code
	LEFT OUTER JOIN #BUYER_ORDER_DET_PRODUCT_CODE C ON C.PRODUCT_CODE=A.product_code
	WHERE B.SP_ID=@cSPID AND C.PRODUCT_CODE IS NULL AND ISNULL(B.PARA1_CODE_NEW,'')<>''  
  
	UPDATE A SET A.PARA1_NAME=B.PARA1_NAME
	FROM #BUYER_ORDER_DET_PRODUCT_CODE A
	JOIN PARA1 B ON B.para1_code=A.PARA1_CODE

	 ;with Upd_SalesOrder as
	  (
	  select A.ARTICLE_CODE,A.PARA1_CODE, B.PARA1_CODE_NEW 
	  FROM BUYER_ORDER_DET A (nolock)    
	  JOIN ART_ART_PARA1_BUYER_ORDER_DET_UPLOAD B ON B.ARTICLE_CODE=A.article_code AND B.replaceable_para1_code=A.replaceable_para1_code  
	  WHERE B.SP_ID=@cSPID AND ISNULL(B.PARA1_CODE_NEW,'')<>''
	  group by A.ARTICLE_CODE,A.PARA1_CODE, B.PARA1_CODE_NEW 
	  )

	  Update a set Para1Code =b.PARA1_CODE_NEW
	  from SalesOrderProcessing a (nolock)
	  join Upd_SalesOrder b on a.ArticleCode =b.article_code and a.Para1Code =b.para1_code 

	
	 UPDATE A SET PARA1_CODE=B.PARA1_CODE_NEW  
	 FROM BUYER_ORDER_DET A  
	 JOIN ART_ART_PARA1_BUYER_ORDER_DET_UPLOAD B ON B.ARTICLE_CODE=A.article_code AND B.replaceable_para1_code=A.replaceable_para1_code
	 WHERE B.SP_ID=@cSPID AND ISNULL(B.PARA1_CODE_NEW,'')<>'' 
  

  
  UPDATE A SET A.para1_code=B.PARA1_CODE
  FROM pod01106 A
  JOIN #BUYER_ORDER_DET_PRODUCT_CODE B ON B.PRODUCT_CODE=A.product_code

  --SELECT TOP 1 PRODUCT_CODE
  --FROM SKU A
  --JOIN ART_ART_PARA1_BUYER_ORDER_DET_UPLOAD B ON B.ARTICLE_CODE=A.article_code AND B.PARA1_CODE_NEW=A.para1_code
  --WHERE  B.SP_ID=@cSPID AND ISNULL(B.PARA1_CODE_NEW,'')<>''  
  --AND A.barcode_coding_scheme=1

  UPDATE A SET A.para1_code=B.PARA1_CODE
  FROM SKU A
  JOIN #BUYER_ORDER_DET_PRODUCT_CODE B ON B.PRODUCT_CODE=A.product_code
  
  UPDATE A SET A.para1_name=B.PARA1_NAME
  FROM SKU_NAMES A
  JOIN #BUYER_ORDER_DET_PRODUCT_CODE B ON B.PRODUCT_CODE=A.product_code


  DELETE A FROM art_para1 A  
  JOIN ART_ART_PARA1_BUYER_ORDER_DET_UPLOAD B ON B.ARTICLE_CODE=A.article_code AND B.replaceable_para1_code=A.replaceable_para1_code  
  WHERE B.SP_ID=@cSPID  AND ISNULL(B.PARA1_CODE_NEW,'')<>''  
  
  INSERT art_para1 ( article_code, last_modified_on, last_update, para1_code, para1_desc, row_id,replaceable_para1_code )    
  SELECT    a.article_code, GETDATE() last_modified_on, GETDATE() last_update, A.PARA1_CODE_NEW para1_code, '' para1_desc, NEWID() row_id   ,A.replaceable_para1_code
  FROM ART_ART_PARA1_BUYER_ORDER_DET_UPLOAD A  
  LEFT OUTER JOIN ART_PARA1  B ON B.ARTICLE_CODE=A.article_code AND B.replaceable_para1_code=A.replaceable_para1_code  
  WHERE A.SP_ID=@cSPID  AND ISNULL(A.PARA1_CODE_NEW,'')<>'' AND B.article_code IS NULL  
  
  INSERT ART_PARA1_AUDIT ( ARTICLE_CODE, AUDITDATETIME, AUDITID, COMPUTERNAME, LOGVISIT, PARA1_CODE, PARA1_CODE_NEW, ROW_ID, WINUSERNAME, WIZUSERCODE,replaceable_para1_code )    
  SELECT    A.ARTICLE_CODE, GETDATE() AUDITDATETIME,NEWID() AUDITID, @CMACHINENAME COMPUTERNAME, 0 LOGVISIT, A.PARA1_CODE, A.PARA1_CODE_NEW, A.ROW_ID,   
  @CWINDOWUSERNAME WINUSERNAME, @CWIZAPPUSERCODE WIZUSERCODE   ,replaceable_para1_code
  FROM ART_ART_PARA1_BUYER_ORDER_DET_UPLOAD A  
  WHERE A.SP_ID=@cSPID  
  
 END TRY  
 BEGIN CATCH  
  SET @cErrMsg=ERROR_MESSAGE()  
 END CATCH  
  
 IF ISNULL(@cErrMsg,'')<>''  
  ROLLBACK TRAN  
 ELSE  
  COMMIT TRAN  
ENDPROC: 
 DELETE FROM ART_ART_PARA1_BUYER_ORDER_DET_UPLOAD WHERE  SP_ID=@cSPID

 SELECT ISNULL(@cErrMsg,'') AS ERRMSG  
END