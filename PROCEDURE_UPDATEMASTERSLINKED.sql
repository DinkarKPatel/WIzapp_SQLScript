CREATE PROCEDURE UPDATEMASTERSLINKED 
(
	@CTARGETDB VARCHAR(100),
	@CSOURCEDB VARCHAR(100)='',
	@NMASTERSTYPE NUMERIC(1,0)=1, --1.CHALLAN MASTERS 2.LOCATION MASTERS 3.ARTICLE MASTERS 4.USER & AUTHORIZATION
	@NSPID NUMERIC(5,0)=0
)
--WITH ENCRYPTION
AS 
BEGIN
	SET NOCOUNT ON

	IF @NMASTERSTYPE NOT IN (2,4)
		GOTO END_PROC

	-- CREATING TEMPORARY TABLE TO STORE A LIST OF MASTERS AND THE KEY FIELDS 
	DECLARE @TBTABLELIST TABLE ( CTARGETTABLENAME VARCHAR(40), CKEYFIELD1 VARCHAR(40),
							     CKEYFIELD2 VARCHAR(40), CKEYFIELD3 VARCHAR(40),CSOURCETABLENAME VARCHAR(40))
	DECLARE @CCMD NVARCHAR(4000)

	IF @CSOURCEDB = ''
	BEGIN
		SET @CSOURCEDB = @CTARGETDB
	END
	

	IF @NMASTERSTYPE = 2
	BEGIN
		INSERT @TBTABLELIST VALUES ( 'REGIONM', 'REGION_CODE', '', '', '' )
		INSERT @TBTABLELIST VALUES ( 'STATE', 'STATE_CODE', '', '', '' )
		INSERT @TBTABLELIST VALUES ( 'CITY', 'CITY_CODE', '', '', '' )
		INSERT @TBTABLELIST VALUES ( 'AREA', 'AREA_CODE', '', '', '' )
		INSERT @TBTABLELIST VALUES ( 'LOCATION', 'DEPT_ID', '', '' , '')
	END
	
	IF @NMASTERSTYPE = 4
	BEGIN
		INSERT @TBTABLELIST VALUES ( 'USERS', 'USER_CODE', '', '','' )
		INSERT @TBTABLELIST VALUES ( 'LOCUSERS', 'USER_CODE', 'DEPT_ID', '','' )
		INSERT @TBTABLELIST VALUES ( 'MODULES', 'ROW_ID', '', '', '' )
	END
	
PRINT 'U4'
	DECLARE @CSOURCETABLENAME VARCHAR(50),
			@CTARGETTABLENAME VARCHAR(50), 
			@CKEYFIELD1 VARCHAR(50), 
			@CKEYFIELD2 VARCHAR(50), 
			@CKEYFIELD3 VARCHAR(50)

		DECLARE TBL CURSOR FOR 
		SELECT CSOURCETABLENAME,CTARGETTABLENAME, CKEYFIELD1, CKEYFIELD2, CKEYFIELD3 FROM @TBTABLELIST

		OPEN TBL
		FETCH NEXT FROM TBL INTO @CSOURCETABLENAME,@CTARGETTABLENAME, @CKEYFIELD1, @CKEYFIELD2, @CKEYFIELD3
		WHILE @@FETCH_STATUS = 0
		BEGIN
				
PRINT 'U5'+@CSOURCETABLENAME
			IF @CSOURCETABLENAME=''
				SET @CSOURCETABLENAME=@CTARGETTABLENAME

			IF @NSPID<>0
				SET @CSOURCETABLENAME = 'TEMP_' + @CSOURCETABLENAME+'_'+LTRIM(RTRIM(STR(@NSPID)))


PRINT 'U6'+@CSOURCETABLENAME			
			SET @CCMD = N'IF  EXISTS (SELECT NAME FROM '+@CSOURCEDB+'SYSOBJECTS WHERE NAME='''+@CSOURCETABLENAME+''')
				AND EXISTS (SELECT NAME FROM '+@CTARGETDB+'SYSOBJECTS WHERE NAME='''+@CTARGETTABLENAME+''')
				EXEC UPDATEMASTERXN '''+@CSOURCEDB+''','''+@CSOURCETABLENAME+''','''+@CTARGETDB+''','''+@CTARGETTABLENAME+''',
									'''+@CKEYFIELD1+''','''+@CKEYFIELD2+''','''+@CKEYFIELD3+''''

			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
			FETCH NEXT FROM TBL INTO @CSOURCETABLENAME,@CTARGETTABLENAME, @CKEYFIELD1, @CKEYFIELD2, @CKEYFIELD3
		END
		CLOSE TBL
		DEALLOCATE TBL
PRINT 'U8'

END_PROC:

END
--************************************************ END OF PROCEDURE UPDATEMASTERSLINKED
