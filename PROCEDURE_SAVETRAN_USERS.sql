create PROC SAVETRAN_USERS
(
	@NUPDATEMODE NUMERIC(1,0),  --@NUPDATEMODE 1 FOR ADD,2 FOR EDIT 
	@NSPID	VARCHAR(50),                
	@CMEMOPREFIX CHAR(5)=  '',
	@CFINYEAR	CHAR(5)='', 
	@CMACHINENAME	VARCHAR(20)	= '', 
    @CWINDOWUSERNAME VARCHAR(20)	= '', 
    @CWIZAPPUSERCODE	VARCHAR(20) = '', 
	@CUSERS_CODE VARCHAR(7)=''   --@USERS CODE REQUIRED FOR EDIT MODE
)
--WITH ENCRYPTION
AS
BEGIN
--changes by Dinkar in location id varchar(4)..
  DECLARE @CMASTERTABLENAME VARCHAR(100),
          @CTEMPMASTERTABLE VARCHAR(100),
          @CTEMPMASTERTABLENAME VARCHAR(100),
          @CDETAILTABLENAME VARCHAR(100),
          @CTEMPDETAILTABLE VARCHAR(100),
          @CTEMPDETAILTABLENAME VARCHAR(100),



		  @CDETAILTABLENAME1 VARCHAR(100),
          @CTEMPDETAILTABLE1 VARCHAR(100),
          @CTEMPDETAILTABLENAME1 VARCHAR(100),

		  @CDETAILTABLENAME2 VARCHAR(100),
          @CTEMPDETAILTABLE2 VARCHAR(100),
          @CTEMPDETAILTABLENAME2 VARCHAR(100),

		   @CDETAILTABLENAME3 VARCHAR(100),
          @CTEMPDETAILTABLE3 VARCHAR(100),
          @CTEMPDETAILTABLENAME3 VARCHAR(100),


		  @CTEMPDBNAME VARCHAR(100),		
		  @NSTEP VARCHAR(10),
		  @BENABLETEMPDB BIT,
		  @CERRORMSG VARCHAR(500),
		  @CKEYFIELD VARCHAR(22),	
		  @NCKEYFIELDLEN INT,		
		  @NSAVETRANLOOP	BIT,
		  @CCMD NVARCHAR(MAX),
		  @CMEMODEPTID VARCHAR(4),
		  @CNEW_USERS_CODE VARCHAR(7)
		  
		  DECLARE @OUTPUT TABLE(ERRMSG VARCHAR(2000),CAT_ID VARCHAR(22))
          SET @NSTEP = 0		-- SETTTING UP ENVIRONMENT		
		
		 SET @CTEMPDBNAME = ''	
					  
	      SET @CMASTERTABLENAME ='USERS'		
		
		 SET @CTEMPMASTERTABLE  ='MSTUSRROLE_USERS_UPLOAD'
		 SET @CTEMPMASTERTABLENAME = @CTEMPDBNAME + @CTEMPMASTERTABLE
		 
		 SET @CDETAILTABLENAME ='LOCUSERS'	
		 SET @CTEMPDETAILTABLE  ='MSTUSRROLE_locusers_UPLOAD'
		 SET @CTEMPDETAILTABLENAME = @CTEMPDBNAME + @CTEMPDETAILTABLE


		 SET @CDETAILTABLENAME1 ='WIZMD_USER_AUTH'	
		 SET @CTEMPDETAILTABLE1  ='MSTUSRROLE_WIZMD_USER_AUTH_upload'	
		 SET @CTEMPDETAILTABLENAME1 = @CTEMPDBNAME + @CTEMPDETAILTABLE1

		 SET @CDETAILTABLENAME2 ='USER_XNS_FILTER'	
		 SET @CTEMPDETAILTABLE2  ='MSTUSRROLE_USER_XNS_FILTER_UPLOAD'	
		 SET @CTEMPDETAILTABLENAME2 = @CTEMPDBNAME + @CTEMPDETAILTABLE2


		 SET @CDETAILTABLENAME3 ='LocRepUser'	
		 SET @CTEMPDETAILTABLE3  ='MSTUSRROLE_LocRepUser_UPLOAD'	
		 SET @CTEMPDETAILTABLENAME3 = @CTEMPDBNAME + @CTEMPDETAILTABLE3



		
		 SET @CKEYFIELD = 'USER_CODE'
         SET @NCKEYFIELDLEN	= 7
         SET @NSTEP = 10		-- BEGIN TRANSACTION    
         BEGIN TRY
	     BEGIN TRANSACTION
	     
	    SET @NSTEP = 30		--CALL FROM ADD MODE
		IF @NUPDATEMODE = 1
		BEGIN
					SET @NSAVETRANLOOP=0
					WHILE @NSAVETRANLOOP=0
					BEGIN
						--EXEC GETNEXTKEY @CMASTERTABLENAME, @CKEYFIELD, @NCKEYFIELDLEN, '01', 1,@CFINYEAR='',@NROWCOUNT=0, @CNEW_USERS_CODE OUTPUT   
						EXEC GETNEXTKEY @CMASTERTABLENAME, @CKEYFIELD, @NCKEYFIELDLEN, '', 1,@CFINYEAR,0,@CNEW_USERS_CODE OUTPUT   
						SET @CCMD= N'IF EXISTS(SELECT '+@CKEYFIELD+' FROM '+@CMASTERTABLENAME+' WHERE '+@CKEYFIELD+' = '''+@CNEW_USERS_CODE+''')
										SET @NLOOPOUTPUT=0
									 ELSE
										SET @NLOOPOUTPUT=1'
						PRINT @CCMD
						EXEC SP_EXECUTESQL @CCMD,N'@NLOOPOUTPUT BIT OUTPUT',@NLOOPOUTPUT=@NSAVETRANLOOP OUTPUT
					END
					SET @NSTEP = 40	
					--SET @CNEW_USERS_CODE = @CLOCID + @CFINYEAR+ REPLICATE('0', 15-LEN(LTRIM(RTRIM(@CNEW_CALL_CODE1)))) + LTRIM(RTRIM(@CNEW_CALL_CODE1))			
					IF @CNEW_USERS_CODE IS NULL  
					BEGIN
						  SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR CREATING NEXT USER CODE....'
						  GOTO END_PROC  		
					END
					
					SET @NSTEP = 60	-- UPDATING NEW ID INTO TEMP TABLES
					SET @CCMD=N'UPDATE '+@CTEMPMASTERTABLENAME+' SET '+@CKEYFIELD+'='''+@CNEW_USERS_CODE+''',LAST_UPDATE=GETDATE(),MAJOR_USER_CODE='''+@CNEW_USERS_CODE+''' WHERE SP_ID='''+@NSPID+''''
					PRINT @CCMD 
					EXEC SP_EXECUTESQL @CCMD 
					
					SET @NSTEP = 70	-- UPDATING NEW ID INTO TEMP TABLES
					SET @CCMD=N'UPDATE '+@CTEMPDETAILTABLENAME+' SET '+@CKEYFIELD+'='''+@CNEW_USERS_CODE+''',LAST_UPDATE=GETDATE() WHERE SP_ID='''+@NSPID+''''
					PRINT @CCMD 
					EXEC SP_EXECUTESQL @CCMD 

					SET @NSTEP = 71	-- UPDATING NEW ID INTO TEMP TABLES
					SET @CCMD=N'UPDATE '+@CTEMPDETAILTABLENAME1+' SET '+@CKEYFIELD+'='''+@CNEW_USERS_CODE+''',LAST_UPDATE=GETDATE() WHERE SP_ID='''+@NSPID+''''
					PRINT @CCMD 
					EXEC SP_EXECUTESQL @CCMD 
					
					SET @CCMD=N'UPDATE '+@CTEMPDETAILTABLENAME2+' SET '+@CKEYFIELD+'='''+@CNEW_USERS_CODE+''',LAST_UPDATE=GETDATE() WHERE SP_ID='''+@NSPID+''''
					PRINT @CCMD 
					EXEC SP_EXECUTESQL @CCMD 

					SET @CCMD=N'UPDATE '+@CTEMPDETAILTABLENAME3+' SET '+@CKEYFIELD+'='''+@CNEW_USERS_CODE+''',LAST_UPDATE=GETDATE() WHERE SP_ID='''+@NSPID+''''
					PRINT @CCMD 
					EXEC SP_EXECUTESQL @CCMD 

					
					
		END--END FROM ADD MODE
	    
	    ELSE
		BEGIN--CALL FROM EDIT AND CANCELLED MODE
				  SET @NSTEP = 80		-- GETTING MEMO ID FROM TEMP TABLE
				   SET @CCMD=N'SELECT @CNEW_USERS_CODE='+@CKEYFIELD+' FROM ' +@CMASTERTABLENAME+ ' WHERE USER_CODE= '''+@CUSERS_CODE+'''' 
				   PRINT @CCMD
				   EXEC SP_EXECUTESQL @CCMD,N'@CNEW_USERS_CODE VARCHAR(7) OUTPUT',@CNEW_USERS_CODE OUTPUT
				   
				   SET @NSTEP = 90
				   IF @CNEW_USERS_CODE IS NULL  
				   BEGIN
				   
							  SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR PLEASE ENTER USERS CODE FOR UPDATING....'	
							  GOTO END_PROC  		
				   
				   END
				   
				   IF @NUPDATEMODE = 2
				   BEGIN
				   SET @CCMD = N'UPDATE ' + @CTEMPMASTERTABLENAME + ' SET LAST_UPDATE=GETDATE()  WHERE ' + @CKEYFIELD + ' = ''' + @CNEW_USERS_CODE + ''' AND SP_ID='''+@NSPID+''''
				   EXEC SP_EXECUTESQL @CCMD
				   
				   SET @CCMD = N'UPDATE ' + @CTEMPDETAILTABLENAME + ' SET LAST_UPDATE=GETDATE()  WHERE ' + @CKEYFIELD + ' = ''' + @CNEW_USERS_CODE + '''AND SP_ID='''+@NSPID+''''
				   EXEC SP_EXECUTESQL @CCMD
				  
				   SET @CCMD = N'UPDATE ' + @CTEMPDETAILTABLENAME1 + ' SET LAST_UPDATE=GETDATE()  WHERE ' + @CKEYFIELD + ' = ''' + @CNEW_USERS_CODE + '''AND SP_ID='''+@NSPID+''''
				   EXEC SP_EXECUTESQL @CCMD

				    SET @CCMD = N'UPDATE ' + @CTEMPDETAILTABLENAME3 + ' SET LAST_UPDATE=GETDATE()  WHERE ' + @CKEYFIELD + ' = ''' + @CNEW_USERS_CODE + '''AND SP_ID='''+@NSPID+''''
				   EXEC SP_EXECUTESQL @CCMD

				   END
				    
		END
		
		SET @NSTEP = 140
	    IF LTRIM(RTRIM(ISNULL(@CNEW_USERS_CODE,'LATER'))) = 'LATER'
		BEGIN
			SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR CREATING NEXT USERS_CODE....'
			GOTO END_PROC
		END
		
		SET @NSTEP = 160 

		DECLARE @CWHERECLAUSE VARCHAR(1000)
        SET @CWHERECLAUSE = ' SP_ID='''+LTRIM(RTRIM((@NSPID)))+''''
	    -- UPDATING MASTER TABLE FROM TEMP TABLE
		IF @NUPDATEMODE = 1 OR @NUPDATEMODE = 2
		BEGIN
		
				EXEC UPDATEMASTERXN 
					  @CSOURCEDB	= @CTEMPDBNAME
					, @CSOURCETABLE = @CTEMPMASTERTABLE
					, @CDESTDB		= ''
					, @CDESTTABLE	= @CMASTERTABLENAME
					, @CKEYFIELD1	= @CKEYFIELD
					, @BALWAYSUPDATE = 1
					,@CFILTERCONDITION=@CWHERECLAUSE
					
		           SET @CCMD = N'DELETE  A
		                         FROM LOCUSERS  A WHERE USER_CODE='''+@CNEW_USERS_CODE+''''
		           PRINT @CCMD
				   EXEC SP_EXECUTESQL @CCMD
				   
					
					EXEC UPDATEMASTERXN 
					  @CSOURCEDB	= @CTEMPDBNAME
					, @CSOURCETABLE = @CTEMPDETAILTABLE
					, @CDESTDB		= ''
					, @CDESTTABLE	= @CDETAILTABLENAME
					, @CKEYFIELD1	= @CKEYFIELD
					, @CKEYFIELD2	= 'DEPT_ID'
					, @BALWAYSUPDATE = 1
					,@CFILTERCONDITION=@CWHERECLAUSE



					   SET @CCMD = N'DELETE  A
		                         FROM LocRepUser A WHERE USER_CODE='''+@CNEW_USERS_CODE+''''
		           PRINT @CCMD
				   EXEC SP_EXECUTESQL @CCMD
				   
					
					EXEC UPDATEMASTERXN 
					  @CSOURCEDB	= @CTEMPDBNAME
					, @CSOURCETABLE = @CTEMPDETAILTABLE3
					, @CDESTDB		= ''
					, @CDESTTABLE	= @CDETAILTABLENAME3
					, @CKEYFIELD1	= @CKEYFIELD
					, @CKEYFIELD2	= 'DEPT_ID'
					, @BALWAYSUPDATE = 1
					,@CFILTERCONDITION=@CWHERECLAUSE



				   SET @CCMD = N'DELETE  A
		                         FROM WIZMD_USER_AUTH  A WHERE USER_CODE='''+@CNEW_USERS_CODE+''''
		           PRINT @CCMD

				   EXEC SP_EXECUTESQL @CCMD
					  EXEC UPDATEMASTERXN 
					  @CSOURCEDB	= @CTEMPDBNAME
					, @CSOURCETABLE = @CTEMPDETAILTABLE1
					, @CDESTDB		= ''
					, @CDESTTABLE	= @CDETAILTABLENAME1
					, @CKEYFIELD1	= @CKEYFIELD					
					, @BALWAYSUPDATE = 1
					,@CFILTERCONDITION=@CWHERECLAUSE


					 SET @CCMD = N'DELETE  A
		                         FROM USER_XNS_FILTER  A WHERE USER_CODE='''+@CNEW_USERS_CODE+''''
		           PRINT @CCMD
				   EXEC SP_EXECUTESQL @CCMD
				   
					
					EXEC UPDATEMASTERXN 
					  @CSOURCEDB	= @CTEMPDBNAME
					, @CSOURCETABLE = @CTEMPDETAILTABLE2
					, @CDESTDB		= ''
					, @CDESTTABLE	= @CDETAILTABLENAME2
					, @CKEYFIELD1	= @CKEYFIELD
					, @CKEYFIELD2	= 'XNS_USER_CODE'
					, @BALWAYSUPDATE = 1
					,@CFILTERCONDITION=@CWHERECLAUSE


		
	    END
	     END TRY
         BEGIN CATCH
				SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
				GOTO END_PROC
        END CATCH
END_PROC:
		IF @@TRANCOUNT>0
		BEGIN
			IF ISNULL(@CERRORMSG,'')=''
				commit TRANSACTION
			ELSE
				ROLLBACK 	
		END 



		  SET @CCMD = N'DELETE  FROM MSTUSRROLE_users_UPLOAD   WHERE SP_ID='''+@NSPID+''''
		  PRINT @CCMD
		  EXEC SP_EXECUTESQL @CCMD

		  SET @CCMD = N'DELETE  FROM MSTUSRROLE_LOCUSERS_UPLOAD   WHERE SP_ID='''+@NSPID+''''
		  PRINT @CCMD
		  EXEC SP_EXECUTESQL @CCMD


		    SET @CCMD = N'DELETE  FROM MSTUSRROLE_LocRepUser_UPLOAD   WHERE SP_ID='''+@NSPID+''''
		  PRINT @CCMD
		  EXEC SP_EXECUTESQL @CCMD

		  SET @CCMD = N'DELETE  FROM MSTUSRROLE_WIZMD_USER_AUTH_upload   WHERE SP_ID='''+@NSPID+''''
		  PRINT @CCMD
		  EXEC SP_EXECUTESQL @CCMD

		  DELETE FROM MSTUSRROLE_USER_XNS_FILTER_UPLOAD WHERE SP_ID=@NSPID
		
		  		   		     
		SELECT ISNULL(@CERRORMSG,'') AS ERRMSG,@CNEW_USERS_CODE AS USERS_CODE
END
----'END OF  PROCEDURE SAVETRAN_USERS'



