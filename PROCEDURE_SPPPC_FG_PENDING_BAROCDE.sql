create PROCEDURE SPPPC_FG_PENDING_BAROCDE
(  
 @NQUERYID INT=0,  
 @CAC_CODE VARCHAR(10)='',  
 @CBILL_NO VARCHAR(MAX)='',  
 @CARTICLE_CODE VARCHAR(10)='',  
 @CPARA1_CODE VARCHAR(100)='',  
 @CSIZEGROUP_CODE VARCHAR(100)='',  
 @CMEMO_ID VARCHAR(50)='',  
 @NBARCODEPRINT int =0,  
 @NRETURN INT=0,  
 @CPRODUCT_CODE VARCHAR(100)='',  
 @BO_DET_ROW_ID VARCHAR(100)='' ,
 @CJOB_CODE VARCHAR(10)='',
 @CFIN_YEAR VARCHAR(5)='' 
)  
AS  
BEGIN  
  
    DECLARE @DTSQL NVARCHAR(MAX),@CFILTER VARCHAR(MAX)
    IF ISNULL(@CBILL_NO,'')<>'' AND @NQUERYID not in(3,9)
    SET @CBILL_NO=' AND det.BILL_NO  '+@CBILL_NO
    
    IF @NQUERYID IN(4,5,10)  
    BEGIN  
          
     IF @NRETURN=0  
     BEGIN  
     IF OBJECT_ID('TEMPDB..#TMPPRODUCT','U') IS NOT NULL  
     DROP TABLE #TMPPRODUCT 
      
       SELECT A.AC_CODE,LM.AC_NAME,DET.BILL_NO,  
		B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,  
		SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,  
		SKU.PARA1_CODE,P1.PARA1_NAME,  
		SKU.PARA2_CODE,P2.PARA2_NAME,  
		SKU.PARA3_CODE,P3.PARA3_NAME ,  
		SKU.PRODUCT_CODE,  
		CAST('' AS VARCHAR(10)) AS JOB_CODE,  
		CAST('' AS VARCHAR(100)) AS  JOB_NAME,  
		1 AS JOB_ORDER,  
		CAST(1 AS INT) AS QUANTITY_IN_STOCK,  
		CAST(1 AS INT)  AS ISSUE_QTY,  
		b.BO_DET_ROW_ID ,
		CAST('' AS VARCHAR(10)) AS  AGENCY_CODE ,
		CONVERT(VARCHAR,A.MEMO_DT,105) AS MEMO_DT,
		CONVERT(VARCHAR,det.DELIVERY_DT,105) AS DELIVERY_DT
		INTO #TMPPRODUCT  
	   FROM PPC_FGBCG_MST A  
	   JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID   
	   JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID   
	   join  
	   (  
		 SELECT  b.ac_code,a.article_code ,  
		 ROW_ID,B.BILL_NO ,a.DELIVERY_DT 
		 FROM PPC_BUYER_ORDER_DET A  
		 JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID  
		 WHERE B.CANCELLED=0  
		 group by b.ac_code,a.article_code ,ROW_ID,B.BILL_NO,a.DELIVERY_DT   
	   ) det on det.row_id=B.BO_DET_ROW_ID   
	   JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_CODE   
	   JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE   
	   JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE   
	   JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE   
	   JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE   
	   JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE   
	   WHERE 1=2 
	   
            
	 SET @DTSQL=N'SELECT A.AC_CODE,LM.AC_NAME,DET.BILL_NO,  
		B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,  
		SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,  
		SKU.PARA1_CODE,P1.PARA1_NAME,  
		SKU.PARA2_CODE,P2.PARA2_NAME,  
		SKU.PARA3_CODE,P3.PARA3_NAME ,  
		SKU.PRODUCT_CODE,  
		J.JOB_CODE,  
		J.JOB_NAME,  
		1 AS JOB_ORDER,  
		CAST(1 AS INT) AS QUANTITY_IN_STOCK,  
		ISNULL(ISSUE_QTY,0) AS ISSUE_QTY,  
		b.BO_DET_ROW_ID  ,
		ISNULL(PR.AC_CODE,'''') AS AGENCY_CODE,
		REPLACE(CONVERT(VARCHAR(11),PR.MEMO_DT,106),'' '',''-'')  AS MEMO_DT,
		REPLACE(CONVERT(VARCHAR(11),det.DELIVERY_DT,106),'' '',''-'')  AS DELIVERY_DT
	   FROM PPC_FGBCG_MST A  
	   JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID   
	   JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID   
	   join  
	   (  
		 SELECT  b.ac_code,a.article_code ,  
		ROW_ID,B.BILL_NO ,a.DELIVERY_DT 
		FROM PPC_BUYER_ORDER_DET A  
		JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID  
		WHERE B.CANCELLED=0  
		 group by b.ac_code,a.article_code ,ROW_ID,B.BILL_NO,a.DELIVERY_DT  
	   ) det on det.row_id=B.BO_DET_ROW_ID   
	   JOIN ARTICLE ART ON ART.ARTICLE_CODE =B.ARTICLE_CODE   
	   JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE   
	   JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE   
	   JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE   
	   JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE   
	   JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE   
	   JOIN  
	   (  
		SELECT A.REF_ROW_ID, A.JOB_CODE,B.JOB_NAME   
		FROM PPC_BO_ART_JOBS A  
		JOIN JOBS B ON A.JOB_CODE=B.JOB_CODE  
		WHERE JOB_ORDER=1  
		GROUP BY A.REF_ROW_ID, A.JOB_CODE,B.JOB_NAME  
	   ) J ON J.REF_ROW_ID=B.BO_DET_ROW_ID  
	   LEFT OUTER JOIN  
	   (  
		SELECT B.MEMO_DT, b.ac_code, PRODUCT_CODE,A.QUANTITY AS ISSUE_QTY  
		FROM PPC_AGENCY_ISSUE_FG_FIRST_DET  A  
		JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID   
		WHERE B.CANCELLED=0 and ISNULL(MEMO_TYPE,0)=1  
	   ) PR ON PR.PRODUCT_CODE =SKU .PRODUCT_CODE  
	   WHERE a.cancelled=0 '+@CBILL_NO
	   
	   PRINT @DTSQL
	   INSERT INTO #TMPPRODUCT
	   EXEC SP_EXECUTESQL @DTSQL 
  END             
  END  
         
  
 IF @NQUERYID=1  
    GOTO LBLAGENCY  
 ELSE IF @NQUERYID=2  
    GOTO LBLBILL_NO  
 ELSE IF @NQUERYID=3  
    GOTO LBLMST  
 ELSE IF @NQUERYID=4  
    GOTO LBLDET  
 ELSE IF @NQUERYID=5  
    GOTO LBLPARA2DET   
 ELSE IF @NQUERYID=6  
    GOTO LBLBARCODEPRINT     
 ELSE IF @NQUERYID=7  
    GOTO LBLBARCODEPRINT_CROSSTAB    
 ELSE IF @NQUERYID=8  
    GOTO LBLBUYER   
 ELSE IF @NQUERYID=9  
    GOTO LBLJOB   
 ELSE IF @NQUERYID=10  
    GOTO LBLAGENCYSUMMARY     
 ELSE  
 GOTO END_PROC  
      
    LBLAGENCY:    
  
      SELECT B.AC_CODE,B.AGENCY_NAME AS AC_NAME  
      FROM AGENCY_JOBS A 
      JOIN PRD_AGENCY_MST B ON A.AGENCY_CODE=B.AGENCY_CODE
      WHERE A.JOB_CODE=@CJOB_CODE
      
      
    GOTO END_PROC  
      
    LBLBILL_NO:  
         
       SELECT BILL_NO AS ORDER_NO   
       FROM PPC_BUYER_ORDER_MST A  
       WHERE CANCELLED=0  
       AND (@CAC_CODE='' OR A.AC_CODE=@CAC_CODE)  
       GROUP BY BILL_NO  
         
    GOTO END_PROC  
      
      
    LBLMST:  
       
       IF OBJECT_ID('TEMPDB..#TMPMST','U') IS NOT NULL
          DROP TABLE #TMPMST
        
       SELECT CASE WHEN a.MEMO_TYPE=1 THEN 'REGULAR' ELSE 'RETURN' END AS MEMO_TYPE,  
              JOBS.JOB_NAME, A.JOB_CODE,A.APPROVED,A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,A.LAST_UPDATE,  
              A.AC_CODE,LM.AC_NAME, 
              BILL_NO= (STUFF(( SELECT DISTINCT ', '+BILL_NO FROM PPC_BUYER_ORDER_MST MST 
                  JOIN PPC_BUYER_ORDER_DET DET ON MST.ORDER_ID=DET.ORDER_ID
                  JOIN PPC_FGBCG_DET C ON C.BO_DET_ROW_ID=DET.ROW_ID
                  JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID =C.ROW_ID 
                  JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET BD ON BD.PRODUCT_CODE=SKU.PRODUCT_CODE 
                  WHERE BD.MEMO_ID =A.MEMO_ID  FOR XML PATH('')),1,1,'')),
              A.FIN_YEAR,
              A.CANCELLED,LM1.AC_NAME AS BUYER_NAME,LM1.AC_CODE AS BUYER_CODE ,
              ISNULL(TC.TERM_NAME,'') AS TERM_NAME ,
              B.ARTICLE_NO,
              B.ARTICLE_CODE,
              B.QUANTITY,
             CONVERT(VARCHAR,isnull(a.DELIVERY_DT,''),105) as DELIVERY_DT,
             CASE WHEN  B.QUANTITY= ISNULL(PRINY_QTY,0) THEN 1 ELSE 0 END AS PR_STATUS
             
       INTO #TMPMST
       FROM  PPC_AGENCY_ISSUE_FG_FIRST_MST A  
       join 
       (
        SELECT  A.MEMO_ID ,ART.ARTICLE_NO,ART.ARTICLE_CODE,
        D.AC_CODE,SUM(A.QUANTITY) AS QUANTITY ,
        SUM(ISNULL(PRINY_QTY,0)) AS PRINY_QTY
        FROM PPC_AGENCY_ISSUE_FG_FIRST_DET A
        JOIN PPC_FG_SKU SKU ON SKU.PRODUCT_CODE =A.PRODUCT_CODE 
        JOIN PPC_FGBCG_DET C ON C.ROW_ID=SKU.PPC_FGBCG_DET_ROW_ID
        JOIN PPC_FGBCG_MST D ON C.MEMO_ID =D.MEMO_ID 
        JOIN ARTICLE ART ON ART.ARTICLE_CODE=SKU.ARTICLE_CODE
        left join
        (
        SELECT  PRODUCT_CODE,A.QUANTITY AS PRINY_QTY
		FROM PPC_FG_BARCODE_PRINT_DET  A
		JOIN PPC_FG_BARCODE_PRINT_MST B ON A.MEMO_ID =B.MEMO_ID 
		WHERE B.CANCELLED=0
        )pr on pr.PRODUCT_CODE =a.PRODUCT_CODE 
        GROUP BY  A.MEMO_ID,ART.ARTICLE_NO, ART.ARTICLE_CODE,
        D.AC_CODE 
       ) B ON A.MEMO_ID =B.MEMO_ID
       JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE  
       JOIN LM01106 LM1 ON LM1.AC_CODE=B.AC_CODE  
       JOIN JOBS ON JOBS.JOB_CODE =A.JOB_CODE  
       LEFT OUTER JOIN PPC_TERM_CONDITION_MST TC ON TC.MEMO_ID=A.TERMS_MEMO_ID
       WHERE (@CMEMO_ID='' OR A.MEMO_ID=@CMEMO_ID)
       AND (@CAC_CODE='' OR A.AC_CODE=@CAC_CODE)
       AND (@CFIN_YEAR='' OR A.FIN_YEAR=@CFIN_YEAR)
       AND (@CJOB_CODE='' OR JOBS.job_code =@CJOB_CODE)
       
       
      
     SET @DTSQL=N'SELECT * FROM #TMPMST A
       WHERE ('''+@CBILL_NO+'''='''' OR A.BILL_NO LIKE ''%'+@CBILL_NO+'%'')
     ORDER BY a.MEMO_DT desc, A.MEMO_ID desc '
     PRINT @DTSQL
EXEC SP_EXECUTESQL @DTSQL
         
    GOTO END_PROC 
 
    LBLDET:  
         
         
 IF @NRETURN=0  
    BEGIN  
 
        SELECT CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,  
        ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),  
        A.AC_CODE,  
        A.AC_NAME,  
        A.BILL_NO,  
        A.ARTICLE_CODE,  
        A.ARTICLE_NO,  
		A.PARA1_CODE,  
		A.PARA1_NAME,  
		A.SIZEGROUP_CODE,  
		A.SIZEGROUP_NAME,  
		A.PARA3_CODE,  
		A.PARA3_NAME,  
		A.JOB_NAME,  
		A.JOB_ORDER,  
		a.BO_DET_ROW_ID,  
		SUM(QUANTITY_IN_STOCK) AS AVAILABLE_QTY,  
		SUM(ISSUE_QTY) AS ISSUED,  
		PENDING=CAST(SUM(QUANTITY_IN_STOCK)-SUM(ISSUE_QTY) AS NUMERIC(10,0)),  
		SELECT_QTY=CAST(0 AS NUMERIC(10,0))  ,
		A.DELIVERY_DT
		FROM #TMPPRODUCT A   
		GROUP BY  A.JOB_NAME,  
		A.JOB_ORDER,A.AC_CODE,A.AC_NAME,A.BILL_NO,  
		A.PARA1_CODE,A.PARA1_NAME,A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,  
		A.PARA3_CODE,A.PARA3_NAME, A.ARTICLE_CODE,  
        A.ARTICLE_NO,a.BO_DET_ROW_ID ,A.DELIVERY_DT 
   END  
   ELSE  
   BEGIN  
        
      --SELECT   
         
         
        
       --A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,  
       --A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,  
       --a.PARA1_CODE,a.PARA1_NAME AS COLOR,  
       --A.PARA3_CODE,a.PARA3_NAME BUYER_STYLE_NO,  
       --a.PARA2_CODE,a.PARA2_NAME SIZE,  
       --a.JOB_CODE,  
       --a.JOB_NAME,  
       --a.PRODUCT_CODE,  
       --a.ISSUE_QTY AS QUANTITY  
                 
  SELECT  CAST(1 AS BIT) AS CHK,  
          CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,  
          ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),  
          A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,  
    A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,  
    a.PARA1_CODE,a.PARA1_NAME AS COLOR,  
    A.PARA3_CODE,a.PARA3_NAME BUYER_STYLE_NO,  
    a.PARA2_CODE,a.PARA2_NAME SIZE,  
    A.PRODUCT_CODE,  
    ISNULL(ISSUE_QTY,0)-ISNULL(RE_ISS_QTY,0) AS QUANTITY  
  FROM  
  (  
   SELECT C.JOB_CODE ,  
          A.AC_CODE ,LM.AC_NAME ,  
          C.BILL_NO,  
          SKU.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,  
       SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,  
       P1.PARA1_CODE,P1.PARA1_NAME ,  
       P3.PARA3_CODE,P3.PARA3_NAME ,  
       P2.PARA2_CODE,P2.PARA2_NAME ,   
       SKU.PRODUCT_CODE ,SUM(C.ISSUE_QTY) AS ISSUE_QTY  
   FROM PPC_FGBCG_MST A  
   JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID   
   JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID   
   JOIN  
   (  
    SELECT B.BILL_NO, B.JOB_CODE, PRODUCT_CODE,  
        SUM(A.QUANTITY)   AS ISSUE_QTY  
    FROM PPC_AGENCY_REC_FG_DET  A  
    JOIN PPC_AGENCY_REC_FG_MST  B ON A.MEMO_ID =B.MEMO_ID   
    WHERE B.CANCELLED=0 AND ISNULL(MEMO_TYPE,0)=2  
    AND B.AC_CODE=@CAC_CODE  
    AND (@CBILL_NO='' OR B.BILL_NO=@CBILL_NO)  
    GROUP BY  B.BILL_NO,B.JOB_CODE, PRODUCT_CODE  
   ) C ON SKU.PRODUCT_CODE=C.PRODUCT_CODE  
   JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE   
   JOIN ARTICLE ART on ART.ARTICLE_CODE=SKU.ARTICLE_CODE  
   JOIN PARA1 P1 ON P1.para1_code =SKU.PARA1_CODE   
   JOIN PARA2 P2 ON P2.para2_code =SKU.para2_code   
   JOIN PARA3 P3 ON P3.para3_code =SKU.para3_code   
   JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE   
   JOIN PPC_BO_ART_JOBS JOBS ON JOBS .REF_ROW_ID=B.BO_DET_ROW_ID  AND JOBS.JOB_CODE =C.JOB_CODE  
   WHERE JOB_ORDER BETWEEN 1 AND 2 AND A.CANCELLED =0  
   GROUP BY C.JOB_CODE ,A.AC_CODE ,LM.AC_NAME ,  
          C.BILL_NO,SKU.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,  
       SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,  
       P1.PARA1_CODE,P1.PARA1_NAME ,  
       P3.PARA3_CODE,P3.PARA3_NAME ,  
       P2.PARA2_CODE,P2.PARA2_NAME ,   
       SKU.PRODUCT_CODE   
  ) A  
  LEFT JOIN  
  (  
    SELECT PRODUCT_CODE,B.JOB_CODE,  
     SUM(QUANTITY ) AS RE_ISS_QTY  
    FROM PPC_AGENCY_ISSUE_FG_FIRST_DET A  
    JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID   
    WHERE B.CANCELLED =0 AND ISNULL(MEMO_TYPE,0)=2  
    AND B.AC_CODE=@CAC_CODE  
    AND (@CBILL_NO='' OR B.BILL_NO=@CBILL_NO)  
    GROUP BY PRODUCT_CODE,B.JOB_CODE  
  ) B ON A.PRODUCT_CODE=B.PRODUCT_CODE AND A.JOB_CODE=B.JOB_CODE  
  JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=A.PRODUCT_CODE  
  WHERE A.PRODUCT_CODE=@CPRODUCT_CODE AND PMT.QUANTITY_IN_STOCK >0  
  AND ISNULL(ISSUE_QTY,0)-ISNULL(RE_ISS_QTY,0)>0  
     
     
   END   
    GOTO END_PROC  
     
   LBLPARA2DET:  
          
          
       -- SELECT * FROM #TMPPRODUCT  
        
        SELECT SP.SR_NO,CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,  
        ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),  
        A.PARA2_CODE,PARA2_NAME,  
        a.BO_DET_ROW_ID,  
        CAST(SUM(QUANTITY_IN_STOCK) AS NUMERIC(10,0)) AS ALLOTED_QTY,  
        CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0)) AS ISSUED_QTY,  
        CAST(SUM(QUANTITY_IN_STOCK)-SUM(ISNULL(ISSUE_QTY,0))AS NUMERIC(10,0)) AS BAL_QTY,  
        CAST(0 AS NUMERIC(10,0)) AS SELECT_QUANTITY  
        FROM #TMPPRODUCT A  
        LEFT JOIN PPC_SIZEGROUP_PARA2 SP ON A.SIZEGROUP_CODE=SP.SIZEGROUP_CODE AND A.PARA2_CODE=SP.PARA2_CODE  
        WHERE   
       -- ISNULL(ISSUE_QTY,0)=0 AND  
         (@CARTICLE_CODE ='' OR ARTICLE_CODE=@CARTICLE_CODE)  
        AND (@CPARA1_CODE ='' OR PARA1_CODE=@CPARA1_CODE)  
        AND (@CSIZEGROUP_CODE ='' OR A.SIZEGROUP_CODE=@CSIZEGROUP_CODE)  
        AND(@BO_DET_ROW_ID='' OR a.BO_DET_ROW_ID=@BO_DET_ROW_ID)  
        group by SP.SR_NO,A.PARA2_CODE,PARA2_NAME,a.BO_DET_ROW_ID  
        ORDER BY a.BO_DET_ROW_ID,SP.SR_NO  
  
     
   GOTO END_PROC  
     
     
   LBLBARCODEPRINT:  
          
        IF OBJECT_ID('TEMPDB..#TMPBARCODEPRINT','') IS NOT NULL  
           DROP TABLE #TMPBARCODEPRINT   
             
        SELECT CAST(1 AS BIT) AS CHK, PR.MEMO_ID,PR.MEMO_NO,PR.MEMO_DT,  
               A.AC_CODE,LM.AC_NAME ,  
               det.BILL_NO,  
               det.ARTICLE_CODE,ART.ARTICLE_NO,ART.ARTICLE_NAME,  
               B.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,  
               B.PARA1_CODE,P1.PARA1_NAME AS COLOR,  
               B.PARA3_CODE,P3.PARA3_NAME BUYER_STYLE_NO,  
               SKU.PARA2_CODE,P2.PARA2_NAME SIZE,  
               PR.JOB_CODE,  
               PR.JOB_NAME,  
               PR.PRODUCT_CODE,  
               PR.QUANTITY  
            INTO #TMPBARCODEPRINT  
      FROM PPC_FGBCG_MST A  
   JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID   
   JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID   
   join  
   (  
     SELECT  b.ac_code,a.article_code ,  
    ROW_ID,B.BILL_NO FROM PPC_BUYER_ORDER_DET A  
    JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID  
    WHERE B.CANCELLED=0  
     group by b.ac_code,a.article_code ,ROW_ID,B.BILL_NO  
   ) det on det.row_id=B.BO_DET_ROW_ID   
   JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE   
   JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE   
   JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE   
   JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE   
   JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE   
   JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE   
   JOIN  
   (  
    SELECT JOBS.JOB_CODE,JOBS.JOB_NAME,  
    b.MEMO_ID,B.MEMO_NO,B.MEMO_DT, PRODUCT_CODE,QUANTITY AS QUANTITY  
    FROM PPC_AGENCY_ISSUE_FG_FIRST_DET  A  
    JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID   
    JOIN JOBS  ON B.JOB_CODE=JOBS.JOB_CODE  
    WHERE B.CANCELLED=0  
    AND A.MEMO_ID=@CMEMO_ID  
   ) PR ON PR.PRODUCT_CODE =SKU.PRODUCT_CODE   
   
  
     
    --  WHERE C.PARA2_CODE<>'0000000  '  
   IF @NBARCODEPRINT=0  
   BEGIN  
         
         
       SELECT A.* FROM #TMPBARCODEPRINT A  
       ORDER BY ARTICLE_NO,A.SIZEGROUP_NAME ,  
             A.COLOR,A.SIZE ,A.PRODUCT_CODE  
     
   END  
   ELSE  
   BEGIN   
      SELECT  CHK, A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,  
               A.AC_CODE,A.AC_NAME ,  
             A.BILL_NO,  
               A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,  
               A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,  
               A.PARA1_CODE,A.COLOR,  
               A.PARA3_CODE,A.BUYER_STYLE_NO,  
               A.PARA2_CODE,  
               A.SIZE,  
               A.JOB_CODE,  
               A.JOB_NAME,  
               A.PRODUCT_CODE,  
               A.QUANTITY   
             FROM #TMPBARCODEPRINT A  
             WHERE a.PARA2_CODE<>'0000000  '  
        union all  
              SELECT  CHK, A.MEMO_ID,A.MEMO_NO,A.MEMO_DT,  
               A.AC_CODE,A.AC_NAME ,  
               A.BILL_NO,  
               A.ARTICLE_CODE,A.ARTICLE_NO,A.ARTICLE_NAME,  
               A.SIZEGROUP_CODE,A.SIZEGROUP_NAME ,  
               A.PARA1_CODE,A.COLOR,  
               A.PARA3_CODE,A.BUYER_STYLE_NO,  
               P2.PARA2_CODE,  
               P2.PARA2_NAME AS SIZE,  
               A.JOB_CODE,  
               A.JOB_NAME,  
               A.PRODUCT_CODE,  
               A.QUANTITY   
             FROM #TMPBARCODEPRINT A  
             join PPC_FG_BARCODE_NA_DET b ON A.PRODUCT_CODE=B.PRODUCT_CODE  
       JOIN PPC_FG_BARCODE_NA_MST c ON c.MEMO_ID=B.MEMO_ID   
       JOIN PARA2 P2 ON P2.PARA2_CODE=b.PARA2_CODE   
       WHERE a.PARA2_CODE='0000000  ' AND C.CANCELLED=0  
     
     
     
   END  
    
          
          
          
    GOTO END_PROC  
      
    LBLBARCODEPRINT_CROSSTAB:  
          
  
        IF OBJECT_ID ('TEMPDB..#TMPALLOTEDPRINT','P') IS NOT NULL  
           DROP TABLE #TMPALLOTEDPRINT  
             
   
            
   SELECT PR.MEMO_ID,PR.ROW_ID,A.AC_CODE,LM.AC_NAME,DET.BILL_NO,  
    B.ARTICLE_CODE,ART.ARTICLE_NO ,ART.ARTICLE_NAME ,  
    SKU.SIZEGROUP_CODE,SG.SIZEGROUP_NAME ,  
    SKU.PARA1_CODE,P1.PARA1_NAME,  
    SKU.PARA2_CODE,P2.PARA2_NAME,  
    SKU.PARA3_CODE,P3.PARA3_NAME ,  
    SKU.PRODUCT_CODE,  
    J.JOB_CODE,  
    J.JOB_NAME,  
    1 AS JOB_ORDER,  
    CAST(1 AS INT) AS QUANTITY_IN_STOCK,  
    ISNULL(PR.ISSUE_QTY,0) AS ISSUE_QTY,  
    ISNULL(PR1.ISSUE_QTY,0) AS ISSUED,  
     SELECT_QTY=CAST(0 AS NUMERIC(10,0)),
     B.BO_DET_ROW_ID  ,
     DET.DELIVERY_DT
    INTO #TMPALLOTEDPRINT  
   FROM PPC_FGBCG_MST A  
   JOIN PPC_FGBCG_DET B ON A.MEMO_ID =B.MEMO_ID   
   JOIN PPC_FG_SKU SKU ON SKU.PPC_FGBCG_DET_ROW_ID=B.ROW_ID   
   join  
   (  
     SELECT  b.ac_code,a.article_code ,  
    ROW_ID,B.BILL_NO ,a.DELIVERY_DT 
    FROM PPC_BUYER_ORDER_DET A  
    JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID  
    WHERE B.CANCELLED=0  
     group by b.ac_code,a.article_code ,ROW_ID,B.BILL_NO,a.DELIVERY_DT   
   ) det on det.row_id=B.BO_DET_ROW_ID   
   JOIN ARTICLE ART ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE   
   JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.PARA1_CODE   
   JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.PARA2_CODE   
   JOIN PARA3 P3 ON P3.PARA3_CODE =SKU.PARA3_CODE   
   JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE =SKU.SIZEGROUP_CODE   
   JOIN LM01106 LM ON LM.AC_CODE =A.AC_CODE   
   JOIN  
   (  
    SELECT A.REF_ROW_ID, A.JOB_CODE,B.JOB_NAME FROM PPC_BO_ART_JOBS A  
    JOIN JOBS B ON A.JOB_CODE=B.JOB_CODE  
    WHERE JOB_ORDER=1  
    GROUP BY A.REF_ROW_ID, A.JOB_CODE,B.JOB_NAME  
   ) J ON J.REF_ROW_ID=B.BO_DET_ROW_ID  
   JOIN  
   ( 
     SELECT c.BO_DET_ROW_ID
      FROM PPC_AGENCY_ISSUE_FG_FIRST_DET A
      JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID  
      JOIN PPC_FG_SKU SKU ON SKU.PRODUCT_CODE =A.PRODUCT_CODE 
      JOIN PPC_FGBCG_DET C ON C.ROW_ID=SKU.PPC_FGBCG_DET_ROW_ID
      JOIN PPC_FGBCG_MST D ON C.MEMO_ID =D.MEMO_ID 
      where b.CANCELLED =0
      AND A.MEMO_ID=@CMEMO_ID  
      group by c.BO_DET_ROW_ID
         
    --SELECT PRODUCT_CODE,CAST(1 AS INT) AS ISSUE_QTY  
    --FROM PPC_AGENCY_ISSUE_FG_FIRST_DET  A  
    --JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID   
    --WHERE B.CANCELLED=0  
 --AND A.MEMO_ID=@CMEMO_ID  
   ) TPR ON TPR.BO_DET_ROW_ID =b.BO_DET_ROW_ID
   LEFT  JOIN  
   (  
    SELECT A.MEMO_ID,A.ROW_ID, PRODUCT_CODE,CAST(1 AS INT) AS ISSUE_QTY  
    FROM PPC_AGENCY_ISSUE_FG_FIRST_DET  A  
    JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID   
    WHERE B.CANCELLED=0  
    AND A.MEMO_ID=@CMEMO_ID  
   ) PR ON PR.PRODUCT_CODE =SKU.PRODUCT_CODE  
   LEFT  JOIN  
   (  
    SELECT A.MEMO_ID,A.ROW_ID, PRODUCT_CODE,CAST(1 AS INT) AS ISSUE_QTY  
    FROM PPC_AGENCY_ISSUE_FG_FIRST_DET  A  
    JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B ON A.MEMO_ID =B.MEMO_ID   
    WHERE B.CANCELLED=0  
    AND A.MEMO_ID<@CMEMO_ID  
   ) PR1 ON PR1.PRODUCT_CODE =SKU.PRODUCT_CODE  
   WHERE 
   (@CARTICLE_CODE='' OR B.ARTICLE_CODE=@CARTICLE_CODE) AND 
   --det.bill_no=@CBILL_NO and  
    a.cancelled=0  
     
     --CAST(SUM(QUANTITY_IN_STOCK) AS NUMERIC(10,0)) AS ALLOTED_QTY,  
     --   CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0)) AS ISSUED_QTY,  
     --   CAST(SUM(QUANTITY_IN_STOCK)-SUM(ISNULL(ISSUE_QTY,0))AS NUMERIC(10,0)) AS BAL_QTY,  
     --   CAST(0 AS NUMERIC(10,0)) AS SELECT_QUANTITY  
     
   SELECT   
    A.AC_CODE,  
    A.AC_NAME,  
    A.BILL_NO,  
    A.ARTICLE_CODE,  
    A.ARTICLE_NO,  
    A.PARA1_CODE,  
    A.PARA1_NAME,  
    A.SIZEGROUP_CODE,  
    A.SIZEGROUP_NAME,  
    A.PARA3_CODE,  
    A.PARA3_NAME,  
    A.JOB_CODE,  
    A.JOB_NAME,  
    JOB_ORDER,  
    A.BO_DET_ROW_ID,
    CAST(SUM(QUANTITY_IN_STOCK) AS NUMERIC(10,0)) AS ALLOTED_QTY,  
    CAST(SUM(ISNULL(ISSUED,0)) AS NUMERIC(10,0)) AS ISSUED_QTY,  
    CAST(SUM(QUANTITY_IN_STOCK)-SUM(ISNULL(ISSUED,0))AS NUMERIC(10,0)) AS BAL_QTY,  
    CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0))  AS SELECT_QUANTITY  ,
    IMAGE_1=CAST('' AS VARCHAR(100)),a.DELIVERY_DT
    FROM #TMPALLOTEDPRINT A   
    WHERE (@CARTICLE_CODE='' OR A.ARTICLE_CODE=@CARTICLE_CODE)  
    GROUP BY A.AC_CODE,A.AC_NAME,A.BILL_NO,  
    A.PARA1_CODE,A.PARA1_NAME,A.SIZEGROUP_CODE,A.SIZEGROUP_NAME,  
    A.PARA3_CODE,A.PARA3_NAME, A.ARTICLE_CODE,  
    A.ARTICLE_NO,A.JOB_CODE,  
    A.JOB_NAME,JOB_ORDER,A.BO_DET_ROW_ID  ,a.DELIVERY_DT
    HAVING CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0))>0  
      
      
  SELECT CAST('LATER' AS VARCHAR(50)) AS MEMO_ID,  
        ROW_ID=CAST('LATER' AS VARCHAR(40))+CAST(NEWID() AS VARCHAR(100)),  
        A.AC_CODE,A.AC_NAME,A.BILL_NO,A.ARTICLE_CODE,  
  A.ARTICLE_NO,A.PARA1_CODE,  
  A.PARA1_NAME,A.SIZEGROUP_CODE,  
  A.SIZEGROUP_NAME,A.PARA3_CODE,A.PARA3_NAME,  
  a.PARA2_CODE,PARA2_NAME, 
  A.BO_DET_ROW_ID  ,
  CAST(SUM(QUANTITY_IN_STOCK) AS NUMERIC(10,0)) AS ALLOTED_QTY,  
  CAST(SUM(ISNULL(ISSUED,0)) AS NUMERIC(10,0)) AS ISSUED_QTY,  
  CAST(SUM(QUANTITY_IN_STOCK)-SUM(ISNULL(ISSUED,0))AS NUMERIC(10,0)) AS BAL_QTY,  
  CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0))  AS SELECT_QUANTITY  ,
  sp.SR_NO
  FROM #TMPALLOTEDPRINT A  
  join PPC_SIZEGROUP_PARA2 sp on a.sizegroup_code=sp.sizegroup_code and a.PARA2_CODE =sp.PARA2_CODE
  WHERE (@CARTICLE_CODE ='' OR ARTICLE_CODE=@CARTICLE_CODE)  
  AND (@CPARA1_CODE ='' OR PARA1_CODE=@CPARA1_CODE)  
  AND (@CSIZEGROUP_CODE ='' OR a.SIZEGROUP_CODE=@CSIZEGROUP_CODE)  
  group by a.PARA2_CODE,PARA2_NAME,A.AC_CODE,A.AC_NAME,A.BILL_NO,A.ARTICLE_CODE,  
  A.ARTICLE_NO,A.PARA1_CODE,  
  A.PARA1_NAME,A.SIZEGROUP_CODE,  
  A.SIZEGROUP_NAME,A.PARA3_CODE,A.PARA3_NAME,A.BO_DET_ROW_ID  ,sp.SR_NO
  HAVING  CAST(SUM(ISNULL(ISSUE_QTY,0)) AS NUMERIC(10,0))>0  
  order by A.BO_DET_ROW_ID,SR_NO
        
   
      
     GOTO END_PROC  
       
     LBLBUYER:  
          
        SELECT A.AC_CODE,B.AC_NAME   
        FROM PPC_BUYER_ORDER_MST  A  
        JOIN LM01106 B ON A.AC_CODE=B.AC_CODE  
        WHERE CANCELLED =0  
        GROUP BY A.AC_CODE,B.AC_NAME  
       
     GOTO END_PROC  
       
     LBLJOB:  
        
      SELECT DISTINCT C.JOB_CODE,C.JOB_ORDER,JOBS.JOB_NAME   
      FROM PPC_BUYER_ORDER_MST A  
      JOIN PPC_BUYER_ORDER_DET B ON A.ORDER_ID=B.ORDER_ID  
      JOIN PPC_BO_ART_JOBS C ON B.ROW_ID=C.REF_ROW_ID   
      JOIN JOBS ON C.JOB_CODE=JOBS.JOB_CODE  
      WHERE CANCELLED=0 AND C.JOB_ORDER=1  
      and (@CAC_CODE='' or a.ac_code=@CAC_CODE)
      and (@CBILL_NO='' or a.bill_no=@CBILL_NO)
      --AND (@CBILL_NO='' OR A.BILL_NO=@CBILL_NO)  
       
     GOTO END_PROC  
     
     LBLAGENCYSUMMARY:
           --DROP TABLE tmpprd
        --   select * into tmpprd from #TMPPRODUCT
 
     
     DECLARE @CCOLNAME VARCHAR(MAX),@CTCOLNAME VARCHAR(MAX)
     SELECT @CCOLNAME=ISNULL(@CCOLNAME,'')+','+QUOTENAME( PARA2_NAME)
     FROM #TMPPRODUCT A
     JOIN PPC_SIZEGROUP_PARA2 B ON A.SIZEGROUP_CODE =B.SIZEGROUP_CODE AND A.PARA2_CODE =B.PARA2_CODE 
     where a.BO_DET_ROW_ID =@BO_DET_ROW_ID
     GROUP BY B.SR_NO,A.PARA2_NAME
     ORDER BY B.SR_NO,A.PARA2_NAME
     
     SET @CCOLNAME=SUBSTRING(@CCOLNAME,2,LEN(@CCOLNAME))
     
     SELECT @CTCOLNAME=ISNULL(@CTCOLNAME,'')+'+ isnull('+QUOTENAME( PARA2_NAME)+',0)' 
     FROM #TMPPRODUCT A
     where a.BO_DET_ROW_ID =@BO_DET_ROW_ID 
     GROUP BY PARA2_NAME
     SET @CTCOLNAME=SUBSTRING(@CTCOLNAME,2,LEN(@CTCOLNAME))+' as TOTAL'
    
 
     IF OBJECT_ID('TEMPDB..#TMPAGENCY','U') IS NOT NULL
        DROP TABLE #TMPAGENCY
        
     SELECT B.AC_NAME AS AGENCY_NAME,
            A.BO_DET_ROW_ID ,A.para2_name ,
            A.MEMO_DT ,
            SUM(ISSUE_QTY) AS ISSUE_QTY 
     INTO #TMPAGENCY
     FROM #TMPPRODUCT A
     JOIN LM01106 B ON A.AGENCY_CODE =B.AC_CODE
     where a.BO_DET_ROW_ID =@BO_DET_ROW_ID  
     GROUP BY B.AC_NAME ,
            A.BO_DET_ROW_ID ,A.para2_name,A.MEMO_DT
     
     
     SET @DTSQL=N' SELECT AGENCY_NAME as [AGENCY NAME],MEMO_DT AS MEMODT ,'+@CCOLNAME+' , '+@CTCOLNAME+'
    FROM #TMPAGENCY A
    PIVOT (SUM(ISSUE_QTY) FOR PARA2_NAME IN('+@CCOLNAME+')) AS P1
    '    
    PRINT @DTSQL  
    EXEC SP_EXECUTESQL @DTSQL
    
           
   GOTO END_PROC 
     
      
 END_PROC:  
  
  
END    

