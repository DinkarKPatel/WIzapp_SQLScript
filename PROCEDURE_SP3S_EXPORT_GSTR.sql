create PROCEDURE SP3S_EXPORT_GSTR--(LocId 3 digit change by Sanjay:05-11-2024)
(
  @DFMDATE DATETIME='',
  @DTODATE DATETIME='',
  @CGSTN_NO VARCHAR(100)='',
  @CLOC_TYPE INT=0,--0 FOR ALL 1 FOR ONLY COMPANY OWNED,
  @CDEPT_ID VARCHAR(4)='',
  @BCALLEDFORGSTR9 BIT=0
  
)
AS
BEGIN
    
	
	
     DECLARE @TBLEXP TABLE (MEMO_ID VARCHAR(100),SR INT,RTYPE VARCHAR(10),XN_TYPE VARCHAR(100),GSTIN_UIN_RECIPIENT VARCHAR(100),INVOICE_NO VARCHAR(50),INVOICE_DT VARCHAR(25),
                            INVOICE_VALUE NUMERIC(12,2),PLACE_OF_SUPPLY VARCHAR(100),REVERSE_CHARGE CHAR(1),INVOICE_TYPE VARCHAR(20),
                            E_COMMERCE_GSTIN VARCHAR(100),RATE NUMERIC(8,2),TAXABLE_VALUE NUMERIC(12,2),CESS_AMOUNT NUMERIC(8,2),RECEIVER_NAME VARCHAR(200),
							CGST_AMOUNT NUMERIC(12,2),SGST_AMOUNT NUMERIC(12,2),IGST_AMOUNT NUMERIC(12,2))
                            
  
      --WSL INVOICE
      
    
      --**** STATR B2B----(WSL INVOICE)
     INSERT INTO @TBLEXP(MEMO_ID,SR ,RTYPE,XN_TYPE ,GSTIN_UIN_RECIPIENT ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                  REVERSE_CHARGE,INVOICE_TYPE , E_COMMERCE_GSTIN ,RATE ,TAXABLE_VALUE ,CESS_AMOUNT,RECEIVER_NAME,
				  CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT)
     SELECT A.INV_ID,SR=CAST(2 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            CAST(CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS VARCHAR(100)) AS XN_TYPE,
            CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END  AS GSTIN_UIN_RECIPIENT,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            C.GST_STATE_CODE+'-'+C.GST_STATE_NAME  AS PLACE_OF_SUPPLY,--(CONFUSION)
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('REGULAR' AS VARCHAR(10)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            A.OTHER_CHARGES_GST_PERCENTAGE AS RATE,
            A.OTHER_CHARGES_TAXABLE_VALUE  AS TAXABLE_VALUE,
            0 AS CESS_AMOUNT ,
            CAST(CASE WHEN A.INV_MODE =1 THEN LM.AC_NAME  ELSE TL.DEPT_NAME  END AS VARCHAR(200)) AS RECEIVER_NAME  ,
			A.OTHER_CHARGES_CGST_AMOUNT,A.OTHER_CHARGES_SGST_AMOUNT,A.OTHER_CHARGES_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_code
      LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      LEFT JOIN GST_STATE_MST C (NOLOCK)  ON A.PARTY_STATE_CODE  =C.GST_STATE_CODE
      LEFT JOIN GST_STATE_MST TS (NOLOCK)  ON TL.GST_STATE_CODE  =TS.GST_STATE_CODE
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND ISNULL(A.OTHER_CHARGES,0)<>0
      AND (@CDEPT_ID='' OR a.location_Code=@CDEPT_ID)
      AND A.SUPPLY_TYPE_CODE  IN('EXPWP','EXPWOP')
      UNION ALL
      SELECT A.INV_ID,SR=CAST(2 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
       CAST(CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS VARCHAR(100)) AS XN_TYPE,
            CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END  AS GSTIN_UIN_RECIPIENT,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            C.GST_STATE_CODE+'-'+C.GST_STATE_NAME  AS PLACE_OF_SUPPLY,--(CONFUSION)
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('REGULAR' AS VARCHAR(10)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            A.FREIGHT_GST_PERCENTAGE AS RATE,
            A.FREIGHT_TAXABLE_VALUE  AS TAXABLE_VALUE,
            0 AS CESS_AMOUNT,
            CAST(CASE WHEN A.INV_MODE =1 THEN LM.AC_NAME  ELSE TL.DEPT_NAME  END AS VARCHAR(200)) AS RECEIVER_NAME   ,
			A.FREIGHT_CGST_AMOUNT,A.FREIGHT_SGST_AMOUNT,A.FREIGHT_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_code
      LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      LEFT JOIN GST_STATE_MST C (NOLOCK)  ON A.PARTY_STATE_CODE  =C.GST_STATE_CODE
      LEFT JOIN GST_STATE_MST TS (NOLOCK)  ON TL.GST_STATE_CODE  =TS.GST_STATE_CODE
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND ISNULL(A.FREIGHT,0)<>0
      AND (@CDEPT_ID='' OR a.location_Code=@CDEPT_ID)
      AND A.SUPPLY_TYPE_CODE  IN('EXPWP','EXPWOP')
      UNION ALL
      
       SELECT A.INV_ID,SR=CAST(2 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            CAST(CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS VARCHAR(100)) AS XN_TYPE,
            CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END  AS GSTIN_UIN_RECIPIENT,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            C.GST_STATE_CODE+'-'+C.GST_STATE_NAME  AS PLACE_OF_SUPPLY,--(CONFUSION)
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('REGULAR' AS VARCHAR(10)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            A.INSURANCE_GST_PERCENTAGE AS RATE,
            A.INSURANCE_TAXABLE_VALUE  AS TAXABLE_VALUE,
            0 AS CESS_AMOUNT ,
            CAST(CASE WHEN A.INV_MODE =1 THEN LM.AC_NAME  ELSE TL.DEPT_NAME  END AS VARCHAR(200)) AS RECEIVER_NAME  ,
			A.INSURANCE_CGST_AMOUNT,A.INSURANCE_SGST_AMOUNT,A.INSURANCE_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_code
      LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      LEFT JOIN GST_STATE_MST C (NOLOCK)  ON A.PARTY_STATE_CODE  =C.GST_STATE_CODE
      LEFT JOIN GST_STATE_MST TS (NOLOCK)  ON TL.GST_STATE_CODE  =TS.GST_STATE_CODE
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND ISNULL(A.INSURANCE,0)<>0
      AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID)
      AND A.SUPPLY_TYPE_CODE  IN('EXPWP','EXPWOP')
      UNION ALL
      
        SELECT A.INV_ID,SR=CAST(2 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            CAST(CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS VARCHAR(100)) AS XN_TYPE,
            CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END  AS GSTIN_UIN_RECIPIENT,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            C.GST_STATE_CODE+'-'+C.GST_STATE_NAME  AS PLACE_OF_SUPPLY,--(CONFUSION)
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('REGULAR' AS VARCHAR(10)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            A.PACKING_GST_PERCENTAGE AS RATE,
            A.PACKING_TAXABLE_VALUE  AS TAXABLE_VALUE,
            0 AS CESS_AMOUNT  ,
            CAST(CASE WHEN A.INV_MODE =1 THEN LM.AC_NAME  ELSE TL.DEPT_NAME  END AS VARCHAR(200)) AS RECEIVER_NAME ,
			A.PACKING_CGST_AMOUNT,A.PACKING_SGST_AMOUNT,A.PACKING_IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_code
      LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      LEFT JOIN GST_STATE_MST C (NOLOCK)  ON A.PARTY_STATE_CODE  =C.GST_STATE_CODE
      LEFT JOIN GST_STATE_MST TS (NOLOCK)  ON TL.GST_STATE_CODE  =TS.GST_STATE_CODE
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND ISNULL(A.PACKING,0)<>0
      AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID)
      AND A.SUPPLY_TYPE_CODE  IN('EXPWP','EXPWOP')
      UNION ALL
     SELECT A.INV_ID,SR=CAST(2 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            CAST(CASE WHEN A.INV_MODE =1 THEN 'PARTY INVOICE' ELSE 'GROUP INVOICE' END AS VARCHAR(100)) AS XN_TYPE,
            CASE WHEN A.INV_MODE =1 THEN  LMP.AC_GST_NO ELSE TL.LOC_GST_NO  END  AS GSTIN_UIN_RECIPIENT,
            CAST(A.INV_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.INV_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            C.GST_STATE_CODE+'-'+C.GST_STATE_NAME  AS PLACE_OF_SUPPLY,--(CONFUSION)
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('REGULAR' AS VARCHAR(10)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            IND.RATE AS RATE,
            ISNULL(IND.XN_VALUE_WITHOUT_GST,0) AS TAXABLE_VALUE,
            IND.Gst_cess_amount AS CESS_AMOUNT,
            CAST(CASE WHEN A.INV_MODE =1 THEN LM.AC_NAME  ELSE TL.DEPT_NAME  END AS VARCHAR(200)) AS RECEIVER_NAME   ,
			IND.CGST_AMOUNT,IND.SGST_AMOUNT,IND.IGST_AMOUNT
      FROM INM01106  A (NOLOCK)
      JOIN 
      ( SELECT INV_ID ,IND.GST_PERCENTAGE AS RATE  ,
               SUM(XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST,
               SUM(XN_VALUE_WITH_GST) AS XN_VALUE_WITH_GST,
			   SUM(CGST_AMOUNT) AS CGST_AMOUNT,
			   SUM(SGST_AMOUNT) AS SGST_AMOUNT,
			   SUM(IGST_AMOUNT) AS IGST_AMOUNT,
			   SUM(isnull(Gst_cess_amount,0)) as Gst_cess_amount

        FROM IND01106 IND (NOLOCK) 
       -- WHERE ISNULL(GST_PERCENTAGE,0)=0
        GROUP BY INV_ID,IND.GST_PERCENTAGE 
      )IND ON A.INV_ID =IND.INV_ID 
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =a.location_code
      LEFT JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID =A.PARTY_DEPT_ID 
      LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
      LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
      LEFT JOIN GST_STATE_MST C (NOLOCK)  ON A.PARTY_STATE_CODE  =C.GST_STATE_CODE
      LEFT JOIN GST_STATE_MST TS (NOLOCK)  ON TL.GST_STATE_CODE  =TS.GST_STATE_CODE
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND A.INV_DT BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID)
      AND A.SUPPLY_TYPE_CODE  IN('EXPWP','EXPWOP')
      
      
    DECLARE @TBLB2BCMM TABLE (MEMO_ID VARCHAR(100),XN_TYPE VARCHAR(20),GSTIN_UIN_RECIPIENT VARCHAR(100),PLACE_OF_SUPPLY VARCHAR(100),RECEIVER_NAME VARCHAR(200))

	 INSERT INTO @TBLB2BCMM(MEMO_ID,XN_TYPE,GSTIN_UIN_RECIPIENT,PLACE_OF_SUPPLY,RECEIVER_NAME)
	   SELECT A.CM_ID,'SLS' AS XN_TYPE,
            A.Party_Gst_No AS GSTIN_UIN_RECIPIENT,         
            CS.GST_STATE_CODE+'-'+Cs.GST_STATE_NAME  AS PLACE_OF_SUPPLY,
            ISNULL(CUST.CUSTOMER_FNAME ,'')+' '+ISNULL(CUSTOMER_LNAME,'') AS RECEIVER_NAME
     FROM CMM01106 A (NOLOCK)
     JOIN CUSTDYM CUST (NOLOCK) ON A.CUSTOMER_CODE =CUST.CUSTOMER_CODE
     JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.location_Code 
     LEFT JOIN GST_STATE_MST CS (NOLOCK)  ON CS.GST_STATE_CODE =A.PARTY_STATE_CODE 
     WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
     AND A.CM_DT BETWEEN @DFMDATE AND @DTODATE
     AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
     AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
	 AND ISNULL(A.Party_Gst_No,'')<>''
	 AND A.NET_AMOUNT>0
	 AND (@CDEPT_ID='' OR a.location_code=@CDEPT_ID)
	 AND A.SUPPLY_TYPE_CODE  IN('EXPWP','EXPWOP')
     
      
      INSERT INTO @TBLEXP(MEMO_ID,SR ,RTYPE,XN_TYPE ,GSTIN_UIN_RECIPIENT ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                  REVERSE_CHARGE,INVOICE_TYPE , E_COMMERCE_GSTIN ,RATE ,TAXABLE_VALUE ,CESS_AMOUNT,RECEIVER_NAME,
				  CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT)
      

        SELECT A.CM_ID,
            SR=CAST(1 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            'SLS' AS XN_TYPE,
            A.Party_Gst_No AS GSTIN_UIN_RECIPIENT,
            CAST(A.CM_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.CM_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            B.PLACE_OF_SUPPLY,
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('Export' AS VARCHAR(50)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            A.OTHER_CHARGES_GST_PERCENTAGE AS RATE,
            ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE  ,0) AS TAXABLE_VALUE,
            0 AS CESS_AMOUNT,
            B.RECEIVER_NAME,
			A.OTHER_CHARGES_CGST_AMOUNT,A.OTHER_CHARGES_SGST_AMOUNT,A.OTHER_CHARGES_IGST_AMOUNT
     FROM CMM01106 A (NOLOCK)
     JOIN @TBLB2BCMM  B ON A.cm_id =B.MEMO_ID 
	 WHERE  ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
	
	
	  INSERT INTO @TBLEXP(MEMO_ID,SR ,RTYPE,XN_TYPE ,GSTIN_UIN_RECIPIENT ,INVOICE_NO ,INVOICE_DT ,INVOICE_VALUE ,PLACE_OF_SUPPLY ,
                  REVERSE_CHARGE,INVOICE_TYPE , E_COMMERCE_GSTIN ,RATE ,TAXABLE_VALUE ,CESS_AMOUNT,RECEIVER_NAME,
				  CGST_AMOUNT ,SGST_AMOUNT,IGST_AMOUNT)
     SELECT A.CM_ID,
            SR=CAST(1 AS INT),
            CAST('B2B' AS VARCHAR(100)) AS RTYPE,
            'SLS' AS XN_TYPE,
            A.Party_Gst_No AS GSTIN_UIN_RECIPIENT,
            CAST(A.CM_NO  AS VARCHAR(100)) AS INVOICE_NO,
            REPLACE(CONVERT(VARCHAR(11),A.CM_DT,106),' ','-')  AS INVOICE_DATE,
            A.NET_AMOUNT  AS INVOICE_VALUE,
            B.PLACE_OF_SUPPLY,
            CAST('N' AS CHAR(1)) AS REVERSE_CHARGE,
            CAST('Export' AS VARCHAR(50)) AS INVOICE_TYPE,
            CAST('' AS VARCHAR(100))  AS E_COMMERCE_GSTIN,
            CMD.gst_percentage  AS RATE,
            ISNULL(CMD.XN_VALUE_WITHOUT_GST,0) AS TAXABLE_VALUE,
            CMD.Gst_cess_amount  AS CESS_AMOUNT ,
            B.RECEIVER_NAME,
			CMD.CGST_AMOUNT,CMD.SGST_AMOUNT,CMD.IGST_AMOUNT
     FROM CMM01106 A (NOLOCK)
     JOIN @TBLB2BCMM  B ON A.cm_id =B.MEMO_ID  
     JOIN CMD01106 CMD (NOLOCK) ON A.CM_ID =CMD.CM_ID 
    
	  IF ISNULL(@BCALLEDFORGSTR9,0)=1
	  BEGIN
	       IF OBJECT_ID ('TEMPDB..##EXP','U') IS NOT NULL 
		      DROP TABLE ##EXP

		 SELECT * INTO ##EXP FROM @TBLEXP
		 RETURN
	  END

	    DECLARE @EINVOICE_START_DATE VARCHAR(10),@EINVOICESTDATE DATETIME
	  select @EINVOICE_START_DATE=value from config where config_option='EINVOICE_START_DATE'

	  set @einvoicestdate=''
      IF ISNULL(@EINVOICE_START_DATE,'')<>''
      SET @EINVOICESTDATE=@EINVOICE_START_DATE

	    DECLARE @CEINVOICE_PREFIX VARCHAR(10)
	   select @CEINVOICE_PREFIX=value  from CONFIG where config_option ='EINVOICE_PREFIX'
	   set @CEINVOICE_PREFIX=ISNULL(@CEINVOICE_PREFIX,'')



      SELECT CAST('EXP' AS VARCHAR(3))  AS RTYPE, 
             CAST(CASE WHEN ISNULL(RATE,0) <>0 THEN 'WPAY' ELSE  'WOPAY' END AS VARCHAR(5)) AS [EXPORT TYPE],
              CASE WHEN (@CEINVOICE_PREFIX<>'' AND LEFT(RTRIM(LTRIM(INVOICE_NO)),1)='0' and CAST( INVOICE_DT  AS DATETIME) >= @EINVOICESTDATE) THEN @CEINVOICE_PREFIX ELSE '' END+INVOICE_NO AS [INVOICE NUMBER],
             INVOICE_DT AS [INVOICE DATE],
             INVOICE_VALUE AS [INVOICE VALUE],
             CAST('' AS VARCHAR(10)) AS [PORT CODE],
             CAST('' AS VARCHAR(10)) AS [SHIPPING BILL NUMBER],
             CAST('' AS VARCHAR(10)) AS [SHIPPING BILL DATE],
             --CAST('' AS VARCHAR(100)) as [Applicable % of Tax Rate],
             ISNULL(RATE,0) AS [RATE],
             SUM(ISNULL(TAXABLE_VALUE,0)) AS TAXABLE_VALUE

      FROM  @TBLEXP
      GROUP BY  CASE WHEN (@CEINVOICE_PREFIX<>'' AND LEFT(RTRIM(LTRIM(INVOICE_NO)),1)='0' and CAST( INVOICE_DT  AS DATETIME) >= @EINVOICESTDATE) THEN @CEINVOICE_PREFIX ELSE '' END+INVOICE_NO,
	  INVOICE_DT,INVOICE_VALUE,ISNULL(RATE,0),
	  CAST(CASE WHEN ISNULL(RATE,0) <>0 THEN 'WPAY' ELSE  'WOPAY' END AS VARCHAR(5)) 
 
      SELECT CAST('EXP' AS VARCHAR(3))  AS RTYPE, 
             SUM(TAXABLE_VALUE) AS TAXABLE_VALUE
      FROM  @TBLEXP

END

