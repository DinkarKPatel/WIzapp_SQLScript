CREATE PROCEDURE SPPPC_CUTTING_DETAILS
(
 @CBILL_NO VARCHAR(100)='',
 @CAC_NAME VARCHAR(100)='',
 @CMEMO_ID VARCHAR(100)='',
 @NQUERYID INT=1
)
AS
BEGIN
     
 IF @NQUERYID=1
    GOTO LBLMST
 ELSE IF @NQUERYID=2
    GOTO LBLDET
 ELSE
    GOTO END_PROC
 
 LBLMST:
   
     SELECT A.MEMO_ID, A.MEMO_NO,REPLACE(CONVERT(VARCHAR(11),A.MEMO_DT,106),' ','/') AS MEMO_DT ,
            A.AC_CODE,B.AC_NAME,
            A.JOB_CODE,A.CANCELLED,A.APPROVED,C.BILL_NO,JOBS.JOB_NAME
     FROM PPC_FG_CUTTING_ORDER_MST A
     JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
     JOIN
     (
      SELECT MEMO_ID,BO_DET_ROW_ID,C.BILL_NO 
      FROM PPC_FG_CUTTING_ORDER_DET A
      JOIN PPC_BUYER_ORDER_DET B ON A.BO_DET_ROW_ID=B.ROW_ID
      JOIN PPC_BUYER_ORDER_MST C ON C.ORDER_ID=B.ORDER_ID
      WHERE (@CBILL_NO='' OR C.BILL_NO=@CBILL_NO)
      GROUP BY MEMO_ID,BO_DET_ROW_ID,C.BILL_NO 
     ) C ON A.MEMO_ID=C.MEMO_ID
     JOIN JOBS ON JOBS.JOB_CODE=A.JOB_CODE
     WHERE (@CBILL_NO='' OR C.BILL_NO=@CBILL_NO)
     AND (@CAC_NAME='' OR B.AC_NAME=@CAC_NAME)
     AND (@CMEMO_ID='' OR A.MEMO_ID =@CMEMO_ID)
   GOTO END_PROC
   
   LBLDET:
   
     SELECT MST.ORDER_NO,
           MST.ORDER_DT, 
           C.PARA3_CODE ,
           P3.PARA3_NAME ,
           C.ARTICLE_CODE,
           ART.ARTICLE_NO ,
           C.PARA1_CODE,
           P1.PARA1_NAME,
           C.SIZEGROUP_CODE,
           SG.SIZEGROUP_NAME,
           C.QUANTITY,
           UOM.UOM_NAME,
           ART.UOM_CODE,
           C.PARA2_CODE,
           P2.PARA2_NAME,
           PMT.PRODUCT_CODE,
           PMT.QUANTITY_IN_STOCK,
           C.BO_DET_ROW_ID AS BO_ROW_ID,
           C.ROW_ID AS ROW_ID
     FROM PPC_FG_CUTTING_ORDER_MST A
     JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
     JOIN PPC_FG_CUTTING_ORDER_DET C ON A.MEMO_ID=C.MEMO_ID
     JOIN PPC_BUYER_ORDER_DET DET ON C.BO_DET_ROW_ID=DET.ROW_ID
     JOIN PPC_BUYER_ORDER_MST MST ON MST.ORDER_ID=DET.ORDER_ID
     JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE
     JOIN PARA1 P1 ON P1.PARA1_CODE=C.PARA1_CODE
     JOIN PARA2 P2 ON P2.PARA2_CODE=C.PARA2_CODE
     JOIN PARA3 P3 ON P3.PARA3_CODE=C.PARA3_CODE
     JOIN PPC_SIZEGROUP SG ON SG.SIZEGROUP_CODE=C.SIZEGROUP_CODE
     JOIN JOBS ON JOBS.JOB_CODE=A.JOB_CODE
     JOIN PPC_FG_PMT PMT ON PMT.PRODUCT_CODE=C.PRODUCT_CODE
     JOIN UOM ON UOM.UOM_CODE=ART.UOM_CODE
     WHERE A.MEMO_ID=@CMEMO_ID
   GOTO END_PROC
   
     
END_PROC:

END
