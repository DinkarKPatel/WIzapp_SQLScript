create PROCEDURE SP3S_GST_TAX_CAL
(
  @CXN_TYPE VARCHAR(10)='',
  @CMEMO_ID VARCHAR(30)='',
  @DMEMO_DT DATETIME='',
  @NSPID VARCHAR(40)='',
  @CPARTYSTATE_CODE VARCHAR(10)='',
  @BLOCALBILL BIT =0,
  @BPARTYREGISTERED INT=0, --USE REGISTERED
  @CPARTY_GSTN_NO VARCHAR(50)='',
  @CERRMSG VARCHAR(max) OUTPUT  ,
  @cLocationId VARCHAR(5)='',
  @nBoxNo NUMERIC(3,0)=0
)
--WITH RECOMPILE
AS
BEGIN


  
    DECLARE @CSTEP VARCHAR(10),@CCURDEPT_ID VARCHAR(5),@CCURSTATE_CODE VARCHAR(10),@GSTDATE DATETIME,
            @CTABLENAME VARCHAR(100),@CTEMPTABLENAME VARCHAR(100),@CTEMPDBNAME   VARCHAR(100),
            @CMASTERTABLENAME  VARCHAR(100),  @CDETAILTABLENAME  VARCHAR(100),   @CTEMPMASTERTABLENAME VARCHAR(100),  
            @CTEMPDETAILTABLENAME VARCHAR(100), @CTEMPMASTERTABLE  VARCHAR(100),   @CTEMPDETAILTABLE  VARCHAR(100) ,
            @DTSQL NVARCHAR(MAX) ,@CHASNCODEERROR VARCHAR(1000),@CLOC_GSTN_NO VARCHAR(100),@BREGISTERED_DELEER INT,
            @BCALCGST BIT ,@CFILTER VARCHAR(1000),@NDNTYPE INT,@CREFMRRID VARCHAR(100),
            @GST_CAL_DELIVERY_CHALLAN VARCHAR(10),@nExportGstMode NUMERIC(1,0),@nExportGstPct NUMERIC(6,2),
            @bExportInvoice BIT,@cRoundoffGst VARCHAR(2),
            @BCESS_APPLICABLE BIT,@DOMESTIC_FOR_EXPORT int,@cdebugxntype varchar(10),
			@dinv_mode int ,@CAC_CODE VARCHAR(15)
    
    SET @CSTEP=5
	DECLARE @CSTATECODE VARCHAR(10)
	DECLARE @CSOURCEDEPTID varchar(5) 
	set @DOMESTIC_FOR_EXPORT=0
	   	          
    DECLARE @CGSTCUTOFFDATE VARCHAR(10)
    SELECT TOP 1 @cRoundoffGst=VALUE FROM CONFIG WHERE CONFIG_OPTION ='WSL_ROUND_OFF_GST' 

	  DECLARE @CPICKLASTTAX VARCHAR(10)
	  SELECT TOP 1 @CPICKLASTTAX=LTRIM(RTRIM(VALUE)) FROM CONFIG 
	  WHERE CONFIG_OPTION='PICK_LAST_SLS_TAX'
    
    SET @cRoundoffGst='' ---ISNULL(@cRoundoffGst,'')

	set @cdebugxntype=@CXN_TYPE 

	if @CXN_TYPE='sls'
	  SET @CDEBUGXNTYPE='SLS_GST'
    
    SELECT TOP 1 @CGSTCUTOFFDATE=VALUE FROM CONFIG WHERE CONFIG_OPTION ='GST_CUT_OFF_DATE'
     SELECT TOP 1 @GST_CAL_DELIVERY_CHALLAN=VALUE FROM CONFIG WHERE CONFIG_OPTION='GST_CAL_DELIVERY_CHALLAN_PRINT'  
   
   SET @CTEMPDBNAME = '' 
   
   SET @CSTEP=10
    IF @CGSTCUTOFFDATE<>''
       SELECT @GSTDATE=CAST(@CGSTCUTOFFDATE AS DATETIME)
    
    BEGIN TRY 
    SET @CERRMSG=''
    SET @CFILTER=''
	
	EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

	IF @cLocationId=''
		SELECT TOP 1 @CCURDEPT_ID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID 
	else
		SET @CCURDEPT_ID=@cLocationId
		
		
	
    
	IF ISNULL(@CCURDEPT_ID,'')=''
	 BEGIN
		SET @CERRMSG =' LOCATION ID CAN NOT BE BLANK  '  +str(@@SPID)+' while calculating gst'
		RETURN    
	 END

    PRINT ' 1. DEFINE TEMP TABLES'
    
     IF @CXN_TYPE ='PRT'
     BEGIN
	 SET @CSTEP=15
              SET @CTEMPDBNAME=''
              SET @CMASTERTABLENAME = 'PRT_RMM01106_UPLOAD'  
			  SET @CDETAILTABLENAME = 'PRT_RMD01106_UPLOAD' 
			  SET @CTEMPMASTERTABLENAME = '#tPrtMstTable'
			  SET @CTEMPDETAILTABLENAME = '#tPrtDetTable'
			  SET @CTEMPMASTERTABLE =  @CTEMPMASTERTABLENAME  
			  SET @CTEMPDETAILTABLE =  @CTEMPDETAILTABLENAME  
			  
			  SELECT  @CCURDEPT_ID=A.ACCOUNTS_DEPT_ID , @CREFMRRID =ISNULL(A.REFMEMOID,'') ,@NDNTYPE=dn_type  FROM #tPrtMstTable a
              
              
               SELECT TOP 1 @nExportGstMode=ISNULL(export_gst_mode,0),
                           @nExportGstPct=ISNULL(export_gst_percentage,0),
                           @bExportInvoice=ISNULL(export_gst_percentage_Applicable,0)
              FROM #tPrtMstTable A 
	          JOIN LMP01106 B ON A.AC_CODE=B.AC_CODE
	          
               
			   SET @CSTEP=20
			  SET @CFILTER=' '
			
       
       END
       ELSE IF @CXN_TYPE ='PUR'
       BEGIN
	   SET @CSTEP=25
              
              SET @CTEMPDBNAME=''
              SET @CMASTERTABLENAME = 'PUR_PIM01106_UPLOAD'  
			  SET @CDETAILTABLENAME = 'PUR_PID01106_UPLOAD'  
			  SET @CTEMPMASTERTABLENAME = '#tMstTable'
			  SET @CTEMPDETAILTABLENAME = '#tDetTable'
			  SET @CTEMPMASTERTABLE =  @CTEMPMASTERTABLENAME  
			  SET @CTEMPDETAILTABLE =  @CTEMPDETAILTABLENAME  
			  

			  SET @CSTEP=30
              SET @DTSQL=N' SELECT @CCURDEPT_ID=(CASE WHEN ISNULL(PUR_FOR_DEPT_ID,'''')<>'''' AND ISNULL(XN_ITEM_TYPE,0) NOT IN (0,1)
              THEN PUR_FOR_DEPT_ID ELSE DEPT_ID END)   FROM '+@CTEMPMASTERTABLE+' A'
              EXEC SP_EXECUTESQL @DTSQL,N'@CCURDEPT_ID VARCHAR(5) OUTPUT',@CCURDEPT_ID=@CCURDEPT_ID OUTPUT
              PRINT @DTSQL
              

              SET @CSTEP=35
			   SELECT TOP 1 @nExportGstMode=ISNULL(export_gst_mode,0),
                           @nExportGstPct=ISNULL(export_gst_percentage,0),
                           @bExportInvoice=ISNULL(export_gst_percentage_Applicable,0)
              FROM #tMstTable A 
	          JOIN LMP01106 B ON A.AC_CODE=B.AC_CODE
	          
			  
       END
       ELSE IF @CXN_TYPE ='WSR'
       BEGIN
	   SET @CSTEP=40
              SET @CTEMPDBNAME=''
              SET @CMASTERTABLENAME = 'WSR_CNM01106_UPLOAD'  
			  SET @CDETAILTABLENAME = 'WSR_CND01106_UPLOAD'  
			  SET @CTEMPMASTERTABLENAME = '#tWsrMstTable'
			  SET @CTEMPDETAILTABLENAME = '#tWsrDetTable'  
			  SET @CTEMPMASTERTABLE = @CTEMPDBNAME + @CTEMPMASTERTABLENAME  
			  SET @CTEMPDETAILTABLE = @CTEMPDBNAME + @CTEMPDETAILTABLENAME  
			 
			 SET @CSTEP=45
			  SET @DTSQL=N' SELECT  @CCURDEPT_ID=billed_from_dept_id   FROM '+@CTEMPMASTERTABLE+' A '
              EXEC SP_EXECUTESQL @DTSQL,N'@CCURDEPT_ID VARCHAR(5) OUTPUT',@CCURDEPT_ID=@CCURDEPT_ID OUTPUT
              PRINT @DTSQL
              
			  SET @CSTEP=50            
              SELECT TOP 1 @nExportGstMode=ISNULL(export_gst_mode,0),
                           @nExportGstPct=ISNULL(export_gst_percentage,0),
                           @bExportInvoice=ISNULL(export_gst_percentage_Applicable,0),
						@NDNTYPE=cn_type 
              FROM #tWsrMstTable a
	          JOIN LMP01106 B (NOLOCK) ON A.AC_CODE=B.AC_CODE
	          
       
       END
       ELSE IF @CXN_TYPE IN('WSL','EXP','jwi','MIS')
       BEGIN
         
			 SET @CSTEP=52
			  SELECT TOP 1 @CSOURCEDEPTID=SOURCE_DEPT_ID FROM GST_TAXINFO_CALC TMP (NOLOCK)
			  WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))

			  SELECT TOP 1 @nExportGstMode=ISNULL(export_gst_mode,0),
                           @nExportGstPct=ISNULL(export_gst_percentage,0),
                           @bExportInvoice=ISNULL(export_gst_percentage_Applicable,0),
						   @DOMESTIC_FOR_EXPORT=a.DOMESTIC_FOR_EXPORT
              FROM wsl_inm01106_upload A 
	          JOIN LMP01106 B ON A.AC_CODE=B.AC_CODE
	          WHERE a.SP_ID= LTRIM(RTRIM((@NSPID)))
	        
			SET @CSTEP=55

			  IF ISNULL(@CSOURCEDEPTID,'')<>''
				  SET @CCURDEPT_ID=@CSOURCEDEPTID
				  
				
			
       END
       ELSE IF @CXN_TYPE IN('SLS','PO')
       BEGIN
       SET @CSTEP=60
	   EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

			SELECT TOP 1 @CSOURCEDEPTID=SOURCE_DEPT_ID FROM GST_TAXINFO_CALC TMP (NOLOCK)
			WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))

          IF ISNULL(@CSOURCEDEPTID,'')<>''
		     SET @CCURDEPT_ID=@CSOURCEDEPTID

		

       END


	   IF @CXN_TYPE='SLS'
	   BEGIN
			    SET @CSTEP=65
                
				EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1


				UPDATE A SET PARTY_STATE_CODE =CUST.CUS_GST_STATE_CODE,
				             party_gst_no=CUST.CUS_GST_NO
				FROM SLS_CMM01106_UPLOAD A (NOLOCK)
				JOIN CUSTDYM CUST (NOLOCK) ON A.CUSTOMER_CODE=CUST.CUSTOMER_CODE
				WHERE ISNULL(CUST.CUS_GST_NO ,'')<>'' AND  A.SP_ID =LTRIM(RTRIM((@NSPID)))
				--AND A.PARTY_STATE_CODE <>CUST.CUS_GST_STATE_CODE
				
				IF @@ROWCOUNT >0
				  select @CPARTYSTATE_CODE=PARTY_STATE_CODE from SLS_CMM01106_UPLOAD where sp_id=LTRIM(RTRIM((@NSPID)))


				    SET @CSTEP=66
                
				EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

				  -- as discuss with rohit sir /pankaj if tick in custdym always pick percenateg from  custdym & calculate igs amount

				SELECT TOP 1 @nExportGstPct=ISNULL(b.custdym_export_gst_percentage,0),
                             @bExportInvoice=ISNULL(b.custdym_export_gst_percentage_Applicable,0)
              FROM SLS_CMM01106_UPLOAD A (NOLOCK)
	          JOIN custdym B (NOLOCK) ON A.CUSTOMER_CODE =B.CUSTOMER_CODE
			  where A.SP_ID =LTRIM(RTRIM((@NSPID)))

			  set @bExportInvoice=isnull(@bExportInvoice,0)
			  set @nExportGstPct=isnull(@nExportGstPct,0)

			  IF ISNULL(@BEXPORTINVOICE,0)=1 
			      SET @CPARTYSTATE_CODE='NA2'

			

      END
       SET @CSTEP=67

	   EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

       set @bExportInvoice=ISNULL(@bExportInvoice,0)
       PRINT '1.END OF DEFINE TEMP TABLES'
       
	   SELECT @CSTATECODE=STATE_CODE FROM LOC_VIEW WHERE DEPT_ID=@CCURDEPT_ID
	   SELECT TOP 1 @CCURSTATE_CODE=ISNULL(GST_STATE_CODE,''),@CLOC_GSTN_NO=A.LOC_GST_NO,@BREGISTERED_DELEER=ISNULL(REGISTERED_GST,0) ,
	   @BCESS_APPLICABLE=ISNULL(CESS_APPLICABLE,0)
	   FROM LOCATION A WHERE A.DEPT_ID =@CCURDEPT_ID

	  SET @CSTEP=65.4	   
	 
       IF @BLOCALBILL=1
	      SET @CPARTYSTATE_CODE=@CCURSTATE_CODE
	  
	   IF @CXN_TYPE NOT IN('DSM','PRT','WSR')
	   BEGIN
			 IF ISNULL(@DMEMO_DT,'')<>''
			 UPDATE A SET MEMO_DT=@DMEMO_DT FROM GST_TAXINFO_CALC A  with (rowLOCK) WHERE SP_ID =LTRIM(RTRIM((@NSPID)))  AND ISNULL(MEMO_DT,'') =''
	   END
	   
	   SET @CSTEP=66
	   IF EXISTS (SELECT TOP 1 'U' FROM GST_TAXINFO_CALC A (NOLOCK) WHERE SP_ID =LTRIM(RTRIM((@NSPID)))  AND MEMO_DT <='2017-06-30')
	   BEGIN
		  RETURN
	   END
       
         DECLARE @CFC_CODE VARCHAR(7)
		 SELECT @CFC_CODE=fc_code  FROM location WHERE DEPT_ID=@CCURDEPT_ID
				   
       DECLARE  @CALL_XN_IGST VARCHAR(5)
       SELECT TOP 1 @CALL_XN_IGST=VALUE  FROM CONFIG WHERE CONFIG_OPTION ='ALL_XN_IGST' 
       
       IF @CALL_XN_IGST IS NULL
			SET @CALL_XN_IGST=''
       
       IF ISNULL(@CFC_CODE,'') NOT IN('','0000000')
       	SET @CALL_XN_IGST='1'

       	SET @CSTEP=66.5
		EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

		-- as Per discuss with ved ji (2-08-2022) wsl export Invoice(mark in ledger Master ) donot calculate focely igst for Rangoli Saree

		IF (ISNULL(@DOMESTIC_FOR_EXPORT,0)>1 ) AND @CXN_TYPE='WSL'--OR @BEXPORTINVOICE=1
		    SET @CPARTYSTATE_CODE='96' --FOR IGST AMOUNT CALCULATION

       IF ISNULL(@CALL_XN_IGST,'')='1'
       BEGIN
            SET @BPARTYREGISTERED=1
            SET @BREGISTERED_DELEER=1
            SET @CCURSTATE_CODE='NA1'
            SET @CPARTYSTATE_CODE='NA2'
            SET @CPARTY_GSTN_NO='NA1'
            SET @CLOC_GSTN_NO='NA2'
       END
        
 
       IF ISNULL(@CMEMO_ID,'')=''
       BEGIN
			print 'check gst-1'
            SET @CSTEP=66.2
			IF @CXN_TYPE NOT IN('PRT','WSR','PUR')
			BEGIN
				  DELETE  FROM GST_TAXINFO_TAXFREE with (rowlock)  WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
			END
	        
	        PRINT '2.VALIDATIONS USER DEFINE'
			
			print 'check gst-2'
		    IF @CXN_TYPE IN('WSL','SLS','WSR')
		    BEGIN
				SET @CSTEP=66.4
				   --PARTY REGISTERED AND LOC UN REGISTERED DOES NOT ALL SALE
				   IF (ISNULL(@BPARTYREGISTERED,0)=1 AND ISNULL(@BREGISTERED_DELEER,0)=0  ) AND ISNULL(@CALL_XN_IGST,'')<>'1'
				   BEGIN
						IF @CPARTYSTATE_CODE<>@CCURSTATE_CODE AND @CPARTYSTATE_CODE<>'00' AND @CCURSTATE_CODE<>'00'
						 BEGIN
							SET @CERRMSG=' INTER STATE TRANSACTION NOT ALLOWED FOR REGISTERED PARTY UNREGISTERED LOCATION'
							RETURN
						  END
				   END
				   SET @CSTEP=66.6
					--PARTY UN REGISTERED AND LOC UN REGISTERED DOES NOT ALL SALE
				   IF (ISNULL(@BPARTYREGISTERED,0)=0 AND ISNULL(@BREGISTERED_DELEER,0)=0  ) AND ISNULL(@CALL_XN_IGST,'')<>'1'
				   BEGIN
						IF @CPARTYSTATE_CODE<>@CCURSTATE_CODE AND @CPARTYSTATE_CODE<>'00' AND @CCURSTATE_CODE<>'00'
						BEGIN
							SET @CERRMSG=' INTER STATE TRANSACTION NOT ALLOWED FOR UNREGISTERED PARTY/LOCATION'
							RETURN
						END
				   END
			   
		      END
		      
			  IF @CXN_TYPE IN('PUR','PRT') AND ISNULL(@CALL_XN_IGST,'')<>'1'
				 BEGIN
				 SET @CSTEP=66.8
					--PARTY UN REGISTERED AND LOC UN REGISTERED DOES NOT ALL SALE
				   IF (ISNULL(@BPARTYREGISTERED,0)=0 AND ISNULL(@BREGISTERED_DELEER,0)=0  )
				   BEGIN
						IF @CPARTYSTATE_CODE<>@CCURSTATE_CODE AND @CPARTYSTATE_CODE<>'00' AND @CCURSTATE_CODE<>'00'
						BEGIN
							SET @CERRMSG=' INTER STATE TRANSACTION NOT ALLOWED FOR UN REGISTERED PARTY/LOCATION'
							RETURN
						END
				   END
			   END
	        
			SET @CSTEP=68
	        print 'check gst-3'
			   DECLARE @NGSTCALC INT
			   SET @NGSTCALC=0

			   EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

			   /*As Discuss with sanjiv Sir if Transaction un Registered  location no need to gst calculate in all inward transaction
			     again in All inward Tranaction Unregistered LOcation and Party registered Caluculte Gst (13072023)
			   */

			   IF @CXN_TYPE IN ('PUR','PRT','JWR','PPC_PUR','PPC_FG_REC','PO','WSLORD')
			   SET @NGSTCALC=1
			   
			   IF NOT (ISNULL(@BREGISTERED_DELEER,0)=1 OR @NGSTCALC=1 ) 
					UPDATE TMP SET HSN_CODE=CASE WHEN ISNULL(TMP.HSN_CODE,'') NOT IN ('','0000000000') THEN TMP.HSN_CODE
				                                WHEN ISNULL(SKU.HSN_CODE,'') NOT IN ('','0000000000') THEN SKU.HSN_CODE  
				                                ELSE HM.HSN_CODE END ,
				                  MRP=CASE WHEN ISNULL(TMP.MRP,0)=0 THEN SKU.MRP ELSE TMP.MRP END
				   FROM GST_TAXINFO_CALC TMP WITH (ROWLOCK)
				   JOIN SKU  (NOLOCK) SKU ON TMP.PRODUCT_CODE=SKU.PRODUCT_CODE 
				   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
				   LEFT JOIN HSN_MST  HM (NOLOCK) ON HM.HSN_CODE=ART.HSN_CODE 
				   WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) AND ISNULL(TMP.PRODUCT_CODE,'')<>''

		       SET @CSTEP=70
			   IF (ISNULL(@BREGISTERED_DELEER,0)=1 OR @NGSTCALC=1 ) 
			   BEGIN  
					SET @CSTEP=70.2	   
				   IF @CXN_TYPE NOT IN ('WOD','EXP') AND ISNULL(@CALL_XN_IGST,'')<>'1'
				   BEGIN
					SET @CSTEP=70.4
					   IF ISNULL (@CPARTYSTATE_CODE,'')IN('','00')
					   BEGIN
						  SET @CERRMSG='1.1:INVALID STATE CODE'
						  RETURN
					   END
					   SET @CSTEP=70.6
					   IF NOT EXISTS(SELECT TOP 1 'U' FROM GST_STATE_MST (NOLOCK) WHERE GST_STATE_CODE=@CPARTYSTATE_CODE) 
					   AND @bExportInvoice<>1
					   BEGIN
						  SET @CERRMSG='PLEASE CHECK GST STATE MASTER-'+@CPARTYSTATE_CODE
						  RETURN
					   END  
			      END
                 SET @CSTEP=72
              
			     EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

       
                   
			       PRINT '3.UPDATE HSN CODE IN TEMP TABLE'   
				   UPDATE TMP SET HSN_CODE=CASE WHEN ISNULL(TMP.HSN_CODE,'') NOT IN ('','0000000000') THEN TMP.HSN_CODE
				                                WHEN ISNULL(SKU.HSN_CODE,'') NOT IN ('','0000000000') THEN SKU.HSN_CODE  
				                                ELSE HM.HSN_CODE END ,
				                  MRP=CASE WHEN ISNULL(TMP.MRP,0)=0 THEN SKU.MRP ELSE TMP.MRP END
				   FROM GST_TAXINFO_CALC TMP (NOLOCK)
				   JOIN SKU  (NOLOCK) SKU ON TMP.PRODUCT_CODE=SKU.PRODUCT_CODE 
				   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE 
				   LEFT JOIN HSN_MST  HM (NOLOCK) ON HM.HSN_CODE=ART.HSN_CODE 
				   WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) AND ISNULL(TMP.PRODUCT_CODE,'')<>''
				 
				   SET @CSTEP=75
                 EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1


				   IF  @CXN_TYPE ='SLS'
				   BEGIN
				       
					   DECLARE @CALWAYS_PICK_GST_MODE_IN_RETAIL VARCHAR(10)
				       SELECT @CALWAYS_PICK_GST_MODE_IN_RETAIL=value  FROM CONFIG WHERE CONFIG_OPTION='ALWAYS_PICK_GST_MODE_IN_RETAIL_SALE_FROM_HSN_MASTER'

					   IF ISNULL(@CALWAYS_PICK_GST_MODE_IN_RETAIL,'')='1'
					   BEGIN
					       
						   UPDATE TMP SET TAX_METHOD =(CASE WHEN isnull(hm.RETAILSALE_TAX_METHOD,0)=2 THEN 1 ELSE 2 END) 
						   FROM GST_TAXINFO_CALC TMP (NOLOCK)
						   JOIN HSN_MST HM (NOLOCK) ON TMP.HSN_CODE =HM.HSN_CODE
						   WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) 

					   END

				   END
           SET @CSTEP=78
            EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

				
				   --@CCURDEPT_ID
				 
                   PRINT '4.FETCH GST PERCENTAGE ACCORDING TO WEF '
		
				     --CALCULATE HSN
				IF EXISTS (SELECT TOP 1 SP_ID FROM gst_xns_hsn (NOLOCK) WHERE sp_id=@NSPID)
					DELETE FROM gst_xns_hsn WITH (ROWLOCK) WHERE sp_id=@nSpId
	   
			       SET @CSTEP=80			   
                   IF ISNULL(@CFC_CODE,'')IN('','0000000')
                   BEGIN
                   SET @CSTEP=82
						;WITH CTE AS
						(
						SELECT a.sp_id,A.ROW_ID,B.HSN_CODE,ISNULL(C.TAX_PERCENTAGE,0) AS TAX_PERCENTAGE,ISNULL(C.RATE_CUTOFF,0) AS RATE_CUTOFF,
							   ISNULL(C.RATE_CUTOFF_TAX_PERCENTAGE,0) AS RATE_CUTOFF_TAX_PERCENTAGE,
							  ISNULL(C.WEF,'') AS WEF,ISNULL(B.TAXABLE_ITEM,'') AS TAXABLE_ITEM,ISNULL(B.HSN_TYPE ,'') AS HSN_TYPE  ,
							  SR=ROW_NUMBER() OVER (PARTITION BY A.ROW_ID ORDER BY C.WEF DESC),
							  ISNULL(C.GST_CAL_BASIS,1) AS GST_CAL_BASIS,
							  isnull(c.Rate_CutOff_Gst_Cess_Percentage,0) as Rate_CutOff_Gst_Cess_Percentage,
							  isnull(c.Gst_Cess_Percentage,0) as Gst_Cess_Percentage
						FROM GST_TAXINFO_CALC A (NOLOCK)
						JOIN HSN_MST B (NOLOCK) ON A.HSN_CODE =B.HSN_CODE 
						LEFT JOIN HSN_DET C (NOLOCK) ON B.HSN_CODE =C.HSN_CODE AND C.WEF  <=MEMO_DT AND ISNULL(C.DEPT_ID,'')=''
						WHERE A.SP_ID =LTRIM(RTRIM((@NSPID)))  
						)
						insert gst_xns_hsn (SP_ID,ROW_ID,HSN_CODE,TAX_PERCENTAGE,RATE_CUTOFF,
					    RATE_CUTOFF_TAX_PERCENTAGE,WEF,TAXABLE_ITEM,HSN_TYPE,SR,GST_CAL_BASIS,Rate_CutOff_Gst_Cess_Percentage,Gst_Cess_Percentage)
						SELECT SP_ID,ROW_ID,HSN_CODE,TAX_PERCENTAGE,RATE_CUTOFF,
					    RATE_CUTOFF_TAX_PERCENTAGE,WEF,TAXABLE_ITEM,HSN_TYPE,SR,GST_CAL_BASIS,
						Rate_CutOff_Gst_Cess_Percentage,Gst_Cess_Percentage
					    FROM CTE WHERE SR=1
						
					END
					ELSE
					BEGIN
					    SET @CSTEP=84 
					     ;WITH CTE AS
						(
						SELECT a.sp_id,A.ROW_ID,B.HSN_CODE,ISNULL(C.TAX_PERCENTAGE,0) AS TAX_PERCENTAGE,ISNULL(C.RATE_CUTOFF,0) AS RATE_CUTOFF,
							   ISNULL(C.RATE_CUTOFF_TAX_PERCENTAGE,0) AS RATE_CUTOFF_TAX_PERCENTAGE,
							  ISNULL(C.WEF,'') AS WEF,ISNULL(B.TAXABLE_ITEM,'') AS TAXABLE_ITEM,ISNULL(B.HSN_TYPE ,'') AS HSN_TYPE  ,
							  SR=ROW_NUMBER() OVER (PARTITION BY A.ROW_ID ORDER BY C.WEF DESC),
							  ISNULL(C.GST_CAL_BASIS,1) AS GST_CAL_BASIS,
							   isnull(c.Rate_CutOff_Gst_Cess_Percentage,0) as Rate_CutOff_Gst_Cess_Percentage,
							  isnull(c.Gst_Cess_Percentage,0) as Gst_Cess_Percentage
						FROM GST_TAXINFO_CALC A (NOLOCK)
						JOIN HSN_MST B (NOLOCK) ON A.HSN_CODE =B.HSN_CODE 
						LEFT JOIN HSN_DET C (NOLOCK) ON B.HSN_CODE =C.HSN_CODE AND C.WEF  <=MEMO_DT AND C.DEPT_ID=@CCURDEPT_ID
						WHERE A.SP_ID =LTRIM(RTRIM((@NSPID)))  
						)
						insert gst_xns_hsn (SP_ID,ROW_ID,HSN_CODE,TAX_PERCENTAGE,RATE_CUTOFF,
					    RATE_CUTOFF_TAX_PERCENTAGE,WEF,TAXABLE_ITEM,HSN_TYPE,SR,GST_CAL_BASIS,Rate_CutOff_Gst_Cess_Percentage,Gst_Cess_Percentage)
						SELECT SP_ID,ROW_ID,HSN_CODE,TAX_PERCENTAGE,RATE_CUTOFF,
					    RATE_CUTOFF_TAX_PERCENTAGE,WEF,TAXABLE_ITEM,HSN_TYPE,SR,GST_CAL_BASIS,
						Rate_CutOff_Gst_Cess_Percentage,Gst_Cess_Percentage
					    FROM CTE WHERE SR=1
					END
					
				
					SET @CSTEP=86

			EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

				   PRINT '4.UPDATE MRP COLUMN TO GST PERCENTAGE CALCULATE ACCORDING TO  GST CAL BASIS '   
				    
				   UPDATE TMP SET MRP= CASE WHEN ISNULL(HM.GST_CAL_BASIS,1)=1 THEN NET_VALUE ELSE (MRP*QUANTITY) END
				   FROM GST_TAXINFO_CALC TMP
				   JOIN gst_xns_hsn  HM (NOLOCK) ON hm.sp_id=tmp.sp_id and HM.HSN_CODE=TMP.HSN_CODE and tmp.row_id =hm.row_id 
				   WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
                    
                  PRINT '4.5 UPDATE CESS PERCENTAGE '
                    
					 IF ISNULL(@BCESS_APPLICABLE,0)=1 and @CXN_TYPE ='SLS'
					 BEGIN
				     
						 UPDATE A  SET CESS_PERCENTAGE= B.CESS_PERCENTAGE
						 FROM GST_TAXINFO_CALC  A (NOLOCK)
						 JOIN GST_STATE_DET B (NOLOCK) ON B.gst_STATE_CODE=@CCURSTATE_CODE AND A.MEMO_DT BETWEEN B.FM_DT AND B.TO_DT
						 WHERE A.SP_ID=LTRIM(RTRIM((@NSPID)))
						 AND @CCURSTATE_CODE=@CPARTYSTATE_CODE
					 END
			
			SET @CSTEP=88
		 	EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1
		 	
		 	  PRINT '5.UPDATE TAXABLE VALUE depend upon ARTICLE_PACK_SIZE '
		 	  
		 	   IF (EXISTS (SELECT TOP 1 'U'  FROM GST_TAXINFO_CALC TMP (NOLOCK) WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) AND ISNULL(PRODUCT_CODE,'')='') or (@CXN_TYPE ='PUR'))
			   begin
				       
					   UPDATE TMP SET MRP =TMP.MRP / ARTICLE_PACK_SIZE FROM GST_TAXINFO_CALC TMP (NOLOCK)
					   JOIN ARTICLE C (NOLOCK) ON C.ARTICLE_CODE =tmp.Gst_Article_code 
					   WHERE ISNULL(ARTICLE_PACK_SIZE,0)>0
					   and  TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
				       
			   end
			 
			 if @CXN_TYPE <>'PUR'
			 begin
		 	       UPDATE TMP SET MRP =TMP.MRP / ARTICLE_PACK_SIZE FROM GST_TAXINFO_CALC TMP (NOLOCK)
				   JOIN SKU B (NOLOCK) ON TMP.PRODUCT_CODE =B.PRODUCT_CODE 
				   JOIN ARTICLE C (NOLOCK) ON C.ARTICLE_CODE =B.ARTICLE_CODE 
                   WHERE ISNULL(ARTICLE_PACK_SIZE,0)>0
				   AND  TMP.SP_ID=LTRIM(RTRIM((@NSPID))) and isnull(TMP.PRODUCT_CODE,'')<>''
			 end
			
                    
                    
                    
                    PRINT '5.UPDATE TAXABLE VALUE '
				
					
                   UPDATE TMP SET  NET_VALUE_WOTAX= ROUND(MRP-(MRP*(CASE WHEN TAX_METHOD=2 THEN ( (HM.RATE_CUTOFF_TAX_PERCENTAGE+ISNULL(tmp.CESS_PERCENTAGE,0)+ISNULL(HM.GST_CESS_PERCENTAGE,0))/  
												   (100 + HM.RATE_CUTOFF_TAX_PERCENTAGE+ISNULL(tmp.CESS_PERCENTAGE,0)+ISNULL(HM.GST_CESS_PERCENTAGE,0))) ELSE 0 END)),2)
				   FROM GST_TAXINFO_CALC TMP (NOLOCK)
				   JOIN gst_xns_hsn HM (NOLOCK) ON hm.sp_id=tmp.sp_id and HM.HSN_CODE=TMP.HSN_CODE and tmp.row_id =hm.row_id 
				   WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) 
				   
				   
				  
				     
				   PRINT '6.UPDATE GST PERCENTAGE '
                   SET @CSTEP=90

				EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1
				
				-- select @BEXPORTINVOICE,@NEXPORTGSTPCT
                   UPDATE TMP SET GST_PERCENTAGE=CASE WHEN @CXN_TYPE IN('WSR','PRT')  AND ISNULL(TMP.gst_percentage,0)>0 THEN TMP.gst_percentage ELSE 
				   (CASE WHEN @BEXPORTINVOICE=1 THEN ISNULL(@NEXPORTGSTPCT,0)
				   WHEN ABS(TMP.QUANTITY)=0 THEN 0
                   ELSE ISNULL(CASE WHEN HM.RATE_CUTOFF<ABS(TMP.NET_VALUE_WOTAX)/ABS(TMP.QUANTITY) 
                   THEN HM.TAX_PERCENTAGE ELSE RATE_CUTOFF_TAX_PERCENTAGE END ,0) END)
				   END ,

				   Gst_Cess_Percentage=(CASE WHEN  ABS(TMP.QUANTITY)=0 THEN 0
                   ELSE ISNULL(CASE WHEN HM.RATE_CUTOFF<ABS(TMP.NET_VALUE_WOTAX)/ABS(TMP.QUANTITY) 
                   THEN HM.Gst_Cess_Percentage ELSE hm.Rate_CutOff_Gst_Cess_Percentage END ,0) END),

				   IGST_AMOUNT=0,
				   SGST_AMOUNT=0
				   FROM GST_TAXINFO_CALC TMP (NOLOCK)
				   JOIN gst_xns_hsn HM (NOLOCK) ON hm.sp_id=tmp.sp_id and HM.HSN_CODE=TMP.HSN_CODE  and tmp.row_id =hm.row_id 
				   WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))

				   SET @CSTEP=92
                  EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

				  IF @CPARTYSTATE_CODE='96' AND @CXN_TYPE='PUR'
				  begin
				      
					  SET @DTSQL = N' UPDATE B SET FOREX_GST_PERCENTAGE=A.GST_PERCENTAGE 
					  FROM  GST_TAXINFO_CALC A
					  JOIN  ' + @CDETAILTABLENAME + ' B ON A.ROW_ID=B.ROW_ID '+@CFILTER+'
					  WHERE A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''' '  
					  PRINT @DTSQL
					  EXEC SP_EXECUTESQL @DTSQL  

				  end
			
					

	             
	               PRINT '7.UPDATE TAX FREE WITH 0 '
	               
	               UPDATE TMP SET GST_PERCENTAGE =0,
				                  Gst_Cess_Percentage=0
	               FROM GST_TAXINFO_CALC TMP (NOLOCK)
				   JOIN GST_TAXINFO_TAXFREE B (NOLOCK) ON TMP.ROW_ID =B.ROW_ID AND TMP.SP_ID =B.SP_ID
	               WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) 


			
	               
       SET @CSTEP=94
	  	              
	EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

                    PRINT '8.IN SALE RETURN PICK LAST SALE '
					IF  @CXN_TYPE ='SLS'
					BEGIN

					    --IN CASE OF SALE RETURN CHECK CONFIG & PICK GST FROM SALE
					  
        
                        IF ISNULL(@CPICKLASTTAX,'')='1'	
                        BEGIN
						SET @CSTEP=94
							--IN RETAIL SALE 1 FOR INCLUSIVE AND ANOTHER TRANSACTION 1 FOR EXCLUSIVE PICK  FROM CASH MEMO
							UPDATE A SET HSN_CODE=ISNULL(SLS.HSN_CODE,B.HSN_CODE) ,
							TAX_METHOD = (CASE WHEN ISNULL(C.MRP_EXCHANGE_BILL,0)=1 THEN 2 
							ELSE ISNULL(SLS.TAX_METHOD,A.TAX_METHOD) END) ,
							GST_PERCENTAGE =ISNULL(SLS.GST_PERCENTAGE,B.GST_PERCENTAGE) ,
							Gst_Cess_Percentage=ISNULL(SLS.Gst_Cess_Percentage,B.Gst_Cess_Percentage)
							FROM   GST_TAXINFO_CALC A (NOLOCK)
							JOIN SLS_CMD01106_UPLOAD B (NOLOCK) ON A.ROW_ID =B.ROW_ID AND A.SP_ID =B.SP_ID 
							JOIN SLS_CMM01106_UPLOAD C (NOLOCK) ON C.SP_ID=B.SP_ID
							LEFT OUTER JOIN
							( 
								SELECT A.CM_NO,A.CM_DT ,B.PRODUCT_CODE,  
								B.GST_PERCENTAGE ,(CASE WHEN B.TAX_METHOD=1 THEN 2 ELSE 1 END) AS TAX_METHOD,
								B.HSN_CODE ,b.Gst_Cess_Percentage
								FROM CMM01106 A (NOLOCK)
								JOIN CMD01106 B (NOLOCK) ON A.CM_ID =B.CM_ID 
								JOIN GST_TAXINFO_CALC C (NOLOCK) ON C.PRODUCT_CODE=B.PRODUCT_CODE
								WHERE A.CANCELLED =0 AND B.QUANTITY >0
								AND CM_DT >='2017-07-01' and c.SP_ID=LTRIM(RTRIM((@NSPID))) 
							) SLS ON SLS.CM_NO =B.REF_SLS_MEMO_NO AND SLS.CM_DT =B.REF_SLS_MEMO_DT AND SLS.PRODUCT_CODE =A.PRODUCT_CODE 
							WHERE NET_VALUE <0  AND B.REF_SLS_MEMO_DT BETWEEN DATEADD(MONTH,-6,C.CM_DT) AND C.CM_DT
							AND  A.SP_ID=LTRIM(RTRIM((@NSPID))) 
					
						END
								
						
						UPDATE A SET NET_VALUE_WOTAX= ROUND(A.MRP-(A.MRP*(CASE WHEN A.TAX_METHOD=1 THEN ( A.GST_PERCENTAGE+ISNULL(a.CESS_PERCENTAGE,0) /
						                                       (100 + A.GST_PERCENTAGE+ISNULL(a.CESS_PERCENTAGE,0) )) ELSE 0 END)),2) 
						FROM   GST_TAXINFO_CALC A (NOLOCK)
						JOIN SLS_CMD01106_UPLOAD B (NOLOCK) ON A.ROW_ID =B.ROW_ID AND A.SP_ID =B.SP_ID 
						WHERE  A.NET_VALUE <0 
						AND  A.SP_ID=LTRIM(RTRIM((@NSPID))) 
						

					END
					-- END OF SALE RETURN
					
					SET @CSTEP=98
		EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

					DECLARE @DONOT_CALCULATE_GST_FDN VARCHAR(10)
					SELECT TOP 1 @DONOT_CALCULATE_GST_FDN=VALUE  FROM CONFIG WHERE CONFIG_OPTION='DONOT_CALCULATE_GST_FDN' 
					
                    PRINT '9.IN FINANCIAL  DN/CN UPDATE GST PERCENTAGE 0 IF ENABLED DONOT_CALCULATE_GST_FDN '
                    IF ISNULL(@DONOT_CALCULATE_GST_FDN,'')='1'  AND @CXN_TYPE='EOSS'
                    SET @NDNTYPE=2
                              
                     IF @NDNTYPE=2 AND ISNULL(@DONOT_CALCULATE_GST_FDN,'')='1' AND  @CXN_TYPE IN('PRT','WSR','EOSS')
                     BEGIN
                         UPDATE TMP WITH (ROWLOCK)
                         SET GST_PERCENTAGE=0,
						  Gst_Cess_Percentage=0,
                         NET_VALUE_WOTAX=NET_VALUE      
                         FROM GST_TAXINFO_CALC TMP
                         WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
                     
                     END

				
                  
                     PRINT 'UPDATE FINANCIAL DEBIT NOTE AGAINST PURCHASE ACCORDING TO PURCHASE '
	                IF @NDNTYPE=2 AND @CXN_TYPE='PRT' AND ISNULL(@CREFMRRID,'')<>'' AND ISNULL(@DONOT_CALCULATE_GST_FDN,'')<>'1'
					 BEGIN
					      SET @CSTEP=100
						   SET @DTSQL=N' UPDATE A SET HSN_CODE=PID.HSN_CODE,
						   GST_PERCENTAGE=PID.GST_PERCENTAGE,
						   Gst_Cess_Percentage=pid.Gst_Cess_Percentage
						   FROM GST_TAXINFO_CALC A (NOLOCK)
						   JOIN  #tDEtTable  B ON A.ROW_ID=B.ROW_ID 
						   JOIN
						   (
							SELECT A.MRR_ID,PRODUCT_CODE ,A.GST_PERCENTAGE ,A.HSN_CODE,
							       a.Gst_Cess_Percentage
							FROM PID01106 A (NOLOCK)
							JOIN PIM01106 B (NOLOCK) ON A.MRR_ID =B.MRR_ID 
							JOIN (select distinct mrr_id from #tDEtTable)
							WHERE B.CANCELLED =0
							GROUP BY A.MRR_ID,PRODUCT_CODE ,A.GST_PERCENTAGE ,A.HSN_CODE,a.Gst_Cess_Percentage
						   ) PID ON PID.MRR_ID=B.MRR_ID
						   AND PID.PRODUCT_CODE=B.PRODUCT_CODE  '
						        
						  PRINT @DTSQL
						  EXEC SP_EXECUTESQL @DTSQL
					 
					 END
	           
			        SET @CSTEP=105
	                EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1
           
					--if @@spid=124
					--SELECT 'chk gst no.s', ISNULL(@CPARTY_GSTN_NO,''),ISNULL(@CLOC_GSTN_NO,'')  , @CXN_TYPE , ISNULL(@GST_CAL_DELIVERY_CHALLAN,''),  @bExportInvoice

	                PRINT 'UPDATE STOCK TRANSFER GST PERCENTAGE WITH 0 ' 
                    IF ISNULL(@CPARTY_GSTN_NO,'')=ISNULL(@CLOC_GSTN_NO,'')  and @CXN_TYPE <>'WSL'
                     BEGIN
                         UPDATE TMP
                         SET GST_PERCENTAGE=CASE WHEN @CXN_TYPE ='WSR' AND @bExportInvoice=1 THEN GST_PERCENTAGE ELSE   0 END ,
						      Gst_Cess_Percentage=0,
                         NET_VALUE_WOTAX=NET_VALUE      
                         FROM GST_TAXINFO_CALC TMP (NOLOCK)
                         WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
                     END
                     ELSE IF ISNULL(@CPARTY_GSTN_NO,'')=ISNULL(@CLOC_GSTN_NO,'')  and @CXN_TYPE ='WSL' AND ISNULL(@GST_CAL_DELIVERY_CHALLAN,'')<>'1' AND @bExportInvoice<>1
                     BEGIN 

					     SET @CSTEP=107
                         UPDATE TMP
                         SET GST_PERCENTAGE=0,
						   Gst_Cess_Percentage=0,
                         NET_VALUE_WOTAX=NET_VALUE      
                         FROM GST_TAXINFO_CALC TMP (NOLOCK)
                         WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
                     
                     END
                     ELSE    IF @NDNTYPE=1 AND @CXN_TYPE='PRT' AND @BREGISTERED_DELEER IN(0,2)
                     begin
                        UPDATE TMP SET GST_PERCENTAGE=0,Gst_Cess_Percentage=0,
                         NET_VALUE_WOTAX=NET_VALUE      
                         FROM GST_TAXINFO_CALC TMP (NOLOCK)
                         WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
                     
                     end

			  SET @CSTEP=106	
            EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1
        
                     PRINT 'THEASE TRANSACTION CALCULATE GST ONLY REGISTERED PARTY' 
                     
                     IF @CXN_TYPE IN('PUR','PRT','EXP','JWR','PSJWR','PO','WSLORD') AND @BPARTYREGISTERED IN(0,2)
                     BEGIN
                         UPDATE TMP WITH (ROWLOCK)
                         SET GST_PERCENTAGE=0,
						 Gst_Cess_Percentage=0,
                         NET_VALUE_WOTAX=NET_VALUE      
                         FROM GST_TAXINFO_CALC TMP 
                         WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))
                     END
                     	
				   -- STEP 4 IN HSN CODE CAN NOT BE BLANK
				   SET @CSTEP=109
			      EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1

				  SELECT @CHASNCODEERROR=ROW_ID 
				  FROM GST_TAXINFO_CALC 
				  WHERE SP_ID=LTRIM(RTRIM((@NSPID))) 
				  AND ISNULL(HSN_CODE,'') IN('','0000000000')
				   
				 IF ISNULL(@CHASNCODEERROR,'')<>''
	             BEGIN
	                 SET @CERRMSG='HSN CODE CAN NOT BE BLANK:-'
	                 RETURN
	             END

				  SELECT @CHASNCODEERROR=A.HSN_CODE 
				  FROM GST_TAXINFO_CALC  A (nolock)
				  LEFT JOIN HSN_MST B (NOLOCK) ON A.HSN_CODE =B.HSN_CODE 
				  WHERE a.SP_ID=LTRIM(RTRIM((@NSPID))) 
				  AND B.HSN_CODE IS NULL
				  
				 IF ISNULL(@CHASNCODEERROR,'')<>''
	             BEGIN
	                 SET @CERRMSG=@CHASNCODEERROR+',HSN CODE NOT FOUND IN HSN MASTER'
	                 RETURN
	             END
				   
	       end  --END OF REGISTERED DELTER
		   ELSE
		   IF  isnull(@bExportInvoice,0)<>1
		   BEGIN
		        --UNREGINSTERED CUSTOMER NOT ALLOW RO CALCULATE TAX PERCENTAGE
		       SET @CSTEP=111
		        UPDATE TMP SET HSN_CODE=CASE WHEN ISNULL(HSN_CODE,'')='' THEN '0000000000' ELSE HSN_CODE END,
				GST_PERCENTAGE=0 ,
				Gst_Cess_Percentage=0,
				IGST_AMOUNT=0,
				CGST_AMOUNT=0,
			    SGST_AMOUNT=0,
				NET_VALUE_WOTAX=NET_VALUE 
				FROM GST_TAXINFO_CALC TMP
				WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) 
				
		   END	 
			
			set @cStep=111.4
		    PRINT 'CALCULATE TAXABLE & WITH TAXABLE VALUE' 
	EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1		
				  
				    
			UPDATE TMP SET XN_VALUE_WITHOUT_GST =ROUND(NET_VALUE-(NET_VALUE*(CASE WHEN TAX_METHOD=2 THEN ((ISNULL(TMP.GST_PERCENTAGE,0)+ISNULL(TMP.CESS_PERCENTAGE,0)+ISNULL(TMP.Gst_Cess_Percentage,0))/  
			(100 + ISNULL(TMP.GST_PERCENTAGE,0)+ISNULL(TMP.CESS_PERCENTAGE,0)+ISNULL(TMP.Gst_Cess_Percentage,0))) ELSE 0 END)),2)
			FROM GST_TAXINFO_CALC TMP
			WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))

		
			set @cStep=111.5
	EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1
			
			 IF ISNULL(@BCESS_APPLICABLE,0)=1
			 BEGIN
		     SET @CSTEP=113
				 UPDATE A  SET CESS_AMOUNT= xn_value_without_gst *isnull(A.CESS_PERCENTAGE,0)/100
				 FROM GST_TAXINFO_CALC  A (NOLOCK)
				 WHERE A.SP_ID=LTRIM(RTRIM((@NSPID)))
				
			 END
		 
			 UPDATE A  SET Gst_Cess_Amount= ROUND(xn_value_without_gst *isnull(A.gst_CESS_PERCENTAGE,0)/100,2)
			 FROM GST_TAXINFO_CALC  A (NOLOCK)
			 WHERE A.SP_ID=LTRIM(RTRIM((@NSPID)))
			  
            SET @CSTEP=115  
				EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1
		  UPDATE TMP SET XN_VALUE_WITH_GST = ROUND((NET_VALUE-ISNULL(Gst_Cess_Amount,0))+((NET_VALUE-ISNULL(Gst_Cess_Amount,0))*(CASE WHEN TAX_METHOD=2 THEN 0   
           ELSE ((ISNULL(TMP.GST_PERCENTAGE,0))/100) END)) ,2)     
          FROM GST_TAXINFO_CALC TMP (NOLOCK)  
          WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))   
       

   --         UPDATE TMP SET XN_VALUE_WITH_GST = ROUND((CASE WHEN TAX_METHOD=2 THEN NET_VALUE  
   --         ELSE XN_VALUE_WITHOUT_GST+(XN_VALUE_WITHOUT_GST*gst_percentage /100) END) ,2)	  
			--FROM GST_TAXINFO_CALC TMP (NOLOCK)
			--WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) 

		    SET @CSTEP=116
            	EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1
             UPDATE TMP SET IGST_AMOUNT =ROUND(CASE WHEN @CCURSTATE_CODE<>@CPARTYSTATE_CODE THEN 
             (NET_VALUE-(CASE WHEN TAX_METHOD=2 THEN isnull(Gst_Cess_Amount,0) ELSE 0 END))
			*(CASE WHEN TAX_METHOD=2 THEN (TMP.GST_PERCENTAGE/  
	        (100 + TMP.GST_PERCENTAGE)) ELSE (TMP.GST_PERCENTAGE/100) END)
			ELSE 0 END,(CASE WHEN @cRoundoffGst='1' THEN 0 ELSE 2 END)) ,
			
			CGST_AMOUNT=ROUND((CASE WHEN @CCURSTATE_CODE<>@CPARTYSTATE_CODE THEN 0
			ELSE (NET_VALUE-(CASE WHEN TAX_METHOD=2 THEN ISNULL(CESS_AMOUNT,0)+isnull(Gst_Cess_Amount,0) ELSE 0 END))
			*(CASE WHEN TAX_METHOD=2 THEN (TMP.GST_PERCENTAGE/  
			(100 + TMP.GST_PERCENTAGE)) ELSE (TMP.GST_PERCENTAGE/100) END) 
			 END)/2,(CASE WHEN @cRoundoffGst='1' THEN 0 ELSE 2 END)),
			 
			SGST_AMOUNT=ROUND((CASE WHEN @CCURSTATE_CODE<>@CPARTYSTATE_CODE THEN 0
			ELSE (NET_VALUE-(CASE WHEN TAX_METHOD=2 THEN ISNULL(CESS_AMOUNT,0)+isnull(Gst_Cess_Amount,0) ELSE 0 END))
			*(CASE WHEN TAX_METHOD=2 THEN (TMP.GST_PERCENTAGE/  
			(100 + TMP.GST_PERCENTAGE)) ELSE (TMP.GST_PERCENTAGE/100) END) 
			END)/2,(CASE WHEN @cRoundoffGst='1' THEN 0 ELSE 2 END))
			FROM GST_TAXINFO_CALC TMP (NOLOCK)
			WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID)))

			
		SET @CSTEP=118

			EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1
	    IF EXISTS (SELECT TOP 1 'U'	FROM GST_TAXINFO_CALC TMP (NOLOCK)
		 WHERE TMP.SP_ID=LTRIM(RTRIM((@NSPID))) AND ISNULL(CGST_AMOUNT,0)<>ISNULL(SGST_AMOUNT,0))
	     BEGIN
	        SET @CERRMSG='Diff In cgst & sgst Amount :-'
	        RETURN
	     
	     END
	   	
              SET @CSTEP=120
              	
             PRINT 'UPDATE ALL VALUES INR MAIN TABLE' 
             IF @CXN_TYPE IN('PUR','PRT','WSR')
             BEGIN
	   
				  SET @DTSQL = N' UPDATE B SET HSN_CODE=A.HSN_CODE,
				  GST_PERCENTAGE=ISNULL(A.GST_PERCENTAGE,0),
				  IGST_AMOUNT=ISNULL(A.IGST_AMOUNT,0),
				  CGST_AMOUNT=ISNULL(A.CGST_AMOUNT,0),
				  SGST_AMOUNT=ISNULL(A.SGST_AMOUNT,0),
				  XN_VALUE_WITHOUT_GST=ISNULL(A.XN_VALUE_WITHOUT_GST,0),
				  XN_VALUE_WITH_GST=ISNULL(A.XN_VALUE_WITH_GST,0),
				  CESS_AMOUNT=ISNULL(A.CESS_AMOUNT,0),
				  Gst_Cess_Percentage=isnull(a.Gst_Cess_Percentage,0),
				  Gst_Cess_Amount=isnull(a.Gst_Cess_Amount,0)
				  FROM  GST_TAXINFO_CALC A
				  JOIN  ' + @CTEMPDETAILTABLE + ' B ON A.ROW_ID=B.ROW_ID '+@CFILTER+'
				  WHERE A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''' '  
				  PRINT @DTSQL
				  EXEC SP_EXECUTESQL @DTSQL  
				  
	         END
	         
	        SET @CSTEP=122
	         --CALCULATE GST OVER HEAD 
            IF EXISTS (SELECT TOP 1 'U' FROM GST_TAXINFO_CALC_OH (NOLOCK) WHERE SP_ID=LTRIM(RTRIM((@NSPID))))
            BEGIN
               
                DECLARE @NGSTCAL INT,@BDONOTCALGSTINOH BIT
				SET @BDONOTCALGSTINOH=0
                IF @CXN_TYPE IN('PUR','PRT','EXP','JWR','PSJWR','WSLORD')
                   SET @NGSTCAL=@BPARTYREGISTERED
                ELSE
                   SET @NGSTCAL=@BREGISTERED_DELEER

				   IF @CXN_TYPE='WSL' AND @BEXPORTINVOICE=1 AND ISNULL(@NEXPORTGSTPCT,0)=0
				   BEGIN
				        SET @BDONOTCALGSTINOH=1
				   END

                   
                PRINT 'OVER HEAD GST CALCULATED-started' 
                EXEC SP3S_GST_TAX_CAL_OH @CXN_TYPE,@NSPID,@NGSTCAL,@CLOC_GSTN_NO,@CPARTY_GSTN_NO,@CCURSTATE_CODE,@CPARTYSTATE_CODE,@CERRMSG OUTPUT,@BDONOTCALGSTINOH
                 PRINT 'OVER HEAD GST CALCULATED-finished' 
                 
                IF ISNULL(@CERRMSG,'')=''
                BEGIN
                   IF @CXN_TYPE IN('PUR','PRT','WSR')
                   BEGIN
                      SET @CSTEP=124
						  SET @DTSQL = N' UPDATE B SET FREIGHT_HSN_CODE=A.FREIGHT_HSN_CODE,
						  OTHER_CHARGES_HSN_CODE=A.OTHER_CHARGES_HSN_CODE, 
						                          
						  FREIGHT_GST_PERCENTAGE=A.FREIGHT_GST_PERCENTAGE,
						  OTHER_CHARGES_GST_PERCENTAGE=A.OTHER_CHARGES_GST_PERCENTAGE,
						                               
						  FREIGHT_IGST_AMOUNT=ROUND(CASE WHEN ISNULL(ISIGST,0)=1 THEN A.FREIGHT_GST_AMOUNT ELSE 0 END,2),
						  FREIGHT_CGST_AMOUNT=ROUND(CASE WHEN ISNULL(ISIGST,0)=1 THEN 0 ELSE A.FREIGHT_GST_AMOUNT END/2,2),
						  FREIGHT_SGST_AMOUNT=ROUND(CASE WHEN ISNULL(ISIGST,0)=1 THEN 0 ELSE A.FREIGHT_GST_AMOUNT END/2,2),
						                               
						  OTHER_CHARGES_IGST_AMOUNT=ROUND(CASE WHEN ISNULL(ISIGST,0)=1 THEN A.OTHER_CHARGES_GST_AMOUNT ELSE 0 END,2),
						  OTHER_CHARGES_CGST_AMOUNT=ROUND(CASE WHEN ISNULL(ISIGST,0)=1 THEN 0 ELSE A.OTHER_CHARGES_GST_AMOUNT END/2,2),
						  OTHER_CHARGES_SGST_AMOUNT=ROUND(CASE WHEN ISNULL(ISIGST,0)=1 THEN 0 ELSE A.OTHER_CHARGES_GST_AMOUNT END/2,2),
						  OTHER_CHARGES_TAXABLE_VALUE=A.OTHER_CHARGES_TAXABLE_VALUE,
						  FREIGHT_TAXABLE_VALUE=A.FREIGHT_TAXABLE_VALUE
						                                              
					       FROM  GST_TAXINFO_CALC_OH A
						   JOIN  ' + @CTEMPMASTERTABLE + ' B WITH (ROWLOCK) ON 1=1 '+@CFILTER+'
						   WHERE A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''' '  
						  PRINT @DTSQL
						  EXEC SP_EXECUTESQL @DTSQL  

						  SET @CSTEP=126
						  --SELECT * FROM TEMP_RMM01106_109
						  
						--  SELECT * FROM GST_TAXINFO_CALC_OH WHERE SP_ID=77
						  
						  IF @CXN_TYPE IN('WSR')
						  BEGIN
						      
						       SET @DTSQL = N' UPDATE B SET INSURANCE_HSN_CODE=A.INSURANCE_HSN_CODE ,          
						                       INSURANCE_GST_PERCENTAGE=ISNULL(A.INSURANCE_GST_PERCENTAGE,0),  
						                       INSURANCE_IGST_AMOUNT=ROUND(CASE WHEN ISNULL(ISIGST,0)=1 THEN ISNULL(A.INSURANCE_GST_AMOUNT,0) ELSE 0 END,2),
						                       INSURANCE_CGST_AMOUNT=ROUND(CASE WHEN ISNULL(ISIGST,0)=1 THEN 0 ELSE ISNULL(A.INSURANCE_GST_AMOUNT,0) END/2,2),
						                       INSURANCE_SGST_AMOUNT=ROUND(CASE WHEN ISNULL(ISIGST,0)=1 THEN 0 ELSE ISNULL(A.INSURANCE_GST_AMOUNT,0) END/2,2) ,
						                       INSURANCE_TAXABLE_VALUE=A.INSURANCE_TAXABLE_VALUE
							   FROM  GST_TAXINFO_CALC_OH A
							   JOIN  ' + @CTEMPMASTERTABLE + ' B ON 1=1 '+@CFILTER+'
							   WHERE A.SP_ID='''+LTRIM(RTRIM((@NSPID)))+''' '  
						       PRINT @DTSQL
						       EXEC SP_EXECUTESQL @DTSQL  
						  
						  END
                     END
                 END 
                 --END OF CALCULATING OVER HEAD 
	        END
	  EXEC SP_CHKXNSAVELOG @CDEBUGXNTYPE,@cStep,0,@NSPID,1
          RETURN
             
       END
       ELSE
       BEGIN --NEW TRANSACTION  END OF @CMEMO_ID
		   IF @CXN_TYPE IN ('PUR')
		   BEGIN
	             
				  SET @CSTEP=128
				  --DELETE FROM GST_TAXINFO_CALC WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
				  --DELETE FROM GST_TAXINFO_CALC_OH WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
				declare @cPurFilter varchar(200),@cPurJoinstr varchar(200)

				select  @cPurFilter=(case when @cXn_type='pur' then '1=1' else 'b.sp_id='''+@nSpId+'''' end),
					    @cPurJoinStr=(case when @cxn_type='pur' then '1=1' else 'a.sp_id=b.sp_id' end)

						DECLARE @CBOXFILTER VARCHAR(100)
						SET @CBOXFILTER=''

						IF @NBOXNO>0
						SET @CBOXFILTER=' and A.BOX_NO='+RTRIM(LTRIM(STR(@NBOXNO)))+' '

			   --ARTICLE WISE
				 SET @DTSQL=N'  INSERT GST_TAXINFO_CALC	( PRODUCT_CODE, SP_ID, NET_VALUE,ROW_ID,TAX_METHOD,QUANTITY,HSN_CODE,MRP,Gst_Article_code) 
				   SELECT 	  A.PRODUCT_CODE
				 , SP_ID='''+LTRIM(RTRIM((@NSPID))) +''',
				  NET_VALUE=(((A.PURCHASE_PRICE*A.INVOICE_QUANTITY)-(ISNULL(PIMDISCOUNTAMOUNT,0))
				             ))  ,
				 A.ROW_ID,B.BILL_LEVEL_TAX_METHOD,A.QUANTITY,
				 CASE WHEN ISNULL(A.HSN_CODE,'''') IN('''',''0000000000'') THEN  HM.HSN_CODE ELSE A.HSN_CODE END AS HSN_CODE,
				 A.MRP,ART.ARTICLE_CODE
				 FROM '+@CTEMPDETAILTABLE+' A
				 JOIN '+@CTEMPMASTERTABLE+' B  on '+@cPurJoinStr+ ' 
				 JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
				 LEFT JOIN HSN_MST HM (NOLOCK) ON HM.HSN_CODE=ART.HSN_CODE WHERE   '+@cPurFilter+' and  ISNULL(A.PRODUCT_CODE,'''')='''' 
				 ' +@CBOXFILTER
				 print @dtSql
				 EXEC SP_EXECUTESQL @DTSQL
				 PRINT @DTSQL
			
	             
				 --BARCODE WISE
				 SET @CSTEP=130
				 SET @DTSQL=N'INSERT GST_TAXINFO_CALC	( PRODUCT_CODE, SP_ID, NET_VALUE,ROW_ID,TAX_METHOD,QUANTITY,HSN_CODE,MRP,Gst_Article_code) 
				 SELECT 	 CASE WHEN A.ARTICLE_CODE=C.ARTICLE_CODE THEN  A.PRODUCT_CODE ELSE '''' END
				 , SP_ID='''+LTRIM(RTRIM((@NSPID))) +''',
				  NET_VALUE=(((A.PURCHASE_PRICE*A.INVOICE_QUANTITY)
							 -(PIMDISCOUNTAMOUNT)
				             )),
				 A.ROW_ID,B.BILL_LEVEL_TAX_METHOD,A.QUANTITY,
				  CASE WHEN ISNULL(A.HSN_CODE,'''') NOT IN('''',''0000000000'') THEN  A.HSN_CODE ELSE HM.HSN_CODE END,
				  A.MRP,A.ARTICLE_CODE 
				 FROM '+@CTEMPDETAILTABLE+' A
				 JOIN '+@CTEMPMASTERTABLE+'  B on '+@cPurJoinstr +'
				 JOIN SKU C ON A.PRODUCT_CODE=C.PRODUCT_CODE
				 JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
				 LEFT JOIN HSN_MST HM (NOLOCK) ON HM.HSN_CODE=ART.HSN_CODE
				 WHERE  '+@cPurFilter+' and ISNULL(A.PRODUCT_CODE,'''')<>''''   
				 '+@CBOXFILTER
				 PRINT @DTSQL
				 EXEC SP_EXECUTESQL @DTSQL
		        
				SET @CSTEP=132
		        --FOR OVER HEADS
		         SET @DTSQL=N'INSERT GST_TAXINFO_CALC_OH	( SP_ID, FREIGHT, OTHER_CHARGES, INSURANCE, PACKING,OH_TAX_METHOD,DO_NOT_CALC_GST_OH,FREIGHT_HSN_CODE,OTHER_CHARGES_HSN_CODE)
		         SELECT 	 SP_ID='''+LTRIM(RTRIM((@NSPID))) +''', CASE WHEN ISNULL(FRIGHT_PAY_MODE,0)=2 THEN 0 ELSE  
				 FREIGHT END, OTHER_CHARGES, 0 AS INSURANCE, 0 AS  PACKING ,ISNULL(OH_TAX_METHOD,0) ,0 AS DO_NOT_CALC_GST_OH,
		         FREIGHT_HSN_CODE,OTHER_CHARGES_HSN_CODE
		         FROM '+@CTEMPMASTERTABLE+' B  where '+@cPurFilter
		         
		         PRINT @DTSQL
				 EXEC SP_EXECUTESQL @DTSQL
				 
	            
			 END  
			 ELSE IF @CXN_TYPE='PRT'
			 BEGIN
	              
				
	      
				  SET @CSTEP=136
				 DELETE FROM GST_TAXINFO_CALC WITH (ROWLOCK) WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
				 DELETE FROM GST_TAXINFO_CALC_OH  WITH (ROWLOCK) WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
	             DELETE FROM GST_TAXINFO_TAXFREE WITH (ROWLOCK) WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
	    
	    --GST_TAXINFO_TAXFREE
				 SET @DTSQL=N' INSERT GST_TAXINFO_CALC	( PRODUCT_CODE, SP_ID, NET_VALUE,ROW_ID,TAX_METHOD,QUANTITY,TARGET_DEPT_ID,MEMO_DT) 
				 SELECT 	  A.PRODUCT_CODE
				 , SP_ID='''+LTRIM(RTRIM((@NSPID))) +''' ,
				  NET_VALUE=ROUND(((A.PURCHASE_PRICE*A.INVOICE_QUANTITY)
							 -ISNULL(A.RMMDISCOUNTAMOUNT,0)
				             ),2),
				 A.ROW_ID,A.BILL_LEVEL_TAX_METHOD,A.QUANTITY ,B.PARTY_DEPT_ID,
				 B.RM_DT
				 FROM #tPrtDetTable  A
				 JOIN #tPrtMstTable B ON 1=1'
				 PRINT @DTSQL
				 EXEC SP_EXECUTESQL @DTSQL
	             

				 -- HSN CHANGES IN 6 DIGIT AS ON 01-04-2021 IN RETURN PICK GST FROM LAST PURCHASE as per sir

			 
				 SELECT @DINV_MODE=MODE,@CAC_CODE=Ac_code   FROM #TPRTMSTTABLE


				 IF ISNULL(@CPICKLASTTAX,'')='1'
				 BEGIN
				  
					 UPDATE A SET GST_PERCENTAGE =PID.GST_PERCENTAGE 
					 FROM GST_TAXINFO_CALC A
					 JOIN #TPRTDETTABLE B ON A.ROW_ID =B.ROW_ID 
					 JOIN PIM01106 PIM (NOLOCK) ON PIM.BILL_NO =B.BILL_NO AND PIM.INV_DT =B.BILL_DT 
					 JOIN PID01106 PID (NOLOCK) ON PIM.MRR_ID =PID.MRR_ID 
					 AND LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))=
					 LEFT(pid.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',pid.PRODUCT_CODE)-1,-1),LEN(pid.PRODUCT_CODE )))
					 WHERE PIM.CANCELLED =0 and pim.INV_MODE =@dinv_mode AND PIM.ac_code=@CAC_CODE
					 AND  A.SP_ID=LTRIM(RTRIM((@NSPID))) and @BREGISTERED_DELEER=1 and pim.receipt_dt >='2017-07-01'

				 END

				
				SET @CSTEP=144.2
				 -- BEFORE SIX MONTH TAX FREE
				
	            SET @CSTEP=148
	             --FOR OVER HEADS
		            SET @DTSQL=N'INSERT GST_TAXINFO_CALC_OH	( SP_ID, FREIGHT, OTHER_CHARGES, INSURANCE, PACKING ,OH_TAX_METHOD,DO_NOT_CALC_GST_OH,FREIGHT_HSN_CODE,OTHER_CHARGES_HSN_CODE,
					        MANUAL_GST_PER_FREIGHT,MANUAL_GST_PER_OTH,freight_gst_percentage,other_charges_gst_percentage)
		            SELECT 	 SP_ID='''+LTRIM(RTRIM((@NSPID))) +''', A.FREIGHT, A.OTHER_CHARGES, 0 AS INSURANCE, 0 AS  PACKING ,ISNULL(OH_TAX_METHOD,0),DO_NOT_CALC_GST_OH,
					FREIGHT_HSN_CODE,OTHER_CHARGES_HSN_CODE ,MANUAL_GST_PER_FREIGHT,MANUAL_GST_PER_OTH,freight_gst_percentage,other_charges_gst_percentage
		            FROM #tPrtMstTable A'
		            PRINT @DTSQL
				    EXEC SP_EXECUTESQL @DTSQL

				
				    
				 
			 END  
			 ELSE IF @CXN_TYPE='WSR'
			 BEGIN
	              
	             
				  SET @CSTEP=150
				  DELETE FROM GST_TAXINFO_CALC WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
				  DELETE FROM GST_TAXINFO_CALC_OH WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
	              DELETE FROM GST_TAXINFO_TAXFREE WHERE SP_ID=LTRIM(RTRIM((@NSPID)))
	              
				 SET @DTSQL=N'INSERT GST_TAXINFO_CALC	( PRODUCT_CODE, SP_ID, NET_VALUE,ROW_ID,TAX_METHOD,QUANTITY,MEMO_DT) 
				 SELECT 	  A.PRODUCT_CODE
				 , SP_ID='''+LTRIM(RTRIM((@NSPID))) +''',
				  NET_VALUE=ROUND(((A.NET_RATE*A.INVOICE_QUANTITY)
							  -ISNULL(A.CNMDISCOUNTAMOUNT,0)
				             ),2),
				 A.ROW_ID,A.BILL_LEVEL_TAX_METHOD,A.QUANTITY,
				 CASE WHEN A.INV_DT<=''2017-06-30'' THEN B.CN_DT ELSE A.INV_DT END 
				 FROM #tWsrDetTable a
				 JOIN #tWsrMstTable   B ON 1=1'
	             
				 PRINT @DTSQL
				 EXEC SP_EXECUTESQL @DTSQL
				 
				  SELECT @CAC_CODE=Ac_code   FROM #tWsrMstTable
				
				 IF ISNULL(@CPICKLASTTAX,'')='1'
				 BEGIN

					 UPDATE A SET GST_PERCENTAGE =ind.GST_PERCENTAGE 
					 FROM GST_TAXINFO_CALC A
					 JOIN #tWsrDetTable B ON A.ROW_ID =B.ROW_ID 
					 JOIN INM01106 inm (NOLOCK) ON inm.inv_no =B.inv_no AND inm.INV_DT =B.INV_DT 
					 JOIN IND01106 ind (NOLOCK) ON inm.inv_id =ind.inv_id 
					 AND LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))=
					 LEFT(ind.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',ind.PRODUCT_CODE)-1,-1),LEN(ind.PRODUCT_CODE )))
					 WHERE inm.CANCELLED =0
					 AND  A.SP_ID=LTRIM(RTRIM((@NSPID))) and @BREGISTERED_DELEER=1
					 and inm.inv_mode =1 and inm.ac_code =@CAC_CODE



				 end


				SET @CSTEP=166					 
				--FOR OVER HEADS
		         SET @DTSQL=N'INSERT GST_TAXINFO_CALC_OH	( SP_ID, FREIGHT, OTHER_CHARGES, INSURANCE, PACKING,OH_TAX_METHOD,DO_NOT_CALC_GST_OH ,
				                 other_charges_hsn_code, freight_hsn_code ,MANUAL_GST_PER_FREIGHT,MANUAL_GST_PER_OTH,
											other_charges_gst_percentage,freight_gst_percentage )
		         SELECT 	 SP_ID='''+LTRIM(RTRIM((@NSPID))) +''', A.FREIGHT, A.OTHER_CHARGES, A.INSURANCE, 0 AS  PACKING ,ISNULL(OH_TAX_METHOD,0),DO_NOT_CALC_GST_OH,
				             other_charges_hsn_code, freight_hsn_code,MANUAL_GST_PER_FREIGHT,MANUAL_GST_PER_OTH,
											other_charges_gst_percentage,freight_gst_percentage
		         FROM '+@CTEMPMASTERTABLE+' A '
		         PRINT @DTSQL
				 EXEC SP_EXECUTESQL @DTSQL
	          
			 END 
			
			 --------------
			 --SELECT * FROM   GST_TAXINFO_CALC_OH WHERE SP_ID='109'
            --@CPARTY_GSTN_NO
            
            DECLARE @SP_IDFILTER VARCHAR(100)
            SET @SP_IDFILTER=''
            
            SET @CSTEP=174
            
            IF @CXN_TYPE='PRT'
            BEGIN
                  SELECT  @CPARTYSTATE_CODE=CASE WHEN MODE=2 THEN ISNULL(L.GST_STATE_CODE,'') ELSE  ISNULL(B.AC_GST_STATE_CODE,'') END ,
                                        @CPARTY_GSTN_NO=CASE WHEN MODE=2 THEN ISNULL(L.LOC_GST_NO,'') ELSE  ISNULL(B.AC_GST_NO,'') END  ,
                                        @BPARTYREGISTERED=CASE WHEN MODE=2 THEN ISNULL(L.REGISTERED_GST,0) ELSE  ISNULL(B.REGISTERED_GST_DEALER,0) END 
                  FROM #tPrtMstTable A 
	              LEFT JOIN LMP01106 B (NOLOCK) ON A.AC_CODE=B.AC_CODE
	              LEFT JOIN LOCATION L (NOLOCK) ON L.DEPT_ID=A.PARTY_DEPT_ID 


				  if isnull(@CPARTY_GSTN_NO,'')<>''
				  SET @CPARTYSTATE_CODE=LEFT(@CPARTY_GSTN_NO,2)



                 
				  --IF EXISTS (SELECT TOP 1'U' FROM #TPRTMSTTABLE a 
				  --JOIN LMP01106 B (NOLOCK) ON A.SHIPPING_AC_CODE=b.AC_CODE
				  --WHERE RTRIM(LTRIM(ISNULL(A.SHIPPING_AC_CODE,''))) NOT IN('','0000000000') and isnull(CASE WHEN ISNULL(B.AC_GST_NO,'')<> '' THEN LEFT(AC_GST_NO,2) ELSE   B.AC_GST_STATE_CODE END,'')  <>'' )
				  --BEGIN
				  --     SELECT @CPARTYSTATE_CODE=CASE WHEN ISNULL(B.AC_GST_NO,'')<> '' THEN LEFT(AC_GST_NO,2) ELSE   B.AC_GST_STATE_CODE END  
					 --  FROM #TPRTMSTTABLE A
					 --  LEFT JOIN LMP01106 B (NOLOCK) ON A.SHIPPING_AC_CODE=b.AC_CODE
				  --END


            END
            ELSE
            BEGIN
			SET @CSTEP=176
				print 'read party state code for wsr'
                  SET @DTSQL=N' SELECT  @CPARTYSTATE_CODE=ISNULL(B.AC_GST_STATE_CODE,''''),
										@CPARTY_GSTN_NO=ISNULL(B.AC_GST_NO,''''),
                                        @BPARTYREGISTERED= ISNULL(REGISTERED_GST_DEALER,0)
                  FROM '+@CTEMPMASTERTABLE+' A 
	              JOIN LMP01106 B ON A.AC_CODE=B.AC_CODE '+@SP_IDFILTER
				  
				  print @dtsql
				  EXEC SP_EXECUTESQL @DTSQL,N'@CPARTYSTATE_CODE VARCHAR(10) OUTPUT,@CPARTY_GSTN_NO VARCHAR(50) OUTPUT,@BPARTYREGISTERED INT OUTPUT',
                  @CPARTYSTATE_CODE=@CPARTYSTATE_CODE OUTPUT,@CPARTY_GSTN_NO=@CPARTY_GSTN_NO OUTPUT,@BPARTYREGISTERED=@BPARTYREGISTERED OUTPUT
                  PRINT @DTSQL


            
            END
 
           -- SELECT @BPARTYREGISTERED
            
            IF @CXN_TYPE IN('WSR')
            BEGIN
              
                DECLARE @COUNTRY VARCHAR(10)
                SET @CSTEP=178
				SET @DTSQL=N'SELECT TOP 1 @COUNTRY=ISNULL(CON.COUNTRY_CODE,'''')
				FROM '+@CTEMPMASTERTABLE+' A 
				JOIN LMP01106 B (NOLOCK) ON A.AC_CODE=B.AC_CODE 
				LEFT OUTER JOIN AREA AR (NOLOCK) ON AR.AREA_CODE =B.AREA_CODE 
				LEFT OUTER JOIN CITY CT (NOLOCK) ON CT.CITY_CODE =AR.CITY_CODE 
				LEFT OUTER JOIN STATE ST (NOLOCK) ON ST.STATE_CODE =CT.STATE_CODE 
				LEFT OUTER JOIN REGIONM R (NOLOCK) ON R.REGION_CODE =ST.REGION_CODE
				LEFT OUTER JOIN COUNTRY CON (NOLOCK) ON CON.COUNTRY_CODE=R.COUNTRY_CODE '
				EXEC SP_EXECUTESQL @DTSQL,N'@COUNTRY VARCHAR(10) OUTPUT',@DTSQL OUTPUT
				
				
				 IF ISNULL(@COUNTRY,'') NOT IN('0000000','')
				 BEGIN
				  
				  SET @CSTEP=180
				  UPDATE A SET HSN_CODE='0000000000',GST_PERCENTAGE=0,IGST_AMOUNT=0,
			      CGST_AMOUNT=0,SGST_AMOUNT=0,
			      XN_VALUE_WITHOUT_GST=A.NET_VALUE,XN_VALUE_WITH_GST=A.NET_VALUE    
			      FROM GST_TAXINFO_CALC A WITH (ROWLOCK)
			      WHERE SP_ID=@NSPID
			      
			      UPDATE A SET FREIGHT_TAXABLE_VALUE=ISNULL(FREIGHT,0),
			      OTHER_CHARGES_TAXABLE_VALUE=ISNULL(OTHER_CHARGES,0),
			      INSURANCE_TAXABLE_VALUE=ISNULL(INSURANCE,0),
			      PACKING_TAXABLE_VALUE=ISNULL(PACKING,0),
			      FREIGHT_GST_AMOUNT=0,
			      OTHER_CHARGES_GST_AMOUNT=0,
			      INSURANCE_GST_AMOUNT=0,
			      PACKING_GST_AMOUNT=0
			      FROM GST_TAXINFO_CALC_OH A WITH (ROWLOCK)
			      WHERE SP_ID=@NSPID
			      
			      RETURN
				 END
            
            END

            SET @CSTEP=182
            
            SET @DTSQL=N' UPDATE  '+@CTEMPMASTERTABLE+' SET PARTY_STATE_CODE='+(case when @CPARTYSTATE_CODE<>'' then
			''''+RTRIM(LTRIM(@CPARTYSTATE_CODE))+'''' else '''00''' end)+@SP_IDFILTER
            PRINT @DTSQL 
            EXEC SP_EXECUTESQL @DTSQL 
                   
			            
			--DECLARE @BYPASS_SIX_MONTH_RESTRICTION_DN VARCHAR(5)
			--SELECT TOP 1 @BYPASS_SIX_MONTH_RESTRICTION_DN=VALUE  FROM CONFIG WHERE CONFIG_OPTION= 'BYPASS_SIX_MONTH_RESTRICTION_DN'

   --         IF ISNULL(@CPARTY_GSTN_NO,'')<>ISNULL(@CLOC_GSTN_NO,'') AND   @CXN_TYPE IN('PRT') AND @NDNTYPE =1 AND ISNULL(@BYPASS_SIX_MONTH_RESTRICTION_DN,'')<>'1'
   --         BEGIN
			--SET @CSTEP=184
			--	IF EXISTS (SELECT TOP 1 'U' FROM #TMPRMDNOGSTCALC WHERE SR=100)--100 MARK AS BEFORE 6 MONTH PURCHASE
			--	BEGIN
			--		SET @CERRMSG='PURCHASE RETURN DOES NOT ALLOW SIX MONTH OLD BILL DATE.'
			--		RETURN
			--	END
			--END
			
		 -- IF ISNULL(@CPARTY_GSTN_NO,'')<>ISNULL(@CLOC_GSTN_NO,'') AND   @CXN_TYPE IN('WSR') AND ISNULL(@BYPASS_SIX_MONTH_RESTRICTION_DN,'')<>'1'
   --         BEGIN
			--	IF EXISTS (SELECT TOP 1 'U' FROM #TMPCNDNOGSTCALC WHERE SR=100)--100 MARK AS BEFORE 6 MONTH WSL
			--	BEGIN
			--		SET @CERRMSG='WHOSALE RETURN DOES NOT ALLOW SIX MONTH OLD BILL DATE.'
			--		RETURN
			--	END
			--END
            
            SET @CSTEP=186
   --         DECLARE @DONOT_CREATE_DN_FOR_VAT_PUR VARCHAR(5)
   --         SELECT TOP 1 @DONOT_CREATE_DN_FOR_VAT_PUR=VALUE  FROM CONFIG WHERE CONFIG_OPTION= 'DONOT_CREATE_DN_FOR_VAT_PUR'
   --         IF ISNULL(@CPARTY_GSTN_NO,'')<>ISNULL(@CLOC_GSTN_NO,'') AND   @CXN_TYPE IN('PRT') AND ISNULL(@DONOT_CREATE_DN_FOR_VAT_PUR,'')='1'
   --         BEGIN
			--	IF EXISTS (SELECT TOP 1 'U' FROM #TMPRMDNOGSTCALC WHERE SR=100 AND BILL_DT<='2017-06-30')
			--	BEGIN
			--		SET @CERRMSG='PURCHAE RETURN DOES NOT ALLOW VAT PURCHASE.'
			--		RETURN
			--	END
			--END
			
		 -- IF ISNULL(@CPARTY_GSTN_NO,'')<>ISNULL(@CLOC_GSTN_NO,'') AND   @CXN_TYPE IN('WSR') AND ISNULL(@DONOT_CREATE_DN_FOR_VAT_PUR,'')='1'
   --         BEGIN
			--	IF EXISTS (SELECT TOP 1 'U' FROM #TMPCNDNOGSTCALC WHERE SR=100 AND INV_DT <='2017-06-30')
			--	BEGIN
			--		SET @CERRMSG='WHOSALE RETURN DOES NOT ALLOW VAT INOICE.'
			--		RETURN
			--	END
			--END

			  if @CXN_TYPE='pur' and @CPARTYSTATE_CODE<>'96'
			  begin

			       DECLARE @CSUPPLY_STATE_CODE VARCHAR(2)

			       SET @DTSQL=N' SELECT  @CSUPPLY_STATE_CODE=ISNULL(SUPPLY_STATE_CODE,'''')
                  FROM '+@CTEMPMASTERTABLE+' A '+@SP_IDFILTER
				  EXEC SP_EXECUTESQL @DTSQL,N'@CSUPPLY_STATE_CODE VARCHAR(2) OUTPUT',@CSUPPLY_STATE_CODE=@CSUPPLY_STATE_CODE OUTPUT
                  PRINT @DTSQL

				  if isnull(@CSUPPLY_STATE_CODE,'') not in('','00')
				     set @CPARTYSTATE_CODE=@CSUPPLY_STATE_CODE


				end 


			SET @CSTEP=188
			
              
            EXEC SP3S_GST_TAX_CAL @CXN_TYPE,'',@DMEMO_DT,@NSPID,@CPARTYSTATE_CODE,0,@BPARTYREGISTERED,@CPARTY_GSTN_NO,@CERRMSG OUTPUT,@cLocationId
       END
		
	   SET @CSTEP=190		
	   DELETE FROM gst_xns_hsn WITH (ROWLOCK) WHERE sp_id=@nSpId	 
  END TRY  
  BEGIN CATCH
  print 'enter catch of sp3s_gst_tax_cal'
   SELECT @CERRMSG='ERROR MESSAGE IN PROCEDURE SP3S_GST_TAX_CAL STEP#'+@CSTEP+' '+CAST(ERROR_MESSAGE() AS VARCHAR(1000))
   PRINT 'ENTER CATCH IN SP3S_GST_TAX_CAL line#'+error_message()
  END CATCH  
  
END