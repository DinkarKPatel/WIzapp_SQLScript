CREATE PROCEDURE SP_POSTSALES_JOB_WORK_ISSUE_4 
(
  @IMODE INT ,        
  @CWHERE VARCHAR(4000)='',    
  @CAGENCYCODE CHAR(7)='',    
  @BMODE BIT = 0 ,  
  @FINYEAR VARCHAR(10)=''  ,  
  @DEPTID VARCHAR(10)='' 
)
AS
BEGIN
   
  IF OBJECT_ID ('TEMPDB..#ISSUEDFROMAPPROVED','U') IS NOT NULL
     DROP TABLE #ISSUEDFROMAPPROVED

	 SELECT a.product_code,B.product_code as CMD_PRODUCT_CODE, a.ROW_ID 
	 INTO #ISSUEDFROMAPPROVED 
	 FROM hold_back_deliver_det a (nolock)
	 join hold_back_deliver_mst hm (nolock) on a.memo_id =hm.memo_id 
	 join ITEM_STATUS it (nolock) on it.HBD_MEMO_ID =a.memo_id and it.HBD_ROW_ID =a.row_id 
	 LEFT JOIN CMD01106 B (NOLOCK) ON A.REF_CMD_ROW_ID =B.ROW_ID   
	 WHERE (A.PRODUCT_CODE=@CWHERE OR B.PRODUCT_CODE=@CWHERE OR B.PRODUCT_CODE LIKE @CWHERE+'@%' ) AND HM.CANCELLED=0
	 and ISNULL(it.DELIVER_MEMO_ID,'') ='' 
    AND (ISNULL(it.ISSUE_ID,'')='' OR ISNULL(it.RECEIPT_ID,'')<>'')
	order by hm.memo_id desc


  EXEC SP_HOLDBACK_PENDING_FOR_ISSUE '','','','',@DEPTID,'',@CAGENCYCODE

RETURN

--THIS CODE WILL NOT IN USE HOLD BACK & REPAIR MODULE CHANGES NEW METHOD

	;WITH POST_SALES_DET
	AS
	(
		SELECT REF_HBD_ROW_ID 
		FROM  POST_SALES_JOBWORK_ISSUE_DET A  (NOLOCK)  
		JOIN POST_SALES_JOBWORK_ISSUE_MST B  (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID  
		WHERE A.PRODUCT_CODE=@CWHERE AND B.CANCELLED=0
	),
	DELIVERY_DET
	AS
	(
		SELECT A.REF_HBD_ROW_ID FROM SLS_DELIVERY_DET A (NOLOCK)  
		JOIN SLS_DELIVERY_MST B (NOLOCK) ON B.MEMO_ID = A.MEMO_ID   
		JOIN HOLD_BACK_DELIVER_DET C (NOLOCK) ON C.ROW_ID=A.REF_HBD_ROW_ID  
		WHERE C.PRODUCT_CODE=@CWHERE AND B.CANCELLED=0
	)
	--CMD
	--AS
	--(
	--	SELECT M.CM_ID,C.ROW_ID,M.fin_year,M.CM_NO,C.PRODUCT_CODE,C.EMP_CODE  ,M.CUSTOMER_CODE,C.MRP,
	--	ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
	--	PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
	--	CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,SKU.PURCHASE_PRICE,      
	--	SKU.MRP AS SKU_MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
	--	P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
	--	PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
	--	ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
	--	ART.STOCK_NA,ART.ALIAS AS ARTICLE_ALIAS,EMP.emp_name,
	--	(CUST.CUSTOMER_FNAME +' '+ CUST.CUSTOMER_LNAME) AS CUST_NAME,CUST.MOBILE
	--	FROM  CMD01106 C (NOLOCK)          
	--	JOIN CMM01106 M (NOLOCK) ON C.CM_ID = M.CM_ID 
	--	join hold_back_deliver_det hd (nolock) on hd.ref_cmd_row_id=c.ROW_ID 
	--	JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=C.PRODUCT_CODE      
	--	JOIN ARTICLE ART (NOLOCK)  ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE          
	--	JOIN SECTIOND SD (NOLOCK)  ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
	--	JOIN SECTIONM SM (NOLOCK)  ON SD.SECTION_CODE = SM.SECTION_CODE        
	--	JOIN PARA1 P1 (NOLOCK)  ON SKU.PARA1_CODE = P1.PARA1_CODE          
	--	JOIN PARA2 P2 (NOLOCK)  ON SKU.PARA2_CODE = P2.PARA2_CODE          
	--	JOIN PARA3 P3 (NOLOCK)  ON SKU.PARA3_CODE = P3.PARA3_CODE          
	--	JOIN PARA4 P4 (NOLOCK)  ON SKU.PARA4_CODE = P4.PARA4_CODE          
	--	JOIN PARA5 P5 (NOLOCK)  ON SKU.PARA5_CODE = P5.PARA5_CODE          
	--	JOIN PARA6 P6 (NOLOCK)  ON SKU.PARA6_CODE = P6.PARA6_CODE          
	--	JOIN UOM E (NOLOCK)  ON ART.UOM_CODE = E.UOM_CODE        
	--	LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK)  ON EMP.EMP_CODE=C.EMP_CODE       
	--	LEFT OUTER JOIN CUSTDYM CUST (NOLOCK)  ON (CUST.CUSTOMER_CODE = M.CUSTOMER_CODE AND M.CUSTOMER_CODE <>'000000000000')  
	--	   --OR (CUST.CUSTOMER_CODE = A.CUSTOMER_CODE AND ISNULL(A.Entry_mode,0) <>2 )  
	--	WHERE hd.PRODUCT_CODE=@CWHERE AND M.CANCELLED=0 --AND M.cm_id='03011200000301-0003723' 
	--),
	--HOLD_BACK_DET
	--AS
	--(
	--	SELECT B.*--.REF_CMD_ROW_ID,A.memo_id ,B.JOB_CODE,B.ROW_ID
	--	FROM HOLD_BACK_DELIVER_DET B (NOLOCK)             
	--	JOIN HOLD_BACK_DELIVER_MST A (NOLOCK) ON A.MEMO_ID = B.MEMO_ID
	--	join pmt01106 pmt (nolock) on b.product_code =pmt.product_code and a.BIN_ID =pmt.BIN_ID
	--	WHERE A.cancelled=0  AND B.DELIVERED=0  AND ISNULL(A.MODE,0)<>2   and pmt.quantity_in_stock >0
	--	AND ISNULL(B.REF_CMD_ROW_ID,'')<>''
	--)
	------SELECT * FROM SLS_DELIVERY_DET
	------SELECT * FROM HOLD_BACK_DET    
	--SELECT CAST(0 AS BIT) AS CHKBILL,C.CM_ID,C.CM_NO,B.*,C.PRODUCT_CODE,    
	--CAST('1.00' AS NUMERIC(10,2)) AS QUANTITY,C.MRP,          
	--C.ARTICLE_CODE, C.ARTICLE_NO, C.ARTICLE_NAME, C.PARA1_CODE,        
	--PARA1_NAME, C.PARA2_CODE,PARA2_NAME,C.PARA3_CODE,PARA3_NAME,UOM_NAME,           
	--CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,C.PURCHASE_PRICE,      
	--C.MRP,C.WS_PRICE,   C.SECTION_NAME, C.SUB_SECTION_NAME,        
	--C.PARA4_CODE,C.PARA5_CODE,C.PARA6_CODE,        
	--PARA4_NAME,PARA5_NAME,PARA6_NAME,C.UOM_CODE,ISNULL(C.UOM_TYPE,0) AS [UOM_TYPE],        
	--C.ART_DT_CREATED,C.PARA3_DT_CREATED,C.SKU_DT_CREATED,          C.STOCK_NA,C.EMP_NAME ,L.JOB_NAME ,0 AS JOB_RATE,  
	--C.FIN_YEAR ,C.CUST_NAME,C.MOBILE, C.ARTICLE_ALIAS 
	--FROM HOLD_BACK_DET B
	--JOIN CMD C ON C.ROW_ID = B.REF_CMD_ROW_ID  
	--JOIN JOBS L (NOLOCK)  ON B.JOB_CODE=L.JOB_CODE     
	--LEFT OUTER JOIN POST_SALES_DET ISU ON B.ROW_ID  = ISU.REF_HBD_ROW_ID  
	--LEFT OUTER JOIN DELIVERY_DET DLV  ON DLV.REF_HBD_ROW_ID=B.ROW_ID              
	   
	--WHERE  C.PRODUCT_CODE=@CWHERE   
	--AND (ISU.REF_HBD_ROW_ID IS NULL OR DLV.REF_HBD_ROW_ID IS NULL)  
	---- AND  A.CANCELLED = 0 AND B.DELIVERED=0  AND ISNULL(A.MODE,0)<>2  
	  
	--UNION  

	SELECT CAST(0 AS BIT) AS CHKBILL,cmm.cm_id  AS CM_ID,cmm.cm_no AS CM_NO,B.*,C.PRODUCT_CODE,    
	CAST('1.00' AS NUMERIC(10,2)) AS QUANTITY,0 AS MRP,          
	ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME,'0000000' AS PARA1_CODE,        
	'' AS PARA1_NAME,'0000000' AS PARA2_CODE,'' AS PARA2_NAME,'0000000' AS PARA3_CODE,'' AS PARA3_NAME,  
	UOM_NAME,CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,0 AS PURCHASE_PRICE,      
	0 AS MRP,0 AS WS_PRICE,SM.SECTION_NAME, SD.SUB_SECTION_NAME,'0000000' AS PARA4_CODE,'0000000' AS PARA5_CODE,  
	'0000000'  AS PARA6_CODE,'' AS PARA4_NAME,'' AS PARA5_NAME,'' AS PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
	ART.DT_CREATED AS [ART_DT_CREATED],'' AS [PARA3_DT_CREATED],'' AS [SKU_DT_CREATED],        
	ART.STOCK_NA,'' AS EMP_NAME ,L.JOB_NAME ,0 AS JOB_RATE,  
	A.FIN_YEAR ,(CUST.CUSTOMER_FNAME +' '+ CUST.CUSTOMER_LNAME) AS CUST_NAME,CUST.MOBILE,  
	ART.ALIAS AS ARTICLE_ALIAS        
	FROM HOLD_BACK_DELIVER_MST A (NOLOCK)             
	JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID  
	left join cmd01106 cmd(nolock) on cmd.ROW_ID=b.ref_cmd_row_id
	left join cmm01106 cmm (nolock) on cmm.cm_id =cmd.cm_id 
	join pmt01106 pmt (nolock) on b.product_code =pmt.product_code and a.BIN_ID =pmt.BIN_ID AND PMT.DEPT_ID=@DEPTID          
	JOIN sku C ON C.PRODUCT_CODE=B.PRODUCT_CODE      
	JOIN ARTICLE ART ON C.ARTICLE_CODE = ART.ARTICLE_CODE          
	JOIN SECTIOND SD ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
	JOIN SECTIONM SM ON SD.SECTION_CODE = SM.SECTION_CODE        
	JOIN UOM E ON ART.UOM_CODE = E.UOM_CODE       
	JOIN JOBS L ON B.JOB_CODE=L.JOB_CODE        
	LEFT OUTER JOIN CUSTDYM CUST ON CUST.CUSTOMER_CODE = A.CUSTOMER_CODE  
	LEFT OUTER JOIN POST_SALES_DET ISU ON B.ROW_ID  = ISU.REF_HBD_ROW_ID  
	LEFT OUTER JOIN DELIVERY_DET DLV  ON DLV.REF_HBD_ROW_ID=B.ROW_ID                
	WHERE  C.PRODUCT_CODE=@CWHERE AND (ISU.REF_HBD_ROW_ID IS NULL OR DLV.REF_HBD_ROW_ID IS NULL)  
	AND  A.CANCELLED = 0 AND B.DELIVERED=0 and pmt.quantity_in_stock>0


END        