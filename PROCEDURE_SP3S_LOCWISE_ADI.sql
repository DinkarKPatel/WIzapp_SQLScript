CREATE PROCEDURE SP3S_LOCWISE_ADI
(
	 @DPROCESSDT DATETIME
	,@CFILTER VARCHAR(MAX)=''
	,@CMODE CHAR(1)=0
	,@CLAYOUT VARCHAR(1000)=''
	,@BREPROCESS BIT=0
	,@CPROCESSID VARCHAR(50) OUTPUT	
	,@CERRMSG VARCHAR(1000) OUTPUT	
)
--WITH ENCRYPTION
AS
/*
	THIS PROCEDURE PROCESSES ADI AND STORES IT IN ADI_MST AND ADI_DET
*/
BEGIN
	DECLARE @CSTEP VARCHAR(5)
	BEGIN TRY
	SET @CSTEP=10
	
	IF ISNULL(@DPROCESSDT,'')=''
	BEGIN
		SET @CERRMSG='P:SP3S_LOCWISE_ADI,'+CHAR(13)+'STEP:'+@CSTEP+','+CHAR(13)+'MESSAGE:NO PROCESS DATE DEFINED.'
		GOTO EXIT_PROC
	END	 
	
	SET @CSTEP=20
	SET @DPROCESSDT=DATEADD(DD,0,DATEDIFF(DD,0,@DPROCESSDT))
	
	SET @CSTEP=30
	IF OBJECT_ID('TEMPDB..#TMPADI3','U') IS NOT NULL
		DROP TABLE #TMPADI3	
	
	SET @CSTEP=40	
	IF OBJECT_ID('TEMPDB..#TMPCBSPP','U') IS NOT NULL
		DROP TABLE #TMPCBSPP
	
	SET @CSTEP=50
	CREATE TABLE #TMPADI3(PARA_NAME VARCHAR(100),ADI NUMERIC(18,4))	
	CREATE TABLE #TMPCBSPP(PARA_NAME VARCHAR(100),CBS_VALUE NUMERIC(18,4))	
	
	SET @CSTEP=80
	SELECT @CPROCESSID=PROCESS_ID FROM ADI_MST WHERE PROCESS_DT=@DPROCESSDT AND LAYOUT=@CLAYOUT AND MODE=@CMODE
	
	SET @CSTEP=85
	IF @BREPROCESS=1 AND ISNULL(@CPROCESSID,'')<>''
	BEGIN
		DELETE ADI_DET WHERE PROCESS_ID=@CPROCESSID	
		DELETE ADI_MST WHERE PROCESS_ID=@CPROCESSID	
		SET @CPROCESSID=''
	END
	
	SET @CSTEP=90
	IF ISNULL(@CPROCESSID,'')=''
	BEGIN
		EXEC SPCALCULATE_ADI '',@DPROCESSDT,@CFILTER,@CMODE,@CLAYOUT		
	END
	ELSE 
		RETURN
	
	SET @CSTEP=100
	IF EXISTS(SELECT TOP 1 'U' FROM #TMPADI3)
	BEGIN
		SET @CSTEP=110
		SET @CPROCESSID='ADI'+CONVERT(VARCHAR(40),NEWID())	
		SET @CSTEP=120
		INSERT ADI_MST(PROCESS_ID,PROCESS_DT,LAYOUT,FILTER,MODE)
			SELECT  @CPROCESSID,@DPROCESSDT,@CLAYOUT,@CFILTER,@CMODE
		
		SET @CSTEP=130	
		INSERT ADI_DET(PROCESS_ID,LAYOUT_VALUE,ADI_VALUE,CBS_VALUE)
		SELECT @CPROCESSID,A.PARA_NAME,ADI,CBS_VALUE FROM #TMPADI3 A 
		LEFT JOIN #TMPCBSPP B ON A.PARA_NAME=B.PARA_NAME	
		WHERE ADI<>0
	END
	END TRY
	BEGIN CATCH
		SET @CERRMSG='P:SP3S_LOCWISE_ADI,'+CHAR(13)+'STEP:'+@CSTEP+','+CHAR(13)+'MESSAGE:'+ERROR_MESSAGE()
		GOTO EXIT_PROC
	END CATCH
EXIT_PROC:

END
---END OF PROCEDURE - SP3S_LOCWISE_ADI
