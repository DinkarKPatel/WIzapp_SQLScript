CREATE PROCEDURE CrossTabStr 
(
	@CTABLENAME VARCHAR(50), 
	@CCROSSPARA VARCHAR(50), 
	@CCROSSPARAORDER VARCHAR(50) = '', 
	@CCELLCOLUMN1 VARCHAR(50), 
	@CCELLCOLUMN2 VARCHAR(50) = '', 
	@CCELLCOLUMN3 VARCHAR(50) = '',
	@CRETCOLSTR NVARCHAR(MAX) OUTPUT,
	--SECOND PIVOT COL
	@CCROSSPARA2 VARCHAR(50)='', 
	@CCELLCOLUMN1_PARA2 VARCHAR(50)=''
	--SECOND PIVOT COL
)
----WITH ENCRYPTION
AS
BEGIN
    SET NOCOUNT ON
	--******** PARAMETERS
	-- @CTABLENAME :		SOURCE TABLE IN WHICH THE DATA LIES IN TABULAR FORMAT
	-- @CCROSSPARA :		NAME OF COLUMN ON WHICH YOU WANT TO GENERATE CROSS TAB
	-- @CCROSSPARAORDER :	NAME OF COLUMN FOR THE ORDER OF CROSSTAB PARA
	--						IF LEFT BLANK, IT WILL ORDERED ON COLUMN SPECIFIED IN CROSSTABPARA
	-- @CCELLCOLUMN1 :		COLUMN1 OF VALUE TO BE DISPLAYED AS CELLVALUE
	-- @CCELLCOLUMN2 :		COLUMN2 OF VALUE TO BE DISPLAYED AS CELLVALUE (OPTIONAL)
	-- @CCELLCOLUMN3 :		COLUMN2 OF VALUE TO BE DISPLAYED AS CELLVALUE (OPTIONAL)
	-- @CRETCOLSTR :		OUTPUT VARCHAR TYPE VARIABLE FOR RETURN OF THE STRING

	--**** NOTE
	-- PLEASE NOTE, THIS PROCEDURE WILL GENERATE A PERMANENT TABLE NAMED #crosstabstr
	-- WHICH CONTAINS THE ACTUAL NAMES OF CROSS TAB COLUMNS, 
	-- AS THE COLUMN WILL BE GENERATED WITH HARDCODED ALIAS E.G COL1, COL2 ETC.

	-- ACTUAL PROCESSING STARTS HERE...
	--******** START OF BATCH
	DECLARE @CCOL VARCHAR(40), 
			@CCOL2 VARCHAR(40), 
			@CCOL3 VARCHAR(40), 
			@CCOL4 VARCHAR(40), 
			@CCMD NVARCHAR(4000), 
			@NCOLCOUNTER NUMERIC(3), 
			@CCOLALIAS VARCHAR(20),
			@CRETCOLSTR2 NVARCHAR(MAX)=N''
			

	
	

	SET @CRETCOLSTR = N''
	SET @NCOLCOUNTER = 1

	IF @CCROSSPARAORDER = ''
		SET @CCROSSPARAORDER = @CCROSSPARA


	IF @CCROSSPARAORDER= 'MONTHNO_DTNAME'
	    SET @CCMD = N'
				DECLARE CUR_CT CURSOR FOR
				SELECT DISTINCT ISNULL(A.' + @CCROSSPARA + ','''') AS COL1, ISNULL(A.' + @CCROSSPARAORDER + ',''0'') AS COL2,YEAR_DTNAME,MONTHNO_DTNAME FROM ' + @CTABLENAME + ' A ORDER BY 3,4'
	
    ELSE
	   SET @CCMD = N'
				DECLARE CUR_CT CURSOR FOR
				SELECT DISTINCT ISNULL(A.' + @CCROSSPARA + ','''') AS COL1, ISNULL(A.' + @CCROSSPARAORDER + ',''0'') AS COL2,'''' AS COL3,'''' AS COL4  FROM ' + @CTABLENAME + ' A ORDER BY 2'
	
	
	
	EXEC SP_EXECUTESQL @CCMD

	OPEN CUR_CT

	FETCH NEXT FROM CUR_CT INTO @CCOL, @CCOL2, @CCOL3, @CCOL4
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @CCOLALIAS = 'COL_' + CAST(@NCOLCOUNTER AS VARCHAR(10))

		INSERT #CROSSTABHEADERS VALUES ( @CCOL, @CCOLALIAS)

		SET @CRETCOLSTR = @CRETCOLSTR + (CASE WHEN @CRETCOLSTR<>'' THEN N', ' ELSE '' END )+N'
							SUM( CASE WHEN ' + @CCROSSPARA + ' = ''' + @CCOL + ''' THEN ' + @CCELLCOLUMN1 + ' ELSE 0 END ) AS ' + '['+@CCELLCOLUMN1 + '_' + @CCOLALIAS + ']'
		IF @CCELLCOLUMN2 <> ''
			SET @CRETCOLSTR = @CRETCOLSTR + ( CASE WHEN @CRETCOLSTR<>'' THEN N', ' ELSE '' END )+ N'
								SUM( CASE WHEN ' + @CCROSSPARA + ' = ''' + @CCOL + ''' THEN ' + @CCELLCOLUMN2 + ' ELSE 0 END ) AS ' + '[' + @CCELLCOLUMN2 + '_' + @CCOLALIAS + ']'
		IF @CCELLCOLUMN3 <> ''
			SET @CRETCOLSTR = @CRETCOLSTR + ( CASE WHEN @CRETCOLSTR<>'' THEN N', ' ELSE '' END ) + N'
								SUM( CASE WHEN ' + @CCROSSPARA + ' = ''' + @CCOL + ''' THEN ' + @CCELLCOLUMN3 + ' ELSE 0 END ) AS ' + '[' +@CCELLCOLUMN3 + '_' + @CCOLALIAS + ']'
		
		--SECOND PIVOT COL
		IF @CCROSSPARA2 <> ''
		   SET @CRETCOLSTR2 = @CRETCOLSTR2 + ( CASE WHEN @CRETCOLSTR2<>'' THEN N', ' ELSE '' END )+ N'
							SUM( CASE WHEN ' + @CCROSSPARA2 + ' = ''' + @CCOL + ''' THEN ' + @CCELLCOLUMN1_PARA2 + ' ELSE 0 END ) AS ' + '[' + @CCELLCOLUMN1_PARA2 + '_' + @CCOLALIAS + ']'
		--SECOND PIVOT COL
		
		SET @NCOLCOUNTER = @NCOLCOUNTER + 1

		FETCH NEXT FROM CUR_CT INTO @CCOL, @CCOL2, @CCOL3, @CCOL4
	END
	CLOSE CUR_CT
	DEALLOCATE CUR_CT
	
	IF @CRETCOLSTR2<>''
	   SET @CRETCOLSTR2 = @CRETCOLSTR2 + ( CASE WHEN @CRETCOLSTR2<>'' THEN N', ' ELSE '' END )+N'
							SUM('+@CCELLCOLUMN1_PARA2+') AS TOTAL_'+@CCELLCOLUMN1_PARA2
	IF @CRETCOLSTR2<>'' 
	   SET @CRETCOLSTR = @CRETCOLSTR + ( CASE WHEN @CRETCOLSTR<>'' THEN N', ' ELSE '' END )+N'
							SUM('+@CCELLCOLUMN1+') AS TOTAL_'+@CCELLCOLUMN1
							+ ( CASE WHEN @CRETCOLSTR2<>'' THEN N', ' ELSE '' END )+@CRETCOLSTR2
	SET NOCOUNT OFF
END
