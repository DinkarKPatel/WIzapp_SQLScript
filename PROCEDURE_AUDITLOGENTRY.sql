CREATE PROCEDURE AUDITLOGENTRY
(
	@CXNTYPE VARCHAR(10), 
	@CXNID VARCHAR(50), 
	@CDEPTID VARCHAR(10),
	@CCOMPUTERNAME VARCHAR(100), 
	@CWINUSERNAME VARCHAR(100), 
	@CWIZUSERCODE VARCHAR(10),
	@BCREATEMERGELOGENTRY BIT=0 
)
--WITH ENCRYPTION
AS 
BEGIN
	SET NOCOUNT ON

	IF @CXNTYPE NOT IN ('SLS','WSL', 'WSR','CHO', 'VCH','PUR','PRT')
		GOTO LAST
		
	DECLARE @ROWID VARCHAR(1000),@COL_LIST VARCHAR(2000),@MODE VARCHAR(100),@CNT_NEW INT,@CNT_OLD INT
	,@HDR_TAB VARCHAR(100),@HDR_KEY VARCHAR(500)
	,@DTL_TAB VARCHAR(100),@DTL_KEY VARCHAR(500)
	
	DECLARE @TABLELIST TABLE ( TABLENAME VARCHAR(50), WHERECLAUSE VARCHAR(2000) )
	DECLARE @TABCOLLIST TABLE ( COLNAME VARCHAR(50) )
	DECLARE @CTABLENAME		VARCHAR(100),
			@CAUDITTABLENAME VARCHAR(100),
			@CPRIMEAUDITTABLE VARCHAR(100),
			@CCOLLIST		VARCHAR(MAX), 
			@CCOLLISTVALUE  VARCHAR(MAX),
			@CAUDITCOLLIST	VARCHAR(MAX),
			@CCMD			NVARCHAR(MAX),
			@CAUDITID		VARCHAR(10),
			@CWHERECLAUSE	VARCHAR(2000),
			@CREFXNID		VARCHAR(50),
			@CPREFIX		VARCHAR(20),
			@CAUDITTABLESUFFIX VARCHAR(300),
			@CAUDITTABLENAMEMERGE	VARCHAR(1000)

	SET @CAUDITTABLESUFFIX='_AUDIT'
	
	IF @CXNTYPE = 'SLS'		-- CASHMEMO
	BEGIN
		INSERT @TABLELIST VALUES ( 'CMM01106', 'CM_ID = ''' + @CXNID + '''' )
		INSERT @TABLELIST VALUES ( 'CMD01106', 'CM_ID = ''' + @CXNID + '''' )
		--INSERT @TABLELIST VALUES ( 'CMA01106', 'CM_ID = ''' + @CXNID + '''' )
		--INSERT @TABLELIST VALUES ( 'CMR01106', 'CM_ID = ''' + @CXNID + ''' OR REF_CM_ID = ''' + @CXNID + '''' )
		SET @CPRIMEAUDITTABLE = 'CMM01106'+@CAUDITTABLESUFFIX
	END
	ELSE
	IF @CXNTYPE = 'CHO'		-- CHALLAN OUT
	BEGIN
		INSERT @TABLELIST VALUES ( 'COM01106', 'CHALLAN_ID = ''' + @CXNID + '''' )
		INSERT @TABLELIST VALUES ( 'COD01106', 'CHALLAN_ID = ''' + @CXNID + '''' )
		SET @CPRIMEAUDITTABLE = 'COM01106'+@CAUDITTABLESUFFIX
	END
	ELSE
	IF @CXNTYPE = 'WSL'		-- WHOLESALE INVOICE
	BEGIN
		INSERT @TABLELIST VALUES ( 'INM01106', 'INV_ID = ''' + @CXNID + '''' )
		INSERT @TABLELIST VALUES ( 'IND01106', 'INV_ID = ''' + @CXNID + '''' )
		SET @CPRIMEAUDITTABLE = 'INM01106'+@CAUDITTABLESUFFIX
	END
	ELSE
	IF @CXNTYPE = 'WSR'		-- WHOLESALE CREDIT NOTE
	BEGIN
		INSERT @TABLELIST VALUES ( 'CNM01106', 'CN_ID = ''' + @CXNID + '''' )
		INSERT @TABLELIST VALUES ( 'CND01106', 'CN_ID = ''' + @CXNID + '''' )
		SET @CPRIMEAUDITTABLE = 'CNM01106'+@CAUDITTABLESUFFIX
	END
	ELSE
	IF @CXNTYPE = 'PUR'		-- PURCHASE INVOICE
	BEGIN
		INSERT @TABLELIST VALUES ( 'PIM01106', 'MRR_ID = ''' + @CXNID + '''' )
		INSERT @TABLELIST VALUES ( 'PID01106', 'MRR_ID = ''' + @CXNID + '''' )
		SET @CPRIMEAUDITTABLE = 'PIM01106'+@CAUDITTABLESUFFIX
	END
	ELSE
	IF @CXNTYPE = 'PRT'		-- DEBIT NOTE
	BEGIN
		INSERT @TABLELIST VALUES ( 'RMM01106', 'RM_ID = ''' + @CXNID + '''' )
		INSERT @TABLELIST VALUES ( 'RMD01106', 'RM_ID = ''' + @CXNID + '''' )
		SET @CPRIMEAUDITTABLE = 'RMM01106'+@CAUDITTABLESUFFIX
	END
	ELSE
	IF @CXNTYPE = 'VCH'		-- VOUCHER ENTRY
	BEGIN
		INSERT @TABLELIST VALUES ( 'VM01106', 'VM_ID = ''' + @CXNID + '''' )
		INSERT @TABLELIST VALUES ( 'VD01106', 'VM_ID = ''' + @CXNID + '''' )
		INSERT @TABLELIST VALUES ( 'VDN01106', 'VD_ID IN ( SELECT VD_ID FROM VD01106 WHERE VM_ID = ''' + @CXNID + ''')' )
		INSERT @TABLELIST VALUES ( 'VDA01106', 'VD_ID IN ( SELECT VD_ID FROM VD01106 WHERE VM_ID = ''' + @CXNID + ''')' )

		SELECT @CREFXNID = VM_ID FROM VM01106 WHERE REF_VM_ID = @CXNID
		IF @CREFXNID IS NOT NULL
		BEGIN
			INSERT @TABLELIST VALUES ( 'VM01106', 'VM_ID = ''' + @CREFXNID + '''' )
			INSERT @TABLELIST VALUES ( 'VD01106', 'VM_ID = ''' + @CREFXNID + '''' )
			INSERT @TABLELIST VALUES ( 'VDN01106', 'VD_ID IN ( SELECT VD_ID FROM VD01106 WHERE VM_ID = ''' + @CREFXNID + ''')' )
			INSERT @TABLELIST VALUES ( 'VDA01106', 'VD_ID IN ( SELECT VD_ID FROM VD01106 WHERE VM_ID = ''' + @CREFXNID + ''')' )
		END
		SET @CPRIMEAUDITTABLE = 'VM01106'+@CAUDITTABLESUFFIX
	END

	IF NOT EXISTS ( SELECT NAME FROM SYSOBJECTS WHERE NAME = @CPRIMEAUDITTABLE )
		GOTO LAST

	-- THE POINT ONWARDS IS THE GENERALIZED PROCEDURE TO INSERT IN AUDIT LOG TABLES
	-- GENERATING NEW AUDIT ID 
	SET @CPREFIX = @CXNTYPE + @CDEPTID + '-'
	EXEC GETNEXTKEY @CPRIMEAUDITTABLE, 'AUDITID', 40, @CPREFIX, 0, '', 0, @CAUDITID OUTPUT
	IF @CAUDITID IS NULL
		RETURN

	-- LOOPING THROUGH TABLES CURSOR TO INSERT THE LOG
	DECLARE ABC CURSOR FOR
	SELECT TABLENAME, WHERECLAUSE FROM @TABLELIST

	OPEN ABC

	FETCH NEXT FROM ABC INTO @CTABLENAME, @CWHERECLAUSE
	WHILE @@FETCH_STATUS = 0
	BEGIN

		SET @CAUDITTABLENAME = @CTABLENAME + @CAUDITTABLESUFFIX
		IF NOT EXISTS ( SELECT NAME FROM SYSOBJECTS WHERE NAME = @CAUDITTABLENAME )
		BEGIN
			FETCH NEXT FROM ABC INTO @CTABLENAME, @CWHERECLAUSE
			CONTINUE
		END
		
		IF @BCREATEMERGELOGENTRY=1
		BEGIN
			SET @CAUDITTABLENAMEMERGE = @CTABLENAME +'_AUDIT_MERGE'
			IF NOT EXISTS ( SELECT NAME FROM SYSOBJECTS WHERE NAME = @CAUDITTABLENAMEMERGE )
			BEGIN
				SET @CCMD=N'SELECT * INTO '+@CAUDITTABLENAMEMERGE+' FROM '+@CAUDITTABLENAME+' WHERE 1=2'
				EXEC SP_EXECUTESQL @CCMD
			END	
			SET @CAUDITTABLENAME=@CAUDITTABLENAMEMERGE
		END
		
		DELETE FROM @TABCOLLIST

		INSERT @TABCOLLIST 
		SELECT NAME FROM SYSCOLUMNS 
		
		WHERE ID = OBJECT_ID( @CTABLENAME ) 
		AND NAME NOT IN ('TS','ROW_SNO')

		SET @CCOLLIST = ''
		UPDATE @TABCOLLIST
			SET @CCOLLIST = @CCOLLIST + ( CASE WHEN @CCOLLIST<>'' THEN ', ' ELSE ' ' END ) + COLNAME 
		
		SET @CCOLLISTVALUE = REPLACE( @CCOLLIST, 'SENT_TO_HO', '0 AS SENT_TO_HO' )
		SET @CAUDITCOLLIST = ', COMPUTERNAME, WINUSERNAME, WIZUSERCODE, AUDITDATETIME, AUDITID, LOGVISIT'

		SET @CCMD = N'
					INSERT ' + @CAUDITTABLENAME + ' ( ' + @CCOLLIST + @CAUDITCOLLIST + ' ) 
					SELECT ' + @CCOLLISTVALUE + 
						   ', ''' + @CCOMPUTERNAME + ''', ''' + @CWINUSERNAME + ''', ''' + @CWIZUSERCODE + ''', 
							   GETDATE(), ''' + @CAUDITID + ''', 0 AS LOGVISIT 
					FROM   ' + @CTABLENAME + '
					WHERE  ' + @CWHERECLAUSE
		 PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

		FETCH NEXT FROM ABC INTO @CTABLENAME, @CWHERECLAUSE
	END
	-- AUDIT LOG INSERTION IS COMPLETE
	LAST:
	-- END THE PROCEDURE		
END
