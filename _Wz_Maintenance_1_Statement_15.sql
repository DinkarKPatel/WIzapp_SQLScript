
 

IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE  CONFIG_OPTION='DELETE_DUP_LOCSST' AND VALUE=1)
BEGIN
	PRINT 'DELETE DUPLICATE FROM LOCSST'
	
    IF OBJECT_ID('TEMPDB..#1','U') IS NOT NULL
    DROP TABLE #1
    
	;WITH CTE (ROW_NO,MEMO_ID,SUB_SECTION_CODE, TAX_PERCENTAGE)
	AS
	(
	SELECT ROW_NUMBER() OVER(PARTITION BY MEMO_ID,SUB_SECTION_CODE, TAX_PERCENTAGE 
	ORDER BY MEMO_ID,SUB_SECTION_CODE, TAX_PERCENTAGE) AS [ROW_NO]
	,MEMO_ID,SUB_SECTION_CODE, TAX_PERCENTAGE FROM LOCSST WITH(NOLOCK)
	)
	SELECT * INTO #1  FROM CTE WHERE ROW_NO > 1

	---DELETE DUBLICATE RECORDS FROM LOCSSTADD TABLE
	DELETE FROM LOCSSTADD WHERE LOCSST_ROW_ID IN (SELECT ROW_ID FROM LOCSST WHERE MEMO_ID IN (SELECT DISTINCT MEMO_ID FROM #1))

	----DELETE RECORDS FROM LOCSST TABLE
	;WITH CTE1 (ROW_NO,MEMO_ID,SUB_SECTION_CODE, TAX_PERCENTAGE)
	AS
	(
	SELECT ROW_NUMBER() OVER(PARTITION BY MEMO_ID,SUB_SECTION_CODE, TAX_PERCENTAGE 
	ORDER BY MEMO_ID,SUB_SECTION_CODE, TAX_PERCENTAGE) AS [ROW_NO]
	,MEMO_ID,SUB_SECTION_CODE, TAX_PERCENTAGE FROM LOCSST WITH(NOLOCK)
	)
	DELETE  FROM CTE1 WHERE ROW_NO > 1

	IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE  CONFIG_OPTION='DELETE_DUP_LOCSST')
		INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
			   VALUES ('DELETE_DUP_LOCSST',1,'',GETDATE())	
	ELSE
		UPDATE CONFIG SET VALUE='1' WHERE CONFIG_OPTION='DELETE_DUP_LOCSST'
	
END		
