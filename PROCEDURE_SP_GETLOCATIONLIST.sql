CREATE PROCEDURE SP_GETLOCATIONLIST  
@BIMPLEMENTBILLINGRULE BIT=0,  
@cLoc varchar(5)='',  
@CWHERE VARCHAR(MAX)='',  
@bOnlyLoc NUMERIC(1)=0
  
--WITH ENCRYPTION  
AS  
BEGIN  
--SELECT @BIMPLEMENTBILLINGRULE,@bOnlyLoc
 IF @BIMPLEMENTBILLINGRULE=0  
 BEGIN  
 IF (@bOnlyLoc=1)
 BEGIN
  SELECT A.DEPT_ID,A.DEPT_ID+'-'+DEPT_NAME AS DEPT_NAME,  
  (CASE WHEN (locS.loc_type=2 AND locS.account_posting_at_ho=1) OR (a.loc_type=2 AND a.account_posting_at_ho=1)  
   THEN ISNULL(flls.ac_code,a.DEPT_AC_CODE) ELSE a.DEPT_AC_CODE END) as dept_ac_code,AC_NAME,a.LOC_TYPE,UPD_PURINFO,  
  PUR_LOC,ISNULL(B.DISCOUNT_PERCENTAGE,0) AS DISCOUNT_PERCENTAGE,XFER_ACT,LOC_DISCOUNT_PERCENTAGE,  
  B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.PINCODE,B.CITY,B.STATE,A.ENFORCE_BILLING_RULES,  
  A.GENERATE_AUTO_SERIES,A.DEPT_ALIAS,
  ISNULL(B1.BIN_ID,'000') AS [BIN_ID],  ISNULL(B2.BIN_NAME,'DEFAULT BIN') AS [BIN_NAME],B.FORM_ID,   
  ISNULL(SIS_LOC,0) AS SIS_LOC,FR_TYPE,A.STATE_CODE AS LOC_STATE_CODE,B.PURCHASE_AGAINST_TERMS,  
   ISNULL(A.ADDRESS1,'') + ' ' + ISNULL(A.ADDRESS2,'') + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +         
        A.STATE AS 'LOC_ADDRESS'  ,A.loc_gst_no,A.invoice_control_ac_code
		,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE_1,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE_1
,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE_2,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE_2
,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE,
ISNULL(B.lm_REMARKS,'') AS LEDGER_REMARKS,ISNULL(A.GoodsReceiveInGitBin,0) AS GoodsReceiveInGitBin
  FROM LOC_VIEW A (NOLOCK)  
  JOIN LMV01106 B (NOLOCK) ON A.DEPT_AC_CODE = B.AC_CODE  
  LEFT OUTER JOIN BIN_LOC B1 (NOLOCK) ON B1.DEPT_ID=A.DEPT_ID  
  LEFT OUTER JOIN BIN B2 (NOLOCK) ON B2.BIN_ID=B1.BIN_ID   
  LEFT OUTER JOIN PARTY_RATE_MST RATE_MST (NOLOCK) ON RATE_MST.MEMO_ID=B.PARTY_RATE_MEMO_ID
  LEFT OUTER JOIN FRANCHISE_LOC_LEDGER_SETUP FLLS (NOLOCK) ON FLLS.source_dept_id=@cLoc AND FLLS.target_Dept_id=a.dept_id and FLLS.XN_TYPE ='wsl'  
  JOIN (SELECT dept_id,loc_type,account_posting_at_ho FROM location WHERE dept_id=@cLoc) locS ON 1=1   
  WHERE A.DEPT_ID <>  @cLoc  
  AND A.INACTIVE=0 AND A.DEPT_ID=A.MAJOR_DEPT_ID   
  AND (@CWHERE='' OR (A.DEPT_ID LIKE @CWHERE OR A.DEPT_ALIAS LIKE @CWHERE OR A.DEPT_NAME LIKE @CWHERE))  
  END
  ELSE
  BEGIN
  
  SELECT A.DEPT_ID,A.DEPT_ID+'-'+DEPT_NAME AS DEPT_NAME,  
  (CASE WHEN (locS.loc_type=2 AND locS.account_posting_at_ho=1) OR (a.loc_type=2 AND a.account_posting_at_ho=1)  
   THEN ISNULL(flls.ac_code,a.DEPT_AC_CODE) ELSE a.DEPT_AC_CODE END) as dept_ac_code,AC_NAME,a.LOC_TYPE,UPD_PURINFO,  
  PUR_LOC,ISNULL(B.DISCOUNT_PERCENTAGE,0) AS DISCOUNT_PERCENTAGE,XFER_ACT,LOC_DISCOUNT_PERCENTAGE,  
  B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.PINCODE,B.CITY,B.STATE,A.ENFORCE_BILLING_RULES,  
  A.GENERATE_AUTO_SERIES,A.DEPT_ALIAS,
  ISNULL(B2.BIN_ID,'000') AS [BIN_ID],  ISNULL(B2.BIN_NAME,'DEFAULT BIN') AS [BIN_NAME],B.FORM_ID,   
  ISNULL(SIS_LOC,0) AS SIS_LOC,FR_TYPE,A.STATE_CODE AS LOC_STATE_CODE,B.PURCHASE_AGAINST_TERMS,  
   ISNULL(A.ADDRESS1,'') + ' ' + ISNULL(A.ADDRESS2,'') + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +         
        A.STATE AS 'LOC_ADDRESS'  ,A.loc_gst_no,A.invoice_control_ac_code
		,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE_1,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE_1
,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE_2,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE_2
,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE
,ISNULL(B.lm_REMARKS,'') AS LEDGER_REMARKS,ISNULL(A.GoodsReceiveInGitBin,0) AS GoodsReceiveInGitBin
  FROM LOC_VIEW A (NOLOCK)  
  JOIN LMV01106 B (NOLOCK) ON A.DEPT_AC_CODE = B.AC_CODE  
  LEFT OUTER JOIN BIN B2 (NOLOCK) ON 1=2
  LEFT OUTER JOIN PARTY_RATE_MST RATE_MST (NOLOCK) ON RATE_MST.MEMO_ID=B.PARTY_RATE_MEMO_ID
  LEFT OUTER JOIN FRANCHISE_LOC_LEDGER_SETUP FLLS (NOLOCK) ON FLLS.source_dept_id=@cLoc AND FLLS.target_Dept_id=a.dept_id and FLLS.XN_TYPE ='wsl'  
  JOIN (SELECT dept_id,loc_type,account_posting_at_ho FROM location WHERE dept_id=@cLoc) locS ON 1=1   
  WHERE A.DEPT_ID <>  @cLoc  
  AND A.INACTIVE=0 AND A.DEPT_ID=A.MAJOR_DEPT_ID   
  AND (@CWHERE='' OR (A.DEPT_ID LIKE @CWHERE OR A.DEPT_ALIAS LIKE @CWHERE OR A.DEPT_NAME LIKE @CWHERE))  
  END
 END  
 ELSE  
 BEGIN 
 IF (@bOnlyLoc=1)
 BEGIN 
  SELECT A.DEPT_ID,A.DEPT_ID+'-'+DEPT_NAME AS DEPT_NAME,DEPT_AC_CODE,AC_NAME,LOC_TYPE,UPD_PURINFO,   
  PUR_LOC,ISNULL(B.DISCOUNT_PERCENTAGE,0) AS DISCOUNT_PERCENTAGE,XFER_ACT,LOC_DISCOUNT_PERCENTAGE, R.*,  
  B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.PINCODE,B.CITY,B.STATE,A.ENFORCE_BILLING_RULES,  
  A.GENERATE_AUTO_SERIES,A.DEPT_ALIAS ,ISNULL(B1.BIN_ID,'000') AS [BIN_ID],  
  ISNULL(B2.BIN_NAME,'DEFAULT BIN') AS [BIN_NAME],B.FORM_ID,   
  ISNULL(SIS_LOC,0) AS SIS_LOC,FR_TYPE,A.STATE_CODE AS LOC_STATE_CODE,B.PURCHASE_AGAINST_TERMS,  
   ISNULL(A.ADDRESS1,'') + ' ' + ISNULL(A.ADDRESS2,'') + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +         
        A.STATE AS 'LOC_ADDRESS'  ,A.loc_gst_no ,A.invoice_control_ac_code
		,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE_1,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE_1
,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE_2,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE_2
,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE
,ISNULL(B.lm_REMARKS,'') AS LEDGER_REMARKS,ISNULL(A.GoodsReceiveInGitBin,0) AS GoodsReceiveInGitBin
		FROM LOC_VIEW A (NOLOCK)   
  JOIN LOC_BILLING_RULES R (NOLOCK) ON R.TARGET_DEPT_ID=A.DEPT_ID  
  JOIN LMV01106 B (NOLOCK) ON A.DEPT_AC_CODE = B.AC_CODE  
  LEFT OUTER JOIN BIN_LOC B1 (NOLOCK) ON B1.DEPT_ID=A.DEPT_ID  
  LEFT OUTER JOIN BIN B2 (NOLOCK) ON B2.BIN_ID=B1.BIN_ID  
    LEFT OUTER JOIN PARTY_RATE_MST RATE_MST (NOLOCK) ON RATE_MST.MEMO_ID=B.PARTY_RATE_MEMO_ID
  WHERE R.SOURCE_DEPT_ID=@cLoc  
  AND A.INACTIVE=0 AND ( DOC_TYPE=1 OR DOC_TYPE=3) AND A.DEPT_ID=A.MAJOR_DEPT_ID   
  AND (@CWHERE='' OR (A.DEPT_ID LIKE @CWHERE OR A.DEPT_ALIAS LIKE @CWHERE OR A.DEPT_NAME LIKE @CWHERE))  
  END
  ELSE 
  BEGIN 
    SELECT A.DEPT_ID,A.DEPT_ID+'-'+DEPT_NAME AS DEPT_NAME,DEPT_AC_CODE,AC_NAME,LOC_TYPE,UPD_PURINFO,   
  PUR_LOC,ISNULL(B.DISCOUNT_PERCENTAGE,0) AS DISCOUNT_PERCENTAGE,XFER_ACT,LOC_DISCOUNT_PERCENTAGE,  R.*,  
  B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.PINCODE,B.CITY,B.STATE,A.ENFORCE_BILLING_RULES,  
  A.GENERATE_AUTO_SERIES,A.DEPT_ALIAS ,ISNULL(B2.BIN_ID,'000') AS [BIN_ID],  
  ISNULL(B2.BIN_NAME,'DEFAULT BIN') AS [BIN_NAME],B.FORM_ID,   
  ISNULL(SIS_LOC,0) AS SIS_LOC,FR_TYPE,A.STATE_CODE AS LOC_STATE_CODE,B.PURCHASE_AGAINST_TERMS,  
   ISNULL(A.ADDRESS1,'') + ' ' + ISNULL(A.ADDRESS2,'') + ', ' + A.AREA_NAME + ' ' + A.CITY + ' ' +         
        A.STATE AS 'LOC_ADDRESS'  ,A.loc_gst_no ,A.invoice_control_ac_code
		,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE_1,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE_1
,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE_2,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE_2
,ISNULL(RATE_MST.PARTY_RATE_MST_DISCOUNT_PERCENTAGE,0) AS PARTY_RATE_MST_DISCOUNT_PERCENTAGE
,ISNULL(B.lm_REMARKS,'') AS LEDGER_REMARKS,ISNULL(A.GoodsReceiveInGitBin,0) AS GoodsReceiveInGitBin
		FROM LOC_VIEW A (NOLOCK)   
  JOIN LOC_BILLING_RULES R (NOLOCK) ON R.TARGET_DEPT_ID=A.DEPT_ID  
  JOIN LMV01106 B (NOLOCK) ON A.DEPT_AC_CODE = B.AC_CODE  
  LEFT OUTER JOIN BIN B2 (NOLOCK) ON 1=2
    LEFT OUTER JOIN PARTY_RATE_MST RATE_MST (NOLOCK) ON RATE_MST.MEMO_ID=B.PARTY_RATE_MEMO_ID
  WHERE R.SOURCE_DEPT_ID=@cLoc  
  AND A.INACTIVE=0 AND ( DOC_TYPE=1 OR DOC_TYPE=3) AND A.DEPT_ID=A.MAJOR_DEPT_ID   
  AND (@CWHERE='' OR (A.DEPT_ID LIKE @CWHERE OR A.DEPT_ALIAS LIKE @CWHERE OR A.DEPT_NAME LIKE @CWHERE))  
  END
 END  
END



