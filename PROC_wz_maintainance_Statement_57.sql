

IF NOT EXISTS(SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_ORDER_AMOUNT_SKU_BO' AND VALUE='1')
BEGIN

	PRINT 'UPDATING WS_PRICE IN BUYER ORDER DETAILS'
	UPDATE WSL_ORDER_DET
	SET WS_PRICE=(GROSS_WSP-(DISCOUNT_AMOUNT/QUANTITY))

	PRINT 'UPDATING RFNET IN BUYERS ORDER DETAILS'
	DECLARE @CORDER_ID VARCHAR(22)
	IF CURSOR_STATUS('GLOBAL','CUR_ORDER') IN (0,1)
	BEGIN
		CLOSE	   CUR_ORDER
		DEALLOCATE CUR_ORDER
	END

	DECLARE CUR_ORDER CURSOR FOR SELECT ORDER_ID FROM WSL_ORDER_MST
	OPEN CUR_ORDER 
	FETCH NEXT FROM CUR_ORDER INTO @CORDER_ID
	WHILE @@FETCH_STATUS=0
	BEGIN

		EXEC UPDATERFNET 'WOD',@CORDER_ID

	FETCH NEXT FROM CUR_ORDER INTO @CORDER_ID
	END
	CLOSE	   CUR_ORDER
	DEALLOCATE CUR_ORDER

	PRINT 'UPDATING ORDER AMOUNT IN SKU_BO FOR BARCODES ALREADY IN ORDER DETAIL TABLE'
	UPDATE A SET ORDER_AMOUNT=(B.RFNET/B.QUANTITY)
	FROM SKU_BO A 
	JOIN WSL_ORDER_DET B ON A.PRODUCT_CODE=B.PRODUCT_CODE
	WHERE ISNULL(A.ORDER_AMOUNT,0)=0 
	
	PRINT 'CREATING LINK BETWEEN PURCHASE AND PURCHASE ORDER'
	UPDATE PID SET PO_ROW_ID=PO.ROW_ID
	FROM PID01106 PID
	JOIN 
	(
		SELECT A.PRODUCT_CODE,B.ROW_ID
		FROM SKU_BO A
		JOIN POD01106 B ON A.PRODUCT_CODE=B.PRODUCT_CODE
	)PO ON PID.PRODUCT_CODE=PO.PRODUCT_CODE
	WHERE ISNULL(PID.PO_ROW_ID,'')=''	

	PRINT 'UPDATING ORDER AMOUNT IN SKU_BO FOR BARCODES GENERATED THRU PURCHASE'
	UPDATE B SET ORDER_AMOUNT=(WOD.RFNET/WOD.QUANTITY)
	FROM SKU_BO B
	JOIN PID01106 PID ON B.PRODUCT_CODE=PID.PRODUCT_CODE
	JOIN POD01106 POD ON PID.PO_ROW_ID=POD.ROW_ID
	JOIN WSL_ORDER_DET WOD ON POD.WOD_ROW_ID=WOD.ROW_ID
	WHERE ISNULL(B.ORDER_AMOUNT,0)=0

	IF NOT EXISTS (SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_ORDER_AMOUNT_SKU_BO')
       INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
	   VALUES ('UPDATE_ORDER_AMOUNT_SKU_BO','1','',GETDATE())	
	ELSE	
		UPDATE CONFIG SET VALUE='1' WHERE CONFIG_OPTION='UPDATE_ORDER_AMOUNT_SKU_BO'
END

