CREATE PROCEDURE SP_MERGE_MIRROR_DSM_DATA
(
	@CMEMOID VARCHAR(50)
   ,@CLOCID VARCHAR(3)
   ,@CSOURCEDB VARCHAR(200)
   ,@CMERGEDB VARCHAR(200)
   ,@BMSTINSERTONLY BIT
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
    DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@NMERGE_ORDER NUMERIC(5)
	   ,@CTABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(50),@CKEYFIELD VARCHAR(200),@CDEL_ID VARCHAR(50),@CTMP_TABLENAME VARCHAR(200),@LINSERTONLY VARCHAR(1)
	   ,@CFILTERCONDITION VARCHAR(200),@LUPDATEONLY VARCHAR(1),@BALWAYSUPDATE VARCHAR(1),@FDEL CHAR(1)
	   ,@CERRMSGOUT VARCHAR(1000),@CTABLESSTR VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100)
	   
     DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(40))  
     
     
BEGIN TRY
	SET @CSTEP=20
	SET @CTABLE_SUFFIX=REPLACE(@CMEMOID,'-','_')
	BEGIN TRANSACTION

	SET @CTABLENAME='REGIONM'
	SET @CTMP_TABLENAME='TMP_DSM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='REGION_CODE'
	SET @CSTEP=25
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
					  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
					  ,@BALWAYSUPDATE=1
	
	SET @CSTEP=30
	SET @CTABLENAME='STATE'
	SET @CTMP_TABLENAME='TMP_DSM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='STATE_CODE'
	SET @CSTEP=26
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
					  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
					  ,@BALWAYSUPDATE=1
					  
	SET @CSTEP=35
	SET @CTABLENAME='CITY'
	SET @CTMP_TABLENAME='TMP_DSM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='CITY_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
					  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
					  ,@BALWAYSUPDATE=1
	
	SET @CSTEP=40
	SET @CTABLENAME='AREA'
	SET @CTMP_TABLENAME='TMP_DSM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='AREA_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
					  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
					  ,@BALWAYSUPDATE=1				  
	
	
	SET @CSTEP=45
	SET @CTABLENAME='CUSTDYM'
	SET @CTMP_TABLENAME='TMP_DSM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='CUSTOMER_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
					  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
					  ,@BALWAYSUPDATE=1	
	
	
	SET @CSTEP=50
	SET @CTABLENAME='CMM01106'
	SET @CTMP_TABLENAME=@CSOURCEDB+'TMP_DSM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		
	IF OBJECT_ID(@CTMP_TABLENAME,'U') IS NOT NULL
	BEGIN
		SET @DTSQL =N'UPDATE CMM01106  WITH (ROWLOCK)  SET CUSTOMER_CODE=B.CUSTOMER_CODE FROM '+@CTMP_TABLENAME+' B (NOLOCK) 
					WHERE B.CM_ID=CMM01106.CM_ID'
		EXEC SP_EXECUTESQL @DTSQL
	END				  	
	
	SET @CSTEP=60
	SET @CTABLENAME='DSM01106'
	SET @CTMP_TABLENAME='TMP_DSM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='DS_ID'
	SET @CSTEP=80
	--UPDATE SHIFT_ID TO NULL IF BLANK IN TEMPERORY TABLE SO THAT IT COULD GET MERGED
	IF OBJECT_ID(@CSOURCEDB+@CTMP_TABLENAME,'U') IS NOT NULL
	BEGIN
		SET @DTSQL=N'UPDATE '+@CSOURCEDB+@CTMP_TABLENAME+'  WITH (ROWLOCK)  SET SHIFT_ID=NULL WHERE SHIFT_ID='''''
		EXEC SP_EXECUTESQL @DTSQL
	END
	
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
					  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
					  ,@BALWAYSUPDATE=1
	

			
	SET @CSTEP=70
	SET @CTABLENAME='DSD01106'
	SET @CTMP_TABLENAME='TMP_DSM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
	SET @CKEYFIELD='DS_ID'
	
	SET @CSTEP=80
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
					  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
					  ,@LINSERTONLY=@BMSTINSERTONLY,@CFILTERCONDITION='',@LUPDATEONLY=0
					  ,@BALWAYSUPDATE=1 
	
	IF EXISTS (SELECT TOP 1 DS_ID FROM DSM01106 (NOLOCK) WHERE DS_ID=@CMEMOID AND CANCELLED=0)
	BEGIN
		SET @CSTEP=90
		SET @CTMP_TABLENAME=@CSOURCEDB+'TMP_DSM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		
		IF OBJECT_ID(@CTMP_TABLENAME,'U') IS NOT NULL
		BEGIN
			SET @DTSQL = N'DELETE A FROM PAYMODE_XN_DET A WITH (ROWLOCK) JOIN DSD01106 B (NOLOCK) ON A.MEMO_ID=B.CM_ID
						   WHERE B.'+@CKEYFIELD+' = '''+@CMEMOID+''' AND A.XN_TYPE=''SLS'''
			PRINT @DTSQL
			EXEC SP_EXECUTESQL @DTSQL	   
		END
		
		SET @CSTEP=100
		SET @CTABLENAME='PAYMODE_XN_DET'
		SET @CTMP_TABLENAME='TMP_DSM_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))
		SET @CKEYFIELD='MEMO_ID'
		
		SET @CSTEP=110
		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
						  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='XN_TYPE',@CKEYFIELD3=''
						  ,@LINSERTONLY=1,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0,@BALWAYSUPDATE=1 
	END		
	
	GOTO EXIT_PROC			  	   
END TRY

BEGIN CATCH
	SET @CERRMSG='P:SP_MERGE_MIRROR_DSM_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO EXIT_PROC
END CATCH
	
EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
	BEGIN
		COMMIT
		SET @CSOURCEDB=DB_NAME()+'_TEMP..' 

		SET @CTABLESSTR='DSM01106,DSD01106,CMM01106,PAYMODE_XN_DET,CUSTDYM,AREA,CITY,STATE,REGIONM'
	    IF ISNULL(@CERRMSG,'')=''	
		   EXEC SP3S_DROPTEMPTABLES_MIRRORDATA
			@CXNTYPE='DSM',
			@CTABLESUFFIX=@CTABLE_SUFFIX,
			@CTABLESSTR=@CTABLESSTR

		
	END
	ELSE
	IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0
		ROLLBACK   
	   
	   
END
