CREATE PROCEDURE SP3S_POS_NRV
(
@NMODE INT      ---- 1-CLUBBED   2--LOCATION WISE
)
AS
BEGIN
        
          IF @NMODE=1
          
           SELECT SUM(NRV) AS TOTAL_NRV FROM POS_NRV 
           
           
          IF @NMODE=2
          BEGIN
          
			  IF OBJECT_ID('TEMPDB..#T1','U') IS NOT NULL
			  DROP TABLE #T1
	          
			  IF OBJECT_ID('TEMPDB..#T2','U') IS NOT NULL
			  DROP TABLE #T2
	          
			  SELECT ROW_NUMBER()OVER(ORDER BY  NRV ASC) AS SRNO,DEPT_ID AS DEPT_ID1,NRV AS NRV1,CONVERT(VARCHAR(2),'')DEPT_ID2,CONVERT(NUMERIC(10,2),0)AS NRV2 INTO #T1 FROM POS_NRV ORDER BY  NRV ASC 
			  SELECT ROW_NUMBER()OVER(ORDER BY  NRV DESC ) AS SRNO,DEPT_ID AS DEPT_ID2,NRV AS NRV2 INTO #T2 FROM POS_NRV 


			  UPDATE A SET DEPT_ID2=B.DEPT_ID2,NRV2=B.NRV2 FROM #T1 A JOIN #T2 B ON A.SRNO=B.SRNO
			  
	           
			  SELECT LEFT(B.DEPT_ALIAS,15) AS DEPT_ID1,NRV1,LEFT(C.DEPT_ALIAS,15) AS DEPT_ID2,NRV2 FROM #T1 A 
			  JOIN LOCATION B ON A.DEPT_ID1=B.DEPT_ID
			  JOIN LOCATION C ON A.DEPT_ID2=C.DEPT_ID
			  
			  
		
		
			  


          END
          
          
END
