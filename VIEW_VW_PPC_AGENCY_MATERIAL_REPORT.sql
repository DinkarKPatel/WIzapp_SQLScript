CREATE VIEW VW_PPC_AGENCY_MATERIAL_REPORT    
AS      
  SELECT SM.SECTION_NAME ,SD.SUB_SECTION_NAME , ART.ARTICLE_NO ,    
       ART.ARTICLE_NAME, A.PRODUCT_CODE   
       , SUM(A.IN_QTY ) AS IN_QTY   
       , SUM(A.OUT_QTY ) AS OUT_QTY  
       , BAL_QTY= SUM(A.IN_QTY )-SUM(A.OUT_QTY )    
   FROM     
   (    
     SELECT A.ARTICLE_CODE,A.PRODUCT_CODE   
   ,SUM(IN_QTY ) AS IN_QTY   
   ,CAST(0 AS NUMERIC(10,3)) AS OUT_QTY     
  FROM   
  (  
   SELECT B.ARTICLE_CODE ,C.PRODUCT_CODE ,C.PRODUCT_UID , C.QUANTITY AS IN_QTY     
   FROM PPC_PIM01106 A    
   JOIN PPC_PID01106 B ON A.MRR_ID =B.MRR_ID     
   JOIN PPC_PID01106_BARCODE C ON B.ROW_ID =C.PID_ROW_ID     
   WHERE A.CANCELLED =0   
  ) A    
  GROUP BY A.ARTICLE_CODE,A.PRODUCT_CODE     
      
    UNION ALL    
  SELECT A.ARTICLE_CODE ,A.PRODUCT_CODE ,0 AS IN_QTY ,SUM(A.OUT_QTY) AS OUT_QTY    
  FROM  
  (  
   SELECT A.PRODUCT_UID ,C.PRODUCT_CODE ,C.ARTICLE_CODE,A.QUANTITY AS OUT_QTY      
   FROM PPC_AGENCY_ISSUE_MATERIAL_DET  A    
   JOIN PPC_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID     
   JOIN PPC_SKU C ON A.PRODUCT_UID =C.PRODUCT_UID     
   WHERE B.CANCELLED =0          
  )A    
  GROUP BY A.ARTICLE_CODE ,A.PRODUCT_CODE    
    ) A    
    JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE     
    JOIN SECTIOND SD ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE     
    JOIN SECTIONM SM ON SM.SECTION_CODE =SD.SECTION_CODE     
    WHERE 1=1      
     GROUP BY SM.SECTION_NAME ,SD.SUB_SECTION_NAME , ART.ARTICLE_NO ,    
    ART.ARTICLE_NAME,A.PRODUCT_CODE     
    HAVING ( SUM(A.IN_QTY )-SUM(A.OUT_QTY )>0)
