CREATE PROCEDURE SP_BUYERSORDER_WSL_33
@CMEMOID VARCHAR(40),  
@CWHERE VARCHAR(500),  
@CFINYEAR VARCHAR(10),  
@NNAVMODE NUMERIC(2,0),
@CARTICLECODE CHAR(9)='',  
@CPARA2CODE CHAR(7)='',
@DTWHERE DATETIME ='',
@cLocId VARCHAR(5)=''
--WITH ENCRYPTION
 
AS    
BEGIN 
DECLARE @ORDERNO VARCHAR(100),@REFNO VARCHAR(100)
    SELECT TOP 1 @ORDERNO=order_no,@REFNO=REF_NO FROM BUYER_ORDER_MST (NOLOCK) WHERE ORDER_ID=@CMEMOID
    SELECT @ORDERNO=ISNULL(@ORDERNO,''),@REFNO=ISNULL(@REFNO,'')

	;WITH BOM_DET
	AS
	(
		SELECT article_code,bom_article_code,bom_para1_code,bom_para2_code,
		CONVERT(NUMERIC(14,3), ISNULL(avg_qty,0)+ISNULL(ADD_AVG_QTY,0)) AS QTY 
		FROM ART_BOM (NOLOCK)
	),
	BO
	AS
	(
		SELECT article_code,SUM(CONVERT(NUMERIC(14,3), ISNULL(quantity,0))) AS BO_QTY 
		FROM BUYER_ORDER_DET D (NOLOCK)
		WHERE order_id=@CMEMOID
		GROUP BY article_code
	)
	SELECT --C.bom_article_code,C.bom_para1_code,C.bom_para2_code,
	A.ARTICLE_NO,A.article_name,D.para1_name,E.para2_name, SUM(CONVERT(NUMERIC(14,3), C.QTY * B.BO_QTY)) AS BOM_QTY,BU.CONVERSION_UOM_NAME AS BOM_UOM,
	CONVERT(NUMERIC(14,3),   SUM( C.QTY * B.BO_QTY)/CASE WHEN isnull(UC.CONVERSION_VALUE,0) =0 THEN 1 ELSE UC.CONVERSION_VALUE END ) as stock_Qty  ,
	F.UOM_NAME AS STOCK_UOM, 
	@ORDERNO [ORDER NO],@REFNO [REF NO]
	FROM BOM_DET C
	JOIN BO B ON B.article_code=C.article_code
	JOIN ARTICLE A (NOLOCK) ON A.ARTICLE_CODE=C.BOM_ARTICLE_CODE
	JOIN para1 D (NOLOCK) ON D.para1_code=C.bom_para1_code
	JOIN PARA2 E (NOLOCK) ON E.para2_code=C.bom_para2_code
	JOIN uom F (NOLOCK) ON F.uom_code=A.uom_code
	LEFT OUTER JOIN UOM_CONVERSION UC (nolock) ON UC.UOM_CODE=F.UOM_CODE  
	LEFT OUTER JOIN BOM_UOM BU (nolock) ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE  
	GROUP BY --C.bom_article_CODE,C.bom_para1_code,C.bom_para2_code,
	A.ARTICLE_NO,A.article_name,D.para1_name,E.para2_name,F.UOM_NAME,bu.CONVERSION_UOM_NAME,UC.CONVERSION_VALUE
END