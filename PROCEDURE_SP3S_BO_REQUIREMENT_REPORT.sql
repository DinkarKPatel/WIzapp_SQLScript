CREATE PROCEDURE  SP3S_BO_REQUIREMENT_REPORT  --(LocId 3 digit change only increased the parameter width by Sanjay:04-11-2024)
(
 @DASONDATE DATETIME='2018-06-29',
 @CDEPT_ID VARCHAR(4)=''
)
AS
BEGIN
     
     IF OBJECT_ID('TEMPDB..#TMPPURLOC','U') IS NOT NULL
         DROP TABLE #TMPPURLOC
       
      SELECT  DEPT_ID 
      INTO #TMPPURLOC
      FROM LOCATION WHERE ISNULL(PUR_LOC,0)=1
      AND (@CDEPT_ID='' OR DEPT_ID=@CDEPT_ID)
      
      IF OBJECT_ID('TEMPDB..#TMPORDER','U') IS NOT NULL
          DROP TABLE #TMPORDER
      
      SELECT B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,
      SUM(B.QUANTITY) AS ORDER_QTY 
      INTO #TMPORDER
      FROM BUYER_ORDER_MST A (NOLOCK)
      JOIN BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID=B.ORDER_ID
      WHERE A.CANCELLED=0
      AND A.ORDER_DT<=@DASONDATE
      GROUP BY B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE
      
      IF OBJECT_ID('TEMPDB..#TMPDELIVERED','U') IS NOT NULL
          DROP TABLE #TMPDELIVERED
          
      SELECT A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,
      SUM(A.QUANTITY) AS DELIVERD_QTY 
      INTO #TMPDELIVERED 
      FROM
      (
      SELECT A.PACKSLIP_ARTICLE_CODE AS ARTICLE_CODE,
             A.PACKSLIP_PARA1_CODE AS PARA1_CODE,
             A.PACKSLIP_PARA2_CODE AS PARA2_CODE,
             SUM(QUANTITY) AS QUANTITY
	  FROM WPS_DET A (NOLOCK)
	  JOIN WPS_MST B (NOLOCK) ON A.PS_ID =B.PS_ID 
	  WHERE B.CANCELLED =0
	  AND ISNULL(A.ORDER_ID,0)<>''
	  GROUP BY A.PACKSLIP_ARTICLE_CODE ,A.PACKSLIP_PARA1_CODE ,A.PACKSLIP_PARA2_CODE
	  UNION ALL
	  SELECT A.PICKLIST_ARTICLE_CODE AS ARTICLE_CODE,
	         A.PICKLIST_PARA1_CODE AS PARA1_CODE,
	         A.PICKLIST_PARA2_CODE AS PARA2_CODE,
	          SUM(QUANTITY) AS ORDER_DELIVERED
	  FROM IND01106 A (NOLOCK)
	  JOIN INM01106 B (NOLOCK) ON A.INV_ID =B.INV_ID 
	  WHERE B.CANCELLED =0
	  AND  ISNULL(PS_ID,'')='' AND ISNULL(A.ORDER_ID,'')<>''
	  GROUP BY A.PICKLIST_ARTICLE_CODE ,A.PICKLIST_PARA1_CODE ,A.PICKLIST_PARA2_CODE
	  ) A
	  GROUP BY A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE
	  
	   IF OBJECT_ID('TEMPDB..#TMPPUR','U') IS NOT NULL
          DROP TABLE #TMPPUR
	  
	  
	  SELECT A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE ,
	  SUM(PO_QTY) AS PO_QTY,
	  SUM(ISNULL(PI_QTY,0)) AS PI_QTY,
	  SUM(ISNULL(PURCHASE_PRICE,0)) AS PURCHASE_PRICE,
	  SUM(ISNULL(PURCHASE_VALUE,0)) AS PURCHASE_VALUE
	  INTO  #TMPPUR
	  FROM
	  (
	  SELECT A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE,A.ROW_ID ,
	  A.QUANTITY AS PO_QTY,
	  ISNULL(C.PI_QTY,0) AS PI_QTY,
	  ISNULL(C.PURCHASE_PRICE,0) AS PURCHASE_PRICE,
	  ISNULL(C.PURCHASE_VALUE,0) AS PURCHASE_VALUE
	  FROM POD01106 A
	  JOIN POM01106 B ON A.PO_ID=B.PO_ID
	  LEFT JOIN
	  (
	   SELECT PO_ROW_ID,SUM(QUANTITY) AS PI_QTY,
	   SUM(PURCHASE_PRICE) AS PURCHASE_PRICE,
	   SUM(PURCHASE_PRICE*QUANTITY ) AS PURCHASE_VALUE
	   FROM PID01106 A 
	   JOIN PIM01106 B ON A.MRR_ID=B.MRR_ID
	   WHERE B.CANCELLED=0
	   GROUP BY PO_ROW_ID
	  ) C ON A.ROW_ID =C.PO_ROW_ID 
	  WHERE B.CANCELLED=0
	  AND ISNULL(A.WOD_ROW_ID,'')<>''
     ) A
     GROUP BY A.ARTICLE_CODE,A.PARA1_CODE,A.PARA2_CODE
     
     
  
     IF OBJECT_ID('TEMPDB..#TMPWHSTOCK','U') IS NOT NULL
          DROP TABLE #TMPWHSTOCK
     
     SELECT B.ARTICLE_CODE ,B.PARA1_CODE ,B.PARA2_CODE ,
     SUM(A.QUANTITY_IN_STOCK) AS WH_QTY,
     SUM(PURCHASE_PRICE) AS PURCHASE_PRICE,
	 SUM(PURCHASE_PRICE*A.QUANTITY_IN_STOCK ) AS PURCHASE_VALUE
     INTO #TMPWHSTOCK
     FROM PMT01106 A
     JOIN #TMPPURLOC TMP ON A.DEPT_ID=TMP.DEPT_ID
     JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE 
     WHERE A.QUANTITY_IN_STOCK >0
     GROUP BY B.ARTICLE_CODE ,B.PARA1_CODE ,B.PARA2_CODE
     
     
     SELECT ART.ARTICLE_NO,P1.PARA1_NAME,P2.PARA2_NAME,A.ORDER_QTY,
     ISNULL(B.DELIVERD_QTY,0) AS DELIVERD_QTY,
     A.ORDER_QTY-ISNULL(B.DELIVERD_QTY,0) AS PENDING_ORDER_QTY,
     ISNULL(C.PO_QTY ,0) AS PO_QTY,
     ISNULL(C.PI_QTY ,0) AS GRN_QTY,
     ISNULL(D.WH_QTY,0) AS WH_STOCK,
     REQ_QTY=(A.ORDER_QTY-ISNULL(B.DELIVERD_QTY,0))-((ISNULL(C.PO_QTY ,0)-ISNULL(C.PI_QTY ,0))+ISNULL(D.WH_QTY,0)),
     ISNULL(D.PURCHASE_PRICE ,0)+ISNULL(C.PURCHASE_PRICE ,0) AS PURCHASE_PRICE,
     CONVERT(NUMERIC(10,2),ISNULL(D.PURCHASE_VALUE ,0)+ISNULL(C.PURCHASE_VALUE ,0)) AS PURCHASE_VALUE
     
     FROM #TMPORDER A
     LEFT JOIN #TMPDELIVERED B ON A.ARTICLE_CODE =B.ARTICLE_CODE 
     AND A.PARA1_CODE=B.PARA1_CODE AND A.PARA2_CODE=B.PARA2_CODE 
     LEFT JOIN #TMPPUR C ON A.ARTICLE_CODE=C.ARTICLE_CODE 
     AND A.PARA1_CODE=C.PARA1_CODE AND A.PARA2_CODE=C.PARA2_CODE 
     LEFT JOIN #TMPWHSTOCK D ON A.ARTICLE_CODE =D.ARTICLE_CODE 
     AND A.PARA1_CODE=D.PARA1_CODE AND A.PARA2_CODE=D.PARA2_CODE
     JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE
     JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
     JOIN PARA2 P2 ON P2.PARA2_CODE =A.PARA2_CODE 
     WHERE (A.ORDER_QTY-ISNULL(B.DELIVERD_QTY,0))-((ISNULL(C.PO_QTY ,0)-ISNULL(C.PI_QTY ,0))+ISNULL(D.WH_QTY,0))>0
     ORDER BY ART.ARTICLE_NO,P1.PARA1_NAME,P2.PARA2_NAME

END
