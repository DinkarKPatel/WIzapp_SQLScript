CREATE FUNCTION FN_VCH_TRAVTREESTR ( @CVCHCODE VARCHAR(20) )  
RETURNS VARCHAR(MAX)  
--WITH ENCRYPTION  
AS   
BEGIN  
 DECLARE @CRETVAL VARCHAR(MAX),   
   @CTEMPHEADCODE VARCHAR(10)  
   
 SET @CRETVAL = ''  
 SET @CRETVAL = '''' + @CVCHCODE + ''''  
 DECLARE ABC CURSOR FOR   
 SELECT VOUCHER_CODE FROM VCHTYPE (NOLOCK) WHERE VOUCHER_MAJOR_HEAD_CODE = @CVCHCODE AND VOUCHER_CODE <> @CVCHCODE  
  
 OPEN ABC  
 FETCH NEXT FROM ABC INTO @CTEMPHEADCODE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  --SET @CRETVAL = @CRETVAL + ',''' + @CTEMPHEADCODE + ''''  
  SET @CRETVAL = @CRETVAL + ',' + DBO.FN_VCH_TRAVTREESTR( @CTEMPHEADCODE )  
   
  FETCH NEXT FROM ABC INTO @CTEMPHEADCODE  
 END  
 CLOSE ABC  
 DEALLOCATE ABC  
   
 RETURN @CRETVAL  
END