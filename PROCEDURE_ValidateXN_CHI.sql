CREATE PROCEDURE VALIDATEXN_CHI
(
		@CXNID VARCHAR(40),
		@NUPDATEMODE INT,					
		@CCMD VARCHAR(1000) OUTPUT
		--*** PARAMETERS :
		--*** @CXNID - TRANSACTION ID ( MEMO ID OF MASTER TABLE )
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CCIMTABLE TABLE ( CHALLAN_ID VARCHAR(22), CHALLAN_NO VARCHAR(10), CHALLAN_DT DATETIME, 
							   FIN_YEAR VARCHAR(10), CANCELLED BIT )
	
	INSERT @CCIMTABLE
	SELECT CHALLAN_ID, CHALLAN_NO, CHALLAN_DT, FIN_YEAR, CANCELLED
	FROM CIM01106 WHERE CHALLAN_ID = @CXNID

	SET @CCMD = ''

	IF EXISTS (SELECT CHALLAN_ID FROM @CCIMTABLE WHERE FIN_YEAR<>'01'+DBO.FN_GETFINYEAR(CHALLAN_DT))
		SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'MISMATCH BETWEEN CHALLAN DATE & FIN YEAR ..... '

	IF EXISTS (SELECT CHALLAN_ID FROM @CCIMTABLE WHERE FIN_YEAR<>SUBSTRING(CHALLAN_ID,3,5))
		SET @CCMD=@CCMD+(CASE WHEN @CCMD<>'' THEN ',' ELSE '' END )+'MISMATCH BETWEEN CHALLAN ID & FIN YEAR ..... '

END_PROC:
END
--********************************************* END OF PROCEDURE VALIDATEXN_CHI
