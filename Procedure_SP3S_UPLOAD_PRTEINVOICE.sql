
create PROCEDURE SP3S_UPLOAD_PRTEINVOICE    
(        
@CXNID VARCHAR(50)=''        
)        
AS        
BEGIN        

      DECLARE @CEINVOICE_PREFIX VARCHAR(10)
     select @CEINVOICE_PREFIX=value  from CONFIG where config_option ='EINVOICE_PREFIX'
    set @CEINVOICE_PREFIX=ISNULL(@CEINVOICE_PREFIX,'')
   
        
       IF OBJECT_ID ('TEMPDB..#TRANSPORTER','U') IS NOT NULL                                
           DROP TABLE #TRANSPORTER            
    SELECT A.PARCEL_MEMO_ID, ANGM.ANGADIA_NAME AS TRANSPORTER_NAME , angm.Angadia_code ,       
           ANGADIA_ADD1 ,ANGADIA_ADD2  ,AR.AREA_NAME ,AR.PINCODE , lmp.ac_gst_state_code  AS STATE ,A.MODE ,  
     vehicle_no , parcel_memo_no , parcel_memo_dt ,bilty_no ,lmp.Ac_gst_no as TRANSPORTER_GST_NO                                       
    INTO #TRANSPORTER                                
    FROM PARCEL_MST A (NOLOCK)                                
    JOIN PARCEL_DET B (NOLOCK) ON A.PARCEL_MEMO_ID =B.PARCEL_MEMO_ID                                           
    LEFT OUTER JOIN ANGM (NOLOCK) ON ANGM.ANGADIA_CODE =A.ANGADIA_CODE            
    LEFT JOIN AREA AR (NOLOCK) ON AR.AREA_CODE =ANGM.AREA_CODE  
	left join lmp01106 lmp (nolock) on lmp.ac_code= angm.ac_code                    
    WHERE A.XN_TYPE ='prt' AND B.REF_MEMO_ID=@CXNID          
    AND A.CANCELLED =0        
    GROUP BY A.PARCEL_MEMO_ID, ANGM.ANGADIA_NAME  ,        
    ANGADIA_ADD1 ,ANGADIA_ADD2  ,AR.AREA_NAME ,AR.PINCODE ,  lmp.ac_gst_state_code,A.MODE,vehicle_no ,parcel_memo_no,bilty_no, parcel_memo_dt 
	,angm.Angadia_code ,lmp.Ac_gst_no                         
     
           
    ;WITH CTE AS                                 
    (                                
   SELECT PARCEL_MEMO_ID,SR=ROW_NUMBER () OVER (ORDER BY PARCEL_MEMO_ID)                                 
   FROM #TRANSPORTER                                
    )                                
                                   
    DELETE FROM CTE WHERE SR>1      
   
        
        
  DECLARE @NIGSTVAL NUMERIC(10,2),@NCGSTVAL NUMERIC(10,2),@NSGSTVAL NUMERIC(10,2),@NCESSaMOUNT  NUMERIC(10,2)  ,@NTABLABLEVALUE NUMERIC(18,2)  , @NDISCOUNT_AMOUNT NUMERIC(10,2)  
        
  SELECT @NIGSTVAL=SUM(IGST_AMOUNT),@NCGSTVAL=SUM(CGST_AMOUNT),@NSGSTVAL=SUM(CGST_AMOUNT),@NCESSaMOUNT=SUM(CESS_AMOUNT),  
  @NTABLABLEVALUE= SUM(XN_VALUE_WITHOUT_GST ),-- SUM(XN_VALUE_WITHOUT_GST),
  @NDISCOUNT_AMOUNT =SUM(DISCOUNT_AMOUNT)  
  FROM rmd01106         
  WHERE rm_id  =@CXNID      
  

 DECLARE @NPICKINGSHIPPINGADDRESS INT
--1 FOR  INM  SHIPPING AC_CODE DETAILS 2.INM SHPING ADDRESS STORED IN INM 3 FOR PARTY ADDRESS


 SELECT @NPICKINGSHIPPINGADDRESS=
      CASE WHEN ISNULL(SHIPPING_SAME_AS_BILLING_ADD,0) =0 
	       THEN CASE WHEN ISNULL(SHIPPING_MODE,0)=0 THEN 1 ELSE 2 END 
		   ELSE 3 END  
 FROM rmm01106  WHERE rm_id=@CXNID



    
 IF OBJECT_ID('TEMPDB..#TMPINVOICE','U') IS NOT NULL  
    DROP TABLE #TMPINVOICE  
           
   SELECT 'GST' AS TAXSCH,SUPPLY_TYPE_CODE AS SUPTYP,'N' AS REGREV,UPPER(L.LOC_GST_NO) AS ECMGSTIN,'N' AS IGSTONINTRA,        
   'DBN' AS TYP,  
   --******SellerDtls******  
   NO=CASE WHEN (@CEINVOICE_PREFIX<>'' AND LEFT(RTRIM(LTRIM(A.rm_no )),1)='0') THEN @CEINVOICE_PREFIX ELSE '' END+RTRIM(LTRIM(A.rm_no )),--A.INV_NO ,
 -- NO=RTRIM(LTRIM(A.rm_no)),
   -- a.INV_NO  AS NO,---- EVERY  NO CAHNE NOT MATCH INV_NO BOTH ARE DIFFERENT      
   convert(varchar,A.rm_dt,103) AS INV_DT,  -- CONVERT INVDT NOT TIME      
   UPPER(L.LOC_GST_NO) AS GSTIN,L.DEPT_NAME AS LGLNM,L.DEPT_NAME AS TRDNM,-- L.DEPT_ALIAS TRADE NAME SHOULD BE MIN 3 CHARCATER      
   LEFT(ISNULL(L.ADDRESS1,'')+' '+ISNULL(L.ADDRESS2,''),100) ADDRESS1 ,
   Substring(ISNULL(L.ADDRESS1,'')+' '+ISNULL(L.ADDRESS2,''),101,100) ADDRESS2 ,        
   L.AREA_NAME LOC ,l.PINCODE  PIN,-- PIN NO SHOULD NOT BE BLANK MOUST BE 6 CHARACTER      
   l.gst_state_code  STCD,---L.gst_state_code      
   l.phone  PH,--L.PHONE MUST BE NOT BLANK SHOULD BE MIN 6 CHARCTAER   
   C.EMAIL_ID  AS EM ,     
  
   --******BuyerDtls******  
  
   CASE WHEN A.party_state_code IN('96') THEN 'URP' ELSE   UPPER(LM.AC_GST_NO)  END   AS B_GSTIN,--LM.AC_GST_NO      
   LM.AC_NAME AS B_LGLNM ,      
   LM.AC_NAME AS B_TRDNM  ,--LM.ALIAS NOT SHOULD BE BLANK  
   a.party_state_code AS POS,      
   LEFT(ISNULL(LM.ADDRESS0 ,'')+' '+ISNULL(LM.ADDRESS1 ,'')+' '+ISNULL(LM.ADDRESS2 ,''),100) AS ADDR1 ,-- LM.ADDRESS1 SHOULD NOT BE BLANK      
   substring((ISNULL(LM.ADDRESS0 ,'')+' '+ISNULL(LM.ADDRESS1 ,'')+' '+ISNULL(LM.ADDRESS2 ,'')),101,100)  AS ADDR2,  --LM.ADDRESS2 SHOULD NOT BE BLANK      
   LM.AREA_NAME +' '+lm.CITY  B_LOC ,lm.PINCODE AS B_PIN,-- LM.PINCODE PIN CODE MATCH ADDRESS        
   a.party_state_code AS B_STCD--LM.AC_GST_STATE_CODE  STCD IS NOT SAME STATECODE FOR b_STCd      
   ,case when isnull( LM.MOBILE,'')='' then lm.PHONES_O else lm.mobile end AS B_PH,LM.E_MAIL  AS B_EM ,  
  
	 --******DispDtls******  
	   ISNULL(L.DEPT_NAME,'NULL') AS DIS_NM,
	   LEFT(ISNULL(L.ADDRESS1,'')+' '+ISNULL(L.ADDRESS2,''),100) AS DIS_ADDR1,  
	   Substring(ISNULL(L.ADDRESS1,'')+' '+ISNULL(L.ADDRESS2,''),101,100) AS DIS_ADDR2,        
	   ISNULL(L.AREA_NAME,'NULL') AS DIS_LOC ,--mANADATORY disc loc TR.AREA_NAME    
	   ISNULL(l.PINCODE,'NULL') AS DIS_PIN,--mANADATORY PINCODE TR.PINCODE      
	  ISNULL( l.gst_state_code,'NULL') AS DIS_STCD,  --mANADATORY STCD SENDER GSTNO     
   
    --******ShipDtls******   

      UPPER(CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHLMP.Ac_gst_no  
		   ELSE LM.Ac_gst_no  END) SHIP_GSTIN,

      CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHLM.AC_NAME   
		   ELSE LM.AC_NAME  END SHIP_LGLNM,

       CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHLM.AC_NAME   
		   ELSE LM.AC_NAME  END SHIP_TRDNM,

         CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN LEFT(ISNULL(SHLMP.ADDRESS0 ,'')+' '+ISNULL(SHLMP.ADDRESS1 ,''),100)
		   ELSE Left(isnull(LM.ADDRESS0,'')+' '+isnull(LM.ADDRESS1,'')+' '+isnull(LM.ADDRESS2,''),100) END SHIP_ADDR1,

	    CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN Substring(ISNULL(SHLMP.ADDRESS0 ,'')+' '+ISNULL(SHLMP.ADDRESS1 ,''),101,100)
		   ELSE substring(isnull(LM.ADDRESS0,'')+' '+isnull(LM.ADDRESS1,'')+' '+isnull(LM.ADDRESS2,''),101,100) END SHIP_ADDR2,

         CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHAR.AREA_NAME  
		   ELSE lm.AREA_NAME  END SHIP_LOC,
         
		  CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHAR.pincode   
		   ELSE lm.PINCODE    END SHIP_PIN,

		   CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHcs.gst_state_code   
		   ELSE lm.ac_gst_state_code     END SHIP_STCD,

    ROW_NUMBER () OVER (ORDER BY rmd.HSN_CODE )  AS SLNO,

	rmd.HSN_CODE  AS PRDDESC,     
	
    CASE WHEN XN_ITEM_TYPE =4 THEN 'Y' ELSE  'N' END AS ISSERVC,
   rmd.HSN_CODE AS HSNCD,
   rmd.HSN_CODE AS BARCDE,        
   CAST(SUM(rmd.INVOICE_QUANTITY) AS NUMERIC(10,3)) AS QTY,
   CAST(SUM(rmd.SCHEME_QUANTITY) AS NUMERIC(10,3)) AS FREEQTY,
    CASE WHEN ISNULL(UOM.GST_UOM_NAME,'')<>'' THEN LEFT(UOM.GST_UOM_NAME,3) ELSE UOM.UOM_NAME END AS UNIT,   

   CAST((XN_VALUE_WITHOUT_GST+(rmd.DISCOUNT_AMOUNT +rmd.RMMDISCOUNTAMOUNT)) /INVOICE_QUANTITY  AS NUMERIC(14,2)) AS UNITPRICE,
   CAST((sum(XN_VALUE_WITHOUT_GST+(RMD.DISCOUNT_AMOUNT +rmd.RMMDISCOUNTAMOUNT)))   AS NUMERIC(14,2)) AS TOTAMT, --SUBT
   CAST(sum(isnull(RMD.DISCOUNT_AMOUNT,0) +isnull(RMD.RMMDISCOUNTAMOUNT,0))  AS NUMERIC(10,2)) AS DISCOUNT,

   CAST(SUM(XN_VALUE_WITHOUT_GST) AS nUMERIC(14,2)) AS PRETAXVAL, 
   CAST(SUM(XN_VALUE_WITHOUT_GST) AS NUMERIC(14,2))  AS ASSAMT,-- ASSAMT IS SAME TOTAMT  -SUBT  
   rmd.GST_PERCENTAGE AS GSTRT,
   CAST(SUM(rmd.IGST_AMOUNT) AS NUMERIC(14,2)) AS IGSTAMT,
   CAST(SUM(rmd.CGST_AMOUNT) AS NUMERIC(14,2)) AS CGSTAMT,        
   CAST(SUM(rmd.CGST_AMOUNT) AS NUMERIC(14,2)) AS SGSTAMT,
   isnull(rmd.GST_CESS_PERCENTAGE,0) AS CESRT,
   SUM(isnull(rmd.gst_CESS_AMOUNT,0)) AS  CESAMT,        
   0 AS CESNONADVLAMT,0 AS STATECESRT,0 AS STATECESAMT,0 AS STATECESNONADVLAMT,0 AS OTHCHRG,   
  
   CAST(SUM(ISNULL(XN_VALUE_WITHOUT_GST,0)+ISNULL(CGST_AMOUNT,0)+ISNULL(SGST_AMOUNT,0)+ISNULL(IGST_AMOUNT,0)) aS nUMERIC(18,2)) AS TOTITEMVAL,

   0 AS ORDLINEREF,'IN' AS ORGCNTRY,CAST(0 AS INT) AS PRDSLNO,        
   COMPANY_NAME AS NM,'' AS EXPDT,'' AS WRDT,'' AS ATTR_NM,0 AS ATTR_VAL ,     
    
  --*******ValDtls***********  
       
   ASSVAL= cast(@NTABLABLEVALUE+isnull(a.other_charges_taxable_value,0)+isnull(a.freight_taxable_value,0)  as numeric(18,2)) ,--+ISNULL(@NDISCOUNT_AMOUNT,0)+A.DISCOUNT_AMOUNT ,--net_rate,---ASSVAL WITHOUT TAX VALE  --SUBT
   CGSTVAL=cast(@NCGSTVAL+isnull(a.other_charges_cgst_amount ,0)+isnull(a.freight_cgst_amount ,0) as numeric(18,2)) ,-- cgst_amount, ----@NCGSTVAL,    
   SGSTVAL=cast(@NSGSTVAL+isnull(a.other_charges_sgst_amount ,0)+isnull(a.freight_sgst_amount ,0) as numeric(18,2)),--sgst_amount,-- , 
   IGSTVAL=cast(@NIGSTVAL+isnull(a.other_charges_Igst_amount ,0)+isnull(a.freight_igst_amount ,0) as numeric(18,2)),--rmd.IGST_AMOUNT , --- ,   
   CESVAL=@NCESSaMOUNT,---rmd.CESS_AMOUNT , 
   
  -- @NCGSTVAL=SUM(CGST_AMOUNT),@NSGSTVAL=SUM(CGST_AMOUNT),@NCESSaMOUNT=SUM(CESS_AMOUNT),  
  --@NTABLABLEVALUE  
        
   STCESVAL=0,    
   DISCOUNTVAL=0,  ---rmd.DISCOUNT_AMOUNT TWO DISCOUNT COLUMN THEN THIS COLMN NAME CHANGE,        
   OTHCHRGVAL=0,     
   RNDOFFAMT=A.ROUND_OFF ,  --A.ROUND_OFF,        
   TOTINVVAL=A.total_amount ,   --A.NET_AMOUNT,    ---TOTINVVALUE  ASSVALUE+TAX VALE    
   TOTINVVALFC=CAST((@NTABLABLEVALUE+@NCGSTVAL+@NSGSTVAL+@NIGSTVAL+@NCESSaMOUNT
    +a.FREIGHT +a.OTHER_CHARGES+
   case when a.OH_TAX_METHOD =1 then 
   ISNULL(A.FREIGHT_IGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0)+ISNULL(A.FREIGHT_CGST_AMOUNT,0) 
   +ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)
   else 0 end 
   )  AS NUMERIC(18,2)), 
  
  --*******PayDtls***********  
      
   PAY_NM=isnull(bd.BF_AC_NAME,'-'),--MANADTORT MUST BE 11 CHARACTER    
   -- dm ACCDET='000705019105', ---bank ac number of payee      (mandetory) 
   ACCDET=isnull(bd.ACCOUNT_NO,'-')  , ---bank ac number of payee      (mandetory) 
    MODE='CREDIT'  ,        
   -- dm FININSBR='ICIC0000007',--bd.IFSC_CODE,---IFSC code      (mandetory) 
   FININSBR=isnull(bd.IFSC_CODE,'-') ,--bd.IFSC_CODE,---IFSC code      (mandetory) 
   PAYTERM=0,    
   PAYINSTR='PI',--payment instruction mandatory should be 1 character    
   CRTRN='CT',--CREDIT TRANSFER MANADATORY MIN 1CHARCTER    
   DIRDR='RR',----direct debit  MANADATORY MIN 1CHARCTER   
   CRDAY=A.CREDIT_DAYS ,        
   PAIDAMT=A.total_amount ,PAYMTDUE=0,INVRM='invrm',-- MANADATORY,    
   INVSTDT=convert(varchar(10),GETDATE(),103), -- MANADATORY,    
   INVENDDT= convert(varchar(10),GETDATE()+1,103), -- MANADATORY,    
     
    --*******RefDtls***********  
  
   -- INVNO= 'IN-'+LEFT(A.rm_id,2)+RIGHT(FIN_YEAR,2)+RIGHT(A.INV_NO,6),--A.INV_NO ,    
    INVNO=CASE WHEN (@CEINVOICE_PREFIX<>'' AND  LEFT(RTRIM(LTRIM(A.rm_no )),1)='0') THEN @CEINVOICE_PREFIX ELSE '' END+
    RTRIM(LTRIM(A.rm_no)), --A.INV_NO,--A.INV_NO ,    
  --INVNO=RTRIM(LTRIM(A.rm_no )),
   INVDT= convert(varchar(10),A.rm_dt ,103),  --A.INV_DT ,        
   OTHREFNO='OTH-'+A.rm_no,--MANADTORY    
   RECADVREFR='RF',--MANADTORY    
   RECADVDT=convert(varchar(10),GETDATE(),103),--MANADTORY    
   TENDREFR='TR-90',--MANADTORY    
   CONTRREFR='CR',--MANADTORY    
   EXTREFR='ER',--MANADTORY    
   PROJREFR='PR',--MANADTORY    
   POREFR='PR',--MANADTORY    
   POREFDT=convert(varchar(10),GETDATE(),103),  --MANADTORY      
  
   --ExpDtls--  
   SHIPBNO='NULL',--MANADTORY    5 CHARCETER  ---NOT STORE
   SHIPBDT=convert(varchar(10),GETDATE(),103),--MANADTORY      
   PORT=CAST('' AS VARCHAR(20)),--MANADTORY   FIX  
   REFCLM='N',--MANADTORY  only one charcter FIX  
   FORCUR='AED',--MANADTORY  THIS VALUE IS FIX 3 CHARCTER   
   CNTCODE='AE',--MANADTORY   THIS VALUE IS FIX 2 CHARACTER  
  
   --EwbDtls--  
   TRANSID=UPPER(case when ISNULL(TR.TRANSPORTER_GST_NO,'')='' then '' else TR.TRANSPORTER_GST_NO end), --MANADTORY  
   TRANSNAME=TRANSPORTER_NAME,  --MANADTORY  
   DISTANCE=0,-- NOT BE 0  
   TRANSDOCNO=case when ISNULL(bilty_no,'')='' then '' else bilty_no end,  --parcel_memo_no , --MANADTORY       
   TRANSDOCDT=convert(varchar(10),parcel_memo_dt ,103),--MANADTORY   
   VEHNO=case when ISNULL(vehicle_no,'')='' then '' else vehicle_no end ,--vehicle_no ,--MANADTORY   
   VEHTYPE='R',--MANADTORY   
   TRANSMODE=tr.mode  --MANADTORY  nUMERIC VALUE,  
   into #TMPINVOICE            
   FROM rmm01106 A (NOLOCK)        
   JOIN RMD01106  rmd (NOLOCK) ON A.rm_id =rmd.rm_id         
   JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =rmd.PRODUCT_CODE         
   JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU.ARTICLE_CODE         
   JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE         
   JOIN SKU_NAMES SN (NOLOCK) ON SN.PRODUCT_CODE =rmd.PRODUCT_CODE         
   JOIN LOC_VIEW L (NOLOCK) ON L.DEPT_ID =CASE WHEN ISNULL(ACCOUNTS_DEPT_ID,'')<>'' THEN ACCOUNTS_DEPT_ID ELSE  LEFT(A.rm_id,2)   END     
   LEFT JOIN GST_STATE_DET GD (NOLOCK) ON GD.GST_STATE_CODE =L.GST_STATE_CODE AND A.rm_dt BETWEEN GD.FM_DT AND GD.TO_DT         
   JOIN COMPANY C (NOLOCK) ON C.COMPANY_CODE ='01'        
   JOIN LMV01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE         
  LEFT JOIN #TRANSPORTER TR ON 1=1          
  left join LM01106 shlm (nolock) on shlm.AC_CODE =a.SHIPPING_AC_CODE 
  left join LMP01106 shlmp (nolock) on shlmp.AC_CODE =shlm.AC_CODE 
  LEFT JOIN AREA shAR (NOLOCK) ON shlmp.AREA_CODE=shAR.AREA_CODE                        
  LEFT JOIN CITY shCT (NOLOCK) ON shAR.CITY_CODE=shCT.CITY_CODE  
  LEFT JOIN GST_STATE_MST shCS (NOLOCK) ON shCS.GST_STATE_CODE=shLMP.AC_GST_STATE_CODE      
  LEFT JOIN GST_STATE_MST SHP (NOLOCK) ON ISNULL(SHP.GST_STATE_NAME,'')=ISNULL(a.SHIPPING_STATE_NAME,'')     
  left join LM_BANK_DETAIL bd (nolock) on bd.AC_CODE =L.control_ac_code   
  WHERE A.rm_id=@CXNID    and ISNULL(a.IRN_QR_CODE,'')=''
  and isnull(a.bill_challan_mode,0)=0
   group by UPPER(L.LOC_GST_NO), SUPPLY_TYPE_CODE,    
   --******SellerDtls******  
   RTRIM(LTRIM(A.rm_no )),
   convert(varchar,A.rm_dt ,103),  -- CONVERT INVDT NOT TIME      
   UPPER(L.LOC_GST_NO) ,L.DEPT_NAME ,L.DEPT_NAME ,-- L.DEPT_ALIAS TRADE NAME SHOULD BE MIN 3 CHARCATER      
   L.ADDRESS1 ,L.ADDRESS2 ,        
   L.AREA_NAME  ,l.PINCODE  ,-- PIN NO SHOULD NOT BE BLANK MOUST BE 6 CHARACTER      
   l.gst_state_code  ,---L.gst_state_code      
   l.phone  ,--L.PHONE MUST BE NOT BLANK SHOULD BE MIN 6 CHARCTAER      
   C.EMAIL_ID ,     
   UPPER(LM.AC_GST_NO) ,--LM.AC_GST_NO      
   LM.AC_NAME  ,      
   LM.AC_NAME  ,--LM.ALIAS NOT SHOULD BE BLANK  
   a.party_state_code ,      
   ISNULL(LM.ADDRESS0 ,'')+' '+ISNULL(LM.ADDRESS1 ,'')+' '+ISNULL(LM.ADDRESS2 ,'') ,-- LM.ADDRESS1 SHOULD NOT BE BLANK         
   LM.AREA_NAME +' '+lm.CITY   ,lm.PINCODE ,-- LM.PINCODE PIN CODE MATCH ADDRESS        
   a.party_state_code --LM.AC_GST_STATE_CODE  STCD IS NOT SAME STATECODE FOR b_STCd      
   ,case when isnull( LM.MOBILE,'')='' then lm.PHONES_O else lm.mobile end ,LM.E_MAIL  ,  
    CASE WHEN XN_ITEM_TYPE =4 THEN 'Y' ELSE  'N' END ,
 

      UPPER(CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHLMP.Ac_gst_no  
		   ELSE LM.Ac_gst_no  END) ,

      CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHLM.AC_NAME   
		   ELSE LM.AC_NAME  END ,

       CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHLM.AC_NAME   
		   ELSE LM.AC_NAME  END ,

       CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN LEFT(ISNULL(SHLMP.ADDRESS0 ,'')+' '+ISNULL(SHLMP.ADDRESS1 ,''),100)
		   ELSE Left(isnull(LM.ADDRESS0,'')+' '+isnull(LM.ADDRESS1,'')+' '+isnull(LM.ADDRESS2,''),100) END ,

	    CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN Substring(ISNULL(SHLMP.ADDRESS0 ,'')+' '+ISNULL(SHLMP.ADDRESS1 ,''),101,100)
		   ELSE substring(isnull(LM.ADDRESS0,'')+' '+isnull(LM.ADDRESS1,'')+' '+isnull(LM.ADDRESS2,''),101,100) END ,

         CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHAR.AREA_NAME  
		   ELSE lm.AREA_NAME  END ,
         
		  CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHAR.pincode   
		   ELSE lm.PINCODE    END ,

		   CASE WHEN @NPICKINGSHIPPINGADDRESS=1 THEN SHcs.gst_state_code   
		   ELSE lm.ac_gst_state_code     END ,
   rmd.HSN_CODE,
   CASE WHEN ISNULL(UOM.GST_UOM_NAME,'')<>'' THEN LEFT(UOM.GST_UOM_NAME,3) ELSE UOM.UOM_NAME END,       
   rmd.GST_PERCENTAGE ,isnull(rmd.GST_CESS_PERCENTAGE,0) ,      
  CAST((XN_VALUE_WITHOUT_GST+(rmd.DISCOUNT_AMOUNT +rmd.RMMDISCOUNTAMOUNT)) /INVOICE_QUANTITY  AS NUMERIC(14,2)) ,
  --*******ValDtls***********  
   A.ROUND_OFF ,  --A.ROUND_OFF,        
   A.total_amount ,   --A.NET_AMOUNT,    ---TOTINVVALUE  ASSVALUE+TAX VALE    
   CAST((a.FREIGHT +a.OTHER_CHARGES+
   case when a.OH_TAX_METHOD =1 then 
   ISNULL(A.FREIGHT_IGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0)+ISNULL(A.FREIGHT_CGST_AMOUNT,0) 
   +ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)
  
   else 0 end 
   )  AS NUMERIC(18,2)), 
  
  --*******PayDtls***********  
  isnull(bd.BF_AC_NAME,'-'),--MANADTORT MUST BE 11 CHARACTER    
  isnull(bd.ACCOUNT_NO,'-')  , ---bank ac number of payee      (mandetory) 
  isnull(bd.IFSC_CODE,'-') ,--bd.IFSC_CODE,---IFSC code      (mandetory) 
  A.CREDIT_DAYS ,
   lm.Ac_gst_no, --MANADTORY  
   TRANSPORTER_NAME,  --MANADTORY  
   isnull(a.ewaydistance,0),-- NOT BE 0  
   parcel_memo_no ,bilty_no, --MANADTORY       
   convert(varchar(10),parcel_memo_dt ,103),--MANADTORY   
   tr.mode,COMPANY_NAME,
   A.OTHER_CHARGES_TAXABLE_VALUE,A.FREIGHT_TAXABLE_VALUE,
   A.other_charges_cgst_amount ,A.other_charges_Sgst_amount,A.other_charges_Igst_amount,
   A.FREIGHT_cgst_amount ,
   A.FREIGHT_Sgst_amount ,
   A.FREIGHT_Igst_amount ,
   A.FREIGHT,A.OTHER_CHARGES  ,A.OH_TAX_METHOD  ,A.rm_dt  ,A.rm_no ,
   case when ISNULL(TR.TRANSPORTER_GST_NO,'')='' then '' else TR.TRANSPORTER_GST_NO end,
   case when ISNULL(vehicle_no,'')='' then '' else vehicle_no end

    Update #TMPINVOICE set SUPTYP='B2B' where isnull(SUPTYP,'')=''


UPDATE A SET ADDRESS1=(CASE WHEN  LEN(ADDRESS1)<=3 THEN ADDRESS1+'...' ELSE ADDRESS1 END),
       ADDRESS2=(CASE WHEN  LEN(ADDRESS2)<=3 THEN ADDRESS2+'...' ELSE ADDRESS2 END),

	   ADDR1=(CASE WHEN  LEN(ADDR1)<=3 THEN ADDR1+'...' ELSE ADDR1 END),
	   ADDR2=(CASE WHEN  LEN(ADDR2)<=3 THEN ADDR2+'...' ELSE ADDR2 END),

	   DIS_ADDR1=(CASE WHEN  LEN(DIS_ADDR1)<=3 THEN DIS_ADDR1+'...' ELSE DIS_ADDR1 END),
	   DIS_ADDR2=(CASE WHEN  LEN(DIS_ADDR2)<=3 THEN DIS_ADDR2+'...' ELSE DIS_ADDR2 END),

	   SHIP_ADDR1=(CASE WHEN  LEN(SHIP_ADDR1)<=3 THEN SHIP_ADDR1+'...' ELSE SHIP_ADDR1 END),
	   SHIP_ADDR2=(CASE WHEN  LEN(SHIP_ADDR2)<=3 THEN SHIP_ADDR2+'...' ELSE SHIP_ADDR2 END)

FROM #TMPINVOICE A

  IF OBJECT_ID ('TEMPDB..#TMPOVERHEAD','U') IS NOT NULL
    drop table #TMPOVERHEAD

	 SELECT TOP 1 * INTO #TMPOVERHEAD FROM #TMPINVOICE




		 INSERT #TMPINVOICE	( TAXSCH, SUPTYP, REGREV, ECMGSTIN, IGSTONINTRA, TYP, NO, INV_DT, GSTIN, LGLNM, TRDNM, ADDRESS1, ADDRESS2, LOC, PIN, STCD, PH, EM, B_GSTIN, B_LGLNM, B_TRDNM,
		  POS, ADDR1, ADDR2, B_LOC, B_PIN, B_STCD, B_PH, B_EM, DIS_NM, DIS_ADDR1, DIS_ADDR2, DIS_LOC, DIS_PIN, DIS_STCD, SHIP_GSTIN, SHIP_LGLNM, SHIP_TRDNM, SHIP_ADDR1, SHIP_ADDR2, SHIP_LOC, 
		  SHIP_PIN, SHIP_STCD, SLNO, PRDDESC, ISSERVC, HSNCD, BARCDE, QTY, FREEQTY, UNIT, UNITPRICE, TOTAMT, DISCOUNT, PRETAXVAL, ASSAMT, GSTRT, IGSTAMT, CGSTAMT, SGSTAMT, CESRT, CESAMT, 
		  CESNONADVLAMT, STATECESRT, STATECESAMT, STATECESNONADVLAMT, OTHCHRG, TOTITEMVAL, ORDLINEREF, ORGCNTRY, PRDSLNO, NM, EXPDT, WRDT, ATTR_NM, ATTR_VAL, ASSVAL, CGSTVAL, SGSTVAL, 
		  IGSTVAL, CESVAL, STCESVAL, DISCOUNTVAL, OTHCHRGVAL, RNDOFFAMT, TOTINVVAL, TOTINVVALFC, PAY_NM, ACCDET, MODE, FININSBR, PAYTERM, PAYINSTR, CRTRN, DIRDR, CRDAY, PAIDAMT, PAYMTDUE, 
		  INVRM, INVSTDT, INVENDDT, INVNO, INVDT, OTHREFNO, RECADVREFR, RECADVDT, TENDREFR, CONTRREFR, EXTREFR, PROJREFR, POREFR, POREFDT, SHIPBNO, SHIPBDT, PORT, REFCLM, FORCUR, CNTCODE, 
		  TRANSID, TRANSNAME, DISTANCE, TRANSDOCNO, TRANSDOCDT, VEHNO, VEHTYPE, TRANSMODE )  

		 SELECT 	TOP 1  TAXSCH, SUPTYP, REGREV, ECMGSTIN, IGSTONINTRA, TYP, NO, A.INV_DT, GSTIN, LGLNM, TRDNM, ADDRESS1, ADDRESS2, LOC, PIN, STCD, PH, EM, B_GSTIN, B_LGLNM, B_TRDNM, 
		 POS, ADDR1, ADDR2, B_LOC, B_PIN, B_STCD, B_PH, B_EM, DIS_NM, DIS_ADDR1, DIS_ADDR2, DIS_LOC, DIS_PIN, DIS_STCD, SHIP_GSTIN, SHIP_LGLNM, SHIP_TRDNM, SHIP_ADDR1, SHIP_ADDR2, SHIP_LOC, 
		 SHIP_PIN, SHIP_STCD, SLNO,'Other Charges' PRDDESC, 'Y', other_charges_hsn_code  HSNCD,'Other Charges' BARCDE,1 QTY,0 FREEQTY, UNIT, 
		 UNITPRICE= CAST(b.OTHER_CHARGES   
		   -(CASE WHEN B.OH_TAX_METHOD =2 THEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) ELSE 0 END)
		   AS NUMERIC(18,2)), 
		 TOTAMT=CAST(b.OTHER_CHARGES   
		   -(CASE WHEN B.OH_TAX_METHOD =2 THEN ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_IGST_AMOUNT,0) ELSE 0 END)
		   AS NUMERIC(18,2)), 
		 DISCOUNT=0, 
		 PRETAXVAL=OTHER_CHARGES_TAXABLE_VALUE , 
		 ASSAMT=OTHER_CHARGES_TAXABLE_VALUE, 
		 GSTRT=other_charges_gst_percentage , 
		 IGSTAMT=isnull(other_charges_igst_amount,0) , 
		 CGSTAMT=isnull(other_charges_cgst_amount,0) , 
		 SGSTAMT=isnull(other_charges_sgst_amount,0) , 
		 0 CESRT,0 CESAMT, 
		 0 CESNONADVLAMT,0  STATECESRT,0 STATECESAMT,0 STATECESNONADVLAMT, OTHCHRG, 
		 TOTITEMVAL=   ISNULL(OTHER_CHARGES_TAXABLE_VALUE ,0)+ISNULL(other_charges_CGST_AMOUNT,0)+ISNULL(other_charges_SGST_AMOUNT,0)+ISNULL(other_charges_IGST_AMOUNT,0) ,
		  ORDLINEREF, ORGCNTRY, PRDSLNO, NM, EXPDT, WRDT, ATTR_NM, ATTR_VAL, 
		  ASSVAL, CGSTVAL, SGSTVAL,  IGSTVAL,0 CESVAL,0 STCESVAL,0 DISCOUNTVAL,0 OTHCHRGVAL, RNDOFFAMT, TOTINVVAL, TOTINVVALFC, PAY_NM, ACCDET, a.MODE, FININSBR, PAYTERM, PAYINSTR, CRTRN, DIRDR, CRDAY, PAIDAMT, PAYMTDUE, 
		 INVRM, INVSTDT, INVENDDT, INVNO, INVDT, OTHREFNO, RECADVREFR, RECADVDT, TENDREFR, CONTRREFR, EXTREFR, PROJREFR, POREFR, POREFDT, SHIPBNO, SHIPBDT, PORT, REFCLM, FORCUR, CNTCODE, 
		 TRANSID, TRANSNAME, DISTANCE, TRANSDOCNO, TRANSDOCDT, VEHNO, VEHTYPE, TRANSMODE 
		 FROM #TMPOVERHEAD A
		 JOIN RMM01106 B ON 1=1
		 WHERE B.RM_ID=@CXNID
		 AND B.OTHER_CHARGES <>0
		 union all
		 SELECT 	TOP 1  TAXSCH, SUPTYP, REGREV, ECMGSTIN, IGSTONINTRA, TYP, NO, A.INV_DT, GSTIN, LGLNM, TRDNM, ADDRESS1, ADDRESS2, LOC, PIN, STCD, PH, EM, B_GSTIN, B_LGLNM, B_TRDNM, 
		 POS, ADDR1, ADDR2, B_LOC, B_PIN, B_STCD, B_PH, B_EM, DIS_NM, DIS_ADDR1, DIS_ADDR2, DIS_LOC, DIS_PIN, DIS_STCD, SHIP_GSTIN, SHIP_LGLNM, SHIP_TRDNM, SHIP_ADDR1, SHIP_ADDR2, SHIP_LOC, 
		 SHIP_PIN, SHIP_STCD, SLNO,'Freight' PRDDESC, 'Y', Freight_hsn_code  HSNCD,'Freight' BARCDE,1 QTY,0 FREEQTY, UNIT, 
		 UNITPRICE= CAST(b.Freight   
		   -(CASE WHEN B.OH_TAX_METHOD =2 THEN ISNULL(Freight_CGST_AMOUNT,0)+ISNULL(Freight_SGST_AMOUNT,0)+ISNULL(Freight_IGST_AMOUNT,0) ELSE 0 END)
		   AS NUMERIC(18,2)), 
		 TOTAMT=CAST(b.Freight   
		   -(CASE WHEN B.OH_TAX_METHOD =2 THEN ISNULL(Freight_CGST_AMOUNT,0)+ISNULL(Freight_SGST_AMOUNT,0)+ISNULL(Freight_IGST_AMOUNT,0) ELSE 0 END)
		   AS NUMERIC(18,2)), 
		 DISCOUNT=0, 
		 PRETAXVAL=Freight_TAXABLE_VALUE , 
		 ASSAMT=Freight_TAXABLE_VALUE, 
		 GSTRT=Freight_gst_percentage , 
		 IGSTAMT=isnull(Freight_igst_amount,0) , 
		 CGSTAMT=isnull(Freight_cgst_amount,0) , 
		 SGSTAMT=isnull(Freight_sgst_amount,0) , 
		 0 CESRT,0 CESAMT, 
		 0 CESNONADVLAMT,0  STATECESRT,0 STATECESAMT,0 STATECESNONADVLAMT, OTHCHRG, 
		 TOTITEMVAL=   ISNULL(Freight_TAXABLE_VALUE ,0)+ISNULL(Freight_CGST_AMOUNT,0)+ISNULL(Freight_SGST_AMOUNT,0)+ISNULL(Freight_IGST_AMOUNT,0) ,
		  ORDLINEREF, ORGCNTRY, PRDSLNO, NM, EXPDT, WRDT, ATTR_NM, ATTR_VAL, 
		  ASSVAL, CGSTVAL, SGSTVAL,  IGSTVAL,0 CESVAL,0 STCESVAL,0 DISCOUNTVAL,0 OTHCHRGVAL, RNDOFFAMT, TOTINVVAL, TOTINVVALFC, PAY_NM, ACCDET, a.MODE, FININSBR, PAYTERM, PAYINSTR, CRTRN, DIRDR, CRDAY, PAIDAMT, PAYMTDUE, 
		 INVRM, INVSTDT, INVENDDT, INVNO, INVDT, OTHREFNO, RECADVREFR, RECADVDT, TENDREFR, CONTRREFR, EXTREFR, PROJREFR, POREFR, POREFDT, SHIPBNO, SHIPBDT, PORT, REFCLM, FORCUR, CNTCODE, 
		 TRANSID, TRANSNAME, DISTANCE, TRANSDOCNO, TRANSDOCDT, VEHNO, VEHTYPE, TRANSMODE 
		 FROM #TMPOVERHEAD A
		 JOIN RMM01106 B ON 1=1
		 WHERE B.RM_ID=@CXNID
		 AND B.Freight <>0
		
		 ;with CTE as 
		 (
			select NEWSRNO =ROW_NUMBER () OVER (ORDER BY CASE WHEN BARCDE IN('OTHER CHARGES','FREIGHT') THEN 1 ELSE 0 END ,SLNO ),* from  #TMPINVOICE a
		 )

		 UPDATE CTE SET SLNO  =NEWSRNO

	
	  SELECT *   
	  FROM #TMPINVOICE  
      ORDER BY SLNO  

	 DECLARE @CERRMSG VARCHAR(1000)
	 SET @CERRMSG=''
	  
	IF EXISTS (SELECT TOP 1'U' FROM #TMPINVOICE where isnull(PIN,'')='' )
	BEGIN
	   SET  @CERRMSG='LOcation Pin can not be blank Please check '
	   GOTO END_PROC

	END
	IF EXISTS (SELECT TOP 1'U' FROM #TMPINVOICE where isnull(B_PIN,'')='' )
	BEGIN
	   SET  @CERRMSG='Customer Pin can not be blank Please check '
	   GOTO END_PROC

	END
	IF EXISTS (SELECT TOP 1'U' FROM #TMPINVOICE where isnull(DIS_PIN,'')='' )
	BEGIN
	   SET  @CERRMSG='Dispatch Pin can not be blank Please check '
	   GOTO END_PROC

	END
	IF EXISTS (SELECT TOP 1'U' FROM #TMPINVOICE where isnull(SHIP_PIN,'')='' )
	BEGIN
	   SET  @CERRMSG='Shipping Pin can not be blank Please check '
	   GOTO END_PROC

	END

	IF EXISTS (SELECT TOP 1 'U'  FROM rmm01106  A (NOLOCK) WHERE rm_id =@CXNID AND isnull(EINV_IRN_NO,'')<>'' )
	BEGIN
	     SET  @CERRMSG='Irn No Already Generated of  this memo Please Check '
		 GOTO END_PROC
   	END
  
   END_PROC:
   SELECT @CERRMSG AS ERRMSG
		

END  
--new