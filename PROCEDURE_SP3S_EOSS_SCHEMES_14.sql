/*BUY N GET N (BUY 2 SHIRTS GET 1 SHIRT FREE,BUY 3 GET 2 FREE) (BUY 3 TROUSERS GET 1 TROUSER AT 399,BUY 4 SHIRTS GET 2 SHIRTS AT 299)
MAKE A SET OF ITEMS IN THE ORDER OF ENTRY AND GIVE DISCOUNT ON LOWEST MRP ITEM OF THE SET
THE SET ITEMS SHOULD BELONG TO SAME FILTER
*/	
CREATE PROCEDURE SP3S_EOSS_SCHEMES_14
(
	@CSCHEMEDETROWID VARCHAR(50),
	@CSLSTITLE VARCHAR(500),
	@CROUNDITEMLEVEL VARCHAR(5),
	@CJOINSTRBUY VARCHAR(MAX),
	@CJOINSTRGET VARCHAR(MAX),
	@CPICKSLRDISCMODE VARCHAR(5),
	@NSPID VARCHAR(40),
	@CERRMSG VARCHAR(MAX) OUTPUT
)
AS 
BEGIN

	DECLARE @NBUYQTY NUMERIC(10,2),@NGETAMT NUMERIC(10,2),@NGETQTY NUMERIC(10,2),
			@NREQGETQTY NUMERIC(10,2),@CPRODUCTCODE VARCHAR(50),@NMRP NUMERIC(10,2),@NQTY NUMERIC(10,2),
			@CCMDROWID VARCHAR(50),@NLOOPCNT INT,@NMODE INT,@BQUALIFIED BIT,
			@CROWID VARCHAR(100),@NSTEP INT,@NAMT NUMERIC(10,2),
			@CMRPORDER VARCHAR(10),@NREQBUYAMT NUMERIC(10,2),@BRETRY2NDCASE BIT,
			@CCMD NVARCHAR(MAX),@NDISCMODE INT,@NDISCPCT NUMERIC(7,3),@NDISCAMT NUMERIC(10,2),
			@NNETRATE NUMERIC(10,2),@CBUYFILTER VARCHAR(MAX),@CGETFILTER VARCHAR(MAX),
			@CADDFILTER VARCHAR(MAX),@CORGADDFILTER VARCHAR(MAX),@NFILTERMODE INT,@BHIGHERMRPFOUNDINGETITEM BIT,
			@BPROCESSSLRENTRY BIT,@NGETFILTERMODE INT,@CAPPLYSCHEMEONHIGHERPRICE VARCHAR(2),
			@BAPPLYSCHEMEONDISCITEMS BIT,@NMINMRP NUMERIC(10,2),@NSRNO NUMERIC(3,0),@NMAXSRNO NUMERIC(3,0),
			@NBUNDLELEVEL NUMERIC(3,0),@NBUNDLELOOP NUMERIC(3,0),@NQUALIFYINGQTY NUMERIC(3,0)
	
	SET @BPROCESSSLRENTRY=0
				
START_PROC:
	SELECT @NBUYQTY=0,@CPRODUCTCODE='',@NGETAMT=0,@NMRP=0,@NQTY=0,@NGETQTY=0,
		   @CCMDROWID='',@NLOOPCNT=0,@NREQGETQTY=0,
		   @NMODE=0,@BQUALIFIED=0,@CROWID='',@NSTEP=0,@NAMT=0,@CMRPORDER='',
		   @NREQBUYAMT=0,@BRETRY2NDCASE=0,@CCMD='',@NDISCMODE=0,@CBUYFILTER='',
		   @CGETFILTER='',@CADDFILTER='',@NFILTERMODE=0,@NDISCPCT=0,@NDISCAMT=0,
		   @NNETRATE=0,@NGETFILTERMODE=0,@CORGADDFILTER='',@NMINMRP=0,@NMAXSRNO=0,
		   @NBUNDLELOOP=0,@NQUALIFYINGQTY=0
			
	
	PRINT 'START SP3S_EOSS_SCHEMES_14'
	
	--IF @CSLSTITLE='BUY 1 GET 1'
	--	SELECT 'START CHECK SCHEMES_3 FOR BUY 1 GET 1',(CASE WHEN @BPROCESSSLRENTRY=1 THEN 'SLR' ELSE 'SLS' END) AS XN_TYPE,* FROM #TMPCMD
	
	SELECT @BAPPLYSCHEMEONDISCITEMS=ISNULL(APPLY_SCHEME_ON_DISCOUNTED_ITEMS,0) FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
	
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMD A WHERE (@BAPPLYSCHEMEONDISCITEMS=1 AND (ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 
				   OR A.SCHEME_SETUP_DET_ROW_ID<>@CSCHEMEDETROWID))OR (@BAPPLYSCHEMEONDISCITEMS=0 
				   AND (ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 AND (a.SCHEME_SETUP_DET_ROW_ID='' OR a.SCHEME_APPLIED_QTY=0))))
		GOTO END_PROC

	IF @BPROCESSSLRENTRY=1
		SET @CORGADDFILTER='A.QUANTITY<0'
	ELSE
		SET @CORGADDFILTER='A.QUANTITY>0'
	
	IF CURSOR_STATUS('GLOBAL','SCHEMECUR') IN (0,1)
	BEGIN
		CLOSE SCHEMECUR
		DEALLOCATE SCHEMECUR
	END

BEGIN TRY        
	
	PRINT 'CHECK SCHEME SP3S_EOSS_SCHEMES_14' 	
	SET @NSTEP=10
		
	SELECT @CMRPORDER='',@BQUALIFIED=0,@BRETRY2NDCASE=0
		
	IF OBJECT_ID('TEMPDB..#TEMPCMDPREV','U') IS NOT NULL
		DROP TABLE #TEMPCMDPREV

	IF OBJECT_ID('TEMPDB..#TMPCMDSCHEMES','U') IS NOT NULL
		DROP TABLE #TMPCMDSCHEMES
	
	SET @NSTEP=15
	SELECT PRODUCT_CODE,MRP,QUANTITY,CMD_ROW_ID AS ROW_ID,
	CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT,QUANTITY AS GET_QUANTITY,
	QUANTITY AS SCHEME_APPLIED_QTY,CONVERT(INT,0) AS SR_NO,CONVERT(NUMERIC(1,0),0) AS MODE
	INTO #TMPCMDSCHEMES FROM #TMPCMD WHERE 1=2 

	SELECT @NDISCMODE=DISC_METHOD,@NDISCPCT=DISCOUNT_PERCENTAGE,@NDISCAMT=DISCOUNT_AMOUNT,@NNETRATE=NET_PRICE,
		   @NFILTERMODE=FILTER_MODE
	FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
	
	SELECT @NBUNDLELEVEL=BUNDLES_LEVEL FROM SCHEME_SETUP_SCH0014_1 WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID
		
	SET @NSTEP=20
	
	SELECT @CADDFILTER=@CORGADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''''
	
	SET @NBUNDLELOOP=1
					
	WHILE @NBUNDLELOOP<=@NBUNDLELEVEL
	BEGIN
		SELECT @CBUYFILTER=(CASE WHEN @NBUNDLELOOP=1 THEN  B1_FILTER_CRITERIA WHEN @NBUNDLELOOP=2 THEN  B2_FILTER_CRITERIA
		WHEN @NBUNDLELOOP=3 THEN  B3_FILTER_CRITERIA WHEN @NBUNDLELOOP=4 THEN  B4_FILTER_CRITERIA 
		ELSE  B5_FILTER_CRITERIA END)
		FROM SCHEME_SETUP_SCH0014_1 WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID
		
		SET @CCMD=N' SELECT A.PRODUCT_CODE,A.MRP,'+(CASE WHEN @BAPPLYSCHEMEONDISCITEMS=1 THEN 'ABS(A.QUANTITY) ' ELSE 
   					 '(ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY) ' END)+'*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END),
   					 A.CMD_ROW_ID AS ROW_ID,0 AS DISCOUNT_AMOUNT,0 AS GET_QUANTITY,0 AS SCHEME_APPLIED_QTY,CMDU.SR_NO,
   					 '+LTRIM(RTRIM(STR(@NBUNDLELOOP)))+' AS MODE 
   					 FROM #TMPCMD A 
					 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTRBUY+'
					 JOIN SLS_CMD01106_UPLOAD CMDU ON A.CMD_ROW_ID=CMDU.ROW_ID WHERE '+
					 (CASE WHEN @BAPPLYSCHEMEONDISCITEMS=1 THEN ' (ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 OR A.SCHEME_SETUP_DET_ROW_ID<>'''+@CSCHEMEDETROWID+''') AND '
						   ELSE '(ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0  AND (a.SCHEME_SETUP_DET_ROW_ID='''' OR a.SCHEME_APPLIED_QTY=0))  AND ' END)+@CBUYFILTER+'
					 AND CMDU.SP_ID='''+LTRIM(RTRIM(@NSPID))+'''' 	   
					 
		
		PRINT @CCMD
					 
		INSERT #TMPCMDSCHEMES
		EXEC SP_EXECUTESQL @CCMD
		
		SET @NBUNDLELOOP=@NBUNDLELOOP+1
	END
	
	--IF @@SPID=167
	--	SELECT 'CHECK CMDSCHEMES',A.* FROM #TMPCMDSCHEMES A

	--JOIN SKU B ON A.PRODUCT_CODE=B.PRODUCT_CODE
	--JOIN ARTICLE C ON C.ARTICLE_CODE=B.ARTICLE_CODE
	--JOIN SECTIOND D ON D.SUB_SECTION_CODE=C.SUB_SECTION_CODE
	--JOIN SECTIONM E ON E.SECTION_CODE=D.SECTION_CODE
	
	SET @NSTEP=30		
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMDSCHEMES WHERE MODE=1)
	 OR NOT EXISTS (SELECT TOP 1 * FROM #TMPCMDSCHEMES WHERE MODE=2 OR @NBUNDLELEVEL=1)	
	BEGIN   
		SET @NSTEP=40
		IF @BPROCESSSLRENTRY=0 AND @CPICKSLRDISCMODE<>'3'
		BEGIN
			SET @BPROCESSSLRENTRY=1
			GOTO START_PROC
		END	
		ELSE
			GOTO END_PROC	
	END
	
	SET @NSTEP=50
	
	SELECT * INTO #TEMPCMDPREV FROM #TMPCMDSCHEMES

LBL1STCASE:
	
	
--	SELECT * FROM #TMPCMDSCHEMES
		
	SELECT @NREQGETQTY=0,@NMINMRP=0,@NMAXSRNO=0
			
	SET @NSTEP=60
	
	SET @CAPPLYSCHEMEONHIGHERPRICE = ''
	
	--SELECT 'SELECTED ROWS TO PROCESS',* FROM #TMPSCHEMEROWS

	SET @NBUNDLELOOP=1
					
	WHILE @NBUNDLELOOP<=@NBUNDLELEVEL
	BEGIN	
		SELECT @NQUALIFYINGQTY=(CASE WHEN @NBUNDLELOOP=1 THEN B1_QTY WHEN @NBUNDLELOOP=2 THEN B2_QTY
		WHEN @NBUNDLELOOP=3 THEN B3_QTY WHEN @NBUNDLELOOP=4 THEN B4_QTY ELSE B5_QTY END)
		FROM SCHEME_SETUP_SCH0014_1 WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID
		
		SELECT @NBUYQTY=0,@BQUALIFIED=0
		
		
		DECLARE SCHEMECUR CURSOR FOR
		SELECT A.PRODUCT_CODE,A.MRP,A.QUANTITY,A.ROW_ID,SR_NO FROM
		#TMPCMDSCHEMES A WHERE MODE=@NBUNDLELOOP ORDER BY SR_NO
	
		
		OPEN SCHEMECUR
		FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID,@NSRNO
		WHILE @@FETCH_STATUS=0
		BEGIN
			SET @NSTEP=70
							
			SET @NLOOPCNT=1
			WHILE @NLOOPCNT<=ABS(@NQTY)
			BEGIN
				SET @NBUYQTY=@NBUYQTY+1
			    
				SET @NSTEP=80
				UPDATE #TMPCMDSCHEMES SET SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+1
				WHERE ROW_ID=@CCMDROWID
			    		    
				IF @NBUYQTY=@NQUALIFYINGQTY
				BEGIN
					SET @BQUALIFIED=1				
					BREAK
				END
			
				SET @NLOOPCNT=@NLOOPCNT+1
			END										
			
			IF @BQUALIFIED=1
				BREAK
				
			FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID,@NSRNO
		END
		CLOSE SCHEMECUR
		DEALLOCATE SCHEMECUR
		
		IF @BQUALIFIED=0
			BREAK
		
		SET @NBUNDLELOOP=@NBUNDLELOOP+1
		
	END	
	
	IF @BQUALIFIED=0
		GOTO EXIT_PROC
			
	
END TRY
	
BEGIN CATCH
	  PRINT 'CATCH START OF SP3S_EOSS_SCHEMES_14'       
	  SET @CERRMSG='P:SP3S_EOSS_SCHEMES_14, STEP:'+LTRIM(RTRIM(STR(@NSTEP)))+', MESSAGE:'+ERROR_MESSAGE()        
	  GOTO END_PROC
END CATCH
	
EXIT_PROC:
		
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
		IF @BQUALIFIED=0
		BEGIN
			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=0
		END	
		ELSE
		BEGIN
			
			--IF @CSLSTITLE='BUY 1 GET 1'
			--	SELECT 'BEFORE QUALIFIED CHECK SCHEMES_10 FOR BUY 1 GET 1',(CASE WHEN @BPROCESSSLRENTRY=1 THEN 'SLR' ELSE 'SLS' END) AS XN_TYPE,* FROM #TMPCMD
			
			print 'Qualified for schemes SP3S_EOSS_SCHEMES_14'
			IF @NDISCMODE IN (2,3)
			BEGIN
				SELECT @NAMT=SUM(MRP) FROM #TMPCMDSCHEMES WHERE SCHEME_APPLIED_QTY<>0  
				IF @NDISCMODE=2
					SET @NDISCAMT=(CASE WHEN @NAMT>@NNETRATE THEN (@NAMT-@NNETRATE) ELSE @nAmt END)
									
				SET @NDISCPCT=ROUND((@NDISCAMT/@NAMT)*100,2)
			END
			
			
			--IF @@SPID=167
			--	SELECT @NDISCPCT AS NDISCPCT,@NDISCAMT AS NDISCAMT,@NAMT AS NAMT,@NNETRATE AS NNETRATE,*
			--	FROM #TMPCMDSCHEMES WHERE SCHEME_APPLIED_QTY<>0 

			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=(CASE WHEN @CROUNDITEMLEVEL='1' THEN ROUND(MRP*@NDISCPCT/100,0) ELSE MRP*@NDISCPCT/100 END)
			*(case when QUANTITY<0 THEN -1 ELSE 1 END)

			WHERE SCHEME_APPLIED_QTY<>0
			
			UPDATE #TMPCMD SET DISCOUNT_AMOUNT=#TMPCMD.DISCOUNT_AMOUNT+(B.DISCOUNT_AMOUNT*
			(CASE WHEN @BPROCESSSLRENTRY=1 THEN -1 ELSE 1 END)) ,
			SLS_TITLE=SLS_TITLE+(CASE WHEN SLS_TITLE<>'' THEN ',' ELSE '' END)+@CSLSTITLE,
			SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
			SCHEME_APPLIED_QTY=#TMPCMD.SCHEME_APPLIED_QTY+B.SCHEME_APPLIED_QTY,
			BNGN_QTY=BNGN_QTY+B.SCHEME_APPLIED_QTY,
			BNGN_DISCOUNT=BNGN_DISCOUNT+B.DISCOUNT_AMOUNT
			FROM #TMPCMDSCHEMES B WHERE B.ROW_ID=#TMPCMD.CMD_ROW_ID 
			AND B.SCHEME_APPLIED_QTY<>0
			
			UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ABS(ROUND((DISCOUNT_AMOUNT/(MRP*QUANTITY))*100,2)),
			NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT
			
			--IF @@SPID=167
			--SELECT 'AFTER QUALIFIED BUNDLING SCHEME',(CASE WHEN @BPROCESSSLRENTRY=1 THEN 'SLR' ELSE 'SLS' END) AS XN_TYPE,* FROM #TMPCMD
		END		

		--SELECT 'AFTER APPLYING SP3S_EOSS_SCHEMES_3',* FROM #TMPCMD
	
		IF @BPROCESSSLRENTRY=0 AND @BQUALIFIED=1
		BEGIN
			--SELECT 'COME OUT OF LOOP-1'
			IF EXISTS (SELECT TOP 1 * FROM #TMPCMD A WHERE (@BAPPLYSCHEMEONDISCITEMS=1 AND (A.QUANTITY-A.SCHEME_APPLIED_QTY>0 
				   OR A.SCHEME_SETUP_DET_ROW_ID<>@CSCHEMEDETROWID))OR (@BAPPLYSCHEMEONDISCITEMS=0 
				   AND A.QUANTITY-A.SCHEME_APPLIED_QTY>0))
				GOTO START_PROC
		END
		ELSE
		IF @BPROCESSSLRENTRY=1 AND @BQUALIFIED=1
		BEGIN
			--SELECT 'COME OUT OF LOOP-2'
			IF EXISTS (SELECT TOP 1 * FROM #TMPCMD A WHERE (@BAPPLYSCHEMEONDISCITEMS=1 AND (ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 
				   OR A.SCHEME_SETUP_DET_ROW_ID<>@CSCHEMEDETROWID))OR (@BAPPLYSCHEMEONDISCITEMS=0 
				   AND ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0) AND QUANTITY<0)
				GOTO START_PROC		
		END		
		
		IF @BPROCESSSLRENTRY=0 AND @CPICKSLRDISCMODE<>'3'
		BEGIN
			--SELECT 'COME OUT OF LOOP-3'
			SET @BPROCESSSLRENTRY=1
			GOTO START_PROC
		END	
		ELSE
		BEGIN
			--SELECT 'COME OUT OF LOOP-4'
			GOTO END_PROC
		END		
	END	
	ELSE
	BEGIN
		--SELECT 'COME OUT OF LOOP-5'
		GOTO END_PROC
	END
END_PROC:
	PRINT 'FINISH SP3S_EOSS_SCHEMES_14'
		
	--IF @CSLSTITLE='BUY 5 QTY GET 2 FREE'
	--	SELECT 'LAST STEP :'+STR(@NSTEP)	
END
----- END OF PROCEDURE SP3S_EOSS_SCHEMES_14