CREATE PROCEDURE SP3S_GETBO
(
	 @DFROMDT DATETIME
	,@DTODT DATETIME
)
--WITH ENCRYPTION
AS
BEGIN	
        
        IF OBJECT_ID ('TEMPDB..#ORDDLV','U') IS NOT NULL
            DROP TABLE #ORDDLV
           
    	SELECT A.CUSTOMER_CODE
			  ,A.CM_NO 
			  ,A.CM_DT 
			  ,B.PRODUCT_CODE   
			  ,B.QUANTITY
		INTO #ORDDLV	  	  
		FROM CMM01106 A (NOLOCK) 
		JOIN CMD01106 B (NOLOCK) ON A.CM_ID=B.CM_ID
		JOIN WSL_ORDER_DET WOD (NOLOCK) ON B.PRODUCT_CODE=
							(CASE WHEN WOD.ORDER_TYPE=0 THEN WOD.PRODUCT_CODE ELSE WOD.REF_PRODUCT_CODE END)
		JOIN WSL_ORDER_MST WOM (NOLOCK) ON WOD.ORDER_ID=WOM.ORDER_ID AND A.CUSTOMER_CODE=WOM.CUSTOMER_CODE
		WHERE A.CM_MODE = 1 AND B.RFNET>0
		AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000' AND WOM.CANCELLED=0 AND ISNULL(WOD.CANCELLED,0)=0


		;WITH CTE_REMOVEDUP AS
		(
			SELECT ROW_NUMBER() OVER(PARTITION BY PRODUCT_CODE,CUSTOMER_CODE ORDER BY CM_DT ASC,CM_NO ASC) AS SNO
				  ,CUSTOMER_CODE
				  ,CM_NO
				  ,PRODUCT_CODE
				  ,QUANTITY
			FROM #ORDDLV	  
		)
		DELETE CTE_REMOVEDUP WHERE SNO<>1
		
		CREATE INDEX IX_ORDDLV_PRODUCT_CODE  ON #ORDDLV(PRODUCT_CODE)
		CREATE INDEX IX_ORDDLV_CUSTOMER_CODE ON #ORDDLV(CUSTOMER_CODE)
		CREATE INDEX IX_ORDDLV_CM_NO ON #ORDDLV(CM_NO)
		
	SELECT 
		 (CASE WHEN OM.CUSTOMER_CODE='000000000000' THEN LM.AC_NAME ELSE CM.CUSTOMER_FNAME+' '+CM.CUSTOMER_LNAME END) AS CUSTOMER_NAME
		,OM.REF_NO
		,ISNULL(EM.EMP_NAME,'') AS SALE_PERSON1
		,ISNULL(EM1.EMP_NAME,'') AS SALE_PERSON2
		,OM.ORDER_NO AS ORDER_NUMBER
		,OM.ORDER_DT AS ORDER_DATE
		,(CASE WHEN PD.ROW_ID IS NULL THEN 'NO' ELSE 'YES' END) AS PO_RAISED
		,AM.ARTICLE_NO AS ARTICLE
		,ISNULL(PID.PRODUCT_CODE,'') AS PRODUCT_CODE
		,(CASE WHEN SD.CM_NO IS NULL THEN 'NO' ELSE 'YES' END) AS DELIVERED
		,OD.QUANTITY AS CAL_ORDER_QUANTITY
		,ISNULL(SD.QUANTITY,0) AS CAL_SALE_QUANTITY
	FROM WSL_ORDER_MST OM (NOLOCK)
	JOIN WSL_ORDER_DET OD (NOLOCK) ON OM.ORDER_ID=OD.ORDER_ID
	LEFT JOIN EMPLOYEE EM (NOLOCK) ON OM.EMP_CODE=EM.EMP_CODE
	LEFT JOIN EMPLOYEE EM1 (NOLOCK) ON OM.SALE_EMP_CODE=EM1.EMP_CODE
	JOIN CUSTDYM CM (NOLOCK) ON CM.CUSTOMER_CODE=OM.CUSTOMER_CODE
	JOIN LM01106 LM (NOLOCK) ON OM.AC_CODE=LM.AC_CODE
	LEFT JOIN POD01106 PD (NOLOCK) ON OD.ROW_ID=PD.WOD_ROW_ID
	JOIN ARTICLE AM (NOLOCK) ON OD.ARTICLE_CODE=AM.ARTICLE_CODE
	LEFT JOIN PID01106 PID (NOLOCK) ON PID.PO_ROW_ID=PD.ROW_ID
	LEFT OUTER JOIN #ORDDLV SD (NOLOCK) ON SD.PRODUCT_CODE=
							(CASE WHEN OD.ORDER_TYPE=0 THEN OD.PRODUCT_CODE ELSE OD.REF_PRODUCT_CODE END) 
							AND SD.CUSTOMER_CODE=OM.CUSTOMER_CODE
	WHERE OM.CANCELLED=0 AND OM.ORDER_DT BETWEEN @DFROMDT AND @DTODT
END
---END OF PROCEDURE - SP3S_GETBO
