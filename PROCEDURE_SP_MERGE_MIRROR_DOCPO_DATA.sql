create PROCEDURE SP_MERGE_MIRROR_DOCPO_DATA        
(        
	 @CMEMOID VARCHAR(50),        
	 @CLOCID VARCHAR(4),        
	 @CERRMSG VARCHAR(MAX) OUTPUT        
)        
AS        
BEGIN 
 
 SET NOCOUNT ON    
 
     
 
 DECLARE @DTSQL NVARCHAR(MAX),@CSOURCEDB VARCHAR(200),@CTMP_TABLENAME VARCHAR(200),        
   @CJOINSTR VARCHAR(MAX),@CERRORMSG VARCHAR(MAX),@CTABLESUFFIX VARCHAR(100),        
   @CTABLENAME VARCHAR(200),@CERRMSGOUT VARCHAR(MAX),@CSTEP VARCHAR(20),@CKEYFIELD VARCHAR(100)        
   ,@CKEYFIELD1 VARCHAR(100),@CMERGEDB VARCHAR(50)
   ,@INV_MODE INT,@CFINYEAR VARCHAR(10),@MRR_NO VARCHAR(50),@INV_ID VARCHAR(50)      
   ,@TEMP_TABLE1 VARCHAR(20),@CCMD NVARCHAR(MAX), @CCURDEPTID VARCHAR(4),@CHODEPTID VARCHAR(4),
   @BSOURCEPURLOC BIT,@BTARGETPURLOC BIT,@BGENERATEAUTOSERIES BIT,@CSOURCELOCID VARCHAR(4), @BHOLOC BIT,@BSKU_OH BIT,
   @NTARGETLOCTYPE INT,@BMSTINSERTONLY BIT,@CMEMONOPREFIX VARCHAR(100),@CPARTYDEPTID VARCHAR(5),
   @BCHALLANRECEIVEDPREV BIT,@CTABLESSTR VARCHAR(MAX),@BGETCHALLANTHRUMIRROR BIT,@CSOURCETEMPTABLE VARCHAR(500),
   @CTMPINDTABLE VARCHAR(500),@nInvMode INT,@CFILTERCONDITION VARCHAR(MAX),@cCmdOutput VARCHAR(MAX),@cFilterCondition1 varchar(max),
   @BSENDPURINFOLOC BIT
  
 
 BEGIN TRY        
  
  SET @CSTEP=2
    	 
  SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'  SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'
  
  SET @CSTEP=5	
  SET @CSOURCEDB=DB_NAME()+'.DBO.'
          
  SET @CTABLESUFFIX=REPLACE(@CMEMOID,'-','_') 
  SET @CFILTERCONDITION=''
  SET @CTMP_TABLENAME=@CSOURCEDB+'DOCPO_POM01106_mirror'
    
  SELECT @cFilterCondition=' A.PO_ID='''+@CMEMOID+''''
		 
     
  SET @CCMD=N'SELECT @CPARTYDEPTID=DEPT_ID FROM '+@CTMP_TABLENAME+' A WHERE '+@cFilterCondition
  
  PRINT @CCMD
  EXEC SP_EXECUTESQL @CCMD,N'@CPARTYDEPTID VARCHAR(5) OUTPUT',@CPARTYDEPTID OUTPUT
  
    
  IF ISNULL(@cMemoId,'')=''
	GOTO EXIT_PROC     
  
  IF @CPARTYDEPTID<>@CCURDEPTID
  BEGIN
	SET @CERRMSG = 'THE CHALLAN NO.:'+RIGHT(@CMEMOID,10)+' BELONGS TO LOCATION ID :'+@CPARTYDEPTID+' OTHER THAN CURRENT LOCATION ID:'+@CCURDEPTID		
	GOTO EXIT_PROC
  END
  
  SELECT TOP 1 @CSOURCELOCID=DEPT_ID,@BSOURCEPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=LEFT(@CMEMOID,2)	
  SELECT TOP 1 @BTARGETPURLOC=PUR_LOC,@NTARGETLOCTYPE=LOC_TYPE,@BSENDPURINFOLOC=upd_purinfo
  FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID
  
  SET @BHOLOC=0
  IF @CCURDEPTID=@CHODEPTID
	  SET @BHOLOC=1
  
  SET @CSTEP = 10        
  SET @CMERGEDB=DB_NAME()+'.DBO.'      
  SET @CERRORMSG=''        
 
  IF @BHOLOC=1
	SET @BMSTINSERTONLY = 1
  ELSE
	SET @BMSTINSERTONLY = 0
	
  IF @BHOLOC=0
	BEGIN TRANSACTION        
	
/*INM,IND,PAYMODE_XN_DET,PAYMODE_MST,PAYMODE_GRP_MST*/        
    SET @CSTEP = 15        
  
  SELECT @cFilterCondition=' B.DOCPO_MEMO_ID='''+@CMEMOID+''''
         
    SET @CSTEP = 140       
    SET @CTABLENAME='HD01106'        
    SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'        
    SET @CKEYFIELD='HEAD_CODE'        
    SET @CSTEP= 150        
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1  
         ,@CFILTERCONDITION=@CFILTERCONDITION  
         
    SET @CSTEP = 160       
    SET @CTABLENAME='LM01106'        
    SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'       
    SET @CKEYFIELD='AC_CODE'        
    
    
        
	SET @DTSQL=N'UPDATE A SET COMPANY_CODE=''01''  FROM '+@CTMP_TABLENAME+' A  WITH (ROWLOCK) WHERE COMPANY_CODE<>''01'' '
	EXEC SP_EXECUTESQL @DTSQL	
	
    SET @CSTEP = 165        
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION  
         
     UPDATE DOCPO_LMP01106_MIRROR SET AREA_CODE='0000000' FROM DOCPO_LMP01106_MIRROR
     WHERE area_code NOT IN (SELECT area_code FROM area)
     
        

    SET @CSTEP = 170        
    SET @CTABLENAME='LMP01106'        
    SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'      
    SET @CKEYFIELD='AC_CODE'        
    SET @CSTEP= 175        
    PRINT @DTSQL        
    EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1 
         ,@CFILTERCONDITION=@CFILTERCONDITION 
    
	SET @CTABLENAME='SECTIONM'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='SECTION_CODE'
	SET @CSTEP=280
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1	
         ,@CFILTERCONDITION=@CFILTERCONDITION 	
	

	
	SET @CSTEP=310
	SET @CTABLENAME='SECTIOND'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='SUB_SECTION_CODE'
	SET @CSTEP=320
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1 
         ,@CFILTERCONDITION=@CFILTERCONDITION    
         
    SET @CSTEP=380
	SET @CTABLENAME='PARA1'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA1_CODE'
	SET @CSTEP=390
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
              
    SET @CSTEP=400
	SET @CTABLENAME='PARA2'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA2_CODE'
	SET @CSTEP=410
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
       
    SET @CSTEP=420
	SET @CTABLENAME='PARA3'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA3_CODE'
	SET @CSTEP=430
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
         
    SET @CSTEP=500
	SET @CTABLENAME='PARA4'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA4_CODE'
	SET @CSTEP=510
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
         
    SET @CSTEP=520
	SET @CTABLENAME='PARA5'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA5_CODE'
	SET @CSTEP=530
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
   
    SET @CSTEP=560
	SET @CTABLENAME='PARA6'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PARA6_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1 
         ,@CFILTERCONDITION=@CFILTERCONDITION 
         
    SET @CSTEP=565
	SET @CTABLENAME='UOM'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='UOM_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION     
    
    SET @CSTEP=565
	SET @CTABLENAME='ARTICLE'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='ARTICLE_CODE'

	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 

    
	SET @CSTEP=565
	DELETE a FROM art_det a JOIN DOCPO_ART_DET_MIRROR b ON a.article_code=b.article_code
	WHERE b.DOCPO_MEMO_ID=@CMEMOID
	
    SET @CSTEP=575
	SET @CTABLENAME='ART_DET'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='ARTICLE_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='PARA2_CODE',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
         
    SET @CSTEP=580
	DELETE a FROM art_para1 a JOIN DOCPO_ART_para1_MIRROR b ON a.article_code=b.article_code
	WHERE b.DOCPO_MEMO_ID=@CMEMOID
	
    SET @CSTEP=585
	SET @CTABLENAME='ART_PARA1'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='ARTICLE_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='PARA1_CODE',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 


	DECLARE @NCOUNT INT,@BLOOP INT,@CCMD1 NVARCHAR(MAX)
	SET @NCOUNT=25
	SET @BLOOP=1
	WHILE (@BLOOP <=@NCOUNT )
	BEGIN
	      
			DECLARE @CATTR_KEY_NAME VARCHAR(100)

			 SET @CTABLENAME='ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST'
			SET @CTMP_TABLENAME='DOCPO_ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST_MIRROR'
			SET @CKEYFIELD='ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_KEY_CODE'
			SET @CATTR_KEY_NAME ='ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_KEY_NAME'

			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
				,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
				,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
				,@BALWAYSUPDATE=1
				,@CFILTERCONDITION=@CFILTERCONDITION
	       
			SET @BLOOP=@BLOOP +1  			
	END
   
	SET @CSTEP=587
	SET @CTABLENAME='ARTICLE_FIX_ATTR'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='ARTICLE_CODE'
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
		 
    
	
 --   SET @CSTEP=570
	--SET @CTABLENAME='ATTRM'
	--SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	--SET @CKEYFIELD='ATTRIBUTE_CODE'
	--EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
 --        ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
 --        ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
 --        ,@BALWAYSUPDATE=1
 --        ,@CFILTERCONDITION=@CFILTERCONDITION 


	--SET @CSTEP=575
	--SET @CTABLENAME='ATTR_KEY'
	--SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	--SET @CKEYFIELD='KEY_CODE'
	--EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
 --        ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
 --        ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
 --        ,@BALWAYSUPDATE=1
 --        ,@CFILTERCONDITION=@CFILTERCONDITION 
                           
                           
 --   SET @CSTEP=580
	--SET @CTABLENAME='ART_ATTR'
	--SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	--SET @CKEYFIELD='ARTICLE_CODE'
	--EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
 --        ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='ATTRIBUTE_CODE',@CKEYFIELD3=''        
 --        ,@LINSERTONLY=@BMSTINSERTONLY,@CJOINSTR='',@LUPDATEONLY=0        
 --        ,@BALWAYSUPDATE=1
 --        ,@CFILTERCONDITION=@CFILTERCONDITION 

                 
    SET @CSTEP=585
	SET @CTABLENAME='SKU'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PRODUCT_CODE'


	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB        
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''        
         ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0        
         ,@BALWAYSUPDATE=1
         ,@CFILTERCONDITION=@CFILTERCONDITION 
    
  SELECT @cFilterCondition=' A.PO_ID='''+@CMEMOID+''''
  	
       SET @CSTEP=360
	SET @CTABLENAME='POM01106'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='PO_ID'
	SET @CSTEP=110
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							 
   --DELETE FROM POD01106 WHERE PO_ID=@CMEMOID		
   
   	DELETE A FROM PURCHASEORDERPROCESSINGNEW A (NOLOCK)
	JOIN POD01106 B (NOLOCK) ON A.ROWID =B.ROW_ID 
	WHERE A.XNTYPE ='PURCHASEORDER' AND B.PO_ID =@CMEMOID 
								  
   
   DELETE FROM pod01106 WHERE row_id NOT IN (SELECT row_id FROM DOCPO_POD01106_MIRROR WHERE PO_ID=@CMEMOID)
   AND  PO_ID=@CMEMOID
							  
	
	SET @CSTEP=370
	SET @CTABLENAME='POD01106'
	SET @CTMP_TABLENAME='DOCPO_'+@CTABLENAME+'_MIRROR'
	SET @CKEYFIELD='ROW_ID'
	SET @CSTEP=110
	EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB
							  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
							  ,@LINSERTONLY=0,@CFILTERCONDITION='',@LUPDATEONLY=0
							  ,@BALWAYSUPDATE=1 
							  
					
	
	SET @CSTEP=380
	  INSERT INTO PURCHASEORDERPROCESSINGNEW(XNTYPE,ROWID,REFROWID,QTY)
	  SELECT 'PURCHASEORDER' AS XNTYPE, B.ROW_ID ROWID,B.ROW_ID REFROWID,
	          B.QUANTITY +
			 CEILING((ISNULL(B.INVOICE_QUANTITY,0) * ISNULL(B.TOLERANCE_PERCENTAGE,0))/100)
	  FROM POM01106 A (NOLOCK)
	  JOIN POD01106 B (NOLOCK) ON A.PO_ID =B.PO_ID 
	  WHERE A.CANCELLED =0 AND A.PO_ID =@CMEMOID
	
	 
    					
 END TRY        
 BEGIN CATCH
  PRINT 'CATCH START'       
  SET @CERRMSG='P:SP_MERGE_MIRROR_DOCPO_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
 END CATCH        
        
EXIT_PROC:   
 
     
 IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0        
 BEGIN 
	 IF @BHOLOC=0       
	 BEGIN
		COMMIT TRANSACTION
	END	
		
 END        
 ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0 
 BEGIN 
	 IF @BHOLOC=0
		ROLLBACK        
 END
   
   
		DELETE A FROM DOCPO_POD01106_MIRROR A WITH (ROWLOCK) WHERE a.PO_ID =@cMemoId 
		DELETE A FROM DOCPO_POM01106_MIRROR A			 WITH (ROWLOCK) WHERE a.PO_ID  =@cMemoId 
		DELETE a FROM DOCPO_HD01106_mirror a			 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_LM01106_mirror a			 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_LMP01106_mirror a			 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_SECTIONM_mirror a			 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_SECTIOND_mirror a			 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_PARA1_mirror a				 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_PARA2_mirror a				 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_PARA3_mirror a				 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_PARA4_mirror a				 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_PARA5_mirror a				 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_PARA6_mirror a				 WITH (ROWLOCK) WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_ARTICLE_mirror a			 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_UOM_mirror a			 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_ATTRM_mirror a				 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_ART_ATTR_mirror a			 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_ATTR_KEY_mirror a			 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE a FROM DOCPO_SKU_mirror a				 WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 

		DELETE A FROM DOCPO_attr1_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr10_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr11_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr12_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr13_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr14_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr15_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr16_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr17_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr18_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr19_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr2_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr20_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr21_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr22_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr23_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr24_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr25_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr3_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr4_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr5_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr6_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr7_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr8_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_attr9_mst_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_ARTICLE_FIX_ATTR_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_ART_DET_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 
		DELETE A FROM DOCPO_ART_PARA1_MIRROR A WITH (ROWLOCK)  WHERE a.DOCPO_MEMO_ID =@cMemoId 

		


END 
------ END OF CREATING PROCEDURE - SP_MERGE_MIRROR_DOCPO_DATA



