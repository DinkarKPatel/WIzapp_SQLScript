CREATE  PROCEDURE SP_PRD_JOBWORK_REPORT_PCS_DETAILS_UPC  

(  
 @CAGENCY_CODE VARCHAR(100)='',  
 @NPENDING INT=0,
 @NSUMMARY INT=0,  -- 0 FOR SUMMARY 1 FOR DETAILS
 @CARTICLE_CODE VARCHAR(10)=''
)  
AS  
BEGIN  
  
  
     DECLARE @DTSQL NVARCHAR(MAX),@AC_CODE VARCHAR(100)  
     IF @CAGENCY_CODE=''  
     BEGIN  
     SET @AC_CODE=''  
     SET @CAGENCY_CODE='IN('''')'  
     END  
     ELSE   
     BEGIN  
     SET @AC_CODE='LATER'  
     END  
	    
		 IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL  
			DROP TABLE #TMPISSUE  
	        
		IF OBJECT_ID('TEMPDB..#TMPALLOCATION','U') IS NOT NULL  
		   DROP TABLE #TMPALLOCATION  
		     
		 SELECT ORDER_ID,
		 CAST('' AS VARCHAR(100)) BO_ORDER_NO,
		 CAST('' AS DATETIME) BO_ORDER_DT,
		 WO_ID AS MEMO_ID ,
		 CAST('' AS VARCHAR(100)) AS ARTICLE_CODE,
		 PARA1_CODE,PARA2_CODE,PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE   
		 INTO #TMPALLOCATION
		 FROM PRD_UPCPMT WHERE 1=2
		
		 SET @DTSQL=N' SELECT B.ORDER_ID,M.ORDER_NO,M.ORDER_DT,
		 ISNULL(PMT1.WO_ID,ISNULL(A.MEMO_ID,'''')) AS MEMO_ID , 
		 B.ARTICLE_CODE,B.PARA1_CODE,B.PARA2_CODE,ISNULL(PMT1.PRODUCT_CODE,ISNULL(A.PRODUCT_CODE,'''')) AS PRODUCT_CODE,
		 ISNULL(PMT1.QUANTITY_IN_STOCK,ISNULL(A.QUANTITY_IN_STOCK,0)) AS QUANTITY_IN_STOCK,
		 ISNULL(PMT1.JOB_CODE,ISNULL(A.JOB_CODE,'''')) AS JOB_CODE      
		 FROM BUYER_ORDER_DET B   
		 JOIN BUYER_ORDER_MST M ON M.ORDER_ID=B.ORDER_ID   
		 LEFT JOIN  
		 (  
		  SELECT A.ORDER_ID,C.ARTICLE_SET_CODE ,A.MEMO_ID,PMT.PARA1_CODE,PMT.PARA2_CODE,
		  PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE
		  FROM  
		 (SELECT DISTINCT * FROM PRD_WO_ORDERS) A       
		 JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID         
		 JOIN
		 (
		  SELECT WO_ID,PARA1_CODE,PARA2_CODE,PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE
		  FROM PRD_UPCPMT WHERE ISNULL(ORDER_ID,'''')=''''
		 ) PMT ON PMT.WO_ID=C.MEMO_ID   
		 WHERE C.CANCELLED=0   
		 ) A ON A.ORDER_ID=B.ORDER_ID       
		 AND B.PARA1_CODE = A.PARA1_CODE       
		 AND B.PARA2_CODE = A.PARA2_CODE       
		 AND B.ARTICLE_CODE = A.ARTICLE_SET_CODE 
		 LEFT JOIN
		 (
		  SELECT ORDER_ID, WO_ID,PARA1_CODE,PARA2_CODE,PRODUCT_CODE,QUANTITY_IN_STOCK,JOB_CODE
		  FROM PRD_UPCPMT WHERE ISNULL(ORDER_ID,'''')<>''''
		 ) PMT1 ON PMT1.ORDER_ID=M.ORDER_ID   
		 AND B.PARA1_CODE=PMT1.PARA1_CODE
		 AND B.PARA2_CODE=PMT1.PARA2_CODE 
		 WHERE  M.CANCELLED=0     
         AND ('''+@CARTICLE_CODE+'''='''' OR B.ARTICLE_CODE='''+@CARTICLE_CODE+''')   '  
		 PRINT @DTSQL  
		 INSERT INTO #TMPALLOCATION  
		 EXEC SP_EXECUTESQL @DTSQL  
		
     IF OBJECT_ID('TEMPDB..#TMPISSUE','U') IS NOT NULL  
	   DROP TABLE #TMPISSUE 
	   
	   SELECT A.ORDER_ID BO_ORDER_ID,A.BO_ORDER_NO ,A.BO_ORDER_DT ,
	      LM.AC_NAME,
	      A.MEMO_ID AS ORDER_ID,
          MST.MEMO_NO AS ORDER_NO,
          MST.MEMO_DT AS ORDER_DT,
          C.REF_AGENCY_CODE AS AGENCY_CODE,
          AG.AGENCY_NAME,
          A.PARA1_CODE,
          P1.PARA1_NAME,
          A.PARA2_CODE,
          P2.PARA2_NAME,
          A.ARTICLE_CODE,
          ART.ARTICLE_NO AS FG_ARTICLE_NO,
          ART.ARTICLE_NAME AS FG_ARTICLE_NAME,
          C.MEMO_ID AS ISSUE_ID,
          C.MEMO_NO AS ISSUE_NO,
          C.MEMO_DT AS ISSUE_DT ,
          SUM(B.QUANTITY) AS ISSUE_QTY
     INTO #TMPISSUE 
     FROM #TMPALLOCATION A 
	 JOIN PRD_AGENCY_ISSUE_MATERIAL_UPC B ON A.PRODUCT_CODE=B.PRODUCT_CODE
	 JOIN PRD_AGENCY_ISSUE_MATERIAL_MST C ON B.MEMO_ID=C.MEMO_ID
	 JOIN PRD_WO_MST MST ON MST.MEMO_ID=A.MEMO_ID
	 JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE=C.REF_AGENCY_CODE
	 JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
	 JOIN PARA2 P2 ON P2.PARA2_CODE=A.PARA2_CODE
	 JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE
	 JOIN BUYER_ORDER_MST OM ON OM.ORDER_ID=A.ORDER_ID
	 JOIN LM01106 LM ON LM.AC_CODE=OM.AC_CODE
	 WHERE C.CANCELLED=0 AND 1=2
	 GROUP BY A.ORDER_ID ,A.MEMO_ID ,MST.MEMO_NO, MST.MEMO_DT,C.REF_AGENCY_CODE ,AG.AGENCY_NAME, A.PARA1_CODE,
  P1.PARA1_NAME,A.PARA2_CODE,P2.PARA2_NAME,A.ARTICLE_CODE,
     ART.ARTICLE_NO ,ART.ARTICLE_NAME ,C.MEMO_ID ,C.MEMO_NO ,C.MEMO_DT ,LM.AC_NAME,A.BO_ORDER_NO ,A.BO_ORDER_DT
     
	 
	 SET @DTSQL=N' SELECT A.ORDER_ID BO_ORDER_ID,A.BO_ORDER_NO ,A.BO_ORDER_DT ,
	      LM.AC_NAME,
	      A.MEMO_ID AS ORDER_ID,
          MST.MEMO_NO AS ORDER_NO,
          MST.MEMO_DT AS ORDER_DT,
          C.REF_AGENCY_CODE AS AGENCY_CODE,
          AG.AGENCY_NAME,
          A.PARA1_CODE,
          P1.PARA1_NAME,
          A.PARA2_CODE,
          P2.PARA2_NAME,
          A.ARTICLE_CODE,
          ART.ARTICLE_NO AS FG_ARTICLE_NO,
          ART.ARTICLE_NAME AS FG_ARTICLE_NAME,
          C.MEMO_ID AS ISSUE_ID,
          C.MEMO_NO AS ISSUE_NO,
          C.MEMO_DT AS ISSUE_DT ,
          SUM(B.QUANTITY) AS ISSUE_QTY 
     FROM #TMPALLOCATION A 
	 JOIN PRD_AGENCY_ISSUE_MATERIAL_UPC B ON A.PRODUCT_CODE=B.PRODUCT_CODE
	 JOIN PRD_AGENCY_ISSUE_MATERIAL_MST C ON B.MEMO_ID=C.MEMO_ID
	 JOIN PRD_WO_MST MST ON MST.MEMO_ID=A.MEMO_ID
	 JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE=C.REF_AGENCY_CODE
	 JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
	 JOIN PARA2 P2 ON P2.PARA2_CODE=A.PARA2_CODE
	 JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE
	 JOIN BUYER_ORDER_MST OM ON OM.ORDER_ID=A.ORDER_ID
	 JOIN LM01106 LM ON LM.AC_CODE=OM.AC_CODE
	 WHERE C.CANCELLED=0
	 AND ( '''+@AC_CODE+'''='''' OR AG.AC_CODE '+@CAGENCY_CODE+')  
	 GROUP BY LM.AC_NAME,A.ORDER_ID ,A.MEMO_ID ,MST.MEMO_NO,MST.MEMO_DT ,C.REF_AGENCY_CODE ,AG.AGENCY_NAME, A.PARA1_CODE,
     P1.PARA1_NAME,A.PARA2_CODE,P2.PARA2_NAME,A.ARTICLE_CODE,
     ART.ARTICLE_NO ,ART.ARTICLE_NAME ,C.MEMO_ID ,C.MEMO_NO ,C.MEMO_DT ,LM.AC_NAME,A.BO_ORDER_NO ,A.BO_ORDER_DT '
     PRINT @DTSQL  
    INSERT INTO #TMPISSUE  
    EXEC SP_EXECUTESQL @DTSQL  
     
     
     
    -- SELECT * INTO TMPALLOCATION FROM #TMPALLOCATION
     
      IF OBJECT_ID ('TEMPDB..#TMPREC','U') IS NOT NULL    
        DROP TABLE #TMPREC  

	   
	 
	 SELECT  A.ORDER_ID AS BO_ORDER_ID,A.BO_ORDER_NO ,A.BO_ORDER_DT ,
	      A.MEMO_ID AS ORDER_ID,
          C.REF_AGENCY_CODE AS AGENCY_CODE,
          A.PARA1_CODE,
          A.PARA2_CODE,
          A.ARTICLE_CODE,
          C.MEMO_ID AS REC_ISSUE_ID,
          REC.MEMO_NO AS RECEIVE_NO,
          REC.MEMO_DT AS RECEIVE_DT ,
          SUM(REC.QUANTITY) AS REC_QTY
     INTO #TMPREC 
     FROM #TMPALLOCATION A 
	 JOIN PRD_AGENCY_ISSUE_MATERIAL_UPC B ON A.PRODUCT_CODE=B.PRODUCT_CODE
	 JOIN PRD_AGENCY_ISSUE_MATERIAL_MST C ON B.MEMO_ID=C.MEMO_ID
	 JOIN
	 (
	  SELECT A.*,B.MEMO_NO,B.MEMO_DT ,B.AGENCY_CODE,ISS.ISSUE_ID 
	  FROM PRD_AGENCY_MATERIAL_RECEIPT_UPC A
	  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID
	   JOIN
	  (
	   SELECT A.MEMO_ID,C.MEMO_ID AS ISSUE_ID FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A
	   JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B ON A.REF_ROW_ID =B.ROW_ID 
	   JOIN PRD_AGENCY_ISSUE_MATERIAL_MST C ON B.MEMO_ID =C.MEMO_ID
	   WHERE C.CANCELLED =0
	   GROUP BY A.MEMO_ID,C.MEMO_ID
	  ) ISS ON ISS.MEMO_ID =A.MEMO_ID 
	  WHERE B.CANCELLED=0
	 ) REC ON B.PRODUCT_CODE=REC.PRODUCT_CODE AND C.REF_AGENCY_CODE =REC.AGENCY_CODE AND REC.ISSUE_ID=C.MEMO_ID 
	 JOIN PRD_WO_MST MST ON MST.MEMO_ID=A.MEMO_ID
	 JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE=C.REF_AGENCY_CODE
	 JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
	 JOIN PARA2 P2 ON P2.PARA2_CODE=A.PARA2_CODE
	 JOIN ARTICLE ART ON ART.ARTICLE_CODE=A.ARTICLE_CODE
	 WHERE C.CANCELLED=0
	 GROUP BY  A.ORDER_ID ,A.MEMO_ID ,
     C.REF_AGENCY_CODE ,A.PARA1_CODE, A.PARA2_CODE,
     A.ARTICLE_CODE,C.MEMO_ID ,REC.MEMO_NO ,REC.MEMO_DT ,A.BO_ORDER_NO ,A.BO_ORDER_DT
	 
	
	 
	  IF OBJECT_ID ('TEMPDB..#TMPISSUE_REC','U') IS NOT NULL
      DROP TABLE #TMPISSUE_REC
   
     SELECT  A.AC_NAME,A.BO_ORDER_ID,A.BO_ORDER_NO ,A.BO_ORDER_DT ,
            A.ORDER_ID,A.ORDER_NO,A.ORDER_DT,
          A.AGENCY_CODE,
          A.AGENCY_NAME,
          A.PARA1_CODE,
          A.PARA1_NAME,
          A.PARA2_CODE,
          A.PARA2_NAME,
          A.ARTICLE_CODE,
          A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME,
          A.ISSUE_ID,
          A.ISSUE_NO,
          A.ISSUE_DT ,
          A.ISSUE_QTY,
          B.RECEIVE_NO,
          B.RECEIVE_DT ,
          B.REC_QTY ,
           SR=ROW_NUMBER() OVER (PARTITION BY A.AC_NAME, A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID ORDER BY A.AC_NAME,A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ISSUE_ID )  
         -- SR=ROW_NUMBER() OVER (PARTITION BY A.AC_NAME, A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID  ORDER BY A.AC_NAME,A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID )  
   INTO #TMPISSUE_REC    
   FROM #TMPISSUE A
   LEFT OUTER JOIN
   (       
	 SELECT A.BO_ORDER_ID, A.REC_ISSUE_ID,A.RECEIVE_NO,A.RECEIVE_DT, 
	 A.ORDER_ID, A.AGENCY_CODE,A.ARTICLE_CODE ,A.PARA1_CODE,A.PARA2_CODE,  
	 A.REC_QTY   
	 FROM #TMPREC A       
	) B ON A.BO_ORDER_ID=B.BO_ORDER_ID AND A.ORDER_ID=B.ORDER_ID AND A.ISSUE_ID=B.REC_ISSUE_ID 
	    AND A.AGENCY_CODE=B.AGENCY_CODE AND A.PARA1_CODE =B.PARA1_CODE   
	   AND A.PARA2_CODE =B.PARA2_CODE AND A.ARTICLE_CODE=B.ARTICLE_CODE 
    ORDER BY A.ISSUE_ID
   
 
 
 IF OBJECT_ID('TEMPDB..#TMPFINAL','U') IS NOT NULL
    DROP TABLE #TMPFINAL
 
 
 SELECT A.BO_ORDER_ID,  A.ORDER_ID,A.AC_NAME,A.BO_ORDER_NO ,A.BO_ORDER_DT,
          A.ORDER_NO,
          A.ORDER_DT,
          A.AGENCY_NAME,
          A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME, 
          A.PARA1_NAME AS FG_COLOR, 
          A.PARA2_NAME AS FG_SIZE, 
          A.ISSUE_ID,
          A.ISSUE_NO,
          A.ISSUE_DT ,
          A.SR,
          CASE WHEN A.SR=1 THEN  A.ISSUE_QTY ELSE 0 END AS ISSUE_QTY,
          ISNULL(A.RECEIVE_NO,'') AS RECEIVE_NO,
          ISNULL(A.RECEIVE_DT,'') AS  RECEIVE_DT,
          ISNULL(A.REC_QTY,0) AS  REC_QTY,
          SUM(B.REC_QTY ) AS CUMM_REC,
          A.ISSUE_QTY-SUM(ISNULL(B.REC_QTY,0)) AS PENDING_QTY  
   INTO #TMPFINAL
   FROM #TMPISSUE_REC A
   JOIN #TMPISSUE_REC B ON A.BO_ORDER_ID=B.BO_ORDER_ID AND A.AGENCY_CODE=B.AGENCY_CODE AND A.PARA1_CODE =B.PARA1_CODE   
   AND A.PARA2_CODE =B.PARA2_CODE AND A.ARTICLE_CODE=B.ARTICLE_CODE 
   AND A.ORDER_ID=B.ORDER_ID AND A.ISSUE_ID=B.ISSUE_ID
   AND B.SR<=A.SR
   GROUP BY  A.BO_ORDER_ID,  A.ORDER_ID,A.AC_NAME,A.ORDER_ID,
          A.BO_ORDER_NO ,A.BO_ORDER_DT,
          A.ORDER_NO,
          A.ORDER_DT,
          A.AGENCY_CODE,
          A.AGENCY_NAME,
          A.PARA1_CODE,
          A.PARA1_NAME,
          A.PARA2_CODE,
          A.PARA2_NAME,
          A.ARTICLE_CODE,
          A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME,
          A.ISSUE_ID,
          A.ISSUE_NO,
          A.ISSUE_DT ,
          A.ISSUE_QTY,
          A.RECEIVE_NO,
          A.RECEIVE_DT ,
          A.REC_QTY,
          A.SR,
          CASE WHEN A.SR=1 THEN  A.ISSUE_QTY ELSE 0 END
   ORDER BY A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID,A.SR
   
   
	IF ISNULL(@NPENDING,0)=1
	BEGIN   
	 
	 DELETE A FROM #TMPFINAL A
	 JOIN
	 (
	 SELECT A.* FROM #TMPFINAL A
	 JOIN
	 (
	 SELECT A.AC_NAME, A.AGENCY_NAME, A.FG_COLOR,A.FG_SIZE,A.FG_ARTICLE_NO ,A.ORDER_ID,A.ISSUE_ID,MAX(SR)AS SR
	 FROM #TMPFINAL A 
	 GROUP BY A.AC_NAME, A.AGENCY_NAME, A.FG_COLOR,A.FG_SIZE,A.FG_ARTICLE_NO ,A.ORDER_ID,A.ISSUE_ID
	 ) B ON A.AC_NAME=B.AC_NAME AND  
	 A.AGENCY_NAME=B.AGENCY_NAME 
	 AND  A.FG_COLOR=B.FG_COLOR 
	 AND A.FG_SIZE=B.FG_SIZE
	 AND A.FG_ARTICLE_NO=B. FG_ARTICLE_NO
	 AND A.ORDER_ID=B.ORDER_ID
	 AND A.ISSUE_ID=B.ISSUE_ID
	 AND A.SR=B.SR AND A.PENDING_QTY=0
	 ) B 
	 ON A.AC_NAME=B.AC_NAME AND  
	 A.AGENCY_NAME=B.AGENCY_NAME 
	 AND  A.FG_COLOR=B.FG_COLOR 
	 AND A.FG_SIZE=B.FG_SIZE
	 AND A.FG_ARTICLE_NO=B. FG_ARTICLE_NO
	 AND A.ORDER_ID=B.ORDER_ID
	 AND A.ISSUE_ID=B.ISSUE_ID
   
   
    END
  --SELECT * INTO TMPFINAL FROM #TMPFINAL
   
   IF @NSUMMARY=0
   BEGIN
   
    SELECT A.AC_NAME, A.ORDER_NO,
          A.AGENCY_NAME,
          A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME, 
          A.FG_COLOR, 
          A.FG_SIZE, 
          A.ISSUE_ID,
          A.ISSUE_NO,
          A.ISSUE_DT ,
          SUM(A.ISSUE_QTY) AS  ISSUE_QTY,
          SUM(ISNULL(A.REC_QTY,0)) AS  REC_QTY,
          SUM(A.ISSUE_QTY)-SUM(ISNULL(A.REC_QTY,0)) AS PENDING_QTY  
   FROM #TMPFINAL A
   GROUP BY  A.AC_NAME, A.ORDER_NO,
          A.AGENCY_NAME,
          A.FG_ARTICLE_NO,
          A.FG_ARTICLE_NAME, 
          A.FG_COLOR, 
          A.FG_SIZE, 
          A.ISSUE_ID,
          A.ISSUE_NO,
          A.ISSUE_DT 
   ORDER BY  A.ISSUE_DT ,A.ISSUE_NO,A.ORDER_NO ,A.FG_ARTICLE_NO ,A.FG_COLOR,A.FG_SIZE,A.AC_NAME
  END       
  ELSE
  BEGIN
  
   SELECT A.* 
   FROM #TMPFINAL A
    ORDER BY A.ISSUE_DT ,A.ISSUE_NO,A.ORDER_NO,A.FG_ARTICLE_NO ,A.FG_COLOR,A.FG_SIZE, A.ISSUE_ID,A.SR,A.AC_NAME
 --  WHERE ISSUE_ID='0101117000000100000721'
  -- ORDER BY A.AC_NAME, A.FG_COLOR,A.FG_SIZE,A.FG_ARTICLE_NO ,A.ORDER_NO,A.ISSUE_ID,A.SR
  
  END
END
