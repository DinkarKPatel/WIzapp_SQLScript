create PROCEDURE SP_PCR   
(  
 @CDTFROM VARCHAR(10),  
 @CDTTO VARCHAR(10),  
 @CWHERE VARCHAR(100) ,
 @CUSERCODE	VARCHAR(15) 
)  
-- WITH ENCRYPTION
 
AS  
BEGIN 
--(dinkar) Replace  left(memoid,2) to Location_code 
	DECLARE @cHEAD_CODE VARCHAR(MAX)
    DECLARE @TOPBALDT TABLE (OPENING_BALANCE NUMERIC(20,2))  
   
 --DECLARE @TOPBAL TABLE (XN_DT DATETIME,OPENING_BALANCE NUMERIC(20,2))   
   
 DECLARE @DMEMODT DATETIME  ,@DMEMODTPARA DATETIME 
 SET @DMEMODT=CONVERT(DATETIME,@CDTTO,110)-1  
	DECLARE @CCONSIDERALLCASHXN VARCHAR(1)
   
	 SELECT TOP 1 @CCONSIDERALLCASHXN=VALUE FROM CONFIG (NOLOCK) WHERE  CONFIG_OPTION='CONSIDER_ALL_CASH_RECEIPTS'  
	 
	 SET @CCONSIDERALLCASHXN=ISNULL(@CCONSIDERALLCASHXN,'')  


SELECT @cHEAD_CODE = DBO.FN_ACT_TRAVTREE('0000000014') ----ADD VARIABLE BY GAURI ON 17/4/2019

  INSERT @TOPBALDT  
  EXEC SP_CASHXN @CWHERE,'',@DMEMODT,0,0,1,@CUSERCODE
  --EXEC SP_CASHXN @CWHERE,@CDTFROM,@CDTTO,0,0,1
	SELECT @CWHERE AS DEPT_ID,'OPENING BALANCE' AS AC_NAME,'' AS NARRATION,  
	OPENING_BALANCE AS OP,  
	0 AS DR_AMOUNT,0 AS CR_AMOUNT,(CASE WHEN OPENING_BALANCE <0 THEN 'CR' ELSE 'DR' END) AS XN_TYPE  ,0 AS S_NO  
	FROM @TOPBALDT  
 
--SELECT DEPT_ID,'OPENING BALANCE' AS AC_NAME,'' AS NARRATION,  
--       SUM(CASE WHEN XN_DT< @CDTTO AND XN_TYPE= 'CR' THEN XN_AMOUNT    
--                WHEN  XN_DT< @CDTTO AND XN_TYPE= 'DR'  THEN -XN_AMOUNT ELSE 0 END ) AS OP,  
--       0 AS DR_AMOUNT,0 AS CR_AMOUNT,'CR' AS XN_TYPE  ,0 AS S_NO  
--FROM VW_PCR  
--WHERE XN_DT<@CDTTO  
--GROUP BY   DEPT_ID  
UNION  
SELECT DEPT_ID,AC_NAME,NARRATION,0 AS OP,  
       SUM(CASE WHEN XN_TYPE= 'DR' THEN XN_AMOUNT ELSE 0 END) AS DR_AMOUNT,  
       SUM(CASE WHEN XN_TYPE= 'CR' THEN XN_AMOUNT ELSE 0 END) AS CR_AMOUNT,  
       XN_TYPE ,1 AS S_NO  
FROM VW_PCR  
WHERE XN_DT=@CDTTO  
AND DEPT_ID=(CASE WHEN @CWHERE='' THEN DEPT_ID ELSE @CWHERE END)
AND USER_CODE=(CASE WHEN @CUSERCODE='' THEN USER_CODE ELSE @CUSERCODE END)
GROUP BY   DEPT_ID,AC_NAME,NARRATION,XN_TYPE   

UNION  
  
SELECT a.location_Code  AS DEPT_ID,'RETAIL SALE' AS AC_NAME,'' AS NARRATION,0 AS OP,  

		( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN 0 ELSE ABS(SUM(D.CASH_AMOUNT)) END) AS DR_AMOUNT,  
       ( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN SUM(D.CASH_AMOUNT) ELSE 0 END) AS CR_AMOUNT,  
       ( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN 'CR' ELSE 'DR' END ) AS XN_TYPE ,1 AS S_NO 

 FROM CMM01106 A  
 LEFT OUTER JOIN VW_BILL_PAYMODE D ON A.CM_ID = D.MEMO_ID AND D.XN_TYPE = 'SLS'  
 WHERE  A.CANCELLED = 0  
 --AND   (A.MEMO_TYPE = 1 OR @BESTIMATEENABLED = 1)--CHANGE  
 AND   A.CM_DT = @CDTTO 
 AND   ((a.location_Code  =  @CWHERE OR @CWHERE='') )-- AND (ISNULL(A.BIN_ID,LEFT(A.CM_NO,2)) = @CWHERE OR @CWHERE='') )  
 AND   ISNULL(D.CASH_AMOUNT,0) <> 0  
 --AND (@BSKIPSLSENTRIES=0 OR @DFROMDT='') 
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)
 AND @CCONSIDERALLCASHXN='1'  
 GROUP BY a.location_Code 
  
 UNION ALL   
 SELECT a.location_Code  AS DEPT_ID,'RECEIPT FROM CUSTOMER' AS AC_NAME,'' AS NARRATION,0 AS OP,  
		( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN 0 ELSE ABS(SUM(D.CASH_AMOUNT)) END) AS DR_AMOUNT,
       ( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN SUM(D.CASH_AMOUNT) ELSE 0 END) AS CR_AMOUNT,  
         
       ( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN 'CR' ELSE 'DR' END ) AS XN_TYPE ,1 AS S_NO 
 
 FROM ARC01106 A  
 LEFT OUTER JOIN VW_BILL_PAYMODE D ON A.ADV_REC_ID = D.MEMO_ID AND D.XN_TYPE = 'ARC'  
 WHERE A.CANCELLED = 0  
 AND   D.CASH_AMOUNT <> 0  
 AND   (a.location_Code  = @CWHERE OR @CWHERE='') 
 AND   A.ADV_REC_DT = @CDTTO
 AND A.ARC_TYPE=1
 AND @CCONSIDERALLCASHXN='1'
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)  
 GROUP BY a.location_Code 
  
 UNION ALL   
 SELECT a.location_Code  AS DEPT_ID,'PAYMENT TO CUSTOMER' AS AC_NAME,'' AS NARRATION,0 AS OP,  

( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN 0 ELSE ABS(SUM(D.CASH_AMOUNT)) END) AS DR_AMOUNT,
       ( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN SUM(D.CASH_AMOUNT) ELSE 0 END) AS CR_AMOUNT,  
         
       ( CASE WHEN SUM(D.CASH_AMOUNT)>0 THEN 'CR' ELSE 'DR' END ) AS XN_TYPE ,1 AS S_NO 
 
 FROM ARC01106 A  
 LEFT OUTER JOIN VW_BILL_PAYMODE D ON A.ADV_REC_ID = D.MEMO_ID AND D.XN_TYPE = 'ARC'  
 WHERE A.CANCELLED = 0  
 AND   D.CASH_AMOUNT <> 0  
 AND   (a.location_Code  = @CWHERE OR @CWHERE='') 
 AND   A.ADV_REC_DT = @CDTTO
 AND A.ARC_TYPE=2
 AND @CCONSIDERALLCASHXN='1'
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)
 GROUP BY a.location_Code 
 UNION ALL  
 
 SELECT a.location_Code  AS DEPT_ID,'WHOLESALE' AS AC_NAME,'' AS NARRATION,0 AS OP,  
( CASE WHEN SUM(B.AMOUNT)>0 THEN 0 ELSE ABS(SUM(B.AMOUNT)) END) AS DR_AMOUNT,  
       ( CASE WHEN SUM(B.AMOUNT)>0 THEN SUM(B.AMOUNT) ELSE 0 END) AS CR_AMOUNT,  
       
       ( CASE WHEN SUM(B.AMOUNT)>0 THEN 'CR' ELSE 'DR' END ) AS XN_TYPE ,1 AS S_NO 
 FROM INM01106 A  
 JOIN PAYMODE_XN_DET B ON A.INV_ID=B.MEMO_ID   AND B.XN_TYPE='WSL'
 JOIN PAYMODE_MST C ON C.PAYMODE_CODE=B.PAYMODE_CODE  
 WHERE (a.location_Code  = @CWHERE OR @CWHERE='') AND CANCELLED = 0  
 AND C.PAYMODE_GRP_CODE='0000001'  
 AND A.INV_DT=@CDTTO
 AND @CCONSIDERALLCASHXN='1'  
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)
 GROUP BY a.location_Code 
   
 UNION ALL   
 SELECT a.location_Code  AS DEPT_ID,'WHOLESALE RETURN' AS AC_NAME,'' AS NARRATION,0 AS OP,  
       ( CASE WHEN SUM(A.TOTAL_AMOUNT)>0 THEN 0 ELSE ABS(SUM(A.TOTAL_AMOUNT)) END) AS DR_AMOUNT,  
       ( CASE WHEN SUM(A.TOTAL_AMOUNT)>0 THEN SUM(A.TOTAL_AMOUNT) ELSE 0 END) AS CR_AMOUNT,  

       ( CASE WHEN SUM(A.TOTAL_AMOUNT)>0 THEN 'CR' ELSE 'DR' END ) AS XN_TYPE ,1 AS S_NO
 FROM CNM01106 A  
 JOIN LM01106 B ON A.AC_CODE = B.AC_CODE  
 WHERE (a.location_Code  = @CWHERE OR @CWHERE='') AND CHARINDEX(B.HEAD_CODE,@cHEAD_CODE)> 0  ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019
 AND CANCELLED = 0  
 AND CN_DT = @CDTTO-- ISNULL((SELECT [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'OPENING_CASH_DATE'),'')  
 AND @CCONSIDERALLCASHXN='1'  
 AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)
 GROUP BY a.location_Code   
 ORDER BY S_NO, XN_TYPE     
  
  
  
SELECT PEM_MEMO_DT ,DENOMINATION,QUANTITY   
FROM PECD01106  
WHERE  PEM_MEMO_DT=@CDTTO 
--AND USER_CODE=(CASE WHEN @CUSERCODE='' THEN USER_CODE ELSE @CUSERCODE END) 
  
  
END
