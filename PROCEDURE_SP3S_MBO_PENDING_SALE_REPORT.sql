CREATE PROCEDURE SP3S_MBO_PENDING_SALE_REPORT
(
	 @DTO_DATE DATETIME /*DATE TILL WHEN THE TRANSACTION SHOULD BE CONSIDERED.*/
	,@NMODE NUMERIC(1)=1 /*MODE : 1 FOR SUMMARY, 2 FOR DETAILS*/
)
--WITH ENCRYPTION 
AS
BEGIN
	
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @NMODE=1
BEGIN
	SELECT BIN.BIN_NAME,LM.AC_NAME,CMM.CM_NO,CMM.REF_NO,CONVERT(VARCHAR(10),CMM.CM_DT,105) AS CM_DT,CMM.NET_AMOUNT
	FROM CMM01106 CMM
	JOIN BIN ON CMM.BIN_ID=BIN.BIN_ID
	JOIN LM01106 LM ON BIN.MBO_LEDGER_AC_CODE=LM.AC_CODE
	LEFT JOIN SLS_WSR_LINK SWL ON CMM.CM_ID=SWL.CM_ID
	WHERE CMM.CANCELLED=0 AND SWL.CM_ID IS NULL
	AND BIN.MBO_COUNTER=1 
	AND CMM.CM_DT<=@DTO_DATE
	ORDER BY BIN.BIN_NAME, CMM.CM_DT,CMM.CM_NO
END
ELSE IF @NMODE=2
BEGIN
	SELECT BIN.BIN_NAME,LM.AC_NAME,CMM.CM_NO,CMM.REF_NO,CONVERT(VARCHAR(10),CMM.CM_DT,105) AS CM_DT,CMD.PRODUCT_CODE,CMD.QUANTITY
		  ,CMD.MRP,CMD.DISCOUNT_PERCENTAGE,CMD.DISCOUNT_AMOUNT,CMD.NET AS NET_AMOUNT
	FROM CMM01106 CMM
	JOIN CMD01106 CMD ON CMM.CM_ID=CMD.CM_ID
	JOIN BIN ON CMM.BIN_ID=BIN.BIN_ID
	JOIN LM01106 LM ON BIN.MBO_LEDGER_AC_CODE=LM.AC_CODE
	LEFT JOIN SLS_WSR_LINK SWL ON CMM.CM_ID=SWL.CM_ID
	WHERE CMM.CANCELLED=0 AND SWL.CM_ID IS NULL
	AND BIN.MBO_COUNTER=1 
	AND CMM.CM_DT<=@DTO_DATE
	ORDER BY BIN.BIN_NAME, CMM.CM_DT,CMM.CM_NO
END	
END
--END OF PROCEDURE - SP3S_MBO_PENDING_SALE_REPORT
