CREATE PROCEDURE PPC_SAVETRAN_CONFIG_MAIL
(
	@NSPID INT
 
)
AS
BEGIN
   
     DECLARE @CTEMPDBNAME VARCHAR(100),
			@CMASTERTABLENAME	VARCHAR(100),
			@CTEMPMASTERTABLENAME	VARCHAR(100),
			@CERRORMSG VARCHAR(1000),
			@NSTEP VARCHAR(10)
     DECLARE @OUTPUT TABLE (ERRMSG VARCHAR(2000), MEMO_ID VARCHAR(100))
     
    BEGIN TRANSACTION
    BEGIN TRY
	        
	        
	        DELETE FROM PPC_CONFIG_MAIL
			SET @CMASTERTABLENAME	= 'PPC_CONFIG_MAIL'
			SET @CTEMPMASTERTABLENAME	= 'PPC_PPC_CONFIG_MAIL_UPLOAD'
		
		  DECLARE @FILTER VARCHAR(MAX)
		  SET @FILTER=' B.SP_ID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
		
			SET @NSTEP=10
			EXEC UPDATEMASTERXN 
				  @CSOURCEDB	= ''
				, @CSOURCETABLE = @CTEMPMASTERTABLENAME
				, @CDESTDB		= ''
				, @CDESTTABLE	= @CMASTERTABLENAME
				, @CKEYFIELD1	= 'EMAIL_ID'
				, @BALWAYSUPDATE = 1
				,@CFILTERCONDITION=@FILTER
	
	  
	END TRY
	BEGIN CATCH
		SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
		GOTO END_PROC
	END CATCH

	
END_PROC:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')='' 
			COMMIT TRANSACTION
		ELSE
			ROLLBACK
	END
	INSERT @OUTPUT ( ERRMSG, MEMO_ID)
		VALUES ( ISNULL(@CERRORMSG,''), '' )
	SELECT * FROM @OUTPUT	
	
	DELETE FROM PPC_PPC_CONFIG_MAIL_UPLOAD WHERE SP_ID=LTRIM(RTRIM(STR(@NSPID))) 
END
