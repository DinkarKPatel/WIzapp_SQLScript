CREATE  PROCEDURE SP3S_CREATE_MASTERS_DATA--(LocId 3 digit change by Sanjay:06-11-2024)
(
@NMODE INT,
@BACKNOWLEDGE INT =0

)
AS
BEGIN
    
        
          DECLARE @CTABLENAME NVARCHAR(MAX),@CCMD NVARCHAR(MAX),@CCURLOCTIONID VARCHAR(4)
          ,@CCLONAME NVARCHAR(MAX),@CTEMPLMTABLE VARCHAR(1000),@CSTEP INT,@CERRMSG VARCHAR(1000),
          @RECORDFOUND INT,@JOINTABLE VARCHAR(500)
          
BEGIN TRY          
            
            SELECT @CCURLOCTIONID=VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'

   
        IF @NMODE=1
           BEGIN
			   SET @CTABLENAME='SKU'
			   SET @CCLONAME='PRODUCT_CODE'
			   SET @CTEMPLMTABLE ='TEMP_SYNCH_'+@CTABLENAME+'_'+@CCURLOCTIONID
			   SET @JOINTABLE ='MASTERDATA'

           END
        IF @NMODE=2
			BEGIN
				SET @CTABLENAME='ARTICLE'
				SET @CCLONAME='ARTICLE_CODE'
				SET @CTEMPLMTABLE ='TEMP_SYNCH_'+@CTABLENAME+'_'+@CCURLOCTIONID
				SET @JOINTABLE ='ARTICLEMASTERDATA'
			END
			

			--- DROP TEMP TABLE IF EXISTS 
			SET @CCMD=N'IF OBJECT_ID('''+@CTEMPLMTABLE+''',''U'') IS NOT NULL 
						   DROP TABLE '+@CTEMPLMTABLE+''          
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD
			
           --- INSERT DATA INTO TEMP TABLE FROM LOCATION 
           SET @CCMD=N'SELECT DISTINCT TOP 1000 A.article_code AS CODE INTO '+@CTEMPLMTABLE+' 
                        FROM article A(nolock) 
                        JOIN SKU(NOLOCK) ON SKU.ARTICLE_CODE=A.ARTICLE_CODE
                        LEFT JOIN ARTICLEMASTERDATA B(NOLOCK) ON  A.article_code =B.CODE
                        WHERE B.CODE IS NULL AND A.INACTIVE=0'
                        
           IF(@NMODE=1)
			BEGIN
   			 --- INSERT DATA INTO TEMP TABLE FROM LOCATION 
           SET @CCMD=N'SELECT DISTINCT TOP 2000 A.product_code AS CODE INTO '+@CTEMPLMTABLE+' 
                        FROM SKU A(nolock) 
                        LEFT JOIN MASTERDATA B(NOLOCK) ON  A.product_code =B.CODE
                        WHERE B.CODE IS NULL' --AND A.INACTIVE=0'
			END             
           PRINT @CCMD
           EXEC SP_EXECUTESQL @CCMD
           
           
           SET @CCMD=N'IF NOT EXISTS(SELECT TOP 1 * FROM '+@CTEMPLMTABLE+' )
			             SET @RECORDFOUND=1'
			             
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD,N'@RECORDFOUND BIT OUTPUT',@RECORDFOUND OUTPUT
			
			
			-----DELETE FROM LOG TABLE 
			IF @RECORDFOUND=1
			BEGIN
			   IF @NMODE=1
			   BEGIN
			      TRUNCATE TABLE MASTERDATA
			   	  UPDATE CONFIG SET VALUE=0 WHERE  CONFIG_OPTION='SYNCH_SKU_PROCESS_STARTED'
			   	  GOTO END_PROC
			   END
			   IF @NMODE=2
			   BEGIN
			      TRUNCATE TABLE ARTICLEMASTERDATA
			   	  UPDATE CONFIG SET VALUE=0 WHERE  CONFIG_OPTION='SYNCH_ARTICLE_PROCESS_STARTED'
			   	  GOTO END_PROC
			   END
			   
			END


END TRY  
	BEGIN CATCH  
		SET @CERRMSG='P: SP3S_CREATE_MASTERS_DATA, STEP: '+CAST(@CSTEP AS VARCHAR(5))+', MESSAGE: ' + ERROR_MESSAGE()
		GOTO END_PROC  
	END CATCH   

END_PROC:
    IF @RECORDFOUND=1
      SELECT '' AS  ERRMSG WHERE 1=2
      
	ELSE IF  ISNULL(@CERRMSG,'')<>'' 
		SELECT ISNULL(@CERRMSG,'') AS ERRMSG
	ELSE 
	  BEGIN
	      --IF @NMODE=1
	      --SELECT 'This Option is not in use' AS ERRMSG
	      --IF @NMODE=2
	      BEGIN 
		  SET @CCMD=N'SELECT CODE,'''' AS ERRMSG FROM '+@CTEMPLMTABLE+' '
           PRINT @CCMD
           EXEC SP_EXECUTESQL @CCMD 
           END
           
      END
END

---END OF PROCEDURE - SP3S_CREATE_MASTERS_DATA
