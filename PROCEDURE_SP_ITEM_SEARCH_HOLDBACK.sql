CREATE PROC SP_ITEM_SEARCH_HOLDBACK
@SEARCH_KEY VARCHAR(300),
@FROM_DT VARCHAR(100),
@TO_DT VARCHAR(100),
@STEP INT
--WITH ENCRYPTION

AS
BEGIN
IF @STEP = 1 
	GOTO DTPRODUCTLIST_1;
ELSE IF @STEP = 2
	GOTO DTPRODUCTLIST_2;
ELSE IF @STEP = 3
	GOTO DT_PRODUCTS;
ELSE IF @STEP = 4
	GOTO DT_ACCOUNTS;

DECLARE @CMD NVARCHAR(MAX)

DTPRODUCTLIST_1:
	
	SET @CMD=N'
		SELECT DISTINCT TOP 50 CAST(0 AS BIT) BCHK,CAST('' AS VARCHAR(50)) AS PRODUCT_CODE,B.MEMO_DT,D.ARTICLE_NO,E.SUB_SECTION_NAME,
		F.SECTION_NAME,C.PARA1_NAME,C.PARA2_NAME,C.PARA3_NAME,C.PARA4_NAME,C.PARA5_NAME,C.PARA6_NAME
		FROM hold_back_deliver_det (NOLOCK) A 
		JOIN hold_back_deliver_mst (NOLOCK) B ON B.memo_ID=A.memo_ID
		JOIN SKU_NAMES (NOLOCK) C ON C.PRODUCT_CODE=A.PRODUCT_CODE
		WHERE C.PRODUCT_CODE='''+@SEARCH_KEY+'''   
		AND B.MEMO_DT BETWEEN'''+@FROM_DT+''' AND  '''+@TO_DT+''''
		
	
	PRINT @CMD;
	EXEC SP_EXECUTESQL @CMD;
	
	GOTO END_PROC;
	
DTPRODUCTLIST_2:

	SET @CMD=N'
		SELECT DISTINCT TOP 50 CAST(0 AS BIT) BCHK,CAST('' AS VARCHAR(50)) AS PRODUCT_CODE,C.ARTICLE_NO,C.SUB_SECTION_NAME,C.SECTION_NAME,C.PARA1_NAME
		,C.PARA2_NAME,C.PARA3_NAME,C.PARA4_NAME,C.PARA5_NAME,C.PARA6_NAME
		FROM hold_back_deliver_det (NOLOCK) A 
		JOIN hold_back_deliver_mst (NOLOCK) B ON B.memo_ID=A.memo_ID
		JOIN SKU_NAMES C (NOLOCK) ON C.PRODUCT_CODE=A.PRODUCT_CODE
		WHERE B.CUSTOMER_CODE='''+@SEARCH_KEY+''''
	
	PRINT @CMD;
	
	EXEC SP_EXECUTESQL @CMD
	
	GOTO END_PROC;
	

DT_PRODUCTS:
	SELECT PRODUCT_CODE FROM SKU (NOLOCK) WHERE 1=2
	GOTO END_PROC;
	
DT_ACCOUNTS:
	SELECT customer_code,customer_fname +' ' +customer_lname+'('+user_customer_code+')' AS  user_customer_code FROM CUSTDYM (NOLOCK) WHERE INACTIVE=0;
	GOTO END_PROC;

END_PROC:

END;
