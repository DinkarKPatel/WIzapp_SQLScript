CREATE  PROCEDURE SP_PRD_JOBWORK_REPORT_PCS_DETAILS_WITH_RM      
    
(      
 @CAGENCY_CODE VARCHAR(100)='',      
 @NPENDING INT=0,    
 @NSUMMARY INT=0,  -- 1 FOR SUMMARY 2 FOR DETAILS    
 @CARTICLE_CODE VARCHAR(10)='',
 @DAS_ON DATETIME=''
    
)      
AS      
BEGIN      
      
      
     DECLARE @DTSQL NVARCHAR(MAX),@AC_CODE VARCHAR(100)      
     IF @CAGENCY_CODE=''      
     BEGIN      
     SET @AC_CODE=''      
     SET @CAGENCY_CODE='IN('''')'      
     END      
     ELSE       
     BEGIN      
     SET @AC_CODE='LATER'      
     END      
        
     IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL      
        DROP TABLE #TMPISSUE      
            
       IF OBJECT_ID ('TEMPDB..#TMPISSUE','U') IS NOT NULL        
        DROP TABLE #TMPISSUE        
              
     SELECT ORD.WORK_ORDER_ID AS ORDER_ID, ORD.ORDER_NO,  A.REF_AGENCY_CODE AS AGENCY_CODE,    
     B.PARA1_CODE,B.PARA2_CODE,B.ARTICLE_CODE,        
     C.AGENCY_NAME,P1.PARA1_NAME,P2.PARA2_NAME,        
     AR.ARTICLE_NO AS FG_ARTICLE_NO,        
     AR.ARTICLE_NAME AS FG_ARTICLE_NAME,        
     B.ISSUE_QTY AS ISSUE_QTY,    
     A.MEMO_NO AS ISSUE_NO,      
     A.MEMO_DT AS ISSUE_DT ,    
     A.MEMO_ID AS ISSUE_ID     
     INTO #TMPISSUE        
     FROM PRD_AGENCY_ISSUE_MATERIAL_MST (NOLOCK) A        
     JOIN PRD_AGENCY_ISSUE_ROW_MATERIAL_DET (NOLOCK) B ON A.MEMO_ID =B.MEMO_ID       
     JOIN      
     (      
       SELECT MST.MEMO_NO AS ORDER_NO, A.MEMO_ID, REF_MATERIAL_ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID       
       FROM PRD_AGENCY_ISSUE_MATERIAL_DET A      
       JOIN PRD_WO_MST MST ON A.REF_PRD_WORKORDER_MEMOID=MST.MEMO_ID      
       GROUP BY MST.MEMO_NO,A.MEMO_ID, REF_MATERIAL_ROW_ID,A.REF_PRD_WORKORDER_MEMOID      
     ) ORD ON  ORD.MEMO_ID=B.MEMO_ID AND B.ROW_ID =ORD.REF_MATERIAL_ROW_ID        
     JOIN ARTICLE AR ON AR.ARTICLE_CODE=B.ARTICLE_CODE        
     JOIN PRD_AGENCY_MST (NOLOCK) C ON A.REF_AGENCY_CODE =C.AGENCY_CODE        
     JOIN PARA1 P1 ON P1.PARA1_CODE=B.PARA1_CODE        
     JOIN PARA2 P2 ON P2.PARA2_CODE=B.PARA2_CODE        
     WHERE      
     1=2        
            
              
    SET @DTSQL=N' SELECT ORD.WORK_ORDER_ID AS ORDER_ID, ORD.ORDER_NO,  A.REF_AGENCY_CODE AS AGENCY_CODE,B.PARA1_CODE,B.PARA2_CODE,B.ARTICLE_CODE,      
      C.AGENCY_NAME,P1.PARA1_NAME,P2.PARA2_NAME,      
     AR.ARTICLE_NO AS FG_ARTICLE_NO,      
     AR.ARTICLE_NAME AS FG_ARTICLE_NAME,      
     SUM(B.ISSUE_QTY) AS ISSUE_QTY,    
     A.MEMO_NO AS ISSUE_NO,      
     A.MEMO_DT AS ISSUE_DT,    
     A.MEMO_ID AS ISSUE_ID     
     FROM PRD_AGENCY_ISSUE_MATERIAL_MST (NOLOCK) A      
     JOIN PRD_AGENCY_ISSUE_ROW_MATERIAL_DET (NOLOCK) B ON A.MEMO_ID =B.MEMO_ID     
     JOIN    
     (    
       SELECT MST.MEMO_NO AS ORDER_NO, A.MEMO_ID, REF_MATERIAL_ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID     
       FROM PRD_AGENCY_ISSUE_MATERIAL_DET A    
       JOIN PRD_WO_MST MST ON A.REF_PRD_WORKORDER_MEMOID=MST.MEMO_ID    
       GROUP BY MST.MEMO_NO,A.MEMO_ID, REF_MATERIAL_ROW_ID,A.REF_PRD_WORKORDER_MEMOID    
     ) ORD ON  ORD.MEMO_ID=B.MEMO_ID AND B.ROW_ID =ORD.REF_MATERIAL_ROW_ID      
     JOIN ARTICLE AR ON AR.ARTICLE_CODE=B.ARTICLE_CODE      
     JOIN PRD_AGENCY_MST (NOLOCK) C ON A.REF_AGENCY_CODE =C.AGENCY_CODE      
     JOIN PARA1 P1 ON P1.PARA1_CODE=B.PARA1_CODE      
     JOIN PARA2 P2 ON P2.PARA2_CODE=B.PARA2_CODE      
     WHERE ('''+@AC_CODE+'''='''' OR C.AC_CODE  '+@CAGENCY_CODE+' )      
     AND ('''+@CARTICLE_CODE+'''='''' OR B.ARTICLE_CODE='''+@CARTICLE_CODE+''')  
     AND ('''+CONVERT(VARCHAR(10), @DAS_ON,121)+'''=''1900-01-01'' OR A.MEMO_DT<='''+CONVERT(VARCHAR(10), @DAS_ON,121)+''')          
     AND A.CANCELLED =0      
     GROUP BY ORD.WORK_ORDER_ID ,B.ARTICLE_CODE,A.REF_AGENCY_CODE,B.PARA1_CODE,B.PARA2_CODE,C.AGENCY_NAME,P1.PARA1_NAME,P2.PARA2_NAME,      
     AR.ARTICLE_NO ,      
     AR.ARTICLE_NAME ,ORD.ORDER_NO, A.MEMO_NO ,      
     A.MEMO_DT ,A.MEMO_ID   '    
         
     PRINT @DTSQL      
     INSERT INTO #TMPISSUE      
     EXEC SP_EXECUTESQL @DTSQL      
         
           
     IF OBJECT_ID ('TEMPDB..#TMPREC','U') IS NOT NULL        
        DROP TABLE #TMPREC                     
              
   SELECT ORD.ORDER_ID, B.AGENCY_CODE,A.ARTICLE_CODE ,PARA1_CODE,PARA2_CODE,        
   REC_QTY AS  REC_QTY,    
   B.MEMO_NO AS RECEIVE_NO,      
   B.MEMO_DT AS RECEIVE_DT,    
   A.MEMO_ID AS REC_ISSUE_ID    
   INTO #TMPREC        
   FROM PRD_AGENCY_ROW_MATERIAL_RECEIPT_DET A        
   JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID      
   JOIN      
   (      
          
    SELECT A.REF_MATERIAL_ROW_ID , A.MEMO_ID,B.ORDER_ID FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A        
    JOIN        
    (        
     SELECT A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID FROM PRD_AGENCY_ISSUE_MATERIAL_DET A      
     JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID       
     WHERE CANCELLED =0      
              
     UNION         
     SELECT A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID     
     FROM PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING  A      
     JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.REF_ISSUE_ID =B.MEMO_ID       
     WHERE CANCELLED =0        
    ) B ON A.REF_ROW_ID=B.ROW_ID        
    GROUP BY A.REF_MATERIAL_ROW_ID ,A.MEMO_ID,B.ORDER_ID        
   )ORD ON ORD.MEMO_ID=B.MEMO_ID        
   AND ORD.REF_MATERIAL_ROW_ID =A.ROW_ID       
   JOIN PRD_AGENCY_MST (NOLOCK) C ON B.AGENCY_CODE =C.AGENCY_CODE          
   WHERE 1=2      
        
       
   SET @DTSQL=N'SELECT ORD.ORDER_ID, B.AGENCY_CODE,A.ARTICLE_CODE ,PARA1_CODE,PARA2_CODE,      
   SUM(REC_QTY) AS  REC_QTY,    
   B.MEMO_NO AS RECEIVE_NO,      
   B.MEMO_DT AS RECEIVE_DT,    
   ORD.ISSUE_ID      
   FROM PRD_AGENCY_ROW_MATERIAL_RECEIPT_DET A      
   JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID    
   JOIN    
   (    
        
    SELECT B.ISSUE_ID, A.REF_MATERIAL_ROW_ID , A.MEMO_ID,B.ORDER_ID FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A      
    JOIN      
    (      
     SELECT A.MEMO_ID AS ISSUE_ID, A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID FROM PRD_AGENCY_ISSUE_MATERIAL_DET A    
     JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID     
     WHERE CANCELLED =0  
     AND ('''+CONVERT(VARCHAR(10), @DAS_ON,121)+'''=''1900-01-01'' OR B.MEMO_DT<='''+CONVERT(VARCHAR(10), @DAS_ON,121)+''')      
            
     UNION       
     SELECT B.MEMO_ID AS ISSUE_ID,A.ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS ORDER_ID FROM PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING  A    
      JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.REF_ISSUE_ID =B.MEMO_ID     
     WHERE CANCELLED =0   
     AND ('''+CONVERT(VARCHAR(10), @DAS_ON,121)+'''=''1900-01-01'' OR B.MEMO_DT<='''+CONVERT(VARCHAR(10), @DAS_ON,121)+''')       
    ) B ON A.REF_ROW_ID=B.ROW_ID      
    GROUP BY B.ISSUE_ID,A.REF_MATERIAL_ROW_ID ,A.MEMO_ID,B.ORDER_ID      
   )ORD ON ORD.MEMO_ID=B.MEMO_ID      
   AND ORD.REF_MATERIAL_ROW_ID =A.ROW_ID     
  JOIN PRD_AGENCY_MST (NOLOCK) C ON B.AGENCY_CODE =C.AGENCY_CODE        
  WHERE ( '''+@AC_CODE+'''='''' OR C.AC_CODE '+@CAGENCY_CODE+')      
   AND ('''+@CARTICLE_CODE+'''='''' OR A.ARTICLE_CODE='''+@CARTICLE_CODE+''')        
   AND B.CANCELLED =0      
   GROUP BY ORD.ISSUE_ID  ,ORD.ORDER_ID,B.AGENCY_CODE,A.ARTICLE_CODE ,PARA1_CODE,PARA2_CODE,B.MEMO_NO ,      
   B.MEMO_DT  '    
        
   PRINT @DTSQL      
   INSERT INTO #TMPREC      
   EXEC SP_EXECUTESQL @DTSQL      
       
       
   --SELECT * INTO TMPISSUE FROM #TMPISSUE    
       
       
       
   IF OBJECT_ID ('TEMPDB..#TMPISSUE_REC','U') IS NOT NULL    
      DROP TABLE #TMPISSUE_REC    
       
   SELECT A.ORDER_ID,    
          A.ORDER_NO,A.AGENCY_CODE,    
          A.AGENCY_NAME,    
          A.PARA1_CODE,    
          A.PARA1_NAME,    
          A.PARA2_CODE,    
          A.PARA2_NAME,    
          A.ARTICLE_CODE,    
          A.FG_ARTICLE_NO,    
          A.FG_ARTICLE_NAME,    
          A.ISSUE_ID,    
          A.ISSUE_NO,    
          A.ISSUE_DT ,    
          A.ISSUE_QTY,    
          B.RECEIVE_NO,    
          B.RECEIVE_DT ,    
          B.REC_QTY ,    
             
          SR=ROW_NUMBER() OVER (PARTITION BY A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID  ORDER BY A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID )      
   INTO #TMPISSUE_REC        
   FROM #TMPISSUE A    
   LEFT OUTER JOIN    
   (           
  SELECT A.REC_ISSUE_ID,A.RECEIVE_NO,A.RECEIVE_DT,     
  A.ORDER_ID, A.AGENCY_CODE,A.ARTICLE_CODE ,A.PARA1_CODE,A.PARA2_CODE,      
  A.REC_QTY       
  FROM #TMPREC A           
 ) B ON A.AGENCY_CODE=B.AGENCY_CODE AND A.PARA1_CODE =B.PARA1_CODE       
    AND A.PARA2_CODE =B.PARA2_CODE AND A.ARTICLE_CODE=B.ARTICLE_CODE     
    AND A.ORDER_ID=B.ORDER_ID AND A.ISSUE_ID=B.REC_ISSUE_ID    
    ORDER BY A.ISSUE_ID    
       
       
  -- SELECT * INTO TMPREC FROM #TMPREC    
       
     
       
 --  UPDATE #TMPISSUE_REC SET ISSUE_QTY=0 WHERE SR>1    
     
 IF OBJECT_ID('TEMPDB..#TMPFINAL','U') IS NOT NULL    
    DROP TABLE #TMPFINAL    
     
   SELECT A.ORDER_ID,    
          A.ORDER_NO,    
          A.AGENCY_NAME,    
          A.FG_ARTICLE_NO,    
          A.FG_ARTICLE_NAME,     
          A.PARA1_NAME AS FG_COLOR,     
          A.PARA2_NAME AS FG_SIZE,     
          A.ISSUE_ID,    
          A.ISSUE_NO,    
          A.ISSUE_DT ,    
          A.SR,    
          CASE WHEN A.SR=1 THEN  A.ISSUE_QTY ELSE 0 END AS ISSUE_QTY,    
          ISNULL(A.RECEIVE_NO,'') AS RECEIVE_NO,    
          ISNULL(A.RECEIVE_DT,'') AS  RECEIVE_DT,    
          ISNULL(A.REC_QTY,0) AS  REC_QTY,    
          SUM(B.REC_QTY ) AS CUMM_REC,    
          A.ISSUE_QTY-SUM(ISNULL(B.REC_QTY,0)) AS PENDING_QTY,    
          ROW_NUMBER () OVER (ORDER BY  A.ORDER_ID) AS FGSR    
   INTO #TMPFINAL     
   FROM #TMPISSUE_REC A    
   JOIN #TMPISSUE_REC B ON A.ISSUE_ID=B.ISSUE_ID AND  A.ORDER_ID=B.ORDER_ID AND A.PARA1_CODE =B.PARA1_CODE AND A.PARA2_CODE =B.PARA2_CODE AND  B.SR<=A.SR    
   GROUP BY A.ORDER_ID,    
          A.ORDER_NO,A.AGENCY_CODE,    
          A.AGENCY_NAME,    
          A.PARA1_CODE,    
          A.PARA1_NAME,    
          A.PARA2_CODE,    
          A.PARA2_NAME,    
          A.ARTICLE_CODE,    
          A.FG_ARTICLE_NO,    
          A.FG_ARTICLE_NAME,    
          A.ISSUE_ID,    
          A.ISSUE_NO,    
          A.ISSUE_DT ,    
          A.ISSUE_QTY,    
          A.RECEIVE_NO,    
          A.RECEIVE_DT ,    
          A.REC_QTY,    
          A.SR,    
          CASE WHEN A.SR=1 THEN  A.ISSUE_QTY ELSE 0 END    
   ORDER BY A.AGENCY_CODE, A.PARA1_CODE,A.PARA2_CODE,A.ARTICLE_CODE ,A.ORDER_ID,A.ISSUE_ID,A.SR    
        
    IF @NPENDING=1    
    BEGIN    
            
        DELETE A FROM #TMPFINAL A    
        JOIN     
        (    
   SELECT A.* FROM #TMPFINAL A    
   JOIN    
   (    
   SELECT A.ISSUE_ID,  A.ORDER_ID, A.FG_COLOR, A.FG_SIZE,MAX(A.SR) AS SR     
   FROM #TMPFINAL A    
   GROUP BY A.ISSUE_ID,  A.ORDER_ID, A.FG_COLOR, A.FG_SIZE    
   ) B ON A.ISSUE_ID=B.ISSUE_ID AND  A.ORDER_ID=B.ORDER_ID AND A.FG_COLOR =B.FG_COLOR AND A.FG_SIZE =B.FG_SIZE AND  B.SR=A.SR    
   WHERE A.PENDING_QTY =0    
        ) B ON A.ISSUE_ID=B.ISSUE_ID AND  A.ORDER_ID=B.ORDER_ID AND A.FG_COLOR =B.FG_COLOR AND A.FG_SIZE =B.FG_SIZE     
        
    END    
        
   --IF OBJECT_ID('TEMPDB..#TMPISSUE','U') IS NOT NULL    
   --   DROP TABLE #TMPISSUE    
          
   --   SELECT * FROM TMPFINAL A WHERE  ORDER_ID='0101117000000100000941'    
        
    IF OBJECT_ID('TEMPDB..#TMPRMDETAILS','U') IS NOT NULL    
        DROP TABLE #TMPRMDETAILS    
        
           
    SELECT 'FG DETAILS' AS DETAILS, CAST(A.FGSR AS NUMERIC(10,1)) AS FGSR,A.ORDER_ID,A.ORDER_NO,A.AGENCY_NAME,    
              A.FG_ARTICLE_NO,A.FG_ARTICLE_NAME,A.FG_COLOR,A.FG_SIZE,A.ISSUE_ID,A.ISSUE_NO,    
              A.ISSUE_DT,A.ISSUE_QTY AS FG_ISSUE,0 AS ISSUE_QTY, A.RECEIVE_NO,A.RECEIVE_DT,    
              A.REC_QTY AS FG_REC,0 AS REC_QTY,    
              A.CUMM_REC,A.PENDING_QTY ,    
              '' AS  RM_ARTICLE_NO ,'' AS PRODUCT_CODE,    
              '' AS UOM_NAME,    
              '' AS PARA1_NAME ,'' AS PARA2_NAME ,    
              '' AS PARA3_NAME ,'' AS PARA4_NAME ,'' AS PARA5_NAME ,'' AS PARA6_NAME     
    INTO #TMPRMDETAILS    
    FROM #TMPFINAL A    
       --WHERE A.ISSUE_ID='WH0111700000WH00000002'    
       UNION ALL    
       SELECT 'RM DETAILS' AS DETAILS,SR=0, C.REF_PRD_WORKORDER_MEMOID AS ORDER_ID ,    
              RIGHT (C.REF_PRD_WORKORDER_MEMOID,10) AS ORDER_NO,AG.AGENCY_NAME ,    
              ART.ARTICLE_NO,ART.ARTICLE_NAME ,P1.PARA1_NAME ,P2.PARA2_NAME ,    
              B.MEMO_ID ,B.MEMO_NO ,B.MEMO_DT ,0 AS FG_ISSUE,  C.QUANTITY ,    
              REC.MEMO_NO,REC.MEMO_DT ,0 AS FG_REC,ISNULL(REC.REC_QTY,0 ) AS REC_QTY,    
              0 AS CUMM_REC,C.QUANTITY-ISNULL(REC.REC_QTY,0 ) AS PENDING_QTY,    
              ART1.ARTICLE_NO AS RM_ARTICLE_NO ,SKU.PRODUCT_CODE,    
              UOM.UOM_NAME ,    
              P11.PARA1_NAME ,P12.PARA2_NAME ,    
              P3.PARA3_NAME ,P4.PARA4_NAME ,P5.PARA5_NAME ,P6.PARA6_NAME     
                 
       FROM     
       PRD_AGENCY_ISSUE_ROW_MATERIAL_DET A    
       JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID     
       JOIN PRD_AGENCY_ISSUE_MATERIAL_DET C ON A.ROW_ID =C.REF_MATERIAL_ROW_ID AND A.MEMO_ID =C.MEMO_ID     
       JOIN PRD_AGENCY_MST  AG ON AG.AGENCY_CODE  =B.REF_AGENCY_CODE    
       JOIN ARTICLE ART ON ART.ARTICLE_CODE =A.ARTICLE_CODE     
       JOIN PARA1 P1 ON P1.PARA1_CODE =A.PARA1_CODE     
       JOIN PARA2 P2 ON P2.PARA2_CODE =A.PARA2_CODE     
       JOIN PRD_SKU SKU ON SKU.PRODUCT_UID =C.PRODUCT_UID     
       JOIN PARA1 P11 ON P11.PARA1_CODE =SKU.PARA1_CODE     
       JOIN PARA2 P12 ON P12.PARA2_CODE =SKU.PARA2_CODE     
       JOIN PARA3 P3 ON P3.PARA3_CODE=SKU.PARA3_CODE    
       JOIN PARA4 P4 ON P4.PARA4_CODE=SKU.PARA4_CODE    
       JOIN PARA5 P5 ON P5.PARA5_CODE=SKU.PARA5_CODE    
       JOIN PARA6 P6 ON P6.PARA6_CODE=SKU.PARA6_CODE    
       JOIN ARTICLE ART1 ON ART1.ARTICLE_CODE =SKU.ARTICLE_CODE     
       JOIN UOM ON UOM.UOM_CODE =ART1.UOM_CODE     
       LEFT OUTER JOIN    
       (    
        SELECT C.REF_ROW_ID ,B.MEMO_ID ,B.MEMO_NO ,B.MEMO_DT,    
               SUM(C.QUANTITY) AS REC_QTY      
        FROM PRD_AGENCY_ROW_MATERIAL_RECEIPT_DET A        
        JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID      
        JOIN PRD_AGENCY_MATERIAL_RECEIPT_DET C ON A.ROW_ID =C.REF_MATERIAL_ROW_ID AND A.MEMO_ID =C.MEMO_ID     
        WHERE     
        B.CANCELLED =0    
        GROUP BY C.REF_ROW_ID ,B.MEMO_ID ,B.MEMO_NO ,B.MEMO_DT    
        UNION ALL    
        SELECT C.REF_ROW_ID ,B.MEMO_ID ,B.MEMO_NO ,B.MEMO_DT,    
               SUM(C.QUANTITY) AS REC_QTY      
        FROM PRD_AGENCY_RM_RETURN_MST  B     
        JOIN PRD_AGENCY_RM_RETURN_DET C ON  B.MEMO_ID =C.MEMO_ID     
        WHERE B.CANCELLED =0    
        GROUP BY C.REF_ROW_ID ,B.MEMO_ID ,B.MEMO_NO ,B.MEMO_DT    
       ) REC ON C.ROW_ID =REC.REF_ROW_ID    
       WHERE 
       --( @AC_CODE='' OR B.REF_AGENCY_CODE=@CAGENCY_CODE)      
       --AND (@CARTICLE_CODE='' OR A.ARTICLE_CODE=@CARTICLE_CODE) AND    
        B.CANCELLED =0    
       UNION ALL    
       SELECT 'RM DETAILS PENDING' AS DETAILS,SR=0, C.REF_PRD_WORKORDER_MEMOID AS ORDER_ID ,    
              RIGHT (C.REF_PRD_WORKORDER_MEMOID,10) AS ORDER_NO,AG.AGENCY_NAME ,    
              ART.ARTICLE_NO,ART.ARTICLE_NAME ,P1.PARA1_NAME ,P2.PARA2_NAME ,    
              IM.MEMO_ID ,IM.MEMO_NO ,IM.MEMO_DT ,0 AS FG_ISSUE,C.QUANTITY ,    
              REC.MEMO_NO,REC.MEMO_DT ,0 AS FG_REC,ISNULL(REC.REC_QTY,0 ) AS REC_QTY,    
              0 AS CUMM_REC,C.QUANTITY-ISNULL(REC.REC_QTY,0 ) AS PENDING_QTY,    
              ART1.ARTICLE_NO AS RM_ARTICLE_NO ,SKU.PRODUCT_CODE,UOM.UOM_NAME,    
              P11.PARA1_NAME ,P12.PARA2_NAME ,    
              P3.PARA3_NAME ,P4.PARA4_NAME ,P5.PARA5_NAME ,P6.PARA6_NAME     
       FROM  PRD_AGENCY_ISSUE_MATERIAL_MST_PENDING B     
       JOIN PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING  C ON  B.MEMO_ID =C.MEMO_ID     
       JOIN PRD_AGENCY_ISSUE_MATERIAL_MST IM ON IM.MEMO_ID =C.REF_ISSUE_ID     
       JOIN PRD_SKU SKU ON SKU.PRODUCT_UID =C.PRODUCT_UID     
       JOIN PRD_AGENCY_MST  AG ON AG.AGENCY_CODE  =B.REF_AGENCY_CODE    
       JOIN PRD_WO_MST MST ON MST.MEMO_ID =C.REF_PRD_WORKORDER_MEMOID    
       JOIN ARTICLE ART ON ART.ARTICLE_CODE =MST.ARTICLE_SET_CODE      
       JOIN PARA1 P1 ON P1.PARA1_CODE =SKU.COM_PARA1_CODE     
       JOIN PARA2 P2 ON P2.PARA2_CODE =SKU.COM_PARA2_CODE     
       JOIN PARA1 P11 ON P11.PARA1_CODE =SKU.PARA1_CODE     
       JOIN PARA2 P12 ON P12.PARA2_CODE =SKU.PARA2_CODE     
       JOIN PARA3 P3 ON P3.PARA3_CODE=SKU.PARA3_CODE    
       JOIN PARA4 P4 ON P4.PARA4_CODE=SKU.PARA4_CODE    
       JOIN PARA5 P5 ON P5.PARA5_CODE=SKU.PARA5_CODE    
       JOIN PARA6 P6 ON P6.PARA6_CODE=SKU.PARA6_CODE    
       JOIN ARTICLE ART1 ON ART1.ARTICLE_CODE =SKU.ARTICLE_CODE     
       JOIN UOM ON UOM.UOM_CODE =ART1.UOM_CODE     
       LEFT OUTER JOIN    
       (    
        SELECT C.REF_ROW_ID ,B.MEMO_ID ,B.MEMO_NO ,B.MEMO_DT,    
               SUM(C.QUANTITY) AS REC_QTY      
        FROM PRD_AGENCY_ROW_MATERIAL_RECEIPT_DET A        
        JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID      
        JOIN PRD_AGENCY_MATERIAL_RECEIPT_DET C ON A.ROW_ID =C.REF_MATERIAL_ROW_ID AND A.MEMO_ID =C.MEMO_ID     
        WHERE B.CANCELLED =0    
        GROUP BY C.REF_ROW_ID ,B.MEMO_ID ,B.MEMO_NO ,B.MEMO_DT    
        UNION ALL    
        SELECT C.REF_ROW_ID ,B.MEMO_ID ,B.MEMO_NO ,B.MEMO_DT,    
               SUM(C.QUANTITY) AS REC_QTY      
        FROM PRD_AGENCY_RM_RETURN_MST  B     
        JOIN PRD_AGENCY_RM_RETURN_DET C ON  B.MEMO_ID =C.MEMO_ID     
        WHERE B.CANCELLED =0    
        GROUP BY C.REF_ROW_ID ,B.MEMO_ID ,B.MEMO_NO ,B.MEMO_DT    
       ) REC ON C.ROW_ID =REC.REF_ROW_ID    
       WHERE     
       --( @AC_CODE='' OR B.REF_AGENCY_CODE=@CAGENCY_CODE)      
       --AND (@CARTICLE_CODE='' OR ART.ARTICLE_CODE=@CARTICLE_CODE)  AND   
        B.CANCELLED =0    
          
  --    UPDATE A SET FGSR=B.FGSR FROM #TMPRMDETAILS A    
  --JOIN    
  --(    
  --  SELECT A.ORDER_ID,FG_ARTICLE_NO,FG_COLOR ,FG_SIZE ,    
  --  A.ISSUE_ID,A.RECEIVE_NO,A.RECEIVE_DT, A.FGSR     
  --  FROM #TMPRMDETAILS A    
  --  WHERE FGSR<>0    
  --) B ON A.ORDER_ID=B.ORDER_ID AND A.FG_ARTICLE_NO=B.FG_ARTICLE_NO    
  --AND A.FG_COLOR=B.FG_COLOR    
  --AND A.FG_SIZE=B.FG_SIZE    
  --AND A.ISSUE_ID=B.ISSUE_ID    
  ----AND A.RECEIVE_NO=B.RECEIVE_NO    
  ----AND A.RECEIVE_DT=B.RECEIVE_DT    
  --WHERE A.FGSR=0    
          
          
           
           
 SELECT A.DETAILS ,A.FGSR ,A.ORDER_ID ,A.ORDER_NO ,A.AGENCY_NAME ,A.FG_ARTICLE_NO ,A.FG_ARTICLE_NAME ,    
             A.FG_COLOR ,A.FG_SIZE,A.ISSUE_ID ,A.ISSUE_NO ,A.ISSUE_DT ,B.FG_ISSUE, A.ISSUE_QTY ,A.RECEIVE_NO ,A.RECEIVE_DT ,    
             B.FG_REC,A.REC_QTY ,A.CUMM_REC,ISNULL(B.FG_ISSUE,0)-ISNULL(B.FG_REC,0) AS FG_PENDING, A.PENDING_QTY ,A.RM_ARTICLE_NO ,A.PRODUCT_CODE ,A.UOM_NAME,    
             A.PARA1_NAME ,A.PARA2_NAME ,A.PARA3_NAME ,A.PARA4_NAME ,A.PARA5_NAME ,A.PARA6_NAME      
    FROM #TMPRMDETAILS A    
 JOIN    
 (    
      
  SELECT ORDER_ID,AGENCY_NAME,FG_ARTICLE_NO,FG_COLOR,FG_SIZE,ISSUE_ID,    
   SUM(FG_ISSUE) AS FG_ISSUE,SUM(FG_REC) AS FG_REC    
  FROM #TMPRMDETAILS A    
  WHERE DETAILS='FG DETAILS'    
  GROUP BY ORDER_ID,AGENCY_NAME,FG_ARTICLE_NO,FG_COLOR,FG_SIZE,ISSUE_ID    
    
 ) B ON A.ORDER_ID=B.ORDER_ID     
 AND A.AGENCY_NAME=B.AGENCY_NAME     
 AND A.FG_ARTICLE_NO=B.FG_ARTICLE_NO     
 AND A.FG_COLOR=B.FG_COLOR AND  A.FG_SIZE=B.FG_SIZE    
 AND A.ISSUE_ID=B.ISSUE_ID    
 WHERE DETAILS='RM DETAILS'    
    
          
     -- SELECT A.DETAILS ,A.FGSR ,A.ORDER_ID ,A.ORDER_NO ,A.AGENCY_NAME ,A.FG_ARTICLE_NO ,A.FG_ARTICLE_NAME ,    
     --        A.FG_COLOR ,A.FG_SIZE,A.ISSUE_ID ,A.ISSUE_NO ,A.ISSUE_DT ,A.FG_ISSUE, A.ISSUE_QTY ,A.RECEIVE_NO ,A.RECEIVE_DT ,    
     --        A.FG_REC,A.REC_QTY ,A.CUMM_REC,A.PENDING_QTY ,A.RM_ARTICLE_NO ,A.PRODUCT_CODE ,A.UOM_NAME,    
     --        A.PARA1_NAME ,A.PARA2_NAME ,A.PARA3_NAME ,A.PARA4_NAME ,A.PARA5_NAME ,A.PARA6_NAME     
     -- FROM #TMPRMDETAILS A    
     ---- WHERE A.ISSUE_ID='WH0111700000WH00000002'    
     -- ORDER BY A.ORDER_ID,FG_ARTICLE_NO,FG_COLOR ,FG_SIZE ,    
     -- A.ISSUE_ID,A.RECEIVE_NO,A.DETAILS ,FGSR DESC    
          
       
END
