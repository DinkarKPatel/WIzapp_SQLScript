CREATE PROCEDURE SP_AGENCY_JOB_RATE_WISE_RECEIVED
(
   @FROM_DATE DATE='1900-01-01'
  ,@TO_DATE DATE='1900-01-01'
  ,@AGENCY_FILTER VARCHAR(MAX)=''
  ,@NCANCELLETION INT=0
)
AS
BEGIN
   	DECLARE @DTSQL NVARCHAR(MAX),@CCOLNAME VARCHAR(MAX),@CMERCHANT_FILTER VARCHAR(MAX)
   	
	IF OBJECT_ID('TEMPDB..#TMPDETAILS','U') IS NOT NULL
	   DROP TABLE #TMPDETAILS

	;WITH CTE AS
	(
	SELECT ISNULL(A.ORDER_ID,wo.ORDER_ID) AS F_ORDER_ID,
		   WO .ARTICLE_CODE,
		   WO.MEMO_NO AS WO_NO,
		   CONVERT(VARCHAR,WO.MEMO_DT,105) AS WO_DT,
		   WO.PARA1_CODE ,ISNULL(A.ITEM_MERCHANT_CODE ,'0000000') AS ITEM_MERCHANT_CODE,
		   A.JOB_CODE,RECEIPT_NO,
		   CONVERT(VARCHAR,RECEIPT_DT,105) AS RECEIPT_DT,
		   A.PRODUCT_CODE ,
		   SR=ROW_NUMBER() OVER(PARTITION BY  AM.AGENCY_NAME,A.PRODUCT_CODE ORDER BY D.LAST_UPDATE DESC),
		   AM.AGENCY_NAME
		   ,D.RATE,D.AMOUNT
		   ,AM.AC_CODE
	FROM JOBWORK_PMT  A (nolock)
	JOIN
	(
	 SELECT ISNULL(MST.ORDER_ID ,'') AS ORDER_ID,
	        MEMO_NO,MEMO_DT ,OD.ARTICLE_CODE ,OD.PARA1_CODE,
	        BD.PRODUCT_CODE 
	 FROM ORD_PLAN_MST OM (NOLOCK) 
	 JOIN ORD_PLAN_DET OD (NOLOCK) ON OM.MEMO_ID =OD.MEMO_ID 
	 JOIN ORD_PLAN_BARCODE_DET BD (NOLOCK) ON REFROW_ID =OD.ROW_ID 
	 LEFT JOIN BUYER_ORDER_DET DET (NOLOCK) ON DET.ROW_ID=OD.WOD_ROW_ID
	 LEFT JOIN BUYER_ORDER_MST MST (NOLOCK) ON DET.order_id =MST.order_id 
	 WHERE OM.CANCELLED=0
	) WO ON WO.PRODUCT_CODE=A.PRODUCT_CODE 
	LEFT JOIN
	(
	 SELECT  B.AGENCY_CODE ,A.JOB_CODE,A.PRODUCT_CODE,B.LAST_UPDATE,
			 B.RECEIPT_NO  AS RECEIPT_NO,B.RECEIPT_DT  AS RECEIPT_DT
			 ,A.JOB_RATE AS RATE,
			 CONVERT(NUMERIC(10,2),CASE WHEN A.QUANTITY >0 THEN  A.JOB_RATE/A.QUANTITY ELSE 0 END)   AS AMOUNT
	 FROM JOBWORK_RECEIPT_DET  A (NOLOCK)
	 JOIN JOBWORK_RECEIPT_MST  B (NOLOCK) ON A.RECEIPT_ID  =B.RECEIPT_ID
	 WHERE B.CANCELLED=0
	 GROUP BY B.AGENCY_CODE ,A.JOB_CODE,A.PRODUCT_CODE,B.LAST_UPDATE,B.RECEIPT_NO ,B.RECEIPT_DT,
	 A.JOB_RATE,
	 CONVERT(NUMERIC(10,2),CASE WHEN A.QUANTITY >0 THEN  A.JOB_RATE/A.QUANTITY ELSE 0 END)
	) D ON   A.PRODUCT_CODE=D.PRODUCT_CODE -- A.JOB_CODE =D.JOB_CODE AND
	LEFT JOIN PRD_AGENCY_MST  AM ON AM.AGENCY_CODE=D.AGENCY_CODE
	--JOIN PRD_WO_ORDERS ORD ON ORD.MEMO_ID=A.WO_ID
	--JOIN PRD_WO_MST WO ON WO .MEMO_ID =ORD .MEMO_ID 
	WHERE D.RECEIPT_DT BETWEEN @FROM_DATE AND @TO_DATE
	)
    SELECT *,CAST(0 AS INT) AS CANCELLETION_QTY INTO #TMPDETAILS FROM CTE WHERE SR=1  --AND ISNULL(JOB_CODE,'')<>''
    
    IF ISNULL(@AGENCY_FILTER,'')<>''
        BEGIN
    	  SET @DTSQL='DELETE FROM #TMPDETAILS WHERE AC_CODE NOT '+@AGENCY_FILTER
    	  PRINT @DTSQL
	      EXEC SP_EXECUTESQL @DTSQL
	    END
    
    
    
		--UPDATE TMP SET CANCELLETION_QTY =A.QTY  FROM 
		--#TMPDETAILS TMP
		--JOIN PRD_TRANSFER_MAIN_DET A ON TMP.PRODUCT_CODE=A.WIP_PRODUCT_CODE 
		--JOIN PRD_TRANSFER_MAIN_MST B ON A.MEMO_ID =B.MEMO_ID 
		--WHERE B.CANCELLED=0 AND ISNULL(B.MODE,0)=1
	    
    
	IF OBJECT_ID ('TEMPDB..#TMPWIP','U') IS NOT NULL
	   DROP TABLE #TMPWIP

    SELECT   CAST('' AS VARCHAR(100)) AS  PARTY_NAME,
		   CAST('' AS VARCHAR(100)) AS ORDER_NO ,
		   CONVERT(VARCHAR(10),'') AS ORDER_DT,
		   A.WO_NO AS JOBCARD_NO,
		   A.WO_DT AS JOBCARD_DT,
		   CAST('' AS VARCHAR(100))  AS ARTICLE_NO ,
		   CAST('' AS VARCHAR(100)) AS MERCHANT,
		   A.AGENCY_NAME ,
		   A.PRODUCT_CODE ,
		   A.RECEIPT_NO ,
		   A.RECEIPT_DT ,
		   1 AS QUANTITY_IN_STOCK,
		   CAST('' AS VARCHAR(100)) AS JOB_NAME 
		   ,RATE
		   ,AMOUNT
		   ,ARTICLE_CODE
		   ,CAST('' AS VARCHAR(100)) AS PARA1_NAME
		   ,A.CANCELLETION_QTY
	INTO #TMPWIP
	FROM #TMPDETAILS A
	WHERE 1=2

 SET @DTSQL =N'SELECT LM.AC_NAME AS PARTY_NAME,
		   BM.ORDER_NO ,CONVERT(VARCHAR,BM.ORDER_DT ,105) AS ORDER_DT,
		   A.WO_NO,
		   A.WO_DT,
		   ART.ARTICLE_NO AS ARTICLE_NO ,
		   EMP.EMP_NAME AS MERCHANT,
		   A.AGENCY_NAME ,
		   A.PRODUCT_CODE ,
		   A.RECEIPT_NO ,
		   A.RECEIPT_DT ,
		   1 AS QUANTITY_IN_STOCK,
		   JOBS.JOB_NAME 
		   ,A.RATE
		   ,A.AMOUNT
		   ,A.ARTICLE_CODE
		   ,P1.PARA1_NAME
		   ,A.CANCELLETION_QTY
	FROM #TMPDETAILS A
	JOIN PARA1 P1 (NOLOCK) ON A.PARA1_CODE=P1.PARA1_CODE
	JOIN BUYER_ORDER_MST BM (NOLOCK) ON BM.ORDER_ID =A.F_ORDER_ID 
	JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =BM.AC_CODE 
	JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
	JOIN EMPLOYEE EMP (NOLOCK) ON EMP.EMP_CODE =A.ITEM_MERCHANT_CODE 
	JOIN JOBS (NOLOCK) ON JOBS.JOB_CODE =A.JOB_CODE '
	----WHERE ('''+@CMERCHANT_FILTER+'''='''' OR ITEM_MERCHANT_CODE  '+@CMERCHANT_CODE+' ) 
	PRINT @DTSQL
	INSERT INTO #TMPWIP( PARTY_NAME,ORDER_NO ,ORDER_DT,JOBCARD_NO ,JOBCARD_DT , ARTICLE_NO ,MERCHANT,AGENCY_NAME ,
		   PRODUCT_CODE ,RECEIPT_NO ,RECEIPT_DT ,QUANTITY_IN_STOCK,JOB_NAME,RATE,AMOUNT,ARTICLE_CODE,PARA1_NAME,CANCELLETION_QTY)
	EXEC SP_EXECUTESQL @DTSQL

  
  SELECT A.*, CAST(VALUE+''+IMAGE_SUBFOLDER+'\'+A.ARTICLE_NO+'.JPG' AS VARCHAR(1000)) AS PICT_PATH  
  FROM #TMPWIP A
  LEFT JOIN IMAGE_INFO IMG (NOLOCK) ON IMG.ARTICLE_CODE=A.ARTICLE_CODE
  JOIN ( SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='ART_PICT_PATH' )  PIC ON 1=1
  WHERE (@NCANCELLETION=0 OR ISNULL(A.CANCELLETION_QTY,0) >0)
  ORDER BY A.RECEIPT_DT
  --ARTICLE_NO,AGENCY_NAME --,FG_COLOR , ISSUE_ID  
  
END
