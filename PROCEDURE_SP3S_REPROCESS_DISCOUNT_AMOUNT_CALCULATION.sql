CREATE PROCEDURE DBO.SP3S_REPROCESS_DISCOUNT_AMOUNT_CALCULATION
(
 @INV_ID VARCHAR(100)
,@ERRMSG VARCHAR(MAX) OUTPUT
)
AS
BEGIN
 BEGIN TRY

    ---DECLARE LOCAL VARIABLE
    DECLARE @ILOOP_START INT,@ILOOP_END INT,@NDISCOUNT_PERCENTAGE NUMERIC(15,2)
           ,@NDISCOUNT_AMOUNT NUMERIC(15,2),@TOTAL_DISCOUNT_AMOUNT NUMERIC(15,2)
           ,@NITEM_WISE_DIS_AMOUNT NUMERIC(15,2),@ID INT,@NREMANING_BALANCE NUMERIC(15,2)
           ,@LOOP_VAT_UPDATE_END  INT,@CSQLSTR NVARCHAR(MAX),@NREMANING_QTY INT
    ---SET VALE INTO LOCAL VARIABLE
    SET @NDISCOUNT_AMOUNT       =  0
    SET @NDISCOUNT_PERCENTAGE   =  0
    SET @TOTAL_DISCOUNT_AMOUNT  =  0
    SET @NITEM_WISE_DIS_AMOUNT  =  0    
    SET @ERRMSG =''
    
    --CREATE A TABLE TO INSERT RECORDS DISCOUNT AMOUNT DETAILS BASED ON INV_ID
    IF OBJECT_ID('TEMPDB..#TEMP_DISCOUNT_AMOUNT') IS NOT NULL
       DROP TABLE #TEMP_DISCOUNT_AMOUNT
    CREATE TABLE #TEMP_DISCOUNT_AMOUNT
     (
      ID INT IDENTITY(1,1)
     ,RATE NUMERIC(15,2)
     ,INVOICE_QUANTITY NUMERIC(15,2)
     ,DISCOUNT_AMOUNT NUMERIC(15,2)
     ,DISCOUNT_PERCENTAGE NUMERIC(15,2)
     ,ROW_ID VARCHAR(100)
     )
    --INSERT RECORDS INTO TEMP TABLE
    INSERT INTO #TEMP_DISCOUNT_AMOUNT(RATE,INVOICE_QUANTITY,DISCOUNT_AMOUNT,DISCOUNT_PERCENTAGE,ROW_ID)
    SELECT D.RATE,D.INVOICE_QUANTITY,D.DISCOUNT_AMOUNT,D.DISCOUNT_PERCENTAGE ,D.ROW_ID
    FROM INM01106 M
    JOIN IND01106 D ON M.INV_ID = D.INV_ID
    WHERE D.INV_ID = @INV_ID	AND ISNULL(D.MANUAL_DISCOUNT,0)=0

    SET @LOOP_VAT_UPDATE_END= @@ROWCOUNT;

    ----CREATE TABLE FOR DISCOUNTV PERCENTAGE
    IF OBJECT_ID('TEMPDB..#TEMP_DISCOUNT_PERCENTAGE') IS NOT NULL
       DROP TABLE #TEMP_DISCOUNT_PERCENTAGE
       CREATE TABLE #TEMP_DISCOUNT_PERCENTAGE
       (
         ID INT IDENTITY(1,1)
        ,DISCOUNT_PERCERTAGE NUMERIC(15,2)
       )
    ----INSERT DISCOUNT PERCENTAGE INTO TEMP TABLE
    INSERT INTO #TEMP_DISCOUNT_PERCENTAGE(DISCOUNT_PERCERTAGE)     
    SELECT DISTINCT DISCOUNT_PERCENTAGE FROM #TEMP_DISCOUNT_AMOUNT
    SET @ILOOP_END = @@ROWCOUNT;
    SET @ILOOP_START = 1

    ---START LOOP FOR CALCULATE DISCOUNT AMOUNT
    WHILE @ILOOP_END >=@ILOOP_START
      BEGIN 
      SELECT @NDISCOUNT_PERCENTAGE=DISCOUNT_PERCERTAGE FROM #TEMP_DISCOUNT_PERCENTAGE WHERE ID = @ILOOP_START
      SELECT @NDISCOUNT_AMOUNT = SUM(ISNULL(RATE,0)*INVOICE_QUANTITY)*@NDISCOUNT_PERCENTAGE/100
      FROM #TEMP_DISCOUNT_AMOUNT WHERE DISCOUNT_PERCENTAGE = @NDISCOUNT_PERCENTAGE
      
      SET @TOTAL_DISCOUNT_AMOUNT = @TOTAL_DISCOUNT_AMOUNT+@NDISCOUNT_AMOUNT
       
       SET @ILOOP_START = @ILOOP_START + 1;
      END

    --CALCULATE TAOTAL DISCOUNT AMOUNT
    SELECT @NITEM_WISE_DIS_AMOUNT = SUM(ISNULL(DISCOUNT_AMOUNT,0)) FROM #TEMP_DISCOUNT_AMOUNT 



    --VALIDATE CUMULATIVE AND ITEM WISE DISCOUNBT AMOUNT
    IF @NITEM_WISE_DIS_AMOUNT <> @TOTAL_DISCOUNT_AMOUNT
    BEGIN
      SET @NREMANING_BALANCE = (@TOTAL_DISCOUNT_AMOUNT - @NITEM_WISE_DIS_AMOUNT) * 100;
      SET @NREMANING_QTY =SUBSTRING(CAST(@NREMANING_BALANCE AS VARCHAR(10)),1,CHARINDEX('.',@NREMANING_BALANCE)-1)  
      WHILE ISNULL(@NREMANING_QTY,0) > 0
       BEGIN
         IF @NREMANING_QTY > @LOOP_VAT_UPDATE_END
          BEGIN
           UPDATE #TEMP_DISCOUNT_AMOUNT SET DISCOUNT_AMOUNT = ISNULL(DISCOUNT_AMOUNT,0)+.01
           SET @NREMANING_QTY = @NREMANING_QTY - @LOOP_VAT_UPDATE_END
          END   
          ELSE
          BEGIN
            SET @CSQLSTR =N'UPDATE #TEMP_DISCOUNT_AMOUNT SET DISCOUNT_AMOUNT = ISNULL(DISCOUNT_AMOUNT,0)+.01
                            WHERE ROW_ID IN (SELECT TOP '+CAST(@NREMANING_QTY AS VARCHAR(10))+' ROW_ID FROM
                            #TEMP_DISCOUNT_AMOUNT)'
            PRINT (@CSQLSTR)
            EXEC SP_EXECUTESQL @CSQLSTR
            SET @NREMANING_QTY = 0
          END
                
       END
       --UPDATE DISCOUNT AMOUNT VINTO MAIN TABLE
       UPDATE D SET D.DISCOUNT_AMOUNT = M.DISCOUNT_AMOUNT  FROM DBO.IND01106 D
       JOIN #TEMP_DISCOUNT_AMOUNT M ON M.ROW_ID = D.ROW_ID
       
    END
END TRY
BEGIN CATCH
  SET @ERRMSG ='ERROR IN PROCEDURE || SP3S_DISCOUNT_AMOUNT_CALCULATION ERROR MESSAGE || '+ ERROR_MESSAGE();
END CATCH


END
