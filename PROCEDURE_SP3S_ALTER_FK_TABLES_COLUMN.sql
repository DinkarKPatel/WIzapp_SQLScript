CREATE PROCEDURE SP3S_ALTER_FK_TABLES_COLUMN
(
  @TABLE_NAME VARCHAR(200)  
 ,@COLUMN_NAME VARCHAR(200)  

)
AS
BEGIN

BEGIN TRY

BEGIN TRAN
  DECLARE @NROWCOUNT INT , @CSTRQUERY NVARCHAR(MAX) ,@CERRMSG NVARCHAR(MAX),@NSTEP INT 
           ,@NLOOP_START INT  
           ,@CSOURCETABLE VARCHAR(500)  
           ,@CTARGATETABLE VARCHAR(500)  
           ,@CSOURCECOLUMN VARCHAR(500)  
           ,@CTARGATECOLUMN VARCHAR(500) 
           ,@FOREIGNKEY VARCHAR(1000) 
           ,@CERORMSG VARCHAR(MAX)  
           ,@STRQUERY NVARCHAR(MAX)  
           ,@CDATABASENAME VARCHAR(100)  
           ,@UNIQUE_CONSTRAINT_COLUMN_NAME VARCHAR(200)
           ,@RECORDS_EXISTS VARCHAR(100) ,
           @STRSQL NVARCHAR(MAX) ,
           @CFLAG INT 
           
           SET @CFLAG=0
 
 
		
		
		SET @NSTEP=10
		
		IF OBJECT_ID('TEMPDB..#CONSTRAINT_DETAILS') IS NOT NULL  
        DROP TABLE #CONSTRAINT_DETAILS  
        
        IF OBJECT_ID('TEMPDB..##CONSTRAINT_DETAILS1') IS NOT NULL  
        DROP TABLE #CONSTRAINT_DETAILS1
        
		CREATE TABLE #CONSTRAINT_DETAILS  
		 (  
		  ID INT IDENTITY(1,1)  
		 ,SOURCE_TABLE VARCHAR(500)  
		 ,SOURCE_COLUMN VARCHAR(500)  
		 ,TARGAT_TABLE  VARCHAR(500)  
		 ,TARGAT_COLUMN VARCHAR(500)  
		 ,CONSTRAINTS_NAME VARCHAR(500)  
		 ) 
		 
		 CREATE TABLE #CONSTRAINT_DETAILS1  
		 (  
		  ID INT IDENTITY(1,1)  
		 ,SOURCE_TABLE VARCHAR(500)  
		 ,SOURCE_COLUMN VARCHAR(500)  
		 ,TARGAT_TABLE  VARCHAR(500)  
		 ,TARGAT_COLUMN VARCHAR(500)  
		 ,CONSTRAINTS_NAME VARCHAR(500)  
		 )  

		INSERT INTO #CONSTRAINT_DETAILS(SOURCE_TABLE,SOURCE_COLUMN,TARGAT_TABLE,TARGAT_COLUMN,CONSTRAINTS_NAME)  
		SELECT O2.NAME AS [SOURCE TABLE]  
			  ,C2.NAME AS [SOURCE COLUMN]  
			  ,O1.NAME AS [TARGATE TABLE]   
			  ,C1.NAME AS [TARGATE COLUMN]  
			  ,FK.NAME AS [FORIGEN KEY NAME]  
	        
	 FROM SYS.OBJECTS O1  
	 JOIN SYS.FOREIGN_KEYS FK ON O1.OBJECT_ID = FK.PARENT_OBJECT_ID  
	 JOIN SYS.FOREIGN_KEY_COLUMNS FKC ON FK.OBJECT_ID=FKC.CONSTRAINT_OBJECT_ID  
	 JOIN SYS.COLUMNS C1 ON FKC.PARENT_OBJECT_ID = C1.OBJECT_ID  
	   AND FKC.PARENT_COLUMN_ID=C1.COLUMN_ID  
	 JOIN SYS.COLUMNS C2 ON FKC.REFERENCED_OBJECT_ID = C2.OBJECT_ID  
	   AND FKC.REFERENCED_COLUMN_ID=C2.COLUMN_ID  
	 JOIN SYS.OBJECTS O2 ON FK.REFERENCED_OBJECT_ID=O2.OBJECT_ID  
	 JOIN SYS.KEY_CONSTRAINTS PK ON FK.REFERENCED_OBJECT_ID = PK.PARENT_OBJECT_ID  
	   AND FK.KEY_INDEX_ID = PK.UNIQUE_INDEX_ID  
	 WHERE O2.NAME =@TABLE_NAME
	 ORDER BY O2.NAME, C2.NAME  
	 --AND O1.NAME NOT IN ('LMP01106','LOCOB','CAMPAIGN_SECTIONM','CAMPAIGN_SECTIOND','SD_ATTR')    
	 SET @NROWCOUNT = @@ROWCOUNT;  
	 SET @NLOOP_START = 1;  
 
	 WHILE @NROWCOUNT >=@NLOOP_START  
	   BEGIN  
		 --DECLARE TARGATE TABLE AND TARGATE COLUMN NAME  
		 SELECT @CTARGATETABLE=TARGAT_TABLE,@CTARGATECOLUMN =TARGAT_COLUMN ,@FOREIGNKEY=CONSTRAINTS_NAME,
		 @CSOURCECOLUMN=SOURCE_COLUMN
		 FROM #CONSTRAINT_DETAILS WHERE ID=@NLOOP_START  
	       
	     SET @NSTEP=20 
	      -- DROP FOREIGN KEY 
		 SET @STRSQL = 'IF EXISTS (SELECT * FROM SYS.FOREIGN_KEYS WHERE OBJECT_ID = OBJECT_ID(N''' + QUOTENAME(SCHEMA_NAME()) + '.' + QUOTENAME(@FOREIGNKEY) + ''') AND PARENT_OBJECT_ID = OBJECT_ID(N''' + QUOTENAME(SCHEMA_NAME()) + '.' + QUOTENAME(@CTARGATETABLE) + '''))' + CHAR(13)
		 + 'ALTER TABLE ' + QUOTENAME(SCHEMA_NAME()) + '.' + QUOTENAME(@CTARGATETABLE) + ' DROP CONSTRAINT ' + QUOTENAME(@FOREIGNKEY) + '' + CHAR(13) + CHAR(13)
		 PRINT @STRSQL
	     EXEC SP_EXECUTESQL @STRSQL
	        

	         SET @NSTEP=30
            -- UPDATE VALUES IN TARGET TABLE 
		  SET @STRQUERY = N'ALTER TABLE DBO.['+@CTARGATETABLE+'] ALTER COLUMN ['+@CTARGATECOLUMN+'] VARCHAR(7) NOT NULL'
			 PRINT @STRQUERY    
			 EXEC SP_EXECUTESQL @STRQUERY
	    		 
		SET @NLOOP_START = @NLOOP_START+1;  
	    
	   END 
	   
	   
	 INSERT INTO #CONSTRAINT_DETAILS1(SOURCE_TABLE,SOURCE_COLUMN,TARGAT_TABLE,TARGAT_COLUMN,CONSTRAINTS_NAME)
	 SELECT SOURCE_TABLE,SOURCE_COLUMN,TARGAT_TABLE,TARGAT_COLUMN,CONSTRAINTS_NAME FROM 
	 #CONSTRAINT_DETAILS

	 SET @NROWCOUNT = @@ROWCOUNT;  
	 SET @NLOOP_START = 1;  
 
	 WHILE @NROWCOUNT >=@NLOOP_START  
	 BEGIN  
		 --DECLARE TARGATE TABLE AND TARGATE COLUMN NAME  
		 SELECT @CTARGATETABLE=TARGAT_TABLE,@CTARGATECOLUMN =TARGAT_COLUMN ,@FOREIGNKEY=CONSTRAINTS_NAME,
		 @CSOURCECOLUMN=SOURCE_COLUMN
		 FROM #CONSTRAINT_DETAILS WHERE ID=@NLOOP_START  
	       
	     IF  @CFLAG=0
	     BEGIN
			 SET @NSTEP=40
			 SET @STRQUERY = N'ALTER TABLE DBO.['+@TABLE_NAME+'] ALTER COLUMN ['+@CSOURCECOLUMN+'] VARCHAR(7) NOT NULL'
			 PRINT @STRQUERY    
			 EXEC SP_EXECUTESQL @STRQUERY
			 
			 SET @CFLAG=1	 
	     END
	        

			  
		----- ADD FOREIGN KEYS	 
         SET @NSTEP=50 
		 SELECT @STRSQL=
	       'ALTER TABLE ' + QUOTENAME(SCHEMA_NAME()) + '.' + QUOTENAME(@CTARGATETABLE) + ' 
	        WITH NOCHECK ADD CONSTRAINT ' + QUOTENAME(@FOREIGNKEY) + ' 
	        FOREIGN KEY(' + QUOTENAME(@CTARGATECOLUMN) + ') 
	        REFERENCES ' + QUOTENAME(SCHEMA_NAME()) + '.' + 
	        QUOTENAME(@TABLE_NAME) + ' (' + QUOTENAME(@CSOURCECOLUMN) + ')' + CHAR(13)		 
	 	PRINT @STRSQL
	    EXEC SP_EXECUTESQL @STRSQL	 
				   

		SET @NLOOP_START = @NLOOP_START+1;  
	    
	   END 
	   

END TRY
BEGIN CATCH
   
           SET @CERORMSG='ERROR IN PROCEDURE SP3S_UPDATE_FK_TABLES_DATA,STEP:'+LTRIM(RTRIM(@NSTEP))+'MESSAGE'+ERROR_MESSAGE()
           GOTO END_PROC
END CATCH

END_PROC:

	IF ISNULL(@CERORMSG,'')=''
		COMMIT
	ELSE
		ROLLBACK


	SELECT ISNULL(@CERORMSG,'') AS ERRMSG
         
END
