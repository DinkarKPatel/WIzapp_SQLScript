create PROCEDURE SP_SEND_MIRROR_SKU_DATA
(	
	 @CPRODUCTCODEPARA VARCHAR(50),
	 @CREQLOCID VARCHAR(5),
	 @BCALLEDFROMSLS BIT=0
)	
--WITH ENCRYPTION
AS
/*
	SP_SEND_MIRROR_SKU_DATA_208_01_02_14 : THIS PROCEDURE WILL SEND SKU FROM HO TO LOCATION.
*/
BEGIN
	DECLARE @DTSQL NVARCHAR(MAX),@NSPID INT,@CTEMPTABLE VARCHAR(500),
	@CTEMPEMPLOYEETABLE VARCHAR(200),@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),
	@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX),@CCUTOFFDATE VARCHAR(20),
	@CTEMPMASTERTABLE VARCHAR(200),@CTEMPDETAILTABLE VARCHAR(200),@CTEMPLMTABLE VARCHAR(200),
	@CTEMPLMPTABLE VARCHAR(200),@CTEMPAREATABLE VARCHAR(200),@CTEMPCITYTABLE VARCHAR(200),
	@CTEMPSKUTABLE VARCHAR(200),@CTEMPARTTABLE VARCHAR(200),@CTEMPSDTABLE VARCHAR(200),
	@CTEMPARTATTRTABLE VARCHAR(200),@CPRODUCTCODE VARCHAR(50),@BUPDPURINFO BIT,@BPURLOC BIT,
	@CTARGETDB VARCHAR(500),@CERRMSG VARCHAR(MAX),@NDISCPCT NUMERIC(7,3),@CDONOTALLOWSLRWOSLS VARCHAR(1)
	
	DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),
								 XN_ID VARCHAR(40))  	
BEGIN TRY 	
	---- CALL ACKNOWLEDGEMENT OF MEMO SUCCESSFUL MERGING AT MIRRORING SERVER
	SET @CSTEP=00
		
	SET @CSTEP=10
	SET @CFILTERCONDITION=''
	

	IF NOT EXISTS (SELECT TOP 1 PRODUCT_CODE FROM SKU (NOLOCK) WHERE PRODUCT_CODE=@CPRODUCTCODEPARA)
	BEGIN
		SET @CERRMSG='BAR CODE :'+@CPRODUCTCODEPARA+' DETAILS NOT FOUND AT HEAD OFFICE'
		GOTO END_PROC
	END	
	
	IF @BCALLEDFROMSLS=1
	BEGIN	
		SELECT TOP 1 @CDONOTALLOWSLRWOSLS=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='DONOT_ALLOW_SLR_WOSLS'
		
		---- CHECK FOR THE PENDING MEMO TO BE SENT TO MIRRORING SERVER
		DECLARE @TSLSDETAILS TABLE (DISCOUNT_PERCENTAGE NUMERIC(7,3),TAX_METHOD INT)
		
		SET @CSTEP=20
		
		INSERT 	@TSLSDETAILS
		EXEC SP_WL_PICKLASTDISCOUNT		
		
		---- IF BARCODE NOT FOUND , JUST END THE PROCESS
		IF NOT EXISTS (SELECT TOP 1 * FROM @TSLSDETAILS) AND ISNULL(@CDONOTALLOWSLRWOSLS,'')='1'
		BEGIN
			SET @CERRMSG='BAR CODE :'+@CPRODUCTCODEPARA+' SALE DETAILS NOT FOUND AT HEAD OFFICE'
			GOTO END_PROC
		END	
		
		SELECT @NDISCPCT=DISCOUNT_PERCENTAGE FROM @TSLSDETAILS 
	END
	
	SET @NDISCPCT=ISNULL(@NDISCPCT,0)
	
LBLTABLEINFO:
	SET @CSTEP=50
	
	--SET @CTARGETDB=DB_NAME()+'_TEMP.DBO.'
	
	--DECLARE @CTARGETDB1 VARCHAR(50)
	--SET @CTARGETDB1=DB_NAME()+'_TEMP'
	--SET @CSTEP=55
	--IF DB_ID(@CTARGETDB1) IS NOT NULL
	--	SET @CTARGETDB=DB_NAME()+'_TEMP.DBO.'
	--ELSE
	--  BEGIN
	--  SET @CERRMSG='STEP- ' + LTRIM(STR(@CSTEP)) + ' ERROR TEMP DATABASE NOT EXISTS.'          
	--		GOTO END_PROC
	--  END	
	
	SELECT TOP 1 @BPURLOC=PUR_LOC,@BUPDPURINFO=UPD_PURINFO FROM LOCATION (NOLOCK) 
	WHERE DEPT_ID=@CREQLOCID
	
	---- POPULATE LIST OF TABLES 
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('SKU')
	
	IF (@BPURLOC=1 OR @BUPDPURINFO=1) AND 1=2
	BEGIN
		INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('FORM')
		INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('LM01106')
		INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('LMP01106')
		INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('HD01106')
		INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('AREA')
		INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('CITY')
		INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('STATE')
	END
	
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('ARTICLE')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('SECTIOND')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('SECTIONM')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('PARA1')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('PARA2')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('PARA3')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('PARA4')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('PARA5')
	INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('PARA6')
	--INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('SKU_OH')
	--INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('ART_ATTR')
	--INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('ATTRM')
	--INSERT @TXNSSENDINFO (ORG_TABLENAME) VALUES ('ATTR_KEY')
	
	SET @CSTEP=60

	IF CURSOR_STATUS('GLOBAL','CUR_SENDOPS') IN (0,1)
	BEGIN
		CLOSE CUR_SENDOPS
		DEALLOCATE CUR_SENDOPS
	END
	
	SET @CSTEP=70
	---- DROP THE TEMPORARY TABLES ALREADY EXISTING
	
	SET @CSTEP=100
	---- SEND THE OPS MEMO MASTER TABLE
	/*
	--CHANGING THIS STEP DUE TO PERFORMANCE ISSUE AT LAKSHITA ON 11 JAN 2019 REPORTED ON 5 JAN 2019
	SET @CTEMPSKUTABLE=@CTARGETDB+'[TMP_SKU_SKU_'+LTRIM(RTRIM(REPLACE(@CPRODUCTCODEPARA,'-','_')))+']'
	SET @DTSQL=N'SELECT  DISTINCT * '+(CASE WHEN @BCALLEDFROMSLS=1 THEN ','+STR(@NDISCPCT,6,2)+' AS DISCOUNT_PERCENTAGE' ELSE '' END)+
				' INTO '+@CTEMPSKUTABLE+' FROM SKU WHERE PRODUCT_CODE='''+@CPRODUCTCODEPARA+''''
	*/
	SET @DTSQL=N'SELECT DISTINCT * '+(CASE WHEN @BCALLEDFROMSLS=1 THEN ','+STR(@NDISCPCT,6,2)+' AS DISCOUNT_PERCENTAGE' ELSE '' END)
				+',''MSTSKU_SKU_UPLOAD'' AS TARGET_TABLENAME,@@SPID SP_ID'
				+' FROM SKU (NOLOCK) WHERE PRODUCT_CODE='''+@CPRODUCTCODEPARA+''''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	
	SET @CSTEP=190
	---- SEND THE ARTICLE RELATED TO GIVEN OPS MEMO
	/*
	--CHANGING THIS STEP DUE TO PERFORMANCE ISSUE AT LAKSHITA ON 11 JAN 2019 REPORTED ON 5 JAN 2019
	SET @CTEMPARTTABLE=@CTARGETDB+'[TMP_SKU_ARTICLE_'+LTRIM(RTRIM(REPLACE(@CPRODUCTCODEPARA,'-','_')))+']'
	SET @DTSQL=N'SELECT  DISTINCT ARTICLE.* INTO '+@CTEMPARTTABLE+' FROM ARTICLE
				 JOIN '+@CTEMPSKUTABLE+' SKU ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE'
	*/
	SELECT DISTINCT ARTICLE.*,'MSTSKU_ARTICLE_UPLOAD' TARGET_TABLENAME,@@SPID SP_ID 
	FROM ARTICLE (NOLOCK)
	JOIN SKU ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA
	
	
	SET @CSTEP=200
	---- SEND THE SECTIOND RELATED TO GIVEN OPS MEMO
	/*
	--CHANGING THIS STEP DUE TO PERFORMANCE ISSUE AT LAKSHITA ON 11 JAN 2019 REPORTED ON 5 JAN 2019
	SET @CTEMPSDTABLE=@CTARGETDB+'[TMP_SKU_SECTIOND_'+LTRIM(RTRIM(REPLACE(@CPRODUCTCODEPARA,'-','_')))+']'
	SET @DTSQL=N'SELECT  DISTINCT SECTIOND.* INTO '+@CTEMPSDTABLE+' FROM SECTIOND
				 JOIN '+@CTEMPARTTABLE+' ARTICLE ON ARTICLE.SUB_SECTION_CODE=SECTIOND.SUB_SECTION_CODE'
	*/
	SELECT DISTINCT SECTIOND.*,'MSTSKU_SECTIOND_UPLOAD' TARGET_TABLENAME,@@SPID SP_ID 
	FROM SECTIOND (NOLOCK)
	JOIN ARTICLE (NOLOCK) ON ARTICLE.SUB_SECTION_CODE=SECTIOND.SUB_SECTION_CODE
	JOIN SKU     (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA	
	
	
	SET @CSTEP=210
	---- SEND THE SECTIONM RELATED TO GIVEN OPS MEMO
	/*
	--CHANGING THIS STEP DUE TO PERFORMANCE ISSUE AT LAKSHITA ON 11 JAN 2019 REPORTED ON 5 JAN 2019
	SET @CTEMPTABLE=@CTARGETDB+'[TMP_SKU_SECTIONM_'+LTRIM(RTRIM(REPLACE(@CPRODUCTCODEPARA,'-','_')))+']'
	SET @DTSQL=N'SELECT  DISTINCT SECTIONM.* INTO '+@CTEMPTABLE+' FROM SECTIONM
				JOIN '+@CTEMPSDTABLE+' SECTIOND ON SECTIOND.SECTION_CODE=SECTIONM.SECTION_CODE'
	*/
	SELECT DISTINCT SECTIONM.*,'MSTSKU_SECTIONM_UPLOAD' TARGET_TABLENAME,@@SPID SP_ID
	FROM SECTIONM (NOLOCK)
	JOIN SECTIOND (NOLOCK) ON SECTIOND.SECTION_CODE=SECTIONM.SECTION_CODE
	JOIN ARTICLE (NOLOCK) ON ARTICLE.SUB_SECTION_CODE=SECTIOND.SUB_SECTION_CODE
	JOIN SKU     (NOLOCK) ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA	
	
	
	
	SET @CSTEP=220
	---- SEND THE PARA1 RELATED TO GIVEN OPS MEMO
	/*
	--CHANGING THIS STEP DUE TO PERFORMANCE ISSUE AT LAKSHITA ON 11 JAN 2019 REPORTED ON 5 JAN 2019
	SET @CTEMPTABLE=@CTARGETDB+'[TMP_SKU_PARA1_'+LTRIM(RTRIM(REPLACE(@CPRODUCTCODEPARA,'-','_')))+']'
	SET @DTSQL=N'SELECT  DISTINCT PARA1.* INTO '+@CTEMPTABLE+' FROM PARA1
				 JOIN '+@CTEMPSKUTABLE+' SKU ON SKU.PARA1_CODE=PARA1.PARA1_CODE'
	*/
	SELECT DISTINCT PARA1.*,'MSTSKU_PARA1_UPLOAD'TARGET_TABLENAME,@@SPID SP_ID
	FROM PARA1 (NOLOCK)
	JOIN SKU (NOLOCK) ON SKU.PARA1_CODE=PARA1.PARA1_CODE
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA

	
	SET @CSTEP=230
	---- SEND THE PARA2 RELATED TO GIVEN OPS MEMO
	/*
	--CHANGING THIS STEP DUE TO PERFORMANCE ISSUE AT LAKSHITA ON 11 JAN 2019 REPORTED ON 5 JAN 2019
	SET @CTEMPTABLE=@CTARGETDB+'[TMP_SKU_PARA2_'+LTRIM(RTRIM(REPLACE(@CPRODUCTCODEPARA,'-','_')))+']'
	SET @DTSQL=N'SELECT  DISTINCT PARA2.* INTO '+@CTEMPTABLE+' FROM PARA2
				 JOIN '+@CTEMPSKUTABLE+' SKU ON SKU.PARA2_CODE=PARA2.PARA2_CODE'
	*/
	SELECT  DISTINCT PARA2.*,'MSTSKU_PARA2_UPLOAD'TARGET_TABLENAME,@@SPID SP_ID
	FROM PARA2 (NOLOCK)
	JOIN SKU (NOLOCK) ON SKU.PARA2_CODE=PARA2.PARA2_CODE
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA
	


	SET @CSTEP=240
	---- SEND THE PARA3 RELATED TO GIVEN OPS MEMO
	/*
	--CHANGING THIS STEP DUE TO PERFORMANCE ISSUE AT LAKSHITA ON 11 JAN 2019 REPORTED ON 5 JAN 2019
	SET @CTEMPTABLE=@CTARGETDB+'[TMP_SKU_PARA3_'+LTRIM(RTRIM(REPLACE(@CPRODUCTCODEPARA,'-','_')))+']'
	SET @DTSQL=N'SELECT  DISTINCT PARA3.* INTO '+@CTEMPTABLE+' FROM PARA3
				 JOIN '+@CTEMPSKUTABLE+' SKU ON SKU.PARA3_CODE=PARA3.PARA3_CODE'
	*/
	SELECT DISTINCT PARA3.*,'MSTSKU_PARA3_UPLOAD'TARGET_TABLENAME,@@SPID SP_ID
	FROM PARA3 (NOLOCK)
	JOIN SKU (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA
	
	
	
	SET @CSTEP=250
	---- SEND THE PARA4 RELATED TO GIVEN OPS MEMO
	/*
	--CHANGING THIS STEP DUE TO PERFORMANCE ISSUE AT LAKSHITA ON 11 JAN 2019 REPORTED ON 5 JAN 2019
	SET @CTEMPTABLE=@CTARGETDB+'[TMP_SKU_PARA4_'+LTRIM(RTRIM(REPLACE(@CPRODUCTCODEPARA,'-','_')))+']'
	SET @DTSQL=N'SELECT  DISTINCT PARA4.* INTO '+@CTEMPTABLE+'  FROM PARA4
				 JOIN '+@CTEMPSKUTABLE+' SKU ON SKU.PARA4_CODE=PARA4.PARA4_CODE'
	*/
	SELECT  DISTINCT PARA4.*,'MSTSKU_PARA4_UPLOAD'TARGET_TABLENAME,@@SPID SP_ID
	FROM PARA4 (NOLOCK)
	JOIN SKU (NOLOCK) ON SKU.PARA4_CODE=PARA4.PARA4_CODE
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA
	


	SET @CSTEP=260
	---- SEND THE PARA5 RELATED TO GIVEN OPS MEMO
	/*
	--CHANGING THIS STEP DUE TO PERFORMANCE ISSUE AT LAKSHITA ON 11 JAN 2019 REPORTED ON 5 JAN 2019
	SET @CTEMPTABLE=@CTARGETDB+'[TMP_SKU_PARA5_'+LTRIM(RTRIM(REPLACE(@CPRODUCTCODEPARA,'-','_')))+']'
	SET @DTSQL=N'SELECT  DISTINCT PARA5.* INTO '+@CTEMPTABLE+' FROM PARA5
				 JOIN '+@CTEMPSKUTABLE+' SKU ON SKU.PARA5_CODE=PARA5.PARA5_CODE'
	*/
	SELECT  DISTINCT PARA5.*,'MSTSKU_PARA5_UPLOAD'TARGET_TABLENAME,@@SPID SP_ID
	FROM PARA5 (NOLOCK)
	JOIN SKU (NOLOCK) ON SKU.PARA5_CODE=PARA5.PARA5_CODE
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA
	
	
	
	SET @CSTEP=270
	---- SEND THE PARA6 RELATED TO GIVEN OPS MEMO
	/*
	--CHANGING THIS STEP DUE TO PERFORMANCE ISSUE AT LAKSHITA ON 11 JAN 2019 REPORTED ON 5 JAN 2019
	SET @CTEMPTABLE=@CTARGETDB+'[TMP_SKU_PARA6_'+LTRIM(RTRIM(REPLACE(@CPRODUCTCODEPARA,'-','_')))+']'
	SET @DTSQL=N'SELECT  DISTINCT PARA6.* INTO '+@CTEMPTABLE+' FROM PARA6
				 JOIN '+@CTEMPSKUTABLE+' SKU ON SKU.PARA6_CODE=PARA6.PARA6_CODE'
	*/
	SELECT  DISTINCT PARA6.*,'MSTSKU_PARA6_UPLOAD'TARGET_TABLENAME,@@SPID SP_ID
	FROM PARA6 (NOLOCK)
	JOIN SKU (NOLOCK) ON SKU.PARA6_CODE=PARA6.PARA6_CODE
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA
	
	SET @CSTEP=280
	
	select hsn_code  into #tmphsn FROM SKU (NOLOCK)
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA Union
	select article.hsn_code FROM ARTICLE (NOLOCK)
	JOIN SKU ON SKU.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
	WHERE PRODUCT_CODE=@CPRODUCTCODEPARA
	
	SET @CSTEP=290
	SELECT  DISTINCT HSN_MST.*,'MSTSKU_HSN_MST_UPLOAD'TARGET_TABLENAME,@@SPID SP_ID
	FROM HSN_MST  (NOLOCK)
	JOIN #TMPHSN B ON B.HSN_CODE =HSN_MST .HSN_CODE 
	
	SET @CSTEP=300
	
	SELECT  DISTINCT HSN_DET.*,'MSTSKU_HSN_DET_UPLOAD'TARGET_TABLENAME,@@SPID SP_ID
	FROM HSN_DET  (NOLOCK)
	JOIN #TMPHSN B ON B.HSN_CODE =HSN_DET .HSN_CODE 
	
	
	GOTO END_PROC
LBLACK:
	GOTO END_PROC
END TRY

BEGIN CATCH
	SET @CERRMSG='P: SP_SEND_MIRROR_SKU_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 		

END_PROC:
	SELECT ISNULL(@CERRMSG,'') AS ERRMSG
END
---END OF PROCEDURE - SP_SEND_MIRROR_SKU_DATA
