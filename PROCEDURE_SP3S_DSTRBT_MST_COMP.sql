CREATE PROCEDURE SP3S_DSTRBT_MST_COMP
(
	 @CXN_TYPE VARCHAR(5)
	,@CXN_ID VARCHAR(22)	
)
AS
BEGIN
		DECLARE @NDISCOUNT_PERCENTAGE NUMERIC(10,2),@NOTHER_CHARGE NUMERIC(10,2)
			   ,@NMST_DISCOUNT NUMERIC(10,2),@NDET_DISCOUNT NUMERIC(10,2),@NDET_OTHER_CHARGES NUMERIC(10,2)
			   ,@CROW_ID VARCHAR(50),@NOTHER_CHARGE_PCT NUMERIC(10,2)
		IF @CXN_TYPE='WOD'
		BEGIN
				--GETTING THE DISCOUNT AND OTHER CHARGES IN MASTER
				SELECT @NDISCOUNT_PERCENTAGE=ISNULL(DISCOUNT_PERCENTAGE,0),@NMST_DISCOUNT=ISNULL(DISCOUNT_AMOUNT,0)
					  ,@NOTHER_CHARGE=ISNULL(OTHER_CHARGES,0),@NOTHER_CHARGE_PCT=((ISNULL(OTHER_CHARGES,0)/(ISNULL(SUBTOTAL,0)-ISNULL(DISCOUNT_AMOUNT,0)))*100) 
				FROM WSL_ORDER_MST 
				WHERE ORDER_ID=@CXN_ID
				
				SELECT TOP 1 @CROW_ID=ROW_ID FROM WSL_ORDER_DET WHERE ORDER_ID=@CXN_ID	  
				
				--DISTRIBUTING MASTER DISCOUNT TO DETAILS 
				UPDATE WSL_ORDER_DET 
					SET ORD_MST_DISCOUNT_AMOUNT=(ISNULL(WS_PRICE,0)*@NDISCOUNT_PERCENTAGE/100)*ISNULL(QUANTITY,0)
				WHERE ORDER_ID=@CXN_ID
				
				SELECT @NDET_DISCOUNT=SUM(ISNULL(ORD_MST_DISCOUNT_AMOUNT,0))
				FROM WSL_ORDER_DET WHERE ORDER_ID=@CXN_ID
				
				---UPDATING ANY DIFFERENCE BETWEEN THE TWO ROWS
				IF @NMST_DISCOUNT<>@NDET_DISCOUNT
					UPDATE WSL_ORDER_DET SET ORD_MST_DISCOUNT_AMOUNT=ORD_MST_DISCOUNT_AMOUNT+(@NMST_DISCOUNT-@NDET_DISCOUNT)
					WHERE ROW_ID=@CROW_ID
				
				UPDATE WSL_ORDER_DET 
					SET MST_OTHER_CHARGES=((WS_PRICE-(ORD_MST_DISCOUNT_AMOUNT/QUANTITY))*@NOTHER_CHARGE_PCT/100)*QUANTITY
				WHERE ORDER_ID=@CXN_ID	
				
				SELECT @NDET_OTHER_CHARGES=SUM(MST_OTHER_CHARGES)
				FROM WSL_ORDER_DET WHERE ORDER_ID=@CXN_ID

				IF @NOTHER_CHARGE<>@NDET_OTHER_CHARGES
					UPDATE WSL_ORDER_DET SET MST_OTHER_CHARGES=MST_OTHER_CHARGES+(@NOTHER_CHARGE-@NDET_OTHER_CHARGES)
					WHERE ROW_ID=@CROW_ID						  	
		END
END
--END OF PROCEDURE - SP3S_DSTRBT_MST_COMP
