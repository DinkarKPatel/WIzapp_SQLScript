CREATE PROCEDURE SP3S_EOSS_SCHEMES_2
(
	@CSCHEMEDETROWID VARCHAR(50),
	@CSLSTITLE VARCHAR(1000),
	@CROUNDITEMLEVEL VARCHAR(5),
	@CJOINSTRBUY VARCHAR(MAX),
	@CJOINSTRGET VARCHAR(MAX),
	@CPICKSLRDISCMODE VARCHAR(5),
	@NSPID VARCHAR(40),
	@CERRMSG	VARCHAR(MAX) OUTPUT
)
AS 
BEGIN
	
	PRINT 'ENTER POWER SCHEME QTY BASED'
	DECLARE @NBUYQTY NUMERIC(5,0),@CPRODUCTCODE VARCHAR(50),@NMRP NUMERIC(10,2),@NQTY NUMERIC(10,2),
			@BMAXQTYSET BIT,@NREQBUYQTY NUMERIC(5,0),@CCMDROWID VARCHAR(50),@NLOOPCNT INT,@NMODE INT,
			@BQUALIFIED BIT,@CROWID VARCHAR(100),@NSTEP VARCHAR(15),@NAMT NUMERIC(10,2),
			@CMRPORDER VARCHAR(10),@NREQBUYAMT NUMERIC(10,2),@BRETRY2NDCASE BIT,
			@CCMD NVARCHAR(MAX),@NDISCMODE INT,@NDISCFIGURE NUMERIC(7,3),
			@NAPPLIEDQTY NUMERIC(5,0),@BSCHEMEFOUND BIT,@CBUYFILTER VARCHAR(MAX),
			@CADDFILTER VARCHAR(MAX),@NFILTERMODE INT,@NAPPLICABLEQTY NUMERIC(5,0),
			@BPROCESSSLRENTRY BIT,@NDISCAMTAPPLYMODE INT,@NTOTALMRPVAL NUMERIC(10,2),@NDISCAPPLIED NUMERIC(10,2),
			@NCURPENDINGCNT NUMERIC(3,0),@NPREVPENDINGCNT NUMERIC(3,0),@BCUTSIZESCHEME BIT
	

	SET @NSTEP='137.1'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1

	SELECT @BPROCESSSLRENTRY=0,@NCURPENDINGCNT=0,@NPREVPENDINGCNT=0	
	DECLARE @CENABLEOPTIMIZEDSCHEMES VARCHAR(2)
	SELECT TOP 1 @CENABLEOPTIMIZEDSCHEMES=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_OPTIMIZED_EOSS_SCHEMES'		
	
	SET @CENABLEOPTIMIZEDSCHEMES=ISNULL(@CENABLEOPTIMIZEDSCHEMES,'')
	
START_PROC:
	SELECT @NBUYQTY=0,@CPRODUCTCODE='',@NMRP=0,@NQTY=0,@BMAXQTYSET=0,@NREQBUYQTY=0,
		   @CCMDROWID='',@NLOOPCNT=0,@NMODE=0,@BQUALIFIED=0,@CROWID='',@NSTEP=0,@NAMT=0,
		   @CMRPORDER='',@NREQBUYAMT=0,@BRETRY2NDCASE=0,@CCMD='',@NDISCMODE=0,
		   @NDISCFIGURE=0,@NAPPLIEDQTY=0,@BSCHEMEFOUND=0,@CBUYFILTER='',
		   @CADDFILTER='',@NFILTERMODE=0


	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMD WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0)
		GOTO END_PROC

	IF @BPROCESSSLRENTRY=1
		SET @CADDFILTER='A.QUANTITY<0'
	ELSE
		SET @CADDFILTER='A.QUANTITY>0'	
		
	SET @NSTEP='137.3'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1		
	IF CURSOR_STATUS('GLOBAL','SCHEMECUR') IN (0,1)
	BEGIN
		CLOSE SCHEMECUR
		DEALLOCATE SCHEMECUR
	END


BEGIN TRY        
	
	SET @NSTEP='137.5'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
		
	SELECT @CMRPORDER='',@BQUALIFIED=0,@BRETRY2NDCASE=0
		
	IF OBJECT_ID('TEMPDB..#TMPCMDPPDISC','U') IS NOT NULL
		DROP TABLE #TMPCMDPPDISC

			
	SET @NSTEP='137.6'

	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
	
	IF OBJECT_ID('TEMPDB..#TMPCMDPPDISC','U') IS NULL
		SELECT CMD_ROW_ID AS ROW_ID,CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT
		INTO #TMPCMDPPDISC FROM #TMPCMD WHERE 1=2 
	ELSE
		TRUNCATE TABLE #TMPCMDPPDISC
	
	IF OBJECT_ID('TEMPDB..#TMPCMDSCHEMES','U') IS NULL
		SELECT PRODUCT_CODE,MRP,QUANTITY,CMD_ROW_ID AS ROW_ID,CONVERT(NUMERIC(10,2),0) AS DISCOUNT_AMOUNT,
		QUANTITY AS SCHEME_APPLIED_QTY,CMD_ROW_ID
		INTO #TMPCMDSCHEMES FROM #TMPCMD WHERE 1=2
	ELSE
		TRUNCATE TABLE #TMPCMDSCHEMES
	
	SELECT @CBUYFILTER=(CASE WHEN FILTER_MODE IN (0,1) AND @CENABLEOPTIMIZEDSCHEMES<>'1' THEN  BUY_FILTER_CRITERIA ELSE '' END),
		   @NFILTERMODE=FILTER_MODE,@NDISCMODE=DISC_METHOD,@NDISCAMTAPPLYMODE=DISCOUNT_AMOUNT_APPLICABLE_MODE,
		   @BCUTSIZESCHEME=ISNULL(CUT_SIZE_SCHEME,0)
		   FROM SCHEME_SETUP_DET WHERE ROW_ID=@CSCHEMEDETROWID
		   	

	---- Need to Validate the Proper scheme tables data lying in case of Para combination setup
	---- This issue is coming frequently at Donear Pos (Date : 03-02-2023 -- Sanjay)
	IF @NFILTERMODE=6
	BEGIN
		EXEC SP3S_VALIDATE_EOSSDATA
		@cSchdetRowId=@CSCHEMEDETROWID,
		@cErrormsg=@CERRMSG OUTPUT

		IF ISNULL(@CERRMSG,'')<>''
			GOTO END_PROC
	END

	IF @NFILTERMODE NOT IN (0,1)
		SELECT @CADDFILTER=@CADDFILTER+' AND SLSDET.ROW_ID='''+@CSCHEMEDETROWID+''''
	ELSE
		SELECT @CADDFILTER=@CADDFILTER+' AND 1=1'
	
	DECLARE @NCMDCNT NUMERIC(5,0),@NITVCNT NUMERIC(5,0),@CSTR VARCHAR(15)
	SELECT @NCMDCNT=COUNT(PRODUCT_CODE) FROM #TMPCMD
	SELECT @NITVCNT=COUNT(PRODUCT_CODE) FROM #CMDITV

	SET @CSTR=LTRIM(RTRIM(STR(@NCMDCNT)))+'-'+LTRIM(RTRIM(STR(@NITVCNT)))
		SET @NSTEP='137.7'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,@CSTR,1
	IF @BCUTSIZESCHEME=1
		SELECT @CADDFILTER=@CADDFILTER+' AND A.CUT_SIZE=1'

	SELECT @CBUYFILTER=(CASE WHEN ISNULL(@CBUYFILTER,'')='' THEN '1=1' ELSE @CBUYFILTER END)
	

	--IF @@SPID=704
	--	SELECT @CJOINSTRBUY,@CJOINSTRGET

	PRINT 'CHECK FILTERED  DATA FOR P:OWER PRICING QTY SCHEME:'+@CSLSTITLE
	SET @CCMD=N' SELECT A.PRODUCT_CODE,A.MRP,(ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY)*(CASE WHEN A.QUANTITY<0 THEN -1 ELSE 1 END),
				 CONVERT(VARCHAR(40),NEWID()) AS ROW_ID,0 AS DISCOUNT_AMOUNT,
				 0 AS SCHEME_APPLIED_QTY,A.CMD_ROW_ID	
				 FROM #TMPCMD A
				 JOIN #CMDITV ITV ON ITV.PRODUCT_CODE=A.PRODUCT_CODE '+@CJOINSTRBUY+'
				 WHERE ABS(A.QUANTITY)-A.SCHEME_APPLIED_QTY>0 AND 
				 ((A.DISCOUNT_PERCENTAGE=0 AND ISNULL(A.SCHEME_SETUP_DET_ROW_ID,'''')='''') OR ABS(A.QUANTITY)>1)
				  AND '+@CBUYFILTER+' AND '+@CADDFILTER
		PRINT @CCMD

	----- DATE :20-12-2018 HAD TO TAKE A.SCHEME_SETUP_DET_ROW_ID='' MARK BECAUSE PROBLEM STARTED COMING AT SUVIDHA IN WHICH CASE THEY HAD CREATED A ZERO PERCENT TITLE
	----- WHICH WAS BEING CONSIDERED IN BUY N GET N SCHEME						   
						 
	INSERT #TMPCMDSCHEMES (PRODUCT_CODE,MRP,QUANTITY,ROW_ID,DISCOUNT_AMOUNT,SCHEME_APPLIED_QTY,CMD_ROW_ID)
	EXEC SP_EXECUTESQL @CCMD
	
		SET @NSTEP='137.10'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
	
	IF NOT EXISTS (SELECT TOP 1 * FROM #TMPCMDSCHEMES)
	BEGIN
		IF @BPROCESSSLRENTRY=0 AND @CPICKSLRDISCMODE<>'3'
		BEGIN
			SET @BPROCESSSLRENTRY=1
			GOTO START_PROC
		END	
		ELSE
			GOTO END_PROC
	END	
		
	SET @NSTEP='137.12'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
	
	SELECT @NBUYQTY=SUM(ABS(QUANTITY)) FROM #TMPCMDSCHEMES
	
	SELECT @BQUALIFIED=0,@BSCHEMEFOUND=0,@NDISCFIGURE=0



	SELECT TOP 1 @NDISCFIGURE=DISCOUNT_FIGURE FROM SCHEME_SETUP_SCH0002_1 
	WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID AND @NBUYQTY BETWEEN 
	FROM_QTY AND TO_QTY
		
	IF ISNULL(@NDISCFIGURE,0)<>0
	BEGIN
		SELECT @BSCHEMEFOUND=1
		SET @NAPPLICABLEQTY=@NBUYQTY
	END	
	
		SET @NSTEP='137.14'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
	IF @BSCHEMEFOUND=0
	BEGIN
		SELECT TOP 1 @NDISCFIGURE=DISCOUNT_FIGURE,@NAPPLICABLEQTY=TO_QTY FROM SCHEME_SETUP_SCH0002_1 
		WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID AND TO_QTY<=@NBUYQTY
		ORDER BY TO_QTY DESC
		
		IF ISNULL(@NDISCFIGURE,0)<>0
			SELECT @BSCHEMEFOUND=1		

	END
	
		SET @NSTEP='137.16'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
	IF @BSCHEMEFOUND=0
		GOTO EXIT_PROC
	
	
	IF @BPROCESSSLRENTRY=1
	BEGIN
		DECLARE @CPICKMAXDISCSLR VARCHAR(2)
		
		SELECT TOP 1 @CPICKMAXDISCSLR=VALUE FROM CONFIG (NOLOCK) WHERE 
		CONFIG_OPTION='PICK_MAXDISCOUNT_POWERPRICING_SLR' 
		
		SET @CPICKMAXDISCSLR=ISNULL(@CPICKMAXDISCSLR,'')
		
		IF @CPICKMAXDISCSLR='1'
		BEGIN	
			SELECT TOP 1 @NDISCFIGURE=DISCOUNT_FIGURE,@NAPPLICABLEQTY=ABS(@NBUYQTY) FROM SCHEME_SETUP_SCH0002_1 
			WHERE SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID ORDER BY TO_QTY DESC

			IF ISNULL(@NDISCFIGURE,0)<>0
				SELECT @BMAXQTYSET=1
		END	
	END	
	
		SET @NSTEP='137.18'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
	


	SET @NAPPLIEDQTY=0
	DECLARE SCHEMECUR CURSOR FOR SELECT PRODUCT_CODE,MRP,QUANTITY,ROW_ID FROM #TMPCMDSCHEMES 
	
	OPEN SCHEMECUR
	FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID
	
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @NSTEP='137.20'
		EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1

		SET @NLOOPCNT=1
		WHILE @NLOOPCNT<=ABS(@NQTY)
		BEGIN
			SET @NAPPLIEDQTY=@NAPPLIEDQTY+1
			
			IF @NDISCMODE=1
			BEGIN
				INSERT #TMPCMDPPDISC
				SELECT @CCMDROWID,(CASE WHEN @CROUNDITEMLEVEL='1' THEN
				ROUND(@NMRP*@NDISCFIGURE/100,0) ELSE @NMRP*@NDISCFIGURE/100 END)
 			END	
			ELSE
			IF @NDISCMODE=3
			BEGIN
				IF @NDISCAMTAPPLYMODE<>2
					INSERT #TMPCMDPPDISC
					SELECT @CCMDROWID,(CASE WHEN @NMRP-@NDISCFIGURE>=0 THEN @NDISCFIGURE ELSE @NMRP END)
				ELSE
				BEGIN
					INSERT #TMPCMDPPDISC
					SELECT @CCMDROWID,@NMRP
				END	
			END				 			
			ELSE
			BEGIN
				INSERT #TMPCMDPPDISC
				SELECT @CCMDROWID,(CASE WHEN @NMRP-@NDISCFIGURE>=0 THEN @NMRP-@NDISCFIGURE ELSE 0 END)
			END				
					    
			IF @NAPPLIEDQTY=@NAPPLICABLEQTY
			BEGIN
				SET @BQUALIFIED=1
				BREAK
		    END
		    
		    SET @NLOOPCNT=@NLOOPCNT+1
		END										

		IF @NAPPLIEDQTY=@NAPPLICABLEQTY
			BREAK
		
		FETCH NEXT FROM SCHEMECUR INTO @CPRODUCTCODE,@NMRP,@NQTY,@CCMDROWID
	END
	
	SET @NSTEP='137.22'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
	
	CLOSE SCHEMECUR
	DEALLOCATE SCHEMECUR
	
	
						
	IF NOT (@NDISCAMTAPPLYMODE=2 AND @NDISCMODE=3) AND @NDISCMODE<>4
	BEGIN
		SET @NSTEP='137.24'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
		UPDATE A SET DISCOUNT_AMOUNT=A.DISCOUNT_AMOUNT+ABS(B.DISCOUNT_AMOUNT)*(CASE WHEN @BPROCESSSLRENTRY=1 THEN -1 ELSE 1 END),
					 SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+ABS(B.QTY)
		FROM #TMPCMDSCHEMES A
		JOIN 
		(SELECT ROW_ID,SUM(DISCOUNT_AMOUNT) AS DISCOUNT_AMOUNT,COUNT(*) AS QTY FROM  #TMPCMDPPDISC
		 GROUP BY ROW_ID) B ON B.ROW_ID=A.ROW_ID
	END
	ELSE
	BEGIN

		IF @NDISCMODE=4 ---- NET PRICE OF THE BUNDLE
		BEGIN
			SET @NSTEP='137.27'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
			SELECT @NTOTALMRPVAL=SUM(B.MRP) FROM #TMPCMDPPDISC A
			JOIN #TMPCMDSCHEMES B ON A.ROW_ID=B.ROW_ID
			
			IF @NDISCFIGURE>ABS(@NTOTALMRPVAL)
				SET @NDISCFIGURE=@NTOTALMRPVAL
			
						

			
			UPDATE A SET DISCOUNT_AMOUNT=A.DISCOUNT_AMOUNT+((MRP*QUANTITY)-((@NDISCFIGURE/@NTOTALMRPVAL)*MRP*QUANTITY))*
			(CASE WHEN @BPROCESSSLRENTRY=1 THEN -1 ELSE 1 END),
						 SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+ABS(B.QTY)
			FROM #TMPCMDSCHEMES A
			JOIN 
			(SELECT ROW_ID,COUNT(*) AS QTY FROM  #TMPCMDPPDISC
			 GROUP BY ROW_ID) B ON B.ROW_ID=A.ROW_ID
		END	
		ELSE			
		BEGIN
			SET @NSTEP='137.29'
			EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
			SELECT @NTOTALMRPVAL=SUM(DISCOUNT_AMOUNT) FROM #TMPCMDPPDISC 

		
			UPDATE A SET DISCOUNT_AMOUNT=A.DISCOUNT_AMOUNT+ABS((@NDISCFIGURE/@NTOTALMRPVAL)*MRP*QUANTITY)*
			(CASE WHEN @BPROCESSSLRENTRY=1 THEN -1 ELSE 1 END),
						 SCHEME_APPLIED_QTY=SCHEME_APPLIED_QTY+ABS(B.QTY)
			FROM #TMPCMDSCHEMES A
			JOIN 
			(SELECT ROW_ID,COUNT(*) AS QTY FROM  #TMPCMDPPDISC
			 GROUP BY ROW_ID) B ON B.ROW_ID=A.ROW_ID
			 	SET @NSTEP='137.31'
			EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1

			SELECT @NDISCAPPLIED=SUM(DISCOUNT_AMOUNT) FROM #TMPCMDSCHEMES
			
			IF @NDISCAPPLIED<>@NDISCFIGURE
			BEGIN
				SELECT TOP 1 @CCMDROWID=A.ROW_ID FROM #TMPCMDSCHEMES A JOIN #TMPCMDPPDISC B ON A.ROW_ID=B.ROW_ID
				 
				UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=DISCOUNT_AMOUNT+(@NDISCFIGURE-@NDISCAPPLIED)
				WHERE ROW_ID=@CCMDROWID
			END				 
		END		

		 		
		
		--SELECT @BQUALIFIED,@NAPPLIEDQTY,@NREQBUYQTY, 'AFTER APPLYING SCH002',* FROM  #TMPCMDSCHEMES
	END	
	
	GOTO EXIT_PROC
END TRY

BEGIN CATCH
	  PRINT 'CATCH START'       
	  SET @CERRMSG='P:SP3S_EOSS_SCHEMES_2, STEP:'+LTRIM(RTRIM(@NSTEP))+', MESSAGE:'+ERROR_MESSAGE()        
	  GOTO END_PROC
END CATCH

EXIT_PROC:
	SET @NSTEP='137.33'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1		
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
		IF @BQUALIFIED=0
		BEGIN
			
			UPDATE #TMPCMDSCHEMES SET DISCOUNT_AMOUNT=0
		END	
		ELSE
		BEGIN
				SET @NSTEP='137.35'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
			UPDATE #TMPCMD SET DISCOUNT_AMOUNT=#TMPCMD.DISCOUNT_AMOUNT+B.DISCOUNT_AMOUNT,
			SLS_TITLE=@CSLSTITLE,
			SCHEME_SETUP_DET_ROW_ID=@CSCHEMEDETROWID,
			SCHEME_APPLIED_QTY=#TMPCMD.SCHEME_APPLIED_QTY+B.SCHEME_APPLIED_QTY,
			DISCOUNT_PERCENTAGE=(CASE WHEN @nDiscmode=1 and isnull(#TMPCMD.SCHEME_APPLIED_QTY,0)=0 THEN @NDISCFIGURE
			ELSE discount_percentage END)
			FROM #TMPCMDSCHEMES B WHERE B.CMD_ROW_ID=#TMPCMD.CMD_ROW_ID  AND B.PRODUCT_CODE=#TMPCMD.PRODUCT_CODE
			AND B.SCHEME_APPLIED_QTY<>0
			
			UPDATE #TMPCMD SET DISCOUNT_PERCENTAGE=ABS(ROUND((DISCOUNT_AMOUNT/(MRP*QUANTITY))*100,3))
			WHERE (@NDISCMODE<>1 OR ISNULL(discount_percentage,0)=0)
	

			----Need to recalculate this again because of Discount amount validation being failed 
			---- on Final save
			UPDATE  #TMPCMD SET DISCOUNT_AMOUNT=round(mrp*quantity*DISCOUNT_PERCENTAGE/100,2)

			UPDATE  #TMPCMD SET NET=(MRP*QUANTITY)-DISCOUNT_AMOUNT

			IF EXISTS (SELECT TOP 1 * FROM #TMPCMD WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0)
				GOTO START_PROC

		END		

		
		IF @BPROCESSSLRENTRY=0 AND @CPICKSLRDISCMODE<>'3'
		BEGIN
			SET @BPROCESSSLRENTRY=1
			GOTO START_PROC
		END	
		ELSE
			GOTO END_PROC

	END	
	ELSE
		GOTO END_PROC
	
		SET @NSTEP='137.37'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
	IF EXISTS (SELECT TOP 1 * FROM #TMPCMD WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0)
	BEGIN
		IF @NPREVPENDINGCNT<>0
		BEGIN
			SELECT @NCURPENDINGCNT=SUM(ABS(QUANTITY)-SCHEME_APPLIED_QTY) FROM #TMPCMD
			WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0
		END
		ELSE
			SELECT @NPREVPENDINGCNT=SUM(ABS(QUANTITY)-SCHEME_APPLIED_QTY) FROM #TMPCMD
			WHERE ABS(QUANTITY)-SCHEME_APPLIED_QTY>0
		
		IF @NPREVPENDINGCNT<>@NCURPENDINGCNT	
			GOTO START_PROC
	END
	
END_PROC:
	


		SET @NSTEP='137.40'
	EXEC SP_CHKXNSAVELOG 'SCH_GETDISC',@NSTEP,0,@NSPID,'',1
	--SELECT * INTO TMPCMD FROM #TMPCMD	
END
---- 'END OF CREATING PROCEDURE SP3S_EOSS_SCHEMES_2'
