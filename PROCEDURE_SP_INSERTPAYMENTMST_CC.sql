CREATE PROC SP_INSERTPAYMENTMST_CC
(
 @CCARDNAME VARCHAR(100),
 @CLOCID VARCHAR(4)
)
AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 
DECLARE @CCODE VARCHAR(7),@CERRORMSG VARCHAR(MAX),@MEMO_ID  VARCHAR(20),
        @CMASTERTABLENAME VARCHAR(100), @CMEMONO VARCHAR(10), @NMEMONOLEN INT , @CMEMONOPREFIX VARCHAR(2), 
		@CMEMONOVAL VARCHAR(10),@CCURLOCID VARCHAR(4),@CHOLOCID VARCHAR(4),@CSEARCHCARDCODE CHAR(7)  
		


  BEGIN TRANSACTION
  
  BEGIN TRY
  
  SET @CERRORMSG=''
  SET @CMASTERTABLENAME='PAYMODE_MST'
  SET @CMEMONO='PAYMODE_CODE'
  SET @NMEMONOLEN=7
  
  
  
  --SELECT TOP 1 @CCURLOCID=DEPT_ID FROM NEW_APP_LOGIN_INFO (nolock) WHERE SPID=@@SPID
  SELECT TOP 1 @CHOLOCID=VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'


  SET @CCURLOCID= @CLOCID

  
  SET @CMEMONOPREFIX=@CCURLOCID

  	IF ISNULL(@CCURLOCID,'')=''
	 BEGIN
		SET @CERRORMSG =''  
		GOTO END_PROC    
	 END
  
  SET @MEMO_ID=''
  SET @CMASTERTABLENAME=''
  SELECT @CSEARCHCARDCODE=PAYMODE_CODE  FROM PAYMODE_MST WHERE PAYMODE_NAME=@CCARDNAME

  IF ISNULL(@CSEARCHCARDCODE,'')=''
  BEGIN
	SET @CCARDNAME=REPLACE(@CCARDNAME,'"','')
	SELECT @CSEARCHCARDCODE=PAYMODE_CODE  FROM PAYMODE_MST WHERE PAYMODE_NAME=@CCARDNAME
  END
  
  IF ISNULL(@CSEARCHCARDCODE,'')<>''
  BEGIN
      SET @CERRORMSG=''
      GOTO END_PROC
  END
  ELSE
  IF @CCURLOCID<>@CHOLOCID
  BEGIN
      --SET @CERRORMSG='CARD NAME :'+@CCARDNAME+' NOT FOUND IN MASTERS....PLEASE CONTACT HEAD OFFICE'
	  SET @CERRORMSG=''
      GOTO END_PROC
  END
     
   GENKEY:
   EXEC GETNEXTKEY @CMASTERTABLENAME, @CMEMONO, @NMEMONOLEN, @CMEMONOPREFIX, 1,
									'',0, @CMEMONOVAL OUTPUT  
									
	PRINT @CMEMONOVAL
	SET @MEMO_ID=@CMEMONOVAL
	
	IF EXISTS (SELECT TOP 1 'U' FROM PAYMODE_MST WHERE PAYMODE_CODE =@MEMO_ID)	
		GOTO GENKEY	
	
	IF ISNULL(@MEMO_ID,'')=''
    BEGIN
      SET @CERRORMSG='ERROR CREATING NEXT MEMO NO....'
      GOTO END_PROC
    END
				 

	INSERT PAYMODE_MST( PAYMODE_CODE, PAYMODE_NAME, PAYMODE_GRP_CODE, CREDIT_LIMIT, 
	COMMISSION_PERCENTAGE, LAST_UPDATE, SERVICE_TAX_PERCENTAGE, INACTIVE, 
	CURRENCY_CONVERSION_RATE, COMMISSION_PERCENTAGE_PAYABLE, COMMISSION_AC_CODE, AC_CODE )  
	SELECT  @CMEMONOVAL AS PAYMODE_CODE, @CCARDNAME AS PAYMODE_NAME, '0000002' AS PAYMODE_GRP_CODE, 
	0 AS CREDIT_LIMIT, 0 AS COMMISSION_PERCENTAGE, 
	GETDATE() AS LAST_UPDATE, 0 AS SERVICE_TAX_PERCENTAGE, 0 AS INACTIVE,  1 AS CURRENCY_CONVERSION_RATE, 
	0 AS COMMISSION_PERCENTAGE_PAYABLE,'0000000000' AS COMMISSION_AC_CODE,'0000000000' AS  AC_CODE 
	
	SET @CSEARCHCARDCODE=@CMEMONOVAL
	
  END TRY
  BEGIN CATCH
  SET @CERRORMSG =  ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
	GOTO END_PROC
  END CATCH
	
END_PROC:

   IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')='' 
		BEGIN
			COMMIT TRANSACTION
			PRINT 'COMMIT TRANSACTION'
		END	
			
		ELSE
		ROLLBACK
	END
	
	SELECT @CERRORMSG AS ERRMSG,@CSEARCHCARDCODE AS MEMO_ID
END
------- 'END OF CREATING PROCEDURE SP_INSERTPAYMENTMST_CC'
