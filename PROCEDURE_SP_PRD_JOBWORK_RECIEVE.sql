CREATE PROC [DBO].SP_PRD_JOBWORK_RECIEVE                      
@NQUERYID INT,                      
@CWHERE NVARCHAR(4000)='',        
@NMODE INT=0,
@BWIP BIT=0
--WITH ENCRYPTION
             
AS                      
BEGIN                      
IF @NQUERYID=1                      
 GOTO LBLMST          
                     
ELSE IF @NQUERYID=2                      
 GOTO LBLDET              
                 
ELSE IF @NQUERYID=3                      
 GOTO LBLISSUE            
                    
ELSE IF @NQUERYID=4                      
 GOTO LBLDREC            
                   
ELSE IF @NQUERYID=5                      
 GOTO LBLALLDATACOL            
                   
ELSE IF @NQUERYID=6                      
 GOTO LBLLOOKUP           
                    
ELSE IF @NQUERYID=7            
 GOTO LBLCANCELCHECK          
ELSE                      
 GOTO LAST                
      DECLARE @CCMD NVARCHAR(MAX)         
                  
LBLMST:    
                  
   SELECT A.*,B.AGENCY_NAME,U.USERNAME AS USER_NAME,BIN.BIN_NAME,  
   U1.USERNAME AS EDT_USER_NAME FROM PRD_JOBWORK_RECEIPT_MST A (NOLOCK)                   
   JOIN PRD_AGENCY_MST B (NOLOCK) ON A.AGENCY_CODE = B.AGENCY_CODE   
   LEFT OUTER JOIN USERS U (NOLOCK) ON U.USER_CODE = A.USER_CODE     
   LEFT OUTER  JOIN USERS U1 (NOLOCK) ON U1.USER_CODE = A.EDT_USER_CODE     
   LEFT OUTER JOIN BIN (NOLOCK) ON BIN.BIN_ID=A.BIN_ID                     
   WHERE A.RECEIPT_ID=@CWHERE                      
   GOTO LAST                      
           
LBLDET:                      
	SELECT (CAST(1 AS BIT)) AS CHKDELIVER , B.*,      
	B.QUANTITY+ISNULL(B.SHRINK_QTY,0) AS RECEIVE_QUNATITY,       
	CONVERT(NUMERIC(10,2), 0) AS BALANCE_QUANTITY,       
	CONVERT(NUMERIC(10,2),0) AS PENDING_QUANTITY,      
	M.QUANTITY AS ISSUE_QUANTITY,   
	B.ROW_ID AS TMP_ROW_ID,     
	(B.QUANTITY * B.JOB_RATE) AS AMOUNT, ART.ARTICLE_NO, ART.ARTICLE_NAME,         
	PARA1_NAME,PARA2_NAME,PARA3_NAME,UOM_NAME, CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,    
	SKU.PURCHASE_PRICE,SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,             
	PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],          
	ISNULL(ART.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(P3.DT_CREATED,'') AS [PARA3_DT_CREATED],    
	ISNULL(SKU.DT_CREATED,'') AS [SKU_DT_CREATED],          
	ART.STOCK_NA,F.JOB_NAME, A.RECEIPT_NO ,    
	O.ISSUE_NO,ART.ALIAS AS ARTICLE_ALIAS,BI.BIN_NAME,A.REMARKS ,M.REMARKS AS [ISSUE_REMARKS]  ,
	B.SHRINK_QTY,
    B.QUANTITY AS NET_REC  
	FROM PRD_JOBWORK_RECEIPT_MST A (NOLOCK)                         
	JOIN PRD_JOBWORK_RECEIPT_DET B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID                       
	JOIN PRD_JOBWORK_ISSUE_DET M (NOLOCK) ON M.ROW_ID = B.REF_ROW_ID        
	JOIN PRD_JOBWORK_ISSUE_MST O (NOLOCK) ON O.ISSUE_ID = M.ISSUE_ID                
	JOIN PRD_SKU SKU(NOLOCK) ON SKU.PRODUCT_UID=B.PRODUCT_UID        
	JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE            
	JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE          
	JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE          
	JOIN PARA1 P1  (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE            
	JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE            
	JOIN PARA3 P3  (NOLOCK)ON SKU.PARA3_CODE = P3.PARA3_CODE            
	JOIN PARA4 P4 (NOLOCK) ON SKU.PARA4_CODE = P4.PARA4_CODE            
	JOIN PARA5 P5 (NOLOCK) ON SKU.PARA5_CODE = P5.PARA5_CODE            
	JOIN PARA6 P6 (NOLOCK) ON SKU.PARA6_CODE = P6.PARA6_CODE            
	JOIN UOM E (NOLOCK) ON ART.UOM_CODE = E.UOM_CODE         
	JOIN JOBS F (NOLOCK) ON F.JOB_CODE = M.JOB_CODE     
	JOIN BIN BI (NOLOCK) ON BI.BIN_ID = B.BIN_ID                   
	WHERE A.RECEIPT_ID= @CWHERE                      
	ORDER BY B.TS                   
            
 GOTO LAST                      
         
LBLISSUE:                      
 SELECT ISSUE_NO,ISSUE_ID FROM PRD_JOBWORK_ISSUE_MST WHERE CANCELLED = 0                       
 GOTO LAST                       
                      
LBLDREC:                      
                        
 IF OBJECT_ID('TEMPDB..#TMPJWI','U') IS NOT NULL
	DROP TABLE #TMPJWI

 SELECT A.ISSUE_ID,B.ROW_ID,CONVERT(NUMERIC(10,2), ISNULL(REC.QUANTITY,0))+ISNULL(SHRINK_QTY,0) AS RECEIVE_QUNATITY, 
 ISNULL(SHRINK_QTY,0) AS  SHRINK_QTY,    
 (B.QUANTITY - (ISNULL(REC.QUANTITY,0)+ISNULL(SHRINK_QTY,0))) AS BALANCE_QUANTITY,    
 (B.QUANTITY - (ISNULL(REC.QUANTITY,0)+ISNULL(SHRINK_QTY,0))) AS PENDING_QUANTITY,         
 B.QUANTITY AS ISSUE_QUANTITY      INTO #TMPJWI FROM PRD_JOBWORK_ISSUE_DET B (NOLOCK)
 JOIN PRD_JOBWORK_ISSUE_MST A (NOLOCK) ON A.ISSUE_ID=B.ISSUE_ID
 LEFT OUTER JOIN         
 (SELECT M.REF_ROW_ID,SUM(M.QUANTITY) AS QUANTITY,
         SUM(M.SHRINK_QTY) AS SHRINK_QTY
 FROM PRD_JOBWORK_RECEIPT_DET M (NOLOCK)                         
 JOIN PRD_JOBWORK_RECEIPT_MST N (NOLOCK) ON M.RECEIPT_ID = N.RECEIPT_ID         
 WHERE N.CANCELLED = 0 AND N.AGENCY_CODE = @CWHERE       
 GROUP BY M.REF_ROW_ID) REC        
 ON REC.REF_ROW_ID =  B.ROW_ID         
 WHERE A.CANCELLED = 0  AND  A.AGENCY_CODE =@CWHERE          
 AND (B.QUANTITY - (ISNULL(REC.QUANTITY,0)+ISNULL(SHRINK_QTY,0))) > 0   
 
 CREATE INDEX IND_TMPJWI ON #TMPJWI (ROW_ID,ISSUE_ID)
                          
 SELECT (CAST(0 AS BIT)) AS CHKDELIVER ,TMP.RECEIVE_QUNATITY, TMP.BALANCE_QUANTITY,    
 TMP.PENDING_QUANTITY, TMP.ISSUE_QUANTITY,B.ROW_ID AS REF_ROW_ID,BI.BIN_NAME,  
 (CONVERT(NUMERIC(10,2), ISNULL(TMP.RECEIVE_QUNATITY,0))*B.JOB_RATE) AS AMOUNT,      
 B.PRODUCT_CODE,B.QUANTITY,B.REMARKS,B.DEPT_ID,B.COMPANY_CODE,B.ROW_ID,
 B.LAST_UPDATE,B.ISSUE_ID,B.NO_HRS,B.JOB_CODE,B.DUE_DT,B.BIN_ID,
 '' AS WIP_UID,B.PREV_JOB_CODE,B.PREV_JOB_RATE,B.REF_NO,
 B.PRODUCT_UID,  F.JOB_NAME, A.ISSUE_NO , A.ISSUE_DT,                     
 ART.ARTICLE_NO, ART.ARTICLE_NAME, PARA1_NAME,PARA2_NAME,PARA3_NAME,UOM_NAME,
 P1.PARA1_CODE,P2.PARA2_CODE,P3.PARA3_CODE,P4.PARA4_CODE ,P5.PARA5_CODE,P6.PARA6_CODE,            
 CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,SKU.PURCHASE_PRICE,        
 SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,                
 PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],          
 ISNULL(ART.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(P3.DT_CREATED,'') AS [PARA3_DT_CREATED],    
 ISNULL(SKU.DT_CREATED,'') AS [SKU_DT_CREATED],          
 ART.STOCK_NA,D.AGENCY_NAME,D.AGENCY_CODE,ART.ALIAS AS ARTICLE_ALIAS,F1.JOB_NAME AS PREV_JOB_NAME,
 B.PREV_JOB_CODE   ,B.REMARKS AS [ISSUE_REMARKS]   ,AG.JOB_RATE,
 CAST(0 AS NUMERIC(10,2)) AS SHRINK_QTY,
 CAST(0 AS NUMERIC(10,2)) AS NET_REC
                  
 FROM #TMPJWI TMP (NOLOCK)                         
 JOIN PRD_JOBWORK_ISSUE_MST A (NOLOCK) ON A.ISSUE_ID = TMP.ISSUE_ID                                   
 JOIN PRD_JOBWORK_ISSUE_DET B (NOLOCK) ON TMP.ROW_ID = B.ROW_ID                                   
 JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=B.PRODUCT_UID        
 JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE            
 JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE          
 JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE          
 JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE            
 JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE            
 JOIN PARA3 P3 (NOLOCK) ON SKU.PARA3_CODE = P3.PARA3_CODE            
 JOIN PARA4 P4 (NOLOCK) ON SKU.PARA4_CODE = P4.PARA4_CODE            
 JOIN PARA5 P5 (NOLOCK) ON SKU.PARA5_CODE = P5.PARA5_CODE            
 JOIN PARA6 P6 (NOLOCK) ON SKU.PARA6_CODE = P6.PARA6_CODE            
 JOIN UOM E (NOLOCK) ON ART.UOM_CODE = E.UOM_CODE         
 JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE 
 JOIN JOBS F1 (NOLOCK) ON F1.JOB_CODE = B.PREV_JOB_CODE                   
 JOIN PRD_AGENCY_MST D (NOLOCK) ON A.AGENCY_CODE = D.AGENCY_CODE  
 JOIN
 (  
  SELECT DISTINCT DEFAULT_BASIS, A.JOB_CODE,
 CASE WHEN ISNULL(DEFAULT_BASIS,0)=1  THEN JOB_RATE
				   WHEN ISNULL(DEFAULT_BASIS,0)=2  THEN JOB_RATE_PCS
				   WHEN ISNULL(DEFAULT_BASIS,0)=3  THEN JOB_RATE_DAYS
				   WHEN ISNULL(DEFAULT_BASIS,0)=4  THEN JOB_RATE_HOURS
			  ELSE 0 END AS JOB_RATE
	FROM AGENCY_JOBS A (NOLOCK)
	WHERE A.AGENCY_CODE=@CWHERE
	
 ) AG ON AG.JOB_CODE=F.JOB_CODE
 JOIN BIN BI (NOLOCK) ON BI.BIN_ID=B.BIN_ID         
 ORDER BY    SKU.PRODUCT_CODE, A.ISSUE_DT               
      
   GOTO LAST           
                      
LBLALLDATACOL:                      
        
	SELECT * FROM PRD_JOBWORK_RECEIPT_MST(NOLOCK) A                      
	JOIN PRD_JOBWORK_RECEIPT_DET(NOLOCK) B ON A.RECEIPT_ID=B.RECEIPT_ID                      
	JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID =B.PRODUCT_UID        
	JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE            
	JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE          
	JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE          
	JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE            
	JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE            
	JOIN PARA3 P3 (NOLOCK)ON SKU.PARA3_CODE = P3.PARA3_CODE            
	JOIN PARA4 P4 (NOLOCK)ON SKU.PARA4_CODE = P4.PARA4_CODE            
	JOIN PARA5 P5 (NOLOCK)ON SKU.PARA5_CODE = P5.PARA5_CODE            
	JOIN PARA6 P6 (NOLOCK)ON SKU.PARA6_CODE = P6.PARA6_CODE            
	JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE         
	JOIN JOBS (NOLOCK) D ON D.JOB_CODE=A.JOB_CODE                      
	WHERE A.RECEIPT_ID=@CWHERE                      
  GOTO LAST                      
LBLLOOKUP:                      
  SET @CCMD=N'SELECT * FROM PRD_JOBWORK_RECEIPT_MST (NOLOCK) '+@CWHERE + ' ORDER BY RECEIPT_DT,RECEIPT_NO'           
  PRINT @CCMD        
  EXEC SP_EXECUTESQL @CCMD        
          
  GOTO LAST                      
            
        
LBLCANCELCHECK:        
         
 SELECT Q.ISSUE_ID AS MEMO_ID          
 FROM PRD_JOBWORK_RECEIPT_MST A (NOLOCK)                         
 JOIN PRD_JOBWORK_RECEIPT_DET B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID            
 JOIN PRD_JOBWORK_ISSUE_DET M (NOLOCK) ON M.ROW_ID = B.REF_ROW_ID         
 JOIN PRD_JOBWORK_ISSUE_MST Q (NOLOCK) ON Q.ISSUE_ID = M.ISSUE_ID                 
 WHERE A.RECEIPT_ID = @CWHERE         
        
 GOTO LAST        
LAST:                      

END
