create PROCEDURE SP3S_PROCESS_INV_QTY
(
  @CKEYFIELDVAL1 VARCHAR(100)='',
  @NREVERTFLAG INT=0,
  @CERRORMSG VARCHAR(1000) OUTPUT,
  @CXN_TYPE VARCHAR(10)='WSL',
  @NUPDATEMODE		NUMERIC(1,0)=1,
  @NBOXNO NUMERIC(3,0)=0,
  @CPRODUCTCODE varchar(50)=''

)
AS
BEGIN
    
      DECLARE @NOUTFLAG INT 
      
	
	   IF @NREVERTFLAG = 1  
			SET @NOUTFLAG =  1  
       ELSE  
			SET @NOUTFLAG = -1  
	  
	
  SET @CERRORMSG=''
  BEGIN TRY  
     
     
      IF @CXN_TYPE='WPS'
      BEGIN
		   
		   if @NUPDATEMODE in(4,5)
		   begin

				UPDATE A SET INV_QTY=ISNULL(A.INV_QTY,0)-(@NOUTFLAG*B.INV_QTY)  
				FROM BUYER_ORDER_DET  A (NOLOCK)
				JOIN
				(   
					SELECT  B.BO_DET_ROW_ID,
							SUM(A.QUANTITY) AS INV_QTY
					FROM WPS_DET  A (NOLOCK)
					JOIN BUYER_ORDER_WPS_LINK  B (NOLOCK) ON A.ROW_ID   =B.WPS_DET_ROW_ID 
					WHERE A.PS_ID =@CKEYFIELDVAL1
					and ((A.BOX_NO =@NBOXNO and @NUPDATEMODE=4)
					    or (A.PRODUCT_CODE =@CPRODUCTCODE and @NUPDATEMODE=5) )
					AND  ISNULL (B.BO_DET_ROW_ID,'')<>''
					GROUP BY B.BO_DET_ROW_ID
				    
				) B ON  A.ROW_ID  =B.BO_DET_ROW_ID 

		   end
		   else
		   begin
		  
			UPDATE A SET INV_QTY=ISNULL(A.INV_QTY,0)-(@NOUTFLAG*B.INV_QTY)  
			FROM BUYER_ORDER_DET  A (NOLOCK)
			JOIN
			(   
				SELECT  B.BO_DET_ROW_ID,
						SUM(A.QUANTITY) AS INV_QTY
				FROM WPS_DET  A (NOLOCK)
				JOIN BUYER_ORDER_WPS_LINK  B (NOLOCK) ON A.ROW_ID   =B.WPS_DET_ROW_ID 
				WHERE A.PS_ID =@CKEYFIELDVAL1
				AND  ISNULL (B.BO_DET_ROW_ID,'')<>''
				GROUP BY B.BO_DET_ROW_ID
				    
			) B ON  A.ROW_ID  =B.BO_DET_ROW_ID 
		    
			end
	
		END    
		ELSE IF  @CXN_TYPE='WSL'
		BEGIN
		
		   IF @NUPDATEMODE IN(4,5)
		   BEGIN
		 
				UPDATE A SET INV_QTY=ISNULL(A.INV_QTY,0)-(@NOUTFLAG*B.INV_QTY)  
				FROM BUYER_ORDER_DET  A (NOLOCK)
				JOIN
				(   
					SELECT  B.BO_DET_ROW_ID,
							SUM(A.QUANTITY) AS INV_QTY
					FROM IND01106   A (NOLOCK)
					JOIN BUYER_ORDER_WSL_LINK  B (NOLOCK) ON A.ROW_ID   =B.IND_ROW_ID 
					WHERE A.INV_ID =@CKEYFIELDVAL1
					AND ((A.BOX_NO =@NBOXNO AND @NUPDATEMODE=4)
					    OR (A.PRODUCT_CODE =@CPRODUCTCODE AND @NUPDATEMODE=5) )
					AND  ISNULL (B.BO_DET_ROW_ID,'')<>''
					GROUP BY B.BO_DET_ROW_ID
				    
				) B ON  A.ROW_ID  =B.BO_DET_ROW_ID 

		   END
		   ELSE 
		   BEGIN
		      


			    UPDATE A SET INV_QTY=ISNULL(A.INV_QTY,0)-(@NOUTFLAG*B.INV_QTY)  
				FROM BUYER_ORDER_DET  A (NOLOCK)
				JOIN
				(   
					SELECT  B.BO_DET_ROW_ID,
							SUM(A.QUANTITY) AS INV_QTY
					FROM IND01106   A (NOLOCK)
					JOIN BUYER_ORDER_WSL_LINK  B (NOLOCK) ON A.ROW_ID   =B.IND_ROW_ID 
					WHERE A.INV_ID =@CKEYFIELDVAL1
					AND  ISNULL (B.BO_DET_ROW_ID,'')<>''
					GROUP BY B.BO_DET_ROW_ID
				    
				) B ON  A.ROW_ID  =B.BO_DET_ROW_ID 

		   END
		END
		    
	    
     
 END TRY  
 BEGIN CATCH  
  SET @CERRORMSG = 'STEP-  SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()  
  GOTO END_PROC  
 END CATCH  
  
END_PROC:  
END