CREATE VIEW VW_AGENCY_MATERIAL_RECEIPT_LIST    

AS       
SELECT        
 T1.MEMO_NO      
,T1.MEMO_DT AS MEMO_DATE   
, K.AGENCY_NAME     
,T3.DEPARTMENT_NAME AS [DEPARTMENT NAME]  
,T4.[WORK_ORDER_NO]   
,T4.[REFRENCE NO]  
,ISNULL(T1.SUBTOTAL,0) AS SUBTOTAL  
,ISNULL(T1.DISCOUNT_AMOUNT,0) AS DISCOUNT_AMOUNT  
,ISNULL(T1.TDS,0) AS TDS  
,ISNULL(T1.OTHERCHARGES,0) AS OTHERCHARGES  
,ISNULL(T1.FREIGHT,0) AS FREIGHT  
,T1.NET_AMOUNT      
,T1.REMARKS AS MST_REMARKS       
,CASE WHEN T1.CANCELLED =0 THEN '' ELSE 'CANCELLED' END AS CANCELLED      
,T2.USERNAME AS USER_NAME     
,T1.MEMO_ID     
,T1.DEPARTMENT_ID   
,T1.FIN_YEAR   
,CASE WHEN ISNULL(VM.BILL_ID,'')<>'' THEN 'UPDATED' ELSE '' END AS UPDATED
,T1.AGENCY_CHALLAN_NO
,T1.AGENCY_CHALLAN_DT
,T1.AGENCY_BILL_NO
,T1.AGENCY_BILL_DT
,T4.REC_QTY 
FROM PRD_AGENCY_MATERIAL_RECEIPT_MST T1     
JOIN USERS T2 ON T1.USER_CODE = T2.USER_CODE      
JOIN PRD_AGENCY_MST  K ON T1.AGENCY_CODE = K.AGENCY_CODE    
JOIN PRD_DEPARTMENT_MST T3 ON T1.DEPARTMENT_ID=T3.DEPARTMENT_ID  
LEFT OUTER JOIN VM01106 VM ON VM.BILL_ID=T1.MEMO_ID AND VM.CANCELLED=0 AND VM.BILL_TYPE='AMRC'
JOIN   
(  
SELECT A4.MEMO_ID, A1.MEMO_NO AS [WORK_ORDER_NO],A1.REF_NO AS [REFRENCE NO],
       SUM(A4.QUANTITY) AS REC_QTY
FROM PRD_WO_MST A1  
JOIN PRD_AGENCY_ISSUE_MATERIAL_DET A3 ON A1.MEMO_ID=A3.REF_PRD_WORKORDER_MEMOID 
JOIN PRD_AGENCY_ISSUE_MATERIAL_MST A2 ON A3.MEMO_ID=A2.MEMO_ID  
JOIN PRD_AGENCY_MATERIAL_RECEIPT_DET A4 ON A3.ROW_ID=A4.REF_ROW_ID  
GROUP BY A4.MEMO_ID, A1.MEMO_NO,A1.REF_NO  
) T4 ON T4.MEMO_ID=T1.MEMO_ID  
UNION 
SELECT        
 T1.MEMO_NO      
,T1.MEMO_DT AS MEMO_DATE   
, K.AGENCY_NAME     
,T3.DEPARTMENT_NAME AS [DEPARTMENT NAME]  
,T4.[WORK_ORDER_NO]   
,T4.[REFRENCE NO]  
,ISNULL(T1.SUBTOTAL,0) AS SUBTOTAL  
,ISNULL(T1.DISCOUNT_AMOUNT,0) AS DISCOUNT_AMOUNT  
,ISNULL(T1.TDS,0) AS TDS  
,ISNULL(T1.OTHERCHARGES,0) AS OTHERCHARGES  
,ISNULL(T1.FREIGHT,0) AS FREIGHT  
,T1.NET_AMOUNT      
,T1.REMARKS AS MST_REMARKS       
,CASE WHEN T1.CANCELLED =0 THEN '' ELSE 'CANCELLED' END AS CANCELLED      
,T2.USERNAME AS USER_NAME     
,T1.MEMO_ID     
,T1.DEPARTMENT_ID   
,T1.FIN_YEAR   
,CASE WHEN ISNULL(VM.BILL_ID,'')<>'' THEN 'UPDATED' ELSE '' END AS UPDATED
,T1.AGENCY_CHALLAN_NO
,T1.AGENCY_CHALLAN_DT
,T1.AGENCY_BILL_NO
,T1.AGENCY_BILL_DT
,T4.REC_QTY 
FROM PRD_AGENCY_MATERIAL_RECEIPT_MST T1     
JOIN USERS T2 ON T1.USER_CODE = T2.USER_CODE      
JOIN PRD_AGENCY_MST  K ON T1.AGENCY_CODE = K.AGENCY_CODE    
JOIN PRD_DEPARTMENT_MST T3 ON T1.DEPARTMENT_ID=T3.DEPARTMENT_ID  
LEFT OUTER JOIN VM01106 VM ON VM.BILL_ID=T1.MEMO_ID AND VM.CANCELLED=0 AND VM.BILL_TYPE='AMRC'

JOIN   
(  
SELECT A4.MEMO_ID, A1.MEMO_NO AS [WORK_ORDER_NO],A1.REF_NO AS [REFRENCE NO],
       SUM(A4.QUANTITY) AS REC_QTY  
FROM PRD_WO_MST A1  
JOIN PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING A3 ON A1.MEMO_ID=A3.REF_PRD_WORKORDER_MEMOID 
JOIN PRD_AGENCY_ISSUE_MATERIAL_MST_PENDING A2 ON A3.MEMO_ID=A2.MEMO_ID  
 
JOIN PRD_AGENCY_MATERIAL_RECEIPT_DET A4 ON A3.ROW_ID=A4.REF_ROW_ID  
GROUP BY A4.MEMO_ID, A1.MEMO_NO,A1.REF_NO  
) T4 ON T4.MEMO_ID=T1.MEMO_ID
