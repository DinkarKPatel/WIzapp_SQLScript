CREATE PROCEDURE  SP3S_POSTSALES_HBDPRINT
(
  @CMEMO_ID VARCHAR(MAX),
  @CTEMPTABLE VARCHAR(MAX)=''
) 
AS
BEGIN
    DECLARE @DTSQL NVARCHAR(MAX),@DTSQL1 NVARCHAR(MAX),@AVALUE BIT,@CFILTERCONDITION VARCHAR(MAX),
            @SALE_PERSON varchar(1000)
    
	PRINT 'step#1:'+convert(varchar,getdate(),113)
    CREATE TABLE #CUSBAL(BAL FLOAT)   

    DECLARE @CUS VARCHAR(100),@BAL FLOAT
    
    SELECT TOP 1 @CUS=a.CUSTOMER_CODE
    FROM HOLD_BACK_DELIVER_MST A (NOLOCK) 
    WHERE a.MEMO_ID=@CMEMO_ID

	PRINT 'step#2:'+convert(varchar,getdate(),113)

	
	INSERT INTO #CUSBAL
	EXEC USP_CUSTBAL @CUS,''

	select @BAL=bal from #CUSBAL

   -- SELECT TOP 1 @BAL=CUST_BAL FROM custdym where customer_code =@CUS
    
    SET @BAL=ISNULL(@BAL,0)

	PRINT 'step#3:'+convert(varchar,getdate(),113)
    SELECT TOP 1 @AVALUE=VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION ='PENDING'   
 

	SELECT B.PRODUCT_CODE, B.WS_PRICE,B.PURCHASE_PRICE,B.DT_CREATED ,A.ref_cmd_row_id,a.delivered ,a.row_id 
	INTO #TMPSKU        
	FROM HOLD_BACK_DELIVER_DET A(NOLOCK)
	JOIN SKU B (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE
	WHERE A.MEMO_ID =@CMEMO_ID
	

	SET @SALE_PERSON=''  
	
	SELECT @SALE_PERSON=COALESCE(@SALE_PERSON,'')+Emp.EMP_NAME+','      
	FROM
	(
	SELECT A.EMP_CODE ,A.EMP_CODE1 ,A.EMP_CODE2  FROM CMD01106 A (NOLOCK)
	join #TMPSKU b on a.ROW_ID =b.ref_cmd_row_id 
	where b.delivered =0
	) A
	UNPIVOT
	(CODE   FOR EMPLOYEE IN 
      (EMP_CODE, EMP_CODE1, EMP_CODE2)
    )AS UNPVT
    JOIN EMPLOYEE EMP (NOLOCK) ON EMP.EMP_CODE =CODE 
    WHERE CODE<>'0000000'
    GROUP BY EMP.EMP_NAME
    ORDER BY EMP.EMP_NAME
    --ORDER BY EMPLOYEE 
    
    
    SELECT @SALE_PERSON=LTRIM(RTRIM(@SALE_PERSON))              
	IF RIGHT(@SALE_PERSON,1)=','              
	   SET @SALE_PERSON=LEFT(@SALE_PERSON,LEN(@SALE_PERSON)-1)              
	IF @SALE_PERSON<>''               
	    SET @SALE_PERSON='You are attended by '+@SALE_PERSON  
   
	UPDATE A SET DELIVERED=1  
	FROM #TMPSKU A
	JOIN SLS_DELIVERY_DET B (NOLOCK) ON A.ROW_ID =B.REF_HBD_ROW_ID 
	JOIN SLS_DELIVERY_MST C (NOLOCK) ON B.MEMO_ID =C.MEMO_ID 
	WHERE C.CANCELLED =0



	 DECLARE @CADVRECNO VARCHAR(1000),@namt numeric(10,2),@ntotalRate numeric(10,2),
	         @npendingAmount NUmeric(10,2)

	;with cte as
	(
	SELECT A.MEMO_ID,B.ADV_REC_ID,SUM(C.AMOUNT) AS AMOUNT,A.MEMO_NO,C.ADV_REC_NO,C.ADV_REC_DT 
	FROM HOLD_BACK_DELIVER_MST A (NOLOCK) 
    JOIN HBD_RECEIPT B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID 
    JOIN ARC01106 C (NOLOCK) ON B.ADV_REC_ID = C.ADV_REC_ID  
	WHERE 
	A.MEMO_ID = @CMEMO_ID AND 
	C.cancelled=0
	GROUP BY A.MEMO_ID,B.ADV_REC_ID,A.MEMO_NO,C.ADV_REC_NO,C.ADV_REC_DT
	)

	SELECT    @CADVRECNO=COALESCE(@CADVRECNO+',','')+ADV_REC_NO ,
	          @NAMT=(SELECT SUM(AMOUNT) FROM CTE),
			  @ntotalRate=(select sum(JOB_RATE) from hold_back_deliver_det (nolock) where memO_id=@CMEMO_ID)
    FROM CTE 

	 
	SELECT @CADVRECNO=ISNULL(@CADVRECNO,''),@NAMT=ISNULL(@NAMT,0),@NTOTALRATE=ISNULL(@NTOTALRATE,0),
	@NPENDINGAMOUNT=ISNULL(@NTOTALRATE,0)-ISNULL(@NAMT,0)

	
	PRINT 'step#4:'+convert(varchar,getdate(),113)
	SET @CFILTERCONDITION=''

	IF ISNULL(@AVALUE,0)<>0
	SET @CFILTERCONDITION='  AND tmpsku.DELIVERED=0'	


	SET @DTSQL=N'SELECT A.REMARKS AS REMARKS_MST,
	M.CM_ID,M.FIN_YEAR,A.MEMO_NO,A.MEMO_DT,M.CM_NO,M.CM_DT, A.CANCELLED,A.CUSTOMER_CODE,
	B.MEMO_ID,B.ROW_ID,B.REF_CMD_ROW_ID,tmpsku.DELIVERED,B.JOB_CODE,B.LAST_UPDATE,B.REMARKS,B.TS,B.DELIVERY_DT,
	C.PRODUCT_CODE,B.PRODUCT_CODE AS HBD_PRODUCT_CODE, ARTICLE_NAME AS DESCRIPTION,B.QUANTITY,C.MRP,A.ENTRY_MODE,
	ARTICLE_NO, ARTICLE_NAME, PARA1_NAME,PARA2_NAME,PARA3_NAME,     
	CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,Sn.pp PURCHASE_PRICE,
	Sn.WS_PRICE,   SECTION_NAME, SUB_SECTION_NAME,  
	PARA4_NAME,PARA5_NAME,PARA6_NAME,
	F.JOB_NAME,(H.CUSTOMER_FNAME  + '' '' + H.CUSTOMER_LNAME) AS CUSTOMER_NAME,H.USER_CUSTOMER_CODE,  
	(H.ADDRESS1 + '','' + H.ADDRESS2 + '','' + I.AREA_NAME + '','' + I.PINCODE + '','' + J.CITY + '','' + K.STATE) AS CUSTOMER_ADDRESS
	,B.DELIVERY_DT AS [DUE_DT],EMP.EMP_NAME,EMP1.EMP_NAME AS [EMP_NAME2],EMP2.EMP_NAME AS [EMP_NAME3],B.DELIVERY_TIME
	,''01'' AS COMPANY_CODE
	,COM.PAN_NO AS COMP_PANNO
	,COM.EMAIL_ID AS COMP_EMAILID
	,COM.PWD AS COMP_PWD

	,COM.COUNTRY AS COMP_CONTRY
	,COM.MOBILE AS COMP_MOBILE
	,COM.CONTACT_NAME AS COMP_CONTACTNAME
	,COM.TDS_AC_NO AS COMP_TDSACNO

	,CASE WHEN ISNULL(TL.DEPT_PRINT_NAME,'''')<>'''' THEN TL.DEPT_PRINT_NAME ELSE  ISNULL(TL.DEPT_NAME,'''') END AS COMP_COMPANYNAME

	,ISNULL(TL.DEPT_ALIAS,'''') AS COMP_ALIAS
	,ISNULL(TL.ADDRESS1,'''') AS COMP_ADDRESS1
	,ISNULL(TL.ADDRESS2,'''') AS COMP_ADDRESS2 
	,ISNULL(city.city,'''') AS COMP_CITY
	,area.AREA_CODE AS COMP_AREACODE
	,area.area_name AS COMP_area_name
	,GM.gst_state_name AS COMP_STATE 

	,COM.TAN_NO AS COMP_TANNO
	,tl.phone AS COMP_PHONES_FAX
	,COM.CST_DT AS COMP_CST_DT
	,COM.SST_NO AS COMP_SSTNO
	,COM.SST_DT AS COMP_SSTDT
	,COM.GRP_CODE AS COMP_GRPCODE
	,COM.ADDRESS9 AS COMP_ADDRESS9
	,COM.PRINT_ADDRESS AS COMP_PRINTADDRESS
	,COM.WORKABLE AS COMP_WORKABLE
	,area.PINcode AS COMP_PIN
	,COM.LOGO_PATH AS COMP_LOGOPATH
	,COM.WEB_ADDRESS AS COMP_WEBADDRESS
	,COM.SSPL_FIRST_HDSR AS COMP_SSPLFIRSTHDSR
	,COM.POLICY_NO AS COMP_POLICYNO
	,COM.GRP_NAME AS COMP_GRPNAME 
	,COM.CIN AS COMP_CIN
	,COMP_GSTIN=CASE LEN(ISNULL(L.LOC_GST_NO,'''')) WHEN 0 THEN '''' ELSE ''GSTIN: ''+L.LOC_GST_NO END
	,PARTY_GST_NO=CASE ISNULL(TL.LOC_GST_NO,'''') WHEN '''' THEN '''' ELSE ''PARTY GST NO: ''+TL.LOC_GST_NO END
	,C.DISCOUNT_AMOUNT AS ITEM_DISCOUNT_AMOUNT
	,m.DISCOUNT_AMOUNT as Bill_DISCOUNT_AMOUNT
	,M.NET_AMOUNT As CMM_NET_AMOUNT
	,isnull(pay.amount,0) as CREDIT_AMOUNT
	,pay.amount-isnull(ccr.amount,0) as Bill_pending_amount
	,B.JOB_RATE
	,b.Additional_job
	
	,'''+@SALE_PERSON+''' AS SALE_PERSON
	,'''+@CADVRECNO+''' AS ADV_REC_NO
	,'''+RTRIM(LTRIM(STR(@ntotalRate)))+''' AS Total_JOB_RATE
	,'''+RTRIM(LTRIM(STR(@NAMT)))+''' AS Total_Rec_Amount
	,'''+RTRIM(LTRIM(STR(@npendingAmount)))+''' AS Pending_Amt
	'
	+CHAR(13)+','+CAST(@BAL AS VARCHAR)+' AS CUSTBAL'
	+','+CAST(@BAL AS VARCHAR)+' AS BAL_AMOUNT'
	+',CONVERT(VARCHAR,DT_BIRTH,105) AS DOB
	'+RTRIM(LTRIM((CASE WHEN @CTEMPTABLE <> '' THEN ' INTO '+@CTEMPTABLE+' ' ELSE ' ' END)))+'
	FROM HOLD_BACK_DELIVER_MST A (NOLOCK) 
	JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID 
	JOIN CMD01106 C (NOLOCK) ON C.ROW_ID = B.REF_CMD_ROW_ID    
	JOIN CMM01106 M (NOLOCK) ON C.CM_ID = M.CM_ID    
	JOIN #TMPSKU tmpSKU (NOLOCK) ON tmpSKU.row_id = B.row_id--SKU.PRODUCT_CODE=C.PRODUCT_CODE
	JOIN sku_names sn (NOLOCK) ON sn.product_code=tmpSKU.product_code
	LEFT OUTER JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE         
	JOIN CUSTDYM H (NOLOCK) ON A.CUSTOMER_CODE = H.CUSTOMER_CODE
	JOIN AREA I (NOLOCK) ON I.AREA_CODE = H.AREA_CODE 
	JOIN CITY J (NOLOCK) ON J.CITY_CODE = I.CITY_CODE 
	JOIN STATE K (NOLOCK) ON K.STATE_CODE = J.STATE_CODE 
	JOIN EMPLOYEE EMP(NOLOCK) ON EMP.EMP_CODE=C.EMP_CODE
	JOIN EMPLOYEE EMP1(NOLOCK) ON EMP1.EMP_CODE=C.EMP_CODE1
	JOIN EMPLOYEE EMP2(NOLOCK) ON EMP2.EMP_CODE=C.EMP_CODE2
	LEFT JOIN 
	(
	  SELECT C.CM_ID,ISNULL(SUM(C.RECEIPT_AMOUNT),0)  AS AMOUNT FROM 
	   CMM_CREDIT_RECEIPT C(NOLOCK) 
	  JOIN ARC01106 D(NOLOCK) ON D.ADV_REC_ID=C.ADV_REC_ID
	  JOIN cmm01106 cmm (NOLOCK) ON cmm.cm_id=c.cm_id
	  JOIN 
	  ( 
	    select cmd.cm_id from  cmd01106 cmd (NOLOCK) 
	    JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON cmd.ROW_ID = B.REF_CMD_ROW_ID   
	    where b.memo_id='''+@cMemo_Id+'''
	    group  by cmd.cm_id
	  ) cmd ON cmd.cm_id=cmm.cm_id
	  WHERE D.CANCELLED=0 
	  GROUP BY C.CM_ID
	  
	)CCR ON CCR.CM_ID=C.CM_ID
	LEFT JOIN
	(
	  SELECT A.MEMO_ID ,ISNULL(SUM(AMOUNT),0) AS AMOUNT 
	  FROM PAYMODE_XN_DET A
	  JOIN CMM01106 B ON A.MEMO_ID=B.CM_ID
	  JOIN 
	  ( 
	    select cmd.cm_id from  cmd01106 cmd (NOLOCK) 
	    JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON cmd.ROW_ID = B.REF_CMD_ROW_ID   
	    where b.memo_id='''+@cMemo_Id+'''
	    group  by cmd.cm_id
	  ) cmd ON cmd.cm_id=b.cm_id
	  WHERE  PAYMODE_CODE=''0000004'' 
	  GROUP BY A.MEMO_ID
	)PAY ON PAY.MEMO_ID=C.CM_ID
	JOIN COMPANY COM ON COM.COMPANY_CODE =''01''
	LEFT OUTER JOIN LOCATION L (NOLOCK) ON L.DEPT_ID =A.location_code
	LEFT OUTER JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID=A.DELIVERY_DEPT_ID
	LEFT OUTER JOIN area (NOLOCK) ON area.area_code=tl.area_code
	LEFT OUTER JOIN city (NOLOCK) ON city.city_code=area.city_code
	lEFT OUTER JOIN gst_state_mst GM (NOLOCK) ON GM.gst_state_code=TL.gst_state_code 
	WHERE  A.MODE<>2 AND  B.MEMO_ID='''+@CMEMO_ID+''''+ @CFILTERCONDITION+'

	UNION '
	
	
SET @DTSQL1=N'SELECT A.REMARKS AS REMARKS_MST,
	'''' AS CM_ID,'''' AS FIN_YEAR,A.MEMO_NO,A.MEMO_DT,'''' AS CM_NO,'''' AS CM_DT, A.CANCELLED,A.CUSTOMER_CODE,
	B.MEMO_ID,B.ROW_ID,b.REF_CMD_ROW_ID,tmpSKU.DELIVERED,B.JOB_CODE,B.LAST_UPDATE,B.REMARKS,B.TS,B.DELIVERY_DT,
	B.PRODUCT_CODE ,B.PRODUCT_CODE,B.DESCRIPTION,B.QUANTITY,0 AS MRP,A.ENTRY_MODE,
	ARTICLE_NO, ARTICLE_NAME,SKU.PARA1_NAME AS  PARA1_NAME,
	SKU.PARA2_NAME AS PARA2_NAME,SKU.PARA3_NAME AS PARA3_NAME,
	CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,0 AS PURCHASE_PRICE,
	0 AS WS_PRICE,SECTION_NAME,SUB_SECTION_NAME,SKU.PARA4_NAME,SKU.PARA5_NAME,SKU.PARA6_NAME,
	F.JOB_NAME,(H.CUSTOMER_FNAME  + '' '' + H.CUSTOMER_LNAME) AS CUSTOMER_NAME,H.USER_CUSTOMER_CODE,  
	(H.ADDRESS1 + '','' + H.ADDRESS2 + '','' + I.AREA_NAME + '','' + I.PINCODE + '','' + J.CITY + '','' + K.STATE) AS CUSTOMER_ADDRESS,
	B.DELIVERY_DT AS [DUE_DT],EMP.EMP_NAME AS EMP_NAME,'''' AS [EMP_NAME2],'''' AS [EMP_NAME3],B.DELIVERY_TIME
	,''01'' AS COMPANY_CODE
	,COM.PAN_NO AS COMP_PANNO
	,COM.EMAIL_ID AS COMP_EMAILID
	,COM.PWD AS COMP_PWD
	
	,COM.COUNTRY AS COMP_CONTRY
	,COM.MOBILE AS COMP_MOBILE
	,COM.CONTACT_NAME AS COMP_CONTACTNAME
	,COM.TDS_AC_NO AS COMP_TDSACNO

	,CASE WHEN ISNULL(TL.DEPT_PRINT_NAME,'''')<>'''' THEN TL.DEPT_PRINT_NAME ELSE  ISNULL(TL.DEPT_NAME,'''') END AS COMP_COMPANYNAME
	,ISNULL(TL.DEPT_ALIAS,'''') AS COMP_ALIAS
	,ISNULL(TL.ADDRESS1,'''') AS COMP_ADDRESS1
	,ISNULL(TL.ADDRESS2,'''') AS COMP_ADDRESS2 
	,ISNULL(city.city,'''') AS COMP_CITY
	,area.AREA_CODE AS COMP_AREACODE
	,area.area_name AS COMP_area_name
	,GM.gst_state_name AS COMP_STATE 

	,COM.TAN_NO AS COMP_TANNO
	,tl.phone AS COMP_PHONES_FAX
	,COM.CST_DT AS COMP_CST_DT
	,COM.SST_NO AS COMP_SSTNO
	,COM.SST_DT AS COMP_SSTDT
	,COM.GRP_CODE AS COMP_GRPCODE
	,COM.ADDRESS9 AS COMP_ADDRESS9
	,COM.PRINT_ADDRESS AS COMP_PRINTADDRESS
	,COM.WORKABLE AS COMP_WORKABLE
	,AREA.PINCODE AS COMP_PIN
	,COM.LOGO_PATH AS COMP_LOGOPATH
	,COM.WEB_ADDRESS AS COMP_WEBADDRESS
	,COM.SSPL_FIRST_HDSR AS COMP_SSPLFIRSTHDSR
	,COM.POLICY_NO AS COMP_POLICYNO
	,COM.GRP_NAME AS COMP_GRPNAME 
	,COM.CIN AS COMP_CIN
	,COMP_GSTIN=CASE LEN(ISNULL(L.LOC_GST_NO,'''')) WHEN 0 THEN '''' ELSE ''GST NO: ''+L.LOC_GST_NO END
	,PARTY_GST_NO=CASE ISNULL(TL.LOC_GST_NO,'''') WHEN '''' THEN '''' ELSE ''PARTY GST NO: ''+TL.LOC_GST_NO END
	,0 AS ITEM_DISCOUNT_AMOUNT
	,0 as Bill_DISCOUNT_AMOUNT
	,0 As CMM_NET_AMOUNT
	,0 as credit_amount
	,0 as Bill_pending_amount
	,B.JOB_RATE
	,b.Additional_job
	,'''' AS SALE_PERSON
	,'''+@CADVRECNO+''' AS ADV_REC_NO
	,'''+RTRIM(LTRIM(STR(@ntotalRate)))+''' AS Total_JOB_RATE
	,'''+RTRIM(LTRIM(STR(@NAMT)))+''' AS Total_Rec_Amount
	,'''+RTRIM(LTRIM(STR(@npendingAmount)))+''' AS Pending_Amt'
	+CHAR(13)+','+CAST(@BAL AS VARCHAR)+' AS CUSTBAL'
	+','+CAST(@BAL AS VARCHAR)+' AS BAL_AMOUNT'
	+',CONVERT(VARCHAR,DT_BIRTH,105) AS DOB
	FROM HOLD_BACK_DELIVER_MST A (NOLOCK) 
	JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID 
	JOIN sku_names SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE
	LEFT OUTER JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE         
	JOIN CUSTDYM H (NOLOCK) ON A.CUSTOMER_CODE = H.CUSTOMER_CODE
	JOIN AREA I (NOLOCK) ON I.AREA_CODE = H.AREA_CODE 
	JOIN CITY J (NOLOCK) ON J.CITY_CODE = I.CITY_CODE 
	JOIN STATE K (NOLOCK) ON K.STATE_CODE = J.STATE_CODE 
	JOIN COMPANY COM ON COM.COMPANY_CODE =''01''
	JOIN #TMPSKU tmpSKU (NOLOCK) ON tmpSKU.row_id = B.row_id
	LEFT OUTER JOIN LOCATION L (NOLOCK) ON L.DEPT_ID =A.location_code
	LEFT OUTER JOIN LOCATION TL (NOLOCK) ON TL.DEPT_ID=A.DELIVERY_DEPT_ID
	LEFT OUTER JOIN area (NOLOCK) ON area.area_code=tl.area_code
	LEFT OUTER JOIN city (NOLOCK) ON city.city_code=area.city_code	
	lEFT OUTER JOIN gst_state_mst GM (NOLOCK) ON GM.gst_state_code=TL.gst_state_code 
	LEFT JOIN EMPLOYEE EMP(NOLOCK) ON EMP.EMP_CODE=a.hbd_EMP_CODE
	WHERE A.MODE=2 AND   B.MEMO_ID='''+@CMEMO_ID+'''' +@CFILTERCONDITION
	SET @DTSQL=@DTSQL+@DTSQL1
	PRINT @DTSQL1
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL


	PRINT 'step#5:'+convert(varchar,getdate(),113)

	
END
