CREATE PROCEDURE SP_MERGEDOCZVCDATA
@CMEMOID VARCHAR(40)
--WITH ENCRYPTION
AS
BEGIN
	
	BEGIN TRY	
		
		BEGIN TRANSACTION
				
		DECLARE @CCURDEPTID CHAR(2),@CHODEPTID CHAR(2),@CCMD NVARCHAR(MAX),
				@CXNMASTERTABLENAME1 VARCHAR(100),@TCXNMASTERTABLENAME2 VARCHAR(100),@BPROCEED BIT,@CTABLENAME VARCHAR(100),@CMASTERKEYFIELD VARCHAR(100),
				@CKEYFIELD VARCHAR(100),@CPARENTTABLENAME VARCHAR(100),@CPARENTPARANAME VARCHAR(100),@CCHILDPARANAME VARCHAR(100),
				@CWHERECLAUSE VARCHAR(100),@CJOINSTR VARCHAR(1000),@CFINYEAR VARCHAR(100),
				@NGRPCHARS INT,@NSERIESCHARS INT,@BSERIESBROKEN BIT,@CPREVMEMOID VARCHAR(40),@CMERGETABLENAME VARCHAR(50),
				@CFIRSTMEMOID VARCHAR(40),@NPREVMEMOID INT,@NMEMONOLEN INT,@CRETCMD NVARCHAR(MAX),
				@CDELCHILDTABLENAME VARCHAR(100),@CDELCHILDPARANAME VARCHAR(100),@CDELPARENTPARANAME VARCHAR(100),
				@CORIGINALTABLENAME VARCHAR(100),@NLOCTYPE INT,@BDONOTMERGE BIT,@CRFXNTYPE VARCHAR(10),@BHOLOC BIT,
				@BINSERTONLY BIT,@BLINKEDMASTER BIT,@BPURLOC BIT,@CSOURCELOCID CHAR(2),@BSOURCEPURLOC BIT,
				@COUT VARCHAR(100),@CGRPCODE VARCHAR(40),@CMISSINGMEMOID VARCHAR(40),@BRETVAL BIT,@NPREVNO INT,
				@CPREVNO VARCHAR(7),@CSOURCEDB VARCHAR(100),@CFILTERCONDITION VARCHAR(500),@BEMPHEADSUPDATED BIT,
				@CTEMPMASTERTABLENAME VARCHAR(200),@BADDTEMPCOL BIT,@NPAYMODE INT,@NSUMRFNET NUMERIC(10,2),
				@CTEMPCMDTABLENAME VARCHAR(200),@BCREATEAUDITLOGENTRY BIT,@CMEMOLOCID CHAR(2),@NXNSSENDINGORDER INT,
				@NXNSMERGINGORDER INT,@NSTEP INT,@CSKUTABLENAME VARCHAR(100),@CTEMPFORMTABLE VARCHAR(200),
				@CTEMPLMTABLE VARCHAR(200),@CTEMPLMPTABLE VARCHAR(200),@CTEMPHDTABLE VARCHAR(200),@BPURIMPORTFILE BIT,@CTEMPPIDTABLE VARCHAR(200),
				@BTAXCOLNOTFOUND BIT,@CSOURCETEMPTABLE VARCHAR(200),@CTEMPSKUTABLE VARCHAR(200),@CNEWKEYVAL VARCHAR(10),
				@BLOOP BIT,@CMEMONOPREFIX VARCHAR(10),@NUPDATEVALUE INT,@CCMDOUTPUT VARCHAR(MAX),
				@CERRORMSG VARCHAR(MAX),@BENFORCEAUTOSERIES BIT,@CTARGETLOCID CHAR(2),@CMEMOIDPARA VARCHAR(40),
				@NTARGETLOCTYPE INT,@NSOURCELOCTYPE INT,@BSENDPURINFOLOC BIT,@BTARGETPURLOC BIT,@BRETAINSOURCEMEMONO BIT,
				@CBARCODESTR VARCHAR(MAX),@CPRODUCTCODE VARCHAR(50),@BGENSKUREQUESTFROMHO BIT,@BGENERATEAUTOSERIES BIT
				,@SENDBCREQ BIT
		
		SET @CFILTERCONDITION=''
		
		DECLARE @TRETMSG TABLE  (MEMO_ID VARCHAR(40),ERRMSG VARCHAR(MAX))
		
		SET @BHOLOC=0
		
		--- UNCOMMENT AFTER FINALIZATION		
		SET @CSOURCEDB=DB_NAME()
				
		SET @NSTEP=10
		
		
		SELECT @CERRORMSG='',@BPROCEED=1,@NMEMONOLEN=10,@CRETCMD='',@CMISSINGMEMOID=''

		SELECT @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'
		SELECT @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'		
	
		SET @BRETAINSOURCEMEMONO=0
		
		SELECT @NSOURCELOCTYPE=LOC_TYPE FROM LOCATION (NOLOCK) WHERE DEPT_ID=LEFT(@CMEMOID,2)
		
		SELECT @BSENDPURINFOLOC=UPD_PURINFO,@BTARGETPURLOC=PUR_LOC,@NTARGETLOCTYPE=LOC_TYPE
		FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID
				
		SET @NSTEP=15
			
		SET @CMASTERKEYFIELD='CHALLAN_ID'
		
		SET @NSTEP=17
		
		SET @CCMD=N'IF OBJECT_ID(''TMP_DOCZVC_ZVC_MST_'+LTRIM(RTRIM(@CMEMOID))+''',''U'') IS NOT NULL  
			  SELECT @BLOCDATAEXISTSOUT=1   
			 ELSE  
			  SELECT @BLOCDATAEXISTSOUT=0'  
		PRINT @CCMD	  
		EXEC SP_EXECUTESQL @CCMD,N'@BLOCDATAEXISTSOUT BIT OUTPUT',@BLOCDATAEXISTSOUT=@BPROCEED OUTPUT  
		    
		IF @BPROCEED=0  
		BEGIN  
		   SET @NSTEP = 22  
		     
		   SET @CERRORMSG='NO ZERO VALUE CHALLAN DATA FOUND TO BE MERGED'  
		   GOTO LBLLAST  
		END  

		SET @NSTEP=25				
		
		IF @BPROCEED=0
			GOTO LBLLAST			
		

LBLUPDATEMASTERCODES:
		
		SELECT	@CTEMPMASTERTABLENAME='[TMP_DOCZVC_ZVC_MST_'+LTRIM(RTRIM(@CMEMOID))+']',
				@CTEMPPIDTABLE='[TMP_DOCZVC_ZVC_DET_'+LTRIM(RTRIM(@CMEMOID))+']',
				@CTEMPSKUTABLE='[TMP_DOCZVC_SKU_'+LTRIM(RTRIM(@CMEMOID))+']',
				@CTEMPFORMTABLE='[TMP_DOCZVC_FORM_'+LTRIM(RTRIM(@CMEMOID))+']',
				@CTEMPLMTABLE='[TMP_DOCZVC_LM01106_'+LTRIM(RTRIM(@CMEMOID))+']',
				@CTEMPLMPTABLE='[TMP_DOCZVC_LMP01106_'+LTRIM(RTRIM(@CMEMOID))+']'				
		
		IF @CCURDEPTID=@CHODEPTID
			SET @BHOLOC=1
			
		SELECT TOP 1 @CSOURCELOCID=DEPT_ID,@BSOURCEPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=LEFT(@CMEMOID,2)	
		
		SELECT TOP 1 @BTARGETPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID
		
			
			
		--UPDATING AND GENERATING NEW CODE FOR LEDGER MASTER

		SET @NSTEP=50
		SET @CCMD=N'UPDATE '+@CTEMPMASTERTABLENAME+' SET USER_CODE=''0000000'''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

		SET @NSTEP=52
		SET @CCMD=N'IF OBJECT_ID('''+@CTEMPFORMTABLE+''',''U'') IS NOT NULL 
					UPDATE '+@CTEMPFORMTABLE+' SET EXCISE_EDU_CESS_AC_CODE=''0000000000'' ,EXCISE_HEDU_CESS_AC_CODE=''0000000000'' ,EXCISE_DUTY_AC_CODE=''0000000000'' 
					WHERE ISNULL(EXCISE_DUTY_AC_CODE,'''')='''''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

		IF OBJECT_ID(@CTEMPLMTABLE,'U') IS NOT NULL  
		BEGIN
				SET @CCMD=N'UPDATE '+@CTEMPLMTABLE+' SET COMPANY_CODE=''01'''
				EXEC SP_EXECUTESQL @CCMD
		END

		IF OBJECT_ID(@CTEMPLMPTABLE,'U') IS NOT NULL  
		BEGIN
				SET @CCMD=N'UPDATE '+@CTEMPLMPTABLE+' SET COMPANY_CODE=''01'''
				EXEC SP_EXECUTESQL @CCMD
		END
		
LBLDELETE:		

		SET @NSTEP=110
		SET @CCMD=N'DELETE A FROM ZVC_DET A JOIN '+@CTEMPMASTERTABLENAME+' B ON B.CHALLAN_ID=A.CHALLAN_ID'
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

		SET @NSTEP=115
		SET @CCMD=N'DELETE A FROM ZVC_DET A JOIN '+@CTEMPPIDTABLE+' B ON A.ROW_ID=B.ROW_ID'
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD		

LBLMERGE:
		SET @NSTEP=210
		DECLARE @CKEYFIELD1 VARCHAR(200),@CKEYFIELD2 VARCHAR(200)
		

		IF CURSOR_STATUS('GLOBAL','MERGECUR') IN (0,1)  
		BEGIN  
		   CLOSE MERGECUR  
		   DEALLOCATE MERGECUR  
		END  
		
				
		--- NOW, UPDATE TRANSACTIONS DATA ONE BY ONE
		DECLARE MERGECUR CURSOR FOR 
		SELECT DISTINCT TABLENAME, KEYFIELD,LINKED_MASTER,XNS_MERGING_ORDER
		FROM XNSINFO (NOLOCK) 
		WHERE XN_TYPE = 'DOCZVC'
		AND  XNS_MERGING_ORDER <> 99
		ORDER BY XNS_MERGING_ORDER
		
		SET @NSTEP=220
		
		OPEN MERGECUR
		FETCH NEXT FROM MERGECUR INTO @CTABLENAME,@CKEYFIELD,@BLINKEDMASTER,@NXNSMERGINGORDER		
		WHILE @@FETCH_STATUS=0
		BEGIN
			
			SET @NSTEP=230

										
			SET @CSOURCETEMPTABLE='TMP_DOCZVC_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CMEMOID))
			
			PRINT 'SOURCE TABLE '+ISNULL( @CSOURCETEMPTABLE,'NULL')
			IF OBJECT_ID(@CSOURCETEMPTABLE,'U') IS NULL
				GOTO LBLMERGENEXT
			  
			PRINT ''''+@CSOURCETEMPTABLE+''''
			  
			LBLSTARTMERGE:
			SET @BPROCEED=1
			
			SET @NSTEP=235
			SET @CCMD=N'IF NOT EXISTS (SELECT TOP 1 '+@CKEYFIELD+' FROM ['+@CSOURCETEMPTABLE + '])
							SET @BPROCEEDOUT=0'
			
			PRINT @CCMD
			EXEC SP_EXECUTESQL @CCMD,N'@BPROCEEDOUT BIT OUTPUT',@BPROCEEDOUT=@BPROCEED OUTPUT
			
			SET @NSTEP=240
			IF @BPROCEED=0
				GOTO LBLMERGENEXT
			
			SET @NSTEP=250
			
			IF @CTABLENAME='ZVC_DET'
				SET @BINSERTONLY=1
			ELSE
				SET @BINSERTONLY=0 	
			
			IF (@BSOURCEPURLOC=0 OR @BTARGETPURLOC=1) AND @CSOURCELOCID<>@CHODEPTID AND @BHOLOC=0 AND @CTABLENAME IN ('SKU','SKU_OH')
				SET @BINSERTONLY=1
			
			IF @CTABLENAME='ART_ATTR'
				SELECT @CKEYFIELD='ARTICLE_CODE',@CKEYFIELD2='ATTRIBUTE_CODE'
			ELSE
			IF @CTABLENAME='ART_PARA1'
				SELECT @CKEYFIELD='ARTICLE_CODE',@CKEYFIELD2='PARA1_CODE'	
			ELSE
				SET @CKEYFIELD2=''		
		
			EXEC UPDATEMASTERXN_MERGING
			@CSOURCEDB='',
			@CSOURCETABLE=@CSOURCETEMPTABLE,
			@CDESTDB='',
			@CDESTTABLE=@CTABLENAME,
			@CKEYFIELD1=@CKEYFIELD,
			@CKEYFIELD2=@CKEYFIELD2,
			@CKEYFIELD3='',
			@LINSERTONLY=@BINSERTONLY,
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1,
			@CFILTERCONDITION='',
			@CERRORMSG=@CERRORMSG OUTPUT
			
			LBLMERGENEXT:
			
			FETCH NEXT FROM MERGECUR INTO @CTABLENAME,@CKEYFIELD,@BLINKEDMASTER,@NXNSMERGINGORDER		
		END
		CLOSE MERGECUR
		DEALLOCATE MERGECUR
		
		IF @BSENDPURINFOLOC=0 AND @BTARGETPURLOC=0 AND @NTARGETLOCTYPE=1 AND @CCURDEPTID<>@CHODEPTID
		BEGIN
			SET @CCMD=N'UPDATE SKU SET PURCHASE_PRICE=0,FORM_ID=''0000000'',
						AC_CODE=''0000000000'',INV_NO='''',INV_DT='''',CHALLAN_NO='''' FROM ZVC_DET B
						WHERE B.PRODUCT_CODE=SKU.PRODUCT_CODE AND B.CHALLAN_ID='''+@CMEMOID+''''			
			EXEC SP_EXECUTESQL @CCMD		

			SET @CCMD=N'UPDATE SKU_OH SET DISCOUNT_AMOUNT=0,TAX_AMOUNT=0,
						FREIGHT=0,OTHER_CHARGES=0,ROUND_OFF=0,VALUE_ADD=0,EXCISE_DUTY_AMOUNT=0 FROM ZVC_DET B
						WHERE B.PRODUCT_CODE=SKU_OH.PRODUCT_CODE AND B.CHALLAN_ID='''+@CMEMOID+''''
			EXEC SP_EXECUTESQL @CCMD				
		END	

		SET @NSTEP=265
		SET @CCMD=N'INSERT PMT01106 (PRODUCT_CODE,  QUANTITY_IN_STOCK, DEPT_ID,LAST_UPDATE,BIN_ID )
					SELECT	DISTINCT A.PRODUCT_CODE,  0 AS QUANTITY_IN_STOCK,B.TARGET_DEPT_ID AS DEPT_ID, GETDATE() AS LAST_UPDATE,
					''000'' AS BIN_ID
					FROM ZVC_DET A
					JOIN ZVC_MST B ON A.CHALLAN_ID = B.CHALLAN_ID
					LEFT OUTER JOIN PMT01106 D ON A.PRODUCT_CODE = D.PRODUCT_CODE AND D.DEPT_ID = B.TARGET_DEPT_ID
					WHERE B.CHALLAN_ID='''+@CMEMOID+''' AND D.PRODUCT_CODE IS NULL'
					
		PRINT @CCMD					
		EXEC SP_EXECUTESQL @CCMD			
		

		SET @NSTEP=270
		IF CURSOR_STATUS('GLOBAL','ZVCCUR') IN (0,1)  
		BEGIN  
		   CLOSE ZVCCUR  
		   DEALLOCATE ZVCCUR
		END  
		
		
					
	END TRY
	
	BEGIN CATCH
		
		PRINT 'UNTRAPPED ERROR'		
		SELECT @CERRORMSG='PROCEDURE : '+ISNULL(ERROR_PROCEDURE(),'NULL P')+'STEP :'+STR(ISNULL(@NSTEP,0))+ ' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
	END CATCH

			
LBLLAST:

	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			COMMIT TRANSACTION
		ELSE
			ROLLBACK 	
	END	

    INSERT @TRETMSG    
    SELECT @CMEMOID,@CERRORMSG    

    SELECT * FROM @TRETMSG    
	
	--EXEC SP_DROPTEMPTABLES_XNS 'DOCZVC',0,@CMEMOID,'TMP_DOCZVC'		
END
--- END OF CREATING PROCEDURE SP_MERGEDOCZVCDATA
