create PROCEDURE SP_GETINVOICEPRINT_EXCEL    
@CRMID VARCHAR(40),    
@BOX_NO NUMERIC(9,2)=0    
AS    
BEGIN    
    
        
 DECLARE @AC_CODE VARCHAR(10),@TERMS VARCHAR(MAX),@MTRMSNAME VARCHAR(MAX),@CFILTERCONDITION VARCHAR(200)    
 SET @AC_CODE=(SELECT AC_CODE FROM INM01106 WHERE INV_ID =@CRMID)    
    
 SELECT     
 @TERMS=(SELECT STUFF((SELECT CASE WHEN ISNULL(TERMS,'') <> '' THEN ' , ' ELSE '' END +TERMS  FROM      
 (    
 SELECT A.AC_CODE ,B.TERMS          
 FROM  LM_TERMS  A    
 JOIN LEDGER_TERMS B ON A.TERMS_CODE =B.TERMS_CODE    
 WHERE A.AC_CODE =@AC_CODE    
 GROUP BY A.AC_CODE ,B.TERMS     
 ) LM     
 FOR XML PATH('')),1,2,'')),    
 @MTRMSNAME=(SELECT STUFF((SELECT CASE WHEN ISNULL(TERMS_NAME,'') <> '' THEN ' , ' ELSE '' END +TERMS_NAME  FROM      
 (    
 SELECT A.AC_CODE ,B.TERMS_NAME          
 FROM  LM_TERMS  A    
 JOIN LEDGER_TERMS B ON A.TERMS_CODE =B.TERMS_CODE    
 WHERE A.AC_CODE =@AC_CODE    
 GROUP BY A.AC_CODE ,B.TERMS_NAME     
 ) LM     
 FOR XML PATH('')),1,2,''))     
     
 IF @TERMS IS NULL    
 SET @TERMS=''    
     
 SET @CFILTERCONDITION=''    
 IF ISNULL(@BOX_NO,0) <> 0     
 SET @CFILTERCONDITION=' C.BOX_NO='''+RTRIM(LTRIM(STR(@BOX_NO)))+''' AND A.INV_ID='''+@CRMID+''''    
    ELSE    
    SET @CFILTERCONDITION=' A.INV_ID='''+@CRMID+''''    
     
     
 IF @MTRMSNAME IS NULL    
 SET @MTRMSNAME=''    
 --SELECT @MTRMSNAME    
    DECLARE @CCOL VARCHAR(40), @CRETCOLSTR NVARCHAR(MAX),@CCMD NVARCHAR(MAX)  
 SET @CRETCOLSTR = N''    
     
 DECLARE CUR_CT CURSOR FOR    
 SELECT ATTRIBUTE_NAME FROM ATTRM    
  WHERE ATTRIBUTE_TYPE = 1 AND ATTRIBUTE_CODE<>'0000000' ORDER BY ATTRIBUTE_NAME    
     
 OPEN CUR_CT    
 FETCH NEXT FROM CUR_CT INTO @CCOL    
 WHILE @@FETCH_STATUS = 0    
 BEGIN    
  SET @CRETCOLSTR = @CRETCOLSTR + ( CASE WHEN @CRETCOLSTR<>'' THEN N', ' ELSE '' END ) + N'    
        MAX(CASE WHEN B.ATTRIBUTE_NAME = ''' + @CCOL + ''' THEN D.KEY_NAME ELSE '''' END) AS [' + @CCOL + '] '    
    
    
  FETCH NEXT FROM CUR_CT INTO @CCOL    
 END    
 CLOSE CUR_CT    
 DEALLOCATE CUR_CT    
   
 DECLARE @CCMD1 NVARCHAR(MAX)  
     
 SET @CCMD=N'SELECT    
   A.INV_ID,      
   A.INV_DT AS ''MST_XN_DT'',           
   A.INV_NO  AS ''MST_INV_NO'',        
   A.SUBTOTAL  AS ''MST_SUBTOTAL'',          
   A.DISCOUNT_AMOUNT AS ''MST_DISCOUNT_AMOUNT'',          
   A.DISCOUNT_PERCENTAGE AS ''MST_DISCOUNT_PERCENTAGE'',          
   C.ITEM_TAX_AMOUNT AS ''MST_TAX_AMOUNT'',          
   C.ITEM_TAX_PERCENTAGE AS ''MST_TAX_PERCENTAGE'',          
   A.FREIGHT AS ''MST_FREIGHT'',          
   A.OTHER_CHARGES AS ''MST_OTHER_CHARGES'',          
   A.ROUND_OFF AS ''MST_ROUND_OFF'',          
        
   LEFT(c.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',c.PRODUCT_CODE)-1,-1),LEN(c.PRODUCT_CODE ))) AS ''PRODUCT_CODE'',        
   SKU.MRP   AS RSP,          
   SKU.MRP * C.QUANTITY  AS RSP_VALUE,          
   C.QUANTITY AS ''QUANTITY'',         
   C.DISCOUNT_PERCENTAGE,         
   C.DISCOUNT_AMOUNT,         
   D.ARTICLE_NO AS ''ARTICLE_NO'',         
   P1.PARA1_NAME AS ''PARA1_NAME'',           
   P2.PARA2_NAME AS ''PARA2_NAME'',           
   P3.PARA3_NAME AS ''PARA3_NAME'',        
   P4.PARA4_NAME AS ''PARA4_NAME'',          
   P5.PARA5_NAME AS ''PARA5_NAME'',           
   P6.PARA6_NAME AS ''PARA6_NAME'',   
   C.QUANTITY AS ''QUANTITY'',          
   E.SUB_SECTION_NAME AS ''SUB_SECTION_NAME'',             
   F.SECTION_NAME AS ''SECTION_NAME'',           
   SKU.INV_NO  AS ''INV_NO'',          
   SKU.INV_DT AS ''INV_DT'',          
   (C.QUANTITY*C.NET_RATE)  AS ''AMOUNT'',                
   C.NET_RATE,ATTRV.* '  
       
  SET @CCMD1=N'  FROM INM01106 A (NOLOCK)                 
   JOIN LMV01106 B (NOLOCK)  ON A.AC_CODE = B.AC_CODE                
   LEFT JOIN IND01106 C (NOLOCK) ON A.INV_ID = C.INV_ID        
   LEFT JOIN LEDGER_TERMS LT (NOLOCK) ON A.TERMS_CODE =LT.TERMS_CODE            
   LEFT JOIN SKU (NOLOCK) ON C.PRODUCT_CODE = SKU.PRODUCT_CODE            
   LEFT JOIN ARTICLE D (NOLOCK)  ON SKU.ARTICLE_CODE = D.ARTICLE_CODE    
   LEFT JOIN SECTIOND E (NOLOCK)  ON D.SUB_SECTION_CODE = E.SUB_SECTION_CODE                 
   LEFT JOIN SECTIONM F (NOLOCK) ON E.SECTION_CODE = F.SECTION_CODE                 
   LEFT JOIN PARA1 P1 (NOLOCK)  ON SKU.PARA1_CODE = P1.PARA1_CODE            
   LEFT JOIN PARA2 P2 (NOLOCK)  ON SKU.PARA2_CODE = P2.PARA2_CODE                
   LEFT JOIN PARA3 P3 (NOLOCK)  ON SKU.PARA3_CODE = P3.PARA3_CODE         
   LEFT JOIN PARA4 P4 (NOLOCK)  ON SKU.PARA4_CODE = P4.PARA4_CODE         
   LEFT JOIN PARA5 P5 (NOLOCK)  ON SKU.PARA5_CODE = P5.PARA5_CODE           
   LEFT JOIN PARA6 P6 (NOLOCK)  ON SKU.PARA6_CODE = P6.PARA6_CODE               
   JOIN USERS U (NOLOCK)  ON A.USER_CODE = U.USER_CODE          
   LEFT JOIN UOM H (NOLOCK)  ON D.UOM_CODE = H.UOM_CODE          
   LEFT JOIN FORM DG (NOLOCK)  ON C.ITEM_FORM_ID = DG.FORM_ID         
   LEFT OUTER JOIN LOCATION LCT (NOLOCK) ON A.PARTY_DEPT_ID=LCT.DEPT_ID        
   LEFT OUTER JOIN AREA LA ON LCT.AREA_CODE=LA.AREA_CODE        
   LEFT OUTER JOIN CITY LC ON LA.CITY_CODE=LC.CITY_CODE        
   LEFT OUTER JOIN STATE LS ON LC.STATE_CODE=LS.STATE_CODE        
   LEFT OUTER JOIN REGIONM LRG ON LS.REGION_CODE=LRG.REGION_CODE       
         
    
   LEFT OUTER JOIN USERS EU (NOLOCK)  ON A.EDT_USER_CODE = EU.USER_CODE      
   LEFT OUTER JOIN     
   (    
    SELECT ATTR.ARTICLE_CODE '    
    + (CASE WHEN @CRETCOLSTR<>'' THEN ', ' ELSE '' END) + @CRETCOLSTR +     
    ' FROM SKU JOIN IND01106 C ON C.PRODUCT_CODE=SKU.PRODUCT_CODE   
      JOIN INM01106 (NOLOCK) A ON A.INV_ID=C.INV_ID   
      JOIN ART_ATTR ATTR ON ATTR.ARTICLE_CODE=SKU.ARTICLE_CODE    
      JOIN ATTRM B ON ATTR.ATTRIBUTE_CODE = B.ATTRIBUTE_CODE    
      JOIN ATTR_KEY D ON ATTR.KEY_CODE = D.KEY_CODE WHERE'+@CFILTERCONDITION+    
      'GROUP BY ATTR.ARTICLE_CODE    
   )     
   ATTRV ON ATTRV.ARTICLE_CODE = D.ARTICLE_CODE WHERE '+@CFILTERCONDITION+'ORDER BY A.TS'    
   
 PRINT @CCMD1      
 PRINT @CCMD      
 SET  @CCMD=@CCMD+@CCMD1  
   
 EXEC SP_EXECUTESQL @CCMD     
     
    
END
