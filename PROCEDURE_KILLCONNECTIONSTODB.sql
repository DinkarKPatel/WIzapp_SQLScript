CREATE PROCEDURE KILLCONNECTIONSTODB
(
	@CDBNAME VARCHAR(1000)
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CERRORMSG VARCHAR(MAX),@NSPID INT
	IF @CDBNAME=''
	BEGIN
		SET @CERRORMSG='PLEASE DEFINE THE DATABASE..'
		GOTO ENDPROC
	END

	BEGIN TRY
		SELECT @NSPID=MIN(SPID) FROM MASTER..SYSPROCESSES WHERE DBID=DB_ID(@CDBNAME)
		WHILE @NSPID IS NOT NULL
		BEGIN
			EXEC ('KILL '+@NSPID)
			SELECT @NSPID=MIN(SPID) FROM MASTER..SYSPROCESSES WHERE DBID=DB_ID(@CDBNAME)
		END
	END TRY

	BEGIN CATCH
		SET @CERRORMSG='ERROR MESSAGE - '+ ERROR_MESSAGE()
		GOTO ENDPROC
	END CATCH
	
ENDPROC:
	----IF ISNULL(@CERRORMSG,'')<>''
	----	SELECT @CERRORMSG AS ERRORMESSAGE	
	----ELSE
	----	SELECT 'KILLED ALL PROCESSES' AS MESSAGE	
END
