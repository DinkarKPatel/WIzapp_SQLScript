
CREATE PROCEDURE SP3S_SYNCH_UPLOADDATA_BIN_MST_OPT
(
    @CSPID VARCHAR(50)
   ,@CERRMSG VARCHAR(1000) OUTPUT
)
AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX),@CSTEP VARCHAR(10),@CTABLE_SUFFIX VARCHAR(100),
	@CTABLENAME VARCHAR(100),@CTMP_TABLENAME VARCHAR(100),@CKEYFIELD VARCHAR(100),@CREF_CUSTOMER_CODE VARCHAR(100),
	@CTABLESSTR VARCHAR(MAX),@CMEMOID VARCHAR(50),  @CLOCID VARCHAR(5), @CSOURCEDB VARCHAR(100),
	@CMERGEDB VARCHAR(100),@BMSTINSERTONLY BIT,@CFILTERCONDITION VARCHAR(100)

	BEGIN TRY 
			
			SET @CTABLE_SUFFIX = 'UPLOAD'
		
			
			SELECT TOP 1 @CMEMOID = B.MEMO_ID 
			FROM PFI_ORD_PLAN_MST_UPLOAD B (NOLOCK)
			WHERE SP_ID=@CSPID 
    

    
			IF ISNULL(@CMEMOID,'')=''
				GOTO EXIT_PROC
		
			SET @CFILTERCONDITION = ' B.SP_ID='+LTRIM(RTRIM(STR(@CSPID)))
   

		    
			SET @CSTEP = 140
			SET @CTABLENAME='BIN'  
			SET @CTMP_TABLENAME='[BIN_MST_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))+']'
			SET @CKEYFIELD='BIN_ID'  
			SET @CSTEP= 160
			
			
			EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
				 ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
				 ,@LINSERTONLY=1,@CJOINSTR='',@LUPDATEONLY=0  
				 ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION =@CFILTERCONDITION                   
        

		DELETE FROM BIN_MST_BIN_UPLOAD WHERE SP_ID=@CSPID 
	END TRY
    	BEGIN CATCH
	 SET @CERRMSG='P:SP3S_SYNCH_UPLOADDATA_BIN_MST_OPT, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
	END CATCH

EXIT_PROC:
	IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0  
		COMMIT  
	ELSE
	IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0  
		ROLLBACK  

		
END
--END OF THE PROCEDURES SP_MERGE_MIRROR_BIN_MST_DATA

