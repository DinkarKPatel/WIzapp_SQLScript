CREATE PROC PPC_SAVETRAN_HSNMASTER
(
  @NSPID INT
)
--WITH ENCRYPTION
AS
BEGIN
   SET NOCOUNT ON
   DECLARE @CCMD NVARCHAR(MAX),@ON VARCHAR(1000),@COL VARCHAR(1000),@CMASTERTABLENAME VARCHAR(100),@CSOURCEMASTERTABLENAME VARCHAR(100)
   ,@NSTEP INT=0,@CERRORMSG VARCHAR(MAX)='',@UPDATE VARCHAR(MAX)=''
   
   BEGIN TRY
    BEGIN TRANSACTION
    SET @NSTEP=10
	SELECT @CMASTERTABLENAME='HSN_MST',@CSOURCEMASTERTABLENAME='HSN_HSN_MST_UPLOAD',@ON='HSN_CODE'

	SELECT @COL=COALESCE(@COL,'')+'T.['+UPPER(COLUMN_NAME)+']'+', '
	 ,@UPDATE=COALESCE(@UPDATE,'')+'T.['+UPPER(COLUMN_NAME)+']'+'=S.['+UPPER(COLUMN_NAME)+'],'
	FROM INFORMATION_SCHEMA.COLUMNS T
	WHERE T.TABLE_NAME=@CMASTERTABLENAME AND T.DATA_TYPE NOT LIKE 'TIMESTAMP'
	
	
	
	SET @COL=LTRIM(RTRIM(@COL))
	IF RIGHT(@COL,1)=','
		SET @COL=LEFT(@COL,LEN(@COL)-1)
    SET @UPDATE=LTRIM(RTRIM(@UPDATE))		
    IF RIGHT(@UPDATE,1)=','
       SET @UPDATE=LEFT(@UPDATE,LEN(@UPDATE)-1)
       
    SET @CCMD='MERGE '+UPPER(@CMASTERTABLENAME)+' T'  
	SET @CCMD+=CHAR(13)+'USING (SELECT * FROM '+UPPER(@CSOURCEMASTERTABLENAME)+' WHERE SP_ID='+CAST(@NSPID AS VARCHAR)+') S'  
	SET @CCMD+=CHAR(13)+'ON T.HSN_CODE=S.HSN_CODE'
	SET @CCMD+=CHAR(13)+'WHEN MATCHED THEN UPDATE SET '+@UPDATE
	SET @CCMD+=CHAR(13)+'WHEN NOT MATCHED BY TARGET THEN INSERT('+REPLACE(@COL,'T.','')+') VALUES ('+REPLACE(@COL,'T.','S.')+');'   
	PRINT @CCMD+CHAR(13)  
	EXEC (@CCMD)  
	
	SET @NSTEP=15
	SELECT @CMASTERTABLENAME='HSN_DET',@CSOURCEMASTERTABLENAME='HSN_HSN_DET_UPLOAD',@COL='',@UPDATE=''

    SELECT @COL=COALESCE(@COL,'')+'T.['+UPPER(COLUMN_NAME)+']'+', '
	,@UPDATE=COALESCE(@UPDATE,'')+'T.['+UPPER(COLUMN_NAME)+']'+'=S.['+UPPER(COLUMN_NAME)+'],'
	FROM INFORMATION_SCHEMA.COLUMNS T
	WHERE T.TABLE_NAME=@CMASTERTABLENAME AND T.DATA_TYPE NOT LIKE 'TIMESTAMP'
	SET @COL=LTRIM(RTRIM(@COL))
	IF RIGHT(@COL,1)=','
		SET @COL=LEFT(@COL,LEN(@COL)-1)
    SET @UPDATE=LTRIM(RTRIM(@UPDATE))		
    IF RIGHT(@UPDATE,1)=','
       SET @UPDATE=LEFT(@UPDATE,LEN(@UPDATE)-1)

	SET @CCMD='MERGE '+UPPER(@CMASTERTABLENAME)+' T'  
	SET @CCMD+=CHAR(13)+'USING (SELECT * FROM '+UPPER(@CSOURCEMASTERTABLENAME)+' WHERE SP_ID='+CAST(@NSPID AS VARCHAR)+') S'  
	SET @CCMD+=CHAR(13)+'ON T.HSN_CODE=S.HSN_CODE AND T.WEF=S.WEF'
	SET @CCMD+=CHAR(13)+'WHEN MATCHED THEN UPDATE SET '+@UPDATE
	SET @CCMD+=CHAR(13)+'WHEN NOT MATCHED BY TARGET THEN INSERT('+REPLACE(@COL,'T.','')+') VALUES ('+REPLACE(@COL,'T.','S.')+');'   
	--PRINT @CCMD+CHAR(13)  
	EXEC (@CCMD)  
	SET @CCMD='UPDATE '+@CSOURCEMASTERTABLENAME+' SET ROW_ID=NEWID() WHERE LEFT(ROW_ID,5)=''LATER'';'
	EXEC (@CCMD)  
   END TRY
   
   BEGIN CATCH
	  SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
	  GOTO END_PROC
   END CATCH
   
END_PROC:
   IF @@TRANCOUNT>0
	  BEGIN
		IF ISNULL(@CERRORMSG,'')=''
		   COMMIT TRANSACTION
		ELSE
		   ROLLBACK 	
	  END 

   SET @CCMD = N'DELETE HSN_HSN_MST_UPLOAD WHERE SP_ID='+CAST(@NSPID AS VARCHAR)+';
                 DELETE HSN_HSN_DET_UPLOAD WHERE SP_ID='+CAST(@NSPID AS VARCHAR)+';
					  '
		 PRINT @CCMD
		 EXEC SP_EXECUTESQL @CCMD
   SELECT ISNULL(@CERRORMSG,'') AS ERRMSG
   SET NOCOUNT OFF
END
--END OF PROCEDURE PPC_SAVETRAN_HSNMASTER
