create PROCEDURE SP_ITEMSTATUS_2 
(   
  @CQUERYID INT,   
  @BILLNO NVARCHAR(50)='',     
  @PRODUCT_CODE NVARCHAR(20)='',  
  @CFINYEAR NVARCHAR(10)='' ,  
  @CCUSTCODE NVARCHAR(20)='',  
  @NMODE  INT=1,  
  @DTDELIVERYFROM NVARCHAR(20)='',  
  @DTDELIVERYTO NVARCHAR(20)='',  
  @AGENCY NVARCHAR(500)='',  
  @NMODE1 INT=0,--PENDING STATUS (1: LEVEL1) (2: LEVEL2) (3: LEVEL3)  
  @CLOCID NVARCHAR(4)=''  
)   
--WITH ENCRYPTION  
AS   
BEGIN  
   
 ----Putting return in this Procedure till next discussion with Sir.   
 --return  
 DECLARE @CCMD NVARCHAR(MAX),@CCMD01 NVARCHAR(MAX),@CCMD02 NVARCHAR(MAX),@DLAST_DT DATETIME,@CCMD1 NVARCHAR(MAX),@CCMD2 NVARCHAR(MAX),@CCMD3 NVARCHAR(MAX)  
    SELECT @DLAST_DT=DATEADD (YY,-1, DBO.FN_GETFINYEARDATE (@CFINYEAR,1))  
  
   
 PRINT @DLAST_DT  
   
  SELECT TOP 1 CM_NO FROM   
  (   
  SELECT B.PRODUCT_CODE, M.CM_NO, M.CM_DT  
  FROM COMPANY COM (NOLOCK)  
  JOIN HOLD_BACK_DELIVER_MST A (NOLOCK) ON COM.COMPANY_CODE ='01'  
  JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID  
  JOIN CMD01106 C (NOLOCK) ON C.ROW_ID = B.REF_CMD_ROW_ID  
  JOIN CMM01106 M (NOLOCK) ON C.CM_ID = M.CM_ID  
  JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=C.PRODUCT_CODE  
  JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE  
  JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE  
  JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE  
  JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE  
  JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE  
  JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE  
  LEFT OUTER JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE  
  JOIN CUSTDYM H (NOLOCK) ON A.CUSTOMER_CODE = H.CUSTOMER_CODE  
  JOIN AREA I (NOLOCK) ON I.AREA_CODE = H.AREA_CODE  
  JOIN EMPLOYEE EMP(NOLOCK) ON EMP.EMP_CODE=C.EMP_CODE  
  JOIN EMPLOYEE EMP1(NOLOCK) ON EMP1.EMP_CODE=C.EMP_CODE1  
  JOIN EMPLOYEE EMP2(NOLOCK) ON EMP2.EMP_CODE=C.EMP_CODE2  
  UNION  
  SELECT B.PRODUCT_CODE, '' AS CM_NO, '' AS CM_DT  
  FROM COMPANY COM   
  JOIN HOLD_BACK_DELIVER_MST A (NOLOCK) ON COM.COMPANY_CODE ='01'   
  JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID   
  JOIN SKU_REPAIR SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE  
  JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE      
  JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE    
  JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE    
  JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE   
  LEFT OUTER JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE           
  JOIN CUSTDYM H (NOLOCK) ON A.CUSTOMER_CODE = H.CUSTOMER_CODE  
  JOIN AREA I (NOLOCK) ON I.AREA_CODE = H.AREA_CODE  
 ) AS VW_POSTSALES_HBDPRINT  
 WHERE PRODUCT_CODE=@PRODUCT_CODE  
 ORDER BY CM_DT DESC  
   
   
END 