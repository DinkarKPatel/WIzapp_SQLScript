
create PROCEDURE SP3S_HSN_GSTR2
(
  @DFMDATE DATETIME='',
  @DTODATE DATETIME='',
  @CGSTN_NO VARCHAR(100)='',
  @CLOC_TYPE INT=0,
  @CDEPT_ID VARCHAR(5)='',
  @NGSTR3B INT =0
)
AS
BEGIN
     --PROCEDURE WILL BE RETURN ONLY OUTPUT GST
      
	  
      
      IF OBJECT_ID('TEMPDB..#TMPHSNDETAILS','U') IS NOT NULL
         DROP TABLE #TMPHSNDETAILS

      IF OBJECT_ID('TEMPDB..#TMPHSNDETAILS','U') IS NOT NULL
         DROP TABLE #TMPHSNDETAILS

      SELECT CAST('PUR' AS VARCHAR(100)) AS XN_TYPE,
             CAST(A.mrr_id  AS VARCHAR(100)) AS MEMO_ID,
             A.OTHER_CHARGES_HSN_CODE AS HSN_CODE,
             CAST(1 AS NUMERIC(10,2)) AS QTY,
             ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0)+ ISNULL(OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) AS NET_AMOUNT  ,
             ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0)  AS TAXABLE_VALUE,
             A.OTHER_CHARGES_IGST_AMOUNT AS IGST_AMOUNT,
             A.OTHER_CHARGES_CGST_AMOUNT AS CGST_AMOUNT,
             A.OTHER_CHARGES_SGST_AMOUNT AS SGST_AMOUNT,
             CAST(0 AS NUMERIC(10,2)) AS CESS_AMOUNT,
             CAST('' AS VARCHAR(100)) AS PRODUCT_CODE,
             a.rcm_applicable,
			 A.OTHER_CHARGES_GST_PERCENTAGE AS RATE
      INTO #TMPHSNDETAILS
      FROM pim01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =CASE WHEN ISNULL(A.PUR_FOR_DEPT_ID,'')<>'' 
	  THEN PUR_FOR_DEPT_ID ELSE  A.location_Code END 
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      LEFT JOIN LMP01106 LMP  (NOLOCK) ON LMP.AC_CODE =A.ac_code 
      LEFT JOIN location SL ON SL.dept_id =A.challan_source_location_code
      WHERE A.CANCELLED =0
      AND A.BILL_DT BETWEEN @DFMDATE AND @DTODATE
     -- AND (@CDEPT_ID='' OR LEFT (A.CM_ID,2)=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND (@CDEPT_ID='' OR b.dept_id=@CDEPT_ID)
      AND LMP.AC_GST_NO <>CASE WHEN A.INV_MODE =1 THEN B.LOC_GST_NO ELSE b.LOC_GST_NO END
      and ISNULL(LMP.AC_GST_NO,'')<>''
      AND ISNULL(A.BILL_CHALLAN_MODE,0)=0
      union all
       
      SELECT CAST('PUR' AS VARCHAR(100)) AS XN_TYPE,
             CAST(A.mrr_id  AS VARCHAR(100)) AS MEMO_ID,
             A.freight_HSN_CODE AS HSN_CODE,
             CAST(1 AS NUMERIC(10,2)) AS QTY,
             ISNULL(A.freight_TAXABLE_VALUE,0)+ ISNULL(freight_IGST_AMOUNT ,0)+ISNULL(freight_CGST_AMOUNT,0)+ISNULL(freight_SGST_AMOUNT,0) AS NET_AMOUNT  ,
             ISNULL(A.freight_TAXABLE_VALUE,0)  AS TAXABLE_VALUE,
             A.freight_IGST_AMOUNT AS IGST_AMOUNT,
             A.freight_CGST_AMOUNT AS CGST_AMOUNT,
             A.freight_SGST_AMOUNT AS SGST_AMOUNT,
             CAST(0 AS NUMERIC(10,2)) AS CESS_AMOUNT,
             CAST('' AS VARCHAR(100)) AS PRODUCT_CODE,
             a.rcm_applicable ,
			 A.freight_gst_percentage AS RATE
      FROM pim01106 A (NOLOCK)
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =CASE WHEN ISNULL(A.PUR_FOR_DEPT_ID,'')<>'' 
	  THEN PUR_FOR_DEPT_ID ELSE  A.location_Code END 
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
      LEFT JOIN LMP01106 LMP  (NOLOCK) ON LMP.AC_CODE =A.ac_code 
      LEFT JOIN location SL ON SL.dept_id =A.challan_source_location_code
      WHERE A.CANCELLED =0
      AND A.BILL_DT  BETWEEN @DFMDATE AND @DTODATE
     -- AND (@CDEPT_ID='' OR LEFT (A.CM_ID,2)=@CDEPT_ID)
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND ISNULL(A.freight_gst_percentage ,0)>0
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND (@CDEPT_ID='' OR b.dept_id=@CDEPT_ID)
       AND LMP.AC_GST_NO <>CASE WHEN A.INV_MODE =1 THEN B.LOC_GST_NO ELSE b.LOC_GST_NO END
      and ISNULL(LMP.AC_GST_NO,'')<>''
      AND ISNULL(A.BILL_CHALLAN_MODE,0)=0
 
      INSERT INTO #TMPHSNDETAILS(XN_TYPE,MEMO_ID,HSN_CODE,QTY,NET_AMOUNT,TAXABLE_VALUE,IGST_AMOUNT,CGST_AMOUNT,SGST_AMOUNT,CESS_AMOUNT,PRODUCT_CODE,rcm_applicable,RATE )
      SELECT 'pur' AS XN_TYPE,
             A.mrr_id AS MEMO_ID,
             pid.HSN_CODE AS HSN_CODE,
             CAST(pid.QUANTITY  AS NUMERIC(10,2)) AS QTY,
             ISNULL(pid.XN_VALUE_WITH_GST,0)  AS NET_AMOUNT,
             ISNULL(pid.XN_VALUE_WITHOUT_GST,0)  AS TAXABLE_VALUE,
             pid.IGST_AMOUNT AS IGST_AMOUNT,
             pid.CGST_AMOUNT AS CGST_AMOUNT,
             pid.SGST_AMOUNT AS SGST_AMOUNT,
             CAST(pid.Gst_Cess_Amount AS NUMERIC(10,2)) AS CESS_AMOUNT,
             pid.PRODUCT_CODE  AS PRODUCT_CODE ,
             a.rcm_applicable,
			 PID.gst_percentage
      FROM pim01106  A (NOLOCK)
      JOIN pid01106  pid (NOLOCK) ON A.mrr_id =pid.mrr_id
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =CASE WHEN ISNULL(A.PUR_FOR_DEPT_ID,'')<>'' 
	  THEN PUR_FOR_DEPT_ID ELSE  A.location_Code END 
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
	  LEFT JOIN LMP01106 LMP  (NOLOCK) ON LMP.AC_CODE =A.ac_code 
      LEFT JOIN location SL ON SL.dept_id =A.challan_source_location_code
	  JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID') LOC ON 1=1
      JOIN (SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID') HO ON 1=1 
      WHERE A.CANCELLED =0 
      AND A.BILL_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND (@CDEPT_ID='' OR b.dept_id=@CDEPT_ID)
      AND LMP.AC_GST_NO <>CASE WHEN A.INV_MODE =1 THEN B.LOC_GST_NO ELSE b.LOC_GST_NO END
      and ISNULL(LMP.AC_GST_NO,'')<>''
      AND ISNULL(A.BILL_CHALLAN_MODE,0)=0
      and ISNULL(A.RCM_APPLICABLE,0)=0 AND (a.inv_mode IN (0,1) OR loc.value<>ho.value)

	   INSERT INTO #TMPHSNDETAILS(XN_TYPE,MEMO_ID,HSN_CODE,QTY,NET_AMOUNT,TAXABLE_VALUE,IGST_AMOUNT,CGST_AMOUNT,SGST_AMOUNT,CESS_AMOUNT,PRODUCT_CODE,rcm_applicable,RATE )
      SELECT 'pur' AS XN_TYPE,
             A.mrr_id AS MEMO_ID,
             ind.HSN_CODE AS HSN_CODE,
             CAST(ind.QUANTITY  AS NUMERIC(10,2)) AS QTY,
             ISNULL(ind.XN_VALUE_WITH_GST,0)  AS NET_AMOUNT,
             ISNULL(ind.XN_VALUE_WITHOUT_GST,0)  AS TAXABLE_VALUE,
             ind.IGST_AMOUNT AS IGST_AMOUNT,
             ind.CGST_AMOUNT AS CGST_AMOUNT,
             ind.SGST_AMOUNT AS SGST_AMOUNT,
             CAST(ind.Gst_Cess_Amount AS NUMERIC(10,2)) AS CESS_AMOUNT,
             ind.PRODUCT_CODE  AS PRODUCT_CODE ,
             a.rcm_applicable,
			 ind.gst_percentage
      FROM pim01106  A (NOLOCK)
      JOIN ind01106  ind (NOLOCK) ON A.inv_id =ind.inv_id
	  join inm01106 inm (nolock) on ind.inv_id =inm.inv_id 
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =CASE WHEN ISNULL(A.PUR_FOR_DEPT_ID,'')<>'' 
	  THEN PUR_FOR_DEPT_ID ELSE  A.location_Code END 
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
	  LEFT JOIN LMP01106 LMP  (NOLOCK) ON LMP.AC_CODE =A.ac_code 
      LEFT JOIN location SL ON SL.dept_id =A.challan_source_location_code
      WHERE A.CANCELLED =0 
      AND A.BILL_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND (@CDEPT_ID='' OR b.dept_id=@CDEPT_ID)
      AND LMP.AC_GST_NO <>CASE WHEN A.INV_MODE =1 THEN B.LOC_GST_NO ELSE b.LOC_GST_NO END
      and ISNULL(LMP.AC_GST_NO,'')<>''
      AND ISNULL(A.BILL_CHALLAN_MODE,0)=0
      and ISNULL(A.RCM_APPLICABLE,0)=0 AND a.inv_mode=2 and inm.CANCELLED =0




      union all
       SELECT 'pur' AS XN_TYPE,
             A.mrr_id AS MEMO_ID,
             pid.HSN_CODE AS HSN_CODE,
             CAST(pid.QUANTITY  AS NUMERIC(10,2)) AS QTY,
             ISNULL(pid.rcm_taxable_value,0)+ISNULL(pid.rcm_igst_amount,0)+ ISNULL(pid.rcm_cgst_amount,0)+ISNULL(pid.rcm_sgst_amount,0) AS NET_AMOUNT,
             ISNULL(pid.rcm_taxable_value,0)  AS TAXABLE_VALUE,
             pid.rcm_igst_amount AS IGST_AMOUNT,
             pid.rcm_CGST_AMOUNT AS CGST_AMOUNT,
             pid.rcm_SGST_AMOUNT AS SGST_AMOUNT,
             CAST(0 AS NUMERIC(10,2)) AS CESS_AMOUNT,
             pid.PRODUCT_CODE  AS PRODUCT_CODE ,
             a.rcm_applicable ,
			 PID.rcm_gst_percentage
      FROM pim01106  A (NOLOCK)
      JOIN pid01106  pid (NOLOCK) ON A.mrr_id =pid.mrr_id
      JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =CASE WHEN ISNULL(A.PUR_FOR_DEPT_ID,'')<>'' 
	  THEN PUR_FOR_DEPT_ID ELSE  A.location_Code END 
      JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
	  LEFT JOIN LMP01106 LMP  (NOLOCK) ON LMP.AC_CODE =A.ac_code 
      LEFT JOIN location SL ON SL.dept_id =A.challan_source_location_code
      WHERE A.CANCELLED =0 
      AND A.BILL_DT  BETWEEN @DFMDATE AND @DTODATE
      AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
      AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND (@CDEPT_ID='' OR b.dept_id=@CDEPT_ID)
      AND LMP.AC_GST_NO <>CASE WHEN A.INV_MODE =1 THEN B.LOC_GST_NO ELSE b.LOC_GST_NO END
      AND ISNULL(A.BILL_CHALLAN_MODE,0)=0
      and ISNULL(A.RCM_APPLICABLE,0)=1



     --JOBWORK (as Per discuss with ved ji Client Roopkala Remove jwr 22-11-2021)
   --    INSERT INTO #TMPHSNDETAILS(XN_TYPE,MEMO_ID,HSN_CODE,QTY,NET_AMOUNT,TAXABLE_VALUE,IGST_AMOUNT,CGST_AMOUNT,SGST_AMOUNT,CESS_AMOUNT,PRODUCT_CODE,RATE)
       
   --    SELECT 'JWR' AS XN_TYPE,
   --          A.receipt_id  AS MEMO_ID,
   --          JWR.HSN_CODE AS HSN_CODE,
   --          CAST(JWR.QUANTITY  AS NUMERIC(10,2)) AS QTY,
   --          ISNULL(JWR.XN_VALUE_WITH_GST,0)  AS NET_AMOUNT,
   --          ISNULL(JWR.XN_VALUE_WITHOUT_GST,0)  AS TAXABLE_VALUE,
   --          JWR.IGST_AMOUNT AS IGST_AMOUNT,
   --          JWR.CGST_AMOUNT AS CGST_AMOUNT,
   --          JWR.SGST_AMOUNT AS SGST_AMOUNT,
   --          CAST(jwr.Gst_Cess_Amount AS NUMERIC(10,2)) AS CESS_AMOUNT,
   --         JWR.PRODUCT_CODE  AS PRODUCT_CODE ,
			-- JWR.gst_percentage
   --   FROM jobwork_receipt_mst   A (NOLOCK)
   --   JOIN jobwork_receipt_det   JWR (NOLOCK) ON A.receipt_id  =JWR.receipt_id
   --   JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =LEFT (A.receipt_id ,2)
   --   JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE 
	  --LEFT OUTER JOIN HSN_MST HM ON HM.HSN_CODE =JWR .HSN_CODE 
   --   WHERE A.CANCELLED =0 AND ISNULL(TAXABLE_ITEM,0)=1
	  --AND ISNULL(A.BILL_CHALLAN_MODE,0)=0
   --   AND A.challan_dt   BETWEEN @DFMDATE AND @DTODATE
   --   AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
   --   AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
   --   AND (@CDEPT_ID='' OR LEFT(A.receipt_id ,2)=@CDEPT_ID)
   --   AND  ISNULL(IGST_AMOUNT,0)+ISNULL(CGST_AMOUNT,0)+ISNULL(SGST_AMOUNT,0)<>0
      

	  INSERT INTO #TMPHSNDETAILS(XN_TYPE,MEMO_ID,HSN_CODE,QTY,NET_AMOUNT,TAXABLE_VALUE,IGST_AMOUNT,CGST_AMOUNT,SGST_AMOUNT,CESS_AMOUNT,PRODUCT_CODE,RATE)
       
     select 'supp' AS XN_TYPE,
             A.memo_id  AS MEMO_ID,
             det.HSN_CODE AS HSN_CODE,
             CAST(det.QUANTITY  AS NUMERIC(10,2)) AS QTY,
             ISNULL(det.XN_VALUE_WITH_GST,0)  AS NET_AMOUNT,
             ISNULL(det.XN_VALUE_WITHOUT_GST,0)  AS TAXABLE_VALUE,
             det.IGST_AMOUNT AS IGST_AMOUNT,
             det.CGST_AMOUNT AS CGST_AMOUNT,
             det.SGST_AMOUNT AS SGST_AMOUNT,
             CAST(0 AS NUMERIC(10,2)) AS CESS_AMOUNT,
             ''  AS PRODUCT_CODE ,
			 DET.gst_percentage
     FROM SUPPLY_EXPENSE_XN_MST  A (NOLOCK)
	 JOIN SUPPLY_EXPENSE_XN_DET DET (NOLOCK) ON A.MEMO_ID  =DET.MEMO_ID  
	 JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =A.DEPT_ID
	 JOIN GST_STATE_MST C (NOLOCK)  ON B.GST_STATE_CODE =C.GST_STATE_CODE
	 JOIN GST_STATE_MST PS (NOLOCK)  ON PS.GST_STATE_CODE =A.PARTY_STATE_CODE 
	 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =A.AC_CODE 
	 JOIN LMP01106 LMP (NOLOCK) ON LMP.AC_CODE =LM.AC_CODE 
	 WHERE A.CANCELLED =0 
	 AND A.bill_dt   BETWEEN @DFMDATE AND @DTODATE
     AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
     AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
     AND (@CDEPT_ID='' OR A.location_Code=@CDEPT_ID)
     AND  ISNULL(IGST_AMOUNT,0)+ISNULL(CGST_AMOUNT,0)+ISNULL(SGST_AMOUNT,0)<>0
           
      
  
	  --B2CS WHOSALE CREDIT NOTE
	  
     INSERT INTO #TMPHSNDETAILS(XN_TYPE,MEMO_ID,HSN_CODE,QTY,NET_AMOUNT,TAXABLE_VALUE,IGST_AMOUNT,CGST_AMOUNT,SGST_AMOUNT,CESS_AMOUNT,PRODUCT_CODE,RATE)
	     SELECT 
             CAST('PRT' AS VARCHAR(100)) AS XN_TYPE,
             A.rm_id  AS MEMO_ID,
             A.OTHER_CHARGES_HSN_CODE AS HSN_CODE,
             -(1)*CAST(1 AS NUMERIC(10,2)) AS QTY,
             -(1)*ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE ,0)+ ISNULL(OTHER_CHARGES_IGST_AMOUNT ,0)+ISNULL(OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(OTHER_CHARGES_SGST_AMOUNT,0) AS NET_AMOUNT ,
            -(1)* ISNULL(A.OTHER_CHARGES_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
            -(1)* A.OTHER_CHARGES_IGST_AMOUNT AS IGST_AMOUNT,
           -(1)*A.OTHER_CHARGES_CGST_AMOUNT AS CGST_AMOUNT,
            -(1)* A.OTHER_CHARGES_SGST_AMOUNT AS SGST_AMOUNT,
             CAST(0 AS NUMERIC(10,2)) AS CESS_AMOUNT,
             CAST('' AS VARCHAR(100)) AS PRODUCT_CODE,
			 A.OTHER_CHARGES_GST_PERCENTAGE
       FROM rmm01106  A (NOLOCK)
       JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =CASE WHEN ISNULL(A.ACCOUNTS_DEPT_ID,'')<>'' THEN ISNULL(A.ACCOUNTS_DEPT_ID,'') ELSE   LEFT (A.RM_ID,2) END 
	   JOIN GST_STATE_MST LS (NOLOCK)  ON LS.GST_STATE_CODE  =B.GST_STATE_CODE
	   LEFT OUTER JOIN LMP01106 LMP (NOLOCK)  ON LMP.AC_CODE =A.AC_CODE
       LEFT JOIN GST_STATE_MST LMPS (NOLOCK)  ON LMPS.GST_STATE_CODE  =A.PARTY_STATE_CODE
	   LEFT OUTER JOIN LOCATION RML (NOLOCK) ON RML.DEPT_ID =A.PARTY_DEPT_ID 
       WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
       --AND A.CN_TYPE=1
	   AND (CASE WHEN ISNULL(A.GST_ITC_DT,'')<>'' THEN A.GST_ITC_DT ELSE A.RM_DT END )  BETWEEN @DFMDATE AND @DTODATE
	   AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
	   AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
	   -- AND  ISNULL(CASE WHEN A.MODE=1 THEN  LMP.AC_GST_NO ELSE  ISNULL(RML.LOC_GST_NO,'') END,'') =''
       AND ISNULL(CASE WHEN A.MODE=1 THEN  LMP.AC_GST_NO ELSE ISNULL(RML.LOC_GST_NO,'') END,'')<> B.LOC_GST_NO
       AND ISNULL(A.OTHER_CHARGES_GST_PERCENTAGE,0)>0
       AND (@CDEPT_ID='' OR b.dept_id=@CDEPT_ID)
	   and ISNULL(a.bill_challan_mode,0)=0
	  -- AND A.TOTAL_AMOUNT<250000
      UNION ALL
       SELECT CAST('PRT' AS VARCHAR(100)) AS XN_TYPE,
             A.rm_id   AS MEMO_ID,
             A.FREIGHT_HSN_CODE AS HSN_CODE,
            -(1)* CAST(1 AS NUMERIC(10,2)) AS QTY,
            -(1)* ISNULL(A.FREIGHT_TAXABLE_VALUE ,0)+ ISNULL(FREIGHT_IGST_AMOUNT ,0)+ISNULL(FREIGHT_CGST_AMOUNT,0)+ISNULL(FREIGHT_SGST_AMOUNT,0) AS NET_AMOUNT ,
            -(1)* ISNULL(A.FREIGHT_TAXABLE_VALUE,0) AS TAXABLE_VALUE,
             -(1)*A.FREIGHT_IGST_AMOUNT AS IGST_AMOUNT,
            -(1)* A.FREIGHT_CGST_AMOUNT AS CGST_AMOUNT,
            -(1)* A.FREIGHT_SGST_AMOUNT AS SGST_AMOUNT,
             CAST(0 AS NUMERIC(10,2)) AS CESS_AMOUNT,
             CAST('' AS VARCHAR(100)) AS PRODUCT_CODE,
			 A.FREIGHT_GST_PERCENTAGE
       FROM RMM01106 A (NOLOCK)
       JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =CASE WHEN ISNULL(A.ACCOUNTS_DEPT_ID,'')<>'' 
	   THEN ISNULL(A.ACCOUNTS_DEPT_ID,'') ELSE   A.location_Code END 
	   JOIN GST_STATE_MST LS (NOLOCK)  ON LS.GST_STATE_CODE  =B.GST_STATE_CODE
	   LEFT OUTER JOIN LMP01106 LMP (NOLOCK)  ON LMP.AC_CODE =A.AC_CODE
       LEFT JOIN GST_STATE_MST LMPS (NOLOCK)  ON LMPS.GST_STATE_CODE  =LMP.AC_GST_STATE_CODE
	   LEFT OUTER JOIN LOCATION RML (NOLOCK) ON RML.DEPT_ID =A.PARTY_DEPT_ID 
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      --AND A.CN_TYPE=1
	  AND (CASE WHEN ISNULL(A.GST_ITC_DT,'')<>'' THEN A.GST_ITC_DT ELSE A.RM_DT END )  BETWEEN @DFMDATE AND @DTODATE
	  AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
	  AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND ISNULL(CASE WHEN A.MODE=1 THEN  LMP.AC_GST_NO ELSE ISNULL(RML.LOC_GST_NO,'') END,'')<> B.LOC_GST_NO
      AND ISNULL(A.FREIGHT_GST_PERCENTAGE,0)>0
	 -- AND A.TOTAL_AMOUNT<250000
	  AND (@CDEPT_ID='' OR b.dept_id =@CDEPT_ID)
	  and ISNULL(a.bill_challan_mode,0)=0
    
      UNION ALL
      SELECT 'PRT' AS XN_TYPE,
             A.rm_id  AS MEMO_ID,
             RMD.HSN_CODE AS HSN_CODE,
             -(1)*CAST(RMD.QUANTITY  AS NUMERIC(10,2)) AS QTY,
             -(1)* ISNULL(RMD.XN_VALUE_WITH_GST,0)  AS NET_AMOUNT ,
            -(1)* ISNULL(RMD.XN_VALUE_WITHOUT_GST,0)  AS TAXABLE_VALUE,
             -(1)*RMD.IGST_AMOUNT AS IGST_AMOUNT,
             -(1)*RMD.CGST_AMOUNT AS CGST_AMOUNT,
             -(1)*RMD.SGST_AMOUNT AS SGST_AMOUNT,
             CAST(rmd.Gst_Cess_Amount AS NUMERIC(10,2)) AS CESS_AMOUNT,
             RMD.PRODUCT_CODE  AS PRODUCT_CODE,
			 RMD.gst_percentage
       FROM RMM01106 A (NOLOCK)
	   JOIN RMD01106 RMD (NOLOCK) ON A.rm_id =RMD.rm_id  
       JOIN LOCATION B (NOLOCK) ON B.DEPT_ID =CASE WHEN ISNULL(A.ACCOUNTS_DEPT_ID,'')<>'' 
	   THEN ISNULL(A.ACCOUNTS_DEPT_ID,'') ELSE   A.location_Code END 
	   JOIN GST_STATE_MST LS (NOLOCK)  ON LS.GST_STATE_CODE  =B.GST_STATE_CODE
	   LEFT OUTER JOIN LMP01106 LMP (NOLOCK)  ON LMP.AC_CODE =A.AC_CODE
       LEFT JOIN GST_STATE_MST LMPS (NOLOCK)  ON LMPS.GST_STATE_CODE  =LMP.AC_GST_STATE_CODE
	   LEFT OUTER JOIN LOCATION RML (NOLOCK) ON RML.DEPT_ID =A.PARTY_DEPT_ID 
      WHERE A.CANCELLED =0 AND ISNULL(A.MEMO_TYPE,0) IN(0,1)
      --AND A.CN_TYPE=1
	  AND (CASE WHEN ISNULL(A.GST_ITC_DT,'')<>'' THEN A.GST_ITC_DT ELSE A.RM_DT END )  BETWEEN @DFMDATE AND @DTODATE
	  AND (@CGSTN_NO='' OR B.LOC_GST_NO=@CGSTN_NO)
	  AND (@CLOC_TYPE=0 OR ISNULL(B.LOC_TYPE,0) =@CLOC_TYPE)
      AND ISNULL(CASE WHEN A.MODE=1 THEN  LMP.AC_GST_NO ELSE ISNULL(RML.LOC_GST_NO,'') END,'')<> B.LOC_GST_NO
      AND (@CDEPT_ID='' OR b.dept_id=@CDEPT_ID)
	  and ISNULL(a.bill_challan_mode,0)=0

	   --DROP TABLE TMPHSNDETAILS
    --      SELECT * INTO TMPHSNDETAILS FROM #TMPHSNDETAILS
      
       IF OBJECT_ID('TEMPDB..#TMPHSNSUMMARY','U') IS NOT NULL
           DROP TABLE #TMPHSNSUMMARY
           
           SELECT A.XN_TYPE,A.MEMO_ID,
		          CASE WHEN UOM.UOM_NAME IS NULL THEN 'OTH-OTHERS' ELSE ISNULL(GST_UOM_NAME,'') END AS UOM_NAME ,
                  --ISNULL(UOM.UOM_NAME,'OTH-OTHERS') AS UOM_NAME ,
                  A.HSN_CODE,
                  ISNULL(HM.DESCRIPTIONS,'')  AS DESCR,
                  A.QTY,A.NET_AMOUNT,A.TAXABLE_VALUE,
                  A.IGST_AMOUNT,A.CGST_AMOUNT,A.SGST_AMOUNT,A.CESS_AMOUNT,A.PRODUCT_CODE,
                  SR=ROW_NUMBER() OVER (PARTITION BY XN_TYPE,MEMO_ID,A.HSN_CODE,ISNULL(UOM.UOM_NAME,'') ORDER BY MEMO_ID),
                  RCM_APPLICABLE,RATE
           INTO #TMPHSNSUMMARY
           FROM #TMPHSNDETAILS A
           JOIN HSN_MST HM ON HM.HSN_CODE =A.HSN_CODE 
           LEFT JOIN SKU (NOLOCK) ON SKU .PRODUCT_CODE =A.PRODUCT_CODE 
           LEFT JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE =SKU .ARTICLE_CODE 
           --LEFT OUTER JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =ART.SUB_SECTION_CODE
           LEFT JOIN UOM (NOLOCK) ON UOM.UOM_CODE =ART.UOM_CODE 
           
 
      
        
           
           
          IF ISNULL(@NGSTR3B,0)=1
          BEGIN
              
              SELECT * 
              FROM #TMPHSNSUMMARY
              RETURN
          
          END
          
           SELECT 'HSN' AS RTYPE,
                  A.HSN_CODE AS HSN,
                  ISNULL(CAST(A.DESCR AS VARCHAR(100)),'') AS [DESCRIPTION] ,
                  A.UOM_NAME AS UQC,
                  SUM(A.QTY) AS [TOTAL QUANTITY],
                  SUM(A.NET_AMOUNT) AS [TOTAL VALUE],
                  SUM(A.TAXABLE_VALUE) AS [TAXABLE VALUE],
                  SUM(A.IGST_AMOUNT) AS [INTEGRATED TAX AMOUNT],
                  SUM(A.CGST_AMOUNT) AS [CENTRAL TAX AMOUNT],
                  SUM(A.SGST_AMOUNT) AS [STATE/UT TAX AMOUNT],
                  SUM(isnull(A.CESS_AMOUNT,0)) AS [CESS AMOUNT]   
           FROM #TMPHSNSUMMARY A
           GROUP BY A.HSN_CODE,A.UOM_NAME,A.DESCR 
		   HAVING  SUM(A.TAXABLE_VALUE) <>0
           ORDER BY  A.UOM_NAME,A.HSN_CODE
           
        
           
           SELECT 'HSN' AS RTYPE,
		          COUNT(DISTINCT HSN_CODE) AS [NO. OF HSN],
                  SUM(A.QTY) AS [TOTAL QUANTITY],
                  SUM(A.NET_AMOUNT) AS [TOTAL VALUE],
                  SUM(A.TAXABLE_VALUE) AS [TOTAL TAXABLE VALUE],
                  SUM(A.IGST_AMOUNT) AS [TOTAL INTEGRATED TAX],
                  SUM(A.CGST_AMOUNT) AS [TOTAL CENTRAL TAX],
                  SUM(A.SGST_AMOUNT) AS [TOTAL STATE/UT TAX],
                  SUM(isnull(A.CESS_AMOUNT,0)) AS [TOTAL CESS]   
           FROM #TMPHSNSUMMARY A
           JOIN
           (
            SELECT SUM(NET_AMOUNT) AS NET_AMOUNT
            FROM 
            (
            SELECT DISTINCT XN_TYPE,NET_AMOUNT
            FROM #TMPHSNSUMMARY
            ) A
           ) B ON 1=1

END





