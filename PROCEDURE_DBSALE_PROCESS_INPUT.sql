CREATE PROCEDURE DBSALE_PROCESS_INPUT(
 @USERCODE VARCHAR(10)
,@REP_FILTER VARCHAR(MAX)=''
,@SNGL INT=0
,@REV_FILTER VARCHAR(MAX) OUTPUT
,@CDATE VARCHAR(20)OUTPUT
,@LDATE VARCHAR(20)OUTPUT
,@LOC VARCHAR(MAX) OUTPUT
)
AS
BEGIN
   SET NOCOUNT ON
   DECLARE @RAW_FILTER VARCHAR(MAX),@SUB VARCHAR(MAX),@FLTR VARCHAR(MAX),@MYSQL VARCHAR(MAX)
   --EXEC DBSALE_PR_FORM_FLTR @USERCODE,@REP_FILTER, @RAW_FILTER OUTPUT;
   --IF @RAW_FILTER='AND (   )' SET @RAW_FILTER=''
   SET @RAW_FILTER='AND (  CAST(CM_DT AS DATE) = '''+REPLACE(CONVERT(VARCHAR,DATEADD(DD,-1,GETDATE()),102),'.','-')+''' )'
   PRINT 'RAW FILTER '+@RAW_FILTER
   IF ISNULL(@RAW_FILTER,'') !='' SET @RAW_FILTER=LTRIM(RTRIM(@RAW_FILTER))+' AND' ELSE RETURN
   
   SET @RAW_FILTER=REPLACE(@RAW_FILTER,'<>','!=')
   SET @RAW_FILTER=REPLACE(REPLACE(REPLACE(REPLACE(@RAW_FILTER,' ','<>'),'><',''),'<>',' '),' = ','=')
   SET @REV_FILTER=''
   WHILE RIGHT(@RAW_FILTER,3)='AND'
     BEGIN
         SET @FLTR=SUBSTRING(@RAW_FILTER,1,CHARINDEX('AND',@RAW_FILTER,2)-2)
         SET @RAW_FILTER=LTRIM(RTRIM(REPLACE(@RAW_FILTER,@FLTR,'')))
         --FILTER CONTAINS CM DT
         IF @FLTR LIKE '%CM_DT%' AND @SNGL<>2
            BEGIN
              SELECT @FLTR=REPLACE(@FLTR,'CM_DT<=','CM_DT=')
			  ,@CDATE=SUBSTRING(@FLTR,CHARINDEX('=''',@FLTR)+2,10)
			  ,@LDATE=DBO.GET_REPORT_DATE(SUBSTRING(@FLTR,CHARINDEX('=''',@FLTR)+2,10),'LRD')
			  SET @FLTR=REPLACE(REPLACE(@FLTR,'='''+@CDATE+''' )','')+' BETWEEN ''''1900-01-01'''' AND ''''1900-01-02'''')','CM_DT','A.CM_DT')
			  SELECT @CDATE=''''+@CDATE+'''',@LDATE=''''+@LDATE+''''
			END
		 ELSE IF @FLTR LIKE '%CM_DT%' AND @SNGL=2
			BEGIN
			   SET @LDATE=SUBSTRING(@FLTR,CHARINDEX('''',@FLTR,1)+1,10)
			   SET @CDATE=''''+SUBSTRING(@FLTR,CHARINDEX('''',@FLTR,1)+1,10)+''''
			   SET @LDATE=''''+CONVERT(VARCHAR,LEFT(@LDATE,4)-1)+SUBSTRING(@LDATE,5,6)+''''
			   SET @FLTR=REPLACE(@FLTR,'''','''')
			END
			
		 --FILTER CONTAINS LOCATIONS		
         ELSE IF @FLTR LIKE '%DEPT_ID%'
            BEGIN
				IF CHARINDEX('Fn_SPLIT',@FLTR)>0
				   BEGIN
				      IF OBJECT_ID('tempdb..#SPLITTED_VALUES') IS NOT NULL DROP TABLE #SPLITTED_VALUES
				      CREATE TABLE #SPLITTED_VALUES(VAL VARCHAR(100))
				      SET @LOC=LTRIM(RTRIM(LEFT(@FLTR,CHARINDEX('SELECT VALUE',@FLTR)-1))) 
				      SET @MYSQL='INSERT #SPLITTED_VALUES '+SUBSTRING(@FLTR,CHARINDEX('SELECT VALUE',@FLTR)+0,CHARINDEX(''','')',@FLTR)-CHARINDEX('SELECT VALUE',@FLTR)+5)
				      EXEC(@MYSQL)
				      IF @SNGL=0
				         SELECT @LOC=COALESCE(@LOC,'')+''''''+VAL+''''',' FROM #SPLITTED_VALUES
				      ELSE IF @SNGL=1
				         SELECT @LOC=COALESCE(@LOC,'')+''''+VAL+''',' FROM #SPLITTED_VALUES 
                      ELSE IF @SNGL=2
                      SELECT @LOC=COALESCE(@LOC,'')+''''+VAL+''',' FROM #SPLITTED_VALUES				         
				      SET @LOC=RTRIM(@LOC)
				      IF RIGHT(@LOC,1)=',' SET @LOC=REPLACE(LEFT(@LOC,LEN(@LOC)-1),'DEPT_ID','a.location_code')
				      SET @LOC+='))'
				      SET @FLTR=@LOC
				   END
				ELSE
				   BEGIN
				      SET @LOC=REPLACE(@FLTR,',',''',''')
				      IF @SNGL=0
				         SET @FLTR=REPLACE(REPLACE(REPLACE(@FLTR,',',''','''),'DEPT_ID','a.location_code'),'''','''''')
				      ELSE IF @SNGL=1
				         SET @FLTR=REPLACE(REPLACE(@FLTR,',',''','''),'DEPT_ID','a.location_code')
				      ELSE IF @SNGL=2
				         SET @FLTR=''
				   END   
            END   
            
         --OTHERWISE   
         ELSE    
            IF @SNGL=0
               SET @FLTR=REPLACE(@FLTR,'''','''''')
   
         SET @REV_FILTER+=' '+@FLTR   
         IF LTRIM(RTRIM(@RAW_FILTER))='AND'
            BREAK
     END
   SELECT @REV_FILTER=LTRIM(ISNULL(@REV_FILTER,''))
   --,@CDATE=ISNULL(@CDATE,''''+REPLACE(CONVERT(VARCHAR,GETDATE(),102),'.','-')+'''')
   --,@LDATE=ISNULL(@LDATE,''''+REPLACE(CONVERT(VARCHAR,GETDATE(),102),'.','-')+'''')
   ,@CDATE=ISNULL(@CDATE,'')
   ,@LDATE=ISNULL(@LDATE,'')
   SET NOCOUNT OFF
END