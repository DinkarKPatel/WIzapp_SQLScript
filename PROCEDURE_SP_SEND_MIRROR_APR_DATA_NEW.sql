CREATE PROCEDURE SP_SEND_MIRROR_APR_DATA_NEW --(LocId 3 digit change only increased the parameter width by Sanjay:01-11-2024)
(   
  @CUPLOADEDXNID VARCHAR(50)  
 ,@CCURLOCID VARCHAR(4)   
  ,@BACKNOWLEDGE BIT =0    
 ,@CERRMSG VARCHAR(1000) OUTPUT  
)   
--WITH ENCRYPTION  
AS  
/*  
 SP_SEND_MIRROR_APR_DATA_NEW_208_05_02_14 : THIS PROCEDURE WILL SEND APPROVAL RETURN DATA FROM LOCATION TO HO.  
*/  
BEGIN  
 DECLARE @DTSQL NVARCHAR(MAX),@CSPID VARCHAR(10),@CTEMPTABLE VARCHAR(500),@CMEMOID VARCHAR(50),  
 @CTEMPMASTERTABLE VARCHAR(200),@CTEMPLMTABLE VARCHAR(200),@CTEMPLMPTABLE VARCHAR(200)  
 ,@CTEMPAREATABLE VARCHAR(200),@CTEMPCITYTABLE VARCHAR(200),@CTEMPCUSTABLE VARCHAR(200)  
 ,@DMEMOLASTUPDATE DATETIME,@CTABLENAME VARCHAR(100),@BRECFOUND BIT,@CSTEP VARCHAR(5),@CFILTERCONDITION VARCHAR(MAX)  
 ,@CKEYFIELD VARCHAR(100)  
  
 DECLARE @TXNSSENDINFO TABLE (ORG_TABLENAME VARCHAR(50),TMP_TABLENAME VARCHAR(50),XN_ID VARCHAR(40))     
BEGIN TRY    
  
   
 DECLARE @CTEMPDBNAME VARCHAR(40)  
 set @CTEMPDBNAME=''
     
 ---- CALL ACKNOWLEDGEMENT OF MEMO SUCCESSFUL MERGING AT MIRRORING SERVER    
   
 SET @CSTEP=30  
/*APPROVAL_RETURN_MST,APPROVAL_RETURN_DET,CUSTDYM,LM01106,LMP01106,AREA,HD01106,CITY,STATE*/  
   
 --CHNAGE BY BAIJNATH  
 SET @CMEMOID=@CUPLOADEDXNID  
  
 SET @CSTEP=40  
 ---- IF NO MEMO FOUND , JUST END THE PROCESS  
 IF ISNULL(@CMEMOID,'')=''  
  GOTO END_PROC  
LBLTABLEINFO:  
 
 ---- SEND THE APR MEMO MASTER TABLE  
 SELECT A.*, 'APR_APPROVAL_RETURN_MST_UPLOAD' AS TARGET_TABLENAME FROM APPROVAL_RETURN_MST A (NOLOCK)
 WHERE MEMO_ID=@CMEMOID
   
 SET @CSTEP=230  
 ---- SEND THE APR MEMO DETAIL TABLE  
  SELECT A.*, 'APR_APPROVAL_RETURN_DET_UPLOAD' AS TARGET_TABLENAME FROM APPROVAL_RETURN_DET A (NOLOCK)
 WHERE MEMO_ID=@CMEMOID
 
  SET @CSTEP=271
 ---- SEND THE PMT01106 TABLE  
 
  SELECT DISTINCT 'APR_PMT01106_UPLOAD' AS TARGET_TABLENAME, @CMEMOID AS APR_MEMO_ID ,A.DEPT_ID,A.product_code,A.BIN_ID,A.quantity_in_stock  
  FROM PMT01106 A (NOLOCK)  
  JOIN APPROVAL_RETURN_DET B (NOLOCK) ON B.APD_product_code=A.product_code
  WHERE B.MEMO_ID=@CMEMOID 
       

/*APPROVAL_RETURN_MST,APPROVAL_RETURN_DET,CUSTDYM,LM01106,LMP01106,AREA,HD01106,CITY,STATE*/  
   
 GOTO END_PROC  
    
  
END TRY  
BEGIN CATCH  
 SET @CERRMSG='P: SP_SEND_MIRROR_APR_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()  
 GOTO END_PROC  
END CATCH     
END_PROC:  

END  
---END OF PROCEDURE - SP_SEND_MIRROR_APR_DATA_NEW  