CREATE PROCEDURE SP_SEND_MIRROR_PFI_DATA_NEW
(
	 @CUPLOADEDXNID VARCHAR(50)
	,@CCURLOCID VARCHAR(5)
	,@BACKNOWLEDGE BIT=0
	,@CERRMSG VARCHAR(1000) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @CMEMOID VARCHAR(50),@CSTEP VARCHAR(5)
BEGIN TRY 
 SET @CSTEP=00
 
 DECLARE @CTEMPDBNAME1 VARCHAR(40),@CTEMPDBNAME VARCHAR(40)
 
 PRINT 'ENTER PFICHASE SENDING'	
 
 SET @CSTEP=10 			
 
  SET @CMEMOID=@CUPLOADEDXNID
	---- IF NO MEMO FOUND , JUST END THE PROCESS
	IF ISNULL(@CMEMOID,'')=''
		GOTO END_PROC

LBLTABLEINFO:
	SET @CSTEP=50

	IF @BACKNOWLEDGE=1
		GOTO END_PROC
		
	SET @CSTEP=55
	SELECT DISTINCT 'PFI_ORD_PLAN_MST_MIRROR' AS TARGET_TABLENAME,A.* ,@CMEMOID AS XN_ID FROM ORD_PLAN_MST(NOLOCK) A WHERE A.MEMO_ID=@CMEMOID
	
	SET @CSTEP=60
	SELECT DISTINCT 'PFI_ORD_PLAN_DET_MIRROR' AS TARGET_TABLENAME,A.* FROM ORD_PLAN_DET(NOLOCK) A WHERE A.MEMO_ID=@CMEMOID
	
	SET @CSTEP=65
	SELECT DISTINCT 'PFI_ORD_PLAN_BOM_DET_MIRROR' AS TARGET_TABLENAME,A.* , @CMEMOID AS PFI_MEMO_ID FROM ORD_PLAN_BOM_DET A (NOLOCK)  WHERE A.MEMO_ID=@CMEMOID
	
	SET @CSTEP=70
	SELECT DISTINCT 'PFI_ORD_PLAN_BARCODE_DET_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID  
	FROM ORD_PLAN_BARCODE_DET(NOLOCK) A
	JOIN ORD_PLAN_DET (NOLOCK) B ON A.REFROW_ID  =B.ROW_ID
	WHERE B.MEMO_ID=@CMEMOID
	
	SET @CSTEP=70
	---- SEND THE DEBITNOTE MEMO SKU TABLE
	SELECT DISTINCT 'PFI_SKU_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID  
	FROM ORD_PLAN_DET  (NOLOCK) B
	JOIN ORD_PLAN_BARCODE_DET (NOLOCK) C ON B.ROW_ID=C.REFROW_ID
	JOIN SKU (NOLOCK) A  ON A.PRODUCT_CODE=C.PRODUCT_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	
	
	
	
	SET @CSTEP=75
	---- SEND THE SKU_OH RELATED TO GIVEN PFI MEMO
	SELECT DISTINCT 'PFI_SKU_OH_MIRROR' AS TARGET_TABLENAME,A.* , @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET  (NOLOCK) B
	JOIN ORD_PLAN_BARCODE_DET (NOLOCK) C ON B.ROW_ID=C.REFROW_ID
	JOIN SKU_OH (NOLOCK) A  ON A.PRODUCT_CODE=C.PRODUCT_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	
		
	SET @CSTEP=80
	---- SEND THE ARTICLE RELATED TO GIVEN PFI MEMO
	IF OBJECT_ID ('TEMPDB..#TMPARTICLE','U') IS NOT NULL
	   DROP TABLE #TMPARTICLE
	SELECT 'PFI_ARTICLE_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	INTO #TMPARTICLE
	FROM ORD_PLAN_DET(NOLOCK) B
	JOIN ARTICLE A (NOLOCK)  ON A.ARTICLE_CODE=B.ARTICLE_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION 
		SELECT 'PFI_ARTICLE_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
		FROM ORD_PLAN_BOM_DET(NOLOCK) B
		JOIN ARTICLE A (NOLOCK)  ON A.ARTICLE_CODE=B.ARTICLE_CODE 
		WHERE B.MEMO_ID=@CMEMOID
	UNION 
	SELECT 'PFI_ARTICLE_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B (NOLOCK) 
	JOIN ORD_PLAN_BARCODE_DET (NOLOCK) C ON B.ROW_ID=C.REFROW_ID
	JOIN SKU SK (NOLOCK)  ON C.PRODUCT_CODE =SK.PRODUCT_CODE 
	JOIN ARTICLE (NOLOCK) A ON SK.ARTICLE_CODE =A.ARTICLE_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	
	
	
	
	SELECT DISTINCT  A.* FROM #TMPARTICLE A
	
	SET @CSTEP=85
	---- SEND THE SECTIOND RELATED TO GIVEN PFI MEMO
	SELECT DISTINCT 'PFI_SECTIOND_MIRROR' AS TARGET_TABLENAME,SD.*, @CMEMOID AS PFI_MEMO_ID 
	FROM #TMPARTICLE A
	JOIN SECTIOND SD(NOLOCK) ON A.SUB_SECTION_CODE  =SD.SUB_SECTION_CODE
	
	
	
	
	SET @CSTEP=90
	---- SEND THE SECTIONM RELATED TO GIVEN PFI MEMO
	SELECT DISTINCT 'PFI_SECTIONM_MIRROR' AS TARGET_TABLENAME,SM.*, @CMEMOID AS PFI_MEMO_ID 
	FROM #TMPARTICLE A
	JOIN SECTIOND SD(NOLOCK) ON A.SUB_SECTION_CODE  =SD.SUB_SECTION_CODE
	JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE =SM.SECTION_CODE 
	
	
	SET @CSTEP=95
	---- SEND THE PARA1 RELATED TO GIVEN PFI MEMO
	SELECT  DISTINCT 'PFI_PARA1_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN PARA1 A(NOLOCK)   ON A.PARA1_CODE=B.PARA1_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION 
	SELECT DISTINCT 'PFI_PARA1_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_BOM_DET B(NOLOCK)
	JOIN PARA1 A(NOLOCK)  ON A.PARA1_CODE=B.PARA1_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION
	SELECT  DISTINCT 'PFI_PARA1_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN ORD_PLAN_BARCODE_DET (NOLOCK) C ON B.ROW_ID=C.REFROW_ID
    JOIN  SKU(NOLOCK) ON C.PRODUCT_CODE =SKU.PRODUCT_CODE 
	JOIN PARA1 A(NOLOCK) ON A.PARA1_CODE =SKU.PARA1_CODE 
	WHERE B.MEMO_ID=@CMEMOID

	
	SET @CSTEP=95
	---- SEND THE PARA2 RELATED TO GIVEN PFI MEMO
	SELECT  DISTINCT 'PFI_PARA2_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN PARA2 A(NOLOCK)   ON A.PARA2_CODE=B.PARA2_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION 
	SELECT DISTINCT 'PFI_PARA2_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_BOM_DET B(NOLOCK)
	JOIN PARA2 A(NOLOCK)  ON A.PARA2_CODE=B.PARA2_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION
	SELECT  DISTINCT 'PFI_PARA2_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN ORD_PLAN_BARCODE_DET (NOLOCK) C ON B.ROW_ID=C.REFROW_ID
    JOIN  SKU(NOLOCK) ON C.PRODUCT_CODE =SKU.PRODUCT_CODE 
	JOIN PARA2 A(NOLOCK) ON A.PARA2_CODE =SKU.PARA2_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	
	SET @CSTEP=105
	---- SEND THE PARA3 RELATED TO GIVEN PFI MEMO
	SELECT  DISTINCT 'PFI_PARA3_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN PARA3 A(NOLOCK)   ON A.PARA3_CODE=B.PARA3_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION 
	SELECT DISTINCT 'PFI_PARA3_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_BOM_DET B(NOLOCK)
	JOIN PARA3 A(NOLOCK)  ON A.PARA3_CODE=B.PARA3_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION
	SELECT  DISTINCT 'PFI_PARA3_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN ORD_PLAN_BARCODE_DET (NOLOCK) C ON B.ROW_ID=C.REFROW_ID
    JOIN  SKU(NOLOCK) ON C.PRODUCT_CODE =SKU.PRODUCT_CODE 
	JOIN PARA3 A(NOLOCK) ON A.PARA3_CODE =SKU.PARA3_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	
	SET @CSTEP=110
	---- SEND THE PARA4 RELATED TO GIVEN PFI MEMO
	SELECT  DISTINCT 'PFI_PARA4_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN PARA4 A(NOLOCK)   ON A.PARA4_CODE=B.PARA4_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION 
	SELECT DISTINCT 'PFI_PARA4_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_BOM_DET B(NOLOCK)
	JOIN PARA4 A(NOLOCK)  ON A.PARA4_CODE=B.PARA4_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION
	SELECT  DISTINCT 'PFI_PARA4_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN ORD_PLAN_BARCODE_DET (NOLOCK) C ON B.ROW_ID=C.REFROW_ID
    JOIN  SKU(NOLOCK) ON C.PRODUCT_CODE =SKU.PRODUCT_CODE 
	JOIN PARA4 A(NOLOCK) ON A.PARA4_CODE =SKU.PARA4_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	
	SET @CSTEP=115
	---- SEND THE PARA5 RELATED TO GIVEN PFI MEMO
	SELECT  DISTINCT 'PFI_PARA5_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN PARA5 A(NOLOCK)   ON A.PARA5_CODE=B.PARA5_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION 
	SELECT DISTINCT 'PFI_PARA5_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_BOM_DET B(NOLOCK)
	JOIN PARA5 A(NOLOCK)  ON A.PARA5_CODE=B.PARA5_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION
	SELECT  DISTINCT 'PFI_PARA5_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN ORD_PLAN_BARCODE_DET (NOLOCK) C ON B.ROW_ID=C.REFROW_ID
    JOIN  SKU(NOLOCK) ON C.PRODUCT_CODE =SKU.PRODUCT_CODE 
	JOIN PARA5 A(NOLOCK) ON A.PARA5_CODE =SKU.PARA5_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	
	SET @CSTEP=120
	---- SEND THE PARA6 RELATED TO GIVEN PFI MEMO
	SELECT  DISTINCT 'PFI_PARA6_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN PARA6 A(NOLOCK)   ON A.PARA6_CODE=B.PARA6_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION 
	SELECT DISTINCT 'PFI_PARA6_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_BOM_DET B(NOLOCK)
	JOIN PARA6 A(NOLOCK)  ON A.PARA6_CODE=B.PARA6_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	UNION
	SELECT  DISTINCT 'PFI_PARA6_MIRROR' AS TARGET_TABLENAME,A.*, @CMEMOID AS PFI_MEMO_ID 
	FROM ORD_PLAN_DET B(NOLOCK)
	JOIN ORD_PLAN_BARCODE_DET (NOLOCK) C ON B.ROW_ID=C.REFROW_ID
    JOIN  SKU(NOLOCK) ON C.PRODUCT_CODE =SKU.PRODUCT_CODE 
	JOIN PARA6 A(NOLOCK) ON A.PARA6_CODE =SKU.PARA6_CODE 
	WHERE B.MEMO_ID=@CMEMOID
	
	
	
--IF @BSENDNEWATTRIBUTE=0
--BEGIN

SELECT 	DISTINCT 'PFI_ARTICLE_FIX_ATTR_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS PFI_MEMO_ID,A.* FROM ARTICLE_FIX_ATTR A (NOLOCK)
	JOIN #TMPARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE

	
	
SELECT 	DISTINCT 'PFI_SD_ATTR_AVATAR_MIRROR' AS TARGET_TABLENAME,@CMEMOID AS PFI_MEMO_ID,A.* FROM SD_ATTR_AVATAR A (NOLOCK)
    JOIN SECTIOND SD(NOLOCK) ON SD.SUB_SECTION_CODE=A.SUB_SECTION_CODE
	JOIN #TMPARTICLE B (NOLOCK) ON SD.SUB_SECTION_CODE=B.SUB_SECTION_CODE
	
	
	

    DECLARE @NCOUNT INT,@BLOOP INT,@CCMD NVARCHAR(MAX)
	SET @NCOUNT=25
	SET @BLOOP=1
	WHILE (@BLOOP <=@NCOUNT )
	BEGIN
	      
	    
		   SET @CCMD=N' IF EXISTS(SELECT  TOP 1 ''U''
			FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)
			JOIN ARTICLE_FIX_ATTR A (NOLOCK) ON ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code=A.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code
			JOIN #TMPARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE
			WHERE ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000'' )
				SELECT 	DISTINCT ''PFI_ATTR'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_MST_MIRROR'' AS TARGET_TABLENAME,'''+@CMEMOID+''' AS PFI_MEMO_ID,ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.* 
				FROM ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST(NOLOCK)
				JOIN ARTICLE_FIX_ATTR A (NOLOCK) ON ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code=A.attr'+RTRIM(LTRIM(STR(@BLOOP)))+'_key_code
				JOIN #TMPARTICLE B (NOLOCK) ON A.ARTICLE_CODE=B.ARTICLE_CODE

				WHERE 
				  ATTR'+RTRIM(LTRIM(STR(@BLOOP)))+'_MST.attr'+RTRIM(LTRIM(RTRIM(LTRIM(STR(@BLOOP)))))+'_key_code <> ''0000000'' '
				
		   PRINT  @CCMD
		   EXEC SP_EXECUTESQL @CCMD
	       
		   SET @BLOOP=@BLOOP +1
	END
--END	
	
    
LBLCHECKDATA:

END TRY
BEGIN CATCH
	SET @CERRMSG='P: SP_SEND_MIRROR_PFI_DATA_NEW, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH 
	
END_PROC:

END	
---END OF PROCEDURE - SP_SEND_MIRROR_PFI_DATA_NEW
