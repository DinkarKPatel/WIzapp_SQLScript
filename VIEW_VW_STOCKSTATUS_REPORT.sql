CREATE VIEW VW_STOCKSTATUS_REPORT       
  
AS      
  
 SELECT  A.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT,'OPS' AS XN_TYPE,   A.XN_DT AS XN_DT,  '' AS XN_NO,             
 A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
 SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE   
 ,'LM'+SK.AC_CODE AS XN_PARTY_CODE,   
 A.QUANTITY_OB AS XN_QTY,            
 SK.PURCHASE_PRICE AS XN_PP,AR.ARTICLE_CODE ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
  ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,A.PRODUCT_CODE AS PRODUCT_CODE
  ,LM.AC_NAME AS SUPPLIER_NAME
  ,AR.ARTICLE_NAME  
 FROM PRD_OPS01106 A    
 JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=A.DEPARTMENT_ID     
 JOIN PRD_SKU SK ON SK.PRODUCT_UID=A.PRODUCT_UID       
 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SK.ARTICLE_CODE  
 JOIN UOM UOM ON UOM.UOM_CODE=AR.UOM_CODE 
 JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE   
UNION ALL  
  
SELECT D.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT,'PUR' AS XN_TYPE,   B.RECEIPT_DT AS XN_DT,  B.MRR_NO AS XN_NO,             
A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE   
,'LM'+B.AC_CODE AS XN_PARTY_CODE,   
A.QUANTITY AS XN_QTY,            
SK.PURCHASE_PRICE AS XN_PP,AR.ARTICLE_CODE ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
 ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,A.PRODUCT_CODE AS PRODUCT_CODE    
 ,LM.AC_NAME AS SUPPLIER_NAME 
 ,AR.ARTICLE_NAME     
FROM PRD_PID01106 A (NOLOCK)            
JOIN PRD_PIM01106 B (NOLOCK) ON A.MRR_ID = B.MRR_ID            
JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID          
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE 
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE  B.CANCELLED = 0 AND A.PRODUCT_UID<>'' AND AR.STOCK_NA=0       
UNION ALL        
    
SELECT D.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT,'PRT' AS XN_TYPE, B.RM_DT AS XN_DT, B.RM_NO AS XN_NO,          
A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,  
'LM'+B.AC_CODE AS XN_PARTY_CODE,  
A.QUANTITY AS XN_QTY,          
SK.PURCHASE_PRICE AS XN_PP,AR.ARTICLE_CODE ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME    
 ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,A.PRODUCT_CODE AS PRODUCT_CODE  
 ,LM.AC_NAME AS SUPPLIER_NAME 
 ,AR.ARTICLE_NAME
FROM PRD_RMD01106 A (NOLOCK)          
JOIN PRD_RMM01106 B (NOLOCK) ON A.RM_ID = B.RM_ID          
JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID        
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE 
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE    
WHERE B.CANCELLED = 0  AND A.PRODUCT_UID<>'' AND AR.STOCK_NA=0          
--AND ISNULL(B.REF_WO_MEMO_ID,'')<>''     
UNION ALL      
        
SELECT D.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT,(CASE WHEN B.CNC_TYPE=1 THEN 'CNC' ELSE 'UNC' END) AS XN_TYPE    
,B.CNC_MEMO_DT AS XN_DT,  B.CNC_MEMO_NO AS XN_NO,          
A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,  
'LM'+SK.AC_CODE AS XN_PARTY_CODE,  
A.QUANTITY AS XN_QTY,          
SK.PURCHASE_PRICE AS XN_PP,AR.ARTICLE_CODE,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME  
 ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,A.PRODUCT_CODE AS PRODUCT_CODE    
 ,LM.AC_NAME AS SUPPLIER_NAME  
 ,AR.ARTICLE_NAME
FROM PRD_ICD01106 A (NOLOCK)          
JOIN PRD_ICM01106 B (NOLOCK) ON A.CNC_MEMO_ID = B.CNC_MEMO_ID          
JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID        
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE B.CANCELLED = 0  AND AR.STOCK_NA=0  -- AND ST.REF_WO_ID IS NULL  
         
UNION ALL          
    
SELECT D.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT,'WSL' AS XN_TYPE,  B.INV_DT AS XN_DT,  B.INV_NO AS XN_NO,          
A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,  
'LM'+B.AC_CODE AS XN_PARTY_CODE,A.QUANTITY AS XN_QTY,          
SK.PURCHASE_PRICE  AS XN_PP,AR.ARTICLE_CODE,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
 ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,SK.PRODUCT_CODE AS PRODUCT_CODE 
 ,LM.AC_NAME AS SUPPLIER_NAME  
 ,AR.ARTICLE_NAME      
FROM PRD_IND01106 A (NOLOCK)          
JOIN PRD_INM01106 B (NOLOCK) ON A.INV_ID = B.INV_ID          
JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID        
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE 
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE    
WHERE B.CANCELLED = 0 AND B.ENTRY_MODE=0 AND AR.STOCK_NA=0           
UNION ALL    
    
SELECT D.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT,'WSR' AS XN_TYPE,  B.CN_DT AS XN_DT,  B.CN_NO AS XN_NO,          
A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,  
'LM'+B.AC_CODE AS XN_PARTY_CODE,   A.QUANTITY AS XN_QTY,          
SK.PURCHASE_PRICE AS XN_PP,AR.ARTICLE_CODE,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME  
 ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,SK.PRODUCT_CODE AS PRODUCT_CODE  
 ,LM.AC_NAME AS SUPPLIER_NAME 
 ,AR.ARTICLE_NAME   
FROM PRD_CND01106 A (NOLOCK)          
JOIN PRD_CNM01106 B (NOLOCK) ON A.CN_ID = B.CN_ID          
JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID        
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE B.CANCELLED = 0  AND AR.STOCK_NA=0                 
  
UNION ALL        
SELECT D.DEPARTMENT_ID,DEP.DEPARTMENT_NAME  AS DEPARTMENT, 'AMR' AS XN_TYPE,D.MEMO_DT AS XN_DT,D.MEMO_NO AS XN_NO,        
C.XN_PRODUCT_UID AS PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'LM'+AJ.AC_CODE AS XN_PARTY_CODE, (CASE WHEN C.STOCK_TYPE=1 THEN C.QUANTITY ELSE 0 END) AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP,     
 AR.ARTICLE_CODE ,SK.WORK_ORDER_ID,(CASE WHEN C.STOCK_TYPE=2 THEN C.QUANTITY ELSE 0 END) AS WIP_QTY,UOM.UOM_NAME   
  ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,SK.PRODUCT_CODE AS PRODUCT_CODE 
  ,LM.AC_NAME AS SUPPLIER_NAME  
  ,AR.ARTICLE_NAME     
FROM PRD_AGENCY_MATERIAL_RECEIPT_DET C  (NOLOCK)         
JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                    
LEFT JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B (NOLOCK) ON B.ROW_ID=C.REF_ROW_ID                  
LEFT JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE            
JOIN PRD_AGENCY_MST AJ (NOLOCK) ON AJ.AGENCY_CODE=D.AGENCY_CODE        
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.XN_PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE    
JOIN PRD_DEPARTMENT_MST DEP (NOLOCK) ON DEP.DEPARTMENT_ID=D.DEPARTMENT_ID     
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE D.CANCELLED=0 AND AR.STOCK_NA=0                    
    
UNION ALL      
SELECT DEPT.DEPARTMENT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT, 'AMI' AS XN_TYPE,D.MEMO_DT AS XN_DT,D.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,     
'LM'+AJ.AC_CODE AS XN_PARTY_CODE, (CASE WHEN C.STOCK_TYPE=1 THEN C.QUANTITY ELSE 0 END) AS XN_QTY,SK.PURCHASE_PRICE  AS XN_PP  ,    
AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,(CASE WHEN C.STOCK_TYPE=2 THEN C.QUANTITY ELSE 0 END) AS WIP_QTY,UOM.UOM_NAME  
 ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,SK.PRODUCT_CODE AS PRODUCT_CODE  
 ,LM.AC_NAME AS SUPPLIER_NAME 
 ,AR.ARTICLE_NAME    
FROM PRD_AGENCY_ISSUE_MATERIAL_DET  C (NOLOCK)           
JOIN PRD_AGENCY_ISSUE_MATERIAL_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                    
JOIN PRD_AGENCY_MST AJ (NOLOCK) ON AJ.AGENCY_CODE=D.REF_AGENCY_CODE        
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE    
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
LEFT OUTER JOIN     
(     
  SELECT REF_ROW_ID FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A          
  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID     
  WHERE B.CANCELLED =0    
  GROUP BY REF_ROW_ID
) RC  ON RC.REF_ROW_ID = C.ROW_ID       
LEFT JOIN PRD_STK_TRANSFER_DTM_MST ST (NOLOCK) ON ST.REF_WO_ID=SK.WORK_ORDER_ID   
JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.DEPARTMENT_ID  
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE  
WHERE --RC.REF_ROW_ID  IS NULL AND  
D.CANCELLED=0 AND AR.STOCK_NA=0    
--AND ST.REF_WO_ID IS NULL                   
    ---NEW ADD ISSUE MATERIAL PENDING  
UNION ALL      
SELECT DEPT.DEPARTMENT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT, 'AMI' AS XN_TYPE,D.MEMO_DT AS XN_DT,D.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,     
'LM'+AJ.AC_CODE AS XN_PARTY_CODE, (CASE WHEN C.STOCK_TYPE=1 THEN C.QUANTITY ELSE 0 END) AS XN_QTY,SK.PURCHASE_PRICE  AS XN_PP  ,    
AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,(CASE WHEN C.STOCK_TYPE=2 THEN C.QUANTITY ELSE 0 END) AS WIP_QTY,UOM.UOM_NAME  
 ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,SK.PRODUCT_CODE AS PRODUCT_CODE
 ,LM.AC_NAME AS SUPPLIER_NAME  
 ,AR.ARTICLE_NAME     
FROM PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING   C (NOLOCK)           
JOIN PRD_AGENCY_ISSUE_MATERIAL_MST_PENDING  D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                    
JOIN PRD_AGENCY_MST AJ (NOLOCK) ON AJ.AGENCY_CODE=D.REF_AGENCY_CODE        
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE    
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
LEFT OUTER JOIN     
(     
  SELECT REF_ROW_ID FROM PRD_AGENCY_MATERIAL_RECEIPT_DET A          
  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID     
  WHERE B.CANCELLED =0    
  GROUP BY REF_ROW_ID
) RC  ON RC.REF_ROW_ID = C.ROW_ID       
LEFT JOIN PRD_STK_TRANSFER_DTM_MST ST (NOLOCK) ON ST.REF_WO_ID=SK.WORK_ORDER_ID   
JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.DEPARTMENT_ID   
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE --RC.REF_ROW_ID  IS NULL AND  
D.CANCELLED=0 AND AR.STOCK_NA=0      
    
    
UNION ALL         
       
        
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'ISSUE-MAT-OUT' AS XN_TYPE,D.MEMO_DT AS XN_DT,D.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'LM'+AJ.AC_CODE  AS XN_PARTY_CODE,(CASE WHEN C.TYPE=1 THEN 0 ELSE C.QUANTITY END) AS XN_QTY,SK.PURCHASE_PRICE AS  XN_PP ,    
 AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,(CASE WHEN C.TYPE=1 THEN C.QUANTITY ELSE 0 END) AS WIP_QTY,UOM.UOM_NAME  
  ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,SK.PRODUCT_CODE AS PRODUCT_CODE  
  ,LM.AC_NAME AS SUPPLIER_NAME
  ,AR.ARTICLE_NAME     
FROM PRD_ISSUE_MATERIAL_DET  C  (NOLOCK)         
JOIN PRD_ISSUE_MATERIAL_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                    
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE     
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE       
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=D.SOURCE_DEPARTMENT_ID        
LEFT JOIN PRD_STK_TRANSFER_DTM_MST ST (NOLOCK) ON ST.REF_WO_ID=SK.WORK_ORDER_ID   
JOIN PRD_AGENCY_MST AJ (NOLOCK) ON AJ.AGENCY_CODE=D.REF_AGENCY_CODE 
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE   
WHERE D.CANCELLED=0  AND AR.STOCK_NA=0    
AND ST.REF_WO_ID IS NULL                   
  
UNION ALL         
  
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'ISSUE-MAT-IN' AS XN_TYPE,D.MEMO_DT AS XN_DT,D.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+TARGET_DEPARTMENT_ID AS XN_PARTY_CODE,(CASE WHEN C.TYPE=1 THEN 0 ELSE C.QUANTITY END) AS XN_QTY,C.PURCHASE_PRICE AS  XN_PP ,    
 AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,(CASE WHEN C.TYPE=1 THEN C.QUANTITY ELSE 0 END) AS WIP_QTY,UOM.UOM_NAME   
  ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,SK.PRODUCT_CODE AS PRODUCT_CODE  
  ,LM.AC_NAME AS SUPPLIER_NAME  
  ,AR.ARTICLE_NAME 
FROM PRD_ISSUE_MATERIAL_DET  C (NOLOCK)          
JOIN PRD_ISSUE_MATERIAL_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                    
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE     
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE       
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=D.TARGET_DEPARTMENT_ID        
LEFT OUTER JOIN     
(     
  SELECT REF_ROW_ID FROM PRD_MATERIAL_RECEIPT_DET A          
  JOIN PRD_MATERIAL_RECEIPT_MST B ON A.MEMO_ID=B.MEMO_ID     
  WHERE B.CANCELLED =0    
) RC  ON RC.REF_ROW_ID = C.ROW_ID  
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE   
WHERE RC.REF_ROW_ID  IS NULL AND D.CANCELLED=0  AND AR.STOCK_NA=0    
  
  
UNION ALL  
  
SELECT DEPT.DEPARTMENT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT, 'JWI' AS XN_TYPE,B.ISSUE_DT AS XN_DT,B.ISSUE_NO AS XN_NO,        
A.PRODUCT_UID,AR.ARTICLE_NO,SKU .PARA1_CODE,SKU.PARA2_CODE,  
SKU .PARA3_CODE ,SKU.PARA4_CODE ,SKU.PARA5_CODE ,SKU.PARA6_CODE ,        
'LM'+AG.AC_CODE  AS XN_PARTY_CODE,A.QUANTITY AS XN_QTY,SKU.PURCHASE_PRICE AS  XN_PP ,    
AR.ARTICLE_CODE  ,SKU.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE ,SKU.COM_PARA2_CODE ,SKU.PRODUCT_CODE AS PRODUCT_CODE  
,LM.AC_NAME AS SUPPLIER_NAME  
,AR.ARTICLE_NAME 
FROM PRD_JOBWORK_ISSUE_DET A (NOLOCK)          
JOIN PRD_JOBWORK_ISSUE_MST B (NOLOCK) ON A.ISSUE_ID = B.ISSUE_ID    
JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.DEPARTMENT_ID       
JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.PRODUCT_UID   
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SKU .ARTICLE_CODE         
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE      
JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE =B.AGENCY_CODE   
JOIN LM01106 LM ON LM.AC_CODE =SKU.AC_CODE      
WHERE B.CANCELLED = 0   
  
UNION ALL  
SELECT DEPT.DEPARTMENT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT, 'JWR' AS XN_TYPE,B.RECEIPT_DT AS XN_DT,B.RECEIPT_NO AS XN_NO,        
A.PRODUCT_UID,ARTICLE.ARTICLE_NO,SKU .PARA1_CODE,SKU.PARA2_CODE,  
SKU .PARA3_CODE ,SKU.PARA4_CODE ,SKU.PARA5_CODE ,SKU.PARA6_CODE ,        
'LM'+AG.AC_CODE  AS XN_PARTY_CODE,A.QUANTITY+ISNULL(A.SHRINK_QTY,0) AS XN_QTY,SKU.PURCHASE_PRICE AS  XN_PP ,    
ARTICLE.ARTICLE_CODE  ,SKU.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE ,SKU.COM_PARA2_CODE ,SKU.PRODUCT_CODE AS PRODUCT_CODE    
,LM.AC_NAME AS SUPPLIER_NAME 
,ARTICLE.ARTICLE_NAME
 FROM PRD_JOBWORK_RECEIPT_DET A (NOLOCK)          
JOIN PRD_JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID  
JOIN PRD_JOBWORK_ISSUE_DET C (NOLOCK) ON C.ROW_ID=A.REF_ROW_ID          
JOIN PRD_JOBWORK_ISSUE_MST D (NOLOCK) ON C.ISSUE_ID = D.ISSUE_ID      
JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.DEPARTMENT_ID       
JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=C.PRODUCT_UID       
JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE      
JOIN UOM (NOLOCK) ON ARTICLE.UOM_CODE=UOM.UOM_CODE       
JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE =B.AGENCY_CODE 
JOIN LM01106 LM ON LM.AC_CODE =SKU.AC_CODE         
 WHERE B.CANCELLED = 0  
  
UNION ALL  
 SELECT DEPT.DEPARTMENT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT, 'JWR-CON' AS XN_TYPE,B.RECEIPT_DT AS XN_DT,B.RECEIPT_NO AS XN_NO,        
A.PRODUCT_UID,ARTICLE.ARTICLE_NO,SKU .PARA1_CODE,SKU.PARA2_CODE,  
SKU .PARA3_CODE ,SKU.PARA4_CODE ,SKU.PARA5_CODE ,SKU.PARA6_CODE ,        
'LM'+AG.AC_CODE  AS XN_PARTY_CODE,A.QUANTITY+ISNULL(A.SHRINK_QTY,0) AS XN_QTY,SKU.PURCHASE_PRICE AS  XN_PP ,    
ARTICLE.ARTICLE_CODE  ,SKU.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE ,SKU.COM_PARA2_CODE ,SKU.PRODUCT_CODE AS PRODUCT_CODE  
,LM.AC_NAME AS SUPPLIER_NAME 
,ARTICLE.ARTICLE_NAME
FROM PRD_JOBWORK_RECEIPT_DET A (NOLOCK)          
JOIN PRD_JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID  
JOIN PRD_JOBWORK_ISSUE_DET C (NOLOCK) ON C.ROW_ID=A.REF_ROW_ID          
JOIN PRD_JOBWORK_ISSUE_MST D (NOLOCK) ON C.ISSUE_ID = D.ISSUE_ID      
JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =D.DEPARTMENT_ID       
JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=C.PRODUCT_UID       
JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE    
JOIN UOM (NOLOCK) ON ARTICLE.UOM_CODE=UOM.UOM_CODE     
JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE =B.AGENCY_CODE  
JOIN LM01106 LM ON LM.AC_CODE =SKU.AC_CODE                  
WHERE B.CANCELLED = 0   
  
UNION ALL  
 SELECT DEPT.DEPARTMENT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT, 'JWR-FIN' AS XN_TYPE,B.RECEIPT_DT AS XN_DT,B.RECEIPT_NO AS XN_NO,        
A.PRODUCT_UID,ARTICLE.ARTICLE_NO,SKU .PARA1_CODE,SKU.PARA2_CODE,  
SKU .PARA3_CODE ,SKU.PARA4_CODE ,SKU.PARA5_CODE ,SKU.PARA6_CODE ,        
'LM'+AG.AC_CODE AS XN_PARTY_CODE,A.QUANTITY AS XN_QTY,SKU.PURCHASE_PRICE AS  XN_PP ,    
ARTICLE.ARTICLE_CODE  ,SKU.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE ,SKU.COM_PARA2_CODE ,SKU.PRODUCT_CODE AS PRODUCT_CODE
,LM.AC_NAME AS SUPPLIER_NAME 
,ARTICLE.ARTICLE_NAME  
FROM PRD_JOBWORK_RECEIPT_DET A (NOLOCK)          
JOIN PRD_JOBWORK_RECEIPT_MST B (NOLOCK) ON A.RECEIPT_ID = B.RECEIPT_ID  
JOIN PRD_JOBWORK_ISSUE_DET C (NOLOCK) ON C.ROW_ID=A.REF_ROW_ID          
JOIN PRD_JOBWORK_ISSUE_MST D (NOLOCK) ON C.ISSUE_ID = D.ISSUE_ID      
JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.DEPARTMENT_ID       
JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.PRODUCT_UID       
JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE    
JOIN UOM (NOLOCK) ON ARTICLE.UOM_CODE=UOM.UOM_CODE      
JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE =B.AGENCY_CODE 
JOIN LM01106 LM ON LM.AC_CODE =SKU.AC_CODE            
WHERE B.CANCELLED = 0   
      
UNION ALL         
        
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'ISSUE-MAT-IN' AS XN_TYPE,D.MEMO_DT AS XN_DT,D.MEMO_NO AS XN_NO,        
B.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'LM'+D.AC_CODE  AS XN_PARTY_CODE, (CASE WHEN C.TYPE=1 THEN 0 ELSE C.QUANTITY END) AS XN_QTY,SK.PURCHASE_PRICE  AS XN_PP  ,    
AR.ARTICLE_CODE ,SK.WORK_ORDER_ID,(CASE WHEN C.TYPE=1 THEN C.QUANTITY ELSE 0 END) AS WIP_QTY,UOM.UOM_NAME  
 ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,SK.PRODUCT_CODE AS PRODUCT_CODE 
 ,LM.AC_NAME AS SUPPLIER_NAME 
 ,AR.ARTICLE_NAME       
FROM PRD_MATERIAL_RECEIPT_DET  C (NOLOCK)          
JOIN PRD_MATERIAL_RECEIPT_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID                    
JOIN PRD_ISSUE_MATERIAL_DET B (NOLOCK) ON B.ROW_ID=C.REF_ROW_ID                   
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=B.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=D.DEPARTMENT_ID        
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE           
WHERE D.CANCELLED=0 AND AR.STOCK_NA=0    
  
      
UNION ALL        
        
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'CODE-CON' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+DP.DEPARTMENT_ID AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP ,    
AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
 ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,SK.PRODUCT_CODE AS PRODUCT_CODE  
 ,LM.AC_NAME AS SUPPLIER_NAME 
 ,AR.ARTICLE_NAME  
FROM PRD_TRANSFER_MAIN_SUB_DET C (NOLOCK)--PRD_OP_MATERIAL_CON_DET C    
JOIN PRD_TRANSFER_MAIN_MST  B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID    
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.SOURCE_DEPARTMENT_ID    
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE  
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0    
  
UNION ALL        
   
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'OPW' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+B.DEPARTMENT_ID AS XN_PARTY_CODE, 0 AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP ,    
AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,C.QUANTITY AS WIP_QTY,UOM.UOM_NAME   
 ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,SK.PRODUCT_CODE AS PRODUCT_CODE  
 ,LM.AC_NAME AS SUPPLIER_NAME  
 ,AR.ARTICLE_NAME 
FROM PRD_DEPARTMENT_OUTPUT_DET C (NOLOCK)--PRD_OP_MATERIAL_CON_DET C                  
JOIN PRD_DEPARTMENT_OUTPUT_MST B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.DEPARTMENT_ID 
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE      
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0    
  
    
UNION ALL        
      
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'OPC' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+B.SOURCE_DEPARTMENT_ID AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE  AS XN_PP,     
 AR.ARTICLE_CODE ,SK.WORK_ORDER_ID,0 AS WIP_QTY ,UOM.UOM_NAME   
  ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,SK.PRODUCT_CODE AS PRODUCT_CODE     
  ,LM.AC_NAME AS SUPPLIER_NAME
  ,AR.ARTICLE_NAME
FROM PRD_OP_MATERIAL_CON_RWM_DET C  (NOLOCK)  
JOIN PRD_OP_MATERIAL_CON_MST B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.SOURCE_DEPARTMENT_ID 
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE     
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0 AND B.MODE=0    
  
UNION ALL        
        
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'RMR' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,   
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,       
'LM'+B.AC_CODE AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS  XN_PP ,    
  AR.ARTICLE_CODE   ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME  
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE  ,SK.PRODUCT_CODE AS PRODUCT_CODE  
   ,LM.AC_NAME AS SUPPLIER_NAME 
   ,AR.ARTICLE_NAME  
FROM PRD_READY_RECEIVE_DET C (NOLOCK)                  
JOIN PRD_READY_RECEIVE_MST B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID      
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.DEPARTMENT_ID      
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0    
    
UNION ALL        
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'STK-OUT' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+TARGET_DEPARTMENT_ID AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP ,    
  AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY ,UOM.UOM_NAME   
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,SK.PRODUCT_CODE AS PRODUCT_CODE 
   ,LM.AC_NAME AS SUPPLIER_NAME 
   ,AR.ARTICLE_NAME   
FROM PRD_STK_TRANSFER_DET C (NOLOCK)                 
JOIN PRD_STK_TRANSFER_MST B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.NEW_PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.SOURCE_DEPARTMENT_ID     
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE   
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0  
  
UNION ALL        
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'STK-OUT' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+TARGET_DEPARTMENT_ID AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP ,    
  AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY ,UOM.UOM_NAME   
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,SK.PRODUCT_CODE AS PRODUCT_CODE 
   ,LM.AC_NAME AS SUPPLIER_NAME 
   ,AR.ARTICLE_NAME   
FROM PRD_STK_TRANSFER_DET_PENDING C (NOLOCK)                 
JOIN PRD_STK_TRANSFER_MST_PENDING B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.NEW_PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.SOURCE_DEPARTMENT_ID     
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0  --AND B.TRANSFER_TO_MAIN<>1   
    
UNION ALL      
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'STK-IN' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.NEW_PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+B.SOURCE_DEPARTMENT_ID  AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP,    
  AR.ARTICLE_CODE,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,SK.PRODUCT_CODE AS PRODUCT_CODE  
   ,LM.AC_NAME AS SUPPLIER_NAME
   ,AR.ARTICLE_NAME    
FROM PRD_STK_TRANSFER_DET C  (NOLOCK)                 
JOIN PRD_STK_TRANSFER_MST B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.NEW_PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.TARGET_DEPARTMENT_ID     
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0    

UNION ALL      
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'STK-IN' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.NEW_PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+B.SOURCE_DEPARTMENT_ID  AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP,    
  AR.ARTICLE_CODE,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,SK.PRODUCT_CODE AS PRODUCT_CODE
   ,LM.AC_NAME AS SUPPLIER_NAME
   ,AR.ARTICLE_NAME      
FROM PRD_STK_TRANSFER_DET_PENDING C  (NOLOCK)                 
JOIN PRD_STK_TRANSFER_MST_PENDING B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.NEW_PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.TARGET_DEPARTMENT_ID     
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0  
  
    
UNION ALL    
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'FINC' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+B.DEPARTMENT_ID AS XN_PARTY_CODE,C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP,    
  AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,'' AS PRODUCT_CODE     
   ,LM.AC_NAME AS SUPPLIER_NAME
   ,AR.ARTICLE_NAME
FROM PRD_FINISH_DET C  (NOLOCK)                
JOIN PRD_FINISH_MST B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID        
JOIN ARTICLE AR  (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.DEPARTMENT_ID     
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0       
    
UNION ALL    
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'FINR' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+B.DEPARTMENT_ID AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP,    
  AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,'' AS PRODUCT_CODE 
   ,LM.AC_NAME AS SUPPLIER_NAME 
   ,AR.ARTICLE_NAME   
FROM PRD_FINISH_CONSUMPTION_DET C  (NOLOCK)   
JOIN PRD_FINISH_DET C1 (NOLOCK) ON C.REF_ROW_ID=C1.ROW_ID                  
JOIN PRD_FINISH_MST B (NOLOCK) ON B.MEMO_ID=C1.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.DEPARTMENT_ID     
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0       
    
UNION ALL    
SELECT D.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT, 'APP' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'LM'+B.AC_CODE   AS XN_PARTY_CODE, A.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP,    
  AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,A.PRODUCT_CODE  AS PRODUCT_CODE 
   ,LM.AC_NAME AS SUPPLIER_NAME  
   ,AR.ARTICLE_NAME
FROM PRD_APD01106 A     
JOIN PRD_APM01106 B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID    
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE   
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=B.DEPARTMENT_ID
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE    
WHERE B.CANCELLED = 0   
  
UNION ALL ------CHANGES  
SELECT D.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT, 'APR' AS XN_TYPE,C.MEMO_DT AS XN_DT,C.MEMO_NO AS XN_NO,        
A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'LM'+C.AC_CODE  AS XN_PARTY_CODE, A.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP,    
  AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,B.PRODUCT_CODE AS PRODUCT_CODE   
   ,LM.AC_NAME AS SUPPLIER_NAME
   ,AR.ARTICLE_NAME
FROM PRD_APPROVAL_RETURN_DET A     
JOIN PRD_APD01106 B (NOLOCK)ON A.APD_ROW_ID = B.ROW_ID    
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID     
JOIN PRD_APPROVAL_RETURN_MST C (NOLOCK) ON C.MEMO_ID = A.MEMO_ID         
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE   
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=C.DEPARTMENT_ID   
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE C.CANCELLED = 0   
UNION ALL  

SELECT D.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT, 'CIP' AS XN_TYPE,
       B.IRM_MEMO_DT AS XN_DT,B.IRM_MEMO_NO AS XN_NO,        
       A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
       SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
      'LM'+SK.AC_CODE  AS XN_PARTY_CODE, A.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP,    
      AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
     ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,A.PRODUCT_CODE AS PRODUCT_CODE
     ,LM.AC_NAME AS SUPPLIER_NAME
      ,AR.ARTICLE_NAME
 FROM PRD_IRD01106 A (NOLOCK)  
 JOIN PRD_IRM01106 B (NOLOCK) ON A.IRM_MEMO_ID = B.IRM_MEMO_ID
 JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID     
 JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE   
 JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE     
 JOIN LOCATION C (NOLOCK) ON C.DEPT_ID=LEFT(A.IRM_MEMO_ID,2)
 JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=A.DEPARTMENT_ID  
 JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE  
 WHERE A.NEW_PRODUCT_CODE<>''  
 
 UNION ALL   
 SELECT D.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT, 'PFI' AS XN_TYPE,
       B.IRM_MEMO_DT AS XN_DT,B.IRM_MEMO_NO AS XN_NO,        
       A.NEW_PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
       SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
      'LM'+SK.AC_CODE  AS XN_PARTY_CODE, A.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP,    
      AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
     ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,A.NEW_PRODUCT_CODE AS PRODUCT_CODE
     ,LM.AC_NAME AS SUPPLIER_NAME
     ,AR.ARTICLE_NAME
 FROM PRD_IRD01106 A (NOLOCK)  
 JOIN PRD_IRM01106 B (NOLOCK) ON A.IRM_MEMO_ID = B.IRM_MEMO_ID
 JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.NEW_PRODUCT_UID     
 JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE   
 JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE     
 JOIN LOCATION C (NOLOCK) ON C.DEPT_ID=LEFT(A.IRM_MEMO_ID,2)
 JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=A.DEPARTMENT_ID     
 JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
 WHERE  A.NEW_PRODUCT_CODE<>''  
 UNION ALL
 

SELECT D.DEPARTMENT_ID,D.DEPARTMENT_NAME AS DEPARTMENT, 'PRD_SCF' AS XN_TYPE,
       C.RECEIPT_DT  AS XN_DT,C.MEMO_NO AS XN_NO,        
       A.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
       SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
      'LM'+SK.AC_CODE  AS XN_PARTY_CODE,
      CASE WHEN AR.CODING_SCHEME =3 THEN 1 ELSE B.QUANTITY END AS XN_QTY,
      SK.PURCHASE_PRICE AS XN_PP,    
      AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
     ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,A.PRODUCT_CODE AS PRODUCT_CODE
     ,LM.AC_NAME AS SUPPLIER_NAME
     ,AR.ARTICLE_NAME 
FROM PRD_SNC_BARCODE_DET A 
JOIN PRD_SNC_DET B ON A.REFROW_ID =B.ROW_ID 
JOIN PRD_SNC_MST C ON B.MEMO_ID =C.MEMO_ID 
JOIN PRD_DEPARTMENT_MST D (NOLOCK) ON D.DEPARTMENT_ID=C.DEPARTMENT_ID        
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=A.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE 
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE    
WHERE C.CANCELLED = 0  AND A.PRODUCT_UID<>'' AND AR.STOCK_NA=0 
  
UNION ALL

SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'STK-OUT' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+B.SOURCE_DEPARTMENT_ID AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP ,    
  AR.ARTICLE_CODE  ,SK.WORK_ORDER_ID,0 AS WIP_QTY ,UOM.UOM_NAME   
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE ,SK.PRODUCT_CODE AS PRODUCT_CODE 
   ,LM.AC_NAME AS SUPPLIER_NAME 
   ,AR.ARTICLE_NAME   
FROM PRD_STK_RECEIVE_DET C (NOLOCK)                 
JOIN PRD_STK_RECEIVE_MST B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.SOURCE_DEPARTMENT_ID     
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0  --AND B.TRANSFER_TO_MAIN<>1   
    
UNION ALL      
SELECT DP.DEPARTMENT_ID,DP.DEPARTMENT_NAME AS DEPARTMENT, 'STK-IN' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
C.PRODUCT_UID,AR.ARTICLE_NO,SK.PARA1_CODE,SK.PARA2_CODE,  
SK.PARA3_CODE ,SK.PARA4_CODE ,SK.PARA5_CODE ,SK.PARA6_CODE ,        
'DEPT'+DP.DEPARTMENT_ID  AS XN_PARTY_CODE, C.QUANTITY AS XN_QTY,SK.PURCHASE_PRICE AS XN_PP,    
  AR.ARTICLE_CODE,SK.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
   ,SK.COMPONENT_CODE,SK.COM_PARA1_CODE ,SK.COM_PARA2_CODE,SK.PRODUCT_CODE AS PRODUCT_CODE  
   ,LM.AC_NAME AS SUPPLIER_NAME
   ,AR.ARTICLE_NAME    
FROM PRD_STK_RECEIVE_DET C  (NOLOCK)                 
JOIN PRD_STK_RECEIVE_MST B (NOLOCK) ON B.MEMO_ID=C.MEMO_ID               
JOIN PRD_SKU SK (NOLOCK) ON SK.PRODUCT_UID=C.PRODUCT_UID        
JOIN ARTICLE AR (NOLOCK) ON AR.ARTICLE_CODE=SK.ARTICLE_CODE        
JOIN UOM (NOLOCK) ON AR.UOM_CODE=UOM.UOM_CODE    
JOIN PRD_DEPARTMENT_MST DP (NOLOCK) ON DP.DEPARTMENT_ID=B.TARGET_DEPARTMENT_ID    
JOIN LM01106 LM ON LM.AC_CODE =SK.AC_CODE 
WHERE B.CANCELLED=0 AND AR.STOCK_NA=0     
UNION ALL

SELECT DEPT.DEPARTMENT_ID,DEPT.DEPARTMENT_NAME AS DEPARTMENT, 'AMR' AS XN_TYPE,B.MEMO_DT AS XN_DT,B.MEMO_NO AS XN_NO,        
A.PRODUCT_UID,ARTICLE.ARTICLE_NO,SKU.PARA1_CODE,SKU.PARA2_CODE,  
SKU.PARA3_CODE ,SKU.PARA4_CODE ,SKU.PARA5_CODE ,SKU.PARA6_CODE ,        
'DEPT'+DEPT.DEPARTMENT_ID  AS XN_PARTY_CODE, A.QUANTITY AS XN_QTY,SKU.PURCHASE_PRICE AS XN_PP,    
 ARTICLE.ARTICLE_CODE,SKU.WORK_ORDER_ID,0 AS WIP_QTY,UOM.UOM_NAME   
 ,SKU.COMPONENT_CODE,SKU.COM_PARA1_CODE ,SKU.COM_PARA2_CODE,SKU.PRODUCT_CODE AS PRODUCT_CODE  
 ,LM.AGENCY_NAME  AS SUPPLIER_NAME
 ,ARTICLE.ARTICLE_NAME 
FROM PRD_AGENCY_RM_RETURN_DET A (NOLOCK)              
JOIN PRD_AGENCY_RM_RETURN_MST B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID        
JOIN PRD_DEPARTMENT_MST DEPT ON DEPT.DEPARTMENT_ID =B.DEPARTMENT_ID          
JOIN LOCATION L (NOLOCK) ON LEFT(B.MEMO_ID,2)  = L.DEPT_ID          
JOIN PRD_SKU SKU (NOLOCK) ON SKU.PRODUCT_UID=A.PRODUCT_UID           
JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE  
JOIN UOM (NOLOCK) ON ARTICLE.UOM_CODE=UOM.UOM_CODE       
JOIN PRD_AGENCY_MST  LM ON LM.AGENCY_CODE  =B.AGENCY_CODE  
WHERE B.CANCELLED = 0
