CREATE PROCEDURE SP_CUSTOMDVAT24
(
	@DFROMDT DATETIME,
	@DTODT DATETIME,
	@CCURRENTSTATE VARCHAR(10) = '',
	@NMODE INT=1
)
--WITH ENCRYPTION
AS
BEGIN
/*
	THIS PROCEDURE RETURNS DETAILS OF LOCAL PURCHASES AND DEBIT NOTE.
*/

	---POST_TAX_SEPARATELY - 0 : INTERSTATE PURCHASE
	---POST_TAX_SEPARATELY - 1 : LOCAL PURCHASE
	DECLARE @CDEPTID VARCHAR(2), @CHODEPTID VARCHAR(2)  

	SELECT TOP 1 @CDEPTID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'LOCATION_ID'

	SELECT TOP 1 @CHODEPTID = [VALUE] FROM CONFIG WHERE CONFIG_OPTION = 'HO_LOCATION_ID'

	IF ISNULL(@CCURRENTSTATE,'')=''
		SELECT @CCURRENTSTATE = STATE_CODE FROM LOC_VIEW WHERE DEPT_ID = @CDEPTID

	DECLARE @LOCLIST TABLE ( DEPT_ID VARCHAR(2) )

	IF @CDEPTID = @CHODEPTID 
		INSERT @LOCLIST
		SELECT DEPT_ID FROM LOC_VIEW
		WHERE STATE_CODE = @CCURRENTSTATE
		AND   LOC_TYPE = 1
		AND   PUR_LOC = 1
	ELSE
		INSERT @LOCLIST
		SELECT @CDEPTID AS DEPT_ID
	
	IF @NMODE=1
		SELECT	
				  'PURCHASE' AS XN_TYPE	
				, A.INV_DT AS INV_DT
				, A.BILL_NO AS SR_NO
				, B.AC_NAME AS SELLER
				,COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME) AS SELLER_ADDRESS
				, B.TIN_NO  AS TIN
				, SUM( PID.RFNET-PID.TAX_AMOUNT ) AS LOCAL_PUR_AMT
				,(PID.TAX_PERCENTAGE) AS LOCAL_TAX_PERCENTAGE
				,SUM(PID.TAX_AMOUNT) AS LOCAL_TAX_AMOUNT
				,SUM(PID.RFNET) AS LOCAL_TOTAL_AMOUNT
				,F.FORM_NAME		
		FROM PIM01106 A  
		JOIN PID01106 PID ON A.MRR_ID=PID.MRR_ID
		JOIN FORM F ON PID.FORM_ID=F.FORM_ID
		JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE  
		JOIN @LOCLIST LOC ON LEFT(A.MRR_ID,2) = LOC.DEPT_ID
		WHERE A.INV_DT BETWEEN @DFROMDT AND @DTODT 
		AND A.MEMO_TYPE=1 
		AND A.BILL_NO <> ''  
		AND A.CANCELLED=0  
		AND  ROUND(A.SUBTOTAL,0) <>0  AND F.POST_TAX_SEPARATELY=1
		GROUP  BY	  A.INV_DT 
					, A.BILL_NO
					, B.AC_NAME
					, COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME)
					, B.TIN_NO  
					,(PID.TAX_PERCENTAGE)
					,F.FORM_NAME			
		UNION ALL
		
		SELECT	'PURCHASE' AS XN_TYPE
				, A.INV_DT AS INV_DT
				, A.BILL_NO AS SR_NO
				, B.AC_NAME AS SELLER
				,COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME) AS SELLER_ADDRESS
				,B.TIN_NO  AS TIN
				, SUM( PID.RFNET-PID.TAX_AMOUNT ) AS LOCAL_PUR_AMT
				,(PID.TAX_PERCENTAGE) AS LOCAL_TAX_PERCENTAGE
				, SUM( PID.TAX_AMOUNT ) AS LOCAL_TAX_AMOUNT	
				, SUM(PID.RFNET) AS LOCAL_TOTAL_AMOUNT
                ,F.FORM_NAME						
		FROM PRD_PIM01106 A  
		JOIN PRD_PID01106 PID ON A.MRR_ID=PID.MRR_ID
		JOIN FORM F ON PID.FORM_ID=F.FORM_ID
		JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE  
		JOIN @LOCLIST LOC ON LEFT(A.MRR_ID,2) = LOC.DEPT_ID
		WHERE A.INV_DT BETWEEN @DFROMDT AND @DTODT 
		AND A.BILL_NO <> ''  
		AND A.CANCELLED=0  
		AND  ROUND(A.SUBTOTAL,0) <>0  AND F.POST_TAX_SEPARATELY=1
		GROUP  BY	  A.INV_DT 
					, A.BILL_NO
					, B.AC_NAME
					, COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME)
					,B.TIN_NO  
					,(PID.TAX_PERCENTAGE) 
					,F.FORM_NAME						
 	
	ELSE
	
		SELECT	'PURCHASE RETURN' AS XN_TYPE
				, A.RM_DT AS INV_DT
				, A.RM_NO AS SR_NO
				, B.AC_NAME AS SELLER
				,COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME) AS SELLER_ADDRESS
				, ( B.TIN_NO ) AS TIN
				,SUM(C.RFNET-C.ITEM_TAX_AMOUNT) AS LOCAL_PUR_AMT
				, C.ITEM_TAX_PERCENTAGE AS LOCAL_TAX_PERCENTAGE		
				,SUM(C.ITEM_TAX_AMOUNT ) AS LOCAL_TAX_AMOUNT
				,SUM(C.RFNET) AS LOCAL_TOTAL_AMOUNT
				,F.FORM_NAME	
		FROM RMM01106 A  
		JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE  
		JOIN RMD01106 C ON A.RM_ID = C.RM_ID  
		JOIN FORM F ON C.ITEM_FORM_ID=F.FORM_ID
		JOIN @LOCLIST LOC ON LEFT(A.RM_ID,2) = LOC.DEPT_ID
		WHERE A.RM_DT BETWEEN @DFROMDT AND @DTODT AND
		ROUND(A.SUBTOTAL,2) <>0 
		AND A.CANCELLED=0 AND A.MEMO_TYPE=1 AND F.POST_TAX_SEPARATELY=1
 		GROUP BY  A.RM_DT 
				, A.RM_NO 
				, B.AC_NAME
				,COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME)
				,( B.TIN_NO )
				, C.ITEM_TAX_PERCENTAGE
				,F.FORM_NAME
	 	
 		UNION ALL 
	 	
		SELECT	'PURCHASE RETURN' AS XN_TYPE
				, A.RM_DT AS INV_DT
				, A.RM_NO AS SR_NO
				, B.AC_NAME AS SELLER
				,COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME) AS SELLER_ADDRESS
				, ( B.TIN_NO ) AS TIN
				,SUM(C.RFNET-C.ITEM_TAX_AMOUNT) AS LOCAL_PUR_AMT
				, C.ITEM_TAX_PERCENTAGE AS LOCAL_TAX_PERCENTAGE		
				,SUM(C.ITEM_TAX_AMOUNT ) AS LOCAL_TAX_AMOUNT
				,SUM(C.RFNET) AS LOCAL_TOTAL_AMOUNT
				,F.FORM_NAME	
		FROM PRD_RMM01106 A  
		JOIN LMV01106 B ON A.AC_CODE = B.AC_CODE  
		JOIN PRD_RMD01106 C ON A.RM_ID = C.RM_ID  
		JOIN FORM F ON C.ITEM_FORM_ID=F.FORM_ID
		JOIN @LOCLIST LOC ON LEFT(A.RM_ID,2) = LOC.DEPT_ID
		WHERE A.RM_DT BETWEEN @DFROMDT AND @DTODT AND  ROUND(A.SUBTOTAL,2) <>0 AND A.CANCELLED=0 AND F.POST_TAX_SEPARATELY=1
 		GROUP BY  A.RM_DT 
				, A.RM_NO 
				, B.AC_NAME
				,COALESCE(B.ADDRESS0,B.ADDRESS1,B.ADDRESS2,B.AREA_NAME,B.CITY,B.STATE,B.REGION_NAME)
				, ( B.TIN_NO ) 
				, C.ITEM_TAX_PERCENTAGE 
				,F.FORM_NAME	
END
---END OF PROCEDURE - SP_CUSTOMDVAT24
