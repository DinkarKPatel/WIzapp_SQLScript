CREATE PROCEDURE [DBO].[SP3S_INV_JOBCARD_ISSUE_20]          
(          
  @IMODE INT ,          
  @CWHERE VARCHAR(MAX)='',      
  @CAGENCYCODE VARCHAR(20)='',      
  @FINYEAR VARCHAR(10)=''  ,    
  @DEPTID VARCHAR(10)='' ,
  @NRETURNMODE INT=0
          
)      
----WITH ENCRYPTION
AS          
          
BEGIN        
 DECLARE @CCMD NVARCHAR(MAX)  
 --RETURN_BARCODE_REF: 20
      
      SELECT A4.product_code, A6.ORD_PLAN_BOM_DET_ROW_ID ,A6.BOM_DET_ROW_ID,
      CAST(SUM(CASE WHEN ISNULL(A5.ISSUE_TYPE,0)=0 THEN 1 ELSE 0 END *A6.QUANTITY) AS NUMERIC(12,3)) AS QUANTITY,SKU.barcode_coding_scheme
	  FROM BOM_ISSUE_DET A4 (NOLOCK) 
	  JOIN BOM_ISSUE_MST A5  (NOLOCK) ON A5.ISSUE_ID=A4.ISSUE_ID
	  JOIN BOM_ISSUE_REF A6  (NOLOCK) ON A5.ISSUE_ID=A6.BOM_ISSUE_ID AND A4.ROW_ID=A6.BOM_DET_ROW_ID
	  JOIN ORD_PLAN_BOM_DET A1  (NOLOCK) ON A1.ROW_ID=A6.ORD_PLAN_BOM_DET_ROW_ID
	  JOIN SKU (NOLOCK) ON SKU.product_code=A4.product_code
	  WHERE A5.CANCELLED=0 
	  AND A5.JOBWORK_ISSUE_ID=@CWHERE
	  GROUP BY A4.product_code,A6.ORD_PLAN_BOM_DET_ROW_ID,A6.BOM_DET_ROW_ID,sku.barcode_coding_scheme
	  having CAST(SUM(CASE WHEN ISNULL(A5.ISSUE_TYPE,0)=0 THEN 1 ELSE 0 END *A6.QUANTITY) AS NUMERIC(12,3))>0
END
