CREATE PROC SAVETRAN_MERCHANDISER--(LocId 3 digit change by Sanjay:06-11-2024)
(
	@NUPDATEMODE NUMERIC(1,0),  --@NUPDATEMODE 1 FOR ADD,2 FOR EDIT 
	@NSPID	INT,                
	@CUSERS_CODE VARCHAR(7)=''   --@USERS CODE REQUIRED FOR EDIT MODE
)
--WITH ENCRYPTION
AS
BEGIN
			DECLARE @CMASTERTABLENAME VARCHAR(100),
					@CTEMPMASTERTABLE VARCHAR(100),
					@CTEMPMASTERTABLENAME VARCHAR(100),
					@CDETAILTABLENAME VARCHAR(100),
					@CTEMPDETAILTABLE VARCHAR(100),
					@CTEMPDETAILTABLENAME VARCHAR(100),
					@CTEMPDBNAME VARCHAR(100),		
					@NSTEP VARCHAR(10),
					@BENABLETEMPDB BIT,
					@CERRORMSG VARCHAR(500),
					@CKEYFIELD VARCHAR(22),	
					@NCKEYFIELDLEN INT,		
					@NSAVETRANLOOP	BIT,
					@CCMD NVARCHAR(MAX),
					@CMEMODEPTID VARCHAR(4),
					@CNEW_USERS_CODE VARCHAR(7)

			SET @NSTEP = 0		-- SETTTING UP ENVIRONMENT		
			SET @CTEMPDBNAME = ''	
				  
			SET @CMASTERTABLENAME ='MERCHANDISER_MST'		

			SET @CTEMPMASTERTABLE  ='TEMP_MERCHANDISER_MST_'+LTRIM(RTRIM(STR(@NSPID)))		
			SET @CTEMPMASTERTABLENAME = @CTEMPDBNAME + @CTEMPMASTERTABLE

			SET @CDETAILTABLENAME ='MERCHANDISER_LOC'	
			SET @CTEMPDETAILTABLE  ='TEMP_MERCHANDISER_LOC_'+LTRIM(RTRIM(STR(@NSPID)))		
			SET @CTEMPDETAILTABLENAME = @CTEMPDBNAME + @CTEMPDETAILTABLE

			SET @CKEYFIELD = 'USER_CODE'
			SET @NCKEYFIELDLEN	= 7
			SET @NSTEP = 10		-- BEGIN TRANSACTION    
	BEGIN TRY
		BEGIN TRANSACTION
	     
			SET @NSTEP = 30		
			 SET @CNEW_USERS_CODE =@CUSERS_CODE 
		   
			SET @NSTEP = 90
			IF @CNEW_USERS_CODE IS NULL  
			BEGIN   
				SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR PLEASE ENTER USERS CODE FOR UPDATING....'	
				GOTO END_PROC  		
			END
			   
			IF @NUPDATEMODE <> 3
			BEGIN
				SET @CCMD = N'UPDATE ' + @CTEMPMASTERTABLENAME + ' SET USER_CODE ='''+ @CUSERS_CODE +''', LAST_UPDATE=GETDATE()'  --WHERE ' + @CKEYFIELD + ' = ''' + @CNEW_USERS_CODE + ''''
				EXEC SP_EXECUTESQL @CCMD
			   
				SET @CCMD = N'UPDATE ' + @CTEMPDETAILTABLENAME + ' SET USER_CODE ='''+ @CUSERS_CODE +''', LAST_UPDATE=GETDATE()'  --WHERE ' + @CKEYFIELD + ' = ''' + @CNEW_USERS_CODE + ''''
				EXEC SP_EXECUTESQL @CCMD
			END
			    
				
				
			SET @NSTEP = 140
			IF LTRIM(RTRIM(ISNULL(@CNEW_USERS_CODE,'LATER'))) = 'LATER'
			BEGIN
				SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' ERROR CREATING NEXT USERS_CODE....'
				GOTO END_PROC
			END
		
			SET @NSTEP = 160 
			-- UPDATING MASTER TABLE FROM TEMP TABLE
			IF @NUPDATEMODE = 1 OR @NUPDATEMODE = 2
			BEGIN

					EXEC UPDATEMASTERXN 
					@CSOURCEDB	= @CTEMPDBNAME
					, @CSOURCETABLE = @CTEMPMASTERTABLE
					, @CDESTDB		= ''
					, @CDESTTABLE	= @CMASTERTABLENAME
					, @CKEYFIELD1	= @CKEYFIELD
					, @BALWAYSUPDATE = 1

					SET @CCMD = N'DELETE  FROM MERCHANDISER_LOC  WHERE USER_CODE='''+@CNEW_USERS_CODE+''''
					PRINT @CCMD
					EXEC SP_EXECUTESQL @CCMD


					EXEC UPDATEMASTERXN 
					@CSOURCEDB	= @CTEMPDBNAME
					, @CSOURCETABLE = @CTEMPDETAILTABLE
					, @CDESTDB		= ''
					, @CDESTTABLE	= @CDETAILTABLENAME
					, @CKEYFIELD1	= @CKEYFIELD
					, @CKEYFIELD2	= 'DEPT_ID'
					, @BALWAYSUPDATE = 1
			END
			ELSE IF @NUPDATEMODE = 3 
			BEGIN
					SET @CCMD = N'DELETE FROM MERCHANDISER_LOC  WHERE USER_CODE='''+@CNEW_USERS_CODE+''''
					PRINT @CCMD
					EXEC SP_EXECUTESQL @CCMD
					SET @CCMD = N'DELETE  FROM MERCHANDISER_MST   WHERE USER_CODE='''+@CNEW_USERS_CODE+''''
					PRINT @CCMD
					EXEC SP_EXECUTESQL @CCMD				   
			END
	END TRY
    BEGIN CATCH
			SET @CERRORMSG = 'STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()
			GOTO END_PROC
    END CATCH
END_PROC:
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			COMMIT TRANSACTION
		ELSE
			ROLLBACK 	
	END 


			--SET @CCMD = N'IF OBJECT_ID('''+@CTEMPMASTERTABLENAME+''',''U'') IS NOT NULL
			--						DROP TABLE '+@CTEMPMASTERTABLENAME+'
			--			IF OBJECT_ID('''+@CTEMPDETAILTABLENAME+''',''U'') IS NOT NULL
			--						DROP TABLE '+@CTEMPDETAILTABLENAME+''
			--PRINT @CCMD
			--EXEC SP_EXECUTESQL @CCMD 
			  		   		     
			SELECT ISNULL(@CERRORMSG,'') AS ERRMSG,@CNEW_USERS_CODE AS USERS_CODE
END
----'END OF  PROCEDURE SAVETRAN_MERCHANDISER'
