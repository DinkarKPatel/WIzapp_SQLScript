CREATE PROCEDURE DBO.SP_MERGE_MIRROR_MSTWPAY
(
 @NMODE INT=1, -- 1. CLEAR PREVIOUS TEMP ENTRIES , 2. MERGE THE NEW DATA
  @XN_TYPE VARCHAR(50) ='MSTWPAY'
)
AS
----WITH ENCRYPTION
BEGIN
   BEGIN TRY
 --DECLARE LOCAL VARIABLE
   DECLARE @NSTEP INT,@CTABLENAME VARCHAR(200),@CERRMSG VARCHAR(MAX),@CCURDEPTID VARCHAR(5)
          ,@CHODEPTID VARCHAR(5),@CSOURCEDB VARCHAR(100),@CTMP_TABLENAME VARCHAR(200)
          ,@CKEYFIELD VARCHAR(100),@CFILTERCONDITION VARCHAR(1000),@BPROCEED BIT,@NMEMONOLEN INT
          ,@CXNTYPE VARCHAR(200),@BEMPHEADSUPDATED INT
   
        --CHECKED LOCATION FROM CURRENT AND HO
        SET @NSTEP=10
        SELECT @CCURDEPTID = VALUE FROM CONFIG WHERE CONFIG_OPTION='LOCATION_ID'
		SELECT @CHODEPTID =  VALUE FROM CONFIG WHERE CONFIG_OPTION='HO_LOCATION_ID'	
   
       IF @CCURDEPTID=@CHODEPTID
		BEGIN
				SET @CERRMSG='P:SP_MERGE_MIRROR_MSTWPAY, CANNOT CALL MERGING PROC AT HEAD OFFICE'
				GOTO END_PROC;
  		END		
  		BEGIN TRANSACTION

		 IF ISNULL(@NMODE,0) = 1
         GOTO END_PROC;
	   		
  		------MEARGE DATA FROM MIRROR TABLE TO MAIN TABLE-----
  		------INSERT DATA FROM MSTWPAY_REGIONM_MIRROR TABLE TO REGIONM TABLE-----
  		
  		SELECT @CERRMSG='',@BPROCEED=1,@NMEMONOLEN=10,@CXNTYPE='MSTWPAY',@BEMPHEADSUPDATED=0,
		@CFILTERCONDITION='',@CSOURCEDB =''
  		
  		SET @NSTEP=20
		SET @CTABLENAME='REGIONM'
		SET @CTMP_TABLENAME='MSTWPAY_REGIONM_MIRROR'
		SET @CKEYFIELD='REGION_CODE'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
		--SELECT @@ROWCOUNT AS [ROWNO]
        ------INSERT DATA FROM MSTWPAY_STATE_MIRROR TABLE TO STATE TABLE-----
  		SET @NSTEP=30
		SET @CTABLENAME='STATE'
		SET @CTMP_TABLENAME='MSTWPAY_STATE_MIRROR'
		SET @CKEYFIELD='STATE_CODE'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
  		
  		
  		------INSERT DATA FROM MSTWPAY_CITY_MIRROR TABLE TO CITY TABLE-----
  		SET @NSTEP=40
		SET @CTABLENAME='CITY'
		SET @CTMP_TABLENAME='MSTWPAY_CITY_MIRROR'
		SET @CKEYFIELD='CITY_CODE'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
  		
  		------INSERT DATA FROM MSTWPAY_AREA_MIRROR TABLE TO AREA TABLE-----
  		SET @NSTEP=50
		SET @CTABLENAME='AREA'
		SET @CTMP_TABLENAME='MSTWPAY_AREA_MIRROR'
		SET @CKEYFIELD='AREA_CODE'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
  		
  		------INSERT DATA FROM MSTWPAY_EMP_SALARY_MST_MIRROR TABLE TO EMP_SALARY_MST TABLE-----
  		SET @NSTEP=60
		SET @CTABLENAME='EMP_SALARY_MST'
		SET @CTMP_TABLENAME='MSTWPAY_EMP_SALARY_MST_MIRROR'
		SET @CKEYFIELD='SALARY_PROFILE_ID'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1
								  
       ------INSERT DATA FROM MSTWPAY_EMP_SALARY_MST_MIRROR TABLE TO EMP_SALARY_MST TABLE-----
  		SET @NSTEP=70
		SET @CTABLENAME='EMP_SHIFTS'
		SET @CTMP_TABLENAME='MSTWPAY_EMP_SHIFTS_MIRROR'
		SET @CKEYFIELD='SHIFT_ID'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1								  
  		------INSERT DATA FROM MSTWPAY_EMP_SALARY_MST_MIRROR TABLE TO EMP_SALARY_MST TABLE-----
  		SET @NSTEP=80
		SET @CTABLENAME='EMP_DESIG'
		SET @CTMP_TABLENAME='MSTWPAY_EMP_DESIG_MIRROR'
		SET @CKEYFIELD='DESIG_ID'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1		

  		SET @NSTEP=90
		SET @CTABLENAME='EMP_DEPARTMENT'
		SET @CTMP_TABLENAME='MSTWPAY_EMP_DEPARTMENT_MIRROR'
		SET @CKEYFIELD='DEPARTMENT_ID'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1										  
								  								  
        ------INSERT DATA FROM EMP_MST TABLE TO EMP_SALARY_MST TABLE-----
  		SET @NSTEP=100
		SET @CTABLENAME='EMP_MST'
		SET @CTMP_TABLENAME='MSTWPAY_EMP_MST_MIRROR'
		SET @CKEYFIELD='EMP_ID'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1										  
								  
								  
		DELETE FROM EMP_SHIFT_LOC								  
		------INSERT DATA FROM EMP_MST TABLE TO EMP_SALARY_MST TABLE-----
  		SET @NSTEP=110
		SET @CTABLENAME='EMP_SHIFT_LOC'
		SET @CTMP_TABLENAME='MSTWPAY_EMP_SHIFT_LOC_MIRROR'
		SET @CKEYFIELD='SHIFT_ID'

		EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=''
								  ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''
								  ,@LINSERTONLY=0,@CFILTERCONDITION=@CFILTERCONDITION,@LUPDATEONLY=0
								  ,@BALWAYSUPDATE=1							  
								  
  
 END TRY

BEGIN CATCH
	SET @CERRMSG='P:SP_MERGE_MIRROR_MSTWPAY, STEP:'+STR(@NSTEP)+', MESSAGE:'+ERROR_MESSAGE()
	GOTO END_PROC
END CATCH

END_PROC:
	
	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRMSG,'')='' 
			COMMIT
		ELSE
			ROLLBACK	
	END
	
	IF ISNULL(@CERRMSG,'')='' 
	BEGIN   
	    
		    DELETE FROM  MSTWPAY_REGIONM_MIRROR 
			DELETE FROM  MSTWPAY_STATE_MIRROR 
			DELETE FROM  MSTWPAY_CITY_MIRROR 
			DELETE FROM  MSTWPAY_AREA_MIRROR 
			DELETE FROM  MSTWPAY_EMP_SALARY_MST_MIRROR 
			DELETE FROM  MSTWPAY_EMP_SHIFTS_MIRROR 
			DELETE FROM  MSTWPAY_EMP_DEPARTMENT_MIRROR 
			DELETE FROM  MSTWPAY_EMP_DESIG_MIRROR 
			DELETE FROM  MSTWPAY_EMP_MST_MIRROR 
			DELETE FROM  MSTWPAY_EMP_SHIFT_LOC_MIRROR   
   

	   
	END
 
  
   SELECT 'MSTWPAY' AS MEMO_ID,ISNULL(@CERRMSG,'') AS ERRMSG
   
    --DELETE DATA FROM MIRROR TABLE----
         
   
END
