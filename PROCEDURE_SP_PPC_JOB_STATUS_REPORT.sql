
CREATE PROCEDURE SP_PPC_JOB_STATUS_REPORT    
(    
 @NQUERYID INT=1,
 @DASON AS DATETIME='2018-10-23',  
 @CBILL_NO VARCHAR(MAX)='' , 
 @CARTICLE_CODE VARCHAR(MAX)='',    
 @CSIZEGROUP VARCHAR(10)='', 
 @CPARA1_CODE VARCHAR(10)='',
 @CROW_ID varchar(100)='',
 @CAC_CODE VARCHAR(MAX)='',
 @CJOB_CODE VARCHAR(MAX)=''
 
)    
AS    
BEGIN    
    
	   
DECLARE @DTSQL NVARCHAR(MAX),@CFGFILTER VARCHAR(MAX),@CRMFILTER VARCHAR(MAX),
@CAC_CODEFILTER VARCHAR(MAX)

SET @CFGFILTER=''
SET @CRMFILTER=''
SET @CAC_CODEFILTER=''
   
IF ISNULL(@CBILL_NO,'')<>''
    SET @CFGFILTER =@CFGFILTER+' AND A.BILL_NO '+@CBILL_NO+''

IF ISNULL(@CARTICLE_CODE,'')<>''
    SET @CFGFILTER =@CFGFILTER+' AND B.ARTICLE_CODE '+@CBILL_NO+''
    
    
    
	--if @NQUERYID =1
	--select @CAC_CODE as a
	--into sss
   
IF @CAC_CODE<>''
   SET @CRMFILTER =@CRMFILTER+' AND ISNULL(J.AC_CODE,'''') '+@CAC_CODE+''
IF @CJOB_CODE<>''
   SET @CRMFILTER =@CRMFILTER+' AND A.JOB_CODE '+@CJOB_CODE+''
  
IF @CAC_CODE<>''
SET @CAC_CODEFILTER=' AND ISNULL(AC_CODE,'''') '+@CAC_CODE+''   		    
		
	
	
	--select * from sss
	  IF OBJECT_ID('TEMPDB..#TMPWO','U') IS NOT NULL    
			DROP TABLE #TMPWO    
		        
			SELECT A.AC_CODE,A.BILL_NO ,ORDER_NO,ORDER_DT,A.ORDER_ID,B.DELIVERY_DT,
					B.ARTICLE_CODE , B.PARA1_CODE,b.SIZEGROUP_CODE ,
					CAST(SUM(B.QUANTITY) AS NUMERIC(10,2)) AS ORDER_QTY,
					CAST(0 AS NUMERIC(10,2)) AS DLVRD,
					CAST(0 AS NUMERIC(10,2)) AS PENDING_BO,
					B.ROW_ID,
					CAST('' AS VARCHAR(100)) AS JOB_CODE,
					CAST('' AS VARCHAR(100)) AS JOB_NAME,
					CAST(0 AS NUMERIC(10,0)) AS JOB_ORDER
			 INTO #TMPWO
			 FROM PPC_BUYER_ORDER_MST A
			 JOIN PPC_BUYER_ORDER_DET B ON A.ORDER_ID =B.ORDER_ID 
			 WHERE 1=2   
			 GROUP BY A.AC_CODE,A.BILL_NO ,ORDER_NO,ORDER_DT,A.ORDER_ID,B.DELIVERY_DT,
			 B.ARTICLE_CODE , B.PARA1_CODE,b.SIZEGROUP_CODE,B.ROW_ID  
		   
		     SET @DTSQL=N' SELECT A.AC_CODE,A.BILL_NO ,ORDER_NO,ORDER_DT,A.ORDER_ID,B.DELIVERY_DT,
					B.ARTICLE_CODE , B.PARA1_CODE,b.SIZEGROUP_CODE ,
					SUM(B.QUANTITY) AS ORDER_QTY,
					0 AS DLVRD,
					SUM(B.QUANTITY-ISNULL(ST.QUANTITY,0)) AS PENDING_BO,
					B.ROW_ID,
					JOBS.JOB_CODE,
					JOBS.JOB_NAME,
					ISNULL(J.JOB_ORDER,0) AS JOB_ORDER
			 FROM PPC_BUYER_ORDER_MST A (NOLOCK)
			 JOIN PPC_BUYER_ORDER_DET B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID 
			 LEFT JOIN
			 (
			   
			   SELECT REF_ROW_ID ,JOB_CODE ,JOB_ORDER
			   FROM PPC_BO_ART_JOBS (NOLOCK)
			   GROUP BY REF_ROW_ID ,JOB_CODE ,JOB_ORDER
		
			 ) J ON J.REF_ROW_ID=B.ROW_ID
			 LEFT JOIN JOBS ON JOBS.JOB_CODE=J.JOB_CODE
			  JOIN
			 (
				SELECT BO_DET_ROW_ID  ,
					   SUM(QUANTITY) AS QUANTITY
				FROM PPC_FGBCG_MST A (NOLOCK)
				JOIN PPC_FGBCG_DET B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
				WHERE A.CANCELLED =0 
				GROUP BY BO_DET_ROW_ID
			 ) ST ON ST.BO_DET_ROW_ID=B.ROW_ID
			 WHERE A.CANCELLED =0
		   AND A.ORDER_DT<='''+CONVERT(VARCHAR(11),@DASON,120)+'''    
		   '+@CFGFILTER+       
		  'GROUP BY A.AC_CODE,A.BILL_NO ,ORDER_NO,ORDER_DT,A.ORDER_ID,B.DELIVERY_DT,
		  B.ARTICLE_CODE , B.PARA1_CODE,b.SIZEGROUP_CODE ,B.ROW_ID,JOBS.JOB_CODE,
		  JOBS.JOB_NAME,JOB_ORDER  '    
		  PRINT @DTSQL    
		  INSERT INTO #TMPWO    
		  EXEC SP_EXECUTESQL @DTSQL  
		  
		  
		 

            
         IF OBJECT_ID('TEMPDB..#TMPJOBS','U') IS NOT NULL
           DROP TABLE #TMPJOBS
           
         IF OBJECT_ID('TEMPDB..#TMPJOBSDETAILS','U') IS NOT NULL
           DROP TABLE #TMPJOBSDETAILS
          
        SELECT PRODUCT_CODE ,A.MEMO_ID ,MEMO_DT ,JOBSR=1 ,B.JOB_CODE,JOBS.JOB_NAME ,
        case when ISNULL(memo_type,0)=1 then A.QUANTITY else 0 end as ISSUE_QTY,
        case when ISNULL(memo_type,0)<>1 then A.QUANTITY else 0 end as ret_QTY,
		b.AC_CODE,lm.AC_NAME ,A.ROW_ID 
		INTO #TMPJOBS
		FROM PPC_AGENCY_ISSUE_FG_FIRST_DET A (NOLOCK)
		JOIN PPC_AGENCY_ISSUE_FG_FIRST_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
		JOIN JOBS (NOLOCK)  ON b.JOB_CODE=JOBS.JOB_CODE
		JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =B.AC_CODE 
		WHERE B.CANCELLED =0
        UNION ALL
        SELECT PRODUCT_CODE ,A.MEMO_ID ,MEMO_DT  ,JOBSR=2,B.JOB_CODE ,JOBS.JOB_NAME, 
        case when ISNULL(memo_type,0)=1 then A.QUANTITY else 0 end as ISSUE_QTY,
        case when ISNULL(memo_type,0)<>1 then A.QUANTITY else 0 end as ret_QTY,
        b.AC_CODE,lm.AC_NAME ,A.ROW_ID 
		FROM PPC_AGENCY_ISSUE_FG_DET A (NOLOCK)
		JOIN PPC_AGENCY_ISSUE_FG_MST B (NOLOCK) ON A.MEMO_ID =B.MEMO_ID 
	    JOIN JOBS (NOLOCK) ON b.JOB_CODE=JOBS.JOB_CODE
	    JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =B.AC_CODE 
		WHERE B.CANCELLED =0  
       
      -- SELECT * INTO TMPJOBS FROM #TMPJOBS
       
       IF OBJECT_ID('TEMPDB..#TMPPRODUCT','U') IS NOT NULL
           DROP TABLE #TMPPRODUCT
           
        SELECT A.PRODUCT_CODE ,A.MEMO_ID ,A.MEMO_DT ,A.JOBSR ,A.JOB_CODE,A.JOB_NAME ,
                BO.PARA3_CODE,BO.ARTICLE_CODE,BO.PARA1_CODE,BO.SIZEGROUP_CODE,
		       MST.ORDER_ID  ,SKU.PARA2_CODE ,P2.PARA2_NAME ,
			   PMT.QUANTITY_IN_STOCK AS JOB_QTY,
			   TPMT.QUANTITY_IN_STOCK ,
			   BO.ROW_ID,
			   A.AC_CODE ,
			   A.AC_NAME ,
			   ISSUE_QTY,
			   ret_QTY,
			   ISNULL(rec.QUANTITY,0) as REC_QTY
	    INTO #TMPPRODUCT
		FROM #TMPJOBS A
		JOIN PPC_FG_SKU SKU (NOLOCK) ON A.PRODUCT_CODE =SKU.PRODUCT_CODE 
		JOIN PPC_FG_PMT PMT (NOLOCK) ON PMT.PRODUCT_CODE=SKU.PRODUCT_CODE 
		JOIN PPC_FGBCG_DET FGDET (NOLOCK) ON FGDET.ROW_ID =SKU.PPC_FGBCG_DET_ROW_ID 
		JOIN PPC_FGBCG_MST FGMST (NOLOCK) ON FGMST.MEMO_ID  =FGDET.MEMO_ID 
		JOIN PPC_BUYER_ORDER_DET (NOLOCK) BO ON BO.ROW_ID=FGDET.BO_DET_ROW_ID
		JOIN PPC_BUYER_ORDER_MST (NOLOCK) MST ON BO.ORDER_ID=MST.ORDER_ID
		LEFT JOIN PMT01106 TPMT (NOLOCK) ON PMT.PRODUCT_CODE =TPMT.product_code 
		JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =SKU.PARA2_CODE 
		LEFT OUTER JOIN
		(
		 SELECT B.PRODUCT_CODE FROM PPC_INM01106 A (NOLOCK)
		 JOIN PPC_IND01106 B (NOLOCK) ON A.INV_ID =B.INV_ID
		 WHERE A.CANCELLED =0
		) INM ON A.PRODUCT_CODE =INM.PRODUCT_CODE 
		left join
		(
		 SELECT a.REF_ROW_ID ,SUM(a.QUANTITY  ) AS QUANTITY
		 FROM PPC_AGENCY_REC_FG_DET a (NOLOCK)
		 join PPC_AGENCY_REC_FG_MST b (NOLOCK) on a.MEMO_ID =b.MEMO_ID  
		 where b.CANCELLED =0
		 GROUP BY a.REF_ROW_ID 
		) rec on a.ROW_ID =rec.ref_row_id
		WHERE  MST.CANCELLED=0   AND  FGMST .CANCELLED=0
		AND INM.PRODUCT_CODE IS NULL
		AND (@CROW_ID='' OR BO.ROW_ID=@CROW_ID)
		

		SELECT A.PRODUCT_CODE ,A.JOB_CODE,A.JOB_NAME ,
                A.PARA3_CODE,A.ARTICLE_CODE,A.PARA1_CODE,A.SIZEGROUP_CODE,
		       A.ORDER_ID  ,A.PARA2_CODE ,A.PARA2_NAME ,
			   --A.QUANTITY_IN_STOCK AS JOB_QTY,
			   SUM(A.QUANTITY_IN_STOCK ) AS QUANTITY_IN_STOCK,
			   A.ROW_ID,
			   A.AC_CODE ,
			   A.AC_NAME ,
			  1 AS ISSUE_QTY,
			   SUM(ISNULL(ISSUE_QTY,0)+ISNULL(RET_QTY,0)) as JWI,
			   SUM(ISNULL(REC_QTY,0)) AS JWR,
			  CAST( SUM(ISNULL(ISSUE_QTY,0)+ISNULL(RET_QTY,0))-SUM(ISNULL(REC_QTY,0)) AS NUMERIC(10,0)) AS JOB_QTY
			  INTO #TMPJOBSDETAILS
		FROM #TMPPRODUCT A
		GROUP BY A.PRODUCT_CODE ,A.JOB_CODE,A.JOB_NAME ,
        A.PARA3_CODE,A.ARTICLE_CODE,A.PARA1_CODE,A.SIZEGROUP_CODE,
		A.ORDER_ID  ,A.PARA2_CODE ,A.PARA2_NAME ,
        A.ROW_ID,A.AC_CODE ,A.AC_NAME 
		
		
	
		
		
     IF @NQUERYID=1
	 BEGIN 
	 --	DROP TABLE TMPJOBSDETAILS
		--SELECT * INTO TMPJOBSDETAILS FROM #TMPJOBSDETAILS
		-- DROP TABLE TMPWO
		--  SELECT * INTO TMPWO FROM #TMPWO  

	 
	     
		 SET @DTSQL=N' SELECT ISNULL(J.AC_CODE,'''') AS AC_CODE, ISNULL(J.AC_NAME,'''') AS AC_NAME,
				 A.BILL_NO AS ORDER_NO,A.ORDER_NO AS SYS_ORDER_NO,
				 CONVERT(VARCHAR(10),A.ORDER_DT,105) AS ORDER_DT,
				 A.ORDER_ID,
				 CONVERT(VARCHAR(10),A.DELIVERY_DT,105) AS DELIVERY_DT,
				 A.ARTICLE_CODE, ART.ARTICLE_NO,
				 A.PARA1_CODE,P1.PARA1_NAME,
				 a.SIZEGROUP_CODE, SZ.SIZEGROUP_NAME,  
				 convert(numeric(10,0),A.ORDER_QTY) as ORDER_QTY,
				 a.JOB_CODE,
				 JOB_NAME ,
				 A.ROW_ID 
				 ,JOB_ORDER,
				 ISNULL(ISSUE_QTY,0) as TOTAL_JOB_QTY,
				 ISNULL(PENDING_QTY,0) as PENDING_QTY,
				 ISNULL(ISSUE_QTY,0)-ISNULL(PENDING_QTY,0) as WIP_QTY,
				 ISNULL(QUANTITY_IN_STOCK,0) as QUANTITY_IN_STOCK
				
		  FROM #TMPWO  A
		  JOIN ARTICLE ART ON ART.ARTICLE_CODE =A.ARTICLE_CODE 
		  JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE
		  JOIN PPC_SIZEGROUP SZ ON SZ.SIZEGROUP_CODE =A.SIZEGROUP_CODE  
		  JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
		  LEFT JOIN
		  (
		   SELECT ROW_ID ,JOB_CODE ,A.AC_CODE ,A.AC_NAME ,
		        SUM(ISNULL(ISSUE_QTY,0)) AS ISSUE_QTY,
		        SUM(CASE WHEN ISNULL(A.JOB_QTY,0)>0 THEN JOB_QTY ELSE 0 END) AS PENDING_QTY,
		        SUM(ISNULL(CONVERT(NUMERIC(10,0),QUANTITY_IN_STOCK),0)) AS QUANTITY_IN_STOCK
		   FROM #TMPJOBSDETAILS A
		   GROUP BY ROW_ID ,JOB_CODE ,A.AC_CODE ,A.AC_NAME 
		  
		  ) J ON J.ROW_ID =A.ROW_ID AND J.JOB_CODE =A.JOB_CODE 
		  WHERE 1=1 '+@CRMFILTER+
		   '
		  ORDER BY ORDER_DT ,ORDER_NO ,JOB_ORDER '
		print  @DTSQL
		exec sp_executesql  @DTSQL
		  
		   --AND ('''+RTRIM(LTRIM(@AAC_STATUS))+'''='''' OR A.AC_CODE '+@CAC_CODE+')    
	 
	 
	 end
	 else
	 begin
	 
	 
	 SELECT  A.ORDER_ID, A.PARA3_CODE,A.ARTICLE_CODE,A.PARA1_CODE,A.SIZEGROUP_CODE ,
		        A.JOB_CODE,A.JOB_NAME,
		        para2_code, PARA2_NAME,
		        SUM(ISNULL(A.JOB_QTY,0)) AS JOB_QTY,
		        A.ROW_ID 
		FROM #TMPJOBSDETAILS A
		where (@CAC_CODE='' OR A.AC_CODE =@CAC_CODE)
		AND (@CJOB_CODE ='' OR JOB_CODE =@CJOB_CODE )
		GROUP BY A.ORDER_ID, A.PARA3_CODE,A.ARTICLE_CODE ,
		A.JOB_CODE,A.JOB_NAME,A.PARA1_CODE,A.SIZEGROUP_CODE,
		A.ROW_ID ,para2_code, PARA2_NAME
		HAVING SUM(ISNULL(A.JOB_QTY,0))<>0
		ORDER BY A.ORDER_ID
		


		--SET @DTSQL=N'SELECT  A.ORDER_ID, A.PARA3_CODE,A.ARTICLE_CODE,A.PARA1_CODE,A.SIZEGROUP_CODE ,
		--        A.JOB_CODE,A.JOB_NAME,
		--        para2_code, PARA2_NAME,
		--        SUM(ISNULL(A.JOB_QTY,0)) AS JOB_QTY,
		--        A.ROW_ID 
		--FROM #TMPJOBSDETAILS A
		--where ('''+@CJOB_CODE+'''='''' or a.JOB_CODE ='''+@CJOB_CODE+''')'
		--+@CAC_CODEFILTER +
  --      'GROUP BY A.ORDER_ID, A.PARA3_CODE,A.ARTICLE_CODE ,
		--A.JOB_CODE,A.JOB_NAME,A.PARA1_CODE,A.SIZEGROUP_CODE,
		--A.ROW_ID ,para2_code, PARA2_NAME
		--HAVING SUM(ISNULL(A.JOB_QTY,0))<>0
		--ORDER BY A.ORDER_ID
		
		--'
		--PRINT @DTSQL
		--EXEC SP_EXECUTESQL @DTSQL
		
      END
     
	 
END 

