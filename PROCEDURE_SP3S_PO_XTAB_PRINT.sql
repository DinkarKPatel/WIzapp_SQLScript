CREATE PROCEDURE SP3S_PO_XTAB_PRINT
(
  @CXN_TYPE VARCHAR(10),
  @CMEMO_ID VARCHAR(100)
)
--WITH ENCRYPTION 
AS
BEGIN
IF @CXN_TYPE='PO'
GOTO PODETAILS
ELSE
GOTO END_PROC
     
     DECLARE @CCMD NVARCHAR(MAX),@FILTER VARCHAR(1000)
  
 PODETAILS: 
       IF OBJECT_ID ('TEMPDB..#TEMP','U') IS NOT NULL
          DROP TABLE #TEMP
         
             SELECT A.ARTICLE_NO,P1.PARA1_NAME ,P2.PARA2_NAME ,M.MRP, SKU.PURCHASE_PRICE,MRR_DT AS RECEIPT_DT ,QUANTITY,
                   ISNULL(RECEIPT_QTY,0) AS  RECEIPT_QTY ,
				    SR=CAST(DENSE_RANK () OVER ( ORDER BY  A.ARTICLE_NO,P1.PARA1_NAME,M.MRP, SKU.PURCHASE_PRICE,MRR_DT ) AS NUMERIC(18,2)),
				    SUB_SECTION_NAME ,SECTION_NAME ,UOM_NAME,
				    PO.PO_NO,PO.PO_ID,CONVERT(VARCHAR,PO_DT,105) AS PO_DT,
				    LM.AC_NAME,PO.TOTAL_AMOUNT,PO.SUBTOTAL,PO.DISCOUNT_PERCENTAGE,
				    PO.DISCOUNT_AMOUNT,
				    CANCELLED=CASE WHEN CANCELLED=0 THEN '' ELSE 'CANCELLED' END,
				    CONVERT(VARCHAR,M.DELIVERY_DT,105) AS POD_DELIVERY_DT,
				    L.DEPT_NAME,BIN.BIN_NAME,
				    P2.PARA2_ORDER 
				    
				   
		    INTO #TEMP
			FROM POD01106 M (NOLOCK)
			JOIN POM01106 PO ON M.PO_ID=PO.PO_ID
			LEFT JOIN
			(
			  SELECT PRODUCT_CODE, MRR_DT ,SUM(QUANTITY) AS RECEIPT_QTY FROM PID01106 PID (NOLOCK) 
			  JOIN PIM01106 PIM (NOLOCK) ON PIM.MRR_ID=PID.MRR_ID
			  WHERE PIM.CANCELLED =0 AND ISNULL(PRODUCT_CODE,'')<>''
			  GROUP BY MRR_DT,PRODUCT_CODE
			) PID ON PID.PRODUCT_CODE =M.PRODUCT_CODE
			JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE =M.PRODUCT_CODE 
			JOIN ARTICLE A (NOLOCK) ON A.ARTICLE_CODE =SKU.ARTICLE_CODE 
			JOIN PARA1 P1 (NOLOCK) ON P1.PARA1_CODE =M.PARA1_CODE 
			JOIN PARA2 P2 (NOLOCK) ON P2.PARA2_CODE =M.PARA2_CODE 
			JOIN SECTIOND SD (NOLOCK) ON SD.SUB_SECTION_CODE =A.SUB_SECTION_CODE 
			JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE =SM.SECTION_CODE
			JOIN UOM (NOLOCK) ON UOM.UOM_CODE=A.UOM_CODE
			JOIN BIN (NOLOCK) ON BIN.BIN_ID =PO.BIN_ID 
			JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =PO.AC_CODE 
			JOIN LOCATION L ON L.DEPT_ID =PO.DEPT_ID 
			JOIN FORM F1 ON F1.FORM_ID =PO.FORM_ID 
			WHERE M.PO_ID= @CMEMO_ID
			ORDER BY A.ARTICLE_NO,P1.PARA1_NAME,M.MRP, M.PURCHASE_PRICE,MRR_DT 


			DECLARE @MINSR INT,@MAXSR INT
			SET @MINSR=1
			SET @MAXSR=(SELECT MAX(SR) FROM #TEMP)

			WHILE @MINSR<=@MAXSR
			BEGIN

			INSERT INTO #TEMP(ARTICLE_NO,PARA1_NAME,PARA2_NAME,MRP ,QUANTITY,SR ,SUB_SECTION_NAME,SECTION_NAME,UOM_NAME
			                  ,BIN_NAME ,PO_NO,PO_ID,AC_NAME,TOTAL_AMOUNT,CANCELLED,DEPT_NAME,PO_DT,SUBTOTAL ,DISCOUNT_AMOUNT ,DISCOUNT_PERCENTAGE,POD_DELIVERY_DT,PARA2_ORDER ,PURCHASE_PRICE ,RECEIPT_DT ,RECEIPT_QTY   )
				    
			SELECT ARTICLE_NO,PARA1_NAME,'TOTAL QTY' AS PARA2_NAME,MRP,SUM(QUANTITY),@MINSR+.10,SUB_SECTION_NAME,SECTION_NAME ,UOM_NAME
			       ,BIN_NAME ,PO_NO,PO_ID,AC_NAME,TOTAL_AMOUNT,CANCELLED,DEPT_NAME,PO_DT,SUBTOTAL ,DISCOUNT_AMOUNT ,DISCOUNT_PERCENTAGE,POD_DELIVERY_DT ,999 ,PURCHASE_PRICE ,RECEIPT_DT ,SUM(RECEIPT_QTY)
			 FROM #TEMP WHERE SR=@MINSR 
			GROUP BY ARTICLE_NO,PARA1_NAME,MRP,SUB_SECTION_NAME,SECTION_NAME ,UOM_NAME
			         ,BIN_NAME ,PO_NO,PO_ID,AC_NAME,TOTAL_AMOUNT,CANCELLED,DEPT_NAME,PO_DT,SUBTOTAL ,DISCOUNT_AMOUNT ,DISCOUNT_PERCENTAGE,POD_DELIVERY_DT ,PURCHASE_PRICE ,RECEIPT_DT 
			UNION ALL
			SELECT ARTICLE_NO,PARA1_NAME,'TOTALAMT' AS PARA2_NAME,MRP,SUM(MRP*QUANTITY),@MINSR+.20,SUB_SECTION_NAME,SECTION_NAME ,UOM_NAME
			       ,BIN_NAME ,PO_NO,PO_ID,AC_NAME,TOTAL_AMOUNT,CANCELLED,DEPT_NAME,PO_DT,SUBTOTAL ,DISCOUNT_AMOUNT ,DISCOUNT_PERCENTAGE ,POD_DELIVERY_DT,1000 ,PURCHASE_PRICE ,RECEIPT_DT ,SUM(MRP*RECEIPT_QTY)
			 FROM #TEMP WHERE SR=@MINSR
			GROUP BY ARTICLE_NO,PARA1_NAME,MRP,SUB_SECTION_NAME,SECTION_NAME ,UOM_NAME 
			        ,BIN_NAME ,PO_NO,PO_ID,AC_NAME,TOTAL_AMOUNT,CANCELLED ,DEPT_NAME,PO_DT,SUBTOTAL ,DISCOUNT_AMOUNT ,DISCOUNT_PERCENTAGE,POD_DELIVERY_DT ,PURCHASE_PRICE ,RECEIPT_DT
			SET @MINSR=@MINSR+1

			END

			SELECT  ARTICLE_NO,PARA1_NAME ,PARA2_NAME ,MRP,QUANTITY,
			        PURCHASE_PRICE ,RECEIPT_DT,RECEIPT_QTY, 
				    SUB_SECTION_NAME ,SECTION_NAME ,UOM_NAME,
				    PO_NO,PO_ID,PO_DT,
				    AC_NAME,TOTAL_AMOUNT,SUBTOTAL,DISCOUNT_PERCENTAGE,
				    DISCOUNT_AMOUNT,
				    CANCELLED,
				    CONVERT(VARCHAR,POD_DELIVERY_DT,105) AS DELIVERY_DT,
				    DEPT_NAME,BIN_NAME,PARA2_ORDER
			 FROM #TEMP
			ORDER BY SR,PARA2_NAME
			
GOTO END_PROC
END_PROC:
END
--END OF PROCEDURE SP3S_PO_XTAB_PRINT
