CREATE PROCEDURE SP_TRACK_REPORT
(
 @CWHERE NVARCHAR(MAX),
 @CEMPCODE NVARCHAR(MAX) = '',
 @CACCODE NVARCHAR(MAX) = '',
 @CDATE NVARCHAR(MAX) = '',
 @CSTATUS NVARCHAR(MAX) = 'ALL'
)
--WITH ENCRYPTION

AS
BEGIN

DECLARE @CCMD NVARCHAR(MAX)

PRINT @CWHERE

IF OBJECT_ID('TEMPDB..##1','U') IS NOT NULL   
	DROP TABLE  ##1
IF OBJECT_ID('TEMPDB..##2','U') IS NOT NULL   
	DROP TABLE  ##2

SET @CCMD=N'SELECT A.REF_PRD_WORKORDER_MEMOID,AJ.AGENCY_NAME AS K_NAME,D.AGENCY_CHALLAN_NO AS CHALLAN_NO,
B.REF_COMPONENT_ARTICLE_CODE ,ART.ARTICLE_NO,E.JOB_NAME AS DEPARTMENT,  
B.ARTICLE_CODE,	A.MEMO_DT AS ISSUE_DT,D.MEMO_DT AS RECEIVE_DT,E.JOB_CODE,A.MEMO_NO AS ISSUE_NO ,
D.MEMO_NO AS RECEIPT_NO,1 AS XN_TYPE  INTO ##1 
FROM PRD_AGENCY_ISSUE_MATERIAL_MST A  (NOLOCK)           
JOIN PRD_AGENCY_ISSUE_MATERIAL_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID    
LEFT OUTER JOIN  PRD_AGENCY_MATERIAL_RECEIPT_DET C (NOLOCK) ON  B.ROW_ID=C.REF_ROW_ID       
LEFT OUTER JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID   AND D.CANCELLED =0            
JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE              
JOIN JOBS E (NOLOCK) ON E.JOB_CODE=A.JOB_CODE  
JOIN PRD_AGENCY_MST AJ (NOLOCK) ON AJ.AGENCY_CODE=A.REF_AGENCY_CODE  
WHERE A.CANCELLED=0 '+ CASE WHEN @CWHERE = '' THEN '' ELSE 'AND REF_PRD_WORKORDER_MEMOID IN ('+@CWHERE+')' END +'

UNION ALL   
SELECT A.REF_PRD_WORKORDER_MEMOID,''IN HOUSE'' AS K_NAME,'''' AS CHALLAN_NO,
B.REF_COMPONENT_ARTICLE_CODE ,ART.ARTICLE_NO,E.JOB_NAME AS DEPARTMENT,  
B.ARTICLE_CODE,	A.MEMO_DT AS ISSUE_DT,D.MEMO_DT AS RECEIVE_DT,E.JOB_CODE,A.MEMO_NO AS ISSUE_NO ,
D.MEMO_NO AS RECEIPT_NO,1 AS XN_TYPE 
FROM PRD_ISSUE_MATERIAL_MST A  (NOLOCK)           
JOIN PRD_ISSUE_MATERIAL_DET B (NOLOCK) ON A.MEMO_ID=B.MEMO_ID    
LEFT OUTER JOIN  PRD_MATERIAL_RECEIPT_DET C (NOLOCK) ON  B.ROW_ID=C.REF_ROW_ID       
JOIN PRD_MATERIAL_RECEIPT_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID  AND D.CANCELLED =0         
JOIN ARTICLE ART (NOLOCK) ON ART.ARTICLE_CODE=B.REF_COMPONENT_ARTICLE_CODE              
JOIN JOBS E (NOLOCK) ON E.JOB_CODE=A.JOB_CODE  
JOIN PRD_DEPARTMENT_MST DM ON DM.DEPARTMENT_ID=A.TARGET_DEPARTMENT_ID   
WHERE A.CANCELLED=0 '+ CASE WHEN @CWHERE = '' THEN '' ELSE 'AND A.REF_PRD_WORKORDER_MEMOID IN ('+@CWHERE+')' END +'


UNION ALL  
SELECT  D.REF_WO_ID AS REF_PRD_WORKORDER_MEMOID,LM.AC_NAME AS K_NAME,PM.BILL_NO AS CHALLAN_NO,
WOD.ARTICLE_CODE AS REF_COMPONENT_ARTICLE_CODE, ART.ARTICLE_NO,''HAND EMBROIDERY'' AS DEPARTMENT_NAME,
A.ARTICLE_CODE, B.PO_DT AS ISSUE_DT, PM.RECEIPT_DT  AS RECEIVE_DT,''0000002'' AS JOB_CODE,
B.PO_NO AS ISSUE_NO,PM.MRR_NO AS RECEIPT_NO,2 AS XN_TYPE   
FROM PRD_POD01106 A (NOLOCK)
JOIN PRD_POM01106 B (NOLOCK) ON A.PO_ID = B.PO_ID  AND B.CANCELLED=0
JOIN PRD_PO_WSL C (NOLOCK) ON B.PO_ID = C.PO_ID  
JOIN PRD_PS_MST D (NOLOCK) ON C.INV_ID=D.PS_ID 
LEFT OUTER JOIN PRD_WO_DET WOD (NOLOCK) ON WOD.MEMO_ID=D.REF_WO_ID  
LEFT OUTER JOIN ARTICLE ART (NOLOCK) ON  ART.ARTICLE_CODE=WOD.ARTICLE_CODE             
LEFT OUTER JOIN ARTICLE ART1 (NOLOCK) ON ART1.ARTICLE_CODE=A.ARTICLE_CODE             
LEFT OUTER JOIN LMV01106 LM (NOLOCK) ON LM.AC_CODE=B.AC_CODE 
LEFT OUTER JOIN PRD_PID01106 PD (NOLOCK) ON A.ROW_ID= PD.PO_ROW_ID 
LEFT OUTER JOIN PRD_PIM01106  PM (NOLOCK) ON PD.MRR_ID = PM.MRR_ID   AND PM.CANCELLED =0
'+ CASE WHEN @CWHERE = '' THEN '' ELSE 'WHERE  D.REF_WO_ID IN ('+@CWHERE+')' END +''
EXEC SP_EXECUTESQL @CCMD
PRINT @CCMD

SET @CCMD=N'SELECT A.JOB_CODE ,D.JOB_NAME , A.TARGET_DT,C.MEMO_ID,A.JOB_ORDER,B.ARTICLE_CODE INTO ##2
FROM PRD_WO_ART_JOBS A
JOIN PRD_WO_DET B ON A.REF_ROW_ID = B.ROW_ID 
JOIN PRD_WO_MST C ON B.MEMO_ID = C.MEMO_ID 
JOIN JOBS D ON A.JOB_CODE = D.JOB_CODE 
'+ CASE WHEN @CWHERE = '' THEN '' ELSE 'WHERE  C.MEMO_ID IN ('+@CWHERE+')' END +''
EXEC SP_EXECUTESQL @CCMD

PRINT @CCMD
--DELETE  FROM ##1   WHERE  XN_TYPE =2 AND RECEIPT_NO  IS  NULL

  
SELECT 
ORM.ORDER_NO ,
AR.ARTICLE_NO AS SET_NO  ,
AR1.ARTICLE_NO AS COMP_NO,
WOM.MEMO_NO AS WORK_ORDER_NO,
WOM.REF_NO,
ISNULL(CONVERT(VARCHAR,ORM.ORDER_DT ,105),' ') AS ORDER_DT,
ISNULL(CONVERT(VARCHAR,ORM.TRAIL_DT ,105),' ') AS TRAIL_DT,
ISNULL(CONVERT(VARCHAR,ORM.DELIVERY_DT ,105),' ') AS DELIVERY_DT,
CASE WHEN ISNULL(CONVERT(VARCHAR,DTM.MEMO_DT,105),'')<>''THEN     
     CASE WHEN DATEDIFF(DAY,ORM.DELIVERY_DT,DTM.MEMO_DT) <0  THEN 0 ELSE DATEDIFF(DAY,ORM.DELIVERY_DT,DTM.MEMO_DT) END     
     ELSE      
     CASE WHEN DATEDIFF(DAY,ORM.DELIVERY_DT,GETDATE())<0 THEN 0 ELSE DATEDIFF(DAY,ORM.DELIVERY_DT,GETDATE()) END     
     END AS NET_DELAY ,    
CASE WHEN ISNULL(CONVERT(VARCHAR,DTM.MEMO_DT,105),'')<>''THEN     
CASE WHEN DATEDIFF(DAY,DTM.MEMO_DT,ORM.DELIVERY_DT) <0  THEN 0 ELSE DATEDIFF(DAY,DTM.MEMO_DT,ORM.DELIVERY_DT) END     
     ELSE      
     CASE WHEN DATEDIFF(DAY,GETDATE(),ORM.DELIVERY_DT)<0 THEN 0 ELSE DATEDIFF(DAY,GETDATE(),ORM.DELIVERY_DT) END     
     END  AS DAYS_TO_GO, 
     
      CASE WHEN ISNULL(CONVERT(VARCHAR,B.TARGET_DT,105),'')='01-01-1900' OR ISNULL(CONVERT(VARCHAR,B.TARGET_DT,105),'')=''  
THEN '' ELSE    
CASE WHEN ISNULL(CONVERT(VARCHAR,A.RECEIVE_DT ,105),'')<>''THEN       
CASE WHEN DATEDIFF(DAY,B.TARGET_DT,A.RECEIVE_DT ) <0  THEN 0 ELSE DATEDIFF(DAY,B.TARGET_DT,A.RECEIVE_DT ) END       
     ELSE        
     CASE WHEN DATEDIFF(DAY,B.TARGET_DT,GETDATE())<0 THEN 0 ELSE DATEDIFF(DAY,B.TARGET_DT,GETDATE()) END      
     END   
       
END AS DEPT_NET_DELAY ,  
A.K_NAME, 
A.ISSUE_NO,
LM.AC_NAME,
ORD.QUANTITY,
ISNULL(A.DEPARTMENT,B.JOB_NAME) AS DEPARTMENT,
ISNULL(EMP.EMP_FNAME,'')+' '+ISNULL(EMP.EMP_LNAME,'') AS ALLOCATED_TO,   
ISNULL(CONVERT(VARCHAR,DTM.MEMO_DT,105),'') AS COMPLETION_DT  ,    
ISNULL(B.JOB_ORDER,2) AS JOB_ORDER,
A.CHALLAN_NO,
A.RECEIPT_NO,
ISNULL(CONVERT(VARCHAR,A.ISSUE_DT ,105),' ') AS ISSUE_DT,
ISNULL(CONVERT(VARCHAR,B.TARGET_DT ,105),'') AS TARGET_DT,
ISNULL(CONVERT(VARCHAR,A.RECEIVE_DT ,105),'') AS RECEIVE_DT,
ISNULL(A.REF_PRD_WORKORDER_MEMOID,B.MEMO_ID ) AS WORK_ORDER_ID,
(CASE WHEN ISNULL(DTM.MEMO_NO,'') ='' THEN 'IN PROCESS' ELSE 'COMPLETED' END) AS WORK_STATUS,
(CASE WHEN ISNULL(IND.PRODUCT_CODE,'')='' THEN 'NOT SOLD' ELSE 'SOLD' END) AS SOLD_STATUS
FROM ##1 A 
FULL OUTER JOIN ##2  B ON  A.JOB_CODE = B.JOB_CODE AND A.REF_COMPONENT_ARTICLE_CODE = B.ARTICLE_CODE AND A.REF_PRD_WORKORDER_MEMOID = B.MEMO_ID 
JOIN PRD_WO_MST WOM ON WOM.MEMO_ID=ISNULL(A.REF_PRD_WORKORDER_MEMOID,B.MEMO_ID )
JOIN PRD_WO_DET WOD ON WOD.MEMO_ID =WOM.MEMO_ID
JOIN PRD_WO_ORDERS  PD ON PD.MEMO_ID =WOM.MEMO_ID
JOIN ARTICLE AR ON AR.ARTICLE_CODE=WOM.ARTICLE_SET_CODE
JOIN ARTICLE AR1 ON AR1.ARTICLE_CODE=WOD.ARTICLE_CODE
JOIN BUYER_ORDER_MST ORM ON PD.ORDER_ID  =ORM.ORDER_ID 
JOIN BUYER_ORDER_DET ORD ON ORM.ORDER_ID =ORD.ORDER_ID
JOIN LMV01106 LM ON LM.AC_CODE=ORM.AC_CODE
LEFT OUTER JOIN EMP_MST EMP (NOLOCK) ON EMP.EMP_ID=WOM.EMP_CODE    
LEFT OUTER JOIN PRD_STK_TRANSFER_DTM_MST DTM (NOLOCK) ON WOM.MEMO_ID=DTM.REF_WO_ID AND DTM.CANCELLED=0 
LEFT OUTER JOIN PRD_STK_TRANSFER_DTM_DET DTD (NOLOCK) ON DTD.MEMO_ID = DTM.MEMO_ID 
LEFT OUTER JOIN IND01106 IND (NOLOCK) ON IND.PRODUCT_CODE = DTD.PRODUCT_CODE
WHERE 
(WOM.EMP_CODE = @CEMPCODE  OR  @CEMPCODE = '') AND  
(ORM.AC_CODE = @CACCODE OR ORM.CUSTOMER_CODE = '' OR @CACCODE = '') AND 
(ORM.DELIVERY_DT = @CDATE OR  @CDATE = '') 
AND (CASE WHEN ISNULL(DTM.MEMO_NO,'') ='' THEN 'IN PROCESS' ELSE 'COMPLETED' END) = (CASE WHEN @CSTATUS = 'ALL' THEN (CASE WHEN ISNULL(DTM.MEMO_NO,'') ='' THEN 'IN PROCESS' ELSE 'COMPLETED' END) ELSE @CSTATUS END)
ORDER BY B.JOB_ORDER,WORK_ORDER_ID 
END
