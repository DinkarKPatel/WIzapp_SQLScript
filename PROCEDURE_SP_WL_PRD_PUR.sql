CREATE PROCEDURE SP_WL_PRD_PUR  
(    
 @CQUERYID  NUMERIC(2),  
 @CWHERE   VARCHAR(100)='',  
 @CFINYEAR  VARCHAR(5)='',  
 @CDEPTID  VARCHAR(7)='',  
 @NNAVMODE  NUMERIC(2)=1 ,
 @CWHERE1   VARCHAR(100)='' 

   
)
--WITH ENCRYPTION
AS  
BEGIN  
DECLARE @CCMD NVARCHAR(MAX),@cHEAD_CODE VARCHAR(MAX)  
SET @CCMD=''  
    IF @CQUERYID=1  
  GOTO LBLPOLU  
 ELSE IF @CQUERYID=2  
  GOTO LBLMST  
 ELSE IF @CQUERYID=3  
  GOTO LBLDET  
 ELSE IF @CQUERYID=4  
  GOTO LBLPARA1  
 ELSE IF @CQUERYID=5  
  GOTO LBLPARA2  
 ELSE IF @CQUERYID=6  
  GOTO LBLPARA3  
 ELSE IF @CQUERYID=7  
  GOTO LBLPARA4  
 ELSE IF @CQUERYID=8  
  GOTO LBLPARA5  
 ELSE IF @CQUERYID=9  
  GOTO LBLPARA6  
 ELSE IF @CQUERYID=10  
  GOTO LBLSUPPLIERS  
 ELSE IF @CQUERYID=11  
  GOTO LBLARTICLELIST  
 ELSE IF @CQUERYID=12  
  GOTO LBLARTICLEINFO  
 ELSE IF @CQUERYID=13  
  GOTO LBLFORMS  
 ELSE IF @CQUERYID=14  
  GOTO LBLARTICLESKUINFO  
 ELSE IF @CQUERYID=15  
  GOTO LBLARTPARA2LIST  
 ELSE IF @CQUERYID=16  
  GOTO LBLARTPARA1LIST  
 ELSE IF @CQUERYID=17  
  GOTO LBLQBF  
 ELSE IF @CQUERYID=18  
  GOTO LBLLOCLIST  
    ELSE IF @CQUERYID=19    
        GOTO LBLPRDSERIES    
    ELSE IF @CQUERYID=20   
    GOTO LBLORDERLIST   
    ELSE IF @CQUERYID=21    
    GOTO LBLORDERDET  
   
  
 ELSE   
   
  GOTO LAST  
   
   
    
LBLPOLU:  
 SELECT A.MRR_ID FROM PRD_PIM01106 A WHERE FIN_YEAR = @CFINYEAR ORDER BY A.MRR_ID  
 GOTO LAST  
   
LBLMST:  
  
  
 SELECT D.USERNAME AS 'CREATED_USERNAME', E.USERNAME AS 'MODIFIED_USERNAME',     
    C.AC_NAME AS SUPP_NAME,C.ADDRESS0+' '+ C.ADDRESS1 + ' ' + C.ADDRESS2 + ', ' + C.AREA_NAME +     
    ' ' + C.CITY + ' ' + C.STATE AS 'SUPP_ADDRESS', B.FORM_NAME, A.*,'' AS WSL_INV_ID     
 FROM PRD_PIM01106 A    
 JOIN FORM B (NOLOCK) ON A.FORM_ID = B.FORM_ID    
 JOIN LMV01106 C (NOLOCK) ON A.AC_CODE = C.AC_CODE    
 JOIN USERS D (NOLOCK) ON A.USER_CODE = D.USER_CODE    
 JOIN USERS E (NOLOCK) ON A.EDT_USER_CODE = E.USER_CODE   
 WHERE A.MRR_ID = @CWHERE    
    
    GOTO LAST  
      
LBLDET:  
  
 SELECT K.SECTION_NAME, J.SUB_SECTION_NAME, I.*, C.PARA1_NAME,      
    D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,B.ARTICLE_NO,       
    B.ARTICLE_NAME, B.CODING_SCHEME, A.*,A.PURCHASE_PRICE * A.INVOICE_QUANTITY AS 'AMOUNT'  ,    
    ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],    
    ISNULL(SKU.DT_CREATED,'') AS [SKU_DT_CREATED],    
    '' AS OTHER_XN_PRODUCT_CODE,    
    A.QUANTITY AS [ORG_QUANTITY],CAST(0 AS NUMERIC(10,2)) AS [STK_QUANTITY],B.STOCK_NA,  
    FORM.FORM_NAME,B.FIX_MRP,  SKU.PRODUCT_UID AS PRODUCT_NAME,'' AS COMPONENT,POM.PO_NO  
 FROM PRD_PID01106 A (NOLOCK)     
 LEFT OUTER JOIN PRD_POD01106 PORD ON PORD.ROW_ID=A.PO_ROW_ID   
 LEFT JOIN PRD_POM01106 POM ON POM.PO_ID=PORD.PO_ID  
 JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE       
 JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE      
 JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE      
 JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE      
 JOIN PARA4 F (NOLOCK) ON A.PARA4_CODE = F.PARA4_CODE      
 JOIN PARA5 G (NOLOCK) ON A.PARA5_CODE = G.PARA5_CODE      
 JOIN PARA6 H (NOLOCK) ON A.PARA6_CODE = H.PARA6_CODE      
 JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE      
 JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE      
 JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE   
 JOIN FORM (NOLOCK) ON FORM.FORM_ID=A.FORM_ID   
 LEFT OUTER JOIN PRD_SKU SKU ON SKU.PRODUCT_UID=A.PRODUCT_UID    
  WHERE A.MRR_ID = @CWHERE     
 ORDER BY A.SRNO    
    
    GOTO LAST  
      
LBLPARA1:  
 SELECT A.PARA1_CODE, A.PARA1_NAME FROM PARA1 A   
 WHERE PARA1_NAME <> '' AND A.INACTIVE = 0 ORDER BY A.PARA1_NAME    
    GOTO LAST  
  
LBLPARA2:  
 SELECT A.PARA2_CODE, A.PARA2_NAME, A.PARA2_ORDER FROM PARA2 A   
    WHERE A.PARA2_NAME <> '' AND A.INACTIVE = 0 ORDER BY A.PARA2_ORDER  
    GOTO LAST  
      
LBLPARA3:  
    
 SELECT A.PARA3_CODE, A.PARA3_NAME FROM PARA3 A   
    WHERE A.PARA3_NAME <> '' AND A.INACTIVE = 0 ORDER BY A.PARA3_NAME  
    GOTO LAST  
  
LBLPARA4:  
    
 SELECT A.PARA4_CODE, A.PARA4_NAME FROM PARA4 A   
    WHERE A.PARA4_NAME <> '' AND A.INACTIVE = 0 ORDER BY A.PARA4_NAME  
    GOTO LAST  
  
LBLPARA5:  
    
 SELECT A.PARA5_CODE, A.PARA5_NAME FROM PARA5 A   
    WHERE A.PARA5_NAME <> '' AND A.INACTIVE = 0 ORDER BY A.PARA5_NAME  
    GOTO LAST  
  
LBLPARA6:  
    
 SELECT A.PARA6_CODE, A.PARA6_NAME FROM PARA6 A   
    WHERE A.PARA6_NAME <> '' AND A.INACTIVE = 0 ORDER BY A.PARA6_NAME  
    GOTO LAST  
      
LBLSUPPLIERS:  
    
 --SET @CCMD = N'SELECT  A.AC_CODE, A.AC_NAME, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,         
 --   ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE, A.CITY, A.ADDRESS0 + '' '' +   
 --   A.ADDRESS1 + '' '' + A.ADDRESS2 + '' '' + A.AREA_NAME + '' '' + A.CITY + '' '' +         
 --   A.STATE AS SUPP_ADDRESS, AC_NAME AS REPCOLNAME         
 --   FROM LMV01106 A         
 --   WHERE ( CHARINDEX ( HEAD_CODE, DBO.FN_ACT_TRAVTREE (''' + @CWHERE + ''') ) > 0    
 --   OR ALLOW_CREDITOR_DEBTOR = 1 OR CHARINDEX ( HEAD_CODE, DBO.FN_ACT_TRAVTREE (''0000000018'') ) > 0)         
 --   AND INACTIVE = 0 AND A.AC_NAME <> ''''        
  
 --   UNION ALL        
  
 --   SELECT A.AC_CODE, ALIAS, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,         
 --   ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE, A.CITY, A.ADDRESS0 + '' '' +         
 --   A.ADDRESS1 + '' '' + A.ADDRESS2 + '' '' + A.AREA_NAME + '' '' + A.CITY + '' '' +   
 --   A.STATE AS SUPP_ADDRESS, AC_NAME AS REPCOLNAME          
 --   FROM LMV01106 A         
 --   WHERE ( CHARINDEX ( HEAD_CODE, DBO.FN_ACT_TRAVTREE (''' + @CWHERE + ''') ) > 0    
 --   OR ALLOW_CREDITOR_DEBTOR = 1 OR CHARINDEX ( HEAD_CODE, DBO.FN_ACT_TRAVTREE (''0000000018'') ) > 0)          
 --   AND INACTIVE = 0 AND A.ALIAS <> ''''          
 --   ORDER BY A.AC_NAME '  
 
 
 
 SET @cHEAD_CODE = DBO.FN_ACT_TRAVTREE (@CWHERE ) ----ADD VARIABLE BY GAURI ON 17/4/2019
 
  SET @CCMD = N'SELECT  A.AC_CODE, A.AC_NAME, ISNULL(A.CREDIT_DAYS, 0) AS CREDIT_DAYS,           
    ISNULL(A.DISCOUNT_PERCENTAGE, 0) AS DISCOUNT_PERCENTAGE, A.CITY, A.ADDRESS0 + '' '' +     
    A.ADDRESS1 + '' '' + A.ADDRESS2 + '' '' + A.AREA_NAME + '' '' + A.CITY + '' '' +           
    A.STATE AS SUPP_ADDRESS, AC_NAME AS REPCOLNAME           
    FROM LMV01106 A           
    WHERE   HEAD_CODE IN( '+@cHEAD_CODE+')			  ----REPLACE VARIABLE FROM FUNCTION BY GAURI ON 17/4/2019            
    AND INACTIVE = 0 AND A.AC_NAME <> ''''  ORDER BY A.AC_NAME ' 
      
    EXEC SP_EXECUTESQL @CCMD  
          
    GOTO LAST  
      
LBLARTICLELIST:  
  
   SELECT A.ARTICLE_CODE, A.ARTICLE_NAME, A.ARTICLE_NO,     
   B.SUB_SECTION_NAME, C.SECTION_NAME     
   FROM ARTICLE A     
   JOIN SECTIOND B ON A.SUB_SECTION_CODE = B.SUB_SECTION_CODE    
   JOIN SECTIONM C ON B.SECTION_CODE = C.SECTION_CODE    
   WHERE A.ARTICLE_NO <> '' AND A.INACTIVE=0    
   GOTO LAST  
      
LBLARTICLEINFO:  
 SELECT A.ARTICLE_CODE, A.ARTICLE_DESC, A.ARTICLE_NAME, A.ARTICLE_NO, A.CODING_SCHEME,  
 A.PURCHASE_PRICE, A.FIX_MRP AS MRP, A.WHOLESALE_PRICE, A.CREATED_ON, A.PARA1_SET, A.PARA2_SET, B.UOM_CODE,   
 B.UOM_NAME, B.UOM_TYPE, A.MP_PERCENTAGE ,A.FIX_MRP, ISNULL(S.PRODUCT_UID, '') AS PRODUCT_CODE,  
 ISNULL(P3.DT_CREATED, '') AS [PARA3_DT_CREATED],  
    ISNULL(S.DT_CREATED,'') AS [SKU_DT_CREATED],  
    A.DT_CREATED AS [ART_DT_CREATED],  
    A.WSP_PERCENTAGE,D.SECTION_NAME,C.SUB_SECTION_NAME,  
    A.PURCHASE_PRICE AS GROSS_PURCHASE_PRICE,CAST(0 AS NUMERIC(10,2)) AS DISCOUNT_PERCENTAGE,  
    CAST(0 AS NUMERIC(10,2)) AS  DISCOUNT_AMOUNT,A.ARTICLE_NAME AS PRODUCT_NAME  
 FROM ARTICLE A   
 JOIN UOM B ON A.UOM_CODE = B.UOM_CODE   
 JOIN SECTIOND C ON A.SUB_SECTION_CODE = C.SUB_SECTION_CODE   
 JOIN SECTIONM D ON C.SECTION_CODE = D.SECTION_CODE   
 LEFT OUTER JOIN PRD_SKU (NOLOCK)S ON A.ARTICLE_CODE = A.ARTICLE_CODE AND A.PARA1_CODE = S.PARA1_CODE AND A.PARA2_CODE = S.PARA2_CODE   
    LEFT OUTER JOIN PARA3 (NOLOCK) P3 ON P3.PARA3_CODE = A.PARA3_CODE  
 WHERE A.ARTICLE_CODE=@CWHERE  
    GOTO LAST  
  
LBLFORMS:  
  
 SELECT FORM_ID, FORM_NAME, TAX_PERCENTAGE FROM FORM   
WHERE FORM_NAME <> '' AND INACTIVE = 0  ORDER BY FORM_NAME
 
 -- SELECT FORM_ID, FORM_NAME, TAX_PERCENTAGE FROM FORM   
 --WHERE FORM_NAME <> '' AND INACTIVE = 0  AND PURCHASE_AC_CODE <> '0000000000'
 --ORDER BY FORM_NAME 
   
 GOTO LAST  
  
LBLARTICLESKUINFO:  
  
 SELECT TOP 1 A.PARA1_CODE, A.PARA2_CODE, A.PARA3_CODE, A.PARA4_CODE, A.PARA5_CODE,   
    A.PARA6_CODE, P1.PARA1_NAME, P2.PARA2_NAME, P3.PARA3_NAME, P4.PARA4_NAME,   
    P5.PARA5_NAME, P6.PARA6_NAME, ART.DT_CREATED AS [ART_DT_CREATED],   
    P3.DT_CREATED AS [PARA3_DT_CREATED],ISNULL(A.DT_CREATED,'') AS [SKU_DT_CREATED],  
    A.MRP AS FIX_MRP  
    FROM PRD_SKU A   
    JOIN ARTICLE (NOLOCK) ART ON ART.ARTICLE_CODE= A.ARTICLE_CODE   
    JOIN PARA1 (NOLOCK) P1 ON A.PARA1_CODE = P1.PARA1_CODE   
    JOIN PARA2 (NOLOCK) P2 ON A.PARA2_CODE = P2.PARA2_CODE   
    JOIN PARA3 (NOLOCK) P3 ON A.PARA3_CODE = P3.PARA3_CODE   
    JOIN PARA4 (NOLOCK) P4 ON A.PARA4_CODE = P4.PARA4_CODE   
    JOIN PARA5 (NOLOCK) P5 ON A.PARA5_CODE = P5.PARA5_CODE   
    JOIN PARA6 (NOLOCK) P6 ON A.PARA6_CODE = P6.PARA6_CODE   
    WHERE A.ARTICLE_CODE = @CWHERE  
    GOTO LAST  
     
LBLARTPARA2LIST:  
 SELECT A.ARTICLE_CODE, A.PARA2_CODE, B.PARA2_NAME FROM ART_DET A   
    JOIN PARA2 B ON A.PARA2_CODE = B.PARA2_CODE  
    WHERE A.ARTICLE_CODE = @CWHERE  
    ORDER BY B.PARA2_ORDER  
 GOTO LAST  
  
LBLARTPARA1LIST:  
 SELECT A.ARTICLE_CODE, A.PARA1_CODE, B.PARA1_NAME FROM ART_PARA1 A   
    JOIN PARA1 B ON A.PARA1_CODE = B.PARA1_CODE  
    WHERE A.ARTICLE_CODE = @CWHERE  
    ORDER BY B.PARA1_NAME  
 GOTO LAST  
  
  
LBLQBF:  
  
 SET @CCMD=N'SELECT DISTINCT PO_ID AS XN_ID,MST_PO_NO AS XN_NO ,MST_XN_DT AS XN_DT   
    FROM VW_PRD_PO_QBF  '+@CWHERE  
 EXEC SP_EXECUTESQL @CCMD  
 GOTO LAST  
  
LBLLOCLIST:  
  
 SELECT * FROM LOCATION WHERE INACTIVE=0 AND LOC_TYPE = 1 AND DEPT_ID<>@CWHERE    
    GOTO LAST     
      
 LBLPRDSERIES:     
     
   SELECT PREFIX FROM PRD_SERIES WHERE PUR_LINKED=1  
   GOTO LAST      
     
     
LBLORDERLIST:     
     
--SELECT T1.PO_ID,PO_NO,PO_DT,WO.MEMO_NO AS WORK_ORDER_NO,WO.REF_NO   ,ART.ARTICLE_NO AS SET_NO    
--FROM PRD_POM01106 T1    
--LEFT OUTER JOIN PRD_PS_MST PS ON PS.PS_ID=T1.WSL_INV_ID    
--LEFT OUTER JOIN PRD_WO_MST WO ON WO.MEMO_ID=PS.REF_WO_ID     
--LEFT OUTER JOIN ARTICLE ART ON ART.ARTICLE_CODE=WO.ARTICLE_SET_CODE     
--WHERE T1.PO_ID IN       
--(      
--	 SELECT A.PO_ID       
--	 FROM PRD_POD01106 A     
--	 JOIN PRD_POM01106 B ON A.PO_ID=B.PO_ID      
--	 LEFT OUTER JOIN     
--	 (    
--		  SELECT PO_ROW_ID,SUM(QUANTITY) AS PUR_QTY FROM      
--		  PRD_PID01106 A     
--		  JOIN PRD_PIM01106 B ON A.MRR_ID=B.MRR_ID     
--		  WHERE B.MRR_ID <> @CWHERE1 AND B.AC_CODE=@CWHERE  AND CANCELLED=0 GROUP BY PO_ROW_ID    
--	 )C ON A.ROW_ID = C.PO_ROW_ID       
--	 WHERE AC_CODE=@CWHERE AND (APPROVED=2 OR @NNAVMODE =0) AND A.QUANTITY-ISNULL(C.PUR_QTY,0)>0    
--	 AND B.DEPARTMENT_ID=@CDEPTID          
--)  AND T1.CANCELLED=0    
--ORDER BY T1.PO_NO,T1.PO_DT DESC       
     
--   GOTO LAST      
       
--   LBLORDERDET:   
--  SELECT K.SECTION_NAME, J.SUB_SECTION_NAME, I.*, C.PARA1_NAME,    
-- D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,B.ARTICLE_NO,     
-- B.ARTICLE_NAME, B.CODING_SCHEME,B.STOCK_NA, A.*,A.PURCHASE_PRICE * A.INVOICE_QUANTITY AS 'AMOUNT'  ,  
-- ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],  
-- CAST( 0 AS BIT) AS CHECKED,(A.INVOICE_QUANTITY-ISNULL(PI.PUR_QTY,0))  AS PO_QTY,  
-- (A.SCHEME_QUANTITY-ISNULL(PI.FOC_QTY,0))  AS PO_SCHEME_QUANTITY,  
-- (A.INVOICE_QUANTITY-ISNULL(PI.PUR_QTY,0))  AS REC_QTY,B.STOCK_NA,FRM.*,A.WS_PRICE AS [WHOLESALE_PRICE],POM.PO_NO  
-- FROM PRD_POD01106 A (NOLOCK)   
-- JOIN PRD_POM01106 POM (NOLOCK) ON A.PO_ID = POM.PO_ID   
-- JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE     
-- JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE    
-- JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE    
-- JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE    
-- JOIN PARA4 F (NOLOCK) ON A.PARA4_CODE = F.PARA4_CODE    
-- JOIN PARA5 G (NOLOCK) ON A.PARA5_CODE = G.PARA5_CODE    
-- JOIN PARA6 H (NOLOCK) ON A.PARA6_CODE = H.PARA6_CODE    
-- JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE    
-- JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE    
-- JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE    
-- JOIN FORM FRM (NOLOCK) ON FRM.FORM_ID=A.FORM_ID   
-- LEFT OUTER JOIN   
-- (  
-- SELECT PO_ROW_ID,SUM(INVOICE_QUANTITY) AS PUR_QTY,SUM(SCHEME_QUANTITY) AS FOC_QTY FROM  
-- PRD_PID01106 A JOIN PRD_PIM01106 B ON A.MRR_ID=B.MRR_ID  
-- WHERE B.MRR_ID <> @CWHERE1 AND B.AC_CODE=@CWHERE  AND CANCELLED=0   
-- GROUP BY PO_ROW_ID  
   
-- ) PI ON A.ROW_ID = PI.PO_ROW_ID   
     
-- WHERE POM.AC_CODE= @CWHERE AND (POM.APPROVED=2 OR @NNAVMODE =0)  AND A.QUANTITY-ISNULL(PI.PUR_QTY,0)>0   
-- AND POM.DEPARTMENT_ID=@CDEPTID     
-- ORDER BY A.SRNO   


    SELECT T1.PO_ID,PO_NO,PO_DT,WO.MEMO_NO AS WORK_ORDER_NO,WO.REF_NO   ,ART.ARTICLE_NO AS SET_NO    
	FROM PRD_POM01106 T1    
	LEFT OUTER JOIN PRD_PS_MST PS ON PS.PS_ID=T1.WSL_INV_ID    
	LEFT OUTER JOIN PRD_WO_MST WO ON WO.MEMO_ID=PS.REF_WO_ID     
	LEFT OUTER JOIN ARTICLE ART ON ART.ARTICLE_CODE=WO.ARTICLE_SET_CODE     
	WHERE T1.PO_ID IN       
	(      
		 SELECT A.PO_ID       
		 FROM PRD_POD01106 A     
		 JOIN PRD_POM01106 B ON A.PO_ID=B.PO_ID      
		 LEFT OUTER JOIN     
		 (    
			  SELECT PO_ROW_ID,SUM(QUANTITY) AS PUR_QTY FROM      
			  PRD_PID01106 A     
			  JOIN PRD_PIM01106 B ON A.MRR_ID=B.MRR_ID     
			  WHERE B.AC_CODE=@CWHERE  AND CANCELLED=0 GROUP BY PO_ROW_ID    
		 )C ON A.ROW_ID = C.PO_ROW_ID       
		 WHERE AC_CODE=@CWHERE AND (APPROVED=2 OR @NNAVMODE =0) AND A.INVOICE_QUANTITY-ISNULL(C.PUR_QTY,0)>0    
		 AND B.DEPARTMENT_ID=@CDEPTID          
	)  AND T1.CANCELLED=0 


	UNION 

	SELECT T1.PO_ID,PO_NO,PO_DT,WO.MEMO_NO AS WORK_ORDER_NO,WO.REF_NO   ,ART.ARTICLE_NO AS SET_NO    
	FROM PRD_POM01106 T1    
	LEFT OUTER JOIN PRD_PS_MST PS ON PS.PS_ID=T1.WSL_INV_ID    
	LEFT OUTER JOIN PRD_WO_MST WO ON WO.MEMO_ID=PS.REF_WO_ID     
	LEFT OUTER JOIN ARTICLE ART ON ART.ARTICLE_CODE=WO.ARTICLE_SET_CODE 
	WHERE T1.PO_ID IN       
	(      
	SELECT A.PO_ID       
	FROM PRD_POD01106 A     
	JOIN PRD_POM01106 B ON A.PO_ID=B.PO_ID      
	JOIN     
	(    
		SELECT PO_ROW_ID,SUM(QUANTITY) AS PUR_QTY FROM      
		PRD_PID01106 A     
		JOIN PRD_PIM01106 B ON A.MRR_ID=B.MRR_ID     
		WHERE B.MRR_ID =@CWHERE1 GROUP BY PO_ROW_ID    
	)C ON A.ROW_ID = C.PO_ROW_ID     
	)    
	ORDER BY T1.PO_NO,T1.PO_DT DESC       
     
   GOTO LAST      
       
   LBLORDERDET:
      
	  SELECT K.SECTION_NAME, J.SUB_SECTION_NAME, I.*, C.PARA1_NAME,    
			 D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,B.ARTICLE_NO,     
			 B.ARTICLE_NAME, B.CODING_SCHEME,B.STOCK_NA, A.*,A.PURCHASE_PRICE * A.INVOICE_QUANTITY AS 'AMOUNT'  ,  
			 ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],  
			 CAST( 0 AS BIT) AS CHECKED,		
			 -- (A.INVOICE_QUANTITY-ISNULL(PI.PUR_QTY,0))  AS PO_QTY,  
			  A.INVOICE_QUANTITY AS PO_QTY,  
			 (A.SCHEME_QUANTITY-ISNULL(PI.FOC_QTY,0))  AS PO_SCHEME_QUANTITY,  
			 (A.INVOICE_QUANTITY-ISNULL(PI.PUR_QTY,0))  AS REC_QTY,B.STOCK_NA,FRM.*,A.WS_PRICE AS [WHOLESALE_PRICE],POM.PO_NO  
	 FROM PRD_POD01106 A (NOLOCK)   
	 JOIN PRD_POM01106 POM (NOLOCK) ON A.PO_ID = POM.PO_ID   
	 JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE     
	 JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE    
	 JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE    
	 JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE    
	 JOIN PARA4 F (NOLOCK) ON A.PARA4_CODE = F.PARA4_CODE    
	 JOIN PARA5 G (NOLOCK) ON A.PARA5_CODE = G.PARA5_CODE    
	 JOIN PARA6 H (NOLOCK) ON A.PARA6_CODE = H.PARA6_CODE    
	 JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE    
	 JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE    
	 JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE    
	 JOIN FORM FRM (NOLOCK) ON FRM.FORM_ID=A.FORM_ID   
	 LEFT OUTER JOIN   
	 (  
	 SELECT PO_ROW_ID,SUM(INVOICE_QUANTITY) AS PUR_QTY,SUM(SCHEME_QUANTITY) AS FOC_QTY FROM  
	 PRD_PID01106 A JOIN PRD_PIM01106 B ON A.MRR_ID=B.MRR_ID  
	 WHERE B.AC_CODE=@CWHERE  AND CANCELLED=0   
	 GROUP BY PO_ROW_ID  
	   
	 ) PI ON A.ROW_ID = PI.PO_ROW_ID   
	     
	 WHERE POM.AC_CODE= @CWHERE AND (POM.APPROVED=2 OR @NNAVMODE =0)  AND A.INVOICE_QUANTITY-ISNULL(PI.PUR_QTY,0)>0   
	 AND POM.DEPARTMENT_ID=@CDEPTID 
	 
	 UNION 
	 
	 
	     
	 SELECT K.SECTION_NAME, J.SUB_SECTION_NAME, I.*, C.PARA1_NAME,    
	 D.PARA2_NAME,E.PARA3_NAME,F.PARA4_NAME,G.PARA5_NAME,H.PARA6_NAME,B.ARTICLE_NO,     
	 B.ARTICLE_NAME, B.CODING_SCHEME,B.STOCK_NA, A.*,A.PURCHASE_PRICE * A.INVOICE_QUANTITY AS 'AMOUNT'  ,  
	 ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],  
	 CAST( 1 AS BIT) AS CHECKED,ISNULL(PI.PUR_QTY,0)  AS PO_QTY,  
	 (A.SCHEME_QUANTITY-ISNULL(PI.FOC_QTY,0))  AS PO_SCHEME_QUANTITY,  
	 ISNULL(PI.PUR_QTY,0)  AS REC_QTY,B.STOCK_NA,FRM.*,A.WS_PRICE AS [WHOLESALE_PRICE],POM.PO_NO  
	 FROM PRD_POD01106 A (NOLOCK)   
	 JOIN PRD_POM01106 POM (NOLOCK) ON A.PO_ID = POM.PO_ID   
	 JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE     
	 JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE    
	 JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE    
	 JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE    
	 JOIN PARA4 F (NOLOCK) ON A.PARA4_CODE = F.PARA4_CODE    
	 JOIN PARA5 G (NOLOCK) ON A.PARA5_CODE = G.PARA5_CODE    
	 JOIN PARA6 H (NOLOCK) ON A.PARA6_CODE = H.PARA6_CODE    
	 JOIN UOM I (NOLOCK) ON B.UOM_CODE = I.UOM_CODE    
	 JOIN SECTIOND J (NOLOCK) ON B.SUB_SECTION_CODE = J.SUB_SECTION_CODE    
	 JOIN SECTIONM K (NOLOCK) ON J.SECTION_CODE = K.SECTION_CODE    
	 JOIN FORM FRM (NOLOCK) ON FRM.FORM_ID=A.FORM_ID   
	 JOIN   
	 (  
		 SELECT PO_ROW_ID,SUM(INVOICE_QUANTITY) AS PUR_QTY,SUM(SCHEME_QUANTITY) AS FOC_QTY FROM  
		 PRD_PID01106 A 
		 JOIN PRD_PIM01106 B ON A.MRR_ID=B.MRR_ID  
		 WHERE B.MRR_ID =@CWHERE1   
		 GROUP BY PO_ROW_ID  
	   
	 ) PI ON A.ROW_ID = PI.PO_ROW_ID 
	     
	 ORDER BY POM.PO_NO,A.SRNO   


   GOTO LAST   
  
LAST:  
  
END
