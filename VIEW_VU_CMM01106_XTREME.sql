create VIEW VU_CMM01106_XTREME     
--WITH ENCRYPTION
AS 
SELECT CM_NO AS CM_NO
,CM_DT AS CM_DT,
cm_time AS CM_TIME
,CUSTOMER_CODE
,A.CM_ID
,(CASE WHEN CM_MODE=2 THEN 'APPROVAL' ELSE 'BILL' END) AS CM_MODE
,(CASE WHEN CANCELLED = 0 THEN 'NO' ELSE 'YES' END) AS CANCELLED
,LEFT(CM_NO, 2) AS [LOCATION_ID]
,LOC.DEPT_NAME AS [LOCATION_NAME]
,LOC.DEPT_ALIAS AS [LOCATION_ALIAS]
,LOC.AREA_NAME AS [LOCATION_AREA]
,LOC.CITY AS [LOCATION_CITY]
,LOC.STATE AS [LOCATION_STATE]
,NSM+ ATD_CHARGES AS [BILL_AMOUNT]  
,ATD_CHARGES AS [OTHER_CHARGES]
,USERS.USERNAME AS [USER_NAME]
,DTM.DT_NAME AS [DISCOUNT_TYPE]
,DISCOUNT_AMOUNT  AS [BILL_LEVEL_DISCOUNT]
,CMD.SLSQTY AS [GROSS_SALE_QUANTITY]
,CMD.SLSMRPVAL AS [GROSS_SALE_MRP_VALUE]
,CMD.SLSDISCAMT AS [GROSS_SALE_ITEM_LEVEL_DISCOUNT]
,CMD.SLRQTY AS [SALE_RETURN_QUANTITY]
,CMD.SLRMRPVAL AS [SALE_RETURN_MRP_VALUE]
,CMD.SLRDISCAMT AS [SALE_RETURN_ITEM_LEVEL_DISCOUNT]
,CMD.NETQTY AS [NET_SALE_QUANTITY]
,CMD.NETMRPVAL AS [NET_SALE_MRP_VALUE]
,CMD.NETDISCAMT AS [NET_SALE_ITEM_LEVEL_DISCOUNT]
,(DISCOUNT_AMOUNT + CMD.NETDISCAMT) AS [TOTAL_BILL_DISCOUNT]
,[BILL_DISCOUNT_PERCENTAGE] AS BILL_DISCOUNT_PERCENTAGE
,CASH_AMOUNT AS CASH_AMOUNT
,CC_AMOUNT AS CREDIT_CARD_AMOUNT
,CN_AMOUNT AS [CREDIT_NOTE_AMOUNT_ADJUSTED]
,ADVANCE_AMOUNT_ADJUSTED AS [ADVANCE_ADJUSTED]
,OTHER_DOC_AMOUNT AS CHEQUE_AMOUNT
,CREDIT_AMOUNT AS CREDIT_AMOUNT
,BANK_CHARGES AS BANK_CHARGES
,MISC_AMOUNT AS MISC_AMOUNT
,GIFT_VOUCHERS AS GV_AMOUNT
,'' AS SALE_PERSON
,C.WALLET--ADDED ON 03 JAN 2019
,A.REMARKS
,A.OTHER_CHARGES_TAXABLE_VALUE ,
A.round_off

FROM CMM01106 A (NOLOCK)    
LEFT OUTER JOIN       
 (    
  SELECT A.CM_ID,  
  SUM(CASE WHEN QUANTITY>0 THEN QUANTITY ELSE 0 END) AS SLSQTY,       
  SUM(CASE WHEN QUANTITY<0 THEN ABS(QUANTITY) ELSE 0 END) AS SLRQTY,       
  SUM(QUANTITY) AS NETQTY,       
  SUM(CASE WHEN QUANTITY>0 THEN QUANTITY * MRP ELSE 0 END) AS SLSMRPVAL,       
  SUM(CASE WHEN QUANTITY<0 THEN ABS(QUANTITY * MRP) ELSE 0 END) AS SLRMRPVAL,       
  SUM(RFNET) AS NETMRPVAL,       
  SUM(CASE WHEN QUANTITY>0 THEN B.DISCOUNT_AMOUNT ELSE 0 END) AS SLSDISCAMT,       
  SUM(CASE WHEN QUANTITY<0 THEN ABS(B.DISCOUNT_AMOUNT) ELSE 0 END) AS SLRDISCAMT,       
  SUM(ROUND((QUANTITY*MRP)-RFNET,2)) AS NETDISCAMT,    
  (CASE WHEN SUM(QUANTITY*MRP)>0 THEN     
  (SUM(((QUANTITY*MRP)-RFNET))/SUM(QUANTITY*MRP))*100 ELSE 0 END) AS BILL_DISCOUNT_PERCENTAGE   ,
  SUM(A.NET-A.CMM_DISCOUNT_AMOUNT) AS NSM   
  FROM CMD01106 A (NOLOCK)    
  JOIN CMM01106 B (NOLOCK) ON A.CM_ID = B.CM_ID     
  GROUP BY A.CM_ID
 ) CMD ON A.CM_ID = CMD.CM_ID      
JOIN USERS (NOLOCK) ON A.USER_CODE = USERS.USER_CODE      
LEFT OUTER JOIN VW_BILL_PAYMODE C  ON A.CM_ID=C.MEMO_ID
LEFT OUTER JOIN DTM  (NOLOCK) ON A.DT_CODE = DTM.DT_CODE      
JOIN LOC_VIEW LOC ON /*LEFT(A.CM_NO, 2)*//*Rohit 01-11-2024*/A.location_Code =LOC.DEPT_ID  
--LEFT OUTER JOIN EMPLOYEE EMP ON CMD.EMP_CODE= EMP.EMP_CODE  
WHERE  ISNULL(C.XN_TYPE,'SLS')='SLS' 
--and 1=2 catnabil use view in custom Proc Please donot change 1=2
