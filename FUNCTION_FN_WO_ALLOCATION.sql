CREATE FUNCTION FN_WO_ALLOCATION    
(    
 @CORDER_ID VARCHAR(100)='',    
 @CWO_ID VARCHAR(100)=''    
)    
RETURNS @TBLORDER TABLE (PRODUCT_CODE VARCHAR(100),ORDER_ID VARCHAR(100),AC_CODE VARCHAR(10),AC_NAME VARCHAR(100),ITEM_MERCHANT_CODE VARCHAR(10),ITEM_MERCHANT_NAME VARCHAR(100), WO_ID VARCHAR(50),PARA1_CODE VARCHAR(10),PARA2_CODE VARCHAR(10))     
AS    
BEGIN    
        
   INSERT INTO @TBLORDER(PRODUCT_CODE,ORDER_ID,AC_CODE,AC_NAME,ITEM_MERCHANT_CODE,ITEM_MERCHANT_NAME,WO_ID,PARA1_CODE ,PARA2_CODE )    
       
  SELECT DISTINCT ISNULL(C.PRODUCT_CODE,'') AS PRODUCT_CODE ,B.ORDER_ID, A.AC_CODE,LM.AC_NAME ,    
     ISNULL(U.USER_CODE  , B.ITEM_MERCHANT_CODE) AS ITEM_MERCHANT_CODE,    
     ISNULL(U.USERNAME ,EMP.EMP_NAME) AS MERCHANT_NAME,    
     ISNULL(C.MEMO_ID ,'') AS WO_ID,    
     C.PARA1_CODE  AS PARA1_CODE,    
     C.PARA2_CODE  AS PARA1_CODE     
  FROM BUYER_ORDER_MST A    
  JOIN BUYER_ORDER_DET B ON A.ORDER_ID =B.ORDER_ID    
  JOIN    
  (    
  SELECT ISNULL(PMT1.PRODUCT_CODE ,P1.PRODUCT_CODE) AS PRODUCT_CODE, 
  ISNULL(PMT1.ORDER_ID , A.ORDER_ID) AS ORDER_ID,  
  C.ARTICLE_SET_CODE ,A.MEMO_ID,DET.PARA1_CODE ,DET.PARA2_CODE,
  A.ORDER_ID AS ORG_ORDER_ID     
  FROM  (SELECT DISTINCT * FROM PRD_WO_ORDERS) A      
  JOIN PRD_WO_MST C ON C.MEMO_ID=A.MEMO_ID      
  JOIN PRD_WO_DET B ON B.MEMO_ID =C.MEMO_ID     
           
  JOIN              
  (              
  SELECT C.PARA1_CODE,C.PARA2_CODE,REF_ROW_ID,SUM(QUANTITY) AS QUANTITY               
  FROM PRD_WO_SUB_DET C                   
  GROUP BY REF_ROW_ID,C.PARA1_CODE,C.PARA2_CODE              
  ) DET ON B.ROW_ID=DET.REF_ROW_ID     
   LEFT JOIN   
  (  
   SELECT A.PRODUCT_CODE , A.ORDER_ID, A.WO_ID,A.PARA1_CODE,A.PARA2_CODE, 1 AS PRD_QTY     
    FROM PRD_UPCPMT A    
   -- WHERE ISNULL(ORDER_ID,'')=''
   WHERE (@CWO_ID='' OR A.WO_ID  =@CWO_ID)        
  ) P1 ON P1.WO_ID =A.MEMO_ID AND DET.PARA1_CODE =P1.PARA1_CODE AND DET.PARA2_CODE =P1.PARA2_CODE   
  --LEFT JOIN PRD_UPCPMT P1 ON P1.WO_ID =A.MEMO_ID AND DET.PARA1_CODE =P1.PARA1_CODE AND DET.PARA2_CODE =P1.PARA2_CODE AND ISNULL(P1.ORDER_ID,'') =''     
  LEFT JOIN    
 (    
    SELECT A.PRODUCT_CODE , A.ORDER_ID, A.WO_ID,A.PARA1_CODE,A.PARA2_CODE,COUNT(*) AS PRD_QTY     
    FROM PRD_UPCPMT A    
    --WHERE ISNULL(ORDER_ID,'')<>''   
    WHERE (@CWO_ID='' OR A.WO_ID  =@CWO_ID)    
    GROUP BY A.PRODUCT_CODE ,A.ORDER_ID, A.WO_ID,A.PARA1_CODE,A.PARA2_CODE    
 ) PMT1 ON   
   
  PMT1.WO_ID=A.MEMO_ID 
 -- AND ISNULL(P1.ORDER_ID,A.MEMO_ID ) =PMT1.ORDER_ID   
 -- AND A.ORDER_ID =PMT1.ORDER_ID        
 AND PMT1.PARA1_CODE=DET.PARA1_CODE    
 AND PMT1.PARA2_CODE=DET.PARA2_CODE     
 WHERE (@CWO_ID='' OR A.MEMO_ID  =@CWO_ID)    
    
 GROUP BY  ISNULL(PMT1.PRODUCT_CODE ,P1.PRODUCT_CODE),PMT1.ORDER_ID ,A.ORDER_ID,C.ARTICLE_SET_CODE ,A.MEMO_ID,DET.PARA1_CODE ,DET.PARA2_CODE     
 ) C ON A.ORDER_ID =C.ORG_ORDER_ID     
 AND B.PARA1_CODE =C.PARA1_CODE     
 AND B.PARA2_CODE =C.PARA2_CODE 
 LEFT OUTER JOIN 
 (
  SELECT DISTINCT B.ORDER_ID,A.PRODUCT_CODE,B.AC_CODE,B.USER_CODE    FROM
  PRD_UPCPMT A
  JOIN BUYER_ORDER_MST B ON A.ORDER_ID =B.ORDER_ID 
  WHERE B.ORDER_ID <>''
 ) AC ON AC.PRODUCT_CODE = ISNULL(C.PRODUCT_CODE,'')  
 JOIN LM01106 LM ON LM.AC_CODE =ISNULL(AC.AC_CODE,A.AC_CODE     )
 LEFT JOIN EMPLOYEE EMP ON EMP.EMP_CODE =B.ITEM_MERCHANT_CODE     
 LEFT OUTER JOIN USERS U ON U.USER_CODE = AC.USER_CODE    
     
    
 RETURN     
END
