CREATE PROCEDURE SP_CROSSTABQTY
@CCOLNAME	VARCHAR(MAX),
@CCOLVAL	VARCHAR(MAX)
--WITH ENCRYPTION

AS
BEGIN
	DECLARE @CCMD NVARCHAR(MAX)
	SET @CCMD=''
	SET @CCMD=N'
	SELECT PARA1.PARA1_CODE,PARA1.PARA1_NAME, PARA2.PARA2_CODE ,PARA2.PARA2_NAME ,SUM(PMT01106.QUANTITY_IN_STOCK) AS QTY
	FROM PMT01106 
	JOIN SKU		ON SKU.PRODUCT_CODE=PMT01106.PRODUCT_CODE
	JOIN ARTICLE	ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE
	JOIN SECTIOND	ON SECTIOND.SUB_SECTION_CODE=ARTICLE.SUB_SECTION_CODE
	JOIN SECTIONM	ON SECTIONM.SECTION_CODE=SECTIOND.SECTION_CODE
	JOIN PARA1		ON PARA1.PARA1_CODE=SKU.PARA1_CODE
	JOIN PARA2		ON PARA2.PARA2_CODE=SKU.PARA2_CODE
	JOIN PARA3		ON PARA3.PARA3_CODE=SKU.PARA3_CODE
	JOIN PARA4		ON PARA4.PARA4_CODE=SKU.PARA4_CODE
	JOIN PARA5		ON PARA5.PARA5_CODE=SKU.PARA5_CODE
	JOIN PARA6		ON PARA6.PARA6_CODE=SKU.PARA6_CODE
	WHERE 1=1 '+ 
	(CASE WHEN LTRIM(RTRIM(@CCOLNAME))='' THEN '' ELSE ' AND '+LTRIM(RTRIM(@CCOLNAME))+'='''+LTRIM(RTRIM(@CCOLVAL))+ '''' END)
	+N' GROUP BY PARA1.PARA1_CODE,PARA1.PARA1_NAME, PARA2.PARA2_CODE ,PARA2.PARA2_NAME 
	ORDER BY PARA1_NAME,PARA2_ORDER'
	
	PRINT @CCMD

	EXEC SP_EXECUTESQL @CCMD
END
