CREATE PROCEDURE SP_WL_REPORTS --(LocId 3 digit change by Sanjay:04-11-2024)   
 @NQUERYID NUMERIC(3,0),        
 @CFROMDT DATETIME,    
 @CTODT  DATETIME ,
 @CDEPTID VARCHAR(5)  ='',
 @CUSERCODE VARCHAR(15)=''   
--WITH ENCRYPTION
AS
BEGIN  
 DECLARE @CMAJORDEPTID VARCHAR(5)   
SET @CMAJORDEPTID=''
 IF @CDEPTID <>''  
 SELECT @CMAJORDEPTID=MAJOR_DEPT_ID FROM LOCATION 
 WHERE DEPT_ID=@CDEPTID
   
   
 IF @NQUERYID=1        
   GOTO LBLDAILYTRANSACTION    
 ELSE     
 IF @NQUERYID=2        
   GOTO LBLSALESSUMMARY    
 ELSE     
  GOTO LAST    
         
LBLDAILYTRANSACTION:    
     
 SELECT A.CM_DT, A.CM_NO, X.SLS_QTY, X.SLS_MRP, (X.SLS_MRP - A.NET_AMOUNT) AS DISCOUNT, A.NET_AMOUNT,  
     C.PAYMODE_NAME,  B.AMOUNT AS PAYMODE_AMOUNT  
 FROM CMM01106 A  
 JOIN ( SELECT CM_ID, SUM(QUANTITY) AS SLS_QTY, SUM(QUANTITY*MRP) AS SLS_MRP   
        FROM CMD01106 B   
     GROUP BY CM_ID   
   )X ON A.CM_ID = X.CM_ID  
 JOIN PAYMODE_XN_DET B ON A.CM_ID = B.MEMO_ID AND B.XN_TYPE = 'SLS'  
 JOIN PAYMODE_MST C ON B.PAYMODE_CODE = C.PAYMODE_CODE  
 WHERE A.CANCELLED = 0 AND   A.CM_MODE = 1   
 AND A.CM_DT BETWEEN  @CFROMDT AND @CTODT   AND A.MEMO_TYPE=1
AND   ((a.location_Code = @CMAJORDEPTID OR @CMAJORDEPTID='') AND (ISNULL(A.BIN_ID,a.location_Code) = @CDEPTID OR @CDEPTID=@CMAJORDEPTID ))   
AND A.USER_CODE=(CASE WHEN @CUSERCODE='' THEN A.USER_CODE ELSE @CUSERCODE END)
 GOTO LAST   
    
LBLSALESSUMMARY:    
     
   SELECT 1 AS PRTORD,(CASE WHEN TAX_PERCENTAGE=0 THEN 'F' WHEN ROUND(TAX_PERCENTAGE,0)=TAX_PERCENTAGE THEN LTRIM(RTRIM(STR(TAX_PERCENTAGE)))
							 ELSE LTRIM(RTRIM(STR(TAX_PERCENTAGE,6,2))) END) AS DETAILS,    
  SUM( CASE WHEN QUANTITY>0 THEN (RFNET-ATD_CHARGES - TAX_AMOUNT) ELSE 0 END) AS GNS,    
  SUM( CASE WHEN QUANTITY>0 THEN TAX_AMOUNT ELSE 0 END) AS GST,    
  SUM( CASE WHEN QUANTITY>0 THEN RFNET ELSE 0 END) AS GTS,    
  SUM( CASE WHEN QUANTITY<0 THEN (ABS(RFNET)-ABS(ATD_CHARGES) - ABS(TAX_AMOUNT)) ELSE 0 END ) AS RNS,    
  SUM( CASE WHEN QUANTITY<0 THEN ABS(TAX_AMOUNT) ELSE 0 END) AS RST,    
  SUM( CASE WHEN QUANTITY<0 THEN ABS(RFNET)-ATD_CHARGES ELSE 0 END) AS RTS,    
  SUM( RFNET-ATD_CHARGES - TAX_AMOUNT) AS NNS,    
  SUM( TAX_AMOUNT ) AS NST,    
  SUM( RFNET-ATD_CHARGES ) AS NTS    
 FROM CMD01106 A    
 JOIN CMM01106 B ON A.CM_ID = B.CM_ID    
 JOIN LOCATION C ON b.location_Code = C.DEPT_ID    
 WHERE B.CANCELLED = 0    
 AND   ((b.location_code = @CMAJORDEPTID OR @CMAJORDEPTID='') AND (ISNULL(B.BIN_ID,b.location_code) = @CDEPTID OR @CDEPTID=@CMAJORDEPTID ))  
 AND B.CM_MODE = 1  AND B.MEMO_TYPE=1   
 AND B.CM_DT BETWEEN @CFROMDT AND @CTODT   
AND B.USER_CODE=(CASE WHEN @CUSERCODE='' THEN B.USER_CODE ELSE @CUSERCODE END)
 GROUP BY (CASE WHEN TAX_PERCENTAGE=0 THEN 'F' WHEN ROUND(TAX_PERCENTAGE,0)=TAX_PERCENTAGE THEN LTRIM(RTRIM(STR(TAX_PERCENTAGE)))
							 ELSE LTRIM(RTRIM(STR(TAX_PERCENTAGE,6,2))) END)   
   
   
 SELECT MST.PAYMODE_NAME,SUM(DET.AMOUNT) AS [AMOUNT]  
 FROM PAYMODE_XN_DET DET  
 JOIN PAYMODE_MST MST ON MST.PAYMODE_CODE=DET.PAYMODE_CODE  
 JOIN CMM01106 CMM ON CMM.CM_ID=DET.MEMO_ID AND DET.XN_TYPE='SLS'  
 WHERE CMM.CANCELLED = 0    
 AND cmm.location_code IN (  
  SELECT DEPT_ID   
  FROM LOCATION   
  WHERE MAJOR_DEPT_ID= @CDEPTID  
 )   
 AND CMM.CM_MODE = 1    
 AND CMM.CM_DT BETWEEN @CFROMDT AND @CTODT   AND CMM.MEMO_TYPE=1  
 AND   ((cmm.location_code = @CMAJORDEPTID OR @CMAJORDEPTID='') AND (ISNULL(CMM.BIN_ID,cmm.location_code) = @CDEPTID OR @CDEPTID=@CMAJORDEPTID ))  
 AND CMM.USER_CODE=(CASE WHEN @CUSERCODE='' THEN CMM.USER_CODE ELSE @CUSERCODE END)
 GROUP BY  MST.PAYMODE_NAME  
   
 GOTO LAST  
   
LAST:    
  
END
