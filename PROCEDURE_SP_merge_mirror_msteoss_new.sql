create PROCEDURE SP_MERGE_MIRROR_MSTEOSS_NEW
(  
 @NMODE INT  
)  
----WITH ENCRYPTION
AS  
BEGIN  
   
 BEGIN TRY  
 --(dinkar) Replace  left(memoid,2) to Location_code 
    
  DECLARE @CERRORMSG VARCHAR(1000),@CCURDEPTID CHAR(4),@CHODEPTID CHAR(4),@CCMD NVARCHAR(MAX),  
    @CXNMASTERTABLENAME VARCHAR(100),@BPROCEED BIT,@CTABLENAME VARCHAR(100),@CMASTERKEYFIELD VARCHAR(100),  
    @CKEYFIELD VARCHAR(100),@CPARENTTABLENAME VARCHAR(100),@CPARENTPARANAME VARCHAR(100),@CCHILDPARANAME VARCHAR(100),  
    @CWHERECLAUSE VARCHAR(100),@CJOINSTR VARCHAR(1000),@CMEMOID VARCHAR(100),@CFINYEAR VARCHAR(100),  
    @NGRPCHARS INT,@NSERIESCHARS INT,@BSERIESBROKEN BIT,@CPREVMEMOID VARCHAR(40),@CMERGETABLENAME VARCHAR(50),  
    @CFIRSTMEMOID VARCHAR(40),@NPREVMEMOID INT,@NMEMONOLEN INT,@CRETCMD NVARCHAR(MAX),  
    @CDELCHILDTABLENAME VARCHAR(100),@CDELCHILDPARANAME VARCHAR(100),@CDELPARENTPARANAME VARCHAR(100),  
    @CORIGINALTABLENAME VARCHAR(100),@NLOCTYPE INT,@BDONOTMERGE BIT,@CRFXNTYPE VARCHAR(10),  
    @BINSERTONLY BIT,@BLINKEDMASTER BIT,@BPURLOC BIT,@CSOURCELOCID CHAR(2),@BSOURCEPURLOC BIT,  
    @CMISSINGMEMOID VARCHAR(40),@CGRPCODE VARCHAR(20),@BRETVAL BIT,@NPREVNO INT,@CPREVNO VARCHAR(20),  
    @BEMPHEADSUPDATED BIT,@CFILTERCONDITION VARCHAR(100),@CTABLEPREFIX VARCHAR(100),@CXNTYPE VARCHAR(10),  
    @NXNSMERGINGORDER INT,@NSTEP INT,@CBUNDLEMTABLENAME VARCHAR(100),@CBUNDLEDTABLENAME VARCHAR(100),  
    @CSLSMSTTABLENAME VARCHAR(100),@CSLSDETTABLENAME VARCHAR(100),@CLOCSLSSETTABLENAME VARCHAR(100),  
    @CSCHEMEDETTABLENAME VARCHAR(100),@CSCHEMEHHTABLENAME VARCHAR(100),@CSLSBCTABLENAME VARCHAR(100),  
    @CSLSARTTABLENAME VARCHAR(100),@NXNSSENDINGORDER INT,@CSLSMEMONO VARCHAR(20),@BRESTOREMODE BIT
    
   DECLARE @CTEMPMASTERTABLENAME VARCHAR(100), @CTEMPDETAILTABLENAME VARCHAR(100),@CTEMPLOCTABLENAME VARCHAR(100),
			@CTEMPSLSBCTABLENAME VARCHAR(100), @CTEMPSLSARTTABLENAME VARCHAR(100),@CTEMPSLSPARATABLENAME VARCHAR(100),
			@CTEMHAPPYHOURSTABLENAME VARCHAR(100),@CSCH2 VARCHAR(100),@CSCH7 VARCHAR(100),@CSCH6 VARCHAR(100),@CSCH_B VARCHAR(100),@CTEMPCONFIGTABLENAME VARCHAR(100),
			@CTEMPSLSBCGETTABLENAME VARCHAR(100), @CTEMPSLSARTGETTABLENAME VARCHAR(100),@CTEMPSLSPARAGETTABLENAME VARCHAR(100),@BRECFOUND BIT
		   ,@CTEMPALLMASTERTABLENAME  VARCHAR(500),@CTEMPALLMASTERCONFIGTABLENAME VARCHAR(500),@CTEMPSCHEMEOPTPARATABLENAME VARCHAR(500)
    
  SET @NSTEP=10  
    
  DECLARE @TRETMSG TABLE  (MEMO_ID VARCHAR(40),ERRMSG VARCHAR(MAX))  
     
  SELECT @CERRORMSG='',@BPROCEED=1,@NMEMONOLEN=10,@CRETCMD='',@CMEMOID='',@CXNTYPE='MSTEOSS',@BEMPHEADSUPDATED=0  
   
  
    
  SET @NSTEP=30  
    
  SET @CFILTERCONDITION=''  
     
  SELECT TOP 1 @CCURDEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='LOCATION_ID'  
  SELECT TOP 1 @CHODEPTID = VALUE FROM CONFIG (NOLOCK) WHERE CONFIG_OPTION='HO_LOCATION_ID'  

  IF @CCURDEPTID=@CHODEPTID
  BEGIN
	  SET @CERRORMSG='P:SP_MERGE_MIRROR_MSTEOSS, CANNOT CALL MERGING PROC AT HEAD OFFICE'
	  GOTO END_PROC
  END					
      
  SELECT @NLOCTYPE=LOC_TYPE,@BPURLOC=PUR_LOC FROM LOCATION (NOLOCK) WHERE DEPT_ID=@CCURDEPTID  
    

  BEGIN TRANSACTION
		
  IF @NMODE=1
	GOTO END_PROC
    
  SET @CMEMOID='MSTEOSS'  
    
LBLMERGEBEFORE:  
	
	SET @NSTEP=40  

	IF OBJECT_ID('TEMPDB..#TMPFILTERCHANGE','U') IS NOT NULL
		DROP TABLE #TMPFILTERCHANGE	  
	
	SELECT ROW_ID INTO #TMPFILTERCHANGE FROM SCHEME_SETUP_DET WHERE 1=2
	     
	SELECT	   @CTEMPMASTERTABLENAME='MSTEOSS_SCHEME_SETUP_MST_MIRROR',  
			   @CTEMPDETAILTABLENAME='MSTEOSS_SCHEME_SETUP_DET_MIRROR',  
			   @CTEMPLOCTABLENAME='MSTEOSS_SCHEME_SETUP_LOC_MIRROR',  
			   @CTEMPSLSBCTABLENAME='MSTEOSS_SCHEME_SETUP_SLSBC_MIRROR',  
			   @CTEMPSLSBCGETTABLENAME='MSTEOSS_SCHEME_SETUP_SLSBC_GET_MIRROR',  
			   @CTEMPSLSARTTABLENAME='MSTEOSS_SCHEME_SETUP_SLSART_MIRROR',  
			   @CTEMPSLSARTGETTABLENAME='MSTEOSS_SCHEME_SETUP_SLSART_GET_MIRROR',  
			   @CTEMPSLSPARATABLENAME='MSTEOSS_SCHEME_SETUP_SLSPARA_MIRROR',  
			   @CTEMPSLSPARAGETTABLENAME='MSTEOSS_SCHEME_SETUP_SLSPARA_GET_MIRROR',  
			   @CTEMHAPPYHOURSTABLENAME='MSTEOSS_SCHEME_SETUP_HAPPYHOURS_MIRROR',
			   @CSCH2='MSTEOSS_SCHEME_SETUP_SCH0002_1_MIRROR', 
			   @CSCH7='MSTEOSS_SCHEME_SETUP_SCH0007_1_MIRROR', 
			   @CSCH6='MSTEOSS_SCHEME_SETUP_SCH0006_1_MIRROR', 
			   @CSCH_B='MSTEOSS_SCHEME_SETUP_SCHB001_1_MIRROR', 
			   @CTEMPCONFIGTABLENAME = 'MSTEOSS_CONFIG_MIRROR' ,
			   @CTEMPALLMASTERTABLENAME='MSTEOSS_SCHEME_SETUP_ALLMASTERS_MIRROR' ,
			   @CTEMPALLMASTERCONFIGTABLENAME='MSTEOSS_SCHEME_SETUP_ALLMASTERS_CONFIG_MIRROR',
			   @CTEMPSCHEMEOPTPARATABLENAME='MSTEOSS_SCHEME_SETUP_OPTIMIZED_PARA_MIRROR'  
	     	   
LBLDELETE:  
    
	SET @NSTEP=50
	
	---- TAKE BACKUP OF ALL SALES SETUP TABLES BECAUSE OF ISSUE COMING AT SUVIDHA OF COMPLETE SALES SETUP GETTING REMOVED 	
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_ALLMASTERS_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_ALLMASTERS_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_ALLMASTERS_'+@CCURDEPTID+' FROM SCHEME_SETUP_ALLMASTERS'
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=60
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_ALLMASTERS_CONFIG_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_ALLMASTERS_CONFIG_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_ALLMASTERS_CONFIG_'+@CCURDEPTID+' FROM SCHEME_SETUP_ALLMASTERS_CONFIG'
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=70
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_OPTIMIZED_PARA_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_OPTIMIZED_PARA_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_OPTIMIZED_PARA_'+@CCURDEPTID+' FROM SCHEME_SETUP_OPTIMIZED_PARA'
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=80
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SCH0002_1_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SCH0002_1_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SCH0002_1_'+@CCURDEPTID+' FROM SCHEME_SETUP_SCH0002_1 A'
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=90
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SCH0006_1_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SCH0006_1_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SCH0006_1_'+@CCURDEPTID+' FROM SCHEME_SETUP_SCH0006_1 A' 
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=100
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SCH0007_1_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SCH0007_1_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SCH0007_1_'+@CCURDEPTID+' FROM SCHEME_SETUP_SCH0007_1'
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=110
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SCHB001_1_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SCHB001_1_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SCHB001_1_'+@CCURDEPTID+' FROM SCHEME_SETUP_SCHB001_1'
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=120
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SLSPARA_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SLSPARA_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SLSPARA_'+@CCURDEPTID+' FROM SCHEME_SETUP_SLSPARA' 
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=130
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SLSPARA_GET_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SLSPARA_GET_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SLSPARA_GET_'+@CCURDEPTID+' FROM SCHEME_SETUP_SLSPARA_GET' 
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=140
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SLSART_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SLSART_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SLSART_'+@CCURDEPTID+' FROM SCHEME_SETUP_SLSART' 
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=150
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SLSART_GET_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SLSART_GET_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SLSART_GET_'+@CCURDEPTID+' FROM SCHEME_SETUP_SLSART_GET'
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=160
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SLSBC_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SLSBC_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SLSBC_'+@CCURDEPTID+' FROM SCHEME_SETUP_SLSBC'
	EXEC SP_EXECUTESQL @CCMD

	SET @NSTEP=170
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SLSBC_GET_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SLSBC_GET_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SLSBC_GET_'+@CCURDEPTID+' FROM SCHEME_SETUP_SLSBC_GET'
	EXEC SP_EXECUTESQL @CCMD

	SET @NSTEP=180     
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_HAPPYHOURS_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_HAPPYHOURS_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_HAPPYHOURS_'+@CCURDEPTID+' FROM SCHEME_SETUP_HAPPYHOURS' 			  		  
	EXEC SP_EXECUTESQL @CCMD

	SET @NSTEP=190
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_LOC_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_LOC_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_LOC_'+@CCURDEPTID+' FROM SCHEME_SETUP_LOC' 
	EXEC SP_EXECUTESQL @CCMD

	SET @NSTEP=200
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_DET_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_DET_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_DET_'+@CCURDEPTID+' FROM SCHEME_SETUP_DET' 
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=210
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_MST_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_MST_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_MST_'+@CCURDEPTID+' FROM SCHEME_SETUP_MST'
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=220		
	SET @CCMD=N'IF OBJECT_ID(''TEMP_REP_FILTER_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_REP_FILTER_'+@CCURDEPTID+'
	SELECT A.* INTO TEMP_REP_FILTER_'+@CCURDEPTID+' FROM REP_FILTER A JOIN REP_MST B ON A.REP_ID=B.REP_ID WHERE REP_CODE=''SSU01'''
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=230
	SET @CCMD=N'IF OBJECT_ID(''TEMP_REP_FILTER_DET_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_REP_FILTER_DET_'+@CCURDEPTID+'
	SELECT A.* INTO TEMP_REP_FILTER_DET_'+@CCURDEPTID+' FROM REP_FILTER_DET A JOIN REP_MST B ON A.REP_ID=B.REP_ID WHERE REP_CODE=''SSU01'''
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=240
	SET @CCMD=N'IF OBJECT_ID(''TEMP_REP_DET_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_REP_DET_'+@CCURDEPTID+'
	SELECT A.* INTO TEMP_REP_DET_'+@CCURDEPTID+' FROM REP_DET A JOIN REP_MST B ON A.REP_ID=B.REP_ID WHERE B.REP_CODE=''SSU01'''
	EXEC SP_EXECUTESQL @CCMD
	
	SET @NSTEP=250
	SET @CCMD=N'IF OBJECT_ID(''TEMP_REP_MST_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_REP_MST_'+@CCURDEPTID+'
	SELECT * INTO TEMP_REP_MST_'+@CCURDEPTID+' FROM REP_MST WHERE REP_CODE=''SSU01'''
    EXEC SP_EXECUTESQL @CCMD

	SET @NSTEP=255
	SET @CCMD=N'IF OBJECT_ID(''TEMP_SCHEME_SETUP_SCH0012_'+@CCURDEPTID+''',''U'') IS NOT NULL
		DROP TABLE TEMP_SCHEME_SETUP_SCH0012_'+@CCURDEPTID+'
	SELECT * INTO TEMP_SCHEME_SETUP_SCH0012_'+@CCURDEPTID+' FROM SCHEME_SETUP_SCH0012'
	EXEC SP_EXECUTESQL @CCMD
	    
	--DELETE DATA FROM MAIN TABLES
	IF @NMODE=2
	BEGIN
		SET @NSTEP=260
		DELETE A FROM SCHEME_SETUP_ALLMASTERS A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		DELETE A FROM SCHEME_SETUP_ALLMASTERS_CONFIG A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		DELETE A FROM SCHEME_SETUP_OPTIMIZED_PARA A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		DELETE A FROM  SCHEME_SETUP_SCH0002_1 A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		DELETE A FROM  SCHEME_SETUP_SCH0006_1 A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		DELETE A FROM  SCHEME_SETUP_SCH0007_1 A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		DELETE A FROM  SCHEME_SETUP_SCHB001_1 A  JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		DELETE A FROM  SCHEME_SETUP_SLSPARA A  JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		DELETE A FROM  SCHEME_SETUP_SLSPARA_GET A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID 
		DELETE A FROM  SCHEME_SETUP_SLSART A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID 
		DELETE A FROM  SCHEME_SETUP_SLSART_GET A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID 
		DELETE A FROM  SCHEME_SETUP_SLSBC A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		JOIN SCHEME_SETUP_DET C ON C.ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
		
	    
	    DELETE A FROM  SCHEME_SETUP_SCH0012 A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID
	    
	    SET @NSTEP=270
	    DELETE A FROM  REP_FILTER A JOIN MSTEOSS_REP_MST_MIRROR B ON A.REP_ID=B.REP_ID
	    DELETE A FROM  REP_FILTER_DET A JOIN MSTEOSS_REP_MST_MIRROR B ON A.REP_ID=B.REP_ID
	    DELETE C FROM  REP_MST A JOIN MSTEOSS_REP_MST_MIRROR B ON A.REP_ID=B.REP_ID
	    JOIN REP_DET C ON C.REP_ID=A.REP_ID
	    DELETE A FROM  REP_MST A JOIN MSTEOSS_REP_MST_MIRROR B ON A.REP_ID=B.REP_ID
	    	    
	    
	    SET @NSTEP=280
		DELETE A FROM  SCHEME_SETUP_SLSBC_GET A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.SCHEME_SETUP_DET_ROW_ID 
	    
		DELETE A FROM SCHEME_SETUP_HAPPYHOURS A JOIN SCHEME_SETUP_DET C ON C.MEMO_NO=A.MEMO_NO
		JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON B.SCHEME_SETUP_DET_ROW_ID=C.ROW_ID
		
		DELETE A FROM SCHEME_SETUP_LOC A  JOIN SCHEME_SETUP_DET C ON C.MEMO_NO=A.MEMO_NO
		JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON B.SCHEME_SETUP_DET_ROW_ID=C.ROW_ID
		
		SET @NSTEP=290
		DELETE A FROM SCHEME_SETUP_DET A JOIN MSTEOSS_SCHEMESINFO_MIRROR B ON B.SCHEME_SETUP_DET_ROW_ID=A.ROW_ID
		
		
		DELETE A FROM SCHEME_SETUP_MST A LEFT OUTER JOIN SCHEME_SETUP_DET B ON A.MEMO_NO=B.MEMO_NO
		WHERE B.MEMO_NO IS NULL

		INSERT #TMPFILTERCHANGE (ROW_ID)
		SELECT A.ROW_ID FROM MSTEOSS_SCHEME_SETUP_DET_MIRROR A 

	END	
	ELSE
	BEGIN
		SET @NSTEP=300
		
		INSERT #TMPFILTERCHANGE (ROW_ID)
		SELECT A.ROW_ID FROM MSTEOSS_SCHEME_SETUP_DET_MIRROR A 
		LEFT OUTER JOIN SCHEME_SETUP_DET B ON A.ROW_ID=B.ROW_ID
		WHERE ISNULL(A.FILTER_CHANGE_LAST_UPDATE,'')<>ISNULL(B.FILTER_CHANGE_LAST_UPDATE,'')
		AND  A.FILTER_MODE<=1 AND ISNULL(A.GET_FILTER_MODE,0)<=1
		UNION
		SELECT A.ROW_ID FROM MSTEOSS_SCHEME_SETUP_DET_MIRROR A 
		WHERE A.FILTER_MODE>1 OR ISNULL(A.GET_FILTER_MODE,0)>1
		
		DELETE FROM SCHEME_SETUP_ALLMASTERS
		DELETE FROM SCHEME_SETUP_ALLMASTERS_CONFIG
		DELETE FROM SCHEME_SETUP_OPTIMIZED_PARA
		DELETE A FROM  SCHEME_SETUP_SCH0002_1 A
		DELETE A FROM  SCHEME_SETUP_SCH0006_1 A
		DELETE A FROM  SCHEME_SETUP_SCH0007_1 A
		DELETE A FROM  SCHEME_SETUP_SCH0012 A
		DELETE A FROM  SCHEME_SETUP_SCHB001_1 A 
		DELETE A FROM  SCHEME_SETUP_SLSPARA A 
		DELETE A FROM  SCHEME_SETUP_SLSPARA_GET A 
		DELETE A FROM  SCHEME_SETUP_SLSART A 
		DELETE A FROM  SCHEME_SETUP_SLSART_GET A 
		DELETE A FROM  SCHEME_SETUP_SLSBC A JOIN SCHEME_SETUP_DET B ON A.SCHEME_SETUP_DET_ROW_ID = B.ROW_ID
		
	    
	    SET @NSTEP=310
		DELETE A FROM  SCHEME_SETUP_SLSBC_GET A 
	    
		DELETE FROM SCHEME_SETUP_HAPPYHOURS 			  		  
		DELETE FROM SCHEME_SETUP_LOC 
		DELETE FROM SCHEME_SETUP_DET 
		DELETE FROM SCHEME_SETUP_MST	
		
		SET @NSTEP=320
		DELETE A FROM REP_FILTER A JOIN REP_MST B ON A.REP_ID=B.REP_ID WHERE REP_CODE='SSU01'
		DELETE A FROM REP_FILTER_DET A JOIN REP_MST B ON A.REP_ID=B.REP_ID WHERE REP_CODE='SSU01'
		DELETE FROM A FROM REP_DET A JOIN REP_MST B ON A.REP_ID=B.REP_ID WHERE B.REP_CODE='SSU01'
		DELETE FROM REP_MST WHERE REP_CODE='SSU01'
	END	
	
	SET @BRESTOREMODE=0
LBLMERGE:  
	
    PRINT 'SCHEME_SETUP_MST'
	SET @NSTEP=650
	DELETE FROM MSTEOSS_SCHEME_SETUP_LOC_MIRROR WHERE DEPT_ID<>@CCURDEPTID
	
	SET @NSTEP=655
	
	DELETE A FROM MSTEOSS_SCHEME_SETUP_MST_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_LOC_MIRROR B ON A.MEMO_NO=B.MEMO_NO WHERE LOC_APPLICABLE_MODE=2
	AND B.DEPT_ID IS NULL
	
	SET @NSTEP=660
	DELETE A FROM MSTEOSS_SCHEME_SETUP_DET_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_MST_MIRROR B ON A.MEMO_NO=B.MEMO_NO WHERE B.MEMO_NO IS NULL	
	
	SET @NSTEP=665
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SLSBC_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	
	
	SET @NSTEP=670
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SLSBC_GET_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	
	
	SET @NSTEP=675
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SLSART_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	
	
	SET @NSTEP=680	
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SLSART_GET_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	
	
	SET @NSTEP=685
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SLSPARA_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	

	SET @NSTEP=690
	
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SLSPARA_GET_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	

	SET @NSTEP=700
	
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SCH0002_1_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	

	SET @NSTEP=705
	
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SCH0007_1_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	
	
	SET @NSTEP=707
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SCH0012_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	
	
	SET @NSTEP=710
	
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SCH0006_1_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	
	
	SET @NSTEP=715
	
	DELETE A FROM MSTEOSS_SCHEME_SETUP_SCHB001_1_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_DET_MIRROR B ON A.SCHEME_SETUP_DET_ROW_ID=B.ROW_ID
	WHERE B.MEMO_NO IS NULL	

	SET @NSTEP=720
	
	DELETE A FROM MSTEOSS_SCHEME_SETUP_HAPPYHOURS_MIRROR A 
	LEFT OUTER JOIN MSTEOSS_SCHEME_SETUP_MST_MIRROR B ON A.MEMO_NO=B.MEMO_NO
	WHERE B.MEMO_NO IS NULL	

LBLMERGETABLES:
		
	SET @NSTEP=725
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPMASTERTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_MST',
	@CKEYFIELD1='MEMO_NO',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1

	
	SET @NSTEP=730
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPDETAILTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_DET',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1

	SET @NSTEP=740
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPSLSBCTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SLSBC',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1

				
	SET @NSTEP=745
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPSLSBCGETTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SLSBC_GET',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1
	

	SET @NSTEP=770
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPSLSARTTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SLSART',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1
		
	SET @NSTEP=800
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPSLSARTGETTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SLSART_GET',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1
		
	SET @NSTEP=830	
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPSLSPARATABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SLSPARA',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1

		
	SET @NSTEP=850
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPSLSPARAGETTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SLSPARA_GET',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1

			
	SET @NSTEP=870
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CSCH2,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SCH0002_1',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1					

	SET @NSTEP=890
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CSCH7,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SCH0007_1',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1	

	SET @NSTEP=895
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE='MSTEOSS_SCHEME_SETUP_SCH0012_MIRROR',
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SCH0012',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1	
	
	SET @NSTEP=900
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CSCH6,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SCH0006_1',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1					


	SET @NSTEP=910
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CSCH_B,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_SCHB001_1',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1					

							
	SET @NSTEP=920
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMHAPPYHOURSTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_HAPPYHOURS',
	@CKEYFIELD1='ROW_ID',
    @CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1
					
	SET @NSTEP=950
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPLOCTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_LOC',
	@CKEYFIELD1='MEMO_NO',
	 @CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1
						
	
	SET @NSTEP=1010	
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPCONFIGTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='CONFIG',
	@CKEYFIELD1='CONFIG_OPTION',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1
	
	SET @NSTEP=1020
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPALLMASTERTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_ALLMASTERS',
	@CKEYFIELD1='ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1
	
	SET @NSTEP=1020
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE=@CTEMPALLMASTERCONFIGTABLENAME,
	@CDESTDB='',
	@CDESTTABLE='SCHEME_SETUP_ALLMASTERS_CONFIG',
	@CKEYFIELD1='SCHEME_SETUP_DET_ROW_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1

	SET @NSTEP=1030
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE='MSTEOSS_REP_MST_MIRROR',
	@CDESTDB='',
	@CDESTTABLE='REP_MST',
	@CKEYFIELD1='REP_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=1,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1
			
	SET @NSTEP=1040
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE='MSTEOSS_REP_FILTER_MIRROR',
	@CDESTDB='',
	@CDESTTABLE='REP_FILTER',
	@CKEYFIELD1='REP_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=1,
	@CFILTERCONDITION='',
	@LUPDATEONLY=0,
	@BALWAYSUPDATE=1

	SET @NSTEP=1030
	EXEC UPDATEMASTERXN_MIRROR 
	@CSOURCEDB='',
	@CSOURCETABLE='MSTEOSS_REP_FILTER_DET_MIRROR',
	@CDESTDB='',
	@CDESTTABLE='REP_FILTER_DET',
	@CKEYFIELD1='REP_ID',
	@CKEYFIELD2='',
	@CKEYFIELD3='',
	@LINSERTONLY=0,
	@CFILTERCONDITION='',
	@LUPDATEONLY=1,
	@BALWAYSUPDATE=1
	
	IF @BRESTOREMODE=0
	BEGIN
		IF NOT EXISTS(SELECT TOP 1 MEMO_NO FROM SCHEME_SETUP_MST)
		BEGIN
			SET @CCMD=N'IF EXISTS (SELECT TOP 1 MEMO_NO FROM TEMP_SCHEME_SETUP_MST_'+@CCURDEPTID+')
							SET @BRECFOUND=1
						ELSE
							SET @BRECFOUND=0'
			EXEC SP_EXECUTESQL @CCMD,N'@BRECFOUND BIT OUTPUT',@BRECFOUND OUTPUT
			
			IF @BRECFOUND=1
			BEGIN
				SELECT	   @CTEMPMASTERTABLENAME='TEMP_SCHEME_SETUP_MST_'+@CCURDEPTID,  
						   @CTEMPDETAILTABLENAME='TEMP_SCHEME_SETUP_DET_'+@CCURDEPTID,  
						   @CTEMPLOCTABLENAME='TEMP_SCHEME_SETUP_LOC_'+@CCURDEPTID,  
						   @CTEMPSLSBCTABLENAME='TEMP_SCHEME_SETUP_SLSBC_'+@CCURDEPTID,  
						   @CTEMPSLSBCGETTABLENAME='TEMP_SCHEME_SETUP_SLSBC_GET_'+@CCURDEPTID,  
						   @CTEMPSLSARTTABLENAME='TEMP_SCHEME_SETUP_SLSART_'+@CCURDEPTID,  
						   @CTEMPSLSARTGETTABLENAME='TEMP_SCHEME_SETUP_SLSART_GET_'+@CCURDEPTID,  
						   @CTEMPSLSPARATABLENAME='TEMP_SCHEME_SETUP_SLSPARA_'+@CCURDEPTID,  
						   @CTEMPSLSPARAGETTABLENAME='TEMP_SCHEME_SETUP_SLSPARA_GET_'+@CCURDEPTID,  
						   @CTEMHAPPYHOURSTABLENAME='TEMP_SCHEME_SETUP_HAPPYHOURS_'+@CCURDEPTID,
						   @CSCH2='TEMP_SCHEME_SETUP_SCH0002_1_'+@CCURDEPTID, 
						   @CSCH7='TEMP_SCHEME_SETUP_SCH0007_1_'+@CCURDEPTID, 
						   @CSCH6='TEMP_SCHEME_SETUP_SCH0006_1_'+@CCURDEPTID, 
						   @CSCH_B='TEMP_SCHEME_SETUP_SCHB001_1_'+@CCURDEPTID, 
						   @CTEMPCONFIGTABLENAME = 'TEMP_CONFIG_'+@CCURDEPTID ,
						   @CTEMPALLMASTERTABLENAME='TEMP_SCHEME_SETUP_ALLMASTERS_'+@CCURDEPTID ,
						   @CTEMPALLMASTERCONFIGTABLENAME='TEMP_SCHEME_SETUP_ALLMASTERS_CONFIG_'+@CCURDEPTID,
						   @CTEMPSCHEMEOPTPARATABLENAME='TEMP_SCHEME_SETUP_OPTIMIZED_PARA_'+@CCURDEPTID  						
				
				SET @BRESTOREMODE=1
				
				GOTO LBLMERGETABLES
			END					   
		END		
	END


	SET @NSTEP=1040
	DECLARE @CENABLEOPTIMIZEDSCHEMES VARCHAR(2)
	SELECT TOP 1 @CENABLEOPTIMIZEDSCHEMES=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENABLE_OPTIMIZED_EOSS_SCHEMES'		
			
	IF ISNULL(@CENABLEOPTIMIZEDSCHEMES,'')='1'
	BEGIN
		SET @NSTEP=1050
		
		IF OBJECT_ID('TEMPDB..#TMPCMD','U') IS NOT NULL
			DROP TABLE #TMPCMD 
		
		SELECT TOP 1 PRODUCT_CODE INTO #TMPCMD FROM PMT01106 WHERE 1=2
		
		SET @NSTEP=1055			
		EXEC SP3S_GETFILTERED_TITLES
		@NMODE=@NMODE,
		@CERRORMSG=@CERRORMSG OUTPUT
	END
	
	GOTO END_PROC
												
END TRY			

BEGIN CATCH
	SET @CERRORMSG ='ERROR IN PROCEDURE SP_MERGE_MIRROR_MSTEOSS AT STEP#'+STR(@NSTEP)+' || ' + ERROR_MESSAGE()
END CATCH
    
END_PROC:
		
		DELETE FROM MSTEOSS_SCHEME_SETUP_SCH0002_1_MIRROR
		DELETE FROM MSTEOSS_SCHEME_SETUP_SCH0006_1_MIRROR
		DELETE FROM MSTEOSS_SCHEME_SETUP_SCH0007_1_MIRROR
		DELETE FROM MSTEOSS_SCHEME_SETUP_SCHB001_1_MIRROR
		DELETE FROM MSTEOSS_SCHEME_SETUP_SCH0012_MIRROR 
		DELETE FROM MSTEOSS_SCHEME_SETUP_SLSPARA_MIRROR 
		DELETE FROM MSTEOSS_SCHEME_SETUP_SLSPARA_GET_MIRROR 
		DELETE FROM MSTEOSS_SCHEME_SETUP_SLSART_MIRROR 
		DELETE FROM MSTEOSS_SCHEME_SETUP_SLSART_GET_MIRROR 
		DELETE FROM MSTEOSS_SCHEME_SETUP_SLSBC_MIRROR
	    DELETE FROM MSTEOSS_SCHEME_SETUP_SLSBC_GET_MIRROR
	    DELETE FROM MSTEOSS_SCHEME_SETUP_HAPPYHOURS_MIRROR 			  		  
		DELETE FROM MSTEOSS_SCHEME_SETUP_LOC_MIRROR 
		DELETE FROM MSTEOSS_SCHEME_SETUP_DET_MIRROR
		DELETE FROM MSTEOSS_SCHEME_SETUP_MST_MIRROR
		DELETE FROM MSTEOSS_CONFIG_MIRROR
		DELETE FROM MSTEOSS_SCHEME_SETUP_ALLMASTERS_MIRROR
		DELETE FROM MSTEOSS_SCHEME_SETUP_ALLMASTERS_CONFIG_MIRROR
		DELETE FROM MSTEOSS_SCHEME_SETUP_OPTIMIZED_PARA_MIRROR
		DELETE FROM MSTEOSS_SCHEMESINFO_MIRROR
		DELETE FROM MSTEOSS_REP_MST_MIRROR
		DELETE FROM MSTEOSS_REP_FILTER_MIRROR
		DELETE FROM MSTEOSS_REP_FILTER_DET_MIRROR

	IF @@TRANCOUNT>0
	BEGIN
		IF ISNULL(@CERRORMSG,'')=''
			COMMIT TRANSACTION
		ELSE
			ROLLBACK 	
	END	
	
	SELECT 'MSTEOSS' AS MEMO_ID,ISNULL(@CERRORMSG,'') AS ERRMSG    
    
END  
--- END OF CREATING PROCEDURE SP_MERGE_MIRROR_MSTEOSS_NEW
