CREATE PROCEDURE SP_GETACCOUNTDETAIL
(
 @CXNTYPE VARCHAR(10) ,
 @CWHERE VARCHAR(40) 
)

AS

BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 

	DECLARE @CVMID VARCHAR(40),@CREFNO VARCHAR(100),@CDEBTORHEADS VARCHAR(2000)


	SELECT @CVMID=  VM_ID FROM POSTACT_VOUCHER_LINK WHERE MEMO_ID= @CWHERE AND XN_TYPE= @CXNTYPE
	
	SET @CDEBTORHEADS = DBO.FN_ACT_TRAVTREE( '0000000018' )
		
	SELECT TOP 1 @CREFNO=A.REF_NO FROM BILL_BY_BILL_REF A (NOLOCK)
	JOIN VD01106 B  (NOLOCK) ON A.VD_ID = B.VD_ID 
	JOIN VM01106 V  (NOLOCK) ON B.VM_ID = V.VM_ID 
	WHERE V.VM_ID=@CVMID

	SELECT VOUCHER_NO,VOUCHER_DT,B.VOUCHER_CODE,B.VOUCHER_TYPE
	FROM VM01106 A
	JOIN VCHTYPE B ON A.VOUCHER_CODE= B.VOUCHER_CODE  
	WHERE VM_ID=@CVMID


	SELECT A.VD_ID, A.VM_ID,CONVERT(VARCHAR, D.VOUCHER_DT,105) AS VOUCHER_DT , A.AC_CODE, A.NARRATION,
	( CASE WHEN A.CREDIT_AMOUNT  = 0 THEN '' ELSE CONVERT(VARCHAR(14),CAST(A.CREDIT_AMOUNT AS NUMERIC(14,2))) END ) AS CREDIT_AMOUNT,
	( CASE WHEN A.DEBIT_AMOUNT = 0 THEN '' ELSE CONVERT(VARCHAR(14),CAST(A.DEBIT_AMOUNT AS NUMERIC(14,2))) END ) AS DEBIT_AMOUNT, 
	A.X_TYPE, A.VS_AC_CODE, A.CHK_RECON, A.RECON_DT, A.LAST_UPDATE, A.COMPANY_CODE, D.FIN_YEAR, A.AUTOENTRY,
	 B.AC_NAME,ISNULL(B.PRINT_NAME,'')AS PRINT_NAME,
	B.BILL_BY_BILL, B.HEAD_CODE,A.COST_CENTER_DEPT_ID,
	ISNULL(A.COST_CENTER_DEPT_ID,D.DEPT_ID) AS COST_CENTER_CODE,A.CONTROL_AC,
	ISNULL(B.CREDIT_DAYS,0) AS CR_DAYS,ISNULL(B.DISCOUNT_PERCENTAGE,0.00) AS DISCOUNT_PERCENTAGE,
	A.COST_CENTER_AC_CODE ,A.CREDIT_AMOUNT AS CR_AMT,A.DEBIT_AMOUNT AS DR_AMT
	FROM VD01106 A (NOLOCK) 
	JOIN VM01106 D (NOLOCK) ON A.VM_ID = D.VM_ID 
	JOIN LMV01106 B (NOLOCK) ON A.AC_CODE = B.AC_CODE
	WHERE A.VM_ID= @CVMID
	ORDER BY A.TS,A.VD_ID
	
	IF OBJECT_ID('TEMPDB..#TMPBB','U') IS NOT NULL
		DROP TABLE #TMPBB

	SELECT  1 AS DISP_ORDER,A.REMARKS,'' AS REF_TYPE,A.X_TYPE, B.AC_CODE,C.AC_NAME,A.REF_NO AS VDN_ID,
	A.REF_NO,A.REF_NO AS BILL_NO,A.REF_NO AS DISPLAY_REF_NO,CONVERT(VARCHAR,GETDATE(),103) AS BILL_DT,
				A.X_TYPE AS NBILL_TYPE,
	0 AS ADJ_BILL_AMOUNT,0 AS AMOUNT_ADJUSTABLE,A.X_TYPE AS BILL_TYPE,CAST('' AS DATETIME) AS DUE_DATE,
	CAST(V.VOUCHER_DT AS DATETIME) AS REF_DATE,0 AS DISCOUNT_PERCENTAGE,0 AS DISC_AMT, A.AMOUNT AS FEEDED_AMOUNT,
	A.AMOUNT AS NET_AMOUNT,0 AS ON_ACCOUNT,'' AS VDN_TEMP,V.DEPT_ID,CONVERT(NUMERIC(14,2),(CASE WHEN A.X_TYPE='CR' THEN A.AMOUNT ELSE 0 END)) AS CREDIT_AMOUNT
	,CONVERT(NUMERIC(14,2),(CASE WHEN A.X_TYPE='DR' THEN A.AMOUNT ELSE 0 END)) AS DEBIT_AMOUNT ,VOUCHER_TYPE,A.LAST_UPDATE
	,b.COST_CENTER_DEPT_ID,(CASE WHEN A.X_TYPE='DR' THEN 'Cr' ELSE 'Dr' END) as pending_amount_cr_dr,ISNULL(C.CREDIT_DAYS,0) AS CR_DAYS
	INTO #TMPBB FROM BILL_BY_BILL_REF A (NOLOCK)
	JOIN VD01106 B  (NOLOCK) ON A.VD_ID = B.VD_ID 
	JOIN VM01106 V  (NOLOCK) ON B.VM_ID = V.VM_ID 
	JOIN LMV01106 C  (NOLOCK) ON C.AC_CODE=B.AC_CODE
	JOIN VCHTYPE VT_BF (NOLOCK) ON VT_BF.VOUCHER_CODE=V.VOUCHER_CODE
	WHERE B.VM_ID= @CVMID
	ORDER BY A.LAST_UPDATE,REF_DATE,BILL_NO
	
	EXEC SP3S_GETBILLINFO_PENDINGBB '#TMPBB',@CDEBTORHEADS,0
	
	SELECT * FROM #TMPBB
	
END
