CREATE PROC SP_ITEM_SEARCH
@SEARCH_KEY VARCHAR(300),
@FROM_DT VARCHAR(100),
@TO_DT VARCHAR(100),
@STEP INT
--WITH ENCRYPTION

AS
BEGIN
IF @STEP = 1 
	GOTO DTPRODUCTLIST_1;
ELSE IF @STEP = 2
	GOTO DTPRODUCTLIST_2;
ELSE IF @STEP = 3
	GOTO DT_PRODUCTS;
ELSE IF @STEP = 4
	GOTO DT_ACCOUNTS;

DECLARE @CMD NVARCHAR(MAX)

DTPRODUCTLIST_1:
	
	SET @CMD=N'
		SELECT DISTINCT TOP 50 CAST(0 AS BIT) BCHK, A.PRODUCT_CODE,B.INV_DT,D.ARTICLE_NO,E.SUB_SECTION_NAME,
		F.SECTION_NAME,
		P1.PARA1_NAME,P2.PARA2_NAME,P3.PARA3_NAME,P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME,
		C.DT_CREATED AS [SKU_DT_CREATED]
		,D.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED]
		FROM IND01106 (NOLOCK) A 
		JOIN INM01106 (NOLOCK) B ON B.INV_ID=A.INV_ID
		JOIN SKU (NOLOCK) C ON C.PRODUCT_CODE=A.PRODUCT_CODE
		JOIN ARTICLE (NOLOCK) D ON D.ARTICLE_CODE=C.ARTICLE_CODE
		JOIN SECTIOND (NOLOCK) E ON D.SUB_SECTION_CODE=E.SUB_SECTION_CODE
		JOIN SECTIONM (NOLOCK) F ON F.SECTION_CODE=E.SECTION_CODE
		JOIN PARA1 (NOLOCK) P1 ON P1.PARA1_CODE=C.PARA1_CODE
		JOIN PARA2 (NOLOCK)P2 ON P2.PARA2_CODE=C.PARA2_CODE
		JOIN PARA3 (NOLOCK)P3 ON P3.PARA3_CODE=C.PARA3_CODE
		JOIN PARA4 (NOLOCK)P4 ON P4.PARA4_CODE=C.PARA4_CODE
		JOIN PARA5 (NOLOCK)P5 ON P5.PARA5_CODE=C.PARA5_CODE
		JOIN PARA6 (NOLOCK)P6 ON P6.PARA6_CODE=C.PARA6_CODE
		JOIN LM01106 (NOLOCK) LM ON B.AC_CODE = LM.AC_CODE 
		WHERE C.PRODUCT_CODE='''+@SEARCH_KEY+'''   
		AND B.INV_DT BETWEEN'''+@FROM_DT+''' AND  '''+@TO_DT+''''
		
	
	PRINT @CMD;
	EXEC SP_EXECUTESQL @CMD;
	
	GOTO END_PROC;
	
DTPRODUCTLIST_2:

	SET @CMD=N'
		SELECT DISTINCT TOP 50 CAST(0 AS BIT) BCHK,A.PRODUCT_CODE,D.ARTICLE_NO,E.SUB_SECTION_NAME,F.SECTION_NAME,P1.PARA1_NAME
		,P2.PARA2_NAME,P3.PARA3_NAME,P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME,C.DT_CREATED AS [SKU_DT_CREATED]
		,D.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED]
		FROM IND01106 A (NOLOCK)
		JOIN INM01106 B (NOLOCK)ON B.INV_ID=A.INV_ID
		JOIN SKU C (NOLOCK) ON C.PRODUCT_CODE=A.PRODUCT_CODE
		JOIN ARTICLE D (NOLOCK) ON D.ARTICLE_CODE=C.ARTICLE_CODE
		JOIN SECTIOND E (NOLOCK)  ON D.SUB_SECTION_CODE=E.SUB_SECTION_CODE
		JOIN SECTIONM (NOLOCK) F ON F.SECTION_CODE=E.SECTION_CODE
		JOIN PARA1 (NOLOCK) P1 ON P1.PARA1_CODE=C.PARA1_CODE
		JOIN PARA2 (NOLOCK) P2 ON P2.PARA2_CODE=C.PARA2_CODE
		JOIN PARA3 (NOLOCK) P3 ON P3.PARA3_CODE=C.PARA3_CODE
		JOIN PARA4 (NOLOCK) P4 ON P4.PARA4_CODE=C.PARA4_CODE
		JOIN PARA5 (NOLOCK) P5 ON P5.PARA5_CODE=C.PARA5_CODE
		JOIN PARA6 (NOLOCK) P6 ON P6.PARA6_CODE=C.PARA6_CODE
		JOIN LM01106 (NOLOCK) LM ON B.AC_CODE = LM.AC_CODE 
		WHERE A.AC_CODE='''+@SEARCH_KEY+''''
	
	PRINT @CMD;
	
	EXEC SP_EXECUTESQL @CMD
	
	GOTO END_PROC;
	

DT_PRODUCTS:
	SELECT PRODUCT_CODE FROM SKU (NOLOCK)
	GOTO END_PROC;
	
DT_ACCOUNTS:
	SELECT AC_CODE,AC_NAME FROM LMV01106 (NOLOCK) WHERE INACTIVE=0;
	GOTO END_PROC;

END_PROC:

END;
