CREATE PROCEDURE SP3S_GET_PARA3_FKEYDATA
@CSOURCEDB VARCHAR(200),
@CSOURCETABLE VARCHAR(200),
@CSOURCEKEYFIELD VARCHAR(200),
@CXNTYPE VARCHAR(10),
@CTABLESUFFIX VARCHAR(40),
@CLOCID VARCHAR(5),
@CERRORMSG VARCHAR(MAX) OUTPUT
--WITH ENCRYPTION
AS
BEGIN
	BEGIN TRY
		DECLARE @CCMD NVARCHAR(MAX),@CTEMPTABLE VARCHAR(1000),@CTEMPTABLE1 VARCHAR(1000),@CTEMPTABLE2 VARCHAR(1000),
				@CTEMPTABLE3 VARCHAR(1000),@CKEYFIELDVAL VARCHAR(40),@CDESTDB VARCHAR(200),@CFILTERCONDITION VARCHAR(MAX),
				@NSTEP INT
		
		SET @CDESTDB='WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.'

		IF @CSOURCETABLE<>'#TMPMISSINGPARA3DATA'
		BEGIN			
			IF OBJECT_ID('TEMPDB..#TMPMISSINGPARA3DATA','U') IS NOT NULL
				DROP TABLE #TMPMISSINGPARA3DATA
			
			SELECT PARA3_CODE INTO #TMPMISSINGPARA3DATA FROM PARA3 WHERE 1=2
		END
				
		SET @CTEMPTABLE=(CASE WHEN LEFT(@CSOURCETABLE,1)='#' THEN @CSOURCETABLE ELSE @CSOURCEDB+'TMP_'+@CXNTYPE+'_'+@CSOURCETABLE+'_'+@CTABLESUFFIX END)
		SET @CTEMPTABLE1=@CSOURCEDB+'TMP_'+@CXNTYPE+'_PARA3_'+@CTABLESUFFIX

		IF @CSOURCETABLE<>'#TMPMISSINGPARA3DATA'
		BEGIN			
			IF OBJECT_ID(@CTEMPTABLE1,'U') IS NOT NULL
				SET @CCMD=N'SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
							LEFT OUTER JOIN '+@CTEMPTABLE1+'  B ON B.PARA3_CODE=A.'+@CSOURCEKEYFIELD+'
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.PARA3 C ON C.PARA3_CODE=A.'+@CSOURCEKEYFIELD+'
							WHERE B.PARA3_CODE IS NULL AND C.PARA3_CODE IS NULL AND A.'+@CSOURCEKEYFIELD+' IS NOT NULL'
			ELSE
				SET @CCMD=N'SELECT DISTINCT A.'+@CSOURCEKEYFIELD+' FROM '+@CTEMPTABLE+'  A
							LEFT OUTER JOIN WIZAPP3S_MIRROR_'+@CLOCID+'.DBO.PARA3 B ON B.PARA3_CODE=A.'+@CSOURCEKEYFIELD+'
							WHERE B.PARA3_CODE IS NULL AND A.'+@CSOURCEKEYFIELD+' IS NOT NULL'
			INSERT #TMPMISSINGPARA3DATA
			EXEC SP_EXECUTESQL @CCMD
		END
		
		IF EXISTS (SELECT TOP 1 PARA3_CODE FROM #TMPMISSINGPARA3DATA)
		BEGIN
			SET @CFILTERCONDITION= 'B.PARA3_CODE IN (SELECT PARA3_CODE FROM #TMPMISSINGPARA3DATA)'
			
			EXEC UPDATEMASTERXN_MIRROR
			@CSOURCEDB='',
			@CSOURCETABLE='PARA3',
			@CDESTDB=@CDESTDB,
			@CDESTTABLE='PARA3',
			@CKEYFIELD1='PARA3_CODE',
			@LINSERTONLY=0,
			@CFILTERCONDITION=@CFILTERCONDITION,
			
			
			@LUPDATEONLY=0,
			@BALWAYSUPDATE=1
		END
		
		GOTO END_PROC									
	END TRY
	
	BEGIN CATCH
		SELECT @CERRORMSG='PROCEDURE SP3S_GET_PARA3_FKEYDATA : '+ISNULL(ERROR_PROCEDURE(),'NULL P')+'STEP :'+STR(ISNULL(@NSTEP,0))+ ' LINE NO. :'+
		ISNULL(LTRIM(RTRIM(STR(ERROR_LINE()))),'NULL LINE')+'MSG :'+ISNULL(ERROR_MESSAGE(),'NULL MSG')
		
		GOTO END_PROC
	END CATCH
	
END_PROC:
		
END
----'END OF PROCEDURE SP3S_GET_PARA3_FKEYDATA'
