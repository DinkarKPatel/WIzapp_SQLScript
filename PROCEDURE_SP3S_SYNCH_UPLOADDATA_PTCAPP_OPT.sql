CREATE PROCEDURE SP3S_SYNCH_UPLOADDATA_PTCAPP_OPT
(
	@CspId VARCHAR(50),  
    @CERRMSG VARCHAR(MAX) OUTPUT  
)
--WITH ENCRYPTION
AS
BEGIN
      DECLARE @DTSQL NVARCHAR(MAX),@CTMP_TABLENAME VARCHAR(200),@CTABLE_SUFFIX VARCHAR(100),
      @CTABLESUFFIX VARCHAR(100),
      @CERRORMSG VARCHAR(MAX),@CSTEP VARCHAR(10),@CKEYFIELD  VARCHAR(50),@CTABLENAME VARCHAR(100),
      @CERRMSGOUT VARCHAR(500),@CPEDTABLENAME VARCHAR(100),@CTMP_PEDTABLENAME VARCHAR(100),
	  @CSOURCEDB VARCHAR(100),@CMERGEDB VARCHAR(100),@CFILTERCONDITION VARCHAR(100),@CMEMOID VARCHAR(50)
      
    BEGIN TRY	
      --SET @CSTEP = 10  
      --SET @CMERGEDB= DB_NAME()
      --SET @CERRORMSG=''   
      SET @CTABLESUFFIX='UPLOAD'
	
	 BEGIN TRANSACTION
	 SET @CSOURCEDB=''
	 SET @CMERGEDB=''

	 
	 
	 SET @CFILTERCONDITION='  B.SP_ID='''+@CspId+''''

	    SET @CSTEP = 20  
        SET @CTABLENAME='PED_XN_APPROVAL'  
        SET @CTMP_TABLENAME='PTCAPP_'+@CTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
        SET @CKEYFIELD='ROW_ID'  
        SET @CSTEP=60 
         
        EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_TABLENAME,@CDESTDB=@CMERGEDB  
         ,@CDESTTABLE=@CTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
         ,@BALWAYSUPDATE=1 ,@CFILTERCONDITION=@CFILTERCONDITION 
         
         
         
         SET @CSTEP = 20  
        SET @CPEDTABLENAME='PED01106'  
        SET @CTMP_PEDTABLENAME='PTCAPP_'+@CPEDTABLENAME+'_'+LTRIM(RTRIM(@CTABLE_SUFFIX))  
        SET @CKEYFIELD='ROW_ID'  
        SET @CSTEP=60 
         
        EXEC UPDATEMASTERXN_MIRROR @CSOURCEDB=@CSOURCEDB,@CSOURCETABLE=@CTMP_PEDTABLENAME,@CDESTDB=@CMERGEDB  
         ,@CDESTTABLE=@CPEDTABLENAME,@CKEYFIELD1=@CKEYFIELD,@CKEYFIELD2='',@CKEYFIELD3=''  
         ,@LINSERTONLY=0,@CJOINSTR='',@LUPDATEONLY=0  
         ,@BALWAYSUPDATE=1  ,@CFILTERCONDITION=@CFILTERCONDITION  
	 
		 IF ISNULL(@CERRMSGOUT,'')<>''  
		 BEGIN  
		  SET @CERRMSG='P:SP_MERGE_MIRROR_PTCAPP_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+N''+@CERRMSGOUT+''''  
		 END 
	   
		  UPDATE A SET LAST_UPDATE=GETDATE() 
		  FROM PEM01106  A
		  JOIN PED01106 B ON A.PEM_MEMO_ID=B.PEM_MEMO_ID
		  WHERE B.ROW_ID=@CMEMOID


		  DELETE FROM PTCAPP_PED01106_UPLOAD WHERE SP_ID=@CspId
		  DELETE FROM PTCAPP_PED_XN_APPROVAL_UPLOAD WHERE SP_ID=@CspId
	   
	   
	 END TRY
     BEGIN CATCH
     SET @CERRMSG='P:SP3S_SYNCH_UPLOADDATA_PTCAPP_OPT, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()
     END CATCH
     
EXIT_PROC:
		 IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0  
         BEGIN  
			 COMMIT   
         END  
         ELSE IF ISNULL(@CERRMSG,'')<>'' AND @@TRANCOUNT>0  
				ROLLBACK  
				
			

END
