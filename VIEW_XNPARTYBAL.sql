create  VIEW XNPARTYBAL  
--WITH ENCRYPTION
AS  
SELECT 1 AS XN_ORDER,A.CUSTOMER_CODE AS XN_PARTY_CODE,CUSTOMER_FNAME+' '+CUSTOMER_LNAME AS XN_PARTY_NAME,'OPS' AS XN_TYPE,   
  '' AS XN_NO, '' AS XN_ID, '' AS XN_DT,   
  A.OPENING_BALANCE AS XN_CASH,     
 '' AS DEPT_ID,'' AS COMPANY_CODE,  
  'OPENING BALANCE ' AS NARRATION,CONVERT(BIT,0) AS ACT_NA  
FROM custdym A WHERE A.OPENING_BALANCE <> 0 
UNION ALL    

  
SELECT 6 AS XN_ORDER,A.CUSTOMER_CODE AS XN_PARTY_CODE,CUSTOMER_FNAME+' '+CUSTOMER_LNAME AS XN_PARTY_NAME,'REC' AS XN_TYPE,   
    A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,NET_AMOUNT*-1 AS XN_CASH,  
    '' AS DEPT_ID,   
    '' AS COMPANY_CODE,'RECEIPT FROM CUSTOMER' AS NARRATION,CONVERT(BIT,0) AS ACT_NA  
FROM ARC01106 A   
JOIN CUSTDYM  B ON B.CUSTOMER_CODE=A.CUSTOMER_CODE  
WHERE A.CANCELLED=0 AND A.ARC_TYPE=1
UNION ALL 

SELECT  6 AS XN_ORDER,A.CUSTOMER_CODE AS XN_PARTY_CODE,CUSTOMER_FNAME+' '+CUSTOMER_LNAME AS XN_PARTY_NAME,'CNA' AS XN_TYPE,   
    A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,
    SUM(C.AMOUNT*(CASE WHEN ARC_TYPE=1 THEN 1 ELSE -1 END)) AS XN_CASH,  
    '' AS DEPT_ID,   
    '' AS COMPANY_CODE,'C/N ADJUSTE IN O/S RECEIPT' AS NARRATION,CONVERT(BIT,0) AS ACT_NA  
FROM ARC01106 A
JOIN CUSTDYM B ON A.CUSTOMER_CODE = B.CUSTOMER_CODE
JOIN PAYMODE_XN_DET C ON C.MEMO_ID=A.ADV_REC_ID
WHERE C.PAYMODE_CODE='0000001'
AND A.CANCELLED = 0 AND A.CUSTOMER_CODE <> '000000000000'
GROUP BY A.CUSTOMER_CODE,CUSTOMER_FNAME,CUSTOMER_LNAME,ADV_REC_NO,ADV_REC_DT,ADV_REC_ID
UNION ALL

SELECT 7 AS XN_ORDER,A.CUSTOMER_CODE AS XN_PARTY_CODE,CUSTOMER_FNAME+' '+CUSTOMER_LNAME AS XN_PARTY_NAME,'REC' AS XN_TYPE,   
    A.ADV_REC_NO AS XN_NO, A.ADV_REC_ID AS XN_ID, A.ADV_REC_DT AS XN_DT,NET_AMOUNT*-1 AS XN_CASH,  
    '' AS DEPT_ID,   
    '' AS COMPANY_CODE,'PAYMENT TO CUSTOMER' AS NARRATION,CONVERT(BIT,0) AS ACT_NA  
FROM ARC01106 A   
JOIN CUSTDYM  B ON B.CUSTOMER_CODE=A.CUSTOMER_CODE  
WHERE A.CANCELLED=0 AND A.ARC_TYPE=2
 
UNION ALL  
  
SELECT 8 AS XN_ORDER,A.CUSTOMER_CODE,CUSTOMER_FNAME+' '+CUSTOMER_LNAME AS XN_PARTY_NAME,'SLR' AS XN_TYPE,   
    A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT,  
    NET_AMOUNT*-1  AS XN_CASH,'' AS DEPT_ID,   
    '' AS COMPANY_CODE,'CREDIT NOTE ISSUED'  AS NARRATION,CONVERT(BIT,0) AS ACT_NA  
FROM CMM01106  A JOIN CUSTDYM B ON B.CUSTOMER_CODE=A.CUSTOMER_CODE  
WHERE A.CANCELLED=0 AND SUBSTRING(CM_NO,5,1)='N' 

UNION ALL  
  
  
SELECT 9 AS XN_ORDER,A.CUSTOMER_CODE,CUSTOMER_FNAME+' '+CUSTOMER_LNAME AS XN_PARTY_NAME,'SLS' AS XN_TYPE,   
    A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT,  
    A.NET_AMOUNT AS XN_CASH, '' AS DEPT_ID,   
    '' AS COMPANY_CODE,'OUTSTANDING AGAINST SALES' AS NARRATION,CONVERT(BIT,0) AS ACT_NA  
FROM CMM01106  A   
JOIN CUSTDYM B ON B.CUSTOMER_CODE=A.CUSTOMER_CODE  
WHERE A.CANCELLED=0 
  
UNION ALL  
  
  
SELECT 10 AS XN_ORDER,A.CUSTOMER_CODE,CUSTOMER_FNAME+' '+CUSTOMER_LNAME AS XN_PARTY_NAME,'SLS' AS XN_TYPE,   
    A.CM_NO AS XN_NO, A.CM_ID AS XN_ID, A.CM_DT AS XN_DT, 
    SUM(AMOUNT)*-1 AS XN_CASH,  
    '' AS DEPT_ID,   
    '' AS COMPANY_CODE,'AMOUNT RECEIVED AGAINST SALES' AS NARRATION,CONVERT(BIT,0) AS ACT_NA  
FROM CMM01106 A JOIN PAYMODE_XN_DET B ON B.MEMO_ID=A.CM_ID  
JOIN CUSTDYM C ON C.CUSTOMER_CODE=A.CUSTOMER_CODE  
JOIN PAYMODE_MST D ON D.PAYMODE_CODE=B.PAYMODE_CODE  
WHERE A.CANCELLED=0 AND PAYMODE_GRP_CODE IN ('0000001','0000002') AND B.XN_TYPE='SLS'  
GROUP BY A.CUSTOMER_CODE,CUSTOMER_FNAME,CUSTOMER_LNAME,A.CM_ID,A.CM_DT,CM_NO
