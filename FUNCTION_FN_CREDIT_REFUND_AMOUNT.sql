CREATE FUNCTION FN_CREDIT_REFUND_AMOUNT 
( 
	@CBILLID VARCHAR(40), 
	@COMITBILLID VARCHAR(40) 
)
RETURNS NUMERIC(10,2)
--WITH ENCRYPTION
AS
BEGIN
	DECLARE @NREFUNDAMOUNT NUMERIC(10,2)
	
	IF @COMITBILLID IS NULL
		SELECT @NREFUNDAMOUNT = SUM(ABS(A.AMOUNT)) 
		FROM PAYMODE_XN_DET A (NOLOCK)
		JOIN CMM01106 B  (NOLOCK) ON A.MEMO_ID = B.CM_ID
		WHERE A.ADJ_MEMO_ID = @CBILLID
		AND B.CANCELLED = 0
	ELSE
		SELECT @NREFUNDAMOUNT = SUM(ABS(A.AMOUNT)) 
		FROM PAYMODE_XN_DET A (NOLOCK)
		JOIN CMM01106 B ON A.MEMO_ID = B.CM_ID
		WHERE B.CM_ID <> @COMITBILLID  
		AND A.ADJ_MEMO_ID = @CBILLID  
		AND B.CANCELLED = 0

	IF @NREFUNDAMOUNT IS NULL
		SET @NREFUNDAMOUNT = 0

	RETURN @NREFUNDAMOUNT
END
--****************************** END OF PROCEDURE FN_CREDIT_REFUND_AMOUNT
