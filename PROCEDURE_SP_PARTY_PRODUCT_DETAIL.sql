CREATE PROCEDURE SP_PARTY_PRODUCT_DETAIL        
(          
 @CPRODUCTCODE VARCHAR(50),        
 @MEMOTYPE NUMERIC(1),        
 @NMODE INT=1  ,        
 @CDEPTID VARCHAR(4)='',        
 @TARGETDEPTID VARCHAR(4)='',    
 @INCLUDE_BRULE BIT=0,
 @CBIN_ID VARCHAR(MAX)=''  ,
 @Bbill_challan_mode bit=0
) 
--WITH ENCRYPTION
         
AS           
BEGIN      
--(dinkar) Replace  left(memoid,2) to Location_code  
	 SELECT TOP 1  A.AC_CODE AS [AC_CODE], F.UOM_TYPE, H.SECTION_NAME, G.SUB_SECTION_NAME,A.PRODUCT_CODE, 
	 -- COMMENT BY SUMIT ON 12-05-2016 DATES FIELDS ARE NOT USE IN PRINTING CONFIRMED BY ALOK SIR           
	-- CONVERT(VARCHAR, A.INV_DT, 105) AS INV_DT, A.INV_NO,LM.AC_NAME,CONVERT(VARCHAR, A.INV_DT, 105) AS BILL_DT , 
	  A.INV_DT AS INV_DT, A.INV_NO,LM.AC_NAME, A.INV_DT AS BILL_DT  ,             
	  A.PURCHASE_PRICE AS GROSS_PURCHASE_PRICE,   A.MRP,A.WS_PRICE ,B.ARTICLE_CODE,   
	 B.ARTICLE_NO, B.ARTICLE_NAME, B.ARTICLE_DESC, C.PARA1_NAME, D.PARA2_NAME,E.PARA3_NAME, P4.PARA4_NAME,   
	 P5.PARA5_NAME , P6.PARA6_NAME, F.UOM_CODE, F.UOM_NAME,  I.FORM_ID, PMT.DEPT_ID,             
	 I.FORM_NAME,  I.TAX_PERCENTAGE, ISNULL(PMT.QUANTITY_IN_STOCK,0) AS [QUANTITY_IN_STOCK],            
	 ISNULL(B.DT_CREATED,'') AS [ART_DT_CREATED],ISNULL(E.DT_CREATED,'') AS [PARA3_DT_CREATED],ISNULL(A.DT_CREATED,'') AS [SKU_DT_CREATED],          
	 '' AS MRR_NO ,A.BARCODE_CODING_SCHEME AS CODING_SCHEME,B.DISCON,          
	 LM.INACTIVE ,LMP.ON_HOLD,0 AS  [DISCOUNT_PERCENTAGE],0 AS  [DISCOUNT_AMOUNT],   
	 CONVERT(NUMERIC(14,2),(CASE WHEN A.PURCHASE_PRICE<>0 THEN (AOH.DISCOUNT_AMOUNT *100)/A.PURCHASE_PRICE
									 ELSE 0 END)) AS  [DN_DISCOUNT_PERCENTAGE],     
	 (CASE WHEN A.ER_FLAG=0 THEN 1 ELSE A.ER_FLAG END )AS ER_FLAG,A.CHALLAN_NO,A.INV_NO AS BILL_NO ,ISNULL(AOH.EXCISE_DUTY_AMOUNT,0) AS PARTY_PUR_EXCISE_RATE,          
	 ISNULL(AOH.FREIGHT,0) AS FREIGHT, ISNULL(AOH.OTHER_CHARGES,0) AS OTHER_CHARGES,          
	 0 AS [PUR_DISCOUNT_PERCENTAGE],0 AS [PUR_DISCOUNT_AMOUNT] ,      
	 A.PURCHASE_PRICE  AS INV_RATE ,A.PURCHASE_PRICE, 1 AS BILL_LEVEL_TAX_METHOD,'EXCLUSIVE' AS TAX_METHOD_NAME ,
	 @CBIN_ID AS [BIN_ID],BI.BIN_NAME,B.ALIAS AS ARTICLE_ALIAS
	 ,(A.PURCHASE_PRICE-ISNULL(AOH.DISCOUNT_AMOUNT,0)+ISNULL(AOH.EXCISE_DUTY_AMOUNT,0)) AS PURCHASEAMOUNT
	 ,CONVERT(NUMERIC(18,2),0) AS DIFFAMOUNT,B.STOCK_NA,A.hsn_code,CONVERT(NUMERIC(1,0),@Bbill_challan_mode) pur_bill_challan_mode,
	  cast(0 as numeric(5,0)) as DNPS_CD_PERCENTAGE,
      cast('' as varchar(1000)) as DNPS_Terms
	 INTO #tmpDnps FROM SKU A (NOLOCK)                
	 LEFT JOIN SKU_OH AOH (NOLOCK) ON A.PRODUCT_CODE=AOH.PRODUCT_CODE          
	 JOIN ARTICLE B (NOLOCK) ON A.ARTICLE_CODE = B.ARTICLE_CODE                  
	 JOIN PARA1 C (NOLOCK) ON A.PARA1_CODE = C.PARA1_CODE                  
	 JOIN PARA2 D (NOLOCK) ON A.PARA2_CODE = D.PARA2_CODE                 
	 JOIN PARA3 E (NOLOCK) ON A.PARA3_CODE = E.PARA3_CODE                  
	 JOIN PARA4 P4 (NOLOCK) ON A.PARA4_CODE = P4.PARA4_CODE                  
	 JOIN PARA5 P5 (NOLOCK) ON A.PARA5_CODE = P5.PARA5_CODE                  
	 JOIN PARA6 P6 (NOLOCK) ON A.PARA6_CODE = P6.PARA6_CODE          
	 JOIN UOM F (NOLOCK) ON B.UOM_CODE = F.UOM_CODE                 
	 JOIN SECTIOND G (NOLOCK) ON B.SUB_SECTION_CODE = G.SUB_SECTION_CODE                  
	 JOIN SECTIONM H (NOLOCK) ON G.SECTION_CODE = H.SECTION_CODE                 
	 JOIN FORM I (NOLOCK) ON A.FORM_ID = I.FORM_ID                         
	 LEFT OUTER JOIN PMT01106 PMT (NOLOCK) ON PMT.PRODUCT_CODE=A.PRODUCT_CODE     and pmt.dept_id=  @CDEPTID     
	 JOIN LM01106 LM (NOLOCK) ON A.AC_CODE = LM.AC_CODE          
	 LEFT OUTER JOIN LMP01106 LMP (NOLOCK) ON LM.AC_CODE=LMP.AC_CODE          
	 --JOIN BIN_LOC BL (NOLOCK) ON BL.DEPT_ID =@CDEPTID  
	 JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID= @CDEPTID 
	 JOIN BIN BI (NOLOCK) ON BI.BIN_ID=@CBIN_ID               
	 ---LEFT JOIN LOC_BILLING_RULES LBR (NOLOCK) ON LBR.SOURCE_DEPT_ID=LOC.DEPT_ID AND LBR.TARGET_DEPT_ID=@TARGETDEPTID AND @INCLUDE_BRULE=1    
	 WHERE A.PRODUCT_CODE = @CPRODUCTCODE         
	 AND A.ER_FLAG=(CASE WHEN @MEMOTYPE=1 OR A.BARCODE_CODING_SCHEME=1 THEN A.ER_FLAG ELSE @MEMOTYPE END)           
	
	UPDATE a SET DNPS_Terms =c.terms ,DNPS_CD_PERCENTAGE =c.cr_discount_percentage
	from #tmpDnps a
	JOIN pid01106 b ON a.product_code=b.product_code
	JOIN pim01106 c on c.mrr_id=b.mrr_id
	WHERE inv_mode=1


	UPDATE #tmpDnps with (rowlock) SET 	DNPS_CD_PERCENTAGE=substring(DNPS_Terms,dbo.CHARINDEX_NTH('-',DNPS_Terms,1,5)+1,
					  dbo.CHARINDEX_NTH('-',DNPS_Terms,1,6)-dbo.CHARINDEX_NTH('-',DNPS_Terms,1,5)-1)
	where ISNULL(DNPS_Terms,'')<>''
	
	SELECT * FROM #tmpdnps
END
