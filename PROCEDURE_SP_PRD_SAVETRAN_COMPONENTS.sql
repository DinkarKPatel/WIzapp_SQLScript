CREATE PROCEDURE DBO.SP_PRD_SAVETRAN_COMPONENTS
(
 @NUPDATEMODE    INT      
,@NSPID		     INT = 0
,@CMEMOID        VARCHAR(22)=''
,@CFINYEAR       VARCHAR(50)
,@CLOCID         VARCHAR(2)=''  
)
------WITH ENCRYPTION
AS
 SET NOCOUNT ON;
 BEGIN TRY
   ---DECLARE LOCAL VARIABLE
   DECLARE @CSOURCETABLE_MST       VARCHAR(100)
          ,@CSOURCTABLE_DET        VARCHAR(100)
          ,@CDESTINATIONTABLE_MST  VARCHAR(100)
          ,@CDESTINATIONTABLE_DET  VARCHAR(100)
          --,@CLOCATION             VARCHAR(100)
          ,@CMEMO_NO               VARCHAR(10)
          ,@NMEMO_NO_LENGTH        VARCHAR(10)
          ,@CKEYFIELD1             VARCHAR(22)
          ,@CMEMO_ID_NEW           VARCHAR(22)
          ,@FILTER                 VARCHAR(200)
          ,@NSAVETRANLOOP          INT
          ,@CMEMONOVAL             VARCHAR(50)
          ,@VALIMEMO_ID            VARCHAR(22)
          ,@CROW_ID                VARCHAR(50)
          ,@STRQUERY               NVARCHAR(MAX)
          ,@ERRMSG                 VARCHAR(MAX)
          ,@STEP                   INT
  ---SET VALUE OF REQUIRED VARIABLE
  SET @STEP = 1

  SET @CDESTINATIONTABLE_MST  = 'PRD_COMPONENT_MST'
  SET @CDESTINATIONTABLE_DET  = 'PRD_COMPONENT_DET'
  SET @CSOURCETABLE_MST       = 'TEMP_'+@CDESTINATIONTABLE_MST+'_'+LTRIM(RTRIM(STR(@NSPID)))
  SET @CSOURCTABLE_DET        = 'TEMP_'+@CDESTINATIONTABLE_DET+'_'+LTRIM(RTRIM(STR(@NSPID)))
   
  SET @NMEMO_NO_LENGTH        =  10
  SET @CKEYFIELD1             = 'MEMO_ID'
  SET @CMEMO_NO               = 'MEMO_NO'
  
  --SET VALIDATION WHERE ARE REQUIRED
  SET @STEP = 2
  IF ISNULL(@NUPDATEMODE,0)= 0
     BEGIN
       SET @ERRMSG='ERROR || INPUT MODE IS NOT NULL OR 0';
       GOTO PROC_END;
     END
  SET @STEP = 3
  IF ISNULL(@NSPID,0) = 0 
     BEGIN
       SET @ERRMSG='ERROR || SPID COULD NOT BE NULL OR 0';
       GOTO PROC_END;
     END
  SET @STEP = 4
  IF ISNULL(@CFINYEAR,'') = ''
     BEGIN
       SET @ERRMSG='ERROR || FINYEAR COULD NOT BE NULL OR 0';
       GOTO PROC_END;
     END
  IF @NUPDATEMODE = 1
     BEGIN
       SET @NSAVETRANLOOP = 0
        WHILE @NSAVETRANLOOP = 0
         BEGIN
           SET @STEP=5
           EXEC GETNEXTKEY @CDESTINATIONTABLE_MST, @CMEMO_NO, @NMEMO_NO_LENGTH, @CLOCID, 1,
                @CFINYEAR,0, @CMEMONOVAL OUTPUT 
           -- BELOW QUERY CHECKED NEWLY GENERATED MEMO_NO ARE EXIST IN MASTER TABLE 
           --IF EXIST THEN RE-GENERATE NEW MEMO_NO
           SET @STEP=6
           SET @STRQUERY=N'IF EXISTS ( SELECT '+@CMEMO_NO+' FROM '+@CDESTINATIONTABLE_MST+' 
                      WHERE '+@CMEMO_NO+'='''+@CMEMONOVAL+'''
                      AND FIN_YEAR = '''+@CFINYEAR+''' )
                       SET @NLOOPOUTPUT=0
                      ELSE
                       SET @NLOOPOUTPUT=1'
          -- PRINT @STRQUERY
           SET @STEP=7
           EXEC SP_EXECUTESQL @STRQUERY, N'@NLOOPOUTPUT BIT OUTPUT',@NLOOPOUTPUT=@NSAVETRANLOOP OUTPUT 
         END
         IF ISNULL(@CMEMONOVAL,'') = ''
            BEGIN
             SET @STEP=8
             SET @ERRMSG='ERROR || MEMO NO NOT GENERATED SOMTING WRONG IN INPUT PARAMATER';
             GOTO PROC_END;
            END
         SET @STEP=9
         SET @CMEMO_ID_NEW=@CLOCID + @CFINYEAR+ REPLICATE('0', 15-LEN(LTRIM(RTRIM(@CMEMONOVAL)))) + LTRIM(RTRIM(@CMEMONOVAL))
         
         IF ISNULL(@CMEMO_ID_NEW,'')=''
            BEGIN
             SET @STEP=10;
             SET @ERRMSG ='ERROR || MEMO ID IS NOT GENERATED KINDLY CEHECKED INPUT PARAMATERS'
            END
        
       -------UPDATE MEMO ID AND MEMO NO INTO MST TABLE OF UPLOAD----
       SET @STEP=14
       SET @STRQUERY=N'UPDATE ['+@CSOURCETABLE_MST+'] SET '+@CKEYFIELD1+'='''+@CMEMO_ID_NEW+''' 
                       ,'+@CMEMO_NO+'='''+@CMEMONOVAL+'''    '
                       --WHERE SPID='''+CAST(@NSPID AS VARCHAR(10))+'''
       --PRINT @STRQUERY
       EXEC SP_EXECUTESQL @STRQUERY
       
       -------UPDATE MEMO ID INTO MST TABLE OF UPLOAD----
       SET @STEP=15
       SET @STRQUERY =N'UPDATE ['+@CSOURCTABLE_DET+'] SET '+@CKEYFIELD1+'='''+@CMEMO_ID_NEW+''' '-- WHERE SPID='+CAST(@NSPID AS VARCHAR(10))+''
       EXEC SP_EXECUTESQL @STRQUERY
       ---UPDATE NEW ID INTO ROW ID COLUMN IN DET TABLE-----
       SET @STEP=16
       SET @STRQUERY =N'UPDATE ['+@CSOURCTABLE_DET+'] SET ROW_ID = NEWID() '-- WHERE SPID='+CAST(@NSPID AS VARCHAR(10))+''
       EXEC SP_EXECUTESQL @STRQUERY
       
       BEGIN TRANSACTION
        -----------INSERT INTO MST_TABLE----------
		--SET @FILTER=' B.SPID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
        EXEC UPDATEMASTERXN 
				  @CSOURCEDB	= ''
				, @CSOURCETABLE = @CSOURCETABLE_MST
				, @CDESTDB		= ''
				, @CDESTTABLE	= @CDESTINATIONTABLE_MST
				, @CKEYFIELD1	= @CKEYFIELD1
				, @BALWAYSUPDATE = 1
				--, @CFILTERCONDITION=@FILTER
		-----INSERT INTO DETAILS TABLE-------
		EXEC UPDATEMASTERXN 
				  @CSOURCEDB	= ''
				, @CSOURCETABLE = @CSOURCTABLE_DET
				, @CDESTDB		= ''
				, @CDESTTABLE	= @CDESTINATIONTABLE_DET
				, @CKEYFIELD1	= @CKEYFIELD1
				, @BALWAYSUPDATE = 1
				--, @CFILTERCONDITION=@FILTER
       COMMIT TRANSACTION
       SELECT '' AS [ERRMSG],@CMEMO_ID_NEW AS [MEMO_ID] 
     END
    IF @NUPDATEMODE = 2
       BEGIN
         SET @STEP=17
         IF ISNULL(@CMEMOID,'') = ''
            BEGIN
             SET @ERRMSG = 'ERROR || PLEASE PASS MEMO ID';
             GOTO PROC_END;
            END
         SET @STEP=18
         SET @STRQUERY = N'SELECT @VALIMEMO_ID='+@CKEYFIELD1+' FROM '+@CSOURCETABLE_MST+' '--- WHERE SPID = '+CAST(@NSPID AS VARCHAR(10))+''
         EXEC SP_EXECUTESQL @STRQUERY, N'@VALIMEMO_ID VARCHAR(22) OUTPUT',@VALIMEMO_ID OUTPUT
         SET @STEP=19
         IF (ISNULL(@VALIMEMO_ID,'')='' OR @VALIMEMO_ID='LATER')
            BEGIN
              SET @STEP=20
              SET @STRQUERY=N'UPDATE '+@CSOURCETABLE_MST+' SET '+@CKEYFIELD1+' = '''+@CMEMOID +''' '
                           -- WHERE SPID='+CAST(@NSPID AS VARCHAR(10))+' '
            END
         SET @STEP=21
         SET @STRQUERY = N'SELECT @VALIMEMO_ID='+@CKEYFIELD1+' FROM '+@CSOURCTABLE_DET+''-- WHERE SPID = '+CAST(@NSPID AS VARCHAR(10))+''
         EXEC SP_EXECUTESQL @STRQUERY, N'@VALIMEMO_ID VARCHAR(22) OUTPUT',@VALIMEMO_ID OUTPUT
        
        
         IF (ISNULL(@VALIMEMO_ID,'')='' OR @VALIMEMO_ID='LATER')
            BEGIN
               SET @STEP=22
              SET @STRQUERY=N'UPDATE '+@CSOURCTABLE_DET+' SET '+@CKEYFIELD1+' = '''+@CMEMOID +''' 
                            WHERE MEMO_ID = ''LATER'' ' --SPID='+CAST(@NSPID AS VARCHAR(10))+'
              EXEC SP_EXECUTESQL @STRQUERY
            END
        
         SET @STRQUERY = N'SELECT @CROW_ID=ROW_ID FROM '+@CSOURCTABLE_DET+' '-- WHERE SPID = '+CAST(@NSPID AS VARCHAR(10))+''
         EXEC SP_EXECUTESQL @STRQUERY, N'@CROW_ID VARCHAR(50) OUTPUT',@CROW_ID OUTPUT
          SET @STEP=23
         IF (ISNULL(@CROW_ID,'')='' OR ISNULL(@CROW_ID,'')= 'LATER')
            BEGIN
			 SET @STRQUERY =N'UPDATE ['+@CSOURCTABLE_DET+'] SET ROW_ID = NEWID() AND (ROW_ID IS NULL OR  ROW_ID=''LATER'')' --WHERE SPID='+CAST(@NSPID AS VARCHAR(10))+'
			                 
			--PRINT @STRQUERY
			 EXEC SP_EXECUTESQL @STRQUERY
            END
            
         BEGIN TRANSACTION
        -----------INSERT INTO MST_TABLE----------
        SET @STEP=24
		--SET @FILTER=' B.SPID='''+LTRIM(RTRIM(STR(@NSPID)))+''''
        EXEC UPDATEMASTERXN 
				  @CSOURCEDB	= ''
				, @CSOURCETABLE = @CSOURCETABLE_MST
				, @CDESTDB		= ''
				, @CDESTTABLE	= @CDESTINATIONTABLE_MST
				, @CKEYFIELD1	= @CKEYFIELD1
				, @BALWAYSUPDATE = 1
				--, @CFILTERCONDITION=@FILTER
		-----INSERT INTO DETAILS TABLE-------
		SET @STEP=25
		EXEC UPDATEMASTERXN 
				  @CSOURCEDB	= ''
				, @CSOURCETABLE = @CSOURCTABLE_DET
				, @CDESTDB		= ''
				, @CDESTTABLE	= @CDESTINATIONTABLE_DET
				, @CKEYFIELD1	= @CKEYFIELD1
				, @CKEYFIELD2	= 'ROW_ID'
				, @BALWAYSUPDATE = 1
				--, @CFILTERCONDITION=@FILTER
       COMMIT TRANSACTION
       SET @STEP=26
       SELECT '' AS [ERRMSG],@CMEMOID AS [MEMO_ID] 
     END
     IF @NUPDATEMODE = 3
        BEGIN
        SET @STEP=27
          IF ISNULL(@CMEMOID,'') = ''
            BEGIN
             SET @ERRMSG = 'ERROR || PLEASE PASS MEMO ID';
             GOTO PROC_END;
            END
          ---UPDATE ISACTIVE
          SET @STEP=28  
            UPDATE DBO.PRD_COMPONENT_MST SET CANCELLED = 1 WHERE MEMO_ID=@CMEMOID
		  SET @STEP=29
		  SELECT '' AS [ERRMSG],@CMEMOID AS [MEMO_ID] 
        END    
      
  PROC_END:
     IF ISNULL(@ERRMSG,'') <> ''
        BEGIN
         SELECT @ERRMSG AS [ERRMSG], '' AS [MEMO_ID]
        END
   ------DROP TEMP TABLE------------
   IF OBJECT_ID(@CSOURCETABLE_MST) IS NOT NULL
      BEGIN
      SET @STRQUERY = N'DROP TABLE ['+@CSOURCETABLE_MST+']'
      EXEC SP_EXECUTESQL @STRQUERY
      END
   IF OBJECT_ID(@CSOURCTABLE_DET) IS NOT NULL
      BEGIN
       SET @STRQUERY = N'DROP TABLE ['+@CSOURCTABLE_DET+']'
       EXEC SP_EXECUTESQL @STRQUERY
      END
   
    
 END TRY
 BEGIN CATCH
   IF @@TRANCOUNT > 0
     ROLLBACK;
     
   SET @ERRMSG = 'ERROR IN SP_PRD_SAVETRAN_COMPONENTS ON STEP || '+ CAST(@STEP AS  VARCHAR(5))+ ' '+ ERROR_MESSAGE()
   SELECT @ERRMSG AS [ERRMSG], '' AS [MEMO_ID]
 END CATCH
