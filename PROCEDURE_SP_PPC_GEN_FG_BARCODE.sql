CREATE PROCEDURE SP_PPC_GEN_FG_BARCODE
(
 @CMEMO_ID VARCHAR(100)='',
 @CERRORMSG VARCHAR(MAX) OUTPUT   
)
AS
BEGIN
    
    DECLARE @NSTEP VARCHAR(10)
    BEGIN TRY

       SET @NSTEP=00
       IF OBJECT_ID('TEMPDB..#TMP','U')IS NOT NULL
       DROP TABLE #TMP
       
       
        SELECT A.ROW_ID AS FGBCG_DET_ROW_ID,A.BO_DET_ROW_ID,B.ROW_ID,B.PARA2_CODE,
        SUM(B.QUANTITY) AS TOTAL_QUANTITY 
        INTO #TMP
		FROM PPC_FGBCG_DET A
		JOIN PPC_FGBCG_SUB_DET B ON A.ROW_ID=B.PPC_FGBCG_DET_ROW_ID
		WHERE ISNULL(B.QUANTITY,0)<>0 AND A.MEMO_ID=@CMEMO_ID
		GROUP BY B.PARA2_CODE,A.ROW_ID ,A.BO_DET_ROW_ID,B.ROW_ID
	

	DECLARE @BLOOP1 BIT,@NCNT1 INT,@BO_DET_ROW_ID VARCHAR(40),@PPC_FGBCG_DET_ROW_ID VARCHAR(40),@PPC_FGBCG_SUB_DET_ROW_ID VARCHAR(40),@TEMP_PRODUCT_CODE VARCHAR(100),
	@BLOOP INT,@NCNT INT,@CPARA2_CODE VARCHAR(10)
	
	SET @BLOOP1=0
	SET @NCNT1=1
	WHILE @BLOOP1=0
	BEGIN
        SET @NSTEP=10
		SET @BO_DET_ROW_ID=''	
		SET @NCNT1=@NCNT1+1
		SELECT TOP 1 @CPARA2_CODE=PARA2_CODE, @BO_DET_ROW_ID=BO_DET_ROW_ID,@PPC_FGBCG_SUB_DET_ROW_ID=ROW_ID,@PPC_FGBCG_DET_ROW_ID=FGBCG_DET_ROW_ID,
		@NCNT=TOTAL_QUANTITY FROM #TMP
		ORDER BY BO_DET_ROW_ID
		
		
		IF ISNULL(@BO_DET_ROW_ID,'')=''
			BREAK
		SET @BLOOP=1
	 	
		WHILE @BLOOP<=@NCNT
		BEGIN
                          
			SET @NSTEP=20
					  EXEC DBO.GETNEXTKEY 'PPC_FG_PMT', 'PRODUCT_CODE', 7, 'FG', 0, '', 1, @TEMP_PRODUCT_CODE OUTPUT 
                        
                        INSERT PPC_FG_SKU	( LAST_UPDATE,  PRODUCT_CODE, ARTICLE_CODE, PARA1_CODE, SIZEGROUP_CODE, PARA2_CODE, PARA3_CODE, PPC_FGBCG_DET_ROW_ID )  
                         SELECT GETDATE()AS  LAST_UPDATE,  @TEMP_PRODUCT_CODE AS  PRODUCT_CODE, ARTICLE_CODE, PARA1_CODE, SIZEGROUP_CODE,@CPARA2_CODE AS PARA2_CODE,
                          PARA3_CODE, @PPC_FGBCG_DET_ROW_ID AS FGBCG_SUB_DET_ROW_ID 
                          FROM PPC_FGBCG_DET WHERE ISNULL(QUANTITY,0)<>0 AND BO_DET_ROW_ID=@BO_DET_ROW_ID
						  GROUP BY BO_DET_ROW_ID,PARA3_CODE,PARA1_CODE,ARTICLE_CODE,SIZEGROUP_CODE
                          
                         
             SET @NSTEP=30
                 
                          INSERT PPC_FG_PMT	( LAST_UPDATE, PRODUCT_CODE, QUANTITY_IN_STOCK )  
                          SELECT  GETDATE()	  LAST_UPDATE, @TEMP_PRODUCT_CODE AS PRODUCT_CODE,1 AS QUANTITY_IN_STOCK 
                          FROM PPC_FGBCG_DET WHERE ISNULL(QUANTITY,0)<>0 AND BO_DET_ROW_ID=@BO_DET_ROW_ID
						  GROUP BY BO_DET_ROW_ID,PARA3_CODE,PARA1_CODE,ARTICLE_CODE,SIZEGROUP_CODE


						SET @BLOOP=@BLOOP+1	
						
		END
		DELETE FROM #TMP WHERE BO_DET_ROW_ID=@BO_DET_ROW_ID AND ROW_ID=@PPC_FGBCG_SUB_DET_ROW_ID
	END
END TRY     
     
BEGIN CATCH    
		    
  SET @CERRORMSG = 'PROCEDURE SP_PPC_GEN_FG_BARCODE : STEP- ' + LTRIM(STR(@NSTEP)) + ' SQL ERROR: #' + LTRIM(STR(ERROR_NUMBER())) + ' ' + ERROR_MESSAGE()    
    
END CATCH    
     
END_PROC:  
END
