create PROCEDURE SP3S_SLSPRINT_DYNAMIC
(
@cMemoId VARCHAR(40),
@CuserCode NVARCHAR(50)=''

)
AS
BEGIN
	SET NOCOUNT ON
	   DECLARE @cCmdCols NVARCHAR(MAX),@cCmd NVARCHAR(MAX),@cCols VARCHAR(MAX),@cCmd1 NVARCHAR(MAX),@cCmd2 NVARCHAR(MAX),@cCmd3 NVARCHAR(MAX),@cCmdIMG NVARCHAR(MAX)
	   ,@PARA1 NVARCHAR(10),@PARA2 NVARCHAR(10),@PARA3 NVARCHAR(10),@PARA4 NVARCHAR(10),@PARA5 NVARCHAR(10),@PARA6 NVARCHAR(10),
	    @SALE_PERSON VARCHAR(1000),@cnullableCols varchar(max) ,@CERRMSG varchar (1000)   

		IF OBJECT_ID('TEMPDB..#tmpParcel','U') IS NOT NULL
		   DROP TABLE #tmpParcel

		SELECT A.PARCEL_MEMO_ID,ANGM.ANGADIA_NAME AS TRANSPORTER_NAME,A.BILTY_NO AS BILTY_NO,                  
			CAST(A.RECEIPT_DT AS DATE) AS BILTY_DATE,SUM(B.BOX_NO) AS BOX_NO,SUM(QTY) AS WGHT,                  
			B.REF_MEMO_ID AS XN_ID,A.VEHICLE_NO,CAST(A.TOT_QTY AS VARCHAR) AS DISP_WEIGHT,  
            CAST(A.TOT_BOXES AS VARCHAR)AS DISP_BOX_NO    
			into #tmpParcel
		   FROM PARCEL_MST A (NOLOCK)                  
		   JOIN PARCEL_DET B (NOLOCK) ON A.PARCEL_MEMO_ID =B.PARCEL_MEMO_ID                             
		   LEFT OUTER JOIN ANGM (NOLOCK) ON ANGM.ANGADIA_CODE =A.ANGADIA_CODE                   
		   WHERE A.XN_TYPE ='SLS' and a.cancelled=0 AND B.REF_MEMO_ID=@cMemoId               
		   GROUP BY ANGM.ANGADIA_NAME ,A.PARCEL_MEMO_ID ,A.BILTY_NO ,B.REF_MEMO_ID,A.VEHICLE_NO,A.RECEIPT_DT,A.TOT_QTY,A.TOT_BOXES
	   
		IF OBJECT_ID('TEMPDB..#TMPLMV01106','U') IS NOT NULL
		   DROP TABLE #TMPLMV01106
			
        
		    SET @SALE_PERSON=''    
	
			SELECT @SALE_PERSON=COALESCE(@SALE_PERSON,'')+E.EMP_NAME+','        
			FROM      
			(      
			SELECT C1.SNO,E.EMP_NAME      
			FROM        
			(           
			SELECT DISTINCT '1'SNO,C.EMP_CODE  FROM CMD01106 C (NOLOCK) WHERE C.CM_ID=@cMemoId      
			UNION        
			SELECT DISTINCT '2',C.EMP_CODE1 FROM CMD01106 C (NOLOCK) WHERE C.CM_ID=@cMemoId      
			UNION        
			SELECT DISTINCT '3',C.EMP_CODE2 FROM CMD01106 C (NOLOCK) WHERE C.CM_ID=@cMemoId      
			)C1        
			JOIN EMPLOYEE E (NOLOCK) ON E.EMP_CODE=C1.EMP_CODE       
			WHERE ISNULL(E.EMP_NAME,'')<>''      
			)E      
			ORDER BY E.SNO      
        
			SELECT @SALE_PERSON=LTRIM(RTRIM(@SALE_PERSON))              
			IF RIGHT(@SALE_PERSON,1)=','              
			   SET @SALE_PERSON=LEFT(@SALE_PERSON,LEN(@SALE_PERSON)-1)              
			IF @SALE_PERSON<>''               
			   SET @SALE_PERSON='You are attended by '+@SALE_PERSON  
		 
		
		     
		DECLARE @NTAXABLEVALUE NUMERIC(14,2),@NIGST_AMOUNT NUMERIC(14,2),@NCGST_AMOUNT NUMERIC(14,2),@NSGST_AMOUNT NUMERIC(14,2),
		        @bpatchup_run bit ,@CAllowPatchedView varchar(10)

	            SELECT @CAllowPatchedView =VALUE FROM USER_ROLE_DET A (NOLOCK)--ADDED
				JOIN USERS B (NOLOCK)--ADDED
				ON A.ROLE_ID=B.ROLE_ID 
				WHERE USER_CODE=@CuserCode 
				AND FORM_NAME='FRMSALE' 
				AND FORM_OPTION='ALLOW_VIEW_PATCH_DATA'	

				if isnull(@CAllowPatchedView,0)<>'1'
				select top 1 @bpatchup_run=patchup_run  from cmm01106 (nolock)  WHERE cm_id=@cMemoId 



           if isnull(@bpatchup_run,0)=0
		   begin
			  SELECT    @NTAXABLEVALUE=ISNULL(cmd.XN_VALUE_WITHOUT_GST,0)+ ISNULL(cmm.OTHER_CHARGES_TAXABLE_VALUE,0),
					@NIGST_AMOUNT=ISNULL(cmd.IGST_AMOUNT,0)+ISNULL(cmm.OTHER_CHARGES_IGST_AMOUNT,0),
					@NCGST_AMOUNT=ISNULL(cmd.CGST_AMOUNT,0)+ISNULL(cmm.OTHER_CHARGES_CGST_AMOUNT,0),
					@NSGST_AMOUNT=ISNULL(cmd.SGST_AMOUNT,0)+ ISNULL(cmm.OTHER_CHARGES_SGST_AMOUNT,0)
			FROM cmm01106  cmm (NOLOCK)
			JOIN 
			( 
			   SELECT cm_id ,
					  SUM(XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST,
					  SUM(IGST_AMOUNT ) AS IGST_AMOUNT,
					  SUM(CGST_AMOUNT ) AS CGST_AMOUNT,
					  SUM(SGST_AMOUNT) AS SGST_AMOUNT
			   FROM cmd01106 cmd (NOLOCK)
			   WHERE cmd.cm_id=@CMEMOID
			   GROUP BY cm_id
			 ) cmd ON cmm.cm_id =cmd.cm_id 
			 WHERE cmm.cm_id=@cMemoId 

			 end 
			 else
			 begin
			     
			   SELECT    @NTAXABLEVALUE=ISNULL(cmd.XN_VALUE_WITHOUT_GST,0)+ ISNULL(cmm.OTHER_CHARGES_TAXABLE_VALUE,0),
					@NIGST_AMOUNT=ISNULL(cmd.IGST_AMOUNT,0)+ISNULL(cmm.OTHER_CHARGES_IGST_AMOUNT,0),
					@NCGST_AMOUNT=ISNULL(cmd.CGST_AMOUNT,0)+ISNULL(cmm.OTHER_CHARGES_CGST_AMOUNT,0),
					@NSGST_AMOUNT=ISNULL(cmd.SGST_AMOUNT,0)+ ISNULL(cmm.OTHER_CHARGES_SGST_AMOUNT,0)
			FROM cmm01106  cmm (NOLOCK)
			JOIN 
			( 
			   SELECT cm_id ,
					  SUM(old_XN_VALUE_WITHOUT_GST) AS XN_VALUE_WITHOUT_GST,
					  SUM(old_IGST_AMOUNT ) AS IGST_AMOUNT,
					  SUM(old_CGST_AMOUNT ) AS CGST_AMOUNT,
					  SUM(old_SGST_AMOUNT) AS SGST_AMOUNT
			   FROM cmd01106 cmd (NOLOCK)
			   WHERE cmd.cm_id=@CMEMOID
			   GROUP BY cm_id
			 ) cmd ON cmm.cm_id =cmd.cm_id 
			 WHERE cmm.cm_id=@cMemoId 


			 end



		DECLARE @IMG_SECTION BIT,@IMG_SUB_SECTION BIT,@IMG_ARTICLE BIT,@IMG_PARA1 BIT,@IMG_PARA2 BIT,@IMG_PARA3 BIT,@IMG_PARA4 BIT,@IMG_PARA5 BIT,@IMG_PARA6 BIT,@IMG_PRODUCT BIT
		SELECT @IMG_SECTION=SECTION,@IMG_SUB_SECTION=SUB_SECTION,@IMG_ARTICLE=ARTICLE        
		,@IMG_PARA1=PARA1 ,@IMG_PARA2=PARA2, @IMG_PARA3=PARA3,@IMG_PARA4=PARA4        
		,@IMG_PARA5=PARA5 ,@IMG_PARA6=PARA6, @IMG_PRODUCT=PRODUCT        
		FROM DBO.IMAGE_INFO_CONFIG WITH(NOLOCK)  
		--END: 30 NOV 2019
		
		
	  
        
        SELECT TOP 1 @PARA1=VALUE FROM CONFIG WHERE config_option='PARA1_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA2=VALUE FROM CONFIG WHERE config_option='PARA2_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA3=VALUE FROM CONFIG WHERE config_option='PARA3_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA4=VALUE FROM CONFIG WHERE config_option='PARA4_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA5=VALUE FROM CONFIG WHERE config_option='PARA5_caption' AND ISNULL(VALUE,'') <>''
        SELECT TOP 1 @PARA6=VALUE FROM CONFIG WHERE config_option='PARA6_caption' AND ISNULL(VALUE,'') <>''
	    SET @PARA1=CASE WHEN ISNULL(@PARA1,'')='' THEN 'Para1' ELSE ISNULL(@PARA1,'') END
	    SET @PARA2=CASE WHEN ISNULL(@PARA2,'')='' THEN 'Para2' ELSE ISNULL(@PARA2,'') END
	    SET @PARA3=CASE WHEN ISNULL(@PARA3,'')='' THEN 'Para3' ELSE ISNULL(@PARA3,'') END
	    SET @PARA4=CASE WHEN ISNULL(@PARA4,'')='' THEN 'Para4' ELSE ISNULL(@PARA4,'') END
	    SET @PARA5=CASE WHEN ISNULL(@PARA5,'')='' THEN 'Para5' ELSE ISNULL(@PARA5,'') END
	    SET @PARA6=CASE WHEN ISNULL(@PARA6,'')='' THEN 'Para6' ELSE ISNULL(@PARA6,'') END
	   

	     if isnull(@bpatchup_run,0)=0
		 begin

			SELECT @cCols=COALESCE(@cCols+',','')+column_name+' ['+DISPLAY_COLUMN_NAME+']' 
			FROM dynamic_print_cols	
			WHERE LTRIM(RTRIM(xn_type))='sls' AND selected=1
		end
		else
		begin

		    SELECT @cCols=COALESCE(@cCols+',','')+old_column_name+' ['+DISPLAY_COLUMN_NAME+']' 
			FROM dynamic_print_cols	
			WHERE LTRIM(RTRIM(xn_type))='sls' AND selected=1

		end


		SELECT @cnullableCols=COALESCE(@cnullableCols+',','')+'NULL as '+' ['+DISPLAY_COLUMN_NAME+']' 
		FROM dynamic_print_cols	
	    WHERE LTRIM(RTRIM(xn_type))='SLS' AND selected=0

		SET @cnullableCols=ISNULL(@cnullableCols,'')
		IF ISNULL(@cnullableCols,'')<>''
		   SET @cnullableCols=','+ISNULL(@cnullableCols,'')


	   
	   DECLARE @NAME VARCHAR(300),@CREFNO VARCHAR(1000),@ncnADJAMount numeric(14,2)

	     if isnull(@bpatchup_run,0)=0
		 begin

		   SELECT @NAME=COALESCE(@NAME,'')+(CASE WHEN M.PAYMODE_NAME='INR' THEN 'CASH' ELSE M.PAYMODE_NAME END)+':'+CONVERT(VARCHAR,ISNULL(P.amount,0))+'; ',
				  @CREFNO=COALESCE(@CREFNO+';','')+rtrim(ltrim(p.ref_no )),
				  @ncnADJAMount=COALESCE(@ncnADJAMount,0)+(CASE WHEN p.paymode_code ='0000001' and isnull(p.adj_memo_id,0)<>''  THEN P.amount ELSE 0 END)
		   FROM cmm01106  I (NOLOCK)
		   JOIN PAYMODE_XN_DET P (NOLOCK) ON I.cm_id =P.memo_id AND P.xn_type='SLS'
		   JOIN paymode_mst M (NOLOCK) ON M.paymode_code =P.paymode_code 
		   WHERE I.cm_id=@cMemoId

	   end 
	   else
	   begin
	        
			
		   SELECT @NAME=COALESCE(@NAME,'')+(CASE WHEN M.PAYMODE_NAME='INR' THEN 'CASH' ELSE M.PAYMODE_NAME END)+':'+CONVERT(VARCHAR,ISNULL(P.old_amount,0))+'; ',
				  @CREFNO=COALESCE(@CREFNO+';','')+rtrim(ltrim(p.ref_no )),
				  @ncnADJAMount=COALESCE(@ncnADJAMount,0)+(CASE WHEN p.paymode_code ='0000001' and isnull(p.adj_memo_id,0)<>''  THEN P.old_amount ELSE 0 END)
		   FROM cmm01106  I (NOLOCK)
		   JOIN PAYMODE_XN_DET P (NOLOCK) ON I.cm_id =P.memo_id AND P.xn_type='SLS'
		   JOIN paymode_mst M (NOLOCK) ON M.paymode_code =P.paymode_code 
		   WHERE I.cm_id=@cMemoId


	   end
	   
	   set @ncnADJAMount=ISNULL(@ncnADJAMount,0)



	   SET @NAME=RTRIM(@NAME)
	   IF RIGHT(@NAME,1)=';' SET @NAME=LEFT(@NAME,LEN(@NAME)-1)

	   IF RIGHT(@CREFNO,1)=';' SET @CREFNO=LEFT(@CREFNO,LEN(@CREFNO)-1)

	   set @NAME=isnull(@NAME,'')
	   set @CREFNO=isnull(@CREFNO,'')


	   --hold status Print

	      
		 IF OBJECT_ID ('TEMPDB..#TMPHOLDS','U') IS NOT NULL  
			DROP TABLE #TMPHOLDS  

			SELECT cast('' as varchar(50)) as cmd_row_id, Hold_Status=CAST(0 AS BIT), CAST('' AS VARCHAR(100)) AS JOB_NAME,
			       CAST('' AS DateTime) AS DELIVERY_DT
			INTO #TMPHOLDS WHERE 1=2
			
       
        IF EXISTS (SELECT TOP 1 'U'  FROM dynamic_print_cols (nolock)	WHERE LTRIM(RTRIM(xn_type))='sls' AND selected=1 
		AND DISPLAY_COLUMN_NAME IN('Hold_Status','Job_Name','DELIVERY_DT'))
		begin

			 INSERT INTO #TMPHOLDS(cmd_row_id,HOLD_STATUS,JOB_NAME,DELIVERY_DT)
			 SELECT A.ROW_ID ,CASE WHEN HD.DELIVERED= 1 THEN 0 ELSE 1 END AS HOLD_STATUS, ISNULL(J.JOB_NAME,'')JOB_NAME,  
				CONVERT(VARCHAR(10), ISNULL(HD.DELIVERY_DT,''),121) DELIVERY_DT  
			 FROM CMD01106 A (NOLOCK)  
			 JOIN HOLD_BACK_DELIVER_DET HD (NOLOCK) ON HD.REF_CMD_ROW_ID =A.ROW_ID   
			 JOIN HOLD_BACK_DELIVER_MST HM (NOLOCK) ON HM.MEMO_ID =HD.MEMO_ID   
			 JOIN JOBS J (NOLOCK) ON J.JOB_CODE=HD.JOB_CODE  
			 WHERE CM_ID=@CMEMOID AND HM.CANCELLED =0  
			 AND ISNULL(J.JOB_NAME,'')<>'' --AND 1=2  
			 group by A.ROW_ID ,CASE WHEN HD.DELIVERED= 1 THEN 0 ELSE 1 END , ISNULL(J.JOB_NAME,''), CONVERT(VARCHAR(10), ISNULL(HD.DELIVERY_DT,''),121)

			 ;with cte as
			 (
			   select *,sr=ROW_NUMBER () over(partition by cmd_row_id order by Delivery_dt) from #TMPHOLDS
			 )

			DELETE FROM CTE WHERE SR>1
			

		 end

    DECLARE @CONSBARCODE VARCHAR(1000),@GSTINVOICE_WITHOUT_STARS varchar(5)

	IF EXISTS (SELECT TOP 1 'U' FROM dynamic_print_cols	(NOLOCK) WHERE LTRIM(RTRIM(xn_type))='SLS' AND selected=1 AND DISPLAY_COLUMN_NAME ='CONSUMABLE_BARCODE')
	BEGIN

	
	   SELECT @CONSBARCODE=ISNULL(@CONSBARCODE+',' ,'')+''+
	           LEFT(CONS.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX ('@',CONS.PRODUCT_CODE)-1,-1),LEN(CONS.PRODUCT_CODE )))  + 
			   ' Qty:'+CAST(CONS.quantity AS VARCHAR(100)) 
	   FROM CMD_CONS  CONS (NOLOCK) 
	   WHERE CONS.CM_ID=@CMEMOID  
	
	END
	
	
	   SELECT TOP 1 @GSTINVOICE_WITHOUT_STARS =VALUE FROM USER_ROLE_DET A(NOLOCK)    
	   JOIN USERS B(NOLOCK) ON A.ROLE_ID=B.ROLE_ID    
	   WHERE USER_CODE=@CUSERCODE    
	   AND FORM_NAME='Miscellaneous'     
	   AND FORM_OPTION='GSTINVOICE_WITHOUT_STARS'    

	select @CONSBARCODE as CONSUMABLE_BARCODE,@GSTINVOICE_WITHOUT_STARS as  GSTINVOICE_WITHOUT_STARS
    INTO #TMPcons

   
       

	   DECLARE @CSPID VARCHAR(50),@CTABLENAME VARCHAR(50)

		SET @CSPID=LTRIM(RTRIM(STR(@@SPID )))
		SET @CTABLENAME  ='##TMPINVPRINT'+@CSPID

		SET @CCMD = N'IF OBJECT_ID(''TEMPDB..'+@CTABLENAME+''',''U'') IS NOT NULL
			DROP TABLE '+@CTABLENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD
                

	   SET @cCmdCols=N'
	   SELECT '+@cCols+',
	   '''+@para1 +''' AS PARA1_CONFIG,'''+@PARA2 +''' AS PARA2_CONFIG,'''+@PARA3 +''' AS PARA3_CONFIG,
	   '''+@PARA4 +''' AS PARA4_CONFIG,'''+@PARA5 +''' AS PARA5_CONFIG,'''+@PARA6 +''' AS PARA6_CONFIG,
	   DBO.FN_CONVERTAMOUNTINWORDS(ABS(CMM.NET_AMOUNT)) AS  NET_AMOUNT_IN_WORDS,
	    '+RTRIM(LTRIM(STR(@NTAXABLEVALUE ,14,2)))+' as Total_Taxable_value,
	   '+RTRIM(LTRIM(STR(@NIGST_AMOUNT,14,2)))+' as Total_Igst_Amount,
	   '+RTRIM(LTRIM(STR(@NSGST_AMOUNT,14,2)))+' as Total_Sgst_Amount,
	   '+RTRIM(LTRIM(STR(@NCGST_AMOUNT,14,2)))+' as Total_Cgst_amount,
	   cast(NULL AS VARBINARY(MAX)) AS QRCODEIMAGE,cast(NULL AS VARBINARY(MAX)) AS QRCODEIMAGE_MEMODETAILS,CAST(NULL AS VARCHAR(MAX)) AS DOCUMENTCOPY,
	   '''+@NAME+''' PAYMENT_DETAILS,
	    '+RTRIM(LTRIM(STR(@ncnADJAMount ,14,2)))+' as CN_AdjAmount,
	   '''+@CREFNO+''' AS REFERENCE_NO,
	   '''+@SALE_PERSON+''' AS  SALE_PERSON 
	   '+@cnullableCols
	   +' INTO '+@CTABLENAME+' '
	   SET @cCmd1=N'  FROM CMD01106  (NOLOCK)  
	   JOIN CMM01106 CMM (NOLOCK) ON CMM.CM_ID=CMD01106.CM_ID       
	   JOIN GST_COMPANY_CONFIG COM(NOLOCK) ON 1=1 AND COM.XN_TYPE=''SLS''   
	   JOIN USERS  (NOLOCK) ON USERS.USER_CODE=CMM.USER_CODE   
	   JOIN BIN (NOLOCK) ON BIN.BIN_ID=CMD01106.BIN_ID
	   LEFT JOIN COMPANY CMP (NOLOCK) ON CMP.COMPANY_CODE=''01''   
	   LEFT OUTER JOIN LOCATION SL (NOLOCK) ON SL.DEPT_ID =CMM.LOCATION_CODE 
	   LEFT JOIN AREA SLA (NOLOCK) ON SL.AREA_CODE=SLA.AREA_CODE                  
	   LEFT JOIN CITY SLC (NOLOCK) ON SLA.CITY_CODE=SLC.CITY_CODE                  
	   LEFT JOIN GST_STATE_MST SLS (NOLOCK) ON SLS.GST_STATE_CODE=SL.GST_STATE_CODE
	   LEFT JOIN STATE SLST (nolock) on SL.gst_state_code =SLST.state_code
	   LEFT JOIN REGIONM SLR (NOLOCK) ON SLST.region_code=SLR.region_code '
       SET @cCmd2=N'
        JOIN SKU (NOLOCK) ON sku.product_CODE=CMD01106.product_code        
        JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE        
        JOIN SKU_NAMES (NOLOCK) ON SKU_NAMES.PRODUCT_CODE =SKU.PRODUCT_CODE '        
       SET @cCmd3=N' 
       LEFT JOIN UOM UOM (NOLOCK) ON UOM.UOM_CODE=ARTICLE.UOM_CODE                  
       LEFT OUTER JOIN (SELECT TNC_1,TNC_2,TNC_3,TNC_4,TNC_5,TNC_6,TNC_7,TNC_8 FROM GST_TNC WHERE XN_TYPE=''SLS'')GST_TNC  ON 1=1
	   JOIN CUSTDYM CUST (NOLOCK) ON CUST.CUSTOMER_CODE=CMM.CUSTOMER_CODE  
	   JOIN GST_STATE_MST CUSTST (NOLOCK) ON CMM.PARTY_STATE_CODE=CUSTST.GST_STATE_CODE
	   LEFT JOIN AREA CUSTAR (NOLOCK) ON CUSTAR.AREA_CODE=CUST.AREA_CODE                  
	   LEFT JOIN CITY CUSTCT (NOLOCK) ON CUSTCT.CITY_CODE=CUSTAR.CITY_CODE    
	   LEFT JOIN RPS_DET RPSDET   (NOLOCK) ON RPSDET.ROW_ID =CMD01106.PACK_SLIP_ROW_ID 
	   LEFT JOIN RPS_MST RPSMST (NOLOCK) ON RPSDET.CM_ID=RPSMST.CM_ID 
	   LEFT JOIN EMPLOYEE ON EMPLOYEE.EMP_CODE=CMD01106.EMP_CODE             
       LEFT JOIN EMPLOYEE EMPLOYEE1 ON EMPLOYEE1.EMP_CODE=CMD01106.EMP_CODE1             
       LEFT JOIN EMPLOYEE EMPLOYEE2 ON EMPLOYEE2.EMP_CODE=CMD01106.EMP_CODE2  
	   LEFT JOIN #TMPHOLDS hlds on hlds.cmd_row_id=CMD01106.row_id
	   LEFT JOIN DTM  (NOLOCK) ON DTM.DT_CODE=CMM.DT_CODE
	   LEFT JOIN #TMPCONS CONS ON 1=1
	   '

       
       IF CHARINDEX('PROD_IMAGE',@CCOLS)>0
       SET @cCmdIMG=N'LEFT OUTER JOIN ' + DB_NAME()+ '_IMAGE..IMAGE_INFO IMG (NOLOCK) ON 1=2 ' +
                            (CASE WHEN @IMG_SECTION = 1 THEN 'AND IMG.SECTION_CODE=SECTIONM.SECTION_CODE' ELSE ''  END) +
                            (CASE WHEN @IMG_SUB_SECTION = 1 THEN ' AND IMG.SUB_SECTION_CODE=SECTIOND.SUB_SECTION_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_ARTICLE = 1 THEN ' AND IMG.ARTICLE_CODE=ARTICLE.ARTICLE_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA1 = 1 THEN ' AND IMG.PARA1_CODE=SKU.PARA1_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA2 = 1 THEN ' AND IMG.PARA2_CODE=SKU.PARA2_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA3 = 1 THEN ' AND IMG.PARA3_CODE=SKU.PARA3_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA4 = 1 THEN  ' AND IMG.PARA4_CODE=SKU.PARA4_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA5 = 1 THEN  ' AND IMG.PARA5_CODE=SKU.PARA5_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PARA6 = 1 THEN  ' AND IMG.PARA6_CODE=SKU.PARA6_CODE' ELSE '' END) +
                            (CASE WHEN @IMG_PRODUCT = 1 THEN  'AND IMG.PRODUCT_CODE=SKU.PRODUCT_CODE' ELSE '' END)
                            +' WHERE CMM.CM_ID='''+@cMemoId+''''       
       ELSE
          SET @cCmdIMG=N' WHERE CMM.CM_ID='''+@cMemoId+''''
     print 'cCmdCols '+@cCmdCols
    
 
       PRINT @ccmd1
       PRINT @ccmd2
       PRINT @ccmd3
       PRINT 'IMG '+@cCmdIMG
       EXEC(@cCmdCols+@ccmd1+@ccmd2+@ccmd3+@cCmdIMG)

 
 END_PROC:

	   IF ISNULL(@CERRMSG,'')<>'' 
	   BEGIN
		   SELECT @CERRMSG AS ERRMSG 
	   END
	   ELSE 
	   BEGIN
	     
			  SET @CCMD = N'SELECT * FROM '+@CTABLENAME+' '  
			  PRINT @CCMD  
			  EXEC SP_EXECUTESQL @CCMD  

			
             SELECT CM.CM_NO,P.MEMO_ID ,(CASE WHEN M.PAYMODE_NAME='INR' THEN 'CASH' ELSE M.PAYMODE_NAME END) PAYMODE_NAME,
			     SUM(case when isnull(@bpatchup_run,0)=0 then AMOUNT else old_amount end) AS AMOUNT,P.REF_NO 
			FROM  PAYMODE_XN_DET P (NOLOCK)
			JOIN CMM01106 CM ON P.MEMO_ID =CM.CM_ID 
			JOIN PAYMODE_MST M (NOLOCK) ON M.PAYMODE_CODE =P.PAYMODE_CODE 
			WHERE MEMO_ID=@CMEMOID AND P.XN_TYPE ='SLS'
			GROUP BY CM.CM_NO,P.MEMO_ID ,
			(CASE WHEN M.PAYMODE_NAME='INR' THEN 'CASH' ELSE M.PAYMODE_NAME END),P.REF_NO 
 
	   END

	    SET @CCMD = N'IF OBJECT_ID(''TEMPDB..'+@CTABLENAME+''',''U'') IS NOT NULL
			DROP TABLE '+@CTABLENAME+''
		PRINT @CCMD
		EXEC SP_EXECUTESQL @CCMD

SET NOCOUNT OFF
END


