CREATE   PROCEDURE SP_PRDUPC_WO_DETAILS    
(    
 @CORDER_ID VARCHAR(100)='',    
 @CPARA1_CODE VARCHAR(10)='',    
 @CPARA2_CODE VARCHAR(10)='',    
 @NISSUE INT =1,    
 @CMEMO_ID VARCHAR(100)=''    
)    
AS    
BEGIN    
    
IF @NISSUE=1 --FOR ISSUE    
  BEGIN    
 SELECT CAST(0 AS BIT) AS CHK, CAST('LATER' AS VARCHAR(100)) AS MEMO_ID,     
 CAST(NEWID() AS VARCHAR(40)) AS ROW_ID,    
 CAST('' AS VARCHAR(40)) AS REF_ROW_ID,    
 A.WO_ID,A.PARA1_CODE,A.PARA2_CODE,A.PRODUCT_CODE,A.QUANTITY_IN_STOCK  ,    
 1 AS QUANTITY,    
 A.JOB_CODE,    
 GETDATE() AS LAST_UPDATE,    
 P1.PARA1_NAME,    
 P2.PARA2_NAME,    
 EMP.EMP_NAME  AS MERCHANT_NAME,    
 LM.AC_NAME AS AC_NAME,
 JOBS.JOB_NAME     
 FROM PRD_UPCPMT A    
 JOIN PRD_WO_MST MST ON MST.MEMO_ID =A.WO_ID    
 JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE    
 JOIN PARA2 P2 ON P2.PARA2_CODE=A.PARA2_CODE   
 LEFT JOIN JOBS ON JOBS.JOB_CODE =A.JOB_CODE 
 LEFT JOIN(SELECT * FROM PRD_WO_ORDERS (NOLOCK) ) WO ON WO.MEMO_ID =A.WO_ID  
 LEFT OUTER JOIN 
 (
  SELECT A.ORDER_ID ,A.ITEM_MERCHANT_CODE ,B.AC_CODE  
  FROM BUYER_ORDER_DET A (NOLOCK)
  JOIN BUYER_ORDER_MST B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID 
  WHERE B.CANCELLED =0
  GROUP BY A.ORDER_ID ,A.ITEM_MERCHANT_CODE ,B.AC_CODE
 ) BO ON BO.ORDER_ID =ISNULL(A.ORDER_ID ,WO.ORDER_ID )
 LEFT OUTER JOIN EMPLOYEE EMP ON EMP.EMP_CODE =BO.ITEM_MERCHANT_CODE 
 LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =BO.AC_CODE  
 --JOIN FN_WO_ALLOCATION  ('',@CORDER_ID) FN ON FN.WO_ID  =A.WO_ID AND FN.PARA1_CODE=A.PARA1_CODE  AND FN.PARA2_CODE=A.PARA2_CODE          
 --AND FN.PRODUCT_CODE=A.PRODUCT_CODE     
 WHERE A.WO_ID=@CORDER_ID    
 AND MST.CANCELLED =0    
 AND A.PARA1_CODE=@CPARA1_CODE     
 AND A.PARA2_CODE=@CPARA2_CODE    
 AND QUANTITY_IN_STOCK>0    
 END    
 ELSE IF @NISSUE=0 --FOR REC    
 BEGIN    
     
     
 IF OBJECT_ID ('TEMPDB..#TMPREC','U') IS NOT NULL    
    DROP TABLE #TMPREC    
     
 SELECT DISTINCT A.MEMO_ID AS ISSUE_ID ,B.MEMO_ID AS REC_ID     
 INTO #TMPREC    
 FROM PRD_AGENCY_ISSUE_MATERIAL_DET A    
 JOIN    
 (    
 SELECT B.MEMO_ID ,C.REF_ROW_ID     
 FROM  PRD_AGENCY_MATERIAL_RECEIPT_MST B     
 JOIN PRD_AGENCY_MATERIAL_RECEIPT_DET C ON B.MEMO_ID =C.MEMO_ID     
 WHERE B.CANCELLED =0     
 GROUP BY B.MEMO_ID ,C.REF_ROW_ID     
 ) B ON A.ROW_ID =B.REF_ROW_ID     
 WHERE A.MEMO_ID=@CMEMO_ID    
     
  SELECT CAST(0 AS BIT) AS CHK, CAST('LATER' AS VARCHAR(100)) AS MEMO_ID,     
 CAST(NEWID() AS VARCHAR(40)) AS ROW_ID,    
 CAST('' AS VARCHAR(40)) AS REF_ROW_ID,    
 A.WO_ID,A.PARA1_CODE,A.PARA2_CODE,A.PRODUCT_CODE,A.QUANTITY_IN_STOCK  ,    
 1 AS QUANTITY,    
 A.JOB_CODE,    
 GETDATE() AS LAST_UPDATE,    
 P1.PARA1_NAME,    
 P2.PARA2_NAME,    
 EMP.EMP_NAME  AS MERCHANT_NAME,    
 LM.AC_NAME AS AC_NAME,
 JOBS.JOB_NAME    
 FROM PRD_UPCPMT A    
 JOIN PRD_AGENCY_ISSUE_MATERIAL_UPC ISS ON A.PRODUCT_CODE=ISS.PRODUCT_CODE    
 JOIN PRD_AGENCY_ISSUE_MATERIAL_MST MST ON MST.MEMO_ID =ISS.MEMO_ID     
 JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE    
 JOIN PARA2 P2 ON P2.PARA2_CODE=A.PARA2_CODE   
 LEFT JOIN JOBS ON JOBS.JOB_CODE =A.JOB_CODE  
 LEFT OUTER JOIN    
 (    
  SELECT A.ISSUE_ID,A.REC_ID,B.PRODUCT_CODE  FROM #TMPREC A    
  JOIN PRD_AGENCY_MATERIAL_RECEIPT_UPC B ON A.REC_ID=B.MEMO_ID     
 ) REC ON MST.MEMO_ID =REC.ISSUE_ID AND A.PRODUCT_CODE =REC.PRODUCT_CODE 
 LEFT JOIN(SELECT * FROM PRD_WO_ORDERS (NOLOCK) ) WO ON WO.MEMO_ID =A.WO_ID  
 LEFT OUTER JOIN 
 (
  SELECT A.ORDER_ID ,A.ITEM_MERCHANT_CODE ,B.AC_CODE  
  FROM BUYER_ORDER_DET A (NOLOCK)
  JOIN BUYER_ORDER_MST B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID 
  WHERE B.CANCELLED =0
  GROUP BY A.ORDER_ID ,A.ITEM_MERCHANT_CODE ,B.AC_CODE
 ) BO ON BO.ORDER_ID =ISNULL(A.ORDER_ID ,WO.ORDER_ID )
 LEFT OUTER JOIN EMPLOYEE EMP ON EMP.EMP_CODE =BO.ITEM_MERCHANT_CODE 
 LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =BO.AC_CODE       
 --JOIN FN_WO_ALLOCATION  ('',@CORDER_ID) FN ON FN.WO_ID  =A.WO_ID AND FN.PARA1_CODE=A.PARA1_CODE  AND FN.PARA2_CODE=A.PARA2_CODE     
-- AND FN.PRODUCT_CODE=A.PRODUCT_CODE     
 WHERE A.WO_ID=@CORDER_ID    
 AND A.PARA1_CODE=@CPARA1_CODE     
 AND A.PARA2_CODE=@CPARA2_CODE    
 AND ISS.MEMO_ID=@CMEMO_ID    
 AND MST.CANCELLED =0    
 AND A.QUANTITY_IN_STOCK=0    
 AND REC.PRODUCT_CODE IS NULL    
     
     
     
 END     
 ELSE    
 BEGIN    
     
    SELECT DISTINCT CAST(0 AS BIT) AS CHK, CAST('LATER' AS VARCHAR(100)) AS MEMO_ID,     
 CAST(NEWID() AS VARCHAR(40)) AS ROW_ID,    
 A.WO_ID,A.PARA1_CODE,A.PARA2_CODE,A.PRODUCT_CODE,A.QUANTITY_IN_STOCK  ,    
 1 AS QUANTITY,    
 A.JOB_CODE,    
 GETDATE() AS LAST_UPDATE,    
 P1.PARA1_NAME,    
 P2.PARA2_NAME,    
 CAST('' AS VARCHAR(40)) AS REF_ROW_ID,    
 EMP.EMP_NAME  AS MERCHANT_NAME,    
 LM.AC_NAME AS AC_NAME,
  JOBS.JOB_NAME   
 FROM PRD_UPCPMT A    
 JOIN     
 (    
  SELECT PRODUCT_CODE FROM PRD_AGENCY_MATERIAL_RECEIPT_UPC REC    
  JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST MST ON MST.MEMO_ID=REC.MEMO_ID    
  WHERE MST.CANCELLED=0    
  GROUP BY PRODUCT_CODE    
 ) UPC ON A.PRODUCT_CODE =UPC.PRODUCT_CODE     
 --PRD_AGENCY_MATERIAL_RECEIPT_UPC REC ON A.PRODUCT_CODE=REC.PRODUCT_CODE    
 --JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST MST ON MST.MEMO_ID=REC.MEMO_ID    
 JOIN PARA1 P1 ON P1.PARA1_CODE=A.PARA1_CODE    
 JOIN PARA2 P2 ON P2.PARA2_CODE=A.PARA2_CODE 
 LEFT JOIN JOBS ON JOBS.JOB_CODE =A.JOB_CODE
  LEFT JOIN(SELECT * FROM PRD_WO_ORDERS (NOLOCK) ) WO ON WO.MEMO_ID =A.WO_ID  
 LEFT OUTER JOIN 
 (
  SELECT A.ORDER_ID ,A.ITEM_MERCHANT_CODE ,B.AC_CODE  
  FROM BUYER_ORDER_DET A (NOLOCK)
  JOIN BUYER_ORDER_MST B (NOLOCK) ON A.ORDER_ID =B.ORDER_ID 
  WHERE B.CANCELLED =0
  GROUP BY A.ORDER_ID ,A.ITEM_MERCHANT_CODE ,B.AC_CODE
 ) BO ON BO.ORDER_ID =ISNULL(A.ORDER_ID ,WO.ORDER_ID )
 LEFT OUTER JOIN EMPLOYEE EMP ON EMP.EMP_CODE =BO.ITEM_MERCHANT_CODE 
 LEFT JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =BO.AC_CODE        
 --JOIN FN_WO_ALLOCATION  ('',@CORDER_ID) FN ON FN.WO_ID  =A.WO_ID AND FN.PARA1_CODE=A.PARA1_CODE  AND FN.PARA2_CODE=A.PARA2_CODE     
 --AND FN.PRODUCT_CODE=A.PRODUCT_CODE     
 WHERE A.WO_ID=@CORDER_ID     
 AND A.PARA1_CODE=@CPARA1_CODE     
 AND A.PARA2_CODE=@CPARA2_CODE    
 AND A.QUANTITY_IN_STOCK=1 AND ISNULL(A.JOB_CODE,'')<>''    
     
 END    
  
END
