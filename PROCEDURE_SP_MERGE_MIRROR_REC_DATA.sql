CREATE PROCEDURE SP_MERGE_MIRROR_REC_DATA
(
	 @CUPLOADEDXNID VARCHAR(50)='',
	 @CXNTYPE VARCHAR(50) = '',
	 @BMISMATCH BIT OUTPUT,
	 @CERRMSG VARCHAR(MAX) OUTPUT
)
--WITH ENCRYPTION
AS
BEGIN
   DECLARE @CSTEP VARCHAR(100),@DTSQL NVARCHAR(MAX),@CMERGEDB VARCHAR(100),@CSOURCEDB VARCHAR(100),@CTEMPTABLENAME1 VARCHAR(100),
   @CTEMPTABLENAME2 VARCHAR(100),@CTEMPTABLENAME3 VARCHAR(100),@HOQUANTITY NUMERIC(14,2),@CDETAILTABLENAME VARCHAR(100),@CMEMOCOLUMN VARCHAR(100),
   @LOCQUANTITY NUMERIC(14,2),@LOCAMOUNT NUMERIC(14,2),@XN_DT VARCHAR(100),@CTEMPTAXRECOTABLE VARCHAR(500)
   DECLARE @CDETTABLE VARCHAR(100),@CMASTERTABLNAME VARCHAR(100),@CPAYMODETABLE VARCHAR(100),@CKEYCOLUMN VARCHAR(20),@CBIN VARCHAR(20),
   @CENFORCEBATCHMODEMERGING VARCHAR(2),@HOAMOUNT NUMERIC(14,2),@BCOMPCUSTCODE BIT,@CFILTEREXPR1 VARCHAR(500),@CFILTEREXPR2 VARCHAR(500),@NVERSIONNO INT 
   
   SET @CSTEP = '00'
   
   SELECT @CFILTEREXPR1='',@CFILTEREXPR2=''
   
   SET @BMISMATCH=0
   
   SELECT TOP 1 @CENFORCEBATCHMODEMERGING=VALUE FROM CONFIG WHERE CONFIG_OPTION='ENFORCE_BATCH_MODE_MERGING'
   
	   
    DECLARE @TSENDINGORDER TABLE (XN_TYPE VARCHAR(100),MASTERTABLNAME VARCHAR(100),DETTABLENAME VARCHAR(100),KEYFILD VARCHAR(100),MEMODT VARCHAR(100),BIN VARCHAR(10), SEND_ORDER NUMERIC(4))
   
    INSERT @TSENDINGORDER (XN_TYPE,MASTERTABLNAME,DETTABLENAME,KEYFILD,MEMODT,BIN,SEND_ORDER)
	SELECT 'PUR','PIM01106','PID01106','MRR_ID','RECEIPT_DT','B.BIN_ID',20
	UNION
	SELECT 'IRR_PFI','IRM01106','IRD01106','IRM_MEMO_ID','IRM_MEMO_DT','B.BIN_ID',40
	UNION
	SELECT 'IRR_CIP','IRM01106','IRD01106','IRM_MEMO_ID','IRM_MEMO_DT','A.BIN_ID',50
	UNION
	SELECT 'RPS','RPS_MST','RPS_DET','CM_ID','CM_DT','A.BIN_ID',60
	UNION
	SELECT 'SLS','CMM01106','CMD01106','CM_ID','CM_DT','A.BIN_ID',80
	UNION
	SELECT 'DNPS','DNPS_MST','DNPS_DET','PS_ID','PS_DT','A.BIN_ID',100
	UNION
	SELECT 'PRT','RMM01106','RMD01106','RM_ID','RM_DT','A.BIN_ID',120
	UNION
	SELECT 'WPS','WPS_MST','WPS_DET','PS_ID','PS_DT','A.BIN_ID',140
	UNION
	SELECT 'WSL','INM01106','IND01106','INV_ID','INV_DT','A.BIN_ID',160
	UNION
	SELECT 'WSR','CNM01106','CND01106','CN_ID','CN_DT','A.BIN_ID',180
	UNION
	SELECT 'CNC','ICM01106','ICD01106','CNC_MEMO_ID','CNC_MEMO_DT','A.BIN_ID',200
   
   	   
BEGIN TRY
	SET @CSTEP = 00
	SET @CMERGEDB =  DB_NAME()
	SET @CSOURCEDB = DB_NAME()+'_TEMP.DBO.'
	SET @CTEMPTABLENAME1 = 'TMP_RECON_'+@CXNTYPE+'_'+LTRIM(RTRIM(REPLACE(@CUPLOADEDXNID,'-','_')))
	SET @BMISMATCH = 0
	SET @CSTEP = 10
	SET @CTEMPTABLENAME2 = ''
	
	SET @CPAYMODETABLE='PAYMODE_XN_DET'
	
	IF @CXNTYPE = 'SLS'
	BEGIN
		SET @CSTEP = 20
		SET @CTEMPTABLENAME2 = 'TMP_RECON_'+@CXNTYPE+'_PAYMODE_'+LTRIM(RTRIM(REPLACE(@CUPLOADEDXNID,'-','_')))
        SET @CTEMPTABLENAME3 = 'TMP_RECON_'+@CXNTYPE+'_CMD_RECO_TAX_'+LTRIM(RTRIM(REPLACE(@CUPLOADEDXNID,'-','_')))

		SET @DTSQL=N'IF EXISTS (SELECT MEMO_ID FROM '+@CSOURCEDB+@CTEMPTABLENAME1+' WHERE ISNULL(CUSTOMER_CODE,'''')<>'''')
						SET @BCOMPCUSTCODE=1
					 ELSE
						SET @BCOMPCUSTCODE=0'
		PRINT @DTSQL
		EXEC SP_EXECUTESQL @DTSQL,N'@BCOMPCUSTCODE BIT OUTPUT',@BCOMPCUSTCODE OUTPUT
    END
	
	SET @CSTEP = 40
	
	SET @DTSQL = N'IF OBJECT_ID('''+@CSOURCEDB+@CTEMPTABLENAME1+''',''U'') IS NULL
					SET @CERRMSG = ''TEMP XNS TABLE NOT FOUND'''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL,N'@CERRMSG VARCHAR(MAX) OUTPUT',@CERRMSG OUTPUT		
	
	SET @CSTEP = 50
	IF ISNULL(@CERRMSG,'') <> ''
	BEGIN
		SET @BMISMATCH = 1
		GOTO END_PROC
	END
	
	SET @CSTEP = 60
	SET @DTSQL = N'IF OBJECT_ID('''+@CTEMPTABLENAME1+''',''U'') IS NOT NULL
					DROP TABLE '+@CTEMPTABLENAME1+''
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
	
	SET @CSTEP = 65
	SELECT @CDETTABLE=DETTABLENAME,@CMASTERTABLNAME=MASTERTABLNAME,@CKEYCOLUMN=KEYFILD,@CBIN=BIN,@XN_DT=MEMODT 
	FROM @TSENDINGORDER WHERE XN_TYPE = @CXNTYPE
	
	IF @CXNTYPE='SLS'
	BEGIN
		PRINT 'CHECK MEMO IN MIRROR TABLE'
		IF EXISTS (SELECT TOP 1 CM_ID FROM SLS_CMM01106_MIRROR (NOLOCK) WHERE CM_ID=@CUPLOADEDXNID)
		BEGIN
			SET @CSTEP = 70
			SELECT @NVERSIONNO=MAX(VERSION_NO) FROM SLS_CMM01106_MIRROR WHERE CM_ID=@CUPLOADEDXNID
	
			
			SELECT @CDETTABLE='SLS_CMD01106_MIRROR',@CMASTERTABLNAME='SLS_CMM01106_MIRROR',@CPAYMODETABLE='SLS_PAYMODE_XN_DET_MIRROR',
				   @CFILTEREXPR1=' AND A.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO)))+' AND B.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO))),
				   @CFILTEREXPR2=' AND B.VERSION_NO='+LTRIM(RTRIM(STR(@NVERSIONNO)))
		END	
	END	
	
	SET @CSTEP = 80
	PRINT 'CHECK MEMO MISMATCH IN QTY'
	
	SET @DTSQL = N'SELECT '''+@CXNTYPE+''' AS XN_TYPE,
							  A.'+@CKEYCOLUMN+' AS MEMO_ID,
							   ISNULL(SUM(QUANTITY),0) AS XN_QTY,'+
						      (CASE WHEN @CXNTYPE = 'SLS' THEN ' NET_AMOUNT ' ELSE ' 0 'END)+' AS AMOUNT ,
						       '''+LEFT(@CUPLOADEDXNID,2)+''' AS DEPT_ID,
						       '+@CBIN+', '+@XN_DT+' AS XN_DT
						INTO '+@CTEMPTABLENAME1+' FROM '+@CDETTABLE+' A JOIN '+@CMASTERTABLNAME+' B
						ON A.'+@CKEYCOLUMN+' = B.'+@CKEYCOLUMN+' 
						WHERE B.'+@CKEYCOLUMN+' = '''+@CUPLOADEDXNID+''''+@CFILTEREXPR1+' 
						GROUP BY A.'+@CKEYCOLUMN+','+@CBIN+', '+@XN_DT+''+
						(CASE WHEN @CXNTYPE = 'SLS' THEN ',NET_AMOUNT ' ELSE ' 'END)
	
						
	PRINT ISNULL(@DTSQL,'NULL DTSQL')
	EXEC SP_EXECUTESQL @DTSQL
	
	SET @CSTEP = 90					
	SET @DTSQL = N'IF EXISTS (SELECT TOP 1 A.* FROM '+@CSOURCEDB+@CTEMPTABLENAME1+' A 
							  JOIN '+@CTEMPTABLENAME1+' B ON A.MEMO_ID = B.MEMO_ID
							  WHERE A.XN_DT<>B.XN_DT)
						BEGIN	  
							SET @BMISMATCH=1
							SET @CERRMSG = ''MEMO DATE NOT MATCH''
						END	
						ELSE
						BEGIN
							SET @BMISMATCH=0
							SET @CERRMSG = ''SUCCESS''
						END	'
	
	PRINT @DTSQL					
	EXEC SP_EXECUTESQL @DTSQL,N'@BMISMATCH BIT OUTPUT,@CERRMSG VARCHAR(100) OUTPUT',@BMISMATCH OUTPUT,@CERRMSG OUTPUT

	IF (@BMISMATCH = 1)
		GOTO END_PROC
	
	SET @CSTEP = 100								
	SET @DTSQL = N'IF EXISTS (SELECT TOP 1 A.* FROM '+@CSOURCEDB+@CTEMPTABLENAME1+' A 
							  FULL OUTER JOIN '+@CTEMPTABLENAME1+' B ON A.MEMO_ID = B.MEMO_ID AND A.BIN_ID=B.BIN_ID AND A.XN_DT = B.XN_DT
							  WHERE  ISNULL(A.XN_QTY,0) <> ISNULL(B.XN_QTY,0))
						BEGIN	  
							SET @BMISMATCH=1
							SET @CERRMSG = ''QUANTITY NOT MATCH''
						END	
							ELSE
						BEGIN
							SET @BMISMATCH=0
							SET @CERRMSG = ''SUCCESS''
						END	'
	
	PRINT @DTSQL					
	EXEC SP_EXECUTESQL @DTSQL,N'@BMISMATCH BIT OUTPUT,@CERRMSG VARCHAR(100) OUTPUT',@BMISMATCH OUTPUT,@CERRMSG OUTPUT
	
	IF (@BMISMATCH = 1)
		GOTO END_PROC
		
	IF (@CXNTYPE = 'SLS')
	BEGIN
		SET @CSTEP = 165

		SET @DTSQL = N'IF EXISTS (SELECT TOP 1 A.* FROM '+@CSOURCEDB+@CTEMPTABLENAME1+' A 
					   FULL OUTER JOIN '+@CTEMPTABLENAME1+' B ON A.MEMO_ID = B.MEMO_ID AND A.BIN_ID=B.BIN_ID AND A.XN_DT = B.XN_DT
					   WHERE  ISNULL(A.XN_AMOUNT,0) <> ISNULL(B.AMOUNT,0))
					BEGIN	  
						SET @BMISMATCH=1
						SET @CERRMSG = ''BILL AMOUNT NOT MATCHED''
					END	
					ELSE
					BEGIN
						SET @BMISMATCH=0
						SET @CERRMSG = ''SUCCESS''
					END	'

		EXEC SP_EXECUTESQL @DTSQL,N'@BMISMATCH BIT OUTPUT,@CERRMSG VARCHAR(100) OUTPUT',@BMISMATCH OUTPUT,@CERRMSG OUTPUT

		IF (@BMISMATCH = 1)
			GOTO END_PROC
								
		IF @BCOMPCUSTCODE=1
		BEGIN
			SET @CSTEP = 170
			SET @DTSQL = N'IF EXISTS (SELECT A.CUSTOMER_CODE FROM '+@CSOURCEDB+@CTEMPTABLENAME1+' A 
									  JOIN '+@CMASTERTABLNAME+' B ON A.MEMO_ID=B.CM_ID 
									  WHERE A.CUSTOMER_CODE<>B.CUSTOMER_CODE'+@CFILTEREXPR2+')
								SET @BMISMATCH=1
						   ELSE
								SET @BMISMATCH=0'										   	
			PRINT @DTSQL
			EXEC SP_EXECUTESQL @DTSQL,N'@BMISMATCH BIT OUTPUT',@BMISMATCH OUTPUT
			
			IF @BMISMATCH=1
			BEGIN
				SET @CERRMSG = 'CUSTOMER ID NOT MATCHING'
				GOTO END_PROC
			END	
		END		
	END

	IF @CXNTYPE IN ('PUR','IRR_CIP','IRR_PFI')
	BEGIN
		IF @CXNTYPE='PUR'
		BEGIN
			SET @CSTEP = 175
			IF  EXISTS (SELECT TOP 1 A.PRODUCT_CODE FROM PID01106 A LEFT OUTER JOIN SKU B 
						ON A.PRODUCT_CODE=B.PRODUCT_CODE WHERE MRR_ID = @CUPLOADEDXNID
						AND B.PRODUCT_CODE IS NULL AND ISNULL(A.PRODUCT_CODE,'')<>'')
				SET @BMISMATCH = 1
		END	

		IF @CXNTYPE IN ('IRR_CIP','IRR_PFI')
		BEGIN
			SET @CSTEP = 180
			IF  EXISTS (SELECT TOP 1 A.PRODUCT_CODE FROM IRD01106 A LEFT OUTER JOIN SKU B 
						ON A.NEW_PRODUCT_CODE=B.PRODUCT_CODE WHERE IRM_MEMO_ID = @CUPLOADEDXNID
						AND B.PRODUCT_CODE IS NULL AND ISNULL(A.NEW_PRODUCT_CODE,'')<>'')
				SET @BMISMATCH = 1
		END	
		
		IF @BMISMATCH = 1
		BEGIN		
			SET @CERRMSG = 'SKU DATA NOT FOUND'
			GOTO END_PROC
		END
		
	END
	
	
	
	
	IF (@CXNTYPE = 'SLS')
	BEGIN
			SET @CSTEP = 190
			SET @CERRMSG = ''
			SET @CSTEP = 200
			SET @DTSQL = N'IF OBJECT_ID('''+@CSOURCEDB+@CTEMPTABLENAME2+''', ''U'') IS NULL
							SET @CERRMSG = ''TEMP PAYMODE TABLE NOT FOUND'''
			PRINT @DTSQL
			EXEC SP_EXECUTESQL @DTSQL,N'@CERRMSG VARCHAR(MAX) OUTPUT',@CERRMSG OUTPUT		
	
			
			SET @CSTEP = 220
			IF ISNULL(@CERRMSG,'') <> ''
			BEGIN
				SET @BMISMATCH = 1
				GOTO END_PROC
			END
			
			SET @CSTEP = 240
			SET @DTSQL = N'IF EXISTS (SELECT * FROM 
							(SELECT  XN_TYPE,MEMO_ID,PAYMODE_CODE,ADJ_MEMO_ID,SUM(AMOUNT) AS AMOUNT FROM '+@CPAYMODETABLE+' B
							 WHERE MEMO_ID = '''+@CUPLOADEDXNID+''' AND XN_TYPE = ''SLS'''+@CFILTEREXPR2+' GROUP BY XN_TYPE,MEMO_ID,PAYMODE_CODE,ADJ_MEMO_ID ) A 
							 FULL OUTER JOIN '+@CSOURCEDB+@CTEMPTABLENAME2+' B 
								ON A.XN_TYPE = B.XN_TYPE AND A.MEMO_ID =B.MEMO_ID AND A.PAYMODE_CODE = B.PAYMODE_CODE
								AND ISNULL(A.ADJ_MEMO_ID,'''') = ISNULL(B.ADJ_MEMO_ID,'''')
								WHERE   ISNULL(A.AMOUNT,0) <> ISNULL(B.AMOUNT,0) OR ISNULL(A.ADJ_MEMO_ID,'''') <> ISNULL(B.ADJ_MEMO_ID,'''')
							)
								SET @BMISMATCH = 1
								ELSE 
								SET @BMISMATCH = 0'
			PRINT @DTSQL
			EXEC SP_EXECUTESQL 	@DTSQL,N'@BMISMATCH  BIT OUTPUT',@BMISMATCH OUTPUT	
			
			IF (@BMISMATCH = 1)
			BEGIN
				SET @CERRMSG = 'PAY MODE DETAIL NOT MATCHED'
				GOTO END_PROC
			END	
		
			SET @CERRMSG = ''
			SET @CSTEP = 260
			
			SET @CTEMPTAXRECOTABLE=@CSOURCEDB+@CTEMPTABLENAME3
			
			SET @CSTEP = 310
			
			
			IF OBJECT_ID(@CTEMPTAXRECOTABLE,'U') IS NOT NULL
			BEGIN
				SET @DTSQL = N'IF EXISTS (SELECT * FROM 
								( 
								 SELECT TAX_PERCENTAGE,TAX_METHOD,SUM(TAX_AMOUNT) AS TAX_AMOUNT FROM '+@CDETTABLE+' B
								 WHERE CM_ID = '''+@CUPLOADEDXNID+''''+@CFILTEREXPR2+'  
								 GROUP BY TAX_PERCENTAGE,TAX_METHOD) A 
								 FULL OUTER JOIN '+@CSOURCEDB+@CTEMPTABLENAME3+' B 
									ON A.TAX_PERCENTAGE = B.TAX_PERCENTAGE AND A.TAX_METHOD =B.TAX_METHOD 
									WHERE ISNULL(A.TAX_AMOUNT,0) <> ISNULL(B.TAX_AMOUNT,0)
								)
									SET @BMISMATCH = 1
									ELSE 
									SET @BMISMATCH = 0'
				PRINT @DTSQL
				EXEC SP_EXECUTESQL 	@DTSQL,N'@BMISMATCH  BIT OUTPUT',@BMISMATCH OUTPUT	
				
				IF (@BMISMATCH = 1)
				BEGIN
					SET @CERRMSG = 'TAX DETAIL NOT MATCHED'
					GOTO END_PROC
				END	
				ELSE 
				BEGIN
					SET @CERRMSG = 'SUCCESS'
					GOTO END_PROC
				END
			END
				
		END	
	

END TRY
BEGIN CATCH
	SET @CERRMSG='P: SP_MERGE_MIRROR_REC_DATA, STEP:'+@CSTEP+', MESSAGE:'+ERROR_MESSAGE()
END CATCH
	
END_PROC:
	IF ISNULL(@CERRMSG,'')=''
	BEGIN
		PRINT 'LAST STEP :'+@CSTEP
		SET @DTSQL = N'IF OBJECT_ID('''+@CSOURCEDB+@CTEMPTABLENAME1+''',''U'') IS NOT NULL
							DROP TABLE '+@CSOURCEDB+@CTEMPTABLENAME1+''
						
		PRINT @DTSQL
		EXEC SP_EXECUTESQL 	@DTSQL
		IF ISNULL(@CTEMPTABLENAME2,'') <> ''
		BEGIN		
			SET @DTSQL =N'IF OBJECT_ID('''+@CSOURCEDB+@CTEMPTABLENAME2+''',''U'') IS NOT NULL
							DROP TABLE '+@CSOURCEDB+@CTEMPTABLENAME2+''
			PRINT @DTSQL
			EXEC SP_EXECUTESQL 	@DTSQL
		END		
		
		IF ISNULL(@CTEMPTABLENAME3,'') <> ''
		BEGIN		
			SET @DTSQL =N'IF OBJECT_ID('''+@CSOURCEDB+@CTEMPTABLENAME3+''',''U'') IS NOT NULL
							DROP TABLE '+@CSOURCEDB+@CTEMPTABLENAME3+''
			PRINT @DTSQL
			EXEC SP_EXECUTESQL 	@DTSQL
		END		
		PRINT 'DROP TEMP TABLES'
	END						
END
