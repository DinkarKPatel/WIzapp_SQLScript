CREATE PROCEDURE SP_JOB_CARD_PRINT   
  
(@MEMO_ID VARCHAR(40))  
  
AS  
BEGIN  
SET NOCOUNT ON  

   DECLARE @DTSQL NVARCHAR(MAX),@CIMAGEDBNAME VARCHAR(1000)
   SET @CIMAGEDBNAME=DB_NAME ()+'_IMAGE.DBO.'
	

;with JWBARCODE as
(
   SELECT BIN.BIN_NAME,OPD.WOD_ROW_ID, opd.MEMO_ID , 
		sku_names.SECTION_NAME,sku_names.SUB_SECTION_NAME,sku_names.PARA1_NAME ,sku_names.PARA2_NAME ,sku_names.PARA3_NAME ,  
		sku_names.ARTICLE_NAME,sku_names.ARTICLE_NO,sku_names.uom UOM_NAME,OPD.HSN_CODE,  1 as quantit,opd.WHOLESALE_PRICE,opd.mrp,
		sku_names .para4_name ,sku_names .para5_name ,sku_names .para6_name ,opd.JOB_RATE_PER_UNIT,opd.BOM_RATE_PER_UNIT 
		,sku_names.barcode_img_id 
		,cast('' as varbinary(max)) AS PROD_IMAGE
   FROM ORD_PLAN_DET OPD
   JOIN ORD_PLAN_BARCODE_DET OBAR (NOLOCK) ON OBAR.REFROW_ID=OPD.ROW_ID  
   join sku_names (nolock) on sku_names.product_Code =obar.PRODUCT_CODE 
   JOIN BIN  (NOLOCK) ON BIN.BIN_ID=ISNULL(opd.BIN_ID,'000')  
   WHERE OPD.MEMO_ID=@MEMO_ID  

   
)

SELECT  OPM.MEMO_ID,OPM.MEMO_NO,OPM.MEMO_DT,LMV01106.AC_NAME,LOC.DEPT_NAME,OPD.BIN_NAME,OPM.ORD_PLAN_MODE,OPD.WOD_ROW_ID,  
OPD.SECTION_NAME,OPD.SUB_SECTION_NAME,OPD.PARA1_NAME COLOR,OPD.PARA2_NAME SIZE,OPD.PARA3_NAME STYLE,  
OPD.ARTICLE_NAME,OPD.ARTICLE_NO,OPD.UOM_NAME,OPM.CANCELLED,OPD.HSN_CODE,  
OPD.MRP,OPD.WHOLESALE_PRICE,sum(quantit) as QUANTITY,  
LMV01106.ADDRESS0 +''+ LMV01106.ADDRESS1+''+LMV01106.ADDRESS2  
+''+LMV01106.AREA_NAME+''+LMV01106.CITY+'-'+LMV01106.PINCODE AS LEDGER_ADD ,
opd .para4_name ,opd .para5_name ,opd .para6_name  ,opd.JOB_RATE_PER_UNIT,opd.BOM_RATE_PER_UNIT,OPM.REMARKS ,
OPD.PROD_IMAGE,barcode_img_id
Into #tmpOrderPlan
FROM ORD_PLAN_MST OPM (NOLOCK)  
JOIN JWBARCODE OPD (NOLOCK) ON OPM.MEMO_ID=OPD.MEMO_ID  
JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=OPM.DEPT_ID  
LEFT JOIN LMV01106 (NOLOCK) ON LMV01106.AC_CODE=OPM.AC_CODE  
WHERE OPM.MEMO_ID=@MEMO_ID  
GROUP BY OPM.MEMO_ID,OPM.MEMO_NO,OPM.MEMO_DT,LMV01106.AC_NAME,LOC.DEPT_NAME,OPD.BIN_NAME,OPM.ORD_PLAN_MODE,OPD.WOD_ROW_ID,  
OPD.SECTION_NAME,OPD.SUB_SECTION_NAME,OPD.PARA1_NAME ,OPD.PARA2_NAME ,OPD.PARA3_NAME ,  
OPD.ARTICLE_NAME,OPD.ARTICLE_NO,OPD.UOM_NAME,OPM.CANCELLED,OPD.HSN_CODE,  
OPD.MRP,OPD.WHOLESALE_PRICE, 
LMV01106.ADDRESS0 +''+ LMV01106.ADDRESS1+''+LMV01106.ADDRESS2  
+''+LMV01106.AREA_NAME+''+LMV01106.CITY+'-'+LMV01106.PINCODE ,
opd .para4_name ,opd .para5_name ,opd .para6_name  ,opd.JOB_RATE_PER_UNIT  ,opd.BOM_RATE_PER_UNIT ,
OPM.REMARKS  ,OPD.PROD_IMAGE,barcode_img_id

SET @DTSQL=' UPDATE A SET PROD_IMAGE=B.PROD_IMAGE
FROM #tmpOrderPlan a 
JOIN '+@CIMAGEDBNAME+'IMAGE_INFO B ON A.barcode_img_id=B.IMG_ID '
PRINT @DTSQL
EXEC SP_EXECUTESQL @DTSQL

select * from #tmpOrderPlan
  
SELECT   
---DISTINCT   
JOBS.JOB_NAME,OPM.MEMO_ID,OPM.MEMO_NO,OPM.MEMO_DT,BIN.BIN_NAME,OPM.ORD_PLAN_MODE,  
SECTIONM.SECTION_NAME,SECTIOND.SUB_SECTION_NAME,PARA1.PARA1_NAME COLOR,PARA2.PARA2_NAME SIZE,  
PARA3.PARA3_NAME STYLE,  
ARTICLE.ARTICLE_NAME,ARTICLE.ARTICLE_NO,UOM.UOM_NAME,OBM.TOL_PER ,  
OBM.AVG_QUANTITY,OBM.ADD_AVG_QUANTITY,BU.CONVERSION_UOM_NAME AS BOM_UOM,UC.CONVERSION_VALUE,SUM(OBM.QUANTITY/UC.CONVERSION_VALUE) as QUANTITY 

FROM ORD_PLAN_MST OPM (NOLOCK)  
JOIN ORD_PLAN_DET OPD (NOLOCK) ON OPM.MEMO_ID=OPD.MEMO_ID  
JOIN ORD_PLAN_BOM_DET OBM (NOLOCK) ON OBM.REF_ROW_ID=OPD.ROW_ID  
JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID=OPM.DEPT_ID  
LEFT JOIN LMV01106 (NOLOCK) ON LMV01106.AC_CODE=OPM.AC_CODE  
JOIN ARTICLE (NOLOCK) ON OBM.ARTICLE_CODE = ARTICLE.ARTICLE_CODE           
JOIN PARA1 (NOLOCK) ON OBM.PARA1_CODE = PARA1.PARA1_CODE          
JOIN PARA2 (NOLOCK) ON OBM.PARA2_CODE = PARA2.PARA2_CODE          
JOIN PARA3 (NOLOCK) ON OBM.PARA3_CODE = PARA3.PARA3_CODE          
JOIN PARA4 (NOLOCK) ON OBM.PARA4_CODE = PARA4.PARA4_CODE          
JOIN PARA5 (NOLOCK) ON OBM.PARA5_CODE = PARA5.PARA5_CODE          
JOIN PARA6 (NOLOCK) ON OBM.PARA6_CODE = PARA6.PARA6_CODE          
JOIN UOM   (NOLOCK) ON ARTICLE.UOM_CODE = UOM.UOM_CODE  
LEFT OUTER JOIN UOM_CONVERSION UC ON UC.UOM_CODE=UOM.UOM_CODE  
LEFT OUTER JOIN BOM_UOM BU ON BU.CONVERSION_UOM_CODE=UC.CONVERSION_UOM_CODE  
JOIN JOBS  ON JOBS.JOB_CODE=OBM.JOB_CODE   
JOIN SECTIOND (NOLOCK) ON ARTICLE.SUB_SECTION_CODE = SECTIOND.SUB_SECTION_CODE          
JOIN SECTIONM (NOLOCK) ON SECTIOND.SECTION_CODE = SECTIONM.SECTION_CODE       
JOIN BIN  (NOLOCK) ON BIN.BIN_ID=ISNULL(OBM.BIN_ID,'000')   
WHERE OPM.MEMO_ID=@MEMO_ID  
GROUP BY JOBS.JOB_NAME,OPM.MEMO_ID,OPM.MEMO_NO,OPM.MEMO_DT,BIN.BIN_NAME,OPM.ORD_PLAN_MODE,  
SECTIONM.SECTION_NAME,SECTIOND.SUB_SECTION_NAME,PARA1.PARA1_NAME ,PARA2.PARA2_NAME ,  
PARA3.PARA3_NAME ,ARTICLE.ARTICLE_NAME,ARTICLE.ARTICLE_NO,UOM.UOM_NAME,OBM.TOL_PER,  
OBM.AVG_QUANTITY,OBM.ADD_AVG_QUANTITY,BU.CONVERSION_UOM_NAME,UC.CONVERSION_VALUE   
  
SET NOCOUNT OFF  
END  
--new  
  