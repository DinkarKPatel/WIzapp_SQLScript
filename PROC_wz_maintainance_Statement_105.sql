

IF NOT EXISTS(SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_PRTAMOUNT' AND VALUE='1')
BEGIN
	PRINT 'UPDATING PRTAMOUNT IN PURCHASE FROM FINANCIAL DEBITNOTE'
	
	IF OBJECT_ID('TEMPDB..#FINANPRT','U') IS NOT NULL
		DROP TABLE #FINANPRT
	
	SELECT REFMEMOID AS MRR_ID,TOTAL_AMOUNT 
	 INTO #FINANPRT
	  FROM RMM01106 WHERE DN_TYPE=2 AND PRTSOURCE='PUR' AND ISNULL(REFMEMOID,'')<>''	
	
	DECLARE @NPRTAMOUNT NUMERIC(18,4),@CMRRID VARCHAR(30)
	
	WHILE EXISTS(SELECT TOP 1 'U' FROM #FINANPRT)
	BEGIN
		SELECT TOP 1 @CMRRID=MRR_ID,@NPRTAMOUNT=TOTAL_AMOUNT 
		FROM #FINANPRT
		
		UPDATE A
		 SET PRTAMOUNT=(@NPRTAMOUNT/B.SUBTOTAL)*A.PURCHASE_PRICE
		 FROM PID01106 A
		  JOIN PIM01106 B ON A.MRR_ID=B.MRR_ID
		   WHERE B.MRR_ID=@CMRRID
		
		DELETE #FINANPRT WHERE MRR_ID=@CMRRID
	END
	
	
	IF NOT EXISTS(SELECT CONFIG_OPTION FROM CONFIG WHERE CONFIG_OPTION='UPDATE_PRTAMOUNT')
	   INSERT CONFIG (CONFIG_OPTION,VALUE,ROW_ID,LAST_UPDATE)
	   VALUES ('UPDATE_PRTAMOUNT','1','',GETDATE())	
	ELSE	
		UPDATE CONFIG SET VALUE='1' WHERE CONFIG_OPTION='UPDATE_PRTAMOUNT'	
	
END	
