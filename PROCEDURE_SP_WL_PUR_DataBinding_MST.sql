CREATE PROCEDURE SP_WL_PUR_DATABINDING_MST
(  
	@CMRRID VARCHAR(100)
)
----WITH ENCRYPTION
AS  
BEGIN  
	DECLARE @CMEMONO VARCHAR(22),@RATE_REVISED BIT

	SELECT D.USERNAME AS 'CREATED_USERNAME', E.USERNAME AS 'MODIFIED_USERNAME',   
	 C.AC_NAME AS SUPP_NAME,C.ADDRESS0+' '+ C.ADDRESS1 + ' ' + C.ADDRESS2 + ', ' + C.AREA_NAME +   
	 ' ' + C.CITY + ' ' + C.STATE AS 'SUPP_ADDRESS',  A.*,ISNULL(A.INV_ID,'') AS WSL_INV_ID 
	 ,'' AS BILL_STATUS 
	 ,INV_MODE AS PURCHASE_TYPE,C.MRP_CALC_MODE  
	 ,'' AS REF_BILL_ID,ISNULL(EMP.EMP_NAME,'') AS EMP_NAME ,
	  (A.PARTY_INV_AMOUNT-  A.TOTAL_AMOUNT) AS DIFFERENCE_AMOUNT,C.ALIAS,
     '' AS  FORM_NAME, '' AS FORM_ID,BIN.BIN_NAME, C.MP_PERCENTAGE AS [MP_PERCENTAGE],
     ISNULL(T7.AC_NAME,'') AS BROKER_AC_NAME ,LOC.DEPT_NAME ,C.PURCHASE_AGAINST_TERMS,
     0 AS [GROSS_MARGIN],
     '' AS TERMS_REMARKS,RMM.REFMEMOID,RMM.RM_ID,RMM.RM_NO,
     ISNULL(a.pur_terms_name,A.TERMS) TERMS_NAME,a.pur_terms_name
     ,'' AS ADJMEMONO
     ,A.TAX_AMOUNT,LOC.ALLOW_PURCHASE_AT_HO,ST.GST_STATE_NAME AS PARTY_STATE_NAME,
     CAST ('' AS VARCHAR(50)) AS SP_ID,TD.TDS_NAME,
     ISNULL(A.FREIGHT_CGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0) +ISNULL(A.FREIGHT_IGST_AMOUNT,0) AS  FREIGHT_GST_AMT,
     ISNULL(A.FREIGHT,0)+CASE WHEN ISNULL(A.OH_TAX_METHOD,0)=1 THEN
     ISNULL(A.FREIGHT_CGST_AMOUNT,0)+ISNULL(A.FREIGHT_SGST_AMOUNT,0) +ISNULL(A.FREIGHT_IGST_AMOUNT,0) 
      ELSE 0 END AS FREIGHT_TOTAL,
     ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) +ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0) AS  OTHER_CHARGES_GST_AMT,
     ISNULL(A.OTHER_CHARGES,0)+CASE WHEN ISNULL(A.OH_TAX_METHOD,0)=1 THEN
     ISNULL(A.OTHER_CHARGES_CGST_AMOUNT,0)+ISNULL(A.OTHER_CHARGES_SGST_AMOUNT,0) +ISNULL(A.OTHER_CHARGES_IGST_AMOUNT,0)
     ELSE 0 END AS OTHER_CHARGES_TOTAL,LOC_PUR.DEPT_NAME AS PUR_DEPT_NAME,C.AC_GST_NO,OEM.AC_NAME AS OEM_AC_NAME
	 ,TD1.TDS_Name AS BROKER_TDS_NAME,SHIP.AC_NAME AS SHIPPING_FROM_AC_NAME,SHIP.ADDRESS0+' '+ SHIP.ADDRESS1 + ' ' + SHIP.ADDRESS2 + ', ' + SHIP.AREA_NAME +   
	 ' ' + SHIP.CITY + ' ' + SHIP.STATE AS 'SHIPPING_FROM_ADDRESS',SHIP.Ac_gst_no AS SHIPPING_GST_NO,
	 FC.FC_NAME AS XN_FC_NAME,ISNULL(C.mp_calc_based_on,1) AS mp_calc_based_on,(CASE WHEN supply.gst_state_code IS NULL THEN '' ELSE supply.gst_state_code+' - '+supply.gst_state_name END) as supply_state_name
	 ,CAST(0 AS BIT) GST_PERCENTAGE_ADDED
	FROM PIM01106 A  (NOLOCK)
	JOIN LMV01106 c (NOLOCK) ON A.AC_CODE = C.AC_CODE  
	LEFT OUTER JOIN LM01106  OEM ON A.OEM_AC_CODE= OEM.AC_CODE 
	JOIN USERS D (NOLOCK) ON A.USER_CODE = D.USER_CODE  
	JOIN USERS E (NOLOCK) ON A.EDT_USER_CODE = E.USER_CODE 
    JOIN BIN (NOLOCK) ON BIN.BIN_ID = A.BIN_ID
	LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK) ON A.EMP_CODE = EMP.EMP_CODE 
	LEFT OUTER JOIN LMV01106 T7 (NOLOCK) ON T7.AC_CODE = A.BROKER_AC_CODE    
	LEFT OUTER JOIN LOCATION LOC (NOLOCK) ON LOC.DEPT_ID = A.DEPT_ID
	LEFT OUTER JOIN LOCATION LOC_PUR (NOLOCK) ON LOC_PUR.DEPT_ID = A.PUR_FOR_DEPT_ID
    LEFT OUTER JOIN RMM01106 RMM (NOLOCK)ON RMM.REFMEMOID=A.MRR_ID AND RMM.PRTSOURCE='PUR' AND RMM.CANCELLED=0
    LEFT OUTER JOIN GST_STATE_MST ST(NOLOCK) ON A.PARTY_STATE_CODE=ST.GST_STATE_CODE
    LEFT OUTER JOIN TDS_SECTION TD(NOLOCK) ON A.TDS_CODE= TD.TDS_CODE
	LEFT OUTER JOIN TDS_SECTION TD1(NOLOCK) ON A.BROKER_TDS_CODE= TD1.TDS_CODE
	LEFT OUTER JOIN LMV01106 SHIP (NOLOCK) ON SHIP.AC_CODE = A.SHIPPING_FROM_AC_CODE
	LEFT OUTER JOIN fc  (NOLOCK) ON A.xn_fc_code = fc.fc_code
	LEFT OUTER JOIN gst_state_mst supply(NOLOCK) ON supply.gst_state_code=A.supply_state_code
	WHERE A.MRR_ID = @CMRRID  
END      
