CREATE PROCEDURE SP_PPC_TRANSACTIONHISTORY  
( 
 @CPRODUCTCODE VARCHAR(20)='',
 @FROMDATE DATETIME = '',    
 @TODATE DATETIME = '' 
)
----WITH ENCRYPTION
  
AS  
BEGIN  

 
  DECLARE @DTSQL NVARCHAR(MAX)
  DECLARE @OUTPUTC TABLE ( DEPT_ID VARCHAR(2), XN_TYPE VARCHAR(30), XN_DT DATETIME,         
        XN_ID VARCHAR(40), XN_NO VARCHAR(40), PRODUCT_CODE VARCHAR(50),ARTICLE_NO VARCHAR(500),       
        XN_PARTY_NAME VARCHAR(500), XN_QTY NUMERIC(10,3),JOB_NAME VARCHAR(100))        

 --1.FG BARCODE GENERATION -INQTY,XN_TYPE='BGN'  
 SET @DTSQL=N' SELECT LEFT(A.MEMO_ID,2) AS DEPT_ID,
      ''PPC_BGN'' AS XN_TYPE,A.MEMO_DT AS XN_DT,A.MEMO_ID AS XN_ID,
      A.MEMO_NO AS XN_NO,C.PRODUCT_CODE,ART.ARTICLE_NO, LM.AC_NAME,1 AS QUANTITY,
      '''' AS JOB_NAME
      FROM PPC_FGBCG_MST A
      JOIN PPC_FGBCG_DET  B ON A.MEMO_ID =B.MEMO_ID 
      JOIN PPC_FG_SKU C ON B.ROW_ID=C.PPC_FGBCG_DET_ROW_ID
      JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE
      JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
      WHERE A.CANCELLED=0  AND '''+@CPRODUCTCODE +'''=' + 'C.PRODUCT_CODE'
 PRINT @DTSQL
 INSERT @OUTPUTC
 EXEC SP_EXECUTESQL @DTSQL
 
 --2.FIRST ISSUE --OUT QTY ,AFI
 SET @DTSQL=N' SELECT LEFT(A.MEMO_ID,2) AS DEPT_ID,
      ''PPC_AFI'' AS XN_TYPE,A.MEMO_DT AS XN_DT,A.MEMO_ID AS XN_ID,
      A.MEMO_NO AS XN_NO,C.PRODUCT_CODE,ART.ARTICLE_NO, LM.AC_NAME,B.QUANTITY,JOBS.JOB_NAME
      FROM PPC_AGENCY_ISSUE_FG_FIRST_MST A
      JOIN PPC_AGENCY_ISSUE_FG_FIRST_DET  B ON A.MEMO_ID =B.MEMO_ID 
      JOIN PPC_FG_SKU C ON B.PRODUCT_CODE=C.PRODUCT_CODE
      JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE
      JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
      JOIN JOBS ON A.JOB_CODE=JOBS.JOB_CODE
      WHERE A.CANCELLED=0  AND '''+@CPRODUCTCODE +'''=' + 'C.PRODUCT_CODE'
 PRINT @DTSQL
 INSERT @OUTPUTC
 EXEC SP_EXECUTESQL @DTSQL
 
 --3.SECOND ISSUE -OUTQTY ,ASI
 
 SET @DTSQL=N' SELECT LEFT(A.MEMO_ID,2) AS DEPT_ID,
      ''PPC_ASI'' AS XN_TYPE,A.MEMO_DT AS XN_DT,A.MEMO_ID AS XN_ID,
      A.MEMO_NO AS XN_NO,C.PRODUCT_CODE,ART.ARTICLE_NO, LM.AC_NAME,B.QUANTITY,JOBS.JOB_NAME
      FROM PPC_AGENCY_ISSUE_FG_MST A
      JOIN PPC_AGENCY_ISSUE_FG_DET  B ON A.MEMO_ID =B.MEMO_ID 
      JOIN PPC_FG_SKU C ON B.PRODUCT_CODE=C.PRODUCT_CODE
      JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE
      JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
      JOIN JOBS ON A.JOB_CODE=JOBS.JOB_CODE
      WHERE A.CANCELLED=0  AND '''+@CPRODUCTCODE +'''=' + 'C.PRODUCT_CODE'
 PRINT @DTSQL
 INSERT @OUTPUTC
 EXEC SP_EXECUTESQL @DTSQL
 
 --4.RECEIVING -IN QTY ,REC

 SET @DTSQL=N' SELECT LEFT(A.MEMO_ID,2) AS DEPT_ID,
      ''PPC_REC'' AS XN_TYPE,A.MEMO_DT AS XN_DT,A.MEMO_ID AS XN_ID,
      A.MEMO_NO AS XN_NO,C.PRODUCT_CODE,ART.ARTICLE_NO, LM.AC_NAME,B.QUANTITY,JOBS.JOB_NAME
      FROM PPC_AGENCY_REC_FG_MST A
      JOIN PPC_AGENCY_REC_FG_DET  B ON A.MEMO_ID =B.MEMO_ID 
      JOIN PPC_FG_SKU C ON B.PRODUCT_CODE=C.PRODUCT_CODE
      JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE
      JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
      JOIN JOBS ON A.JOB_CODE=JOBS.JOB_CODE
      WHERE A.CANCELLED=0  AND '''+@CPRODUCTCODE +'''=' + 'C.PRODUCT_CODE'
 PRINT @DTSQL
 INSERT @OUTPUTC
 EXEC SP_EXECUTESQL @DTSQL
 
 --5.WSL -OUT QTY WSL


 SET @DTSQL=N' SELECT LEFT(A.INV_ID,2) AS DEPT_ID,
      ''PPC_WSL'' AS XN_TYPE,A.INV_DT AS XN_DT,A.INV_ID AS XN_ID,
      A.INV_NO AS XN_NO,C.PRODUCT_CODE,ART.ARTICLE_NO, LM.AC_NAME,B.QUANTITY,'''' AS JOB_NAME
      FROM PPC_INM01106 A
      JOIN PPC_IND01106  B ON A.INV_ID =B.INV_ID 
      JOIN PPC_FG_SKU C ON B.PRODUCT_CODE=C.PRODUCT_CODE
      JOIN ARTICLE ART ON ART.ARTICLE_CODE=C.ARTICLE_CODE
      JOIN LM01106 LM ON LM.AC_CODE=A.AC_CODE
      WHERE A.CANCELLED=0  AND '''+@CPRODUCTCODE +'''=' + 'C.PRODUCT_CODE'
 PRINT @DTSQL
 INSERT @OUTPUTC
 EXEC SP_EXECUTESQL @DTSQL
 --SELECT * FROM PPC_AGENCY_REC_FG_DET 
 
    
    

    
				INSERT @OUTPUTC    
				SELECT  A.DEPT_ID,'PPC_OPS' AS XN_TYPE,     
				  @FROMDATE AS XN_DT,'PPC_OPS' AS XN_ID,           
				  'PPC_OPS' AS XN_NO,A.PRODUCT_CODE,ARTICLE.ARTICLE_NO,       
				  '' AS XN_PARTY_NAME,    
				  SUM( (CASE WHEN A.XN_TYPE='PPC_OPS' OR (A.XN_TYPE IN ('PPC_OPS','PPC_BGN', 'PPC_REC')     
				  AND (XN_DT  < @FROMDATE) AND ARTICLE.STOCK_NA=0 ) THEN 1     
				  WHEN A.XN_TYPE IN ('PPC_AFI','PPC_ASI','PPC_WSL')     
				  AND (CONVERT(VARCHAR(10),XN_DT,126) < @FROMDATE) AND ARTICLE.STOCK_NA=0 THEN -1 ELSE 0 END) * (XN_QTY)) AS XN_QTY,    
				  '' AS JOB_NAME           
				FROM @OUTPUTC A 
				JOIN PPC_FG_SKU SKU (NOLOCK) ON SKU.PRODUCT_CODE=A.PRODUCT_CODE     
				JOIN ARTICLE (NOLOCK) ON ARTICLE.ARTICLE_CODE=SKU.ARTICLE_CODE     
				JOIN PARA3 (NOLOCK) ON SKU.PARA3_CODE=PARA3.PARA3_CODE   
				WHERE A.PRODUCT_CODE=@CPRODUCTCODE  AND XN_DT<@FROMDATE  
				GROUP BY A.DEPT_ID,A.PRODUCT_CODE,ARTICLE.ARTICLE_NO
				--HAVING SUM( (CASE WHEN A.XN_TYPE='PPC_OPS' OR (A.XN_TYPE IN ('PPC_OPS','PPC_BGN', 'PPC_REC')     
				--AND (CONVERT(VARCHAR(10),XN_DT,126)  < @FROMDATE) AND ARTICLE.STOCK_NA=0 ) THEN 1     
				--WHEN A.XN_TYPE IN ('PPC_AFI','PPC_ASI','PPC_WSL')     
				--AND (CONVERT(VARCHAR(10),XN_DT,126) < @FROMDATE) AND ARTICLE.STOCK_NA=0 THEN -1 ELSE 0 END) * (XN_QTY)) >0 

              SELECT  A.DEPT_ID,LOC.DEPT_NAME, A.PRODUCT_CODE,         
			  A.XN_PARTY_NAME ,
			  ISNULL(CAST(SUM(CASE WHEN  XN_TYPE IN ('PPC_OPS','PPC_BGN', 'PPC_REC')     
			  THEN XN_QTY ELSE NULL END) AS NUMERIC(18,3)),0) AS XN_IN_QTY, 
			  
			  ISNULL(CAST(SUM(CASE WHEN  XN_TYPE IN('PPC_AFI','PPC_ASI','PPC_WSL')
			  THEN XN_QTY ELSE NULL END) AS NUMERIC(18,3)),0) AS XN_OUT_QTY,   
			  SUM(A.XN_QTY) AS XN_QTY,
			  A.XN_TYPE, A.XN_NO, A.XN_DT,
			  ART .ARTICLE_NO,SD.SUB_SECTION_NAME ,SM.SECTION_NAME ,
			  P1.PARA1_NAME,P2.PARA2_NAME    ,
			  BCG.BILL_NO  AS  ORDER_NO     
			
			 FROM @OUTPUTC A    
			 JOIN LOCATION LOC ON LOC.DEPT_ID =A.DEPT_ID   
			 JOIN PPC_FG_SKU SKU ON SKU.PRODUCT_CODE=A.PRODUCT_CODE 
			 JOIN 
			 ( 
			   SELECT DISTINCT  A.ROW_ID ,D.BILL_NO 
			   FROM  PPC_FGBCG_DET  A
			   JOIN PPC_FGBCG_MST B ON A.MEMO_ID =B.MEMO_ID 
			   JOIN PPC_BUYER_ORDER_DET C ON C.ROW_ID =A.BO_DET_ROW_ID
			   JOIN PPC_BUYER_ORDER_MST D ON C.ORDER_ID =D.ORDER_ID 
			   WHERE B.CANCELLED =0 AND D.CANCELLED =0
			 
			 ) BCG ON BCG.ROW_ID =SKU.PPC_FGBCG_DET_ROW_ID 
			 JOIN ARTICLE ART ON ART.article_code =SKU .ARTICLE_CODE 
			 JOIN Sectiond SD ON SD.sub_section_code =ART.sub_section_code 
			 JOIN sectionM SM ON SM.section_code =SD.section_code    
			 join para1 p1 on p1.para1_code =sku.PARA1_CODE 
			 join para2 p2 on p2.para2_code =sku.PARA2_CODE    
			 WHERE (CONVERT(VARCHAR(10),XN_DT,126)  BETWEEN @FROMDATE AND @TODATE )   
			 GROUP BY  A.PRODUCT_CODE,    LOC.DEPT_NAME, A.XN_PARTY_NAME ,A.XN_TYPE,A.XN_NO,A.XN_DT,        
			 A.DEPT_ID,A.XN_PARTY_NAME,ART .ARTICLE_NO,SD.SUB_SECTION_NAME ,SM.SECTION_NAME ,
			  P1.PARA1_NAME,P2.PARA2_NAME ,BCG.BILL_NO
             
 
END
