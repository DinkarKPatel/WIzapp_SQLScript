CREATE PROCEDURE SP3S_MERGE_MIRROR_KEYS_DATA
 (
  @CDEPTID VARCHAR(5)
 )
-- WITH ENCRYPTION
 AS
 BEGIN
     
    BEGIN TRY
    BEGIN TRANSACTION
    DECLARE @TABLENAME VARCHAR(100),@TMPTABLENAME VARCHAR(100),@DTSQL NVARCHAR(MAX),@DFM_DT VARCHAR(20)
	DECLARE @CTEMPDBNAME VARCHAR(40),@CSTEP INT,@CERRMSG VARCHAR(MAX),
	@TABLENAME_PAYMODE VARCHAR(100),@TMPTABLENAME_PAYMODE VARCHAR(100)
	
	SET @CTEMPDBNAME = DB_NAME() + '_TEMP.DBO.'	    
	
	SET @TABLENAME='KEYS_MIRROR_LOG'
	SET @TMPTABLENAME=@CTEMPDBNAME+'TMP_KEYS_'+@TABLENAME+'_'+@CDEPTID
	SET @CSTEP=100
	
	SET @DTSQL =N'IF OBJECT_ID('''+@TMPTABLENAME+''',''U'') IS NOT NULL
	BEGIN
	 DELETE A FROM   KEYS_MIRROR_LOG A WHERE A.DEPT_ID='''+@CDEPTID+'''
	END'
	
	PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	

	
	SET @DTSQL =N'SELECT DEPT_ID,KEYS_TABLENAME,COLUMNNAME,PREFIX,FINYEAR,TABLENAME,LASTKEYVAL FROM '+@TMPTABLENAME
	PRINT @DTSQL
	INSERT INTO KEYS_MIRROR_LOG(DEPT_ID,KEYS_TABLENAME,COLUMNNAME,PREFIX,FINYEAR,TABLENAME,LASTKEYVAL)
	EXEC SP_EXECUTESQL @DTSQL
	
	
	SET @DTSQL =N'IF OBJECT_ID('''+@TMPTABLENAME+''',''U'') IS NOT NULL
	    DROP TABLE '+@TMPTABLENAME+''
    PRINT @DTSQL
	EXEC SP_EXECUTESQL @DTSQL
	
  END TRY        
 BEGIN CATCH
  PRINT 'CATCH START'       
  SET @CERRMSG='P:SP3S_MERGE_MIRROR_KEYS_DATA, STEP:'+LTRIM(RTRIM(STR(@CSTEP)))+', MESSAGE:'+ERROR_MESSAGE()        
  GOTO EXIT_PROC
 END CATCH        
        
EXIT_PROC:   
 
 IF ISNULL(@CERRMSG,'')='' AND @@TRANCOUNT>0
 BEGIN        		
	 COMMIT TRANSACTION
 END		
 ELSE
		ROLLBACK        
 END
 IF ISNULL(@CERRMSG,'')=''
 SET @CERRMSG=''
 
 SELECT @CERRMSG AS ERRMSG
