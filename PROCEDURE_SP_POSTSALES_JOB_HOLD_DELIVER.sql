create PROCEDURE SP_POSTSALES_JOB_HOLD_DELIVER      
(      
  @IMODE INT ,      
  @CWHERE VARCHAR(4000)='',      
  @CFINYEAR VARCHAR(10)=''      
)      
----WITH ENCRYPTION
AS      
      
BEGIN      
 
 IF @IMODE =1      
 GOTO LBLCMM01106      
       
 ELSE IF @IMODE =2      
 GOTO LBLCMD01106      
       
 ELSE IF @IMODE =3      
 GOTO LBLMST      
       
 ELSE IF @IMODE =4      
 GOTO LBLDET      
       
 ELSE IF @IMODE =5      
 GOTO LBLJOBLIST      
       
 ELSE IF @IMODE =6      
 GOTO LBLHBDMST      
       
       
 ELSE IF @IMODE =7      
 GOTO LBLCANCELCHECK 
 
 ELSE IF @IMODE =8
 GOTO LBLHOLDBACK    

 ELSE IF @IMODE =9
 GOTO LBLBILLMST          
 ELSE IF @IMODE =10
 GOTO ADVREC     
 ELSE IF @IMODE =11
 GOTO CNREC     
 ELSE      
 GOTO LAST       
 
ADVREC:
CNREC:
    SELECT 'Advance' AS XN_TYPE,A.MEMO_ID,B.ADV_REC_ID,SUM(C.AMOUNT) AS AMOUNT,A.MEMO_NO,C.ADV_REC_NO,C.ADV_REC_DT 
	FROM HOLD_BACK_DELIVER_MST A (NOLOCK) 
    JOIN HBD_RECEIPT B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID 
    JOIN ARC01106 C (NOLOCK) ON B.ADV_REC_ID = C.ADV_REC_ID  
	WHERE A.MEMO_ID = @CWHERE AND C.cancelled=0
	GROUP BY A.MEMO_ID,B.ADV_REC_ID,A.MEMO_NO,C.ADV_REC_NO,C.ADV_REC_DT
	UNION ALL
	SELECT 'Credit Note' AS XN_TYPE, A.MEMO_ID,B.CM_ID,SUM(C.NET_AMOUNT) AS AMOUNT,A.MEMO_NO,C.CM_NO,C.CM_DT 
	FROM HOLD_BACK_DELIVER_MST A (NOLOCK) 
    JOIN HBD_RECEIPT B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID 
    JOIN CMM01106 C (NOLOCK) ON B.CM_ID = C.CM_ID  
	WHERE A.MEMO_ID = @CWHERE AND C.cancelled=0
	GROUP BY A.MEMO_ID,B.CM_ID,A.MEMO_NO,C.CM_NO,C.CM_DT
    GOTO LAST
       
LBLCMM01106:      

 SELECT  A.CM_ID,A.CM_NO,A.CM_MODE,A.NET_AMOUNT,A.CUSTOMER_CODE,      
 (B.CUSTOMER_FNAME  + ' ' + B.CUSTOMER_LNAME) AS CUSTOMER_NAME, B.USER_CUSTOMER_CODE,       
 (B.CUSTOMER_FNAME  + ' ' + B.CUSTOMER_LNAME)+ CHAR(13) + (B.ADDRESS1 + ' ' + B.ADDRESS2 + ' ' + C.AREA_NAME + ' ' + C.PINCODE + ' ' + D.CITY + ' ' + E.STATE) AS  CUSTOMER_ADDRESS      
 FROM CMM01106 A  (NOLOCK)         
 LEFT OUTER JOIN CUSTDYM B (NOLOCK)  ON A.CUSTOMER_CODE = B.CUSTOMER_CODE       
 LEFT OUTER JOIN AREA C (NOLOCK) ON C.AREA_CODE = B.AREA_CODE       
 LEFT OUTER JOIN CITY D (NOLOCK) ON D.CITY_CODE = C.CITY_CODE       
 LEFT OUTER JOIN STATE E (NOLOCK) ON E.STATE_CODE = D.STATE_CODE       
 WHERE A.CM_NO = @CWHERE AND A.FIN_YEAR = @CFINYEAR       
 AND A.CANCELLED = 0      
      
 GOTO LAST       
       
       
LBLCMD01106:      
       
 SELECT CAST(ISNULL(B.HOLD_FOR_ALTER,0) AS BIT) AS CHKDELIVER, A.CM_NO,B.PRODUCT_CODE,B.QUANTITY,B.MRP,B.ROW_ID,      
 ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
 PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
 CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,SKU.PURCHASE_PRICE,      
 SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
 P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
 PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
 ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
 ART.STOCK_NA   
 ,B.EMP_CODE,EMP.EMP_NAME ,B.DISCOUNT_AMOUNT,B.NET ,
 ART.ALIAS AS ARTICLE_ALIAS  ,EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2,B.PRODUCT_CODE AS OLD_PRODUCT_CODE
 FROM CMM01106 A (NOLOCK)       
 JOIN CMD01106  B (NOLOCK) ON A.CM_ID = B.CM_ID       
 JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE      
 JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE          
 JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
 JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE        
 JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE          
 JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE          
 JOIN PARA3 P3 (NOLOCK)ON SKU.PARA3_CODE = P3.PARA3_CODE          
 JOIN PARA4 P4 (NOLOCK)ON SKU.PARA4_CODE = P4.PARA4_CODE          
 JOIN PARA5 P5 (NOLOCK)ON SKU.PARA5_CODE = P5.PARA5_CODE          
 JOIN PARA6 P6 (NOLOCK)ON SKU.PARA6_CODE = P6.PARA6_CODE          
 JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE   
 LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK)ON B.EMP_CODE = EMP.EMP_CODE 
LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON B.EMP_CODE1 = EMP1.EMP_CODE     
LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON B.EMP_CODE2 = EMP2.EMP_CODE    
      
 WHERE A.CM_NO = @CWHERE  AND A.FIN_YEAR = @CFINYEAR AND B.QUANTITY >0 AND A.CANCELLED = 0      
      
 GOTO LAST      
       
LBLMST:  

DECLARE @NADV_AMOUNT NUMERIC(10,2),@NCN_AMOUNT NUMERIC(10,2)
SELECT @NADV_AMOUNT=SUM(A.amount) FROM ARC01106 A
JOIN HBD_RECEIPT B ON A.adv_rec_id=B.ADV_REC_ID 
WHERE B.MEMO_ID=@CWHERE AND A.CANCELLED=0
SELECT @NCN_AMOUNT=ABS(SUM(A.NET_AMOUNT)) FROM CMM01106 A
JOIN HBD_RECEIPT B ON A.cm_id=B.CM_ID 
WHERE B.MEMO_ID=@CWHERE AND A.CANCELLED=0

 SELECT A.*,        
 (C.CUSTOMER_FNAME  + ' ' + C.CUSTOMER_LNAME) AS CUSTOMER_NAME,  C.USER_CUSTOMER_CODE, L.DEPT_NAME AS DELIVERY_DEPT_NAME,      
  (C.CUSTOMER_FNAME  + ' ' + C.CUSTOMER_LNAME)+CHAR(13)+(C.ADDRESS1 + ' ' + C.ADDRESS2 + ' ' + D.AREA_NAME + ' ' + D.PINCODE + ' ' + E.CITY + ' ' + F.STATE) AS CUSTOMER_ADDRESS ,
 ISNULL(@NADV_AMOUNT,0) AS ADV_AMOUNT,ISNULL(EMP.EMP_NAME,'') AS HBD_EMP_NAME,ISNULL(@NCN_AMOUNT,0) AS CN_AMOUNT
 FROM HOLD_BACK_DELIVER_MST A (NOLOCK)         
 LEFT JOIN CUSTDYM C (NOLOCK) ON A.CUSTOMER_CODE = C.CUSTOMER_CODE        
 LEFT JOIN AREA D (NOLOCK) ON D.AREA_CODE = C.AREA_CODE         
 LEFT JOIN CITY E (NOLOCK) ON E.CITY_CODE = D.CITY_CODE         
 LEFT JOIN STATE F (NOLOCK) ON F.STATE_CODE = E.STATE_CODE  
 LEFT OUTER JOIN LOCATION L (NOLOCK)ON L.DEPT_ID=A.DELIVERY_DEPT_ID 
 LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK)ON EMP.EMP_CODE=A.hbd_EMP_CODE 
 WHERE A.MEMO_ID = @CWHERE        
       
 GOTO LAST      
      
LBLDET:      
	 DECLARE @NMODE INT	     ,@cRefCMDRowId Varchar(100) 
	 SELECT @NMODE=MODE,@cRefCMDRowId='' FROM HOLD_BACK_DELIVER_MST (NOLOCK) WHERE MEMO_ID=@CWHERE	
	 
	 IF ISNULL(@NMODE,0)<>2
		 SELECT (CASE WHEN B.DELIVERED=0 THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END)  AS  CHKDELIVER,     
		 G.CM_NO,G.CM_ID,C.PRODUCT_CODE AS SALE_PRODUCT_CODE,B.*,(CAST(1 AS NUMERIC(10,2))) AS QUANTITY,C.MRP,      
		 ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
		 PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
	 	 CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,SKU.PURCHASE_PRICE,      
		 SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
		 P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
		 PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
		 ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
		 ART.STOCK_NA,F.JOB_NAME ,F.JOB_CODE,  
		 C.EMP_CODE,EMP.EMP_NAME,C.DISCOUNT_AMOUNT,C.NET,
		 ART.ALIAS AS ARTICLE_ALIAS ,EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2 ,A.BIN_ID ,C.PRODUCT_CODE AS OLD_PRODUCT_CODE
		 ,X.HBD_STATUS_NAME,G.CM_DT,C.cmm_discount_amount
		 FROM HOLD_BACK_DELIVER_MST A (NOLOCK)       
		 JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID       
		 JOIN CMD01106 C (NOLOCK) ON C.ROW_ID = B.REF_CMD_ROW_ID       
		 JOIN CMM01106 G (NOLOCK) ON C.CM_ID = G.CM_ID       
		 JOIN SKU (NOLOCK) ON SKU.PRODUCT_CODE=C.PRODUCT_CODE      
		 JOIN ARTICLE ART (NOLOCK) ON SKU.ARTICLE_CODE = ART.ARTICLE_CODE          
		 JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
		 JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE        
		 JOIN PARA1 P1 (NOLOCK) ON SKU.PARA1_CODE = P1.PARA1_CODE          
		 JOIN PARA2 P2 (NOLOCK) ON SKU.PARA2_CODE = P2.PARA2_CODE          
		 JOIN PARA3 P3 (NOLOCK)ON SKU.PARA3_CODE = P3.PARA3_CODE          
		 JOIN PARA4 P4 (NOLOCK)ON SKU.PARA4_CODE = P4.PARA4_CODE          
		 JOIN PARA5 P5 (NOLOCK)ON SKU.PARA5_CODE = P5.PARA5_CODE          
		 JOIN PARA6 P6 (NOLOCK)ON SKU.PARA6_CODE = P6.PARA6_CODE          
		 JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE       
		 LEFT OUTER JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE  
		 LEFT OUTER JOIN EMPLOYEE EMP (NOLOCK)ON C.EMP_CODE = EMP.EMP_CODE 
		 LEFT OUTER JOIN EMPLOYEE EMP1  (NOLOCK) ON C.EMP_CODE1 = EMP1.EMP_CODE     
		 LEFT OUTER JOIN EMPLOYEE EMP2  (NOLOCK) ON C.EMP_CODE2 = EMP2.EMP_CODE   
		 LEFT OUTER JOIN 
		 (
			SELECT CAST(0 AS INT) AS HBD_STATUS,'' AS HBD_STATUS_NAME		
			UNION ALL
			SELECT CAST(1 AS INT) AS HBD_STATUS,'Approve & Issue Credit Note' AS HBD_STATUS_NAME 
			UNION ALL
			SELECT CAST(2 AS INT) AS HBD_STATUS,'Free Repair & Return' AS HBD_STATUS_NAME 
			UNION ALL
			SELECT CAST(3 AS INT) AS HBD_STATUS,'Charged Repair & Return' AS HBD_STATUS_NAME 
			UNION ALL
			SELECT CAST(4 AS INT) AS HBD_STATUS,'Disapprove & Return' AS HBD_STATUS_NAME 
		 )x ON X.HBD_STATUS=b.HBD_STATUS
		 WHERE B.MEMO_ID = @CWHERE  AND ISNULL( B.ref_cmd_row_id,'')<>'' 
		 UNION ALL
		 /*
		 SELECT (CASE WHEN B.DELIVERED=0 THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END)  AS  CHKDELIVER,     
		 G.CM_NO,G.CM_ID,C.PRODUCT_CODE AS SALE_PRODUCT_CODE,B.*,(CAST(1 AS NUMERIC(10,2))) AS QUANTITY,C.MRP,      
		 ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, P1.PARA1_CODE,        
		 PARA1_NAME, P2.PARA2_CODE,PARA2_NAME,P3.PARA3_CODE,PARA3_NAME,UOM_NAME,           
	 	 CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,SKU.PURCHASE_PRICE,      
		 SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
		 P4.PARA4_CODE,P5.PARA5_CODE,P6.PARA6_CODE,        
		 PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
		 ART.DT_CREATED AS [ART_DT_CREATED],P3.DT_CREATED AS [PARA3_DT_CREATED],SKU.DT_CREATED AS [SKU_DT_CREATED],        
		 ART.STOCK_NA,F.JOB_NAME ,F.JOB_CODE,  
		 C.EMP_CODE,EMP.EMP_NAME,C.DISCOUNT_AMOUNT,C.NET,
		 ART.ALIAS AS ARTICLE_ALIAS ,EMP1.EMP_NAME AS EMP_NAME1 ,EMP2.EMP_NAME AS EMP_NAME2 ,A.BIN_ID ,C.PRODUCT_CODE AS OLD_PRODUCT_CODE
		 ,X.HBD_STATUS_NAME,G.CM_DT,C.cmm_discount_amount
		 */
		 SELECT (CASE WHEN B.DELIVERED=0 THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END)  AS  CHKDELIVER,     
		 ISNULL(B.SOLD_BILL_NO,'') AS CM_NO,'' AS CM_ID,ISNULL(B.SOLD_PRODUCT_CODE,'') AS SALE_PRODUCT_CODE,B.*,(CAST(1 AS NUMERIC(10,2))) AS QUANTITY,0 AS MRP,      
		 ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME, SKU.PARA1_CODE,        
		 PARA1_NAME, SKU.PARA2_CODE,PARA2_NAME,SKU.PARA3_CODE,PARA3_NAME,UOM_NAME,           
	 	 CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,SKU.PURCHASE_PRICE,      
		 SKU.MRP,SKU.WS_PRICE,   SM.SECTION_NAME, SD.SUB_SECTION_NAME,        
		 SKU.PARA4_CODE,SKU.PARA5_CODE,SKU.PARA6_CODE,        
		 PARA4_NAME,PARA5_NAME,PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
		 ART.DT_CREATED AS [ART_DT_CREATED],'' AS [PARA3_DT_CREATED],'' AS  [SKU_DT_CREATED],         
		 ART.STOCK_NA,F.JOB_NAME ,F.JOB_CODE,  
		 '' AS EMP_CODE,'' AS EMP_NAME,0 AS DISCOUNT_AMOUNT,ISNULL(B.SOLD_NET_AMOUNT,0) AS NET,
		 ART.ALIAS AS ARTICLE_ALIAS ,'' AS EMP_NAME1 ,'' AS EMP_NAME2 ,A.BIN_ID ,ISNULL(B.SOLD_PRODUCT_CODE,'') AS OLD_PRODUCT_CODE
		 ,X.HBD_STATUS_NAME,CAST(ISNULL(B.SOLD_BILL_DT,'') AS DATETIME) AS CM_DT,CAST(0 AS NUMERIC(14,2)) AS CMM_DISCOUNT_AMOUNT
		 FROM HOLD_BACK_DELIVER_MST A (NOLOCK)       
		 JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID       
		 left JOIN sku SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE 
		 LEFT JOIN sku_names (NOLOCK) ON sku_names.product_Code=SKU.product_code
		 left JOIN ARTICLE ART (NOLOCK) ON art.ARTICLE_CODE = b.ARTICLE_CODE          
		 left JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
		 left JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE        
		 left JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE       
		 LEFT OUTER JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE
		 LEFT OUTER JOIN 
		 (
			SELECT CAST(0 AS INT) AS HBD_STATUS,'' AS HBD_STATUS_NAME		
			UNION ALL
			SELECT CAST(1 AS INT) AS HBD_STATUS,'Approve & Issue Credit Note' AS HBD_STATUS_NAME 
			UNION ALL
			SELECT CAST(2 AS INT) AS HBD_STATUS,'Free Repair & Return' AS HBD_STATUS_NAME 
			UNION ALL
			SELECT CAST(3 AS INT) AS HBD_STATUS,'Charged Repair & Return' AS HBD_STATUS_NAME 
			UNION ALL
			SELECT CAST(4 AS INT) AS HBD_STATUS,'Disapprove & Return' AS HBD_STATUS_NAME 
		 )x ON X.HBD_STATUS=b.HBD_STATUS
		 WHERE B.MEMO_ID = @CWHERE AND ISNULL( B.ref_cmd_row_id,'')='' AND ISNULL( B.SOLD_BILL_NO,'')='' 
		 order by product_code   
		 
	 ELSE	 

		 SELECT (CASE WHEN B.DELIVERED=0 THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END)  AS  CHKDELIVER,     
		 '' AS CM_NO,'' AS CM_ID,B.*,(CAST(1 AS NUMERIC(10,2))) AS QUANTITY,0 AS MRP,      
		 ART.ARTICLE_CODE, ART.ARTICLE_NO, ART.ARTICLE_NAME,B.PARA1_CODE,        
		 SKU_NAMES.PARA1_NAME,B.PARA2_CODE,SKU_NAMES.PARA2_NAME,B.PARA3_CODE,SKU_NAMES.PARA3_NAME,UOM_NAME,           
		 CODING_SCHEME,CONVERT(NUMERIC(10,2),0) AS QUANTITY_IN_STOCK,0 AS PURCHASE_PRICE,      
		 0 AS MRP,0 AS WS_PRICE,SM.SECTION_NAME, SD.SUB_SECTION_NAME,B.PARA4_CODE,B.PARA5_CODE,
		 B.PARA6_CODE,SKU_NAMES.PARA4_NAME,SKU_NAMES.PARA5_NAME,SKU_NAMES.PARA6_NAME,E.UOM_CODE,ISNULL(E.UOM_TYPE,0) AS [UOM_TYPE],        
		 ART.DT_CREATED AS [ART_DT_CREATED],'' AS [PARA3_DT_CREATED],'' AS  [SKU_DT_CREATED],        
		 ART.STOCK_NA,F.JOB_NAME ,F.JOB_CODE,  
		 '' AS EMP_CODE,'' AS EMP_NAME,0 AS DISCOUNT_AMOUNT,0 AS NET,
		 ART.ALIAS AS ARTICLE_ALIAS ,'' AS EMP_NAME1 ,'' AS EMP_NAME2 ,A.BIN_ID ,'' AS OLD_PRODUCT_CODE
		 ,X.HBD_STATUS_NAME,CAST('' AS DATETIME) AS CM_DT,CAST(0 AS NUMERIC(14,2)) AS CMM_DISCOUNT_AMOUNT
		 FROM HOLD_BACK_DELIVER_MST A (NOLOCK)       
		 JOIN HOLD_BACK_DELIVER_DET B (NOLOCK) ON A.MEMO_ID = B.MEMO_ID       
		 left JOIN sku SKU (NOLOCK) ON SKU.PRODUCT_CODE=B.PRODUCT_CODE 
		 LEFT JOIN sku_names (NOLOCK) ON sku_names.product_Code=SKU.product_code
		 left JOIN ARTICLE ART (NOLOCK) ON art.ARTICLE_CODE = b.ARTICLE_CODE          
		 left JOIN SECTIOND SD (NOLOCK) ON ART.SUB_SECTION_CODE = SD.SUB_SECTION_CODE        
		 left JOIN SECTIONM SM (NOLOCK) ON SD.SECTION_CODE = SM.SECTION_CODE        
		 left JOIN UOM E (NOLOCK)ON ART.UOM_CODE = E.UOM_CODE       
		 LEFT OUTER JOIN JOBS F (NOLOCK) ON F.JOB_CODE = B.JOB_CODE
		 LEFT OUTER JOIN 
		 (
			SELECT CAST(0 AS INT) AS HBD_STATUS,'' AS HBD_STATUS_NAME		
			UNION ALL
			SELECT CAST(1 AS INT) AS HBD_STATUS,'Approve & Issue Credit Note' AS HBD_STATUS_NAME 
			UNION ALL
			SELECT CAST(2 AS INT) AS HBD_STATUS,'Free Repair & Return' AS HBD_STATUS_NAME 
			UNION ALL
			SELECT CAST(3 AS INT) AS HBD_STATUS,'Charged Repair & Return' AS HBD_STATUS_NAME 
			UNION ALL
			SELECT CAST(4 AS INT) AS HBD_STATUS,'Disapprove & Return' AS HBD_STATUS_NAME 
		 )x ON X.HBD_STATUS=b.HBD_STATUS
		 WHERE B.MEMO_ID = @CWHERE  
		 --order by b.product_code    
	        
       
 GOTO LAST      
       
LBLJOBLIST:      
	SELECT JOB_CODE,JOB_NAME  FROM JOBS (NOLOCK) WHERE JOB_NAME <> '' AND INACTIVE = 0      
 GOTO LAST      
LBLHBDMST:      
      
 SELECT * FROM HOLD_BACK_DELIVER_MST (NOLOCK) --ORDER BY LAST_UPDATE DESC
       
 GOTO LAST      
          
LBLCANCELCHECK:      
       
 SELECT C.MEMO_ID       
 FROM POST_SALES_JOBWORK_ISSUE_MST A (NOLOCK)             
 JOIN  POST_SALES_JOBWORK_ISSUE_DET  G (NOLOCK)  ON A.ISSUE_ID = G.ISSUE_ID        
 JOIN  HOLD_BACK_DELIVER_DET B (NOLOCK) ON G.REF_HBD_ROW_ID = B.ROW_ID         
 JOIN  HOLD_BACK_DELIVER_MST C (NOLOCK) ON B.MEMO_ID = C.MEMO_ID       
 WHERE C.MEMO_ID = @CWHERE AND A.CANCELLED = 0         
 GOTO LAST 
 LBLHOLDBACK:
 DECLARE @CVALCASHE CHAR(2)
 SELECT @CVALCASHE = VALUE FROM CONFIG WHERE CONFIG_OPTION = 'OPEN_CASHIER_FOR_CASHMEMOS'
 IF(@CVALCASHE = 1 )
 BEGIN
	SELECT  A.CM_ID,A.CM_NO,A.CM_MODE,A.NET_AMOUNT,A.CUSTOMER_CODE,B.USER_CUSTOMER_CODE, 
	(B.CUSTOMER_FNAME  + ' ' + B.CUSTOMER_LNAME) AS CUSTOMER_NAME, 
	(B.ADDRESS1 + ' ' + B.ADDRESS2 + ' ' + C.AREA_NAME + ' ' + C.PINCODE + ' ' + D.CITY + ' ' + E.STATE) AS  CUSTOMER_ADDRESS 
	FROM CMM01106 A  (NOLOCK) 
	JOIN (SELECT DISTINCT CM_ID FROM DSD01106 DSD (NOLOCK) JOIN DSM01106 DSM (NOLOCK) 
			ON DSD.DS_ID = DSM.DS_ID WHERE DSM.CANCELLED = 0 AND FIN_YEAR = @CFINYEAR )DS
			ON DS.CM_ID = A.CM_ID
	JOIN CUSTDYM B (NOLOCK)  ON A.CUSTOMER_CODE = B.CUSTOMER_CODE  
	JOIN AREA C (NOLOCK) ON C.AREA_CODE = B.AREA_CODE 
	JOIN CITY D (NOLOCK) ON D.CITY_CODE = C.CITY_CODE 
	JOIN STATE E (NOLOCK) ON E.STATE_CODE = D.STATE_CODE  
	WHERE  A.FIN_YEAR = @CFINYEAR AND A.CANCELLED = 0
 END
 ELSE
 BEGIN
	SELECT  A.CM_ID,A.CM_NO,A.CM_MODE,A.NET_AMOUNT,A.CUSTOMER_CODE,B.USER_CUSTOMER_CODE, 
	(B.CUSTOMER_FNAME  + ' ' + B.CUSTOMER_LNAME) AS CUSTOMER_NAME, 
	(B.CUSTOMER_FNAME  + ' ' + B.CUSTOMER_LNAME)+' '+(B.ADDRESS1 + ' ' + B.ADDRESS2 + ' ' + C.AREA_NAME + ' ' + C.PINCODE + ' ' + D.CITY + ' ' + E.STATE) AS  CUSTOMER_ADDRESS 
	FROM CMM01106 A  (NOLOCK) 
	JOIN CUSTDYM B (NOLOCK)  ON A.CUSTOMER_CODE = B.CUSTOMER_CODE  
	JOIN AREA C (NOLOCK) ON C.AREA_CODE = B.AREA_CODE 
	JOIN CITY D (NOLOCK) ON D.CITY_CODE = C.CITY_CODE 
	JOIN STATE E (NOLOCK) ON E.STATE_CODE = D.STATE_CODE  
	WHERE  A.FIN_YEAR = @CFINYEAR AND A.CANCELLED = 0 
 END

LBLBILLMST:
         
   DECLARE @DTSQL NVARCHAR(MAX)
   SET @CWHERE= REPLACE(REPLACE(@CWHERE,',',''','''),' ','')
   --ISNULL(SUBTOTAL,0) +ISNULL(SUBTOTAL_R,0) AMOUNT
     SET @DTSQL=N'SELECT CMM.CM_NO AS BILL_NO,CMM.CM_DT AS BILL_DT
       ,cmm.net_amount AS AMOUNT
       ,ISNULL(CR_AMOUNT,0) AS CREDIT_AMOUNT 
       ,(ISNULL(SUBTOTAL,0) +ISNULL(SUBTOTAL_R,0))-ISNULL(CR_AMOUNT,0) AS RECEIVABLE_AMOUNT
       ,C.MOBILE,
       CUSTOMER=CUSTOMER_TITLE+ '' ''+CUSTOMER_FNAME+'' ''+CUSTOMER_LNAME
       FROM CMM01106 CMM (NOLOCK)
       LEFT JOIN 
       (SELECT XN.MEMO_ID,SUM(AMOUNT) AS CR_AMOUNT 
         FROM  PAYMODE_XN_DET XN (NOLOCK)
         JOIN PAYMODE_MST M (NOLOCK) ON M.PAYMODE_CODE=XN.PAYMODE_CODE
         JOIN PAYMODE_GRP_MST GM (NOLOCK) ON GM.PAYMODE_GRP_CODE=M.PAYMODE_GRP_CODE
         WHERE GM.PAYMODE_GRP_CODE =''0000004''
         GROUP BY XN.MEMO_ID
       ) XN ON XN.MEMO_ID=CMM.CM_ID
       JOIN CUSTDYM C ON C.CUSTOMER_CODE=CMM.CUSTOMER_CODE
       WHERE CMM.CANCELLED=0 AND  CMM.CM_ID IN('''+@CWHERE+''')'

    PRINT @DTSQL
    EXEC SP_EXECUTESQL @DTSQL  
 
  GOTO LAST    
LAST:      
          
END

