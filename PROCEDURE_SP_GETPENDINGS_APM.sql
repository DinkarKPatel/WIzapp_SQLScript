create PROCEDURE SP_GETPENDINGS_APM
(
 @CMEMO_TYPE		NUMERIC(5)=0,
 @CCUSTCODE			VARCHAR(50)='',
 @CDEPT_ID			VARCHAR(5)='',
 @CUSERCODE			VARCHAR(10)='',
 @CBINID			VARCHAR(7)='000'
 ,@NXN_ITEM_TYPE NUMERIC(1)=1     

)
--WITH ENCRYPTION

AS
BEGIN
--(dinkar) Replace  left(memoid,2) to Location_code 
	IF ISNULL(@NXN_ITEM_TYPE,0)=0
	SET @NXN_ITEM_TYPE=1


     DECLARE @CUTOFF_DATE DATETIME 
	 set @CUTOFF_DATE=''
	  SElect @CUTOFF_DATE=ISNULL(value,'') from config where config_option='CUTOFF_DATE_FOR_PENDING_ADV_CN_CR'


	   DECLARE @cMobile VARCHAR(50),@cUserCustCode VARCHAR(50)

	SELECT TOP 1 @cMobile=mobile,@cUserCustCode=user_customer_code FROM custdym (NOLOCK)
	WHERE customer_code=@CCUSTCODE
	
	SELECT memo_id INTO #pending_app FROM apm01106 a (NOLOCK)
	LEFT JOIN  custdym cus (NOLOCK) ON cus.customer_code=a.customer_code
	WHERE A.CANCELLED=0 AND ISNULL(A.REF_CM_ID,'')='' 
	--AND (C.APD_ROW_ID IS NULL OR B.QUANTITY>ISNULL(C.RET_QTY,0))
	AND A.MEMO_TYPE=@CMEMO_TYPE   
	AND ((@CMEMO_TYPE IN  (0,1) AND (A.CUSTOMER_CODE = @CCUSTCODE OR (ISNULL(cus.mobile,'')=@cMobile AND @cMobile<>'')
						 OR (ISNULL(cus.user_customer_code,'')=@cUserCustCode AND @cUserCustCode<>''))) 
	  OR (@CMEMO_TYPE=2 AND A.AC_CODE= @CCUSTCODE) )

	AND a.location_Code = @CDEPT_ID 
	AND A.BIN_ID=@CBINID
	AND (ISNULL(@CUTOFF_DATE,'')='' OR A.MEMO_DT >= ISNULL(@CUTOFF_DATE,''))
	AND CASE WHEN ISNULL(A.XN_ITEM_TYPE,0) IN(0,1) THEN 1 ELSE A.XN_ITEM_TYPE END  =@NXN_ITEM_TYPE
			

	SELECT CONVERT(BIT,0) AS CHKITEM,A.MEMO_ID,B.PRODUCT_CODE,B.QUANTITY AS [TOTAL_QTY],  
	ISNULL(C.RET_QTY,0) AS [RET_QTY],
	B.QUANTITY-ISNULL(C.RET_QTY,0) AS BALANCE_QUANTITY,      
	B.MRP,D.MRP AS TEMPMRP,CONVERT(NUMERIC(14,2),((B.NET/B.QUANTITY)*(B.QUANTITY-ISNULL(C.RET_QTY,0)))) AS [NET],A.MEMO_NO,A.MEMO_DT,      
	B.ROW_ID,B.EMP_CODE,B.MRP,B.RFNET,D.DT_CREATED AS SKU_DT_CREATED, E.DT_CREATED AS ART_DT_CREATED,E.ARTICLE_NO,           
	F.PARA1_CODE,F.PARA1_NAME , G.PARA2_CODE , G.PARA2_NAME,H.SUB_SECTION_NAME, I.SECTION_NAME,      
	J.DT_CREATED AS PARA3_DT_CREATED,J.PARA3_NAME,  D.FIX_MRP,D.PRODUCT_NAME,    
	P4.PARA4_NAME,P5.PARA5_NAME,P6.PARA6_NAME,UOM.UOM_TYPE     
	,B.EMP_CODE1,B.EMP_CODE2,B.ROW_ID AS APD_ROW_ID      
	,EMP.EMP_NAME,EMP1.EMP_NAME AS [EMP_NAME1],EMP2.EMP_NAME AS [EMP_NAME2],UOM.UOM_NAME,CONVERT(BIT,0) AS FREEZED,
	B.DISCOUNT_PERCENTAGE,CONVERT(NUMERIC(14,2),((B.DISCOUNT_AMOUNT/B.QUANTITY)*(B.QUANTITY-ISNULL(C.RET_QTY,0)))) AS [DISCOUNT_AMOUNT]
	,B.BIN_ID,B1.BIN_NAME,I.ITEM_TYPE,A.DISCOUNT_PERCENTAGE AS APM_DISCOUNT_PERCENTAGE,D.hsn_code
	FROM APD01106 B (NOLOCK)
	JOIN APM01106 A (NOLOCK) ON B.MEMO_ID=A.MEMO_ID
	JOIN #pending_app papp ON papp.memo_id=a.memo_id
	JOIN SKU D (NOLOCK) ON B.PRODUCT_CODE = D.PRODUCT_CODE      
	JOIN ARTICLE E (NOLOCK) ON D.ARTICLE_CODE = E.ARTICLE_CODE           
	JOIN PARA1 F (NOLOCK) ON D.PARA1_CODE = F.PARA1_CODE           
	JOIN PARA2 G (NOLOCK) ON D.PARA2_CODE = G.PARA2_CODE           
	JOIN SECTIOND H (NOLOCK) ON E.SUB_SECTION_CODE = H.SUB_SECTION_CODE           
	JOIN SECTIONM I (NOLOCK) ON H.SECTION_CODE = I.SECTION_CODE         
	JOIN PARA3 J (NOLOCK) ON D.PARA3_CODE = J.PARA3_CODE     
	JOIN PARA4 P4 (NOLOCK) ON P4.PARA4_CODE = D.PARA4_CODE     
	JOIN PARA5 P5 (NOLOCK) ON P5.PARA5_CODE = D.PARA5_CODE     
	JOIN PARA6 P6 (NOLOCK) ON P6.PARA6_CODE = D.PARA6_CODE     
	JOIN UOM (NOLOCK) ON E.UOM_CODE = UOM.UOM_CODE     
	JOIN EMPLOYEE EMP  (NOLOCK) ON B.EMP_CODE = EMP.EMP_CODE  
	JOIN EMPLOYEE EMP1  (NOLOCK) ON B.EMP_CODE1 = EMP1.EMP_CODE  
	JOIN EMPLOYEE EMP2  (NOLOCK) ON B.EMP_CODE2 = EMP2.EMP_CODE  
	JOIN BIN B1 ON B1.BIN_ID=B.BIN_ID
	LEFT OUTER JOIN
	(
		SELECT BIN_ID FROM BIN WHERE '0000000'=@CUSERCODE
		UNION 
		SELECT BIN_ID FROM  BINUSERS WHERE '0000000'<>@CUSERCODE AND USER_CODE=@CUSERCODE
	)BU ON BU.BIN_ID=A.BIN_ID 
	LEFT OUTER JOIN 
	(
		SELECT C.APD_ROW_ID,SUM(C.QUANTITY) AS [RET_QTY]
		FROM APPROVAL_RETURN_DET C (NOLOCK) 
		JOIN APPROVAL_RETURN_MST D (NOLOCK) ON D.MEMO_ID=C.MEMO_ID
		JOIN  apd01106 e (NOLOCK) ON e.ROW_ID=c.apd_row_id
		JOIN #pending_app papp ON papp.memo_id=e.memo_id
		WHERE D.CANCELLED=0
		GROUP BY C.APD_ROW_ID
	)C ON C.APD_ROW_ID=B.ROW_ID
	WHERE  (C.APD_ROW_ID IS NULL OR B.QUANTITY>ISNULL(C.RET_QTY,0))
	ORDER BY A.MEMO_DT,B.MEMO_ID
END
