CREATE PROCEDURE SP_CMM_CAL_SUBTOTAL
@CM_ID VARCHAR(100)='',
@BMIRROR BIT = 0,
@BUPDMIRRORTEMPTABLES BIT=0,
@CLOCID VARCHAR(5)=''
--WITH ENCRYPTION
AS
BEGIN
 BEGIN TRY
	DECLARE @CCMD NVARCHAR(MAX),@CCMMTABLE VARCHAR(1000),@CCMDTABLE VARCHAR(1000),@CFILTERCONDITION VARCHAR(1000)
	
	IF (@BMIRROR = 0)
		BEGIN TRAN
			
    IF ISNULL(@CM_ID,'')=''
    BEGIN
			SELECT @CCMMTABLE=(CASE WHEN @BUPDMIRRORTEMPTABLES=1 THEN 'SLS_CMM01106_MIRROR' ELSE 'CMM01106' END),
				   @CCMDTABLE=(CASE WHEN @BUPDMIRRORTEMPTABLES=1 THEN 'SLS_CMD01106_MIRROR' ELSE 'CMD01106' END),
				   @CFILTERCONDITION=(CASE WHEN @BUPDMIRRORTEMPTABLES=1 THEN ' MIRROR_DEPT_ID='''+@CLOCID+''' ' ELSE ' 1=1 ' END) 

            SET @CCMD=N'UPDATE '+@CCMDTABLE+' SET CMM_DISCOUNT_AMOUNT = 0 WHERE CMM_DISCOUNT_AMOUNT IS NULL AND '+@CFILTERCONDITION
            EXEC SP_EXECUTESQL @CCMD
            
			SET @CCMD=N'UPDATE '+@CCMDTABLE+' SET DISCOUNT_AMOUNT = -(ISNULL(DISCOUNT_AMOUNT,0)) 
						WHERE '+@CFILTERCONDITION+' AND QUANTITY < 0 AND DISCOUNT_AMOUNT >0' 
			
			EXEC SP_EXECUTESQL @CCMD
			
			SET @CCMD=N'UPDATE CM SET SUBTOTAL = ISNULL(CD.AMOUNT,0)  FROM '+@CCMMTABLE+' CM 
			LEFT OUTER JOIN 
			( SELECT CM_ID,SUM(NET) AS AMOUNT FROM '+@CCMDTABLE+' WHERE '+@CFILTERCONDITION+' AND QUANTITY > 0 GROUP BY CM_ID )
			CD ON CM.CM_ID = CD.CM_ID WHERE '+@CFILTERCONDITION 
			
			EXEC SP_EXECUTESQL @CCMD
			
			SET @CCMD=N'UPDATE CM SET SUBTOTAL_R = ISNULL(CD.AMOUNT,0)  FROM '+@CCMMTABLE+' CM
			LEFT OUTER JOIN 
			( SELECT CM_ID,SUM(NET) AS AMOUNT FROM '+@CCMDTABLE+' WHERE '+@CFILTERCONDITION+' AND QUANTITY < 0 GROUP BY CM_ID )
			CD ON CM.CM_ID = CD.CM_ID WHERE '+@CFILTERCONDITION 
			
			EXEC SP_EXECUTESQL @CCMD
			
			SET @CCMD=N'UPDATE '+@CCMMTABLE+'  SET DISCOUNT_PERCENTAGE=(DISCOUNT_AMOUNT/SUBTOTAL)*100,DISCOUNT_AMOUNT=ABS(DISCOUNT_AMOUNT)
						WHERE '+@CFILTERCONDITION +' AND SUBTOTAL > 0 AND DISCOUNT_PERCENTAGE > 0  AND (DISCOUNT_AMOUNT/SUBTOTAL)*100 BETWEEN 0 AND 100'
			EXEC SP_EXECUTESQL @CCMD
			
			PRINT 'FIFTH'
			SET @CCMD=N'UPDATE '+@CCMMTABLE+' SET DISCOUNT_PERCENTAGE=ABS(((DISCOUNT_AMOUNT/SUBTOTAL_R)*100)),
			DISCOUNT_AMOUNT=ABS(DISCOUNT_AMOUNT)*-1
			WHERE '+@CFILTERCONDITION +' AND SUBTOTAL = 0 AND DISCOUNT_PERCENTAGE > 0 AND ISNULL(SUBTOTAL_R ,0) < 0    
			AND ABS(((DISCOUNT_AMOUNT/SUBTOTAL_R)*100)) BETWEEN 0 AND 100'
			
			EXEC SP_EXECUTESQL @CCMD
			
			SET @CCMD=N'UPDATE CD SET CMM_DISCOUNT_AMOUNT = ROUND(((CM.DISCOUNT_AMOUNT*NET)/SUBTOTAL) ,3)
			FROM '+@CCMMTABLE+' CM JOIN '+@CCMDTABLE+' CD ON CM.CM_ID = CD.CM_ID 
			WHERE '+@CFILTERCONDITION +' AND CM.DISCOUNT_AMOUNT >0 AND QUANTITY > 0'
			
			EXEC SP_EXECUTESQL @CCMD
			
			SET @CCMD=N'UPDATE CD SET CMM_DISCOUNT_AMOUNT = ROUND(((CM.DISCOUNT_AMOUNT*NET)/SUBTOTAL_R) ,3)
			FROM '+@CCMMTABLE+' CM JOIN '+@CCMDTABLE+' CD ON CM.CM_ID = CD.CM_ID 
			WHERE '+@CFILTERCONDITION +' AND CM.DISCOUNT_AMOUNT < 0 AND QUANTITY < 0'
			
			EXEC SP_EXECUTESQL @CCMD
			
			IF OBJECT_ID ('#TEMP_TT','U') IS NOT NULL
              DROP TABLE #TEMP_TT
            
            SELECT CONVERT(NUMERIC(10,2),0) AS DIFF,A.CM_ID,CONVERT(INT,0) AS ROW,CMM_DISCOUNT_AMOUNT , 
			CONVERT(INT,0) AS ROW1 INTO #TEMP_TT FROM CMD01106 A WHERE 1=2
						 
			SET @CCMD=N'SELECT DISTINCT TT.DIFF,TT.CM_ID,TT.ROW ,CMM_DISCOUNT_AMOUNT  
			,ROW_NUMBER() OVER(PARTITION BY RR.CM_ID  ORDER BY RR.CM_ID  ) AS ROW1  
			FROM '+@CCMDTABLE+' AS RR JOIN (
			SELECT  ROUND(CM.DISCOUNT_AMOUNT,3)-ISNULL(SUM(CMM_DISCOUNT_AMOUNT),0) DIFF,CM.CM_ID,
			ROW_NUMBER() OVER(  ORDER BY CM.CM_ID  ) AS ROW 
			FROM '+@CCMMTABLE+' CM JOIN '+@CCMDTABLE+' CD ON CM.CM_ID = CD.CM_ID  
			WHERE '+@CFILTERCONDITION +' AND CM.DISCOUNT_AMOUNT >0 AND QUANTITY > 0 GROUP BY CM.DISCOUNT_AMOUNT,CM.CM_ID 
			HAVING ROUND(CM.DISCOUNT_AMOUNT,3)-ISNULL(SUM(CMM_DISCOUNT_AMOUNT),0) <> 0 )
			AS TT ON TT.CM_ID = RR.CM_ID' 
			
			EXEC SP_EXECUTESQL @CCMD
				
			IF EXISTS (SELECT TOP 1 * FROM #TEMP_TT)
			BEGIN	
				ALTER TABLE #TEMP_TT ADD ROW_ID VARCHAR(100)
				
				SET @CCMD=N'UPDATE AA SET ROW_ID = CC.ROW_ID  FROM #TEMP_TT AA JOIN '+@CCMDTABLE+' AS CC ON AA.CM_ID = CC.CM_ID' 
				EXEC SP_EXECUTESQL @CCMD
				
				SET @CCMD=N'UPDATE BB SET CMM_DISCOUNT_AMOUNT = ISNULL(BB.CMM_DISCOUNT_AMOUNT,0) + ISNULL(TT.DIFF,0)
				FROM '+@CCMDTABLE+' AS BB  JOIN #TEMP_TT AS TT ON BB.ROW_ID= TT.ROW_ID WHERE ROW1=1'
				
				EXEC SP_EXECUTESQL @CCMD
			END
        
    END 
    ELSE 
    BEGIN
			
			UPDATE CMD01106 SET CMM_DISCOUNT_AMOUNT = 0 WHERE CM_ID = @CM_ID
         
			UPDATE CM SET SUBTOTAL = ISNULL(CD.AMOUNT,0)  FROM CMM01106 AS CM 
			LEFT OUTER JOIN 
			( SELECT CM_ID,SUM(NET) AS AMOUNT FROM CMD01106 WHERE QUANTITY > 0 AND CM_ID = @CM_ID GROUP BY CM_ID )
			CD ON CM.CM_ID = CD.CM_ID WHERE CM.CM_ID = @CM_ID

			UPDATE CM SET SUBTOTAL_R = ISNULL(CD.AMOUNT,0)  FROM CMM01106 CM
			LEFT OUTER JOIN 
			( SELECT CM_ID,SUM(NET) AS AMOUNT FROM CMD01106 WHERE QUANTITY < 0 AND CM_ID = @CM_ID GROUP BY CM_ID )
			CD ON CM.CM_ID = CD.CM_ID WHERE CM.CM_ID = @CM_ID
			
			UPDATE CD SET CMM_DISCOUNT_AMOUNT = ROUND(((CM.DISCOUNT_AMOUNT*NET)/SUBTOTAL) ,3)
			FROM CMM01106 (NOLOCK) CM JOIN CMD01106 (NOLOCK) CD ON CM.CM_ID = CD.CM_ID 
			WHERE CM.DISCOUNT_AMOUNT >0 AND QUANTITY > 0 AND CM.CM_ID = @CM_ID

			UPDATE CD SET CMM_DISCOUNT_AMOUNT = ROUND(((CM.DISCOUNT_AMOUNT*NET)/SUBTOTAL_R) ,3)
			FROM CMM01106 (NOLOCK) CM JOIN CMD01106 (NOLOCK) CD ON CM.CM_ID = CD.CM_ID 
			WHERE CM.DISCOUNT_AMOUNT < 0 AND QUANTITY < 0 AND CM.CM_ID = @CM_ID
			
			IF OBJECT_ID ('#TEMP_TT1','U') IS NOT NULL
              DROP TABLE #TEMP_TT1
              
			SELECT DISTINCT TT.DIFF,TT.CM_ID,TT.ROW ,CMM_DISCOUNT_AMOUNT  
			, ROW_NUMBER() OVER(PARTITION BY RR.CM_ID  ORDER BY RR.CM_ID  ) AS ROW1  
			INTO #TEMP_TT1 FROM CMD01106 AS RR JOIN (
			SELECT  ROUND(CM.DISCOUNT_AMOUNT,3)-ISNULL(SUM(CMM_DISCOUNT_AMOUNT),0) DIFF,CM.CM_ID,
			ROW_NUMBER() OVER(  ORDER BY CM.CM_ID  ) AS ROW 
			FROM CMM01106 CM JOIN CMD01106 CD ON CM.CM_ID = CD.CM_ID  
			WHERE CM.DISCOUNT_AMOUNT >0 AND QUANTITY > 0 
			AND CM.CM_ID = @CM_ID GROUP BY CM.DISCOUNT_AMOUNT,CM.CM_ID 
			HAVING ROUND(CM.DISCOUNT_AMOUNT,3)-ISNULL(SUM(CMM_DISCOUNT_AMOUNT),0) <> 0 
			) AS TT ON TT.CM_ID = RR.CM_ID 
			
			
			--SELECT * FROM #TEMP_TT1
			
			IF EXISTS (SELECT TOP 1 * FROM #TEMP_TT1)
			 BEGIN	
				ALTER TABLE #TEMP_TT1 ADD ROW_ID VARCHAR(100)
				UPDATE AA SET ROW_ID = CC.ROW_ID  FROM #TEMP_TT1 AA JOIN CMD01106 AS CC ON AA.CM_ID = CC.CM_ID 

				UPDATE BB SET CMM_DISCOUNT_AMOUNT = ISNULL(BB.CMM_DISCOUNT_AMOUNT,0) + ISNULL(TT.DIFF,0)
				FROM CMD01106 AS BB  JOIN #TEMP_TT1 AS TT ON BB.ROW_ID= TT.ROW_ID 
				WHERE ROW1=1
			 END
		
    END
	
	IF (@BMIRROR = 0)         
		COMMIT
    
    SELECT '' AS ERRMSG
END TRY
 
BEGIN CATCH
	IF (@BMIRROR = 0)
		ROLLBACK
	
	SELECT ERROR_MESSAGE() AS ERRMSG
END CATCH
END
