CREATE PROC VALIDATEXN_WSR_BEFORE_EDIT   
@CMEMOID VARCHAR(30),  
@BCANCELXN BIT,  
@CERRORMSG VARCHAR(200) OUTPUT,  
@CEXPRERRORMSG VARCHAR(200) OUTPUT  
--WITH ENCRYPTION
AS  
BEGIN  
   
 DECLARE @CTEXT VARCHAR(10),@CPRODUCTCODE VARCHAR(50) ,@CVALUE VARCHAR(5) 
   
 SELECT @CPRODUCTCODE=''  
 
 SELECT @CVALUE = VALUE  FROM CONFIG  WHERE CONFIG_OPTION ='NEW_ACCOUNT_SYSTEM'
    
 SET @CTEXT=(CASE WHEN @BCANCELXN=1 THEN 'CANCEL' ELSE 'EDIT' END)  

	  IF EXISTS (SELECT TOP 1 CN_ID FROM CNM01106 WHERE CN_ID=@CMEMOID AND CANCELLED=0 AND ISNULL(EINV_IRN_NO,'')<>'') AND @BCANCELXN<>1
	 BEGIN   
		SET @CERRORMSG='EINVOICE GENERATED.........CAN NOT '+@CTEXT  
		RETURN  
	 END  

 
   IF EXISTS (SELECT TOP 1 CN_ID FROM CNM01106 WHERE CN_ID=@CMEMOID AND mode=2)
	BEGIN   
		SET @CERRORMSG='Group Credit note cannot be Edited/Cancelled directly'
		RETURN  
	END  

   IF EXISTS (SELECT TOP 1 CN_ID FROM CNM01106 WHERE CN_ID=@CMEMOID AND CANCELLED=0 AND ISNULL(EINV_IRN_NO,'')<>'' ) AND @BCANCELXN<>1
	BEGIN   
		SET @CERRORMSG='EINVOICE GENERATED.........CAN NOT '+@CTEXT  
		RETURN  
	END  

	IF EXISTS (SELECT TOP 1 a.Memo_ID FROM eosssorm A (NOLOCK) JOIN SOR_FDNFCN_LINK b (NOLOCK) 
			   ON a.MEMO_ID=b.sorMemoId WHERE b.refFcnMemoId= @CMEMOID) 
	BEGIN	
		SET @CERRORMSG='This Credit Note has been generated From SOR module.........CAN NOT '+@CTEXT
		RETURN
	END
	
	IF EXISTS (SELECT TOP 1 a.Memo_ID FROM eossdnm A (NOLOCK) JOIN cnm01106 b (NOLOCK) 
			   ON 'FDN'+b.cn_id=a.ref_fdn_memoid WHERE b.cn_ID= @CMEMOID) AND @BCANCELXN=0
	BEGIN	
		SET @CERRORMSG='This Credit Note has been generated From EOSS Debit note module.........CAN NOT '+@CTEXT
		RETURN
	END

END