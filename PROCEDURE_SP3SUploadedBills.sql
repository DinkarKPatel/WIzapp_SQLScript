CREATE PROCEDURE SP3SUPLOADEDBILLS
AS  
BEGIN  
  
  IF OBJECT_ID ('TEMPDB..#UPLOADCMID','U') IS NOT NULL  
   DROP TABLE #UPLOADCMID  
      
   CREATE TABLE #UPLOADCMID  
   (  
  CM_ID VARCHAR(50)  
   )  
   
 IF OBJECT_ID('UPLOADEDBILL','U') IS NULL  
 CREATE TABLE UPLOADEDBILL(CM_ID VARCHAR(50) NOT NULL PRIMARY KEY)   
     
 INSERT INTO #UPLOADCMID (CM_ID)  
 SELECT A.CM_ID    
 FROM CMM01106 A  
 LEFT JOIN UPLOADEDBILL B ON A.CM_ID=B.CM_ID  
 WHERE A.CANCELLED=0 AND B.CM_ID IS NULL   
       
 SELECT LEFT(A.CM_ID,2)AS DEPT_ID,D.DEPT_ALIAS AS LOCATIONALIES,PRODUCT_CODE,SUM(A.QUANTITY) AS QUANTITY  
 FROM CMD01106 A   
 JOIN #UPLOADCMID B ON A.CM_ID=B.CM_ID  
 JOIN PRODUCTLOCATION C ON LEFT(A.CM_ID,2)=C.DEPT_ID 
 JOIN LOCATION D  ON LEFT(A.CM_ID,2)=D.DEPT_ID
 GROUP BY LEFT(A.CM_ID,2),D.DEPT_ALIAS,PRODUCT_CODE  
 HAVING SUM(A.QUANTITY)>0   
       
 ---FOR INSERT CM_ID INTO UPLOADEDBILL TABLE FROM TEMP TABLE-----  
 INSERT INTO UPLOADEDBILL (CM_ID)   
 SELECT CM_ID FROM #UPLOADCMID  
END  
--END OF PROCEDURE - SP3SUPLOADEDBILLS
