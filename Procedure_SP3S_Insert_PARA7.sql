create	Procedure SP3S_Insert_PARA7
(
   @CXNTYPE VARCHAR(10)='',
   @CSP_ID VARCHAR(50),
   @CLOCID varchar(5)='',
   @CERRORMSG VARCHAR(1000) OUTPUT 
)
as
begin

BEGIN TRY             
        

	

	  DECLARE @CSTEP varchar(10),@CMEMOPREFIX VARCHAR(2),@ctablename varchar(100),
	           @CMEMONOVAL varchar(10),@NMEMONOLEN NUMERIC(5,0)
	  set @CERRORMSG=''
	  SET @NMEMONOLEN=9
	  
	
		 
		 IF @CXNTYPE='PUR'
		 BEGIN
		    SET @CTABLENAME='PUR_PID01106_UPLOAD'
		
		 END
     	 ELSE IF @CXNTYPE='PO'
		 BEGIN
	         SET @CTABLENAME='PO_POD01106_UPLOAD'

		END
         ELSE IF @CXNTYPE='WSL'
		 BEGIN
	         SET @CTABLENAME='ind01106'

		END
		 ELSE IF @CXNTYPE='GRNPS'
		 BEGIN
	         SET @CTABLENAME='GRN_ps_det'

		END
		ELSE IF @CXNTYPE='SNC'
		 BEGIN
	         SET @CTABLENAME='SNC_BARCODE_DET'

		END
		ELSE IF @CXNTYPE='IRR'
		 BEGIN
	         SET @CTABLENAME='IRR_IRD01106_UPLOAD'

		END

	  SET @CSTEP='10'

	

	  DECLARE @CCOLNAME VARCHAR(1000),@CCOLUMNSEPARATOR VARCHAR(5),@ccolfilter varchar(20)
	   SELECT @CCOLUMNSEPARATOR=SEPARATOR_KEY FROM INV_SKU_COL_LIST

	   IF ISNULL(@CCOLUMNSEPARATOR,'')=''
	   SET @CCOLUMNSEPARATOR=''
	  

	
	
		SELECT  @CCOLNAME=ISNULL(@CCOLNAME +'+'+''''+@CCOLUMNSEPARATOR+'''+','') +  (CASE WHEN COL_VALUE='PRODUCT_CODE' THEN 'LEFT(A.PRODUCT_CODE, ISNULL(NULLIF(CHARINDEX (''@'',A.PRODUCT_CODE)-1,-1),LEN(A.PRODUCT_CODE )))' 
		WHEN COL_VALUE='DEPT_ID' THEN 'LOC_VIEW.DEPT_ID' ELSE COL_EXPR  END )  
		FROM INV_SKU_COL_LIST a
		WHERE ISNULL(FOR_SKU ,0)=1
		order by isnull(sku_order,0)

	  IF ISNULL(@CCOLNAME,'')=''
		 GOTO END_PROC

	

        SET @CSTEP='20'
       
       if @CXNTYPE <>'PUR'
       begin
	       
			IF OBJECT_ID('TEMPDB..#TMPPARA7_DET','U') IS NOT NULL
			   DROP TABLE #TMPPARA7_DET
			  CREATE TABLE #TMPPARA7_DET(Product_code VARCHAR(50),PARA7_NAME VARCHAR(100),PARA7_CODE VARCHAR(10))
			  
		end

		  
		 
		DECLARE @DTSQL NVARCHAR(MAX)

		if @CXNTYPE in('PUR','PO')
		begin

			SET @DTSQL=N'
			SELECT A.product_code, '+@CCOLNAME+' AS PARA7_NAME,cast('''' as varchar(10)) AS PARA7_CODE
			FROM  '+@CTABLENAME+' A
			JOIN  article (NOLOCK)  ON ARTICLE.ARTICLE_CODE = A.ARTICLE_CODE
			JOIN  PARA1 (NOLOCK) ON PARA1.PARA1_CODE = A.PARA1_CODE
			JOIN  PARA2 (NOLOCK) ON PARA2.PARA2_CODE = A.PARA2_CODE
			JOIN  PARA3 (NOLOCK)  ON PARA3.PARA3_CODE = A.PARA3_CODE
			JOIN  PARA4 (NOLOCK) ON PARA4.PARA4_CODE = A.PARA4_CODE
			JOIN  PARA5 (NOLOCK) ON PARA5.PARA5_CODE	= A.PARA5_CODE
			JOIN  PARA6 (NOLOCK)  ON PARA6.PARA6_CODE = A.PARA6_CODE
			where A.SP_ID='''+@CSP_ID+''''
		 end
		ELSE if  @CXNTYPE in('WSL','GRNPS')
		BEGIN
		    
			if @CXNTYPE='wsl'
			  set @ccolfilter=' A.inv_id'
			else if @CXNTYPE='GRNPS'
			   set @ccolfilter=' A.memo_id'

			 

		   SET @DTSQL=N'
			SELECT A.product_code, '+@CCOLNAME+' AS PARA7_NAME,cast('''' as varchar(10)) AS PARA7_CODE
			FROM  '+@CTABLENAME+' A
			JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE
			JOIN  article (NOLOCK)  ON ARTICLE.ARTICLE_CODE = SKU.ARTICLE_CODE
			JOIN  PARA1 (NOLOCK) ON PARA1.PARA1_CODE = SKU.PARA1_CODE
			JOIN  PARA2 (NOLOCK) ON PARA2.PARA2_CODE = SKU.PARA2_CODE
			JOIN  PARA3 (NOLOCK)  ON PARA3.PARA3_CODE = SKU.PARA3_CODE
			JOIN  PARA4 (NOLOCK) ON PARA4.PARA4_CODE = SKU.PARA4_CODE
			JOIN  PARA5 (NOLOCK) ON PARA5.PARA5_CODE	= SKU.PARA5_CODE
			JOIN  PARA6 (NOLOCK)  ON PARA6.PARA6_CODE = SKU.PARA6_CODE
			where '+@ccolfilter+'='''+@CSP_ID+''''

		end
		ELSE if  @CXNTYPE in('SNC')
		BEGIN
		   
			
		   SET @DTSQL=N'
			SELECT A.product_code, '+@CCOLNAME+' AS PARA7_NAME,cast('''' as varchar(10)) AS PARA7_CODE
			FROM  '+@CTABLENAME+' A
			join SNC_DET sd (nolock) on a.REFROW_ID=sd.row_id
			JOIN SKU (NOLOCK) ON A.PRODUCT_CODE=SKU.PRODUCT_CODE
			JOIN  article (NOLOCK)  ON ARTICLE.ARTICLE_CODE = SKU.ARTICLE_CODE
			JOIN  PARA1 (NOLOCK) ON PARA1.PARA1_CODE = SKU.PARA1_CODE
			JOIN  PARA2 (NOLOCK) ON PARA2.PARA2_CODE = SKU.PARA2_CODE
			JOIN  PARA3 (NOLOCK)  ON PARA3.PARA3_CODE = SKU.PARA3_CODE
			JOIN  PARA4 (NOLOCK) ON PARA4.PARA4_CODE = SKU.PARA4_CODE
			JOIN  PARA5 (NOLOCK) ON PARA5.PARA5_CODE	= SKU.PARA5_CODE
			JOIN  PARA6 (NOLOCK)  ON PARA6.PARA6_CODE = SKU.PARA6_CODE
			where sd.memo_id='''+@CSP_ID+''' '

		end
		else if @CXNTYPE in('IRR')
		begin

			SET @DTSQL=N'
			SELECT A.product_code, '+@CCOLNAME+' AS PARA7_NAME,cast('''' as varchar(10)) AS PARA7_CODE
			FROM  '+@CTABLENAME+' A
			JOIN  article (NOLOCK)  ON ARTICLE.ARTICLE_CODE = A.ARTICLE_CODE
			JOIN  PARA1 (NOLOCK) ON PARA1.PARA1_CODE = A.PARA1_CODE
			JOIN  PARA2 (NOLOCK) ON PARA2.PARA2_CODE = A.PARA2_CODE
			JOIN  PARA3 (NOLOCK)  ON PARA3.PARA3_CODE = A.PARA3_CODE
			JOIN  PARA4 (NOLOCK) ON PARA4.PARA4_CODE = A.PARA4_CODE
			JOIN  PARA5 (NOLOCK) ON PARA5.PARA5_CODE	= A.PARA5_CODE
			JOIN  PARA6 (NOLOCK)  ON PARA6.PARA6_CODE = A.PARA6_CODE
			join sku_names sn (nolock) on sn.product_code=a.product_code 
			where A.SP_ID='''+@CSP_ID+''' and isnull(a.new_product_code,'''') ='''' 
			and isnull(sn.para7_name,'''')<>'+@CCOLNAME+'
			'
			IF EXISTS (SELECT TOP 1 'U' FROM IRR_IRD01106_UPLOAD (NOLOCK) WHERE SP_ID =@CSP_ID AND ISNULL(NEW_PRODUCT_CODE,'')<>'')
			BEGIN
			
		   SET @DTSQL=@DTSQL+'	union all 
			SELECT A.new_product_code, '+@CCOLNAME+' AS PARA7_NAME,cast('''' as varchar(10)) AS PARA7_CODE
			FROM  '+@CTABLENAME+' A
			JOIN  article (NOLOCK)  ON ARTICLE.ARTICLE_CODE = A.ARTICLE_CODE
			JOIN  PARA1 (NOLOCK) ON PARA1.PARA1_CODE = A.PARA1_CODE
			JOIN  PARA2 (NOLOCK) ON PARA2.PARA2_CODE = A.PARA2_CODE
			JOIN  PARA3 (NOLOCK)  ON PARA3.PARA3_CODE = A.PARA3_CODE
			JOIN  PARA4 (NOLOCK) ON PARA4.PARA4_CODE = A.PARA4_CODE
			JOIN  PARA5 (NOLOCK) ON PARA5.PARA5_CODE	= A.PARA5_CODE
			JOIN  PARA6 (NOLOCK)  ON PARA6.PARA6_CODE = A.PARA6_CODE
			where A.SP_ID='''+@CSP_ID+''' and isnull(a.new_product_code,'''') <>'''' 
			
			'
		   END
			
			
		 end
		
		PRINT @DTSQL 
		INSERT INTO #TMPPARA7_DET(Product_code,PARA7_NAME,PARA7_CODE)
		EXEC SP_EXECUTESQL @DTSQL
		
		IF @CXNTYPE ='IRR'
		BEGIN
		    IF NOT  EXISTS (SELECT TOP 1 'U' FROM #TMPPARA7_DET)
		     GOTO END_PROC 
		END

		IF OBJECT_ID('TEMPDB..#TMPPARA7','U') IS NOT NULL
		   DROP TABLE #TMPPARA7

		   SELECT A.PARA7_NAME,A.PARA7_CODE  ,CAST(0 AS NUMERIC(5,0)) AS SRNO
		       INTO #TMPPARA7
		   FROM #TMPPARA7_DET A 
		   LEFT JOIN PARA7 B (NOLOCK) ON A.PARA7_NAME =B.PARA7_NAME 
		   WHERE B.PARA7_NAME IS NULL
		   GROUP BY  A.PARA7_NAME,A.PARA7_CODE  



		IF NOT  EXISTS (SELECT TOP 1 'U' FROM #TMPPARA7)
		   GOTO LBLUPDATE_SKU 

		SET @CSTEP='30'

		LBLGENKEY:

		;WITH CTE AS
		(
		SELECT *,SR=ROW_NUMBER() OVER (ORDER BY PARA7_NAME) 
		FROM #TMPPARA7
		)
		UPDATE CTE SET  SRNO=SR

		SET @CSTEP='40'
		SET @CMEMOPREFIX=@CLOCID
		
		 EXEC DBO.GETNEXTKEY 'PARA7', 'PARA7_CODE', 9, @CMEMOPREFIX, 1, '', 2, @CMEMONOVAL OUTPUT 
		  
		  	IF @CMEMONOVAL IS NULL  OR @CMEMONOVAL LIKE '%LATER%' OR ISNUMERIC(RIGHT(@CMEMONOVAL,6))=0
			BEGIN  
			   SET @CERRORMSG = 'STEP- ' + LTRIM(RTRIM(@cStep)) + ' ERROR CREATING Para7 (SKU)....'   
			   GOTO END_PROC      
			END  

		   SET @CSTEP='50'                        
		   IF EXISTS(SELECT TOP 1 'U' FROM PARA7 WHERE PARA7_CODE=@CMEMONOVAL )                        
			GOTO LBLGENKEY    

         SET @CSTEP='51'   
		 
		 --UPDATE #TMPPARA7 SET PARA7_CODE=rtrim(ltrim(@CMEMOPREFIX+replicate('0',9-len(ltrim(rtrim(@CMEMOPREFIX+CAST(cast(RIGHT(@CMEMONOVAL,7) as numeric(10,0))+SRNO-1 AS VARCHAR(10))))))+
		 --CAST(cast(RIGHT(@CMEMONOVAL,7) as numeric(10,0))+SRNO-1 AS VARCHAR(10))))      
    
		
		UPDATE #TMPPARA7 SET PARA7_CODE=RTRIM(LTRIM(@CMEMOPREFIX+REPLICATE('0',9-LEN(LTRIM(RTRIM(@CMEMOPREFIX+
		CAST(cast(RIGHT(@CMEMONOVAL,7) as numeric(10,0))+SRNO-1 AS VARCHAR(10))))))+CAST(cast(RIGHT(@CMEMONOVAL,7) as numeric(10,0))+SRNO-1 AS VARCHAR(10))))            
		
		  SET @CSTEP='52'  
		UPDATE A SET PARA7_CODE ='' FROM #TMPPARA7 A
		JOIN PARA7 P7 (NOLOCK) ON P7.PARA7_CODE =A.PARA7_CODE

		IF EXISTS (SELECT TOP 1 'U' FROM #TMPPARA7 WHERE ISNULL(PARA7_CODE,'')='')
		   GOTO LBLGENKEY

		   SET @CSTEP='53'  
		 SELECT LEFT (PARA7_CODE,2) AS PREFIX ,MAX(PARA7_CODE) AS MAXCM_NO             
		 INTO #TMPKEYS            
		 FROM #TMPPARA7 A            
		 GROUP BY LEFT (PARA7_CODE,2)          
            
		 UPDATE A SET LASTKEYVAL =B.MAXCM_NO             
		 FROM KEYS  A            
		 JOIN #TMPKEYS B ON A.PREFIX=B.PREFIX 
		 WHERE TABLENAME='PARA7'
            
		 INSERT PARA7	( INACTIVE, LAST_UPDATE, PARA7_CODE, PARA7_NAME )  
		 SELECT 0 INACTIVE,GETDATE() LAST_UPDATE, PARA7_CODE, PARA7_NAME 
		 FROM #TMPPARA7

		
		 lblUPDATE_SKU:


		SET @CSTEP='60'    
		

		UPDATE A SET PARA7_CODE= B.PARA7_CODE
		FROM #TMPPARA7_DET A
		JOIN PARA7 B ON A.PARA7_NAME =B.PARA7_NAME 

		IF EXISTS (SELECT TOP 1'U' FROM #TMPPARA7_DET WHERE ISNULL(PARA7_CODE,'')='')
		begin
		   
		   SET @CERRORMSG = 'STEP- ' + LTRIM(RTRIM(@cStep)) + ' Blank SKU CAN NOT BE SAVED'   
		   GOTO END_PROC

		end
		
		if @CXNTYPE ='PUR' 
		begin
		     if exists (select top 1 'U' from #TMPPARA7_DET where product_code like '%@%')
		     begin
		     
		        INSERT INTO #TMPPARA7_DET(Product_code,PARA7_NAME,PARA7_CODE)
		        select substring(Product_code,1,CHARINDEX('@',product_code)-1) as Product_code,PARA7_NAME,PARA7_CODE
		        from #TMPPARA7_DET where product_code like '%@%'
		     
		     end
		     
		GOTO END_PROC  
		end 

		UPDATE B SET PARA7_CODE =A.PARA7_CODE
		FROM #TMPPARA7_DET A
		JOIN SKU B WITH (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE

		UPDATE B SET para7_name  =A.para7_name  
		FROM #TMPPARA7_DET A  
		JOIN sku_names  B WITH (NOLOCK) ON A.PRODUCT_CODE=B.PRODUCT_CODE  
		
		
		
  


GOTO END_PROC                        
                          
END TRY                        
                         
BEGIN CATCH                       
  PRINT 'ENTER CATCH BLOCK'                     
  SET @CERRORMSG='SP3S_Insert_PARA7  : AT STEP - '+@CSTEP+', MESSAGE - '+ERROR_MESSAGE()                                   
  GOTO END_PROC                         
END CATCH                        
                         
END_PROC:         


 END

