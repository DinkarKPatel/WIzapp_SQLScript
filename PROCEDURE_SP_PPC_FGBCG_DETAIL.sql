CREATE PROCEDURE SP_PPC_FGBCG_DETAIL
(
@NQUERYID INT,
@ORDERID VARCHAR(50)
)
AS
BEGIN

IF @NQUERYID=1
GOTO LBLMST
IF @NQUERYID=2
GOTO LBLDET


LBLMST:
 
SELECT AC_NAME,A.AC_CODE,REF_NO,ORDER_NO,
CONVERT(VARCHAR(10) ,CAST(ORDER_DT AS DATETIME),103) AS ORDER_DT
 FROM PPC_BUYER_ORDER_MST A
JOIN LM01106 B ON A.AC_CODE=B.AC_CODE
WHERE A.BILL_NO=@ORDERID
GOTO END_PROC	  
		
		
LBLDET:
    

SELECT ROW_NUMBER()OVER(ORDER BY A.ARTICLE_CODE) AS ROWNUMBER,ARTICLE_NO, A.ARTICLE_CODE,PARA1.PARA1_CODE,
       PARA1_NAME,S.SIZEGROUP_CODE,SIZEGROUP_NAME,SUM(QUANTITY) AS TOTAL_QUANTITY,A.PARA3_CODE,PARA3_NAME, 
		ARTICLE.UOM_CODE,UOM_NAME,
		0 AS QUANTITY,
		(SUM(QUANTITY)-ISNULL(TOTALBAR,0)) AS PENDING_QUANTITY,
		 'LATER' AS ROW_ID,ROW_ID AS BO_DET_ROW_ID 
		 FROM PPC_BUYER_ORDER_DET A
		JOIN PPC_BUYER_ORDER_MST B ON A.ORDER_ID=B.ORDER_ID
		JOIN ARTICLE ON A.ARTICLE_CODE=ARTICLE.ARTICLE_CODE
		JOIN PARA1 ON PARA1.PARA1_CODE=A.PARA1_CODE
		JOIN PARA3 ON PARA3.PARA3_CODE=A.PARA3_CODE
		JOIN PPC_SIZEGROUP S ON S.SIZEGROUP_CODE=A.SIZEGROUP_CODE
		JOIN UOM U ON U.UOM_CODE=ARTICLE.UOM_CODE
		LEFT JOIN 
		(
		 SELECT BO_DET_ROW_ID,COUNT(BO_DET_ROW_ID)AS TOTALBAR 
		 FROM PPC_FGBCG_DET A
		 JOIN PPC_FG_SKU B ON A.ROW_ID =B.PPC_FGBCG_DET_ROW_ID
		 JOIN PPC_FGBCG_MST C ON C.MEMO_ID =A.MEMO_ID
		 WHERE C.CANCELLED=0
		GROUP BY BO_DET_ROW_ID
		)PMT ON PMT.BO_DET_ROW_ID=A.ROW_ID 
		WHERE B.BILL_NO=@ORDERID
		GROUP BY ARTICLE_NO,A.ARTICLE_CODE,PARA1.PARA1_CODE,PARA1_NAME,
		S.SIZEGROUP_CODE,SIZEGROUP_NAME,ROW_ID,A.PARA3_CODE,PARA3_NAME,
		ARTICLE.UOM_CODE,UOM_NAME,TOTALBAR
		HAVING (SUM(QUANTITY)-ISNULL(TOTALBAR,0))>0
		GOTO END_PROC


END_PROC:		
		  
END
