CREATE PROCEDURE SP3S_GETPROFITCONTR_REPORT
@CDEPTID VARCHAR(5),
@CSETUPCODE CHAR(5)
AS
BEGIN
	DECLARE @NROWSCNT NUMERIC(5,0)
	
	IF OBJECT_ID('TEMPDB..#TMPPROFITCONTR','U') IS NOT NULL
		DROP TABLE #TMPPROFITCONTR
		
	SELECT TOP 10 DEPT_ID,PARA_VAL,PROFIT_AMOUNT,CONTR_PCT
	INTO #TMPPROFITCONTR FROM DB_PROFIT_CONTR_SUMMARY WHERE SETUP_CODE=@CSETUPCODE AND DEPT_ID=@CDEPTID
	ORDER BY PROFIT_AMOUNT DESC
	
	SET @NROWSCNT=@@ROWCOUNT
	
	IF EXISTS (SELECT TOP 1 A.SETUP_CODE FROM DB_PROFIT_CONTR_SUMMARY A
			   LEFT OUTER JOIN #TMPPROFITCONTR B ON A.PARA_VAL=B.PARA_VAL
			   WHERE A.SETUP_CODE=@CSETUPCODE AND A.DEPT_ID=@CDEPTID AND B.DEPT_ID IS NULL
			  )
		
		SELECT * FROM 
		(	  
		SELECT 1 AS SR_NO,* FROM #TMPPROFITCONTR
		UNION
		SELECT 2 AS SR_NO,'' AS DEPT_ID,'OTHERS' AS PARA_VAL,SUM(A.PROFIT_AMOUNT) AS PROFIT_AMOUNT,SUM(A.CONTR_PCT) AS CONTR_PCT
		FROM DB_PROFIT_CONTR_SUMMARY A
		LEFT OUTER JOIN #TMPPROFITCONTR B ON A.PARA_VAL=B.PARA_VAL
		WHERE A.SETUP_CODE=@CSETUPCODE AND A.DEPT_ID=@CDEPTID AND B.DEPT_ID IS NULL
		) A
		ORDER BY SR_NO,PARA_VAL
	ELSE
		SELECT * FROM #TMPPROFITCONTR
		ORDER BY PARA_VAL
END
---------- END OF  PROCEDURE SP3S_GETPROFITCONTR_REPORT
