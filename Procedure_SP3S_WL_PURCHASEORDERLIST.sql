
create  Procedure SP3S_WL_PURCHASEORDERLIST     

AS               
SELECT  
A.PO_DT AS 'MEMO_DT',  
A.PO_ID AS 'MEMO_ID',       
A.PO_NO AS 'MEMO_NO',       
A.REF_NO AS 'REF_NO',       

A.CHECKED_BY AS 'CHECKED_BY',      
(CASE WHEN A.CANCELLED = 0 THEN A.TOTAL_AMOUNT  ELSE 0 END) AS 'NET_PURCHASE_VALUE',           

(CASE WHEN A.CANCELLED = 0 THEN A.DISCOUNT_AMOUNT  ELSE 0 END)  AS 'BILL_DISCOUNT_AMOUNT',      
A.DISCOUNT_PERCENTAGE AS 'DISCOUNT_PERCENTAGE',      
(CASE WHEN A.CANCELLED = 0 THEN A.FREIGHT  ELSE 0 END) AS 'FREIGHT',      
(CASE WHEN A.CANCELLED = 0 THEN A.OTHER_CHARGES  ELSE 0 END) AS 'OTHER_CHARGES',      
(CASE WHEN A.CANCELLED = 0 THEN A.ROUND_OFF  ELSE 0 END) AS 'ROUND_OFF',    

A.REMARKS AS 'REMARKS',      
(CASE WHEN A.CANCELLED = 0 THEN A.SUBTOTAL  ELSE 0 END) AS 'SUBTOTAL',      
(CASE WHEN A.CANCELLED = 0 THEN A.TAX_AMOUNT ELSE 0 END) AS 'TAX_AMOUNT',      
A.TAX_PERCENTAGE AS 'TAX_PERCENTAGE',      
B.AC_NAME AS 'SUPPLIER_NAME',        
H.USERNAME AS 'CREATED_BY_USER'  ,  
(CASE WHEN A.CANCELLED = 1 THEN 'CANCELLED' ELSE '' END) AS CANCELLED,  
(CASE WHEN PO.PO_QTY = C.PUR_QTY+ISNULL(PA_QTY,0) THEN 'SETTLED' ELSE 'PENDING' END) AS [STATUS],  
PO.PO_QTY,C.PUR_QTY ,(PO.PO_QTY - C.PUR_QTY-ISNULL(PA_QTY,0)) AS PENDING_QTY,A.DELIVERY_DT,A.FIN_YEAR  
,COM.COMPANY_CODE,L.DEPT_ID  AS LOC_ID,L.DEPT_NAME AS LOC_NAME 
FROM POM01106 A (NOLOCK)               
JOIN LM01106 B (NOLOCK)  ON A.AC_CODE = B.AC_CODE         
JOIN USERS H (NOLOCK) ON A.USER_CODE = H.USER_CODE      
JOIN  
(  
	SELECT B.PO_ID, SUM(A.QUANTITY) AS PO_QTY        
	FROM POD01106 A (NOLOCK)   
	JOIN POM01106 B (NOLOCK) ON A.PO_ID=B.PO_ID 
	GROUP BY B.PO_ID 
) PO ON A.PO_ID= PO.PO_ID  
LEFT OUTER JOIN  
(
	SELECT C.PO_ID,SUM(A.QUANTITY) AS PUR_QTY FROM    
	PID01106 A (NOLOCK) JOIN PIM01106 B (NOLOCK) ON A.MRR_ID=B.MRR_ID  
	JOIN POD01106 C (NOLOCK) ON C.ROW_ID=A.PO_ROW_ID   
	WHERE B.CANCELLED=0 GROUP BY C.PO_ID
)C   ON A.PO_ID = C.PO_ID   

LEFT OUTER JOIN COMPANY COM ON 1=1 AND COM.COMPANY_CODE='01'  
LEFT OUTER JOIN LOCATION  L (NOLOCK) ON A.DEPT_ID = L.DEPT_ID       
LEFT OUTER JOIN 
( 
SELECT SUM(A.ADJ_QUANTITY)AS PA_QTY,B.PO_ID FROM PO_ADJ_DET A(NOLOCK)   
JOIN POD01106 B (NOLOCK) ON A.PO_ROW_ID = B.ROW_ID
GROUP BY B.PO_ID
) J ON J.PO_ID = A.PO_ID
  
     

