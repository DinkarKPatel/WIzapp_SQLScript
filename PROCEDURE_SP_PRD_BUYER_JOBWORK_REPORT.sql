CREATE  PROCEDURE SP_PRD_BUYER_JOBWORK_REPORT    
  
(    
 @CAGENCY_CODE VARCHAR(MAX)='',    
 @NPENDING INT=0,  
 @NSUMMARY INT=0,  -- 1 FOR SUMMARY 2 FOR DETAILS  
 @CARTICLE_CODE VARCHAR(10)='',  
 @DAS_ON DATETIME=''  
)    
AS    
BEGIN    
    
    
     DECLARE @DTSQL NVARCHAR(MAX),@AC_CODE VARCHAR(MAX)    
     IF @CAGENCY_CODE=''    
     BEGIN    
     SET @AC_CODE=''    
     SET @CAGENCY_CODE='IN('''')'    
     END    
     ELSE     
     BEGIN    
     SET @AC_CODE='LATER'    
     END    
       
       
           
       
     IF OBJECT_ID('TEMPDB..#TMPWIP','U') IS NOT NULL  
    DROP TABLE #TMPWIP      
            
   SELECT ORD.WORK_ORDER_ID AS ORDER_ID,  A.REF_AGENCY_CODE ,  
   C.AGENCY_NAME,  
   CAST('' AS VARCHAR(100)) AS WO_ID,  
   B.PARA1_CODE,B.PARA2_CODE,   
   A.MEMO_ID AS ISSUE_ID ,  
   A.MEMO_NO AS ISSUE_NO,    
   A.MEMO_DT AS ISSUE_DT ,  
   CAST('' AS VARCHAR(100)) AS PRODUCT_CODE ,      
   B.ISSUE_QTY AS ISSUE_QTY,  
   CAST('' AS VARCHAR(100)) AS RECEIVE_NO   ,  
   CAST('' AS DATETIME) AS RECEIVE_DT   ,  
   CAST(0 AS NUMERIC(10,2)) AS REC_QTY     
   INTO #TMPWIP      
   FROM PRD_AGENCY_ISSUE_MATERIAL_MST (NOLOCK) A      
   JOIN PRD_AGENCY_ISSUE_ROW_MATERIAL_DET (NOLOCK) B ON A.MEMO_ID =B.MEMO_ID     
   JOIN    
   (    
     SELECT MST.MEMO_NO AS ORDER_NO, A.MEMO_ID, REF_MATERIAL_ROW_ID,A.REF_PRD_WORKORDER_MEMOID AS WORK_ORDER_ID     
     FROM PRD_AGENCY_ISSUE_MATERIAL_DET A    
     JOIN PRD_WO_MST MST ON A.REF_PRD_WORKORDER_MEMOID=MST.MEMO_ID    
     GROUP BY MST.MEMO_NO,A.MEMO_ID, REF_MATERIAL_ROW_ID,A.REF_PRD_WORKORDER_MEMOID    
   ) ORD ON  ORD.MEMO_ID=B.MEMO_ID AND B.ROW_ID =ORD.REF_MATERIAL_ROW_ID      
   JOIN ARTICLE AR ON AR.ARTICLE_CODE=B.ARTICLE_CODE      
   JOIN PRD_AGENCY_MST (NOLOCK) C ON A.REF_AGENCY_CODE =C.AGENCY_CODE      
   JOIN PARA1 P1 ON P1.PARA1_CODE=B.PARA1_CODE      
   JOIN PARA2 P2 ON P2.PARA2_CODE=B.PARA2_CODE      
   WHERE    
   1=2             
   
 SET @DTSQL=N'SELECT A.ORDER_ID,  
        A.REF_AGENCY_CODE ,AGENCY_NAME,  
        A.WO_ID,A.PARA1_CODE,A.PARA2_CODE,  
        A.ISSUE_ID,   
        A.ISSUE_NO ,A.ISSUE_DT,  
        A.PRODUCT_CODE,  
        A.QUANTITY AS ISSUE_QTY,  
        B.RECEIPT_NO AS RECEIVE_NO ,  
        B.RECEIPT_DT AS RECEIVE_DT,  
        B.QUANTITY AS REC_QTY  
 FROM   
 (  
  SELECT A.REF_AGENCY_CODE ,PMT.ORDER_ID ,PMT.WO_ID,PMT.PARA1_CODE,PMT.PARA2_CODE,A.MEMO_ID AS ISSUE_ID,  
  A.MEMO_NO AS ISSUE_NO,A.MEMO_DT AS ISSUE_DT,B.PRODUCT_CODE , B.QUANTITY  
  FROM  PRD_AGENCY_ISSUE_MATERIAL_MST  A  
  JOIN PRD_AGENCY_ISSUE_MATERIAL_UPC B ON A.MEMO_ID =B.MEMO_ID   
  JOIN PRD_UPCPMT PMT ON PMT.PRODUCT_CODE =B.PRODUCT_CODE   
  WHERE A.CANCELLED =0  
 ) A  
 LEFT OUTER JOIN  
 (  
  SELECT A.ISSUE_ID, A.RECEIPT_ID,RECEIPT_NO,RECEIPT_DT,UPC.WO_ID,UPC.PARA1_CODE ,UPC.PARA2_CODE ,  
      UPC.PRODUCT_CODE ,B.QUANTITY    
  FROM  
  (  
  SELECT A.MEMO_ID AS ISSUE_ID,B.MEMO_NO AS ISSUE_NO,B.MEMO_DT AS ISSUE_DT ,D.MEMO_ID AS RECEIPT_ID,  
      D.MEMO_NO AS RECEIPT_NO,D.MEMO_DT  AS  RECEIPT_DT  
  FROM PRD_AGENCY_ISSUE_MATERIAL_DET  A  
  JOIN PRD_AGENCY_ISSUE_MATERIAL_MST B ON A.MEMO_ID =B.MEMO_ID   
  LEFT JOIN PRD_AGENCY_MATERIAL_RECEIPT_DET C ON A.ROW_ID =C.REF_ROW_ID   
  LEFT JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST D ON C.MEMO_ID =D.MEMO_ID   
  WHERE B.CANCELLED =0 AND ISNULL (D.CANCELLED,0)=0  
  GROUP BY A.MEMO_ID ,B.MEMO_NO ,  
  B.MEMO_DT  ,D.MEMO_ID , D.MEMO_NO ,  
  D.MEMO_DT  
  ) A  
  JOIN PRD_AGENCY_MATERIAL_RECEIPT_UPC  B ON A.RECEIPT_ID =B.MEMO_ID   
  JOIN PRD_UPCPMT UPC ON UPC.PRODUCT_CODE=B.PRODUCT_CODE  
   
 ) B ON A.WO_ID=B.WO_ID   
 AND A.ISSUE_ID =B.ISSUE_ID   
 AND A.PARA1_CODE =B.PARA1_CODE   
 AND A.PARA2_CODE =B.PARA2_CODE   
 AND A.PRODUCT_CODE =B.PRODUCT_CODE  
 JOIN PRD_AGENCY_MST AG ON AG.AGENCY_CODE=A.REF_AGENCY_CODE   
 JOIN PRD_WO_MST WM ON WM.MEMO_ID=A.WO_ID  
 WHERE ('''+@AC_CODE+'''='''' OR AG.AC_CODE  '+@CAGENCY_CODE+' )    
    AND ('''+@CARTICLE_CODE+'''='''' OR WM.ARTICLE_SET_CODE='''+@CARTICLE_CODE+''')  
    AND ('''+CONVERT(VARCHAR(10), @DAS_ON,121)+'''=''1900-01-01'' OR A.ISSUE_DT<='''+CONVERT(VARCHAR(10), @DAS_ON,121)+''')      
      '  
 PRINT  @DTSQL  
 INSERT INTO #TMPWIP(ORDER_ID,REF_AGENCY_CODE ,C.AGENCY_NAME,WO_ID,PARA1_CODE,PARA2_CODE,ISSUE_ID, ISSUE_NO ,ISSUE_DT,  
        PRODUCT_CODE,ISSUE_QTY,RECEIVE_NO ,RECEIVE_DT,REC_QTY)  
 EXEC SP_EXECUTESQL @DTSQL  
 
 --SELECT * INTO TMPWIP FROM #TMPWIP
   
 IF OBJECT_ID('TEMPDB..#TMPDELIVER','U') IS NOT NULL  
    DROP TABLE #TMPDELIVER  
      
  SELECT ISSUE_ID,WO_ID,PARA1_CODE,PARA2_CODE  
     INTO #TMPDELIVER  
     FROM #TMPWIP  
     WHERE 1=2  
       
   
 IF @NPENDING=1  
 BEGIN  
 INSERT INTO #TMPDELIVER(ISSUE_ID,WO_ID,PARA1_CODE,PARA2_CODE)  
     SELECT ISSUE_ID,ORDER_ID,PARA1_CODE,PARA2_CODE  
     FROM #TMPWIP  
     GROUP BY ISSUE_ID,ORDER_ID,PARA1_CODE,PARA2_CODE  
     HAVING SUM(ISSUE_QTY)=SUM(ISNULL(REC_QTY,0))  
 END      
 IF OBJECT_ID('TEMPDB..#TMPWIPSUMMARY','U') IS NOT NULL  
    DROP TABLE #TMPWIPSUMMARY  
IF OBJECT_ID('TMPWIPSUMMARY_PROC','U') IS NOT NULL  
    DROP TABLE TMPWIPSUMMARY_PROC
--IF @NPENDING<>1       

SET @DTSQL='SELECT LM.AC_NAME AS BUYER_NAME,  
        A.WO_ID AS ORDER_ID ,WM.MEMO_NO AS ORDER_NO,  
        A.AGENCY_NAME ,ART.ARTICLE_CODE,
        ART.ARTICLE_NO AS FG_ARTICLE_NO ,ART.ARTICLE_NAME AS FG_ARTICLE_NAME ,  
        P1.PARA1_NAME AS FG_COLOR,  
        P2.PARA2_NAME AS FG_SIZE,  
        A.ISSUE_ID,   
        A.ISSUE_NO,  
        A.ISSUE_DT,  
        SUM(A.ISSUE_QTY) AS ISSUE_QTY,  
        RECEIVE_NO,  
        RECEIVE_DT,  
        SUM(ISNULL(A.REC_QTY,0)) AS REC_QTY,  
        SUM(A.ISSUE_QTY)-SUM(ISNULL(A.REC_QTY,0)) AS PENDING_QTY
 INTO TMPWIPSUMMARY_PROC  
 FROM #TMPWIP A  
 --LEFT JOIN #TMPDELIVER B ON A.ORDER_ID =B.WO_ID   
 --AND A.PARA1_CODE=B.PARA1_CODE AND  A.PARA2_CODE=B.PARA2_CODE  
 --AND A.ISSUE_ID=B.ISSUE_ID   
 JOIN PRD_WO_ORDERS ORD ON ORD.MEMO_ID =A.WO_ID   
 JOIN PRD_WO_MST WM ON WM.MEMO_ID =A.WO_ID  
 JOIN ARTICLE ART ON ART.ARTICLE_CODE =WM.ARTICLE_SET_CODE   
 JOIN PARA1 P1 ON P1.PARA1_CODE =A.PARA1_CODE   
 JOIN PARA2 P2 ON P2.PARA2_CODE =A.PARA2_CODE   
 JOIN BUYER_ORDER_MST BM ON BM.ORDER_ID=ISNULL(A.ORDER_ID ,ORD.ORDER_ID )  
 JOIN LM01106 LM (NOLOCK) ON LM.AC_CODE =BM.AC_CODE  
 --WHERE B.ISSUE_ID IS NULL  
 GROUP BY A.WO_ID ,WM.MEMO_NO ,  
 A.AGENCY_NAME ,ART.ARTICLE_NO  ,ART.ARTICLE_NAME  ,  
 P1.PARA1_NAME ,P2.PARA2_NAME , A.ISSUE_NO,A.ISSUE_DT,RECEIVE_NO,  
 LM.AC_NAME ,RECEIVE_DT, A.ISSUE_ID  ,ART.ARTICLE_CODE'
 +CASE @NPENDING WHEN 1 THEN ' HAVING SUM(A.ISSUE_QTY)-SUM(ISNULL(A.REC_QTY,0))<>0 ' ELSE '' END 
 
PRINT @DTSQL
EXEC SP_EXECUTESQL @DTSQL 

 
   
 SELECT A.* ,
  CAST(VALUE+''+IMAGE_SUBFOLDER+'\'+A.FG_ARTICLE_NO+'.JPG' AS VARCHAR(1000)) AS PICT_PATH  
 FROM  
 --#TMPWIPSUMMARY A  
 TMPWIPSUMMARY_PROC A
 LEFT JOIN IMAGE_INFO IMG (NOLOCK) ON IMG.ARTICLE_CODE=A.ARTICLE_CODE
 JOIN ( SELECT TOP 1 VALUE FROM CONFIG WHERE CONFIG_OPTION='ART_PICT_PATH' )  PIC ON 1=1
 ORDER BY FG_ARTICLE_NO,AGENCY_NAME ,FG_COLOR , ISSUE_ID  
   
 END
