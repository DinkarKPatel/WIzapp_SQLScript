CREATE PROCEDURE SP_ISSUEMATERIAL_AGENCY_RE_ISSUE
(
 @NQUERTID INT,
 @DFM_DT DATETIME,
 @DTODT DATETIME,
 @CAGENCY_CODE VARCHAR(100)='',
 @CMEMO_ID VARCHAR(100)='',
 @CWHERE VARCHAR(MAX)=''
)
AS
BEGIN
     DECLARE @CCMD NVARCHAR(MAX)
IF @NQUERTID=1
GOTO LBLMASTER
ELSE 
IF @NQUERTID=2
GOTO LBLDETAILS
ELSE
IF @NQUERTID=3
GOTO LBLSUBDETAILS
ELSE
IF @NQUERTID=4
GOTO LBLAPPLU


LBLMASTER:
 
	 SELECT A.*,B.AGENCY_NAME AS AGENCY_NAME 
	 FROM PRD_AGENCY_RE_ISSUE_MST A
	 JOIN PRD_AGENCY_MST B ON A.REF_AGENCY_CODE=B.AGENCY_CODE
	 WHERE A.MEMO_ID=@CMEMO_ID
 
GOTO END_PROC

LBLDETAILS:
    
    IF OBJECT_ID('TEMPDB..#TMPRE_ISSUE','U') IS NOT NULL
       DROP TABLE #TMPRE_ISSUE
       
	SELECT A.MEMO_NO,A.MEMO_DT,A.MEMO_ID,B.XN_PRODUCT_UID,B.QUANTITY,ISNULL(C.QUANTITY ,0) AS RE_ISSUE_QTY
	INTO #TMPRE_ISSUE
	FROM PRD_AGENCY_MATERIAL_RECEIPT_MST A
	JOIN PRD_AGENCY_MATERIAL_RECEIPT_DET B ON A.MEMO_ID=B.MEMO_ID
	LEFT OUTER JOIN
	(
	 SELECT REF_REC_ID,PRODUCT_UID,SUM(QUANTITY) AS  QUANTITY
	 FROM PRD_AGENCY_RE_ISSUE_MST A
	 JOIN PRD_AGENCY_RE_ISSUE_DET B ON A.MEMO_ID=B.MEMO_ID
	 WHERE A.CANCELLED=0 
	 GROUP BY REF_REC_ID,PRODUCT_UID
	) C ON A.MEMO_ID=C.REF_REC_ID AND B.XN_PRODUCT_UID=C.PRODUCT_UID
	WHERE A.CANCELLED=0 AND A.AGENCY_CODE=@CAGENCY_CODE 
	AND A.MEMO_DT BETWEEN @DFM_DT AND @DTODT
    AND B.QUANTITY-ISNULL(C.QUANTITY ,0)>0
    
    
    SELECT CAST(0  AS INT) AS CHK, A.MEMO_NO AS RECEIPT_NO,A.MEMO_DT AS RECEIPT_DT,A.MEMO_ID AS RECEIPT_ID
    FROM #TMPRE_ISSUE A
    GROUP BY A.MEMO_NO,A.MEMO_DT,A.MEMO_ID
    ORDER BY A.MEMO_NO,A.MEMO_DT,A.MEMO_ID
    
    
    
GOTO END_PROC

LBLSUBDETAILS:
     
     IF @CMEMO_ID=''
     BEGIN
	 SELECT CAST(0 AS BIT) AS CHK,
			C.XN_PRODUCT_UID AS PRODUCT_UID,
			C.QUANTITY AS REC_QTY,
			ISNULL(R.QUANTITY,0) AS RE_ISSUED_QTY,
			C.QUANTITY-ISNULL(R.QUANTITY,0) AS QUANTITY,
			ROW_ID=CAST('LATER'+CAST(NEWID() AS VARCHAR(100)) AS VARCHAR(40)),
			GETDATE()  AS LAST_UPDATE,
			CAST('LATER' AS VARCHAR(100)) AS MEMO_ID,
			SKU.PRODUCT_CODE,
			C.MEMO_ID AS REF_REC_ID,
			C.MEMO_ID AS RECEIPT_ID,
			D.JOB_CODE AS JOB_CODE,
			JOBS.JOB_NAME
	 FROM PRD_AGENCY_MATERIAL_RECEIPT_DET C 
	 JOIN PRD_AGENCY_MATERIAL_RECEIPT_MST F ON C.MEMO_ID=F.MEMO_ID
	 JOIN
	 (
	   SELECT D.ROW_ID,D.JOB_CODE
	   FROM  PRD_AGENCY_ISSUE_MATERIAL_DET D 
	   JOIN PRD_AGENCY_ISSUE_MATERIAL_MST E ON E.MEMO_ID=D.MEMO_ID
	   WHERE  E.CANCELLED=0
	   UNION ALL
	   SELECT D.ROW_ID,D.JOB_CODE
	   FROM  PRD_AGENCY_ISSUE_MATERIAL_DET_PENDING D 
	   JOIN PRD_AGENCY_ISSUE_MATERIAL_MST_PENDING E ON E.MEMO_ID=D.MEMO_ID
	   WHERE  E.CANCELLED=0
	 ) D ON C.REF_ROW_ID=D.ROW_ID
	 LEFT OUTER JOIN
	 (
	  SELECT REF_REC_ID,PRODUCT_UID,SUM(QUANTITY) AS  QUANTITY
	  FROM PRD_AGENCY_RE_ISSUE_MST A
	  JOIN PRD_AGENCY_RE_ISSUE_DET B ON A.MEMO_ID=B.MEMO_ID
	  WHERE A.CANCELLED=0
	  GROUP BY REF_REC_ID,PRODUCT_UID
	 ) R ON C.MEMO_ID=R.REF_REC_ID AND C.XN_PRODUCT_UID=R.PRODUCT_UID
	 JOIN PRD_SKU SKU ON SKU.PRODUCT_UID=C.XN_PRODUCT_UID
	 JOIN ARTICLE AR ON AR.ARTICLE_CODE=SKU.ARTICLE_CODE
	 LEFT OUTER JOIN JOBS ON JOBS.JOB_CODE=D.JOB_CODE
	 WHERE   F.CANCELLED=0
	 AND C.QUANTITY-ISNULL(R.QUANTITY,0)>0
	  AND F.AGENCY_CODE=@CAGENCY_CODE 
	  AND F.CANCELLED=0 
	  AND F.MEMO_DT BETWEEN @DFM_DT AND @DTODT
	END
	ELSE
	BEGIN
	

	  SELECT CAST(0 AS BIT) AS CHK,
			B.PRODUCT_UID AS PRODUCT_UID,
			B.QUANTITY AS REC_QTY,
			B.QUANTITY AS RE_ISSUED_QTY,
			B.QUANTITY AS QUANTITY,
			ROW_ID,
			A.LAST_UPDATE,
			A.MEMO_ID,
			B.PRODUCT_CODE,
			B.REF_REC_ID AS REF_REC_ID,
			B.REF_REC_ID AS RECEIPT_ID,
			B.JOB_CODE AS JOB_CODE,
			JOBS.JOB_NAME
	  FROM PRD_AGENCY_RE_ISSUE_MST A
	  JOIN PRD_AGENCY_RE_ISSUE_DET B ON A.MEMO_ID=B.MEMO_ID
	  LEFT OUTER JOIN JOBS ON JOBS.JOB_CODE=B.JOB_CODE
	  WHERE   A.MEMO_ID=@CMEMO_ID
	
	END
GOTO END_PROC

LBLAPPLU:                        
	SET @CCMD=N'SELECT MEMO_ID,MEMO_NO FROM PRD_AGENCY_RE_ISSUE_MST '+(CASE WHEN ISNULL(@CWHERE,'')='' THEN ''                  
	 ELSE ' WHERE '+@CWHERE END)                 
	 SET @CCMD=@CCMD+' ORDER BY PRD_AGENCY_RE_ISSUE_MST.MEMO_DT'                     
	                  
	PRINT @CCMD                  
	EXEC SP_EXECUTESQL @CCMD                   
GOTO END_PROC  
END_PROC:

END
